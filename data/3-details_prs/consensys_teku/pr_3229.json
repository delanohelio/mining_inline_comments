{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxMzAzMTMw", "number": 3229, "title": "Handle external signer refusal to sign due to violation of slashing conditions", "bodyText": "PR Description\nHandle external signer refusal to sign due to violation of slashing conditions by handling response status code 412 and constructing appropriate error message.\nSee #3109 and ConsenSys/web3signer#303\nSigned-off-by: Usman Saleem usman@usmans.info\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-16T01:32:48Z", "url": "https://github.com/ConsenSys/teku/pull/3229", "merged": true, "mergeCommit": {"oid": "984c0a17fdf107fa68d91bf09c010b05ac3ccdac"}, "closed": true, "closedAt": "2020-11-16T05:11:31Z", "author": {"login": "usmansaleem"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdc6r99AH2gAyNTIxMzAzMTMwOmI2ZTU2ZGYwYTgwMGViYjdkYmQ5MjhlYzNiZjlkNWZlNGRjNGQ1ZWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdc9hFwAH2gAyNTIxMzAzMTMwOjg3NzZiZDQzYzhlNDg4NDY0M2EyN2ViZDg0YWU4NDQzYWFiMzAyMjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b6e56df0a800ebb7dbd928ec3bf9d5fe4dc4d5ed", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/b6e56df0a800ebb7dbd928ec3bf9d5fe4dc4d5ed", "committedDate": "2020-11-16T01:29:38Z", "message": "[#3109] Handle external signer slashing protection error\n\nHandle external signer slashing protection error by handling response status code 412 and construct appropriate error message to indicate that external signer refuses to sign due to slashing condition may be violated.\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b1479dc64c09c4d4b5b661b3d163deab664e49e", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/0b1479dc64c09c4d4b5b661b3d163deab664e49e", "committedDate": "2020-11-16T02:09:51Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_handle_412\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwOTA3NjI4", "url": "https://github.com/ConsenSys/teku/pull/3229#pullrequestreview-530907628", "createdAt": "2020-11-16T04:05:43Z", "commit": {"oid": "0b1479dc64c09c4d4b5b661b3d163deab664e49e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwNDowNTo0NFrOHznp_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwNDowNjo0OVrOHznq1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg4OTE0OQ==", "bodyText": "Can we add this as a constant in HttpStatusCodes and use that constant rather than hard coding the 412 number?", "url": "https://github.com/ConsenSys/teku/pull/3229#discussion_r523889149", "createdAt": "2020-11-16T04:05:44Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/integration-test/java/tech/pegasys/teku/validator/client/signer/ExternalSignerIntegrationTest.java", "diffHunk": "@@ -119,6 +118,36 @@ void failsSigningWhenSigningServiceReturnsInvalidSignatureResponse() {\n             \"External signer returned an invalid signature: Illegal character 'I' found at index 0 in hex binary representation\");\n   }\n \n+  @Test\n+  void failsSigningBlockWhenSigningServiceRefusesToSignDueToSlashingCondition() {\n+    final BeaconBlock block = dataStructureUtil.randomBeaconBlock(10);\n+    client.when(request()).respond(response().withStatusCode(412));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b1479dc64c09c4d4b5b661b3d163deab664e49e"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg4OTM2Ng==", "bodyText": "Would be good to sue a constant here (and actually switch the 200 below to a HttpStatusCodes constant too.", "url": "https://github.com/ConsenSys/teku/pull/3229#discussion_r523889366", "createdAt": "2020-11-16T04:06:49Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/signer/ExternalSigner.java", "diffHunk": "@@ -175,12 +187,18 @@ private String createSigningRequestBody(\n   }\n \n   private BLSSignature getBlsSignature(\n-      final HttpResponse<String> response, final Throwable throwable) {\n+      final HttpResponse<String> response,\n+      final Throwable throwable,\n+      final Supplier<String> slashableMessage) {\n     if (throwable != null) {\n       throw new ExternalSignerException(\n           \"External signer failed to sign due to \" + throwable.getMessage(), throwable);\n     }\n \n+    if (response.statusCode() == 412) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b1479dc64c09c4d4b5b661b3d163deab664e49e"}, "originalPosition": 111}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97f49f714165a8b4acfd6a3d8dc49a3d474aa6cd", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/97f49f714165a8b4acfd6a3d8dc49a3d474aa6cd", "committedDate": "2020-11-16T04:44:35Z", "message": "Review suggestion - use HttpStatusCodes class\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf77580eb40654af829d450ae4267231cd1da01c", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/bf77580eb40654af829d450ae4267231cd1da01c", "committedDate": "2020-11-16T04:45:01Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_handle_412\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8776bd43c8e4884643a27ebd84ae8443aab30229", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/8776bd43c8e4884643a27ebd84ae8443aab30229", "committedDate": "2020-11-16T04:47:28Z", "message": "Review suggestion - use HttpStatusCodes class\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4452, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}