{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNTQ1NDg2", "number": 1137, "title": "Add metrics to EventChannel", "bodyText": "PR Description\nAdds counters to EventChannel for number of events published, number of events consumed by each subscriber and number of failures when processing events.  This allows monitoring:\n\nthat events are still flowing as expected\nthe size of queue for each subscriber (consumed - published)\nthe rate of events being published\nthe rate of errors", "createdAt": "2020-02-05T19:28:07Z", "url": "https://github.com/ConsenSys/teku/pull/1137", "merged": true, "mergeCommit": {"oid": "aac23d84d1812f68653aa18968403ae6b2fed90b"}, "closed": true, "closedAt": "2020-02-06T23:38:00Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcA4BexgH2gAyMzcxNTQ1NDg2OjRiNzY0YjBhYjE1NTNlNTIxOTdlMGEyYjBjZmM3ZGJiOTJjMDM5MTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBzPjOgH2gAyMzcxNTQ1NDg2OjNhMzI2YzljNWY4ZjdhZDQ2ZWExYmNmYjM5ZGQ5ZmYyY2M1Y2IwMDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4b764b0ab1553e52197e0a2b0cfc7dbb92c03919", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/4b764b0ab1553e52197e0a2b0cfc7dbb92c03919", "committedDate": "2020-02-04T02:22:23Z", "message": "Add metrics for events published to and consumed from event channels."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b28e81a0408d1e7d5d6756a687636156ef838f2", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/6b28e81a0408d1e7d5d6756a687636156ef838f2", "committedDate": "2020-02-05T19:16:51Z", "message": "Gradle dependencies."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f8daa6dc79a2401109e79f91efe551b4063f485", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/1f8daa6dc79a2401109e79f91efe551b4063f485", "committedDate": "2020-02-05T19:27:48Z", "message": "Increment consumed counter even when a failure occurs.  Add failure counter."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ad9230e1b97b6b1e7e6b354d73f4fb4144cd635", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/0ad9230e1b97b6b1e7e6b354d73f4fb4144cd635", "committedDate": "2020-02-05T19:29:04Z", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis into event-metrics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NjI4ODg1", "url": "https://github.com/ConsenSys/teku/pull/1137#pullrequestreview-354628885", "createdAt": "2020-02-06T17:17:49Z", "commit": {"oid": "0ad9230e1b97b6b1e7e6b354d73f4fb4144cd635"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNzoxNzo0OVrOFmjb0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNzoxNzo0OVrOFmjb0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk3MDc3MA==", "bodyText": "Should we include method.getName()?", "url": "https://github.com/ConsenSys/teku/pull/1137#discussion_r375970770", "createdAt": "2020-02-06T17:17:49Z", "author": {"login": "mbaxter"}, "path": "events/src/main/java/tech/pegasys/artemis/events/DirectEventDeliverer.java", "diffHunk": "@@ -13,24 +13,58 @@\n \n package tech.pegasys.artemis.events;\n \n+import static tech.pegasys.artemis.metrics.ArtemisMetricCategory.EVENTBUS;\n+\n import java.lang.reflect.InvocationTargetException;\n import java.lang.reflect.Method;\n+import org.hyperledger.besu.plugin.services.MetricsSystem;\n+import org.hyperledger.besu.plugin.services.metrics.Counter;\n+import org.hyperledger.besu.plugin.services.metrics.LabelledMetric;\n \n class DirectEventDeliverer<T> extends EventDeliverer<T> {\n   private final ChannelExceptionHandler exceptionHandler;\n+  private final LabelledMetric<Counter> consumedEventCounter;\n+  private final LabelledMetric<Counter> failedEventCounter;\n \n-  DirectEventDeliverer(final ChannelExceptionHandler exceptionHandler) {\n+  DirectEventDeliverer(\n+      final ChannelExceptionHandler exceptionHandler, final MetricsSystem metricsSystem) {\n+    super(metricsSystem);\n     this.exceptionHandler = exceptionHandler;\n+    consumedEventCounter =\n+        metricsSystem.createLabelledCounter(\n+            EVENTBUS,\n+            \"event_consumed_count\",\n+            \"Total number of events consumed\",\n+            \"channel\",\n+            \"subscriber\");\n+    failedEventCounter =\n+        metricsSystem.createLabelledCounter(\n+            EVENTBUS,\n+            \"event_failed_count\",\n+            \"Number of events which failed to be processed\",\n+            \"channel\",\n+            \"subscriber\");\n   }\n \n   @Override\n   protected void deliverTo(final T subscriber, final Method method, final Object[] args) {\n     try {\n       method.invoke(subscriber, args);\n     } catch (IllegalAccessException e) {\n+      incrementCounter(failedEventCounter, subscriber, method);\n       exceptionHandler.handleException(e, subscriber, method, args);\n     } catch (InvocationTargetException e) {\n+      incrementCounter(failedEventCounter, subscriber, method);\n       exceptionHandler.handleException(e.getTargetException(), subscriber, method, args);\n+    } finally {\n+      incrementCounter(consumedEventCounter, subscriber, method);\n     }\n   }\n+\n+  private void incrementCounter(\n+      final LabelledMetric<Counter> counter, final T subscriber, final Method method) {\n+    counter\n+        .labels(method.getDeclaringClass().getSimpleName(), subscriber.getClass().getSimpleName())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ad9230e1b97b6b1e7e6b354d73f4fb4144cd635"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a326c9c5f8f7ad46ea1bcfb39dd9ff2cc5cb006", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/3a326c9c5f8f7ad46ea1bcfb39dd9ff2cc5cb006", "committedDate": "2020-02-06T23:22:09Z", "message": "Merge branch 'master' into event-metrics"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4277, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}