{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4ODkxODkx", "number": 2205, "title": "Index finalized data by slot instead of block root", "bodyText": "PR Description\nSo that we can efficiently find the closest available snapshot prior to the requested one (and then regenerate from there), switch to storing finalised states and blocks indexed by slot instead of blockRoot and then have a blockRoot->slot index instead of slot->blockRoot.\nOnly changes the database format for v4 which still isn't the default. Had to change how V3 looks up data but what it stores on disk is unchanged so still backwards compatible.\nFixed Issue(s)\nPart of #2198\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-06-24T00:28:30Z", "url": "https://github.com/ConsenSys/teku/pull/2205", "merged": true, "mergeCommit": {"oid": "3a342769001aeecf24f71affd74de17be6372799"}, "closed": true, "closedAt": "2020-06-24T21:23:23Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuDIxtAH2gAyNDM4ODkxODkxOmQwM2VkOWZkOGExZTZlNjJlMTA0NTg3MDUyNGQ5OTExOTBkZWMyMTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcugvALAH2gAyNDM4ODkxODkxOjQ4Njk4YmE2MjVkODA1YzA2MGM3MWZjYmYwMGQ0MmRkODI2ZjkxNTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d03ed9fd8a1e6e62e1045870524d991190dec215", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d03ed9fd8a1e6e62e1045870524d991190dec215", "committedDate": "2020-06-23T10:45:54Z", "message": "Index finalized data by slot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92b9099362c467d481b91d9f8d389912f6f657da", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/92b9099362c467d481b91d9f8d389912f6f657da", "committedDate": "2020-06-24T00:25:44Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into index-by-slot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a7eb0fe487bc3f11e56ed9c39ff2089b53442c7", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/6a7eb0fe487bc3f11e56ed9c39ff2089b53442c7", "committedDate": "2020-06-24T00:51:01Z", "message": "Add test for StreamingStateRegenerator."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "693c851841a55cec549ec056553fca434e76520f", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/693c851841a55cec549ec056553fca434e76520f", "committedDate": "2020-06-24T01:03:00Z", "message": "Fix naming."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a10b2e811677fe37faf2e1bca9a2c17dd00e914", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/7a10b2e811677fe37faf2e1bca9a2c17dd00e914", "committedDate": "2020-06-24T01:16:45Z", "message": "Use getLatestFinalizedBlock since we expect to get the block in effect."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1e4b45a468ae190ad017880d5221669647d1a53", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d1e4b45a468ae190ad017880d5221669647d1a53", "committedDate": "2020-06-24T01:41:08Z", "message": "Implement getLatestAvailableFinalizedState for V3 database."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23d41fbe546e01c32edb02bb22c2d5f88bf9c366", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/23d41fbe546e01c32edb02bb22c2d5f88bf9c366", "committedDate": "2020-06-24T05:20:27Z", "message": "Don't process empty slots to minimise changes to tests required."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd267eb3e6a04d4de0030a2a7ed0dec3ca29aea9", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/bd267eb3e6a04d4de0030a2a7ed0dec3ca29aea9", "committedDate": "2020-06-24T05:21:44Z", "message": "Spotless."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2f6af086919f74d3a312c646ffedf92139af449", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d2f6af086919f74d3a312c646ffedf92139af449", "committedDate": "2020-06-24T05:29:54Z", "message": "Add test for streaming finalized blocks."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3674904f1abf4cea45cdeb0fea1a12fb5bed1c7f", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/3674904f1abf4cea45cdeb0fea1a12fb5bed1c7f", "committedDate": "2020-06-24T05:31:57Z", "message": "Rename back to getLatestState."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "808835a6428e4b93aca1523a18c8b89a96146a15", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/808835a6428e4b93aca1523a18c8b89a96146a15", "committedDate": "2020-06-24T05:38:42Z", "message": "assertOpen()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2NzU2NDU0", "url": "https://github.com/ConsenSys/teku/pull/2205#pullrequestreview-436756454", "createdAt": "2020-06-24T15:22:55Z", "commit": {"oid": "808835a6428e4b93aca1523a18c8b89a96146a15"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNToyMjo1NVrOGoXPOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNToyOTo0M1rOGoXjLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk3Njk1NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final List<UnsignedLong> unavailableRoots =\n          \n          \n            \n                    final List<UnsignedLong> unavailableSlots =", "url": "https://github.com/ConsenSys/teku/pull/2205#discussion_r444976954", "createdAt": "2020-06-24T15:22:55Z", "author": {"login": "mbaxter"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/AbstractDatabaseTest.java", "diffHunk": "@@ -657,13 +660,24 @@ protected void testShouldRecordFinalizedBlocksAndStates(\n         break;\n       case PRUNE:\n         // Check pruned states\n-        final List<Bytes32> unavailableRoots =\n-            allBlocksAndStates.stream().map(SignedBlockAndState::getRoot).collect(toList());\n+        final List<UnsignedLong> unavailableRoots =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "808835a6428e4b93aca1523a18c8b89a96146a15"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4MTU0OQ==", "bodyText": "This helper method is oddly specific - why not pass in expectedFinalizedBlocks?", "url": "https://github.com/ConsenSys/teku/pull/2205#discussion_r444981549", "createdAt": "2020-06-24T15:29:06Z", "author": {"login": "mbaxter"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/AbstractDatabaseTest.java", "diffHunk": "@@ -645,6 +647,7 @@ protected void testShouldRecordFinalizedBlocksAndStates(\n     assertBlocksFinalized(expectedFinalizedBlocks);\n     assertGetLatestFinalizedRootAtSlotReturnsFinalizedBlocks(expectedFinalizedBlocks);\n     assertBlocksAvailableByRoot(expectedFinalizedBlocks);\n+    assertFinalizedBlocksAvailableViaStream(primaryChain);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "808835a6428e4b93aca1523a18c8b89a96146a15"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4MjA2MQ==", "bodyText": "Shouldn't block 7 also be available?  It was finalized.", "url": "https://github.com/ConsenSys/teku/pull/2205#discussion_r444982061", "createdAt": "2020-06-24T15:29:43Z", "author": {"login": "mbaxter"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/AbstractDatabaseTest.java", "diffHunk": "@@ -657,13 +660,24 @@ protected void testShouldRecordFinalizedBlocksAndStates(\n         break;\n       case PRUNE:\n         // Check pruned states\n-        final List<Bytes32> unavailableRoots =\n-            allBlocksAndStates.stream().map(SignedBlockAndState::getRoot).collect(toList());\n+        final List<UnsignedLong> unavailableRoots =\n+            allBlocksAndStates.stream().map(SignedBlockAndState::getSlot).collect(toList());\n         assertStatesUnavailable(unavailableRoots);\n         break;\n     }\n   }\n \n+  private void assertFinalizedBlocksAvailableViaStream(final ChainBuilder primaryChain) {\n+    try (final Stream<SignedBeaconBlock> stream =\n+        database.streamFinalizedBlocks(UnsignedLong.valueOf(1), UnsignedLong.valueOf(3))) {\n+      assertThat(stream)\n+          .containsExactly(\n+              primaryChain.getBlockAtSlot(1),\n+              primaryChain.getBlockAtSlot(2),\n+              primaryChain.getBlockAtSlot(3));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "808835a6428e4b93aca1523a18c8b89a96146a15"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bad83a8398a10b1d44a2c4ad7fcb78203c08f58b", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/bad83a8398a10b1d44a2c4ad7fcb78203c08f58b", "committedDate": "2020-06-24T21:13:43Z", "message": "Make utility method more generic."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48698ba625d805c060c71fcbf00d42dd826f9151", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/48698ba625d805c060c71fcbf00d42dd826f9151", "committedDate": "2020-06-24T21:14:54Z", "message": "Rename."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3972, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}