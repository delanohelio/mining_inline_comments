{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2MjEzNzc3", "number": 2555, "title": "[Issue-2438] Be more careful about disabling validator duties while \"syncing\"", "bodyText": "PR Description\nAdd an extra check to see where our current chain head is before disabling duties when our sync process is active.  This protects us from the case where a peer sends us a faulty finalized epoch in its status message, tricking our node into initiating a sync and skipping validator duties.\nFixed Issue(s)\nRelates to #2438\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-08-11T16:22:16Z", "url": "https://github.com/ConsenSys/teku/pull/2555", "merged": true, "mergeCommit": {"oid": "b1b6390268ccd953ec0e909a6996dd064cd94cfd"}, "closed": true, "closedAt": "2020-08-11T22:14:46Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc95QatgH2gAyNDY2MjEzNzc3OmZlYTI2YTA1OGIwN2JhZjhmYmYxZGZjNTI1NDUxOGFjMjgzMTU5Nzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc999fRAH2gAyNDY2MjEzNzc3OjcwODVkMTk4MzFjZWQyN2Y1MWY0N2ZkNjFiNjhlMDBhMmI1YzBiYjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fea26a058b07baf8fbf1dfc5254518ac28315979", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/fea26a058b07baf8fbf1dfc5254518ac28315979", "committedDate": "2020-08-11T16:17:59Z", "message": "Be more careful about disabling duties while \"syncing\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccfb8e08905530e017630e46f8d70facce2bf453", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/ccfb8e08905530e017630e46f8d70facce2bf453", "committedDate": "2020-08-11T19:46:27Z", "message": "Merge branch 'master' into issue-2438/double-check-head-slot-before-skipping-duties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d66bb78aa5c85228e4d2be3c87018460571aab30", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/d66bb78aa5c85228e4d2be3c87018460571aab30", "committedDate": "2020-08-11T20:07:36Z", "message": "Merge branch 'master' into issue-2438/double-check-head-slot-before-skipping-duties"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1Mzk4OTM3", "url": "https://github.com/ConsenSys/teku/pull/2555#pullrequestreview-465398937", "createdAt": "2020-08-11T20:21:15Z", "commit": {"oid": "d66bb78aa5c85228e4d2be3c87018460571aab30"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMDoyMToxNVrOG_HzuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMDoyMzo1MVrOG_H4-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg0MTQwMQ==", "bodyText": "Should we apply this rename to recentChainData.getBestSlot() too? I must admit I'm getting confused about best vs head vs current slot and what they all mean.  It may be worth adding some JavaDoc to define them.", "url": "https://github.com/ConsenSys/teku/pull/2555#discussion_r468841401", "createdAt": "2020-08-11T20:21:15Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/client/CombinedChainDataClient.java", "diffHunk": "@@ -333,10 +334,22 @@ public boolean isChainDataFullyAvailable() {\n     return result;\n   }\n \n-  public UInt64 getBestSlot() {\n+  public UInt64 getHeadSlot() {\n     return this.recentChainData.getBestSlot();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d66bb78aa5c85228e4d2be3c87018460571aab30"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg0Mjc0Ng==", "bodyText": "I'd extract getCurrentSyncState to a variable so we have a consistent view of it rather than it potentially changing part way through this logic (should still work out fine but is easier to reason about if its fixed).", "url": "https://github.com/ConsenSys/teku/pull/2555#discussion_r468842746", "createdAt": "2020-08-11T20:23:51Z", "author": {"login": "ajsutton"}, "path": "validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/ValidatorApiHandler.java", "diffHunk": "@@ -307,8 +308,16 @@ public void sendSignedBlock(final SignedBeaconBlock block) {\n     eventBus.post(new ProposedBlockEvent(block));\n   }\n \n-  private boolean isSyncActive() {\n-    return !syncStateTracker.getCurrentSyncState().isInSync();\n+  @VisibleForTesting\n+  boolean isSyncActive() {\n+    return syncStateTracker.getCurrentSyncState().isStartingUp()\n+        || (syncStateTracker.getCurrentSyncState().isSyncing() && headBlockIsTooFarBehind());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d66bb78aa5c85228e4d2be3c87018460571aab30"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98aea18ddc3d9b758db6c467c4cf566c30df724f", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/98aea18ddc3d9b758db6c467c4cf566c30df724f", "committedDate": "2020-08-11T21:26:49Z", "message": "Merge branch 'master' into issue-2438/double-check-head-slot-before-skipping-duties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92c3c7f76b4f48c14619304508cb828149c77369", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/92c3c7f76b4f48c14619304508cb828149c77369", "committedDate": "2020-08-11T21:29:14Z", "message": "Extract syncState to a variable for clarity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7085d19831ced27f51f47fd61b68e00a2b5c0bb4", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/7085d19831ced27f51f47fd61b68e00a2b5c0bb4", "committedDate": "2020-08-11T21:46:50Z", "message": "Rework naming conventions related to head block data"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3617, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}