{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxMzYxMjEy", "number": 2083, "title": "Automate API doc with CI", "bodyText": "PR Description\nThis is the second attempt to provide CI automated API doc published on Github Pages.\nFirst attempt failed for many reasons and mostly because I faced issues with pushing changes on a protected branch. Now this one uses a gh-pages specific branch and no generated content is stored on the master. Only source files and scripts for doc publishing are on master (or in this branch for now). This was refined in other projects like we3js-eea or orchestrate node SDK before.\nFor now, on this PR, you will be able to notice the publication in a test branch but it will be similar in the real one.\nIMPORTANT: the PR is draft because it is required to remove Circle CI GH_PAGES_BRANCH_OVERRIDE env var and the publishAPIDoc job workflow filter for 1826-api-doc-on-CI before merge. So draft should work like a warning and prevent merging without taking care of this.\nFixed Issue(s)\n\n\nfixes #1826", "createdAt": "2020-06-08T19:51:11Z", "url": "https://github.com/ConsenSys/teku/pull/2083", "merged": true, "mergeCommit": {"oid": "2a3d206b9962e0a0b33ff2bf4c008ec5d5a93c29"}, "closed": true, "closedAt": "2020-06-11T11:41:56Z", "author": {"login": "NicolasMassart"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpSybcgH2gAyNDMxMzYxMjEyOjFlZThiYzc1NmJhYjUxMmM2MTQyYzhjNzI1ZTkxZDJiYWY1YTNlYWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqJqLZgFqTQyODY4Mjk1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1ee8bc756bab512c6142c8c725e91d2baf5a3eaf", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/1ee8bc756bab512c6142c8c725e91d2baf5a3eaf", "committedDate": "2020-06-08T16:10:21Z", "message": "update scripts and readme"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcf563a3c839c315146c8746bebf033edfcbc622", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/bcf563a3c839c315146c8746bebf033edfcbc622", "committedDate": "2020-06-08T16:42:27Z", "message": "remove version file that will be in gh-pages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89570400da02e22d2f2ac51ff98166523eb9342c", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/89570400da02e22d2f2ac51ff98166523eb9342c", "committedDate": "2020-06-08T17:16:08Z", "message": "update CI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "103e533d269bee1399190d2f306fd1c189cfd49a", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/103e533d269bee1399190d2f306fd1c189cfd49a", "committedDate": "2020-06-08T17:21:43Z", "message": "testing CI filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfac8d3a65baa65d68da2a1db79c14aa51edd412", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/cfac8d3a65baa65d68da2a1db79c14aa51edd412", "committedDate": "2020-06-08T17:27:51Z", "message": "fix artifact path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "363ecf8b036753b5420c6809598fa4885b387057", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/363ecf8b036753b5420c6809598fa4885b387057", "committedDate": "2020-06-08T18:57:42Z", "message": "fix cache and js script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b856aaa70ae778ed24682f3257c90abeab2abb5", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/7b856aaa70ae778ed24682f3257c90abeab2abb5", "committedDate": "2020-06-08T19:44:34Z", "message": "fix wrong dir"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3073785aa6f6b04c037607b7e8b17ad62c527dee", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/3073785aa6f6b04c037607b7e8b17ad62c527dee", "committedDate": "2020-06-08T19:59:37Z", "message": "Merge branch 'master' into 1826-api-doc-on-CI"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NzE5MDQ1", "url": "https://github.com/ConsenSys/teku/pull/2083#pullrequestreview-426719045", "createdAt": "2020-06-09T00:59:09Z", "commit": {"oid": "3073785aa6f6b04c037607b7e8b17ad62c527dee"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwMDo1OTowOVrOGg1N-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwMTowMToxMlrOGg1QIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3OTU0NQ==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        # retrieve branch to publish to from CIrcle CI env vars and fallback on test-gh-pages\n          \n          \n            \n                        # retrieve branch to publish to from Circle CI env vars and fallback on test-gh-pages", "url": "https://github.com/ConsenSys/teku/pull/2083#discussion_r437079545", "createdAt": "2020-06-09T00:59:09Z", "author": {"login": "ajsutton"}, "path": ".circleci/config.yml", "diffHunk": "@@ -307,53 +307,88 @@ jobs:\n             kill $TEKU_PID\n             exit $EXIT_CODE\n       - store_artifacts:\n-          path: openapi.json\n+          path: ./docs/openapi.json\n       - store_artifacts:\n           path: teku_output.log\n       - persist_to_workspace:\n           root: ~/project\n           paths:\n-            - ./\n+            - ./docs/openapi.json\n \n   publishAPIDoc:\n     executor: node_executor\n     steps:\n+      # This job requires that we checkout current branch first to have all the repos.\n+      # it will not be used directly as we have the saved workspace\n+      # but will enable to checkout gh-pages branch.\n       - checkout\n       - attach_workspace:\n-          at: ~/project\n-      - add_ssh_keys:\n-          fingerprints:\n-            - '45:36:58:67:43:15:c6:5f:2c:58:ec:7f:71:e2:e6:ef'\n+          at: /tmp/workspace\n       - run:\n-          name: Set Git user params\n+          name: checkout gh pages branch and copy files from workspace\n           command: |\n-            git config --global user.name $CIRCLE_USERNAME\n-            git config --global user.email \"${CIRCLE_USERNAME}@users.noreply.github.com\"\n+            # publishing happens by pushing files to gh-pages branch\n+            # retrieve branch to publish to from CIrcle CI env vars and fallback on test-gh-pages", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3073785aa6f6b04c037607b7e8b17ad62c527dee"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3OTkwMg==", "bodyText": "I'd suggest we should fall back to gh-pages so that the code says what it will do in the normal case.  Removing the BRANCH_OVERRIDE is probably ideal if we can so that you don't have to go digging through CircleCI to find out what this will actually do.", "url": "https://github.com/ConsenSys/teku/pull/2083#discussion_r437079902", "createdAt": "2020-06-09T01:00:27Z", "author": {"login": "ajsutton"}, "path": ".circleci/config.yml", "diffHunk": "@@ -307,53 +307,88 @@ jobs:\n             kill $TEKU_PID\n             exit $EXIT_CODE\n       - store_artifacts:\n-          path: openapi.json\n+          path: ./docs/openapi.json\n       - store_artifacts:\n           path: teku_output.log\n       - persist_to_workspace:\n           root: ~/project\n           paths:\n-            - ./\n+            - ./docs/openapi.json\n \n   publishAPIDoc:\n     executor: node_executor\n     steps:\n+      # This job requires that we checkout current branch first to have all the repos.\n+      # it will not be used directly as we have the saved workspace\n+      # but will enable to checkout gh-pages branch.\n       - checkout\n       - attach_workspace:\n-          at: ~/project\n-      - add_ssh_keys:\n-          fingerprints:\n-            - '45:36:58:67:43:15:c6:5f:2c:58:ec:7f:71:e2:e6:ef'\n+          at: /tmp/workspace\n       - run:\n-          name: Set Git user params\n+          name: checkout gh pages branch and copy files from workspace\n           command: |\n-            git config --global user.name $CIRCLE_USERNAME\n-            git config --global user.email \"${CIRCLE_USERNAME}@users.noreply.github.com\"\n+            # publishing happens by pushing files to gh-pages branch\n+            # retrieve branch to publish to from CIrcle CI env vars and fallback on test-gh-pages\n+            # if no var defined\n+            [ -n \"$BRANCH_OVERRIDE\" ] && readonly BRANCH=\"$BRANCH_OVERRIDE\" || readonly BRANCH='test-gh-pages'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3073785aa6f6b04c037607b7e8b17ad62c527dee"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA4MDA5OQ==", "bodyText": "Should we delete the existing content first?  Otherwise if a file is moved both versions will stay around forever with one being stale.", "url": "https://github.com/ConsenSys/teku/pull/2083#discussion_r437080099", "createdAt": "2020-06-09T01:01:12Z", "author": {"login": "ajsutton"}, "path": ".circleci/config.yml", "diffHunk": "@@ -307,53 +307,88 @@ jobs:\n             kill $TEKU_PID\n             exit $EXIT_CODE\n       - store_artifacts:\n-          path: openapi.json\n+          path: ./docs/openapi.json\n       - store_artifacts:\n           path: teku_output.log\n       - persist_to_workspace:\n           root: ~/project\n           paths:\n-            - ./\n+            - ./docs/openapi.json\n \n   publishAPIDoc:\n     executor: node_executor\n     steps:\n+      # This job requires that we checkout current branch first to have all the repos.\n+      # it will not be used directly as we have the saved workspace\n+      # but will enable to checkout gh-pages branch.\n       - checkout\n       - attach_workspace:\n-          at: ~/project\n-      - add_ssh_keys:\n-          fingerprints:\n-            - '45:36:58:67:43:15:c6:5f:2c:58:ec:7f:71:e2:e6:ef'\n+          at: /tmp/workspace\n       - run:\n-          name: Set Git user params\n+          name: checkout gh pages branch and copy files from workspace\n           command: |\n-            git config --global user.name $CIRCLE_USERNAME\n-            git config --global user.email \"${CIRCLE_USERNAME}@users.noreply.github.com\"\n+            # publishing happens by pushing files to gh-pages branch\n+            # retrieve branch to publish to from CIrcle CI env vars and fallback on test-gh-pages\n+            # if no var defined\n+            [ -n \"$BRANCH_OVERRIDE\" ] && readonly BRANCH=\"$BRANCH_OVERRIDE\" || readonly BRANCH='test-gh-pages'\n+\n+            # switch to the publishing branch\n+            git checkout \"$BRANCH\"\n+\n+            # copy the content of the docs folder built on the previous job and attached\n+            # using workspace on temp location\n+            # cp with T option to override existing content, specially usefull for latest\n+            cp -aT /tmp/workspace/docs/. .", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3073785aa6f6b04c037607b7e8b17ad62c527dee"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dc31add4d383f74d497d02a5da39b7444a18ce8", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/3dc31add4d383f74d497d02a5da39b7444a18ce8", "committedDate": "2020-06-09T15:04:43Z", "message": "typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa5c6b3f9c37389a29944975b666be788e1d069c", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/fa5c6b3f9c37389a29944975b666be788e1d069c", "committedDate": "2020-06-10T08:57:52Z", "message": "updated branch name override per review comment\n\nand added a more explicit name as otherwise we don't know what branch\noverride it is about."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7b865d9f0fecc8365c8247a5ea0359363158b01", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/c7b865d9f0fecc8365c8247a5ea0359363158b01", "committedDate": "2020-06-11T07:08:57Z", "message": "Merge branch 'master' into 1826-api-doc-on-CI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c94fefab4ba803e0e33a4170d0455627de18d26", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/1c94fefab4ba803e0e33a4170d0455627de18d26", "committedDate": "2020-06-11T07:43:35Z", "message": "remove test publishing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NjgyOTU0", "url": "https://github.com/ConsenSys/teku/pull/2083#pullrequestreview-428682954", "createdAt": "2020-06-11T08:06:07Z", "commit": {"oid": "1c94fefab4ba803e0e33a4170d0455627de18d26"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3867, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}