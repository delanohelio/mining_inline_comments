{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0NDMzNzU2", "number": 1488, "title": "Convert DiskUpdate events to EventChannels", "bodyText": "PR Description\nConverts disk updates and disk update responses to utilize EventChannels instead of EventBus.", "createdAt": "2020-03-26T21:29:18Z", "url": "https://github.com/ConsenSys/teku/pull/1488", "merged": true, "mergeCommit": {"oid": "9f7f33c9856ac269511303ea1f9a576f9c7e3834"}, "closed": true, "closedAt": "2020-03-27T21:45:30Z", "author": {"login": "cemozerr"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRi7wNAH2gAyMzk0NDMzNzU2OjJiNmQyYWJlNmI5ZjUzMjlkMDk1ZDE3YmVkMGFhZGM0ZGEzODcyYTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcR1qRSAH2gAyMzk0NDMzNzU2OjM1MDMyYzJjYWUxNjJkMGZjZmZmNDZkMGU3MjZiNDVmMzAzMGEyYzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2b6d2abe6b9f5329d095d17bed0aadc4da3872a2", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/2b6d2abe6b9f5329d095d17bed0aadc4da3872a2", "committedDate": "2020-03-26T21:24:50Z", "message": "Convert DiskUpdate events to EventChannels"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c71b2442619cfb170edc0cd3f4a34f29e17dc16", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/6c71b2442619cfb170edc0cd3f4a34f29e17dc16", "committedDate": "2020-03-26T21:28:37Z", "message": "Run spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55284174dee98b851bae905688455877ebe5ce64", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/55284174dee98b851bae905688455877ebe5ce64", "committedDate": "2020-03-26T22:22:28Z", "message": "Fix integration test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0552b5f5ed308eb1bf7c480a1d1cbccd0fc1c610", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/0552b5f5ed308eb1bf7c480a1d1cbccd0fc1c610", "committedDate": "2020-03-26T23:21:14Z", "message": "Fix integration test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f98f2b2cb7a93cb7b0fba7d81b8524856d614b1", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/9f98f2b2cb7a93cb7b0fba7d81b8524856d614b1", "committedDate": "2020-03-27T00:16:46Z", "message": "Clean up PR"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2498b064f7f566f6655e7914f5bab58ddf77c2a", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/e2498b064f7f566f6655e7914f5bab58ddf77c2a", "committedDate": "2020-03-27T00:04:40Z", "message": "Merge branch 'master' into diskUpdateEventsToEventChannels"}, "afterCommit": {"oid": "9f98f2b2cb7a93cb7b0fba7d81b8524856d614b1", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/9f98f2b2cb7a93cb7b0fba7d81b8524856d614b1", "committedDate": "2020-03-27T00:16:46Z", "message": "Clean up PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/d234cc4db0b252efc60eac32db617ff44a2a03b3", "committedDate": "2020-03-27T00:17:12Z", "message": "Merge branch 'master' into diskUpdateEventsToEventChannels"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNTA5NzI3", "url": "https://github.com/ConsenSys/teku/pull/1488#pullrequestreview-382509727", "createdAt": "2020-03-27T00:31:30Z", "commit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "state": "APPROVED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMDozMTozMFrOF8fPRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMDo1MDowOVrOF8fh9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MDY5Mg==", "bodyText": "I wonder if we should create a text fixture class that creates a memory only ChainStorageClient and then it can automatically create the mock DiskUpdateChannel.  We never use the memory only version in production so it's weird that we've polluted our production code with test setup constructors.  Might be a separate PR though.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398970692", "createdAt": "2020-03-27T00:31:30Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/BeaconRestApiWithSwaggerTest.java", "diffHunk": "@@ -28,12 +28,13 @@\n import tech.pegasys.artemis.api.DataProvider;\n import tech.pegasys.artemis.storage.ChainStorageClient;\n import tech.pegasys.artemis.storage.CombinedChainDataClient;\n+import tech.pegasys.artemis.storage.api.DiskUpdateChannel;\n import tech.pegasys.artemis.sync.SyncService;\n import tech.pegasys.artemis.util.config.ArtemisConfiguration;\n \n public class BeaconRestApiWithSwaggerTest {\n   private final ChainStorageClient storageClient =\n-      ChainStorageClient.memoryOnlyClient(new EventBus());\n+      ChainStorageClient.memoryOnlyClient(new EventBus(), mock(DiskUpdateChannel.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MTEyMw==", "bodyText": "Not sure DiskGenesisUpdate is the right name for this event.  It's probably just GenesisEvent", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398971123", "createdAt": "2020-03-27T00:33:16Z", "author": {"login": "ajsutton"}, "path": "data/recorder/src/main/java/tech/pegasys/artemis/data/recorder/SSZTransitionRecorder.java", "diffHunk": "@@ -42,7 +42,7 @@ public SSZTransitionRecorder(final Path outputDirectory) {\n   }\n \n   @Subscribe\n-  public void onGenesisEvent(final StoreGenesisDiskUpdateEvent genesisEvent) {\n+  public void onDiskGenesisUpdate(final DiskGenesisUpdate genesisEvent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MjcxMA==", "bodyText": "This seems like a complicated way of creating a mock that will always return new SafeFuture() that doesn't complete.  Since there's no subscriber, nothing will reply so the future never completes.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398972710", "createdAt": "2020-03-27T00:39:35Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/testFixtures/java/tech/pegasys/artemis/networking/eth2/Eth2NetworkFactory.java", "diffHunk": "@@ -152,11 +156,16 @@ private NetworkConfig generateConfig() {\n     }\n \n     private void setDefaults() {\n+      if (diskUpdateChannel == null) {\n+        final EventChannels eventChannels =\n+            EventChannels.createSyncChannels(TEST_EXCEPTION_HANDLER, new NoOpMetricsSystem());\n+        diskUpdateChannel = eventChannels.getPublisher(DiskUpdateChannel.class);\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MzQxMA==", "bodyText": "Given this was just creating a TransactionPrecommit.memoryOnly() maybe it should just create a stub DiskUpdateChannel implementation that returns the same DatabaseUpdateResult.successfulWithNothingPruned() as the result of onDiskUpdate calls.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398973410", "createdAt": "2020-03-27T00:42:24Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageClient.java", "diffHunk": "@@ -59,32 +60,33 @@\n   // Time\n   private volatile UnsignedLong genesisTime;\n \n-  public static ChainStorageClient memoryOnlyClient(final EventBus eventBus) {\n-    final ChainStorageClient client =\n-        new ChainStorageClient(eventBus, TransactionPrecommit.memoryOnly());\n+  public static ChainStorageClient memoryOnlyClient(\n+      final EventBus eventBus, final DiskUpdateChannel diskUpdateChannel) {\n+    final ChainStorageClient client = new ChainStorageClient(diskUpdateChannel, eventBus);\n     eventBus.register(client);\n     return client;\n   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MzU5Mg==", "bodyText": "We don't need the wrapper DiskGenesisUpdate event here - just pass store as the argument.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398973592", "createdAt": "2020-03-27T00:43:01Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageClient.java", "diffHunk": "@@ -103,7 +105,8 @@ public void initializeFromGenesis(final BeaconState genesisState) {\n           \"Failed to set genesis state: store has already been initialized\");\n     }\n \n-    eventBus.post(new StoreGenesisDiskUpdateEvent(store));\n+    diskUpdateChannel.onDiskGenesisUpdate(new DiskGenesisUpdate(store));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3Mzk3Mg==", "bodyText": "We shouldn't use supplyAsync here or events will be recorded in parallel and potentially out of order.  Just SafeFuture.of.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398973972", "createdAt": "2020-03-27T00:44:30Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java", "diffHunk": "@@ -81,15 +83,18 @@ public void onStoreRequest(final GetStoreRequest request) {\n     eventBus.post(new GetStoreResponse(request.getId(), getStore()));\n   }\n \n-  @Subscribe\n-  public void onStoreDiskUpdate(final StoreDiskUpdateEvent event) {\n-    final DatabaseUpdateResult result = database.update(event);\n-    handleStoreUpdate(result);\n-    eventBus.post(new StoreDiskUpdateCompleteEvent(event.getTransactionId(), result));\n+  @Override\n+  public SafeFuture<DiskUpdateResult> onDiskUpdate(final DiskUpdate event) {\n+    return SafeFuture.supplyAsync(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3NDM0Ng==", "bodyText": "Actually now I think about it, as a follow up to this we should be able to remove the .join() calls after each commit() because we know each change will be applied in order.\nThough there is still a question of what to do if the returned future throws an Exception. Will need some thought, but would be really nice if we can let our processing run ahead of storage.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398974346", "createdAt": "2020-03-27T00:46:04Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java", "diffHunk": "@@ -81,15 +83,18 @@ public void onStoreRequest(final GetStoreRequest request) {\n     eventBus.post(new GetStoreResponse(request.getId(), getStore()));\n   }\n \n-  @Subscribe\n-  public void onStoreDiskUpdate(final StoreDiskUpdateEvent event) {\n-    final DatabaseUpdateResult result = database.update(event);\n-    handleStoreUpdate(result);\n-    eventBus.post(new StoreDiskUpdateCompleteEvent(event.getTransactionId(), result));\n+  @Override\n+  public SafeFuture<DiskUpdateResult> onDiskUpdate(final DiskUpdate event) {\n+    return SafeFuture.supplyAsync(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3Mzk3Mg=="}, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3NTIxNA==", "bodyText": "I wonder if we should be using Storage instead of Disk for these classes.  The storage system doesn't necessarily have to store to disk (it could be S3StorageServer etc).", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398975214", "createdAt": "2020-03-27T00:49:14Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/api/DiskUpdateChannel.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.storage.api;\n+\n+import tech.pegasys.artemis.storage.events.diskupdates.DiskGenesisUpdate;\n+import tech.pegasys.artemis.storage.events.diskupdates.DiskUpdate;\n+import tech.pegasys.artemis.storage.events.diskupdates.DiskUpdateResult;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+\n+public interface DiskUpdateChannel {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3NTQ3OA==", "bodyText": "Slightly odd that we're using StubDiskUpdateChannel here but a mock in a lot of other places.  Seems like we could just be using the stub.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398975478", "createdAt": "2020-03-27T00:50:09Z", "author": {"login": "ajsutton"}, "path": "storage/src/test/java/tech/pegasys/artemis/storage/MapDbDatabaseTest.java", "diffHunk": "@@ -118,7 +116,7 @@ public void shouldRecreateOriginalGenesisStore() {\n \n   @Test\n   public void shouldGetHotBlockByRoot() {\n-    final Transaction transaction = store.startTransaction(databaseTransactionPrecommit);\n+    final Transaction transaction = store.startTransaction(new StubDiskUpdateChannel());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37f3c88fb87eb194f34e83e4ff6b724282947e1a", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/37f3c88fb87eb194f34e83e4ff6b724282947e1a", "committedDate": "2020-03-27T19:06:56Z", "message": "Resolve comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1065f5419d30b45e64e6f0fbb0f9360a8b8472ec", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/1065f5419d30b45e64e6f0fbb0f9360a8b8472ec", "committedDate": "2020-03-27T19:09:44Z", "message": "Merge remote-tracking branch 'remotes/origin/master' into diskUpdateEventsToEventChannels\n\n# Conflicts:\n#\tdata/provider/src/test/java/tech/pegasys/artemis/api/ChainDataProviderTest.java\n#\tvalidator/coordinator/src/test/java/tech/pegasys/artemis/validator/coordinator/ValidatorCoordinatorTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35032c2cae162d0fcfff46d0e726b45f3030a2c1", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/35032c2cae162d0fcfff46d0e726b45f3030a2c1", "committedDate": "2020-03-27T19:13:56Z", "message": "Fix merge conflicts"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4394, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}