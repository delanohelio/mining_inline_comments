{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1NDk3MTA3", "number": 1101, "title": "[BC-220] Don't drop unattached blocks", "bodyText": "PR Description\nWhen a block is gossiped and we don't have the pre-state associated with this block, don't re-gossip the block but do post an event so that BlockPropagationManager can track the block.  Also add some extra validation to prevent us from re-gossiping future blocks (see: https://github.com/ethereum/eth2.0-specs/blob/v0.10.0/specs/phase0/p2p-interface.md#global-topics).", "createdAt": "2020-01-21T20:29:56Z", "url": "https://github.com/ConsenSys/teku/pull/1101", "merged": true, "mergeCommit": {"oid": "c6794d3c9507592c3feaf80f50959711e82a8f0f"}, "closed": true, "closedAt": "2020-01-21T22:21:43Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8meO6AH2gAyMzY1NDk3MTA3OmYwMTczNjAwNDcyNjg4MGVmZTliOTEyOTJhNmU4MmMwYTc5MzYzOGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8ooFLAH2gAyMzY1NDk3MTA3OjhlNDA1ZjA2YmFjODFhMWM1MDJiMDJjZjczOGJkMjllMjA2YWQ4NDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f01736004726880efe9b91292a6e82c0a793638b", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f01736004726880efe9b91292a6e82c0a793638b", "committedDate": "2020-01-21T19:39:48Z", "message": "Post block events for blocks with unknown prestate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cd0f53f2024818b75ccc084f15ab80e1fcb3503", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/6cd0f53f2024818b75ccc084f15ab80e1fcb3503", "committedDate": "2020-01-21T20:11:13Z", "message": "Don't gossip future blocks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTgwNjg2", "url": "https://github.com/ConsenSys/teku/pull/1101#pullrequestreview-346180686", "createdAt": "2020-01-21T20:48:19Z", "commit": {"oid": "6cd0f53f2024818b75ccc084f15ab80e1fcb3503"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMDo0ODoxOVrOFgIUGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMDo0ODoxOVrOFgIUGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIzNDk2OA==", "bodyText": "It feels very weird to say the data is invalid but process it anyway.  Kind of have to with the way gossip works but still awkward. Just something to ponder in the back of our minds about how it could be done better.", "url": "https://github.com/ConsenSys/teku/pull/1101#discussion_r369234968", "createdAt": "2020-01-21T20:48:19Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/gossip/topics/BlockTopicHandler.java", "diffHunk": "@@ -62,14 +66,23 @@ protected SignedBeaconBlock deserialize(final Bytes bytes) throws SSZException {\n \n   @Override\n   protected boolean validateData(final SignedBeaconBlock block) {\n+    if (chainStorageClient.isPreGenesis()) {\n+      // We can't process blocks pre-genesis\n+      return false;\n+    }\n+\n     final BeaconState preState =\n         chainStorageClient.getStore().getBlockState(block.getMessage().getParent_root());\n     if (preState == null) {\n-      // TODO - handle future and unattached blocks\n-      LOG.warn(\n-          \"Dropping block message at slot {} with unknown parent state {}\",\n-          block.getMessage().getSlot(),\n-          block.getMessage().getParent_root());\n+      // Post event even if we don't have the prestate\n+      eventBus.post(createEvent(block));\n+      return false;\n+    }\n+\n+    final UnsignedLong currentSlot = get_current_slot(chainStorageClient.getStore());\n+    if (block.getSlot().compareTo(currentSlot) > 0) {\n+      // Don't gossip future blocks\n+      eventBus.post(createEvent(block));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cd0f53f2024818b75ccc084f15ab80e1fcb3503"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f86ec1903e948b0eb8894cd9d1aad2a8ad9a40e0", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f86ec1903e948b0eb8894cd9d1aad2a8ad9a40e0", "committedDate": "2020-01-21T21:59:42Z", "message": "Fix ordering of block validation checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25bf937aad19e322f0fbf53db7f765ccc4e645eb", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/25bf937aad19e322f0fbf53db7f765ccc4e645eb", "committedDate": "2020-01-21T22:00:16Z", "message": "Update integration tests to support block slot validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e405f06bac81a1c502b02cf738bd29e206ad846", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/8e405f06bac81a1c502b02cf738bd29e206ad846", "committedDate": "2020-01-21T22:10:22Z", "message": "Merge branch 'master' into bc-220/dont-drop-unattached-blocks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4214, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}