{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3NDQ3ODg5", "number": 3182, "title": "Limit size of range used when requesting deposit logs", "bodyText": "PR Description\nInfura has a limit of 10,000 log events that it will return from a single call and ETH1 nodes may struggle to respond to requests over a very large range of blocks.  To handle this, DepositFetcher now limits the number of blocks requested in each batch and if the request times out or is rejected by Infura, the batch size is halved.\nTo avoid the batch size being reduced to a very small number because of a busy period and then making a lot of extra requests for the rest of the chain, the batch size increases slightly after each successful request.  The batch size deliberately grows much slower than it shrinks to avoid bouncing around too much.\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-09T03:52:31Z", "url": "https://github.com/ConsenSys/teku/pull/3182", "merged": true, "mergeCommit": {"oid": "00af3b87f3e47fc9f946ed2a6afc523a051cb83f"}, "closed": true, "closedAt": "2020-11-09T05:25:06Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdasdAHAH2gAyNTE3NDQ3ODg5OjEzYTc1NzRjNzIwY2I3ZDNlNGY1MDkzNGYyM2IyZjFkMjBhMzA2NzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdatz1ugFqTUyNTkzMDc0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "13a7574c720cb7d3e4f50934f23b2f1d20a30670", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/13a7574c720cb7d3e4f50934f23b2f1d20a30670", "committedDate": "2020-11-09T03:46:46Z", "message": "Limit number of blocks deposit logs are requested for.\nReduce request size if logs are not returned because the result set is too large (Infura) or times out."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ad56fafcebec88354348448fc097cf1e9cab436", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/2ad56fafcebec88354348448fc097cf1e9cab436", "committedDate": "2020-11-09T03:47:45Z", "message": "Ensure batch size will always grow again."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e98772a625d6a42099555a856173b2ca508b523", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/5e98772a625d6a42099555a856173b2ca508b523", "committedDate": "2020-11-09T03:50:42Z", "message": "Add comment."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1OTI5Mjc0", "url": "https://github.com/ConsenSys/teku/pull/3182#pullrequestreview-525929274", "createdAt": "2020-11-09T05:16:34Z", "commit": {"oid": "5e98772a625d6a42099555a856173b2ca508b523"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwNToxNjozNFrOHvfRQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwNToxNjozNFrOHvfRQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1NzQ0Mg==", "bodyText": "'FROM' eth1 node?", "url": "https://github.com/ConsenSys/teku/pull/3182#discussion_r519557442", "createdAt": "2020-11-09T05:16:34Z", "author": {"login": "rolfyone"}, "path": "pow/src/main/java/tech/pegasys/teku/pow/contract/DepositContract.java", "diffHunk": "@@ -138,11 +138,19 @@ protected DepositContract(\n             .ethGetLogs(filter)\n             .sendAsync()\n             .thenApply(\n-                logs ->\n-                    logs.getLogs().stream()\n-                        .map(log -> (Log) log.get())\n-                        .map(this::convertLogToDepositEventEventResponse)\n-                        .collect(Collectors.toList())));\n+                logs -> {\n+                  if (logs.getLogs() == null) {\n+                    // We got a response from the node but it didn't include even an empty list\n+                    // of logs.  This happens with Infura when more than 10,000 log entries match\n+                    // so treat as an explicit rejection of the request to allow the requested block\n+                    // range to be reduced.\n+                    throw new RejectedRequestException(\"No logs returned by ETH1 node\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e98772a625d6a42099555a856173b2ca508b523"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1OTMwNzQx", "url": "https://github.com/ConsenSys/teku/pull/3182#pullrequestreview-525930741", "createdAt": "2020-11-09T05:21:38Z", "commit": {"oid": "5e98772a625d6a42099555a856173b2ca508b523"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4413, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}