{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NjIyNDcw", "number": 1307, "title": "Disconnect cleanly", "bodyText": "PR Description\nSupport sending a GOODBYE message when peers are disconnected. To maintain the clear separation between Eth2 and LibP2P layers, Peer supports a custom DisconnectRequestHandler which by default just disconnects, but is set by the ETH2 network to send a goodbye request.\nAlso found that when we sent a goodbye request we were depending on the other side closing the connection - a misbehaving peer could wind up holding the connection open. To avoid this once we've sent the goodbye message we now disconnect.", "createdAt": "2020-03-06T04:01:25Z", "url": "https://github.com/ConsenSys/teku/pull/1307", "merged": true, "mergeCommit": {"oid": "a99697641d57a3d3c3d940df75a8c82df712689a"}, "closed": true, "closedAt": "2020-03-07T03:23:38Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcK3QdggH2gAyMzg0NjIyNDcwOjhmOGY0MGU5ZjMxNDJjMWEwNzI3NGUzM2VjOWMxM2UzZmRjYWU5OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcLKsJNgH2gAyMzg0NjIyNDcwOjdiNzU2YzVjODEzMmJmODFmNTQwYzBlNTczZWM4YmY0OTg2ZjQ4M2E=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8f8f40e9f3142c1a07274e33ec9c13e3fdcae993", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/8f8f40e9f3142c1a07274e33ec9c13e3fdcae993", "committedDate": "2020-03-06T03:08:05Z", "message": "Send GOODBYE message politely when disconnecting excess peers."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7f10da5411bd796b821f1e915d468f4d7f8a8ab", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d7f10da5411bd796b821f1e915d468f4d7f8a8ab", "committedDate": "2020-03-06T03:54:39Z", "message": "Consistently use disconnectCleanly so that we guarantee disconnection even if the other side misbehaves."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "634866ab2aede026311c074ebd55869e5b717a1c", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/634866ab2aede026311c074ebd55869e5b717a1c", "committedDate": "2020-03-06T04:01:35Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into clean-disconnect"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNDAzOTYx", "url": "https://github.com/ConsenSys/teku/pull/1307#pullrequestreview-370403961", "createdAt": "2020-03-06T15:22:25Z", "commit": {"oid": "634866ab2aede026311c074ebd55869e5b717a1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNToyMjoyNVrOFy8j9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNToyMjoyNVrOFy8j9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk2NTM2Nw==", "bodyText": "It seems like we're calling connected.set(false) twice. Is there a specific reason we do that?", "url": "https://github.com/ConsenSys/teku/pull/1307#discussion_r388965367", "createdAt": "2020-03-06T15:22:25Z", "author": {"login": "cemozerr"}, "path": "networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/LibP2PPeer.java", "diffHunk": "@@ -58,11 +65,29 @@ public boolean isConnected() {\n \n   @Override\n   @SuppressWarnings(\"FutureReturnValueIgnored\")\n-  public void disconnect() {\n+  public void disconnectImmediately() {\n     connected.set(false);\n     connection.close();\n   }\n \n+  @Override\n+  public void disconnectCleanly(final DisconnectRequestHandler.DisconnectReason reason) {\n+    connected.set(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "634866ab2aede026311c074ebd55869e5b717a1c"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNDA3ODQz", "url": "https://github.com/ConsenSys/teku/pull/1307#pullrequestreview-370407843", "createdAt": "2020-03-06T15:27:30Z", "commit": {"oid": "634866ab2aede026311c074ebd55869e5b717a1c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b756c5c8132bf81f540c0e573ec8bf4986f483a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/7b756c5c8132bf81f540c0e573ec8bf4986f483a", "committedDate": "2020-03-07T01:46:31Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into clean-disconnect"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3913, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}