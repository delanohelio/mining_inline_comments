{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2NDUyMTIw", "number": 1630, "title": "Improve genesis performance and logging", "bodyText": "PR Description\nImprove the user experience around startup.\n\nSend status logs to the console which logging mode is set to \"both\". They're important messages that shouldn't be hidden off in the log file.\nProvide status logs indicating which mode of genesis is being used (load from existing store on disk, load from genesis file, mock genesis or eth1 chain).\nCount the number of activated validators in GenesisGenerator instead of having to generate the state and iterate through all validators counting them.\nSend requests for ETH1 block data in increasing order of block number so that the data we get back first can be immediately sent off for processing. Previously we sent requests in reverse order and so wound up waiting for them all to complete before processing any deposits\nAdd status logs to report when min genesis time is reached and for each full percentage of required validators added so the user can see progress towards genesis.\nReduce log level for invalid deposits to debug instead of warn. They're really very common and probably not yours so you don't care.", "createdAt": "2020-04-21T05:44:44Z", "url": "https://github.com/ConsenSys/teku/pull/1630", "merged": true, "mergeCommit": {"oid": "5aa181047a9055b54976815a3923fb7fd66817bf"}, "closed": true, "closedAt": "2020-04-21T20:34:19Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZr2e6gH2gAyNDA2NDUyMTIwOjhmODE1MjM4MTNiZGI0YWIzZDc5MmEzZGExMzEwYTY3OGNlOWFkMGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZ1djLAFqTM5NzQ0OTA5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8f81523813bdb4ab3d792a3da1310a678ce9ad0a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/8f81523813bdb4ab3d792a3da1310a678ce9ad0a", "committedDate": "2020-04-21T04:19:37Z", "message": "Send status logs to the console not the file.\nImprove logging at startup around source of genesis state."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d905852ca95b3663509a13d14d891f81355ee8d", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/7d905852ca95b3663509a13d14d891f81355ee8d", "committedDate": "2020-04-21T05:38:46Z", "message": "Request block data in the order they will be required (not reverse order) so we start processing deposits sooner.\nProvide status logs for each whole percentage increase in the number of registered validators."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd1b854141a76a5f89500c51ed84867d4c66c10e", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/dd1b854141a76a5f89500c51ed84867d4c66c10e", "committedDate": "2020-04-21T05:40:08Z", "message": "Fix grammar."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a067af24ce420e4cbe30dec048d3838f29cdf2b7", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/a067af24ce420e4cbe30dec048d3838f29cdf2b7", "committedDate": "2020-04-21T10:44:57Z", "message": "Ignore min genesis time block if we have already loaded genesis."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDM3NDAz", "url": "https://github.com/ConsenSys/teku/pull/1630#pullrequestreview-397437403", "createdAt": "2020-04-21T15:18:55Z", "commit": {"oid": "a067af24ce420e4cbe30dec048d3838f29cdf2b7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNToxODo1NVrOGJLfUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNToxODo1NVrOGJLfUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI3ODYxMQ==", "bodyText": "nice.", "url": "https://github.com/ConsenSys/teku/pull/1630#discussion_r412278611", "createdAt": "2020-04-21T15:18:55Z", "author": {"login": "cemozerr"}, "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/genesis/GenesisHandler.java", "diffHunk": "@@ -54,16 +56,31 @@ public void onDepositsFromBlock(final DepositsFromBlockEvent event) {\n \n   @Override\n   public void onMinGenesisTimeBlock(MinGenesisTimeBlockEvent event) {\n+    if (!recentChainData.isPreGenesis()) {\n+      return;\n+    }\n+    STATUS_LOG.minGenesisTimeReached();\n     processNewData(event.getBlockHash(), event.getTimestamp(), List.of());\n   }\n \n   private void processNewData(\n       Bytes32 blockHash, UnsignedLong timestamp, List<DepositWithIndex> deposits) {\n+    final int previousValidatorRequirementPercent =\n+        roundPercent(genesisGenerator.getActiveValidatorCount());\n     genesisGenerator.updateCandidateState(blockHash, timestamp, deposits);\n \n-    genesisGenerator\n-        .getGenesisStateIfValid(BeaconStateUtil::is_valid_genesis_state)\n-        .ifPresent(this::eth2Genesis);\n+    final int newActiveValidatorCount = genesisGenerator.getActiveValidatorCount();\n+    if (BeaconStateUtil.is_valid_genesis_state(\n+        genesisGenerator.getGenesisTime(), newActiveValidatorCount)) {\n+      eth2Genesis(genesisGenerator.getGenesisState());\n+    } else if (roundPercent(newActiveValidatorCount) > previousValidatorRequirementPercent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a067af24ce420e4cbe30dec048d3838f29cdf2b7"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDQ3Mzc3", "url": "https://github.com/ConsenSys/teku/pull/1630#pullrequestreview-397447377", "createdAt": "2020-04-21T15:29:24Z", "commit": {"oid": "a067af24ce420e4cbe30dec048d3838f29cdf2b7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNToyOToyNFrOGJMBhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNToyOToyNFrOGJMBhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI4NzM2Ng==", "bodyText": "What's is the reasoning behind getting all the status logs in one place? It seems similar to having all constants in one file, which we seem to not want to be doing going forward.", "url": "https://github.com/ConsenSys/teku/pull/1630#discussion_r412287366", "createdAt": "2020-04-21T15:29:24Z", "author": {"login": "cemozerr"}, "path": "logging/src/main/java/tech/pegasys/teku/logging/StatusLogger.java", "diffHunk": "@@ -60,10 +61,37 @@ public void validatorDepositEncryptedKeystoreWriterFailure(\n   }\n \n   public void beginInitializingChainData() {\n-    log.info(\"Begin initializing chain data from storage\");\n+    log.info(\"Initializing storage\");\n   }\n \n   public void finishInitializingChainData() {\n-    log.info(\"Finish initializing chain data from storage\");\n+    log.info(\"Storage initialization complete\");\n+  }\n+\n+  public void generatingMockStartGenesis(final long genesisTime, final int size) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a067af24ce420e4cbe30dec048d3838f29cdf2b7"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDQ5MDky", "url": "https://github.com/ConsenSys/teku/pull/1630#pullrequestreview-397449092", "createdAt": "2020-04-21T15:31:27Z", "commit": {"oid": "a067af24ce420e4cbe30dec048d3838f29cdf2b7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4333, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}