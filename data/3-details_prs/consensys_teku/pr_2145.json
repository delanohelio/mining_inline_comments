{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0MTY0MDQz", "number": 2145, "title": "Removes recursion from get_ancestor()", "bodyText": "PR Description\nI and others have been experiencing stack overflows during a long period of non-finalisation due to deep recursion in the fork choice rule. This PR removes the recursion from get_ancestor().\nI've run this for several hours on Witti, and it seems good.\nFixed Issue(s)\nFixes #2144\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-06-14T15:52:13Z", "url": "https://github.com/ConsenSys/teku/pull/2145", "merged": true, "mergeCommit": {"oid": "54f18c91cada1ebaa374c340b2dddf3febd1b4ce"}, "closed": true, "closedAt": "2020-06-15T14:46:30Z", "author": {"login": "benjaminion"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrNwozgH2gAyNDM0MTY0MDQzOmYzYTA5YzhmNjMxY2NhMDA2ZGVlMGNhNDc5MmNlODdjZGY1MWJiNDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrhmpFAH2gAyNDM0MTY0MDQzOmQ1OWIyOTQ1Mzc4ZGM5MzQ1MTVkNGIyYmIyZjVjMDAyZTYyOGFkMzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f3a09c8f631cca006dee0ca4792ce87cdf51bb49", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/f3a09c8f631cca006dee0ca4792ce87cdf51bb49", "committedDate": "2020-06-14T15:26:43Z", "message": "Removes recursion from get_ancestor()\n\nI and others have been experiencing stack overflows during a long period\nof non-finalisation. Removing the recursion from get_ancestor() should\nhelp."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMjUwMzAw", "url": "https://github.com/ConsenSys/teku/pull/2145#pullrequestreview-430250300", "createdAt": "2020-06-14T20:55:00Z", "commit": {"oid": "f3a09c8f631cca006dee0ca4792ce87cdf51bb49"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQyMDo1NTowMFrOGjfVDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQyMDo1NTowMFrOGjfVDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2NjYzOQ==", "bodyText": "This isn't quite right - the Optional returned by forkChoiceStrategy.blockSlot(parentRoot) may be empty (which would indicate we're importing a block from an invalid fork).\nWe'll want:\nBytes32 parentRoot = root;\n    Optional<UnsignedLong> blockSlot = forkChoiceStrategy.blockSlot(parentRoot);\n    while (blockSlot.isPresent() && blockSlot.get().compareTo(slot) > 0) {\n      parentRoot = forkChoiceStrategy.blockParentRoot(parentRoot).orElseThrow();\n      blockSlot = forkChoiceStrategy.blockSlot(parentRoot);\n    }\n    return blockSlot.isPresent() ? Optional.of(parentRoot) : Optional.empty();", "url": "https://github.com/ConsenSys/teku/pull/2145#discussion_r439866639", "createdAt": "2020-06-14T20:55:00Z", "author": {"login": "ajsutton"}, "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/ForkChoiceUtil.java", "diffHunk": "@@ -84,23 +84,11 @@ public static UnsignedLong compute_slots_since_epoch_start(UnsignedLong slot) {\n    */\n   private static Optional<Bytes32> get_ancestor(\n       ForkChoiceStrategy forkChoiceStrategy, Bytes32 root, UnsignedLong slot) {\n-    return forkChoiceStrategy\n-        .blockSlot(root)\n-        .flatMap(\n-            blockSlot -> {\n-              if (blockSlot.compareTo(slot) > 0) {\n-                return get_ancestor(\n-                    forkChoiceStrategy,\n-                    forkChoiceStrategy.blockParentRoot(root).orElseThrow(),\n-                    slot);\n-              } else if (blockSlot.equals(slot)) {\n-                return Optional.of(root);\n-              } else {\n-                // root is older than the queried slot, thus a skip slot. Return earliest root prior\n-                // to slot.\n-                return Optional.of(root);\n-              }\n-            });\n+    Bytes32 parentRoot = root;\n+    while (forkChoiceStrategy.blockSlot(parentRoot).get().compareTo(slot) > 0) {\n+      parentRoot = forkChoiceStrategy.blockParentRoot(parentRoot).orElseThrow();\n+    }\n+    return Optional.of(parentRoot);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3a09c8f631cca006dee0ca4792ce87cdf51bb49"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4494455e5de9ebf7bfe48e2d3aa9a44447979977", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/4494455e5de9ebf7bfe48e2d3aa9a44447979977", "committedDate": "2020-06-14T21:02:56Z", "message": "Handle unknown parent blocks in get_ancestor."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNjY2ODU0", "url": "https://github.com/ConsenSys/teku/pull/2145#pullrequestreview-430666854", "createdAt": "2020-06-15T13:55:22Z", "commit": {"oid": "4494455e5de9ebf7bfe48e2d3aa9a44447979977"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMzo1NToyMlrOGjzQ5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMzo1NToyMlrOGjzQ5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE5MzI1Mw==", "bodyText": "This looks good to me, but independent from this PR, makes me wonder if throwing here when the parentRoot does not exist in our ProtoArray was the right call. Seems like we simply should be returning an empty optional when we don't have the parent root, since the parent root is potentially a root of a block in a non-finalized fork, and we should be fine with that. Will do a follow-up PR on this.", "url": "https://github.com/ConsenSys/teku/pull/2145#discussion_r440193253", "createdAt": "2020-06-15T13:55:22Z", "author": {"login": "cemozerr"}, "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/ForkChoiceUtil.java", "diffHunk": "@@ -84,23 +84,13 @@ public static UnsignedLong compute_slots_since_epoch_start(UnsignedLong slot) {\n    */\n   private static Optional<Bytes32> get_ancestor(\n       ForkChoiceStrategy forkChoiceStrategy, Bytes32 root, UnsignedLong slot) {\n-    return forkChoiceStrategy\n-        .blockSlot(root)\n-        .flatMap(\n-            blockSlot -> {\n-              if (blockSlot.compareTo(slot) > 0) {\n-                return get_ancestor(\n-                    forkChoiceStrategy,\n-                    forkChoiceStrategy.blockParentRoot(root).orElseThrow(),\n-                    slot);\n-              } else if (blockSlot.equals(slot)) {\n-                return Optional.of(root);\n-              } else {\n-                // root is older than the queried slot, thus a skip slot. Return earliest root prior\n-                // to slot.\n-                return Optional.of(root);\n-              }\n-            });\n+    Bytes32 parentRoot = root;\n+    Optional<UnsignedLong> blockSlot = forkChoiceStrategy.blockSlot(root);\n+    while (blockSlot.isPresent() && blockSlot.get().compareTo(slot) > 0) {\n+      parentRoot = forkChoiceStrategy.blockParentRoot(parentRoot).orElseThrow();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4494455e5de9ebf7bfe48e2d3aa9a44447979977"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d59b2945378dc934515d4b2bb2f5c002e628ad31", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/d59b2945378dc934515d4b2bb2f5c002e628ad31", "committedDate": "2020-06-15T14:33:54Z", "message": "Merge branch 'master' into unrecurse-get-ancestor"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3924, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}