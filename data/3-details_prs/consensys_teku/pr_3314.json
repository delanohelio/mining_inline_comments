{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3MzQxMjEw", "number": 3314, "title": "Use ValidatorsUtil.getValidatorPubKey where possible", "bodyText": "PR Description\nValidator.getPubkey() deserializes compressed pubkey bytes and creates BLSPublicKey instance on every invocation. That's pretty expensive operation.\nWhenever possible the ValidatorsUtil.getValidatorPubKey should be used as it caches BLSPublicKey instances for validators.\nWould also be good to make Validator.getPubkey() returning Bytes48 to make creation of BLSPublicKey explicit.\nFixed Issue(s)\nPartially fix #3294 (speedup ~x50-x100)\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-25T10:28:18Z", "url": "https://github.com/ConsenSys/teku/pull/3314", "merged": true, "mergeCommit": {"oid": "af1b5caf7966d7f9c4ead44f58b7d59cd166a772"}, "closed": true, "closedAt": "2020-11-26T09:19:57Z", "author": {"login": "Nashatyrev"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdf7lpAAH2gAyNTI3MzQxMjEwOmZkN2VmOTFlMTFiNmU2YmI4OTkyYmM1YjgzNTRiMzQwNjYwOTE0N2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgPNcGAH2gAyNTI3MzQxMjEwOjBmMmUwM2RhMDdjN2EwODgwODI1NjNmMGVmZWU3MDhmZDRhNzk4ZmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fd7ef91e11b6e6bb8992bc5b8354b3406609147c", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/fd7ef91e11b6e6bb8992bc5b8354b3406609147c", "committedDate": "2020-11-25T10:14:24Z", "message": "Make Validator.getPubkey() to return Bytes48 instead of construction-expensive BLSPublicKey\nUse ValidatorsUtil.getValidatorPubKey where possible to make use of BLSPublicKey instance cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "803cfeb706d74352860a966e1383b59cc2e4a2d1", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/803cfeb706d74352860a966e1383b59cc2e4a2d1", "committedDate": "2020-11-25T10:34:25Z", "message": "Add javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d88b16c422c517e3388e0afe28cacad0df637ab6", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/d88b16c422c517e3388e0afe28cacad0df637ab6", "committedDate": "2020-11-25T11:12:47Z", "message": "Fix Validator SSZ"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9fc54ab10669681a35c1b2620f96584690c1cc7", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/e9fc54ab10669681a35c1b2620f96584690c1cc7", "committedDate": "2020-11-25T11:54:18Z", "message": "Fix ValidatorApiHandler.createAttesterDuties handling of invalid validatorIndex"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4ODcxNjU3", "url": "https://github.com/ConsenSys/teku/pull/3314#pullrequestreview-538871657", "createdAt": "2020-11-25T22:01:36Z", "commit": {"oid": "e9fc54ab10669681a35c1b2620f96584690c1cc7"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMjowMTozN1rOH6FLww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMjoxMTowOFrOH6FaSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY2NDM4Nw==", "bodyText": "nit: Can we make this throw BlockProcessingException specifically.  It shouldn't ever happen but if it does it should be the same as the signature being invalid to ensure it gets handled correctly.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ValidatorsUtil.getValidatorPubKey(state, UInt64.valueOf(proposerIndex)).orElseThrow();\n          \n          \n            \n                    ValidatorsUtil.getValidatorPubKey(state, UInt64.valueOf(proposerIndex)).orElseThrow(() -> new BlockProcessingException(\"Public key not found for validator \" + proposerIndex));", "url": "https://github.com/ConsenSys/teku/pull/3314#discussion_r530664387", "createdAt": "2020-11-25T22:01:37Z", "author": {"login": "ajsutton"}, "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/blockvalidator/SimpleBlockValidator.java", "diffHunk": "@@ -120,13 +122,14 @@ public SimpleBlockValidator(\n \n   private void verify_block_signature(final BeaconState state, SignedBeaconBlock signed_block)\n       throws BlockProcessingException {\n-    final Validator proposer =\n-        state.getValidators().get(get_beacon_proposer_index(state, signed_block.getSlot()));\n+    final int proposerIndex = get_beacon_proposer_index(state, signed_block.getSlot());\n+    final BLSPublicKey proposerPublicKey =\n+        ValidatorsUtil.getValidatorPubKey(state, UInt64.valueOf(proposerIndex)).orElseThrow();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9fc54ab10669681a35c1b2620f96584690c1cc7"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY2NzQ1MA==", "bodyText": "nit: Would be good to just return false here if the pub key isn't available. Little surprised we've gotten away with the current version actually as we don't appear to check the proposer index ahead of time.", "url": "https://github.com/ConsenSys/teku/pull/3314#discussion_r530667450", "createdAt": "2020-11-25T22:09:21Z", "author": {"login": "ajsutton"}, "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/operationsignatureverifiers/ProposerSlashingSignatureVerifier.java", "diffHunk": "@@ -40,11 +39,7 @@ public boolean verifySignature(\n     final BeaconBlockHeader header1 = proposerSlashing.getHeader_1().getMessage();\n     final BeaconBlockHeader header2 = proposerSlashing.getHeader_2().getMessage();\n     BLSPublicKey publicKey =\n-        BeaconStateCache.getTransitionCaches(state)\n-            .getValidatorsPubKeys()\n-            .get(\n-                header1.getProposerIndex(),\n-                idx -> state.getValidators().get(toIntExact(idx.longValue())).getPubkey());\n+        ValidatorsUtil.getValidatorPubKey(state, header1.getProposerIndex()).orElseThrow();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9fc54ab10669681a35c1b2620f96584690c1cc7"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY2Nzk3MQ==", "bodyText": "Returning false here would be good too.", "url": "https://github.com/ConsenSys/teku/pull/3314#discussion_r530667971", "createdAt": "2020-11-25T22:10:42Z", "author": {"login": "ajsutton"}, "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/operationsignatureverifiers/VoluntaryExitSignatureVerifier.java", "diffHunk": "@@ -34,11 +33,7 @@ public boolean verifySignature(\n     final VoluntaryExit exit = signedExit.getMessage();\n \n     BLSPublicKey publicKey =\n-        BeaconStateCache.getTransitionCaches(state)\n-            .getValidatorsPubKeys()\n-            .get(\n-                exit.getValidator_index(),\n-                idx -> state.getValidators().get(toIntExact(idx.longValue())).getPubkey());\n+        ValidatorsUtil.getValidatorPubKey(state, exit.getValidator_index()).orElseThrow();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9fc54ab10669681a35c1b2620f96584690c1cc7"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY2ODEwNw==", "bodyText": "nit: Can just use\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                fixedPartsList.addAll(Collections.singleton(getPubkey()));\n          \n          \n            \n                fixedPartsList.add(getPubkey());", "url": "https://github.com/ConsenSys/teku/pull/3314#discussion_r530668107", "createdAt": "2020-11-25T22:11:08Z", "author": {"login": "ajsutton"}, "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/state/Validator.java", "diffHunk": "@@ -127,7 +129,7 @@ public int getSSZFieldCount() {\n   @Override\n   public List<Bytes> get_fixed_parts() {\n     List<Bytes> fixedPartsList = new ArrayList<>();\n-    fixedPartsList.addAll(getPubkey().get_fixed_parts());\n+    fixedPartsList.addAll(Collections.singleton(getPubkey()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9fc54ab10669681a35c1b2620f96584690c1cc7"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8596af11603f587a622c3e039ecc8678255c22e8", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/8596af11603f587a622c3e039ecc8678255c22e8", "committedDate": "2020-11-26T08:09:43Z", "message": "Throw BlocksProcessingException instead of NoSuchelementException\n\nCo-authored-by: Adrian Sutton <adrian@symphonious.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7679f337aa64f39129226adc56653b863fe5aff0", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/7679f337aa64f39129226adc56653b863fe5aff0", "committedDate": "2020-11-26T08:26:11Z", "message": "Just return false from verifySignature() when slashing proposer index is invalid"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3042c92e86b6a509f420ffc2d5e0987d3c9c0df", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/d3042c92e86b6a509f420ffc2d5e0987d3c9c0df", "committedDate": "2020-11-26T08:40:07Z", "message": "Shorten the code\n\nCo-authored-by: Adrian Sutton <adrian@symphonious.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed0b0c699878bce301426294320dd58107072651", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/ed0b0c699878bce301426294320dd58107072651", "committedDate": "2020-11-26T08:46:59Z", "message": "Just return false from verifySignature() when voluntary exit validator index is invalid"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dabded072f40eaaed51b5b611935321e2c1e8e25", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/dabded072f40eaaed51b5b611935321e2c1e8e25", "committedDate": "2020-11-26T08:48:44Z", "message": "Merge branch 'fix/use-validator-pubkey-cache' of https://github.com/Nashatyrev/artemis into fix/use-validator-pubkey-cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ab78ffbbd6fad063a9d702734e298cc288e9d20", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/9ab78ffbbd6fad063a9d702734e298cc288e9d20", "committedDate": "2020-11-26T08:49:37Z", "message": "Merge branch 'master' into fix/use-validator-pubkey-cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f2e03da07c7a088082563f0efee708fd4a798fe", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/0f2e03da07c7a088082563f0efee708fd4a798fe", "committedDate": "2020-11-26T09:06:04Z", "message": "Sptoless"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4314, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}