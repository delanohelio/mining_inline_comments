{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1NzE3Njk4", "number": 1618, "title": "cli/deposit: significantly simplify validator keystore path", "bodyText": "PR Description\ncurrently the validator keys are stored in an unnecessary long path and file name, e.g.,\n~/.opt/byz-f/teku q9-valid-path 7s\n\u276f ll ~/.local/share/teku/keystore/validator_0x8612758a1376713c90900c6681849f1e04b0bca243e00246657932822fd40589a8c55165fc3b480365bcce75fa854e5c/\ntotal 16K\n4.0K drwxr-xr-x  2 user users 4.0K Apr  8 21:25 ./\n4.0K drwxr-xr-x 16 user users 4.0K Apr 19 14:58 ../\n4.0K -rw-r--r--  1 user users  893 Apr  8 21:25 validator_0x8612758a1376713c90900c6681849f1e04b0bca243e00246657932822fd40589a8c55165fc3b480365bcce75fa854e5c.json\n4.0K -rw-r--r--  1 user users  893 Apr  8 21:25 withdrawal_0x8dc343b8bfb07f5bc93d43299d65cf577dc76aa95473a5c2563a0149e15fb077eedd52a52f699943f60ebfa02d2f9745.json\n\nthis pull request proposes to simplify the path significantly for usability handling encrypted key files:\n~/.opt/byz-f/teku q9-valid-path\n\u276f ll ~/.local/share/teku/keystore/validator_8612758/\ntotal 16K\n4.0K drwxr-xr-x  2 user users 4.0K Apr  8 21:25 ./\n4.0K drwxr-xr-x 16 user users 4.0K Apr 19 14:58 ../\n4.0K -rw-r--r--  1 user users  893 Apr  8 21:25 validator_8612758.json\n4.0K -rw-r--r--  1 user users  893 Apr  8 21:25 withdrawal_8dc343b.json\n\nFixed Issue(s)\nN/A", "createdAt": "2020-04-19T19:13:43Z", "url": "https://github.com/ConsenSys/teku/pull/1618", "merged": true, "mergeCommit": {"oid": "56a3b87e57bb9cd53cafdb53d9ff361ed2ba4efe"}, "closed": true, "closedAt": "2020-04-26T20:53:12Z", "author": {"login": "q9f"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZPQkqAH2gAyNDA1NzE3Njk4OjExYThkNjkyZWNiMzNkZmI0NTYwOGUyYmUwMzNhMjEyMDI5NDI1MGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbhDuBAFqTQwMDU0ODAzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "11a8d692ecb33dfb45608e2be033a2120294250f", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/ConsenSys/teku/commit/11a8d692ecb33dfb45608e2be033a2120294250f", "committedDate": "2020-04-19T19:00:52Z", "message": "cli/deposit: significantly simplify validator keystore path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1f1e207ea6b9021615351872c6c11c098b850a7", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/ConsenSys/teku/commit/d1f1e207ea6b9021615351872c6c11c098b850a7", "committedDate": "2020-04-19T19:09:47Z", "message": "cli/deposit: mind the 0x prefix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03b32062fc046834dd39d3b229c98dc06d0f76f1", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/ConsenSys/teku/commit/03b32062fc046834dd39d3b229c98dc06d0f76f1", "committedDate": "2020-04-19T19:13:30Z", "message": "cli/deposit: remove the 0x prefix by offset"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2MDg0NjM5", "url": "https://github.com/ConsenSys/teku/pull/1618#pullrequestreview-396084639", "createdAt": "2020-04-20T00:46:10Z", "commit": {"oid": "03b32062fc046834dd39d3b229c98dc06d0f76f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMDo0NjoxMFrOGH_S-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMDo0NjoxMFrOGH_S-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAzMDI2NQ==", "bodyText": "Given that not using the full public key opens up the possibility of overwriting an existing key with a different value, we should add a check in saveKeyStore so that it fails if the file already exists.  The chance of such a conflict is extremely low but given it results in a loss of funds we want to completely eliminate any risk of it.\nGiven how rare the overlap is, just aborting before we send the deposit would be fine.", "url": "https://github.com/ConsenSys/teku/pull/1618#discussion_r411030265", "createdAt": "2020-04-20T00:46:10Z", "author": {"login": "ajsutton"}, "path": "artemis/src/main/java/tech/pegasys/artemis/cli/deposit/EncryptedKeystoreWriter.java", "diffHunk": "@@ -56,18 +56,13 @@ public void writeKeys(final BLSKeyPair validatorKey, final BLSKeyPair withdrawal\n     final KeyStoreData withdrawalKeyStoreData =\n         generateKeystoreData(withdrawalKey, withdrawalKeyPassword);\n \n-    saveKeyStore(\n-        keystoreDirectory.resolve(\"validator_\" + validatorKey.getPublicKey().toString() + \".json\"),\n-        validatorKeyStoreData);\n-    saveKeyStore(\n-        keystoreDirectory.resolve(\n-            \"withdrawal_\" + withdrawalKey.getPublicKey().toString() + \".json\"),\n-        withdrawalKeyStoreData);\n+    saveKeyStore(keystoreDirectory.resolve(\"validator.json\"), validatorKeyStoreData);\n+    saveKeyStore(keystoreDirectory.resolve(\"withdrawal.json\"), withdrawalKeyStoreData);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03b32062fc046834dd39d3b229c98dc06d0f76f1"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2MDkxMzYz", "url": "https://github.com/ConsenSys/teku/pull/1618#pullrequestreview-396091363", "createdAt": "2020-04-20T01:26:03Z", "commit": {"oid": "03b32062fc046834dd39d3b229c98dc06d0f76f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMToyNjowM1rOGH_0FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMToyNjowM1rOGH_0FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAzODc0MQ==", "bodyText": "instead of directly using substring, may I suggest to introduce a method something on the lines of :\nString trimPublicKey(final String publicKey) {\n  if (publicKey.toLowerCase().startsWith(\"0x\")) {\n    return publicKey.substring(2,9); \n  } \n  return publicKey.substring(0, 7);\n}\n\nas the public key technically can start without \"0x\"", "url": "https://github.com/ConsenSys/teku/pull/1618#discussion_r411038741", "createdAt": "2020-04-20T01:26:03Z", "author": {"login": "usmansaleem"}, "path": "artemis/src/main/java/tech/pegasys/artemis/cli/deposit/EncryptedKeystoreWriter.java", "diffHunk": "@@ -56,18 +56,13 @@ public void writeKeys(final BLSKeyPair validatorKey, final BLSKeyPair withdrawal\n     final KeyStoreData withdrawalKeyStoreData =\n         generateKeystoreData(withdrawalKey, withdrawalKeyPassword);\n \n-    saveKeyStore(\n-        keystoreDirectory.resolve(\"validator_\" + validatorKey.getPublicKey().toString() + \".json\"),\n-        validatorKeyStoreData);\n-    saveKeyStore(\n-        keystoreDirectory.resolve(\n-            \"withdrawal_\" + withdrawalKey.getPublicKey().toString() + \".json\"),\n-        withdrawalKeyStoreData);\n+    saveKeyStore(keystoreDirectory.resolve(\"validator.json\"), validatorKeyStoreData);\n+    saveKeyStore(keystoreDirectory.resolve(\"withdrawal.json\"), withdrawalKeyStoreData);\n   }\n \n   private Path createKeystoreDirectory(final BLSKeyPair validatorKey) {\n     final Path keystoreDirectory =\n-        outputPath.resolve(\"validator_\" + validatorKey.getPublicKey().toString());\n+        outputPath.resolve(\"validator_\" + validatorKey.getPublicKey().toString().substring(2, 9));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03b32062fc046834dd39d3b229c98dc06d0f76f1"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f813c2957bcff405d0b10293070156bc4e741ff3", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/ConsenSys/teku/commit/f813c2957bcff405d0b10293070156bc4e741ff3", "committedDate": "2020-04-22T11:27:22Z", "message": "cli/deposit: use trimmed pubkey in filename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9061ed04a42ec371cc6d56e44bc7bdf8f15d10d8", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/ConsenSys/teku/commit/9061ed04a42ec371cc6d56e44bc7bdf8f15d10d8", "committedDate": "2020-04-22T11:28:39Z", "message": "Merge branch 'master' into q9-valid-path"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4Njc1OTI2", "url": "https://github.com/ConsenSys/teku/pull/1618#pullrequestreview-398675926", "createdAt": "2020-04-23T00:13:31Z", "commit": {"oid": "9061ed04a42ec371cc6d56e44bc7bdf8f15d10d8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwMDoxMzozMVrOGKRCRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwMDoxMzozMVrOGKRCRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQxODA1NQ==", "bodyText": "Why did these change to using abbreviations instead of the full validator and withdrawal prefix?", "url": "https://github.com/ConsenSys/teku/pull/1618#discussion_r413418055", "createdAt": "2020-04-23T00:13:31Z", "author": {"login": "ajsutton"}, "path": "artemis/src/main/java/tech/pegasys/artemis/cli/deposit/EncryptedKeystoreWriter.java", "diffHunk": "@@ -56,18 +56,18 @@ public void writeKeys(final BLSKeyPair validatorKey, final BLSKeyPair withdrawal\n     final KeyStoreData withdrawalKeyStoreData =\n         generateKeystoreData(withdrawalKey, withdrawalKeyPassword);\n \n-    saveKeyStore(\n-        keystoreDirectory.resolve(\"validator_\" + validatorKey.getPublicKey().toString() + \".json\"),\n-        validatorKeyStoreData);\n-    saveKeyStore(\n-        keystoreDirectory.resolve(\n-            \"withdrawal_\" + withdrawalKey.getPublicKey().toString() + \".json\"),\n-        withdrawalKeyStoreData);\n+    final String validatorFileName =\n+        \"val_\" + trimPublicKey(validatorKey.getPublicKey().toString()) + \".json\";\n+    final String withdrawalFileName =\n+        \"wdr_\" + trimPublicKey(withdrawalKey.getPublicKey().toString()) + \".json\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9061ed04a42ec371cc6d56e44bc7bdf8f15d10d8"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c20c02a14f71762907148ccc677aa04eb3530de", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/ConsenSys/teku/commit/8c20c02a14f71762907148ccc677aa04eb3530de", "committedDate": "2020-04-26T08:31:59Z", "message": "cli/deposit: restore full destination in filename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61d0ea21433cb0bd772fa6c7713f632b74c6d334", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/ConsenSys/teku/commit/61d0ea21433cb0bd772fa6c7713f632b74c6d334", "committedDate": "2020-04-26T08:32:32Z", "message": "Merge branch 'master' into q9-valid-path"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNTQ4MDM2", "url": "https://github.com/ConsenSys/teku/pull/1618#pullrequestreview-400548036", "createdAt": "2020-04-26T20:52:58Z", "commit": {"oid": "61d0ea21433cb0bd772fa6c7713f632b74c6d334"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4313, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}