{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5NTYyNDU5", "number": 1386, "title": "Fail startup as soon as any service fails to start", "bodyText": "PR Description\nWhen the storage service fails to start, the beacon chain controller startup hangs waiting for a response from storage.  Since we were using allOf to wait for both startups to complete, we never reported the startup failure from the storage service (because we were still waiting for the beacon chain controller to finish starting up).\nAdded a allOfFailFast to SafeFuture which, when everything completes successfully is the same as allOf but will fail immediately when any of the futures fails. This ensures the failure is reported, even if other services are unable to complete startup until the failed service is available.", "createdAt": "2020-03-17T00:44:13Z", "url": "https://github.com/ConsenSys/teku/pull/1386", "merged": true, "mergeCommit": {"oid": "f3f3474229cd240f47a623db2bf1334e95c13a2c"}, "closed": true, "closedAt": "2020-03-17T21:51:07Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOXumIAH2gAyMzg5NTYyNDU5Ojc4MzE1NDMzODJiNDVhMzA3NTBiMzZhMjA0MmU4NDYxNDJlNDhiZTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOpgDAAH2gAyMzg5NTYyNDU5OmZiN2JmNzU0OGU1NGRjN2IwZGI5YTYwNDczZWY2Y2EwZmM4OGU1NDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7831543382b45a30750b36a2042e846142e48be8", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/7831543382b45a30750b36a2042e846142e48be8", "committedDate": "2020-03-17T00:39:44Z", "message": "Fail startup as soon as any service fails to start.  Avoids deadlocks where services can't complete startup until some other one does, and that dependency fails to start."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8395431975ace88e19f0ec98dd1bed09af87b500", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/8395431975ace88e19f0ec98dd1bed09af87b500", "committedDate": "2020-03-17T00:51:59Z", "message": "Spotless."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NzMyNzYx", "url": "https://github.com/ConsenSys/teku/pull/1386#pullrequestreview-375732761", "createdAt": "2020-03-17T04:25:32Z", "commit": {"oid": "8395431975ace88e19f0ec98dd1bed09af87b500"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwNDoyNTozMlrOF3NkLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwNDoyNTozMlrOF3NkLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQzODI1Mw==", "bodyText": "Would it be worth using a parallel stream rather than a sequential stream?\nStream.of(futures). parallel().forEach(future -> future.finish(() -> {}, complete::completeExceptionally));", "url": "https://github.com/ConsenSys/teku/pull/1386#discussion_r393438253", "createdAt": "2020-03-17T04:25:32Z", "author": {"login": "CjHare"}, "path": "util/src/main/java/tech/pegasys/artemis/util/async/SafeFuture.java", "diffHunk": "@@ -96,6 +97,27 @@ public static void reportExceptions(final CompletionStage<?> future) {\n     return of(CompletableFuture.allOf(futures));\n   }\n \n+  /**\n+   * Returns a new SafeFuture that is completed when all of the given SafeFutures complete\n+   * successfully or completes exceptionally immediately when any of the SafeFutures complete\n+   * exceptionally. The results, if any, of the given SafeFutures are not reflected in the returned\n+   * SafeFuture, but may be obtained by inspecting them individually. If no SafeFutures are\n+   * provided, returns a SafeFuture completed with the value {@code null}.\n+   *\n+   * <p>Among the applications of this method is to await completion of a set of independent\n+   * SafeFutures before continuing a program, as in: {@code SafeFuture.allOf(c1, c2, c3).join();}.\n+   *\n+   * @param futures the SafeFutures\n+   * @return a new SafeFuture that is completed when all of the given SafeFutures complete\n+   * @throws NullPointerException if the array or any of its elements are {@code null}\n+   */\n+  public static <U> SafeFuture<Void> allOfFailFast(final SafeFuture<?>... futures) {\n+    final SafeFuture<Void> complete = new SafeFuture<>();\n+    Stream.of(futures).forEach(future -> future.finish(() -> {}, complete::completeExceptionally));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8395431975ace88e19f0ec98dd1bed09af87b500"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NzM4Mjc3", "url": "https://github.com/ConsenSys/teku/pull/1386#pullrequestreview-375738277", "createdAt": "2020-03-17T04:48:17Z", "commit": {"oid": "8395431975ace88e19f0ec98dd1bed09af87b500"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c15d34a9e6479f208bd08b597ecb4bc65a7600f1", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/c15d34a9e6479f208bd08b597ecb4bc65a7600f1", "committedDate": "2020-03-17T05:02:29Z", "message": "Merge branch 'master' into report-startup-failures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5d2036db64b467003bb33fcc41ee81cea6c3a58", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d5d2036db64b467003bb33fcc41ee81cea6c3a58", "committedDate": "2020-03-17T11:17:17Z", "message": "Merge branch 'master' into report-startup-failures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb7bf7548e54dc7b0db9a60473ef6ca0fc88e546", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/fb7bf7548e54dc7b0db9a60473ef6ca0fc88e546", "committedDate": "2020-03-17T21:22:08Z", "message": "Merge branch 'master' into report-startup-failures"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3988, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}