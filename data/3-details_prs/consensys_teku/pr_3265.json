{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0MzczOTY3", "number": 3265, "title": "Avoid repeatedly processing epoch transitions", "bodyText": "PR Description\nWhen creating the first block of an epoch, Teku winds up processing the epoch transition four times:\n\nComputing proposer duties\nBlockFactory creates the state at the block slot to use when getting operations to include in the block\nBlockProposalUtil recreates the state at the block slot as part of applying the block to get the resulting state\nForkChoiceUtil reprocesses the block when it imports it\n\nThe first three of those can all be modified to reuse the same cached state.  This is done by changing our Checkpoint based state cache to a SlotAndBlockRoot based so it can cache states from arbitrary slots rather than only epoch boundaries.  Computing proposer duties looks up the state at the epoch start slot. This includes applying any empty slots if needed.\nBoth BlockFactory and BlockProposalUtil are invoked as a result of the same validator client call to create the unsigned block - the state from the new block's slot can be retrieved from cache then passed in to both of them to reuse.\nNote that the caching works out correctly even when we request a state at the first slot of an epoch prior to importing the block because that's cached under (start_slot, previous_block_root) and then if a block is later imported for that slot it's cached under (start_slot, new_block_root) so we can't pollute the cache by looking a state for a slot too early.\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-20T02:59:04Z", "url": "https://github.com/ConsenSys/teku/pull/3265", "merged": true, "mergeCommit": {"oid": "848fd9c0282d17f3623741ed09d56c12141c09e3"}, "closed": true, "closedAt": "2020-12-08T00:37:49Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeOQKIgH2gAyNTI0MzczOTY3OjY5Y2JjZjk3OTg0M2YyNzE4YjY4NTE5MTE2MDI0NmE1ZGQ4MDJhN2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj-smkgH2gAyNTI0MzczOTY3OmM0YmU0MDg2YTA2MGIzMGQ0MGZhMjBmYmY5NGMzM2ZhN2FjMGM1YTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "69cbcf979843f2718b685191160246a5dd802a7c", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/69cbcf979843f2718b685191160246a5dd802a7c", "committedDate": "2020-11-20T02:51:17Z", "message": "Avoid repeatedly processing epoch transitions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e26e1ddcca2067d9e7b4d8f4859889c93e976ba", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/2e26e1ddcca2067d9e7b4d8f4859889c93e976ba", "committedDate": "2020-11-20T02:59:14Z", "message": "Merge branch 'master' of github.com:ConsenSys/teku into optimise-epoch-transition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2fbc7cce7569654d68264c41c228335fc0930f4", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d2fbc7cce7569654d68264c41c228335fc0930f4", "committedDate": "2020-11-20T03:15:20Z", "message": "Errorprone."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4caf1bbcd28058b1e983d4ba23ed298faaf343e3", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/4caf1bbcd28058b1e983d4ba23ed298faaf343e3", "committedDate": "2020-11-20T03:32:06Z", "message": "Update tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c30644e5c4f29bab7bbf752b47cd0a9fa8f6ffd", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/8c30644e5c4f29bab7bbf752b47cd0a9fa8f6ffd", "committedDate": "2020-11-25T23:06:12Z", "message": "Merge branch 'master' of github.com:ConsenSys/teku into optimise-epoch-transition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68094038d35ecbed918a59b35dad5b2a38a9a9bf", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/68094038d35ecbed918a59b35dad5b2a38a9a9bf", "committedDate": "2020-11-25T23:48:53Z", "message": "Update new tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fde597500eb760bff77f656c15188e5b1502c9a4", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/fde597500eb760bff77f656c15188e5b1502c9a4", "committedDate": "2020-11-27T01:20:51Z", "message": "Merge branch 'master' of github.com:ConsenSys/teku into optimise-epoch-transition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "846c433c75e17098b6910da0d5208fe326103179", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/846c433c75e17098b6910da0d5208fe326103179", "committedDate": "2020-12-02T22:28:25Z", "message": "Merge branch 'master' into optimise-epoch-transition"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNDc5ODg3", "url": "https://github.com/ConsenSys/teku/pull/3265#pullrequestreview-543479887", "createdAt": "2020-12-03T05:06:49Z", "commit": {"oid": "846c433c75e17098b6910da0d5208fe326103179"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwNTowNjo0OVrOH95wyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwNTowNjo0OVrOH95wyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3MTU2MA==", "bodyText": "typo? (EPOCH + x)", "url": "https://github.com/ConsenSys/teku/pull/3265#discussion_r534671560", "createdAt": "2020-12-03T05:06:49Z", "author": {"login": "rolfyone"}, "path": "ethereum/core/src/test/java/tech/pegasys/teku/core/stategenerator/StateAtSlotTaskTest.java", "diffHunk": "@@ -26,19 +26,21 @@\n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n import tech.pegasys.teku.core.ChainBuilder;\n+import tech.pegasys.teku.core.StateTransition;\n import tech.pegasys.teku.core.stategenerator.CachingTaskQueue.CacheableTask;\n-import tech.pegasys.teku.core.stategenerator.CheckpointStateTask.AsyncStateProvider;\n+import tech.pegasys.teku.core.stategenerator.StateAtSlotTask.AsyncStateProvider;\n import tech.pegasys.teku.datastructures.blocks.SignedBlockAndState;\n+import tech.pegasys.teku.datastructures.blocks.SlotAndBlockRoot;\n import tech.pegasys.teku.datastructures.forkchoice.InvalidCheckpointException;\n import tech.pegasys.teku.datastructures.state.BeaconState;\n import tech.pegasys.teku.datastructures.state.Checkpoint;\n import tech.pegasys.teku.datastructures.util.BeaconStateUtil;\n import tech.pegasys.teku.infrastructure.async.SafeFuture;\n import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n \n-class CheckpointStateTaskTest {\n-  private static final UInt64 EPOCH = UInt64.valueOf(2);\n-  private static final UInt64 EPOCH_START_SLOT = BeaconStateUtil.compute_start_slot_at_epoch(EPOCH);\n+class StateAtSlotTaskTest {\n+  private static final UInt64 EPOCHx = UInt64.valueOf(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "846c433c75e17098b6910da0d5208fe326103179"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNDkzMzg2", "url": "https://github.com/ConsenSys/teku/pull/3265#pullrequestreview-543493386", "createdAt": "2020-12-03T05:14:56Z", "commit": {"oid": "846c433c75e17098b6910da0d5208fe326103179"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwNToxNDo1NlrOH956zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwNToxNDo1NlrOH956zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3NDEyNg==", "bodyText": "might be able to use orElseGet instead here?", "url": "https://github.com/ConsenSys/teku/pull/3265#discussion_r534674126", "createdAt": "2020-12-03T05:14:56Z", "author": {"login": "rolfyone"}, "path": "validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/BlockFactory.java", "diffHunk": "@@ -87,7 +94,12 @@ public BeaconBlock createUnsignedBlock(\n     }\n \n     // Collect attestations to include\n-    final BeaconState blockSlotState = stateTransition.process_slots(blockPreState, newSlot);\n+    final BeaconState blockSlotState;\n+    if (maybeBlockSlotState.isPresent()) {\n+      blockSlotState = maybeBlockSlotState.get();\n+    } else {\n+      blockSlotState = stateTransition.process_slots(blockPreState, newSlot);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "846c433c75e17098b6910da0d5208fe326103179"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecd6298b0607dbd54680db27f59c61973517bae1", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/ecd6298b0607dbd54680db27f59c61973517bae1", "committedDate": "2020-12-03T21:06:33Z", "message": "Remove stray x."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19646b35f7b6e9b359717bf853eb29f2cad3e117", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/19646b35f7b6e9b359717bf853eb29f2cad3e117", "committedDate": "2020-12-03T21:06:36Z", "message": "Merge branch 'master' of github.com:ConsenSys/teku into optimise-epoch-transition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0b3c55148f8807f75b26539b6ed5f4cd20883f4", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e0b3c55148f8807f75b26539b6ed5f4cd20883f4", "committedDate": "2020-12-03T21:06:44Z", "message": "Merge branch 'optimise-epoch-transition' of github.com:ajsutton/teku into optimise-epoch-transition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4548888505a22a771b254b724cdfa0b6bb60669", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d4548888505a22a771b254b724cdfa0b6bb60669", "committedDate": "2020-12-07T00:21:53Z", "message": "Merge branch 'master' of github.com:ConsenSys/teku into optimise-epoch-transition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fc65f3130447fa541e6ce872fd37fea2b3183da", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/5fc65f3130447fa541e6ce872fd37fea2b3183da", "committedDate": "2020-12-07T00:21:57Z", "message": "Merge branch 'master' of github.com:ConsenSys/teku into optimise-epoch-transition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b29f1eb5c42586397fde8c75785f165cb1b7d336", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/b29f1eb5c42586397fde8c75785f165cb1b7d336", "committedDate": "2020-12-07T02:36:19Z", "message": "Merge branch 'master' into optimise-epoch-transition"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NjAyOTIw", "url": "https://github.com/ConsenSys/teku/pull/3265#pullrequestreview-546602920", "createdAt": "2020-12-07T22:47:04Z", "commit": {"oid": "b29f1eb5c42586397fde8c75785f165cb1b7d336"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7feba4470ff00b0d01c89335acc38e7bfad82766", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/7feba4470ff00b0d01c89335acc38e7bfad82766", "committedDate": "2020-12-07T22:55:30Z", "message": "Merge branch 'master' into optimise-epoch-transition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4be4086a060b30d40fa20fbf94c33fa7ac0c5a4", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/c4be4086a060b30d40fa20fbf94c33fa7ac0c5a4", "committedDate": "2020-12-08T00:07:25Z", "message": "Merge branch 'master' into optimise-epoch-transition"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3219, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}