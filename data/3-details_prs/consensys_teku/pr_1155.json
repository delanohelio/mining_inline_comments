{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0OTYxNDQz", "number": 1155, "title": "[BC-268] Only prune hot blocks prior to latest finalized block", "bodyText": "PR Description\nCurrently, we're pruning our hotStatesByRoot collection using the epoch boundary of the latest finalized block.  If the epoch boundary is a skipped slot (the finalized block for this epoch is from a slot prior to the epoch boundary slot), this means that we'll end up pruning the finalized state.  Upon restarting the client, we'll hydrate our Store from the database and end up with no finalized state corresponding to our finalized block.  This prevents us from importing new blocks on top of our latest finalized block.\nIn this PR, the hot block pruning logic has been updated to only prune blocks that are prior to the slot of the latest finalized block.", "createdAt": "2020-02-13T16:18:17Z", "url": "https://github.com/ConsenSys/teku/pull/1155", "merged": true, "mergeCommit": {"oid": "43a253fad315e921cc36ebfb9fa6bc98c48e94c2"}, "closed": true, "closedAt": "2020-02-14T16:42:52Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEDBaLAFqTM1ODYwOTY3NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcER0_rgH2gAyMzc0OTYxNDQzOmI0YzJmN2M3YzU2YTc2NmEzZWFkYzM5MTcyNDhhMWM5ZGUyNjgzNzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NjA5Njc1", "url": "https://github.com/ConsenSys/teku/pull/1155#pullrequestreview-358609675", "createdAt": "2020-02-13T22:52:27Z", "commit": {"oid": "eea6d8ce68ae6bc02712e3014258125d0852cbbb"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMjo1MjoyN1rOFpmXBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMjo1MjoyN1rOFpmXBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2NDQyMA==", "bodyText": "I suspect we don't need this TODO anymore - we can prune anything up to the finalised block.", "url": "https://github.com/ConsenSys/teku/pull/1155#discussion_r379164420", "createdAt": "2020-02-13T22:52:27Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -257,10 +256,10 @@ private void pruneCheckpointStates(final Checkpoint newFinalizedCheckpoint) {\n \n   private void pruneHotBlocks(final Checkpoint newFinalizedCheckpoint) {\n     // TODO: Can we prune blocks from in the finalized epoch as well?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eea6d8ce68ae6bc02712e3014258125d0852cbbb"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5a85a495b20a625e15307d4a6cf9ce37622212e", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c5a85a495b20a625e15307d4a6cf9ce37622212e", "committedDate": "2020-02-14T16:06:05Z", "message": "Prune hot blocks up to the slot prior to the latest finalized block\n\nWe need to make sure that the state for the finalized block is preserved\nso that we are able to import blocks on top of the finalized state."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eea6d8ce68ae6bc02712e3014258125d0852cbbb", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/eea6d8ce68ae6bc02712e3014258125d0852cbbb", "committedDate": "2020-02-13T16:03:17Z", "message": "Prune hot blocks up to the slot prior to the latest finalized block\n\nWe need to make sure that the state for the finalized block is preserved\nso that we are able to import blocks on top of the finalized state."}, "afterCommit": {"oid": "c5a85a495b20a625e15307d4a6cf9ce37622212e", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c5a85a495b20a625e15307d4a6cf9ce37622212e", "committedDate": "2020-02-14T16:06:05Z", "message": "Prune hot blocks up to the slot prior to the latest finalized block\n\nWe need to make sure that the state for the finalized block is preserved\nso that we are able to import blocks on top of the finalized state."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4c2f7c7c56a766a3eadc3917248a1c9de268371", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/b4c2f7c7c56a766a3eadc3917248a1c9de268371", "committedDate": "2020-02-14T16:08:03Z", "message": "Cut stale comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4043, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}