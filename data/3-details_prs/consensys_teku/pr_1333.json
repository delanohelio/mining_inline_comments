{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1ODU3NTA5", "number": 1333, "title": "update beaconStateHandler to make use of DataProvider abstraction", "bodyText": "Updated BeaconStateHandler and created the BeaconState type in DataProvider schema.\nRefactored BeaconValidators, BeaconBlockRoot because they both used internal BeaconState.\naddresses #1315", "createdAt": "2020-03-09T23:00:05Z", "url": "https://github.com/ConsenSys/teku/pull/1333", "merged": true, "mergeCommit": {"oid": "86a2c91bd743761c8f73035918684ef134319a6a"}, "closed": true, "closedAt": "2020-03-10T01:39:50Z", "author": {"login": "rolfyone"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcL2jIrAH2gAyMzg1ODU3NTA5OjI4ZjI0Y2ZhZWRkMGY5NzdkMzY5NjFiYWRjYmJkZjg4ZDNmOTU0NDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMIOVKAH2gAyMzg1ODU3NTA5OmY4NmIyOTZmZjExZmJjODg5NWIyOTYwNzc3NGM2NTVkOTE3MjQ0ZTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "28f24cfaedd0f977d36961badcbbdf88d3f95449", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/28f24cfaedd0f977d36961badcbbdf88d3f95449", "committedDate": "2020-03-09T04:52:30Z", "message": "addresses #1315\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0006b3246650dacc035c8e844a13f63380337ac5", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/0006b3246650dacc035c8e844a13f63380337ac5", "committedDate": "2020-03-09T22:54:04Z", "message": "Merge remote-tracking branch 'upstream/master' into 1315-beaconStateHandler\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6d4fc0f859bd0792a335f91db6c069d9d00d253", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/d6d4fc0f859bd0792a335f91db6c069d9d00d253", "committedDate": "2020-03-09T22:54:25Z", "message": "Merge remote-tracking branch 'upstream/master' into 1315-beaconStateHandler"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNjA5Mjg0", "url": "https://github.com/ConsenSys/teku/pull/1333#pullrequestreview-371609284", "createdAt": "2020-03-10T00:19:57Z", "commit": {"oid": "d6d4fc0f859bd0792a335f91db6c069d9d00d253"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMDoxOTo1N1rOFz9kpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMDozMDo0OFrOFz9vMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMDUwMA==", "bodyText": "we don't want to use ValidatorsUtil?", "url": "https://github.com/ConsenSys/teku/pull/1333#discussion_r390030500", "createdAt": "2020-03-10T00:19:57Z", "author": {"login": "macfarla"}, "path": "data/provider/src/main/java/tech/pegasys/artemis/api/schema/BeaconValidators.java", "diffHunk": "@@ -105,7 +114,12 @@ public static long getEffectiveListSize(\n     if (!activeOnly) {\n       return list.size();\n     } else {\n-      return list.stream().filter(v -> ValidatorsUtil.is_active_validator(v, epoch)).count();\n+      return list.stream().filter(v -> is_active_validator(v, epoch)).count();\n     }\n   }\n+\n+  private static boolean is_active_validator(Validator validator, UnsignedLong epoch) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6d4fc0f859bd0792a335f91db6c069d9d00d253"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMDc3MA==", "bodyText": "BLSPublicKeySerializer renamed as Fork is confusing", "url": "https://github.com/ConsenSys/teku/pull/1333#discussion_r390030770", "createdAt": "2020-03-10T00:20:58Z", "author": {"login": "macfarla"}, "path": "data/provider/src/main/java/tech/pegasys/artemis/api/schema/Fork.java", "diffHunk": "@@ -11,18 +11,19 @@\n  * specific language governing permissions and limitations under the License.\n  */\n \n-package tech.pegasys.artemis.provider;\n+package tech.pegasys.artemis.api.schema;\n \n-import com.fasterxml.jackson.core.JsonGenerator;\n-import com.fasterxml.jackson.databind.JsonSerializer;\n-import com.fasterxml.jackson.databind.SerializerProvider;\n-import java.io.IOException;\n-import tech.pegasys.artemis.util.bls.BLSPublicKey;\n+import com.google.common.primitives.UnsignedLong;\n+import tech.pegasys.artemis.util.SSZTypes.Bytes4;\n \n-public class BLSPublicKeySerializer extends JsonSerializer<BLSPublicKey> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6d4fc0f859bd0792a335f91db6c069d9d00d253"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMTIzNA==", "bodyText": "nice", "url": "https://github.com/ConsenSys/teku/pull/1333#discussion_r390031234", "createdAt": "2020-03-10T00:22:56Z", "author": {"login": "macfarla"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconStateHandler.java", "diffHunk": "@@ -81,48 +82,40 @@ public BeaconStateHandler(\n   public void handle(Context ctx) throws Exception {\n     try {\n       final Map<String, List<String>> parameters = ctx.queryParamMap();\n-      SafeFuture<Optional<BeaconState>> future = null;\n+      SafeFuture<Optional<BeaconState>> future;\n       if (parameters.size() == 0) {\n         throw new IllegalArgumentException(\"No query parameters specified\");\n       }\n-      if (!combinedClient.isStoreAvailable()) {\n+      if (!provider.isStoreAvailable()) {\n         ctx.status(SC_NO_CONTENT);\n         return;\n       }\n \n       if (parameters.containsKey(ROOT)) {\n-        future = queryByRootHash(validateQueryParameter(parameters, ROOT));\n+        future = provider.getStateByBlockRoot(getParameterValueAsBytes32(parameters, ROOT));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6d4fc0f859bd0792a335f91db6c069d9d00d253"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMjM2NQ==", "bodyText": "do we need to create a new BeaconState here?", "url": "https://github.com/ConsenSys/teku/pull/1333#discussion_r390032365", "createdAt": "2020-03-10T00:27:23Z", "author": {"login": "macfarla"}, "path": "data/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconStateHandlerTest.java", "diffHunk": "@@ -87,86 +91,67 @@ public void shouldReturnNotFoundWhenQueryAgainstMissingRootObject() throws Excep\n \n   @Test\n   public void shouldReturnBadRequestWhenNoParameterSpecified() throws Exception {\n-    final BeaconStateHandler handler =\n-        new BeaconStateHandler(combinedChainDataClient, jsonProvider);\n+    final BeaconStateHandler handler = new BeaconStateHandler(provider, jsonProvider);\n     when(context.queryParamMap()).thenReturn(Map.of());\n-\n     handler.handle(context);\n-\n     verify(context).status(SC_BAD_REQUEST);\n   }\n \n   @Test\n   public void shouldReturnBadRequestWhenBadSlotSpecified() throws Exception {\n-    final BeaconStateHandler handler =\n-        new BeaconStateHandler(combinedChainDataClient, jsonProvider);\n+    final BeaconStateHandler handler = new BeaconStateHandler(provider, jsonProvider);\n     when(context.queryParamMap()).thenReturn(Map.of(SLOT, List.of(\"not-an-int\")));\n-\n     handler.handle(context);\n-\n     verify(context).status(SC_BAD_REQUEST);\n   }\n \n   @Test\n   public void shouldReturnBadRequestWhenBadParamSpecified() throws Exception {\n-    final BeaconStateHandler handler =\n-        new BeaconStateHandler(combinedChainDataClient, jsonProvider);\n+    final BeaconStateHandler handler = new BeaconStateHandler(provider, jsonProvider);\n     when(context.queryParamMap()).thenReturn(Map.of(EPOCH, List.of(\"not-an-int\")));\n-\n     handler.handle(context);\n-\n     verify(context).status(SC_BAD_REQUEST);\n   }\n \n   @Test\n   public void shouldReturnBeaconStateObjectWhenQueryByRoot() throws Exception {\n-    final BeaconStateHandler handler =\n-        new BeaconStateHandler(combinedChainDataClient, jsonProvider);\n+    final BeaconStateHandler handler = new BeaconStateHandler(provider, jsonProvider);\n     when(context.queryParamMap()).thenReturn(Map.of(ROOT, List.of(blockRoot.toHexString())));\n \n     handler.handle(context);\n \n     verify(context).result(args.capture());\n     SafeFuture<String> data = args.getValue();\n-    assertEquals(data.get(), jsonProvider.objectToJSON(beaconState));\n+    assertEquals(data.get(), jsonProvider.objectToJSON(new BeaconState(beaconStateInternal)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6d4fc0f859bd0792a335f91db6c069d9d00d253"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMjkwNw==", "bodyText": "nvm I get it. beaconStateInternal is the internal data structure", "url": "https://github.com/ConsenSys/teku/pull/1333#discussion_r390032907", "createdAt": "2020-03-10T00:29:34Z", "author": {"login": "macfarla"}, "path": "data/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconStateHandlerTest.java", "diffHunk": "@@ -87,86 +91,67 @@ public void shouldReturnNotFoundWhenQueryAgainstMissingRootObject() throws Excep\n \n   @Test\n   public void shouldReturnBadRequestWhenNoParameterSpecified() throws Exception {\n-    final BeaconStateHandler handler =\n-        new BeaconStateHandler(combinedChainDataClient, jsonProvider);\n+    final BeaconStateHandler handler = new BeaconStateHandler(provider, jsonProvider);\n     when(context.queryParamMap()).thenReturn(Map.of());\n-\n     handler.handle(context);\n-\n     verify(context).status(SC_BAD_REQUEST);\n   }\n \n   @Test\n   public void shouldReturnBadRequestWhenBadSlotSpecified() throws Exception {\n-    final BeaconStateHandler handler =\n-        new BeaconStateHandler(combinedChainDataClient, jsonProvider);\n+    final BeaconStateHandler handler = new BeaconStateHandler(provider, jsonProvider);\n     when(context.queryParamMap()).thenReturn(Map.of(SLOT, List.of(\"not-an-int\")));\n-\n     handler.handle(context);\n-\n     verify(context).status(SC_BAD_REQUEST);\n   }\n \n   @Test\n   public void shouldReturnBadRequestWhenBadParamSpecified() throws Exception {\n-    final BeaconStateHandler handler =\n-        new BeaconStateHandler(combinedChainDataClient, jsonProvider);\n+    final BeaconStateHandler handler = new BeaconStateHandler(provider, jsonProvider);\n     when(context.queryParamMap()).thenReturn(Map.of(EPOCH, List.of(\"not-an-int\")));\n-\n     handler.handle(context);\n-\n     verify(context).status(SC_BAD_REQUEST);\n   }\n \n   @Test\n   public void shouldReturnBeaconStateObjectWhenQueryByRoot() throws Exception {\n-    final BeaconStateHandler handler =\n-        new BeaconStateHandler(combinedChainDataClient, jsonProvider);\n+    final BeaconStateHandler handler = new BeaconStateHandler(provider, jsonProvider);\n     when(context.queryParamMap()).thenReturn(Map.of(ROOT, List.of(blockRoot.toHexString())));\n \n     handler.handle(context);\n \n     verify(context).result(args.capture());\n     SafeFuture<String> data = args.getValue();\n-    assertEquals(data.get(), jsonProvider.objectToJSON(beaconState));\n+    assertEquals(data.get(), jsonProvider.objectToJSON(new BeaconState(beaconStateInternal)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMjM2NQ=="}, "originalCommit": {"oid": "d6d4fc0f859bd0792a335f91db6c069d9d00d253"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMzIwMA==", "bodyText": "might make it clearer to make it a method call getMeTheExternalRepresentationOfTheInternalState(beaconStateInternal)", "url": "https://github.com/ConsenSys/teku/pull/1333#discussion_r390033200", "createdAt": "2020-03-10T00:30:48Z", "author": {"login": "macfarla"}, "path": "data/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconStateHandlerTest.java", "diffHunk": "@@ -87,86 +91,67 @@ public void shouldReturnNotFoundWhenQueryAgainstMissingRootObject() throws Excep\n \n   @Test\n   public void shouldReturnBadRequestWhenNoParameterSpecified() throws Exception {\n-    final BeaconStateHandler handler =\n-        new BeaconStateHandler(combinedChainDataClient, jsonProvider);\n+    final BeaconStateHandler handler = new BeaconStateHandler(provider, jsonProvider);\n     when(context.queryParamMap()).thenReturn(Map.of());\n-\n     handler.handle(context);\n-\n     verify(context).status(SC_BAD_REQUEST);\n   }\n \n   @Test\n   public void shouldReturnBadRequestWhenBadSlotSpecified() throws Exception {\n-    final BeaconStateHandler handler =\n-        new BeaconStateHandler(combinedChainDataClient, jsonProvider);\n+    final BeaconStateHandler handler = new BeaconStateHandler(provider, jsonProvider);\n     when(context.queryParamMap()).thenReturn(Map.of(SLOT, List.of(\"not-an-int\")));\n-\n     handler.handle(context);\n-\n     verify(context).status(SC_BAD_REQUEST);\n   }\n \n   @Test\n   public void shouldReturnBadRequestWhenBadParamSpecified() throws Exception {\n-    final BeaconStateHandler handler =\n-        new BeaconStateHandler(combinedChainDataClient, jsonProvider);\n+    final BeaconStateHandler handler = new BeaconStateHandler(provider, jsonProvider);\n     when(context.queryParamMap()).thenReturn(Map.of(EPOCH, List.of(\"not-an-int\")));\n-\n     handler.handle(context);\n-\n     verify(context).status(SC_BAD_REQUEST);\n   }\n \n   @Test\n   public void shouldReturnBeaconStateObjectWhenQueryByRoot() throws Exception {\n-    final BeaconStateHandler handler =\n-        new BeaconStateHandler(combinedChainDataClient, jsonProvider);\n+    final BeaconStateHandler handler = new BeaconStateHandler(provider, jsonProvider);\n     when(context.queryParamMap()).thenReturn(Map.of(ROOT, List.of(blockRoot.toHexString())));\n \n     handler.handle(context);\n \n     verify(context).result(args.capture());\n     SafeFuture<String> data = args.getValue();\n-    assertEquals(data.get(), jsonProvider.objectToJSON(beaconState));\n+    assertEquals(data.get(), jsonProvider.objectToJSON(new BeaconState(beaconStateInternal)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMjM2NQ=="}, "originalCommit": {"oid": "d6d4fc0f859bd0792a335f91db6c069d9d00d253"}, "originalPosition": 104}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3804955108b49a571078e144648d839a89d640a3", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/3804955108b49a571078e144648d839a89d640a3", "committedDate": "2020-03-10T01:12:15Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2367598fb9ae842dbb8017c1c9797a21912f1173", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/2367598fb9ae842dbb8017c1c9797a21912f1173", "committedDate": "2020-03-10T01:25:44Z", "message": "commit feedback, and build failure from merge issue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f86b296ff11fbc8895b29607774c655d917244e2", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/f86b296ff11fbc8895b29607774c655d917244e2", "committedDate": "2020-03-10T01:28:04Z", "message": "Merge remote-tracking branch 'upstream/master' into 1315-beaconStateHandler"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3949, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}