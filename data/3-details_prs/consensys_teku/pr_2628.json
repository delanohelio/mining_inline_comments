{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNjU4OTY1", "number": 2628, "title": "Add CacheableTaskQueue and use it to manage checkpoint state generation", "bodyText": "PR Description\nAdds a flexible CacheableTaskQueue which is almost identical to StateGenerationQueue but able to work with generic tasks so it will be able to be used for both states and checkpoint states.\nThis PR only switches checkpoint states over to use the task queue, ensuring that generation is deduplicated and optimised to start from the most recently available state.  A follow up PR will convert StateGenerationQueue to be a state specific task and use the generic CacheableTaskQueue implementation.\nFixed Issue(s)\nfixes #2604\nfixes #2609\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-08-20T05:09:43Z", "url": "https://github.com/ConsenSys/teku/pull/2628", "merged": true, "mergeCommit": {"oid": "15ae7a2d5516439a635b84e8585365ce5e5533bb"}, "closed": true, "closedAt": "2020-08-20T23:26:49Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdApB9agH2gAyNDcwNjU4OTY1OmRkOGE3YzBiNjI0MmM0YWE5M2E2YTk1ZTZiNWVjY2VmNTEwNzVjOWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdA4rVTgH2gAyNDcwNjU4OTY1OmIzNDNlNGVjOTYyZGY2NTAyYzlkNDc4ODQ3ZjFhN2IxZDM2MzgzM2E=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dd8a7c0b6242c4aa93a6a95e6b5eccef51075c9d", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/dd8a7c0b6242c4aa93a6a95e6b5eccef51075c9d", "committedDate": "2020-08-20T05:05:29Z", "message": "Add CacheableTaskQueue and use it to avoid duplicate checkpoint state generation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d009276d3bac8cc01fa1de45ec0360de57307aaa", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d009276d3bac8cc01fa1de45ec0360de57307aaa", "committedDate": "2020-08-20T05:05:45Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into task-queue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9fd53724ff6ee13e9c7ffc07ca06ed0d917ab2e", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e9fd53724ff6ee13e9c7ffc07ca06ed0d917ab2e", "committedDate": "2020-08-20T05:26:42Z", "message": "Make errorprone happy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d21d745bde72c5cbfba2ef6d1a2e5402ede8657", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/2d21d745bde72c5cbfba2ef6d1a2e5402ede8657", "committedDate": "2020-08-20T05:39:28Z", "message": "Remove tests for what is now just a test fixture."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e529ab7ee9ee2a6d7374d3b4641b320aae4e288e", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e529ab7ee9ee2a6d7374d3b4641b320aae4e288e", "committedDate": "2020-08-20T08:21:16Z", "message": "ofNullable."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNDMwMTcy", "url": "https://github.com/ConsenSys/teku/pull/2628#pullrequestreview-471430172", "createdAt": "2020-08-20T09:43:43Z", "commit": {"oid": "e529ab7ee9ee2a6d7374d3b4641b320aae4e288e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwOTo0Mzo0M1rOHD35MQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwOTo0Mzo0M1rOHD35MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgyMzUzNw==", "bodyText": "I'm a bit confused with how you accomplish this:", "url": "https://github.com/ConsenSys/teku/pull/2628#discussion_r473823537", "createdAt": "2020-08-20T09:43:43Z", "author": {"login": "cemozerr"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/store/Store.java", "diffHunk": "@@ -915,16 +832,20 @@ public boolean containsBlock(final Bytes32 blockRoot) {\n     public SafeFuture<Optional<BeaconState>> retrieveCheckpointState(Checkpoint checkpoint) {\n       BeaconState inMemoryCheckpointBlockState = block_states.get(checkpoint.getRoot());\n       if (inMemoryCheckpointBlockState != null) {\n-        return SafeFuture.completedFuture(\n-            Optional.of(regenerateCheckpointState(checkpoint, inMemoryCheckpointBlockState)));\n+        // Not executing the task via the task queue to avoid caching the result before the tx is", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e529ab7ee9ee2a6d7374d3b4641b320aae4e288e"}, "originalPosition": 237}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNDM3NzM5", "url": "https://github.com/ConsenSys/teku/pull/2628#pullrequestreview-471437739", "createdAt": "2020-08-20T09:52:15Z", "commit": {"oid": "e529ab7ee9ee2a6d7374d3b4641b320aae4e288e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b343e4ec962df6502c9d478847f1a7b1d363833a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/b343e4ec962df6502c9d478847f1a7b1d363833a", "committedDate": "2020-08-20T23:19:15Z", "message": "Merge branch 'master' into task-queue"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3513, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}