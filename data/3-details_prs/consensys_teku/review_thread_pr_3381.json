{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0OTUzOTk5", "number": 3381, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNzowOTo0OFrOFCxEmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwMzowNzowM1rOFDPzrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4NDQ1NDY0OnYy", "diffSide": "RIGHT", "path": "infrastructure/async/src/main/java/tech/pegasys/teku/infrastructure/async/ThrottlingTaskQueue.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNzowOTo0OFrOICFnWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMjowMjozOFrOICrisQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA2MDA1OQ==", "bodyText": "@ajsutton processQueuedResults and requestComplete were synchronized in their original spot.\nI've added an atomic integer to act as the limit counter, and made them not synchronized, but I'll be interested to get your take on the best way to go here...", "url": "https://github.com/ConsenSys/teku/pull/3381#discussion_r539060059", "createdAt": "2020-12-09T07:09:48Z", "author": {"login": "rolfyone"}, "path": "infrastructure/async/src/main/java/tech/pegasys/teku/infrastructure/async/ThrottlingTaskQueue.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.infrastructure.async;\n+\n+import java.util.Queue;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.function.Supplier;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.hyperledger.besu.plugin.services.MetricsSystem;\n+import tech.pegasys.teku.infrastructure.metrics.SettableGauge;\n+import tech.pegasys.teku.infrastructure.metrics.TekuMetricCategory;\n+\n+public class ThrottlingTaskQueue {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final int maximumConcurrentRequests;\n+  private volatile Queue<Runnable> queuedRequests = new ConcurrentLinkedQueue<>();\n+  private volatile AtomicInteger activeTasks = new AtomicInteger(0);\n+\n+  private final SettableGauge queueSizeGauge;\n+\n+  public ThrottlingTaskQueue(\n+      final int maximumConcurrentRequests,\n+      final MetricsSystem metricsSystem,\n+      final TekuMetricCategory metricCategory,\n+      final String metricsPrefix) {\n+    this.maximumConcurrentRequests = maximumConcurrentRequests;\n+\n+    this.queueSizeGauge =\n+        SettableGauge.create(\n+            metricsSystem,\n+            metricCategory,\n+            metricsPrefix + \"_tasks_queued\",\n+            \"Number of tasks queued\");\n+  }\n+\n+  public <T> SafeFuture<T> queueRequest(final Supplier<SafeFuture<T>> request) {\n+    final SafeFuture<T> future = new SafeFuture<>();\n+    queuedRequests.add(\n+        () -> {\n+          final SafeFuture<T> requestFuture = request.get();\n+          requestFuture.propagateTo(future);\n+          requestFuture.always(this::requestComplete);\n+        });\n+    queueSizeGauge.set(queuedRequests.size());\n+    processQueuedRequests();\n+    return future;\n+  }\n+\n+  private void requestComplete() {\n+    activeTasks.decrementAndGet();\n+    processQueuedRequests();\n+  }\n+\n+  private void processQueuedRequests() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88dd258045b1bcc542d494ff2ed2166841a13369"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4MTQ1Nw==", "bodyText": "The synchronized was essential and you'll need it back. :). The first key race condition here is that there's a race between when you check queuedRequests.isEmpty() and queuedRequests.remove().run() - the latter will give you either a NoSuchElementException or NullPointerException if the last item in the queue is removed by a different thread between the two calls.\nThe next race condition you'll hit once you fix that is that after you call incrementAndGet and find that it's actually too high, some tasks may complete which will then decrement but still not make any new requests because the limit is still reached.  Then you'll decrement to below the limit but not make any new requests and we're left underutilising the limit.\nA throttling queue is actually incredibly complex to get right with a lock free approach and there's actually no performance benefit to avoiding locks anyway.", "url": "https://github.com/ConsenSys/teku/pull/3381#discussion_r539681457", "createdAt": "2020-12-09T22:02:38Z", "author": {"login": "ajsutton"}, "path": "infrastructure/async/src/main/java/tech/pegasys/teku/infrastructure/async/ThrottlingTaskQueue.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.infrastructure.async;\n+\n+import java.util.Queue;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.function.Supplier;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.hyperledger.besu.plugin.services.MetricsSystem;\n+import tech.pegasys.teku.infrastructure.metrics.SettableGauge;\n+import tech.pegasys.teku.infrastructure.metrics.TekuMetricCategory;\n+\n+public class ThrottlingTaskQueue {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final int maximumConcurrentRequests;\n+  private volatile Queue<Runnable> queuedRequests = new ConcurrentLinkedQueue<>();\n+  private volatile AtomicInteger activeTasks = new AtomicInteger(0);\n+\n+  private final SettableGauge queueSizeGauge;\n+\n+  public ThrottlingTaskQueue(\n+      final int maximumConcurrentRequests,\n+      final MetricsSystem metricsSystem,\n+      final TekuMetricCategory metricCategory,\n+      final String metricsPrefix) {\n+    this.maximumConcurrentRequests = maximumConcurrentRequests;\n+\n+    this.queueSizeGauge =\n+        SettableGauge.create(\n+            metricsSystem,\n+            metricCategory,\n+            metricsPrefix + \"_tasks_queued\",\n+            \"Number of tasks queued\");\n+  }\n+\n+  public <T> SafeFuture<T> queueRequest(final Supplier<SafeFuture<T>> request) {\n+    final SafeFuture<T> future = new SafeFuture<>();\n+    queuedRequests.add(\n+        () -> {\n+          final SafeFuture<T> requestFuture = request.get();\n+          requestFuture.propagateTo(future);\n+          requestFuture.always(this::requestComplete);\n+        });\n+    queueSizeGauge.set(queuedRequests.size());\n+    processQueuedRequests();\n+    return future;\n+  }\n+\n+  private void requestComplete() {\n+    activeTasks.decrementAndGet();\n+    processQueuedRequests();\n+  }\n+\n+  private void processQueuedRequests() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA2MDA1OQ=="}, "originalCommit": {"oid": "88dd258045b1bcc542d494ff2ed2166841a13369"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4NDUzMDM4OnYy", "diffSide": "RIGHT", "path": "teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorKeysOptions.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNzozMjozNlrOICGRLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMjoxMzoxNlrOICr5Eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA3MDc2NA==", "bodyText": "I seemed to hit timeouts fairly quickly, I wonder if that's a good reason to actually make this option not hidden?\nRunning everything on my machine with 64 validators, a queue of 64 was enough to start not completing within timeouts, and 50 was ok to complete signing without dropping anything, but this was on web3signer with no slashing protection enabled...", "url": "https://github.com/ConsenSys/teku/pull/3381#discussion_r539070764", "createdAt": "2020-12-09T07:32:36Z", "author": {"login": "rolfyone"}, "path": "teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorKeysOptions.java", "diffHunk": "@@ -80,13 +80,23 @@\n       arity = \"1\")\n   private int validatorExternalSignerTimeout = 1000;\n \n+  @CommandLine.Option(\n+      names = {\"--Xvalidators-external-signer-concurrent-limit\"},\n+      paramLabel = \"<INTEGER>\",\n+      description = \"The maximum number of concurrent background requests to make to the signer.\",\n+      hidden = true,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88dd258045b1bcc542d494ff2ed2166841a13369"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY4NzE4Ng==", "bodyText": "I think the increased timeout will help.  I'd say keep it hidden to start with until we know more.  Wouldn't surprise me if we do make it a fully supported option at some point though.", "url": "https://github.com/ConsenSys/teku/pull/3381#discussion_r539687186", "createdAt": "2020-12-09T22:13:16Z", "author": {"login": "ajsutton"}, "path": "teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorKeysOptions.java", "diffHunk": "@@ -80,13 +80,23 @@\n       arity = \"1\")\n   private int validatorExternalSignerTimeout = 1000;\n \n+  @CommandLine.Option(\n+      names = {\"--Xvalidators-external-signer-concurrent-limit\"},\n+      paramLabel = \"<INTEGER>\",\n+      description = \"The maximum number of concurrent background requests to make to the signer.\",\n+      hidden = true,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA3MDc2NA=="}, "originalCommit": {"oid": "88dd258045b1bcc542d494ff2ed2166841a13369"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4OTQ1MjcwOnYy", "diffSide": "RIGHT", "path": "infrastructure/async/src/main/java/tech/pegasys/teku/infrastructure/async/ThrottlingTaskQueue.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwMjo1MjowMVrOICzFEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwMjo1MjowMVrOICzFEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwNDk0NA==", "bodyText": "Suspect this should be final and not volatile.", "url": "https://github.com/ConsenSys/teku/pull/3381#discussion_r539804944", "createdAt": "2020-12-10T02:52:01Z", "author": {"login": "ajsutton"}, "path": "infrastructure/async/src/main/java/tech/pegasys/teku/infrastructure/async/ThrottlingTaskQueue.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.infrastructure.async;\n+\n+import java.util.Queue;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.function.Supplier;\n+import org.hyperledger.besu.plugin.services.MetricsSystem;\n+import tech.pegasys.teku.infrastructure.metrics.SettableGauge;\n+import tech.pegasys.teku.infrastructure.metrics.TekuMetricCategory;\n+\n+public class ThrottlingTaskQueue {\n+  private final int maximumConcurrentRequests;\n+  private volatile Queue<Runnable> queuedRequests = new ConcurrentLinkedQueue<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d75ec4b1a940ea2321c9073b6bb7ffbaf1e4c6"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4OTQ1NjU0OnYy", "diffSide": "RIGHT", "path": "infrastructure/async/src/main/java/tech/pegasys/teku/infrastructure/async/ThrottlingTaskQueue.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwMjo1MzozOFrOICzHQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwMjo1MzozOFrOICzHQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwNTUwNA==", "bodyText": "You can just use a normal gauge here rather than SettableGuage and pass queuedRequests::size as the supplier.  It's a concurrent queue anyway so safe to access from the metrics thread.", "url": "https://github.com/ConsenSys/teku/pull/3381#discussion_r539805504", "createdAt": "2020-12-10T02:53:38Z", "author": {"login": "ajsutton"}, "path": "infrastructure/async/src/main/java/tech/pegasys/teku/infrastructure/async/ThrottlingTaskQueue.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.infrastructure.async;\n+\n+import java.util.Queue;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.function.Supplier;\n+import org.hyperledger.besu.plugin.services.MetricsSystem;\n+import tech.pegasys.teku.infrastructure.metrics.SettableGauge;\n+import tech.pegasys.teku.infrastructure.metrics.TekuMetricCategory;\n+\n+public class ThrottlingTaskQueue {\n+  private final int maximumConcurrentRequests;\n+  private volatile Queue<Runnable> queuedRequests = new ConcurrentLinkedQueue<>();\n+  private int inflightRequestCount = 0;\n+\n+  private final SettableGauge queueSizeGauge;\n+\n+  public ThrottlingTaskQueue(\n+      final int maximumConcurrentRequests,\n+      final MetricsSystem metricsSystem,\n+      final TekuMetricCategory metricCategory,\n+      final String metricsPrefix) {\n+    this.maximumConcurrentRequests = maximumConcurrentRequests;\n+\n+    this.queueSizeGauge =\n+        SettableGauge.create(\n+            metricsSystem,\n+            metricCategory,\n+            metricsPrefix + \"_tasks_queued\",\n+            \"Number of tasks queued\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d75ec4b1a940ea2321c9073b6bb7ffbaf1e4c6"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4OTQ1OTYxOnYy", "diffSide": "RIGHT", "path": "pow/src/main/java/tech/pegasys/teku/pow/ThrottlingEth1Provider.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwMjo1NDo1NFrOICzJCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNDoxMzoyMFrOIC0tng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwNTk2MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        maximumConcurrentRequests, metricsSystem, TekuMetricCategory.BEACON, \"eth1Queue\");\n          \n          \n            \n                        maximumConcurrentRequests, metricsSystem, TekuMetricCategory.BEACON, \"eth1_request_queue_size\");", "url": "https://github.com/ConsenSys/teku/pull/3381#discussion_r539805960", "createdAt": "2020-12-10T02:54:54Z", "author": {"login": "ajsutton"}, "path": "pow/src/main/java/tech/pegasys/teku/pow/ThrottlingEth1Provider.java", "diffHunk": "@@ -16,94 +16,75 @@\n import java.math.BigInteger;\n import java.time.Duration;\n import java.util.Optional;\n-import java.util.Queue;\n-import java.util.concurrent.ConcurrentLinkedQueue;\n-import java.util.function.Supplier;\n+import org.hyperledger.besu.plugin.services.MetricsSystem;\n import org.web3j.protocol.core.methods.response.EthBlock.Block;\n import org.web3j.protocol.core.methods.response.EthCall;\n import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.async.ThrottlingTaskQueue;\n+import tech.pegasys.teku.infrastructure.metrics.TekuMetricCategory;\n import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n \n public class ThrottlingEth1Provider implements Eth1Provider {\n   private final Eth1Provider delegate;\n-  private final int maximumConcurrentRequests;\n-  private final Queue<Runnable> queuedRequests = new ConcurrentLinkedQueue<>();\n-  private int inflightRequestCount = 0;\n+  private final ThrottlingTaskQueue taskQueue;\n \n-  public ThrottlingEth1Provider(final Eth1Provider delegate, final int maximumConcurrentRequests) {\n+  public ThrottlingEth1Provider(\n+      final Eth1Provider delegate,\n+      final int maximumConcurrentRequests,\n+      final MetricsSystem metricsSystem) {\n     this.delegate = delegate;\n-    this.maximumConcurrentRequests = maximumConcurrentRequests;\n+    taskQueue =\n+        new ThrottlingTaskQueue(\n+            maximumConcurrentRequests, metricsSystem, TekuMetricCategory.BEACON, \"eth1Queue\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d75ec4b1a940ea2321c9073b6bb7ffbaf1e4c6"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgyOTE3Mg==", "bodyText": "it'll get queue_size from the task queue, just need the prefix... i'll set it to eth1_request", "url": "https://github.com/ConsenSys/teku/pull/3381#discussion_r539829172", "createdAt": "2020-12-10T04:05:06Z", "author": {"login": "rolfyone"}, "path": "pow/src/main/java/tech/pegasys/teku/pow/ThrottlingEth1Provider.java", "diffHunk": "@@ -16,94 +16,75 @@\n import java.math.BigInteger;\n import java.time.Duration;\n import java.util.Optional;\n-import java.util.Queue;\n-import java.util.concurrent.ConcurrentLinkedQueue;\n-import java.util.function.Supplier;\n+import org.hyperledger.besu.plugin.services.MetricsSystem;\n import org.web3j.protocol.core.methods.response.EthBlock.Block;\n import org.web3j.protocol.core.methods.response.EthCall;\n import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.async.ThrottlingTaskQueue;\n+import tech.pegasys.teku.infrastructure.metrics.TekuMetricCategory;\n import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n \n public class ThrottlingEth1Provider implements Eth1Provider {\n   private final Eth1Provider delegate;\n-  private final int maximumConcurrentRequests;\n-  private final Queue<Runnable> queuedRequests = new ConcurrentLinkedQueue<>();\n-  private int inflightRequestCount = 0;\n+  private final ThrottlingTaskQueue taskQueue;\n \n-  public ThrottlingEth1Provider(final Eth1Provider delegate, final int maximumConcurrentRequests) {\n+  public ThrottlingEth1Provider(\n+      final Eth1Provider delegate,\n+      final int maximumConcurrentRequests,\n+      final MetricsSystem metricsSystem) {\n     this.delegate = delegate;\n-    this.maximumConcurrentRequests = maximumConcurrentRequests;\n+    taskQueue =\n+        new ThrottlingTaskQueue(\n+            maximumConcurrentRequests, metricsSystem, TekuMetricCategory.BEACON, \"eth1Queue\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwNTk2MA=="}, "originalCommit": {"oid": "d1d75ec4b1a940ea2321c9073b6bb7ffbaf1e4c6"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgzMTcxMA==", "bodyText": "I think I'd probably just put the whole metric name here rather than appending to what's given.  Makes searching for the metric a lot easier.", "url": "https://github.com/ConsenSys/teku/pull/3381#discussion_r539831710", "createdAt": "2020-12-10T04:13:20Z", "author": {"login": "ajsutton"}, "path": "pow/src/main/java/tech/pegasys/teku/pow/ThrottlingEth1Provider.java", "diffHunk": "@@ -16,94 +16,75 @@\n import java.math.BigInteger;\n import java.time.Duration;\n import java.util.Optional;\n-import java.util.Queue;\n-import java.util.concurrent.ConcurrentLinkedQueue;\n-import java.util.function.Supplier;\n+import org.hyperledger.besu.plugin.services.MetricsSystem;\n import org.web3j.protocol.core.methods.response.EthBlock.Block;\n import org.web3j.protocol.core.methods.response.EthCall;\n import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.async.ThrottlingTaskQueue;\n+import tech.pegasys.teku.infrastructure.metrics.TekuMetricCategory;\n import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n \n public class ThrottlingEth1Provider implements Eth1Provider {\n   private final Eth1Provider delegate;\n-  private final int maximumConcurrentRequests;\n-  private final Queue<Runnable> queuedRequests = new ConcurrentLinkedQueue<>();\n-  private int inflightRequestCount = 0;\n+  private final ThrottlingTaskQueue taskQueue;\n \n-  public ThrottlingEth1Provider(final Eth1Provider delegate, final int maximumConcurrentRequests) {\n+  public ThrottlingEth1Provider(\n+      final Eth1Provider delegate,\n+      final int maximumConcurrentRequests,\n+      final MetricsSystem metricsSystem) {\n     this.delegate = delegate;\n-    this.maximumConcurrentRequests = maximumConcurrentRequests;\n+    taskQueue =\n+        new ThrottlingTaskQueue(\n+            maximumConcurrentRequests, metricsSystem, TekuMetricCategory.BEACON, \"eth1Queue\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwNTk2MA=="}, "originalCommit": {"oid": "d1d75ec4b1a940ea2321c9073b6bb7ffbaf1e4c6"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4OTQ2MTI1OnYy", "diffSide": "RIGHT", "path": "infrastructure/async/src/main/java/tech/pegasys/teku/infrastructure/async/ThrottlingTaskQueue.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwMjo1NTozMVrOICzJ6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwMjo1NTozMVrOICzJ6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwNjE4Ng==", "bodyText": "nit: Tasks aren't necessarily requests so this should probably just be queue or queueTask?", "url": "https://github.com/ConsenSys/teku/pull/3381#discussion_r539806186", "createdAt": "2020-12-10T02:55:31Z", "author": {"login": "ajsutton"}, "path": "infrastructure/async/src/main/java/tech/pegasys/teku/infrastructure/async/ThrottlingTaskQueue.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.infrastructure.async;\n+\n+import java.util.Queue;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.function.Supplier;\n+import org.hyperledger.besu.plugin.services.MetricsSystem;\n+import tech.pegasys.teku.infrastructure.metrics.SettableGauge;\n+import tech.pegasys.teku.infrastructure.metrics.TekuMetricCategory;\n+\n+public class ThrottlingTaskQueue {\n+  private final int maximumConcurrentRequests;\n+  private volatile Queue<Runnable> queuedRequests = new ConcurrentLinkedQueue<>();\n+  private int inflightRequestCount = 0;\n+\n+  private final SettableGauge queueSizeGauge;\n+\n+  public ThrottlingTaskQueue(\n+      final int maximumConcurrentRequests,\n+      final MetricsSystem metricsSystem,\n+      final TekuMetricCategory metricCategory,\n+      final String metricsPrefix) {\n+    this.maximumConcurrentRequests = maximumConcurrentRequests;\n+\n+    this.queueSizeGauge =\n+        SettableGauge.create(\n+            metricsSystem,\n+            metricCategory,\n+            metricsPrefix + \"_tasks_queued\",\n+            \"Number of tasks queued\");\n+  }\n+\n+  public <T> SafeFuture<T> queueRequest(final Supplier<SafeFuture<T>> request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d75ec4b1a940ea2321c9073b6bb7ffbaf1e4c6"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4OTQ2NzgxOnYy", "diffSide": "RIGHT", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/ValidatorLoader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwMjo1ODowMlrOICzNZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNDowODoyN1rOIC0n4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwNzA3Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"ExternalSigner\");\n          \n          \n            \n                        \"external_signer_request_queue_size\");", "url": "https://github.com/ConsenSys/teku/pull/3381#discussion_r539807076", "createdAt": "2020-12-10T02:58:02Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/ValidatorLoader.java", "diffHunk": "@@ -104,6 +114,12 @@ public static ValidatorLoader create(\n     if (config.getValidatorExternalSignerPublicKeys().isEmpty()) {\n       return Collections.emptyMap();\n     }\n+    externalSignerTaskQueue =\n+        new ThrottlingTaskQueue(\n+            config.getValidatorExternalSignerConcurrentRequestLimit(),\n+            metricsSystem,\n+            TekuMetricCategory.VALIDATOR,\n+            \"ExternalSigner\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d75ec4b1a940ea2321c9073b6bb7ffbaf1e4c6"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgzMDI0MA==", "bodyText": "same theory as above, i'll rename to external_signer as the prefix", "url": "https://github.com/ConsenSys/teku/pull/3381#discussion_r539830240", "createdAt": "2020-12-10T04:08:27Z", "author": {"login": "rolfyone"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/ValidatorLoader.java", "diffHunk": "@@ -104,6 +114,12 @@ public static ValidatorLoader create(\n     if (config.getValidatorExternalSignerPublicKeys().isEmpty()) {\n       return Collections.emptyMap();\n     }\n+    externalSignerTaskQueue =\n+        new ThrottlingTaskQueue(\n+            config.getValidatorExternalSignerConcurrentRequestLimit(),\n+            metricsSystem,\n+            TekuMetricCategory.VALIDATOR,\n+            \"ExternalSigner\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwNzA3Ng=="}, "originalCommit": {"oid": "d1d75ec4b1a940ea2321c9073b6bb7ffbaf1e4c6"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4OTQ5MDM2OnYy", "diffSide": "RIGHT", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/ValidatorLoader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwMzowNzowM1rOICzZfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwMzowNzowM1rOICzZfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgxMDE3NA==", "bodyText": "This doesn't seem to need to be a field.", "url": "https://github.com/ConsenSys/teku/pull/3381#discussion_r539810174", "createdAt": "2020-12-10T03:07:03Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/ValidatorLoader.java", "diffHunk": "@@ -104,6 +114,12 @@ public static ValidatorLoader create(\n     if (config.getValidatorExternalSignerPublicKeys().isEmpty()) {\n       return Collections.emptyMap();\n     }\n+    externalSignerTaskQueue =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d75ec4b1a940ea2321c9073b6bb7ffbaf1e4c6"}, "originalPosition": 48}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2929, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}