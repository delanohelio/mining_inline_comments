{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5NjYwOTI4", "number": 1391, "title": "[#1365] - Use v3 keystore for Eth1 private key in validator subcommand", "bodyText": "PR Description\n\nIntroduce new cli options\n\n      --eth1-keystore-file=<FILE>\n                         Path to encrypted (V3) keystore containing Ethereum 1\n                           private key to use to send transactions\n      --eth1-keystore-password-file=<FILE>\n                         Path to file containing password to decrypt Ethereum 1\n                           keystore\n\n\nRename --private-key to --eth1-private-key\n\nFixed Issue(s)\nIssue: #1365\nSigned-off-by: Usman Saleem usman@usmans.info", "createdAt": "2020-03-17T07:03:42Z", "url": "https://github.com/ConsenSys/teku/pull/1391", "merged": true, "mergeCommit": {"oid": "65cddbee2e2630439ddd0fad48c8a12fb6a0567e"}, "closed": true, "closedAt": "2020-03-18T03:37:35Z", "author": {"login": "usmansaleem"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOdK9DAH2gAyMzg5NjYwOTI4OjdlMGI3YTdmMGUyMWZmZGNkMjY5YzAxMDYzZDkxMzRiNTEwZjMxYzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOt_gdgH2gAyMzg5NjYwOTI4OmVjOTZkODgyODdkNDFjZWRhYTMyZDRmODRmYzJkNzg0N2Q4YmJmZjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7e0b7a7f0e21ffdcd269c01063d9134b510f31c6", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/7e0b7a7f0e21ffdcd269c01063d9134b510f31c6", "committedDate": "2020-03-17T07:00:14Z", "message": "[#1365] - Use v3 keystore for Eth1 private key in validator subcommand\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29f7307beb383321a779aa516ffb8102a14b5f8f", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/29f7307beb383321a779aa516ffb8102a14b5f8f", "committedDate": "2020-03-17T07:06:19Z", "message": "remove short option -p\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a530cf22dc498d0b7902901fa1022e3516b0aa73", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/a530cf22dc498d0b7902901fa1022e3516b0aa73", "committedDate": "2020-03-17T07:11:31Z", "message": "spotless fix\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33dbc7109ffab97a86bf45a980795faad3397db7", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/33dbc7109ffab97a86bf45a980795faad3397db7", "committedDate": "2020-03-17T07:16:36Z", "message": "Merge remote-tracking branch 'upstream/master' into 1365_eth1_privatekey\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0011000c9838d196f243082214cf852cefdb2e7a", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/0011000c9838d196f243082214cf852cefdb2e7a", "committedDate": "2020-03-17T08:04:22Z", "message": "adding unit tests\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NDcwOTUw", "url": "https://github.com/ConsenSys/teku/pull/1391#pullrequestreview-376470950", "createdAt": "2020-03-17T23:24:30Z", "commit": {"oid": "0011000c9838d196f243082214cf852cefdb2e7a"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QyMzoyNDozMFrOF3xfSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QyMzo0MjoxMlrOF3x2DQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyNjgyNA==", "bodyText": "nit: Instead of saying \"reading v3 keystore\" I think just calling it an Eth1 keystore would be clearer so something like \"reading Eth1 keystore\"", "url": "https://github.com/ConsenSys/teku/pull/1391#discussion_r394026824", "createdAt": "2020-03-17T23:24:30Z", "author": {"login": "jframe"}, "path": "artemis/src/main/java/tech/pegasys/artemis/cli/deposit/CommonParams.java", "diffHunk": "@@ -85,6 +103,41 @@ public UnsignedLong getAmount() {\n     return amount;\n   }\n \n+  Credentials getEth1Credentials() {\n+    if (eth1PrivateKeyOptions.eth1PrivateKey != null) {\n+      return Credentials.create(eth1PrivateKeyOptions.eth1PrivateKey);\n+    }\n+\n+    final String keystorePassword =\n+        KeystorePasswordOptions.readFromFile(\n+            spec.commandLine(),\n+            eth1PrivateKeyOptions.keystoreOptions.eth1PrivateKeystorePasswordFile);\n+    final File eth1PrivateKeystoreFile =\n+        eth1PrivateKeyOptions.keystoreOptions.eth1PrivateKeystoreFile;\n+    try {\n+      return WalletUtils.loadCredentials(keystorePassword, eth1PrivateKeystoreFile);\n+    } catch (final FileNotFoundException e) {\n+      throw new CommandLine.ParameterException(\n+          spec.commandLine(), \"Error: File not found: \" + eth1PrivateKeystoreFile, e);\n+    } catch (final IOException e) {\n+      throw new CommandLine.ParameterException(\n+          spec.commandLine(),\n+          \"Error: Unexpected IO Error while reading v3 keystore [\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0011000c9838d196f243082214cf852cefdb2e7a"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyNzQ2Ng==", "bodyText": "Do we need include private as part of this? It technically contains both. I think just \"--eth1-keystore-file\" would be enough", "url": "https://github.com/ConsenSys/teku/pull/1391#discussion_r394027466", "createdAt": "2020-03-17T23:26:50Z", "author": {"login": "jframe"}, "path": "artemis/src/main/java/tech/pegasys/artemis/cli/deposit/Eth1PrivateKeyOptions.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.cli.deposit;\n+\n+import java.io.File;\n+import picocli.CommandLine.ArgGroup;\n+import picocli.CommandLine.Option;\n+\n+class Eth1PrivateKeyOptions {\n+  @Option(\n+      names = {\"--eth1-private-key\"},\n+      required = true,\n+      paramLabel = \"<KEY>\",\n+      description = \"Ethereum 1 private key to use to send transactions\")\n+  String eth1PrivateKey;\n+\n+  @ArgGroup(exclusive = false, multiplicity = \"1\")\n+  Eth1EncryptedPrivateKeystoreOptions keystoreOptions;\n+\n+  static class Eth1EncryptedPrivateKeystoreOptions {\n+    @Option(\n+        names = {\"--eth1-private-keystore-file\"},", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0011000c9838d196f243082214cf852cefdb2e7a"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyNzYxNQ==", "bodyText": "Same as the related option, I think this can just be \"eth1-keystore-password-file\"", "url": "https://github.com/ConsenSys/teku/pull/1391#discussion_r394027615", "createdAt": "2020-03-17T23:27:23Z", "author": {"login": "jframe"}, "path": "artemis/src/main/java/tech/pegasys/artemis/cli/deposit/Eth1PrivateKeyOptions.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.cli.deposit;\n+\n+import java.io.File;\n+import picocli.CommandLine.ArgGroup;\n+import picocli.CommandLine.Option;\n+\n+class Eth1PrivateKeyOptions {\n+  @Option(\n+      names = {\"--eth1-private-key\"},\n+      required = true,\n+      paramLabel = \"<KEY>\",\n+      description = \"Ethereum 1 private key to use to send transactions\")\n+  String eth1PrivateKey;\n+\n+  @ArgGroup(exclusive = false, multiplicity = \"1\")\n+  Eth1EncryptedPrivateKeystoreOptions keystoreOptions;\n+\n+  static class Eth1EncryptedPrivateKeystoreOptions {\n+    @Option(\n+        names = {\"--eth1-private-keystore-file\"},\n+        required = true,\n+        paramLabel = \"<FILE>\",\n+        description =\n+            \"Path to encrypted (V3) keystore containing Ethereum 1 private key to use to send transactions\")\n+    File eth1PrivateKeystoreFile;\n+\n+    @Option(\n+        names = {\"--eth1-private-keystore-password-file\"},", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0011000c9838d196f243082214cf852cefdb2e7a"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyOTkzMQ==", "bodyText": "This block creating the credentials for the keystore would be nice to go into seperate function", "url": "https://github.com/ConsenSys/teku/pull/1391#discussion_r394029931", "createdAt": "2020-03-17T23:35:29Z", "author": {"login": "jframe"}, "path": "artemis/src/main/java/tech/pegasys/artemis/cli/deposit/CommonParams.java", "diffHunk": "@@ -85,6 +103,41 @@ public UnsignedLong getAmount() {\n     return amount;\n   }\n \n+  Credentials getEth1Credentials() {\n+    if (eth1PrivateKeyOptions.eth1PrivateKey != null) {\n+      return Credentials.create(eth1PrivateKeyOptions.eth1PrivateKey);\n+    }\n+\n+    final String keystorePassword =\n+        KeystorePasswordOptions.readFromFile(\n+            spec.commandLine(),\n+            eth1PrivateKeyOptions.keystoreOptions.eth1PrivateKeystorePasswordFile);\n+    final File eth1PrivateKeystoreFile =\n+        eth1PrivateKeyOptions.keystoreOptions.eth1PrivateKeystoreFile;\n+    try {\n+      return WalletUtils.loadCredentials(keystorePassword, eth1PrivateKeystoreFile);\n+    } catch (final FileNotFoundException e) {\n+      throw new CommandLine.ParameterException(\n+          spec.commandLine(), \"Error: File not found: \" + eth1PrivateKeystoreFile, e);\n+    } catch (final IOException e) {\n+      throw new CommandLine.ParameterException(\n+          spec.commandLine(),\n+          \"Error: Unexpected IO Error while reading v3 keystore [\"\n+              + eth1PrivateKeystoreFile\n+              + \"] : \"\n+              + e.getMessage(),\n+          e);\n+    } catch (CipherException e) {\n+      throw new CommandLine.ParameterException(\n+          spec.commandLine(),\n+          \"Error: Unable to decrypt v3 keystore [\"\n+              + eth1PrivateKeystoreFile\n+              + \"] : \"\n+              + e.getMessage(),\n+          e);\n+    }\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0011000c9838d196f243082214cf852cefdb2e7a"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAzMDE5NA==", "bodyText": "Same as before I thinking we should just call it an Eth1 keystore?", "url": "https://github.com/ConsenSys/teku/pull/1391#discussion_r394030194", "createdAt": "2020-03-17T23:36:17Z", "author": {"login": "jframe"}, "path": "artemis/src/main/java/tech/pegasys/artemis/cli/deposit/CommonParams.java", "diffHunk": "@@ -85,6 +103,41 @@ public UnsignedLong getAmount() {\n     return amount;\n   }\n \n+  Credentials getEth1Credentials() {\n+    if (eth1PrivateKeyOptions.eth1PrivateKey != null) {\n+      return Credentials.create(eth1PrivateKeyOptions.eth1PrivateKey);\n+    }\n+\n+    final String keystorePassword =\n+        KeystorePasswordOptions.readFromFile(\n+            spec.commandLine(),\n+            eth1PrivateKeyOptions.keystoreOptions.eth1PrivateKeystorePasswordFile);\n+    final File eth1PrivateKeystoreFile =\n+        eth1PrivateKeyOptions.keystoreOptions.eth1PrivateKeystoreFile;\n+    try {\n+      return WalletUtils.loadCredentials(keystorePassword, eth1PrivateKeystoreFile);\n+    } catch (final FileNotFoundException e) {\n+      throw new CommandLine.ParameterException(\n+          spec.commandLine(), \"Error: File not found: \" + eth1PrivateKeystoreFile, e);\n+    } catch (final IOException e) {\n+      throw new CommandLine.ParameterException(\n+          spec.commandLine(),\n+          \"Error: Unexpected IO Error while reading v3 keystore [\"\n+              + eth1PrivateKeystoreFile\n+              + \"] : \"\n+              + e.getMessage(),\n+          e);\n+    } catch (CipherException e) {\n+      throw new CommandLine.ParameterException(\n+          spec.commandLine(),\n+          \"Error: Unable to decrypt v3 keystore [\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0011000c9838d196f243082214cf852cefdb2e7a"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAzMDMxMg==", "bodyText": "nit final", "url": "https://github.com/ConsenSys/teku/pull/1391#discussion_r394030312", "createdAt": "2020-03-17T23:36:44Z", "author": {"login": "jframe"}, "path": "artemis/src/test/java/tech/pegasys/artemis/cli/deposit/CommonParamsTest.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.cli.deposit;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatExceptionOfType;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.web3j.crypto.CipherException;\n+import org.web3j.crypto.Credentials;\n+import org.web3j.crypto.ECKeyPair;\n+import org.web3j.crypto.WalletUtils;\n+import org.web3j.utils.Numeric;\n+import picocli.CommandLine;\n+import picocli.CommandLine.Model.CommandSpec;\n+\n+class CommonParamsTest {\n+  private static final String ETH1_PRIVATE_KEY =\n+      \"8f2a55949038a9610f50fb23b5883af3b4ecb3c3bb792cbcefbd1542c692be63\";\n+  private static final ECKeyPair EXPECTED_EC_KEYPAIR =\n+      ECKeyPair.create(Numeric.toBigInt(ETH1_PRIVATE_KEY));\n+  private static final String PASSWORD = \"test123\";\n+  private CommandSpec commandSpec = mock(CommandSpec.class);\n+\n+  @Test\n+  void eth1PrivateKeyReturnsCredential() {\n+    Eth1PrivateKeyOptions eth1PrivateKeyOptions = new Eth1PrivateKeyOptions();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0011000c9838d196f243082214cf852cefdb2e7a"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAzMDg0Nw==", "bodyText": "nit: missing some finals", "url": "https://github.com/ConsenSys/teku/pull/1391#discussion_r394030847", "createdAt": "2020-03-17T23:38:22Z", "author": {"login": "jframe"}, "path": "artemis/src/test/java/tech/pegasys/artemis/cli/deposit/CommonParamsTest.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.cli.deposit;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatExceptionOfType;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.web3j.crypto.CipherException;\n+import org.web3j.crypto.Credentials;\n+import org.web3j.crypto.ECKeyPair;\n+import org.web3j.crypto.WalletUtils;\n+import org.web3j.utils.Numeric;\n+import picocli.CommandLine;\n+import picocli.CommandLine.Model.CommandSpec;\n+\n+class CommonParamsTest {\n+  private static final String ETH1_PRIVATE_KEY =\n+      \"8f2a55949038a9610f50fb23b5883af3b4ecb3c3bb792cbcefbd1542c692be63\";\n+  private static final ECKeyPair EXPECTED_EC_KEYPAIR =\n+      ECKeyPair.create(Numeric.toBigInt(ETH1_PRIVATE_KEY));\n+  private static final String PASSWORD = \"test123\";\n+  private CommandSpec commandSpec = mock(CommandSpec.class);\n+\n+  @Test\n+  void eth1PrivateKeyReturnsCredential() {\n+    Eth1PrivateKeyOptions eth1PrivateKeyOptions = new Eth1PrivateKeyOptions();\n+    eth1PrivateKeyOptions.eth1PrivateKey = ETH1_PRIVATE_KEY;\n+    CommonParams commonParams = new CommonParams(commandSpec, eth1PrivateKeyOptions);\n+    final Credentials eth1Credentials = commonParams.getEth1Credentials();\n+    assertThat(eth1Credentials.getEcKeyPair()).isEqualTo(EXPECTED_EC_KEYPAIR);\n+  }\n+\n+  @Test\n+  void eth1EncryptedKeystoreReturnsCredential(@TempDir final Path tempDir)\n+      throws IOException, CipherException {\n+    // create v3 wallet\n+    final String keystoreFileName =\n+        WalletUtils.generateWalletFile(PASSWORD, EXPECTED_EC_KEYPAIR, tempDir.toFile(), true);\n+    final File keystoreFile = tempDir.resolve(keystoreFileName).toFile();\n+    // create password file\n+    final File passwordFile =\n+        Files.writeString(tempDir.resolve(\"password.txt\"), \"test123\").toFile();\n+\n+    Eth1PrivateKeyOptions.Eth1EncryptedPrivateKeystoreOptions keystoreOptions =\n+        new Eth1PrivateKeyOptions.Eth1EncryptedPrivateKeystoreOptions();\n+    keystoreOptions.eth1PrivateKeystoreFile = keystoreFile;\n+    keystoreOptions.eth1PrivateKeystorePasswordFile = passwordFile;\n+\n+    Eth1PrivateKeyOptions eth1PrivateKeyOptions = new Eth1PrivateKeyOptions();\n+    eth1PrivateKeyOptions.keystoreOptions = keystoreOptions;\n+\n+    CommonParams commonParams = new CommonParams(commandSpec, eth1PrivateKeyOptions);\n+    final Credentials eth1Credentials = commonParams.getEth1Credentials();\n+    assertThat(eth1Credentials.getEcKeyPair()).isEqualTo(EXPECTED_EC_KEYPAIR);\n+  }\n+\n+  @Test\n+  void nonExistentEth1EncryptedKeystoreThrowsError(@TempDir final Path tempDir)\n+      throws IOException, CipherException {\n+    Eth1PrivateKeyOptions.Eth1EncryptedPrivateKeystoreOptions keystoreOptions =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0011000c9838d196f243082214cf852cefdb2e7a"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAzMjY1Mw==", "bodyText": "From this error, we testing that the incorrect version of the wallet store was provided? Can the test be renamed to make this clearer?", "url": "https://github.com/ConsenSys/teku/pull/1391#discussion_r394032653", "createdAt": "2020-03-17T23:42:12Z", "author": {"login": "jframe"}, "path": "artemis/src/test/java/tech/pegasys/artemis/cli/deposit/CommonParamsTest.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.cli.deposit;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatExceptionOfType;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.web3j.crypto.CipherException;\n+import org.web3j.crypto.Credentials;\n+import org.web3j.crypto.ECKeyPair;\n+import org.web3j.crypto.WalletUtils;\n+import org.web3j.utils.Numeric;\n+import picocli.CommandLine;\n+import picocli.CommandLine.Model.CommandSpec;\n+\n+class CommonParamsTest {\n+  private static final String ETH1_PRIVATE_KEY =\n+      \"8f2a55949038a9610f50fb23b5883af3b4ecb3c3bb792cbcefbd1542c692be63\";\n+  private static final ECKeyPair EXPECTED_EC_KEYPAIR =\n+      ECKeyPair.create(Numeric.toBigInt(ETH1_PRIVATE_KEY));\n+  private static final String PASSWORD = \"test123\";\n+  private CommandSpec commandSpec = mock(CommandSpec.class);\n+\n+  @Test\n+  void eth1PrivateKeyReturnsCredential() {\n+    Eth1PrivateKeyOptions eth1PrivateKeyOptions = new Eth1PrivateKeyOptions();\n+    eth1PrivateKeyOptions.eth1PrivateKey = ETH1_PRIVATE_KEY;\n+    CommonParams commonParams = new CommonParams(commandSpec, eth1PrivateKeyOptions);\n+    final Credentials eth1Credentials = commonParams.getEth1Credentials();\n+    assertThat(eth1Credentials.getEcKeyPair()).isEqualTo(EXPECTED_EC_KEYPAIR);\n+  }\n+\n+  @Test\n+  void eth1EncryptedKeystoreReturnsCredential(@TempDir final Path tempDir)\n+      throws IOException, CipherException {\n+    // create v3 wallet\n+    final String keystoreFileName =\n+        WalletUtils.generateWalletFile(PASSWORD, EXPECTED_EC_KEYPAIR, tempDir.toFile(), true);\n+    final File keystoreFile = tempDir.resolve(keystoreFileName).toFile();\n+    // create password file\n+    final File passwordFile =\n+        Files.writeString(tempDir.resolve(\"password.txt\"), \"test123\").toFile();\n+\n+    Eth1PrivateKeyOptions.Eth1EncryptedPrivateKeystoreOptions keystoreOptions =\n+        new Eth1PrivateKeyOptions.Eth1EncryptedPrivateKeystoreOptions();\n+    keystoreOptions.eth1PrivateKeystoreFile = keystoreFile;\n+    keystoreOptions.eth1PrivateKeystorePasswordFile = passwordFile;\n+\n+    Eth1PrivateKeyOptions eth1PrivateKeyOptions = new Eth1PrivateKeyOptions();\n+    eth1PrivateKeyOptions.keystoreOptions = keystoreOptions;\n+\n+    CommonParams commonParams = new CommonParams(commandSpec, eth1PrivateKeyOptions);\n+    final Credentials eth1Credentials = commonParams.getEth1Credentials();\n+    assertThat(eth1Credentials.getEcKeyPair()).isEqualTo(EXPECTED_EC_KEYPAIR);\n+  }\n+\n+  @Test\n+  void nonExistentEth1EncryptedKeystoreThrowsError(@TempDir final Path tempDir)\n+      throws IOException, CipherException {\n+    Eth1PrivateKeyOptions.Eth1EncryptedPrivateKeystoreOptions keystoreOptions =\n+        new Eth1PrivateKeyOptions.Eth1EncryptedPrivateKeystoreOptions();\n+    keystoreOptions.eth1PrivateKeystoreFile = tempDir.resolve(\"nonExistent\").toFile();\n+    keystoreOptions.eth1PrivateKeystorePasswordFile = tempDir.resolve(\"nonExistent\").toFile();\n+\n+    Eth1PrivateKeyOptions eth1PrivateKeyOptions = new Eth1PrivateKeyOptions();\n+    eth1PrivateKeyOptions.keystoreOptions = keystoreOptions;\n+\n+    CommonParams commonParams = new CommonParams(commandSpec, eth1PrivateKeyOptions);\n+\n+    when(commandSpec.commandLine()).thenReturn(mock(CommandLine.class));\n+    assertThatExceptionOfType(CommandLine.ParameterException.class)\n+        .isThrownBy(() -> commonParams.getEth1Credentials())\n+        .withMessage(\"Error: File not found: \" + keystoreOptions.eth1PrivateKeystoreFile);\n+  }\n+\n+  @Test\n+  void invalidEth1EncryptedKeystoreThrowsError(@TempDir final Path tempDir) throws IOException {\n+    Eth1PrivateKeyOptions.Eth1EncryptedPrivateKeystoreOptions keystoreOptions =\n+        new Eth1PrivateKeyOptions.Eth1EncryptedPrivateKeystoreOptions();\n+    keystoreOptions.eth1PrivateKeystoreFile =\n+        Files.writeString(tempDir.resolve(\"v3.json\"), \"{test:123}\").toFile();\n+    keystoreOptions.eth1PrivateKeystorePasswordFile =\n+        Files.writeString(tempDir.resolve(\"password.txt\"), \"test123\").toFile();\n+\n+    Eth1PrivateKeyOptions eth1PrivateKeyOptions = new Eth1PrivateKeyOptions();\n+    eth1PrivateKeyOptions.keystoreOptions = keystoreOptions;\n+\n+    CommonParams commonParams = new CommonParams(commandSpec, eth1PrivateKeyOptions);\n+\n+    when(commandSpec.commandLine()).thenReturn(mock(CommandLine.class));\n+    assertThatExceptionOfType(CommandLine.ParameterException.class)\n+        .isThrownBy(() -> commonParams.getEth1Credentials())\n+        .withMessage(\n+            \"Error: Unable to decrypt v3 keystore [%s] : Wallet version is not supported\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0011000c9838d196f243082214cf852cefdb2e7a"}, "originalPosition": 113}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97ab422bb08bbe1230b506bee068777dccbc835d", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/97ab422bb08bbe1230b506bee068777dccbc835d", "committedDate": "2020-03-17T23:45:42Z", "message": "Merge remote-tracking branch 'upstream/master' into 1365_eth1_privatekey\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97f2fdeb47d11c486bbaf5cf189502748c03c2ef", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/97f2fdeb47d11c486bbaf5cf189502748c03c2ef", "committedDate": "2020-03-17T23:47:15Z", "message": "review suggestion - renaming cli option\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e895b84379138b47f9676c11ab0ef4669d68517c", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/e895b84379138b47f9676c11ab0ef4669d68517c", "committedDate": "2020-03-17T23:50:23Z", "message": "review suggestion - updating exception msg\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed791cd9ac495b2cea1c59842857c6507518f8a8", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/ed791cd9ac495b2cea1c59842857c6507518f8a8", "committedDate": "2020-03-18T00:00:24Z", "message": "review suggestion - minor refactoring\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTA5NzIz", "url": "https://github.com/ConsenSys/teku/pull/1391#pullrequestreview-376509723", "createdAt": "2020-03-18T01:35:12Z", "commit": {"oid": "ed791cd9ac495b2cea1c59842857c6507518f8a8"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMTozNToxM1rOF3ziCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMTozNjo0NlrOF3zjfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2MDI5OA==", "bodyText": "nit: since we are getting rid of private as part of describing the eth1 keystore might as well drop it here as well to be consistent. so Eth1EncryptedKeystoreOptions?", "url": "https://github.com/ConsenSys/teku/pull/1391#discussion_r394060298", "createdAt": "2020-03-18T01:35:13Z", "author": {"login": "jframe"}, "path": "artemis/src/main/java/tech/pegasys/artemis/cli/deposit/Eth1PrivateKeyOptions.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.cli.deposit;\n+\n+import java.io.File;\n+import picocli.CommandLine.ArgGroup;\n+import picocli.CommandLine.Option;\n+\n+class Eth1PrivateKeyOptions {\n+  @Option(\n+      names = {\"--eth1-private-key\"},\n+      required = true,\n+      paramLabel = \"<KEY>\",\n+      description = \"Ethereum 1 private key to use to send transactions\")\n+  String eth1PrivateKey;\n+\n+  @ArgGroup(exclusive = false, multiplicity = \"1\")\n+  Eth1EncryptedPrivateKeystoreOptions keystoreOptions;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed791cd9ac495b2cea1c59842857c6507518f8a8"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2MDQyOA==", "bodyText": "Similar to above perhaps Eth1EncryptedKeystoreOptions", "url": "https://github.com/ConsenSys/teku/pull/1391#discussion_r394060428", "createdAt": "2020-03-18T01:35:41Z", "author": {"login": "jframe"}, "path": "artemis/src/main/java/tech/pegasys/artemis/cli/deposit/Eth1PrivateKeyOptions.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.cli.deposit;\n+\n+import java.io.File;\n+import picocli.CommandLine.ArgGroup;\n+import picocli.CommandLine.Option;\n+\n+class Eth1PrivateKeyOptions {\n+  @Option(\n+      names = {\"--eth1-private-key\"},\n+      required = true,\n+      paramLabel = \"<KEY>\",\n+      description = \"Ethereum 1 private key to use to send transactions\")\n+  String eth1PrivateKey;\n+\n+  @ArgGroup(exclusive = false, multiplicity = \"1\")\n+  Eth1EncryptedPrivateKeystoreOptions keystoreOptions;\n+\n+  static class Eth1EncryptedPrivateKeystoreOptions {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed791cd9ac495b2cea1c59842857c6507518f8a8"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2MDU3OQ==", "bodyText": "update the field to match the new param name, so eth1KeystoreFile", "url": "https://github.com/ConsenSys/teku/pull/1391#discussion_r394060579", "createdAt": "2020-03-18T01:36:23Z", "author": {"login": "jframe"}, "path": "artemis/src/main/java/tech/pegasys/artemis/cli/deposit/Eth1PrivateKeyOptions.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.cli.deposit;\n+\n+import java.io.File;\n+import picocli.CommandLine.ArgGroup;\n+import picocli.CommandLine.Option;\n+\n+class Eth1PrivateKeyOptions {\n+  @Option(\n+      names = {\"--eth1-private-key\"},\n+      required = true,\n+      paramLabel = \"<KEY>\",\n+      description = \"Ethereum 1 private key to use to send transactions\")\n+  String eth1PrivateKey;\n+\n+  @ArgGroup(exclusive = false, multiplicity = \"1\")\n+  Eth1EncryptedPrivateKeystoreOptions keystoreOptions;\n+\n+  static class Eth1EncryptedPrivateKeystoreOptions {\n+    @Option(\n+        names = {\"--eth1-keystore-file\"},\n+        required = true,\n+        paramLabel = \"<FILE>\",\n+        description =\n+            \"Path to encrypted (V3) keystore containing Ethereum 1 private key to use to send transactions\")\n+    File eth1PrivateKeystoreFile;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed791cd9ac495b2cea1c59842857c6507518f8a8"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2MDY2OA==", "bodyText": "update the field to match the new param name, so eth1KeystorePasswordFile", "url": "https://github.com/ConsenSys/teku/pull/1391#discussion_r394060668", "createdAt": "2020-03-18T01:36:46Z", "author": {"login": "jframe"}, "path": "artemis/src/main/java/tech/pegasys/artemis/cli/deposit/Eth1PrivateKeyOptions.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.cli.deposit;\n+\n+import java.io.File;\n+import picocli.CommandLine.ArgGroup;\n+import picocli.CommandLine.Option;\n+\n+class Eth1PrivateKeyOptions {\n+  @Option(\n+      names = {\"--eth1-private-key\"},\n+      required = true,\n+      paramLabel = \"<KEY>\",\n+      description = \"Ethereum 1 private key to use to send transactions\")\n+  String eth1PrivateKey;\n+\n+  @ArgGroup(exclusive = false, multiplicity = \"1\")\n+  Eth1EncryptedPrivateKeystoreOptions keystoreOptions;\n+\n+  static class Eth1EncryptedPrivateKeystoreOptions {\n+    @Option(\n+        names = {\"--eth1-keystore-file\"},\n+        required = true,\n+        paramLabel = \"<FILE>\",\n+        description =\n+            \"Path to encrypted (V3) keystore containing Ethereum 1 private key to use to send transactions\")\n+    File eth1PrivateKeystoreFile;\n+\n+    @Option(\n+        names = {\"--eth1-keystore-password-file\"},\n+        required = true,\n+        paramLabel = \"<FILE>\",\n+        description = \"Path to file containing password to decrypt Ethereum 1 keystore\")\n+    File eth1PrivateKeystorePasswordFile;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed791cd9ac495b2cea1c59842857c6507518f8a8"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fee737a43d5e7922863d5021089ca2ff688f25a8", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/fee737a43d5e7922863d5021089ca2ff688f25a8", "committedDate": "2020-03-18T01:44:25Z", "message": "review suggestion - minor refactoring\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTEyNzM1", "url": "https://github.com/ConsenSys/teku/pull/1391#pullrequestreview-376512735", "createdAt": "2020-03-18T01:46:06Z", "commit": {"oid": "fee737a43d5e7922863d5021089ca2ff688f25a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec96d88287d41cedaa32d4f84fc2d7847d8bbff4", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/ec96d88287d41cedaa32d4f84fc2d7847d8bbff4", "committedDate": "2020-03-18T02:36:07Z", "message": "Merge remote-tracking branch 'upstream/master' into 1365_eth1_privatekey\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3998, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}