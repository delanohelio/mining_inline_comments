{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MTk0NDU3", "number": 1990, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDozMToxN1rOEAiNgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDozNDowNFrOEAiUMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4OTk1OTcwOnYy", "diffSide": "RIGHT", "path": "pow/src/main/java/tech/pegasys/teku/pow/Eth1HeadTracker.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDozMToxN1rOGb370Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMDo0OToyOVrOGcGM7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg4MTE2OQ==", "bodyText": "There is a possibility that running pollLatestHead every SECONDS_PER_ETH1_BLOCK leads to us trailing almost a block behind the ETH1_FOLLOW_DISTANCE. Not sure if that would be a problem.", "url": "https://github.com/ConsenSys/teku/pull/1990#discussion_r431881169", "createdAt": "2020-05-28T14:31:17Z", "author": {"login": "cemozerr"}, "path": "pow/src/main/java/tech/pegasys/teku/pow/Eth1HeadTracker.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.pow;\n+\n+import static tech.pegasys.teku.util.config.Constants.ETH1_FOLLOW_DISTANCE;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.Optional;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.web3j.protocol.core.methods.response.EthBlock.Block;\n+import tech.pegasys.teku.util.async.AsyncRunner;\n+import tech.pegasys.teku.util.config.Constants;\n+import tech.pegasys.teku.util.events.Subscribers;\n+\n+public class Eth1HeadTracker {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final AtomicBoolean running = new AtomicBoolean(false);\n+  private final AsyncRunner asyncRunner;\n+  private final Eth1Provider eth1Provider;\n+  private Optional<UnsignedLong> headAtFollowDistance = Optional.empty();\n+\n+  private final Subscribers<HeadUpdatedSubscriber> subscribers = Subscribers.create(true);\n+\n+  public Eth1HeadTracker(final AsyncRunner asyncRunner, final Eth1Provider eth1Provider) {\n+    this.asyncRunner = asyncRunner;\n+    this.eth1Provider = eth1Provider;\n+  }\n+\n+  public void start() {\n+    if (!running.compareAndSet(false, true)) {\n+      return;\n+    }\n+    pollLatestHead();\n+  }\n+\n+  private void pollLatestHead() {\n+    if (!running.get()) {\n+      return;\n+    }\n+    eth1Provider\n+        .getLatestEth1Block()\n+        .thenAccept(this::onLatestBlockHead)\n+        .exceptionally(\n+            error -> {\n+              LOG.warn(\"Failed to get latest ETH1 chain head. Will retry.\", error);\n+              return null;\n+            })\n+        .always(\n+            () ->\n+                asyncRunner\n+                    .runAfterDelay(\n+                        this::pollLatestHead,\n+                        Constants.SECONDS_PER_ETH1_BLOCK.longValue(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ae3f49449ed3e07c1aaa8eef95d34966d2bb229"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExNDkyNw==", "bodyText": "I think we can live with that - we're already 1024 blocks behind the chain, what's one more?  And in practice block Tims are never exactly SECONDS_PER_ETH1_BLOCK apart anyway (on G\u00f6rli block are consistently every 15 seconds, not 14 and the vary a lot on Mainnet) so the amount we're behind will vary.", "url": "https://github.com/ConsenSys/teku/pull/1990#discussion_r432114927", "createdAt": "2020-05-28T20:49:29Z", "author": {"login": "ajsutton"}, "path": "pow/src/main/java/tech/pegasys/teku/pow/Eth1HeadTracker.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.pow;\n+\n+import static tech.pegasys.teku.util.config.Constants.ETH1_FOLLOW_DISTANCE;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.Optional;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.web3j.protocol.core.methods.response.EthBlock.Block;\n+import tech.pegasys.teku.util.async.AsyncRunner;\n+import tech.pegasys.teku.util.config.Constants;\n+import tech.pegasys.teku.util.events.Subscribers;\n+\n+public class Eth1HeadTracker {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final AtomicBoolean running = new AtomicBoolean(false);\n+  private final AsyncRunner asyncRunner;\n+  private final Eth1Provider eth1Provider;\n+  private Optional<UnsignedLong> headAtFollowDistance = Optional.empty();\n+\n+  private final Subscribers<HeadUpdatedSubscriber> subscribers = Subscribers.create(true);\n+\n+  public Eth1HeadTracker(final AsyncRunner asyncRunner, final Eth1Provider eth1Provider) {\n+    this.asyncRunner = asyncRunner;\n+    this.eth1Provider = eth1Provider;\n+  }\n+\n+  public void start() {\n+    if (!running.compareAndSet(false, true)) {\n+      return;\n+    }\n+    pollLatestHead();\n+  }\n+\n+  private void pollLatestHead() {\n+    if (!running.get()) {\n+      return;\n+    }\n+    eth1Provider\n+        .getLatestEth1Block()\n+        .thenAccept(this::onLatestBlockHead)\n+        .exceptionally(\n+            error -> {\n+              LOG.warn(\"Failed to get latest ETH1 chain head. Will retry.\", error);\n+              return null;\n+            })\n+        .always(\n+            () ->\n+                asyncRunner\n+                    .runAfterDelay(\n+                        this::pollLatestHead,\n+                        Constants.SECONDS_PER_ETH1_BLOCK.longValue(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg4MTE2OQ=="}, "originalCommit": {"oid": "7ae3f49449ed3e07c1aaa8eef95d34966d2bb229"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4OTk3NjgyOnYy", "diffSide": "RIGHT", "path": "pow/src/main/java/tech/pegasys/teku/pow/Eth1Provider.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDozNDowNFrOGb4GbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMDo0ODo0MVrOGcGLdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg4Mzg4NQ==", "bodyText": "nit: to keep the method names in line, you might want to either add Future to the end of this method name or remove all the Futures from the method names above.", "url": "https://github.com/ConsenSys/teku/pull/1990#discussion_r431883885", "createdAt": "2020-05-28T14:34:04Z", "author": {"login": "cemozerr"}, "path": "pow/src/main/java/tech/pegasys/teku/pow/Eth1Provider.java", "diffHunk": "@@ -31,7 +28,7 @@\n \n   SafeFuture<Block> getGuaranteedEth1BlockFuture(UnsignedLong blockNumber);\n \n-  SafeFuture<Block> getLatestEth1BlockFuture();\n+  SafeFuture<Block> getLatestEth1Block();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ae3f49449ed3e07c1aaa8eef95d34966d2bb229"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExNDU1MA==", "bodyText": "I had meant to remove future from them all but forgot to do a full pass will fix.", "url": "https://github.com/ConsenSys/teku/pull/1990#discussion_r432114550", "createdAt": "2020-05-28T20:48:41Z", "author": {"login": "ajsutton"}, "path": "pow/src/main/java/tech/pegasys/teku/pow/Eth1Provider.java", "diffHunk": "@@ -31,7 +28,7 @@\n \n   SafeFuture<Block> getGuaranteedEth1BlockFuture(UnsignedLong blockNumber);\n \n-  SafeFuture<Block> getLatestEth1BlockFuture();\n+  SafeFuture<Block> getLatestEth1Block();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg4Mzg4NQ=="}, "originalCommit": {"oid": "7ae3f49449ed3e07c1aaa8eef95d34966d2bb229"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3677, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}