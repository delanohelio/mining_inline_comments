{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMjk2NjM2", "number": 3349, "title": "[Issue 3337] Be more tolerant of missing eth1 blocks", "bodyText": "PR Description\nBe more tolerant of missing eth1 blocks.  Some eth1 clients can be configured to avoid downloading full historical blocks and receipts.  Update MinimumGenesisTimeBlockFinder's binary search to ignore unavailable block ranges, and add extra logic to confirm the min genesis block that is retrieved.  Also add retries for eth1 block requests.\nFixed Issue(s)\nPart of #3337\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-12-02T21:20:52Z", "url": "https://github.com/ConsenSys/teku/pull/3349", "merged": true, "mergeCommit": {"oid": "0e3cc8bfff559fe5b92ce21da39b6518d7b67f9b"}, "closed": true, "closedAt": "2020-12-03T23:12:51Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiVOfvAH2gAyNTMxMjk2NjM2OjVjZmJhOTBmMDY4YTBlYWZhNmQ5ZDhjYjFmZmQyMDg5ZjEyM2ExMDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdirS9MgH2gAyNTMxMjk2NjM2OjliMGRlYzgwNTFkYmU5ZTNhMzI5OTY4ZGRhZjRmYWJmMzRhNzcwYjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5cfba90f068a0eafa6d9d8cb1ffd2089f123a103", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/5cfba90f068a0eafa6d9d8cb1ffd2089f123a103", "committedDate": "2020-12-02T21:14:30Z", "message": "Start updating Eth1Provider block API's to return Optional's"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26a956cf929a8b79d2520227e89e1b2287ffc65a", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/26a956cf929a8b79d2520227e89e1b2287ffc65a", "committedDate": "2020-12-02T21:14:30Z", "message": "Add retry utility for retrying futures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d19eb8aba6ddfeea3772460cfdb2e0925e8f4e85", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/d19eb8aba6ddfeea3772460cfdb2e0925e8f4e85", "committedDate": "2020-12-02T21:14:30Z", "message": "Make MinimumGenesisTimeBlockFinder more tolerant of missing blocks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca6d63d5d68ee64779b86beb9f29f6e354a3f938", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/ca6d63d5d68ee64779b86beb9f29f6e354a3f938", "committedDate": "2020-12-02T22:21:38Z", "message": "Simplify minimal block check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33207f34ad05c2472d46b35184afa40c11cbf7a2", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/33207f34ad05c2472d46b35184afa40c11cbf7a2", "committedDate": "2020-12-02T22:37:29Z", "message": "Add logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6f30d92fdbb586abd6786b99ba27a8174ed9248", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/a6f30d92fdbb586abd6786b99ba27a8174ed9248", "committedDate": "2020-12-02T23:01:47Z", "message": "Clean up comments, logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f375b72eee8da34ce3a3b174cf6bcb1cb194938e", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f375b72eee8da34ce3a3b174cf6bcb1cb194938e", "committedDate": "2020-12-02T23:01:56Z", "message": "Clean up tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMzEzMjky", "url": "https://github.com/ConsenSys/teku/pull/3349#pullrequestreview-543313292", "createdAt": "2020-12-02T23:07:00Z", "commit": {"oid": "f375b72eee8da34ce3a3b174cf6bcb1cb194938e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMzowNzowMFrOH9x6fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMzowNzowMFrOH9x6fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU0Mjk3NQ==", "bodyText": "This is the approach we talked about using - but I'm not sure it actually makes a lot of sense to search one by one through the ancestors.  I suppose it's possible that some historical blocks were filled in as the binary search runs, but it's also possible we spend a lot of time walking back through ancestors and don't find our target block.\nThoughts?", "url": "https://github.com/ConsenSys/teku/pull/3349#discussion_r534542975", "createdAt": "2020-12-02T23:07:00Z", "author": {"login": "mbaxter"}, "path": "pow/src/main/java/tech/pegasys/teku/pow/MinimumGenesisTimeBlockFinder.java", "diffHunk": "@@ -52,7 +60,93 @@ public MinimumGenesisTimeBlockFinder(\n   public SafeFuture<EthBlock.Block> findMinGenesisTimeBlockInHistory(\n       final BigInteger headBlockNumber) {\n     return binarySearchLoop(\n-        new SearchContext(eth1DepositContractDeployBlock.orElse(ZERO), headBlockNumber));\n+            new SearchContext(eth1DepositContractDeployBlock.orElse(ZERO), headBlockNumber))\n+        .thenCompose(this::confirmOrFindMinGenesisBlock);\n+  }\n+\n+  /**\n+   * The binary search may return a block that is too new (if historical blocks are unavailable\n+   * during the search), so walk back though chain to confirm or else pull the correct min genesis\n+   * block.\n+   *\n+   * @param candidateMinGenesisBlock A candidate block that may be the min genesis block\n+   * @return The confirmed min genesis block\n+   */\n+  @VisibleForTesting\n+  SafeFuture<EthBlock.Block> confirmOrFindMinGenesisBlock(\n+      final EthBlock.Block candidateMinGenesisBlock) {\n+    assertBlockIsAtOrAfterMinGenesis(candidateMinGenesisBlock);\n+    if (blockIsAtMinimalMinGenesisPosition(candidateMinGenesisBlock)) {\n+      // We've found min genesis\n+      traceWithBlock(\n+          \"Confirmed minimum genesis block at minimal position: \", candidateMinGenesisBlock);\n+      return SafeFuture.completedFuture(candidateMinGenesisBlock);\n+    }\n+\n+    traceWithBlock(\n+        \"Confirm minimum genesis block retrieved via binary search: \", candidateMinGenesisBlock);\n+    final SafeFuture<EthBlock.Block> minGenesisFuture = new SafeFuture<>();\n+\n+    final AtomicReference<EthBlock.Block> currentMinGenesisCandidate =\n+        new AtomicReference<>(candidateMinGenesisBlock);\n+    final AtomicInteger examinedAncestorsCount = new AtomicInteger(0);\n+    SafeFuture.asyncDoWhile(\n+            () ->\n+                eth1Provider\n+                    .getEth1BlockWithRetry(\n+                        currentMinGenesisCandidate.get().getParentHash(), Duration.ofSeconds(5), 3)\n+                    .thenApply(\n+                        parent -> {\n+                          examinedAncestorsCount.incrementAndGet();\n+                          if (blockIsPriorToMinGenesis(parent)) {\n+                            // We've confirmed the current candidate is at the boundary\n+                            traceWithBlock(\n+                                \"Confirmed min genesis block: \", currentMinGenesisCandidate.get());\n+                            minGenesisFuture.complete(currentMinGenesisCandidate.get());\n+                            return false;\n+                          } else if (blockIsAtMinGenesis(parent)) {\n+                            // We've found the min genesis block\n+                            traceWithBlock(\n+                                \"Confirmed min genesis block at exact genesis time: \", parent);\n+                            minGenesisFuture.complete(parent);\n+                            return false;\n+                          } else {\n+                            // The parent block is after min genesis\n+                            // Keep searching through ancestors up to our limit", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f375b72eee8da34ce3a3b174cf6bcb1cb194938e"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "763d65a35db4f77048fa2799aab2df247a2cbd6b", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/763d65a35db4f77048fa2799aab2df247a2cbd6b", "committedDate": "2020-12-03T16:27:19Z", "message": "Return an Optional from getEth1BlockWithRetry\n\nThere's probably no point retrying if the block isn't available."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db4cf8dd0dd6b4c3cbf7fde9aa13f9baa4957c1e", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/db4cf8dd0dd6b4c3cbf7fde9aa13f9baa4957c1e", "committedDate": "2020-12-03T17:13:05Z", "message": "Simplify min genesis block confirmation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5578adffad318d27bb4b325329ff3d77cf51fa4a", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/5578adffad318d27bb4b325329ff3d77cf51fa4a", "committedDate": "2020-12-03T17:50:05Z", "message": "Add retries to remaining MinGenesisTimeBlockFinder requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50bcf533d1940fd70e284a585566ddd8b84a484c", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/50bcf533d1940fd70e284a585566ddd8b84a484c", "committedDate": "2020-12-03T18:03:52Z", "message": "Tweak error, add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c17da2a561c5cdee9c49c27c6a12fec82fd3f3d0", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c17da2a561c5cdee9c49c27c6a12fec82fd3f3d0", "committedDate": "2020-12-03T18:47:03Z", "message": "Update stale comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NDU3ODA2", "url": "https://github.com/ConsenSys/teku/pull/3349#pullrequestreview-544457806", "createdAt": "2020-12-03T21:19:51Z", "commit": {"oid": "c17da2a561c5cdee9c49c27c6a12fec82fd3f3d0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b0dec8051dbe9e3a329968ddaf4fabf34a770b8", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/9b0dec8051dbe9e3a329968ddaf4fabf34a770b8", "committedDate": "2020-12-03T22:57:17Z", "message": "Merge branch 'master' into issue-3337/be-more-tolerant-of-missing-eth1-blocks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4338, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}