{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExNzY2MzAw", "number": 3106, "title": "Move all object validation to state transition package", "bodyText": "PR Description\nMove all object validation to state transition package.\nTwo things to make sure (for myself):\n\nCheck if the removed markGossiped call matters. DONE - it doesn't\nCheck if addSeenAggregate TODO is important. DONE\n\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-10-28T18:51:28Z", "url": "https://github.com/ConsenSys/teku/pull/3106", "merged": true, "mergeCommit": {"oid": "eb9ee281e7412f24cb864352fcd813a7e5e05944"}, "closed": true, "closedAt": "2020-10-30T18:15:12Z", "author": {"login": "cemozerr"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXCPcFAH2gAyNTExNzY2MzAwOmE3NGYyZWQ4OGY5NThhZWVkYjI1NzVlYjc1NjU3ZGQ4ZjNhMmRjNjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXqoIAAH2gAyNTExNzY2MzAwOjFmNDA2M2IyOTZkNmI2MDFhYjBhMzQxNmVjMzg1MmExNzU3ZjE0Mjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a74f2ed88f958aeedb2575eb75657dd8f3a2dc62", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/a74f2ed88f958aeedb2575eb75657dd8f3a2dc62", "committedDate": "2020-10-28T18:54:10Z", "message": "Move validation to state transition package level"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "237623451e6a0ba36ca3b28a36c45037d158b3d2", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/237623451e6a0ba36ca3b28a36c45037d158b3d2", "committedDate": "2020-10-28T18:54:16Z", "message": "Remove individual topic handler classes and fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "580461385e65c7e1f47ab5c5b134c288b5941fdf", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/580461385e65c7e1f47ab5c5b134c288b5941fdf", "committedDate": "2020-10-28T18:54:16Z", "message": "Run spotless"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9744c08ef47e4ee820f92653a0834c2a266e3ce5", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/9744c08ef47e4ee820f92653a0834c2a266e3ce5", "committedDate": "2020-10-28T18:50:52Z", "message": "Run spotless"}, "afterCommit": {"oid": "580461385e65c7e1f47ab5c5b134c288b5941fdf", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/580461385e65c7e1f47ab5c5b134c288b5941fdf", "committedDate": "2020-10-28T18:54:16Z", "message": "Run spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcb11097c1786bd94be63eb830b3323c679084f5", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/dcb11097c1786bd94be63eb830b3323c679084f5", "committedDate": "2020-10-28T19:52:47Z", "message": "Fix warning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1379d76f6aaeb0b4888c3db6d41bb1ee3335722", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/b1379d76f6aaeb0b4888c3db6d41bb1ee3335722", "committedDate": "2020-10-28T19:55:25Z", "message": "Run spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c39c1c6a87a10d01ad63931aa92353a9b2be00c5", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/c39c1c6a87a10d01ad63931aa92353a9b2be00c5", "committedDate": "2020-10-28T19:58:48Z", "message": "Fix warning again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86bc37cce035b5072f2f7e7d38168eb39420c729", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/86bc37cce035b5072f2f7e7d38168eb39420c729", "committedDate": "2020-10-28T20:01:56Z", "message": "Fix warning again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b54ecebf9f306802cefe11fda11b426bb2052a12", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/b54ecebf9f306802cefe11fda11b426bb2052a12", "committedDate": "2020-10-28T20:07:49Z", "message": "Fix warning again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57b7e86b24de08ab13fa6c769b9a788a7a9261cf", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/57b7e86b24de08ab13fa6c769b9a788a7a9261cf", "committedDate": "2020-10-28T20:10:45Z", "message": "Fix warning again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a81d3159efd30659bc393880845433e92faa9457", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/a81d3159efd30659bc393880845433e92faa9457", "committedDate": "2020-10-28T21:18:56Z", "message": "Fix test bug and only run ssz_snappy tests not ssz"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8b3c3e45f4460e8a01c2c28bb8a3aee6684edcf", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/c8b3c3e45f4460e8a01c2c28bb8a3aee6684edcf", "committedDate": "2020-10-28T21:22:34Z", "message": "Run spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MjE5Mzky", "url": "https://github.com/ConsenSys/teku/pull/3106#pullrequestreview-519219392", "createdAt": "2020-10-29T00:34:24Z", "commit": {"oid": "c8b3c3e45f4460e8a01c2c28bb8a3aee6684edcf"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwMDozNDoyNFrOHqCYXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwMDo0Njo1OFrOHqCl6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0MTI0NA==", "bodyText": "If we already know the attestation should be saved for future, do we need to run it through the attestation processor or can it just be added to the pending pool immediately?", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r513841244", "createdAt": "2020-10-29T00:34:24Z", "author": {"login": "ajsutton"}, "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AttestationManager.java", "diffHunk": "@@ -49,38 +52,80 @@\n   private final Subscribers<ProcessedAttestationListener> processedAttestationSubscriber =\n       Subscribers.create(true);\n \n+  private final AttestationValidator attestationValidator;\n+  private final AggregateAttestationValidator aggregateValidator;\n+\n   AttestationManager(\n       final EventBus eventBus,\n       final ForkChoice attestationProcessor,\n       final PendingPool<ValidateableAttestation> pendingAttestations,\n       final FutureItems<ValidateableAttestation> futureAttestations,\n-      final AggregatingAttestationPool aggregatingAttestationPool) {\n+      final AggregatingAttestationPool aggregatingAttestationPool,\n+      final AttestationValidator attestationValidator,\n+      final AggregateAttestationValidator aggregateValidator) {\n     this.eventBus = eventBus;\n     this.attestationProcessor = attestationProcessor;\n     this.pendingAttestations = pendingAttestations;\n     this.futureAttestations = futureAttestations;\n     this.aggregatingAttestationPool = aggregatingAttestationPool;\n+    this.attestationValidator = attestationValidator;\n+    this.aggregateValidator = aggregateValidator;\n   }\n \n   public static AttestationManager create(\n       final EventBus eventBus,\n       final PendingPool<ValidateableAttestation> pendingAttestations,\n       final FutureItems<ValidateableAttestation> futureAttestations,\n       final ForkChoice attestationProcessor,\n-      final AggregatingAttestationPool aggregatingAttestationPool) {\n+      final AggregatingAttestationPool aggregatingAttestationPool,\n+      final AttestationValidator attestationValidator,\n+      final AggregateAttestationValidator aggregateValidator) {\n     return new AttestationManager(\n         eventBus,\n         attestationProcessor,\n         pendingAttestations,\n         futureAttestations,\n-        aggregatingAttestationPool);\n+        aggregatingAttestationPool,\n+        attestationValidator,\n+        aggregateValidator);\n   }\n \n   public void subscribeToProcessedAttestations(\n       ProcessedAttestationListener processedAttestationListener) {\n     processedAttestationSubscriber.subscribe(processedAttestationListener);\n   }\n \n+  public SafeFuture<InternalValidationResult> addAttestation(ValidateableAttestation attestation) {\n+    SafeFuture<InternalValidationResult> validationResult =\n+        attestationValidator.validate(attestation);\n+    processInternallyValidatedAttestation(validationResult, attestation);\n+    return validationResult;\n+  }\n+\n+  public SafeFuture<InternalValidationResult> addAggregate(ValidateableAttestation attestation) {\n+    SafeFuture<InternalValidationResult> validationResult =\n+        aggregateValidator.validate(attestation);\n+    processInternallyValidatedAttestation(validationResult, attestation);\n+    return validationResult;\n+  }\n+\n+  @SuppressWarnings(\"FutureReturnValueIgnored\")\n+  private void processInternallyValidatedAttestation(\n+      SafeFuture<InternalValidationResult> validationResult, ValidateableAttestation attestation) {\n+    validationResult.thenAccept(\n+        internalValidationResult -> {\n+          if (internalValidationResult.equals(InternalValidationResult.ACCEPT)\n+              || internalValidationResult.equals(InternalValidationResult.SAVE_FOR_FUTURE)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8b3c3e45f4460e8a01c2c28bb8a3aee6684edcf"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0MTQ4MA==", "bodyText": "Same as for attestations - if it's save for future should we just add it to the pending pool without further processing?", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r513841480", "createdAt": "2020-10-29T00:35:12Z", "author": {"login": "ajsutton"}, "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/block/BlockManager.java", "diffHunk": "@@ -91,6 +98,20 @@ public static BlockManager create(\n     return doImportBlock(block);\n   }\n \n+  @SuppressWarnings(\"FutureReturnValueIgnored\")\n+  public SafeFuture<InternalValidationResult> validateAndImportBlock(\n+      final SignedBeaconBlock block) {\n+    SafeFuture<InternalValidationResult> validationResult = validator.validate(block);\n+    validationResult.thenAccept(\n+        result -> {\n+          if (result.equals(InternalValidationResult.ACCEPT)\n+              || result.equals(InternalValidationResult.SAVE_FOR_FUTURE)) {\n+            importBlock(block).finish(err -> LOG.error(\"Failed to process received block.\", err));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8b3c3e45f4460e8a01c2c28bb8a3aee6684edcf"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0MTgxMA==", "bodyText": "Why did we switch from OptionalInt to Optional<Integer>?  OptionalInt is probably better if it's possible to stick with it.", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r513841810", "createdAt": "2020-10-29T00:36:30Z", "author": {"login": "ajsutton"}, "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/validation/AttestationValidator.java", "diffHunk": "@@ -113,7 +112,8 @@ private InternalValidationResult singleAttestationChecks(final Attestation attes\n   }\n \n   SafeFuture<InternalValidationResult> singleOrAggregateAttestationChecks(\n-      final ValidateableAttestation validateableAttestation, final OptionalInt receivedOnSubnetId) {\n+      final ValidateableAttestation validateableAttestation,\n+      final Optional<Integer> receivedOnSubnetId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8b3c3e45f4460e8a01c2c28bb8a3aee6684edcf"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0MzI1MQ==", "bodyText": "Probably shouldn't make this change as part of this PR.", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r513843251", "createdAt": "2020-10-29T00:41:38Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/integration-test/java/tech/pegasys/teku/networking/eth2/GossipMessageHandlerIntegrationTest.java", "diffHunk": "@@ -341,7 +368,7 @@ private NodeManager createNodeManager(final Consumer<Eth2P2PNetworkBuilder> netw\n   }\n \n   public static Stream<Arguments> getEncodings() {\n-    final List<GossipEncoding> encodings = List.of(GossipEncoding.SSZ, GossipEncoding.SSZ_SNAPPY);\n+    final List<GossipEncoding> encodings = List.of(GossipEncoding.SSZ_SNAPPY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8b3c3e45f4460e8a01c2c28bb8a3aee6684edcf"}, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0NDExOQ==", "bodyText": "I don't think we can afford to leave this TODO undone as we'd wind up validating more aggregates than we need to.", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r513844119", "createdAt": "2020-10-29T00:44:49Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/AggregateGossipManager.java", "diffHunk": "@@ -53,7 +51,8 @@ public void onNewAggregate(final ValidateableAttestation validateableAttestation\n     if (!validateableAttestation.isAggregate() || !validateableAttestation.markGossiped()) {\n       return;\n     }\n-    validator.addSeenAggregate(validateableAttestation);\n+    // TODO: implement adding the on new aggregate to the validator\n+    //    validator.addSeenAggregate(validateableAttestation);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8b3c3e45f4460e8a01c2c28bb8a3aee6684edcf"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0NDcxMg==", "bodyText": "Probably should be an IllegalArgumentException.", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r513844712", "createdAt": "2020-10-29T00:46:58Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/GossipSubValidationUtil.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.networking.eth2.gossip.topics;\n+\n+import io.libp2p.core.pubsub.ValidationResult;\n+import tech.pegasys.teku.statetransition.validation.InternalValidationResult;\n+\n+public class GossipSubValidationUtil {\n+\n+  public static ValidationResult fromInternalValidationResult(InternalValidationResult result) {\n+    switch (result) {\n+      case ACCEPT:\n+        return ValidationResult.Valid;\n+      case SAVE_FOR_FUTURE:\n+      case IGNORE:\n+        return ValidationResult.Ignore;\n+      case REJECT:\n+        return ValidationResult.Invalid;\n+      default:\n+        throw new UnsupportedOperationException(\"Unexpected validation result: \" + result);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8b3c3e45f4460e8a01c2c28bb8a3aee6684edcf"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40310479629c88204bfc194aebc78812748d27b8", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/40310479629c88204bfc194aebc78812748d27b8", "committedDate": "2020-10-29T17:39:07Z", "message": "Reverse test encodings and optionalInt changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b56606fb1592146d53b9d9257f34d19ca372964", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/7b56606fb1592146d53b9d9257f34d19ca372964", "committedDate": "2020-10-29T17:40:43Z", "message": "Fix optional int change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0fd252913f13bf1abd355ef39156891b9119c2d", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/e0fd252913f13bf1abd355ef39156891b9119c2d", "committedDate": "2020-10-29T18:23:55Z", "message": "Don't process locally produced attetations twice"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6e0200d3ce42076584b5dbe2d7528bf8812e979", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/c6e0200d3ce42076584b5dbe2d7528bf8812e979", "committedDate": "2020-10-29T19:18:10Z", "message": "Merge branch 'master' into moveAllObjectValidationToStateTransitionPackage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b2a8779d06c8c7589ece22d735f41a3a17ddb1e", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/9b2a8779d06c8c7589ece22d735f41a3a17ddb1e", "committedDate": "2020-10-29T19:56:14Z", "message": "Send validator attestations as quickly as possible and only gossip network attestations once"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ace641ef6a2d3584b88b8245ebc5fab0b2f34f5", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/7ace641ef6a2d3584b88b8245ebc5fab0b2f34f5", "committedDate": "2020-10-29T20:09:01Z", "message": "Revert \"Send validator attestations as quickly as possible and only gossip network attestations once\"\n\nThis reverts commit 9b2a8779d06c8c7589ece22d735f41a3a17ddb1e."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6509a801a51a5c815e3b887111f82f07e4f6928", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/e6509a801a51a5c815e3b887111f82f07e4f6928", "committedDate": "2020-10-29T20:51:52Z", "message": "Only gossip network attestations once"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4146beabe012d633969c81dac4cd9c610ee007ef", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/4146beabe012d633969c81dac4cd9c610ee007ef", "committedDate": "2020-10-29T21:15:29Z", "message": "Run spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6aa2265478c6be8efecefaad2e1f5f0376f8bfc8", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/6aa2265478c6be8efecefaad2e1f5f0376f8bfc8", "committedDate": "2020-10-29T21:23:35Z", "message": "Add missing break"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMTQzMzA3", "url": "https://github.com/ConsenSys/teku/pull/3106#pullrequestreview-520143307", "createdAt": "2020-10-29T22:50:45Z", "commit": {"oid": "6aa2265478c6be8efecefaad2e1f5f0376f8bfc8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f4063b296d6b601ab0a3416ec3852a1757f1429", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/1f4063b296d6b601ab0a3416ec3852a1757f1429", "committedDate": "2020-10-30T17:57:20Z", "message": "Merge remote-tracking branch 'remotes/origin/master' into moveAllObjectValidationToStateTransitionPackage\n\n# Conflicts:\n#\tnetworking/eth2/src/testFixtures/java/tech/pegasys/teku/networking/eth2/Eth2NetworkFactory.java"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3283, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}