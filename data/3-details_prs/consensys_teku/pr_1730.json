{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0Mjc4NDY5", "number": 1730, "title": "[BC-413] Fix queries for latest forkInfo", "bodyText": "PR Description\nStore \"best block\" / chainhead info in an atomic datastructure, preventing race conditions.\nThis PR fixes errors related to retrieving the most recent ForkInfo (see error below).  It appears these errors are the result of a race condition where:  we pull the latest head root and then look up the corresponding state.  If the corresponding state is pruned before we can look it up, we'll throw an error on failure to retrieve this state:\n2020-05-05 17:54:48.022-04:00 | ForkJoinPool.commonPool-worker-11 | ERROR | Eth2IncomingRequestHandler | Unhandled error while processing request /eth2/beacon_chain/req/status/1/ssz_snappy\njava.util.NoSuchElementException: No value present\n\tat java.util.Optional.orElseThrow(Optional.java:382) ~[?:?]\n\tat tech.pegasys.teku.networking.eth2.rpc.beaconchain.methods.StatusMessageFactory.createStatusMessage(StatusMessageFactory.java:40) ~[classes/:?]\n\tat tech.pegasys.teku.networking.eth2.rpc.beaconchain.methods.StatusMessageHandler.onIncomingMessage(StatusMessageHandler.java:40) ~[classes/:?]\n\tat tech.pegasys.teku.networking.eth2.rpc.beaconchain.methods.StatusMessageHandler.onIncomingMessage(StatusMessageHandler.java:24) ~[classes/:?]\n\tat tech.pegasys.teku.networking.eth2.rpc.core.Eth2IncomingRequestHandler.handleRequest(Eth2IncomingRequestHandler.java:80) ~[classes/:?]\n\tat tech.pegasys.teku.networking.eth2.rpc.core.Eth2IncomingRequestHandler.processInput(Eth2IncomingRequestHandler.java:69) ~[classes/:?]\n\tat tech.pegasys.teku.networking.p2p.libp2p.rpc.RpcHandler$Controller.lambda$setRequestHandler$0(RpcHandler.java:206) ~[classes/:?]\n\tat tech.pegasys.teku.util.async.SafeFuture.fromRunnable(SafeFuture.java:106) ~[classes/:?]\n\tat tech.pegasys.teku.util.async.AsyncRunner.lambda$runAsync$0(AsyncRunner.java:22) ~[classes/:?]\n\tat tech.pegasys.teku.util.async.DelayedExecutorAsyncRunner.lambda$runAsync$1(DelayedExecutorAsyncRunner.java:57) ~[classes/:?]\n\tat java.util.concurrent.ForkJoinTask$RunnableExecuteAction.exec(ForkJoinTask.java:1426) [?:?]\n\tat java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:290) [?:?]\n\tat java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1020) [?:?]\n\tat java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1656) [?:?]\n\tat java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1594) [?:?]\n\tat java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:177) [?:?]", "createdAt": "2020-05-06T19:04:59Z", "url": "https://github.com/ConsenSys/teku/pull/1730", "merged": true, "mergeCommit": {"oid": "76dffe2c4c4581fb5cd6b885c2d0fd2e64a23d0b"}, "closed": true, "closedAt": "2020-05-07T15:27:53Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceta9TgH2gAyNDE0Mjc4NDY5OmMyNWVjNzJiYmExOTU4OTllN2E1YjUxODRlNDQ2ZjRkMDZjMTA2YWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABce-0viAH2gAyNDE0Mjc4NDY5OmNiNzg3Yzc4YWQ0YzFjZmJiZmEwYmI5MzY4N2ZmZjU5ZGY5YzU3Yjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c25ec72bba195899e7a5b5184e446f4d06c106ab", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c25ec72bba195899e7a5b5184e446f4d06c106ab", "committedDate": "2020-05-06T18:58:59Z", "message": "Store bestBlock info in atomic datastructure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2OTgwNjMw", "url": "https://github.com/ConsenSys/teku/pull/1730#pullrequestreview-406980630", "createdAt": "2020-05-06T20:56:59Z", "commit": {"oid": "c25ec72bba195899e7a5b5184e446f4d06c106ab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMDo1NzowMFrOGRlHIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMDo1NzowMFrOGRlHIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA4NzAxMQ==", "bodyText": "Should we return here rather than ploughing on into a NullPointerException?", "url": "https://github.com/ConsenSys/teku/pull/1730#discussion_r421087011", "createdAt": "2020-05-06T20:57:00Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/client/RecentChainData.java", "diffHunk": "@@ -133,17 +131,31 @@ public Store getStore() {\n    * @param slot\n    */\n   public void updateBestBlock(Bytes32 root, UnsignedLong slot) {\n-    final Optional<Bytes32> originalBestRoot = bestBlockRoot;\n-    final UnsignedLong originalBestSlot = bestSlot;\n-    this.bestBlockRoot = Optional.of(root);\n-    this.bestSlot = slot;\n-    bestBlockInitialized.complete(null);\n-\n-    if (originalBestRoot\n-        .map(original -> hasReorgedFrom(original, originalBestSlot))\n-        .orElse(false)) {\n-      reorgEventChannel.reorgOccurred(root, bestSlot);\n+    synchronized (this) {\n+      final SignedBeaconBlock newBestBlock = store.getSignedBlock(root);\n+      final BeaconState newBestState = store.getBlockState(root);\n+      if (newBestBlock == null || newBestState == null) {\n+        LOG.warn(\n+            \"Unable to update best block (slot={}, root={}). Corresponding {} unavailable\",\n+            slot,\n+            root,\n+            newBestBlock == null ? \"block\" : \"state\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c25ec72bba195899e7a5b5184e446f4d06c106ab"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2OTg3Nzgz", "url": "https://github.com/ConsenSys/teku/pull/1730#pullrequestreview-406987783", "createdAt": "2020-05-06T21:07:36Z", "commit": {"oid": "c25ec72bba195899e7a5b5184e446f4d06c106ab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMTowNzozN1rOGRlecA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMTowNzozN1rOGRlecA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA5Mjk3Ng==", "bodyText": "nit: it might be nicer to use this\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void updateBestBlock(Bytes32 root, UnsignedLong slot) {\n          \n          \n            \n              public synchronized void updateBestBlock(Bytes32 root, UnsignedLong slot) {", "url": "https://github.com/ConsenSys/teku/pull/1730#discussion_r421092976", "createdAt": "2020-05-06T21:07:37Z", "author": {"login": "cemozerr"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/client/RecentChainData.java", "diffHunk": "@@ -133,17 +131,31 @@ public Store getStore() {\n    * @param slot\n    */\n   public void updateBestBlock(Bytes32 root, UnsignedLong slot) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c25ec72bba195899e7a5b5184e446f4d06c106ab"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "288ac5876734f9fdba72331c5f7af3347a1b5383", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/288ac5876734f9fdba72331c5f7af3347a1b5383", "committedDate": "2020-05-06T22:35:18Z", "message": "Rework RecentChainDataTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "056fd0fa08cf15bfe2e538de3e4cd1c30ba4c179", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/056fd0fa08cf15bfe2e538de3e4cd1c30ba4c179", "committedDate": "2020-05-06T22:42:19Z", "message": "Fix short-circuit logic, add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77651e3fa41367ae0a7faba022e0e2810f8f3a05", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/77651e3fa41367ae0a7faba022e0e2810f8f3a05", "committedDate": "2020-05-06T22:45:32Z", "message": "Merge branch 'master' into bc-413/fix-head-state-queries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3MDg1OTUy", "url": "https://github.com/ConsenSys/teku/pull/1730#pullrequestreview-407085952", "createdAt": "2020-05-07T01:05:40Z", "commit": {"oid": "77651e3fa41367ae0a7faba022e0e2810f8f3a05"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8fa2d7df549674233826d72282a286e9a7f9071", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/e8fa2d7df549674233826d72282a286e9a7f9071", "committedDate": "2020-05-07T15:14:24Z", "message": "Fix metrics tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb787c78ad4c1cfbbfa0bb93687fff59df9c57b8", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/cb787c78ad4c1cfbbfa0bb93687fff59df9c57b8", "committedDate": "2020-05-07T15:15:32Z", "message": "Merge branch 'master' into bc-413/fix-head-state-queries"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4172, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}