{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzMDQwMDUw", "number": 2389, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwNDo0OToxNlrOEP9MeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNDoyNjoxOVrOEQ4lkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MTY2NzEyOnYy", "diffSide": "RIGHT", "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/forkchoice/MutableStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwNDo0OToxNlrOGz37hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwNDo0OToxNlrOGz37hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA0NjkxOQ==", "bodyText": "nit: Probably not the most accurate name.  Maybe just putStateRoot?", "url": "https://github.com/ConsenSys/teku/pull/2389#discussion_r457046919", "createdAt": "2020-07-20T04:49:16Z", "author": {"login": "ajsutton"}, "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/forkchoice/MutableStore.java", "diffHunk": "@@ -27,6 +29,8 @@ default void putBlockAndState(SignedBlockAndState blockAndState) {\n     putBlockAndState(blockAndState.getBlock(), blockAndState.getState());\n   }\n \n+  void putStateRootToBlockRoot(Bytes32 stateRoot, SlotAndBlockRoot slotAndBlockRoot);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b352a5b91178edf930d1cb3cc08076dd21b53bb"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MTY3MzUyOnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/teku/storage/client/CombinedChainDataClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwNDo1MToyNlrOGz3_FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwNDo1MToyNlrOGz3_FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA0NzgyOA==", "bodyText": "nit: inline variable.", "url": "https://github.com/ConsenSys/teku/pull/2389#discussion_r457047828", "createdAt": "2020-07-20T04:51:26Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/client/CombinedChainDataClient.java", "diffHunk": "@@ -187,6 +202,45 @@ public boolean isFinalizedEpoch(final UnsignedLong epoch) {\n     return historicalChainData.getFinalizedStateByBlockRoot(blockRoot);\n   }\n \n+  public SafeFuture<Optional<BeaconState>> getStateByStateRoot(final Bytes32 stateRoot) {\n+    final UpdatableStore store = getStore();\n+    if (store == null) {\n+      LOG.trace(\"No state at stateRoot {} because the store is not set\", stateRoot);\n+      return STATE_NOT_AVAILABLE;\n+    }\n+    return historicalChainData\n+        .getSlotAndBlockRootByStateRoot(stateRoot)\n+        .thenCompose(\n+            maybeSlotAndBlockRoot -> {\n+              if (maybeSlotAndBlockRoot.isEmpty()) {\n+                return STATE_NOT_AVAILABLE;\n+              }\n+              return getStateFromSlotAndBlock(maybeSlotAndBlockRoot.get());\n+            });\n+  }\n+\n+  private SafeFuture<Optional<BeaconState>> getStateFromSlotAndBlock(\n+      final SlotAndBlockRoot slotAndBlockRoot) {\n+    return getStateByBlockRoot(slotAndBlockRoot.getBlockRoot())\n+        .thenApply(\n+            maybeState ->\n+                maybeState.map(\n+                    preState -> regenerateBeaconState(preState, slotAndBlockRoot.getSlot())));\n+  }\n+\n+  private BeaconState regenerateBeaconState(final BeaconState preState, final UnsignedLong slot) {\n+    if (preState.getSlot().equals(slot)) {\n+      return preState;\n+    }\n+    try {\n+      final BeaconState desiredState = stateTransition.process_slots(preState, slot);\n+      return desiredState;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b352a5b91178edf930d1cb3cc08076dd21b53bb"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MTY5MDk4OnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/teku/storage/events/StorageUpdate.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwNDo1NjoyN1rOGz4IDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMzo0MDozOFrOG1RjHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA1MDEyNQ==", "bodyText": "We should probably either name this to be clear that it only contains state roots for empty slots or update StateTransition to also put the state root after each processed block. I kind of like the idea of StateTransition putting all states and then you can avoid iterating through the hot blocks in RocksDbDatabase to record their state roots.  Either way is fine though - not sure if there are potential issues with doing it in StateTransition.", "url": "https://github.com/ConsenSys/teku/pull/2389#discussion_r457050125", "createdAt": "2020-07-20T04:56:27Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/events/StorageUpdate.java", "diffHunk": "@@ -106,4 +110,8 @@ public boolean isEmpty() {\n   public Map<UnsignedLong, VoteTracker> getVotes() {\n     return votes;\n   }\n+\n+  public Map<Bytes32, SlotAndBlockRoot> getStateRootsToBlockRoots() {\n+    return stateRootsToBlockRoots;\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b352a5b91178edf930d1cb3cc08076dd21b53bb"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUxNTIyOQ==", "bodyText": "its now called stateRoots and everything that's putting into the hot storage is putting into that list, so hopefully i've resolved this comment.", "url": "https://github.com/ConsenSys/teku/pull/2389#discussion_r458515229", "createdAt": "2020-07-22T03:40:38Z", "author": {"login": "rolfyone"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/events/StorageUpdate.java", "diffHunk": "@@ -106,4 +110,8 @@ public boolean isEmpty() {\n   public Map<UnsignedLong, VoteTracker> getVotes() {\n     return votes;\n   }\n+\n+  public Map<Bytes32, SlotAndBlockRoot> getStateRootsToBlockRoots() {\n+    return stateRootsToBlockRoots;\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA1MDEyNQ=="}, "originalCommit": {"oid": "6b352a5b91178edf930d1cb3cc08076dd21b53bb"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MTM1NDkxOnYy", "diffSide": "RIGHT", "path": "data/beaconrestapi/src/integration-test/java/tech/pegasys/teku/beaconrestapi/AbstractDataBackedRestAPIIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNDowMTowNVrOG1R23Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNDo0NTowN1rOG1ShQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyMDI4NQ==", "bodyText": "Mocking BeaconChainUtil is unexpected given its a test util class. I think I'd just always use the real BeaconChainUtil. The only place it's used is for the non-mock version anyway.", "url": "https://github.com/ConsenSys/teku/pull/2389#discussion_r458520285", "createdAt": "2020-07-22T04:01:05Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/integration-test/java/tech/pegasys/teku/beaconrestapi/AbstractDataBackedRestAPIIntegrationTest.java", "diffHunk": "@@ -109,10 +112,13 @@ private void setupStorage(final StorageSystem storageSystem, final boolean useMo\n     recentChainData = storageSystem.recentChainData();\n     chainBuilder = ChainBuilder.create(VALIDATOR_KEYS);\n     chainUpdater = new ChainUpdater(recentChainData, chainBuilder);\n-    this.forkChoice =\n-        useMockForkChoice\n-            ? mock(ForkChoice.class)\n-            : new ForkChoice(recentChainData, stateTransition);\n+    if (useMockForkChoice) {\n+      beaconChainUtil = mock(BeaconChainUtil.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b73552155ce9b04055a83cfdc55a301b52097f14"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyOTE3OQ==", "bodyText": "its only while mocking the fork choice so that tests pass, otherwise the 'not ready' tests fail... i can investigate if there's another way to do this...", "url": "https://github.com/ConsenSys/teku/pull/2389#discussion_r458529179", "createdAt": "2020-07-22T04:36:56Z", "author": {"login": "rolfyone"}, "path": "data/beaconrestapi/src/integration-test/java/tech/pegasys/teku/beaconrestapi/AbstractDataBackedRestAPIIntegrationTest.java", "diffHunk": "@@ -109,10 +112,13 @@ private void setupStorage(final StorageSystem storageSystem, final boolean useMo\n     recentChainData = storageSystem.recentChainData();\n     chainBuilder = ChainBuilder.create(VALIDATOR_KEYS);\n     chainUpdater = new ChainUpdater(recentChainData, chainBuilder);\n-    this.forkChoice =\n-        useMockForkChoice\n-            ? mock(ForkChoice.class)\n-            : new ForkChoice(recentChainData, stateTransition);\n+    if (useMockForkChoice) {\n+      beaconChainUtil = mock(BeaconChainUtil.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyMDI4NQ=="}, "originalCommit": {"oid": "b73552155ce9b04055a83cfdc55a301b52097f14"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMDk5NA==", "bodyText": "They passed when I ran them with the change.  Which ones were failing for you?", "url": "https://github.com/ConsenSys/teku/pull/2389#discussion_r458530994", "createdAt": "2020-07-22T04:44:37Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/integration-test/java/tech/pegasys/teku/beaconrestapi/AbstractDataBackedRestAPIIntegrationTest.java", "diffHunk": "@@ -109,10 +112,13 @@ private void setupStorage(final StorageSystem storageSystem, final boolean useMo\n     recentChainData = storageSystem.recentChainData();\n     chainBuilder = ChainBuilder.create(VALIDATOR_KEYS);\n     chainUpdater = new ChainUpdater(recentChainData, chainBuilder);\n-    this.forkChoice =\n-        useMockForkChoice\n-            ? mock(ForkChoice.class)\n-            : new ForkChoice(recentChainData, stateTransition);\n+    if (useMockForkChoice) {\n+      beaconChainUtil = mock(BeaconChainUtil.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyMDI4NQ=="}, "originalCommit": {"oid": "b73552155ce9b04055a83cfdc55a301b52097f14"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMTEzNw==", "bodyText": "There's only a couple of tests that ever call the method that uses beaconChainUtil - the others should be unaffected (we'd still mock FockChoice just not BeaconChainUtil.", "url": "https://github.com/ConsenSys/teku/pull/2389#discussion_r458531137", "createdAt": "2020-07-22T04:45:07Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/integration-test/java/tech/pegasys/teku/beaconrestapi/AbstractDataBackedRestAPIIntegrationTest.java", "diffHunk": "@@ -109,10 +112,13 @@ private void setupStorage(final StorageSystem storageSystem, final boolean useMo\n     recentChainData = storageSystem.recentChainData();\n     chainBuilder = ChainBuilder.create(VALIDATOR_KEYS);\n     chainUpdater = new ChainUpdater(recentChainData, chainBuilder);\n-    this.forkChoice =\n-        useMockForkChoice\n-            ? mock(ForkChoice.class)\n-            : new ForkChoice(recentChainData, stateTransition);\n+    if (useMockForkChoice) {\n+      beaconChainUtil = mock(BeaconChainUtil.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyMDI4NQ=="}, "originalCommit": {"oid": "b73552155ce9b04055a83cfdc55a301b52097f14"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MTM4MjUwOnYy", "diffSide": "RIGHT", "path": "ethereum/datastructures/build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNDoxNzoyNVrOG1SGjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNDoxNzoyNVrOG1SGjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyNDMwMA==", "bodyText": "I don't think we should have this dependency.  I suspect SlotAndBlockRoot should just be in :ethereum:datastructures", "url": "https://github.com/ConsenSys/teku/pull/2389#discussion_r458524300", "createdAt": "2020-07-22T04:17:25Z", "author": {"login": "ajsutton"}, "path": "ethereum/datastructures/build.gradle", "diffHunk": "@@ -7,6 +7,7 @@ dependencies {\n   implementation project(':logging')\n   implementation project(':pow')\n   implementation project(':util')\n+  implementation project(':storage:api')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b73552155ce9b04055a83cfdc55a301b52097f14"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MTM5NzkyOnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/teku/storage/client/CombinedChainDataClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNDoyNjoxOVrOG1SPQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNDoyNjoxOVrOG1SPQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyNjUzMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        maybeSlotAndBlockRoot -> {\n          \n          \n            \n                          if (maybeSlotAndBlockRoot.isEmpty()) {\n          \n          \n            \n                            return STATE_NOT_AVAILABLE;\n          \n          \n            \n                          }\n          \n          \n            \n                          return getStateFromSlotAndBlock(maybeSlotAndBlockRoot.get());\n          \n          \n            \n                        });\n          \n          \n            \n                        maybeSlotAndBlockRoot ->\n          \n          \n            \n                            maybeSlotAndBlockRoot\n          \n          \n            \n                                .map(this::getStateFromSlotAndBlock)\n          \n          \n            \n                                .orElse(STATE_NOT_AVAILABLE));\n          \n          \n            \n                        });", "url": "https://github.com/ConsenSys/teku/pull/2389#discussion_r458526531", "createdAt": "2020-07-22T04:26:19Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/client/CombinedChainDataClient.java", "diffHunk": "@@ -205,6 +206,32 @@ public boolean isFinalizedEpoch(final UnsignedLong epoch) {\n     return historicalChainData.getFinalizedStateByBlockRoot(blockRoot);\n   }\n \n+  public SafeFuture<Optional<BeaconState>> getStateByStateRoot(final Bytes32 stateRoot) {\n+    final UpdatableStore store = getStore();\n+    if (store == null) {\n+      LOG.trace(\"No state at stateRoot {} because the store is not set\", stateRoot);\n+      return STATE_NOT_AVAILABLE;\n+    }\n+    return historicalChainData\n+        .getSlotAndBlockRootByStateRoot(stateRoot)\n+        .thenCompose(\n+            maybeSlotAndBlockRoot -> {\n+              if (maybeSlotAndBlockRoot.isEmpty()) {\n+                return STATE_NOT_AVAILABLE;\n+              }\n+              return getStateFromSlotAndBlock(maybeSlotAndBlockRoot.get());\n+            });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b73552155ce9b04055a83cfdc55a301b52097f14"}, "originalPosition": 26}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3414, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}