{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5NjkwNDc2", "number": 3336, "title": "TreeNode classes refactor", "bodyText": "PR Description\n\nmove all tree generalized index calculations to a separate GIndexUtils class\nmake tree traversal a part of TreeNode functionality (TreeNode.iterate() methods)\nmake default implementations for all 3 TreeNode.updated() overloads which invoke each other. So for minimal functionality just a single one needs to implemented.\nmove LeafNode and BranchNode to dedicated files\nminor unrelated fix to ProfilingRun\n\nThe part of #3287\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-30T17:13:22Z", "url": "https://github.com/ConsenSys/teku/pull/3336", "merged": true, "mergeCommit": {"oid": "47a6a78f147800e265910f0a85fedba6840ee72f"}, "closed": true, "closedAt": "2020-12-02T11:44:38Z", "author": {"login": "Nashatyrev"}, "timelineItems": {"totalCount": 42, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbY2XxAH2gAyNTI5NjkwNDc2OjkwNWZiZjhjZmYxMGU0NTEyZGFiYzRlYmJlMjQ0YTZlYjNjZGI3NDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiM7qGgH2gAyNTI5NjkwNDc2OjIxYmUxZWI0NDMxYzQ3NWQ2YjNhZjIxNGEyY2VhNTgwYmZhNDY0OGQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "905fbf8cff10e4512dabc4ebbe244a6eb3cdb746", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/905fbf8cff10e4512dabc4ebbe244a6eb3cdb746", "committedDate": "2020-11-11T07:30:18Z", "message": "Draft"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d1784469949317723ec1b4db06d76b8541023c3", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/8d1784469949317723ec1b4db06d76b8541023c3", "committedDate": "2020-11-12T07:30:54Z", "message": "Almost complete SuperLeafNode implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c35b65fd6f2f68db8662a7060ae0f42e948b598", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/1c35b65fd6f2f68db8662a7060ae0f42e948b598", "committedDate": "2020-11-12T17:42:38Z", "message": "Add Vector nad List TypeHints. Add SuperLeafNode test, fix bugs. Adjust SSZ serialize to work with SuperLeafNode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7bc2500fdd4fb089c9c36040c41c83104357e1c", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/f7bc2500fdd4fb089c9c36040c41c83104357e1c", "committedDate": "2020-11-18T08:37:35Z", "message": "Minor fix to ProfilingRun"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2c38c4624e58f32566fe8f9c3ae2bd049c592ba", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/d2c38c4624e58f32566fe8f9c3ae2bd049c592ba", "committedDate": "2020-11-18T08:38:20Z", "message": "Fix a couple of bugs in SuperLeafNode. Add hash memorize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ca242244e452e7049c02afe2a74d6bedeb4d635", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/8ca242244e452e7049c02afe2a74d6bedeb4d635", "committedDate": "2020-11-18T08:39:33Z", "message": "Make BeaconState.balances to be handled by SuperLeafNode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6eb4b51cc5c2e5cab7a6a84049fcbc91a7cb1503", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/6eb4b51cc5c2e5cab7a6a84049fcbc91a7cb1503", "committedDate": "2020-11-18T08:40:18Z", "message": "Add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5676ad63b0fe519f5fd54a44b1fd58f08c5054c", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/f5676ad63b0fe519f5fd54a44b1fd58f08c5054c", "committedDate": "2020-11-18T08:40:35Z", "message": "Add SuperBranchNode draft impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e255a6a0a7d0273906b8fd163fe2072a36ddbb2a", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/e255a6a0a7d0273906b8fd163fe2072a36ddbb2a", "committedDate": "2020-11-20T13:48:20Z", "message": "Extract generalized index related operations to a separate class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30a5dcf870cea5ea6de9d088a45f93010f0acd63", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/30a5dcf870cea5ea6de9d088a45f93010f0acd63", "committedDate": "2020-11-20T14:23:30Z", "message": "Initial implementation of SuperBranchNode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "826e9b3a7ab21db58aed7f88f68cf520cea67f8d", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/826e9b3a7ab21db58aed7f88f68cf520cea67f8d", "committedDate": "2020-11-20T15:56:39Z", "message": "Fix GIndex function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea3ee18e40da535dcc3ebcb24fcce00702faf50b", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/ea3ee18e40da535dcc3ebcb24fcce00702faf50b", "committedDate": "2020-11-20T15:59:40Z", "message": "Add TreeNode.iterate method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaf4b57c1dd9e80b832eee972088d44f4d34adba", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/eaf4b57c1dd9e80b832eee972088d44f4d34adba", "committedDate": "2020-11-23T11:26:04Z", "message": "Move tree nodes iteration functionality from utils to TreeNode implementations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7fbb735bd33a4a55e7b97133c8cf8a7952ce78e", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/e7fbb735bd33a4a55e7b97133c8cf8a7952ce78e", "committedDate": "2020-11-23T11:28:02Z", "message": "Spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e31dad2040548848bc9cbc6ffbf0d74c37100978", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/e31dad2040548848bc9cbc6ffbf0d74c37100978", "committedDate": "2020-11-23T13:04:33Z", "message": "Fix warn"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13a99b31e37204722abcfff70b2ecaaa8a98f148", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/13a99b31e37204722abcfff70b2ecaaa8a98f148", "committedDate": "2020-11-23T14:03:43Z", "message": "Fix SuperLeafNode.updated() bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec0d5007e25d45668aca13d6fd401b982d0af0a8", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/ec0d5007e25d45668aca13d6fd401b982d0af0a8", "committedDate": "2020-11-23T15:19:31Z", "message": "Merge remote-tracking branch 'origin/master' into feature/backing-tree-size-optimize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbebb416cfb24913622765bf2226fc8c702972e4", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/bbebb416cfb24913622765bf2226fc8c702972e4", "committedDate": "2020-11-24T11:51:02Z", "message": "Integrate SuperBranchNode to BeaconState.validators"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ad354fc0e32dd955961e45d8739cbe19f14ba55", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/4ad354fc0e32dd955961e45d8739cbe19f14ba55", "committedDate": "2020-11-24T18:18:15Z", "message": "Draft implementation of SszSuperNode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e313f44e3ff21041e4e1c87c0362be534263ec1d", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/e313f44e3ff21041e4e1c87c0362be534263ec1d", "committedDate": "2020-11-25T08:54:50Z", "message": "Merge remote-tracking branch 'origin/master' into feature/backing-tree-size-optimize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2333dd7e8352b69e31f9204ac3d81c4d3b70331e", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/2333dd7e8352b69e31f9204ac3d81c4d3b70331e", "committedDate": "2020-11-25T09:16:55Z", "message": "Add a new type hint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8f03ee06ac55385d5057dc9e9b9da4043d04aef", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/e8f03ee06ac55385d5057dc9e9b9da4043d04aef", "committedDate": "2020-11-25T09:17:21Z", "message": "Add temp test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c592e248d63c5e5be68ad4fa1b3d71f9131abd7", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/9c592e248d63c5e5be68ad4fa1b3d71f9131abd7", "committedDate": "2020-11-25T18:39:08Z", "message": "Implement SszSuperNode draft (single ssz bytes for containers sequence)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c28e0f1de8efe18b1a24aa16e916d8f327d9ed50", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/c28e0f1de8efe18b1a24aa16e916d8f327d9ed50", "committedDate": "2020-11-30T15:32:09Z", "message": "Merge remote-tracking branch 'ConsenSys/master' into feature/backing-tree-size-optimize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f86dd86413e9da93605013662f3971278cb9459b", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/f86dd86413e9da93605013662f3971278cb9459b", "committedDate": "2020-11-30T15:59:55Z", "message": "Leave just existing Tree code refactors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90894133960263cc41f6adceafa8ec4f87a82f98", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/90894133960263cc41f6adceafa8ec4f87a82f98", "committedDate": "2020-11-30T17:02:54Z", "message": "Make tree classes refactoring and add javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d71b44cb9ae219f217323f6aa9420ded4b9107e0", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/d71b44cb9ae219f217323f6aa9420ded4b9107e0", "committedDate": "2020-11-30T17:17:25Z", "message": "Spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39cc4da3f23467b9aa5cfd252a9cca45571eec6f", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/39cc4da3f23467b9aa5cfd252a9cca45571eec6f", "committedDate": "2020-11-30T18:20:26Z", "message": "Add GIndexUtil javadocs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e6614f1d1050fcce7beceaa9500773c2b1abe2f", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/9e6614f1d1050fcce7beceaa9500773c2b1abe2f", "committedDate": "2020-11-30T18:34:05Z", "message": "Add GIndexUtil minor test stub"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ab3a104c37e36049f1387538a4c7ce5becd7281", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/0ab3a104c37e36049f1387538a4c7ce5becd7281", "committedDate": "2020-12-01T10:14:47Z", "message": "Add more GIndexUtil tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "580028c80affa3a6a42b26a28000098ed2e48ad5", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/580028c80affa3a6a42b26a28000098ed2e48ad5", "committedDate": "2020-12-01T14:09:07Z", "message": "Add more GIndexUtil tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05e69eda4c92d58dfd7faddfc7ba1f16ba456a8d", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/05e69eda4c92d58dfd7faddfc7ba1f16ba456a8d", "committedDate": "2020-12-01T14:14:00Z", "message": "Make GIndexUtil package private and changed all runtime argument checks to asserts to mitigate performance drawdown risk"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a190c56f90cded009bf64445890a2a1a6bf403c", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/0a190c56f90cded009bf64445890a2a1a6bf403c", "committedDate": "2020-12-01T14:15:13Z", "message": "Merge branch 'master' into feature/tree-node-refactors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64afb9c818facbdb91f08b32407c8b6d9a784e01", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/64afb9c818facbdb91f08b32407c8b6d9a784e01", "committedDate": "2020-12-01T14:27:45Z", "message": "Cleanup TreeUtil.iterate*() methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fca821214a0e9fca58422da937b3c4de91839fda", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/fca821214a0e9fca58422da937b3c4de91839fda", "committedDate": "2020-12-01T14:35:32Z", "message": "Move TreeNode.createLeaf/BranchNode() methods to LeafNode/BranchNode classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac3d3bf2376bb91b2e8937efaeda5d8339e9d319", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/ac3d3bf2376bb91b2e8937efaeda5d8339e9d319", "committedDate": "2020-12-01T14:58:18Z", "message": "TreeNode.iterate(): refactor params order, add tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMTkyNzAx", "url": "https://github.com/ConsenSys/teku/pull/3336#pullrequestreview-542192701", "createdAt": "2020-12-01T18:43:12Z", "commit": {"oid": "ac3d3bf2376bb91b2e8937efaeda5d8339e9d319"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxODo0MzoxMlrOH86xmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxOToxMjowM1rOH8710w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYzOTU3Ng==", "bodyText": "Should we assert childDepth >= 0 as well?", "url": "https://github.com/ConsenSys/teku/pull/3336#discussion_r533639576", "createdAt": "2020-12-01T18:43:12Z", "author": {"login": "mbaxter"}, "path": "ssz/src/main/java/tech/pegasys/teku/ssz/backing/tree/GIndexUtil.java", "diffHunk": "@@ -0,0 +1,281 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.ssz.backing.tree;\n+\n+import static java.lang.Integer.min;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * Util methods for binary tree generalized indexes manipulations See\n+ * https://github.com/ethereum/eth2.0-specs/blob/v1.0.0/ssz/merkle-proofs.md#generalized-merkle-tree-index\n+ * for more info on generalized indexes\n+ *\n+ * <p>Here the general index is represented by <code>long</code> which is treated as unsigned uint64\n+ * Thus the only illegal generalized index value is <code>0</code>\n+ */\n+class GIndexUtil {\n+\n+  /** See {@link #gIdxCompare(long, long)} */\n+  public enum NodeRelation {\n+    Left,\n+    Right,\n+    Successor,\n+    Predecessor,\n+    Same;\n+\n+    /** <code>gIdxCompare(idx1, idx2) == gIdxCompare(idx2, idx1).inverse()</code> */\n+    public NodeRelation inverse() {\n+      switch (this) {\n+        case Left:\n+          return Right;\n+        case Right:\n+          return Left;\n+        case Predecessor:\n+          return Successor;\n+        case Successor:\n+          return Predecessor;\n+        case Same:\n+          return Same;\n+        default:\n+          throw new IllegalArgumentException(\"Unknown: \" + this);\n+      }\n+    }\n+  }\n+\n+  /**\n+   * The generalized index of either a root tree node or an index of a node relative to the node\n+   * itself. Effectively this is <code>1L</code>\n+   */\n+  static final long SELF_G_INDEX = 1;\n+\n+  /**\n+   * The generalized index (normally an index of non-existing node) of the leftmost possible node\n+   * Effectively this is {@link Long#MIN_VALUE} or <code>0b10000...000L</code> in binary form\n+   */\n+  static final long LEFTMOST_G_INDEX = gIdxLeftmostFrom(SELF_G_INDEX);\n+  /**\n+   * The generalized index (normally an index of non-existing node) of the rightmost possible node\n+   * Effectively this is <code>-1L</code> or <code>0b11111...111L</code> in binary form\n+   */\n+  static final long RIGHTMOST_G_INDEX = gIdxRightmostFrom(SELF_G_INDEX);\n+\n+  /**\n+   * Indicates that a relative generalized index refers to the node itself\n+   *\n+   * @see #SELF_G_INDEX\n+   */\n+  public static boolean gIdxIsSelf(long generalizedIndex) {\n+    checkGIndex(generalizedIndex);\n+    return generalizedIndex == SELF_G_INDEX;\n+  }\n+\n+  /**\n+   * Indicates how the node with generalized index <code>idx1</code> relates to the node with\n+   * generalized index <code>idx2</code>:\n+   *\n+   * <ul>\n+   *   <li>{@link NodeRelation#Left}: idx1 is to the left of idx2\n+   *   <li>{@link NodeRelation#Right}: idx1 is to the right of idx2\n+   *   <li>{@link NodeRelation#Successor}: idx1 is the successor of idx2\n+   *   <li>{@link NodeRelation#Predecessor}: idx1 is the predecessor of idx2\n+   *   <li>{@link NodeRelation#Same}: idx1 is equal to idx2\n+   * </ul>\n+   */\n+  public static NodeRelation gIdxCompare(long idx1, long idx2) {\n+    checkGIndex(idx1);\n+    checkGIndex(idx2);\n+    long anchor1 = Long.highestOneBit(idx1);\n+    long anchor2 = Long.highestOneBit(idx2);\n+    int depth1 = Long.bitCount(anchor1 - 1);\n+    int depth2 = Long.bitCount(anchor2 - 1);\n+    int minDepth = min(depth1, depth2);\n+    long minDepthIdx1 = idx1 >>> (depth1 - minDepth);\n+    long minDepthIdx2 = idx2 >>> (depth2 - minDepth);\n+    if (minDepthIdx1 == minDepthIdx2) {\n+      if (depth1 < depth2) {\n+        return NodeRelation.Predecessor;\n+      } else if (depth1 > depth2) {\n+        return NodeRelation.Successor;\n+      } else {\n+        return NodeRelation.Same;\n+      }\n+    } else {\n+      if (minDepthIdx1 < minDepthIdx2) {\n+        return NodeRelation.Left;\n+      } else {\n+        return NodeRelation.Right;\n+      }\n+    }\n+  }\n+\n+  /**\n+   * Returns the depth of the node denoted by the supplied generalized index. E.g. the depth of the\n+   * {@link #SELF_G_INDEX} would be 0\n+   */\n+  public static int gIdxGetDepth(long generalizedIndex) {\n+    checkGIndex(generalizedIndex);\n+    long anchor = Long.highestOneBit(generalizedIndex);\n+    return Long.bitCount(anchor - 1);\n+  }\n+\n+  /**\n+   * Returns the generalized index of the left child of the node with specified generalized index\n+   * E.g. the result when passing {@link #SELF_G_INDEX} would be <code>10</code>\n+   */\n+  public static long gIdxLeftGIndex(long generalizedIndex) {\n+    return gIdxChildGIndex(generalizedIndex, 0, 1);\n+  }\n+\n+  /**\n+   * Returns the generalized index of the right child of the node with specified generalized index\n+   * E.g. the result when passing {@link #SELF_G_INDEX} would be <code>11</code>\n+   */\n+  public static long gIdxRightGIndex(long generalizedIndex) {\n+    return gIdxChildGIndex(generalizedIndex, 1, 1);\n+  }\n+\n+  /**\n+   * More generic variant of methods {@link #gIdxLeftGIndex(long)} {@link #gIdxRightGIndex(long)}\n+   * Calculates the generalized index of a node's <code>childIdx</code> successor at depth <code>\n+   * childDepth</code> (depth relative to the original node). Note that <code>childIdx</code> is not\n+   * the generalized index but index number of child.\n+   *\n+   * <p>For example:\n+   *\n+   * <ul>\n+   *   <li><code>gIdxChildGIndex(SELF_G_INDEX, 0, 2) == 100</code>\n+   *   <li><code>gIdxChildGIndex(SELF_G_INDEX, 1, 2) == 101</code>\n+   *   <li><code>gIdxChildGIndex(SELF_G_INDEX, 2, 2) == 110</code>\n+   *   <li><code>gIdxChildGIndex(SELF_G_INDEX, 3, 2) == 111</code>\n+   *   <li><code>gIdxChildGIndex(SELF_G_INDEX, 4, 2) is invalid cause there are just 4 successors\n+   *   at depth 2</code>\n+   *   <li><code>gIdxChildGIndex(anyIndex, 0, 1) == gIdxLeftGIndex(anyIndex)</code>\n+   *   <li><code>gIdxChildGIndex(anyIndex, 1, 1) == gIdxRightGIndex(anyIndex)</code>\n+   * </ul>\n+   */\n+  public static long gIdxChildGIndex(long generalizedIndex, int childIdx, int childDepth) {\n+    checkGIndex(generalizedIndex);\n+    assert childDepth >= 0 && childDepth < 64;\n+    assert childIdx >= 0;\n+    assert childIdx < (1 << childDepth);\n+    assert gIdxGetDepth(generalizedIndex) + childDepth < 64;\n+    return (generalizedIndex << childDepth) | childIdx;\n+  }\n+\n+  /**\n+   * Returns the generalized index (normally an index of non-existing node) of the leftmost possible\n+   * successor of this node\n+   *\n+   * <p>For example:\n+   *\n+   * <ul>\n+   *   <li><code>gIdxLeftmostFrom(0b1100) == 0b110000000...00L</code>\n+   *   <li><code>gIdxLeftmostFrom(0b1101) == 0b110100000...00L</code>\n+   * </ul>\n+   */\n+  public static long gIdxLeftmostFrom(long fromGeneralizedIndex) {\n+    checkGIndex(fromGeneralizedIndex);\n+    long highestOneBit = Long.highestOneBit(fromGeneralizedIndex);\n+    if (highestOneBit < 0) {\n+      return fromGeneralizedIndex;\n+    } else {\n+      int nodeDepth = Long.bitCount(highestOneBit - 1);\n+      return fromGeneralizedIndex << (63 - nodeDepth);\n+    }\n+  }\n+\n+  /**\n+   * Returns the generalized index (normally an index of non-existing node) of the rightmost\n+   * possible successor of this node\n+   *\n+   * <p>For example:\n+   *\n+   * <ul>\n+   *   <li><code>gIdxRightmostFrom(0b1100) == 0b110011111...11L</code>\n+   *   <li><code>gIdxRightmostFrom(0b1101) == 0b110111111...11L</code>\n+   * </ul>\n+   */\n+  public static long gIdxRightmostFrom(long fromGeneralizedIndex) {\n+    checkGIndex(fromGeneralizedIndex);\n+    long highestOneBit = Long.highestOneBit(fromGeneralizedIndex);\n+    if (highestOneBit < 0) {\n+      return fromGeneralizedIndex;\n+    } else {\n+      int nodeDepth = Long.bitCount(highestOneBit - 1);\n+      int shiftN = 63 - nodeDepth;\n+      return (fromGeneralizedIndex << shiftN) | ((1L << shiftN) - 1);\n+    }\n+  }\n+\n+  /**\n+   * Returns the index number (not a generalized index) of a node at depth <code>childDepth</code>\n+   * which is a predecessor of or equal to the node at <code>generalizedIndex</code>\n+   *\n+   * <p>For example:\n+   *\n+   * <ul>\n+   *   <li><code>gIdxGetChildIndex(LEFTMOST_G_INDEX, anyDepth) == 0</code>\n+   *   <li><code>gIdxGetChildIndex(0b1100, 2) == 2</code>\n+   *   <li><code>gIdxGetChildIndex(0b1101, 2) == 2</code>\n+   *   <li><code>gIdxGetChildIndex(0b1110, 2) == 3</code>\n+   *   <li><code>gIdxGetChildIndex(0b1111, 2) == 3</code>\n+   *   <li><code>gIdxGetChildIndex(0b11, 2)</code> call would be invalid cause node with index 0b11\n+   *       is at depth 1\n+   * </ul>\n+   */\n+  public static int gIdxGetChildIndex(long generalizedIndex, int childDepth) {\n+    checkGIndex(generalizedIndex);\n+    assert childDepth < 64;\n+\n+    long anchor = Long.highestOneBit(generalizedIndex);\n+    int indexBitCount = Long.bitCount(anchor - 1);\n+    assert indexBitCount >= childDepth;\n+    long generalizedIndexWithoutAnchor = generalizedIndex ^ anchor;\n+    return (int) (generalizedIndexWithoutAnchor >>> (indexBitCount - childDepth));\n+  }\n+\n+  /**\n+   * Returns the generalized index of the node at <code>generalizedIndex</code> relative to its\n+   * predecessor at depth <code>childDepth</code> For example:\n+   *\n+   * <ul>\n+   *   <li><code>gIdxGetRelativeGIndex(0b1100, 2) == 0b10</code>\n+   *   <li><code>gIdxGetChildIndex(0b1101, 2) == 0b11</code>\n+   *   <li><code>gIdxGetChildIndex(0b1110, 2) == 0b10</code>\n+   *   <li><code>gIdxGetChildIndex(0b1111, 3) == SELF_G_INDEX</code>\n+   *   <li><code>gIdxGetChildIndex(0b11, 2)</code> call would be invalid cause node with index 0b11\n+   *       is at depth 1\n+   * </ul>\n+   */\n+  public static long gIdxGetRelativeGIndex(long generalizedIndex, int childDepth) {\n+    checkGIndex(generalizedIndex);\n+    assert childDepth < 64;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac3d3bf2376bb91b2e8937efaeda5d8339e9d319"}, "originalPosition": 264}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY1NzA0Mw==", "bodyText": "Looks like this is unused", "url": "https://github.com/ConsenSys/teku/pull/3336#discussion_r533657043", "createdAt": "2020-12-01T19:12:03Z", "author": {"login": "mbaxter"}, "path": "ssz/src/main/java/tech/pegasys/teku/ssz/backing/tree/TreeUpdates.java", "diffHunk": "@@ -105,25 +116,52 @@ private TreeUpdates(List<Long> gIndexes, List<TreeNode> nodes, long prefix, int\n     int idx = Collections.binarySearch(gIndexes, pivotGIndex);\n     int insIdx = idx < 0 ? -idx - 1 : idx;\n     return Pair.of(\n-        new TreeUpdates(\n+        TreeUpdates.create(\n             gIndexes.subList(0, insIdx), nodes.subList(0, insIdx), lPrefix, heightFromLeaf - 1),\n-        new TreeUpdates(\n+        TreeUpdates.create(\n             gIndexes.subList(insIdx, gIndexes.size()),\n             nodes.subList(insIdx, nodes.size()),\n             rPrefix,\n             heightFromLeaf - 1));\n   }\n \n+  public List<TreeUpdates> splitToDepth(int depth) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac3d3bf2376bb91b2e8937efaeda5d8339e9d319"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61744f2f06b953222cf4b6ffbac2c95a283399a6", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/61744f2f06b953222cf4b6ffbac2c95a283399a6", "committedDate": "2020-12-02T08:27:49Z", "message": "Add extra assert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b760def00fb569c59fe76636f6a2ae95b604f3c9", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/b760def00fb569c59fe76636f6a2ae95b604f3c9", "committedDate": "2020-12-02T11:26:08Z", "message": "Remove unused methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e367668e5c544ec598b6906f56075924e6f6fc51", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/e367668e5c544ec598b6906f56075924e6f6fc51", "committedDate": "2020-12-02T11:26:38Z", "message": "Merge branch 'master' into feature/tree-node-refactors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6846f359da32204e2f08c1970d9b486817931bf0", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/6846f359da32204e2f08c1970d9b486817931bf0", "committedDate": "2020-12-02T11:26:49Z", "message": "Merge remote-tracking branch 'origin/feature/tree-node-refactors' into feature/tree-node-refactors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21be1eb4431c475d6b3af214a2cea580bfa4648d", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/21be1eb4431c475d6b3af214a2cea580bfa4648d", "committedDate": "2020-12-02T11:34:41Z", "message": "Spotless"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4328, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}