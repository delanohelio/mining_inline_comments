{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0ODU5MDY2", "number": 2420, "title": "Handle peers limiting request block by range responses", "bodyText": "PR Description\nHandle peers responding with only some of the blocks in the requested range.  If the peer excessively throttles the responses (for example only returning one block) then we fail the sync against that peer.  The SyncManager will avoid selecting that peer as a sync target for a period and select a different target peer.  We don't disconnect the peer.\nIf the peer's response allows us to progress at least 50 slots in our sync, we consider it reasonable throttling and continue using the peer as our sync target.\nIt is possible for a peer to hit this condition when they aren't throttling excessively if there are a lot of empty blocks. e.g if we request block 1-200 and the only block in that range is at slot 2, we will assume the peer is throttling excessively.  The next peer we selected would then return no blocks and we'd then know that all blocks were empty and move on.\nFixed Issue(s)\nfixes #1957\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-07-22T03:34:36Z", "url": "https://github.com/ConsenSys/teku/pull/2420", "merged": true, "mergeCommit": {"oid": "be8a45647921ac332d6dd632f9ccdfd36c20c81b"}, "closed": true, "closedAt": "2020-07-22T05:57:39Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc2pt7cAH2gAyNDU0ODU5MDY2OmU4NzM3ZDAzOTdhYWY5MTk5OTczZjJhNGJmNWIzNzE5NmZiZWJhZTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3TlLHgH2gAyNDU0ODU5MDY2OmQ1N2I2ZmY3NGI2MjFiNTEyMDRkZmExZjljYmNhNmQ0MGVlZGE4Y2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e8737d0397aaf9199973f2a4bf5b37196fbebae8", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e8737d0397aaf9199973f2a4bf5b37196fbebae8", "committedDate": "2020-07-20T04:14:16Z", "message": "Handle peers that only return some of the blocks requested during sync."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6df572bdc19877ffd060721c8a1686fd9b56a39", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/b6df572bdc19877ffd060721c8a1686fd9b56a39", "committedDate": "2020-07-22T01:44:51Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into allow-partial-block-by-range-request"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8164c5a52a238ea8a6d1a792bb5728bb6354af32", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/8164c5a52a238ea8a6d1a792bb5728bb6354af32", "committedDate": "2020-07-22T03:28:55Z", "message": "Reject peers as sync target if they are exessively throttling."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyOTgyMTk4", "url": "https://github.com/ConsenSys/teku/pull/2420#pullrequestreview-452982198", "createdAt": "2020-07-22T04:15:19Z", "commit": {"oid": "8164c5a52a238ea8a6d1a792bb5728bb6354af32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNDoxNToxOVrOG1SEoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNDoxNToxOVrOG1SEoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyMzgwOA==", "bodyText": "isn't this more like Completed request for {} blocks starting at {} from peer {}, got {} blocks. Next request starts from {}?", "url": "https://github.com/ConsenSys/teku/pull/2420#discussion_r458523808", "createdAt": "2020-07-22T04:15:19Z", "author": {"login": "rolfyone"}, "path": "sync/src/main/java/tech/pegasys/teku/sync/PeerSync.java", "diffHunk": "@@ -119,18 +128,29 @@ public void stop() {\n               final SafeFuture<Void> readyForNextRequest =\n                   asyncRunner.getDelayedFuture(\n                       NEXT_REQUEST_TIMEOUT.toMillis(), TimeUnit.MILLISECONDS);\n-              return peer.requestBlocksByRange(startSlot, count, STEP, this::blockResponseListener)\n-                  .thenApply((res) -> readyForNextRequest);\n+              final PeerSyncBlockRequest request =\n+                  new PeerSyncBlockRequest(\n+                      readyForNextRequest, startSlot.plus(count), this::blockResponseListener);\n+              return peer.requestBlocksByRange(startSlot, count, STEP, request)\n+                  .thenApply((res) -> request);\n             })\n         .thenCompose(\n-            (readyForNextRequest) -> {\n+            (blockRequest) -> {\n+              final UnsignedLong nextSlot = blockRequest.getActualEndSlot().plus(UnsignedLong.ONE);\n               LOG.trace(\n-                  \"Completed request for {} blocks starting at {} from peer {}\",\n+                  \"Completed request for {} blocks starting at {} from peer {}. Next request starts from {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8164c5a52a238ea8a6d1a792bb5728bb6354af32"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyOTgyODUw", "url": "https://github.com/ConsenSys/teku/pull/2420#pullrequestreview-452982850", "createdAt": "2020-07-22T04:17:44Z", "commit": {"oid": "8164c5a52a238ea8a6d1a792bb5728bb6354af32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNDoxNzo0NVrOG1SG1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNDoxNzo0NVrOG1SG1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyNDM3NA==", "bodyText": "so if no blocks were returned they must have all been empty", "url": "https://github.com/ConsenSys/teku/pull/2420#discussion_r458524374", "createdAt": "2020-07-22T04:17:45Z", "author": {"login": "rolfyone"}, "path": "sync/src/main/java/tech/pegasys/teku/sync/PeerSyncBlockRequest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.Optional;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.networking.eth2.rpc.core.ResponseStreamListener;\n+\n+public class PeerSyncBlockRequest implements ResponseStreamListener<SignedBeaconBlock> {\n+\n+  private final SafeFuture<Void> readyForNextRequest;\n+  private final UnsignedLong lastRequestedSlot;\n+  private final ResponseStreamListener<SignedBeaconBlock> blockResponseListener;\n+  private Optional<UnsignedLong> slotOfLastBlock = Optional.empty();\n+\n+  public PeerSyncBlockRequest(\n+      final SafeFuture<Void> readyForNextRequest,\n+      final UnsignedLong lastRequestedSlot,\n+      final ResponseStreamListener<SignedBeaconBlock> blockResponseListener) {\n+    this.readyForNextRequest = readyForNextRequest;\n+    this.lastRequestedSlot = lastRequestedSlot;\n+    this.blockResponseListener = blockResponseListener;\n+  }\n+\n+  @Override\n+  public SafeFuture<?> onResponse(final SignedBeaconBlock response) {\n+    slotOfLastBlock = Optional.of(response.getSlot());\n+    return blockResponseListener.onResponse(response);\n+  }\n+\n+  public SafeFuture<Void> getReadyForNextRequest() {\n+    return readyForNextRequest;\n+  }\n+\n+  public UnsignedLong getActualEndSlot() {\n+    // The peer must return at least one block if it has it, so if no blocks were returned they\n+    // must all of have been empty.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8164c5a52a238ea8a6d1a792bb5728bb6354af32"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyOTg1MDQ3", "url": "https://github.com/ConsenSys/teku/pull/2420#pullrequestreview-452985047", "createdAt": "2020-07-22T04:25:29Z", "commit": {"oid": "8164c5a52a238ea8a6d1a792bb5728bb6354af32"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9a95a1811b78c4b4501c725b1f3b51f324ea9b2", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/f9a95a1811b78c4b4501c725b1f3b51f324ea9b2", "committedDate": "2020-07-22T04:45:29Z", "message": "Tidy up PeerSyncTest."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d57b6ff74b621b51204dfa1f9cbca6d40eeda8ce", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d57b6ff74b621b51204dfa1f9cbca6d40eeda8ce", "committedDate": "2020-07-22T05:00:43Z", "message": "Reword log message."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3674, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}