{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5NjUwOTIx", "number": 2729, "reviewThreads": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNDo1OTo0OFrOEgx-xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoyMTowMVrOEkRcsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyODA4Nzc1OnYy", "diffSide": "RIGHT", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreAlreadyInUseException.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNDo1OTo0OFrOHNwN_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMzoxOToxMlrOHOcc1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE4MzU1MA==", "bodyText": "We need to make sure this provides a nice clear error message on the command line and not a big stack trace.  Often this is done by throwing an InvalidConfigurationException.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r484183550", "createdAt": "2020-09-07T04:59:48Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreAlreadyInUseException.java", "diffHunk": "@@ -0,0 +1,20 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+public class KeystoreAlreadyInUseException extends RuntimeException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e298d51f2ff6316a24144ac3a1201229215f12c"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkwODI0Ng==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r484908246", "createdAt": "2020-09-08T13:19:12Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreAlreadyInUseException.java", "diffHunk": "@@ -0,0 +1,20 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+public class KeystoreAlreadyInUseException extends RuntimeException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE4MzU1MA=="}, "originalCommit": {"oid": "6e298d51f2ff6316a24144ac3a1201229215f12c"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTU0NjU4OnYy", "diffSide": "RIGHT", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMjowMDowMFrOHPbynA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMjoxNzozNVrOHPwvKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk0NjAxMg==", "bodyText": "Is this really only visible for testing? Seems like someone external should be calling it in production code.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r485946012", "createdAt": "2020-09-09T22:00:00Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.primitives.Longs;\n+import java.io.IOException;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = Longs.toByteArray(ProcessHandle.current().pid());\n+\n+  @VisibleForTesting\n+  public void lockKeystoreFile(Path keystoreFile) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI4OTE5Mw==", "bodyText": "Yep, removed.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486289193", "createdAt": "2020-09-10T12:17:35Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.primitives.Longs;\n+import java.io.IOException;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = Longs.toByteArray(ProcessHandle.current().pid());\n+\n+  @VisibleForTesting\n+  public void lockKeystoreFile(Path keystoreFile) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk0NjAxMg=="}, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTc1MzczOnYy", "diffSide": "RIGHT", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMzozMzowMFrOHPdtsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMjozMDowMVrOHPxMTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3NzUyMw==", "bodyText": "ProcessHandle is able to throw UnsupportedOperationException if the JVM implementation or OS can't support them.  We need to handle that and just write an empty file in that case.\nFor compatibility with non-java clients we should also ensure we write the PID in native byte order.  So calculating our PID would be:\n    byte[] pidBytes;\n    try {\n      final long pid = ProcessHandle.current().pid();\n      final ByteBuffer buffer = ByteBuffer.allocate(Long.BYTES).order(ByteOrder.nativeOrder());\n      buffer.putLong(pid);\n      pidBytes = buffer.array();\n    } catch (final UnsupportedOperationException e) {\n      LOG.warn(\"....\");\n      pidBytes = new byte[0];\n    }\n\nAnd reading the PID would be:\n    final ByteBuffer readBuffer = ByteBuffer.allocate(Long.BYTES).order(ByteOrder.nativeOrder());\n    readBuffer.put(pidBytes);\n    final long result = readBuffer.getLong(0);", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r485977523", "createdAt": "2020-09-09T23:33:00Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.primitives.Longs;\n+import java.io.IOException;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = Longs.toByteArray(ProcessHandle.current().pid());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI5NjY1Mg==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486296652", "createdAt": "2020-09-10T12:30:01Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.primitives.Longs;\n+import java.io.IOException;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = Longs.toByteArray(ProcessHandle.current().pid());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3NzUyMw=="}, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTc4NDQ1OnYy", "diffSide": "RIGHT", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMzo0ODoyNFrOHPd_Nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMjozMzowM1rOHPxTTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MjAwNw==", "bodyText": "We should check that the file is precisely Long.BYTES long before treating it as a PID. We need to be really conservative before deleting lock files.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r485982007", "createdAt": "2020-09-09T23:48:24Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.primitives.Longs;\n+import java.io.IOException;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = Longs.toByteArray(ProcessHandle.current().pid());\n+\n+  @VisibleForTesting\n+  public void lockKeystoreFile(Path keystoreFile) {\n+    deleteIfStaleLockfileExists(keystoreFile);\n+    try {\n+      final Path keystoreLockFile =\n+          Files.write(Path.of(keystoreFile.toString() + \".lock\"), processPID, CREATE_NEW);\n+      keystoreLockFile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new RuntimeException(\n+          \"Unexpected error at KeystoreValidatorKeyProvider when locking keystore file.\", e);\n+    }\n+  }\n+\n+  public void deleteIfStaleLockfileExists(Path keystoreFile) {\n+    Path keystoreLockfile = Path.of(keystoreFile.toString() + \".lock\");\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(keystoreLockfile);\n+      if (pidInBytes.length != 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI5ODQ0MQ==", "bodyText": "Makes sense. Done.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486298441", "createdAt": "2020-09-10T12:33:03Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.primitives.Longs;\n+import java.io.IOException;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = Longs.toByteArray(ProcessHandle.current().pid());\n+\n+  @VisibleForTesting\n+  public void lockKeystoreFile(Path keystoreFile) {\n+    deleteIfStaleLockfileExists(keystoreFile);\n+    try {\n+      final Path keystoreLockFile =\n+          Files.write(Path.of(keystoreFile.toString() + \".lock\"), processPID, CREATE_NEW);\n+      keystoreLockFile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new RuntimeException(\n+          \"Unexpected error at KeystoreValidatorKeyProvider when locking keystore file.\", e);\n+    }\n+  }\n+\n+  public void deleteIfStaleLockfileExists(Path keystoreFile) {\n+    Path keystoreLockfile = Path.of(keystoreFile.toString() + \".lock\");\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(keystoreLockfile);\n+      if (pidInBytes.length != 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MjAwNw=="}, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI5ODQ0NQ==", "bodyText": "Makes sense. Done.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486298445", "createdAt": "2020-09-10T12:33:03Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.primitives.Longs;\n+import java.io.IOException;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = Longs.toByteArray(ProcessHandle.current().pid());\n+\n+  @VisibleForTesting\n+  public void lockKeystoreFile(Path keystoreFile) {\n+    deleteIfStaleLockfileExists(keystoreFile);\n+    try {\n+      final Path keystoreLockFile =\n+          Files.write(Path.of(keystoreFile.toString() + \".lock\"), processPID, CREATE_NEW);\n+      keystoreLockFile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new RuntimeException(\n+          \"Unexpected error at KeystoreValidatorKeyProvider when locking keystore file.\", e);\n+    }\n+  }\n+\n+  public void deleteIfStaleLockfileExists(Path keystoreFile) {\n+    Path keystoreLockfile = Path.of(keystoreFile.toString() + \".lock\");\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(keystoreLockfile);\n+      if (pidInBytes.length != 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MjAwNw=="}, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTc4ODkzOnYy", "diffSide": "RIGHT", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMzo1MDoyNFrOHPeBpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxOTo1Nzo1MVrOHRkdUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MjYyOA==", "bodyText": "Personal taste but I'd probably do:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ProcessHandle.of(pid)\n          \n          \n            \n                        .ifPresent(\n          \n          \n            \n                            p -> {\n          \n          \n            \n                              if (!p.isAlive()) {\n          \n          \n            \n                                if (!keystoreLockfile.toFile().delete()) {\n          \n          \n            \n                                  LOG.warn(\"Could not delete stale lockfile.\");\n          \n          \n            \n                                }\n          \n          \n            \n                              }\n          \n          \n            \n                            });\n          \n          \n            \n                    ProcessHandle.of(pid)\n          \n          \n            \n                        .filter(process -> !process.isAlive())\n          \n          \n            \n                        .ifPresent(\n          \n          \n            \n                            __ -> {\n          \n          \n            \n                                if (!keystoreLockfile.toFile().delete()) {\n          \n          \n            \n                                  LOG.warn(\"Could not delete stale lockfile.\");\n          \n          \n            \n                                }\n          \n          \n            \n                            });\n          \n      \n    \n    \n  \n\nIt's also possible that the process was exiting just as we came through this code so:\nif (!keystoreLockfile.toFile().delete() && keystoreLockfile.toFile().exists()) {", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r485982628", "createdAt": "2020-09-09T23:50:24Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.primitives.Longs;\n+import java.io.IOException;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = Longs.toByteArray(ProcessHandle.current().pid());\n+\n+  @VisibleForTesting\n+  public void lockKeystoreFile(Path keystoreFile) {\n+    deleteIfStaleLockfileExists(keystoreFile);\n+    try {\n+      final Path keystoreLockFile =\n+          Files.write(Path.of(keystoreFile.toString() + \".lock\"), processPID, CREATE_NEW);\n+      keystoreLockFile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new RuntimeException(\n+          \"Unexpected error at KeystoreValidatorKeyProvider when locking keystore file.\", e);\n+    }\n+  }\n+\n+  public void deleteIfStaleLockfileExists(Path keystoreFile) {\n+    Path keystoreLockfile = Path.of(keystoreFile.toString() + \".lock\");\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(keystoreLockfile);\n+      if (pidInBytes.length != 0) {\n+        long pid = Longs.fromByteArray(pidInBytes);\n+        ProcessHandle.of(pid)\n+            .ifPresent(\n+                p -> {\n+                  if (!p.isAlive()) {\n+                    if (!keystoreLockfile.toFile().delete()) {\n+                      LOG.warn(\"Could not delete stale lockfile.\");\n+                    }\n+                  }\n+                });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMwMjM3Mg==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486302372", "createdAt": "2020-09-10T12:39:26Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.primitives.Longs;\n+import java.io.IOException;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = Longs.toByteArray(ProcessHandle.current().pid());\n+\n+  @VisibleForTesting\n+  public void lockKeystoreFile(Path keystoreFile) {\n+    deleteIfStaleLockfileExists(keystoreFile);\n+    try {\n+      final Path keystoreLockFile =\n+          Files.write(Path.of(keystoreFile.toString() + \".lock\"), processPID, CREATE_NEW);\n+      keystoreLockFile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new RuntimeException(\n+          \"Unexpected error at KeystoreValidatorKeyProvider when locking keystore file.\", e);\n+    }\n+  }\n+\n+  public void deleteIfStaleLockfileExists(Path keystoreFile) {\n+    Path keystoreLockfile = Path.of(keystoreFile.toString() + \".lock\");\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(keystoreLockfile);\n+      if (pidInBytes.length != 0) {\n+        long pid = Longs.fromByteArray(pidInBytes);\n+        ProcessHandle.of(pid)\n+            .ifPresent(\n+                p -> {\n+                  if (!p.isAlive()) {\n+                    if (!keystoreLockfile.toFile().delete()) {\n+                      LOG.warn(\"Could not delete stale lockfile.\");\n+                    }\n+                  }\n+                });", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MjYyOA=="}, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMwMzQyNg==", "bodyText": "Your last comment made me think. We actually don't have code in place to remove these lockfiles when the validator client is shutting down. Not sure if we really need to, since we already have a stale lockfile deletion mechanism at the start.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486303426", "createdAt": "2020-09-10T12:41:10Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.primitives.Longs;\n+import java.io.IOException;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = Longs.toByteArray(ProcessHandle.current().pid());\n+\n+  @VisibleForTesting\n+  public void lockKeystoreFile(Path keystoreFile) {\n+    deleteIfStaleLockfileExists(keystoreFile);\n+    try {\n+      final Path keystoreLockFile =\n+          Files.write(Path.of(keystoreFile.toString() + \".lock\"), processPID, CREATE_NEW);\n+      keystoreLockFile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new RuntimeException(\n+          \"Unexpected error at KeystoreValidatorKeyProvider when locking keystore file.\", e);\n+    }\n+  }\n+\n+  public void deleteIfStaleLockfileExists(Path keystoreFile) {\n+    Path keystoreLockfile = Path.of(keystoreFile.toString() + \".lock\");\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(keystoreLockfile);\n+      if (pidInBytes.length != 0) {\n+        long pid = Longs.fromByteArray(pidInBytes);\n+        ProcessHandle.of(pid)\n+            .ifPresent(\n+                p -> {\n+                  if (!p.isAlive()) {\n+                    if (!keystoreLockfile.toFile().delete()) {\n+                      LOG.warn(\"Could not delete stale lockfile.\");\n+                    }\n+                  }\n+                });", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MjYyOA=="}, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5NDE5OA==", "bodyText": "We do have the deleteOnExit call for the lock file so if the JVM exits it will delete the file.  I think it would be good to delete in our stop code as well actually - we don't really support running multiple Teku's in one process but no need to entrench that further when it should be fairly simple to hook in a delete call (keep the deleteOnExit though as a fallback, it won't care if the file is already deleted).", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486694198", "createdAt": "2020-09-10T23:49:36Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.primitives.Longs;\n+import java.io.IOException;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = Longs.toByteArray(ProcessHandle.current().pid());\n+\n+  @VisibleForTesting\n+  public void lockKeystoreFile(Path keystoreFile) {\n+    deleteIfStaleLockfileExists(keystoreFile);\n+    try {\n+      final Path keystoreLockFile =\n+          Files.write(Path.of(keystoreFile.toString() + \".lock\"), processPID, CREATE_NEW);\n+      keystoreLockFile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new RuntimeException(\n+          \"Unexpected error at KeystoreValidatorKeyProvider when locking keystore file.\", e);\n+    }\n+  }\n+\n+  public void deleteIfStaleLockfileExists(Path keystoreFile) {\n+    Path keystoreLockfile = Path.of(keystoreFile.toString() + \".lock\");\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(keystoreLockfile);\n+      if (pidInBytes.length != 0) {\n+        long pid = Longs.fromByteArray(pidInBytes);\n+        ProcessHandle.of(pid)\n+            .ifPresent(\n+                p -> {\n+                  if (!p.isAlive()) {\n+                    if (!keystoreLockfile.toFile().delete()) {\n+                      LOG.warn(\"Could not delete stale lockfile.\");\n+                    }\n+                  }\n+                });", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MjYyOA=="}, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE4Mzk4OA==", "bodyText": "I think I'll fall back to making an issue about this as it seems to be pretty complex due to only the local signer attempting to delete the lockfiles, and the problem being not too high of a priority.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r488183988", "createdAt": "2020-09-14T19:55:39Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.primitives.Longs;\n+import java.io.IOException;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = Longs.toByteArray(ProcessHandle.current().pid());\n+\n+  @VisibleForTesting\n+  public void lockKeystoreFile(Path keystoreFile) {\n+    deleteIfStaleLockfileExists(keystoreFile);\n+    try {\n+      final Path keystoreLockFile =\n+          Files.write(Path.of(keystoreFile.toString() + \".lock\"), processPID, CREATE_NEW);\n+      keystoreLockFile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new RuntimeException(\n+          \"Unexpected error at KeystoreValidatorKeyProvider when locking keystore file.\", e);\n+    }\n+  }\n+\n+  public void deleteIfStaleLockfileExists(Path keystoreFile) {\n+    Path keystoreLockfile = Path.of(keystoreFile.toString() + \".lock\");\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(keystoreLockfile);\n+      if (pidInBytes.length != 0) {\n+        long pid = Longs.fromByteArray(pidInBytes);\n+        ProcessHandle.of(pid)\n+            .ifPresent(\n+                p -> {\n+                  if (!p.isAlive()) {\n+                    if (!keystoreLockfile.toFile().delete()) {\n+                      LOG.warn(\"Could not delete stale lockfile.\");\n+                    }\n+                  }\n+                });", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MjYyOA=="}, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE4NTE3MA==", "bodyText": "#2793", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r488185170", "createdAt": "2020-09-14T19:57:51Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.primitives.Longs;\n+import java.io.IOException;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = Longs.toByteArray(ProcessHandle.current().pid());\n+\n+  @VisibleForTesting\n+  public void lockKeystoreFile(Path keystoreFile) {\n+    deleteIfStaleLockfileExists(keystoreFile);\n+    try {\n+      final Path keystoreLockFile =\n+          Files.write(Path.of(keystoreFile.toString() + \".lock\"), processPID, CREATE_NEW);\n+      keystoreLockFile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new RuntimeException(\n+          \"Unexpected error at KeystoreValidatorKeyProvider when locking keystore file.\", e);\n+    }\n+  }\n+\n+  public void deleteIfStaleLockfileExists(Path keystoreFile) {\n+    Path keystoreLockfile = Path.of(keystoreFile.toString() + \".lock\");\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(keystoreLockfile);\n+      if (pidInBytes.length != 0) {\n+        long pid = Longs.fromByteArray(pidInBytes);\n+        ProcessHandle.of(pid)\n+            .ifPresent(\n+                p -> {\n+                  if (!p.isAlive()) {\n+                    if (!keystoreLockfile.toFile().delete()) {\n+                      LOG.warn(\"Could not delete stale lockfile.\");\n+                    }\n+                  }\n+                });", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MjYyOA=="}, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTc5MDM3OnYy", "diffSide": "RIGHT", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMzo1MToxMFrOHPeCdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMjozOToyMlrOHPxiaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MjgzOA==", "bodyText": "We shouldn't be using equals on exceptions and shouldn't be ignoring any IOException here.  Suspect the if should just be completely removed.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r485982838", "createdAt": "2020-09-09T23:51:10Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.primitives.Longs;\n+import java.io.IOException;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = Longs.toByteArray(ProcessHandle.current().pid());\n+\n+  @VisibleForTesting\n+  public void lockKeystoreFile(Path keystoreFile) {\n+    deleteIfStaleLockfileExists(keystoreFile);\n+    try {\n+      final Path keystoreLockFile =\n+          Files.write(Path.of(keystoreFile.toString() + \".lock\"), processPID, CREATE_NEW);\n+      keystoreLockFile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new RuntimeException(\n+          \"Unexpected error at KeystoreValidatorKeyProvider when locking keystore file.\", e);\n+    }\n+  }\n+\n+  public void deleteIfStaleLockfileExists(Path keystoreFile) {\n+    Path keystoreLockfile = Path.of(keystoreFile.toString() + \".lock\");\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(keystoreLockfile);\n+      if (pidInBytes.length != 0) {\n+        long pid = Longs.fromByteArray(pidInBytes);\n+        ProcessHandle.of(pid)\n+            .ifPresent(\n+                p -> {\n+                  if (!p.isAlive()) {\n+                    if (!keystoreLockfile.toFile().delete()) {\n+                      LOG.warn(\"Could not delete stale lockfile.\");\n+                    }\n+                  }\n+                });\n+      }\n+    } catch (IOException e) {\n+      if (e.equals(new NoSuchFileException(keystoreLockfile.toString()))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMwMjMxMw==", "bodyText": "Removed the if.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486302313", "createdAt": "2020-09-10T12:39:22Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.primitives.Longs;\n+import java.io.IOException;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = Longs.toByteArray(ProcessHandle.current().pid());\n+\n+  @VisibleForTesting\n+  public void lockKeystoreFile(Path keystoreFile) {\n+    deleteIfStaleLockfileExists(keystoreFile);\n+    try {\n+      final Path keystoreLockFile =\n+          Files.write(Path.of(keystoreFile.toString() + \".lock\"), processPID, CREATE_NEW);\n+      keystoreLockFile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new RuntimeException(\n+          \"Unexpected error at KeystoreValidatorKeyProvider when locking keystore file.\", e);\n+    }\n+  }\n+\n+  public void deleteIfStaleLockfileExists(Path keystoreFile) {\n+    Path keystoreLockfile = Path.of(keystoreFile.toString() + \".lock\");\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(keystoreLockfile);\n+      if (pidInBytes.length != 0) {\n+        long pid = Longs.fromByteArray(pidInBytes);\n+        ProcessHandle.of(pid)\n+            .ifPresent(\n+                p -> {\n+                  if (!p.isAlive()) {\n+                    if (!keystoreLockfile.toFile().delete()) {\n+                      LOG.warn(\"Could not delete stale lockfile.\");\n+                    }\n+                  }\n+                });\n+      }\n+    } catch (IOException e) {\n+      if (e.equals(new NoSuchFileException(keystoreLockfile.toString()))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MjgzOA=="}, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTc5NTcwOnYy", "diffSide": "RIGHT", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMzo1NDowOFrOHPeFrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMjo0MToxN1rOHPxnJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MzY2MQ==", "bodyText": "UncheckedIOException would be a better wrapper type here.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r485983661", "createdAt": "2020-09-09T23:54:08Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.primitives.Longs;\n+import java.io.IOException;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = Longs.toByteArray(ProcessHandle.current().pid());\n+\n+  @VisibleForTesting\n+  public void lockKeystoreFile(Path keystoreFile) {\n+    deleteIfStaleLockfileExists(keystoreFile);\n+    try {\n+      final Path keystoreLockFile =\n+          Files.write(Path.of(keystoreFile.toString() + \".lock\"), processPID, CREATE_NEW);\n+      keystoreLockFile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new RuntimeException(\n+          \"Unexpected error at KeystoreValidatorKeyProvider when locking keystore file.\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMwMzUyNA==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486303524", "createdAt": "2020-09-10T12:41:17Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.primitives.Longs;\n+import java.io.IOException;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = Longs.toByteArray(ProcessHandle.current().pid());\n+\n+  @VisibleForTesting\n+  public void lockKeystoreFile(Path keystoreFile) {\n+    deleteIfStaleLockfileExists(keystoreFile);\n+    try {\n+      final Path keystoreLockFile =\n+          Files.write(Path.of(keystoreFile.toString() + \".lock\"), processPID, CREATE_NEW);\n+      keystoreLockFile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new RuntimeException(\n+          \"Unexpected error at KeystoreValidatorKeyProvider when locking keystore file.\", e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MzY2MQ=="}, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTc5Nzk2OnYy", "diffSide": "RIGHT", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/ValidatorLoader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMzo1NToyNlrOHPeHDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMjo0MzoxOVrOHPxr5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4NDAxMg==", "bodyText": "Probably just create KeystoreLocker inline as there's no need to create it if we don't go on to create a KeystoresValidatorKeyProvider.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r485984012", "createdAt": "2020-09-09T23:55:26Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/ValidatorLoader.java", "diffHunk": "@@ -110,8 +110,9 @@ private Signer createSigner(\n         keyProviders.add(new YamlValidatorKeyProvider());\n       }\n \n+      KeystoreLocker keystoreLocker = new KeystoreLocker();\n       if (config.getValidatorKeystorePasswordFilePairs() != null) {\n-        keyProviders.add(new KeystoresValidatorKeyProvider());\n+        keyProviders.add(new KeystoresValidatorKeyProvider(keystoreLocker));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMwNDc0MA==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486304740", "createdAt": "2020-09-10T12:43:19Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/ValidatorLoader.java", "diffHunk": "@@ -110,8 +110,9 @@ private Signer createSigner(\n         keyProviders.add(new YamlValidatorKeyProvider());\n       }\n \n+      KeystoreLocker keystoreLocker = new KeystoreLocker();\n       if (config.getValidatorKeystorePasswordFilePairs() != null) {\n-        keyProviders.add(new KeystoresValidatorKeyProvider());\n+        keyProviders.add(new KeystoresValidatorKeyProvider(keystoreLocker));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4NDAxMg=="}, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTgwNTM0OnYy", "diffSide": "RIGHT", "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/KeystoreLockerTest.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMzo1ODo0N1rOHPeLHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxOTozNjoxNlrOHRjxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4NTA1NQ==", "bodyText": "We need to add tests for existing PID files that have PIDs for live processes (will need to spawn something via ProcessBuilder - maybe run /bin/sleep and skip the test if it can't be executed like on Windows).  For PID files that have a PID that isn't alive, empty PID files and PID files containing something that isn't a long.\nAnd probably also a non-existent directory to trigger an IOException while creating the file.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r485985055", "createdAt": "2020-09-09T23:58:47Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/KeystoreLockerTest.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import com.google.common.io.Resources;\n+import java.nio.file.Path;\n+import org.assertj.core.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLockerTest {\n+\n+  private KeystoreLocker keystoreLocker = new KeystoreLocker();\n+\n+  @Test\n+  void shouldLockKeystoreFileAndFailWhenTryingCreateLockForLockedFile() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1NzQ3OA==", "bodyText": "I've added all the tests but the last one you mentioned with the non-existent directory. Not sure how I could mock a scenario like that.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486457478", "createdAt": "2020-09-10T15:59:54Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/KeystoreLockerTest.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import com.google.common.io.Resources;\n+import java.nio.file.Path;\n+import org.assertj.core.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLockerTest {\n+\n+  private KeystoreLocker keystoreLocker = new KeystoreLocker();\n+\n+  @Test\n+  void shouldLockKeystoreFileAndFailWhenTryingCreateLockForLockedFile() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4NTA1NQ=="}, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5MTcxMg==", "bodyText": "Create a temp dir (which does exist) then ask KeystoreLocker to lock a non-existent keystore in a non-existent sub directory.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486691712", "createdAt": "2020-09-10T23:40:56Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/KeystoreLockerTest.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import com.google.common.io.Resources;\n+import java.nio.file.Path;\n+import org.assertj.core.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLockerTest {\n+\n+  private KeystoreLocker keystoreLocker = new KeystoreLocker();\n+\n+  @Test\n+  void shouldLockKeystoreFileAndFailWhenTryingCreateLockForLockedFile() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4NTA1NQ=="}, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE3Mzg3NQ==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r488173875", "createdAt": "2020-09-14T19:36:16Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/KeystoreLockerTest.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import com.google.common.io.Resources;\n+import java.nio.file.Path;\n+import org.assertj.core.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLockerTest {\n+\n+  private KeystoreLocker keystoreLocker = new KeystoreLocker();\n+\n+  @Test\n+  void shouldLockKeystoreFileAndFailWhenTryingCreateLockForLockedFile() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4NTA1NQ=="}, "originalCommit": {"oid": "97bb18e9ba7494bc2f7b71a7d0eb47033ca5a00f"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDI5OTcwOnYy", "diffSide": "RIGHT", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzozMTo1NFrOHQJJJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxODowNDozMlrOHRgtSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4OTA2Mg==", "bodyText": "We're still not handling UnsupportedOperationException that could be thrown by ProcessHandle.current()", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486689062", "createdAt": "2020-09-10T23:31:54Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = longPidToNativeByteArray(ProcessHandle.current().pid());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85b95cc1e61058eb11f66410acc0fa59a2ae91a1"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEyMzcyMg==", "bodyText": "My bad. Handled it now.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r488123722", "createdAt": "2020-09-14T18:04:32Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = longPidToNativeByteArray(ProcessHandle.current().pid());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4OTA2Mg=="}, "originalCommit": {"oid": "85b95cc1e61058eb11f66410acc0fa59a2ae91a1"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDMwNDA1OnYy", "diffSide": "RIGHT", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzozNDoxNFrOHQJLvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxODoxNzoxM1rOHRhJZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4OTcyNw==", "bodyText": "Why are we returning a boolean from this method when lockKeystoreFile never does anything with it?", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486689727", "createdAt": "2020-09-10T23:34:14Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = longPidToNativeByteArray(ProcessHandle.current().pid());\n+\n+  public void lockKeystoreFile(Path keystoreFile) {\n+    deleteIfStaleLockfileExists(keystoreFile);\n+    try {\n+      final Path keystoreLockFile =\n+          Files.write(Path.of(keystoreFile.toString() + \".lock\"), processPID, CREATE_NEW);\n+      keystoreLockFile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Unexpected error when trying to lock a keystore file.\", e);\n+    }\n+  }\n+\n+  static boolean deleteIfStaleLockfileExists(Path keystoreFile) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85b95cc1e61058eb11f66410acc0fa59a2ae91a1"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEzMDkxNg==", "bodyText": "Made method void.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r488130916", "createdAt": "2020-09-14T18:17:13Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = longPidToNativeByteArray(ProcessHandle.current().pid());\n+\n+  public void lockKeystoreFile(Path keystoreFile) {\n+    deleteIfStaleLockfileExists(keystoreFile);\n+    try {\n+      final Path keystoreLockFile =\n+          Files.write(Path.of(keystoreFile.toString() + \".lock\"), processPID, CREATE_NEW);\n+      keystoreLockFile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Unexpected error when trying to lock a keystore file.\", e);\n+    }\n+  }\n+\n+  static boolean deleteIfStaleLockfileExists(Path keystoreFile) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4OTcyNw=="}, "originalCommit": {"oid": "85b95cc1e61058eb11f66410acc0fa59a2ae91a1"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDMwNTIwOnYy", "diffSide": "RIGHT", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzozNDo0OVrOHQJMaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxODoxNTo1NlrOHRhGvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4OTg5Ng==", "bodyText": "We should have a single place where we create the path to the lock file instead of duplicating it here and in deleteIfStaleLockfileExists.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486689896", "createdAt": "2020-09-10T23:34:49Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = longPidToNativeByteArray(ProcessHandle.current().pid());\n+\n+  public void lockKeystoreFile(Path keystoreFile) {\n+    deleteIfStaleLockfileExists(keystoreFile);\n+    try {\n+      final Path keystoreLockFile =\n+          Files.write(Path.of(keystoreFile.toString() + \".lock\"), processPID, CREATE_NEW);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85b95cc1e61058eb11f66410acc0fa59a2ae91a1"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEzMDIzOA==", "bodyText": "Makes sense.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r488130238", "createdAt": "2020-09-14T18:15:56Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = longPidToNativeByteArray(ProcessHandle.current().pid());\n+\n+  public void lockKeystoreFile(Path keystoreFile) {\n+    deleteIfStaleLockfileExists(keystoreFile);\n+    try {\n+      final Path keystoreLockFile =\n+          Files.write(Path.of(keystoreFile.toString() + \".lock\"), processPID, CREATE_NEW);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4OTg5Ng=="}, "originalCommit": {"oid": "85b95cc1e61058eb11f66410acc0fa59a2ae91a1"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDMxODcwOnYy", "diffSide": "RIGHT", "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/KeystoreLockerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzo0MTo0MFrOHQJUTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxOTozNjoyMVrOHRjxYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5MTkxOQ==", "bodyText": "Just realised we should be copying this to a temp dir rather than assuming we can write to a file beside the resource - theoretically the tests could be running from inside JAR files and we don't want tests writing to source directories regardless.\nAlso, the keystore doesn't actually have to exist or be valid - it's just a path we're passing to KeystoreLocker.  So just create a temp dir and then point to a non-existent keystore file in that dir (ie <tempdir>/keystore.json but no need for keystore.json to actually exist.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486691919", "createdAt": "2020-09-10T23:41:40Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/KeystoreLockerTest.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+import static org.assertj.core.api.AssertionsForClassTypes.assertThat;\n+import static tech.pegasys.teku.validator.client.loader.KeystoreLocker.deleteIfStaleLockfileExists;\n+import static tech.pegasys.teku.validator.client.loader.KeystoreLocker.longPidToNativeByteArray;\n+\n+import com.google.common.io.Resources;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import org.assertj.core.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLockerTest {\n+\n+  private KeystoreLocker keystoreLocker = new KeystoreLocker();\n+\n+  @Test\n+  void shouldLockKeystoreFileAndFailWhenTryingCreateLockForLockedFile() throws Exception {\n+    final Path keystoreFile = Path.of(Resources.getResource(\"scryptTestVector.json\").toURI());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85b95cc1e61058eb11f66410acc0fa59a2ae91a1"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE3MzkyMg==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r488173922", "createdAt": "2020-09-14T19:36:21Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/KeystoreLockerTest.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+import static org.assertj.core.api.AssertionsForClassTypes.assertThat;\n+import static tech.pegasys.teku.validator.client.loader.KeystoreLocker.deleteIfStaleLockfileExists;\n+import static tech.pegasys.teku.validator.client.loader.KeystoreLocker.longPidToNativeByteArray;\n+\n+import com.google.common.io.Resources;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import org.assertj.core.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLockerTest {\n+\n+  private KeystoreLocker keystoreLocker = new KeystoreLocker();\n+\n+  @Test\n+  void shouldLockKeystoreFileAndFailWhenTryingCreateLockForLockedFile() throws Exception {\n+    final Path keystoreFile = Path.of(Resources.getResource(\"scryptTestVector.json\").toURI());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5MTkxOQ=="}, "originalCommit": {"oid": "85b95cc1e61058eb11f66410acc0fa59a2ae91a1"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDMyNDMyOnYy", "diffSide": "RIGHT", "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/KeystoreLockerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzo0NDo0NVrOHQJXrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxOTozNzozMVrOHRjzwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5Mjc4Mw==", "bodyText": "Just occurred to me that we can use our own PID for a process that's alive which then works on any platform.  And we can then just use KeystoreLocker itself to create the lock file.  Then try to run KeystoreLocker again on the same keystore and it should fail.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486692783", "createdAt": "2020-09-10T23:44:45Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/KeystoreLockerTest.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+import static org.assertj.core.api.AssertionsForClassTypes.assertThat;\n+import static tech.pegasys.teku.validator.client.loader.KeystoreLocker.deleteIfStaleLockfileExists;\n+import static tech.pegasys.teku.validator.client.loader.KeystoreLocker.longPidToNativeByteArray;\n+\n+import com.google.common.io.Resources;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import org.assertj.core.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLockerTest {\n+\n+  private KeystoreLocker keystoreLocker = new KeystoreLocker();\n+\n+  @Test\n+  void shouldLockKeystoreFileAndFailWhenTryingCreateLockForLockedFile() throws Exception {\n+    final Path keystoreFile = Path.of(Resources.getResource(\"scryptTestVector.json\").toURI());\n+    deletePastLockfile(keystoreFile);\n+\n+    Assertions.assertThatCode(() -> keystoreLocker.lockKeystoreFile(keystoreFile))\n+        .doesNotThrowAnyException();\n+    Assertions.assertThatThrownBy(() -> keystoreLocker.lockKeystoreFile(keystoreFile))\n+        .isExactlyInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  void doNotDeleteLockfileIfTheProcessIsAlive() throws Exception {\n+    final Path keystoreFile = Path.of(Resources.getResource(\"lockfileTest1.json\").toURI());\n+    deletePastLockfile(keystoreFile);\n+\n+    Process process = new ProcessBuilder(\"/bin/sleep\", \"5\").start();\n+    long pid = process.pid();\n+    assertThat(process.isAlive()).isTrue();\n+    createLockfileWithContent(keystoreFile, longPidToNativeByteArray(pid));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85b95cc1e61058eb11f66410acc0fa59a2ae91a1"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE3NDUyOA==", "bodyText": "So basically the first and second tests were duplicates. The test you describe was test # 1. So I've deleted # 2.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r488174528", "createdAt": "2020-09-14T19:37:31Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/KeystoreLockerTest.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+import static org.assertj.core.api.AssertionsForClassTypes.assertThat;\n+import static tech.pegasys.teku.validator.client.loader.KeystoreLocker.deleteIfStaleLockfileExists;\n+import static tech.pegasys.teku.validator.client.loader.KeystoreLocker.longPidToNativeByteArray;\n+\n+import com.google.common.io.Resources;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import org.assertj.core.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLockerTest {\n+\n+  private KeystoreLocker keystoreLocker = new KeystoreLocker();\n+\n+  @Test\n+  void shouldLockKeystoreFileAndFailWhenTryingCreateLockForLockedFile() throws Exception {\n+    final Path keystoreFile = Path.of(Resources.getResource(\"scryptTestVector.json\").toURI());\n+    deletePastLockfile(keystoreFile);\n+\n+    Assertions.assertThatCode(() -> keystoreLocker.lockKeystoreFile(keystoreFile))\n+        .doesNotThrowAnyException();\n+    Assertions.assertThatThrownBy(() -> keystoreLocker.lockKeystoreFile(keystoreFile))\n+        .isExactlyInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  void doNotDeleteLockfileIfTheProcessIsAlive() throws Exception {\n+    final Path keystoreFile = Path.of(Resources.getResource(\"lockfileTest1.json\").toURI());\n+    deletePastLockfile(keystoreFile);\n+\n+    Process process = new ProcessBuilder(\"/bin/sleep\", \"5\").start();\n+    long pid = process.pid();\n+    assertThat(process.isAlive()).isTrue();\n+    createLockfileWithContent(keystoreFile, longPidToNativeByteArray(pid));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5Mjc4Mw=="}, "originalCommit": {"oid": "85b95cc1e61058eb11f66410acc0fa59a2ae91a1"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDMyNzEwOnYy", "diffSide": "RIGHT", "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/KeystoreLockerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzo0NjowOFrOHQJZTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxOTozODoxOVrOHRj1VA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5MzE5Ng==", "bodyText": "The delete method should be private and we should just be calling the public lockKeystore method and asserting that it either works or throws an exception.  Then check the file exists with the expected content if it should have created the lock (or that the old content exists if it should have failed).\nCurrently these tests are only checking that the otherwise unused return value is correct - they aren't actually checking the keystore locking really works.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r486693196", "createdAt": "2020-09-10T23:46:08Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/KeystoreLockerTest.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+import static org.assertj.core.api.AssertionsForClassTypes.assertThat;\n+import static tech.pegasys.teku.validator.client.loader.KeystoreLocker.deleteIfStaleLockfileExists;\n+import static tech.pegasys.teku.validator.client.loader.KeystoreLocker.longPidToNativeByteArray;\n+\n+import com.google.common.io.Resources;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import org.assertj.core.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLockerTest {\n+\n+  private KeystoreLocker keystoreLocker = new KeystoreLocker();\n+\n+  @Test\n+  void shouldLockKeystoreFileAndFailWhenTryingCreateLockForLockedFile() throws Exception {\n+    final Path keystoreFile = Path.of(Resources.getResource(\"scryptTestVector.json\").toURI());\n+    deletePastLockfile(keystoreFile);\n+\n+    Assertions.assertThatCode(() -> keystoreLocker.lockKeystoreFile(keystoreFile))\n+        .doesNotThrowAnyException();\n+    Assertions.assertThatThrownBy(() -> keystoreLocker.lockKeystoreFile(keystoreFile))\n+        .isExactlyInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  void doNotDeleteLockfileIfTheProcessIsAlive() throws Exception {\n+    final Path keystoreFile = Path.of(Resources.getResource(\"lockfileTest1.json\").toURI());\n+    deletePastLockfile(keystoreFile);\n+\n+    Process process = new ProcessBuilder(\"/bin/sleep\", \"5\").start();\n+    long pid = process.pid();\n+    assertThat(process.isAlive()).isTrue();\n+    createLockfileWithContent(keystoreFile, longPidToNativeByteArray(pid));\n+    assertThat(deleteIfStaleLockfileExists(keystoreFile)).isFalse();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85b95cc1e61058eb11f66410acc0fa59a2ae91a1"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE3NDkzMg==", "bodyText": "Makes sense. Done.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r488174932", "createdAt": "2020-09-14T19:38:19Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/KeystoreLockerTest.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+import static org.assertj.core.api.AssertionsForClassTypes.assertThat;\n+import static tech.pegasys.teku.validator.client.loader.KeystoreLocker.deleteIfStaleLockfileExists;\n+import static tech.pegasys.teku.validator.client.loader.KeystoreLocker.longPidToNativeByteArray;\n+\n+import com.google.common.io.Resources;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import org.assertj.core.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLockerTest {\n+\n+  private KeystoreLocker keystoreLocker = new KeystoreLocker();\n+\n+  @Test\n+  void shouldLockKeystoreFileAndFailWhenTryingCreateLockForLockedFile() throws Exception {\n+    final Path keystoreFile = Path.of(Resources.getResource(\"scryptTestVector.json\").toURI());\n+    deletePastLockfile(keystoreFile);\n+\n+    Assertions.assertThatCode(() -> keystoreLocker.lockKeystoreFile(keystoreFile))\n+        .doesNotThrowAnyException();\n+    Assertions.assertThatThrownBy(() -> keystoreLocker.lockKeystoreFile(keystoreFile))\n+        .isExactlyInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  void doNotDeleteLockfileIfTheProcessIsAlive() throws Exception {\n+    final Path keystoreFile = Path.of(Resources.getResource(\"lockfileTest1.json\").toURI());\n+    deletePastLockfile(keystoreFile);\n+\n+    Process process = new ProcessBuilder(\"/bin/sleep\", \"5\").start();\n+    long pid = process.pid();\n+    assertThat(process.isAlive()).isTrue();\n+    createLockfileWithContent(keystoreFile, longPidToNativeByteArray(pid));\n+    assertThat(deleteIfStaleLockfileExists(keystoreFile)).isFalse();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5MzE5Ng=="}, "originalCommit": {"oid": "85b95cc1e61058eb11f66410acc0fa59a2ae91a1"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NTE5OTU1OnYy", "diffSide": "RIGHT", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMzo1NDoxNFrOHRrg_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNjowMDowMFrOHS30bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMDc5OQ==", "bodyText": "There's actually a race condition here where the file is deleted between our checking it exists and trying to read it.  We should catch FileNotFoundException explicitly and just return silently because there's no stale file to delete.\nActually there's also a race condition where two processes might be checking the stale file, deleting and creating a new one at the same time as well...  ie both processes see a stale lock file, P1 deletes it and creates its own then P2 deletes that new file and creates its own. Both processes now think they hold the lock.\nThere's no perfect solution to this, but if we took out a FileChannel lock, read the file and deleted all while holding that lock at least two Teku instances wouldn't run into that problem.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r488300799", "createdAt": "2020-09-14T23:54:14Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = getProcessPID();\n+\n+  public void lockKeystore(Path keystoreFile) {\n+    Path lockfilePath = Path.of(keystoreFile.toString() + \".lock\");\n+    deleteIfStaleLockfileExists(lockfilePath);\n+    try {\n+      final Path lockfile = Files.write(lockfilePath, processPID, CREATE_NEW);\n+      lockfile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Unexpected error when trying to lock a keystore file.\", e);\n+    }\n+  }\n+\n+  private static void deleteIfStaleLockfileExists(Path lockfilePath) {\n+    if (!lockfilePath.toFile().exists()) {\n+      return;\n+    }\n+\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(lockfilePath);\n+      if (pidInBytes.length == Long.BYTES) {\n+        long pid = nativeByteArrayToLong(pidInBytes);\n+        Optional<ProcessHandle> processHandle =\n+            ProcessHandle.of(pid).filter(ProcessHandle::isAlive);\n+        if (processHandle.isEmpty()) {\n+          if (!lockfilePath.toFile().delete() && lockfilePath.toFile().exists()) {\n+            LOG.warn(\"Could not delete stale lockfile.\");\n+          }\n+        }\n+      }\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Unexpected error when trying read a keystore lockfile.\", e);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d15391154ad542c4cf78289904451d2ccb519950"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY1OTAwOQ==", "bodyText": "Wouldn't one of the processes fail when trying to create a new one at the same time, with the same name?", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r488659009", "createdAt": "2020-09-15T13:18:04Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = getProcessPID();\n+\n+  public void lockKeystore(Path keystoreFile) {\n+    Path lockfilePath = Path.of(keystoreFile.toString() + \".lock\");\n+    deleteIfStaleLockfileExists(lockfilePath);\n+    try {\n+      final Path lockfile = Files.write(lockfilePath, processPID, CREATE_NEW);\n+      lockfile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Unexpected error when trying to lock a keystore file.\", e);\n+    }\n+  }\n+\n+  private static void deleteIfStaleLockfileExists(Path lockfilePath) {\n+    if (!lockfilePath.toFile().exists()) {\n+      return;\n+    }\n+\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(lockfilePath);\n+      if (pidInBytes.length == Long.BYTES) {\n+        long pid = nativeByteArrayToLong(pidInBytes);\n+        Optional<ProcessHandle> processHandle =\n+            ProcessHandle.of(pid).filter(ProcessHandle::isAlive);\n+        if (processHandle.isEmpty()) {\n+          if (!lockfilePath.toFile().delete() && lockfilePath.toFile().exists()) {\n+            LOG.warn(\"Could not delete stale lockfile.\");\n+          }\n+        }\n+      }\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Unexpected error when trying read a keystore lockfile.\", e);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMDc5OQ=="}, "originalCommit": {"oid": "d15391154ad542c4cf78289904451d2ccb519950"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY3MjU3Nw==", "bodyText": "Turns out that file channel lock won't allow you to delete the file all while holding that lock: https://stackoverflow.com/q/53064571/13391299", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r488672577", "createdAt": "2020-09-15T13:36:07Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = getProcessPID();\n+\n+  public void lockKeystore(Path keystoreFile) {\n+    Path lockfilePath = Path.of(keystoreFile.toString() + \".lock\");\n+    deleteIfStaleLockfileExists(lockfilePath);\n+    try {\n+      final Path lockfile = Files.write(lockfilePath, processPID, CREATE_NEW);\n+      lockfile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Unexpected error when trying to lock a keystore file.\", e);\n+    }\n+  }\n+\n+  private static void deleteIfStaleLockfileExists(Path lockfilePath) {\n+    if (!lockfilePath.toFile().exists()) {\n+      return;\n+    }\n+\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(lockfilePath);\n+      if (pidInBytes.length == Long.BYTES) {\n+        long pid = nativeByteArrayToLong(pidInBytes);\n+        Optional<ProcessHandle> processHandle =\n+            ProcessHandle.of(pid).filter(ProcessHandle::isAlive);\n+        if (processHandle.isEmpty()) {\n+          if (!lockfilePath.toFile().delete() && lockfilePath.toFile().exists()) {\n+            LOG.warn(\"Could not delete stale lockfile.\");\n+          }\n+        }\n+      }\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Unexpected error when trying read a keystore lockfile.\", e);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMDc5OQ=="}, "originalCommit": {"oid": "d15391154ad542c4cf78289904451d2ccb519950"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY3ODQxMA==", "bodyText": "I also tested this and confirmed that is the case.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r488678410", "createdAt": "2020-09-15T13:43:32Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = getProcessPID();\n+\n+  public void lockKeystore(Path keystoreFile) {\n+    Path lockfilePath = Path.of(keystoreFile.toString() + \".lock\");\n+    deleteIfStaleLockfileExists(lockfilePath);\n+    try {\n+      final Path lockfile = Files.write(lockfilePath, processPID, CREATE_NEW);\n+      lockfile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Unexpected error when trying to lock a keystore file.\", e);\n+    }\n+  }\n+\n+  private static void deleteIfStaleLockfileExists(Path lockfilePath) {\n+    if (!lockfilePath.toFile().exists()) {\n+      return;\n+    }\n+\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(lockfilePath);\n+      if (pidInBytes.length == Long.BYTES) {\n+        long pid = nativeByteArrayToLong(pidInBytes);\n+        Optional<ProcessHandle> processHandle =\n+            ProcessHandle.of(pid).filter(ProcessHandle::isAlive);\n+        if (processHandle.isEmpty()) {\n+          if (!lockfilePath.toFile().delete() && lockfilePath.toFile().exists()) {\n+            LOG.warn(\"Could not delete stale lockfile.\");\n+          }\n+        }\n+      }\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Unexpected error when trying read a keystore lockfile.\", e);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMDc5OQ=="}, "originalCommit": {"oid": "d15391154ad542c4cf78289904451d2ccb519950"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY4MDI4MA==", "bodyText": "I've added the explicit catch for the FileNotFoundException for a semi-fix.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r488680280", "createdAt": "2020-09-15T13:45:56Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = getProcessPID();\n+\n+  public void lockKeystore(Path keystoreFile) {\n+    Path lockfilePath = Path.of(keystoreFile.toString() + \".lock\");\n+    deleteIfStaleLockfileExists(lockfilePath);\n+    try {\n+      final Path lockfile = Files.write(lockfilePath, processPID, CREATE_NEW);\n+      lockfile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Unexpected error when trying to lock a keystore file.\", e);\n+    }\n+  }\n+\n+  private static void deleteIfStaleLockfileExists(Path lockfilePath) {\n+    if (!lockfilePath.toFile().exists()) {\n+      return;\n+    }\n+\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(lockfilePath);\n+      if (pidInBytes.length == Long.BYTES) {\n+        long pid = nativeByteArrayToLong(pidInBytes);\n+        Optional<ProcessHandle> processHandle =\n+            ProcessHandle.of(pid).filter(ProcessHandle::isAlive);\n+        if (processHandle.isEmpty()) {\n+          if (!lockfilePath.toFile().delete() && lockfilePath.toFile().exists()) {\n+            LOG.warn(\"Could not delete stale lockfile.\");\n+          }\n+        }\n+      }\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Unexpected error when trying read a keystore lockfile.\", e);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMDc5OQ=="}, "originalCommit": {"oid": "d15391154ad542c4cf78289904451d2ccb519950"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk3MDUzNg==", "bodyText": "Wouldn't one of the processes fail when trying to create a new one at the same time, with the same name?\n\nNo, the sequence would be that both check it's stale, one deletes and recreates, then the other deletes (the new file) and recreates.\nRather than deleting the file while it's stale, we could take a lock and just update the PID in the file. Just remember to get the lock, read and confirm it's stale and then write the new PID.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r488970536", "createdAt": "2020-09-15T21:01:28Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = getProcessPID();\n+\n+  public void lockKeystore(Path keystoreFile) {\n+    Path lockfilePath = Path.of(keystoreFile.toString() + \".lock\");\n+    deleteIfStaleLockfileExists(lockfilePath);\n+    try {\n+      final Path lockfile = Files.write(lockfilePath, processPID, CREATE_NEW);\n+      lockfile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Unexpected error when trying to lock a keystore file.\", e);\n+    }\n+  }\n+\n+  private static void deleteIfStaleLockfileExists(Path lockfilePath) {\n+    if (!lockfilePath.toFile().exists()) {\n+      return;\n+    }\n+\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(lockfilePath);\n+      if (pidInBytes.length == Long.BYTES) {\n+        long pid = nativeByteArrayToLong(pidInBytes);\n+        Optional<ProcessHandle> processHandle =\n+            ProcessHandle.of(pid).filter(ProcessHandle::isAlive);\n+        if (processHandle.isEmpty()) {\n+          if (!lockfilePath.toFile().delete() && lockfilePath.toFile().exists()) {\n+            LOG.warn(\"Could not delete stale lockfile.\");\n+          }\n+        }\n+      }\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Unexpected error when trying read a keystore lockfile.\", e);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMDc5OQ=="}, "originalCommit": {"oid": "d15391154ad542c4cf78289904451d2ccb519950"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU1MDk1Ng==", "bodyText": "Makes sense. Done.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r489550956", "createdAt": "2020-09-16T16:00:00Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = getProcessPID();\n+\n+  public void lockKeystore(Path keystoreFile) {\n+    Path lockfilePath = Path.of(keystoreFile.toString() + \".lock\");\n+    deleteIfStaleLockfileExists(lockfilePath);\n+    try {\n+      final Path lockfile = Files.write(lockfilePath, processPID, CREATE_NEW);\n+      lockfile.toFile().deleteOnExit();\n+    } catch (FileAlreadyExistsException e) {\n+      throw new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Unexpected error when trying to lock a keystore file.\", e);\n+    }\n+  }\n+\n+  private static void deleteIfStaleLockfileExists(Path lockfilePath) {\n+    if (!lockfilePath.toFile().exists()) {\n+      return;\n+    }\n+\n+    try {\n+      byte[] pidInBytes = Files.readAllBytes(lockfilePath);\n+      if (pidInBytes.length == Long.BYTES) {\n+        long pid = nativeByteArrayToLong(pidInBytes);\n+        Optional<ProcessHandle> processHandle =\n+            ProcessHandle.of(pid).filter(ProcessHandle::isAlive);\n+        if (processHandle.isEmpty()) {\n+          if (!lockfilePath.toFile().delete() && lockfilePath.toFile().exists()) {\n+            LOG.warn(\"Could not delete stale lockfile.\");\n+          }\n+        }\n+      }\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Unexpected error when trying read a keystore lockfile.\", e);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMDc5OQ=="}, "originalCommit": {"oid": "d15391154ad542c4cf78289904451d2ccb519950"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NTIyOTYwOnYy", "diffSide": "RIGHT", "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/KeystoreLockerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMDowOToyMFrOHRrypw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMzoxNTozNFrOHSBRTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwNTMxOQ==", "bodyText": "Rather than running an external program and sleeping, I'd suggest just using a really high value (probably Long.MAX_VALUE). Linux defaults to a max PID of 32768 and can only go up to 2^22 so it should be safe enough even if other OS's vary.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r488305319", "createdAt": "2020-09-15T00:09:20Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/KeystoreLockerTest.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static tech.pegasys.teku.validator.client.loader.KeystoreLocker.longPidToNativeByteArray;\n+import static tech.pegasys.teku.validator.client.loader.KeystoreLocker.nativeByteArrayToLong;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import org.assertj.core.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.condition.EnabledOnOs;\n+import org.junit.jupiter.api.condition.OS;\n+import org.junit.jupiter.api.io.TempDir;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLockerTest {\n+\n+  private final KeystoreLocker keystoreLocker = new KeystoreLocker();\n+\n+  @Test\n+  void shouldLockKeystoreFileAndFailWhenTryingCreateLockForLockedFile(\n+      final @TempDir Path keystoreFile) throws Exception {\n+    Assertions.assertThatCode(() -> keystoreLocker.lockKeystore(keystoreFile))\n+        .doesNotThrowAnyException();\n+    Assertions.assertThatThrownBy(() -> keystoreLocker.lockKeystore(keystoreFile))\n+        .isExactlyInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  @EnabledOnOs({OS.LINUX, OS.MAC})\n+  void deleteLockfileIfTheProcessIsNotAlive(final @TempDir Path keystoreFile) throws Exception {\n+    Process process = new ProcessBuilder(\"/bin/sleep\", \"1\").start();\n+    Thread.sleep(1500);\n+    long pid = process.pid();\n+    assertThat(process.isAlive()).isFalse();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d15391154ad542c4cf78289904451d2ccb519950"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY1NzIyOQ==", "bodyText": "Makes sense. Done.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r488657229", "createdAt": "2020-09-15T13:15:34Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/KeystoreLockerTest.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static tech.pegasys.teku.validator.client.loader.KeystoreLocker.longPidToNativeByteArray;\n+import static tech.pegasys.teku.validator.client.loader.KeystoreLocker.nativeByteArrayToLong;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import org.assertj.core.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.condition.EnabledOnOs;\n+import org.junit.jupiter.api.condition.OS;\n+import org.junit.jupiter.api.io.TempDir;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLockerTest {\n+\n+  private final KeystoreLocker keystoreLocker = new KeystoreLocker();\n+\n+  @Test\n+  void shouldLockKeystoreFileAndFailWhenTryingCreateLockForLockedFile(\n+      final @TempDir Path keystoreFile) throws Exception {\n+    Assertions.assertThatCode(() -> keystoreLocker.lockKeystore(keystoreFile))\n+        .doesNotThrowAnyException();\n+    Assertions.assertThatThrownBy(() -> keystoreLocker.lockKeystore(keystoreFile))\n+        .isExactlyInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  @EnabledOnOs({OS.LINUX, OS.MAC})\n+  void deleteLockfileIfTheProcessIsNotAlive(final @TempDir Path keystoreFile) throws Exception {\n+    Process process = new ProcessBuilder(\"/bin/sleep\", \"1\").start();\n+    Thread.sleep(1500);\n+    long pid = process.pid();\n+    assertThat(process.isAlive()).isFalse();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwNTMxOQ=="}, "originalCommit": {"oid": "d15391154ad542c4cf78289904451d2ccb519950"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDcwMDY0OnYy", "diffSide": "RIGHT", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoyMTowMVrOHTHYyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMTowMjo0OFrOHT1b0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwNjAyNg==", "bodyText": "We should be doing all our IO through the FileChannel and need to ensure it and the lock are closed when we're done with it.\nIt's a bit awkward to work with but I think you wind up with:\npublic class KeystoreLocker {\n\n  private static final Logger LOG = LogManager.getLogger();\n  private final byte[] processPID = getProcessPID();\n\n  public void lockKeystore(Path keystoreFile) {\n    Path lockfilePath = Path.of(keystoreFile.toString() + \".lock\");\n    try {\n      if (lockfilePath.toFile().exists()) {\n        attemptReplaceStaleLockFile(lockfilePath);\n      } else {\n        createNewLock(lockfilePath);\n      }\n      lockfilePath.toFile().deleteOnExit();\n    } catch (FileAlreadyExistsException e) {\n      throw keystoreInUseException(keystoreFile);\n    } catch (IOException e) {\n      throw new UncheckedIOException(\"Unexpected error when trying to lock a keystore file.\", e);\n    }\n  }\n\n  public void attemptReplaceStaleLockFile(final Path lockfilePath) throws IOException {\n    try (final FileChannel channel =\n            FileChannel.open(lockfilePath, StandardOpenOption.READ, StandardOpenOption.WRITE);\n        final FileLock lock = channel.tryLock()) {\n      if (lock == null) {\n        // File is already locked, consider it a valid lock\n        throw keystoreInUseException(lockfilePath);\n      }\n      if (channel.size() != Long.BYTES) {\n        throw keystoreInUseException(lockfilePath);\n      }\n      final long pidFromFile = readPidFromFile(channel);\n      if (processIsAlive(pidFromFile)) {\n        throw keystoreInUseException(lockfilePath);\n      }\n\n      LOG.warn(\"Stale PID file for process ID {} detected. Overwriting.\", pidFromFile);\n      channel.write(ByteBuffer.wrap(processPID), 0);\n    } catch (final FileNotFoundException e) {\n      // File doesn't exist so try to create it new\n      createNewLock(lockfilePath);\n    }\n  }\n\n  private Boolean processIsAlive(final long pid) {\n    return ProcessHandle.of(pid).map(ProcessHandle::isAlive).orElse(false);\n  }\n\n  private InvalidConfigurationException keystoreInUseException(final Path keystoreFile) {\n    return new InvalidConfigurationException(\"Keystore file \" + keystoreFile + \" already in use.\");\n  }\n\n  private long readPidFromFile(final FileChannel channel) throws IOException {\n    final ByteBuffer content = ByteBuffer.allocate(Long.BYTES).order(ByteOrder.nativeOrder());\n    channel.read(content, 0);\n    return content.getLong(0);\n  }\n\n  private void createNewLock(final Path lockfilePath) throws IOException {\n    Files.write(lockfilePath, processPID, CREATE_NEW);\n  }\n\n  private static byte[] getProcessPID() {\n    byte[] pidBytes;\n    try {\n      long pid = ProcessHandle.current().pid();\n      pidBytes = longPidToNativeByteArray(pid);\n    } catch (final UnsupportedOperationException e) {\n      LOG.warn(\n          \"Process ID can not be detected. This will inhibit Teku from \"\n              + \"deleting stale validator keystore lockfiles in the future\");\n      pidBytes = new byte[0];\n    }\n    return pidBytes;\n  }\n\n  static byte[] longPidToNativeByteArray(final long pid) {\n    final ByteBuffer buffer = ByteBuffer.allocate(Long.BYTES).order(ByteOrder.nativeOrder());\n    buffer.putLong(pid);\n    return buffer.array();\n  }\n\n  static long nativeByteArrayToLong(final byte[] bytes) {\n    final ByteBuffer readBuffer = ByteBuffer.allocate(Long.BYTES).order(ByteOrder.nativeOrder());\n    readBuffer.put(bytes);\n    return readBuffer.getLong(0);\n  }\n}", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r489806026", "createdAt": "2020-09-16T23:21:01Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+import static java.nio.file.StandardOpenOption.WRITE;\n+\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+import java.nio.channels.FileChannel;\n+import java.nio.channels.FileLock;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = getProcessPID();\n+\n+  public void lockKeystore(Path keystoreFile) {\n+    Path lockfilePath = Path.of(keystoreFile.toString() + \".lock\");\n+    try {\n+      Path lockfile;\n+      if (lockfilePath.toFile().exists()) {\n+        FileLock lockfileLock = FileChannel.open(lockfilePath, WRITE).lock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a050b25bfc25fb836309e9fa9ae0581a2e0fd72e"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQzNDA1MA==", "bodyText": "Okay replaced KeystoreLocker with this. I noticed that we don't release the file lock in attemptReplaceStaleLockFile. Was this on purpose so that we keep the lock on the lockfile until the VM quits?", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r490434050", "createdAt": "2020-09-17T17:27:30Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+import static java.nio.file.StandardOpenOption.WRITE;\n+\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+import java.nio.channels.FileChannel;\n+import java.nio.channels.FileLock;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = getProcessPID();\n+\n+  public void lockKeystore(Path keystoreFile) {\n+    Path lockfilePath = Path.of(keystoreFile.toString() + \".lock\");\n+    try {\n+      Path lockfile;\n+      if (lockfilePath.toFile().exists()) {\n+        FileLock lockfileLock = FileChannel.open(lockfilePath, WRITE).lock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwNjAyNg=="}, "originalCommit": {"oid": "a050b25bfc25fb836309e9fa9ae0581a2e0fd72e"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU2MDQ2Nw==", "bodyText": "We take the lock out in the try-with-resources part so it it automatically closed (released) when we exit the try block along with closing the file channel.", "url": "https://github.com/ConsenSys/teku/pull/2729#discussion_r490560467", "createdAt": "2020-09-17T21:02:48Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/KeystoreLocker.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import static java.nio.file.StandardOpenOption.CREATE_NEW;\n+import static java.nio.file.StandardOpenOption.WRITE;\n+\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+import java.nio.channels.FileChannel;\n+import java.nio.channels.FileLock;\n+import java.nio.file.FileAlreadyExistsException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+\n+public class KeystoreLocker {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final byte[] processPID = getProcessPID();\n+\n+  public void lockKeystore(Path keystoreFile) {\n+    Path lockfilePath = Path.of(keystoreFile.toString() + \".lock\");\n+    try {\n+      Path lockfile;\n+      if (lockfilePath.toFile().exists()) {\n+        FileLock lockfileLock = FileChannel.open(lockfilePath, WRITE).lock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwNjAyNg=="}, "originalCommit": {"oid": "a050b25bfc25fb836309e9fa9ae0581a2e0fd72e"}, "originalPosition": 44}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3370, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}