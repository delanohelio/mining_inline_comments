{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0NzgwODQ5", "number": 2419, "title": "[Issue 2291] Rework fork choice initialization", "bodyText": "PR Description\nUpdate fork choice initialization logic to use async block and state retrieval methods from Store.\nFixed Issue(s)\nPart of #2291\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-07-21T22:33:19Z", "url": "https://github.com/ConsenSys/teku/pull/2419", "merged": true, "mergeCommit": {"oid": "836fbd4f9e32d288fe917620089b029e935376b3"}, "closed": true, "closedAt": "2020-07-22T19:15:06Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3N2y4AH2gAyNDU0NzgwODQ5OjgwZjBlZTA1YWRlYmFkZThhNzhkYzIxZGQwM2QyNWUxNTU4ZmNiODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3fn1YgH2gAyNDU0NzgwODQ5OjgzODE2OTUyNzBiNmVkOTYzMWYyZDk0NTgxYTcwNzc0MWUwODRkMjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "80f0ee05adebade8a78dc21dd03d25e1558fcb81", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/80f0ee05adebade8a78dc21dd03d25e1558fcb81", "committedDate": "2020-07-21T22:20:32Z", "message": "Add method for streaming HashTree nodes in breadth-first order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "addcb26894ee36e6faa303e333a021abc6b629df", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/addcb26894ee36e6faa303e333a021abc6b629df", "committedDate": "2020-07-21T22:20:32Z", "message": "Add Store.getOrderedBlockRoots()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "188399e0b42aa6b645138029b1b51c82ee1a05f0", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/188399e0b42aa6b645138029b1b51c82ee1a05f0", "committedDate": "2020-07-21T22:20:32Z", "message": "Update TestStoreFactory to return MutablePrunableStore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "249192eb936ac2396e3c60e3f58fa8624df28655", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/249192eb936ac2396e3c60e3f58fa8624df28655", "committedDate": "2020-07-21T22:20:32Z", "message": "Fix Store.Transaction.getOrderedBlockRoots()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb3a1c1e0e427bca513a765571a60b0262db2984", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/cb3a1c1e0e427bca513a765571a60b0262db2984", "committedDate": "2020-07-21T22:20:33Z", "message": "Use async block retrieval methods to init ProtoArray"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5490d93cf8fcc4a40b1a3136c8d4a7fa8b188ebf", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/5490d93cf8fcc4a40b1a3136c8d4a7fa8b188ebf", "committedDate": "2020-07-21T22:20:33Z", "message": "Clarify comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyOTM3NDkw", "url": "https://github.com/ConsenSys/teku/pull/2419#pullrequestreview-452937490", "createdAt": "2020-07-22T01:39:04Z", "commit": {"oid": "5490d93cf8fcc4a40b1a3136c8d4a7fa8b188ebf"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMTozOTowNVrOG1PmtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMTozOTowNVrOG1PmtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ4MzM4MA==", "bodyText": "If the blocks are immediately available, do we have a risk of a stack overflow exception here because of the number of chained futures?  I think at worst we'd have 10 epochs worth of blocks held in memory so 320 blocks.\nProbably worth having a test for it, or just deliberately use a thenAcceptAsync variant. Not sure if using the default fork choice pool is sensible here or if we should ensure it goes onto one of the threads own by an AsyncRunner or not (which would require a new method in SafeFuture to support).", "url": "https://github.com/ConsenSys/teku/pull/2419#discussion_r458483380", "createdAt": "2020-07-22T01:39:05Z", "author": {"login": "ajsutton"}, "path": "protoarray/src/main/java/tech/pegasys/teku/protoarray/ProtoArrayForkChoiceStrategy.java", "diffHunk": "@@ -144,27 +145,38 @@ public void maybePrune(Bytes32 finalizedRoot) {\n   }\n \n   // Internal\n-  private static void processBlocksInStoreAtStartup(ReadOnlyStore store, ProtoArray protoArray) {\n+  private static SafeFuture<Void> processBlocksInStoreAtStartup(\n+      PrunableStore store, ProtoArray protoArray) {\n     List<Bytes32> alreadyIncludedBlockRoots =\n         protoArray.getNodes().stream().map(ProtoNode::getBlockRoot).collect(Collectors.toList());\n \n-    store.getBlockRoots().stream()\n-        .filter(root -> !alreadyIncludedBlockRoots.contains(root))\n-        .map(store::getBlock)\n-        .sorted(Comparator.comparing(BeaconBlock::getSlot))\n-        .forEach(block -> processBlockAtStartup(store, protoArray, block));\n+    SafeFuture<Void> future = SafeFuture.completedFuture(null);\n+    for (Bytes32 blockRoot : store.getOrderedBlockRoots()) {\n+      if (alreadyIncludedBlockRoots.contains(blockRoot)) {\n+        continue;\n+      }\n+      future =\n+          future.thenCompose(\n+              __ ->\n+                  store\n+                      .retrieveBlockAndState(blockRoot)\n+                      .thenAccept(\n+                          blockAndState ->\n+                              blockAndState.ifPresent(b -> processBlockAtStartup(protoArray, b))));\n+    }\n+    return future;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5490d93cf8fcc4a40b1a3136c8d4a7fa8b188ebf"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47aed893d1b75c671d2a5bc11cd917895dcb2562", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/47aed893d1b75c671d2a5bc11cd917895dcb2562", "committedDate": "2020-07-22T14:47:52Z", "message": "Remove redundant dependency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4400b9a5c18c6822c071dc1d757ca9814188f18", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f4400b9a5c18c6822c071dc1d757ca9814188f18", "committedDate": "2020-07-22T15:35:41Z", "message": "Move static helper method to a separate class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d0645e9f2d39ac5665be8b104bd4f7aa0f622ee", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/6d0645e9f2d39ac5665be8b104bd4f7aa0f622ee", "committedDate": "2020-07-22T15:54:26Z", "message": "Merge branch 'master' into issue-2291/rework-fork-choice-init"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d38e719d12e6e3bd93bcf75ef07239dc61979cf7", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/d38e719d12e6e3bd93bcf75ef07239dc61979cf7", "committedDate": "2020-07-22T18:45:21Z", "message": "Add test initializing forkChoice with a large number of blocks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c85eef9138a094aea407b65b5fec85679d7d7ee1", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c85eef9138a094aea407b65b5fec85679d7d7ee1", "committedDate": "2020-07-22T18:45:42Z", "message": "Cut unused logger"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNTkzNzg3", "url": "https://github.com/ConsenSys/teku/pull/2419#pullrequestreview-453593787", "createdAt": "2020-07-22T18:50:51Z", "commit": {"oid": "c85eef9138a094aea407b65b5fec85679d7d7ee1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8381695270b6ed9631f2d94581a707741e084d26", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/8381695270b6ed9631f2d94581a707741e084d26", "committedDate": "2020-07-22T19:02:29Z", "message": "Throw if Store is missing blocks at startup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3671, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}