{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5Njg3MTkx", "number": 3409, "title": "Retry ValidatorStatusLogger initial status check until beacon node is ready", "bodyText": "PR Description\nRetry ValidatorStatusLogger initial status check until the beacon node is ready.\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-12-14T17:36:34Z", "url": "https://github.com/ConsenSys/teku/pull/3409", "merged": true, "mergeCommit": {"oid": "8a21fe768c1f30d2df0b3b8742baa0144b4082ab"}, "closed": true, "closedAt": "2020-12-15T19:50:35Z", "author": {"login": "cemozerr"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmJSFDgH2gAyNTM5Njg3MTkxOjRmNzNjOTI2ZDgyYWYxOGYyNjlhYTkwMDQ5NzMxZGI1ZjFiZGYwYTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmfYARAH2gAyNTM5Njg3MTkxOjliOGE5OGU1NDVlYjI5ZWZiNGYyOWM1YTY1MjIwMjgxYTI4ZDJkMDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4f73c926d82af18f269aa90049731db5f1bdf0a2", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/4f73c926d82af18f269aa90049731db5f1bdf0a2", "committedDate": "2020-12-14T17:35:15Z", "message": "Run initial status check until beacon node is ready"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47feab5ab2374c12d330a210038aa1cca0feb239", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/47feab5ab2374c12d330a210038aa1cca0feb239", "committedDate": "2020-12-14T17:48:37Z", "message": "Fix future return value warning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d90ebb5d1dd3f932e7df9bc82b0d4ad259c65d68", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/d90ebb5d1dd3f932e7df9bc82b0d4ad259c65d68", "committedDate": "2020-12-14T17:55:29Z", "message": "Report exceptions at the end of initial validator status check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f80706c7989e5893df8ba337cf35f338d3aa6f0b", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/f80706c7989e5893df8ba337cf35f338d3aa6f0b", "committedDate": "2020-12-14T18:32:22Z", "message": "Add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a55547d5598a70afc07c728fbf2af5ecb2f6bd7", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/3a55547d5598a70afc07c728fbf2af5ecb2f6bd7", "committedDate": "2020-12-14T18:32:54Z", "message": "Supress unchecked warnings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6d0a259d4558be46470794efe886cfcf333d18a", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/d6d0a259d4558be46470794efe886cfcf333d18a", "committedDate": "2020-12-14T18:49:26Z", "message": "Add report exceptions to test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95d9b42de5c83eacb8012ea96c36e3c08fe71ac3", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/95d9b42de5c83eacb8012ea96c36e3c08fe71ac3", "committedDate": "2020-12-14T19:55:35Z", "message": "Merge branch 'master' into fixValidatorStatusLoggerConcurrencyIssue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxODg1MjI4", "url": "https://github.com/ConsenSys/teku/pull/3409#pullrequestreview-551885228", "createdAt": "2020-12-14T20:55:47Z", "commit": {"oid": "95d9b42de5c83eacb8012ea96c36e3c08fe71ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQyMDo1NTo0N1rOIFoWuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQyMDo1NTo0N1rOIFoWuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc3NDk3MQ==", "bodyText": "I recently added a retry utility (AsyncRunner.runWithRetry) that might be useful here.", "url": "https://github.com/ConsenSys/teku/pull/3409#discussion_r542774971", "createdAt": "2020-12-14T20:55:47Z", "author": {"login": "mbaxter"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/DefaultValidatorStatusLogger.java", "diffHunk": "@@ -19,48 +19,66 @@\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n+import java.util.Objects;\n import java.util.Optional;\n+import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.concurrent.atomic.AtomicReference;\n import tech.pegasys.teku.api.response.v1.beacon.ValidatorStatus;\n import tech.pegasys.teku.bls.BLSPublicKey;\n+import tech.pegasys.teku.infrastructure.async.AsyncRunner;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n import tech.pegasys.teku.validator.api.ValidatorApiChannel;\n \n public class DefaultValidatorStatusLogger implements ValidatorStatusLogger {\n \n   private static final int VALIDATOR_KEYS_PRINT_LIMIT = 20;\n+  private static final long INITIAL_STATUS_CHECK_RETRY_PERIOD = 5; // seconds\n \n   final List<BLSPublicKey> validatorPublicKeys;\n   final ValidatorApiChannel validatorApiChannel;\n   final AtomicReference<Map<BLSPublicKey, ValidatorStatus>> latestValidatorStatuses =\n       new AtomicReference<>();\n+  final AsyncRunner asyncRunner;\n \n   public DefaultValidatorStatusLogger(\n-      List<BLSPublicKey> validatorPublicKeys, ValidatorApiChannel validatorApiChannel) {\n+      List<BLSPublicKey> validatorPublicKeys,\n+      ValidatorApiChannel validatorApiChannel,\n+      AsyncRunner asyncRunner) {\n     checkArgument(!validatorPublicKeys.isEmpty());\n     this.validatorPublicKeys = validatorPublicKeys;\n     this.validatorApiChannel = validatorApiChannel;\n+    this.asyncRunner = asyncRunner;\n   }\n \n   @Override\n-  public void printInitialValidatorStatuses() {\n-    validatorApiChannel\n+  public SafeFuture<Void> printInitialValidatorStatuses() {\n+    return validatorApiChannel\n         .getValidatorStatuses(validatorPublicKeys)\n-        .thenAccept(\n+        .thenCompose(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95d9b42de5c83eacb8012ea96c36e3c08fe71ac3"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxODg2MDc0", "url": "https://github.com/ConsenSys/teku/pull/3409#pullrequestreview-551886074", "createdAt": "2020-12-14T20:56:56Z", "commit": {"oid": "95d9b42de5c83eacb8012ea96c36e3c08fe71ac3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "914dfb398c9da8316579c412131116edcabe4660", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/914dfb398c9da8316579c412131116edcabe4660", "committedDate": "2020-12-14T21:26:05Z", "message": "Merge branch 'master' into fixValidatorStatusLoggerConcurrencyIssue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcc1f9d9064ca1d4a56b4870a6a74230b14c9976", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/dcc1f9d9064ca1d4a56b4870a6a74230b14c9976", "committedDate": "2020-12-14T22:39:46Z", "message": "Only keep retrying if the whole request returns empty"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxOTYyMTgw", "url": "https://github.com/ConsenSys/teku/pull/3409#pullrequestreview-551962180", "createdAt": "2020-12-14T22:54:20Z", "commit": {"oid": "dcc1f9d9064ca1d4a56b4870a6a74230b14c9976"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQyMjo1NDoyMFrOIFv-jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQyMjo1Njo0OFrOIFwHzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg5OTg1NA==", "bodyText": "I'm very unclear how we got a ChainDataProvider in here - that should be part of the REST API implementation and the dependency should go the other way around where the providers call into ValidatorApiChannel.  We shouldn't be using the REST API in the internals of Teku like this (ideally that ValidatorResponse class shouldn't be accessible at all from here).  Actually same with ValidatorStatus, it shouldn't be used from here either.\nProbably need to rework this in a follow up PR and get the dependency chain right.", "url": "https://github.com/ConsenSys/teku/pull/3409#discussion_r542899854", "createdAt": "2020-12-14T22:54:20Z", "author": {"login": "ajsutton"}, "path": "validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/ValidatorApiHandler.java", "diffHunk": "@@ -216,20 +216,22 @@ public ValidatorApiHandler(\n   @Override\n   public SafeFuture<Optional<Map<BLSPublicKey, ValidatorStatus>>> getValidatorStatuses(\n       List<BLSPublicKey> validatorIdentifiers) {\n-    return chainDataProvider\n-        .getStateValidators(\n-            \"head\",\n-            validatorIdentifiers.stream().map(BLSPublicKey::toString).collect(toList()),\n-            new HashSet<>())\n-        .thenApply(\n-            (maybeList) ->\n-                maybeList.map(\n-                    list ->\n-                        list.stream()\n-                            .collect(\n-                                toMap(\n-                                    ValidatorResponse::getPublicKey,\n-                                    ValidatorResponse::getStatus))));\n+    return isSyncActive()\n+        ? SafeFuture.completedFuture(Optional.empty())\n+        : chainDataProvider\n+            .getStateValidators(\n+                \"head\",\n+                validatorIdentifiers.stream().map(BLSPublicKey::toString).collect(toList()),\n+                new HashSet<>())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dcc1f9d9064ca1d4a56b4870a6a74230b14c9976"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkwMjIyMQ==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  boolean requestSuccesful = validatorObjects.isPresent();\n          \n          \n            \n                  if (requestSuccesful) {\n          \n          \n            \n                    returnedObjects.putAll(validatorObjects.get());\n          \n          \n            \n                  } else {\n          \n          \n            \n                    return Optional.empty();\n          \n          \n            \n                  }\n          \n          \n            \n                  if (validatorObjects.isEmpty()) {\n          \n          \n            \n                    return Optional.empty();\n          \n          \n            \n                  }\n          \n          \n            \n                  returnedObjects.putAll(validatorObjects.get());", "url": "https://github.com/ConsenSys/teku/pull/3409#discussion_r542902221", "createdAt": "2020-12-14T22:56:48Z", "author": {"login": "ajsutton"}, "path": "validator/remote/src/main/java/tech/pegasys/teku/validator/remote/RemoteValidatorApiHandler.java", "diffHunk": "@@ -100,25 +100,34 @@ public RemoteValidatorApiHandler(\n     if (publicKeys.isEmpty()) {\n       return SafeFuture.completedFuture(emptyMap());\n     }\n-    return sendRequest(() -> makeBatchedValidatorRequest(publicKeys, ValidatorResponse::getIndex));\n+    return sendRequest(\n+        () ->\n+            makeBatchedValidatorRequest(publicKeys, ValidatorResponse::getIndex)\n+                .orElse(emptyMap()));\n   }\n \n   @Override\n   public SafeFuture<Optional<Map<BLSPublicKey, ValidatorStatus>>> getValidatorStatuses(\n       List<BLSPublicKey> publicKeys) {\n-    return sendRequest(\n-        () -> Optional.of(makeBatchedValidatorRequest(publicKeys, ValidatorResponse::getStatus)));\n+    return sendRequest(() -> makeBatchedValidatorRequest(publicKeys, ValidatorResponse::getStatus));\n   }\n \n-  private <T> Map<BLSPublicKey, T> makeBatchedValidatorRequest(\n+  private <T> Optional<Map<BLSPublicKey, T>> makeBatchedValidatorRequest(\n       List<BLSPublicKey> publicKeys, Function<ValidatorResponse, T> valueExtractor) {\n     final Map<BLSPublicKey, T> returnedObjects = new HashMap<>();\n     for (int i = 0; i < publicKeys.size(); i += MAX_PUBLIC_KEY_BATCH_SIZE) {\n       final List<BLSPublicKey> batch =\n           publicKeys.subList(i, Math.min(publicKeys.size(), i + MAX_PUBLIC_KEY_BATCH_SIZE));\n-      requestValidatorObject(batch, valueExtractor).ifPresent(returnedObjects::putAll);\n+      Optional<Map<BLSPublicKey, T>> validatorObjects =\n+          requestValidatorObject(batch, valueExtractor);\n+      boolean requestSuccesful = validatorObjects.isPresent();\n+      if (requestSuccesful) {\n+        returnedObjects.putAll(validatorObjects.get());\n+      } else {\n+        return Optional.empty();\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dcc1f9d9064ca1d4a56b4870a6a74230b14c9976"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7f4e85ac951ff3efdc2412c391320e9cf8ce5b0", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/c7f4e85ac951ff3efdc2412c391320e9cf8ce5b0", "committedDate": "2020-12-15T00:06:55Z", "message": "Merge branch 'master' into fixValidatorStatusLoggerConcurrencyIssue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43971d021cf8c961fb68cef0ca64a27798edfd69", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/43971d021cf8c961fb68cef0ca64a27798edfd69", "committedDate": "2020-12-15T00:07:38Z", "message": "Refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0414c6578aa709f2cc3575a35ed32c4e20a52ee", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/e0414c6578aa709f2cc3575a35ed32c4e20a52ee", "committedDate": "2020-12-15T17:50:22Z", "message": "Do not print validator status changes until logger startup is complete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1047f431edd6d778ebe78dec84722f58a123188f", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/1047f431edd6d778ebe78dec84722f58a123188f", "committedDate": "2020-12-15T18:30:38Z", "message": "Retry validator status check when beacon source event stream is closed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b8a98e545eb29efb4f29c5a65220281a28d2d06", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/9b8a98e545eb29efb4f29c5a65220281a28d2d06", "committedDate": "2020-12-15T19:19:38Z", "message": "Merge branch 'master' into fixValidatorStatusLoggerConcurrencyIssue"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4390, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}