{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExOTQ0MzQ3", "number": 3110, "title": "fix retrieval of validators from beacon state.", "bodyText": "Error codes were returning 500 for any issue, rather than the expected codes (#3105)\n\n\n/eth/v1/state/{state_id}/validators/{validator_id} needed to get the correct state to work from (#3071)\n\n\nFixes #3077\nFixes #3105\nSigned-off-by: Paul Harris paul.harris@consensys.net\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-10-29T01:06:51Z", "url": "https://github.com/ConsenSys/teku/pull/3110", "merged": true, "mergeCommit": {"oid": "4adf5cd8c1958010e4800f8f4d7bfa255c47e40d"}, "closed": true, "closedAt": "2020-10-29T23:39:46Z", "author": {"login": "rolfyone"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXHj-BgH2gAyNTExOTQ0MzQ3OjcwYWJmNTdiZmViMGU0NThhZWM2MmZlNWVmYTQ3YWQ2YTg1OWQ5NGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXasgJAH2gAyNTExOTQ0MzQ3OmQ4NGFjZDQ5Mzc5NmFiYjQ4NWViNmNiMmQwZTQ2YjlkMDMwOWRhZjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "70abf57bfeb0e458aec62fe5efa47ad6a859d94f", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/70abf57bfeb0e458aec62fe5efa47ad6a859d94f", "committedDate": "2020-10-29T01:06:07Z", "message": "fix retrieval of validators from beacon state.\n\n - Error codes were returning 500 for any issue, rather than the expected codes (#3105)\n\n - `/eth/v1/state/{state_id}/validators/{validator_id}` needed to get the correct state to work from (#3071)\n\n Fixes #3071\n Fixes #3105\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e5e6c3f0e6c457d8c4907b035f3747874195880", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/9e5e6c3f0e6c457d8c4907b035f3747874195880", "committedDate": "2020-10-29T01:07:33Z", "message": "Merge remote-tracking branch 'upstream/master' into 3077-validators-from-state"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MjY1NTMw", "url": "https://github.com/ConsenSys/teku/pull/3110#pullrequestreview-519265530", "createdAt": "2020-10-29T01:17:12Z", "commit": {"oid": "9e5e6c3f0e6c457d8c4907b035f3747874195880"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwMToxNzoxMlrOHqDJAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwMToxOTozOVrOHqDNfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg1MzY5OA==", "bodyText": "Maybe rather than having a ValidatorResponse.EMPTY ValidatorResponse.fromState could return an Optional<ValidatorResponse> then this could just flat map?", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r513853698", "createdAt": "2020-10-29T01:17:12Z", "author": {"login": "ajsutton"}, "path": "data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java", "diffHunk": "@@ -617,9 +614,28 @@ public void requireStoreAvailable() {\n     return getValidatorSelector(state, validators)\n         .filter(getStatusPredicate(state, statusFilter))\n         .mapToObj(index -> ValidatorResponse.fromState(state, index))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e5e6c3f0e6c457d8c4907b035f3747874195880"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg1NDQ2NA==", "bodyText": "We throw when the key isn't found or only when it's an invalid key?", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r513854464", "createdAt": "2020-10-29T01:18:53Z", "author": {"login": "ajsutton"}, "path": "data/provider/src/test/java/tech/pegasys/teku/api/ChainDataProviderTest.java", "diffHunk": "@@ -798,6 +798,29 @@ public void filteredValidatorsList_shouldFilterByValidatorPubkey() {\n     assertThat(pubkeys).containsExactly(key);\n   }\n \n+  @Test\n+  public void validatorParameterToIndex_shouldThrowBadRequestExceptionWhenIndexInvalid() {\n+    final ChainDataProvider provider =\n+        new ChainDataProvider(recentChainData, combinedChainDataClient);\n+    assertThrows(BadRequestException.class, () -> provider.validatorParameterToIndex(\"a\"));\n+  }\n+\n+  @Test\n+  public void validatorParameterToIndex_shouldThrowBadRequestExceptionWhenIndexTooHigh() {\n+    final ChainDataProvider provider =\n+        new ChainDataProvider(recentChainData, combinedChainDataClient);\n+    assertThrows(BadRequestException.class, () -> provider.validatorParameterToIndex(\"1024000\"));\n+  }\n+\n+  @Test\n+  public void validatorParameterToIndex_shouldThrowBadRequestExceptionWhenKeyNotFound() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e5e6c3f0e6c457d8c4907b035f3747874195880"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg1NDg0Nw==", "bodyText": "Would be better to check the index is valid ahead of time rather than catching the IndexOutOfBoundsException.", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r513854847", "createdAt": "2020-10-29T01:19:39Z", "author": {"login": "ajsutton"}, "path": "data/serializer/src/main/java/tech/pegasys/teku/api/response/v1/beacon/ValidatorResponse.java", "diffHunk": "@@ -60,14 +63,18 @@ public ValidatorResponse(\n   }\n \n   public static ValidatorResponse fromState(final BeaconState state, final Integer index) {\n-    tech.pegasys.teku.datastructures.state.Validator validatorInternal =\n-        state.getValidators().get(index);\n-    final UInt64 current_epoch = compute_epoch_at_slot(state.getSlot());\n-    return new ValidatorResponse(\n-        UInt64.valueOf(index),\n-        state.getBalances().get(index),\n-        getValidatorStatus(current_epoch, validatorInternal),\n-        new Validator(validatorInternal));\n+    try {\n+      tech.pegasys.teku.datastructures.state.Validator validatorInternal =\n+          state.getValidators().get(index);\n+      final UInt64 current_epoch = compute_epoch_at_slot(state.getSlot());\n+      return new ValidatorResponse(\n+          UInt64.valueOf(index),\n+          state.getBalances().get(index),\n+          getValidatorStatus(current_epoch, validatorInternal),\n+          new Validator(validatorInternal));\n+    } catch (IndexOutOfBoundsException ex) {\n+      return ValidatorResponse.EMPTY;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e5e6c3f0e6c457d8c4907b035f3747874195880"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8221454ea2713d538ba949c11dfe577a55723ea8", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/8221454ea2713d538ba949c11dfe577a55723ea8", "committedDate": "2020-10-29T04:05:30Z", "message": "changes per review feedback. also added handling for invalid Validator Status.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "741b87b5ac0752d25678817e1e8968334eceb856", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/741b87b5ac0752d25678817e1e8968334eceb856", "committedDate": "2020-10-29T04:20:02Z", "message": "Merge remote-tracking branch 'upstream/master' into 3077-validators-from-state"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MzMwMTk5", "url": "https://github.com/ConsenSys/teku/pull/3110#pullrequestreview-519330199", "createdAt": "2020-10-29T04:48:00Z", "commit": {"oid": "741b87b5ac0752d25678817e1e8968334eceb856"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwNDo0ODowMFrOHqJ_3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwNDo0OToyN1rOHqKB_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzk2NjA0NQ==", "bodyText": "nit: this one can just use .flatMap instead of .map as it's not an IntStream.", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r513966045", "createdAt": "2020-10-29T04:48:00Z", "author": {"login": "ajsutton"}, "path": "data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java", "diffHunk": "@@ -562,6 +559,7 @@ public void requireStoreAvailable() {\n       final tech.pegasys.teku.datastructures.state.BeaconState state) {\n     return validatorIndices.stream()\n         .map(index -> ValidatorResponse.fromState(state, index))\n+        .flatMap(Optional::stream)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "741b87b5ac0752d25678817e1e8968334eceb856"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzk2NjU4OQ==", "bodyText": "If this is going to throw an exception if the index is too big then it doesn't need to return Optional because it will never return empty.  I wouldn't have expected a validator index being too big to be a bad request, it's just not found and so the validator wouldn't be included in the results.", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r513966589", "createdAt": "2020-10-29T04:49:27Z", "author": {"login": "ajsutton"}, "path": "data/serializer/src/main/java/tech/pegasys/teku/api/response/v1/beacon/ValidatorResponse.java", "diffHunk": "@@ -59,15 +62,20 @@ public ValidatorResponse(\n     this.validator = validator;\n   }\n \n-  public static ValidatorResponse fromState(final BeaconState state, final Integer index) {\n+  public static Optional<ValidatorResponse> fromState(\n+      final BeaconState state, final Integer index) {\n+    if (index >= state.getValidators().size()) {\n+      throw new BadRequestException(\"Validator index out of bounds: \" + index);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "741b87b5ac0752d25678817e1e8968334eceb856"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0de956eb413fe1b650882e2b4fb18ab915516365", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/0de956eb413fe1b650882e2b4fb18ab915516365", "committedDate": "2020-10-29T07:26:55Z", "message": "review feedback.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f457b2560820cc3fe4b7656d1b1d35c797b3292", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/4f457b2560820cc3fe4b7656d1b1d35c797b3292", "committedDate": "2020-10-29T08:45:13Z", "message": "review feedback.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39878a539cc686caf4c7b2f9a5ebe3132c51d11a", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/39878a539cc686caf4c7b2f9a5ebe3132c51d11a", "committedDate": "2020-10-29T21:25:46Z", "message": "fix missing reference in swagger\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMTQwMTA1", "url": "https://github.com/ConsenSys/teku/pull/3110#pullrequestreview-520140105", "createdAt": "2020-10-29T22:43:26Z", "commit": {"oid": "39878a539cc686caf4c7b2f9a5ebe3132c51d11a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMjo0MzoyNlrOHqxPeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMjo0MzoyNlrOHqxPeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYwOTAxNg==", "bodyText": "This looks like a case where it should result in not found rather than BadRequestException - the index can be parsed but there is no validator at that index. Suspect this should just return Optional.empty which matches the behaviour of a public key not being found and avoids a lot of places needing to check for an index being too large later.", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r514609016", "createdAt": "2020-10-29T22:43:26Z", "author": {"login": "ajsutton"}, "path": "data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java", "diffHunk": "@@ -448,28 +447,26 @@ public void requireStoreAvailable() {\n         BLSPubKey publicKey = BLSPubKey.fromHexString(validatorParameter);\n         return getValidatorIndex(state, publicKey.asBLSPublicKey());\n       } catch (PublicKeyException ex) {\n-        throw new IllegalArgumentException(\n-            String.format(\"Invalid public key: %s\", validatorParameter));\n+        throw new BadRequestException(String.format(\"Invalid public key: %s\", validatorParameter));\n       }\n     } else {\n       try {\n         final UInt64 numericValidator = UInt64.valueOf(validatorParameter);\n         if (numericValidator.isGreaterThan(UInt64.valueOf(Integer.MAX_VALUE))) {\n-          throw new IllegalArgumentException(\n+          throw new BadRequestException(\n               String.format(\"Validator Index is too high to use: %s\", validatorParameter));\n         }\n         final int validatorIndex = numericValidator.intValue();\n         final int validatorCount = state.getValidators().size();\n         if (validatorIndex > validatorCount) {\n-          throw new IllegalArgumentException(\n+          throw new BadRequestException(\n               String.format(\n                   \"Invalid validator index: %d, exceeds validator count: %d\",\n                   validatorIndex, validatorCount));\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39878a539cc686caf4c7b2f9a5ebe3132c51d11a"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15dde65ff19415599df1b103f0ffa5390007253c", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/15dde65ff19415599df1b103f0ffa5390007253c", "committedDate": "2020-10-29T23:20:48Z", "message": "review comments\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d84acd493796abb485eb6cb2d0e46b9d0309daf6", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/d84acd493796abb485eb6cb2d0e46b9d0309daf6", "committedDate": "2020-10-29T23:23:38Z", "message": "Merge remote-tracking branch 'upstream/master' into 3077-validators-from-state"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3285, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}