{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNTA5MjMx", "number": 1233, "title": "Provide a configuration option for dataPath", "bodyText": "Database files are stored under dataPath/db\nAdded a version file to the database path, containing a database version number and initialised it to 1.0\nAbort startup if the database path cannot be created, or if there is a version mis-match of database version.\nAddresses #1216\nSigned-off-by: Paul Harris paul.harris@consensys.net", "createdAt": "2020-02-26T21:12:36Z", "url": "https://github.com/ConsenSys/teku/pull/1233", "merged": true, "mergeCommit": {"oid": "6fc48e3bd7e27199468e3320baa17afd0aa1374f"}, "closed": true, "closedAt": "2020-02-27T03:26:42Z", "author": {"login": "rolfyone"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIM01ngH2gAyMzgwNTA5MjMxOjBmODQwYzI2N2I4OTcwM2UyNzlhZWYzZTRiMTA1OTQyYWQ0NDhkMmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcISrYUgFqTM2NTM5Mjg0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0f840c267b89703e279aef3e4b105942ad448d2a", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/0f840c267b89703e279aef3e4b105942ad448d2a", "committedDate": "2020-02-26T20:34:03Z", "message": "Provide a configuration option for dataPath\n\nDatabase files are stored under dataPath/db\n\nAdded a version file to the database path, containing a database version number and initialised it to 1.0\n\nAbort startup if the database path cannot be created, or if there is a version mis-match of database version.\n\nAddresses\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>\n#1216"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MjcxMzky", "url": "https://github.com/ConsenSys/teku/pull/1233#pullrequestreview-365271392", "createdAt": "2020-02-26T21:54:01Z", "commit": {"oid": "0f840c267b89703e279aef3e4b105942ad448d2a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMTo1NDowMVrOFu9uTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMTo1NjowOVrOFu9yUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5MDA5Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                File databaseStorage = new File(config.getDataPath() + \"/db\");\n          \n          \n            \n                File databaseStoragePath = new File(config.getDataPath() + \"/db\");", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384790092", "createdAt": "2020-02-26T21:54:01Z", "author": {"login": "macfarla"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java", "diffHunk": "@@ -36,8 +36,9 @@\n   private final EventBus eventBus;\n \n   public ChainStorageServer(EventBus eventBus, ArtemisConfiguration config) {\n+    File databaseStorage = new File(config.getDataPath() + \"/db\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f840c267b89703e279aef3e4b105942ad448d2a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5MDQyMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                              \"The database version found (%s) does not meet the expected version(%s).\\n\"\n          \n          \n            \n                              \"The database version found (%s) does not match the expected version(%s).\\n\"", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384790422", "createdAt": "2020-02-26T21:54:46Z", "author": {"login": "macfarla"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -67,15 +73,58 @@\n   private final ConcurrentNavigableMap<UnsignedLong, Set<Bytes32>> hotRootsBySlotCache =\n       new ConcurrentSkipListMap<>();\n \n+  private static void validateDatabaseVersion(File databaseVersionFile) {\n+    try {\n+      if (databaseVersionFile.exists()) {\n+        Scanner contents = new Scanner(databaseVersionFile, UTF_8.name());\n+        String ver = contents.nextLine();\n+        if (StringUtils.isEmpty(ver) || !ver.equals(VERSION)) {\n+          throw new DatabaseStorageException(\n+              String.format(\n+                  \"The database version found (%s) does not meet the expected version(%s).\\n\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f840c267b89703e279aef3e4b105942ad448d2a"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5MTEyMw==", "bodyText": "should we test a different value to \".\"", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384791123", "createdAt": "2020-02-26T21:56:09Z", "author": {"login": "macfarla"}, "path": "util/src/test/java/tech/pegasys/artemis/util/config/ArtemisConfigurationTest.java", "diffHunk": "@@ -74,4 +74,16 @@ void invalidMainnetArtemisConfig() {\n     ArtemisConfiguration config = ArtemisConfiguration.fromString(\"deposit.numValidators=31\");\n     assertThrows(IllegalArgumentException.class, () -> config.validateConfig());\n   }\n+\n+  @Test\n+  void dataPathCanBeSet() {\n+    final ArtemisConfiguration config = ArtemisConfiguration.fromString(\"output.dataPath=\\\".\\\"\");\n+    assertThat(config.getDataPath()).isEqualTo(\".\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f840c267b89703e279aef3e4b105942ad448d2a"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/4ba4f33e18ee6cef96660d045be6ce17a9b65b09", "committedDate": "2020-02-26T22:17:37Z", "message": "Update storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java\n\nCo-Authored-By: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fcaa011057d35abcac60c750e075c2ae6f9ee25", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/1fcaa011057d35abcac60c750e075c2ae6f9ee25", "committedDate": "2020-02-26T22:18:07Z", "message": "Merge remote-tracking branch 'upstream/master' into 1216-configurable-data-directory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f58ea9b073921b27568e73838d7d8ad1bdcdc2e", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/8f58ea9b073921b27568e73838d7d8ad1bdcdc2e", "committedDate": "2020-02-26T22:19:03Z", "message": "Merge branch '1216-configurable-data-directory' of https://github.com/rolfyone/artemis into 1216-configurable-data-directory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fad2064622287ee364c499ea90118f8a83728afc", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/fad2064622287ee364c499ea90118f8a83728afc", "committedDate": "2020-02-26T22:19:44Z", "message": "Update storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java\n\nCo-Authored-By: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58a65f30ef5120770cbf4c5a2595cee45363c8cc", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/58a65f30ef5120770cbf4c5a2595cee45363c8cc", "committedDate": "2020-02-26T22:20:43Z", "message": "fix rename that was done in github\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9760c7d001734c5b5ec3d6f596af56edf693a328", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/9760c7d001734c5b5ec3d6f596af56edf693a328", "committedDate": "2020-02-26T22:20:52Z", "message": "Merge remote-tracking branch 'origin/1216-configurable-data-directory' into 1216-configurable-data-directory"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1Mjg2NDQz", "url": "https://github.com/ConsenSys/teku/pull/1233#pullrequestreview-365286443", "createdAt": "2020-02-26T22:19:23Z", "commit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjoxOToyM1rOFu-d9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjoyNTowNVrOFu-oOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwMjI5NQ==", "bodyText": "This should just return 1 not call System.exit.  PicoCLI treats the returned value as the exit code.\nBut I'm somewhat afraid you're going to tell me it doesn't actually exit...", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384802295", "createdAt": "2020-02-26T22:19:23Z", "author": {"login": "ajsutton"}, "path": "artemis/src/main/java/tech/pegasys/artemis/BeaconNodeCommand.java", "diffHunk": "@@ -78,10 +79,14 @@ public Integer call() {\n                     node.stop();\n                   }));\n       return 0;\n+    } catch (DatabaseStorageException ex) {\n+      System.err.println(ex.getMessage());\n+      System.exit(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwMzEzMw==", "bodyText": "I was expecting that the version number would be in dataPath and then MapDB's stuff would be under /db. I guess that means ChainStorageServer would be responsible for checking the version rather than MapDbDatabase.  That would also fit with the idea that we might migrate from MapDb to some other storage system in the future.", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384803133", "createdAt": "2020-02-26T22:21:18Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java", "diffHunk": "@@ -36,8 +36,9 @@\n   private final EventBus eventBus;\n \n   public ChainStorageServer(EventBus eventBus, ArtemisConfiguration config) {\n+    File databaseStoragePath = new File(config.getDataPath() + \"/db\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwMzQ4Ng==", "bodyText": "Seems weird to explicitly check for empty.  If this is just avoiding nulls you could just use !VERSION.equals(ver).", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384803486", "createdAt": "2020-02-26T22:22:05Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -67,15 +73,58 @@\n   private final ConcurrentNavigableMap<UnsignedLong, Set<Bytes32>> hotRootsBySlotCache =\n       new ConcurrentSkipListMap<>();\n \n+  private static void validateDatabaseVersion(File databaseVersionFile) {\n+    try {\n+      if (databaseVersionFile.exists()) {\n+        Scanner contents = new Scanner(databaseVersionFile, UTF_8.name());\n+        String ver = contents.nextLine();\n+        if (StringUtils.isEmpty(ver) || !ver.equals(VERSION)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNDE0NQ==", "bodyText": "Would Files.readString(databaseVersionFile.toPath()).trim() be simpler?  Would also be slightly stricter by requiring no other content in the file rather than accepting anything that happens to have 1 on the first line.", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384804145", "createdAt": "2020-02-26T22:23:21Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -67,15 +73,58 @@\n   private final ConcurrentNavigableMap<UnsignedLong, Set<Bytes32>> hotRootsBySlotCache =\n       new ConcurrentSkipListMap<>();\n \n+  private static void validateDatabaseVersion(File databaseVersionFile) {\n+    try {\n+      if (databaseVersionFile.exists()) {\n+        Scanner contents = new Scanner(databaseVersionFile, UTF_8.name());\n+        String ver = contents.nextLine();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNDY5MA==", "bodyText": "Files.writeString would be better here.  Otherwise you need to ensure the close is done in a finally block or use try-with-resources to ensure it gets closed even if an exception is thrown.", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384804690", "createdAt": "2020-02-26T22:24:35Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -67,15 +73,58 @@\n   private final ConcurrentNavigableMap<UnsignedLong, Set<Bytes32>> hotRootsBySlotCache =\n       new ConcurrentSkipListMap<>();\n \n+  private static void validateDatabaseVersion(File databaseVersionFile) {\n+    try {\n+      if (databaseVersionFile.exists()) {\n+        Scanner contents = new Scanner(databaseVersionFile, UTF_8.name());\n+        String ver = contents.nextLine();\n+        if (StringUtils.isEmpty(ver) || !ver.equals(VERSION)) {\n+          throw new DatabaseStorageException(\n+              String.format(\n+                  \"The database version found (%s) does not meet the expected version(%s).\\n\"\n+                      + \"Aborting startup to prevent corruption of the database.\\n\",\n+                  ver, VERSION));\n+        }\n+        STDOUT.log(\n+            Level.INFO,\n+            String.format(\n+                \"The existing database is version %s, from file: %s\",\n+                VERSION, databaseVersionFile.getAbsolutePath()));\n+      } else {\n+        STDOUT.log(\n+            Level.INFO,\n+            String.format(\n+                \"Recording database version %s to file: %s\",\n+                VERSION, databaseVersionFile.getAbsolutePath()));\n+        FileWriter fileWriter = new FileWriter(databaseVersionFile.getPath(), UTF_8);\n+        fileWriter.write(VERSION);\n+        fileWriter.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNDkyMw==", "bodyText": "We should indicate which file is not found in the error message.", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384804923", "createdAt": "2020-02-26T22:25:05Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -67,15 +73,58 @@\n   private final ConcurrentNavigableMap<UnsignedLong, Set<Bytes32>> hotRootsBySlotCache =\n       new ConcurrentSkipListMap<>();\n \n+  private static void validateDatabaseVersion(File databaseVersionFile) {\n+    try {\n+      if (databaseVersionFile.exists()) {\n+        Scanner contents = new Scanner(databaseVersionFile, UTF_8.name());\n+        String ver = contents.nextLine();\n+        if (StringUtils.isEmpty(ver) || !ver.equals(VERSION)) {\n+          throw new DatabaseStorageException(\n+              String.format(\n+                  \"The database version found (%s) does not meet the expected version(%s).\\n\"\n+                      + \"Aborting startup to prevent corruption of the database.\\n\",\n+                  ver, VERSION));\n+        }\n+        STDOUT.log(\n+            Level.INFO,\n+            String.format(\n+                \"The existing database is version %s, from file: %s\",\n+                VERSION, databaseVersionFile.getAbsolutePath()));\n+      } else {\n+        STDOUT.log(\n+            Level.INFO,\n+            String.format(\n+                \"Recording database version %s to file: %s\",\n+                VERSION, databaseVersionFile.getAbsolutePath()));\n+        FileWriter fileWriter = new FileWriter(databaseVersionFile.getPath(), UTF_8);\n+        fileWriter.write(VERSION);\n+        fileWriter.close();\n+      }\n+    } catch (FileNotFoundException ex) {\n+      STDOUT.log(Level.ERROR, \"File not found\", ex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e945767761c5e6bc1068de5922158788cde9b9b2", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/e945767761c5e6bc1068de5922158788cde9b9b2", "committedDate": "2020-02-27T01:12:58Z", "message": "changes per review comments, and break out functionality of ChainStorageServer constructor into a start function.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaa02f0d41b3605ebe615a7ca79adef695d1395e", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/aaa02f0d41b3605ebe615a7ca79adef695d1395e", "committedDate": "2020-02-27T01:13:22Z", "message": "Merge remote-tracking branch 'upstream/master' into 1216-configurable-data-directory"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MzkyODQw", "url": "https://github.com/ConsenSys/teku/pull/1233#pullrequestreview-365392840", "createdAt": "2020-02-27T03:23:09Z", "commit": {"oid": "aaa02f0d41b3605ebe615a7ca79adef695d1395e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4114, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}