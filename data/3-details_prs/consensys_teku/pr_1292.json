{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0MDczNDQw", "number": 1292, "title": "Add target peer count range", "bodyText": "PR Description\nConnectionManager now maintains a target range for number of peers to be connected to.  New peers are only connected when the current peer count is below the target range, with enough connection attempts made to reach the top of that range, expecting that some will fail to connect.\nWhen peers subscribe that push us above the target range, we disconnect some to get back down to the range.  We don't currently track peer reputation so an arbitrary peer is picked to disconnect.", "createdAt": "2020-03-05T05:20:42Z", "url": "https://github.com/ConsenSys/teku/pull/1292", "merged": true, "mergeCommit": {"oid": "58d040107637fe021fd521769435c4b57d1af161"}, "closed": true, "closedAt": "2020-03-06T02:03:04Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKkdMuAH2gAyMzg0MDczNDQwOmQ2NWIwODFlNWU2MzgyNTgwYjUxNTYwNDg5ZDgxODQ1NmViMGNkNDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcK2EbTAH2gAyMzg0MDczNDQwOmFmN2M5N2Y0OGM0ZTM5MmUxYTlkMmUwOTA3ZDIzYTNmYzQzY2YzYWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d65b081e5e6382580b51560489d818456eb0cd49", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d65b081e5e6382580b51560489d818456eb0cd49", "committedDate": "2020-03-05T05:13:48Z", "message": "Restrict the number of discovery peers we try to connect to so peer count is maintained within a specific range."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eef7c544edb1ee203487c3dcfe1dc44b919b14af", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/eef7c544edb1ee203487c3dcfe1dc44b919b14af", "committedDate": "2020-03-05T05:20:59Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into peer-limit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd185054b213c3fb5324c97f3e8316426cc0f8de", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/cd185054b213c3fb5324c97f3e8316426cc0f8de", "committedDate": "2020-03-05T21:02:21Z", "message": "Make target peer range configurable."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8fde299512954325cec62486055814c181e6520", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e8fde299512954325cec62486055814c181e6520", "committedDate": "2020-03-05T21:19:01Z", "message": "Aim for the upper bound of peer count range on that basis that disconnects are always successful but connecting to discovered peers is often unsuccessful."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c9039d4a000860ee7c3b677754906f3f49d95f9", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/3c9039d4a000860ee7c3b677754906f3f49d95f9", "committedDate": "2020-03-05T21:19:42Z", "message": "Update test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3532ae29aad70c2ad3476d3d83febedd12dc7de4", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/3532ae29aad70c2ad3476d3d83febedd12dc7de4", "committedDate": "2020-03-05T22:23:50Z", "message": "Add test that we disconnect peers."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "400ae034dc3954191c203e62d3588ef27257e31b", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/400ae034dc3954191c203e62d3588ef27257e31b", "committedDate": "2020-03-05T22:38:09Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into peer-limit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTY5Mjcx", "url": "https://github.com/ConsenSys/teku/pull/1292#pullrequestreview-369969271", "createdAt": "2020-03-05T22:47:34Z", "commit": {"oid": "3532ae29aad70c2ad3476d3d83febedd12dc7de4"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjo0OTo0NFrOFynBLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjo1MTowOVrOFynDbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYxMjM5OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void shouldLimitNumberOfNewConnectionsToKnownPeersOnStartup() {\n          \n          \n            \n              public void shouldLimitNumberOfNewConnectionsToRangeUpperBoundOnStartup() {", "url": "https://github.com/ConsenSys/teku/pull/1292#discussion_r388612398", "createdAt": "2020-03-05T22:49:44Z", "author": {"login": "macfarla"}, "path": "networking/p2p/src/test/java/tech/pegasys/artemis/networking/p2p/discovery/ConnectionManagerTest.java", "diffHunk": "@@ -251,7 +256,92 @@ public void shouldConnectToKnownPeersWhenDiscoverySearchCompletes() {\n     verify(network).connect(discoveryPeer2);\n   }\n \n+  @Test\n+  public void shouldLimitNumberOfNewConnectionsToKnownPeersOnStartup() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "400ae034dc3954191c203e62d3588ef27257e31b"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYxMjU5Ng==", "bodyText": "nit - on first read I took it as limiting the connections to only known peers", "url": "https://github.com/ConsenSys/teku/pull/1292#discussion_r388612596", "createdAt": "2020-03-05T22:50:18Z", "author": {"login": "macfarla"}, "path": "networking/p2p/src/test/java/tech/pegasys/artemis/networking/p2p/discovery/ConnectionManagerTest.java", "diffHunk": "@@ -251,7 +256,92 @@ public void shouldConnectToKnownPeersWhenDiscoverySearchCompletes() {\n     verify(network).connect(discoveryPeer2);\n   }\n \n+  @Test\n+  public void shouldLimitNumberOfNewConnectionsToKnownPeersOnStartup() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYxMjM5OA=="}, "originalCommit": {"oid": "400ae034dc3954191c203e62d3588ef27257e31b"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYxMjk3NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void shouldLimitNumberOfNewConnectionsToKnownPeersOnRetry() {\n          \n          \n            \n              public void shouldLimitNumberOfNewConnectionsToRangeUpperBoundOnRetry() {", "url": "https://github.com/ConsenSys/teku/pull/1292#discussion_r388612974", "createdAt": "2020-03-05T22:51:09Z", "author": {"login": "macfarla"}, "path": "networking/p2p/src/test/java/tech/pegasys/artemis/networking/p2p/discovery/ConnectionManagerTest.java", "diffHunk": "@@ -251,7 +256,92 @@ public void shouldConnectToKnownPeersWhenDiscoverySearchCompletes() {\n     verify(network).connect(discoveryPeer2);\n   }\n \n+  @Test\n+  public void shouldLimitNumberOfNewConnectionsToKnownPeersOnStartup() {\n+    final ConnectionManager manager = createManager(new TargetPeerRange(1, 2));\n+    final DiscoveryPeer discoveryPeer1 = new DiscoveryPeer(Bytes.of(1), new InetSocketAddress(1));\n+    final DiscoveryPeer discoveryPeer2 = new DiscoveryPeer(Bytes.of(2), new InetSocketAddress(2));\n+    final DiscoveryPeer discoveryPeer3 = new DiscoveryPeer(Bytes.of(3), new InetSocketAddress(3));\n+    when(discoveryService.streamKnownPeers())\n+        .thenReturn(Stream.of(discoveryPeer1, discoveryPeer2, discoveryPeer3));\n+    when(network.connect(any(DiscoveryPeer.class))).thenReturn(new SafeFuture<>());\n+\n+    manager.start().join();\n+\n+    verify(network).connect(discoveryPeer1);\n+    verify(network).connect(discoveryPeer2);\n+    verify(network, never()).connect(discoveryPeer3);\n+  }\n+\n+  @Test\n+  public void shouldLimitNumberOfNewConnectionsToKnownPeersOnRetry() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "400ae034dc3954191c203e62d3588ef27257e31b"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50358cdd8393476681dfba8d036695c44af797ee", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/50358cdd8393476681dfba8d036695c44af797ee", "committedDate": "2020-03-06T01:44:30Z", "message": "Clarify test name."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af7c97f48c4e392e1a9d2e0907d23a3fc43cf3af", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/af7c97f48c4e392e1a9d2e0907d23a3fc43cf3af", "committedDate": "2020-03-06T01:45:02Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into peer-limit"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4174, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}