{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5NTIxNjAx", "number": 2825, "title": "[Issue 2273] Validate blocks before importing", "bodyText": "PR Description\nValidate blocks using the WeakSubjectivityValidator before importing: check that blocks are consistent with the weakSubjectivityCheckpoint if such a checkpoint is set.\nFixed Issue(s)\nPart of #2273\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-09-18T20:17:47Z", "url": "https://github.com/ConsenSys/teku/pull/2825", "merged": true, "mergeCommit": {"oid": "7f4d72300c52770185fac27aa7d5182b4b2be8c8"}, "closed": true, "closedAt": "2020-09-21T19:48:57Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKLjJAgBqjM3ODQxMjEwNjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLIeLGAH2gAyNDg5NTIxNjAxOjgyNmFmNDc4MGU1YjExZGZlZWExMTgzY2ZjNjJlMjM2Mzc1NzllMzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a690faa51a4019d7e88891017d526c17a02c990e", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/a690faa51a4019d7e88891017d526c17a02c990e", "committedDate": "2020-09-18T20:09:10Z", "message": "Validate blocks against weakSubjectivity validator before importing"}, "afterCommit": {"oid": "d01b2c5f0a2093963bee14c9ad5b8479ccf8e202", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/d01b2c5f0a2093963bee14c9ad5b8479ccf8e202", "committedDate": "2020-09-18T20:23:24Z", "message": "Validate blocks against weakSubjectivity validator before importing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyODIyMDQz", "url": "https://github.com/ConsenSys/teku/pull/2825#pullrequestreview-492822043", "createdAt": "2020-09-21T17:15:06Z", "commit": {"oid": "52b4055a19665fd9c3c9fe8a28fd441a712ba3b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNzoxNTowNlrOHVav0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNzoxNTowNlrOHVav0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyMDM2OQ==", "bodyText": "nit: It might be nice to log a warning if the chain moved passed the wsCheckpoint since we can't verify it anymore.", "url": "https://github.com/ConsenSys/teku/pull/2825#discussion_r492220369", "createdAt": "2020-09-21T17:15:06Z", "author": {"login": "cemozerr"}, "path": "ethereum/weaksubjectivity/src/main/java/tech/pegasys/teku/weaksubjectivity/WeakSubjectivityValidator.java", "diffHunk": "@@ -68,6 +110,35 @@ public void validateLatestFinalizedCheckpoint(\n     }\n   }\n \n+  public boolean isBlockValid(\n+      final SignedBeaconBlock block, ForkChoiceStrategy forkChoiceStrategy) {\n+    if (maybeWsCheckpoint.isEmpty()) {\n+      return true;\n+    }\n+    final Checkpoint wsCheckpoint = maybeWsCheckpoint.get();\n+\n+    UInt64 blockEpoch = compute_epoch_at_slot(block.getSlot());\n+    boolean blockAtEpochBoundary = compute_start_slot_at_epoch(blockEpoch).equals(block.getSlot());\n+    if (isWSCheckpointEpoch(blockEpoch) && blockAtEpochBoundary) {\n+      // Block is at ws checkpoint slot - so it must match the ws checkpoint block\n+      return isWSCheckpointBlock(block);\n+    } else if (isWSCheckpointBlock(block)) {\n+      // The block is the checkpoint\n+      return true;\n+    } else if (blockEpoch.isGreaterThanOrEqualTo(wsCheckpoint.getEpoch())) {\n+      // If the block is at or past the checkpoint, the wsCheckpoint must be an ancestor\n+      final Optional<Bytes32> ancestor =\n+          get_ancestor(\n+              forkChoiceStrategy, block.getParent_root(), wsCheckpoint.getEpochStartSlot());\n+      // If ancestor is not present, the chain must have moved passed the wsCheckpoint\n+      return ancestor.map(a -> a.equals(wsCheckpoint.getRoot())).orElse(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52b4055a19665fd9c3c9fe8a28fd441a712ba3b1"}, "originalPosition": 122}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyODM4MTc0", "url": "https://github.com/ConsenSys/teku/pull/2825#pullrequestreview-492838174", "createdAt": "2020-09-21T17:36:33Z", "commit": {"oid": "52b4055a19665fd9c3c9fe8a28fd441a712ba3b1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8c0ce46b63e0812fe341c66a4af94b3d7c452a0", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/e8c0ce46b63e0812fe341c66a4af94b3d7c452a0", "committedDate": "2020-09-21T19:16:07Z", "message": "Add method for validating blocks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5a99e61be2690d028f017361d5090d6ae36bdd7", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/d5a99e61be2690d028f017361d5090d6ae36bdd7", "committedDate": "2020-09-21T19:16:07Z", "message": "Validate blocks against weakSubjectivity validator before importing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c753ed17e09b8c029ec79851f1a474493a1af05c", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c753ed17e09b8c029ec79851f1a474493a1af05c", "committedDate": "2020-09-21T19:16:07Z", "message": "Fix tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "52b4055a19665fd9c3c9fe8a28fd441a712ba3b1", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/52b4055a19665fd9c3c9fe8a28fd441a712ba3b1", "committedDate": "2020-09-18T20:37:05Z", "message": "Fix tests"}, "afterCommit": {"oid": "c753ed17e09b8c029ec79851f1a474493a1af05c", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c753ed17e09b8c029ec79851f1a474493a1af05c", "committedDate": "2020-09-21T19:16:07Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "826af4780e5b11dfeea1183cfc62e23637579e38", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/826af4780e5b11dfeea1183cfc62e23637579e38", "committedDate": "2020-09-21T19:22:36Z", "message": "Add test for successful import with ws checks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3448, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}