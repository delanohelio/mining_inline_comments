{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1ODA4NDA4", "number": 2871, "title": "[Issue-2273] Add option to bypass ws checks", "bodyText": "PR Description\nAdd hidden option to suppress weak-subjectivity checks validating that the latest finalized checkpoint is within the weak subjectivity period.  This option can be used to continue syncing in the extreme case where the network fails to finalize for longer than the weak subjectivity period.\nFixed Issue(s)\nPart of #2273\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-09-30T21:49:49Z", "url": "https://github.com/ConsenSys/teku/pull/2871", "merged": true, "mergeCommit": {"oid": "78b4638d2491f6c1fbc91c026897cdcb62d14011"}, "closed": true, "closedAt": "2020-10-05T18:33:26Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdN9xjTgH2gAyNDk1ODA4NDA4OjUyMDMxYmFkNjEyYWM1ZmZlOTc4OGY0NGE4MmM0YzFiMzhiZjg3NWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPnq0bAH2gAyNDk1ODA4NDA4OmMyMDE2N2EzNTYxNGViODNhOTBmMjFmYjgyYmM4YjJjNWM5YTRiNTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "52031bad612ac5ffe9788f44a82c4c1b38bf875c", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/52031bad612ac5ffe9788f44a82c4c1b38bf875c", "committedDate": "2020-09-30T14:36:35Z", "message": "Add hidden CLI option for suppressing ws errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c5ba2d2920eedfb19c658e4b69ad449334bd4f6", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/3c5ba2d2920eedfb19c658e4b69ad449334bd4f6", "committedDate": "2020-09-30T15:27:38Z", "message": "Store config directly in WeakSubjectivityValidator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77f1540ed493eda814777892405c9cc4d8a01979", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/77f1540ed493eda814777892405c9cc4d8a01979", "committedDate": "2020-09-30T18:54:31Z", "message": "Add logic to suppress weak subjectivity period errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f98f5cd74a85496b9dea66fdaa1e26e88093708", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/6f98f5cd74a85496b9dea66fdaa1e26e88093708", "committedDate": "2020-09-30T21:40:31Z", "message": "Fix logic to handle supplied and stored ws config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b57893440dc770eca79f61a567540ef69122d055", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/b57893440dc770eca79f61a567540ef69122d055", "committedDate": "2020-09-30T21:47:05Z", "message": "Fix periodic warning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e909384db31c9bd7b96fb0653e86d8d7f4d5acf", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/9e909384db31c9bd7b96fb0653e86d8d7f4d5acf", "committedDate": "2020-10-01T15:09:05Z", "message": "Clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c70953f734a53e93829f7cdb96bb796ebac3310", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/6c70953f734a53e93829f7cdb96bb796ebac3310", "committedDate": "2020-10-01T15:41:02Z", "message": "Remove comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4a11c20071d7653cdadac6f3845d93ebf10f438", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/e4a11c20071d7653cdadac6f3845d93ebf10f438", "committedDate": "2020-10-02T14:51:51Z", "message": "Merge branch 'master' into issue-2273/add-option-to-bypass-ws-checks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMTU3Nzkw", "url": "https://github.com/ConsenSys/teku/pull/2871#pullrequestreview-502157790", "createdAt": "2020-10-05T15:11:52Z", "commit": {"oid": "e4a11c20071d7653cdadac6f3845d93ebf10f438"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNToxMTo1MlrOHchoiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNToxMTo1MlrOHchoiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY3MzIyNw==", "bodyText": "I'm not quite sure if this warn would be visible in console? If not may be it makes sense to print to console as well?", "url": "https://github.com/ConsenSys/teku/pull/2871#discussion_r499673227", "createdAt": "2020-10-05T15:11:52Z", "author": {"login": "Nashatyrev"}, "path": "ethereum/weaksubjectivity/src/main/java/tech/pegasys/teku/weaksubjectivity/WeakSubjectivityValidator.java", "diffHunk": "@@ -122,35 +125,41 @@ public void validateLatestFinalizedCheckpoint(\n       LOG.debug(\n           \"Latest finalized checkpoint at epoch {} is prior to weak subjectivity checkpoint at epoch {}. Defer validation.\",\n           latestFinalizedCheckpoint.getEpoch(),\n-          maybeWsCheckpoint.orElseThrow().getEpoch());\n+          config.getWeakSubjectivityCheckpoint().orElseThrow().getEpoch());\n       return;\n     }\n \n-    // Determine validity\n-    boolean isValid = true;\n-    if (isAtWSCheckpoint(latestFinalizedCheckpoint)) {\n-      // Roots must match\n-      isValid = isWSCheckpointRoot(latestFinalizedCheckpoint.getRoot());\n+    // Validate against ws checkpoint\n+    if (isAtWSCheckpoint(latestFinalizedCheckpoint)\n+        && !isWSCheckpointRoot(latestFinalizedCheckpoint.getRoot())) {\n+      // Finalized root is inconsistent with ws checkpoint\n+      handleInconsistentWsCheckpoint(latestFinalizedCheckpoint.getBlock());\n     }\n-    isValid = isValid && isWithinWSPeriod(latestFinalizedCheckpoint, currentSlot);\n-\n-    // Handle invalid checkpoint\n-    if (!isValid) {\n-      final int activeValidators =\n-          calculator.getActiveValidators(latestFinalizedCheckpoint.getState());\n-      for (WeakSubjectivityViolationPolicy policy : violationPolicies) {\n-        policy.onFinalizedCheckpointOutsideOfWeakSubjectivityPeriod(\n-            latestFinalizedCheckpoint, activeValidators, currentSlot);\n-      }\n+\n+    // Determine whether we should suppress ws period errors\n+    UInt64 currentEpoch = compute_epoch_at_slot(currentSlot);\n+    final Optional<UInt64> suppressionEpoch = getSuppressWSPeriodChecksUntilEpoch(currentSlot);\n+    final boolean shouldSuppressErrors =\n+        suppressionEpoch.map(e -> e.isGreaterThan(currentEpoch)).orElse(false);\n+\n+    // Validate against ws period\n+    final boolean withinWSPeriod = isWithinWSPeriod(latestFinalizedCheckpoint, currentSlot);\n+    if (!withinWSPeriod && !shouldSuppressErrors) {\n+      handleFinalizedCheckpointOutsideWSPeriod(latestFinalizedCheckpoint, currentSlot);\n+    } else if (!withinWSPeriod\n+        && currentSlot.mod(SUPPRESSION_WARNING_PERIOD_IN_SLOTS).equals(UInt64.ZERO)\n+        && getAndSetLastLoggedSlot(currentSlot).isLessThan(currentSlot)) {\n+      LOG.warn(\n+          \"Suppressing weak subjectivity errors until epoch {}\", suppressionEpoch.orElseThrow());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4a11c20071d7653cdadac6f3845d93ebf10f438"}, "originalPosition": 136}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48a91f563f19a29e9a2a3260f712463c9734275a", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/48a91f563f19a29e9a2a3260f712463c9734275a", "committedDate": "2020-10-05T17:58:49Z", "message": "Send ws error suppression log to console"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c20167a35614eb83a90f21fb82bc8b2c5c9a4b55", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c20167a35614eb83a90f21fb82bc8b2c5c9a4b55", "committedDate": "2020-10-05T17:59:10Z", "message": "Merge branch 'master' into issue-2273/add-option-to-bypass-ws-checks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3471, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}