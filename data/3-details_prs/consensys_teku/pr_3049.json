{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3OTk4MTI5", "number": 3049, "title": "Track peer reputation score during sync", "bodyText": "PR Description\nTrack a reputation score for peers which is adjusted by the multipeer sync process.  Peers are rewarded for providing batches that form part of the chain and penalised for batches that don't match up or are invalid.\nA small reward is applied for each confirmed batch, with a cap on the maximum reputation score a peer can have. This allows peers to build up a limited amount of \"good behaviour credit\" to reduce the likelihood that they will be disconnected because of actions which are unhelpful to us but may result from an honest node's behaviour.\nA small penalty is applied for each batch that is contested - ie when the batch on either side doesn't form a chain with the batch supplied by the peer. The penalty is only small because this could be the honest peer and the other batch was incorrect. From the initial zero score it would take 4 such penalties to be disconnected and 7 small penalties to be disconnected from the maximum reputation cap.\nA large penalty is applied when the peer is known to have provided an invalid batch (e.g. providing a block that fails to import).  From the initial score of zero a single large penalty will disconnect the peer, but two large penalties are required before being disconnected from any positive score.\nFixed Issue(s)\n#1844\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-10-22T04:09:57Z", "url": "https://github.com/ConsenSys/teku/pull/3049", "merged": true, "mergeCommit": {"oid": "2e85af0c962d9e24f40142614b7d317e44e073e6"}, "closed": true, "closedAt": "2020-10-22T20:08:34Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdU52gtgH2gAyNTA3OTk4MTI5OjdmNmU1OWNmNjE1N2EyMTlmYjZmZWI2ZDE2MTU4NGM2NDQ3MGMwYTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVHiePAH2gAyNTA3OTk4MTI5OmVhZjVkZDI4Mjg3NDExNjZlYmYyNjEzNzhlZjBmMjZmM2VlM2FhZmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7f6e59cf6157a219fb6feb6d161584c64470c0a4", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/7f6e59cf6157a219fb6feb6d161584c64470c0a4", "committedDate": "2020-10-22T03:59:51Z", "message": "Track peer reputation score as they are used as part of sync so peers that sending us blocks from the wrong chain wind up being disconnected."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73cb1b43b7b571f83df76c9db0cf85e8cf9a9466", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/73cb1b43b7b571f83df76c9db0cf85e8cf9a9466", "committedDate": "2020-10-22T04:10:08Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into sync-peer-reputation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f6b0769c36ac6784592d96aff775d7dc391eb6d", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/1f6b0769c36ac6784592d96aff775d7dc391eb6d", "committedDate": "2020-10-22T04:20:48Z", "message": "Perform reputation adjustments directly in the peer instead of via Reputationmanager."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b02d2b86bba9c232df56d679cec0169d7d31055", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/2b02d2b86bba9c232df56d679cec0169d7d31055", "committedDate": "2020-10-22T04:28:50Z", "message": "Errorprone."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MzU0NjQ3", "url": "https://github.com/ConsenSys/teku/pull/3049#pullrequestreview-514354647", "createdAt": "2020-10-22T04:42:12Z", "commit": {"oid": "2b02d2b86bba9c232df56d679cec0169d7d31055"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNDo0MjoxMlrOHmQWsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNDo0MjoxMlrOHmQWsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3NTg5MA==", "bodyText": "this peer is then unsuitable until restart, is that a bit harsh? should it just have a 'naughty corner' timeout?", "url": "https://github.com/ConsenSys/teku/pull/3049#discussion_r509875890", "createdAt": "2020-10-22T04:42:12Z", "author": {"login": "rolfyone"}, "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/reputation/ReputationManager.java", "diffHunk": "@@ -121,5 +141,17 @@ private boolean isLocallyConsideredUnsuitable(\n       return locallyInitiated\n           && reason.map(r -> !LOCAL_TEMPORARY_DISCONNECT_REASONS.contains(r)).orElse(false);\n     }\n+\n+    public boolean adjustReputation(final ReputationAdjustment effect) {\n+      final int newScore =\n+          score.updateAndGet(\n+              current -> Math.min(MAX_REPUTATION_SCORE, current + effect.getScoreChange()));\n+      final boolean shouldDisconnect = newScore <= DISCONNECT_THRESHOLD;\n+      if (shouldDisconnect) {\n+        // Prevent our node from connecting out to the remote peer.\n+        unsuitable = true;\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b02d2b86bba9c232df56d679cec0169d7d31055"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MzU1NjMw", "url": "https://github.com/ConsenSys/teku/pull/3049#pullrequestreview-514355630", "createdAt": "2020-10-22T04:45:25Z", "commit": {"oid": "2b02d2b86bba9c232df56d679cec0169d7d31055"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNDo0NToyNlrOHmQZ3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNDo0NToyNlrOHmQZ3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3NjcwMw==", "bodyText": "we create 'shouldDisconnect, set unsuitable to the value of disconnect, return disconnect - maybe just store the value in unsuitable and return that?", "url": "https://github.com/ConsenSys/teku/pull/3049#discussion_r509876703", "createdAt": "2020-10-22T04:45:26Z", "author": {"login": "rolfyone"}, "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/reputation/ReputationManager.java", "diffHunk": "@@ -121,5 +141,17 @@ private boolean isLocallyConsideredUnsuitable(\n       return locallyInitiated\n           && reason.map(r -> !LOCAL_TEMPORARY_DISCONNECT_REASONS.contains(r)).orElse(false);\n     }\n+\n+    public boolean adjustReputation(final ReputationAdjustment effect) {\n+      final int newScore =\n+          score.updateAndGet(\n+              current -> Math.min(MAX_REPUTATION_SCORE, current + effect.getScoreChange()));\n+      final boolean shouldDisconnect = newScore <= DISCONNECT_THRESHOLD;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b02d2b86bba9c232df56d679cec0169d7d31055"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MzU2MDU4", "url": "https://github.com/ConsenSys/teku/pull/3049#pullrequestreview-514356058", "createdAt": "2020-10-22T04:46:54Z", "commit": {"oid": "2b02d2b86bba9c232df56d679cec0169d7d31055"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNDo0Njo1NVrOHmQbYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNDo0Njo1NVrOHmQbYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3NzA4OQ==", "bodyText": "unless we're at 0 reputation, we wont be disconnecting here...", "url": "https://github.com/ConsenSys/teku/pull/3049#discussion_r509877089", "createdAt": "2020-10-22T04:46:55Z", "author": {"login": "rolfyone"}, "path": "sync/src/main/java/tech/pegasys/teku/sync/multipeer/batches/PeerScoringConflictResolutionStrategy.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync.multipeer.batches;\n+\n+import static tech.pegasys.teku.networking.p2p.reputation.ReputationAdjustment.LARGE_PENALTY;\n+import static tech.pegasys.teku.networking.p2p.reputation.ReputationAdjustment.SMALL_PENALTY;\n+import static tech.pegasys.teku.networking.p2p.reputation.ReputationAdjustment.SMALL_REWARD;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.networking.eth2.peers.SyncSource;\n+\n+public class PeerScoringConflictResolutionStrategy implements ConflictResolutionStrategy {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  @Override\n+  public void verifyBatch(final Batch batch, final SyncSource originalSource) {\n+    LOG.debug(\"Invalidating batch {}\", batch);\n+    // We aren't sure if this peer is providing bad blocks or some other peer, so apply a small\n+    // penalty to the peer and re-download the data for the batch. If the peer is honest, it should\n+    // have more confirmed batches than contested and the small penalty to reputation won't matter.\n+    // If it's dishonest the penalties will add up until it is disconnected.\n+    originalSource.adjustReputation(SMALL_PENALTY);\n+    batch.markAsInvalid();\n+  }\n+\n+  @Override\n+  public void reportInvalidBatch(final Batch batch, final SyncSource source) {\n+    LOG.debug(\"Disconnecting peer {} for providing invalid batch data {}\", source, batch);\n+    source.adjustReputation(LARGE_PENALTY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b02d2b86bba9c232df56d679cec0169d7d31055"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MzU2NDQ3", "url": "https://github.com/ConsenSys/teku/pull/3049#pullrequestreview-514356447", "createdAt": "2020-10-22T04:48:12Z", "commit": {"oid": "2b02d2b86bba9c232df56d679cec0169d7d31055"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10b9ba6aba194e554ee059c32fb4baa65c547f6d", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/10b9ba6aba194e554ee059c32fb4baa65c547f6d", "committedDate": "2020-10-22T06:11:12Z", "message": "Fix comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaf5dd2828741166ebf261378ef0f26f3ee3aafe", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/eaf5dd2828741166ebf261378ef0f26f3ee3aafe", "committedDate": "2020-10-22T19:56:38Z", "message": "Merge branch 'master' into sync-peer-reputation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3239, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}