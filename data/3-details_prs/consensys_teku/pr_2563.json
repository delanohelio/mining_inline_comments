{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2NDU4MTIx", "number": 2563, "title": "[issue 2003] added a new option to load keystore files in bulk", "bodyText": "--validator-keys takes a path separated list of paths to allow bulk loading of key files and password files\n\n\neach pair keyDir:passDir (separated by ; on windows)\u00a0 will be loaded as one logical grouping of key and password files.\n\n\nthe file locator looks for json files if a directory was passed in, and matches all json files with a .txt password file in the password path.\n\n\nthe old password file options have been hidden (--validators-key-files, --validators-key-password-files) and will later be superseded by this implementation.\n\n\nFixes #2003\nSigned-off-by: Paul Harris paul.harris@consensys.net\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-08-12T02:09:45Z", "url": "https://github.com/ConsenSys/teku/pull/2563", "merged": true, "mergeCommit": {"oid": "2a6d081394d8b6a859c6e4c01158827b84a6907f"}, "closed": true, "closedAt": "2020-08-13T04:04:02Z", "author": {"login": "rolfyone"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9_4J2gH2gAyNDY2NDU4MTIxOjNlNTljZmU3YTdhN2I2YWY2NjJjM2YxMmMwNDRjMTcwMzk5ODg0ZGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-XyKwAH2gAyNDY2NDU4MTIxOjg0OTFmMTk5NjAzMjU0NGEyMjE1N2NiNDYyM2U3NTIxYWRmY2FlOTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3e59cfe7a7a7b6af662c3f12c044c170399884da", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/3e59cfe7a7a7b6af662c3f12c044c170399884da", "committedDate": "2020-08-12T00:00:49Z", "message": "WIP\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb2b9c9c8ee5c08d4dc3feb699f07036bd4646ff", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/eb2b9c9c8ee5c08d4dc3feb699f07036bd4646ff", "committedDate": "2020-08-12T00:01:07Z", "message": "Merge remote-tracking branch 'upstream/master' into 2003-keys-directory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d2fa560d4e3809ceb6f8c2285befbf0e6cd7cb2", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/7d2fa560d4e3809ceb6f8c2285befbf0e6cd7cb2", "committedDate": "2020-08-12T02:06:43Z", "message": "added a new option to load keystore files in bulk\n\n - `--validator-keys` takes a path separated list of paths to allow bulk loading of key files and password files\n\n - each pair keyDir:passDir (separated by ; on windows)  will be loaded as one logical grouping of key and password files.\n\n - the file locator looks for json files if a directory was passed in, and matches all json files with a .txt password file in the password path.\n\n Fixes #2003\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NTQ1MTQw", "url": "https://github.com/ConsenSys/teku/pull/2563#pullrequestreview-465545140", "createdAt": "2020-08-12T02:11:45Z", "commit": {"oid": "7d2fa560d4e3809ceb6f8c2285befbf0e6cd7cb2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwMjoxMTo0NVrOG_PVIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwMjoxMTo0NVrOG_PVIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk2NDY0Mw==", "bodyText": "@bgravenorst wondering if I could get some help explaining this? It's currently pretty long, and you might have ideas about how i can clean it up", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r468964643", "createdAt": "2020-08-12T02:11:45Z", "author": {"login": "rolfyone"}, "path": "teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java", "diffHunk": "@@ -20,12 +20,25 @@\n import tech.pegasys.teku.util.cli.GraffitiConverter;\n \n public class ValidatorOptions {\n+  @Option(\n+      names = {\"--validator-keys\"},\n+      paramLabel = \"<KEY_PATH>:<PASS_PATH>\",\n+      description =\n+          \"Where KEY_PATH is either a directory or file, and PASS_PATH is the associated password path. \"\n+              + \"keysDir:passDir will find keysDir/**.json, and expect to find passDir/**.txt. \"\n+              + \"keyFile:passFile will expect that the file 'keyFile' exists, \"\n+              + \"and the file containing the password for it is 'passFile'. \"\n+              + \"The path separator is operating system dependent, and should be ';' in windows rather than ':'.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d2fa560d4e3809ceb6f8c2285befbf0e6cd7cb2"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3192baf115162757ee8bda174908001ab04ce807", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/3192baf115162757ee8bda174908001ab04ce807", "committedDate": "2020-08-12T02:58:34Z", "message": "Merge remote-tracking branch 'upstream/master' into 2003-keys-directory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/a2877192f859317636e697c9ca1ec55953e73d71", "committedDate": "2020-08-12T03:59:25Z", "message": "update command line options description.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NTg5Mzkz", "url": "https://github.com/ConsenSys/teku/pull/2563#pullrequestreview-465589393", "createdAt": "2020-08-12T04:52:38Z", "commit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "state": "COMMENTED", "comments": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNDo1MjozOFrOG_RuWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNToyODoyMlrOG_SShg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwMzg2NA==", "bodyText": "Can we initialise this to new ArrayList<>() so that it's always non-null?", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469003864", "createdAt": "2020-08-12T04:52:38Z", "author": {"login": "ajsutton"}, "path": "teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java", "diffHunk": "@@ -20,12 +20,24 @@\n import tech.pegasys.teku.util.cli.GraffitiConverter;\n \n public class ValidatorOptions {\n+  @Option(\n+      names = {\"--validator-keys\"},\n+      paramLabel = \"<KEY_DIR>:<PASS_DIR> | <KEY_FILE>:<PASS_FILE>\",\n+      description =\n+          \"<KEY_DIR>:<PASS_DIR> will find <KEY_DIR>/**.json, and expect to find <PASS_DIR>/**.txt.\\n\"\n+              + \"<KEY_FILE>:<PASS_FILE> will expect that the file <KEY_FILE> exists, \"\n+              + \"and the file containing the password for it is <PASS_FILE>.\\n\"\n+              + \"The path separator is operating system dependent, and should be ';' in windows rather than ':'.\",\n+      split = \",\",\n+      arity = \"1..*\")\n+  private List<String> validatorKeys;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNDIyMQ==", "bodyText": "And can we then make this just take List<String>?  Optional<List> is better avoided unless there's some important difference between empty and not set.", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469004221", "createdAt": "2020-08-12T04:54:08Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/KeyStoreFilesLocator.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import com.google.common.base.Splitter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class KeyStoreFilesLocator {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final List<Pair<Path, Path>> filePairs;\n+  private final Map<Path, Path> pathMap;\n+  private final List<String> colonSeparatedPairs;\n+  private final String pathSeparator;\n+\n+  public KeyStoreFilesLocator(\n+      Optional<List<String>> maybeColonSeparatedPairs, final String pathSeparator) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNTA5OA==", "bodyText": "This isn't using the file separator char correctly.  Suspect we can just drop this check and just use the first instance of the separator to split the parts.  If there are multiple separators it's likely to be rejected because the password isn't found but if it happens to work out that's ok.", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469005098", "createdAt": "2020-08-12T04:57:22Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/KeyStoreFilesLocator.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import com.google.common.base.Splitter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class KeyStoreFilesLocator {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final List<Pair<Path, Path>> filePairs;\n+  private final Map<Path, Path> pathMap;\n+  private final List<String> colonSeparatedPairs;\n+  private final String pathSeparator;\n+\n+  public KeyStoreFilesLocator(\n+      Optional<List<String>> maybeColonSeparatedPairs, final String pathSeparator) {\n+    this.filePairs = new ArrayList<>();\n+    this.colonSeparatedPairs = maybeColonSeparatedPairs.orElse(List.of());\n+    this.pathMap = new HashMap<>();\n+    this.pathSeparator = pathSeparator;\n+  }\n+\n+  public void parse() {\n+    for (final String currentEntry : colonSeparatedPairs) {\n+      if (!currentEntry.contains(pathSeparator)) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") did not contain key and password separated by '\"\n+                + pathSeparator\n+                + \"' as expected.\");\n+      }\n+      if (currentEntry.matches(\".*:.*:.*\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNTUxMw==", "bodyText": "This would then be\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  final List<String> entry = Splitter.on(pathSeparator).splitToList(currentEntry);\n          \n          \n            \n                  parseEntry(entry.get(0), entry.get(1));\n          \n          \n            \n                  final List<String> entry = Splitter.on(pathSeparator).limit(2).splitToList(currentEntry);\n          \n          \n            \n                  parseEntry(entry.get(0), entry.get(1));", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469005513", "createdAt": "2020-08-12T04:58:55Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/KeyStoreFilesLocator.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import com.google.common.base.Splitter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class KeyStoreFilesLocator {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final List<Pair<Path, Path>> filePairs;\n+  private final Map<Path, Path> pathMap;\n+  private final List<String> colonSeparatedPairs;\n+  private final String pathSeparator;\n+\n+  public KeyStoreFilesLocator(\n+      Optional<List<String>> maybeColonSeparatedPairs, final String pathSeparator) {\n+    this.filePairs = new ArrayList<>();\n+    this.colonSeparatedPairs = maybeColonSeparatedPairs.orElse(List.of());\n+    this.pathMap = new HashMap<>();\n+    this.pathSeparator = pathSeparator;\n+  }\n+\n+  public void parse() {\n+    for (final String currentEntry : colonSeparatedPairs) {\n+      if (!currentEntry.contains(pathSeparator)) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") did not contain key and password separated by '\"\n+                + pathSeparator\n+                + \"' as expected.\");\n+      }\n+      if (currentEntry.matches(\".*:.*:.*\")) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") contained more than one '\"\n+                + pathSeparator\n+                + \"', not keyFile'\"\n+                + pathSeparator\n+                + \"'passFile as expected.\");\n+      }\n+      final List<String> entry = Splitter.on(pathSeparator).splitToList(currentEntry);\n+      parseEntry(entry.get(0), entry.get(1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNjA0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      String.format(\"Invalid configuration. could not find the key file (%s).\", keyFileName));\n          \n          \n            \n                      String.format(\"Invalid configuration. Could not find the keystore file (%s).\", keyFileName));", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469006047", "createdAt": "2020-08-12T05:01:05Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/KeyStoreFilesLocator.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import com.google.common.base.Splitter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class KeyStoreFilesLocator {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final List<Pair<Path, Path>> filePairs;\n+  private final Map<Path, Path> pathMap;\n+  private final List<String> colonSeparatedPairs;\n+  private final String pathSeparator;\n+\n+  public KeyStoreFilesLocator(\n+      Optional<List<String>> maybeColonSeparatedPairs, final String pathSeparator) {\n+    this.filePairs = new ArrayList<>();\n+    this.colonSeparatedPairs = maybeColonSeparatedPairs.orElse(List.of());\n+    this.pathMap = new HashMap<>();\n+    this.pathSeparator = pathSeparator;\n+  }\n+\n+  public void parse() {\n+    for (final String currentEntry : colonSeparatedPairs) {\n+      if (!currentEntry.contains(pathSeparator)) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") did not contain key and password separated by '\"\n+                + pathSeparator\n+                + \"' as expected.\");\n+      }\n+      if (currentEntry.matches(\".*:.*:.*\")) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") contained more than one '\"\n+                + pathSeparator\n+                + \"', not keyFile'\"\n+                + pathSeparator\n+                + \"'passFile as expected.\");\n+      }\n+      final List<String> entry = Splitter.on(pathSeparator).splitToList(currentEntry);\n+      parseEntry(entry.get(0), entry.get(1));\n+    }\n+  }\n+\n+  public void parseKeyAndPasswordList(\n+      final List<String> keystoreFiles, final List<String> keystorePasswordFiles) {\n+    for (int i = 0; i < keystoreFiles.size(); i++) {\n+      parseEntry(keystoreFiles.get(i), keystorePasswordFiles.get(i));\n+    }\n+  }\n+\n+  void parseEntry(final String keyFileName, final String passwordFileName) {\n+    final File keyFile = new File(keyFileName);\n+    final File passwordFile = new File(passwordFileName);\n+\n+    if (!keyFile.exists()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\"Invalid configuration. could not find the key file (%s).\", keyFileName));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNjA4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          \"Invalid configuration. could not find the password file (%s).\", passwordFileName));\n          \n          \n            \n                          \"Invalid configuration. Could not find the password file (%s).\", passwordFileName));", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469006082", "createdAt": "2020-08-12T05:01:13Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/KeyStoreFilesLocator.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import com.google.common.base.Splitter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class KeyStoreFilesLocator {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final List<Pair<Path, Path>> filePairs;\n+  private final Map<Path, Path> pathMap;\n+  private final List<String> colonSeparatedPairs;\n+  private final String pathSeparator;\n+\n+  public KeyStoreFilesLocator(\n+      Optional<List<String>> maybeColonSeparatedPairs, final String pathSeparator) {\n+    this.filePairs = new ArrayList<>();\n+    this.colonSeparatedPairs = maybeColonSeparatedPairs.orElse(List.of());\n+    this.pathMap = new HashMap<>();\n+    this.pathSeparator = pathSeparator;\n+  }\n+\n+  public void parse() {\n+    for (final String currentEntry : colonSeparatedPairs) {\n+      if (!currentEntry.contains(pathSeparator)) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") did not contain key and password separated by '\"\n+                + pathSeparator\n+                + \"' as expected.\");\n+      }\n+      if (currentEntry.matches(\".*:.*:.*\")) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") contained more than one '\"\n+                + pathSeparator\n+                + \"', not keyFile'\"\n+                + pathSeparator\n+                + \"'passFile as expected.\");\n+      }\n+      final List<String> entry = Splitter.on(pathSeparator).splitToList(currentEntry);\n+      parseEntry(entry.get(0), entry.get(1));\n+    }\n+  }\n+\n+  public void parseKeyAndPasswordList(\n+      final List<String> keystoreFiles, final List<String> keystorePasswordFiles) {\n+    for (int i = 0; i < keystoreFiles.size(); i++) {\n+      parseEntry(keystoreFiles.get(i), keystorePasswordFiles.get(i));\n+    }\n+  }\n+\n+  void parseEntry(final String keyFileName, final String passwordFileName) {\n+    final File keyFile = new File(keyFileName);\n+    final File passwordFile = new File(passwordFileName);\n+\n+    if (!keyFile.exists()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\"Invalid configuration. could not find the key file (%s).\", keyFileName));\n+    }\n+    if (!passwordFile.exists()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\n+              \"Invalid configuration. could not find the password file (%s).\", passwordFileName));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNjM5Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          \"Invalid configuration. validatorKeys entry (%s\"\n          \n          \n            \n                              + pathSeparator\n          \n          \n            \n                              + \"%s) must be both directories or both files\",\n          \n          \n            \n                          \"Invalid configuration. --validatorKeys entry (%s\"\n          \n          \n            \n                              + pathSeparator\n          \n          \n            \n                              + \"%s) must be both directories or both files.\",", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469006392", "createdAt": "2020-08-12T05:02:30Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/KeyStoreFilesLocator.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import com.google.common.base.Splitter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class KeyStoreFilesLocator {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final List<Pair<Path, Path>> filePairs;\n+  private final Map<Path, Path> pathMap;\n+  private final List<String> colonSeparatedPairs;\n+  private final String pathSeparator;\n+\n+  public KeyStoreFilesLocator(\n+      Optional<List<String>> maybeColonSeparatedPairs, final String pathSeparator) {\n+    this.filePairs = new ArrayList<>();\n+    this.colonSeparatedPairs = maybeColonSeparatedPairs.orElse(List.of());\n+    this.pathMap = new HashMap<>();\n+    this.pathSeparator = pathSeparator;\n+  }\n+\n+  public void parse() {\n+    for (final String currentEntry : colonSeparatedPairs) {\n+      if (!currentEntry.contains(pathSeparator)) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") did not contain key and password separated by '\"\n+                + pathSeparator\n+                + \"' as expected.\");\n+      }\n+      if (currentEntry.matches(\".*:.*:.*\")) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") contained more than one '\"\n+                + pathSeparator\n+                + \"', not keyFile'\"\n+                + pathSeparator\n+                + \"'passFile as expected.\");\n+      }\n+      final List<String> entry = Splitter.on(pathSeparator).splitToList(currentEntry);\n+      parseEntry(entry.get(0), entry.get(1));\n+    }\n+  }\n+\n+  public void parseKeyAndPasswordList(\n+      final List<String> keystoreFiles, final List<String> keystorePasswordFiles) {\n+    for (int i = 0; i < keystoreFiles.size(); i++) {\n+      parseEntry(keystoreFiles.get(i), keystorePasswordFiles.get(i));\n+    }\n+  }\n+\n+  void parseEntry(final String keyFileName, final String passwordFileName) {\n+    final File keyFile = new File(keyFileName);\n+    final File passwordFile = new File(passwordFileName);\n+\n+    if (!keyFile.exists()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\"Invalid configuration. could not find the key file (%s).\", keyFileName));\n+    }\n+    if (!passwordFile.exists()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\n+              \"Invalid configuration. could not find the password file (%s).\", passwordFileName));\n+    }\n+    if (keyFile.isDirectory() != passwordFile.isDirectory()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\n+              \"Invalid configuration. validatorKeys entry (%s\"\n+                  + pathSeparator\n+                  + \"%s) must be both directories or both files\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNjkzMw==", "bodyText": "I'm not sure filePairs is doing anything useful, do we still need it?", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469006933", "createdAt": "2020-08-12T05:04:44Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/KeyStoreFilesLocator.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import com.google.common.base.Splitter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class KeyStoreFilesLocator {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final List<Pair<Path, Path>> filePairs;\n+  private final Map<Path, Path> pathMap;\n+  private final List<String> colonSeparatedPairs;\n+  private final String pathSeparator;\n+\n+  public KeyStoreFilesLocator(\n+      Optional<List<String>> maybeColonSeparatedPairs, final String pathSeparator) {\n+    this.filePairs = new ArrayList<>();\n+    this.colonSeparatedPairs = maybeColonSeparatedPairs.orElse(List.of());\n+    this.pathMap = new HashMap<>();\n+    this.pathSeparator = pathSeparator;\n+  }\n+\n+  public void parse() {\n+    for (final String currentEntry : colonSeparatedPairs) {\n+      if (!currentEntry.contains(pathSeparator)) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") did not contain key and password separated by '\"\n+                + pathSeparator\n+                + \"' as expected.\");\n+      }\n+      if (currentEntry.matches(\".*:.*:.*\")) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") contained more than one '\"\n+                + pathSeparator\n+                + \"', not keyFile'\"\n+                + pathSeparator\n+                + \"'passFile as expected.\");\n+      }\n+      final List<String> entry = Splitter.on(pathSeparator).splitToList(currentEntry);\n+      parseEntry(entry.get(0), entry.get(1));\n+    }\n+  }\n+\n+  public void parseKeyAndPasswordList(\n+      final List<String> keystoreFiles, final List<String> keystorePasswordFiles) {\n+    for (int i = 0; i < keystoreFiles.size(); i++) {\n+      parseEntry(keystoreFiles.get(i), keystorePasswordFiles.get(i));\n+    }\n+  }\n+\n+  void parseEntry(final String keyFileName, final String passwordFileName) {\n+    final File keyFile = new File(keyFileName);\n+    final File passwordFile = new File(passwordFileName);\n+\n+    if (!keyFile.exists()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\"Invalid configuration. could not find the key file (%s).\", keyFileName));\n+    }\n+    if (!passwordFile.exists()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\n+              \"Invalid configuration. could not find the password file (%s).\", passwordFileName));\n+    }\n+    if (keyFile.isDirectory() != passwordFile.isDirectory()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\n+              \"Invalid configuration. validatorKeys entry (%s\"\n+                  + pathSeparator\n+                  + \"%s) must be both directories or both files\",\n+              keyFileName,\n+              passwordFileName));\n+    }\n+    if (keyFile.isFile()) {\n+      pathMap.putIfAbsent(keyFile.toPath(), passwordFile.toPath());\n+      filePairs.add(Pair.of(keyFile.toPath(), passwordFile.toPath()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNzIyNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final List<Pair<Path, Path>> pairs = new ArrayList<>();\n          \n          \n            \n                pathMap.forEach((k, v) -> pairs.add(Pair.of(k, v)));\n          \n          \n            \n                return pairs;\n          \n          \n            \n                return pathMap.entrySet().stream().map(entry -> Pair.of(entry.getKey(), entry.getValue())).collect(toList());", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469007227", "createdAt": "2020-08-12T05:05:52Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/KeyStoreFilesLocator.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import com.google.common.base.Splitter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class KeyStoreFilesLocator {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final List<Pair<Path, Path>> filePairs;\n+  private final Map<Path, Path> pathMap;\n+  private final List<String> colonSeparatedPairs;\n+  private final String pathSeparator;\n+\n+  public KeyStoreFilesLocator(\n+      Optional<List<String>> maybeColonSeparatedPairs, final String pathSeparator) {\n+    this.filePairs = new ArrayList<>();\n+    this.colonSeparatedPairs = maybeColonSeparatedPairs.orElse(List.of());\n+    this.pathMap = new HashMap<>();\n+    this.pathSeparator = pathSeparator;\n+  }\n+\n+  public void parse() {\n+    for (final String currentEntry : colonSeparatedPairs) {\n+      if (!currentEntry.contains(pathSeparator)) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") did not contain key and password separated by '\"\n+                + pathSeparator\n+                + \"' as expected.\");\n+      }\n+      if (currentEntry.matches(\".*:.*:.*\")) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") contained more than one '\"\n+                + pathSeparator\n+                + \"', not keyFile'\"\n+                + pathSeparator\n+                + \"'passFile as expected.\");\n+      }\n+      final List<String> entry = Splitter.on(pathSeparator).splitToList(currentEntry);\n+      parseEntry(entry.get(0), entry.get(1));\n+    }\n+  }\n+\n+  public void parseKeyAndPasswordList(\n+      final List<String> keystoreFiles, final List<String> keystorePasswordFiles) {\n+    for (int i = 0; i < keystoreFiles.size(); i++) {\n+      parseEntry(keystoreFiles.get(i), keystorePasswordFiles.get(i));\n+    }\n+  }\n+\n+  void parseEntry(final String keyFileName, final String passwordFileName) {\n+    final File keyFile = new File(keyFileName);\n+    final File passwordFile = new File(passwordFileName);\n+\n+    if (!keyFile.exists()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\"Invalid configuration. could not find the key file (%s).\", keyFileName));\n+    }\n+    if (!passwordFile.exists()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\n+              \"Invalid configuration. could not find the password file (%s).\", passwordFileName));\n+    }\n+    if (keyFile.isDirectory() != passwordFile.isDirectory()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\n+              \"Invalid configuration. validatorKeys entry (%s\"\n+                  + pathSeparator\n+                  + \"%s) must be both directories or both files\",\n+              keyFileName,\n+              passwordFileName));\n+    }\n+    if (keyFile.isFile()) {\n+      pathMap.putIfAbsent(keyFile.toPath(), passwordFile.toPath());\n+      filePairs.add(Pair.of(keyFile.toPath(), passwordFile.toPath()));\n+    } else {\n+      parseDirectory(keyFile, passwordFile);\n+    }\n+  }\n+\n+  void parseDirectory(final File keyDirectory, final File passwordDirectory) {\n+    final String keyBasePath = keyDirectory.getAbsolutePath();\n+    final String passwordBasePath = passwordDirectory.getAbsolutePath();\n+    try (Stream<Path> walk = Files.walk(keyDirectory.toPath())) {\n+      walk.filter(Files::isRegularFile)\n+          .filter(\n+              (path) ->\n+                  !path.getFileName().toString().startsWith(\".\")\n+                      && path.toString().endsWith(\".json\"))\n+          .forEach(\n+              path -> {\n+                final String keyFilename = path.toAbsolutePath().toString();\n+                final String passwordFileExpectedLocation =\n+                    keyFilename\n+                        .substring(0, keyFilename.length() - 5)\n+                        .replace(keyBasePath, passwordBasePath);\n+                final Optional<File> maybePassFile = findPassFile(passwordFileExpectedLocation);\n+                if (maybePassFile.isEmpty()) {\n+                  throw new InvalidConfigurationException(\n+                      String.format(\n+                          \"Invalid configuration. No matching password file for (%s) in the key path. \"\n+                              + \"For key file 'f.json', expect to see password 'f.txt'.\",\n+                          path.toAbsolutePath().toString()));\n+                }\n+                pathMap.putIfAbsent(path, maybePassFile.get().toPath());\n+              });\n+    } catch (IOException e) {\n+      LOG.fatal(\"Failed to load keys from keystore\", e);\n+    }\n+  }\n+\n+  private Optional<File> findPassFile(final String absolutePassPathWithoutExtension) {\n+    // bin type will be added here soon most likely.\n+    List<String> extensions = List.of(\"txt\");\n+    for (String ext : extensions) {\n+      final File file = new File(absolutePassPathWithoutExtension + \".\" + ext);\n+      if (file.exists() && file.isFile()) {\n+        return Optional.of(file);\n+      }\n+    }\n+    return Optional.empty();\n+  }\n+\n+  public List<Pair<Path, Path>> getFilePairs() {\n+    final List<Pair<Path, Path>> pairs = new ArrayList<>();\n+    pathMap.forEach((k, v) -> pairs.add(Pair.of(k, v)));\n+    return pairs;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 154}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMDA5Ng==", "bodyText": "The example f.json in this message is quite misleading for users. It should list the specific file paths that we attempted to load.", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469010096", "createdAt": "2020-08-12T05:17:00Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/KeyStoreFilesLocator.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import com.google.common.base.Splitter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class KeyStoreFilesLocator {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final List<Pair<Path, Path>> filePairs;\n+  private final Map<Path, Path> pathMap;\n+  private final List<String> colonSeparatedPairs;\n+  private final String pathSeparator;\n+\n+  public KeyStoreFilesLocator(\n+      Optional<List<String>> maybeColonSeparatedPairs, final String pathSeparator) {\n+    this.filePairs = new ArrayList<>();\n+    this.colonSeparatedPairs = maybeColonSeparatedPairs.orElse(List.of());\n+    this.pathMap = new HashMap<>();\n+    this.pathSeparator = pathSeparator;\n+  }\n+\n+  public void parse() {\n+    for (final String currentEntry : colonSeparatedPairs) {\n+      if (!currentEntry.contains(pathSeparator)) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") did not contain key and password separated by '\"\n+                + pathSeparator\n+                + \"' as expected.\");\n+      }\n+      if (currentEntry.matches(\".*:.*:.*\")) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") contained more than one '\"\n+                + pathSeparator\n+                + \"', not keyFile'\"\n+                + pathSeparator\n+                + \"'passFile as expected.\");\n+      }\n+      final List<String> entry = Splitter.on(pathSeparator).splitToList(currentEntry);\n+      parseEntry(entry.get(0), entry.get(1));\n+    }\n+  }\n+\n+  public void parseKeyAndPasswordList(\n+      final List<String> keystoreFiles, final List<String> keystorePasswordFiles) {\n+    for (int i = 0; i < keystoreFiles.size(); i++) {\n+      parseEntry(keystoreFiles.get(i), keystorePasswordFiles.get(i));\n+    }\n+  }\n+\n+  void parseEntry(final String keyFileName, final String passwordFileName) {\n+    final File keyFile = new File(keyFileName);\n+    final File passwordFile = new File(passwordFileName);\n+\n+    if (!keyFile.exists()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\"Invalid configuration. could not find the key file (%s).\", keyFileName));\n+    }\n+    if (!passwordFile.exists()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\n+              \"Invalid configuration. could not find the password file (%s).\", passwordFileName));\n+    }\n+    if (keyFile.isDirectory() != passwordFile.isDirectory()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\n+              \"Invalid configuration. validatorKeys entry (%s\"\n+                  + pathSeparator\n+                  + \"%s) must be both directories or both files\",\n+              keyFileName,\n+              passwordFileName));\n+    }\n+    if (keyFile.isFile()) {\n+      pathMap.putIfAbsent(keyFile.toPath(), passwordFile.toPath());\n+      filePairs.add(Pair.of(keyFile.toPath(), passwordFile.toPath()));\n+    } else {\n+      parseDirectory(keyFile, passwordFile);\n+    }\n+  }\n+\n+  void parseDirectory(final File keyDirectory, final File passwordDirectory) {\n+    final String keyBasePath = keyDirectory.getAbsolutePath();\n+    final String passwordBasePath = passwordDirectory.getAbsolutePath();\n+    try (Stream<Path> walk = Files.walk(keyDirectory.toPath())) {\n+      walk.filter(Files::isRegularFile)\n+          .filter(\n+              (path) ->\n+                  !path.getFileName().toString().startsWith(\".\")\n+                      && path.toString().endsWith(\".json\"))\n+          .forEach(\n+              path -> {\n+                final String keyFilename = path.toAbsolutePath().toString();\n+                final String passwordFileExpectedLocation =\n+                    keyFilename\n+                        .substring(0, keyFilename.length() - 5)\n+                        .replace(keyBasePath, passwordBasePath);\n+                final Optional<File> maybePassFile = findPassFile(passwordFileExpectedLocation);\n+                if (maybePassFile.isEmpty()) {\n+                  throw new InvalidConfigurationException(\n+                      String.format(\n+                          \"Invalid configuration. No matching password file for (%s) in the key path. \"\n+                              + \"For key file 'f.json', expect to see password 'f.txt'.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 129}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMTEzNQ==", "bodyText": "This won't necessarily handle symlinks correctly as toAbsolutePath sometimes returns the resolved path (it's filesystem dependent).\nI think it will have to be:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            final String keyFilename = path.toAbsolutePath().toString();\n          \n          \n            \n                            final String passwordFileExpectedLocation =\n          \n          \n            \n                                keyFilename\n          \n          \n            \n                                    .substring(0, keyFilename.length() - 5)\n          \n          \n            \n                                    .replace(keyBasePath, passwordBasePath);\n          \n          \n            \n                            final Optional<File> maybePassFile = findPassFile(passwordFileExpectedLocation);\n          \n          \n            \n                            final Path relativeDirectoryPath = keyDirectory.toPath().relativize(path.getParent());\n          \n          \n            \n                            final String keystoreName = path.getFileName().toString();\n          \n          \n            \n                            final Path passwordPath =\n          \n          \n            \n                                passwordDirectory\n          \n          \n            \n                                    .toPath()\n          \n          \n            \n                                    .resolve(relativeDirectoryPath)\n          \n          \n            \n                                    .resolve(\n          \n          \n            \n                                        keystoreName.substring(0, keystoreName.length() - \".json\".length()));\n          \n          \n            \n                            final Optional<File> maybePassFile =\n          \n          \n            \n                                findPassFile(passwordPath.toAbsolutePath().toString());", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469011135", "createdAt": "2020-08-12T05:21:05Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/KeyStoreFilesLocator.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import com.google.common.base.Splitter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class KeyStoreFilesLocator {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final List<Pair<Path, Path>> filePairs;\n+  private final Map<Path, Path> pathMap;\n+  private final List<String> colonSeparatedPairs;\n+  private final String pathSeparator;\n+\n+  public KeyStoreFilesLocator(\n+      Optional<List<String>> maybeColonSeparatedPairs, final String pathSeparator) {\n+    this.filePairs = new ArrayList<>();\n+    this.colonSeparatedPairs = maybeColonSeparatedPairs.orElse(List.of());\n+    this.pathMap = new HashMap<>();\n+    this.pathSeparator = pathSeparator;\n+  }\n+\n+  public void parse() {\n+    for (final String currentEntry : colonSeparatedPairs) {\n+      if (!currentEntry.contains(pathSeparator)) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") did not contain key and password separated by '\"\n+                + pathSeparator\n+                + \"' as expected.\");\n+      }\n+      if (currentEntry.matches(\".*:.*:.*\")) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") contained more than one '\"\n+                + pathSeparator\n+                + \"', not keyFile'\"\n+                + pathSeparator\n+                + \"'passFile as expected.\");\n+      }\n+      final List<String> entry = Splitter.on(pathSeparator).splitToList(currentEntry);\n+      parseEntry(entry.get(0), entry.get(1));\n+    }\n+  }\n+\n+  public void parseKeyAndPasswordList(\n+      final List<String> keystoreFiles, final List<String> keystorePasswordFiles) {\n+    for (int i = 0; i < keystoreFiles.size(); i++) {\n+      parseEntry(keystoreFiles.get(i), keystorePasswordFiles.get(i));\n+    }\n+  }\n+\n+  void parseEntry(final String keyFileName, final String passwordFileName) {\n+    final File keyFile = new File(keyFileName);\n+    final File passwordFile = new File(passwordFileName);\n+\n+    if (!keyFile.exists()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\"Invalid configuration. could not find the key file (%s).\", keyFileName));\n+    }\n+    if (!passwordFile.exists()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\n+              \"Invalid configuration. could not find the password file (%s).\", passwordFileName));\n+    }\n+    if (keyFile.isDirectory() != passwordFile.isDirectory()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\n+              \"Invalid configuration. validatorKeys entry (%s\"\n+                  + pathSeparator\n+                  + \"%s) must be both directories or both files\",\n+              keyFileName,\n+              passwordFileName));\n+    }\n+    if (keyFile.isFile()) {\n+      pathMap.putIfAbsent(keyFile.toPath(), passwordFile.toPath());\n+      filePairs.add(Pair.of(keyFile.toPath(), passwordFile.toPath()));\n+    } else {\n+      parseDirectory(keyFile, passwordFile);\n+    }\n+  }\n+\n+  void parseDirectory(final File keyDirectory, final File passwordDirectory) {\n+    final String keyBasePath = keyDirectory.getAbsolutePath();\n+    final String passwordBasePath = passwordDirectory.getAbsolutePath();\n+    try (Stream<Path> walk = Files.walk(keyDirectory.toPath())) {\n+      walk.filter(Files::isRegularFile)\n+          .filter(\n+              (path) ->\n+                  !path.getFileName().toString().startsWith(\".\")\n+                      && path.toString().endsWith(\".json\"))\n+          .forEach(\n+              path -> {\n+                final String keyFilename = path.toAbsolutePath().toString();\n+                final String passwordFileExpectedLocation =\n+                    keyFilename\n+                        .substring(0, keyFilename.length() - 5)\n+                        .replace(keyBasePath, passwordBasePath);\n+                final Optional<File> maybePassFile = findPassFile(passwordFileExpectedLocation);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMTU0MA==", "bodyText": "I'd remove this comment while you're passing through here (it would be the next 6 options that moved anyway and the TODO is just not useful).", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469011540", "createdAt": "2020-08-12T05:22:40Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/TekuConfiguration.java", "diffHunk": "@@ -67,6 +67,7 @@\n   // TODO (#1918): The following two options will eventually be moved to the validator subcommand", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMTg1MA==", "bodyText": "Minor thing but since we're going to need to manipulate the filename later I'd make this:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                  && path.toString().endsWith(\".json\"))\n          \n          \n            \n                                  && getFileName().toString().endsWith(\".json\"))", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469011850", "createdAt": "2020-08-12T05:23:50Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/KeyStoreFilesLocator.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import com.google.common.base.Splitter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class KeyStoreFilesLocator {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final List<Pair<Path, Path>> filePairs;\n+  private final Map<Path, Path> pathMap;\n+  private final List<String> colonSeparatedPairs;\n+  private final String pathSeparator;\n+\n+  public KeyStoreFilesLocator(\n+      Optional<List<String>> maybeColonSeparatedPairs, final String pathSeparator) {\n+    this.filePairs = new ArrayList<>();\n+    this.colonSeparatedPairs = maybeColonSeparatedPairs.orElse(List.of());\n+    this.pathMap = new HashMap<>();\n+    this.pathSeparator = pathSeparator;\n+  }\n+\n+  public void parse() {\n+    for (final String currentEntry : colonSeparatedPairs) {\n+      if (!currentEntry.contains(pathSeparator)) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") did not contain key and password separated by '\"\n+                + pathSeparator\n+                + \"' as expected.\");\n+      }\n+      if (currentEntry.matches(\".*:.*:.*\")) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") contained more than one '\"\n+                + pathSeparator\n+                + \"', not keyFile'\"\n+                + pathSeparator\n+                + \"'passFile as expected.\");\n+      }\n+      final List<String> entry = Splitter.on(pathSeparator).splitToList(currentEntry);\n+      parseEntry(entry.get(0), entry.get(1));\n+    }\n+  }\n+\n+  public void parseKeyAndPasswordList(\n+      final List<String> keystoreFiles, final List<String> keystorePasswordFiles) {\n+    for (int i = 0; i < keystoreFiles.size(); i++) {\n+      parseEntry(keystoreFiles.get(i), keystorePasswordFiles.get(i));\n+    }\n+  }\n+\n+  void parseEntry(final String keyFileName, final String passwordFileName) {\n+    final File keyFile = new File(keyFileName);\n+    final File passwordFile = new File(passwordFileName);\n+\n+    if (!keyFile.exists()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\"Invalid configuration. could not find the key file (%s).\", keyFileName));\n+    }\n+    if (!passwordFile.exists()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\n+              \"Invalid configuration. could not find the password file (%s).\", passwordFileName));\n+    }\n+    if (keyFile.isDirectory() != passwordFile.isDirectory()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\n+              \"Invalid configuration. validatorKeys entry (%s\"\n+                  + pathSeparator\n+                  + \"%s) must be both directories or both files\",\n+              keyFileName,\n+              passwordFileName));\n+    }\n+    if (keyFile.isFile()) {\n+      pathMap.putIfAbsent(keyFile.toPath(), passwordFile.toPath());\n+      filePairs.add(Pair.of(keyFile.toPath(), passwordFile.toPath()));\n+    } else {\n+      parseDirectory(keyFile, passwordFile);\n+    }\n+  }\n+\n+  void parseDirectory(final File keyDirectory, final File passwordDirectory) {\n+    final String keyBasePath = keyDirectory.getAbsolutePath();\n+    final String passwordBasePath = passwordDirectory.getAbsolutePath();\n+    try (Stream<Path> walk = Files.walk(keyDirectory.toPath())) {\n+      walk.filter(Files::isRegularFile)\n+          .filter(\n+              (path) ->\n+                  !path.getFileName().toString().startsWith(\".\")\n+                      && path.toString().endsWith(\".json\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMjQxOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    new File(String.format(\"%s/%s\", tempStr, k)).toPath(),\n          \n          \n            \n                    new File(String.format(\"%s/%s\", tempStr, p)).toPath());\n          \n          \n            \n                    new File(tempStr, k).toPath(),\n          \n          \n            \n                    new File(tempStr, p).toPath());", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469012418", "createdAt": "2020-08-12T05:25:43Z", "author": {"login": "ajsutton"}, "path": "util/src/test/java/tech/pegasys/teku/util/config/KeyStoreFilesLocatorTest.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+import java.util.Optional;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+public class KeyStoreFilesLocatorTest {\n+  @Test\n+  public void shouldFindPairsAtDepth(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key/1/2/3\", \"pass/1/2/3\");\n+    createFiles(tempDir, \"key/a.json\", \"pass/a.txt\", \"key/1/2/3/b.json\", \"pass/1/2/3/b.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key:%s/pass\", tempStr, tempStr))), \":\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs())\n+        .containsExactlyInAnyOrder(\n+            tuple(tempStr, \"key/a.json\", \"pass/a.txt\"),\n+            tuple(tempStr, \"key/1/2/3/b.json\", \"pass/1/2/3/b.txt\"));\n+  }\n+\n+  @Test\n+  public void shouldFindMissingPasswordAtDepth(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key/1/2/3\", \"pass/1/2/3\");\n+    createFiles(tempDir, \"key/a.json\", \"pass/a.txt\", \"key/1/2/3/b.json\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key:%s/pass\", tempStr, tempStr))), \":\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldFindKeyPairOfFiles(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\", \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a;%s/pass/a.txt\", tempStr, tempStr))), \";\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs()).containsExactly(tuple(tempStr, \"key/a\", \"pass/a.txt\"));\n+  }\n+\n+  @Test\n+  public void shouldIgnoreSomeFiles(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(\n+        tempDir, \"key/.asdf.json\", \"key/.hidden2\", \"key/ignored\", \"key/a.json\", \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key;%s/pass\", tempStr, tempStr))), \";\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs()).containsExactly(tuple(tempStr, \"key/a.json\", \"pass/a.txt\"));\n+  }\n+\n+  @Test\n+  public void shouldHandleFilesAndFoldersInOneArgument(@TempDir final Path tempDir)\n+      throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\", \"pass/a.txt\", \"keyStore\", \"password\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(\n+                List.of(\n+                    String.format(\"%s/key/a:%s/pass/a.txt\", tempStr, tempStr),\n+                    String.format(\"%s/keyStore:%s/password\", tempStr, tempStr))),\n+            \":\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs().size()).isEqualTo(2);\n+  }\n+\n+  @Test\n+  public void shouldDetectMissingPasswordFileWhenDirectoryIsPresent(@TempDir final Path tempDir)\n+      throws IOException {\n+    createFolders(tempDir, \"key\", \"pass/a.txt\");\n+    createFiles(tempDir, \"key/a\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a;%s/pass/a.txt\", tempStr, tempStr))), \";\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldDetectMissingPasswordFile(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a:%s/pass/a.txt\", tempStr, tempStr))), \":\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldDetectMissingKeyFile(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a:%s/pass/a.txt\", tempStr, tempStr))), \":\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldSucceedCallingParseOnEmptyList() {\n+    KeyStoreFilesLocator locator = new KeyStoreFilesLocator(Optional.empty(), \":\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs()).isEmpty();\n+  }\n+\n+  @Test\n+  public void shouldHandleOldArgs(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\", \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator = new KeyStoreFilesLocator(Optional.empty(), \":\");\n+    locator.parseKeyAndPasswordList(List.of(tempStr + \"/key/a\"), List.of(tempStr + \"/pass/a.txt\"));\n+    assertThat(locator.getFilePairs())\n+        .containsExactly(tuple(tempDir.toString(), \"key/a\", \"pass/a.txt\"));\n+  }\n+\n+  private void createFolders(final Path tempDir, String... paths) {\n+    for (String path : paths) {\n+      File file = new File(tempDir.toString() + File.separator + path);\n+      file.mkdirs();\n+    }\n+  }\n+\n+  private void createFiles(final Path tempDir, String... paths) throws IOException {\n+    for (String path : paths) {\n+      File file = new File(tempDir.toString() + File.separator + path);\n+      file.createNewFile();\n+    }\n+  }\n+\n+  private Pair<Path, Path> tuple(final String tempStr, final String k, final String p) {\n+    return Pair.of(\n+        new File(String.format(\"%s/%s\", tempStr, k)).toPath(),\n+        new File(String.format(\"%s/%s\", tempStr, p)).toPath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 166}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMjU3Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  File file = new File(tempDir.toString() + File.separator + path);\n          \n          \n            \n                  File file = tempDir.resolve(path).toFile();", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469012573", "createdAt": "2020-08-12T05:26:17Z", "author": {"login": "ajsutton"}, "path": "util/src/test/java/tech/pegasys/teku/util/config/KeyStoreFilesLocatorTest.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+import java.util.Optional;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+public class KeyStoreFilesLocatorTest {\n+  @Test\n+  public void shouldFindPairsAtDepth(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key/1/2/3\", \"pass/1/2/3\");\n+    createFiles(tempDir, \"key/a.json\", \"pass/a.txt\", \"key/1/2/3/b.json\", \"pass/1/2/3/b.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key:%s/pass\", tempStr, tempStr))), \":\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs())\n+        .containsExactlyInAnyOrder(\n+            tuple(tempStr, \"key/a.json\", \"pass/a.txt\"),\n+            tuple(tempStr, \"key/1/2/3/b.json\", \"pass/1/2/3/b.txt\"));\n+  }\n+\n+  @Test\n+  public void shouldFindMissingPasswordAtDepth(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key/1/2/3\", \"pass/1/2/3\");\n+    createFiles(tempDir, \"key/a.json\", \"pass/a.txt\", \"key/1/2/3/b.json\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key:%s/pass\", tempStr, tempStr))), \":\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldFindKeyPairOfFiles(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\", \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a;%s/pass/a.txt\", tempStr, tempStr))), \";\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs()).containsExactly(tuple(tempStr, \"key/a\", \"pass/a.txt\"));\n+  }\n+\n+  @Test\n+  public void shouldIgnoreSomeFiles(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(\n+        tempDir, \"key/.asdf.json\", \"key/.hidden2\", \"key/ignored\", \"key/a.json\", \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key;%s/pass\", tempStr, tempStr))), \";\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs()).containsExactly(tuple(tempStr, \"key/a.json\", \"pass/a.txt\"));\n+  }\n+\n+  @Test\n+  public void shouldHandleFilesAndFoldersInOneArgument(@TempDir final Path tempDir)\n+      throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\", \"pass/a.txt\", \"keyStore\", \"password\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(\n+                List.of(\n+                    String.format(\"%s/key/a:%s/pass/a.txt\", tempStr, tempStr),\n+                    String.format(\"%s/keyStore:%s/password\", tempStr, tempStr))),\n+            \":\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs().size()).isEqualTo(2);\n+  }\n+\n+  @Test\n+  public void shouldDetectMissingPasswordFileWhenDirectoryIsPresent(@TempDir final Path tempDir)\n+      throws IOException {\n+    createFolders(tempDir, \"key\", \"pass/a.txt\");\n+    createFiles(tempDir, \"key/a\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a;%s/pass/a.txt\", tempStr, tempStr))), \";\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldDetectMissingPasswordFile(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a:%s/pass/a.txt\", tempStr, tempStr))), \":\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldDetectMissingKeyFile(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a:%s/pass/a.txt\", tempStr, tempStr))), \":\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldSucceedCallingParseOnEmptyList() {\n+    KeyStoreFilesLocator locator = new KeyStoreFilesLocator(Optional.empty(), \":\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs()).isEmpty();\n+  }\n+\n+  @Test\n+  public void shouldHandleOldArgs(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\", \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator = new KeyStoreFilesLocator(Optional.empty(), \":\");\n+    locator.parseKeyAndPasswordList(List.of(tempStr + \"/key/a\"), List.of(tempStr + \"/pass/a.txt\"));\n+    assertThat(locator.getFilePairs())\n+        .containsExactly(tuple(tempDir.toString(), \"key/a\", \"pass/a.txt\"));\n+  }\n+\n+  private void createFolders(final Path tempDir, String... paths) {\n+    for (String path : paths) {\n+      File file = new File(tempDir.toString() + File.separator + path);\n+      file.mkdirs();\n+    }\n+  }\n+\n+  private void createFiles(final Path tempDir, String... paths) throws IOException {\n+    for (String path : paths) {\n+      File file = new File(tempDir.toString() + File.separator + path);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 158}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMjY2Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  File file = new File(tempDir.toString() + File.separator + path);\n          \n          \n            \n                  File file = tempDir.resolve(path).toFile();", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469012667", "createdAt": "2020-08-12T05:26:37Z", "author": {"login": "ajsutton"}, "path": "util/src/test/java/tech/pegasys/teku/util/config/KeyStoreFilesLocatorTest.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+import java.util.Optional;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+public class KeyStoreFilesLocatorTest {\n+  @Test\n+  public void shouldFindPairsAtDepth(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key/1/2/3\", \"pass/1/2/3\");\n+    createFiles(tempDir, \"key/a.json\", \"pass/a.txt\", \"key/1/2/3/b.json\", \"pass/1/2/3/b.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key:%s/pass\", tempStr, tempStr))), \":\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs())\n+        .containsExactlyInAnyOrder(\n+            tuple(tempStr, \"key/a.json\", \"pass/a.txt\"),\n+            tuple(tempStr, \"key/1/2/3/b.json\", \"pass/1/2/3/b.txt\"));\n+  }\n+\n+  @Test\n+  public void shouldFindMissingPasswordAtDepth(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key/1/2/3\", \"pass/1/2/3\");\n+    createFiles(tempDir, \"key/a.json\", \"pass/a.txt\", \"key/1/2/3/b.json\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key:%s/pass\", tempStr, tempStr))), \":\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldFindKeyPairOfFiles(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\", \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a;%s/pass/a.txt\", tempStr, tempStr))), \";\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs()).containsExactly(tuple(tempStr, \"key/a\", \"pass/a.txt\"));\n+  }\n+\n+  @Test\n+  public void shouldIgnoreSomeFiles(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(\n+        tempDir, \"key/.asdf.json\", \"key/.hidden2\", \"key/ignored\", \"key/a.json\", \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key;%s/pass\", tempStr, tempStr))), \";\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs()).containsExactly(tuple(tempStr, \"key/a.json\", \"pass/a.txt\"));\n+  }\n+\n+  @Test\n+  public void shouldHandleFilesAndFoldersInOneArgument(@TempDir final Path tempDir)\n+      throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\", \"pass/a.txt\", \"keyStore\", \"password\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(\n+                List.of(\n+                    String.format(\"%s/key/a:%s/pass/a.txt\", tempStr, tempStr),\n+                    String.format(\"%s/keyStore:%s/password\", tempStr, tempStr))),\n+            \":\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs().size()).isEqualTo(2);\n+  }\n+\n+  @Test\n+  public void shouldDetectMissingPasswordFileWhenDirectoryIsPresent(@TempDir final Path tempDir)\n+      throws IOException {\n+    createFolders(tempDir, \"key\", \"pass/a.txt\");\n+    createFiles(tempDir, \"key/a\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a;%s/pass/a.txt\", tempStr, tempStr))), \";\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldDetectMissingPasswordFile(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a:%s/pass/a.txt\", tempStr, tempStr))), \":\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldDetectMissingKeyFile(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a:%s/pass/a.txt\", tempStr, tempStr))), \":\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldSucceedCallingParseOnEmptyList() {\n+    KeyStoreFilesLocator locator = new KeyStoreFilesLocator(Optional.empty(), \":\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs()).isEmpty();\n+  }\n+\n+  @Test\n+  public void shouldHandleOldArgs(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\", \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator = new KeyStoreFilesLocator(Optional.empty(), \":\");\n+    locator.parseKeyAndPasswordList(List.of(tempStr + \"/key/a\"), List.of(tempStr + \"/pass/a.txt\"));\n+    assertThat(locator.getFilePairs())\n+        .containsExactly(tuple(tempDir.toString(), \"key/a\", \"pass/a.txt\"));\n+  }\n+\n+  private void createFolders(final Path tempDir, String... paths) {\n+    for (String path : paths) {\n+      File file = new File(tempDir.toString() + File.separator + path);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 151}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMjg1NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  file.mkdirs();\n          \n          \n            \n                  if (!file.mkdirs() && !file.isDirectory()) {\n          \n          \n            \n                    Assertions.fail(\"Failed to create directory \" + file);\n          \n          \n            \n                  }", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469012854", "createdAt": "2020-08-12T05:27:15Z", "author": {"login": "ajsutton"}, "path": "util/src/test/java/tech/pegasys/teku/util/config/KeyStoreFilesLocatorTest.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+import java.util.Optional;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+public class KeyStoreFilesLocatorTest {\n+  @Test\n+  public void shouldFindPairsAtDepth(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key/1/2/3\", \"pass/1/2/3\");\n+    createFiles(tempDir, \"key/a.json\", \"pass/a.txt\", \"key/1/2/3/b.json\", \"pass/1/2/3/b.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key:%s/pass\", tempStr, tempStr))), \":\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs())\n+        .containsExactlyInAnyOrder(\n+            tuple(tempStr, \"key/a.json\", \"pass/a.txt\"),\n+            tuple(tempStr, \"key/1/2/3/b.json\", \"pass/1/2/3/b.txt\"));\n+  }\n+\n+  @Test\n+  public void shouldFindMissingPasswordAtDepth(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key/1/2/3\", \"pass/1/2/3\");\n+    createFiles(tempDir, \"key/a.json\", \"pass/a.txt\", \"key/1/2/3/b.json\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key:%s/pass\", tempStr, tempStr))), \":\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldFindKeyPairOfFiles(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\", \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a;%s/pass/a.txt\", tempStr, tempStr))), \";\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs()).containsExactly(tuple(tempStr, \"key/a\", \"pass/a.txt\"));\n+  }\n+\n+  @Test\n+  public void shouldIgnoreSomeFiles(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(\n+        tempDir, \"key/.asdf.json\", \"key/.hidden2\", \"key/ignored\", \"key/a.json\", \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key;%s/pass\", tempStr, tempStr))), \";\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs()).containsExactly(tuple(tempStr, \"key/a.json\", \"pass/a.txt\"));\n+  }\n+\n+  @Test\n+  public void shouldHandleFilesAndFoldersInOneArgument(@TempDir final Path tempDir)\n+      throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\", \"pass/a.txt\", \"keyStore\", \"password\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(\n+                List.of(\n+                    String.format(\"%s/key/a:%s/pass/a.txt\", tempStr, tempStr),\n+                    String.format(\"%s/keyStore:%s/password\", tempStr, tempStr))),\n+            \":\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs().size()).isEqualTo(2);\n+  }\n+\n+  @Test\n+  public void shouldDetectMissingPasswordFileWhenDirectoryIsPresent(@TempDir final Path tempDir)\n+      throws IOException {\n+    createFolders(tempDir, \"key\", \"pass/a.txt\");\n+    createFiles(tempDir, \"key/a\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a;%s/pass/a.txt\", tempStr, tempStr))), \";\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldDetectMissingPasswordFile(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a:%s/pass/a.txt\", tempStr, tempStr))), \":\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldDetectMissingKeyFile(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a:%s/pass/a.txt\", tempStr, tempStr))), \":\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldSucceedCallingParseOnEmptyList() {\n+    KeyStoreFilesLocator locator = new KeyStoreFilesLocator(Optional.empty(), \":\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs()).isEmpty();\n+  }\n+\n+  @Test\n+  public void shouldHandleOldArgs(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\", \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator = new KeyStoreFilesLocator(Optional.empty(), \":\");\n+    locator.parseKeyAndPasswordList(List.of(tempStr + \"/key/a\"), List.of(tempStr + \"/pass/a.txt\"));\n+    assertThat(locator.getFilePairs())\n+        .containsExactly(tuple(tempDir.toString(), \"key/a\", \"pass/a.txt\"));\n+  }\n+\n+  private void createFolders(final Path tempDir, String... paths) {\n+    for (String path : paths) {\n+      File file = new File(tempDir.toString() + File.separator + path);\n+      file.mkdirs();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMzEyNg==", "bodyText": "Need to avoid hard coding / as the path separator and use Path.resolve or Path.of to join the pieces.", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469013126", "createdAt": "2020-08-12T05:28:22Z", "author": {"login": "ajsutton"}, "path": "util/src/test/java/tech/pegasys/teku/util/config/KeyStoreFilesLocatorTest.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+import java.util.Optional;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+public class KeyStoreFilesLocatorTest {\n+  @Test\n+  public void shouldFindPairsAtDepth(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key/1/2/3\", \"pass/1/2/3\");\n+    createFiles(tempDir, \"key/a.json\", \"pass/a.txt\", \"key/1/2/3/b.json\", \"pass/1/2/3/b.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key:%s/pass\", tempStr, tempStr))), \":\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs())\n+        .containsExactlyInAnyOrder(\n+            tuple(tempStr, \"key/a.json\", \"pass/a.txt\"),\n+            tuple(tempStr, \"key/1/2/3/b.json\", \"pass/1/2/3/b.txt\"));\n+  }\n+\n+  @Test\n+  public void shouldFindMissingPasswordAtDepth(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key/1/2/3\", \"pass/1/2/3\");\n+    createFiles(tempDir, \"key/a.json\", \"pass/a.txt\", \"key/1/2/3/b.json\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key:%s/pass\", tempStr, tempStr))), \":\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldFindKeyPairOfFiles(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\", \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a;%s/pass/a.txt\", tempStr, tempStr))), \";\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs()).containsExactly(tuple(tempStr, \"key/a\", \"pass/a.txt\"));\n+  }\n+\n+  @Test\n+  public void shouldIgnoreSomeFiles(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(\n+        tempDir, \"key/.asdf.json\", \"key/.hidden2\", \"key/ignored\", \"key/a.json\", \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key;%s/pass\", tempStr, tempStr))), \";\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs()).containsExactly(tuple(tempStr, \"key/a.json\", \"pass/a.txt\"));\n+  }\n+\n+  @Test\n+  public void shouldHandleFilesAndFoldersInOneArgument(@TempDir final Path tempDir)\n+      throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\", \"pass/a.txt\", \"keyStore\", \"password\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(\n+                List.of(\n+                    String.format(\"%s/key/a:%s/pass/a.txt\", tempStr, tempStr),\n+                    String.format(\"%s/keyStore:%s/password\", tempStr, tempStr))),\n+            \":\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs().size()).isEqualTo(2);\n+  }\n+\n+  @Test\n+  public void shouldDetectMissingPasswordFileWhenDirectoryIsPresent(@TempDir final Path tempDir)\n+      throws IOException {\n+    createFolders(tempDir, \"key\", \"pass/a.txt\");\n+    createFiles(tempDir, \"key/a\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a;%s/pass/a.txt\", tempStr, tempStr))), \";\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldDetectMissingPasswordFile(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a:%s/pass/a.txt\", tempStr, tempStr))), \":\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldDetectMissingKeyFile(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator =\n+        new KeyStoreFilesLocator(\n+            Optional.of(List.of(String.format(\"%s/key/a:%s/pass/a.txt\", tempStr, tempStr))), \":\");\n+    assertThatThrownBy(locator::parse).isInstanceOf(InvalidConfigurationException.class);\n+  }\n+\n+  @Test\n+  public void shouldSucceedCallingParseOnEmptyList() {\n+    KeyStoreFilesLocator locator = new KeyStoreFilesLocator(Optional.empty(), \":\");\n+    locator.parse();\n+    assertThat(locator.getFilePairs()).isEmpty();\n+  }\n+\n+  @Test\n+  public void shouldHandleOldArgs(@TempDir final Path tempDir) throws IOException {\n+    createFolders(tempDir, \"key\", \"pass\");\n+    createFiles(tempDir, \"key/a\", \"pass/a.txt\");\n+    final String tempStr = tempDir.toString();\n+    KeyStoreFilesLocator locator = new KeyStoreFilesLocator(Optional.empty(), \":\");\n+    locator.parseKeyAndPasswordList(List.of(tempStr + \"/key/a\"), List.of(tempStr + \"/pass/a.txt\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2877192f859317636e697c9ca1ec55953e73d71"}, "originalPosition": 144}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20241fe2f46bf26833336cf41110fd5628f361a0", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/20241fe2f46bf26833336cf41110fd5628f361a0", "committedDate": "2020-08-13T02:11:46Z", "message": "review feedback.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c71c0aae9a53de77548ccdd8561f0ece5078b937", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/c71c0aae9a53de77548ccdd8561f0ece5078b937", "committedDate": "2020-08-13T02:51:03Z", "message": "Merge remote-tracking branch 'upstream/master' into 2003-keys-directory"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NDE0ODU2", "url": "https://github.com/ConsenSys/teku/pull/2563#pullrequestreview-466414856", "createdAt": "2020-08-13T03:09:24Z", "commit": {"oid": "c71c0aae9a53de77548ccdd8561f0ece5078b937"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwMzowOToyNFrOG_6aBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwMzowOToyNFrOG_6aBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY3MDQwNQ==", "bodyText": "I've only just learnt this but we should use File.isHidden for this so:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                              !path.getFileName().toString().startsWith(\".\")\n          \n          \n            \n                              !path.toFile().isHidden()", "url": "https://github.com/ConsenSys/teku/pull/2563#discussion_r469670405", "createdAt": "2020-08-13T03:09:24Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/KeyStoreFilesLocator.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import static java.util.stream.Collectors.toList;\n+\n+import com.google.common.base.Splitter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class KeyStoreFilesLocator {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final Map<Path, Path> pathMap = new HashMap<>();\n+  private final List<String> colonSeparatedPairs;\n+  private final String pathSeparator;\n+\n+  public KeyStoreFilesLocator(final List<String> colonSeparatedPairs, final String pathSeparator) {\n+    this.colonSeparatedPairs = colonSeparatedPairs;\n+    this.pathSeparator = pathSeparator;\n+  }\n+\n+  public void parse() {\n+    for (final String currentEntry : colonSeparatedPairs) {\n+      if (!currentEntry.contains(pathSeparator)) {\n+        throw new InvalidConfigurationException(\n+            \"validatorKeys entry (\"\n+                + currentEntry\n+                + \") did not contain key and password separated by '\"\n+                + pathSeparator\n+                + \"' as expected.\");\n+      }\n+\n+      final List<String> entry = Splitter.on(pathSeparator).limit(2).splitToList(currentEntry);\n+      parseEntry(entry.get(0), entry.get(1));\n+    }\n+  }\n+\n+  public void parseKeyAndPasswordList(\n+      final List<String> keystoreFiles, final List<String> keystorePasswordFiles) {\n+    for (int i = 0; i < keystoreFiles.size(); i++) {\n+      parseEntry(keystoreFiles.get(i), keystorePasswordFiles.get(i));\n+    }\n+  }\n+\n+  void parseEntry(final String keyFileName, final String passwordFileName) {\n+    final File keyFile = new File(keyFileName);\n+    final File passwordFile = new File(passwordFileName);\n+\n+    if (!keyFile.exists()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\"Invalid configuration. Could not find the key file (%s).\", keyFileName));\n+    }\n+    if (!passwordFile.exists()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\n+              \"Invalid configuration. Could not find the password file (%s).\", passwordFileName));\n+    }\n+    if (keyFile.isDirectory() != passwordFile.isDirectory()) {\n+      throw new InvalidConfigurationException(\n+          String.format(\n+              \"Invalid configuration. --validator-keys entry (%s\"\n+                  + pathSeparator\n+                  + \"%s) must be both directories or both files\",\n+              keyFileName,\n+              passwordFileName));\n+    }\n+    if (keyFile.isFile()) {\n+      pathMap.putIfAbsent(keyFile.toPath(), passwordFile.toPath());\n+    } else {\n+      parseDirectory(keyFile, passwordFile);\n+    }\n+  }\n+\n+  void parseDirectory(final File keyDirectory, final File passwordDirectory) {\n+    try (Stream<Path> walk = Files.walk(keyDirectory.toPath())) {\n+      walk.filter(Files::isRegularFile)\n+          .filter(\n+              (path) ->\n+                  !path.getFileName().toString().startsWith(\".\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c71c0aae9a53de77548ccdd8561f0ece5078b937"}, "originalPosition": 100}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5b81cfced5bbcd3cceec3d510f0bbfe7c937337", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/c5b81cfced5bbcd3cceec3d510f0bbfe7c937337", "committedDate": "2020-08-13T03:49:26Z", "message": "Update util/src/main/java/tech/pegasys/teku/util/config/KeyStoreFilesLocator.java\n\nCo-authored-by: Adrian Sutton <adrian@symphonious.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8491f1996032544a22157cb4623e7521adfcae98", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/8491f1996032544a22157cb4623e7521adfcae98", "committedDate": "2020-08-13T03:52:00Z", "message": "spotless\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3623, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}