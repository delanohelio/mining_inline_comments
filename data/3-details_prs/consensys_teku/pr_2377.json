{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxMjQ1NjEy", "number": 2377, "title": "Fix and reenable some deposit processing tests", "bodyText": "Description\n\nFix and reenable a couple of deposit processing tests by adding deposit contract Merkle root calculation logic.\nAdd a test to ensure that a deposit with an invalid public key (not in G1) is handled correctly (i.e. silently ignored).\n\nResolves #2375\nDocumentation\n\n[x ] I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-07-17T16:24:20Z", "url": "https://github.com/ConsenSys/teku/pull/2377", "merged": true, "mergeCommit": {"oid": "89c5e8d334c06d97ce5ac03e5c48b4d08fe4804e"}, "closed": true, "closedAt": "2020-07-18T07:38:57Z", "author": {"login": "benjaminion"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc14U22AFqTQ1MDg3ODQ5MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc2DUm4gBqjM1NjA3NDM2NDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwODc4NDkw", "url": "https://github.com/ConsenSys/teku/pull/2377#pullrequestreview-450878490", "createdAt": "2020-07-17T18:38:50Z", "commit": {"oid": "02198a5bfd334d5edf3c9f74ebfc4001ddd664e4"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODozODo1MVrOGzdX3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODozOTozM1rOGzdZDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxMTgwNg==", "bodyText": "(optional) Might be worth trying to dedupe some of this logic with a helper method that sets up and processes the state & deposits and returns the resulting state.", "url": "https://github.com/ConsenSys/teku/pull/2377#discussion_r456611806", "createdAt": "2020-07-17T18:38:51Z", "author": {"login": "mbaxter"}, "path": "ethereum/statetransition/src/test/java/tech/pegasys/teku/statetransition/util/BlockProcessorUtilTest.java", "diffHunk": "@@ -42,18 +46,31 @@\n   private final DataStructureUtil dataStructureUtil = new DataStructureUtil();\n \n   @Test\n-  @Disabled\n   void processDepositAddsNewValidatorWhenPubkeyIsNotFoundInRegistry()\n       throws BlockProcessingException {\n-    // Data Setup\n-    SSZList<DepositWithIndex> deposits = dataStructureUtil.newDeposits(1);\n-    Deposit deposit = deposits.get(0);\n-    DepositData depositInput = deposit.getData();\n+    // Create a deposit\n+    DepositData depositInput = dataStructureUtil.randomDepositData();\n     BLSPublicKey pubkey = depositInput.getPubkey();\n     Bytes32 withdrawalCredentials = depositInput.getWithdrawal_credentials();\n-    UnsignedLong amount = deposit.getData().getAmount();\n-\n-    BeaconState beaconState = createBeaconState();\n+    UnsignedLong amount = depositInput.getAmount();\n+\n+    // Add the deposit to a Merkle tree so that we can get the root to put into the state\n+    MerkleTree depositMerkleTree = new OptimizedMerkleTree(Constants.DEPOSIT_CONTRACT_TREE_DEPTH);\n+    depositMerkleTree.add(depositInput.hash_tree_root());\n+\n+    // Create the state and insert the Merkle root of the deposit data\n+    BeaconState beaconState =\n+        createBeaconState()\n+            .updated(\n+                state ->\n+                    state.setEth1_data(\n+                        new Eth1Data(\n+                            depositMerkleTree.getRoot(), UnsignedLong.valueOf(1), Bytes32.ZERO)));\n+\n+    SSZMutableList<DepositWithIndex> deposits =\n+        SSZList.createMutable(DepositWithIndex.class, Constants.MAX_DEPOSITS);\n+    deposits.add(\n+        new DepositWithIndex(depositMerkleTree.getProof(0), depositInput, UnsignedLong.valueOf(0)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02198a5bfd334d5edf3c9f74ebfc4001ddd664e4"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxMjExMQ==", "bodyText": "(optional) Maybe we should verify that all of the balances are unchanged.", "url": "https://github.com/ConsenSys/teku/pull/2377#discussion_r456612111", "createdAt": "2020-07-17T18:39:33Z", "author": {"login": "mbaxter"}, "path": "ethereum/statetransition/src/test/java/tech/pegasys/teku/statetransition/util/BlockProcessorUtilTest.java", "diffHunk": "@@ -127,6 +156,56 @@ void processDepositTopsUpValidatorBalanceWhenPubkeyIsFoundInRegistry()\n         beaconState.getBalances().get(originalValidatorBalancesSize - 1));\n   }\n \n+  @Test\n+  void processDepositHandlesDepositWithInvalidPublicKey() throws BlockProcessingException {\n+    // The following deposit uses a \"rogue\" public key that is not in the G1 group\n+    BLSPublicKey pubkey =\n+        BLSPublicKey.fromBytesCompressed(\n+            Bytes.fromHexString(\n+                \"0x9378a6e3984e96d2cd50450c76ca14732f1300efa04aecdb805b22e6d6926a85ef409e8f3acf494a1481090bf32ce3bd\"));\n+    Bytes32 withdrawalCredentials =\n+        Bytes32.fromHexString(\"0x79e43d39ee55749c55994a7ab2a3cb91460cec544fdbf27eb5717c43f970c1b6\");\n+    UnsignedLong amount = UnsignedLong.valueOf(1000000000L);\n+    BLSSignature signature =\n+        BLSSignature.fromBytes(\n+            Bytes.fromHexString(\n+                \"0xddc1ca509e29c6452441069f26da6e073589b3bd1cace50e3427426af5bfdd566d077d4bdf618e249061b9770471e3d515779aa758b8ccb4b06226a8d5ebc99e19d4c3278e5006b837985bec4e0ce39df92c1f88d1afd0f98dbae360024a390d\"));\n+    DepositData depositInput =\n+        new DepositData(new DepositMessage(pubkey, withdrawalCredentials, amount), signature);\n+\n+    // Add the deposit to a Merkle tree so that we can get the root to put into the state\n+    MerkleTree depositMerkleTree = new OptimizedMerkleTree(Constants.DEPOSIT_CONTRACT_TREE_DEPTH);\n+    depositMerkleTree.add(depositInput.hash_tree_root());\n+\n+    // Create the state and insert the Merkle root of the deposit data\n+    BeaconState beaconState =\n+        createBeaconState()\n+            .updated(\n+                state ->\n+                    state.setEth1_data(\n+                        new Eth1Data(\n+                            depositMerkleTree.getRoot(), UnsignedLong.valueOf(1), Bytes32.ZERO)));\n+\n+    SSZMutableList<DepositWithIndex> deposits =\n+        SSZList.createMutable(DepositWithIndex.class, Constants.MAX_DEPOSITS);\n+    deposits.add(\n+        new DepositWithIndex(depositMerkleTree.getProof(0), depositInput, UnsignedLong.valueOf(0)));\n+\n+    int originalValidatorRegistrySize = beaconState.getValidators().size();\n+    int originalValidatorBalancesSize = beaconState.getBalances().size();\n+\n+    // Attempt to process deposit with above data. We expect to fail, but not throw an exception.\n+    beaconState =\n+        beaconState.updated(state -> BlockProcessorUtil.process_deposits(state, deposits));\n+\n+    assertTrue(\n+        beaconState.getValidators().size() == originalValidatorRegistrySize,\n+        \"The validator was added to the validator registry.\");\n+    assertTrue(\n+        beaconState.getBalances().size() == originalValidatorBalancesSize,\n+        \"The balance was added to the validator balances.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02198a5bfd334d5edf3c9f74ebfc4001ddd664e4"}, "originalPosition": 167}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "712bebcc2404c0b594169019c810dc25eb4ce612", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/712bebcc2404c0b594169019c810dc25eb4ce612", "committedDate": "2020-07-18T06:35:32Z", "message": "Fix and reenable some deposit processing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87a5537584ce5c08ff56bdb7242628651e55a896", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/87a5537584ce5c08ff56bdb7242628651e55a896", "committedDate": "2020-07-18T06:35:32Z", "message": "Simplify"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8b8e311c7c2172b090407875eab003d8dd40ab6", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/d8b8e311c7c2172b090407875eab003d8dd40ab6", "committedDate": "2020-07-18T06:35:32Z", "message": "Typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6aab145c48be6071d78401b381f18fc7574bed5", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/b6aab145c48be6071d78401b381f18fc7574bed5", "committedDate": "2020-07-18T07:29:36Z", "message": "Factor out common code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02198a5bfd334d5edf3c9f74ebfc4001ddd664e4", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/02198a5bfd334d5edf3c9f74ebfc4001ddd664e4", "committedDate": "2020-07-17T16:23:47Z", "message": "Typo"}, "afterCommit": {"oid": "b6aab145c48be6071d78401b381f18fc7574bed5", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/b6aab145c48be6071d78401b381f18fc7574bed5", "committedDate": "2020-07-18T07:29:36Z", "message": "Factor out common code"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3643, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}