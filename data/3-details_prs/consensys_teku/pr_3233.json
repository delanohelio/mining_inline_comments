{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxODI0MjA5", "number": 3233, "title": "update API doc publishing CI", "bodyText": "PR Description\nPR 2/2 of updating API doc update system. For first PR 1/2 see #3232\n\nUpdate the CI for OpenAPI spec and doc publishing to be more robust and modern\n(mostly inspired by Consensys/web3signer repos CI, thanks @usmansaleem)\nmake the API doc publishing tag release compatible\n\nFixed Issue(s)\n\n\nfixes ConsenSys/protocol-misc#203\nTesting\nAll the testing was done on a test repos, copy of the teku one but without the Java part as it's not relevant as the CI process for this API doc starts when we fetch the spec form the live teku node.\nThe test API doc output is visible at https://nicolasmassart.github.io/teku-api-doc-test/\nTest source code repos is https://github.com/NicolasMassart/teku-api-doc-test/\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-16T17:41:56Z", "url": "https://github.com/ConsenSys/teku/pull/3233", "merged": true, "mergeCommit": {"oid": "d32b4522c6e1f9ee254a54d1b3b3da86f04f3d4d"}, "closed": true, "closedAt": "2020-11-16T21:41:03Z", "author": {"login": "NicolasMassart"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddIhb4AH2gAyNTIxODI0MjA5OjlkODA5YjhmYWY0ODU5MmJhYmNjZjhiNmU5MzdlZGIzMjJkNTA0YzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddLvgWgH2gAyNTIxODI0MjA5OjgzZjhiNTc1NjVmMGM4MDk5ZGNiMmZkOTllODAxOGNlNDNmMDI2Yzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9d809b8faf48592babccf8b6e937edb322d504c6", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/9d809b8faf48592babccf8b6e937edb322d504c6", "committedDate": "2020-11-16T17:36:48Z", "message": "update API doc CI\n\nSee ConsenSys/protocol-misc#203 and #3232"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4535c31fab08339fbb881668d41ee59db341c2e", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/a4535c31fab08339fbb881668d41ee59db341c2e", "committedDate": "2020-11-16T17:44:58Z", "message": "typo fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7540d7888c7eb9f148f3ded1653281e0bf9487d9", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/7540d7888c7eb9f148f3ded1653281e0bf9487d9", "committedDate": "2020-11-16T17:47:32Z", "message": "double typo!"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6e9a5351da3b04da1020dee2508bf14f7194a36", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/b6e9a5351da3b04da1020dee2508bf14f7194a36", "committedDate": "2020-11-16T18:09:25Z", "message": "Merge branch 'master' into 203-api-doc-ci"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64e586279835e7604590b939716db648b27ae1b1", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/64e586279835e7604590b939716db648b27ae1b1", "committedDate": "2020-11-16T20:16:48Z", "message": "change job names back"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ed8809994e385d73f93354cc03e9a613bc2774f", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/5ed8809994e385d73f93354cc03e9a613bc2774f", "committedDate": "2020-11-16T20:17:20Z", "message": "Merge branch 'master' into 203-api-doc-ci"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8709b7dc5cb9d6633f0327ebcc89abf082466cd", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/a8709b7dc5cb9d6633f0327ebcc89abf082466cd", "committedDate": "2020-11-16T20:27:23Z", "message": "dev version spotting using plus sign"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNzM1Mzc5", "url": "https://github.com/ConsenSys/teku/pull/3233#pullrequestreview-531735379", "createdAt": "2020-11-16T20:36:36Z", "commit": {"oid": "a8709b7dc5cb9d6633f0327ebcc89abf082466cd"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMDozNjozNlrOH0QY_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMDo0NDowMlrOH0QoEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU1NjU0Mw==", "bodyText": "This doesn't seem right.  We should be extracting the API spec on PRs, just not publishing them. Otherwise if the extract is broken we don't find out until after it merges.", "url": "https://github.com/ConsenSys/teku/pull/3233#discussion_r524556543", "createdAt": "2020-11-16T20:36:36Z", "author": {"login": "ajsutton"}, "path": ".circleci/config.yml", "diffHunk": "@@ -461,11 +414,15 @@ workflows:\n             tags:\n               <<: *filters-release-tags\n           context:\n-            - dockerhub-quorumengineering-ro             \n+            - dockerhub-quorumengineering-ro\n       - extractAPISpec:\n           requires:\n             - assemble\n           filters:\n+            branches:\n+              only:\n+                - master\n+                - /^release-.*/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8709b7dc5cb9d6633f0327ebcc89abf082466cd"}, "originalPosition": 235}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU2MDQwMQ==", "bodyText": "nit: comment is out of date.", "url": "https://github.com/ConsenSys/teku/pull/3233#discussion_r524560401", "createdAt": "2020-11-16T20:44:02Z", "author": {"login": "ajsutton"}, "path": ".openapidoc/config.js", "diffHunk": "@@ -0,0 +1,96 @@\n+const fs = require(\"fs\");\n+const path = require(\"path\");\n+const yaml = require(\"js-yaml\");\n+const GitUrlParse = require(\"git-url-parse\");\n+\n+const distDir = process.env.OA_DIST_DIR || \"./dist\";\n+const specDir =\n+  process.env.OA_SPEC_DIR || \"./spec\";\n+const gitUrl =\n+  process.env.OA_GIT_URL || \"git@github.com:Consensys/teku.git\";\n+const gitUserName = process.env.OA_GIT_USERNAME || \"CircleCI Build\";\n+const gitEmail = process.env.OA_GIT_EMAIL || \"ci-build@consensys.net\";\n+const branch = process.env.OA_GH_PAGES_BRANCH || \"gh-pages\";\n+const versionsFileName = process.env.OA_VERSIONS_FILE_NAME || \"versions.json\";\n+\n+module.exports = {\n+  getConfig,\n+};\n+\n+function getConfig() {\n+  const repo = GitUrlParse(gitUrl);\n+  const specs = calculateSpecs();\n+  if (specs.length == 0) {\n+    throw new Error(\"Unable to parse specs in dist\" + distDir);\n+  }\n+\n+  return {\n+    specs: specs,\n+    distDir: distDir,\n+    versions: calculateVersionDetails(repo, branch),\n+    ghPagesConfig: {\n+      add: true, // allows gh-pages module to keep remote files\n+      branch: branch,\n+      repo: repo.href,\n+      user: {\n+        name: gitUserName,\n+        email: gitEmail,\n+      },\n+      message: `[skip ci] OpenAPI Publish [${specs[0].version}]`,\n+    },\n+  };\n+}\n+\n+function calculateSpecs() {\n+  const extension = \".json\";\n+  const specFiles = fs.readdirSync(specDir);\n+  var specArr = [];\n+  specFiles.forEach((file) => {\n+    if (path.extname(file).toLowerCase() === extension) {\n+      specArr.push(calculateSpecDetails(path.join(specDir, file)));\n+    }\n+  });\n+\n+  return specArr;\n+}\n+\n+function calculateSpecDetails(specFile) {\n+  const specVersion = calculateSpecVersion(specFile);\n+  const release = isReleaseVersion(specVersion);\n+  const latestDist = destinationPath(true, specFile, \"latest\");\n+  const latestDistCompat = destinationPath(false, specFile, \"latest\");\n+  const releaseDist = destinationPath(true, specFile, specVersion);\n+\n+  return {\n+    path: specFile,\n+    version: specVersion,\n+    isReleaseVersion: release,\n+    latestDist: latestDist,\n+    latestDistCompat: latestDistCompat,\n+    releaseDist: releaseDist,\n+  };\n+}\n+\n+function calculateSpecVersion(specFile) {\n+  return yaml.safeLoad(fs.readFileSync(specFile, \"utf8\")).info.version;\n+}\n+\n+function isReleaseVersion(specVersion) {\n+  // our main project's gradle's build calculateVersion puts -dev- for snapshot version", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8709b7dc5cb9d6633f0327ebcc89abf082466cd"}, "originalPosition": 79}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4d7ad16a63a81ca258e73e9a49ce7752bd88b66", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/e4d7ad16a63a81ca258e73e9a49ce7752bd88b66", "committedDate": "2020-11-16T21:11:13Z", "message": "trying without branch filter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNzg1OTUz", "url": "https://github.com/ConsenSys/teku/pull/3233#pullrequestreview-531785953", "createdAt": "2020-11-16T21:16:10Z", "commit": {"oid": "e4d7ad16a63a81ca258e73e9a49ce7752bd88b66"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83f8b57565f0c8099dcb2fd99e8018ce43f026c7", "author": {"user": {"login": "NicolasMassart", "name": "Nicolas MASSART"}}, "url": "https://github.com/ConsenSys/teku/commit/83f8b57565f0c8099dcb2fd99e8018ce43f026c7", "committedDate": "2020-11-16T21:21:53Z", "message": "fix comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4454, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}