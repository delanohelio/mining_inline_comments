{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3NzU3ODYy", "number": 1116, "title": "Retrieve block timestamp in PoW service", "bodyText": "PR Description\nMoves retrieval of the block timestamp for deposits from StateProcessor back up into the proof of work service which is actually responsible for communications with the ETH1 node.  This also better balances processing time for deposits so the queue in the event bus doesn't build up as badly.", "createdAt": "2020-01-27T23:36:44Z", "url": "https://github.com/ConsenSys/teku/pull/1116", "merged": true, "mergeCommit": {"oid": "19c7e2835026053695e0b781439917c2eb598f47"}, "closed": true, "closedAt": "2020-01-28T19:57:27Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-k3d2AH2gAyMzY3NzU3ODYyOjhlZGIxYjEzZTUyYWM5NzQ5ZWQ0YWQ4MDNkODVkY2I5MGY3Mzg3NjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-2s-fAH2gAyMzY3NzU3ODYyOmNiMzQyYmEyMjc0MDgzNzhjOTlhNGY4NTJlYmQwODI1YmYxYmI5YzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8edb1b13e52ac9749ed4ad803d85dcb90f738763", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/8edb1b13e52ac9749ed4ad803d85dcb90f738763", "committedDate": "2020-01-27T22:55:24Z", "message": "Retrieve block timestamp in PoW service rather than in StateProcessor."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fb813d6691e452424084d3f752c4e15c6e2fdce", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/4fb813d6691e452424084d3f752c4e15c6e2fdce", "committedDate": "2020-01-27T23:34:07Z", "message": "Cache the block data."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "380ce0f7acb04fc8d5972421a34a0d3307564f90", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/380ce0f7acb04fc8d5972421a34a0d3307564f90", "committedDate": "2020-01-27T23:50:17Z", "message": "Remove debug statement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9688c09de31d6983229bd47314e6591ad14e709e", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/9688c09de31d6983229bd47314e6591ad14e709e", "committedDate": "2020-01-28T00:53:32Z", "message": "Better method name."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af8d38591c6e656667253a3b01018a425d95c658", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/af8d38591c6e656667253a3b01018a425d95c658", "committedDate": "2020-01-28T00:54:06Z", "message": "Use a field for web3j object."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7505be3bbe5b40651d3dd7b4ed84b589a3ec97bf", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/7505be3bbe5b40651d3dd7b4ed84b589a3ec97bf", "committedDate": "2020-01-28T02:28:54Z", "message": "Use web3j field."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NTcwNDY0", "url": "https://github.com/ConsenSys/teku/pull/1116#pullrequestreview-349570464", "createdAt": "2020-01-28T17:38:10Z", "commit": {"oid": "7505be3bbe5b40651d3dd7b4ed84b589a3ec97bf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNzozODoxMFrOFiuP_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNzozODoxMFrOFiuP_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1MzY2MA==", "bodyText": "Are we caching only the current block because the depositEventFlowable will never return an Event from a past block?", "url": "https://github.com/ConsenSys/teku/pull/1116#discussion_r371953660", "createdAt": "2020-01-28T17:38:10Z", "author": {"login": "cemozerr"}, "path": "pow/src/main/java/tech/pegasys/artemis/pow/DepositContractListener.java", "diffHunk": "@@ -16,19 +16,28 @@\n import static tech.pegasys.artemis.pow.contract.DepositContract.DEPOSITEVENT_EVENT;\n \n import com.google.common.eventbus.EventBus;\n+import com.google.common.primitives.UnsignedLong;\n+import io.reactivex.Flowable;\n import io.reactivex.disposables.Disposable;\n+import java.util.Optional;\n import org.web3j.abi.EventEncoder;\n+import org.web3j.protocol.Web3j;\n import org.web3j.protocol.core.DefaultBlockParameterName;\n import org.web3j.protocol.core.methods.request.EthFilter;\n+import org.web3j.protocol.core.methods.response.EthBlock;\n+import org.web3j.protocol.core.methods.response.EthBlock.Block;\n import tech.pegasys.artemis.pow.contract.DepositContract;\n+import tech.pegasys.artemis.pow.contract.DepositContract.DepositEventEventResponse;\n import tech.pegasys.artemis.pow.event.Deposit;\n \n public class DepositContractListener {\n-\n   private final Disposable subscriptionNewDeposit;\n+  private final Web3j web3j;\n   private DepositContract contract;\n+  private volatile Optional<EthBlock.Block> cachedBlock = Optional.empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7505be3bbe5b40651d3dd7b4ed84b589a3ec97bf"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NTcwNjMx", "url": "https://github.com/ConsenSys/teku/pull/1116#pullrequestreview-349570631", "createdAt": "2020-01-28T17:38:27Z", "commit": {"oid": "7505be3bbe5b40651d3dd7b4ed84b589a3ec97bf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NjE2MjY3", "url": "https://github.com/ConsenSys/teku/pull/1116#pullrequestreview-349616267", "createdAt": "2020-01-28T18:48:49Z", "commit": {"oid": "7505be3bbe5b40651d3dd7b4ed84b589a3ec97bf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxODo0ODo1MFrOFiwcng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxODo0ODo1MFrOFiwcng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk4OTY2Mg==", "bodyText": "Does this mean we drop the deposit if the block request fails?", "url": "https://github.com/ConsenSys/teku/pull/1116#discussion_r371989662", "createdAt": "2020-01-28T18:48:50Z", "author": {"login": "mbaxter"}, "path": "pow/src/main/java/tech/pegasys/artemis/pow/DepositContractListener.java", "diffHunk": "@@ -44,11 +53,29 @@ public DepositContractListener(EventBus eventBus, DepositContract contract) {\n     subscriptionNewDeposit =\n         contract\n             .depositEventEventFlowable(depositEventFilter)\n-            .subscribe(\n-                response -> {\n-                  Deposit deposit = new Deposit(response);\n-                  eventBus.post(deposit);\n-                });\n+            .flatMap(this::convertToDeposit)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7505be3bbe5b40651d3dd7b4ed84b589a3ec97bf"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb342ba227408378c99a4f852ebd0825bf1bb9c4", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/cb342ba227408378c99a4f852ebd0825bf1bb9c4", "committedDate": "2020-01-28T19:42:14Z", "message": "Merge branch 'master' into deposit-block-data"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4237, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}