{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5NjAyMjQ1", "number": 2077, "title": "OWLS-77957 - Populate server and domain related env variables to init containers", "bodyText": "Populate the same set of environment variables that are populated in WebLogic server container to init containters. Added unit test for new behavior.\nIntegration test url - https://build.weblogick8s.org:8443/job/weblogic-kubernetes-operator-kind-new/3194/", "createdAt": "2020-11-30T14:53:12Z", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2077", "merged": true, "mergeCommit": {"oid": "c544654967e8f4ba5f68c6836847ac994117319b"}, "closed": true, "closedAt": "2020-12-07T21:40:50Z", "author": {"login": "ankedia"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhdLrGAH2gAyNTI5NjAyMjQ1OmE3MTM3MmQ3NDJjMzU5NTg1YTk2NWE5YWM0MmE0OWM0ZjFkOTQ1ZTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiuPEQgFqTU0NDYxMTAxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a71372d742c359585a965a9ac42a49c4f1d945e7", "author": {"user": {"login": "ankedia", "name": "Anil Kedia"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a71372d742c359585a965a9ac42a49c4f1d945e7", "committedDate": "2020-11-30T03:56:44Z", "message": "OWLS-77957 - Populate server and domain related env variables to init containers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMzgwMjQy", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2077#pullrequestreview-541380242", "createdAt": "2020-11-30T23:37:01Z", "commit": {"oid": "a71372d742c359585a965a9ac42a49c4f1d945e7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a3a6a781b1e598e1f5b5208affd4bf37c19b8ec", "author": {"user": {"login": "ankedia", "name": "Anil Kedia"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3a3a6a781b1e598e1f5b5208affd4bf37c19b8ec", "committedDate": "2020-12-01T13:58:12Z", "message": "Revised change to include existing init containers env variables in addition to server and domain related env variables."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97838bbc19d1e78d0c3fc27a2ca0278fe9ff5bf3", "author": {"user": {"login": "ankedia", "name": "Anil Kedia"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/97838bbc19d1e78d0c3fc27a2ca0278fe9ff5bf3", "committedDate": "2020-12-01T18:00:11Z", "message": "Added new unit test and minor change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMTk5Mjc0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2077#pullrequestreview-542199274", "createdAt": "2020-12-01T18:52:06Z", "commit": {"oid": "97838bbc19d1e78d0c3fc27a2ca0278fe9ff5bf3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxODo1MjowNlrOH87GzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxODo1MjowNlrOH87GzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY0NTAwNQ==", "bodyText": "should env var configued in initContainer take precedence over those configured in server or cluster?", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2077#discussion_r533645005", "createdAt": "2020-12-01T18:52:06Z", "author": {"login": "alai8"}, "path": "operator/src/main/java/oracle/kubernetes/operator/helpers/PodStepContext.java", "diffHunk": "@@ -588,14 +589,22 @@ private static String formatHashLabel(String hash) {\n   protected V1PodSpec createSpec(TuningParameters tuningParameters) {\n     V1PodSpec podSpec = createPodSpec(tuningParameters)\n         .readinessGates(getReadinessGates())\n-        .initContainers(getServerSpec().getInitContainers());\n+        .initContainers(getServerSpec().getInitContainers().stream()\n+                .map(c -> c.env(createEnv(c, tuningParameters))).collect(Collectors.toList()));\n \n     for (V1Volume additionalVolume : getVolumes(getDomainUid())) {\n       podSpec.addVolumesItem(additionalVolume);\n     }\n     return podSpec;\n   }\n \n+  private List<V1EnvVar> createEnv(V1Container c, TuningParameters tuningParameters) {\n+    List<V1EnvVar> envVars = new ArrayList<>();\n+    Optional.ofNullable(c.getEnv()).ifPresent(envVars::addAll);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97838bbc19d1e78d0c3fc27a2ca0278fe9ff5bf3"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cad0c306067ef3650d61a9194a560443bb3e1e24", "author": {"user": {"login": "ankedia", "name": "Anil Kedia"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/cad0c306067ef3650d61a9194a560443bb3e1e24", "committedDate": "2020-12-01T21:30:13Z", "message": "Change to set higher precedence for env var configured in initContainer over those configured in server or cluster as per review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzIyOTA5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2077#pullrequestreview-542322909", "createdAt": "2020-12-01T21:46:39Z", "commit": {"oid": "cad0c306067ef3650d61a9194a560443bb3e1e24"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMTo0Njo0MFrOH9BClA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMTo0Njo0MFrOH9BClA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc0MjIyOA==", "bodyText": "addDefaultEnvVarIfMissing does not handle V1EnvVar with ValueFrom.", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2077#discussion_r533742228", "createdAt": "2020-12-01T21:46:40Z", "author": {"login": "alai8"}, "path": "operator/src/main/java/oracle/kubernetes/operator/helpers/PodStepContext.java", "diffHunk": "@@ -599,10 +599,11 @@ protected V1PodSpec createSpec(TuningParameters tuningParameters) {\n   }\n \n   private List<V1EnvVar> createEnv(V1Container c, TuningParameters tuningParameters) {\n-    List<V1EnvVar> envVars = new ArrayList<>();\n-    Optional.ofNullable(c.getEnv()).ifPresent(envVars::addAll);\n-    envVars.addAll(getEnvironmentVariables(tuningParameters));\n-    return envVars;\n+    List<V1EnvVar> initContainerEnvVars = new ArrayList<>();\n+    Optional.ofNullable(c.getEnv()).ifPresent(initContainerEnvVars::addAll);\n+    getEnvironmentVariables(tuningParameters).forEach(envVar ->\n+            addDefaultEnvVarIfMissing(initContainerEnvVars, envVar.getName(), envVar.getValue()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cad0c306067ef3650d61a9194a560443bb3e1e24"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66f56c5b8b30e933f89e0726e0a12a0596ba686c", "author": {"user": {"login": "ankedia", "name": "Anil Kedia"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/66f56c5b8b30e933f89e0726e0a12a0596ba686c", "committedDate": "2020-12-01T23:37:02Z", "message": "Added a unit test case for testing the precedence and created \"addIfMissing\" method to avoid confusion."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46465788b1bc17357e3ff9c659af74f24ff77159", "author": {"user": {"login": "ankedia", "name": "Anil Kedia"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/46465788b1bc17357e3ff9c659af74f24ff77159", "committedDate": "2020-12-02T16:21:07Z", "message": "Changes to handle environment variables with value from config map or secret."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMDQ2MTA0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2077#pullrequestreview-543046104", "createdAt": "2020-12-02T16:59:56Z", "commit": {"oid": "46465788b1bc17357e3ff9c659af74f24ff77159"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NDUyNDQ4", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2077#pullrequestreview-544452448", "createdAt": "2020-12-03T21:11:48Z", "commit": {"oid": "46465788b1bc17357e3ff9c659af74f24ff77159"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMToxMTo0OVrOH-z6eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMToxMTo0OVrOH-z6eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYyNDMxMg==", "bodyText": "Those new methods (createXXX, listXXX and addXXX) do not seem to belong to this class.", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2077#discussion_r535624312", "createdAt": "2020-12-03T21:11:49Z", "author": {"login": "doxiao"}, "path": "operator/src/test/java/oracle/kubernetes/operator/helpers/Matchers.java", "diffHunk": "@@ -66,6 +78,39 @@ private static V1Container createContainer(String name, String image, String...\n     return new V1Container().name(name).image(image).command(Arrays.asList(command));\n   }\n \n+  private static V1Container createInitContainer(String name, String image, String serverName, String... command) {\n+    return new V1Container().name(name).image(image).command(Arrays.asList(command))\n+            .env(PodHelperTestBase.getPredefinedEnvVariables(serverName));\n+  }\n+\n+  private static V1Container createInitContainerWithEnvVar(String name, String image, String serverName,\n+                                                           V1EnvVar envVar, String... command) {\n+    List<V1EnvVar> envVars = new ArrayList<>(Arrays.asList(envVar));\n+    PodHelperTestBase.getPredefinedEnvVariables(serverName).forEach(predefEnvVar ->\n+            addIfMissing(envVars, predefEnvVar.getName(), predefEnvVar.getValue()));\n+    return new V1Container().name(name).image(image).command(Arrays.asList(command))\n+            .env(envVars);\n+  }\n+\n+  protected static void addEnvVar(List<V1EnvVar> vars, String name, String value) {\n+    vars.add(new V1EnvVar().name(name).value(value));\n+  }\n+\n+  protected static boolean listHasEnvVar(List<V1EnvVar> vars, String name) {\n+    for (V1EnvVar var : vars) {\n+      if (name.equals(var.getName())) {\n+        return true;\n+      }\n+    }\n+    return false;\n+  }\n+\n+  protected static void addIfMissing(List<V1EnvVar> vars, String name, String value) {\n+    if (!listHasEnvVar(vars, name)) {\n+      addEnvVar(vars, name, value);\n+    }\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46465788b1bc17357e3ff9c659af74f24ff77159"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NjExMDE5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2077#pullrequestreview-544611019", "createdAt": "2020-12-04T02:22:45Z", "commit": {"oid": "46465788b1bc17357e3ff9c659af74f24ff77159"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3952, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}