{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2OTcyNzA1", "number": 2039, "title": "Adding application high availability check in operator upgrade tests", "bodyText": "Adding application high availability check in operator upgrade tests.\nAn application is deployed to the cluster in the domain and the application is continuously accessed from a separate thread while the operator is being upgraded and after the upgrade.\nThis check is added only for operator releases 3.0.0 and later, Ryan confirmed this is not needed for older releases.\nJenkins results:\nsequential run - https://build.weblogick8s.org:8443/job/weblogic-kubernetes-operator-kind-new/3056/\nJust upgrade test - https://build.weblogick8s.org:8443/job/weblogic-kubernetes-operator-kind-new/3054/\nUpgrade tests are not run in parallel", "createdAt": "2020-11-06T20:48:09Z", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2039", "merged": true, "mergeCommit": {"oid": "daad271069a791b42f6fd351a11ab7f91651b375"}, "closed": true, "closedAt": "2020-11-09T21:28:30Z", "author": {"login": "vanajamukkara"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZ7oDCgH2gAyNTE2OTcyNzA1OjU5MTNiOWZmYzlmMTk5YzcxM2YwNmIxMGE2NTE2OTM5OWNhODU1NTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABda7OqkgFqTUyNjY0OTYwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5913b9ffc9f199c713f06b10a65169399ca85554", "author": {"user": {"login": "vanajamukkara", "name": "Vanajakshi Mukkara"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5913b9ffc9f199c713f06b10a65169399ca85554", "committedDate": "2020-11-06T18:53:29Z", "message": "adding app high availability check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84a0556dc24b04e8aee4ae6a07e39f755c979156", "author": {"user": {"login": "vanajamukkara", "name": "Vanajakshi Mukkara"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/84a0556dc24b04e8aee4ae6a07e39f755c979156", "committedDate": "2020-11-06T20:23:06Z", "message": "move checkAppIsRunning to common utils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81c9c7a918201f1d213e0e26878d4434922592b2", "author": {"user": {"login": "vanajamukkara", "name": "Vanajakshi Mukkara"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/81c9c7a918201f1d213e0e26878d4434922592b2", "committedDate": "2020-11-06T20:46:56Z", "message": "update test description"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NTEwMjEy", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2039#pullrequestreview-526510212", "createdAt": "2020-11-09T17:55:56Z", "commit": {"oid": "81c9c7a918201f1d213e0e26878d4434922592b2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNzo1NTo1NlrOHv6vCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxODowMTo1N1rOHv69vA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAwNzQzMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Check application availability while the operator upgrade is happening and once after the ugprade is complete\n          \n          \n            \n               * Check application availability while the operator upgrade is happening and once the ugprade is complete", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2039#discussion_r520007433", "createdAt": "2020-11-09T17:55:56Z", "author": {"login": "sankarpn"}, "path": "integration-tests/src/test/java/oracle/weblogic/kubernetes/ItOperatorUpgrade.java", "diffHunk": "@@ -402,4 +461,90 @@ private void checkDomainStarted(String domainUid, String domainNamespace) {\n     };\n   }\n \n+  private void deployAndAccessApplication(String namespace) {\n+    logger.info(\"Getting node port for admin server default channel\");\n+    int serviceNodePort = assertDoesNotThrow(() ->\n+            getServiceNodePort(namespace, getExternalServicePodName(adminServerPodName,\n+                TestConstants.OLD_DEFAULT_EXTERNAL_SERVICE_NAME_SUFFIX), \"default\"),\n+        \"Getting admin server node port failed\");\n+    assertNotEquals(-1, serviceNodePort, \"admin server default node port is not valid\");\n+\n+    Path archivePath = Paths.get(ITTESTS_DIR, \"../src/integration-tests/apps/testwebapp.war\");\n+    logger.info(\"Deploying application {0} to domain {1} cluster target cluster-1 in namespace {2}\",\n+        archivePath, domainUid, namespace);\n+    ExecResult result = DeployUtil.deployUsingRest(K8S_NODEPORT_HOST,\n+        String.valueOf(serviceNodePort),\n+        ADMIN_USERNAME_DEFAULT, ADMIN_PASSWORD_DEFAULT,\n+        \"cluster-1\", archivePath, null, \"testwebapp\");\n+    assertNotNull(result, \"Application deployment failed\");\n+    logger.info(\"Application deployment returned {0}\", result.toString());\n+    assertEquals(\"202\", result.stdout(), \"Deployment didn't return HTTP status code 202\");\n+\n+    // check if the application is accessible inside of a server pod using quick retry policy\n+    logger.info(\"Check and wait for the application to become ready\");\n+    for (int i = 1; i <= replicaCount; i++) {\n+      checkAppIsRunning(withQuickRetryPolicy, namespace, managedServerPodNamePrefix + i,\n+          \"8001\", \"testwebapp/index.jsp\", managedServerPodNamePrefix + i);\n+    }\n+  }\n+\n+  /**\n+   * Check application availability while the operator upgrade is happening and once after the ugprade is complete", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81c9c7a918201f1d213e0e26878d4434922592b2"}, "originalPosition": 250}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAwODk0MA==", "bodyText": "Is there a reason for the delay here?", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2039#discussion_r520008940", "createdAt": "2020-11-09T17:58:23Z", "author": {"login": "sankarpn"}, "path": "integration-tests/src/test/java/oracle/weblogic/kubernetes/ItOperatorUpgrade.java", "diffHunk": "@@ -402,4 +461,90 @@ private void checkDomainStarted(String domainUid, String domainNamespace) {\n     };\n   }\n \n+  private void deployAndAccessApplication(String namespace) {\n+    logger.info(\"Getting node port for admin server default channel\");\n+    int serviceNodePort = assertDoesNotThrow(() ->\n+            getServiceNodePort(namespace, getExternalServicePodName(adminServerPodName,\n+                TestConstants.OLD_DEFAULT_EXTERNAL_SERVICE_NAME_SUFFIX), \"default\"),\n+        \"Getting admin server node port failed\");\n+    assertNotEquals(-1, serviceNodePort, \"admin server default node port is not valid\");\n+\n+    Path archivePath = Paths.get(ITTESTS_DIR, \"../src/integration-tests/apps/testwebapp.war\");\n+    logger.info(\"Deploying application {0} to domain {1} cluster target cluster-1 in namespace {2}\",\n+        archivePath, domainUid, namespace);\n+    ExecResult result = DeployUtil.deployUsingRest(K8S_NODEPORT_HOST,\n+        String.valueOf(serviceNodePort),\n+        ADMIN_USERNAME_DEFAULT, ADMIN_PASSWORD_DEFAULT,\n+        \"cluster-1\", archivePath, null, \"testwebapp\");\n+    assertNotNull(result, \"Application deployment failed\");\n+    logger.info(\"Application deployment returned {0}\", result.toString());\n+    assertEquals(\"202\", result.stdout(), \"Deployment didn't return HTTP status code 202\");\n+\n+    // check if the application is accessible inside of a server pod using quick retry policy\n+    logger.info(\"Check and wait for the application to become ready\");\n+    for (int i = 1; i <= replicaCount; i++) {\n+      checkAppIsRunning(withQuickRetryPolicy, namespace, managedServerPodNamePrefix + i,\n+          \"8001\", \"testwebapp/index.jsp\", managedServerPodNamePrefix + i);\n+    }\n+  }\n+\n+  /**\n+   * Check application availability while the operator upgrade is happening and once after the ugprade is complete\n+   * by accessing the application inside the managed server pods.\n+   */\n+  private static void collectAppAvailability(\n+      String domainNamespace,\n+      String operatorNamespace,\n+      List<Integer> appAvailability,\n+      String managedServerPrefix,\n+      int replicaCount,\n+      String internalPort,\n+      String appPath\n+  ) {\n+    // Access the pod periodically to check application's availability while upgrade is happening\n+    // and after upgrade is complete.\n+    // appAccessedAfterUpgrade is used to access the app once after upgrade is complete\n+    boolean appAccessedAfterUpgrade = false;\n+    while (!appAccessedAfterUpgrade) {\n+      boolean isUpgradeComplete = checkHelmReleaseRevision(OPERATOR_RELEASE_NAME, operatorNamespace, \"2\");\n+      // upgrade is not complete or app is not accessed after upgrade\n+      if (!isUpgradeComplete || !appAccessedAfterUpgrade) {\n+        for (int i = 1; i <= replicaCount; i++) {\n+          if (appAccessibleInPod(\n+              domainNamespace,\n+              managedServerPrefix + i,\n+              internalPort,\n+              appPath,\n+              managedServerPrefix + i)) {\n+            appAvailability.add(1);\n+            logger.fine(\"application is accessible in pod \" + managedServerPrefix + i);\n+          } else {\n+            appAvailability.add(0);\n+            logger.fine(\"application is not accessible in pod \" + managedServerPrefix + i);\n+          }\n+        }\n+      }\n+      if (isUpgradeComplete) {\n+        logger.info(\"Upgrade is complete and app is accessed after upgrade\");\n+        appAccessedAfterUpgrade = true;\n+      }\n+\n+      try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81c9c7a918201f1d213e0e26878d4434922592b2"}, "originalPosition": 290}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxMTE5Ng==", "bodyText": "what is the point of checking for both null and not null? If its null isn't it the next statement going to throw NPE?", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2039#discussion_r520011196", "createdAt": "2020-11-09T18:01:57Z", "author": {"login": "sankarpn"}, "path": "integration-tests/src/test/java/oracle/weblogic/kubernetes/ItOperatorUpgrade.java", "diffHunk": "@@ -169,7 +190,9 @@ public void testOperatorUpgradeFrom3_0_2(@Namespaces(3) List<String> namespaces)\n    */\n   @AfterEach\n   public void tearDown() {\n-    if (System.getenv(\"SKIP_CLEANUP\") == null) {\n+    if (System.getenv(\"SKIP_CLEANUP\") == null\n+        || (System.getenv(\"SKIP_CLEANUP\") != null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81c9c7a918201f1d213e0e26878d4434922592b2"}, "originalPosition": 110}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e733aa6f2c00386af5d88c8c74d6fd311c8430e0", "author": {"user": {"login": "vanajamukkara", "name": "Vanajakshi Mukkara"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e733aa6f2c00386af5d88c8c74d6fd311c8430e0", "committedDate": "2020-11-09T18:14:24Z", "message": "adding 3.0.3 upgrade test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32085f3e10609bab810d35605909b64b3e99ac04", "author": {"user": {"login": "vanajamukkara", "name": "Vanajakshi Mukkara"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/32085f3e10609bab810d35605909b64b3e99ac04", "committedDate": "2020-11-09T18:16:14Z", "message": "Update integration-tests/src/test/java/oracle/weblogic/kubernetes/ItOperatorUpgrade.java\n\nCo-authored-by: Sankar Periyathambi Neelakandan <45743425+sankarpn@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cc605aff9815e0ac445015deb7d480b69c8e052", "author": {"user": {"login": "vanajamukkara", "name": "Vanajakshi Mukkara"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5cc605aff9815e0ac445015deb7d480b69c8e052", "committedDate": "2020-11-09T18:49:26Z", "message": "removing sleep"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cc2b63ec6a37a9ca5f9d6dbfc13b30814642722", "author": {"user": {"login": "vanajamukkara", "name": "Vanajakshi Mukkara"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/2cc2b63ec6a37a9ca5f9d6dbfc13b30814642722", "committedDate": "2020-11-09T18:50:16Z", "message": "Merge branch 'highavailabilitytests' of https://github.com/oracle/weblogic-kubernetes-operator into highavailabilitytests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NjQzMDAy", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2039#pullrequestreview-526643002", "createdAt": "2020-11-09T20:50:07Z", "commit": {"oid": "2cc2b63ec6a37a9ca5f9d6dbfc13b30814642722"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NjQ5NjA4", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2039#pullrequestreview-526649608", "createdAt": "2020-11-09T20:59:41Z", "commit": {"oid": "2cc2b63ec6a37a9ca5f9d6dbfc13b30814642722"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3899, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}