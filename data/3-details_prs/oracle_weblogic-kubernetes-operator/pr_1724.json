{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNzYyMjQy", "number": 1724, "title": "Scale a cluster using WLDF Policy", "bodyText": "Add test infrastructure support for scaling a cluster using WLDF Policy. Also add the test case to scale the cluster using WLDF.\nJenkins test result:\nhttps://build.weblogick8s.org:8443/view/all/job/weblogic-kubernetes-operator-kind-new/429/\nhttps://build.weblogick8s.org:8443/view/all/job/weblogic-kubernetes-operator-model-in-image-tests/1016/", "createdAt": "2020-06-11T00:02:37Z", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724", "merged": true, "mergeCommit": {"oid": "ef5ae92848ff2481bba556db1201c124a36686ef"}, "closed": true, "closedAt": "2020-06-19T18:33:51Z", "author": {"login": "xiancao"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABco1r6RgH2gAyNDMyNzYyMjQyOjQ2NzVjNTdkZmFiMzg3YjYwNDQzYmMwZTlhNDQ4ZGU5ODQ0OTJjNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcshkyeAH2gAyNDMyNzYyMjQyOmMwZGZiZTliN2FiOGViOGU5Mzk3ZTI2OWFlODc2NWYxZGMyOGVlM2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4675c57dfab387b60443bc0e9a448de984492c71", "author": {"user": {"login": "xiancao", "name": "Xian Cao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/4675c57dfab387b60443bc0e9a448de984492c71", "committedDate": "2020-06-07T06:15:59Z", "message": "initial commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "744d58b94548909c4d8e28dfd69cfecd4d632aa6", "author": {"user": {"login": "xiancao", "name": "Xian Cao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/744d58b94548909c4d8e28dfd69cfecd4d632aa6", "committedDate": "2020-06-07T06:23:13Z", "message": "get the latest develop branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd0a1a739d22b0b86d2f53a408f2420b1dabb206", "author": {"user": {"login": "xiancao", "name": "Xian Cao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/fd0a1a739d22b0b86d2f53a408f2420b1dabb206", "committedDate": "2020-06-09T21:56:51Z", "message": "scale cluster with WLDF"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eca477f4f74377b410323253e0118e6deaee1eb7", "author": {"user": {"login": "xiancao", "name": "Xian Cao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/eca477f4f74377b410323253e0118e6deaee1eb7", "committedDate": "2020-06-09T21:57:10Z", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into xc-wldfscale"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc2f167c6ad4df375cc034c1391591925979d706", "author": {"user": {"login": "xiancao", "name": "Xian Cao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/dc2f167c6ad4df375cc034c1391591925979d706", "committedDate": "2020-06-10T22:40:08Z", "message": "refactor the code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbd627871d9abd9212f3dd56a2b5677f69c7e945", "author": {"user": {"login": "xiancao", "name": "Xian Cao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/bbd627871d9abd9212f3dd56a2b5677f69c7e945", "committedDate": "2020-06-10T23:54:37Z", "message": "add more logging information"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NTA5MzA5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#pullrequestreview-428509309", "createdAt": "2020-06-11T00:10:20Z", "commit": {"oid": "bbd627871d9abd9212f3dd56a2b5677f69c7e945"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMDoxMDoyMFrOGiKSuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMDoxMDoyMFrOGiKSuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3MzQwMw==", "bodyText": "Missing javadoc for the usecase detail", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#discussion_r438473403", "createdAt": "2020-06-11T00:10:20Z", "author": {"login": "anpanigr"}, "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItScaleMiiDomainNginx.java", "diffHunk": "@@ -196,19 +214,58 @@ public void testScaleClustersWithRestApi() {\n     }\n   }\n \n+  @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbd627871d9abd9212f3dd56a2b5677f69c7e945"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NTA5NTIx", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#pullrequestreview-428509521", "createdAt": "2020-06-11T00:11:06Z", "commit": {"oid": "bbd627871d9abd9212f3dd56a2b5677f69c7e945"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMDoxMTowNlrOGiKThw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMDoxMTowNlrOGiKThw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3MzYwNw==", "bodyText": "Remove TODO comment", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#discussion_r438473607", "createdAt": "2020-06-11T00:11:06Z", "author": {"login": "anpanigr"}, "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItScaleMiiDomainNginx.java", "diffHunk": "@@ -196,19 +214,58 @@ public void testScaleClustersWithRestApi() {\n     }\n   }\n \n+  @Test\n+  @DisplayName(\"Verify scale each cluster of the domain by using WLDF policy\")\n+  public void testScaleClustersWithWLDF() {\n+    for (int i = 1; i <= NUMBER_OF_CLUSTERS; i++) {\n+\n+      String clusterName = CLUSTER_NAME_PREFIX + i;\n+      curlCmd = generateCurlCmd(clusterName, SAMPLE_APP_CONTEXT_ROOT);\n+\n+      // scale up the cluster by 1 server\n+      logger.info(\"Scaling cluster {0} of domain {1} in namespace {2} from {3} servers to {4} servers.\",\n+          clusterName, domainUid, domainNamespace, replicaCount, replicaCount + 1);\n+      List<String> managedServersBeforeScale = listManagedServersBeforeScale(clusterName, replicaCount);\n+      scaleClusterAndVerifyWithWLDF(clusterName, replicaCount, replicaCount + 1,\n+          managedServersBeforeScale, \"scaleUp\");\n+\n+      // scale down the cluster by 1 server\n+      logger.info(\"Scaling cluster {0} of domain {1} in namespace {2} from {3} servers to {4} servers.\",\n+          clusterName, domainUid, domainNamespace, replicaCount + 1, replicaCount);\n+      managedServersBeforeScale = listManagedServersBeforeScale(clusterName, replicaCount + 1);\n+      scaleClusterAndVerifyWithWLDF(clusterName, replicaCount + 1, replicaCount,\n+          managedServersBeforeScale, \"scaleDown\");\n+    }\n+  }\n+\n   /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbd627871d9abd9212f3dd56a2b5677f69c7e945"}, "originalPosition": 101}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NTEwNDg3", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#pullrequestreview-428510487", "createdAt": "2020-06-11T00:14:12Z", "commit": {"oid": "bbd627871d9abd9212f3dd56a2b5677f69c7e945"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMDoxNDoxMlrOGiKW1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMDoxNDoxMlrOGiKW1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NDQ1NQ==", "bodyText": "Missing copyright Information", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#discussion_r438474455", "createdAt": "2020-06-11T00:14:12Z", "author": {"login": "anpanigr"}, "path": "new-integration-tests/src/test/resources/python-scripts/wldf.py", "diffHunk": "@@ -0,0 +1,96 @@\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbd627871d9abd9212f3dd56a2b5677f69c7e945"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8964ae81065659444c8671f0adef9c2af09986c", "author": {"user": {"login": "xiancao", "name": "Xian Cao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/c8964ae81065659444c8671f0adef9c2af09986c", "committedDate": "2020-06-11T00:30:24Z", "message": "add copyright"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95a0f7fa6a1905fc7ed0539c52bcfe0a40990d37", "author": {"user": {"login": "xiancao", "name": "Xian Cao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/95a0f7fa6a1905fc7ed0539c52bcfe0a40990d37", "committedDate": "2020-06-11T17:01:52Z", "message": "get the latest develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06b6fc6c6497c7a0680da21e7372c3f2ea579ccc", "author": {"user": {"login": "xiancao", "name": "Xian Cao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/06b6fc6c6497c7a0680da21e7372c3f2ea579ccc", "committedDate": "2020-06-11T18:31:55Z", "message": "resolve merge conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebc9ac7d3af6647d9a9b1e6d3bfcf4e21caed56f", "author": {"user": {"login": "xiancao", "name": "Xian Cao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ebc9ac7d3af6647d9a9b1e6d3bfcf4e21caed56f", "committedDate": "2020-06-12T16:48:52Z", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into xc-wldfscale"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5OTU2NjYx", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#pullrequestreview-429956661", "createdAt": "2020-06-12T18:32:16Z", "commit": {"oid": "06b6fc6c6497c7a0680da21e7372c3f2ea579ccc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODozMjoxN1rOGjN6OA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODozMjoxN1rOGjN6OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU4MTI0MA==", "bodyText": "Does this work to use 0 for the nodePort? My expectation is that Kubernetes will fill in the port on the NodePort-type Service. But the introspector won't know what port will be filled in...  Or, asked another way, this might work for HTTP, but won't work for T3.", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#discussion_r439581240", "createdAt": "2020-06-12T18:32:17Z", "author": {"login": "rjeberhard"}, "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItScaleMiiDomainNginx.java", "diffHunk": "@@ -275,7 +340,11 @@ private static void createMiiDomainWithMultiClusters() {\n                     .name(\"USER_MEM_ARGS\")\n                     .value(\"-Djava.security.egd=file:/dev/./urandom \")))\n             .adminServer(new AdminServer()\n-                .serverStartState(\"RUNNING\"))\n+                .serverStartState(\"RUNNING\")\n+                .adminService(new AdminService()\n+                    .addChannelsItem(new Channel()\n+                        .channelName(\"default\")\n+                        .nodePort(0))))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06b6fc6c6497c7a0680da21e7372c3f2ea579ccc"}, "originalPosition": 163}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5OTU4NTY5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#pullrequestreview-429958569", "createdAt": "2020-06-12T18:35:30Z", "commit": {"oid": "06b6fc6c6497c7a0680da21e7372c3f2ea579ccc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODozNTozMVrOGjN_zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODozNTozMVrOGjN_zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU4MjY2OQ==", "bodyText": "This feels like it is working around a bug. Why do we have to copy a script to the admin pod?", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#discussion_r439582669", "createdAt": "2020-06-12T18:35:31Z", "author": {"login": "rjeberhard"}, "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/Domain.java", "diffHunk": "@@ -292,4 +324,231 @@ public static boolean scaleClusterWithRestApi(String domainUid,\n \n     return Command.withParams(params).execute();\n   }\n+\n+  /**\n+   * Scale the cluster of the domain in the specified namespace with WLDF.\n+   *\n+   * @param clusterName name of the WebLogic cluster to be scaled in the domain\n+   * @param domainUid domainUid of the domain to be scaled\n+   * @param domainNamespace domain namespace in which the domain exists\n+   * @param domainHomeLocation domain home location of the domain\n+   * @param scalingAction scaling action, accepted value: scaleUp or scaleDown\n+   * @param scalingSize number of servers to be scaled up or down\n+   * @param opNamespace namespace of WebLogic operator\n+   * @param opServiceAccount service account of operator\n+   * @param myWebAppName web app name deployed to the domain used in the WLDF policy expression\n+   * @param curlCommand curl command to call the web app used in the WLDF policy expression\n+   * @return true if scaling the cluster succeeds, false otherwise\n+   * @throws ApiException if Kubernetes client API call fails\n+   * @throws IOException if an I/O error occurs\n+   * @throws InterruptedException if any thread has interrupted the current thread\n+   */\n+  public static boolean scaleClusterWithWLDF(String clusterName,\n+                                             String domainUid,\n+                                             String domainNamespace,\n+                                             String domainHomeLocation,\n+                                             String scalingAction,\n+                                             int scalingSize,\n+                                             String opNamespace,\n+                                             String opServiceAccount,\n+                                             String myWebAppName,\n+                                             String curlCommand)\n+      throws ApiException, IOException, InterruptedException {\n+\n+    // create RBAC API objects for WLDF script\n+    logger.info(\"Creating RBAC API objects for WLDF script\");\n+    if (!createRbacApiObjectsForWLDFScript(domainNamespace, opNamespace)) {\n+      return false;\n+    }\n+\n+    // copy scalingAction.sh to Admin Server pod\n+    // NOTE: you must copy scalingAction.sh to $DOMAIN_HOME/bin/scripts on admin server pod\n+    String adminServerPodName = domainUid + \"-\" + ADMIN_SERVER_NAME_BASE;\n+    V1Pod adminPod = Kubernetes.getPod(domainNamespace, null, adminServerPodName);\n+    if (adminPod == null) {\n+      logger.info(\"The admin pod {0} does not exist in namespace {1}!\", adminServerPodName, domainNamespace);\n+      return false;\n+    }\n+\n+    // create $DOMAIN_HOME/bin/scripts directory on admin server pod\n+    logger.info(\"Creating directory {0}/bin/scripts on admin server pod\", domainHomeLocation);\n+    ExecResult result = exec(adminPod, null, true,\n+        \"/bin/sh\", \"-c\", \"mkdir -p \" + domainHomeLocation + \"/bin/scripts\");\n+    if (result.exitValue() != 0) {\n+      return false;\n+    }\n+\n+    logger.info(\"Copying scalingAction.sh to admin server pod\");\n+    try {\n+      copyFileToPod(domainNamespace, adminServerPodName, null,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06b6fc6c6497c7a0680da21e7372c3f2ea579ccc"}, "originalPosition": 112}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5OTU5MjYx", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#pullrequestreview-429959261", "createdAt": "2020-06-12T18:36:40Z", "commit": {"oid": "06b6fc6c6497c7a0680da21e7372c3f2ea579ccc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODozNjo0MFrOGjOB1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODozNjo0MFrOGjOB1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU4MzE4OA==", "bodyText": "I don't understand the flow here. Why are we exec'ing a scaling action and then also calling a wldf script? I don't understand the use case being tested.", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#discussion_r439583188", "createdAt": "2020-06-12T18:36:40Z", "author": {"login": "rjeberhard"}, "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/Domain.java", "diffHunk": "@@ -292,4 +324,231 @@ public static boolean scaleClusterWithRestApi(String domainUid,\n \n     return Command.withParams(params).execute();\n   }\n+\n+  /**\n+   * Scale the cluster of the domain in the specified namespace with WLDF.\n+   *\n+   * @param clusterName name of the WebLogic cluster to be scaled in the domain\n+   * @param domainUid domainUid of the domain to be scaled\n+   * @param domainNamespace domain namespace in which the domain exists\n+   * @param domainHomeLocation domain home location of the domain\n+   * @param scalingAction scaling action, accepted value: scaleUp or scaleDown\n+   * @param scalingSize number of servers to be scaled up or down\n+   * @param opNamespace namespace of WebLogic operator\n+   * @param opServiceAccount service account of operator\n+   * @param myWebAppName web app name deployed to the domain used in the WLDF policy expression\n+   * @param curlCommand curl command to call the web app used in the WLDF policy expression\n+   * @return true if scaling the cluster succeeds, false otherwise\n+   * @throws ApiException if Kubernetes client API call fails\n+   * @throws IOException if an I/O error occurs\n+   * @throws InterruptedException if any thread has interrupted the current thread\n+   */\n+  public static boolean scaleClusterWithWLDF(String clusterName,\n+                                             String domainUid,\n+                                             String domainNamespace,\n+                                             String domainHomeLocation,\n+                                             String scalingAction,\n+                                             int scalingSize,\n+                                             String opNamespace,\n+                                             String opServiceAccount,\n+                                             String myWebAppName,\n+                                             String curlCommand)\n+      throws ApiException, IOException, InterruptedException {\n+\n+    // create RBAC API objects for WLDF script\n+    logger.info(\"Creating RBAC API objects for WLDF script\");\n+    if (!createRbacApiObjectsForWLDFScript(domainNamespace, opNamespace)) {\n+      return false;\n+    }\n+\n+    // copy scalingAction.sh to Admin Server pod\n+    // NOTE: you must copy scalingAction.sh to $DOMAIN_HOME/bin/scripts on admin server pod\n+    String adminServerPodName = domainUid + \"-\" + ADMIN_SERVER_NAME_BASE;\n+    V1Pod adminPod = Kubernetes.getPod(domainNamespace, null, adminServerPodName);\n+    if (adminPod == null) {\n+      logger.info(\"The admin pod {0} does not exist in namespace {1}!\", adminServerPodName, domainNamespace);\n+      return false;\n+    }\n+\n+    // create $DOMAIN_HOME/bin/scripts directory on admin server pod\n+    logger.info(\"Creating directory {0}/bin/scripts on admin server pod\", domainHomeLocation);\n+    ExecResult result = exec(adminPod, null, true,\n+        \"/bin/sh\", \"-c\", \"mkdir -p \" + domainHomeLocation + \"/bin/scripts\");\n+    if (result.exitValue() != 0) {\n+      return false;\n+    }\n+\n+    logger.info(\"Copying scalingAction.sh to admin server pod\");\n+    try {\n+      copyFileToPod(domainNamespace, adminServerPodName, null,\n+          Paths.get(PROJECT_ROOT + \"/../src/scripts/scaling/scalingAction.sh\"),\n+          Paths.get(domainHomeLocation + \"/bin/scripts/scalingAction.sh\"));\n+    } catch (ApiException apex) {\n+      logger.severe(\"Got ApiException while copying file to admin pod {0}\", apex.getResponseBody());\n+      return false;\n+    } catch (IOException ioex) {\n+      logger.severe(\"Got IOException while copying file to admin pod {0}\", ioex.getStackTrace());\n+      return false;\n+    }\n+\n+    logger.info(\"Adding execute mode for scalingAction.sh\");\n+    result = exec(adminPod, null, true,\n+        \"/bin/sh\", \"-c\", \"chmod +x \" + domainHomeLocation + \"/bin/scripts/scalingAction.sh\");\n+    if (result.exitValue() != 0) {\n+      return false;\n+    }\n+\n+    // copy wldf.py and callpyscript.sh to Admin Server pod\n+    logger.info(\"Copying wldf.py and callpyscript.sh to admin server pod\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06b6fc6c6497c7a0680da21e7372c3f2ea579ccc"}, "originalPosition": 131}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMDY1OTIw", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#pullrequestreview-430065920", "createdAt": "2020-06-12T22:21:10Z", "commit": {"oid": "ebc9ac7d3af6647d9a9b1e6d3bfcf4e21caed56f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQyMjoyMToxMFrOGjTASQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQyMjoyMToxMFrOGjTASQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY2NDcxMw==", "bodyText": "why do we need to generate zip for each app if multiple app names are provided? it will zip all of them into one zip file with name of first provided app name dir.", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#discussion_r439664713", "createdAt": "2020-06-12T22:21:10Z", "author": {"login": "marinakog"}, "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/utils/CommonTestUtils.java", "diffHunk": "@@ -628,29 +631,41 @@ public static String createMiiImageAndVerify(String miiImageNameBase,\n \n       if (archiveAppsList.size() != 0 && archiveAppsList.get(0) != null) {\n         assertTrue(archiveApp(defaultAppParams()\n-                .srcDirList(archiveAppsList)));\n+            .srcDirList(archiveAppsList)));\n         //archive provided ear or war file\n         String appName = archiveAppsList.get(0).substring(archiveAppsList.get(0).lastIndexOf(\"/\") + 1,\n-                appSrcDirList.get(0).lastIndexOf(\".\"));\n+            appSrcDirList.get(0).lastIndexOf(\".\"));\n \n         // build the archive list\n         String zipAppFile = String.format(\"%s/%s.zip\", ARCHIVE_DIR, appName);\n         archiveList.add(zipAppFile);\n \n       }\n+\n       if (buildAppDirList.size() != 0 && buildAppDirList.get(0) != null) {\n         // build an application archive using what is in resources/apps/APP_NAME\n-        assertTrue(buildAppArchive(defaultAppParams()\n-                        .srcDirList(buildAppDirList)),\n-                String.format(\"Failed to create app archive for %s\", buildAppDirList.get(0)));\n-\n-        // build the archive list\n-        String zipFile = String.format(\"%s/%s.zip\", ARCHIVE_DIR, buildAppDirList.get(0));\n-        archiveList.add(zipFile);\n+        String zipFile = \"\";\n+        if (oneArchiveContainsMultiApps) {\n+          assertTrue(buildAppArchive(defaultAppParams()\n+                  .srcDirList(buildAppDirList)),\n+              String.format(\"Failed to create app archive for %s\", buildAppDirList.get(0)));\n+          zipFile = String.format(\"%s/%s.zip\", ARCHIVE_DIR, buildAppDirList.get(0));\n+          // build the archive list\n+          archiveList.add(zipFile);\n+        } else {\n+          for (String appName : buildAppDirList) {\n+            assertTrue(buildAppArchive(defaultAppParams()\n+                    .srcDirList(Collections.singletonList(appName))\n+                    .appName(appName)),\n+                String.format(\"Failed to create app archive for %s\", appName));\n+            zipFile = String.format(\"%s/%s.zip\", ARCHIVE_DIR, appName);\n+            // build the archive list\n+            archiveList.add(zipFile);\n+          }\n+        }\n       }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebc9ac7d3af6647d9a9b1e6d3bfcf4e21caed56f"}, "originalPosition": 104}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNjkwNTg5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#pullrequestreview-431690589", "createdAt": "2020-06-16T16:32:34Z", "commit": {"oid": "ebc9ac7d3af6647d9a9b1e6d3bfcf4e21caed56f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjozMjozNVrOGkjt9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjo0MDoyM1rOGkkDKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk4NzEyNA==", "bodyText": "do we still need this?", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#discussion_r440987124", "createdAt": "2020-06-16T16:32:35Z", "author": {"login": "sankarpn"}, "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Kubernetes.java", "diffHunk": "@@ -130,6 +130,11 @@\n     try {\n       Configuration.setDefaultApiClient(ClientBuilder.defaultClient());\n       apiClient = Configuration.getDefaultApiClient();\n+      // disable connection and read write timeout to force the internal HTTP client\n+      // to keep a long running connection with the server to fix SSL connection closed issue\n+      apiClient.setConnectTimeout(0);\n+      apiClient.setReadTimeout(0);\n+      apiClient.setWriteTimeout(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebc9ac7d3af6647d9a9b1e6d3bfcf4e21caed56f"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5MjU1NQ==", "bodyText": "Why not use the WLSTUtils.executeWLSTScript(...)?\nYou don't need to use a intermediate script like callpyscript.sh if you use above", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#discussion_r440992555", "createdAt": "2020-06-16T16:40:23Z", "author": {"login": "sankarpn"}, "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/Domain.java", "diffHunk": "@@ -292,4 +324,231 @@ public static boolean scaleClusterWithRestApi(String domainUid,\n \n     return Command.withParams(params).execute();\n   }\n+\n+  /**\n+   * Scale the cluster of the domain in the specified namespace with WLDF.\n+   *\n+   * @param clusterName name of the WebLogic cluster to be scaled in the domain\n+   * @param domainUid domainUid of the domain to be scaled\n+   * @param domainNamespace domain namespace in which the domain exists\n+   * @param domainHomeLocation domain home location of the domain\n+   * @param scalingAction scaling action, accepted value: scaleUp or scaleDown\n+   * @param scalingSize number of servers to be scaled up or down\n+   * @param opNamespace namespace of WebLogic operator\n+   * @param opServiceAccount service account of operator\n+   * @param myWebAppName web app name deployed to the domain used in the WLDF policy expression\n+   * @param curlCommand curl command to call the web app used in the WLDF policy expression\n+   * @return true if scaling the cluster succeeds, false otherwise\n+   * @throws ApiException if Kubernetes client API call fails\n+   * @throws IOException if an I/O error occurs\n+   * @throws InterruptedException if any thread has interrupted the current thread\n+   */\n+  public static boolean scaleClusterWithWLDF(String clusterName,\n+                                             String domainUid,\n+                                             String domainNamespace,\n+                                             String domainHomeLocation,\n+                                             String scalingAction,\n+                                             int scalingSize,\n+                                             String opNamespace,\n+                                             String opServiceAccount,\n+                                             String myWebAppName,\n+                                             String curlCommand)\n+      throws ApiException, IOException, InterruptedException {\n+\n+    // create RBAC API objects for WLDF script\n+    logger.info(\"Creating RBAC API objects for WLDF script\");\n+    if (!createRbacApiObjectsForWLDFScript(domainNamespace, opNamespace)) {\n+      return false;\n+    }\n+\n+    // copy scalingAction.sh to Admin Server pod\n+    // NOTE: you must copy scalingAction.sh to $DOMAIN_HOME/bin/scripts on admin server pod\n+    String adminServerPodName = domainUid + \"-\" + ADMIN_SERVER_NAME_BASE;\n+    V1Pod adminPod = Kubernetes.getPod(domainNamespace, null, adminServerPodName);\n+    if (adminPod == null) {\n+      logger.info(\"The admin pod {0} does not exist in namespace {1}!\", adminServerPodName, domainNamespace);\n+      return false;\n+    }\n+\n+    // create $DOMAIN_HOME/bin/scripts directory on admin server pod\n+    logger.info(\"Creating directory {0}/bin/scripts on admin server pod\", domainHomeLocation);\n+    ExecResult result = exec(adminPod, null, true,\n+        \"/bin/sh\", \"-c\", \"mkdir -p \" + domainHomeLocation + \"/bin/scripts\");\n+    if (result.exitValue() != 0) {\n+      return false;\n+    }\n+\n+    logger.info(\"Copying scalingAction.sh to admin server pod\");\n+    try {\n+      copyFileToPod(domainNamespace, adminServerPodName, null,\n+          Paths.get(PROJECT_ROOT + \"/../src/scripts/scaling/scalingAction.sh\"),\n+          Paths.get(domainHomeLocation + \"/bin/scripts/scalingAction.sh\"));\n+    } catch (ApiException apex) {\n+      logger.severe(\"Got ApiException while copying file to admin pod {0}\", apex.getResponseBody());\n+      return false;\n+    } catch (IOException ioex) {\n+      logger.severe(\"Got IOException while copying file to admin pod {0}\", ioex.getStackTrace());\n+      return false;\n+    }\n+\n+    logger.info(\"Adding execute mode for scalingAction.sh\");\n+    result = exec(adminPod, null, true,\n+        \"/bin/sh\", \"-c\", \"chmod +x \" + domainHomeLocation + \"/bin/scripts/scalingAction.sh\");\n+    if (result.exitValue() != 0) {\n+      return false;\n+    }\n+\n+    // copy wldf.py and callpyscript.sh to Admin Server pod\n+    logger.info(\"Copying wldf.py and callpyscript.sh to admin server pod\");\n+    try {\n+      copyFileToPod(domainNamespace, adminServerPodName, null,\n+          Paths.get(RESOURCE_DIR, \"python-scripts\", \"wldf.py\"),\n+          Paths.get(\"/u01/oracle/wldf.py\"));\n+\n+      copyFileToPod(domainNamespace, adminServerPodName, null,\n+          Paths.get(RESOURCE_DIR, \"bash-scripts\", \"callpyscript.sh\"),\n+          Paths.get(\"/u01/oracle/callpyscript.sh\"));\n+    } catch (ApiException apex) {\n+      logger.severe(\"Got ApiException while copying file to admin pod {0}\", apex.getResponseBody());\n+      return false;\n+    } catch (IOException ioex) {\n+      logger.severe(\"Got IOException while copying file to admin pod {0}\", ioex.getStackTrace());\n+      return false;\n+    }\n+\n+    logger.info(\"Adding execute mode for callpyscript.sh\");\n+    result = exec(adminPod, null, true,\n+        \"/bin/sh\", \"-c\", \"chmod +x /u01/oracle/callpyscript.sh\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebc9ac7d3af6647d9a9b1e6d3bfcf4e21caed56f"}, "originalPosition": 150}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a45a84059b5517acc3cf62c7e6a3a4b146957457", "author": {"user": {"login": "xiancao", "name": "Xian Cao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a45a84059b5517acc3cf62c7e6a3a4b146957457", "committedDate": "2020-06-16T17:26:55Z", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into xc-wldfscale"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxOTIxMTgy", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#pullrequestreview-431921182", "createdAt": "2020-06-16T21:57:06Z", "commit": {"oid": "ebc9ac7d3af6647d9a9b1e6d3bfcf4e21caed56f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxOTMzNzU0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1724#pullrequestreview-431933754", "createdAt": "2020-06-16T22:23:11Z", "commit": {"oid": "ebc9ac7d3af6647d9a9b1e6d3bfcf4e21caed56f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "469658f0a1f444d06f7d5157be01470d0a71b426", "author": {"user": {"login": "xiancao", "name": "Xian Cao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/469658f0a1f444d06f7d5157be01470d0a71b426", "committedDate": "2020-06-17T16:01:06Z", "message": "resolve merge conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1ab3a71e497b2299f0a3892e9e67310d9c73566", "author": {"user": {"login": "xiancao", "name": "Xian Cao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b1ab3a71e497b2299f0a3892e9e67310d9c73566", "committedDate": "2020-06-18T16:39:29Z", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into xc-wldfscale"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0dfbe9b7ab8eb8e9397e269ae8765f1dc28ee3e", "author": {"user": {"login": "xiancao", "name": "Xian Cao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/c0dfbe9b7ab8eb8e9397e269ae8765f1dc28ee3e", "committedDate": "2020-06-18T17:05:48Z", "message": "get the latest develop"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4514, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}