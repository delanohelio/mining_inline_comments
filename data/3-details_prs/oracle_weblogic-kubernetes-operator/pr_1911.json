{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1NDMzNzYy", "number": 1911, "title": "OWLS-80038 and OWLS-80090: fix mountPath validation and token substitution", "bodyText": "When the domain spec is validated before the operator starts a domain, the mountPath of a volumeMount is checked to see if it is valid. A mountPath may contain tokens, such as $(DOMAIN_HOME), or $(SERVER_NAME), which are substituted when the operator has the actual values. The problem is that the token substitution happens after the domain spec validation, so a mountPath that contains tokens are considered invalid.\nThe PR contains the following changes/fixes with unit test cases:\n\nAdd code to detect if a mountPath value contains tokens of valid reserved/custom env var names, and if it does, the operator skips the mountPath part of the domain spec validation and defer it to later.\nAdd a validation step to check mountPath in WLS server pods and introspector job/pod spec after the token substitution happens. If the check fails, the operator quits with an failure message in the domain status.\nFix a bug where volume mounts in the admin server's serverPod and cluster's serverPod are not checked when the domain spec is validated.\n\nhttps://build.weblogick8s.org:8443/job/weblogic-kubernetes-operator-kind-new/1901/", "createdAt": "2020-09-11T20:30:46Z", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1911", "merged": true, "mergeCommit": {"oid": "604c987e33e1801313cc9434ea9cb037c94085a0"}, "closed": true, "closedAt": "2020-09-17T15:06:58Z", "author": {"login": "doxiao"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFot0FAH2gAyNDg1NDMzNzYyOjY3MDhiNzIwNDg5NjFjZjdmNTdlNDYwNmM1YjY5YWNjZTIyOWE2ZTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJNuEFAH2gAyNDg1NDMzNzYyOmQ1ZDI0NTVlMTczNDg2ZWVjZmJhMzAzOTdkYzg2NDlhMzM5YjhiNjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6708b72048961cf7f57e4606c5b69acce229a6e6", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6708b72048961cf7f57e4606c5b69acce229a6e6", "committedDate": "2020-09-04T17:33:06Z", "message": "Skip volume mount path validation if it contains valid tokens"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30a984372a0d782422e704fe4ea6f1f05faa75bd", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/30a984372a0d782422e704fe4ea6f1f05faa75bd", "committedDate": "2020-09-04T19:21:05Z", "message": "Merge remote-tracking branch 'origin/develop' into owls80038-mountpath"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6c637399bb557364fe3dada56f4b5e642754c73", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b6c637399bb557364fe3dada56f4b5e642754c73", "committedDate": "2020-09-08T17:28:57Z", "message": "Check admin serverPod's additional volume mount paths too in domain validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2e203248838313c260d9d04fc4dd826d7858f97", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e2e203248838313c260d9d04fc4dd826d7858f97", "committedDate": "2020-09-08T19:40:21Z", "message": "Check cluster serverPod's additional mount paths too in domain validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0c64e624e5bf26a20dc522f79d7367b064ee4ae", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e0c64e624e5bf26a20dc522f79d7367b064ee4ae", "committedDate": "2020-09-10T17:32:01Z", "message": "check mountpath validation after token substitution is performed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f5244e23d10f0f12acc64cda2fb47f41214a832", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/2f5244e23d10f0f12acc64cda2fb47f41214a832", "committedDate": "2020-09-10T20:07:28Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80ac79d6a2959427c9533165ae3ecdd3da6b254b", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/80ac79d6a2959427c9533165ae3ecdd3da6b254b", "committedDate": "2020-09-10T20:51:23Z", "message": "fine tuning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f1f8ce088f13ada9b132424e4c57619006ef0e3", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3f1f8ce088f13ada9b132424e4c57619006ef0e3", "committedDate": "2020-09-10T20:53:13Z", "message": "Merge remote-tracking branch 'origin/develop' into owls80038-mountpath"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1127e4778dc73b142472051d200416484c5da5da", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1127e4778dc73b142472051d200416484c5da5da", "committedDate": "2020-09-10T21:00:42Z", "message": "minor cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "568ff48197becbcf77dfdafe45f3942ace5f79e9", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/568ff48197becbcf77dfdafe45f3942ace5f79e9", "committedDate": "2020-09-11T14:25:29Z", "message": "In progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1831620d4bbad374fd15113838859b2251ae24b9", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1831620d4bbad374fd15113838859b2251ae24b9", "committedDate": "2020-09-11T16:43:34Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc9df985719f7a1969e30051bc472ca309e453cf", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/cc9df985719f7a1969e30051bc472ca309e453cf", "committedDate": "2020-09-11T20:06:51Z", "message": "minor change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "877de6f1ee9e08e9361a0f1f8909a5bbd042afdd", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/877de6f1ee9e08e9361a0f1f8909a5bbd042afdd", "committedDate": "2020-09-14T14:10:25Z", "message": "Merge remote-tracking branch 'origin/develop' into owls80038-mountpath"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4OTY0NDUy", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1911#pullrequestreview-488964452", "createdAt": "2020-09-15T18:44:50Z", "commit": {"oid": "877de6f1ee9e08e9361a0f1f8909a5bbd042afdd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MDEyNTEx", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1911#pullrequestreview-489012511", "createdAt": "2020-09-15T19:40:23Z", "commit": {"oid": "877de6f1ee9e08e9361a0f1f8909a5bbd042afdd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxOTo0MDoyNFrOHSRvKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxOTo0MDoyNFrOHSRvKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkyNzAxOA==", "bodyText": "Should this test be named ..._jobNotCreated rather than ..._reportValidationError?", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1911#discussion_r488927018", "createdAt": "2020-09-15T19:40:24Z", "author": {"login": "alai8"}, "path": "operator/src/test/java/oracle/kubernetes/operator/helpers/JobHelperTest.java", "diffHunk": "@@ -441,6 +444,55 @@ public void introspectorPodStartupWithNullAdminUsernamePasswordEnvVarValues() {\n         getConfiguredDomainSpec(domainConfigurator).getEnv(), hasEnvVar(\"item1\", RAW_VALUE_1));\n   }\n \n+  @Test\n+  public void whenDomainHasAdditionalVolumesWithReservedVariables_createIntrospectorPodWithSubstitutions() {\n+    configureDomain()\n+        .withAdditionalVolumeMount(\"volume2\", \"/source-$(DOMAIN_UID)\");\n+    runCreateJob();\n+    assertThat(\n+        job.getSpec().getTemplate().getSpec().getContainers().get(0).getVolumeMounts(),\n+        hasVolumeMount(\"volume2\", \"/source-\" + UID));\n+  }\n+\n+  @Test\n+  public void whenDomainHasAdditionalVolumesWithCustomVariables_createIntrospectorPodWithSubstitutions() {\n+    resourceLookup.defineResource(SECRET_NAME, KubernetesResourceType.Secret, NS);\n+    resourceLookup.defineResource(OVERRIDES_CM_NAME_MODEL, KubernetesResourceType.ConfigMap, NS);\n+    resourceLookup.defineResource(OVERRIDES_CM_NAME_IMAGE, KubernetesResourceType.ConfigMap, NS);\n+\n+    configureDomain()\n+        .withEnvironmentVariable(ENV_NAME1, GOOD_MY_ENV_VALUE)\n+        .withWebLogicCredentialsSecret(SECRET_NAME, null)\n+        .withAdditionalVolume(\"volume1\", VOLUME_PATH_1)\n+        .withAdditionalVolumeMount(\"volume1\", VOLUME_MOUNT_PATH_1);\n+\n+    runCreateJob();\n+\n+    assertThat(job.getSpec().getTemplate().getSpec().getContainers().get(0).getVolumeMounts(),\n+            hasVolumeMount(\"volume1\", END_VOLUME_MOUNT_PATH_1));\n+  }\n+\n+  @Test\n+  public void whenDomainHasAdditionalVolumesWithCustomVariablesInvalidValue_reportValidationError() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "877de6f1ee9e08e9361a0f1f8909a5bbd042afdd"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MDE0NDk1", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1911#pullrequestreview-489014495", "createdAt": "2020-09-15T19:43:22Z", "commit": {"oid": "877de6f1ee9e08e9361a0f1f8909a5bbd042afdd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5d2455e173486eecfba30397dc8649a339b8b64", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d5d2455e173486eecfba30397dc8649a339b8b64", "committedDate": "2020-09-15T20:21:38Z", "message": "Modify a test name"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4131, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}