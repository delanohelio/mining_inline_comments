{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NDI0Mzcw", "number": 1834, "title": "Use kubectl exec to fix a test hanging issue", "bodyText": "Replace calls to Kubernetes java client exec API with kubectl exec calls to temporarily fix a test hanging issue in Jenkins that has started to happen recently.", "createdAt": "2020-07-24T18:18:02Z", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1834", "merged": true, "mergeCommit": {"oid": "8be0898563182d9c978ca2c449b2a344bddb32c9"}, "closed": true, "closedAt": "2020-07-27T00:04:02Z", "author": {"login": "doxiao"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3uX6SAH2gAyNDU2NDI0MzcwOmM5ZWFjZDYzOGFmODU2YjgxMzc1YTBiNGEyZGRiYTg3NGZmNmMzZjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc42VOhAFqTQ1NTQwODEwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c9eacd638af856b81375a0b4a2ddba874ff6c3f9", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/c9eacd638af856b81375a0b4a2ddba874ff6c3f9", "committedDate": "2020-07-23T12:13:40Z", "message": "use kubectl exec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "100cc852657871e6b0f7dcbf673b02b22e522445", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/100cc852657871e6b0f7dcbf673b02b22e522445", "committedDate": "2020-07-24T15:35:37Z", "message": "Merge remote-tracking branch 'origin/develop' into use-kubectl-exec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ee4961affc415bda1d87595eb39cfa1f5680644", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1ee4961affc415bda1d87595eb39cfa1f5680644", "committedDate": "2020-07-24T17:28:19Z", "message": "cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTE3MjA4", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1834#pullrequestreview-455117208", "createdAt": "2020-07-24T18:58:17Z", "commit": {"oid": "1ee4961affc415bda1d87595eb39cfa1f5680644"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxODo1ODoxN1rOG26bXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxODo1ODoxN1rOG26bXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzMzU2NQ==", "bodyText": "The podName can differ from the service name.  Should the second 'podName' be converted to DNS 1123?  Alternatively, it could  be changed to \"$SERVICE_NAME\" as I assume the bash command will have access to the pod's env vars...", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1834#discussion_r460233565", "createdAt": "2020-07-24T18:58:17Z", "author": {"login": "tbarnes-us"}, "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/assertions/impl/Application.java", "diffHunk": "@@ -78,6 +80,42 @@ public static boolean appAccessibleInPod(\n       getLogger().warning(String.format(\"Failed to find pod %s to check the app\", podName));\n       return false;\n     }\n-  } \n+  }\n+\n+  /**\n+   * Check if an application is accessible inside a WebLogic server pod.\n+   *\n+   * @param namespace Kubernetes namespace where the WebLogic server pod is running\n+   * @param podName name of the WebLogic server pod\n+   * @param port internal port of the managed server running in the pod\n+   * @param appPath path to access the application\n+   * @param expectedResponse expected response from the app\n+   * @return true if the command succeeds\n+   */\n+  public static boolean appAccessibleInPodKubectl(\n+      String namespace,\n+      String podName,\n+      String port,\n+      String appPath,\n+      String expectedResponse\n+  ) {\n+\n+    // calling \"kubectl exec\" command to access the app inside a pod\n+    String cmd = String.format(\n+        \"kubectl -n %s exec -it %s -- /bin/bash -c 'curl http://%s:%s/%s'\",\n+        namespace,\n+        podName,\n+        podName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ee4961affc415bda1d87595eb39cfa1f5680644"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTIwMzI0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1834#pullrequestreview-455120324", "createdAt": "2020-07-24T19:03:39Z", "commit": {"oid": "1ee4961affc415bda1d87595eb39cfa1f5680644"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxOTowMzozOVrOG26kyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxOTowMzozOVrOG26kyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzNTk3OQ==", "bodyText": "For other tests, we've needed to have multiple retries for initial curl attempts as tests can sometimes try access an app before it or the service is fully deployed; in addition, it's been helpful to tune the curl command's connection and overall timeouts.", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1834#discussion_r460235979", "createdAt": "2020-07-24T19:03:39Z", "author": {"login": "tbarnes-us"}, "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/assertions/impl/Application.java", "diffHunk": "@@ -78,6 +80,42 @@ public static boolean appAccessibleInPod(\n       getLogger().warning(String.format(\"Failed to find pod %s to check the app\", podName));\n       return false;\n     }\n-  } \n+  }\n+\n+  /**\n+   * Check if an application is accessible inside a WebLogic server pod.\n+   *\n+   * @param namespace Kubernetes namespace where the WebLogic server pod is running\n+   * @param podName name of the WebLogic server pod\n+   * @param port internal port of the managed server running in the pod\n+   * @param appPath path to access the application\n+   * @param expectedResponse expected response from the app\n+   * @return true if the command succeeds\n+   */\n+  public static boolean appAccessibleInPodKubectl(\n+      String namespace,\n+      String podName,\n+      String port,\n+      String appPath,\n+      String expectedResponse\n+  ) {\n+\n+    // calling \"kubectl exec\" command to access the app inside a pod\n+    String cmd = String.format(\n+        \"kubectl -n %s exec -it %s -- /bin/bash -c 'curl http://%s:%s/%s'\",\n+        namespace,\n+        podName,\n+        podName,\n+        port,\n+        appPath);\n+\n+    CommandParams params = Command\n+        .defaultCommandParams()\n+        .command(cmd)\n+        .saveResults(true)\n+        .redirect(false)\n+        .verbose(false);\n+    return Command.withParams(params).executeAndVerify(expectedResponse);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ee4961affc415bda1d87595eb39cfa1f5680644"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTkwNTY4", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1834#pullrequestreview-455190568", "createdAt": "2020-07-24T21:17:26Z", "commit": {"oid": "1ee4961affc415bda1d87595eb39cfa1f5680644"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjI2NTU2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1834#pullrequestreview-455226556", "createdAt": "2020-07-24T23:03:55Z", "commit": {"oid": "1ee4961affc415bda1d87595eb39cfa1f5680644"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NDA4MTAw", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1834#pullrequestreview-455408100", "createdAt": "2020-07-27T00:03:54Z", "commit": {"oid": "1ee4961affc415bda1d87595eb39cfa1f5680644"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4328, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}