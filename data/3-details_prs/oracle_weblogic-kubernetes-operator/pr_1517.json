{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1OTU0OTcx", "number": 1517, "title": "Enhance Helm chart deletion Logic in cleanup.sh Script  ", "bodyText": "Modified the clean up scripts to loop thru the NameSpace which has active Helm Deployment for the deletion of Helm Deployment.  The new logic will take care of  both Helm 2.x/3.x", "createdAt": "2020-03-30T23:03:40Z", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517", "merged": true, "mergeCommit": {"oid": "32136563c23002bd9e272db0ac8ad0ff574be85f"}, "closed": true, "closedAt": "2020-03-31T00:48:58Z", "author": {"login": "anpanigr"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcS13IFAH2gAyMzk1OTU0OTcxOjBhYzQyNThmYjhlY2U5NDI1MzY4YzViNjI5NWUxM2FkOTM1MzAzOTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcS4PzkAFqTM4NDMzMDc1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0ac4258fb8ece9425368c5b6295e13ad93530391", "author": {"user": null}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/0ac4258fb8ece9425368c5b6295e13ad93530391", "committedDate": "2020-03-30T22:01:54Z", "message": "Enhance the clean up Script to support Helm 2/3"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0Mjk1MTUx", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#pullrequestreview-384295151", "createdAt": "2020-03-30T23:08:38Z", "commit": {"oid": "0ac4258fb8ece9425368c5b6295e13ad93530391"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMzowODozOFrOF9_gXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMzowODozOFrOF9_gXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0NzkzMg==", "bodyText": "I suspect this should be:\nhelm list --all-namespaces | grep -v NAME | awk '{print $2}' | sort -u\nWe only want to iterate through each namespace once.", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400547932", "createdAt": "2020-03-30T23:08:38Z", "author": {"login": "tbarnes-us"}, "path": "src/integration-tests/bash/cleanup.sh", "diffHunk": "@@ -523,32 +523,38 @@ if [ -x \"$(command -v helm)\" ]; then\n   [[ $? == 1 ]] && HELM_VERSION=V3\n   echo \"Detected Helm Version [$(helm version --short --client)]\"\n   echo @@ `timestamp` Deleting installed helm charts\n-  namespaces=`kubectl get ns | grep -v NAME | awk '{ print $1 }'`\n-  for ns in $namespaces\n-  do \n+  if [ \"$HELM_VERSION\" == \"V2\" ]; then\n+   helm list --short | while read helm_name; do\n    if [ ! \"$DRY_RUN\" = \"true\" ]; then\n-     (\n+   (\n      set -x\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         helm delete --purge  $helm_name\n-       else \n-         helm uninstall $helm_name -n $ns \n-       fi\n-     done\n-     )\n+     helm delete --purge  $helm_name\n+    )\n    else\n-     (\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+     echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+   fi\n+   done\n+  fi\n+\n+  if [ \"$HELM_VERSION\" == \"V3\" ]; then\n+   namespaces=`helm list --all-namespaces | grep -v NAME | awk '{print $2}'`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ac4258fb8ece9425368c5b6295e13ad93530391"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0Mjk1MTIw", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#pullrequestreview-384295120", "createdAt": "2020-03-30T23:08:33Z", "commit": {"oid": "0ac4258fb8ece9425368c5b6295e13ad93530391"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMzowODozM1rOF9_gPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMzowODozM1rOF9_gPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0NzkwMQ==", "bodyText": "The loop is still here", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400547901", "createdAt": "2020-03-30T23:08:33Z", "author": {"login": "markxnelson"}, "path": "src/integration-tests/bash/cleanup.sh", "diffHunk": "@@ -523,32 +523,38 @@ if [ -x \"$(command -v helm)\" ]; then\n   [[ $? == 1 ]] && HELM_VERSION=V3\n   echo \"Detected Helm Version [$(helm version --short --client)]\"\n   echo @@ `timestamp` Deleting installed helm charts\n-  namespaces=`kubectl get ns | grep -v NAME | awk '{ print $1 }'`\n-  for ns in $namespaces\n-  do \n+  if [ \"$HELM_VERSION\" == \"V2\" ]; then\n+   helm list --short | while read helm_name; do\n    if [ ! \"$DRY_RUN\" = \"true\" ]; then\n-     (\n+   (\n      set -x\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         helm delete --purge  $helm_name\n-       else \n-         helm uninstall $helm_name -n $ns \n-       fi\n-     done\n-     )\n+     helm delete --purge  $helm_name\n+    )\n    else\n-     (\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+     echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+   fi\n+   done\n+  fi\n+\n+  if [ \"$HELM_VERSION\" == \"V3\" ]; then\n+   namespaces=`helm list --all-namespaces | grep -v NAME | awk '{print $2}'`\n+   for ns in $namespaces\n+   do \n+     echo \"Looking for helm lists in namesapce $ns\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ac4258fb8ece9425368c5b6295e13ad93530391"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0Mjk4Mzc4", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#pullrequestreview-384298378", "createdAt": "2020-03-30T23:17:00Z", "commit": {"oid": "0ac4258fb8ece9425368c5b6295e13ad93530391"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12fc7703b5a84c816851f953fec892049744b199", "author": {"user": null}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/12fc7703b5a84c816851f953fec892049744b199", "committedDate": "2020-03-31T00:39:48Z", "message": "Addressed the review comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MzMwMjEx", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#pullrequestreview-384330211", "createdAt": "2020-03-31T00:47:05Z", "commit": {"oid": "12fc7703b5a84c816851f953fec892049744b199"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMDo0NzowNVrOF-BW4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMDo0NzowNVrOF-BW4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3ODI3Mw==", "bodyText": "Change \"helm uninstall \" to \"set -x ; helm uninstall \".  In my testing it turns out that the outer scoped set -x is suppressed by teh the system call scope, so you need one inside the system call scope too.", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400578273", "createdAt": "2020-03-31T00:47:05Z", "author": {"login": "tbarnes-us"}, "path": "src/integration-tests/bash/cleanup.sh", "diffHunk": "@@ -537,23 +537,15 @@ if [ -x \"$(command -v helm)\" ]; then\n   fi\n \n   if [ \"$HELM_VERSION\" == \"V3\" ]; then\n-   namespaces=`helm list --all-namespaces | grep -v NAME | awk '{print $2}'`\n-   for ns in $namespaces\n-   do \n-     echo \"Looking for helm lists in namesapce $ns\"\n-     helm_names=`helm list --short -n $ns`\n-     for helm_name in $helm_names\n-     do \n-        if [ ! \"$DRY_RUN\" = \"true\" ]; then\n-        (\n-          set -x\n-          helm uninstall $helm_name -n $ns\n-        )\n-       else \n-         echo @@ `timestamp` Info: DRYRUN: helm uninstall $helm_name -n $ns\n-       fi\n-     done\n-   done\n+    if [ ! \"$DRY_RUN\" = \"true\" ]; then\n+    (\n+      set -x\n+      helm list --all-namespaces | grep -v NAME | awk '{system(\"helm uninstall \" $1 \" --namespace \" $2)}'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12fc7703b5a84c816851f953fec892049744b199"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MzMwNzUx", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#pullrequestreview-384330751", "createdAt": "2020-03-31T00:48:40Z", "commit": {"oid": "12fc7703b5a84c816851f953fec892049744b199"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4941, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}