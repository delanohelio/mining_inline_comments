{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzOTExNDA0", "number": 1735, "title": "Add namespace to operator log messages", "bodyText": "Add domain namespace to operator's log messages.\n\nWhen the current fiber and DomainPresenceInfo are both available, LoggingFormatter uses the existing DomainPresenceInfo to obtain the namespace information.\nWhen the current fiber is available but DomainPresenceInfo is not available, add a new component to the packet to pass the namespace to the LoggingFormatter.\nWhen the current fiber is not available, add the logging context to the thread local to pass the namespace to the LoggingFormatter. This is not ideal; still looking into possible alternatives.\nUse ThreadLocal for log messages in the Watch events.\n\nJenkins job had one known failure in ItSessionMigration.testSessionMigration https://build.weblogick8s.org:8443/view/all/job/weblogic-kubernetes-operator-kind-new/350", "createdAt": "2020-06-12T22:39:26Z", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1735", "merged": true, "mergeCommit": {"oid": "a7705c668466bfd35e3d2fc2777bd8b27ec430e2"}, "closed": true, "closedAt": "2020-06-16T20:36:50Z", "author": {"login": "doxiao"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqVfPjAH2gAyNDMzOTExNDA0OjRiY2JiYTA3NTA1ZGI1NTM3NzUyNGRkYTUwNGM3ODNhNGQ2YWQyYzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcr7ZCFAFqTQzMTg3MTg5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4bcbba07505db55377524dda504c783a4d6ad2c7", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/4bcbba07505db55377524dda504c783a4d6ad2c7", "committedDate": "2020-06-11T21:53:02Z", "message": "Add namespace to log messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89a77ae18a2079b1849730c59fd0c72398ee7911", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/89a77ae18a2079b1849730c59fd0c72398ee7911", "committedDate": "2020-06-11T22:09:56Z", "message": "Add a new file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7353aa2a8f561d8772a557f04514bad8d4220b30", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/7353aa2a8f561d8772a557f04514bad8d4220b30", "committedDate": "2020-06-12T19:31:29Z", "message": "Handle namespace watch event"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMDc5NzE5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1735#pullrequestreview-430079719", "createdAt": "2020-06-12T23:14:33Z", "commit": {"oid": "7353aa2a8f561d8772a557f04514bad8d4220b30"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQyMzoxNDozM1rOGjTtsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQyMzoxNDozM1rOGjTtsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY3NjMzNw==", "bodyText": "consider adding a utility method in LoggingContext that handles setting the context, invoke the code, and removal of context, something like LoggingContext.runUnderContext(LoggingContext, Runnable).", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1735#discussion_r439676337", "createdAt": "2020-06-12T23:14:33Z", "author": {"login": "alai8"}, "path": "operator/src/main/java/oracle/kubernetes/operator/DomainProcessorImpl.java", "diffHunk": "@@ -231,8 +232,23 @@ public void reportSuspendedFibers() {\n             gate.getCurrentFibers().forEach(\n                 (key, fiber) -> {\n                   Optional.ofNullable(fiber.getSuspendedStep()).ifPresent(suspendedStep -> {\n-                    LOGGER.fine(\"Namespace: \" + namespace + \", DomainUid: \" + key\n-                        + \", Fiber: \" + fiber.toString() + \" is SUSPENDED at \" + suspendedStep.getName());\n+                  \n+                    // find out the domainUID \n+                    Packet packet = fiber == null ? null : fiber.getPacket();\n+                    String domainUid = null;\n+                    if (packet != null) {\n+                      DomainPresenceInfo info = packet.getSpi(DomainPresenceInfo.class);\n+                      if (info != null) {\n+                        domainUid = info.getDomainUid();\n+                      }\n+                    }\n+                    LoggingContext.context(new LoggingContext().namespace(namespace).domainUid(domainUid));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7353aa2a8f561d8772a557f04514bad8d4220b30"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMTUzMTk2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1735#pullrequestreview-430153196", "createdAt": "2020-06-13T17:21:44Z", "commit": {"oid": "7353aa2a8f561d8772a557f04514bad8d4220b30"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QxNzoyMTo0NVrOGjYfKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QxNzoyMTo0NVrOGjYfKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc1NDUzOA==", "bodyText": "Does this need a corresponding LoggingContext().remove() in a finally?", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1735#discussion_r439754538", "createdAt": "2020-06-13T17:21:45Z", "author": {"login": "tbarnes-us"}, "path": "operator/src/main/java/oracle/kubernetes/operator/ServerStatusReader.java", "diffHunk": "@@ -167,6 +168,8 @@ public NextAction apply(Packet packet) {\n             String state = null;\n             ClientPool helper = ClientPool.getInstance();\n             ApiClient client = helper.take();\n+            String namespace = pod.getMetadata().getNamespace();\n+            LoggingContext.context(new LoggingContext().namespace(namespace));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7353aa2a8f561d8772a557f04514bad8d4220b30"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8e434341180b3562f45ae654bbaeac2c54c7f44", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b8e434341180b3562f45ae654bbaeac2c54c7f44", "committedDate": "2020-06-15T17:31:59Z", "message": "Remove the thread local in ServerStatusReader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42bf6ea24df193d3e1d1aa8c7014dff0966a508c", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/42bf6ea24df193d3e1d1aa8c7014dff0966a508c", "committedDate": "2020-06-16T11:01:34Z", "message": "Use Closeable and more"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0502cf7383b7e984be76ca4fcb02ccba18c9245", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d0502cf7383b7e984be76ca4fcb02ccba18c9245", "committedDate": "2020-06-16T11:04:32Z", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into add-domain-ns-to-op-log"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "11d92091f52d57b798d7b2c7338bf3ae4a7d1f55", "author": {"user": {"login": "russgold", "name": "Russell Gold"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/11d92091f52d57b798d7b2c7338bf3ae4a7d1f55", "committedDate": "2020-06-15T22:42:44Z", "message": "Add unit test for LoggingFormatter"}, "afterCommit": {"oid": "d0502cf7383b7e984be76ca4fcb02ccba18c9245", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d0502cf7383b7e984be76ca4fcb02ccba18c9245", "committedDate": "2020-06-16T11:04:32Z", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into add-domain-ns-to-op-log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16a367081a8be033d5e8461407773bc40f98a40d", "author": {"user": {"login": "russgold", "name": "Russell Gold"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/16a367081a8be033d5e8461407773bc40f98a40d", "committedDate": "2020-06-16T13:37:36Z", "message": "add unit test for LoggingFormatter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c33dcd6d0fe12b06fb24795a925edfd80e9100a", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3c33dcd6d0fe12b06fb24795a925edfd80e9100a", "committedDate": "2020-06-16T13:40:17Z", "message": "Add unit test cases for namespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3116fb32d2fa8e7be956477d5f4769c7b9c9235", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d3116fb32d2fa8e7be956477d5f4769c7b9c9235", "committedDate": "2020-06-16T13:43:43Z", "message": "Add missing file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29cc0155bcf7a1cee904dcd35a8e06fa1de9ff7b", "author": {"user": {"login": "doxiao", "name": "Dongbo Xiao"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/29cc0155bcf7a1cee904dcd35a8e06fa1de9ff7b", "committedDate": "2020-06-16T13:46:19Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de45f3086de02be13dde6eb508c04b920fe3ce07", "author": {"user": {"login": "russgold", "name": "Russell Gold"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/de45f3086de02be13dde6eb508c04b920fe3ce07", "committedDate": "2020-06-16T15:34:32Z", "message": "some cleanup and unit testing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzAwMTI2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1735#pullrequestreview-431700126", "createdAt": "2020-06-16T16:44:29Z", "commit": {"oid": "de45f3086de02be13dde6eb508c04b920fe3ce07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzA2NTk1", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1735#pullrequestreview-431706595", "createdAt": "2020-06-16T16:52:37Z", "commit": {"oid": "de45f3086de02be13dde6eb508c04b920fe3ce07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxODcxODkz", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1735#pullrequestreview-431871893", "createdAt": "2020-06-16T20:36:34Z", "commit": {"oid": "de45f3086de02be13dde6eb508c04b920fe3ce07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4534, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}