{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2MTI2MTAx", "number": 1639, "title": "Retry  DB startup and RCU creation as well as support custom namespace for RCU/DB  ", "bodyText": "Incorporate the latest custom namespace support for RCU creation in the JRF test\nAdd retry logic for DB startup and RCU creation\nSome  code cleanup\n\nOn cluster 10:\nhttps://build.weblogick8s.org:8443/job/weblogic-kubernetes-operator-quicktest-10/77/testReport/\nonly 1 failure for full test suite.\nBut test log shows that RCU creation/db loading succeeded the first time.", "createdAt": "2020-05-11T14:03:47Z", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1639", "merged": true, "mergeCommit": {"oid": "de8dd7b7da7dd1c98b688e7aad16909e65de7ac3"}, "closed": true, "closedAt": "2020-05-20T15:47:21Z", "author": {"login": "maggiehe00"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABce3HC2gH2gAyNDE2MTI2MTAxOjFjNDUyMmM0NDVkOGRjMWU5OTYxMzFiZmRjMGQzYzFjMWQ5Mzg2OWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABciEVDBgH2gAyNDE2MTI2MTAxOjE2YmNmYzE1MWNiZWEwYTFmMWRiOGJmZWJmMjVkYmI2NDExMDkwYWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1c4522c445d8dc1e996131bfdc0d3c1c1d93869e", "author": {"user": {"login": "maggiehe00", "name": "Maggie He"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1c4522c445d8dc1e996131bfdc0d3c1c1d93869e", "committedDate": "2020-05-07T06:16:17Z", "message": "first cut of retry-rcu"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMTQ0NDA1", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1639#pullrequestreview-410144405", "createdAt": "2020-05-12T15:11:05Z", "commit": {"oid": "1c4522c445d8dc1e996131bfdc0d3c1c1d93869e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNToxMTowNVrOGULg0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNToxMTowNVrOGULg0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzgxMzMzMQ==", "bodyText": "Delete commented out code.", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1639#discussion_r423813331", "createdAt": "2020-05-12T15:11:05Z", "author": {"login": "rjeberhard"}, "path": "integration-tests/src/test/java/oracle/kubernetes/operator/utils/DbUtils.java", "diffHunk": "@@ -230,16 +217,84 @@ public static void deleteNamespace(String namespace) throws Exception {\n   }\n \n   /**\n-   * create a namespace.\n-   *\n-   * @param namespace - namespace to create\n-   * @throws Exception - if any error occurs\n+   * Create a namespace.\n+   * \n+   * @param namespace namespace to create\n+   * @throws Exception if any error occurs\n    */\n   public static void createNamespace(String namespace) throws Exception {\n     if (!namespace.equalsIgnoreCase(\"default\")) {\n-      String command = \"kubectl create ns \" + namespace;\n-      logger.info(\"Running \" + command);\n-      TestUtils.execOrAbortProcess(command);\n+      String cmd1 = \"kubectl delete ns \" + namespace + \" --ignore-not-found\";\n+      logger.info(\"Running \" + cmd1);\n+      TestUtils.execOrAbortProcess(cmd1, true);\n+      String cmd2 = \"kubectl create ns \" + namespace;\n+      logger.info(\"Running \" + cmd2);\n+      TestUtils.execOrAbortProcess(cmd2, true);\n+    }\n+  }\n+  \n+  /**\n+   * Start DB instance, create Oracle rcu pod and load database schema in the specified namespace.\n+   * \n+   * @param scriptsDir directory of scripts\n+   * @param dbPort NodePort of DB\n+   * @param dbUrl URL of DB\n+   * @param rcuSchemaPrefix rcu SchemaPrefixe\n+   * @param namespace namespace where DB and RCU schema are going to start\n+   * @throws Exception if any error occurs when setting up RCU database\n+   */\n+  public static void setupRcuDatabase(String scriptsDir, int dbPort, String dbUrl, \n+      String rcuSchemaPrefix, String namespace) throws Exception {  \n+    \n+    createNamespace(namespace);\n+    createDockerRegistrySecret(namespace);\n+    /*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c4522c445d8dc1e996131bfdc0d3c1c1d93869e"}, "originalPosition": 365}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMTQ0ODc2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1639#pullrequestreview-410144876", "createdAt": "2020-05-12T15:11:34Z", "commit": {"oid": "1c4522c445d8dc1e996131bfdc0d3c1c1d93869e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNToxMTozNFrOGULiJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNToxMTozNFrOGULiJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzgxMzY2OQ==", "bodyText": "Describe what must still be done if you are leaving a TODO.", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1639#discussion_r423813669", "createdAt": "2020-05-12T15:11:34Z", "author": {"login": "rjeberhard"}, "path": "integration-tests/src/test/java/oracle/kubernetes/operator/utils/DbUtils.java", "diffHunk": "@@ -230,16 +217,84 @@ public static void deleteNamespace(String namespace) throws Exception {\n   }\n \n   /**\n-   * create a namespace.\n-   *\n-   * @param namespace - namespace to create\n-   * @throws Exception - if any error occurs\n+   * Create a namespace.\n+   * \n+   * @param namespace namespace to create\n+   * @throws Exception if any error occurs\n    */\n   public static void createNamespace(String namespace) throws Exception {\n     if (!namespace.equalsIgnoreCase(\"default\")) {\n-      String command = \"kubectl create ns \" + namespace;\n-      logger.info(\"Running \" + command);\n-      TestUtils.execOrAbortProcess(command);\n+      String cmd1 = \"kubectl delete ns \" + namespace + \" --ignore-not-found\";\n+      logger.info(\"Running \" + cmd1);\n+      TestUtils.execOrAbortProcess(cmd1, true);\n+      String cmd2 = \"kubectl create ns \" + namespace;\n+      logger.info(\"Running \" + cmd2);\n+      TestUtils.execOrAbortProcess(cmd2, true);\n+    }\n+  }\n+  \n+  /**\n+   * Start DB instance, create Oracle rcu pod and load database schema in the specified namespace.\n+   * \n+   * @param scriptsDir directory of scripts\n+   * @param dbPort NodePort of DB\n+   * @param dbUrl URL of DB\n+   * @param rcuSchemaPrefix rcu SchemaPrefixe\n+   * @param namespace namespace where DB and RCU schema are going to start\n+   * @throws Exception if any error occurs when setting up RCU database\n+   */\n+  public static void setupRcuDatabase(String scriptsDir, int dbPort, String dbUrl, \n+      String rcuSchemaPrefix, String namespace) throws Exception {  \n+    \n+    createNamespace(namespace);\n+    createDockerRegistrySecret(namespace);\n+    /*\n+    //delete leftover pods caused by test being aborted\n+    deleteRcuPod(scriptsDir);\n+    deleteDbPod(scriptsDir);\n+    \n+    startOracleDB(scriptsDir, String.valueOf(dbPort), namespace);\n+    createRcuSchema(scriptsDir,rcuSchemaPrefix, dbUrl, namespace);\n+    */\n+    String cmd1 = \"mkdir -p \" + scriptsDir\n+        + \"/scripts/create-rcu-schema/rcuoutput\";\n+    TestUtils.execOrAbortProcess(cmd1);\n+    String cmd2 = \"cp \" \n+        + scriptsDir\n+        + \"/scripts/create-rcu-schema/common/rcu.yaml \"\n+        + scriptsDir\n+        + \"/scripts/create-rcu-schema/rcuoutput/\";\n+    TestUtils.execOrAbortProcess(cmd2);\n+    createDBandRCUschema(scriptsDir, dbPort, dbUrl, rcuSchemaPrefix, namespace);\n+    LoggerHelper.getLocal().log(Level.INFO,\"RCU schema is going to create for:\" \n+        + \" namespace: \" + namespace \n+        + \" dbUrl:\" + dbUrl \n+        + \" dbPort: \" + dbPort\n+        + \" rcuSchemaPrefix: \" + rcuSchemaPrefix); \n+    \n+  }\n+  \n+  private static void createDBandRCUschema(String scriptsDir, int dbPort, String dbUrl, \n+      String rcuSchemaPrefix, String namespace) throws Exception {\n+    count++;\n+    if (count < 2) {\n+      deleteRcuPod(scriptsDir);\n+      deleteDbPod(scriptsDir);\n+      try {\n+        startOracleDB(scriptsDir, String.valueOf(dbPort), namespace);\n+        createRcuSchema(scriptsDir,rcuSchemaPrefix, dbUrl, namespace);\n+        LoggerHelper.getLocal().log(Level.INFO,\"RCU schema is created for:\" \n+            + \" namespace: \" + namespace \n+            + \" dbUrl:\" + dbUrl \n+            + \" dbPort: \" + dbPort\n+            + \" rcuSchemaPrefix: \" + rcuSchemaPrefix);\n+        //TODO", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c4522c445d8dc1e996131bfdc0d3c1c1d93869e"}, "originalPosition": 405}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMTQ1MzY1", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1639#pullrequestreview-410145365", "createdAt": "2020-05-12T15:12:04Z", "commit": {"oid": "1c4522c445d8dc1e996131bfdc0d3c1c1d93869e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMTIxNzA3", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1639#pullrequestreview-413121707", "createdAt": "2020-05-17T02:17:23Z", "commit": {"oid": "1c4522c445d8dc1e996131bfdc0d3c1c1d93869e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QwMjoxNzoyNFrOGWdvmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QwMjoxNzoyNFrOGWdvmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIwOTE3Ng==", "bodyText": "Oracle DB - be consistent, and Oracle has to have a capital O", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1639#discussion_r426209176", "createdAt": "2020-05-17T02:17:24Z", "author": {"login": "markxnelson"}, "path": "integration-tests/src/test/java/oracle/kubernetes/operator/utils/DbUtils.java", "diffHunk": "@@ -17,14 +17,17 @@\n   public static final String DEFAULT_RCU_SYS_USERNAME = \"sys\";\n   public static final String DEFAULT_RCU_SYS_PASSWORD = \"Oradoc_db1\";\n   public static final String DEFAULT_RCU_NAMESPACE = \"rcu\";\n+  public static final String DEFAULT_ImagePullSecret = \"docker-store\";\n+  public static final String DEFAULT_ImagePullPolicy = \"Always\";\n+  private static int count = 0;\n   private static final Logger logger = Logger.getLogger(\"OperatorIT\", \"OperatorIT\");\n \n   /**\n-   * create oracle db pod in the k8s cluster.\n+   * Create oracle db pod in the k8s cluster.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c4522c445d8dc1e996131bfdc0d3c1c1d93869e"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a0678f2d0aed7713f5a06bd40aad7bb906eef14", "author": {"user": {"login": "maggiehe00", "name": "Maggie He"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1a0678f2d0aed7713f5a06bd40aad7bb906eef14", "committedDate": "2020-05-17T05:19:26Z", "message": "address the review comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16bcfc151cbea0a1f1db8bfebf25dbb6411090ad", "author": {"user": {"login": "maggiehe00", "name": "Maggie He"}}, "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/16bcfc151cbea0a1f1db8bfebf25dbb6411090ad", "committedDate": "2020-05-17T05:22:07Z", "message": "Merge remote-tracking branch 'origin/develop' into retry-rcu"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4773, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}