{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1OTU0OTcx", "number": 1517, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMzowODozM1rODs4t_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMDo0NzowNVrODs57OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MzkzMjE0OnYy", "diffSide": "RIGHT", "path": "src/integration-tests/bash/cleanup.sh", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMzowODozM1rOF9_gPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMzoxMzoyNVrOF9_myA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0NzkwMQ==", "bodyText": "The loop is still here", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400547901", "createdAt": "2020-03-30T23:08:33Z", "author": {"login": "markxnelson"}, "path": "src/integration-tests/bash/cleanup.sh", "diffHunk": "@@ -523,32 +523,38 @@ if [ -x \"$(command -v helm)\" ]; then\n   [[ $? == 1 ]] && HELM_VERSION=V3\n   echo \"Detected Helm Version [$(helm version --short --client)]\"\n   echo @@ `timestamp` Deleting installed helm charts\n-  namespaces=`kubectl get ns | grep -v NAME | awk '{ print $1 }'`\n-  for ns in $namespaces\n-  do \n+  if [ \"$HELM_VERSION\" == \"V2\" ]; then\n+   helm list --short | while read helm_name; do\n    if [ ! \"$DRY_RUN\" = \"true\" ]; then\n-     (\n+   (\n      set -x\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         helm delete --purge  $helm_name\n-       else \n-         helm uninstall $helm_name -n $ns \n-       fi\n-     done\n-     )\n+     helm delete --purge  $helm_name\n+    )\n    else\n-     (\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+     echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+   fi\n+   done\n+  fi\n+\n+  if [ \"$HELM_VERSION\" == \"V3\" ]; then\n+   namespaces=`helm list --all-namespaces | grep -v NAME | awk '{print $2}'`\n+   for ns in $namespaces\n+   do \n+     echo \"Looking for helm lists in namesapce $ns\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ac4258fb8ece9425368c5b6295e13ad93530391"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0ODY3MA==", "bodyText": "namespaces variable will store only the namespace(s) that has a helm deployment not all the namespaces in entire k8s", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400548670", "createdAt": "2020-03-30T23:10:39Z", "author": {"login": "anpanigr"}, "path": "src/integration-tests/bash/cleanup.sh", "diffHunk": "@@ -523,32 +523,38 @@ if [ -x \"$(command -v helm)\" ]; then\n   [[ $? == 1 ]] && HELM_VERSION=V3\n   echo \"Detected Helm Version [$(helm version --short --client)]\"\n   echo @@ `timestamp` Deleting installed helm charts\n-  namespaces=`kubectl get ns | grep -v NAME | awk '{ print $1 }'`\n-  for ns in $namespaces\n-  do \n+  if [ \"$HELM_VERSION\" == \"V2\" ]; then\n+   helm list --short | while read helm_name; do\n    if [ ! \"$DRY_RUN\" = \"true\" ]; then\n-     (\n+   (\n      set -x\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         helm delete --purge  $helm_name\n-       else \n-         helm uninstall $helm_name -n $ns \n-       fi\n-     done\n-     )\n+     helm delete --purge  $helm_name\n+    )\n    else\n-     (\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+     echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+   fi\n+   done\n+  fi\n+\n+  if [ \"$HELM_VERSION\" == \"V3\" ]; then\n+   namespaces=`helm list --all-namespaces | grep -v NAME | awk '{print $2}'`\n+   for ns in $namespaces\n+   do \n+     echo \"Looking for helm lists in namesapce $ns\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0NzkwMQ=="}, "originalCommit": {"oid": "0ac4258fb8ece9425368c5b6295e13ad93530391"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0ODkxMQ==", "bodyText": "The loop here is OK IMO, as long as we only iterate through each NS once, and only iterate through NS that contain a helm, per my previous comment.", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400548911", "createdAt": "2020-03-30T23:11:23Z", "author": {"login": "tbarnes-us"}, "path": "src/integration-tests/bash/cleanup.sh", "diffHunk": "@@ -523,32 +523,38 @@ if [ -x \"$(command -v helm)\" ]; then\n   [[ $? == 1 ]] && HELM_VERSION=V3\n   echo \"Detected Helm Version [$(helm version --short --client)]\"\n   echo @@ `timestamp` Deleting installed helm charts\n-  namespaces=`kubectl get ns | grep -v NAME | awk '{ print $1 }'`\n-  for ns in $namespaces\n-  do \n+  if [ \"$HELM_VERSION\" == \"V2\" ]; then\n+   helm list --short | while read helm_name; do\n    if [ ! \"$DRY_RUN\" = \"true\" ]; then\n-     (\n+   (\n      set -x\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         helm delete --purge  $helm_name\n-       else \n-         helm uninstall $helm_name -n $ns \n-       fi\n-     done\n-     )\n+     helm delete --purge  $helm_name\n+    )\n    else\n-     (\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+     echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+   fi\n+   done\n+  fi\n+\n+  if [ \"$HELM_VERSION\" == \"V3\" ]; then\n+   namespaces=`helm list --all-namespaces | grep -v NAME | awk '{print $2}'`\n+   for ns in $namespaces\n+   do \n+     echo \"Looking for helm lists in namesapce $ns\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0NzkwMQ=="}, "originalCommit": {"oid": "0ac4258fb8ece9425368c5b6295e13ad93530391"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0OTU3Ng==", "bodyText": "But if you want to further optimize, iterate through the output of the first all-namespace command in a single \"big loop\"\nover each entire line, where the commands within loop parse out the ns from the current line and parses out the helm name from the same line.", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400549576", "createdAt": "2020-03-30T23:13:25Z", "author": {"login": "tbarnes-us"}, "path": "src/integration-tests/bash/cleanup.sh", "diffHunk": "@@ -523,32 +523,38 @@ if [ -x \"$(command -v helm)\" ]; then\n   [[ $? == 1 ]] && HELM_VERSION=V3\n   echo \"Detected Helm Version [$(helm version --short --client)]\"\n   echo @@ `timestamp` Deleting installed helm charts\n-  namespaces=`kubectl get ns | grep -v NAME | awk '{ print $1 }'`\n-  for ns in $namespaces\n-  do \n+  if [ \"$HELM_VERSION\" == \"V2\" ]; then\n+   helm list --short | while read helm_name; do\n    if [ ! \"$DRY_RUN\" = \"true\" ]; then\n-     (\n+   (\n      set -x\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         helm delete --purge  $helm_name\n-       else \n-         helm uninstall $helm_name -n $ns \n-       fi\n-     done\n-     )\n+     helm delete --purge  $helm_name\n+    )\n    else\n-     (\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+     echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+   fi\n+   done\n+  fi\n+\n+  if [ \"$HELM_VERSION\" == \"V3\" ]; then\n+   namespaces=`helm list --all-namespaces | grep -v NAME | awk '{print $2}'`\n+   for ns in $namespaces\n+   do \n+     echo \"Looking for helm lists in namesapce $ns\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0NzkwMQ=="}, "originalCommit": {"oid": "0ac4258fb8ece9425368c5b6295e13ad93530391"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MzkzMjM0OnYy", "diffSide": "RIGHT", "path": "src/integration-tests/bash/cleanup.sh", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMzowODozOFrOF9_gXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMzoxNjozM1rOF9_q6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0NzkzMg==", "bodyText": "I suspect this should be:\nhelm list --all-namespaces | grep -v NAME | awk '{print $2}' | sort -u\nWe only want to iterate through each namespace once.", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400547932", "createdAt": "2020-03-30T23:08:38Z", "author": {"login": "tbarnes-us"}, "path": "src/integration-tests/bash/cleanup.sh", "diffHunk": "@@ -523,32 +523,38 @@ if [ -x \"$(command -v helm)\" ]; then\n   [[ $? == 1 ]] && HELM_VERSION=V3\n   echo \"Detected Helm Version [$(helm version --short --client)]\"\n   echo @@ `timestamp` Deleting installed helm charts\n-  namespaces=`kubectl get ns | grep -v NAME | awk '{ print $1 }'`\n-  for ns in $namespaces\n-  do \n+  if [ \"$HELM_VERSION\" == \"V2\" ]; then\n+   helm list --short | while read helm_name; do\n    if [ ! \"$DRY_RUN\" = \"true\" ]; then\n-     (\n+   (\n      set -x\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         helm delete --purge  $helm_name\n-       else \n-         helm uninstall $helm_name -n $ns \n-       fi\n-     done\n-     )\n+     helm delete --purge  $helm_name\n+    )\n    else\n-     (\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+     echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+   fi\n+   done\n+  fi\n+\n+  if [ \"$HELM_VERSION\" == \"V3\" ]; then\n+   namespaces=`helm list --all-namespaces | grep -v NAME | awk '{print $2}'`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ac4258fb8ece9425368c5b6295e13ad93530391"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0OTczMQ==", "bodyText": "nice suggestion. will implement change in next commit", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400549731", "createdAt": "2020-03-30T23:13:50Z", "author": {"login": "anpanigr"}, "path": "src/integration-tests/bash/cleanup.sh", "diffHunk": "@@ -523,32 +523,38 @@ if [ -x \"$(command -v helm)\" ]; then\n   [[ $? == 1 ]] && HELM_VERSION=V3\n   echo \"Detected Helm Version [$(helm version --short --client)]\"\n   echo @@ `timestamp` Deleting installed helm charts\n-  namespaces=`kubectl get ns | grep -v NAME | awk '{ print $1 }'`\n-  for ns in $namespaces\n-  do \n+  if [ \"$HELM_VERSION\" == \"V2\" ]; then\n+   helm list --short | while read helm_name; do\n    if [ ! \"$DRY_RUN\" = \"true\" ]; then\n-     (\n+   (\n      set -x\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         helm delete --purge  $helm_name\n-       else \n-         helm uninstall $helm_name -n $ns \n-       fi\n-     done\n-     )\n+     helm delete --purge  $helm_name\n+    )\n    else\n-     (\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+     echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+   fi\n+   done\n+  fi\n+\n+  if [ \"$HELM_VERSION\" == \"V3\" ]; then\n+   namespaces=`helm list --all-namespaces | grep -v NAME | awk '{print $2}'`", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0NzkzMg=="}, "originalCommit": {"oid": "0ac4258fb8ece9425368c5b6295e13ad93530391"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU1MDYzMg==", "bodyText": "i am assuming that the above command does not yield a ns unless there's at least one helm release in the ns", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400550632", "createdAt": "2020-03-30T23:16:33Z", "author": {"login": "tbarnes-us"}, "path": "src/integration-tests/bash/cleanup.sh", "diffHunk": "@@ -523,32 +523,38 @@ if [ -x \"$(command -v helm)\" ]; then\n   [[ $? == 1 ]] && HELM_VERSION=V3\n   echo \"Detected Helm Version [$(helm version --short --client)]\"\n   echo @@ `timestamp` Deleting installed helm charts\n-  namespaces=`kubectl get ns | grep -v NAME | awk '{ print $1 }'`\n-  for ns in $namespaces\n-  do \n+  if [ \"$HELM_VERSION\" == \"V2\" ]; then\n+   helm list --short | while read helm_name; do\n    if [ ! \"$DRY_RUN\" = \"true\" ]; then\n-     (\n+   (\n      set -x\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         helm delete --purge  $helm_name\n-       else \n-         helm uninstall $helm_name -n $ns \n-       fi\n-     done\n-     )\n+     helm delete --purge  $helm_name\n+    )\n    else\n-     (\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+     echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+   fi\n+   done\n+  fi\n+\n+  if [ \"$HELM_VERSION\" == \"V3\" ]; then\n+   namespaces=`helm list --all-namespaces | grep -v NAME | awk '{print $2}'`", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0NzkzMg=="}, "originalCommit": {"oid": "0ac4258fb8ece9425368c5b6295e13ad93530391"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NDEyOTg1OnYy", "diffSide": "RIGHT", "path": "src/integration-tests/bash/cleanup.sh", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMDo0NzowNVrOF-BW4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMDo0NzowNVrOF-BW4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3ODI3Mw==", "bodyText": "Change \"helm uninstall \" to \"set -x ; helm uninstall \".  In my testing it turns out that the outer scoped set -x is suppressed by teh the system call scope, so you need one inside the system call scope too.", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400578273", "createdAt": "2020-03-31T00:47:05Z", "author": {"login": "tbarnes-us"}, "path": "src/integration-tests/bash/cleanup.sh", "diffHunk": "@@ -537,23 +537,15 @@ if [ -x \"$(command -v helm)\" ]; then\n   fi\n \n   if [ \"$HELM_VERSION\" == \"V3\" ]; then\n-   namespaces=`helm list --all-namespaces | grep -v NAME | awk '{print $2}'`\n-   for ns in $namespaces\n-   do \n-     echo \"Looking for helm lists in namesapce $ns\"\n-     helm_names=`helm list --short -n $ns`\n-     for helm_name in $helm_names\n-     do \n-        if [ ! \"$DRY_RUN\" = \"true\" ]; then\n-        (\n-          set -x\n-          helm uninstall $helm_name -n $ns\n-        )\n-       else \n-         echo @@ `timestamp` Info: DRYRUN: helm uninstall $helm_name -n $ns\n-       fi\n-     done\n-   done\n+    if [ ! \"$DRY_RUN\" = \"true\" ]; then\n+    (\n+      set -x\n+      helm list --all-namespaces | grep -v NAME | awk '{system(\"helm uninstall \" $1 \" --namespace \" $2)}'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12fc7703b5a84c816851f953fec892049744b199"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4686, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}