{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5OTMwMjg2", "number": 3053, "title": "[Feature-2154][api] Workflow version control", "bodyText": "What is the purpose of the pull request\nImplement workflow version control (#2154 ) (#3046 )\nBrief change log\n\nAdd the process definition when create or update the process definition in ProcessDefinitionController, ProcessDefinitionService, and update the process instance in ProcessInstanceService\nAdd new table t_ds_process_definition_version to database, and add the service ProcessDefinitionVersionService, dao ProcessDefinitionVersionMapper.java, mapper ProcessDefinitionVersionMapper.xml, entity ProcessDefinitionVersion\nAdd some return info in Status\nAdd the version.vue in front-end ui and use it in list.vue, dag.vue\n\nVerify this pull request\n\nAdd test cases to cover this unit cases for this feature\nPackage and test feature and sql runner in linux env locally", "createdAt": "2020-06-25T10:30:51Z", "url": "https://github.com/apache/dolphinscheduler/pull/3053", "merged": true, "mergeCommit": {"oid": "93660f4d617d750d803cc3a7f68fe06c6f694463"}, "closed": true, "closedAt": "2020-08-25T02:46:59Z", "author": {"login": "yangyichao-mango"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcusLzlgFqTQzNzM3MDAwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCOCvggFqTQ3NDA2NTg1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MzcwMDAz", "url": "https://github.com/apache/dolphinscheduler/pull/3053#pullrequestreview-437370003", "createdAt": "2020-06-25T10:35:19Z", "commit": {"oid": "5309fbe8198feaa11ba5410fd4c2be41dff12a82"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMDozNToxOVrOGo0_zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMDozNToxOVrOGo0_zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ2NDUyNw==", "bodyText": "Hi @dailidong , Is it necessary to add distributed locks?", "url": "https://github.com/apache/dolphinscheduler/pull/3053#discussion_r445464527", "createdAt": "2020-06-25T10:35:19Z", "author": {"login": "yangyichao-mango"}, "path": "dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/service/ProcessDefinitionVersionService.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.dolphinscheduler.api.service;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+import org.apache.dolphinscheduler.api.enums.Status;\n+import org.apache.dolphinscheduler.api.utils.PageInfo;\n+import org.apache.dolphinscheduler.common.Constants;\n+import org.apache.dolphinscheduler.dao.entity.ProcessDefinition;\n+import org.apache.dolphinscheduler.dao.entity.ProcessDefinitionVersion;\n+import org.apache.dolphinscheduler.dao.entity.Project;\n+import org.apache.dolphinscheduler.dao.entity.User;\n+import org.apache.dolphinscheduler.dao.mapper.ProcessDefinitionVersionMapper;\n+import org.apache.dolphinscheduler.dao.mapper.ProjectMapper;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import com.baomidou.mybatisplus.core.metadata.IPage;\n+import com.baomidou.mybatisplus.extension.plugins.pagination.Page;\n+import com.google.common.collect.ImmutableMap;\n+\n+@Service\n+public class ProcessDefinitionVersionService {\n+\n+    @Autowired\n+    private ProcessDefinitionVersionMapper processDefinitionVersionMapper;\n+\n+    @Autowired\n+    private ProjectService projectService;\n+\n+    @Autowired\n+    private ProjectMapper projectMapper;\n+\n+    /**\n+     * add the newest version of one process definition\n+     *\n+     * @param processDefinition the process definition that need to record version\n+     * @return the newest version number of this process definition\n+     */\n+    public long addProcessDefinitionVersion(ProcessDefinition processDefinition) {\n+\n+        long version = this.queryMaxVersionByProcessDefinitionId(processDefinition.getId()) + 1;\n+\n+        ProcessDefinitionVersion processDefinitionVersion = ProcessDefinitionVersion\n+                .newBuilder()\n+                .processDefinitionId(processDefinition.getId())\n+                .version(version)\n+                .processDefinitionJson(processDefinition.getProcessDefinitionJson())\n+                .description(processDefinition.getDescription())\n+                .locations(processDefinition.getLocations())\n+                .connects(processDefinition.getConnects())\n+                .timeout(processDefinition.getTimeout())\n+                .globalParams(processDefinition.getGlobalParams())\n+                .createTime(processDefinition.getUpdateTime())\n+                .receivers(processDefinition.getReceivers())\n+                .receiversCc(processDefinition.getReceiversCc())\n+                .resourceIds(processDefinition.getResourceIds())\n+                .build();\n+\n+        processDefinitionVersionMapper.insert(processDefinitionVersion);\n+\n+        return version;\n+    }\n+\n+    /**\n+     * query the max version number by the process definition id\n+     *\n+     * @param processDefinitionId process definition id\n+     * @return the max version number of this id\n+     */\n+    public long queryMaxVersionByProcessDefinitionId(int processDefinitionId) {\n+        // TODO Is it necessary to add distributed locks?\n+        Long maxVersion =  processDefinitionVersionMapper.queryMaxVersionByProcessDefinitionId(processDefinitionId);\n+        if (Objects.isNull(maxVersion)) {\n+            return 0L;\n+        } else {\n+            return maxVersion;\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5309fbe8198feaa11ba5410fd4c2be41dff12a82"}, "originalPosition": 97}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5309fbe8198feaa11ba5410fd4c2be41dff12a82", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/5309fbe8198feaa11ba5410fd4c2be41dff12a82", "committedDate": "2020-06-25T10:19:45Z", "message": "[Feature-2154] Workflow version control"}, "afterCommit": {"oid": "0d8331a7f74d13f14e9dce9ce3f9f2daf25eba4b", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/0d8331a7f74d13f14e9dce9ce3f9f2daf25eba4b", "committedDate": "2020-07-13T13:35:23Z", "message": "[Feature-2154] Workflow version control"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6fecc20366b4f4e66c8ef29117c8e0fa4643f3a0", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/6fecc20366b4f4e66c8ef29117c8e0fa4643f3a0", "committedDate": "2020-07-14T04:00:53Z", "message": "[Feature][docs] Update test cases"}, "afterCommit": {"oid": "3ad7e2262cd781c423ebd1c4a38a189b9be0bd45", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/3ad7e2262cd781c423ebd1c4a38a189b9be0bd45", "committedDate": "2020-07-16T02:17:09Z", "message": "[Feature][api] Fix test cases"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f1f846730eccaea699604057a422ef53fea3920", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/6f1f846730eccaea699604057a422ef53fea3920", "committedDate": "2020-07-21T12:19:04Z", "message": "Merge branch 'dev' into feature-2154"}, "afterCommit": {"oid": "693d5c38594f5b034440997e80a72020a3331b9b", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/693d5c38594f5b034440997e80a72020a3331b9b", "committedDate": "2020-08-01T04:59:54Z", "message": "[Feature] Run e2e"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1402bdc8f90798557bc1842b0df5125490a07298", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/1402bdc8f90798557bc1842b0df5125490a07298", "committedDate": "2020-08-01T05:12:02Z", "message": "Add interface"}, "afterCommit": {"oid": "fd97af0b86f6f1a6d72345415bc905e7ed3815e3", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/fd97af0b86f6f1a6d72345415bc905e7ed3815e3", "committedDate": "2020-08-01T08:24:17Z", "message": "Add interface"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd97af0b86f6f1a6d72345415bc905e7ed3815e3", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/fd97af0b86f6f1a6d72345415bc905e7ed3815e3", "committedDate": "2020-08-01T08:24:17Z", "message": "Add interface"}, "afterCommit": {"oid": "01a7347475c2737c7fcac75b8153f64831029f76", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/01a7347475c2737c7fcac75b8153f64831029f76", "committedDate": "2020-08-04T10:34:05Z", "message": "Feature: add version control for process definition"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc1439853bc8e19e3828244ecc19515e633875d5", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/bc1439853bc8e19e3828244ecc19515e633875d5", "committedDate": "2020-08-04T13:35:29Z", "message": "Feature: add impl"}, "afterCommit": {"oid": "81e83d836c4e363b4c4f3eaef86034dd2d5b56ab", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/81e83d836c4e363b4c4f3eaef86034dd2d5b56ab", "committedDate": "2020-08-24T13:08:20Z", "message": "fix conflict"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81e83d836c4e363b4c4f3eaef86034dd2d5b56ab", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/81e83d836c4e363b4c4f3eaef86034dd2d5b56ab", "committedDate": "2020-08-24T13:08:20Z", "message": "fix conflict"}, "afterCommit": {"oid": "48fcb2271e2a71fc313018f468e12670f575be0c", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/48fcb2271e2a71fc313018f468e12670f575be0c", "committedDate": "2020-08-24T13:14:28Z", "message": "Feature: add version control for process definition"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f9aa964f4a2e6f2e9cec4b3837c1926c3e0c1b4", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/0f9aa964f4a2e6f2e9cec4b3837c1926c3e0c1b4", "committedDate": "2020-08-24T13:28:39Z", "message": "Checkstyle"}, "afterCommit": {"oid": "8c2744c3e6479c1dbb62e607f4abff7e5aa1a5a2", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/8c2744c3e6479c1dbb62e607f4abff7e5aa1a5a2", "committedDate": "2020-08-24T13:37:58Z", "message": "[Test][server] Add the master server test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9cc1a5ff447105f17ef76ee6bf9728d3ec6c2cc", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/c9cc1a5ff447105f17ef76ee6bf9728d3ec6c2cc", "committedDate": "2020-08-24T13:44:17Z", "message": "[Feature][api] Workflow version control"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c7de99bb1072fd6e784f86e616cfbc6625c4355", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/9c7de99bb1072fd6e784f86e616cfbc6625c4355", "committedDate": "2020-08-24T13:42:10Z", "message": "[Test][server] Add the master server test case"}, "afterCommit": {"oid": "c9cc1a5ff447105f17ef76ee6bf9728d3ec6c2cc", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/c9cc1a5ff447105f17ef76ee6bf9728d3ec6c2cc", "committedDate": "2020-08-24T13:44:17Z", "message": "[Feature][api] Workflow version control"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce08eeeed20aa2302c3e40ba7b11a15a7390b211", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/ce08eeeed20aa2302c3e40ba7b11a15a7390b211", "committedDate": "2020-08-24T13:45:10Z", "message": "Update messages.properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6349bfe79d1a612ca49679d189c5deef1b7096d", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/a6349bfe79d1a612ca49679d189c5deef1b7096d", "committedDate": "2020-08-24T13:45:37Z", "message": "Update messages_en_US.properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0eb2bff6eeba1dfc4ae424cfaa908cfcf337c03", "author": {"user": {"login": "yangyichao-mango", "name": "Yichao Yang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/c0eb2bff6eeba1dfc4ae424cfaa908cfcf337c03", "committedDate": "2020-08-24T13:45:57Z", "message": "Update messages_zh_CN.properties"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MDY1ODU1", "url": "https://github.com/apache/dolphinscheduler/pull/3053#pullrequestreview-474065855", "createdAt": "2020-08-25T02:46:45Z", "commit": {"oid": "c0eb2bff6eeba1dfc4ae424cfaa908cfcf337c03"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1845, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}