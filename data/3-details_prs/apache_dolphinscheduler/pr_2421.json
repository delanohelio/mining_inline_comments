{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMDAyMTIz", "number": 2421, "title": "workflow lineage", "bodyText": "Tips\n\nThanks very much for contributing to Apache DolphinScheduler.\nPlease review https://dolphinscheduler.apache.org/en-us/community/index.html before opening a pull request.\n\nWhat is the purpose of the pull request\nThis pull request adds workflow lineage\nBrief change log\nThis change added tests and can be verified as follows:\n\nAdded dolphinscheduler-api tests for unit test\nManually verified the change by testing locally.", "createdAt": "2020-04-14T06:53:14Z", "url": "https://github.com/apache/dolphinscheduler/pull/2421", "merged": true, "mergeCommit": {"oid": "f27c62a5dbee2c0f3f51b7975cbc2cd2e792b313"}, "closed": true, "closedAt": "2020-07-30T05:32:30Z", "author": {"login": "LiemLin"}, "timelineItems": {"totalCount": 33, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXc48mgH2gAyNDAzMDAyMTIzOjNiZTA5YjBlY2NiNzUzMjMzMzYwNTZhYTNjZjllODc4NTYxNDFjODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc54zaGAFqTQ1ODA4MTA2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3be09b0eccb75323336056aa3cf9e87856141c83", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/3be09b0eccb75323336056aa3cf9e87856141c83", "committedDate": "2020-04-14T05:45:53Z", "message": "workflow lineage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05b0e25cf684117abee46a7d2b3e0279afd8402b", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/05b0e25cf684117abee46a7d2b3e0279afd8402b", "committedDate": "2020-04-14T06:48:09Z", "message": "workflow lineage unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bd6a5fad4c6cb2180c5b06cbb272ff8625c8d4f", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/6bd6a5fad4c6cb2180c5b06cbb272ff8625c8d4f", "committedDate": "2020-04-15T06:39:12Z", "message": "Merge branch 'dev' into dev"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fe80777c1f62816d87cc0c4209a461beae0ad15", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/5fe80777c1f62816d87cc0c4209a461beae0ad15", "committedDate": "2020-04-15T06:50:35Z", "message": "stash"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6f4de019171bc00c9f04791853060e450974792", "author": {"user": null}, "url": "https://github.com/apache/dolphinscheduler/commit/f6f4de019171bc00c9f04791853060e450974792", "committedDate": "2020-04-15T06:52:09Z", "message": "Merge branch 'dev' of https://github.com/LiemLin/incubator-dolphinscheduler into dev\n\n\u0001 Conflicts:\n\u0001\tdolphinscheduler-common/src/main/resources/common.properties\n\u0001\tdolphinscheduler-dao/src/main/resources/application.properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4a967aa9ca79e29d90ad68c582c494453181156", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/b4a967aa9ca79e29d90ad68c582c494453181156", "committedDate": "2020-04-15T07:03:03Z", "message": "add apache license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5621042260866e1ef4f1ef2444b8250fa5f5302", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/a5621042260866e1ef4f1ef2444b8250fa5f5302", "committedDate": "2020-04-15T07:07:48Z", "message": "Update .env"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fdb1cb97af5c13fb6b230ccafdcfb91fc50d0a3", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/0fdb1cb97af5c13fb6b230ccafdcfb91fc50d0a3", "committedDate": "2020-04-15T08:21:05Z", "message": "code optimize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6420e8f4b2fb081c2672d9426419064b33110e4", "author": {"user": null}, "url": "https://github.com/apache/dolphinscheduler/commit/d6420e8f4b2fb081c2672d9426419064b33110e4", "committedDate": "2020-04-15T08:22:33Z", "message": "Merge remote-tracking branch 'origin/dev' into dev"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f392e29fdb0a466527a5555eec3ad84b9ab02e7b", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/f392e29fdb0a466527a5555eec3ad84b9ab02e7b", "committedDate": "2020-04-15T09:15:55Z", "message": "add unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9d968c4760ae3ede5747fd07261203ac6e2e8e6", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/f9d968c4760ae3ede5747fd07261203ac6e2e8e6", "committedDate": "2020-04-15T09:20:24Z", "message": "add apache license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3def532ed850713ee8e02452c6fd3071d8632f67", "author": {"user": {"login": "dailidong", "name": "lidongdai"}}, "url": "https://github.com/apache/dolphinscheduler/commit/3def532ed850713ee8e02452c6fd3071d8632f67", "committedDate": "2020-04-15T14:30:06Z", "message": "Merge branch 'dev' into dev"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ece442495524f3bd673f3e194fc250ef98a477d5", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/ece442495524f3bd673f3e194fc250ef98a477d5", "committedDate": "2020-04-16T02:02:20Z", "message": "add apache license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2892063447a8bac9699d7ca1f4de05fced1abeaf", "author": {"user": null}, "url": "https://github.com/apache/dolphinscheduler/commit/2892063447a8bac9699d7ca1f4de05fced1abeaf", "committedDate": "2020-04-16T02:03:05Z", "message": "Merge remote-tracking branch 'origin/dev' into dev"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1077e7f123821cf55a290393966c0f3680fa77b1", "author": {"user": {"login": "dailidong", "name": "lidongdai"}}, "url": "https://github.com/apache/dolphinscheduler/commit/1077e7f123821cf55a290393966c0f3680fa77b1", "committedDate": "2020-04-16T14:51:39Z", "message": "Merge branch 'dev' into dev"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b636bd020c97d21abf19b0691278b7b07ab1a45", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/8b636bd020c97d21abf19b0691278b7b07ab1a45", "committedDate": "2020-04-17T02:01:46Z", "message": "optimized code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f62b746db156ba33de96285570be0f11c0e8a914", "author": {"user": null}, "url": "https://github.com/apache/dolphinscheduler/commit/f62b746db156ba33de96285570be0f11c0e8a914", "committedDate": "2020-04-17T02:05:02Z", "message": "Merge remote-tracking branch 'origin/dev' into dev"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MTM0OTYy", "url": "https://github.com/apache/dolphinscheduler/pull/2421#pullrequestreview-395134962", "createdAt": "2020-04-17T03:17:22Z", "commit": {"oid": "3be09b0eccb75323336056aa3cf9e87856141c83"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzoxNzoyMlrOGG-hdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzoxNzoyMlrOGG-hdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk2OTAxNA==", "bodyText": "You can translate this to english.", "url": "https://github.com/apache/dolphinscheduler/pull/2421#discussion_r409969014", "createdAt": "2020-04-17T03:17:22Z", "author": {"login": "lgcareer"}, "path": "dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/service/WorkFlowLineageService.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.apache.dolphinscheduler.api.service;\n+\n+import org.apache.dolphinscheduler.api.enums.Status;\n+import org.apache.dolphinscheduler.common.Constants;\n+import org.apache.dolphinscheduler.dao.mapper.WorkFlowLineageMapper;\n+import org.apache.dolphinscheduler.dao.entity.WorkFlowLineage;\n+import org.apache.dolphinscheduler.dao.entity.WorkFlowRelation;\n+import org.apache.commons.lang.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Repository;\n+import org.springframework.stereotype.Service;\n+\n+import java.util.*;\n+\n+@Service\n+public class WorkFlowLineageService extends BaseService {\n+    private static final Logger logger = LoggerFactory.getLogger(WorkFlowLineageService.class);\n+\n+    @Autowired\n+    private WorkFlowLineageMapper workFlowLineageMapper;\n+\n+    public Map<String, Object> queryWorkFlowLineageByName(String workFlowName, int projectId) {\n+        Map<String, Object> result = new HashMap<>(5);\n+        List<WorkFlowLineage> workFlowLineageList = workFlowLineageMapper.queryByName(workFlowName, projectId);\n+        result.put(Constants.DATA_LIST, workFlowLineageList);\n+        putMsg(result, Status.SUCCESS);\n+        return result;\n+    }\n+\n+    private List<WorkFlowRelation> getWorkFlowRelationRecursion(Set<Integer> ids, List<WorkFlowRelation> workFlowRelations) {\n+        for(int id : ids) {\n+            List<WorkFlowRelation> workFlowRelationsTmp = workFlowLineageMapper.querySourceTarget(id);\n+\n+            if(workFlowRelationsTmp != null && workFlowRelationsTmp.size()>0) {\n+                Set<Integer> idsTmp = new HashSet<>();\n+                for(WorkFlowRelation workFlowRelation:workFlowRelationsTmp) {\n+                    idsTmp.add(workFlowRelation.getTargetWorkFlowId());\n+                }\n+                workFlowRelations.addAll(workFlowRelationsTmp);\n+                getWorkFlowRelationRecursion(idsTmp, workFlowRelations);\n+            }\n+        }\n+        return workFlowRelations;\n+    }\n+\n+    public Map<String, Object> queryWorkFlowLineageByIds(Set<Integer> ids,int projectId) {\n+        Map<String, Object> result = new HashMap<>(5);\n+        List<WorkFlowLineage> workFlowLineageList = workFlowLineageMapper.queryByIds(ids, projectId);\n+        Map<String, Object> workFlowLists = new HashMap<>(5);\n+        Set<Integer> idsV = ids;\n+        if(ids == null || ids.size() == 0){\n+            for(WorkFlowLineage workFlowLineage:workFlowLineageList) {\n+                idsV.add(workFlowLineage.getWorkFlowId());\n+            }\n+        }\n+        List<WorkFlowRelation> workFlowRelations = new ArrayList<>();\n+        getWorkFlowRelationRecursion(idsV, workFlowRelations);\n+\n+        Set<Integer> idSet = new HashSet<>();\n+        //\u5982\u679c\u4f20\u5165\u53c2\u6570\u4e0d\u4e3a\u7a7a\uff0c\u5219\u9700\u8981\u8865\u5145\u4e0b\u6e38\u5de5\u4f5c\u6d41\u660e\u7ec6\u5c5e\u6027", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3be09b0eccb75323336056aa3cf9e87856141c83"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f7ec4e08228cb73519f6b31cb2887fb921a5293", "author": {"user": {"login": "dailidong", "name": "lidongdai"}}, "url": "https://github.com/apache/dolphinscheduler/commit/5f7ec4e08228cb73519f6b31cb2887fb921a5293", "committedDate": "2020-04-18T03:21:00Z", "message": "Merge branch 'dev' into dev"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15d192816e5a0cecfb97c701d7688d72bc8e0abf", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/15d192816e5a0cecfb97c701d7688d72bc8e0abf", "committedDate": "2020-04-20T06:11:39Z", "message": "add postgresql support and optimized code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bde7a4501f320e31e32f1f38f47f55e3ca31892a", "author": {"user": null}, "url": "https://github.com/apache/dolphinscheduler/commit/bde7a4501f320e31e32f1f38f47f55e3ca31892a", "committedDate": "2020-04-20T06:12:14Z", "message": "Merge remote-tracking branch 'origin/dev' into dev"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f7ee96a1b5cb842a1fc102e043f90ccd048b0a8", "author": {"user": {"login": "dailidong", "name": "lidongdai"}}, "url": "https://github.com/apache/dolphinscheduler/commit/5f7ee96a1b5cb842a1fc102e043f90ccd048b0a8", "committedDate": "2020-04-23T08:57:44Z", "message": "Merge branch 'dev' into dev"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0543197713007dac31a4f8bc0e10f482f4eba653", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/0543197713007dac31a4f8bc0e10f482f4eba653", "committedDate": "2020-07-13T09:03:22Z", "message": "Merge branch 'dev' into dev"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffaf7585178cd8a9a7f469b5f2e3af3e39010686", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/ffaf7585178cd8a9a7f469b5f2e3af3e39010686", "committedDate": "2020-07-14T04:08:32Z", "message": "Update pom.xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4d175104b98ef4373020641a37cb2714e728409", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/f4d175104b98ef4373020641a37cb2714e728409", "committedDate": "2020-07-14T04:23:19Z", "message": "Update en_US.js"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c99183cc06f1475f1df4dd3dfb3db1a6b88717b", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/4c99183cc06f1475f1df4dd3dfb3db1a6b88717b", "committedDate": "2020-07-14T04:24:53Z", "message": "Update zh_CN.js"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "250c4851952d5c5d25ec508546889facee0c5c9e", "author": {"user": {"login": "becarchal", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/250c4851952d5c5d25ec508546889facee0c5c9e", "committedDate": "2020-07-14T06:15:21Z", "message": "remove mock code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0834603e5b027b8e5f332e3e762adf2923dc4ee6", "author": {"user": {"login": "becarchal", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/0834603e5b027b8e5f332e3e762adf2923dc4ee6", "committedDate": "2020-07-14T06:16:06Z", "message": "inport i18n"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e949b51f633abf17835463e422b9481257334407", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/e949b51f633abf17835463e422b9481257334407", "committedDate": "2020-07-14T06:57:25Z", "message": "Update pom.xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5eccbf86ea2ea79507dd5bd29a095b13fc8971fc", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/5eccbf86ea2ea79507dd5bd29a095b13fc8971fc", "committedDate": "2020-07-14T09:50:37Z", "message": "Delete .env"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17827731aceea7eb36eb5a7a82897c50e02cb049", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/17827731aceea7eb36eb5a7a82897c50e02cb049", "committedDate": "2020-07-15T01:44:53Z", "message": "add env file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17c10512a8c9da6296efafb8710afa90c4276497", "author": {"user": {"login": "LiemLin", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/17c10512a8c9da6296efafb8710afa90c4276497", "committedDate": "2020-07-30T05:22:25Z", "message": "Merge branch 'dev' into dev"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MDgxMDYy", "url": "https://github.com/apache/dolphinscheduler/pull/2421#pullrequestreview-458081062", "createdAt": "2020-07-30T05:30:36Z", "commit": {"oid": "17c10512a8c9da6296efafb8710afa90c4276497"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2032, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}