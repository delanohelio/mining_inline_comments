{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyNDMwOTcw", "number": 3582, "title": "[Feature][API] process definition delete api add check process instance is already running. #3581", "bodyText": "What is the purpose of the pull request\nThe workflow definition deletion function is added to check whether there are running workflow instances according to the workflow definition ID and running status. If there are running workflow instances, they are not allowed to be deleted, and a friendly prompt will be given.    #3581\nBrief change log\nNew running workflow instance check\nProcessDefinitionServiceImpl.deleteProcessDefinitionById\n  // check process instances is already running\n        List<ProcessInstance> processInstances =  processInstanceMapper.queryByProcessDefineIdAndStatus(processDefinitionId, Constants.NOT_TERMINATED_STATES);\n        if(CollectionUtils.isNotEmpty(processInstances)){\n            putMsg(result, Status.DELETE_PROCESS_DEFINITION_BY_ID_FAIL,processInstances.size());\n            return result;\n        }\n\n\nVerify this pull request\n(Please pick either of the following options)\nThis pull request is already covered by existing tests, such as (please describe tests).\nProcessDefinitionControllerTest.testDeleteProcessDefinitionById()\n\n##\u62c9\u53d6\u8bf7\u6c42\u7684\u76ee\u7684\u662f\u4ec0\u4e48\n\u5de5\u4f5c\u6d41\u5b9a\u4e49\u5220\u9664\u529f\u80fd\uff0c\u65b0\u589e\u6839\u636e\u5de5\u4f5c\u6d41\u5b9a\u4e49ID\u548c\u8fd0\u884c\u72b6\u6001\uff0c\u68c0\u67e5\u662f\u5426\u6709\u6b63\u5728\u8fd0\u884c\u7684\u5de5\u4f5c\u6d41\u5b9e\u4f8b\uff0c\u5982\u679c\u6709\u6b63\u5728\u8fd0\u884c\u7684\u5de5\u4f5c\u6d41\u5b9e\u4f8b\uff0c\u4e0d\u5141\u8bb8\u5220\u9664\uff0c\u53cb\u60c5\u63d0\u793a\u3002\n##\u7b80\u8981\u53d8\u66f4\u65e5\u5fd7\n\u65b0\u589e\u6b63\u5728\u8fd0\u884c\u5de5\u4f5c\u6d41\u5b9e\u4f8b\u68c0\u67e5\nProcessDefinitionServiceImpl.deleteProcessDefinitionById\n  // check process instances is already running\n        List<ProcessInstance> processInstances =  processInstanceMapper.queryByProcessDefineIdAndStatus(processDefinitionId, Constants.NOT_TERMINATED_STATES);\n        if(CollectionUtils.isNotEmpty(processInstances)){\n            putMsg(result, Status.DELETE_PROCESS_DEFINITION_BY_ID_FAIL,processInstances.size());\n            return result;\n        }\n\n\n##\u9a8c\u8bc1\u6b64\u8bf7\u6c42\n\uff08\u8bf7\u9009\u62e9\u4ee5\u4e0b\u4efb\u4e00\u9009\u9879\uff09\n\u6b64\u8bf7\u6c42\u5df2\u88ab\u73b0\u6709\u6d4b\u8bd5\u8986\u76d6\uff0c\u4f8b\u5982*\uff08\u8bf7\u63cf\u8ff0\u6d4b\u8bd5\uff09*\u3002\nProcessDefinitionControllerTest.testDeleteProcessDefinitionById()", "createdAt": "2020-08-24T10:45:27Z", "url": "https://github.com/apache/dolphinscheduler/pull/3582", "merged": true, "mergeCommit": {"oid": "21a90f2161d887433313de3248a2d06663ec9b95"}, "closed": true, "closedAt": "2020-09-07T03:03:52Z", "author": {"login": "zhuangchong"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdB7tuRAH2gAyNDcyNDMwOTcwOjk3Mzk3YjQwZmEwMDQyNGFkYjcyYjI2ZGFlMDA2YTY0ZDczNTk1MmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdC7jUyAH2gAyNDcyNDMwOTcwOjc3MmM3ZjJlZWM1OWE4YzI1Mjg2NzAzZTNmM2RhNWQzM2YwOTZmODE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "97397b40fa00424adb72b26dae006a64d735952f", "author": {"user": null}, "url": "https://github.com/apache/dolphinscheduler/commit/97397b40fa00424adb72b26dae006a64d735952f", "committedDate": "2020-08-24T05:25:30Z", "message": "process definition delete api add check process instance is already running."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2aaac4b3d297f7a5f7b73a133e1dfde978c64530", "author": {"user": null}, "url": "https://github.com/apache/dolphinscheduler/commit/2aaac4b3d297f7a5f7b73a133e1dfde978c64530", "committedDate": "2020-08-25T01:38:54Z", "message": "add checkstyle."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MDgzMDcy", "url": "https://github.com/apache/dolphinscheduler/pull/3582#pullrequestreview-474083072", "createdAt": "2020-08-25T02:55:13Z", "commit": {"oid": "2aaac4b3d297f7a5f7b73a133e1dfde978c64530"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f927f0fac150f822d5e9bd219db3284b99373ed", "author": {"user": null}, "url": "https://github.com/apache/dolphinscheduler/commit/2f927f0fac150f822d5e9bd219db3284b99373ed", "committedDate": "2020-08-25T03:10:58Z", "message": "update."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NTE1Mzky", "url": "https://github.com/apache/dolphinscheduler/pull/3582#pullrequestreview-475515392", "createdAt": "2020-08-26T13:56:42Z", "commit": {"oid": "2f927f0fac150f822d5e9bd219db3284b99373ed"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxMzo1Njo0MlrOHHNX4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxMzo1Njo0MlrOHHNX4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMyMTE4NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<ProcessInstance> processInstances =  processInstanceMapper.queryByProcessDefineIdAndStatus(processDefinitionId, Constants.NOT_TERMINATED_STATES);\n          \n          \n            \n                    if (CollectionUtils.isNotEmpty(processInstances)) {\n          \n          \n            \n                        putMsg(result, Status.DELETE_PROCESS_DEFINITION_BY_ID_FAIL,processInstances.size());\n          \n          \n            \n                        return result;\n          \n          \n            \n                    }\n          \n          \n            \n                    List<ProcessInstance> processInstances =  processInstanceService.queryByProcessDefineIdAndStatus(processDefinitionId, Constants.NOT_TERMINATED_STATES);\n          \n          \n            \n                    if (CollectionUtils.isNotEmpty(processInstances)) {\n          \n          \n            \n                        putMsg(result, Status.DELETE_PROCESS_DEFINITION_BY_ID_FAIL,processInstances.size());\n          \n          \n            \n                        return result;\n          \n          \n            \n                    }\n          \n      \n    \n    \n  \n\nHi,\nIn processDefinitionService service layer, it is not recommended straightly use processInstanceMapper dao layer, this part should be in processInstanceService, use processInstanceService here.", "url": "https://github.com/apache/dolphinscheduler/pull/3582#discussion_r477321185", "createdAt": "2020-08-26T13:56:42Z", "author": {"login": "yangyichao-mango"}, "path": "dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/service/impl/ProcessDefinitionServiceImpl.java", "diffHunk": "@@ -488,6 +488,12 @@ private String getResourceIds(ProcessData processData) {\n             putMsg(result, Status.PROCESS_DEFINE_STATE_ONLINE, processDefinitionId);\n             return result;\n         }\n+        // check process instances is already running\n+        List<ProcessInstance> processInstances =  processInstanceMapper.queryByProcessDefineIdAndStatus(processDefinitionId, Constants.NOT_TERMINATED_STATES);\n+        if (CollectionUtils.isNotEmpty(processInstances)) {\n+            putMsg(result, Status.DELETE_PROCESS_DEFINITION_BY_ID_FAIL,processInstances.size());\n+            return result;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f927f0fac150f822d5e9bd219db3284b99373ed"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d73b9ab248dcc53f230225b39f6a6961f4c0f50", "author": {"user": null}, "url": "https://github.com/apache/dolphinscheduler/commit/2d73b9ab248dcc53f230225b39f6a6961f4c0f50", "committedDate": "2020-08-27T07:20:51Z", "message": "processinstancemapper replaces processinstanceservice."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "772c7f2eec59a8c25286703e3f3da5d33f096f81", "author": {"user": null}, "url": "https://github.com/apache/dolphinscheduler/commit/772c7f2eec59a8c25286703e3f3da5d33f096f81", "committedDate": "2020-08-27T07:48:04Z", "message": "processinstancemapper replaces processinstanceservice."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1764, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}