{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5MjI3NTcw", "number": 2732, "title": "fix #2598::allow to update resource suffix,but if it is authorized to other users,it is not allowed", "bodyText": "What is the purpose of the pull request\nfix #2598:allow to update resource suffix,but if it is authorized to other users,it is not allowed.\nBrief change log\nadd RESOURCE_IS_AUTHORIZED status\nsupport update resource suffix", "createdAt": "2020-05-18T02:50:07Z", "url": "https://github.com/apache/dolphinscheduler/pull/2732", "merged": true, "mergeCommit": {"oid": "60f8eb25fa69fa39cd17404b9eb66376c174b9c3"}, "closed": true, "closedAt": "2020-05-18T09:56:42Z", "author": {"login": "lgcareer"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchyq65gH2gAyNDE5MjI3NTcwOjAyNDU3Yjc0OTU0MDM3YzNmNzhjZjhkZWYyODAzYmJlODkyODJjMjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcic0YmAFqTQxMzQ0MjM1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "02457b74954037c3f78cf8def2803bbe89282c24", "author": {"user": {"login": "lgcareer", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/02457b74954037c3f78cf8def2803bbe89282c24", "committedDate": "2020-05-16T08:47:43Z", "message": "fix #2598:allow to update resource suffix,but if it is authorized to other users,it is not allowed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8b19e46008f266eb6ea2add17765f8ca8a80ede", "author": {"user": {"login": "lgcareer", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/d8b19e46008f266eb6ea2add17765f8ca8a80ede", "committedDate": "2020-05-18T02:29:18Z", "message": "add RESOURCE_IS_AUTHORIZED status"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMjUzMzk1", "url": "https://github.com/apache/dolphinscheduler/pull/2732#pullrequestreview-413253395", "createdAt": "2020-05-18T03:39:59Z", "commit": {"oid": "d8b19e46008f266eb6ea2add17765f8ca8a80ede"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMzo0MDowMFrOGWmm5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwNToxMjoyNFrOGWnv0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM1NDQwNQ==", "bodyText": "change the message the user name is better.", "url": "https://github.com/apache/dolphinscheduler/pull/2732#discussion_r426354405", "createdAt": "2020-05-18T03:40:00Z", "author": {"login": "lenboo"}, "path": "dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/service/ResourcesService.java", "diffHunk": "@@ -355,12 +352,21 @@ public Result updateResource(User loginUser,\n         String nameWithSuffix = name;\n \n         if (!resource.isDirectory()) {\n-            //get the file suffix\n-            String suffix = originResourceName.substring(originResourceName.lastIndexOf(\".\"));\n-\n-            //if the name without suffix then add it ,else use the origin name\n-            if(!name.endsWith(suffix)){\n-                nameWithSuffix = nameWithSuffix + suffix;\n+            //get the origin file suffix\n+            String originSuffix = FileUtils.suffix(originFullName);\n+            String suffix = FileUtils.suffix(fullName);\n+            if (!suffix.equals(originSuffix)) {\n+                //need verify whether this resource is authorized to other users\n+                Map<String, Object> columnMap = new HashMap<String, Object>();\n+                columnMap.put(\"resources_id\", resourceId);\n+\n+                List<ResourcesUser> resourcesUsers = resourceUserMapper.selectByMap(columnMap);\n+                if (CollectionUtils.isNotEmpty(resourcesUsers)) {\n+                    String users = resourcesUsers.stream().map(t -> t.getUserId()).collect(Collectors.toList()).toString();\n+                    logger.error(\"resource is authorized to user {},suffix not allowed to be modified\", users);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8b19e46008f266eb6ea2add17765f8ca8a80ede"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM3MzA3Mg==", "bodyText": "or do not print user name?", "url": "https://github.com/apache/dolphinscheduler/pull/2732#discussion_r426373072", "createdAt": "2020-05-18T05:12:24Z", "author": {"login": "lenboo"}, "path": "dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/service/ResourcesService.java", "diffHunk": "@@ -355,12 +352,21 @@ public Result updateResource(User loginUser,\n         String nameWithSuffix = name;\n \n         if (!resource.isDirectory()) {\n-            //get the file suffix\n-            String suffix = originResourceName.substring(originResourceName.lastIndexOf(\".\"));\n-\n-            //if the name without suffix then add it ,else use the origin name\n-            if(!name.endsWith(suffix)){\n-                nameWithSuffix = nameWithSuffix + suffix;\n+            //get the origin file suffix\n+            String originSuffix = FileUtils.suffix(originFullName);\n+            String suffix = FileUtils.suffix(fullName);\n+            if (!suffix.equals(originSuffix)) {\n+                //need verify whether this resource is authorized to other users\n+                Map<String, Object> columnMap = new HashMap<String, Object>();\n+                columnMap.put(\"resources_id\", resourceId);\n+\n+                List<ResourcesUser> resourcesUsers = resourceUserMapper.selectByMap(columnMap);\n+                if (CollectionUtils.isNotEmpty(resourcesUsers)) {\n+                    String users = resourcesUsers.stream().map(t -> t.getUserId()).collect(Collectors.toList()).toString();\n+                    logger.error(\"resource is authorized to user {},suffix not allowed to be modified\", users);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM1NDQwNQ=="}, "originalCommit": {"oid": "d8b19e46008f266eb6ea2add17765f8ca8a80ede"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f06919c89fae726038078760f47dbb8176c04ea1", "author": {"user": {"login": "lgcareer", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/f06919c89fae726038078760f47dbb8176c04ea1", "committedDate": "2020-05-18T06:23:25Z", "message": "Merge remote-tracking branch 'remotes/upstream/dev-1.3.0' into dev-1.3.0-fix-2598"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad33b8b14514d718d07687d5b166fcdafe7115f8", "author": {"user": {"login": "lgcareer", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/ad33b8b14514d718d07687d5b166fcdafe7115f8", "committedDate": "2020-05-18T06:50:53Z", "message": "verify whether the suffix is empty"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1686a862ab178950d38ec350e6441f63619502a4", "author": {"user": {"login": "lgcareer", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/1686a862ab178950d38ec350e6441f63619502a4", "committedDate": "2020-05-18T08:17:45Z", "message": "Merge remote-tracking branch 'remotes/upstream/dev-1.3.0' into dev-1.3.0-fix-2598"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09cd91ef09b82720abe6deef38718c8c919629fa", "author": {"user": {"login": "lgcareer", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/09cd91ef09b82720abe6deef38718c8c919629fa", "committedDate": "2020-05-18T08:21:07Z", "message": "remove extra variables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6ce6d28031729b3814ada3e8ae01819e019b168", "author": {"user": {"login": "lgcareer", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/a6ce6d28031729b3814ada3e8ae01819e019b168", "committedDate": "2020-05-18T09:20:58Z", "message": "fix code smell"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNDQyMzUy", "url": "https://github.com/apache/dolphinscheduler/pull/2732#pullrequestreview-413442352", "createdAt": "2020-05-18T09:54:04Z", "commit": {"oid": "a6ce6d28031729b3814ada3e8ae01819e019b168"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2014, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}