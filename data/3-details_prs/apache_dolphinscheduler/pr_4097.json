{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2MzIxMjM1", "number": 4097, "title": "[FIX-#4084][server]fix taskInstance state change error", "bodyText": "Concurrent processing of ack message and result message causes the execution sequence to be wrong\nOptimize code and reduce database queries\nthis close #4084", "createdAt": "2020-11-24T09:01:10Z", "url": "https://github.com/apache/dolphinscheduler/pull/4097", "merged": true, "mergeCommit": {"oid": "656ec295b9e09468fc6a871df821ba42436c5e57"}, "closed": true, "closedAt": "2020-11-26T06:30:30Z", "author": {"login": "CalvinKirs"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfl6pbAH2gAyNTI2MzIxMjM1OjUzNTU5MjdiNzliYjFiNTRiN2E2YjU3NDcyNmMwYjM0OWIwMWU4YmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgM-lhAFqTUzOTAyMzc5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5355927b79bb1b54b7a6b574726c0b349b01e8bd", "author": {"user": {"login": "CalvinKirs", "name": "Kirs"}}, "url": "https://github.com/apache/dolphinscheduler/commit/5355927b79bb1b54b7a6b574726c0b349b01e8bd", "committedDate": "2020-11-24T08:59:26Z", "message": "[FIX-#4083][server]fix taskInstance state change error\nConcurrent processing of ack message and result message causes the execution sequence to be wrong\n\n# this close # 4083"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b20a3d5474d5f2c66cf6a9d7eac44255b772c8e5", "author": {"user": {"login": "CalvinKirs", "name": "Kirs"}}, "url": "https://github.com/apache/dolphinscheduler/commit/b20a3d5474d5f2c66cf6a9d7eac44255b772c8e5", "committedDate": "2020-11-24T09:15:48Z", "message": "code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c1a2ebeab13c425bd3667162e8d3ab857326e3d", "author": {"user": {"login": "CalvinKirs", "name": "Kirs"}}, "url": "https://github.com/apache/dolphinscheduler/commit/6c1a2ebeab13c425bd3667162e8d3ab857326e3d", "committedDate": "2020-11-24T14:49:39Z", "message": "add taskResponseTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ef6b70696b7e4ede8c4026fbfdf72f4f78139fb", "author": {"user": {"login": "CalvinKirs", "name": "Kirs"}}, "url": "https://github.com/apache/dolphinscheduler/commit/9ef6b70696b7e4ede8c4026fbfdf72f4f78139fb", "committedDate": "2020-11-24T15:13:01Z", "message": "add taskResponseTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "858c4f32875f2294bac5f1eae11142568bb0f367", "author": {"user": {"login": "CalvinKirs", "name": "Kirs"}}, "url": "https://github.com/apache/dolphinscheduler/commit/858c4f32875f2294bac5f1eae11142568bb0f367", "committedDate": "2020-11-25T01:20:58Z", "message": "code smell"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8286af79d3a77a5aa7b03e1241f56d38d7712f35", "author": {"user": {"login": "CalvinKirs", "name": "Kirs"}}, "url": "https://github.com/apache/dolphinscheduler/commit/8286af79d3a77a5aa7b03e1241f56d38d7712f35", "committedDate": "2020-11-25T01:38:58Z", "message": "Time is too small and the task is not finished"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a164d5f990c988cac7b45a2952f4d6eee5d17e44", "author": {"user": {"login": "CalvinKirs", "name": "Kirs"}}, "url": "https://github.com/apache/dolphinscheduler/commit/a164d5f990c988cac7b45a2952f4d6eee5d17e44", "committedDate": "2020-11-25T02:23:54Z", "message": "Time is too small and the task is not finished"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6a686a71078638a5ebcdecb30fe5e173deac96d", "author": {"user": {"login": "CalvinKirs", "name": "Kirs"}}, "url": "https://github.com/apache/dolphinscheduler/commit/c6a686a71078638a5ebcdecb30fe5e173deac96d", "committedDate": "2020-11-25T05:27:04Z", "message": "Time is too small and the task is not finished"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3991d9dee307191f200a6b660d7264d874d3cb9", "author": {"user": {"login": "CalvinKirs", "name": "Kirs"}}, "url": "https://github.com/apache/dolphinscheduler/commit/b3991d9dee307191f200a6b660d7264d874d3cb9", "committedDate": "2020-11-25T05:43:14Z", "message": "Time is too small and the task is not finished"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a9e789f68d6aba2bdd8a8073ac0abb4b36cd51e", "author": {"user": {"login": "CalvinKirs", "name": "Kirs"}}, "url": "https://github.com/apache/dolphinscheduler/commit/2a9e789f68d6aba2bdd8a8073ac0abb4b36cd51e", "committedDate": "2020-11-25T06:47:00Z", "message": "test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5769999d557b834621604930654a3baabdf5372", "author": {"user": {"login": "CalvinKirs", "name": "Kirs"}}, "url": "https://github.com/apache/dolphinscheduler/commit/d5769999d557b834621604930654a3baabdf5372", "committedDate": "2020-11-25T07:16:19Z", "message": "remove assert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc14b24326acbbbecc1a93188a31e817667d9ea6", "author": {"user": {"login": "CalvinKirs", "name": "Kirs"}}, "url": "https://github.com/apache/dolphinscheduler/commit/cc14b24326acbbbecc1a93188a31e817667d9ea6", "committedDate": "2020-11-25T10:11:55Z", "message": "test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0586e7b16004364e69e634e99dab8454ed187bed", "author": {"user": {"login": "CalvinKirs", "name": "Kirs"}}, "url": "https://github.com/apache/dolphinscheduler/commit/0586e7b16004364e69e634e99dab8454ed187bed", "committedDate": "2020-11-25T14:03:26Z", "message": "test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4OTYwMDYz", "url": "https://github.com/apache/dolphinscheduler/pull/4097#pullrequestreview-538960063", "createdAt": "2020-11-26T02:51:18Z", "commit": {"oid": "0586e7b16004364e69e634e99dab8454ed187bed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMjo1MToxOFrOH6KD9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMjo1MToxOFrOH6KD9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDc0NDMxMA==", "bodyText": "i think we should judge the task status finished: success/failed/stop...", "url": "https://github.com/apache/dolphinscheduler/pull/4097#discussion_r530744310", "createdAt": "2020-11-26T02:51:18Z", "author": {"login": "lenboo"}, "path": "dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/processor/queue/TaskResponseService.java", "diffHunk": "@@ -126,51 +127,52 @@ public void run() {\n \n     /**\n      * persist  taskResponseEvent\n+     *\n      * @param taskResponseEvent taskResponseEvent\n      */\n-    private void persist(TaskResponseEvent taskResponseEvent){\n+    private void persist(TaskResponseEvent taskResponseEvent) {\n         Event event = taskResponseEvent.getEvent();\n         Channel channel = taskResponseEvent.getChannel();\n \n-        switch (event){\n+        switch (event) {\n             case ACK:\n                 try {\n                     TaskInstance taskInstance = processService.findTaskInstanceById(taskResponseEvent.getTaskInstanceId());\n-                    if (taskInstance != null){\n-                        processService.changeTaskState(taskResponseEvent.getState(),\n-                                taskResponseEvent.getStartTime(),\n-                                taskResponseEvent.getWorkerAddress(),\n-                                taskResponseEvent.getExecutePath(),\n-                                taskResponseEvent.getLogPath(),\n-                                taskResponseEvent.getTaskInstanceId());\n+                    if (taskInstance != null && ExecutionStatus.SUCCESS.getCode() != taskInstance.getState().getCode()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0586e7b16004364e69e634e99dab8454ed187bed"}, "originalPosition": 127}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9022680214ab80548102f4d1cf12a041635ecb5", "author": {"user": {"login": "CalvinKirs", "name": "Kirs"}}, "url": "https://github.com/apache/dolphinscheduler/commit/c9022680214ab80548102f4d1cf12a041635ecb5", "committedDate": "2020-11-26T03:01:34Z", "message": "fix task instance status judgment error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4OTczMjA4", "url": "https://github.com/apache/dolphinscheduler/pull/4097#pullrequestreview-538973208", "createdAt": "2020-11-26T03:38:18Z", "commit": {"oid": "c9022680214ab80548102f4d1cf12a041635ecb5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5MDIxOTIy", "url": "https://github.com/apache/dolphinscheduler/pull/4097#pullrequestreview-539021922", "createdAt": "2020-11-26T06:24:56Z", "commit": {"oid": "c9022680214ab80548102f4d1cf12a041635ecb5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5MDIzNzk3", "url": "https://github.com/apache/dolphinscheduler/pull/4097#pullrequestreview-539023797", "createdAt": "2020-11-26T06:30:02Z", "commit": {"oid": "c9022680214ab80548102f4d1cf12a041635ecb5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2364, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}