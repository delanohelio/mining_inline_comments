{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxNTk2NzEw", "number": 2934, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwNjo0Nzo0NFrOEJjoCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwNjo0Nzo0NFrOEJjoCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NDU2MzI4OnYy", "diffSide": "RIGHT", "path": "dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/worker/registry/WorkerRegistry.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwNjo0Nzo0NFrOGqG4iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwOToyNjozM1rOGqz4-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgwNjE1Mw==", "bodyText": "Hello, is it possible to return directly here without continuing to judge? In addition, it is not very intuitive to flood with too many if else", "url": "https://github.com/apache/dolphinscheduler/pull/2934#discussion_r446806153", "createdAt": "2020-06-29T06:47:44Z", "author": {"login": "CalvinKirs"}, "path": "dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/worker/registry/WorkerRegistry.java", "diffHunk": "@@ -86,34 +90,39 @@ public void init(){\n      */\n     public void registry() {\n         String address = OSUtils.getHost();\n-        String localNodePath = getWorkerPath();\n-        zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(localNodePath, \"\");\n-        zookeeperRegistryCenter.getZookeeperCachedOperator().getZkClient().getConnectionStateListenable().addListener(new ConnectionStateListener() {\n-            @Override\n-            public void stateChanged(CuratorFramework client, ConnectionState newState) {\n-                if(newState == ConnectionState.LOST){\n-                    logger.error(\"worker : {} connection lost from zookeeper\", address);\n-                } else if(newState == ConnectionState.RECONNECTED){\n-                    logger.info(\"worker : {} reconnected to zookeeper\", address);\n-                    zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(localNodePath, \"\");\n-                } else if(newState == ConnectionState.SUSPENDED){\n-                    logger.warn(\"worker : {} connection SUSPENDED \", address);\n-                }\n-            }\n-        });\n+        Set<String> workerZkPaths = getWorkerZkPaths();\n         int workerHeartbeatInterval = workerConfig.getWorkerHeartbeatInterval();\n-        this.heartBeatExecutor.scheduleAtFixedRate(new HeartBeatTask(), workerHeartbeatInterval, workerHeartbeatInterval, TimeUnit.SECONDS);\n-        logger.info(\"worker node : {} registry to ZK successfully with heartBeatInterval : {}s\", address, workerHeartbeatInterval);\n \n+        for (String workerZKPath : workerZkPaths) {\n+            zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(workerZKPath, \"\");\n+            zookeeperRegistryCenter.getZookeeperCachedOperator().getZkClient().getConnectionStateListenable().addListener(new ConnectionStateListener() {\n+                @Override\n+                public void stateChanged(CuratorFramework client, ConnectionState newState) {\n+                    if (newState == ConnectionState.LOST) {\n+                        logger.error(\"worker : {} connection lost from zookeeper\", address);\n+                    } else if (newState == ConnectionState.RECONNECTED) {\n+                        logger.info(\"worker : {} reconnected to zookeeper\", address);\n+                        zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(workerZKPath, \"\");\n+                    } else if (newState == ConnectionState.SUSPENDED) {\n+                        logger.warn(\"worker : {} connection SUSPENDED \", address);\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8e389133811a95a095c7000dbb6971941d448ce"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkwNzY1Nw==", "bodyText": "Hello, is it possible to return directly here without continuing to judge? In addition, it is not very intuitive to flood with too many if else\n\nHi, Thx a lot for your review.\nCan you describe your opinion about why it need return directly? I think this is an important step for users to debug zk or worker status errors.", "url": "https://github.com/apache/dolphinscheduler/pull/2934#discussion_r446907657", "createdAt": "2020-06-29T11:46:03Z", "author": {"login": "yangyichao-mango"}, "path": "dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/worker/registry/WorkerRegistry.java", "diffHunk": "@@ -86,34 +90,39 @@ public void init(){\n      */\n     public void registry() {\n         String address = OSUtils.getHost();\n-        String localNodePath = getWorkerPath();\n-        zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(localNodePath, \"\");\n-        zookeeperRegistryCenter.getZookeeperCachedOperator().getZkClient().getConnectionStateListenable().addListener(new ConnectionStateListener() {\n-            @Override\n-            public void stateChanged(CuratorFramework client, ConnectionState newState) {\n-                if(newState == ConnectionState.LOST){\n-                    logger.error(\"worker : {} connection lost from zookeeper\", address);\n-                } else if(newState == ConnectionState.RECONNECTED){\n-                    logger.info(\"worker : {} reconnected to zookeeper\", address);\n-                    zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(localNodePath, \"\");\n-                } else if(newState == ConnectionState.SUSPENDED){\n-                    logger.warn(\"worker : {} connection SUSPENDED \", address);\n-                }\n-            }\n-        });\n+        Set<String> workerZkPaths = getWorkerZkPaths();\n         int workerHeartbeatInterval = workerConfig.getWorkerHeartbeatInterval();\n-        this.heartBeatExecutor.scheduleAtFixedRate(new HeartBeatTask(), workerHeartbeatInterval, workerHeartbeatInterval, TimeUnit.SECONDS);\n-        logger.info(\"worker node : {} registry to ZK successfully with heartBeatInterval : {}s\", address, workerHeartbeatInterval);\n \n+        for (String workerZKPath : workerZkPaths) {\n+            zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(workerZKPath, \"\");\n+            zookeeperRegistryCenter.getZookeeperCachedOperator().getZkClient().getConnectionStateListenable().addListener(new ConnectionStateListener() {\n+                @Override\n+                public void stateChanged(CuratorFramework client, ConnectionState newState) {\n+                    if (newState == ConnectionState.LOST) {\n+                        logger.error(\"worker : {} connection lost from zookeeper\", address);\n+                    } else if (newState == ConnectionState.RECONNECTED) {\n+                        logger.info(\"worker : {} reconnected to zookeeper\", address);\n+                        zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(workerZKPath, \"\");\n+                    } else if (newState == ConnectionState.SUSPENDED) {\n+                        logger.warn(\"worker : {} connection SUSPENDED \", address);\n+                    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgwNjE1Mw=="}, "originalCommit": {"oid": "c8e389133811a95a095c7000dbb6971941d448ce"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUwMzcyMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            public void stateChanged(CuratorFramework client, ConnectionState newState) {\n          \n          \n            \n                                if (newState == ConnectionState.LOST) {\n          \n          \n            \n                                    logger.error(\"worker : {} connection lost from zookeeper\", address);\n          \n          \n            \n                                } else if (newState == ConnectionState.RECONNECTED) {\n          \n          \n            \n                                    logger.info(\"worker : {} reconnected to zookeeper\", address);\n          \n          \n            \n                                    zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(workerZKPath, \"\");\n          \n          \n            \n                                } else if (newState == ConnectionState.SUSPENDED) {\n          \n          \n            \n                                    logger.warn(\"worker : {} connection SUSPENDED \", address);\n          \n          \n            \n                                }\n          \n          \n            \n                            public void stateChanged(CuratorFramework client, ConnectionState newState) {\n          \n          \n            \n                                if (newState == ConnectionState.LOST) {\n          \n          \n            \n                                    logger.error(\"worker : {} connection lost from zookeeper\", address);\n          \n          \n            \n                                    return;\n          \n          \n            \n                                } \n          \n          \n            \n                                 if (newState == ConnectionState.RECONNECTED) {\n          \n          \n            \n                                    logger.info(\"worker : {} reconnected to zookeeper\", address);\n          \n          \n            \n                                    zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(workerZKPath, \"\");\n          \n          \n            \n                                    return ;\n          \n          \n            \n                                } \n          \n          \n            \n                                 if (newState == ConnectionState.SUSPENDED) {\n          \n          \n            \n                                    logger.warn(\"worker : {} connection SUSPENDED \", address);\n          \n          \n            \n                                    return;\n          \n          \n            \n                                }\n          \n      \n    \n    \n  \n\nThis is my suggestion, what do you think,", "url": "https://github.com/apache/dolphinscheduler/pull/2934#discussion_r447503723", "createdAt": "2020-06-30T08:25:18Z", "author": {"login": "CalvinKirs"}, "path": "dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/worker/registry/WorkerRegistry.java", "diffHunk": "@@ -86,34 +90,39 @@ public void init(){\n      */\n     public void registry() {\n         String address = OSUtils.getHost();\n-        String localNodePath = getWorkerPath();\n-        zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(localNodePath, \"\");\n-        zookeeperRegistryCenter.getZookeeperCachedOperator().getZkClient().getConnectionStateListenable().addListener(new ConnectionStateListener() {\n-            @Override\n-            public void stateChanged(CuratorFramework client, ConnectionState newState) {\n-                if(newState == ConnectionState.LOST){\n-                    logger.error(\"worker : {} connection lost from zookeeper\", address);\n-                } else if(newState == ConnectionState.RECONNECTED){\n-                    logger.info(\"worker : {} reconnected to zookeeper\", address);\n-                    zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(localNodePath, \"\");\n-                } else if(newState == ConnectionState.SUSPENDED){\n-                    logger.warn(\"worker : {} connection SUSPENDED \", address);\n-                }\n-            }\n-        });\n+        Set<String> workerZkPaths = getWorkerZkPaths();\n         int workerHeartbeatInterval = workerConfig.getWorkerHeartbeatInterval();\n-        this.heartBeatExecutor.scheduleAtFixedRate(new HeartBeatTask(), workerHeartbeatInterval, workerHeartbeatInterval, TimeUnit.SECONDS);\n-        logger.info(\"worker node : {} registry to ZK successfully with heartBeatInterval : {}s\", address, workerHeartbeatInterval);\n \n+        for (String workerZKPath : workerZkPaths) {\n+            zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(workerZKPath, \"\");\n+            zookeeperRegistryCenter.getZookeeperCachedOperator().getZkClient().getConnectionStateListenable().addListener(new ConnectionStateListener() {\n+                @Override\n+                public void stateChanged(CuratorFramework client, ConnectionState newState) {\n+                    if (newState == ConnectionState.LOST) {\n+                        logger.error(\"worker : {} connection lost from zookeeper\", address);\n+                    } else if (newState == ConnectionState.RECONNECTED) {\n+                        logger.info(\"worker : {} reconnected to zookeeper\", address);\n+                        zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(workerZKPath, \"\");\n+                    } else if (newState == ConnectionState.SUSPENDED) {\n+                        logger.warn(\"worker : {} connection SUSPENDED \", address);\n+                    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgwNjE1Mw=="}, "originalCommit": {"oid": "c8e389133811a95a095c7000dbb6971941d448ce"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0MzU0Ng==", "bodyText": "This is my suggestion, what do you think,\n\nThx a lot for your review.\nI got your point, and can you describe your opinion about what is the benefits of using\nif (a) { xxx; return;}  if (b) { xxx; return; } but not if (a) { xxx; } else if (b) {xxx;} ?", "url": "https://github.com/apache/dolphinscheduler/pull/2934#discussion_r447543546", "createdAt": "2020-06-30T09:26:33Z", "author": {"login": "yangyichao-mango"}, "path": "dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/worker/registry/WorkerRegistry.java", "diffHunk": "@@ -86,34 +90,39 @@ public void init(){\n      */\n     public void registry() {\n         String address = OSUtils.getHost();\n-        String localNodePath = getWorkerPath();\n-        zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(localNodePath, \"\");\n-        zookeeperRegistryCenter.getZookeeperCachedOperator().getZkClient().getConnectionStateListenable().addListener(new ConnectionStateListener() {\n-            @Override\n-            public void stateChanged(CuratorFramework client, ConnectionState newState) {\n-                if(newState == ConnectionState.LOST){\n-                    logger.error(\"worker : {} connection lost from zookeeper\", address);\n-                } else if(newState == ConnectionState.RECONNECTED){\n-                    logger.info(\"worker : {} reconnected to zookeeper\", address);\n-                    zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(localNodePath, \"\");\n-                } else if(newState == ConnectionState.SUSPENDED){\n-                    logger.warn(\"worker : {} connection SUSPENDED \", address);\n-                }\n-            }\n-        });\n+        Set<String> workerZkPaths = getWorkerZkPaths();\n         int workerHeartbeatInterval = workerConfig.getWorkerHeartbeatInterval();\n-        this.heartBeatExecutor.scheduleAtFixedRate(new HeartBeatTask(), workerHeartbeatInterval, workerHeartbeatInterval, TimeUnit.SECONDS);\n-        logger.info(\"worker node : {} registry to ZK successfully with heartBeatInterval : {}s\", address, workerHeartbeatInterval);\n \n+        for (String workerZKPath : workerZkPaths) {\n+            zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(workerZKPath, \"\");\n+            zookeeperRegistryCenter.getZookeeperCachedOperator().getZkClient().getConnectionStateListenable().addListener(new ConnectionStateListener() {\n+                @Override\n+                public void stateChanged(CuratorFramework client, ConnectionState newState) {\n+                    if (newState == ConnectionState.LOST) {\n+                        logger.error(\"worker : {} connection lost from zookeeper\", address);\n+                    } else if (newState == ConnectionState.RECONNECTED) {\n+                        logger.info(\"worker : {} reconnected to zookeeper\", address);\n+                        zookeeperRegistryCenter.getZookeeperCachedOperator().persistEphemeral(workerZKPath, \"\");\n+                    } else if (newState == ConnectionState.SUSPENDED) {\n+                        logger.warn(\"worker : {} connection SUSPENDED \", address);\n+                    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgwNjE1Mw=="}, "originalCommit": {"oid": "c8e389133811a95a095c7000dbb6971941d448ce"}, "originalPosition": 87}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3508, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}