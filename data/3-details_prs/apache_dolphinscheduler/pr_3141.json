{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0NDIzNDQ5", "number": 3141, "title": "[Bug-3140]fix the deadlock between start and stop of ZKServer", "bodyText": "fix #3140\nTips\n\nThanks very much for contributing to Apache DolphinScheduler.\nPlease review https://dolphinscheduler.apache.org/en-us/community/index.html before opening a pull request.\n\nWhat is the purpose of the pull request\n(For example: This pull request adds checkstyle plugin.)\nBrief change log\n(for example:)\n\nRemove the synchronized of start and stop method.\nLet the ZkServer can start with custom port when execute the \"public static void main\" method.\nRefactor the static method to object method to avoid the JMException when execute unit test.\n\nVerify this pull request\n(Please pick either of the following options)\nThis pull request is code cleanup without any test coverage.\n(or)\nThis pull request is already covered by existing tests, such as (please describe tests).\n(or)\nThis change added tests and can be verified as follows:\n(example:)\n\nAdded dolphinscheduler-dao tests for end-to-end.\nAdded CronUtilsTest to verify the change.\nManually verified the change by testing locally.", "createdAt": "2020-07-05T15:36:59Z", "url": "https://github.com/apache/dolphinscheduler/pull/3141", "merged": true, "mergeCommit": {"oid": "753ed58fb9f15f85240918fe6457cf9015ee5101"}, "closed": true, "closedAt": "2020-07-13T10:52:34Z", "author": {"login": "tswstarplanet"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcx-XVDAH2gAyNDQ0NDIzNDQ5OjYzNTEzNzNjZWZmMTU2NGRmNmZhZDkzZmViODAwYjUxNzkzNDVlNDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0fN7igFqTQ0NzE0MzI1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6351373ceff1564df6fad93feb800b5179345e47", "author": {"user": {"login": "tswstarplanet", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/6351373ceff1564df6fad93feb800b5179345e47", "committedDate": "2020-07-05T15:27:58Z", "message": "[Bug-3140]fix the deadlock between start and stop of ZKServer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df0b2682cc73dd91679f122440dedcc1b8b1eec1", "author": {"user": {"login": "tswstarplanet", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/df0b2682cc73dd91679f122440dedcc1b8b1eec1", "committedDate": "2020-07-06T13:51:36Z", "message": "Merge branch 'dev' into ZkServer_deadlock"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMTAwNTU1", "url": "https://github.com/apache/dolphinscheduler/pull/3141#pullrequestreview-443100555", "createdAt": "2020-07-06T13:58:29Z", "commit": {"oid": "6351373ceff1564df6fad93feb800b5179345e47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxMzo1ODoyOVrOGtYb9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxMzo1ODoyOVrOGtYb9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIzOTQ3OA==", "bodyText": "please use logger.error, not use e.printStackTrace", "url": "https://github.com/apache/dolphinscheduler/pull/3141#discussion_r450239478", "createdAt": "2020-07-06T13:58:29Z", "author": {"login": "dailidong"}, "path": "dolphinscheduler-service/src/test/java/org/apache/dolphinscheduler/service/zk/ZKServerTest.java", "diffHunk": "@@ -19,17 +19,40 @@\n import org.junit.Assert;\n import org.junit.Test;\n \n-// ZKServer is a process, can't unit test\n-public class ZKServerTest {\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n \n+public class ZKServerTest {\n \n     @Test\n-    public void isStarted() {\n-        Assert.assertEquals(false, ZKServer.isStarted());\n+    public void testRunWithDefaultPort() {\n+        AtomicReference<ZKServer> zkServer = new AtomicReference<>();\n+        new Thread(() -> {\n+            zkServer.set(new ZKServer());\n+            zkServer.get().start();\n+        }).start();\n+        try {\n+            TimeUnit.SECONDS.sleep(5);\n+            Assert.assertEquals(true, zkServer.get().isStarted());\n+        } catch (InterruptedException e) {\n+            e.printStackTrace();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6351373ceff1564df6fad93feb800b5179345e47"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMTAxMTU5", "url": "https://github.com/apache/dolphinscheduler/pull/3141#pullrequestreview-443101159", "createdAt": "2020-07-06T13:59:06Z", "commit": {"oid": "6351373ceff1564df6fad93feb800b5179345e47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxMzo1OTowNlrOGtYdxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxMzo1OTowNlrOGtYdxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIzOTk0Mg==", "bodyText": "the same with the last one", "url": "https://github.com/apache/dolphinscheduler/pull/3141#discussion_r450239942", "createdAt": "2020-07-06T13:59:06Z", "author": {"login": "dailidong"}, "path": "dolphinscheduler-service/src/test/java/org/apache/dolphinscheduler/service/zk/ZKServerTest.java", "diffHunk": "@@ -19,17 +19,40 @@\n import org.junit.Assert;\n import org.junit.Test;\n \n-// ZKServer is a process, can't unit test\n-public class ZKServerTest {\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n \n+public class ZKServerTest {\n \n     @Test\n-    public void isStarted() {\n-        Assert.assertEquals(false, ZKServer.isStarted());\n+    public void testRunWithDefaultPort() {\n+        AtomicReference<ZKServer> zkServer = new AtomicReference<>();\n+        new Thread(() -> {\n+            zkServer.set(new ZKServer());\n+            zkServer.get().start();\n+        }).start();\n+        try {\n+            TimeUnit.SECONDS.sleep(5);\n+            Assert.assertEquals(true, zkServer.get().isStarted());\n+        } catch (InterruptedException e) {\n+            e.printStackTrace();\n+        }\n+        zkServer.get().stop();\n     }\n \n     @Test\n-    public void stop() {\n-        ZKServer.stop();\n+    public void testRunWithCustomPort() {\n+        AtomicReference<ZKServer> zkServer = new AtomicReference<>();\n+        new Thread(() -> {\n+            zkServer.set(new ZKServer(2182));\n+            zkServer.get().start();\n+        }).start();\n+        try {\n+            TimeUnit.SECONDS.sleep(5);\n+            Assert.assertEquals(true, zkServer.get().isStarted());\n+        } catch (InterruptedException e) {\n+            e.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6351373ceff1564df6fad93feb800b5179345e47"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90c1733de59b73cb7988f33c012758277b4b1cb6", "author": {"user": {"login": "tswstarplanet", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/90c1733de59b73cb7988f33c012758277b4b1cb6", "committedDate": "2020-07-06T16:45:32Z", "message": "use Log framework to print information"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f77ab3d05a4d31b59ff4aaded37eb6da5c2f4d5", "author": {"user": {"login": "tswstarplanet", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/8f77ab3d05a4d31b59ff4aaded37eb6da5c2f4d5", "committedDate": "2020-07-07T11:28:10Z", "message": "Merge branch 'dev' into ZkServer_deadlock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a54df4f8690b530f5d8b2cf48018d2acf219660b", "author": {"user": {"login": "tswstarplanet", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/a54df4f8690b530f5d8b2cf48018d2acf219660b", "committedDate": "2020-07-07T14:22:08Z", "message": "fix code smells; add path prefix of embedded zk server"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18c6cc0c5c70bbebb90344399c81a0062da40b35", "author": {"user": {"login": "tswstarplanet", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/18c6cc0c5c70bbebb90344399c81a0062da40b35", "committedDate": "2020-07-10T04:21:00Z", "message": "Merge branch 'dev' into ZkServer_deadlock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c99ccbe06069e67aadcb7e4b7bd91b5c1318992b", "author": {"user": {"login": "tswstarplanet", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/c99ccbe06069e67aadcb7e4b7bd91b5c1318992b", "committedDate": "2020-07-10T17:39:15Z", "message": "Merge branch 'dev' into ZkServer_deadlock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9872db09e36b8efbd0441df56175139ea13745f1", "author": {"user": {"login": "tswstarplanet", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/9872db09e36b8efbd0441df56175139ea13745f1", "committedDate": "2020-07-11T09:05:12Z", "message": "Merge branch 'dev' into ZkServer_deadlock"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2ODAyNzQ1", "url": "https://github.com/apache/dolphinscheduler/pull/3141#pullrequestreview-446802745", "createdAt": "2020-07-11T13:30:46Z", "commit": {"oid": "9872db09e36b8efbd0441df56175139ea13745f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQxMzozMDo0NlrOGwM2LA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQxMzozMDo0NlrOGwM2LA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE5NTMwOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        logger.error(\"Failed to start ZK: \" + e);\n          \n          \n            \n                        logger.error(\"Failed to start ZK \", e);", "url": "https://github.com/apache/dolphinscheduler/pull/3141#discussion_r453195308", "createdAt": "2020-07-11T13:30:46Z", "author": {"login": "yangyichao-mango"}, "path": "dolphinscheduler-service/src/main/java/org/apache/dolphinscheduler/service/zk/ZKServer.java", "diffHunk": "@@ -34,44 +34,62 @@\n public class ZKServer {\n     private static final Logger logger = LoggerFactory.getLogger(ZKServer.class);\n \n-    private static volatile PublicZooKeeperServerMain zkServer = null;\n-\n     public static final int DEFAULT_ZK_TEST_PORT = 2181;\n \n-    private static String dataDir = null;\n+    private final AtomicBoolean isStarted = new AtomicBoolean(false);\n+\n+    private PublicZooKeeperServerMain zooKeeperServerMain = null;\n+\n+    private int port;\n+\n+    private String dataDir = null;\n \n-    private static final AtomicBoolean isStarted = new AtomicBoolean(false);\n+    private String prefix;\n \n     public static void main(String[] args) {\n-        if(!isStarted()){\n-            ZKServer.start();\n-\n-            /**\n-             *  register hooks, which are called before the process exits\n-             */\n-            Runtime.getRuntime().addShutdownHook(new Thread(new Runnable() {\n-                @Override\n-                public void run() {\n-                    stop();\n-                }\n-            }));\n-        }else{\n-            logger.info(\"zk server aleady started\");\n+        ZKServer zkServer;\n+        if (args.length == 0) {\n+            zkServer = new ZKServer();\n+        } else if (args.length == 1){\n+            zkServer = new ZKServer(Integer.valueOf(args[0]), \"\");\n+        } else {\n+            zkServer = new ZKServer(Integer.valueOf(args[0]), args[1]);\n         }\n+        zkServer.registerHook();\n+        zkServer.start();\n+    }\n+\n+    public ZKServer() {\n+        this(DEFAULT_ZK_TEST_PORT, \"\");\n+    }\n+\n+    public ZKServer(int port, String prefix) {\n+        this.port = port;\n+        if (prefix.contains(\"/\")) {\n+            throw new IllegalArgumentException(\"The prefix of path may not have '/'\");\n+        }\n+        this.prefix = prefix;\n+    }\n+\n+    private void registerHook() {\n+        /**\n+         *  register hooks, which are called before the process exits\n+         */\n+        Runtime.getRuntime().addShutdownHook(new Thread(this::stop));\n     }\n \n     /**\n      * start service\n      */\n-    public static void start() {\n+    public void start() {\n         try {\n-            startLocalZkServer(DEFAULT_ZK_TEST_PORT);\n+            startLocalZkServer(port);\n         } catch (Exception e) {\n             logger.error(\"Failed to start ZK: \" + e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9872db09e36b8efbd0441df56175139ea13745f1"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2ODAyODc4", "url": "https://github.com/apache/dolphinscheduler/pull/3141#pullrequestreview-446802878", "createdAt": "2020-07-11T13:33:03Z", "commit": {"oid": "9872db09e36b8efbd0441df56175139ea13745f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQxMzozMzowM1rOGwM22g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQxMzozMzowM1rOGwM22g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE5NTQ4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    String zkDataDir = System.getProperty(\"user.dir\") + (\"\".equals(prefix) ? prefix : (\"/\" + prefix)) + \"/zookeeper_data\";\n          \n          \n            \n                    String zkDataDir = System.getProperty(\"user.dir\") + (StringUtils.isBlank(prefix) ? StringUtils.EMPTY : (\"/\" + prefix)) + \"/zookeeper_data\";\n          \n      \n    \n    \n  \n\nHi,\nGood job.\nIs it better to use this utils of org.apache.dolphinscheduler.common.utils.StringUtils?", "url": "https://github.com/apache/dolphinscheduler/pull/3141#discussion_r453195482", "createdAt": "2020-07-11T13:33:03Z", "author": {"login": "yangyichao-mango"}, "path": "dolphinscheduler-service/src/main/java/org/apache/dolphinscheduler/service/zk/ZKServer.java", "diffHunk": "@@ -94,8 +112,9 @@ public void shutdown() {\n      *\n      * @param port The port to listen on\n      */\n-    public static void startLocalZkServer(final int port) {\n-        String zkDataDir = System.getProperty(\"user.dir\") +\"/zookeeper_data\";\n+    public void startLocalZkServer(final int port) {\n+        String zkDataDir = System.getProperty(\"user.dir\") + (\"\".equals(prefix) ? prefix : (\"/\" + prefix)) + \"/zookeeper_data\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9872db09e36b8efbd0441df56175139ea13745f1"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2ODAzMTYw", "url": "https://github.com/apache/dolphinscheduler/pull/3141#pullrequestreview-446803160", "createdAt": "2020-07-11T13:37:07Z", "commit": {"oid": "9872db09e36b8efbd0441df56175139ea13745f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQxMzozNzowN1rOGwM4ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQxMzozNzowN1rOGwM4ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE5NTg3Nw==", "bodyText": "Hi,\nWhy introduce logger.warn(\"The path of zk server exists\");?", "url": "https://github.com/apache/dolphinscheduler/pull/3141#discussion_r453195877", "createdAt": "2020-07-11T13:37:07Z", "author": {"login": "yangyichao-mango"}, "path": "dolphinscheduler-service/src/main/java/org/apache/dolphinscheduler/service/zk/ZKServer.java", "diffHunk": "@@ -94,8 +112,9 @@ public void shutdown() {\n      *\n      * @param port The port to listen on\n      */\n-    public static void startLocalZkServer(final int port) {\n-        String zkDataDir = System.getProperty(\"user.dir\") +\"/zookeeper_data\";\n+    public void startLocalZkServer(final int port) {\n+        String zkDataDir = System.getProperty(\"user.dir\") + (\"\".equals(prefix) ? prefix : (\"/\" + prefix)) + \"/zookeeper_data\";\n+        logger.warn(\"The path of zk server exists\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9872db09e36b8efbd0441df56175139ea13745f1"}, "originalPosition": 92}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2ODA0MTg2", "url": "https://github.com/apache/dolphinscheduler/pull/3141#pullrequestreview-446804186", "createdAt": "2020-07-11T13:53:50Z", "commit": {"oid": "9872db09e36b8efbd0441df56175139ea13745f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQxMzo1Mzo1MVrOGwM9_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQxMzo1Mzo1MVrOGwM9_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE5NzMwOQ==", "bodyText": "Hi,\nIs it better to add isStarted.get() compare in if statement because of the public of startLocalZkServer function?\nThe same of stop function.\nThx a lot for your contribution.", "url": "https://github.com/apache/dolphinscheduler/pull/3141#discussion_r453197309", "createdAt": "2020-07-11T13:53:51Z", "author": {"login": "yangyichao-mango"}, "path": "dolphinscheduler-service/src/main/java/org/apache/dolphinscheduler/service/zk/ZKServer.java", "diffHunk": "@@ -108,11 +127,11 @@ public static void startLocalZkServer(final int port) {\n      * @param tickTime    zk tick time\n      * @param maxClientCnxns    zk max client connections\n      */\n-    private static synchronized void startLocalZkServer(final int port, final String dataDirPath,final int tickTime,String maxClientCnxns) {\n-        if (zkServer != null) {\n+    private void startLocalZkServer(final int port, final String dataDirPath,final int tickTime,String maxClientCnxns) {\n+        if (zooKeeperServerMain != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9872db09e36b8efbd0441df56175139ea13745f1"}, "originalPosition": 103}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2ODA0NjAy", "url": "https://github.com/apache/dolphinscheduler/pull/3141#pullrequestreview-446804602", "createdAt": "2020-07-11T14:01:14Z", "commit": {"oid": "9872db09e36b8efbd0441df56175139ea13745f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQxNDowMToxNFrOGwNAZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQxNDowMToxNFrOGwNAZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE5NzkyNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        zooKeeperServerMain.initializeAndRun(args);\n          \n          \n            \n                    } catch (QuorumPeerConfig.ConfigException e) {\n          \n          \n            \n                        logger.warn(\"Caught exception while starting ZK\", e);\n          \n          \n            \n                    } catch (IOException e) {\n          \n          \n            \n                        zooKeeperServerMain.initializeAndRun(args);\n          \n          \n            \n                    } catch (QuorumPeerConfig.ConfigException | IOException e) {\n          \n          \n            \n                        logger.warn(\"Caught exception while starting ZK\", e);\n          \n          \n            \n                    }\n          \n      \n    \n    \n  \n\nHi,\nIs it better to merge tow exceptions into one catch block if the two exceptions are handled in the same way?\nIf it is convenient for you, I think you can modify this part.\nThx a lot for your contribution.", "url": "https://github.com/apache/dolphinscheduler/pull/3141#discussion_r453197926", "createdAt": "2020-07-11T14:01:14Z", "author": {"login": "yangyichao-mango"}, "path": "dolphinscheduler-service/src/main/java/org/apache/dolphinscheduler/service/zk/ZKServer.java", "diffHunk": "@@ -121,7 +140,7 @@ private static synchronized void startLocalZkServer(final int port, final String\n             logger.info(\"Zookeeper server started \");\n             isStarted.compareAndSet(false, true);\n \n-            zkServer.initializeAndRun(args);\n+            zooKeeperServerMain.initializeAndRun(args);\n         } catch (QuorumPeerConfig.ConfigException e) {\n             logger.warn(\"Caught exception while starting ZK\", e);\n         } catch (IOException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9872db09e36b8efbd0441df56175139ea13745f1"}, "originalPosition": 119}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c2bf68ae801a4461a7c0e0a4b0ff2ff6a902409", "author": {"user": {"login": "tswstarplanet", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/4c2bf68ae801a4461a7c0e0a4b0ff2ff6a902409", "committedDate": "2020-07-11T16:01:39Z", "message": "Update dolphinscheduler-service/src/main/java/org/apache/dolphinscheduler/service/zk/ZKServer.java\n\nCo-authored-by: Yichao Yang <1048262223@qq.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e121a697d051e6a1c34d26de3b9e3a6d0b18441b", "author": {"user": {"login": "tswstarplanet", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/e121a697d051e6a1c34d26de3b9e3a6d0b18441b", "committedDate": "2020-07-11T16:38:11Z", "message": "optimize the code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2ODUxNTIy", "url": "https://github.com/apache/dolphinscheduler/pull/3141#pullrequestreview-446851522", "createdAt": "2020-07-12T06:55:02Z", "commit": {"oid": "e121a697d051e6a1c34d26de3b9e3a6d0b18441b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNjo1NTowM1rOGwR1PA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNjo1NTowM1rOGwR1PA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI3Njk4OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void startLocalZkServer(final int port, final String dataDirPath,final int tickTime,String maxClientCnxns) {\n          \n          \n            \n                private void startLocalZkServer(final int port, final String dataDirPath, final int tickTime, String maxClientCnxns) {\n          \n      \n    \n    \n  \n\nHi,\nThx a lot for your good job and contribution.\nPlease configure the checkstyle.xml plugin[1] to your IDE to help format code.\n[1] https://github.com/apache/incubator-dolphinscheduler/tree/dev/style", "url": "https://github.com/apache/dolphinscheduler/pull/3141#discussion_r453276988", "createdAt": "2020-07-12T06:55:03Z", "author": {"login": "yangyichao-mango"}, "path": "dolphinscheduler-service/src/main/java/org/apache/dolphinscheduler/service/zk/ZKServer.java", "diffHunk": "@@ -108,31 +131,29 @@ public static void startLocalZkServer(final int port) {\n      * @param tickTime    zk tick time\n      * @param maxClientCnxns    zk max client connections\n      */\n-    private static synchronized void startLocalZkServer(final int port, final String dataDirPath,final int tickTime,String maxClientCnxns) {\n-        if (zkServer != null) {\n-            throw new RuntimeException(\"Zookeeper server is already started!\");\n-        }\n-        zkServer = new PublicZooKeeperServerMain();\n-        logger.info(\"Zookeeper data path : {} \", dataDirPath);\n-        dataDir = dataDirPath;\n-        final String[] args = new String[]{Integer.toString(port), dataDirPath, Integer.toString(tickTime), maxClientCnxns};\n+    private void startLocalZkServer(final int port, final String dataDirPath,final int tickTime,String maxClientCnxns) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e121a697d051e6a1c34d26de3b9e3a6d0b18441b"}, "originalPosition": 120}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MTQzMjU4", "url": "https://github.com/apache/dolphinscheduler/pull/3141#pullrequestreview-447143258", "createdAt": "2020-07-13T10:52:25Z", "commit": {"oid": "e121a697d051e6a1c34d26de3b9e3a6d0b18441b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1859, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}