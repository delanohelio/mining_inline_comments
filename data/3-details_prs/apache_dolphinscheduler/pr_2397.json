{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNzcwNjUz", "number": 2397, "title": "api server exception management and code optimization (#397)", "bodyText": "Tips\n\nThanks very much for contributing to Apache DolphinScheduler.\nPlease review https://dolphinscheduler.apache.org/en-us/community/index.html before opening a pull request.\n\nWhat is the purpose of the pull request\nCurrently, there are many try-catch code in api-server's controller. This pr clean the code, use an annotation to point out which Status should be return if there is an exception.\nI just update AccessTokenController firstly, to avoid conflict. If this PR is accepted, maybe I could update for other controllers :)\ni.e.\nBefore\npublic Result generateToken(@RequestAttribute(value = Constants.SESSION_USER) User loginUser,\n                              @RequestParam(value = \"userId\") int userId,\n                              @RequestParam(value = \"expireTime\") String expireTime){\n    logger.info(\"login user {}, generate token , userId : {} , token expire time : {}\",loginUser,userId,expireTime);\n    try {\n        Map<String, Object> result = accessTokenService.generateToken(userId, expireTime);\n        return returnDataList(result);\n    }catch (Exception e){\n        logger.error(GENERATE_TOKEN_ERROR.getMsg(),e);\n        return error(GENERATE_TOKEN_ERROR.getCode(), GENERATE_TOKEN_ERROR.getMsg());\n    }\n}\nAfter\n@ControllerException(GENERATE_TOKEN_ERROR)\npublic Result generateToken(@RequestAttribute(value = Constants.SESSION_USER) User loginUser,\n                            @RequestParam(value = \"userId\") int userId,\n                            @RequestParam(value = \"expireTime\") String expireTime) {\n    logger.info(\"login user {}, generate token , userId : {} , token expire time : {}\", loginUser, userId, expireTime);\n\n    Map<String, Object> result = accessTokenService.generateToken(userId, expireTime);\n    return returnDataList(result);\n}\nBrief change log\n\nAdd ControllerException annotation in org.apache.dolphinscheduler.api.exceptions.\nAdd ApiExceptionHandler controller advice to deal with exceptions.\nReplace AccessTokenController functions which has try-catch style with @ControllerException annotation.\n\nVerify this pull request\nI've debugged the code locally, and it works well. But it's difficult to write tests for this code, because I should find how to throw an exception. It will be easy if I can write some test controllers to test this PR. Pls tell me if I can do that, or is there any other way for testing.\nThanks in advance!\nHope it has no conflict.", "createdAt": "2020-04-10T06:00:33Z", "url": "https://github.com/apache/dolphinscheduler/pull/2397", "merged": true, "mergeCommit": {"oid": "3c9ba0a3f300da91fc1c4e71a927ea0c2f21515a"}, "closed": true, "closedAt": "2020-04-12T01:39:58Z", "author": {"login": "hgaol"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWiqmRgH2gAyNDAxNzcwNjUzOjU5Njc2MzU4MTc2ZDlmNDQ3MWY2ZDA4YjkwZjhhMDJhOGNmYjM0NjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWwK9nAFqTM5MTgxMzU4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "59676358176d9f4471f6d08b90f8a02a8cfb3461", "author": {"user": {"login": "hgaol", "name": "Han Gao"}}, "url": "https://github.com/apache/dolphinscheduler/commit/59676358176d9f4471f6d08b90f8a02a8cfb3461", "committedDate": "2020-04-11T09:55:43Z", "message": "api server exception management and code optimization (#397)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cc9d3fe521a8d72e3b251809ff97bf0a20a817f", "author": {"user": {"login": "hgaol", "name": "Han Gao"}}, "url": "https://github.com/apache/dolphinscheduler/commit/4cc9d3fe521a8d72e3b251809ff97bf0a20a817f", "committedDate": "2020-04-11T11:07:04Z", "message": "add unit test for exception handler."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1f37893f5b7aef3127b30cd86766c6ff24a3eb9", "author": {"user": {"login": "dailidong", "name": "lidongdai"}}, "url": "https://github.com/apache/dolphinscheduler/commit/b1f37893f5b7aef3127b30cd86766c6ff24a3eb9", "committedDate": "2020-04-11T12:22:30Z", "message": "Merge branch 'dev' into dev"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8176169ea6396ebe2235fd79bbb4ebee7a570814", "author": {"user": {"login": "hgaol", "name": "Han Gao"}}, "url": "https://github.com/apache/dolphinscheduler/commit/8176169ea6396ebe2235fd79bbb4ebee7a570814", "committedDate": "2020-04-11T13:35:50Z", "message": "fix some style and naming issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzY1NDE1", "url": "https://github.com/apache/dolphinscheduler/pull/2397#pullrequestreview-391765415", "createdAt": "2020-04-11T13:15:47Z", "commit": {"oid": "b1f37893f5b7aef3127b30cd86766c6ff24a3eb9"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMzoxNTo0N1rOGENI_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMzoxNzozNFrOGENJqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA2Mjc4Mg==", "bodyText": "Using IllegalArgumentException", "url": "https://github.com/apache/dolphinscheduler/pull/2397#discussion_r407062782", "createdAt": "2020-04-11T13:15:47Z", "author": {"login": "Technoboy-"}, "path": "dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/service/AccessTokenService.java", "diffHunk": "@@ -83,6 +84,9 @@\n     public Map<String, Object> createToken(int userId, String expireTime, String token) {\n         Map<String, Object> result = new HashMap<>(5);\n \n+        if (userId <= 0) {\n+            throw new ApiServerException(\"User id should not less than or equals to 0.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1f37893f5b7aef3127b30cd86766c6ff24a3eb9"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA2MjgxMQ==", "bodyText": "delete this class", "url": "https://github.com/apache/dolphinscheduler/pull/2397#discussion_r407062811", "createdAt": "2020-04-11T13:16:10Z", "author": {"login": "Technoboy-"}, "path": "dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/exceptions/ApiServerException.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.dolphinscheduler.api.exceptions;\n+\n+/**\n+ * ApiException\n+ */\n+public class ApiServerException extends RuntimeException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1f37893f5b7aef3127b30cd86766c6ff24a3eb9"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA2Mjk1NA==", "bodyText": "How about ApiException.  for you call handler ApiExceptionHandler", "url": "https://github.com/apache/dolphinscheduler/pull/2397#discussion_r407062954", "createdAt": "2020-04-11T13:17:34Z", "author": {"login": "Technoboy-"}, "path": "dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/exceptions/ControllerException.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.dolphinscheduler.api.exceptions;\n+\n+import org.apache.dolphinscheduler.api.enums.Status;\n+\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.Target;\n+\n+import static java.lang.annotation.ElementType.METHOD;\n+import static java.lang.annotation.RetentionPolicy.RUNTIME;\n+\n+/**\n+ * controller exception annotation\n+ */\n+@Retention(RUNTIME)\n+@Target(METHOD)\n+public @interface ControllerException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1f37893f5b7aef3127b30cd86766c6ff24a3eb9"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxODEzNTg3", "url": "https://github.com/apache/dolphinscheduler/pull/2397#pullrequestreview-391813587", "createdAt": "2020-04-12T01:39:50Z", "commit": {"oid": "8176169ea6396ebe2235fd79bbb4ebee7a570814"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2025, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}