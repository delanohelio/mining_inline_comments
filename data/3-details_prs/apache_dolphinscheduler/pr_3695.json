{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxODA3Njkx", "number": 3695, "title": "[Improvement-3690][common] Get the native IP policy problem (\u83b7\u53d6\u672c\u673aip\u7b56\u7565\u95ee\u9898 )", "bodyText": "Tips\n\nThanks very much for contributing to Apache DolphinScheduler.\nPlease review https://dolphinscheduler.apache.org/en-us/community/index.html before opening a pull request.\n\nWhat is the purpose of the pull request\nImprovement #3690\nThe current policy is to take the first one, but the first test is not fixed\u3002This is my debug screenshot.\n\n\u5f53\u524d\u7b56\u7565\u662f\u53d6\u7b2c\u4e00\u4e2a\uff0c\u4f46\u662f\u7b2c\u4e00\u4e2a\u6d4b\u8bd5\u4e0b\u6765\u4e5f\u662f\u4e0d\u56fa\u5b9a\u7684\uff0c\u8fd9\u4e2a\u662f\u6211\u8c03\u8bd5\u622a\u56fe\u3002\n\n\nThe problem is that on the server, the acquired IP is the external network card IP.External network control is more strict, so it is not a full port through. Therefore, it is recommended to get IP of Intranet card first.So make logical optimizations in your code.\n\n\u9047\u5230\u7684\u95ee\u9898\u662f\u670d\u52a1\u5668\u4e0a\uff0c\u83b7\u53d6\u7684ip\u4e3a\u5916\u7f51\u7f51\u5361ip.\u5916\u7f51\u63a7\u5236\u6bd4\u8f83\u4e25\u683c\uff0c\u6240\u4ee5\u4e0d\u662f\u5168\u7aef\u53e3\u6253\u901a\u3002\u6240\u4ee5\uff0c\u5efa\u8bae\u4f18\u5148\u83b7\u53d6\u5185\u7f51\u7f51\u5361ip\u3002\n\u6240\u4ee5\u505a\u51fa\u4ee3\u7801\u4e2d\u7684\u903b\u8f91\u4f18\u5316\u3002", "createdAt": "2020-09-08T06:30:11Z", "url": "https://github.com/apache/dolphinscheduler/pull/3695", "merged": true, "mergeCommit": {"oid": "565b8d3b66cbc035d263ef5695a6c01e8d2eac9b"}, "closed": true, "closedAt": "2020-09-14T02:39:38Z", "author": {"login": "felix-thinkingdata"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGxijMAH2gAyNDgxODA3NjkxOjIyYjg4ZGJiMWFjYWFhYzAzYmUyZTVjYjhjZTJiOGI5MDBlNjY4YjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdIp7K5AFqTQ4NzM4MjAwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "22b88dbb1acaaac03be2e5cb8ce2b8b900e668b1", "author": {"user": {"login": "felix-thinkingdata", "name": "felix.wang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/22b88dbb1acaaac03be2e5cb8ce2b8b900e668b1", "committedDate": "2020-09-08T06:23:52Z", "message": "Get the Intranet IP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06fb5ffc34a617377fa3b1bfba7dfe5137e51a67", "author": {"user": {"login": "felix-thinkingdata", "name": "felix.wang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/06fb5ffc34a617377fa3b1bfba7dfe5137e51a67", "committedDate": "2020-09-08T07:10:31Z", "message": "Get the Intranet IP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dfc03e21d46c47ed51e3294aa2c5dc21035c603", "author": {"user": {"login": "felix-thinkingdata", "name": "felix.wang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/9dfc03e21d46c47ed51e3294aa2c5dc21035c603", "committedDate": "2020-09-08T07:28:20Z", "message": "fix code smell"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NTk0NTcw", "url": "https://github.com/apache/dolphinscheduler/pull/3695#pullrequestreview-484594570", "createdAt": "2020-09-09T01:22:41Z", "commit": {"oid": "9dfc03e21d46c47ed51e3294aa2c5dc21035c603"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2787d974a262f44fbf8d61af87db22e7d56aef4a", "author": {"user": {"login": "felix-thinkingdata", "name": "felix.wang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/2787d974a262f44fbf8d61af87db22e7d56aef4a", "committedDate": "2020-09-09T08:58:43Z", "message": "fix code smell"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f38ff7eb808c4599cb2a828a357a658130facbff", "author": {"user": {"login": "felix-thinkingdata", "name": "felix.wang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/f38ff7eb808c4599cb2a828a357a658130facbff", "committedDate": "2020-09-09T09:14:44Z", "message": "fix code smell"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b077199a8909f4498ca808c52960ae56bd6b0f8", "author": {"user": {"login": "felix-thinkingdata", "name": "felix.wang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/9b077199a8909f4498ca808c52960ae56bd6b0f8", "committedDate": "2020-09-09T14:11:24Z", "message": "Merge branch 'github-local/dev' into Improvement/getInnetIp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3aa6893ca987ec0eb6257687dc79e49723cad5ef", "author": {"user": {"login": "felix-thinkingdata", "name": "felix.wang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/3aa6893ca987ec0eb6257687dc79e49723cad5ef", "committedDate": "2020-09-09T14:43:03Z", "message": "fix code smell"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1ODgyMTcz", "url": "https://github.com/apache/dolphinscheduler/pull/3695#pullrequestreview-485882173", "createdAt": "2020-09-10T12:35:54Z", "commit": {"oid": "3aa6893ca987ec0eb6257687dc79e49723cad5ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMjozNTo1NVrOHPxaCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMjozNTo1NVrOHPxaCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMwMDE3MA==", "bodyText": "Hi, there may be a little problem here, we need to consider the IPV6 situation,", "url": "https://github.com/apache/dolphinscheduler/pull/3695#discussion_r486300170", "createdAt": "2020-09-10T12:35:55Z", "author": {"login": "CalvinKirs"}, "path": "dolphinscheduler-common/src/main/java/org/apache/dolphinscheduler/common/utils/NetUtils.java", "diffHunk": "@@ -227,4 +230,72 @@ private static boolean isSpecifyNetworkInterface(NetworkInterface networkInterfa\n         String preferredNetworkInterface = System.getProperty(DOLPHIN_SCHEDULER_PREFERRED_NETWORK_INTERFACE);\n         return Objects.equals(networkInterface.getDisplayName(), preferredNetworkInterface);\n     }\n+\n+    private static NetworkInterface findAddress(List<NetworkInterface> validNetworkInterfaces) {\n+        if (validNetworkInterfaces.isEmpty()) {\n+            return null;\n+        }\n+        String networkPriority = PropertyUtils.getString(Constants.NETWORK_PRIORITY_STRATEGY, NETWORK_PRIORITY_DEFAULT);\n+        if (NETWORK_PRIORITY_DEFAULT.equalsIgnoreCase(networkPriority)) {\n+            return findAddressByDefaultPolicy(validNetworkInterfaces);\n+        } else if (NETWORK_PRIORITY_INNER.equalsIgnoreCase(networkPriority)) {\n+            return findInnerAddress(validNetworkInterfaces);\n+        } else if (NETWORK_PRIORITY_OUTER.equalsIgnoreCase(networkPriority)) {\n+            return findOuterAddress(validNetworkInterfaces);\n+        } else {\n+            logger.error(\"There is no matching network card acquisition policy!\");\n+            return null;\n+        }\n+    }\n+\n+    private static NetworkInterface findAddressByDefaultPolicy(List<NetworkInterface> validNetworkInterfaces) {\n+        NetworkInterface networkInterface;\n+        networkInterface = findInnerAddress(validNetworkInterfaces);\n+        if (networkInterface == null) {\n+            networkInterface = findOuterAddress(validNetworkInterfaces);\n+            if (networkInterface == null) {\n+                networkInterface = validNetworkInterfaces.get(0);\n+            }\n+        }\n+        return networkInterface;\n+    }\n+\n+    /**\n+     * Get the Intranet IP\n+     *\n+     * @return If no {@link NetworkInterface} is available , return <code>null</code>\n+     */\n+    private static NetworkInterface findInnerAddress(List<NetworkInterface> validNetworkInterfaces) {\n+\n+        NetworkInterface networkInterface = null;\n+        for (NetworkInterface ni : validNetworkInterfaces) {\n+            Enumeration<InetAddress> address = ni.getInetAddresses();\n+            while (address.hasMoreElements()) {\n+                InetAddress ip = address.nextElement();\n+                if (ip.isSiteLocalAddress()\n+                        && !ip.isLoopbackAddress()\n+                        && !ip.getHostAddress().contains(\":\")) {\n+                    networkInterface = ni;\n+                }\n+            }\n+        }\n+        return networkInterface;\n+    }\n+\n+    private static NetworkInterface findOuterAddress(List<NetworkInterface> validNetworkInterfaces) {\n+        NetworkInterface networkInterface = null;\n+        for (NetworkInterface ni : validNetworkInterfaces) {\n+            Enumeration<InetAddress> address = ni.getInetAddresses();\n+            while (address.hasMoreElements()) {\n+                InetAddress ip = address.nextElement();\n+                if (!ip.isSiteLocalAddress()\n+                        && !ip.isLoopbackAddress()\n+                        && !ip.getHostAddress().contains(\":\")) {\n+                    networkInterface = ni;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3aa6893ca987ec0eb6257687dc79e49723cad5ef"}, "originalPosition": 157}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9dce19ab1ff1d399314f54b16229e2099c5b47e", "author": {"user": {"login": "felix-thinkingdata", "name": "felix.wang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/d9dce19ab1ff1d399314f54b16229e2099c5b47e", "committedDate": "2020-09-10T14:25:28Z", "message": "support ipv6  --x:--x:--x:--x:--x:--x:--x:--x"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NTczMzAx", "url": "https://github.com/apache/dolphinscheduler/pull/3695#pullrequestreview-486573301", "createdAt": "2020-09-11T08:21:22Z", "commit": {"oid": "d9dce19ab1ff1d399314f54b16229e2099c5b47e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MTk0NjE5", "url": "https://github.com/apache/dolphinscheduler/pull/3695#pullrequestreview-487194619", "createdAt": "2020-09-12T02:10:39Z", "commit": {"oid": "d9dce19ab1ff1d399314f54b16229e2099c5b47e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwMjoxMDozOVrOHQxwiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwMjoxMDozOVrOHQxwiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM1NDUwNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #Network IP gets priority, default inner outer\n          \n          \n            \n            # Network IP gets priority, default inner outer\n          \n      \n    \n    \n  \n\nFormat the description as the others.", "url": "https://github.com/apache/dolphinscheduler/pull/3695#discussion_r487354505", "createdAt": "2020-09-12T02:10:39Z", "author": {"login": "yangyichao-mango"}, "path": "dolphinscheduler-common/src/main/resources/common.properties", "diffHunk": "@@ -72,3 +72,7 @@ kerberos.expire.time=2\n # datasource encryption salt\n datasource.encryption.enable=false\n datasource.encryption.salt=!@#$%^&*\n+\n+#Network IP gets priority, default inner outer", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9dce19ab1ff1d399314f54b16229e2099c5b47e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6f7f6893e8fb11ae94508efd207a57a3a3c99df", "author": {"user": {"login": "felix-thinkingdata", "name": "felix.wang"}}, "url": "https://github.com/apache/dolphinscheduler/commit/d6f7f6893e8fb11ae94508efd207a57a3a3c99df", "committedDate": "2020-09-12T02:42:04Z", "message": "Update dolphinscheduler-common/src/main/resources/common.properties\n\nCo-authored-by: Yichao Yang <1048262223@qq.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MjE3MzM0", "url": "https://github.com/apache/dolphinscheduler/pull/3695#pullrequestreview-487217334", "createdAt": "2020-09-12T09:16:25Z", "commit": {"oid": "d6f7f6893e8fb11ae94508efd207a57a3a3c99df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MzgyMDA0", "url": "https://github.com/apache/dolphinscheduler/pull/3695#pullrequestreview-487382004", "createdAt": "2020-09-14T02:39:22Z", "commit": {"oid": "d6f7f6893e8fb11ae94508efd207a57a3a3c99df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1697, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}