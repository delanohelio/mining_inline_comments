{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMTI1Njgx", "number": 4232, "title": "[Fix#4222][Master]Add the priority queue to ensure that tasks are submitted according to priority.", "bodyText": "What is the purpose of the pull request\n[Fix#4222][Master]Add the priority queue to ensure that tasks are submitted according to priority.\nBrief change log\nAdd the priority queue to ensure that tasks are submitted according to priority.\n\nAdd PeerTaskInstancePriorityQueue", "createdAt": "2020-12-15T10:00:41Z", "url": "https://github.com/apache/dolphinscheduler/pull/4232", "merged": true, "mergeCommit": {"oid": "e6118b8fe9c9951b9c0271809c3982b292735fb2"}, "closed": true, "closedAt": "2020-12-16T01:19:13Z", "author": {"login": "lgcareer"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmXS4kAH2gAyNTQwMTI1NjgxOmM1YmI3MmM2ZTNiMTc1MGJmY2VmOTBlY2RhMzFkZjIxOTcyOTQyMmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmYks5AH2gAyNTQwMTI1NjgxOmE2NTU4YmZjZDdjYzZmNzk3MDU3NGQ5YTZmOGM2YTRhMTdkY2U2NjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c5bb72c6e3b1750bfcef90ecda31df219729422d", "author": {"user": {"login": "lgcareer", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/c5bb72c6e3b1750bfcef90ecda31df219729422d", "committedDate": "2020-12-15T09:54:48Z", "message": "[Fix-4222][Master]Add the priority queue to ensure that tasks are submitted according to priority."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd7db688b6b1990e3ae40b18b61b0832be9cd8bb", "author": {"user": {"login": "lgcareer", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/bd7db688b6b1990e3ae40b18b61b0832be9cd8bb", "committedDate": "2020-12-15T09:55:03Z", "message": "Merge remote-tracking branch 'remotes/upstream/1.3.4-prepare' into 1.3.4-prepare-feature-3878"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cd1e7e5179afa14ba9670074107845854b998e1", "author": {"user": {"login": "lgcareer", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/4cd1e7e5179afa14ba9670074107845854b998e1", "committedDate": "2020-12-15T10:18:01Z", "message": "[Fix-4222][Master]Add the priority queue to ensure that tasks are submitted according to priority."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMzE5NjU2", "url": "https://github.com/apache/dolphinscheduler/pull/4232#pullrequestreview-552319656", "createdAt": "2020-12-15T10:40:54Z", "commit": {"oid": "4cd1e7e5179afa14ba9670074107845854b998e1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMDo0MDo1NFrOIGEV9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMDo0MDo1NFrOIGEV9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIzMzUyNg==", "bodyText": "Should use logger.error...", "url": "https://github.com/apache/dolphinscheduler/pull/4232#discussion_r543233526", "createdAt": "2020-12-15T10:40:54Z", "author": {"login": "CalvinKirs"}, "path": "dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/master/runner/MasterExecThread.java", "diffHunk": "@@ -996,20 +1002,26 @@ private boolean retryTaskIntervalOverTime(TaskInstance taskInstance){\n      * handling the list of tasks to be submitted\n      */\n     private void submitStandByTask(){\n-        for(Map.Entry<String, TaskInstance> entry: readyToSubmitTaskList.entrySet()) {\n-            TaskInstance task = entry.getValue();\n-            DependResult dependResult = getDependResultForTask(task);\n-            if(DependResult.SUCCESS == dependResult){\n-                if(retryTaskIntervalOverTime(task)){\n-                    submitTaskExec(task);\n+\n+        try {\n+            int length = readyToSubmitTaskQueue.size();\n+            for (int i=0;i<length;i++) {\n+                TaskInstance task = readyToSubmitTaskQueue.peek();\n+                DependResult dependResult = getDependResultForTask(task);\n+                if(DependResult.SUCCESS == dependResult){\n+                    if(retryTaskIntervalOverTime(task)){\n+                        submitTaskExec(task);\n+                        removeTaskFromStandbyList(task);\n+                    }\n+                }else if(DependResult.FAILED == dependResult){\n+                    // if the dependency fails, the current node is not submitted and the state changes to failure.\n+                    dependFailedTask.put(task.getName(), task);\n                     removeTaskFromStandbyList(task);\n+                    logger.info(\"task {},id:{} depend result : {}\",task.getName(), task.getId(), dependResult);\n                 }\n-            }else if(DependResult.FAILED == dependResult){\n-                // if the dependency fails, the current node is not submitted and the state changes to failure.\n-                dependFailedTask.put(entry.getKey(), task);\n-                removeTaskFromStandbyList(task);\n-                logger.info(\"task {},id:{} depend result : {}\",task.getName(), task.getId(), dependResult);\n             }\n+        } catch (Exception e) {\n+            e.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4cd1e7e5179afa14ba9670074107845854b998e1"}, "originalPosition": 155}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMzI1MjQ1", "url": "https://github.com/apache/dolphinscheduler/pull/4232#pullrequestreview-552325245", "createdAt": "2020-12-15T10:47:53Z", "commit": {"oid": "4cd1e7e5179afa14ba9670074107845854b998e1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6558bfcd7cc6f7970574d9a6f8c6a4a17dce664", "author": {"user": {"login": "lgcareer", "name": null}}, "url": "https://github.com/apache/dolphinscheduler/commit/a6558bfcd7cc6f7970574d9a6f8c6a4a17dce664", "committedDate": "2020-12-15T11:24:10Z", "message": "[Fix-4222][Master]update print log."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2293, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}