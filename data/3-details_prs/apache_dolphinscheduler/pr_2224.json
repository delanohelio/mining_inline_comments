{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMzE0NTYy", "number": 2224, "title": "support custom datax configuration ", "bodyText": "support custom datax configuration  #2102", "createdAt": "2020-03-18T09:18:27Z", "url": "https://github.com/apache/dolphinscheduler/pull/2224", "merged": true, "mergeCommit": {"oid": "00ff88ef1c4a8af8d2dc1324543338629dd3ca6b"}, "closed": true, "closedAt": "2020-03-19T10:56:58Z", "author": {"login": "simon824"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABbvRpc_AH2gAyMzkwMzE0NTYyOmFiOWNhZWM1MGVjYTNkNTFiZGVlY2JkNTE3Zjg0YTg5YTFjMGQ0OGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPJvLCgFqTM3NzYxMTY4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ab9caec50eca3d51bdeecbd517f84a89a1c0d48c", "author": {"user": {"login": "simon824", "name": "Simon"}}, "url": "https://github.com/apache/dolphinscheduler/commit/ab9caec50eca3d51bdeecbd517f84a89a1c0d48c", "committedDate": "2019-12-11T10:03:02Z", "message": "fix #1441"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffe2e74c4b30cc2ab0fe9a8f53b90c3e02ce09e0", "author": {"user": {"login": "simon824", "name": "Simon"}}, "url": "https://github.com/apache/dolphinscheduler/commit/ffe2e74c4b30cc2ab0fe9a8f53b90c3e02ce09e0", "committedDate": "2020-03-02T03:38:49Z", "message": "Merge pull request #1 from apache/dev\n\nUpdate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c583c42c2dac6e9c68afec806d9aab19723189de", "author": {"user": {"login": "simon824", "name": "Simon"}}, "url": "https://github.com/apache/dolphinscheduler/commit/c583c42c2dac6e9c68afec806d9aab19723189de", "committedDate": "2020-03-18T03:49:03Z", "message": "Merge pull request #2 from apache/dev\n\naaa"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6928fe04529012f750810a6cfc3bb0894ccb168", "author": {"user": {"login": "simon824", "name": "Simon"}}, "url": "https://github.com/apache/dolphinscheduler/commit/b6928fe04529012f750810a6cfc3bb0894ccb168", "committedDate": "2020-03-18T07:30:21Z", "message": "support custom datax config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c4ba3a55753cde0f2cd741c0c6d8222e0c27396", "author": {"user": {"login": "simon824", "name": "Simon"}}, "url": "https://github.com/apache/dolphinscheduler/commit/8c4ba3a55753cde0f2cd741c0c6d8222e0c27396", "committedDate": "2020-03-18T07:38:45Z", "message": "support datax custom config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b32a3f31a112b89babcfc01998e348cdf0945b1b", "author": {"user": {"login": "simon824", "name": "Simon"}}, "url": "https://github.com/apache/dolphinscheduler/commit/b32a3f31a112b89babcfc01998e348cdf0945b1b", "committedDate": "2020-03-18T09:10:30Z", "message": "support datax custom config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74708b3b84f494facfb989ccf40ff20eb4cf94da", "author": {"user": {"login": "simon824", "name": "Simon"}}, "url": "https://github.com/apache/dolphinscheduler/commit/74708b3b84f494facfb989ccf40ff20eb4cf94da", "committedDate": "2020-03-18T09:59:10Z", "message": "support datax custom config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28f2c84df59c735972255be6fc08eeea11e7c294", "author": {"user": {"login": "simon824", "name": "Simon"}}, "url": "https://github.com/apache/dolphinscheduler/commit/28f2c84df59c735972255be6fc08eeea11e7c294", "committedDate": "2020-03-18T12:27:38Z", "message": "Merge pull request #3 from apache/dev\n\nAdapting partial code(file name start with N) to the sonar cloud rule\u2026"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b92a777e3c8974dd2b4884c7cbdf37950072586", "author": {"user": {"login": "simon824", "name": "Simon"}}, "url": "https://github.com/apache/dolphinscheduler/commit/7b92a777e3c8974dd2b4884c7cbdf37950072586", "committedDate": "2020-03-19T01:01:07Z", "message": "Merge pull request #4 from apache/dev\n\nupdate"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MzQ2NTYy", "url": "https://github.com/apache/dolphinscheduler/pull/2224#pullrequestreview-377346562", "createdAt": "2020-03-19T01:02:02Z", "commit": {"oid": "28f2c84df59c735972255be6fc08eeea11e7c294"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwMTowNzoyNVrOF4cjmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwMTowODozOFrOF4cmsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDczMjQ0MA==", "bodyText": "I think logger.info would be easy to debug the whole task.", "url": "https://github.com/apache/dolphinscheduler/pull/2224#discussion_r394732440", "createdAt": "2020-03-19T01:07:25Z", "author": {"login": "Jave-Chen"}, "path": "dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/worker/task/datax/DataxTask.java", "diffHunk": "@@ -192,24 +192,47 @@ private String buildDataxJsonFile()\n         throws Exception {\n         // generate json\n         String fileName = String.format(\"%s/%s_job.json\", taskDir, taskProps.getTaskAppId());\n+        String json;\n \n         Path path = new File(fileName).toPath();\n         if (Files.exists(path)) {\n             return fileName;\n         }\n \n-        JSONObject job = new JSONObject();\n-        job.put(\"content\", buildDataxJobContentJson());\n-        job.put(\"setting\", buildDataxJobSettingJson());\n \n-        JSONObject root = new JSONObject();\n-        root.put(\"job\", job);\n-        root.put(\"core\", buildDataxCoreJson());\n \n-        logger.debug(\"datax job json : {}\", root.toString());\n+        if (dataXParameters.getCustomConfig() == 1){\n+\n+            json = dataXParameters.getJson().replaceAll(\"\\\\r\\\\n\", \"\\n\");\n+\n+            /**\n+             *  combining local and global parameters\n+             */\n+            Map<String, Property> paramsMap = ParamUtils.convert(taskProps.getUserDefParamsMap(),\n+                    taskProps.getDefinedParams(),\n+                    dataXParameters.getLocalParametersMap(),\n+                    taskProps.getCmdTypeIfComplement(),\n+                    taskProps.getScheduleTime());\n+            if (paramsMap != null){\n+                json = ParameterUtils.convertParameterPlaceholders(json, ParamUtils.convert(paramsMap));\n+            }\n+\n+        }else {\n+\n+            JSONObject job = new JSONObject();\n+            job.put(\"content\", buildDataxJobContentJson());\n+            job.put(\"setting\", buildDataxJobSettingJson());\n+\n+            JSONObject root = new JSONObject();\n+            root.put(\"job\", job);\n+            root.put(\"core\", buildDataxCoreJson());\n+            json = root.toString();\n+        }\n+\n+        logger.debug(\"datax job json : {}\", json);\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b92a777e3c8974dd2b4884c7cbdf37950072586"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDczMzIzMg==", "bodyText": "Variables can also be used in datax job json, which will cause json to be invalid, such as\n{\n  ...\n  \"reader\": {\n    \"name\": \"mysqlreader\",\n    \"parameter\": {\n      \"username\": \"${db_user}\",\n      \"password\": \"${db_pwd}\",\n      \"encoding\": \"UTF-8\",\n      \"column\": [${tbl_clms}],\n      \"connection\": [\n        {\n          \"jdbcUrl\": [\n            \"jdbc:mysql://${host}/${db}?useUnicode=true&characterEncoding=utf8\"\n          ],\n          \"table\": [\n            ${table_list}\n          ]\n        }\n      ]\n    }\n  }\n  ...\n}", "url": "https://github.com/apache/dolphinscheduler/pull/2224#discussion_r394733232", "createdAt": "2020-03-19T01:08:38Z", "author": {"login": "Jave-Chen"}, "path": "dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/worker/task/datax/DataxTask.java", "diffHunk": "@@ -192,24 +192,47 @@ private String buildDataxJsonFile()\n         throws Exception {\n         // generate json\n         String fileName = String.format(\"%s/%s_job.json\", taskDir, taskProps.getTaskAppId());\n+        String json;\n \n         Path path = new File(fileName).toPath();\n         if (Files.exists(path)) {\n             return fileName;\n         }\n \n-        JSONObject job = new JSONObject();\n-        job.put(\"content\", buildDataxJobContentJson());\n-        job.put(\"setting\", buildDataxJobSettingJson());\n \n-        JSONObject root = new JSONObject();\n-        root.put(\"job\", job);\n-        root.put(\"core\", buildDataxCoreJson());\n \n-        logger.debug(\"datax job json : {}\", root.toString());\n+        if (dataXParameters.getCustomConfig() == 1){\n+\n+            json = dataXParameters.getJson().replaceAll(\"\\\\r\\\\n\", \"\\n\");\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b92a777e3c8974dd2b4884c7cbdf37950072586"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NjExNjg0", "url": "https://github.com/apache/dolphinscheduler/pull/2224#pullrequestreview-377611684", "createdAt": "2020-03-19T10:55:37Z", "commit": {"oid": "7b92a777e3c8974dd2b4884c7cbdf37950072586"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2060, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}