{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExNTA0MzM1", "number": 3440, "title": "Enhance validation of dockstore.yml workflows", "bodyText": "#3410\nPreviously if a primary descriptor was not found for a dockstore yml workflow, the version is not added.\nNow, the version is added and a validation message is associated with the dockstore.yml. If a test parameter file is missing, this is also kept.\nAlso adds a test for this situation.\nQuestion for the group:\nIf a dockstore.yml is missing a test parameter file, it will currently cause the version to be invalid. Do we want this to be true?", "createdAt": "2020-04-30T13:36:46Z", "url": "https://github.com/dockstore/dockstore/pull/3440", "merged": true, "mergeCommit": {"oid": "be7c83651c0d404b7d149a0ebdd34d6a69a2c237"}, "closed": true, "closedAt": "2020-05-01T19:44:25Z", "author": {"login": "agduncan94"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccHvcTgH2gAyNDExNTA0MzM1OjIxYWJmZTljODkyOTJmMDg0YmZiNjk4NzAwNTljNmFkNmY2MWYzZDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcdFg_pgH2gAyNDExNTA0MzM1Ojk0NTU0MWRiZTY3ZjEwNDNjNTg0NDk5YTZhOTJjMjNkNWFiN2M3NDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "21abfe9c89292f084bfb69870059c6ad6f61f3d4", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/21abfe9c89292f084bfb69870059c6ad6f61f3d4", "committedDate": "2020-04-28T17:57:07Z", "message": "add version even if primary descriptor is not present"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fc999b729aaa1f4a60db9ee56d1c870cfae7a31", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/4fc999b729aaa1f4a60db9ee56d1c870cfae7a31", "committedDate": "2020-04-28T18:07:46Z", "message": "grab dockstore yml test parameter files even if primary descriptor is not found"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f4301ffc5a56ea34115f8ae02aa74d2c5e37f55", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/7f4301ffc5a56ea34115f8ae02aa74d2c5e37f55", "committedDate": "2020-04-28T19:53:22Z", "message": "record validation information for the .dockstore.yml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b55eaa74788cb0b4882ed317affe30dcbfc1bcc9", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/b55eaa74788cb0b4882ed317affe30dcbfc1bcc9", "committedDate": "2020-04-28T19:58:37Z", "message": "if cannot find primary descriptor, now stores validation message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb41cced998108293d3998da48a35054c8da7f59", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/eb41cced998108293d3998da48a35054c8da7f59", "committedDate": "2020-04-29T18:09:04Z", "message": "fix index issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b56a55aafc740fd45b740d6889e07b3f9226cbdc", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/b56a55aafc740fd45b740d6889e07b3f9226cbdc", "committedDate": "2020-04-29T19:23:13Z", "message": "add tests for invalid dockstore yml cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "126836608d06fa052ef4a732c6380a77cce097ca", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/126836608d06fa052ef4a732c6380a77cce097ca", "committedDate": "2020-04-30T13:04:41Z", "message": "clean up test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3f6342daff9ca45c40249f5241157f879e6bc34", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/f3f6342daff9ca45c40249f5241157f879e6bc34", "committedDate": "2020-04-30T13:37:16Z", "message": "Merge branch 'develop' into feature/3416/disable-refresh-from-services"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba829f2e399ac318243fb4b4ab0a21274c4b54c9", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/ba829f2e399ac318243fb4b4ab0a21274c4b54c9", "committedDate": "2020-04-30T13:38:35Z", "message": "prettier printing of validations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNjk2OTUx", "url": "https://github.com/dockstore/dockstore/pull/3440#pullrequestreview-403696951", "createdAt": "2020-04-30T16:44:38Z", "commit": {"oid": "ba829f2e399ac318243fb4b4ab0a21274c4b54c9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNjo0NDozOFrOGOxplA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNjo0NDozOFrOGOxplA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE0NjcwOA==", "bodyText": "Just my opinion:\nI know it's a hassle to code and I know it's nit-picky, but I think we shouldn't use the (s) in messages -- we know if it's singular or plural.", "url": "https://github.com/dockstore/dockstore/pull/3440#discussion_r418146708", "createdAt": "2020-04-30T16:44:38Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java", "diffHunk": "@@ -704,20 +708,30 @@ private WorkflowVersion setupWorkflowFilesForGitHubVersion(Triple<String, Date,\n                         testJson.setContent(testJsonContent);\n \n                         // Only add test parameter file if it hasn't already been added\n-                        boolean hasDuplicate = version.getSourceFiles().stream().anyMatch(\n-                            (SourceFile sf) -> sf.getPath().equals(workflow.getDefaultTestParameterFilePath()) && sf.getType() == testJson.getType());\n+                        boolean hasDuplicate = version.getSourceFiles().stream().anyMatch((SourceFile sf) -> sf.getPath().equals(workflow.getDefaultTestParameterFilePath()) && sf.getType() == testJson.getType());\n                         if (!hasDuplicate) {\n                             version.getSourceFiles().add(testJson);\n                         }\n+                    } else {\n+                        missingParamFiles.add(testParameterPath);\n                     }\n                 }\n+\n+                if (missingParamFiles.size() > 0) {\n+                    validationMessage.put(\"/.dockstore.yml\", String.format(\"The following file(s) are missing: %s.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba829f2e399ac318243fb4b4ab0a21274c4b54c9"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNzE2NDA5", "url": "https://github.com/dockstore/dockstore/pull/3440#pullrequestreview-403716409", "createdAt": "2020-04-30T17:10:14Z", "commit": {"oid": "ba829f2e399ac318243fb4b4ab0a21274c4b54c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNzoxMDoxNFrOGOyj_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNzoxMDoxNFrOGOyj_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE2MTY2Mg==", "bodyText": "Can you make \"/.dockstore.yml\" a constant somewhere?  There was a recent ticket saying how it sometimes was \"/dockstore.yml\" and it seems like now is as good a time as any to just start using a constant for that file path.", "url": "https://github.com/dockstore/dockstore/pull/3440#discussion_r418161662", "createdAt": "2020-04-30T17:10:14Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java", "diffHunk": "@@ -704,20 +708,30 @@ private WorkflowVersion setupWorkflowFilesForGitHubVersion(Triple<String, Date,\n                         testJson.setContent(testJsonContent);\n \n                         // Only add test parameter file if it hasn't already been added\n-                        boolean hasDuplicate = version.getSourceFiles().stream().anyMatch(\n-                            (SourceFile sf) -> sf.getPath().equals(workflow.getDefaultTestParameterFilePath()) && sf.getType() == testJson.getType());\n+                        boolean hasDuplicate = version.getSourceFiles().stream().anyMatch((SourceFile sf) -> sf.getPath().equals(workflow.getDefaultTestParameterFilePath()) && sf.getType() == testJson.getType());\n                         if (!hasDuplicate) {\n                             version.getSourceFiles().add(testJson);\n                         }\n+                    } else {\n+                        missingParamFiles.add(testParameterPath);\n                     }\n                 }\n+\n+                if (missingParamFiles.size() > 0) {\n+                    validationMessage.put(\"/.dockstore.yml\", String.format(\"The following file(s) are missing: %s.\",\n+                            missingParamFiles.stream().map(paramFile -> String.format(\"'%s'\", paramFile)).collect(Collectors.joining(\", \"))));\n+                }\n             }\n         } else {\n             // File not found or null\n             LOG.info(\"Could not find file \" + primaryDescriptorPath + \" in repo \" + repository);\n-            return null;\n+            validationMessage.put(\"/.dockstore.yml\", \"Could not find the primary descriptor file '\" + primaryDescriptorPath + \"'.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba829f2e399ac318243fb4b4ab0a21274c4b54c9"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c1e9a4026e292aa18cac43bea63fc09f05aa2f9", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/4c1e9a4026e292aa18cac43bea63fc09f05aa2f9", "committedDate": "2020-04-30T17:20:45Z", "message": "recommended changes from PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bed3b9a92a3b66040deae174c66bc3cf81331dff", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/bed3b9a92a3b66040deae174c66bc3cf81331dff", "committedDate": "2020-04-30T18:04:27Z", "message": "fix broken zip function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b819f9c3aaab01b0aa45a60556daa6a76764202a", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/b819f9c3aaab01b0aa45a60556daa6a76764202a", "committedDate": "2020-04-30T18:12:18Z", "message": "ignore dockstore.yml for version validaiton"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e2e97ef5552aead21cbf61be7a0a9ef68fc4a45", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/7e2e97ef5552aead21cbf61be7a0a9ef68fc4a45", "committedDate": "2020-04-30T18:12:35Z", "message": "Merge branch 'develop' into feature/3416/disable-refresh-from-services"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "946e9df396a29df5dbd6a5e2df6f051c6477cfb9", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/946e9df396a29df5dbd6a5e2df6f051c6477cfb9", "committedDate": "2020-04-30T19:00:06Z", "message": "fix failing test for webhook"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MTkyODAy", "url": "https://github.com/dockstore/dockstore/pull/3440#pullrequestreview-404192802", "createdAt": "2020-05-01T14:35:37Z", "commit": {"oid": "946e9df396a29df5dbd6a5e2df6f051c6477cfb9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MjM0MjMx", "url": "https://github.com/dockstore/dockstore/pull/3440#pullrequestreview-404234231", "createdAt": "2020-05-01T15:48:31Z", "commit": {"oid": "946e9df396a29df5dbd6a5e2df6f051c6477cfb9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MjQ2ODMx", "url": "https://github.com/dockstore/dockstore/pull/3440#pullrequestreview-404246831", "createdAt": "2020-05-01T16:10:25Z", "commit": {"oid": "946e9df396a29df5dbd6a5e2df6f051c6477cfb9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0Mjk4Nzk2", "url": "https://github.com/dockstore/dockstore/pull/3440#pullrequestreview-404298796", "createdAt": "2020-05-01T17:46:10Z", "commit": {"oid": "946e9df396a29df5dbd6a5e2df6f051c6477cfb9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "945541dbe67f1043c584499a6a92c23d5ab7c740", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/945541dbe67f1043c584499a6a92c23d5ab7c740", "committedDate": "2020-05-01T17:55:27Z", "message": "Merge branch 'develop' into feature/3416/disable-refresh-from-services"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1865, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}