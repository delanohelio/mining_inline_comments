{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNDA3OTEy", "number": 3282, "title": "Feature/3270/gh apps branches", "bodyText": "branches are now supported for services and workflows using .dockstore.yml\nwebhook endpoint now expects git branch in the form of refs/heads/foobar and refs/tags/v1.0 (this is due to the push event that will now be used - https://developer.github.com/v3/activity/events/types/#pushevent)\nexisting versions are now properly overwritten on refresh/webhook call\n\nSee #3270", "createdAt": "2020-02-28T14:06:37Z", "url": "https://github.com/dockstore/dockstore/pull/3282", "merged": true, "mergeCommit": {"oid": "49146070d462f067a0f022dd6612d09a493faf22"}, "closed": true, "closedAt": "2020-03-03T20:43:50Z", "author": {"login": "agduncan94"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIM5pPAH2gAyMzgxNDA3OTEyOmZlMmUwNWEzNDVjZmIwMjY2MjEzZTBhOWJiOTc2YmYyNDQ4ZjlhMmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKIjoWgFqTM2ODMwOTQzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fe2e05a345cfb0266213e0a9bb976bf2448f9a2b", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/fe2e05a345cfb0266213e0a9bb976bf2448f9a2b", "committedDate": "2020-02-26T20:39:18Z", "message": "first attempt at getting branches supported for dockstore.yml workflows and services"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "548c83273c5a055998ffdbb0dcd3862c389296a4", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/548c83273c5a055998ffdbb0dcd3862c389296a4", "committedDate": "2020-02-27T13:40:04Z", "message": "refresh dockstore.yml adds branches too"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6659e8a4c185ec0d7274fffa06fdc9af919f8a61", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/6659e8a4c185ec0d7274fffa06fdc9af919f8a61", "committedDate": "2020-02-27T13:49:56Z", "message": "fix failing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5ea7102ed510a69ba554eb983d47e2c7e9f80e1", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/f5ea7102ed510a69ba554eb983d47e2c7e9f80e1", "committedDate": "2020-02-27T15:17:42Z", "message": "update regex for matching git ref"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5b1b9a6f574ba034f5b0324e2f80eee9d60153f", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/e5b1b9a6f574ba034f5b0324e2f80eee9d60153f", "committedDate": "2020-02-27T19:39:31Z", "message": "renamed old function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ea720546e33f1786d8549dc99816df79d9a86b1", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/0ea720546e33f1786d8549dc99816df79d9a86b1", "committedDate": "2020-02-27T19:44:40Z", "message": "Merge branch 'develop' into feature/3270/gh-apps-branches"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2d2da67162da530860656263e13f08a1a11d190", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/e2d2da67162da530860656263e13f08a1a11d190", "committedDate": "2020-02-28T13:56:57Z", "message": "update test to also add a branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22c3d7809fbc11fdbd837a05e5f116a34e495bc2", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/22c3d7809fbc11fdbd837a05e5f116a34e495bc2", "committedDate": "2020-02-28T14:07:14Z", "message": "Merge branch 'develop' into feature/3270/gh-apps-branches"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27c03af2ab872a93e515427dccdf080a7630b251", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/27c03af2ab872a93e515427dccdf080a7630b251", "committedDate": "2020-02-28T14:28:58Z", "message": "fix codacy issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NDcxMTky", "url": "https://github.com/dockstore/dockstore/pull/3282#pullrequestreview-366471192", "createdAt": "2020-02-28T15:16:46Z", "commit": {"oid": "27c03af2ab872a93e515427dccdf080a7630b251"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NTU1Njc0", "url": "https://github.com/dockstore/dockstore/pull/3282#pullrequestreview-366555674", "createdAt": "2020-02-28T17:14:39Z", "commit": {"oid": "27c03af2ab872a93e515427dccdf080a7630b251"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NTc1NjA5", "url": "https://github.com/dockstore/dockstore/pull/3282#pullrequestreview-366575609", "createdAt": "2020-02-28T17:49:55Z", "commit": {"oid": "27c03af2ab872a93e515427dccdf080a7630b251"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzo0OTo1NVrOFv9hbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzo1NjoxOFrOFv9stA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgzNTM3NA==", "bodyText": "Suggest LOG.error", "url": "https://github.com/dockstore/dockstore/pull/3282#discussion_r385835374", "createdAt": "2020-02-28T17:49:55Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java", "diffHunk": "@@ -893,28 +891,44 @@ public void syncUserMetadataFromGitHub(User user) {\n     }\n \n     /**\n-     * Retrieves a tag from GitHub and creates a version on Dockstore\n+     * Retrieves a tag/branch from GitHub and creates a version on Dockstore\n      * @param repository Repository path (ex. dockstore/dockstore-ui2)\n-     * @param gitReference Tag reference from GitHub (ex. 1.0)\n+     * @param gitReference Branch/tag reference from GitHub (ex. refs/tags/1.0)\n      * @param workflow Workflow to add version to\n      * @param dockstoreYml Dockstore YML sourcefile\n      * @return New or updated version\n      * @throws IOException\n      */\n-    public WorkflowVersion createTagVersionForWorkflow(String repository, String gitReference, Workflow workflow, SourceFile dockstoreYml) throws IOException {\n+    public WorkflowVersion createVersionForWorkflow(String repository, String gitReference, Workflow workflow, SourceFile dockstoreYml) throws IOException {\n         GHRepository ghRepository = getRepository(repository);\n-        String refName = \"tags/\" + gitReference;\n-        GHRef ghRef = ghRepository.getRef(refName);\n+\n+        // Match the github reference (ex. refs/heads/feature/foobar or refs/tags/1.0)\n+        Pattern pattern = Pattern.compile(\"^refs/(tags|heads)/([a-zA-Z0-9]+([./_-]?[a-zA-Z0-9]+)*)$\");\n+        Matcher matcher = pattern.matcher(gitReference);\n+\n+        if (!matcher.find()) {\n+            String msg = \"Reference \" + gitReference + \" is not of the valid form\";\n+            LOG.info(msg);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27c03af2ab872a93e515427dccdf080a7630b251"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgzODI2MA==", "bodyText": "This is fine, but if so inclined you could just do existingVersion.isPresent(v -> workflow.removeWorkflowVersion(v)) instead of needing an if statement an calling 'get (exact syntax probably wrong)", "url": "https://github.com/dockstore/dockstore/pull/3282#discussion_r385838260", "createdAt": "2020-02-28T17:56:18Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java", "diffHunk": "@@ -893,28 +891,44 @@ public void syncUserMetadataFromGitHub(User user) {\n     }\n \n     /**\n-     * Retrieves a tag from GitHub and creates a version on Dockstore\n+     * Retrieves a tag/branch from GitHub and creates a version on Dockstore\n      * @param repository Repository path (ex. dockstore/dockstore-ui2)\n-     * @param gitReference Tag reference from GitHub (ex. 1.0)\n+     * @param gitReference Branch/tag reference from GitHub (ex. refs/tags/1.0)\n      * @param workflow Workflow to add version to\n      * @param dockstoreYml Dockstore YML sourcefile\n      * @return New or updated version\n      * @throws IOException\n      */\n-    public WorkflowVersion createTagVersionForWorkflow(String repository, String gitReference, Workflow workflow, SourceFile dockstoreYml) throws IOException {\n+    public WorkflowVersion createVersionForWorkflow(String repository, String gitReference, Workflow workflow, SourceFile dockstoreYml) throws IOException {\n         GHRepository ghRepository = getRepository(repository);\n-        String refName = \"tags/\" + gitReference;\n-        GHRef ghRef = ghRepository.getRef(refName);\n+\n+        // Match the github reference (ex. refs/heads/feature/foobar or refs/tags/1.0)\n+        Pattern pattern = Pattern.compile(\"^refs/(tags|heads)/([a-zA-Z0-9]+([./_-]?[a-zA-Z0-9]+)*)$\");\n+        Matcher matcher = pattern.matcher(gitReference);\n+\n+        if (!matcher.find()) {\n+            String msg = \"Reference \" + gitReference + \" is not of the valid form\";\n+            LOG.info(msg);\n+            throw new CustomWebApplicationException(msg, LAMBDA_FAILURE);\n+        }\n+        String gitBranchType = matcher.group(1);\n+        String gitBranchName = matcher.group(2);\n+\n+        GHRef ghRef = ghRepository.getRef(gitBranchType + \"/\" + gitBranchName);\n \n         Triple<String, Date, String> ref = getRef(ghRef, ghRepository);\n         if (ref == null) {\n-            String msg = \"Cannot retrieve the workflow reference from GitHub, ensure that \" + gitReference + \" is a valid tag.\";\n+            String msg = \"Cannot retrieve the workflow reference from GitHub, ensure that \" + gitReference + \" is a valid branch/tag.\";\n             LOG.info(msg);\n             throw new CustomWebApplicationException(msg, LAMBDA_FAILURE);\n         }\n \n-        // Find existing version if it exists\n-        Optional<WorkflowVersion> existingVersion = workflow.getWorkflowVersions().stream().filter(workflowVersion -> Objects.equals(workflowVersion.getReference(), gitReference)).findFirst();\n+        // Delete existing version if it exists\n+        Optional<WorkflowVersion> existingVersion = workflow.getWorkflowVersions().stream().filter(workflowVersion -> Objects.equals(workflowVersion.getReference(), gitBranchName)).findFirst();\n+        if (existingVersion.isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27c03af2ab872a93e515427dccdf080a7630b251"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NjQwMTY4", "url": "https://github.com/dockstore/dockstore/pull/3282#pullrequestreview-366640168", "createdAt": "2020-02-28T19:41:21Z", "commit": {"oid": "27c03af2ab872a93e515427dccdf080a7630b251"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxOTo0MToyMVrOFwAoOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxOTo0MjozM1rOFwAqSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg4NjI2NA==", "bodyText": "Will die if DockstoreTestUser2 releases a new version or someone starts working on a PR", "url": "https://github.com/dockstore/dockstore/pull/3282#discussion_r385886264", "createdAt": "2020-02-28T19:41:21Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/ServiceIT.java", "diffHunk": "@@ -353,16 +353,15 @@ public void updateServiceSync() throws Exception {\n         String installationId = \"1179416\";\n \n         // Add service\n-        List<io.swagger.client.model.Workflow> services = client.handleGitHubRelease(serviceRepo, \"DockstoreTestUser2\", \"1.0\", installationId);\n+        List<io.swagger.client.model.Workflow> services = client.handleGitHubRelease(serviceRepo, \"DockstoreTestUser2\", \"refs/tags/1.0\", installationId);\n         assertEquals(\"Should only have one service\", 1, services.size());\n         io.swagger.client.model.Workflow service = services.get(0);\n         service = client.refresh(service.getId());\n         assertNotNull(service);\n-        assertEquals(\"Should have one new version (one release has no yaml, another has invalid yaml)\", 1, service.getWorkflowVersions().size());\n+        assertEquals(\"Should have two new versions master and 1.0\", 2, service.getWorkflowVersions().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27c03af2ab872a93e515427dccdf080a7630b251"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg4NjYxOA==", "bodyText": "Ditto", "url": "https://github.com/dockstore/dockstore/pull/3282#discussion_r385886618", "createdAt": "2020-02-28T19:42:09Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/WebhookIT.java", "diffHunk": "@@ -115,6 +115,16 @@ public void testGitHubReleaseNoWorkflowOnDockstore() throws Exception {\n         assertEquals(\"Should be a CWL workflow\", Workflow.DescriptorTypeEnum.CWL, workflow2.getDescriptorType());\n         assertEquals(\"Should be type DOCKSTORE_YML\", Workflow.ModeEnum.DOCKSTORE_YML, workflow2.getMode());\n         assertEquals(\"Should have one version 0.2\", 1, workflow2.getWorkflowVersions().size());\n+\n+        // Branch master on GitHub - updates two existing workflows\n+        workflows = client.handleGitHubRelease(workflowRepo, \"DockstoreTestUser2\", \"refs/heads/master\", installationId);\n+        assertEquals(\"Should only have two services\", 2, workflows.size());\n+\n+        workflow = client.getWorkflowByPath(\"github.com/\" + workflowRepo + \"/foobar\", \"\", false);\n+        assertEquals(\"Should have three versions 0.1, 0.2, and master\", 3, workflow.getWorkflowVersions().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27c03af2ab872a93e515427dccdf080a7630b251"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg4Njc5NA==", "bodyText": "Ditto (and will not repeat below)", "url": "https://github.com/dockstore/dockstore/pull/3282#discussion_r385886794", "createdAt": "2020-02-28T19:42:33Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/WebhookIT.java", "diffHunk": "@@ -139,16 +149,20 @@ public void testManualRefreshWorkflowWithGitHubApp() throws Exception {\n         // Refresh\n         workflow = client.refresh(workflow.getId());\n         assertNotNull(workflow);\n-        assertEquals(\"Should have two workflow versions: 0.1, 0.2 and 0.3\", 3, workflow.getWorkflowVersions().size());\n+        assertEquals(\"Should have four workflow versions: 0.1, 0.2 and 0.3, and master\", 4, workflow.getWorkflowVersions().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27c03af2ab872a93e515427dccdf080a7630b251"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11bbb3af61f59f79d24a21459c5d3e29f878b2ca", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/11bbb3af61f59f79d24a21459c5d3e29f878b2ca", "committedDate": "2020-03-02T13:45:15Z", "message": "changes from pr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de6cd7885f46b2f58dc41a221da60aeda2f440b1", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/de6cd7885f46b2f58dc41a221da60aeda2f440b1", "committedDate": "2020-03-03T13:54:17Z", "message": "Merge branch 'develop' into feature/3270/gh-apps-branches"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MjM2OTM2", "url": "https://github.com/dockstore/dockstore/pull/3282#pullrequestreview-368236936", "createdAt": "2020-03-03T18:53:24Z", "commit": {"oid": "de6cd7885f46b2f58dc41a221da60aeda2f440b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxODo1MzoyNFrOFxSTmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxODo1MzoyNFrOFxSTmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIyNDQ3NA==", "bodyText": "Isn't that a refresh on line 152?\nCouldn't someone else create new branches on DockstoreTestUser2/workflow-dockstore-yml and then break this?", "url": "https://github.com/dockstore/dockstore/pull/3282#discussion_r387224474", "createdAt": "2020-03-03T18:53:24Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/WebhookIT.java", "diffHunk": "@@ -127,28 +139,36 @@ public void testManualRefreshWorkflowWithGitHubApp() throws Exception {\n         WorkflowsApi client = new WorkflowsApi(webClient);\n \n         // Release 0.1 on GitHub - one new wdl workflow\n-        List<Workflow> workflows = client.handleGitHubRelease(workflowRepo, \"DockstoreTestUser2\", \"0.1\", installationId);\n+        List<Workflow> workflows = client.handleGitHubRelease(workflowRepo, \"DockstoreTestUser2\", \"refs/tags/0.1\", installationId);\n         assertEquals(\"Should only have one service\", 1, workflows.size());\n \n         // Ensure that new workflow is created and is what is expected\n         Workflow workflow = client.getWorkflowByPath(\"github.com/\" + workflowRepo + \"/foobar\", \"\", false);\n         assertEquals(\"Should be a WDL workflow\", Workflow.DescriptorTypeEnum.WDL, workflow.getDescriptorType());\n         assertEquals(\"Should be type DOCKSTORE_YML\", Workflow.ModeEnum.DOCKSTORE_YML, workflow.getMode());\n-        assertEquals(\"Should have one version 0.1\", 1, workflow.getWorkflowVersions().size());\n+        assertTrue(\"Should have a 0.1 version.\", workflow.getWorkflowVersions().stream().anyMatch((WorkflowVersion version) -> Objects.equals(version.getName(), \"0.1\")));\n \n         // Refresh\n         workflow = client.refresh(workflow.getId());\n         assertNotNull(workflow);\n-        assertEquals(\"Should have two workflow versions: 0.1, 0.2 and 0.3\", 3, workflow.getWorkflowVersions().size());\n+        assertEquals(\"Should have four workflow versions: 0.1, 0.2 and 0.3, and master\", 4, workflow.getWorkflowVersions().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de6cd7885f46b2f58dc41a221da60aeda2f440b1"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10dd7d1d5499b0cae7b05e1ab222304635e0a5b5", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/10dd7d1d5499b0cae7b05e1ab222304635e0a5b5", "committedDate": "2020-03-03T18:55:33Z", "message": "remove line that could fail potentially"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MzA5NDM3", "url": "https://github.com/dockstore/dockstore/pull/3282#pullrequestreview-368309437", "createdAt": "2020-03-03T20:43:29Z", "commit": {"oid": "10dd7d1d5499b0cae7b05e1ab222304635e0a5b5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1798, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}