{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwMTkwOTI0", "number": 3478, "title": "Lazy load event entities", "bodyText": "To optimize https://dockstore.org/api/organizations/16/events?offset=0&limit=30\nfrom https://dockstore.org/organizations/BroadInstitute\n\n\n\n\nPayload Size\nTime\nJDBC statements\n\n\n\n\nBefore\n35.4 KB\n9.84 seconds\n10085\n\n\nAfter\n3.2 KB\n41ms\n8\n\n\n\nThis does absolutely nothing for the logged-in homepage events but that's not even in production right now.  I do have a plan for it, but it requires a significant change.  Not a hotfix change and probably too late for 1.9.0 also.", "createdAt": "2020-05-19T15:21:52Z", "url": "https://github.com/dockstore/dockstore/pull/3478", "merged": true, "mergeCommit": {"oid": "d4a7b6e7fb59862bbce4066b581d3bbe47203335"}, "closed": true, "closedAt": "2020-05-19T21:27:38Z", "author": {"login": "garyluu"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABci1-nSAH2gAyNDIwMTkwOTI0OmNkYzc4NWM3YzBmYTM5MDZiMjRjNjJiOTM1OWYxMjYxMWY2NGQ3ZjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABci6SkagFqTQxNDc4ODQzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cdc785c7c0fa3906b24c62b9359f12611f64d7f5", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/cdc785c7c0fa3906b24c62b9359f12611f64d7f5", "committedDate": "2020-05-19T15:12:52Z", "message": "Lazy load event entities"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0Njg4MzM3", "url": "https://github.com/dockstore/dockstore/pull/3478#pullrequestreview-414688337", "createdAt": "2020-05-19T17:53:30Z", "commit": {"oid": "cdc785c7c0fa3906b24c62b9359f12611f64d7f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNzo1MzozMVrOGXr_Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNzo1MzozMVrOGXr_Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5MTExMQ==", "bodyText": "Do each of these create a separate db connection?", "url": "https://github.com/dockstore/dockstore/pull/3478#discussion_r427491111", "createdAt": "2020-05-19T17:53:31Z", "author": {"login": "Ldcabansay"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/EventResource.java", "diffHunk": "@@ -84,18 +85,36 @@ public EventResource(EventDAO eventDAO, UserDAO userDAO) {\n         switch (eventSearchType) {\n         case STARRED_ENTRIES:\n             Set<Long> entryIDs = userWithSession.getStarredEntries().stream().map(Entry::getId).collect(Collectors.toSet());\n-            return this.eventDAO.findEventsByEntryIDs(entryIDs, offset, limit);\n+            List<Event> eventsByEntryIDs = this.eventDAO.findEventsByEntryIDs(entryIDs, offset, limit);\n+            eagerLoadEventEntries(eventsByEntryIDs);\n+            return eventsByEntryIDs;\n         case STARRED_ORGANIZATION:\n             Set<Long> organizationIDs = userWithSession.getStarredOrganizations().stream().map(Organization::getId).collect(Collectors.toSet());\n-            return this.eventDAO.findAllByOrganizationIds(organizationIDs, offset, limit);\n+            List<Event> allByOrganizationIds = this.eventDAO.findAllByOrganizationIds(organizationIDs, offset, limit);\n+            eagerLoadEventEntries(allByOrganizationIds);\n+            return allByOrganizationIds;\n         case ALL_STARRED:\n             Set<Long> organizationIDs2 = userWithSession.getStarredOrganizations().stream().map(Organization::getId).collect(Collectors.toSet());\n             Set<Long> entryIDs2 = userWithSession.getStarredEntries().stream().map(Entry::getId).collect(Collectors.toSet());\n-            return this.eventDAO.findAllByOrganizationIdsOrEntryIds(organizationIDs2, entryIDs2, offset, limit);\n+            List<Event> allByOrganizationIdsOrEntryIds = this.eventDAO\n+                    .findAllByOrganizationIdsOrEntryIds(organizationIDs2, entryIDs2, offset, limit);\n+            eagerLoadEventEntries(allByOrganizationIdsOrEntryIds);\n+            return allByOrganizationIdsOrEntryIds;\n         default:\n             return Collections.emptyList();\n         }\n     }\n+\n+    private void eagerLoadEventEntries(List<Event> events) {\n+        events.forEach(event -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdc785c7c0fa3906b24c62b9359f12611f64d7f5"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0Njk5OTYz", "url": "https://github.com/dockstore/dockstore/pull/3478#pullrequestreview-414699963", "createdAt": "2020-05-19T18:08:18Z", "commit": {"oid": "cdc785c7c0fa3906b24c62b9359f12611f64d7f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NzA1MjQ3", "url": "https://github.com/dockstore/dockstore/pull/3478#pullrequestreview-414705247", "createdAt": "2020-05-19T18:15:27Z", "commit": {"oid": "cdc785c7c0fa3906b24c62b9359f12611f64d7f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NzEyODg1", "url": "https://github.com/dockstore/dockstore/pull/3478#pullrequestreview-414712885", "createdAt": "2020-05-19T18:25:47Z", "commit": {"oid": "cdc785c7c0fa3906b24c62b9359f12611f64d7f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NzU3Njc1", "url": "https://github.com/dockstore/dockstore/pull/3478#pullrequestreview-414757675", "createdAt": "2020-05-19T19:28:34Z", "commit": {"oid": "cdc785c7c0fa3906b24c62b9359f12611f64d7f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0Nzg4NDMz", "url": "https://github.com/dockstore/dockstore/pull/3478#pullrequestreview-414788433", "createdAt": "2020-05-19T20:14:17Z", "commit": {"oid": "cdc785c7c0fa3906b24c62b9359f12611f64d7f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1886, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}