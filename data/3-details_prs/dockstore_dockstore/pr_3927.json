{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwMjA4ODky", "number": 3927, "title": "Feature/3917/travis to circle ci", "bodyText": "For #3917\n\nonly \"integration-tests\" require Docker.\nSome (maybe all) test profiles rely on cwltool but only two tests actually try launching a workflow with it.  CircleCI with Docker seems to have troubles launching it (even hello world)\nThere are actual legit problems with tests. Some \"flakey\" tests on Travis are not flakey, it's outright wrong and it's a miracle it passes.  I fixed 2 of them.\nForce release DB locks, just in case. Helps with local running of tests (when you stop a set of tests midway and try to relaunch, it would get stuck)\nuse orb for jq, yq, maybe codecov\n\nStill missing:\n\nm2 cache between jobs (not just between workflows)\nmerge to parent\ndouble-check test count https://docs.google.com/spreadsheets/d/1vPkIa4UoqVhJGic6R2-UOK79cibUM2RVaEV3vBqmqHU/edit?usp=sharing\ntravis succeed for the two tests (and create issue to move it to CircleCi or something) <---- this isn't actually running! Rename test\ndouble-check coverage:\nbefore https://codecov.io/gh/dockstore/dockstore/branch/develop vs https://codecov.io/gh/dockstore/dockstore/branch/feature%2Ffeature%2FTravisToCircleCI <-- looks like codecov sent results to old identical branch\nremove some repetitive integration tests commands\ntry reducing resource to \"large\"\nfigure out where to write down CircleCI key and iv (CircleCI can't upload it like Travis can)\nUnit tests still uses postgres 9.x.x, it requires migration changes (splitting to different ticket)\nswap to postgres11.8\ncreate issue to fix flakey tests\nremove coveralls from travis and pom\n\nI plan to do most of those this sprint, but deciding whether to make it 2 PRs or just one depending on urgency", "createdAt": "2020-11-12T22:58:59Z", "url": "https://github.com/dockstore/dockstore/pull/3927", "merged": true, "mergeCommit": {"oid": "c0e20a8d1b2ca36d55973a4f0d1ce6141e4f5fcf"}, "closed": true, "closedAt": "2020-11-13T22:56:22Z", "author": {"login": "garyluu"}, "timelineItems": {"totalCount": 41, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZ7GFNgH2gAyNTIwMjA4ODkyOmRhMmFmNDQ2ODQ1NGIwYWNhODc0NGVkMWEzNDYyYzE2NDQ5M2I0YTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcPA1SAFqTUzMDQ2MDYyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "da2af4468454b0aca8744ed1a3462c164493b4a6", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/da2af4468454b0aca8744ed1a3462c164493b4a6", "committedDate": "2020-11-06T18:16:23Z", "message": "Remove Travis"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91a37e41cc4904a1f032ea355f83197d1bcde0bf", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/91a37e41cc4904a1f032ea355f83197d1bcde0bf", "committedDate": "2020-11-12T21:38:24Z", "message": "Initial test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5592bba9f1555c6f806e471096ba5f409e7bbcb5", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/5592bba9f1555c6f806e471096ba5f409e7bbcb5", "committedDate": "2020-11-12T21:38:24Z", "message": "Install python3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9a51e76e56d99f33792bd1760df417cce795f49", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/c9a51e76e56d99f33792bd1760df417cce795f49", "committedDate": "2020-11-12T21:38:24Z", "message": "Don't wait for DB so early"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0902a41846fbee84c204473de24d10202de57fb5", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/0902a41846fbee84c204473de24d10202de57fb5", "committedDate": "2020-11-12T21:38:24Z", "message": "Disable unit tests for now, re-order everything"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7731771825a2cb0cc1388c68d406c5fe171052c2", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/7731771825a2cb0cc1388c68d406c5fe171052c2", "committedDate": "2020-11-12T21:38:24Z", "message": "Try another way"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b430d83c3e2406edbf22cb66f61802bd13878975", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/b430d83c3e2406edbf22cb66f61802bd13878975", "committedDate": "2020-11-12T21:38:24Z", "message": "Copy m2 manually"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6b9be327bb8ad5c0a118d35ac2d3dcc5827dc0f", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/d6b9be327bb8ad5c0a118d35ac2d3dcc5827dc0f", "committedDate": "2020-11-12T21:38:24Z", "message": "Do all the other integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e96aff4143f4c64d2fa5c8143ca739375692b0d0", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/e96aff4143f4c64d2fa5c8143ca739375692b0d0", "committedDate": "2020-11-12T21:38:24Z", "message": "Faster python/pip install?"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5d3a8f6f04965ca80381bba6ef02b420657749b", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/e5d3a8f6f04965ca80381bba6ef02b420657749b", "committedDate": "2020-11-12T21:38:24Z", "message": "Add coverage attempt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f456b6936568e70cf5b259a0d3bbedae84cf428", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/3f456b6936568e70cf5b259a0d3bbedae84cf428", "committedDate": "2020-11-12T21:38:24Z", "message": "Add enc zip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db03b624884eb17202ca91d28a1a0b08574733ae", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/db03b624884eb17202ca91d28a1a0b08574733ae", "committedDate": "2020-11-12T21:38:25Z", "message": "Update openssl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a32d8f4e312d89a5368e0549722b345285d94a0b", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/a32d8f4e312d89a5368e0549722b345285d94a0b", "committedDate": "2020-11-12T21:38:25Z", "message": "Run prettier"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d314c28696683560ee09fc2ecb65bb07cef99f77", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/d314c28696683560ee09fc2ecb65bb07cef99f77", "committedDate": "2020-11-12T21:38:25Z", "message": "Remove optimizations to debug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbdf26d66dd79595ceb6f588317965e7f04054ba", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/dbdf26d66dd79595ceb6f588317965e7f04054ba", "committedDate": "2020-11-12T21:38:25Z", "message": "Temp install git secrets too"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bde157d309fb7514b7a7653d0458c5ae9707285e", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/bde157d309fb7514b7a7653d0458c5ae9707285e", "committedDate": "2020-11-12T21:38:25Z", "message": "Increase resource size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "830608d7a2e2bdc0ff8ed5345aded0cb1728b01b", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/830608d7a2e2bdc0ff8ed5345aded0cb1728b01b", "committedDate": "2020-11-12T21:38:25Z", "message": "Use same config as UI2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1b0613d23415837708eee64487bc73042c24c16", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/b1b0613d23415837708eee64487bc73042c24c16", "committedDate": "2020-11-12T21:38:25Z", "message": "Setup remote docker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32139c037e3cb6f635b6706c864bedde4c522c55", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/32139c037e3cb6f635b6706c864bedde4c522c55", "committedDate": "2020-11-12T21:38:25Z", "message": "Change java and postgres images"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fb449bbf111b28460e07b2c4c99e6ac798df11b", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/7fb449bbf111b28460e07b2c4c99e6ac798df11b", "committedDate": "2020-11-12T21:38:25Z", "message": "Use older Python3 by using older Java image"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1a6c6c79986a3528fe0c430e84f7fa41aa6dddd", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/a1a6c6c79986a3528fe0c430e84f7fa41aa6dddd", "committedDate": "2020-11-12T21:38:25Z", "message": "Test docker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "429ddb4fb0dcf9e1ad4e1b8c1a2435e60ced1ce2", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/429ddb4fb0dcf9e1ad4e1b8c1a2435e60ced1ce2", "committedDate": "2020-11-12T21:38:25Z", "message": "Make profile for tests that require Docker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50852bdce1ff5455d92572802c8e5145cb7c2589", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/50852bdce1ff5455d92572802c8e5145cb7c2589", "committedDate": "2020-11-12T21:38:25Z", "message": "Use Dockerize for postgres, disable 2 tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bee982fadb32543ab7650a02b58118e0d1c3cd59", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/bee982fadb32543ab7650a02b58118e0d1c3cd59", "committedDate": "2020-11-12T21:38:25Z", "message": "Run the new test group"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7dc12ddee5f7c7367a466e282f431d45607914c", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/f7dc12ddee5f7c7367a466e282f431d45607914c", "committedDate": "2020-11-12T21:38:25Z", "message": "Move to RequireDockerTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cfd5db0443b88ce8c5c9725075db67b473ed83a", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/4cfd5db0443b88ce8c5c9725075db67b473ed83a", "committedDate": "2020-11-12T21:38:25Z", "message": "Upgrade postgres, some test fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb771c50f1bf8da252db874d277e476ef6e2c596", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/cb771c50f1bf8da252db874d277e476ef6e2c596", "committedDate": "2020-11-12T21:38:25Z", "message": "Restart application to clear cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9adb89a0ebdca2ea30990995cccac90aae3fd34", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/c9adb89a0ebdca2ea30990995cccac90aae3fd34", "committedDate": "2020-11-12T21:38:25Z", "message": "Force release lock before dropping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6c4c2c23ac07b5660c304a635ff9ccbb107e8c6", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/b6c4c2c23ac07b5660c304a635ff9ccbb107e8c6", "committedDate": "2020-11-12T21:38:25Z", "message": "Temporarily unmute"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe74da8ea538bfd247a0d217a503a1552bdbab08", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/fe74da8ea538bfd247a0d217a503a1552bdbab08", "committedDate": "2020-11-12T21:38:25Z", "message": "Require cwltool tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "223a4b65822fbf5035c51f2873d23c5ac7c1e61a", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/223a4b65822fbf5035c51f2873d23c5ac7c1e61a", "committedDate": "2020-11-12T22:32:24Z", "message": "Add Travis back and cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NTc2OTQ0", "url": "https://github.com/dockstore/dockstore/pull/3927#pullrequestreview-529576944", "createdAt": "2020-11-12T23:14:02Z", "commit": {"oid": "223a4b65822fbf5035c51f2873d23c5ac7c1e61a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMzoxNDowMlrOHySi8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwMDowNzozMVrOHyUENg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ5NDcwNg==", "bodyText": "We're on 11.8 in prod, but not crucial", "url": "https://github.com/dockstore/dockstore/pull/3927#discussion_r522494706", "createdAt": "2020-11-12T23:14:02Z", "author": {"login": "coverbeck"}, "path": ".circleci/config.yml", "diffHunk": "@@ -1,30 +1,118 @@\n-version: 2\n+version: 2.1\n+executors:\n+  integration_test_exec:\n+    docker: # run the steps with Docker\n+      - image: cimg/openjdk:11.0.8\n+        environment:\n+          PGHOST: 127.0.0.1\n+      - image: circleci/postgres:11.6", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "223a4b65822fbf5035c51f2873d23c5ac7c1e61a"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUxODgyNw==", "bodyText": "Does this always work? I guess so... I found out the hard way that I couldn't run on my Mac unless I added\n   ulimits:\n     memlock:\n      soft: -1\n      hard: -1\n\nBut maybe it's because I'm on a Mac.", "url": "https://github.com/dockstore/dockstore/pull/3927#discussion_r522518827", "createdAt": "2020-11-13T00:04:57Z", "author": {"login": "coverbeck"}, "path": ".circleci/config.yml", "diffHunk": "@@ -1,30 +1,118 @@\n-version: 2\n+version: 2.1\n+executors:\n+  integration_test_exec:\n+    docker: # run the steps with Docker\n+      - image: cimg/openjdk:11.0.8\n+        environment:\n+          PGHOST: 127.0.0.1\n+      - image: circleci/postgres:11.6\n+        environment:\n+          POSTGRES_USER: postgres\n+          POSTGRES_DB: postgres\n+          PG_HOST: localhost\n+          POSTGRES_HOST_AUTH_METHOD: trust\n+          POSTGRES_PASSWORD: postgres\n+      - image: docker.elastic.co/elasticsearch/elasticsearch:6.8.3\n+        environment:\n+          - xpack.security.enabled: false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "223a4b65822fbf5035c51f2873d23c5ac7c1e61a"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUxOTYwNg==", "bodyText": "Postgress 11? Or is there a reason you left it on 9?", "url": "https://github.com/dockstore/dockstore/pull/3927#discussion_r522519606", "createdAt": "2020-11-13T00:07:31Z", "author": {"login": "coverbeck"}, "path": ".circleci/config.yml", "diffHunk": "@@ -39,71 +127,61 @@ jobs:\n             cd git-secrets-1.3.0\n             sudo make install\n       - run:\n-          name: run the actual tests\n-          command: mvn -B clean install -DskipTests\n-      - run:\n-          name: validate openapi\n+          name: decrypt\n           command: |\n-            wget --no-verbose https://repo.maven.apache.org/maven2/org/openapitools/openapi-generator-cli/4.3.0/openapi-generator-cli-4.3.0.jar -O openapi-generator-cli.jar\n-            java -jar openapi-generator-cli.jar validate -i dockstore-webservice/src/main/resources/swagger.yaml\n-            java -jar openapi-generator-cli.jar validate -i dockstore-webservice/src/main/resources/openapi3/openapi.yaml\n+            sudo apt install openssl -y\n+            openssl aes-256-cbc -d -in circle_ci_test_data.zip.enc -k $CIRCLE_CI_KEY -iv $CIRCLE_CI_IV >> test_data.zip\n+            bash expand_confidential_bundle.sh test_data.zip abandonDatabaseConnectionsWithOrcid\n+      - run:\n+          name: build\n+          command: mvn -B clean install -DskipTests\n+      # - run:\n+      #     name: validate openapi\n+      #     command: |\n+      #       wget --no-verbose https://repo.maven.apache.org/maven2/org/openapitools/openapi-generator-cli/4.3.0/openapi-generator-cli-4.3.0.jar -O openapi-generator-cli.jar\n+      #       java -jar openapi-generator-cli.jar validate -i dockstore-webservice/src/main/resources/swagger.yaml\n+      #       java -jar openapi-generator-cli.jar validate -i dockstore-webservice/src/main/resources/openapi3/openapi.yaml\n   unit_test: # runs not using Workflows must have a `build` job as entry point\n     docker: # run the steps with Docker\n-      - image: circleci/openjdk:11.0.4-jdk-stretch\n+      - image: cimg/openjdk:11.0.8\n         environment:\n           JAVA_TOOL_OPTIONS: -Xmx512m # Java can read cgroup. Sadly the cgroup in CircleCI is wrong. Have to manually set. Nothing to do with surefire plugin, it has its own JVM. The two of these must add up to a bit less than 4GB.\n           PGHOST: 127.0.0.1\n-      - image: circleci/postgres:9.6.5-alpine-ram\n+      - image: circleci/postgres:9.6.19", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "223a4b65822fbf5035c51f2873d23c5ac7c1e61a"}, "originalPosition": 163}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5ODEyMzQy", "url": "https://github.com/dockstore/dockstore/pull/3927#pullrequestreview-529812342", "createdAt": "2020-11-13T06:56:20Z", "commit": {"oid": "223a4b65822fbf5035c51f2873d23c5ac7c1e61a"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMTYwMTIw", "url": "https://github.com/dockstore/dockstore/pull/3927#pullrequestreview-530160120", "createdAt": "2020-11-13T15:31:38Z", "commit": {"oid": "223a4b65822fbf5035c51f2873d23c5ac7c1e61a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNTozMTozOVrOHyy8kQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNTozMTozOVrOHyy8kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAyNTU1Mw==", "bodyText": "non-confidential integration tests are running as part of the unit_test job", "url": "https://github.com/dockstore/dockstore/pull/3927#discussion_r523025553", "createdAt": "2020-11-13T15:31:39Z", "author": {"login": "denis-yuen"}, "path": ".circleci/config.yml", "diffHunk": "@@ -39,71 +127,61 @@ jobs:\n             cd git-secrets-1.3.0\n             sudo make install\n       - run:\n-          name: run the actual tests\n-          command: mvn -B clean install -DskipTests\n-      - run:\n-          name: validate openapi\n+          name: decrypt\n           command: |\n-            wget --no-verbose https://repo.maven.apache.org/maven2/org/openapitools/openapi-generator-cli/4.3.0/openapi-generator-cli-4.3.0.jar -O openapi-generator-cli.jar\n-            java -jar openapi-generator-cli.jar validate -i dockstore-webservice/src/main/resources/swagger.yaml\n-            java -jar openapi-generator-cli.jar validate -i dockstore-webservice/src/main/resources/openapi3/openapi.yaml\n+            sudo apt install openssl -y\n+            openssl aes-256-cbc -d -in circle_ci_test_data.zip.enc -k $CIRCLE_CI_KEY -iv $CIRCLE_CI_IV >> test_data.zip\n+            bash expand_confidential_bundle.sh test_data.zip abandonDatabaseConnectionsWithOrcid\n+      - run:\n+          name: build\n+          command: mvn -B clean install -DskipTests\n+      # - run:\n+      #     name: validate openapi\n+      #     command: |\n+      #       wget --no-verbose https://repo.maven.apache.org/maven2/org/openapitools/openapi-generator-cli/4.3.0/openapi-generator-cli-4.3.0.jar -O openapi-generator-cli.jar\n+      #       java -jar openapi-generator-cli.jar validate -i dockstore-webservice/src/main/resources/swagger.yaml\n+      #       java -jar openapi-generator-cli.jar validate -i dockstore-webservice/src/main/resources/openapi3/openapi.yaml\n   unit_test: # runs not using Workflows must have a `build` job as entry point\n     docker: # run the steps with Docker\n-      - image: circleci/openjdk:11.0.4-jdk-stretch\n+      - image: cimg/openjdk:11.0.8\n         environment:\n           JAVA_TOOL_OPTIONS: -Xmx512m # Java can read cgroup. Sadly the cgroup in CircleCI is wrong. Have to manually set. Nothing to do with surefire plugin, it has its own JVM. The two of these must add up to a bit less than 4GB.\n           PGHOST: 127.0.0.1\n-      - image: circleci/postgres:9.6.5-alpine-ram\n+      - image: circleci/postgres:9.6.19\n         environment:\n           POSTGRES_USER: postgres\n           POSTGRES_DB: postgres\n+          POSTGRES_HOST_AUTH_METHOD: trust\n+          POSTGRES_PASSWORD: postgres   \n     steps: # a collection of executable commands\n-      - checkout # check out source code to working directory\n-      - restore_cache: # restore the saved cache after the first run or if `pom.xml` has changed\n-          # Read about caching dependencies: https://circleci.com/docs/2.0/caching/\n-          key: dockstore-java-{{ checksum \"pom.xml\" }}\n-      - run:\n-          name: install dockerize\n-          command: wget https://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz && sudo tar -C /usr/local/bin -xzvf dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz && rm dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz\n-          environment:\n-            DOCKERIZE_VERSION: v0.3.0\n-      - run: \n-          name: Install yq\n-          command: |\n-            wget https://github.com/mikefarah/yq/releases/download/3.3.2/yq_linux_amd64\n-            chmod a+x yq_linux_amd64\n-            sudo mv yq_linux_amd64 /usr/bin/yq\n+      - checkout    \n+      - setup_test\n       - run:\n           name: Install git-secrets\n           command: |\n             wget --no-verbose -O git-secrets-1.3.0.tar.gz https://github.com/awslabs/git-secrets/archive/1.3.0.tar.gz\n             tar -zxf git-secrets-1.3.0.tar.gz\n             cd git-secrets-1.3.0\n             sudo make install\n-      - run:\n-          name: Wait for db\n-          command: dockerize -wait tcp://localhost:5432 -timeout 1m\n       - run:\n           name: Install postgresql client\n           command: |\n             sudo rm -rf /var/lib/apt/lists/*\n             sudo apt update\n             sudo apt install -y postgresql-client\n-      - run:\n-          name: setup postgres\n-          command: |\n-            psql -c \"create user dockstore with password 'dockstore' createdb;\" -U postgres\n-            psql -c \"ALTER USER dockstore WITH superuser;\" -U postgres\n-            psql -c 'create database webservice_test with owner = dockstore;' -U postgres\n+      - setup_postgres\n       - run:\n           name: run the actual tests\n-          command: mvn -B clean install -Punit-tests -ntp\n+          command: mvn -B org.jacoco:jacoco-maven-plugin:report org.jacoco:jacoco-maven-plugin:report-aggregate clean install -Punit-tests,coverage -ntp\n       - run:\n           name: run the non-confidential integration tests", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "223a4b65822fbf5035c51f2873d23c5ac7c1e61a"}, "originalPosition": 215}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMjgyNjI5", "url": "https://github.com/dockstore/dockstore/pull/3927#pullrequestreview-530282629", "createdAt": "2020-11-13T17:53:48Z", "commit": {"oid": "223a4b65822fbf5035c51f2873d23c5ac7c1e61a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02c29726f28c5ba10ee8066d69431d3f8d35f49d", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/02c29726f28c5ba10ee8066d69431d3f8d35f49d", "committedDate": "2020-11-13T18:16:52Z", "message": "Merge branch 'develop' into feature/3917/TravisToCircleCI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "284dc22671c0dcc6309b9a5ba958bee5fd95734b", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/284dc22671c0dcc6309b9a5ba958bee5fd95734b", "committedDate": "2020-11-13T18:17:52Z", "message": "Rename test so it hopefully runs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbe3b5195ff4fb328fa178e17db8a847c631818b", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/cbe3b5195ff4fb328fa178e17db8a847c631818b", "committedDate": "2020-11-13T18:18:18Z", "message": "Hopefully disable coveralls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d422b45cc8f99344ba36f0dd3cbdf3aafb1770af", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/d422b45cc8f99344ba36f0dd3cbdf3aafb1770af", "committedDate": "2020-11-13T20:13:29Z", "message": "Use confidential bundle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0e03288c339446dad4cc57de3fd4043d3424a1a", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/f0e03288c339446dad4cc57de3fd4043d3424a1a", "committedDate": "2020-11-13T20:59:05Z", "message": "Fix another test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDYwNjI4", "url": "https://github.com/dockstore/dockstore/pull/3927#pullrequestreview-530460628", "createdAt": "2020-11-13T22:36:36Z", "commit": {"oid": "f0e03288c339446dad4cc57de3fd4043d3424a1a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1621, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}