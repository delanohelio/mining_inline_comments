{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4Mzk3NjI5", "number": 3376, "title": "Display ORCID for organization members", "bodyText": "", "createdAt": "2020-04-03T21:36:16Z", "url": "https://github.com/dockstore/dockstore/pull/3376", "merged": true, "mergeCommit": {"oid": "dcf7debaa553b990e2e3c7902c048a2c55bbc95b"}, "closed": true, "closedAt": "2020-04-08T18:52:58Z", "author": {"login": "emlys"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUEJOkAH2gAyMzk4Mzk3NjI5Ojk1ODg2OGEyZmQ3N2M0ZjcwZTEyNzQ4ZjFiMjkzM2NlNDJlMzY3MzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVsbEigFqTM5MDIzNzM2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "958868a2fd77c4f70e12748f1b2933ce42e36731", "author": {"user": {"login": "emlys", "name": "Emily Soth"}}, "url": "https://github.com/dockstore/dockstore/commit/958868a2fd77c4f70e12748f1b2933ce42e36731", "committedDate": "2020-04-03T17:14:16Z", "message": "#3371 store user ORCID in enduser table when linked"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d475d92618e4728db86b0dbbdb183e21bb5afe2c", "author": {"user": {"login": "emlys", "name": "Emily Soth"}}, "url": "https://github.com/dockstore/dockstore/commit/d475d92618e4728db86b0dbbdb183e21bb5afe2c", "committedDate": "2020-04-03T18:30:31Z", "message": "add new API yamls so I can run the UI using this branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59d2d0a809c2c40367d2fc2756df64d9a15c2b2f", "author": {"user": {"login": "emlys", "name": "Emily Soth"}}, "url": "https://github.com/dockstore/dockstore/commit/59d2d0a809c2c40367d2fc2756df64d9a15c2b2f", "committedDate": "2020-04-03T20:31:42Z", "message": "persist to database working"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3f9296ca6e84cf4bda3d743fd5c282666bbd64d", "author": {"user": {"login": "emlys", "name": "Emily Soth"}}, "url": "https://github.com/dockstore/dockstore/commit/c3f9296ca6e84cf4bda3d743fd5c282666bbd64d", "committedDate": "2020-04-03T21:31:27Z", "message": "store ORCID in user profile as well"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NTk2MTE1", "url": "https://github.com/dockstore/dockstore/pull/3376#pullrequestreview-387596115", "createdAt": "2020-04-03T21:38:43Z", "commit": {"oid": "c3f9296ca6e84cf4bda3d743fd5c282666bbd64d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMTozODo0M1rOGAqerg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMTozODo0M1rOGAqerg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM0OTE2Ng==", "bodyText": "Included two possible solutions here. First is adding an ORCID column to the enduser table and storing it there. Second is storing it in a user profile.", "url": "https://github.com/dockstore/dockstore/pull/3376#discussion_r403349166", "createdAt": "2020-04-03T21:38:43Z", "author": {"login": "emlys"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/TokenResource.java", "diffHunk": "@@ -658,15 +659,29 @@ public Token addOrcidToken(@ApiParam(hidden = true) @Parameter(hidden = true, na\n             accessToken = tokenResponse.getAccessToken();\n             refreshToken = tokenResponse.getRefreshToken();\n \n-            // ORCID API returns the user's ORCID username in the \"name\" property\n+            // ORCID API returns the username and orcid id along with the tokens\n+            // get them to store in the token and user tables\n             username = tokenResponse.get(\"name\").toString();\n+            orcid = tokenResponse.get(\"orcid\").toString();\n \n         } catch (IOException e) {\n             LOG.error(\"Retrieving accessToken was unsuccessful\" + e.getMessage());\n             throw new CustomWebApplicationException(e.getMessage(), HttpStatus.SC_BAD_REQUEST);\n         }\n \n         if (user != null) {\n+            // save the ORCID to the enduser table", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3f9296ca6e84cf4bda3d743fd5c282666bbd64d"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e5a079067e5e4cc4680945b9cdec25e2cdb2e16", "author": {"user": {"login": "emlys", "name": "Emily Soth"}}, "url": "https://github.com/dockstore/dockstore/commit/2e5a079067e5e4cc4680945b9cdec25e2cdb2e16", "committedDate": "2020-04-03T21:49:54Z", "message": "Merge branch 'develop' into feature/organizations-orcid"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NjQ1NzA3", "url": "https://github.com/dockstore/dockstore/pull/3376#pullrequestreview-387645707", "createdAt": "2020-04-04T00:33:11Z", "commit": {"oid": "2e5a079067e5e4cc4680945b9cdec25e2cdb2e16"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQwMDozMzoxMVrOGAtWGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQwMDozMzoxMVrOGAtWGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM5NjEyMg==", "bodyText": "Was like this, but log the exception", "url": "https://github.com/dockstore/dockstore/pull/3376#discussion_r403396122", "createdAt": "2020-04-04T00:33:11Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/TokenResource.java", "diffHunk": "@@ -658,15 +659,29 @@ public Token addOrcidToken(@ApiParam(hidden = true) @Parameter(hidden = true, na\n             accessToken = tokenResponse.getAccessToken();\n             refreshToken = tokenResponse.getRefreshToken();\n \n-            // ORCID API returns the user's ORCID username in the \"name\" property\n+            // ORCID API returns the username and orcid id along with the tokens\n+            // get them to store in the token and user tables\n             username = tokenResponse.get(\"name\").toString();\n+            orcid = tokenResponse.get(\"orcid\").toString();\n \n         } catch (IOException e) {\n             LOG.error(\"Retrieving accessToken was unsuccessful\" + e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e5a079067e5e4cc4680945b9cdec25e2cdb2e16"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MzMzMzMy", "url": "https://github.com/dockstore/dockstore/pull/3376#pullrequestreview-388333332", "createdAt": "2020-04-06T14:56:17Z", "commit": {"oid": "2e5a079067e5e4cc4680945b9cdec25e2cdb2e16"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c698904f0c040fc26f098d992b7090e5ff782910", "author": {"user": {"login": "emlys", "name": "Emily Soth"}}, "url": "https://github.com/dockstore/dockstore/commit/c698904f0c040fc26f098d992b7090e5ff782910", "committedDate": "2020-04-06T19:59:50Z", "message": "delete ORCID id when token is deleted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0aa24bb64e4b9c6a937d821de9e7d164e3d497f", "author": {"user": {"login": "emlys", "name": "Emily Soth"}}, "url": "https://github.com/dockstore/dockstore/commit/e0aa24bb64e4b9c6a937d821de9e7d164e3d497f", "committedDate": "2020-04-06T20:00:18Z", "message": "Merge branch 'feature/organizations-orcid' of https://github.com/dockstore/dockstore into feature/organizations-orcid"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f2e975f50fab8e2001c0854986ad31e31a1bcb8", "author": {"user": {"login": "emlys", "name": "Emily Soth"}}, "url": "https://github.com/dockstore/dockstore/commit/3f2e975f50fab8e2001c0854986ad31e31a1bcb8", "committedDate": "2020-04-06T21:00:32Z", "message": "cleanup, generated changeset"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NjE1OTQ3", "url": "https://github.com/dockstore/dockstore/pull/3376#pullrequestreview-388615947", "createdAt": "2020-04-06T21:04:33Z", "commit": {"oid": "3f2e975f50fab8e2001c0854986ad31e31a1bcb8"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMTowNDozM1rOGBp1zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMTowNzo0MFrOGBp70g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM4NzI3OQ==", "bodyText": "was better with a descriptive id (used when debugging migrations in a live instance)", "url": "https://github.com/dockstore/dockstore/pull/3376#discussion_r404387279", "createdAt": "2020-04-06T21:04:33Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/resources/migrations.1.9.0.xml", "diffHunk": "@@ -97,4 +97,10 @@\n             <column name=\"os\" type=\"varchar(255 BYTE)\"/>\n         </addColumn>\n     </changeSet>\n+\n+    <changeSet author=\"esoth (generated)\" id=\"1586206601202-8\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f2e975f50fab8e2001c0854986ad31e31a1bcb8"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM4ODgxOA==", "bodyText": "No real performance difference gain when using length-constrained column.\nUnlikely to be attack vector either\nSee tip https://www.postgresql.org/docs/9.3/datatype-character.html", "url": "https://github.com/dockstore/dockstore/pull/3376#discussion_r404388818", "createdAt": "2020-04-06T21:07:40Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/resources/migrations.1.9.0.xml", "diffHunk": "@@ -97,4 +97,10 @@\n             <column name=\"os\" type=\"varchar(255 BYTE)\"/>\n         </addColumn>\n     </changeSet>\n+\n+    <changeSet author=\"esoth (generated)\" id=\"1586206601202-8\">\n+        <addColumn tableName=\"enduser\">\n+            <column name=\"orcid\" type=\"varchar(255 BYTE)\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f2e975f50fab8e2001c0854986ad31e31a1bcb8"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b071a2c1c53e5b383e797ea63210c53f521efb7", "author": {"user": {"login": "emlys", "name": "Emily Soth"}}, "url": "https://github.com/dockstore/dockstore/commit/5b071a2c1c53e5b383e797ea63210c53f521efb7", "committedDate": "2020-04-06T21:12:43Z", "message": "descriptive id for changeset"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzgyNTg4", "url": "https://github.com/dockstore/dockstore/pull/3376#pullrequestreview-388782588", "createdAt": "2020-04-07T04:54:18Z", "commit": {"oid": "5b071a2c1c53e5b383e797ea63210c53f521efb7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNDo1NDoxOFrOGBy0Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNDo1NDoxOFrOGBy0Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDUzNDMxMA==", "bodyText": "I think this should be null, not an empty string.", "url": "https://github.com/dockstore/dockstore/pull/3376#discussion_r404534310", "createdAt": "2020-04-07T04:54:18Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/TokenResource.java", "diffHunk": "@@ -237,6 +237,12 @@ public Response deleteToken(@ApiParam(hidden = true) @Auth User user,\n \n         tokenDAO.delete(token);\n \n+        // also erase the user's ORCID id if deleting an ORCID token\n+        if (token.getTokenSource() == TokenType.ORCID_ORG) {\n+            User byId = userDAO.findById(user.getId());\n+            byId.setOrcid(\"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b071a2c1c53e5b383e797ea63210c53f521efb7"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46837396eed9d65326b71a6c075c14ad1065e819", "author": {"user": {"login": "emlys", "name": "Emily Soth"}}, "url": "https://github.com/dockstore/dockstore/commit/46837396eed9d65326b71a6c075c14ad1065e819", "committedDate": "2020-04-08T16:12:24Z", "message": "set user orcid to null when token is deleted"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMjE5ODg3", "url": "https://github.com/dockstore/dockstore/pull/3376#pullrequestreview-390219887", "createdAt": "2020-04-08T18:20:01Z", "commit": {"oid": "46837396eed9d65326b71a6c075c14ad1065e819"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMjM3MzY1", "url": "https://github.com/dockstore/dockstore/pull/3376#pullrequestreview-390237365", "createdAt": "2020-04-08T18:43:53Z", "commit": {"oid": "46837396eed9d65326b71a6c075c14ad1065e819"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1832, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}