{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0MzI5MTU5", "number": 3988, "title": "Run regression tests on CircleCI machine instance type", "bodyText": "Main issue: #3958\nOur CircleCI tests up until now run on Circle's Docker instances. This leads to issues with CLI tests which end up running Docker (Docker-in-Docker situation).\nThis PR adds the machine_integration_test_exec executor (using an Ubuntu 20.04 image) and the setup_machine command (using docker-compose) to our Circle config.\nAdditionally, since Ubuntu defaults to Python 3.8 and our old Pip dependencies for regression tests need Python 3.6, the old_python command sets up a Python virtual environment with 3.6.\nSee that regression tests and everything else succeeds here: https://app.circleci.com/pipelines/github/dockstore/dockstore/5140/workflows/322e417b-eb0b-4eac-b725-461f4b585bba\nFurther reading on Executor types: https://circleci.com/docs/2.0/executor-types/\nExtra Discussion:\nIn theory, we could use this to run any of our integration test jobs on machine instances using machine_integration_test_exec and running setup_machine before setup_test. The main cost of using machine instances instead of Docker is the overhead of manually spinning up Docker containers within the machine-job, rather than Circle CI doing its Docker-magic (but also this is a thing: https://circleci.com/docs/2.0/docker-layer-caching/).", "createdAt": "2020-12-22T19:46:29Z", "url": "https://github.com/dockstore/dockstore/pull/3988", "merged": true, "mergeCommit": {"oid": "65906945181649826d369d3a07a2198265aaeaa6"}, "closed": true, "closedAt": "2020-12-23T16:21:43Z", "author": {"login": "GFJHogue"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdoZlANgH2gAyNTQ0MzI5MTU5OmFlMWViYTA5NTIzYzI2ZDU3NGJlNmM3Y2Y2YmUyYTE3OTEzMjI4ZjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdpBFN4AFqTU1Nzk4MzU2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ae1eba09523c26d574be6c7cf6be2a17913228f5", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/ae1eba09523c26d574be6c7cf6be2a17913228f5", "committedDate": "2020-12-21T17:42:15Z", "message": "running CircleCI with machine (test)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d44b440b003d8c7a417d9c635ca53b8b009d1cb4", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/d44b440b003d8c7a417d9c635ca53b8b009d1cb4", "committedDate": "2020-12-21T18:13:32Z", "message": "check for java/mvn circle-machine defaults"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ed37977f69ec88f29b55dd30834b6f8732f720b", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/4ed37977f69ec88f29b55dd30834b6f8732f720b", "committedDate": "2020-12-21T18:46:41Z", "message": "try psql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbf23fa8a263816c31aba18db71b7312b7a4aa3a", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/dbf23fa8a263816c31aba18db71b7312b7a4aa3a", "committedDate": "2020-12-21T19:59:38Z", "message": "try using docker-compose for PSQL & ES"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf3818298f93296133985a8e7a2c9a606824df11", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/bf3818298f93296133985a8e7a2c9a606824df11", "committedDate": "2020-12-21T20:37:08Z", "message": "log versions and try Ubuntu 16 image"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaf03695ec984770fed9279402ddf4f146afbda8", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/aaf03695ec984770fed9279402ddf4f146afbda8", "committedDate": "2020-12-21T21:04:29Z", "message": "Ubuntu 20; try using Python 3.6 in venv"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8a4181167583d737d9d75ada39ee08be273ea6a", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/c8a4181167583d737d9d75ada39ee08be273ea6a", "committedDate": "2020-12-21T21:13:45Z", "message": "forgot to run old_python"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86e044bc2f33c5bf3b0134abbb2cda2d0a240ac4", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/86e044bc2f33c5bf3b0134abbb2cda2d0a240ac4", "committedDate": "2020-12-21T21:31:46Z", "message": "try using .bashrc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61bdabd5e35e3c0843a7968887f440ca566eaf67", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/61bdabd5e35e3c0843a7968887f440ca566eaf67", "committedDate": "2020-12-21T21:44:46Z", "message": "can't use `pip --user ...` in venv"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "909fd3e2eff68a344f98bf0f83b00a8eeaf3b474", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/909fd3e2eff68a344f98bf0f83b00a8eeaf3b474", "committedDate": "2020-12-21T21:59:37Z", "message": "include Python 3.6 headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "578b4a57b8b62c391d131113ede7f52894b9263f", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/578b4a57b8b62c391d131113ede7f52894b9263f", "committedDate": "2020-12-21T22:23:08Z", "message": "log psql container info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27da22b80b735046890b2f468226db26924dde3d", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/27da22b80b735046890b2f468226db26924dde3d", "committedDate": "2020-12-22T15:53:03Z", "message": "try using iptables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e860bdb31d454da998b0d328237e8ad38df88d7", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/6e860bdb31d454da998b0d328237e8ad38df88d7", "committedDate": "2020-12-22T16:01:15Z", "message": "try again - no iptables for now"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bcc83e50386c5bee254ba670e678347be236523", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/0bcc83e50386c5bee254ba670e678347be236523", "committedDate": "2020-12-22T16:19:21Z", "message": "try docker-postgres 11.10"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a060f1724d89394f28143a31c955a18c40bfa7bb", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/a060f1724d89394f28143a31c955a18c40bfa7bb", "committedDate": "2020-12-22T16:34:56Z", "message": "try psql 11.6 ; debug container"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bf514eb3eed69b680e6e4ee15d2f05c38fd4b5c", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/3bf514eb3eed69b680e6e4ee15d2f05c38fd4b5c", "committedDate": "2020-12-22T16:52:23Z", "message": "I think I found a bug with some postgres images"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ca415b868fa5ec377e9fd103cdcadaf9608d224", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/8ca415b868fa5ec377e9fd103cdcadaf9608d224", "committedDate": "2020-12-22T17:20:53Z", "message": "set postgres auth (that was my problem)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65b157782c588c0de125db48278aa6c3bdb2d2d5", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/65b157782c588c0de125db48278aa6c3bdb2d2d5", "committedDate": "2020-12-22T18:13:42Z", "message": "verify all tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72a5b656c1b7b323822d9d5365364be90b630748", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/72a5b656c1b7b323822d9d5365364be90b630748", "committedDate": "2020-12-22T19:13:22Z", "message": "filter regression-tests to master & releases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9b78e0ee7f764b25fb6c99c2e2d688134a67a6f", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/f9b78e0ee7f764b25fb6c99c2e2d688134a67a6f", "committedDate": "2020-12-22T19:20:08Z", "message": "remove regression test from travis"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MzU3NDIw", "url": "https://github.com/dockstore/dockstore/pull/3988#pullrequestreview-557357420", "createdAt": "2020-12-22T20:46:52Z", "commit": {"oid": "f9b78e0ee7f764b25fb6c99c2e2d688134a67a6f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQyMDo0Njo1MlrOIKIvjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQyMDo0Njo1MlrOIKIvjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ5OTkxOQ==", "bodyText": "I established at release post-mortem that I don't know regression tests that well, but I thought the idea of the regression tests was to test the previous CLI version with the current web service. So shouldn't this be 1.9?", "url": "https://github.com/dockstore/dockstore/pull/3988#discussion_r547499919", "createdAt": "2020-12-22T20:46:52Z", "author": {"login": "coverbeck"}, "path": ".circleci/config.yml", "diffHunk": "@@ -250,6 +266,29 @@ commands:\n           command: |\n             psql -c \"create user dockstore with password 'dockstore' createdb;\" -U postgres\n             psql -c 'create database webservice_test with owner = dockstore;' -U postgres\n+  old_python: # Need Python 3.6 for old Dockstore 1.7 requirements.txt", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9b78e0ee7f764b25fb6c99c2e2d688134a67a6f"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3Mzc5ODE4", "url": "https://github.com/dockstore/dockstore/pull/3988#pullrequestreview-557379818", "createdAt": "2020-12-22T21:34:53Z", "commit": {"oid": "f9b78e0ee7f764b25fb6c99c2e2d688134a67a6f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3Mzg4MDc1", "url": "https://github.com/dockstore/dockstore/pull/3988#pullrequestreview-557388075", "createdAt": "2020-12-22T21:53:43Z", "commit": {"oid": "f9b78e0ee7f764b25fb6c99c2e2d688134a67a6f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3OTgzNTY4", "url": "https://github.com/dockstore/dockstore/pull/3988#pullrequestreview-557983568", "createdAt": "2020-12-23T15:39:21Z", "commit": {"oid": "f9b78e0ee7f764b25fb6c99c2e2d688134a67a6f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNTozOToyMVrOIKoYgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNTo0MjoyM1rOIKodiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODAxODMwNQ==", "bodyText": "Confirm that machine_integration_test_exec means that only this job incurs the extra cost of running within a VM", "url": "https://github.com/dockstore/dockstore/pull/3988#discussion_r548018305", "createdAt": "2020-12-23T15:39:21Z", "author": {"login": "denis-yuen"}, "path": ".circleci/config.yml", "diffHunk": "@@ -53,12 +59,22 @@ workflows:\n           <<: *common_filters\n           requires:\n             - build\n+      - regression-integration-tests:\n+          filters:\n+            branches:\n+              only:\n+                - master\n+                - /^release.*$/\n+          requires:\n+            - build\n jobs:\n   regression-integration-tests:\n-    executor: integration_test_exec\n+    executor: machine_integration_test_exec", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9b78e0ee7f764b25fb6c99c2e2d688134a67a6f"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODAxOTU5NQ==", "bodyText": "This is a bit remarkable, only two developers for distributing Python on Ubuntu?\nhttps://github.com/deadsnakes\nWonder if there is a more popular way, maybe snap?", "url": "https://github.com/dockstore/dockstore/pull/3988#discussion_r548019595", "createdAt": "2020-12-23T15:42:23Z", "author": {"login": "denis-yuen"}, "path": ".circleci/config.yml", "diffHunk": "@@ -250,6 +266,29 @@ commands:\n           command: |\n             psql -c \"create user dockstore with password 'dockstore' createdb;\" -U postgres\n             psql -c 'create database webservice_test with owner = dockstore;' -U postgres\n+  old_python: # Need Python 3.6 for old Dockstore 1.7 requirements.txt\n+    steps:\n+      - run:\n+          name: Install & use Python 3.6\n+          command: |\n+            sudo add-apt-repository ppa:deadsnakes/ppa", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9b78e0ee7f764b25fb6c99c2e2d688134a67a6f"}, "originalPosition": 64}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1661, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}