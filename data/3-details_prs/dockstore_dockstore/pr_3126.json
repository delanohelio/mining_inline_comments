{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNTUzNzY4", "number": 3126, "title": "Feature/2803/version metadata update", "bodyText": "#2803 wasn't quite working. It worked for new tags/versions, but not old ones", "createdAt": "2020-01-10T17:36:38Z", "url": "https://github.com/dockstore/dockstore/pull/3126", "merged": true, "mergeCommit": {"oid": "e0e9cb5124c2009a05b1965419f7893cdc5515cf"}, "closed": true, "closedAt": "2020-01-13T18:08:48Z", "author": {"login": "garyluu"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5CIleAH2gAyMzYxNTUzNzY4OmU2MmJmNzVkZThkN2E4YmZmZDkyNjhmZDBiMDE4OWE0NjY3NmYyZjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb5-4CWAFqTM0MTk2Njk2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e62bf75de8d7a8bffd9268fd0b0189a46676f2f2", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/e62bf75de8d7a8bffd9268fd0b0189a46676f2f2", "committedDate": "2020-01-10T17:37:48Z", "message": "Fix for updating version metadata when it already exists"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e252c435165090d11c22d730894d6799e1fc54d", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/0e252c435165090d11c22d730894d6799e1fc54d", "committedDate": "2020-01-10T17:37:48Z", "message": "Update test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d3de1521355fa02d34b90ca1db35da61512d3f5", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/0d3de1521355fa02d34b90ca1db35da61512d3f5", "committedDate": "2020-01-10T17:34:38Z", "message": "Update test"}, "afterCommit": {"oid": "0e252c435165090d11c22d730894d6799e1fc54d", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/0e252c435165090d11c22d730894d6799e1fc54d", "committedDate": "2020-01-10T17:37:48Z", "message": "Update test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNDM2NDM3", "url": "https://github.com/dockstore/dockstore/pull/3126#pullrequestreview-341436437", "createdAt": "2020-01-10T21:39:16Z", "commit": {"oid": "0e252c435165090d11c22d730894d6799e1fc54d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNDUyMTA4", "url": "https://github.com/dockstore/dockstore/pull/3126#pullrequestreview-341452108", "createdAt": "2020-01-10T22:17:25Z", "commit": {"oid": "0e252c435165090d11c22d730894d6799e1fc54d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQyMjoxNzoyNVrOFchdGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQyMjoxNzoyNVrOFchdGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ1MjU3MQ==", "bodyText": "Would this just pass if there was no workflow with a name of v1.0?", "url": "https://github.com/dockstore/dockstore/pull/3126#discussion_r365452571", "createdAt": "2020-01-10T22:17:25Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/ExtendedNextflowIT.java", "diffHunk": "@@ -110,15 +110,39 @@ public void testBitbucketNextflowWorkflow() throws Exception {\n         workflowByPathBitbucket.setWorkflowPath(\"/nextflow.config\");\n         workflowByPathBitbucket.setDescriptorType(Workflow.DescriptorTypeEnum.NFL);\n         workflowApi.updateWorkflow(workflowByPathBitbucket.getId(), workflowByPathBitbucket);\n-        final String partialReadmeDescription = \"AMPA-NF is a pipeline for assessing the antimicrobial domains of proteins,\";\n-        final String descriptorDescription = \"Fast automated prediction of protein antimicrobial regions\";\n         workflowByPathBitbucket = workflowApi.getWorkflowByPath(DOCKSTORE_TEST_USER_NEXTFLOW_BITBUCKET_WORKFLOW, null, false);\n         final Workflow bitbucketWorkflow = workflowApi.refresh(workflowByPathBitbucket.getId());\n+        Workflow byPathWorkflow = workflowApi.getWorkflowByPath(DOCKSTORE_TEST_USER_NEXTFLOW_BITBUCKET_WORKFLOW, null, false);\n         // There are 3 versions: master, v1.0, and v2.0\n         // master and v2.0 has a nextflow.config file that has description and author, v1.0 does not\n         // v1.0 will pull description from README instead but the others will use nextflow.config\n-        Assert.assertEquals(descriptorDescription, bitbucketWorkflow.getDescription());\n-        bitbucketWorkflow.getWorkflowVersions().forEach(workflowVersion -> {\n+        testWorkflowVersionMetadata(bitbucketWorkflow);\n+        testWorkflowVersionMetadata(byPathWorkflow);\n+        // Purposely mess up the metadata to test if it can be updated through refresh\n+        testingPostgres.runUpdateStatement(\"update version_metadata set email='bad_potato'\");\n+        testingPostgres.runUpdateStatement(\"update version_metadata set author='bad_potato'\");\n+        testingPostgres.runUpdateStatement(\"update version_metadata set description='bad_potato'\");\n+        final Workflow refreshedBitbucketWorkflow = workflowApi.refresh(workflowByPathBitbucket.getId());\n+        byPathWorkflow = workflowApi.getWorkflowByPath(DOCKSTORE_TEST_USER_NEXTFLOW_BITBUCKET_WORKFLOW, null, false);\n+        // This tests if it can fix outdated metadata\n+        testWorkflowVersionMetadata(refreshedBitbucketWorkflow);\n+        testWorkflowVersionMetadata(byPathWorkflow);\n+        List<SourceFile> sourceFileList = new ArrayList<>(\n+            bitbucketWorkflow.getWorkflowVersions().stream().filter(version -> version.getName().equals(\"v2.0\")).findFirst().get()\n+                .getSourceFiles());\n+        Assert.assertEquals(4, sourceFileList.size());\n+    }\n+\n+    /**\n+     * This tests the DOCKSTORE_TEST_USER_NEXTFLOW_BITBUCKET_WORKFLOW metadata is correct after a refresh\n+     * @param workflow  The DOCKSTORE_TEST_USER_NEXTFLOW_BITBUCKET_WORKFLOW workflow\n+     */\n+    private void testWorkflowVersionMetadata(Workflow workflow) {\n+        final String partialReadmeDescription = \"AMPA-NF is a pipeline for assessing the antimicrobial domains of proteins,\";\n+        final String descriptorDescription = \"Fast automated prediction of protein antimicrobial regions\";\n+        Assert.assertEquals(descriptorDescription, workflow.getDescription());\n+        Assert.assertEquals(descriptorDescription, workflow.getDescription());\n+        workflow.getWorkflowVersions().forEach(workflowVersion -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e252c435165090d11c22d730894d6799e1fc54d"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c140cd8717fb7ab7ee830653999e9c618bec612", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/5c140cd8717fb7ab7ee830653999e9c618bec612", "committedDate": "2020-01-13T15:12:08Z", "message": "Enhance test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxOTE1NDEz", "url": "https://github.com/dockstore/dockstore/pull/3126#pullrequestreview-341915413", "createdAt": "2020-01-13T15:15:11Z", "commit": {"oid": "5c140cd8717fb7ab7ee830653999e9c618bec612"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxOTY2OTY2", "url": "https://github.com/dockstore/dockstore/pull/3126#pullrequestreview-341966966", "createdAt": "2020-01-13T16:23:56Z", "commit": {"oid": "5c140cd8717fb7ab7ee830653999e9c618bec612"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1864, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}