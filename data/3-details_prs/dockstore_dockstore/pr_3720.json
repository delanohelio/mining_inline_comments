{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0MTA0NDA2", "number": 3720, "title": "3487/smart refresh", "bodyText": "NOTE: Hubflow closed the other PR since it was to hotfix 1.9.1.\nAdds smart refresh for refresh workflow and refresh version. Smart refresh will only update a version if required (change on dockstore or on git). If a version has not been edited, it will be skipped. This is based mostly on whether the commit ID for a version has changed since the last refresh.\nThere is the case where the commit id has not been changed, however, a refresh needs to be done since changes were made on Dockstore. Perhaps the default path for a workflow was changed. This is solved by the synced column for workflow versions.\nThe new column synced represents whether or not a change has been made to a workflow/version on Dockstore since the last refresh was done. Any API call which edits a workflow (ex. change default path) or edits a version (ex. change workflow path) will set this bit to false. When a version is added for the first time or updated, synced is set to true.\nThere is also a new optional hard refresh option for refresh and refresh version (Default true). Setting this to true is equivalent to the current refresh implementation. When it is false, it will be a smart refresh. This smart refresh is what the refresh in the UI will call.\nFor the migration, the default value of synced is false. This is because any new version added should be refreshed.\nThe migration also sets all existing workflow versions to have synced as true. This probably requires some discussion. It assumes that no one has used the API to update a workflow or workflow version, since doing so doesn't automatically call refresh. In the UI, any changes to a workflow or workflow version is followed by a refresh.\n#3487", "createdAt": "2020-08-06T15:35:25Z", "url": "https://github.com/dockstore/dockstore/pull/3720", "merged": true, "mergeCommit": {"oid": "57dc7a9e0712d3d40c222c65f9f77154b74b0378"}, "closed": true, "closedAt": "2020-08-10T19:22:20Z", "author": {"login": "agduncan94"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6tnNtgH2gAyNDY0MTA0NDA2OjVhNWEzZDVkYzNlZWM5NjdiYWJlZDJkYTNlMGRmNWE5ODgwMGJlMWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9lH19gFqTQ2NDQwNDEwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5a5a3d5dc3eec967babed2da3e0df5a98800be1c", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/5a5a3d5dc3eec967babed2da3e0df5a98800be1c", "committedDate": "2020-08-01T19:02:15Z", "message": "first pass at smart refresh for refresh workflow and refresh workflow version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3d578cffc5e707068ca8f4e44248b2b51599395", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/f3d578cffc5e707068ca8f4e44248b2b51599395", "committedDate": "2020-08-01T19:36:13Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d6506ca8c0b2437978eebacf7adb2ebcfe154f7", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/9d6506ca8c0b2437978eebacf7adb2ebcfe154f7", "committedDate": "2020-08-01T20:15:32Z", "message": "fix bitbucket issue, add logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd66f736d2ad69d2c4fa9e83682d1ee1c242ccd5", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/fd66f736d2ad69d2c4fa9e83682d1ee1c242ccd5", "committedDate": "2020-08-04T19:26:16Z", "message": "test for smart refresh: github, bitbucket and gitlab"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7ea324b4952749b000ca61bd8dfc311ec97f4d3", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/b7ea324b4952749b000ca61bd8dfc311ec97f4d3", "committedDate": "2020-08-04T19:49:59Z", "message": "default tests to soft refresh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db67e4b2821b7863b717e9008a9c0348881b6448", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/db67e4b2821b7863b717e9008a9c0348881b6448", "committedDate": "2020-08-04T19:56:02Z", "message": "changed some more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a813725e223f62d764b6438144fecc0952e43c5", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/5a813725e223f62d764b6438144fecc0952e43c5", "committedDate": "2020-08-04T19:57:08Z", "message": "missed one more"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0506ad484de66e2b4207c6a04cf1da0a13c29032", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/0506ad484de66e2b4207c6a04cf1da0a13c29032", "committedDate": "2020-08-04T20:47:11Z", "message": "fix failing migration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb9acd121276bbe6bbb519f378f7d34991f16a57", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/fb9acd121276bbe6bbb519f378f7d34991f16a57", "committedDate": "2020-08-05T15:15:33Z", "message": "fix failing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa7d4bd4713f49ef51cd9877fc3c062fc7303c88", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/aa7d4bd4713f49ef51cd9877fc3c062fc7303c88", "committedDate": "2020-08-05T17:13:20Z", "message": "change existing versions to be synced"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34d1344489df36a926bdf43e70344c0cbf140041", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/34d1344489df36a926bdf43e70344c0cbf140041", "committedDate": "2020-08-05T18:25:05Z", "message": "default to false"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a1adf0a42a8b927dd1cf6800938f4ab318d97f7", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/5a1adf0a42a8b927dd1cf6800938f4ab318d97f7", "committedDate": "2020-08-05T19:01:41Z", "message": "another migration fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51398c02a73802ff25c09eb576a3a1bd9d45b58e", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/51398c02a73802ff25c09eb576a3a1bd9d45b58e", "committedDate": "2020-08-06T18:45:23Z", "message": "updates from PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9b12c62f54cfebb14167d7ce25c0a9d02e04c81", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/c9b12c62f54cfebb14167d7ce25c0a9d02e04c81", "committedDate": "2020-08-06T18:58:04Z", "message": "fix filtering"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aae5f436e4a4fc384da3a87d2d244dfd2f4b8dac", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/aae5f436e4a4fc384da3a87d2d244dfd2f4b8dac", "committedDate": "2020-08-06T20:18:37Z", "message": "fix failing test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNDI4NDc4", "url": "https://github.com/dockstore/dockstore/pull/3720#pullrequestreview-463428478", "createdAt": "2020-08-07T16:02:23Z", "commit": {"oid": "aae5f436e4a4fc384da3a87d2d244dfd2f4b8dac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNjowMjoyM1rOG9fY1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNjowMjoyM1rOG9fY1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzEzMDU4Mg==", "bodyText": "ok, now i'm confused which yq is supposed to be used", "url": "https://github.com/dockstore/dockstore/pull/3720#discussion_r467130582", "createdAt": "2020-08-07T16:02:23Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "diffHunk": "@@ -4225,7 +4343,7 @@ paths:\n           description: default response\n       summary: Successful response if elastic search is up and running\n       tags:\n-        - metadata", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aae5f436e4a4fc384da3a87d2d244dfd2f4b8dac"}, "originalPosition": 4114}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNDcyOTk5", "url": "https://github.com/dockstore/dockstore/pull/3720#pullrequestreview-463472999", "createdAt": "2020-08-07T17:12:37Z", "commit": {"oid": "aae5f436e4a4fc384da3a87d2d244dfd2f4b8dac"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNzoxMjozN1rOG9hkUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNzoyMDoxOVrOG9hyrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2NjI5MA==", "bodyText": "Totally optional, but only because it took me a bit to understand this: Either add a comment saying something to the effect that there is no need to change because the version has not changed, or create a function for the if condition whose name represents that.\nI guess the disconnect is that cognitively SKIP_COMMIT_ID != unmodified to me.", "url": "https://github.com/dockstore/dockstore/pull/3720#discussion_r467166290", "createdAt": "2020-08-07T17:12:37Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/SourceCodeRepoInterface.java", "diffHunk": "@@ -332,7 +353,9 @@ public void updateEntryMetadata(final Entry<?, ?> entry, final DescriptorLanguag\n             Workflow workflow = (Workflow)entry;\n             workflow.getWorkflowVersions().forEach(workflowVersion -> {\n                 String filePath = workflowVersion.getWorkflowPath();\n-                updateVersionMetadata(filePath, workflowVersion, type, repositoryId);\n+                if (!Objects.equals(SKIP_COMMIT_ID, workflowVersion.getCommitID())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aae5f436e4a4fc384da3a87d2d244dfd2f4b8dac"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2OTk2Nw==", "bodyText": "I know I suggested the stream/filter, but by making it a Set there is the possibility that a version may get filtered out that wasn't being filtered before. Probably never happens with our data, but still... I would just get rid of the set and the intermediate variable, and use forEach directly on the stream:\nnewWorkflow.getWorkflowVersions().stream()\n    .filter(workflowVersion -> !Objects.equals(SKIP_COMMIT_ID, workflowVersion.getCommitID()))\n    .forEach(version -> {\n        WorkflowVersion workflowVersionFromDB = existingVersionMap.get(version.getName());\n        ...\n});", "url": "https://github.com/dockstore/dockstore/pull/3720#discussion_r467169967", "createdAt": "2020-08-07T17:20:19Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -166,10 +168,15 @@ protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Work\n             }\n         }\n \n+        // Remove versions that do not need to be updated\n+        Set<WorkflowVersion> filteredVersions = newWorkflow.getWorkflowVersions().stream().filter(workflowVersion -> !Objects.equals(SKIP_COMMIT_ID, workflowVersion.getCommitID())).collect(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aae5f436e4a4fc384da3a87d2d244dfd2f4b8dac"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNTQyMjIz", "url": "https://github.com/dockstore/dockstore/pull/3720#pullrequestreview-463542223", "createdAt": "2020-08-07T18:59:38Z", "commit": {"oid": "aae5f436e4a4fc384da3a87d2d244dfd2f4b8dac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97114a366ebcd453289fcd2d5ac2489841ac1eb5", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/97114a366ebcd453289fcd2d5ac2489841ac1eb5", "committedDate": "2020-08-07T20:11:37Z", "message": "some suggestions from PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9a851bee4b979f47b866fc2d4e4208611fa0502", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/a9a851bee4b979f47b866fc2d4e4208611fa0502", "committedDate": "2020-08-07T23:07:57Z", "message": "fix inconsistent test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MzE3NjQ3", "url": "https://github.com/dockstore/dockstore/pull/3720#pullrequestreview-464317647", "createdAt": "2020-08-10T15:09:30Z", "commit": {"oid": "a9a851bee4b979f47b866fc2d4e4208611fa0502"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e818fad74104b69fd8e0b5c5f02733dd82578fff", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/e818fad74104b69fd8e0b5c5f02733dd82578fff", "committedDate": "2020-08-10T15:24:26Z", "message": "use yq 3.3.2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MzcyMzc2", "url": "https://github.com/dockstore/dockstore/pull/3720#pullrequestreview-464372376", "createdAt": "2020-08-10T16:08:13Z", "commit": {"oid": "e818fad74104b69fd8e0b5c5f02733dd82578fff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NDA0MTA5", "url": "https://github.com/dockstore/dockstore/pull/3720#pullrequestreview-464404109", "createdAt": "2020-08-10T16:50:31Z", "commit": {"oid": "e818fad74104b69fd8e0b5c5f02733dd82578fff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1710, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}