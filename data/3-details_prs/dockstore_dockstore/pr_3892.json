{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExNTk2MTY1", "number": 3892, "title": "use actual GitHub path as testparam path, don't use /test.json by default", "bodyText": "Main issue: #3851\nGitHub Apps workflows with Test Parameter Files specified in .dockstore.yml are assigned a path by workflow.getDefaultTestParameterFilePath().\nHowever this defaults to /test.json unless some other default for the workflow was set (seems like not in most cases) \n  \n    \n      dockstore/dockstore-webservice/src/main/java/io/dockstore/webservice/core/Workflow.java\n    \n    \n         Line 341\n      in\n      d836384\n    \n    \n    \n    \n\n        \n          \n           return getDefaultPaths().getOrDefault(this.getDescriptorType().getTestParamType(), \"/test.json\"); \n        \n    \n  \n\n\nThis is problematic for non-JSON (YML) test files appearing incorrectly on the UI, and likely causes file name collisions for multiple Test Parameter Files.\nThis PR changes the assignment of the Test Parameter File path to just be its path in git, this way the original name is preserved. This also aligns with how the Primary Descriptor path is set \n  \n    \n      dockstore/dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java\n    \n    \n         Line 729\n      in\n      d836384\n    \n    \n    \n    \n\n        \n          \n           primaryDescriptorFile.setPath(primaryDescriptorPath); \n        \n    \n  \n\n\nFinally, I also changed the variable names Test Parameter Files to not longer appear JSON-specific.", "createdAt": "2020-10-28T14:35:35Z", "url": "https://github.com/dockstore/dockstore/pull/3892", "merged": true, "mergeCommit": {"oid": "d94fa0b91eed7a4b206f5357d017ad9749962de4"}, "closed": true, "closedAt": "2020-11-04T18:31:43Z", "author": {"login": "GFJHogue"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWvq_iAH2gAyNTExNTk2MTY1OmRiZDQ2ZGZlM2YyYmNjNzMzNDgzODE2MzIxODVhYmViYmFlNzc4Njk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZAJWIgH2gAyNTExNTk2MTY1OjUyNTQ4NzZiYjQyNDdjYTE4YWI2OTg1OGM1MGFlM2NkZjJlMmJiYjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dbd46dfe3f2bcc73348381632185abebbae77869", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/dbd46dfe3f2bcc73348381632185abebbae77869", "committedDate": "2020-10-27T21:16:04Z", "message": "use actual GitHub path as testparam path, don't use test.json by default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0a4fba56486ae1772b00b59215f531383a6162c", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/b0a4fba56486ae1772b00b59215f531383a6162c", "committedDate": "2020-10-28T14:11:54Z", "message": "fix duplicate sourceFile detection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4ODczMzY3", "url": "https://github.com/dockstore/dockstore/pull/3892#pullrequestreview-518873367", "createdAt": "2020-10-28T16:44:17Z", "commit": {"oid": "b0a4fba56486ae1772b00b59215f531383a6162c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNjo0NDoxN1rOHpznNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNjo0NDoxN1rOHpznNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU5OTI4Nw==", "bodyText": "It was like this, but I think you could move this to before line 739, saving the unnecessary reading of the GitHub file and creation of a SourceFile if there actually is a duplicate.\nPerformance-wise, I'm sure it's negligible, and I doubt there are rarely, if ever, any cases of duplicate files like this, but it might make the code slightly easier to read.\nJust nit-picking, and I don't feel super-strongly about this, but just noticed it as I was trying to understand the code.", "url": "https://github.com/dockstore/dockstore/pull/3892#discussion_r513599287", "createdAt": "2020-10-28T16:44:17Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java", "diffHunk": "@@ -736,19 +736,19 @@ private WorkflowVersion setupWorkflowFilesForGitHubVersion(Triple<String, Date,\n             if (testParameterPaths != null) {\n                 List<String> missingParamFiles = new ArrayList<>();\n                 for (String testParameterPath : testParameterPaths) {\n-                    String testJsonContent = this.readFileFromRepo(testParameterPath, ref.getLeft(), repository);\n-                    if (testJsonContent != null) {\n-                        SourceFile testJson = new SourceFile();\n-                        // find type from file type, then find matching test param type\n-                        testJson.setType(workflow.getDescriptorType().getTestParamType());\n-                        testJson.setPath(workflow.getDefaultTestParameterFilePath());\n-                        testJson.setAbsolutePath(workflow.getDefaultTestParameterFilePath());\n-                        testJson.setContent(testJsonContent);\n+                    String testFileContent = this.readFileFromRepo(testParameterPath, ref.getLeft(), repository);\n+                    if (testFileContent != null) {\n+                        SourceFile testFile = new SourceFile();\n+                        // find type from file type\n+                        testFile.setType(workflow.getDescriptorType().getTestParamType());\n+                        testFile.setPath(testParameterPath);\n+                        testFile.setAbsolutePath(testParameterPath);\n+                        testFile.setContent(testFileContent);\n \n                         // Only add test parameter file if it hasn't already been added\n-                        boolean hasDuplicate = version.getSourceFiles().stream().anyMatch((SourceFile sf) -> sf.getPath().equals(workflow.getDefaultTestParameterFilePath()) && sf.getType() == testJson.getType());\n+                        boolean hasDuplicate = version.getSourceFiles().stream().anyMatch((SourceFile sf) -> sf.getPath().equals(testFile.getPath()) && sf.getType() == testFile.getType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0a4fba56486ae1772b00b59215f531383a6162c"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MDAzNjA2", "url": "https://github.com/dockstore/dockstore/pull/3892#pullrequestreview-519003606", "createdAt": "2020-10-28T19:14:32Z", "commit": {"oid": "b0a4fba56486ae1772b00b59215f531383a6162c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTA4NDEy", "url": "https://github.com/dockstore/dockstore/pull/3892#pullrequestreview-520908412", "createdAt": "2020-10-30T17:52:39Z", "commit": {"oid": "b0a4fba56486ae1772b00b59215f531383a6162c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53ecdca1585811524ba3b73d9fba0115f94feba1", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/53ecdca1585811524ba3b73d9fba0115f94feba1", "committedDate": "2020-10-30T18:40:58Z", "message": "test .dockstore.yml workflow test param file path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c68e5aec322769f6c7ae08c3f57c5156a705bd29", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/c68e5aec322769f6c7ae08c3f57c5156a705bd29", "committedDate": "2020-10-30T18:57:24Z", "message": "check for duplicate path before reading file from repo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb40f8279da2007dbc93b68a307a4c74868439de", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/eb40f8279da2007dbc93b68a307a4c74868439de", "committedDate": "2020-10-30T18:59:36Z", "message": "Merge branch 'develop' into feature/3851/dont-assume-json-testparam"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxODA1MjI3", "url": "https://github.com/dockstore/dockstore/pull/3892#pullrequestreview-521805227", "createdAt": "2020-11-02T16:43:22Z", "commit": {"oid": "eb40f8279da2007dbc93b68a307a4c74868439de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNjo0MzoyMlrOHsMkLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNjo0MzoyMlrOHsMkLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEwNTI2MQ==", "bodyText": "Would also like a test for a Galaxy workflow with a yaml test parameter file to cover our bases\nEdit: can see from above, this is unlikely to catch anything, but just in case", "url": "https://github.com/dockstore/dockstore/pull/3892#discussion_r516105261", "createdAt": "2020-11-02T16:43:22Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/WebhookIT.java", "diffHunk": "@@ -535,6 +535,22 @@ public void testInvalidDockstoreYmlFiles() throws Exception {\n         }\n     }\n \n+    /**\n+     * Test that a .dockstore.yml workflow has the expected path for its test parameter file.\n+     */\n+    @Test\n+    public void testTestParameterPaths() throws Exception {\n+        CommonTestUtilities.cleanStatePrivate2(SUPPORT, false);\n+        final ApiClient webClient = getWebClient(BasicIT.USER_2_USERNAME, testingPostgres);\n+        WorkflowsApi client = new WorkflowsApi(webClient);\n+\n+        client.handleGitHubRelease(workflowRepo, BasicIT.USER_2_USERNAME, \"refs/heads/master\", installationId);\n+        Workflow workflow = client.getWorkflowByPath(\"github.com/\" + workflowRepo + \"/foobar\", \"\", false);\n+        WorkflowVersion version = workflow.getWorkflowVersions().get(0);\n+        List<SourceFile> sourceFiles = fileDAO.findSourceFilesByVersion(version.getId());\n+        assertTrue(\"Test file should have the expected path\", sourceFiles.stream().filter(sourceFile -> sourceFile.getPath().equals(\"/dockstore.wdl.json\")).findFirst().isPresent());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb40f8279da2007dbc93b68a307a4c74868439de"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxODczMzQ5", "url": "https://github.com/dockstore/dockstore/pull/3892#pullrequestreview-521873349", "createdAt": "2020-11-02T18:02:21Z", "commit": {"oid": "eb40f8279da2007dbc93b68a307a4c74868439de"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxODkzNjM5", "url": "https://github.com/dockstore/dockstore/pull/3892#pullrequestreview-521893639", "createdAt": "2020-11-02T18:31:06Z", "commit": {"oid": "eb40f8279da2007dbc93b68a307a4c74868439de"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4894f0f11f790f5b10f843487644dfba3a872771", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/4894f0f11f790f5b10f843487644dfba3a872771", "committedDate": "2020-11-03T17:53:54Z", "message": "add Galaxy test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fa1818360910e88142ff3fc11c0b44b3fbecd12", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/0fa1818360910e88142ff3fc11c0b44b3fbecd12", "committedDate": "2020-11-03T17:54:21Z", "message": "Merge branch 'develop' into feature/3851/dont-assume-json-testparam"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "621264c4f150f9eaa7f6c9d321aced4825e18bd7", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/621264c4f150f9eaa7f6c9d321aced4825e18bd7", "committedDate": "2020-11-03T19:17:35Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyODQwNDk4", "url": "https://github.com/dockstore/dockstore/pull/3892#pullrequestreview-522840498", "createdAt": "2020-11-03T20:11:47Z", "commit": {"oid": "621264c4f150f9eaa7f6c9d321aced4825e18bd7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5254876bb4247ca18ab69858c50ae3cdf2e2bbb9", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/5254876bb4247ca18ab69858c50ae3cdf2e2bbb9", "committedDate": "2020-11-03T21:35:33Z", "message": "Merge branch 'develop' into feature/3851/dont-assume-json-testparam"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1811, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}