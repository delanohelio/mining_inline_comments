{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzMjAwMTQ0", "number": 3343, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNjoxMDoxMFrODruBqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxOToxMjoxMVrODsMi0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MTY5NDUwOnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNjoxMDoxMFrOF8OjCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjowMDozM1rOF9w34w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY5NzIyNg==", "bodyText": "What happens if versionName is not empty and the version got deleted on GitHub?", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r398697226", "createdAt": "2020-03-26T16:10:10Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -151,20 +151,24 @@ private String getToken(List<Token> tokens, TokenType tokenType) {\n      * workflow verions.\n      * @param workflow    workflow to be updated\n      * @param newWorkflow workflow to grab new content from\n+     * @param user\n+     * @param versionName\n      */\n-    protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Workflow newWorkflow, final User user) {\n+    protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Workflow newWorkflow, final User user, Optional<String> versionName) {\n         // update root workflow\n         workflow.update(newWorkflow);\n         // update workflow versions\n         Map<String, WorkflowVersion> existingVersionMap = new HashMap<>();\n         workflow.getWorkflowVersions().forEach(version -> existingVersionMap.put(version.getName(), version));\n \n-        // delete versions that exist in old workflow but do not exist in newWorkflow\n-        Map<String, WorkflowVersion> newVersionMap = new HashMap<>();\n-        newWorkflow.getWorkflowVersions().forEach(version -> newVersionMap.put(version.getName(), version));\n-        Sets.SetView<String> removedVersions = Sets.difference(existingVersionMap.keySet(), newVersionMap.keySet());\n-        for (String version : removedVersions) {\n-            workflow.removeWorkflowVersion(existingVersionMap.get(version));\n+        // delete versions that exist in old workflow but do not exist in newWorkflow (only for whole refresh)\n+        if (versionName.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bb1725a62fa6f7613c05a8f12e77c6f9e3de0b5"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1ODUwMQ==", "bodyText": "Good call. Looks like the endpoint will do nothing and not throw an error. I'll update it so that it throws an error if the branch does not exist.", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r399258501", "createdAt": "2020-03-27T13:21:11Z", "author": {"login": "agduncan94"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -151,20 +151,24 @@ private String getToken(List<Token> tokens, TokenType tokenType) {\n      * workflow verions.\n      * @param workflow    workflow to be updated\n      * @param newWorkflow workflow to grab new content from\n+     * @param user\n+     * @param versionName\n      */\n-    protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Workflow newWorkflow, final User user) {\n+    protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Workflow newWorkflow, final User user, Optional<String> versionName) {\n         // update root workflow\n         workflow.update(newWorkflow);\n         // update workflow versions\n         Map<String, WorkflowVersion> existingVersionMap = new HashMap<>();\n         workflow.getWorkflowVersions().forEach(version -> existingVersionMap.put(version.getName(), version));\n \n-        // delete versions that exist in old workflow but do not exist in newWorkflow\n-        Map<String, WorkflowVersion> newVersionMap = new HashMap<>();\n-        newWorkflow.getWorkflowVersions().forEach(version -> newVersionMap.put(version.getName(), version));\n-        Sets.SetView<String> removedVersions = Sets.difference(existingVersionMap.keySet(), newVersionMap.keySet());\n-        for (String version : removedVersions) {\n-            workflow.removeWorkflowVersion(existingVersionMap.get(version));\n+        // delete versions that exist in old workflow but do not exist in newWorkflow (only for whole refresh)\n+        if (versionName.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY5NzIyNg=="}, "originalCommit": {"oid": "6bb1725a62fa6f7613c05a8f12e77c6f9e3de0b5"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI4NDczOQ==", "bodyText": "Actually think I misunderstood. Do you mean if the refresh is of a version that doesn't exist on GitHub but exists on Dockstore, it should be deleted on Dockstore?", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r399284739", "createdAt": "2020-03-27T14:00:22Z", "author": {"login": "agduncan94"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -151,20 +151,24 @@ private String getToken(List<Token> tokens, TokenType tokenType) {\n      * workflow verions.\n      * @param workflow    workflow to be updated\n      * @param newWorkflow workflow to grab new content from\n+     * @param user\n+     * @param versionName\n      */\n-    protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Workflow newWorkflow, final User user) {\n+    protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Workflow newWorkflow, final User user, Optional<String> versionName) {\n         // update root workflow\n         workflow.update(newWorkflow);\n         // update workflow versions\n         Map<String, WorkflowVersion> existingVersionMap = new HashMap<>();\n         workflow.getWorkflowVersions().forEach(version -> existingVersionMap.put(version.getName(), version));\n \n-        // delete versions that exist in old workflow but do not exist in newWorkflow\n-        Map<String, WorkflowVersion> newVersionMap = new HashMap<>();\n-        newWorkflow.getWorkflowVersions().forEach(version -> newVersionMap.put(version.getName(), version));\n-        Sets.SetView<String> removedVersions = Sets.difference(existingVersionMap.keySet(), newVersionMap.keySet());\n-        for (String version : removedVersions) {\n-            workflow.removeWorkflowVersion(existingVersionMap.get(version));\n+        // delete versions that exist in old workflow but do not exist in newWorkflow (only for whole refresh)\n+        if (versionName.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY5NzIyNg=="}, "originalCommit": {"oid": "6bb1725a62fa6f7613c05a8f12e77c6f9e3de0b5"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMwNDUyOA==", "bodyText": "After discussing with Denis, we've decided that on refresh of a version, if that version does not exist, throw an error. This is different from the current refresh workflow logic, which would delete a version on Dockstore if it doesn't exist on the Git repo anymore. We decided on this difference because of how we expect the users to use this refresh in the UI. If they are refreshing a version, then likely they expect it to still exist and are not trying to delete it. A delete version button may be present in the future, pending archive/delete/life cycle discussions.", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r399304528", "createdAt": "2020-03-27T14:28:39Z", "author": {"login": "agduncan94"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -151,20 +151,24 @@ private String getToken(List<Token> tokens, TokenType tokenType) {\n      * workflow verions.\n      * @param workflow    workflow to be updated\n      * @param newWorkflow workflow to grab new content from\n+     * @param user\n+     * @param versionName\n      */\n-    protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Workflow newWorkflow, final User user) {\n+    protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Workflow newWorkflow, final User user, Optional<String> versionName) {\n         // update root workflow\n         workflow.update(newWorkflow);\n         // update workflow versions\n         Map<String, WorkflowVersion> existingVersionMap = new HashMap<>();\n         workflow.getWorkflowVersions().forEach(version -> existingVersionMap.put(version.getName(), version));\n \n-        // delete versions that exist in old workflow but do not exist in newWorkflow\n-        Map<String, WorkflowVersion> newVersionMap = new HashMap<>();\n-        newWorkflow.getWorkflowVersions().forEach(version -> newVersionMap.put(version.getName(), version));\n-        Sets.SetView<String> removedVersions = Sets.difference(existingVersionMap.keySet(), newVersionMap.keySet());\n-        for (String version : removedVersions) {\n-            workflow.removeWorkflowVersion(existingVersionMap.get(version));\n+        // delete versions that exist in old workflow but do not exist in newWorkflow (only for whole refresh)\n+        if (versionName.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY5NzIyNg=="}, "originalCommit": {"oid": "6bb1725a62fa6f7613c05a8f12e77c6f9e3de0b5"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwODE5NQ==", "bodyText": "Actually think I misunderstood. Do you mean if the refresh is of a version that doesn't exist on GitHub but exists on Dockstore, it should be deleted on Dockstore?\n\nYes, I meant that. :) Although I think I missed the larger context, and was just assuming it was a deleted version in general, as opposed to the specific version you are refreshing. You have it covered with the other ticket in any case.", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r400308195", "createdAt": "2020-03-30T16:00:33Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -151,20 +151,24 @@ private String getToken(List<Token> tokens, TokenType tokenType) {\n      * workflow verions.\n      * @param workflow    workflow to be updated\n      * @param newWorkflow workflow to grab new content from\n+     * @param user\n+     * @param versionName\n      */\n-    protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Workflow newWorkflow, final User user) {\n+    protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Workflow newWorkflow, final User user, Optional<String> versionName) {\n         // update root workflow\n         workflow.update(newWorkflow);\n         // update workflow versions\n         Map<String, WorkflowVersion> existingVersionMap = new HashMap<>();\n         workflow.getWorkflowVersions().forEach(version -> existingVersionMap.put(version.getName(), version));\n \n-        // delete versions that exist in old workflow but do not exist in newWorkflow\n-        Map<String, WorkflowVersion> newVersionMap = new HashMap<>();\n-        newWorkflow.getWorkflowVersions().forEach(version -> newVersionMap.put(version.getName(), version));\n-        Sets.SetView<String> removedVersions = Sets.difference(existingVersionMap.keySet(), newVersionMap.keySet());\n-        for (String version : removedVersions) {\n-            workflow.removeWorkflowVersion(existingVersionMap.get(version));\n+        // delete versions that exist in old workflow but do not exist in newWorkflow (only for whole refresh)\n+        if (versionName.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY5NzIyNg=="}, "originalCommit": {"oid": "6bb1725a62fa6f7613c05a8f12e77c6f9e3de0b5"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MTcwMjMwOnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNjoxMTo0MVrOF8Onzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNjoxMTo0MVrOF8Onzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY5ODQ0Ng==", "bodyText": "Shouldn't remove frozen versions. While database shouldn't let you, I think the whole transaction may fail, so other changes that happened will get lost.", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r398698446", "createdAt": "2020-03-26T16:11:41Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -151,20 +151,24 @@ private String getToken(List<Token> tokens, TokenType tokenType) {\n      * workflow verions.\n      * @param workflow    workflow to be updated\n      * @param newWorkflow workflow to grab new content from\n+     * @param user\n+     * @param versionName\n      */\n-    protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Workflow newWorkflow, final User user) {\n+    protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Workflow newWorkflow, final User user, Optional<String> versionName) {\n         // update root workflow\n         workflow.update(newWorkflow);\n         // update workflow versions\n         Map<String, WorkflowVersion> existingVersionMap = new HashMap<>();\n         workflow.getWorkflowVersions().forEach(version -> existingVersionMap.put(version.getName(), version));\n \n-        // delete versions that exist in old workflow but do not exist in newWorkflow\n-        Map<String, WorkflowVersion> newVersionMap = new HashMap<>();\n-        newWorkflow.getWorkflowVersions().forEach(version -> newVersionMap.put(version.getName(), version));\n-        Sets.SetView<String> removedVersions = Sets.difference(existingVersionMap.keySet(), newVersionMap.keySet());\n-        for (String version : removedVersions) {\n-            workflow.removeWorkflowVersion(existingVersionMap.get(version));\n+        // delete versions that exist in old workflow but do not exist in newWorkflow (only for whole refresh)\n+        if (versionName.isEmpty()) {\n+            Map<String, WorkflowVersion> newVersionMap = new HashMap<>();\n+            newWorkflow.getWorkflowVersions().forEach(version -> newVersionMap.put(version.getName(), version));\n+            Sets.SetView<String> removedVersions = Sets.difference(existingVersionMap.keySet(), newVersionMap.keySet());\n+            for (String version : removedVersions) {\n+                workflow.removeWorkflowVersion(existingVersionMap.get(version));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bb1725a62fa6f7613c05a8f12e77c6f9e3de0b5"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MjE5ODgxOnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNzo1OTo1MFrOF8TjnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNToxODoxNVrOF811Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc3OTI5Mg==", "bodyText": "boo", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r398779292", "createdAt": "2020-03-26T17:59:50Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java", "diffHunk": "@@ -473,10 +476,12 @@ public GHRepository getRepository(String repositoryId) {\n      * @param existingDefaults Optional mapping of existing versions\n      * @param repository GitHub repository object\n      * @param dockstoreYml Dockstore YML sourcefile\n+     * @param versionName Optional version name to refresh\n      * @return WorkflowVersion for the given reference\n      */\n+    @SuppressWarnings(\"checkstyle:ParameterNumber\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bb1725a62fa6f7613c05a8f12e77c6f9e3de0b5"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM0MDgxMA==", "bodyText": "\ud83d\ude22", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r399340810", "createdAt": "2020-03-27T15:18:15Z", "author": {"login": "agduncan94"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java", "diffHunk": "@@ -473,10 +476,12 @@ public GHRepository getRepository(String repositoryId) {\n      * @param existingDefaults Optional mapping of existing versions\n      * @param repository GitHub repository object\n      * @param dockstoreYml Dockstore YML sourcefile\n+     * @param versionName Optional version name to refresh\n      * @return WorkflowVersion for the given reference\n      */\n+    @SuppressWarnings(\"checkstyle:ParameterNumber\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc3OTI5Mg=="}, "originalCommit": {"oid": "6bb1725a62fa6f7613c05a8f12e77c6f9e3de0b5"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MjIwNDQ2OnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxODowMToxN1rOF8Tnbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzowOToyOVrOF8wX3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc4MDI3MQ==", "bodyText": "Paging @garyluu\nDoes a shared prefix with @Path(\"/{workflowId}/refresh\") cause issues with ELK?", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r398780271", "createdAt": "2020-03-26T18:01:17Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -380,61 +380,109 @@ private void logFullWorkflowRefresh(final Workflow workflow) {\n         }\n     }\n \n+    /**\n+     * Logs a version refresh statement with the workflow's descriptor language if workflow is a FULL workflow .\n+     * These logs will be monitored by CloudWatch and displayed on Grafana.\n+     * @param workflow\n+     * @param workflowVersion\n+     */\n+    private void logWorkflowVersionRefresh(final Workflow workflow, final String workflowVersion) {\n+        if (workflow.getMode() == WorkflowMode.FULL) {\n+            LOG.info(String.format(\"%s: Refreshing version %s for %s workflow named %s\", dashboardPrefix, workflowVersion, workflow.getDescriptorType(), workflow.getEntryPath()));\n+        }\n+    }\n+\n     @GET\n     @Path(\"/{workflowId}/refresh\")\n     @Timed\n     @UnitOfWork\n+    @Operation(operationId = \"refresh\", description = \"Refresh one particular workflow.\", security = @SecurityRequirement(name = \"bearer\"))\n     @ApiOperation(nickname = \"refresh\", value = \"Refresh one particular workflow.\", notes = \"Full refresh\", authorizations = {\n         @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = Workflow.class)\n     public Workflow refresh(@ApiParam(hidden = true) @Auth User user,\n         @ApiParam(value = \"workflow ID\", required = true) @PathParam(\"workflowId\") Long workflowId) {\n-        Workflow workflow = workflowDAO.findById(workflowId);\n-        checkEntry(workflow);\n-        checkUser(user, workflow);\n-        checkNotHosted(workflow);\n+        return refreshWorkflow(user, workflowId, Optional.empty());\n+    }\n+\n+    @GET\n+    @Path(\"/{workflowId}/refresh/{version}\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bb1725a62fa6f7613c05a8f12e77c6f9e3de0b5"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1MTQyMw==", "bodyText": "No, there's a slash, it should be fine.  but as always, the script to generate the patterns should always be ran.", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r399251423", "createdAt": "2020-03-27T13:09:29Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -380,61 +380,109 @@ private void logFullWorkflowRefresh(final Workflow workflow) {\n         }\n     }\n \n+    /**\n+     * Logs a version refresh statement with the workflow's descriptor language if workflow is a FULL workflow .\n+     * These logs will be monitored by CloudWatch and displayed on Grafana.\n+     * @param workflow\n+     * @param workflowVersion\n+     */\n+    private void logWorkflowVersionRefresh(final Workflow workflow, final String workflowVersion) {\n+        if (workflow.getMode() == WorkflowMode.FULL) {\n+            LOG.info(String.format(\"%s: Refreshing version %s for %s workflow named %s\", dashboardPrefix, workflowVersion, workflow.getDescriptorType(), workflow.getEntryPath()));\n+        }\n+    }\n+\n     @GET\n     @Path(\"/{workflowId}/refresh\")\n     @Timed\n     @UnitOfWork\n+    @Operation(operationId = \"refresh\", description = \"Refresh one particular workflow.\", security = @SecurityRequirement(name = \"bearer\"))\n     @ApiOperation(nickname = \"refresh\", value = \"Refresh one particular workflow.\", notes = \"Full refresh\", authorizations = {\n         @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = Workflow.class)\n     public Workflow refresh(@ApiParam(hidden = true) @Auth User user,\n         @ApiParam(value = \"workflow ID\", required = true) @PathParam(\"workflowId\") Long workflowId) {\n-        Workflow workflow = workflowDAO.findById(workflowId);\n-        checkEntry(workflow);\n-        checkUser(user, workflow);\n-        checkNotHosted(workflow);\n+        return refreshWorkflow(user, workflowId, Optional.empty());\n+    }\n+\n+    @GET\n+    @Path(\"/{workflowId}/refresh/{version}\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc4MDI3MQ=="}, "originalCommit": {"oid": "6bb1725a62fa6f7613c05a8f12e77c6f9e3de0b5"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NTI0NDcwOnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzoxMTo0OVrOF8wc8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzoxMTo0OVrOF8wc8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1MjcyMw==", "bodyText": "use constant for \"bearer\" here and below", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r399252723", "createdAt": "2020-03-27T13:11:49Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -380,61 +380,109 @@ private void logFullWorkflowRefresh(final Workflow workflow) {\n         }\n     }\n \n+    /**\n+     * Logs a version refresh statement with the workflow's descriptor language if workflow is a FULL workflow .\n+     * These logs will be monitored by CloudWatch and displayed on Grafana.\n+     * @param workflow\n+     * @param workflowVersion\n+     */\n+    private void logWorkflowVersionRefresh(final Workflow workflow, final String workflowVersion) {\n+        if (workflow.getMode() == WorkflowMode.FULL) {\n+            LOG.info(String.format(\"%s: Refreshing version %s for %s workflow named %s\", dashboardPrefix, workflowVersion, workflow.getDescriptorType(), workflow.getEntryPath()));\n+        }\n+    }\n+\n     @GET\n     @Path(\"/{workflowId}/refresh\")\n     @Timed\n     @UnitOfWork\n+    @Operation(operationId = \"refresh\", description = \"Refresh one particular workflow.\", security = @SecurityRequirement(name = \"bearer\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bb1725a62fa6f7613c05a8f12e77c6f9e3de0b5"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NTI0NjExOnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzoxMjowOVrOF8wdyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNDo1NjowMFrOF802Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1MjkzNg==", "bodyText": "user not hidden for both endpoints", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r399252936", "createdAt": "2020-03-27T13:12:09Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "diffHunk": "@@ -4115,6 +4115,65 @@ paths:\n       - bearer: []\n       tags:\n       - workflows\n+  /workflows/{workflowId}/refresh:\n+    get:\n+      description: Refresh one particular workflow.\n+      operationId: refresh\n+      parameters:\n+      - in: path\n+        name: workflowId\n+        required: true\n+        schema:\n+          format: int64\n+          type: integer\n+      requestBody:\n+        content:\n+          '*/*':\n+            schema:\n+              $ref: '#/components/schemas/User'\n+      responses:\n+        default:\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/Workflow'\n+          description: default response\n+      security:\n+      - bearer: []\n+      tags:\n+      - workflows\n+  /workflows/{workflowId}/refresh/{version}:\n+    get:\n+      description: Refresh one particular workflow version.\n+      operationId: refreshVersion\n+      parameters:\n+      - in: path\n+        name: workflowId\n+        required: true\n+        schema:\n+          format: int64\n+          type: integer\n+      - in: path\n+        name: version\n+        required: true\n+        schema:\n+          type: string\n+      requestBody:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bb1725a62fa6f7613c05a8f12e77c6f9e3de0b5"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyMjYwNQ==", "bodyText": "How do you hide with openapi?", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r399322605", "createdAt": "2020-03-27T14:53:10Z", "author": {"login": "agduncan94"}, "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "diffHunk": "@@ -4115,6 +4115,65 @@ paths:\n       - bearer: []\n       tags:\n       - workflows\n+  /workflows/{workflowId}/refresh:\n+    get:\n+      description: Refresh one particular workflow.\n+      operationId: refresh\n+      parameters:\n+      - in: path\n+        name: workflowId\n+        required: true\n+        schema:\n+          format: int64\n+          type: integer\n+      requestBody:\n+        content:\n+          '*/*':\n+            schema:\n+              $ref: '#/components/schemas/User'\n+      responses:\n+        default:\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/Workflow'\n+          description: default response\n+      security:\n+      - bearer: []\n+      tags:\n+      - workflows\n+  /workflows/{workflowId}/refresh/{version}:\n+    get:\n+      description: Refresh one particular workflow version.\n+      operationId: refreshVersion\n+      parameters:\n+      - in: path\n+        name: workflowId\n+        required: true\n+        schema:\n+          format: int64\n+          type: integer\n+      - in: path\n+        name: version\n+        required: true\n+        schema:\n+          type: string\n+      requestBody:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1MjkzNg=="}, "originalCommit": {"oid": "6bb1725a62fa6f7613c05a8f12e77c6f9e3de0b5"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyNDc0Ng==", "bodyText": "@Parameter(hidden = true, name = \"user\", in = ParameterIn.HEADER)", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r399324746", "createdAt": "2020-03-27T14:56:00Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "diffHunk": "@@ -4115,6 +4115,65 @@ paths:\n       - bearer: []\n       tags:\n       - workflows\n+  /workflows/{workflowId}/refresh:\n+    get:\n+      description: Refresh one particular workflow.\n+      operationId: refresh\n+      parameters:\n+      - in: path\n+        name: workflowId\n+        required: true\n+        schema:\n+          format: int64\n+          type: integer\n+      requestBody:\n+        content:\n+          '*/*':\n+            schema:\n+              $ref: '#/components/schemas/User'\n+      responses:\n+        default:\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/Workflow'\n+          description: default response\n+      security:\n+      - bearer: []\n+      tags:\n+      - workflows\n+  /workflows/{workflowId}/refresh/{version}:\n+    get:\n+      description: Refresh one particular workflow version.\n+      operationId: refreshVersion\n+      parameters:\n+      - in: path\n+        name: workflowId\n+        required: true\n+        schema:\n+          format: int64\n+          type: integer\n+      - in: path\n+        name: version\n+        required: true\n+        schema:\n+          type: string\n+      requestBody:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1MjkzNg=="}, "originalCommit": {"oid": "6bb1725a62fa6f7613c05a8f12e77c6f9e3de0b5"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NjY5NDU4OnYy", "diffSide": "RIGHT", "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/WebhookIT.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxOToxMjoxMVrOF8-oZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDozMzozNVrOF9sukg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ4NTAzMA==", "bodyText": "Could use a test for refresh version on a frozen version", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r399485030", "createdAt": "2020-03-27T19:12:11Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/WebhookIT.java", "diffHunk": "@@ -117,6 +120,30 @@ public void testWorkflowMigration() throws Exception {\n             assertEquals(\"Should not be able to refresh a dockstore.yml workflow.\", HttpStatus.SC_BAD_REQUEST, ex.getCode());\n         }\n \n+        // Should be able to refresh a legacy version", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1ea056067b66b41593cedd5bb7ce91e698823fe"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUxMzkyNQ==", "bodyText": "Actually this is hard to test, since we would be testing that a frozen version is not removed when the corresponding Git repo branch is deleted. I don't think our current testing framework supports this.", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r399513925", "createdAt": "2020-03-27T20:11:47Z", "author": {"login": "agduncan94"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/WebhookIT.java", "diffHunk": "@@ -117,6 +120,30 @@ public void testWorkflowMigration() throws Exception {\n             assertEquals(\"Should not be able to refresh a dockstore.yml workflow.\", HttpStatus.SC_BAD_REQUEST, ex.getCode());\n         }\n \n+        // Should be able to refresh a legacy version", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ4NTAzMA=="}, "originalCommit": {"oid": "b1ea056067b66b41593cedd5bb7ce91e698823fe"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MjAwNQ==", "bodyText": "That would be hard.  How about testing that a frozen version is not updated when the corresponding Git repo branch is newer?", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r399542005", "createdAt": "2020-03-27T21:16:42Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/WebhookIT.java", "diffHunk": "@@ -117,6 +120,30 @@ public void testWorkflowMigration() throws Exception {\n             assertEquals(\"Should not be able to refresh a dockstore.yml workflow.\", HttpStatus.SC_BAD_REQUEST, ex.getCode());\n         }\n \n+        // Should be able to refresh a legacy version", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ4NTAzMA=="}, "originalCommit": {"oid": "b1ea056067b66b41593cedd5bb7ce91e698823fe"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE5MDQ1MA==", "bodyText": "Wouldn't that also require making a push to the Git repo?", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r400190450", "createdAt": "2020-03-30T13:28:37Z", "author": {"login": "agduncan94"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/WebhookIT.java", "diffHunk": "@@ -117,6 +120,30 @@ public void testWorkflowMigration() throws Exception {\n             assertEquals(\"Should not be able to refresh a dockstore.yml workflow.\", HttpStatus.SC_BAD_REQUEST, ex.getCode());\n         }\n \n+        // Should be able to refresh a legacy version", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ4NTAzMA=="}, "originalCommit": {"oid": "b1ea056067b66b41593cedd5bb7ce91e698823fe"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE5Mzg3Mw==", "bodyText": "What if I do a refresh and check the dbupdatetime?", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r400193873", "createdAt": "2020-03-30T13:33:22Z", "author": {"login": "agduncan94"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/WebhookIT.java", "diffHunk": "@@ -117,6 +120,30 @@ public void testWorkflowMigration() throws Exception {\n             assertEquals(\"Should not be able to refresh a dockstore.yml workflow.\", HttpStatus.SC_BAD_REQUEST, ex.getCode());\n         }\n \n+        // Should be able to refresh a legacy version", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ4NTAzMA=="}, "originalCommit": {"oid": "b1ea056067b66b41593cedd5bb7ce91e698823fe"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI0MDI3NA==", "bodyText": "Was more thinking that you could start the database off with different content, freeze it, do a fake call to the new endpoint, and just verify that the new endpoint respects the frozen status and doesn't update to whats in GitHub", "url": "https://github.com/dockstore/dockstore/pull/3343#discussion_r400240274", "createdAt": "2020-03-30T14:33:35Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/WebhookIT.java", "diffHunk": "@@ -117,6 +120,30 @@ public void testWorkflowMigration() throws Exception {\n             assertEquals(\"Should not be able to refresh a dockstore.yml workflow.\", HttpStatus.SC_BAD_REQUEST, ex.getCode());\n         }\n \n+        // Should be able to refresh a legacy version", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ4NTAzMA=="}, "originalCommit": {"oid": "b1ea056067b66b41593cedd5bb7ce91e698823fe"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3075, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}