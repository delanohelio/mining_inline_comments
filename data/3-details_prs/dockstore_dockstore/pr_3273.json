{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNTY0ODMw", "number": 3273, "title": "Possibly final quay.io swagger cleanup for now", "bodyText": "Possibly final kick at #3232", "createdAt": "2020-02-26T23:48:33Z", "url": "https://github.com/dockstore/dockstore/pull/3273", "merged": true, "mergeCommit": {"oid": "323fa9a9ae5e886ea7101b4db49708a0ab1e0cb4"}, "closed": true, "closedAt": "2020-02-28T22:25:14Z", "author": {"login": "denis-yuen"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIPmW8gH2gAyMzgwNTY0ODMwOjI4MTBkNjliODY0NmM3YWU1OTlhYzY2MDY3NWE0Y2E1NzA3MGZkOTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcI1NT3gH2gAyMzgwNTY0ODMwOmYxN2RhMTA0MDRmYjFlYTI2M2VmMjI4NDZkY2I4Y2E2OWIzMmU3ZTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2810d69b8646c7ae599ac660675a4ca57070fd99", "author": {"user": {"login": "denis-yuen", "name": "Denis Yuen"}}, "url": "https://github.com/dockstore/dockstore/commit/2810d69b8646c7ae599ac660675a4ca57070fd99", "committedDate": "2020-02-26T23:47:57Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1708b8c79d149dcc654e80bd8ca477650ddcf1f7", "author": {"user": {"login": "denis-yuen", "name": "Denis Yuen"}}, "url": "https://github.com/dockstore/dockstore/commit/1708b8c79d149dcc654e80bd8ca477650ddcf1f7", "committedDate": "2020-02-27T16:16:26Z", "message": "Fix return for listrepos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2eab695c8baf54cf189977b5d57a137d2ee794cb", "author": {"user": {"login": "denis-yuen", "name": "Denis Yuen"}}, "url": "https://github.com/dockstore/dockstore/commit/2eab695c8baf54cf189977b5d57a137d2ee794cb", "committedDate": "2020-02-27T18:37:05Z", "message": "Noticed optimization mismatch with old code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1OTY5MTUx", "url": "https://github.com/dockstore/dockstore/pull/3273#pullrequestreview-365969151", "createdAt": "2020-02-27T20:18:16Z", "commit": {"oid": "2eab695c8baf54cf189977b5d57a137d2ee794cb"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMDoxODoxNlrOFvf1rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMDoxODoxNlrOFvf1rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM0OTAzOQ==", "bodyText": "Lots of BuildApi api = new BuildApi(apiClient); , put in constructor instead?", "url": "https://github.com/dockstore/dockstore/pull/3273#discussion_r385349039", "createdAt": "2020-02-27T20:18:16Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/QuayImageRegistry.java", "diffHunk": "@@ -212,129 +202,99 @@ private void insertQuayLastModifiedIntoLastBuilt(QuayTag quayTag, Tag tag) {\n     @Override\n     public void updateAPIToolsWithBuildInformation(List<Tool> apiTools) {\n         // Initialize useful classes\n-        final Gson gson = new Gson();\n         final SimpleDateFormat formatter = new SimpleDateFormat(\"EEE, d MMM yyyy HH:mm:ss Z\");\n \n-        for (Tool tool : apiTools) {\n-            // Set path information (not sure why we have to do this here)\n-            final String repo = tool.getNamespace() + '/' + tool.getName();\n-\n-            LOG.info(\"Grabbing tool information for \" + tool.getPath());\n-\n-            // Initialize giturl\n-            String gitUrl = null;\n-\n-            // Make call for build information from quay (only need most recent)\n-            // TODO: clean-up this with swagger api calls and/or swagger.yaml cleanup\n-            String urlBuilds = QUAY_URL + \"repository/\" + repo + \"/build/?limit=1\";\n-            Optional<String> asStringBuilds = ResourceUtilities.asString(urlBuilds, quayToken.getContent(), client);\n-\n-            // Check result of API call\n-            if (asStringBuilds.isPresent()) {\n-                String json = asStringBuilds.get();\n-\n-                // Store the json file into a map for parsing\n-                Map<String, List> buildMap = new HashMap<>();\n-                buildMap = (Map<String, List>)gson.fromJson(json, buildMap.getClass());\n-\n-                // Grab build information\n-                List builds = buildMap.get(\"builds\");\n-\n-                if (builds.size() > 0) {\n+        // Grab build information for given repository\n+        BuildApi api = new BuildApi(apiClient);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2eab695c8baf54cf189977b5d57a137d2ee794cb"}, "originalPosition": 153}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MDk5NzUz", "url": "https://github.com/dockstore/dockstore/pull/3273#pullrequestreview-366099753", "createdAt": "2020-02-28T00:51:34Z", "commit": {"oid": "2eab695c8baf54cf189977b5d57a137d2ee794cb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2Mzk3NjY3", "url": "https://github.com/dockstore/dockstore/pull/3273#pullrequestreview-366397667", "createdAt": "2020-02-28T13:32:08Z", "commit": {"oid": "2eab695c8baf54cf189977b5d57a137d2ee794cb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71cbf48002d98ace4a2437e43dd9fdbeed64aa1f", "author": {"user": {"login": "denis-yuen", "name": "Denis Yuen"}}, "url": "https://github.com/dockstore/dockstore/commit/71cbf48002d98ace4a2437e43dd9fdbeed64aa1f", "committedDate": "2020-02-28T15:56:12Z", "message": "PR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NTczOTMy", "url": "https://github.com/dockstore/dockstore/pull/3273#pullrequestreview-366573932", "createdAt": "2020-02-28T17:46:56Z", "commit": {"oid": "71cbf48002d98ace4a2437e43dd9fdbeed64aa1f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzo0Njo1NlrOFv9cKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzo0Njo1NlrOFv9cKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgzNDAyNw==", "bodyText": "Are these errors not unexpected? If not, suggest LOG.error instead of warn", "url": "https://github.com/dockstore/dockstore/pull/3273#discussion_r385834027", "createdAt": "2020-02-28T17:46:56Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/QuayImageRegistry.java", "diffHunk": "@@ -181,28 +177,25 @@ private void insertQuayLastModifiedIntoLastBuilt(QuayTag quayTag, Tag tag) {\n         List<Tool> toolList = new ArrayList<>(0);\n \n         for (String namespace : namespaces) {\n-            String url = QUAY_URL + \"repository?namespace=\" + namespace;\n-            Optional<String> asString = ResourceUtilities.asString(url, quayToken.getContent(), client);\n-            //            LOG.info(quayToken.getUsername() + \" : RESOURCE CALL: {}\", url);\n-\n-            if (asString.isPresent()) {\n-                RepoList repos;\n-                try {\n+            try {\n+                final List<QuayRepo> quayRepos = repositoryApi.listRepos(null, null, null, null, null, null, namespace).getRepositories();\n+                List<Tool> tools = Lists.newArrayList();\n+                for (QuayRepo repo : quayRepos) {\n+                    Tool tool = new Tool();\n                     // interesting, this relies upon our container object having the same fields\n                     // as quay.io's repositories\n \n                     // PLEASE NOTE : is_public is from quay.  It has NO connection to our is_published!\n-                    repos = objectMapper.readValue(asString.get(), RepoList.class);\n-\n-                    List<Tool> tools = repos.getRepositories();\n-                    // tag all of these with where they came from\n-                    tools.forEach(container -> container.setRegistry(Registry.QUAY_IO.toString()));\n-                    // not quite correct, they could be mixed but how can we tell from quay?\n-                    tools.forEach(container -> container.setMode(ToolMode.AUTO_DETECT_QUAY_TAGS_AUTOMATED_BUILDS));\n-                    toolList.addAll(tools);\n-                } catch (IOException ex) {\n-                    LOG.warn(quayToken.getUsername() + \" Exception: {}\", ex);\n+                    BeanUtils.copyProperties(tool, repo);\n+                    tools.add(tool);\n                 }\n+                // tag all of these with where they came from\n+                tools.forEach(container -> container.setRegistry(Registry.QUAY_IO.toString()));\n+                // not quite correct, they could be mixed but how can we tell from quay?\n+                tools.forEach(container -> container.setMode(ToolMode.AUTO_DETECT_QUAY_TAGS_AUTOMATED_BUILDS));\n+                toolList.addAll(tools);\n+            } catch (ApiException | IllegalAccessException | InvocationTargetException ex) {\n+                LOG.warn(quayToken.getUsername() + \" Exception: {}\", ex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71cbf48002d98ace4a2437e43dd9fdbeed64aa1f"}, "originalPosition": 140}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0befa18116ddabd423d1fc5fc9317b2571c5b51", "author": {"user": {"login": "denis-yuen", "name": "Denis Yuen"}}, "url": "https://github.com/dockstore/dockstore/commit/c0befa18116ddabd423d1fc5fc9317b2571c5b51", "committedDate": "2020-02-28T19:25:59Z", "message": "Update QuayImageRegistry.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f17da10404fb1ea263ef22846dcb8ca69b32e7e3", "author": {"user": {"login": "denis-yuen", "name": "Denis Yuen"}}, "url": "https://github.com/dockstore/dockstore/commit/f17da10404fb1ea263ef22846dcb8ca69b32e7e3", "committedDate": "2020-02-28T19:36:59Z", "message": "Merge branch 'develop' into feature/even_more_quay_cleanup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1790, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}