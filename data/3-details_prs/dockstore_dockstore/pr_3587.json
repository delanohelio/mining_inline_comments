{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3MTU3MjQ0", "number": 3587, "title": "Feature/3035/requirements map error", "bodyText": "The CWLAvro code expects the Requirements and Hints as arrays. The workflow https://github.com/wshands/SnapTools/blob/feature/docker_cwl/snaptools_create_snap_file.cwl has a secondary file which defines requirements as a map. This code will convert the map into an array for both hints and requirements so that the CWLAvro code works.\nThis was causing the tools and DAG tab for the workflow linked above to error out. This is now fixed.\n#3035", "createdAt": "2020-06-19T15:16:03Z", "url": "https://github.com/dockstore/dockstore/pull/3587", "merged": true, "mergeCommit": {"oid": "29cc8c4d0a6efbee51b82ba880c54bf84f3e4a17"}, "closed": true, "closedAt": "2020-06-24T17:45:17Z", "author": {"login": "agduncan94"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcszl1ZAH2gAyNDM3MTU3MjQ0Ojg5M2IyOTNmMjE4ZGVhMWRjODdhZTA2ZWVjNjg5YjUzZTU0MGJkNzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuaKJmgH2gAyNDM3MTU3MjQ0OmE5YTg4YWYzZjlhOTAyMGJmMTYzZGU0NjU0ZGY3NTg4ZTY2YjY2NjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "893b293f218dea1dc87ae06eec689b53e540bd75", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/893b293f218dea1dc87ae06eec689b53e540bd75", "committedDate": "2020-06-19T14:05:14Z", "message": "support for cwl requirements and hints as maps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41", "committedDate": "2020-06-19T14:52:30Z", "message": "added test for requirements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MTc4MDk3", "url": "https://github.com/dockstore/dockstore/pull/3587#pullrequestreview-434178097", "createdAt": "2020-06-19T15:46:51Z", "commit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTo0Njo1MVrOGmZZPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTo0Njo1MVrOGmZZPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxNTEzNQ==", "bodyText": "You could create constants for \"requirements\" and \"hints\", since they're each referenced twice in the file, but not worth going through another iteration of the PR.", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442915135", "createdAt": "2020-06-19T15:46:51Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -564,6 +569,10 @@ private String parseSecondaryFile(String stepDockerRequirement, String secondary\n             List<Object> cltRequirements = null;\n             List<Object> cltHints = null;\n \n+            // CWLAvro only supports requirements and hints as an array, must be converted\n+            entryJson = convertJSONObjectToArray(\"requirements\", entryJson);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MTg0Mjg5", "url": "https://github.com/dockstore/dockstore/pull/3587#pullrequestreview-434184289", "createdAt": "2020-06-19T15:56:08Z", "commit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MTg1MDQ3", "url": "https://github.com/dockstore/dockstore/pull/3587#pullrequestreview-434185047", "createdAt": "2020-06-19T15:57:15Z", "commit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MTcxMzgw", "url": "https://github.com/dockstore/dockstore/pull/3587#pullrequestreview-434171380", "createdAt": "2020-06-19T15:36:47Z", "commit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTozNjo0N1rOGmZFMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTo1MDo1MVrOGmZhXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxMDAwMw==", "bodyText": "cwl => CWL", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442910003", "createdAt": "2020-06-19T15:36:47Z", "author": {"login": "garyluu"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java", "diffHunk": "@@ -118,6 +118,25 @@ public void testWorkflowDAGCWL() throws ApiException {\n \n     }\n \n+    @Test\n+    public void testWorkflowDAGCWLRequirementMap() throws ApiException {\n+        // Input: snaptools_create_snap_file.cwl\n+        // Repo: SnapTools\n+        // Branch: feature/docker_cwl_req_in_min\n+        // Test: normal cwl workflow DAG with requirement map", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxMDYxMQ==", "bodyText": "cwl => DescriptorLanguage.CWL.getShortName()", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442910611", "createdAt": "2020-06-19T15:38:01Z", "author": {"login": "garyluu"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java", "diffHunk": "@@ -118,6 +118,25 @@ public void testWorkflowDAGCWL() throws ApiException {\n \n     }\n \n+    @Test\n+    public void testWorkflowDAGCWLRequirementMap() throws ApiException {\n+        // Input: snaptools_create_snap_file.cwl\n+        // Repo: SnapTools\n+        // Branch: feature/docker_cwl_req_in_min\n+        // Test: normal cwl workflow DAG with requirement map\n+\n+        final List<String> strings = getJSON(\"DockstoreTestUser2/SnapTools\", \"/snaptools_create_snap_file.cwl\", \"cwl\", \"feature/docker_cwl_req_in_main\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxMDc3Mw==", "bodyText": "expected then actual", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442910773", "createdAt": "2020-06-19T15:38:20Z", "author": {"login": "garyluu"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java", "diffHunk": "@@ -118,6 +118,25 @@ public void testWorkflowDAGCWL() throws ApiException {\n \n     }\n \n+    @Test\n+    public void testWorkflowDAGCWLRequirementMap() throws ApiException {\n+        // Input: snaptools_create_snap_file.cwl\n+        // Repo: SnapTools\n+        // Branch: feature/docker_cwl_req_in_min\n+        // Test: normal cwl workflow DAG with requirement map\n+\n+        final List<String> strings = getJSON(\"DockstoreTestUser2/SnapTools\", \"/snaptools_create_snap_file.cwl\", \"cwl\", \"feature/docker_cwl_req_in_main\");\n+        int countNode = countNodeInJSON(strings);\n+\n+        Assert.assertTrue(\"JSON should not be blank\", strings.size() > 0);\n+        Assert.assertEquals(\"JSON should have eight nodes (including start and end)\", countNode, 8);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxMDg4MA==", "bodyText": "CWL \ud83d\udc4d", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442910880", "createdAt": "2020-06-19T15:38:36Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -583,6 +592,28 @@ private String parseSecondaryFile(String stepDockerRequirement, String secondary\n         return stepDockerRequirement;\n     }\n \n+    /**\n+     * Converts a JSON Object in CWL to JSON Array", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxNzIxMw==", "bodyText": "Optional: should be a way to stream + map requirements to reqArray", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442917213", "createdAt": "2020-06-19T15:50:51Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -583,6 +592,28 @@ private String parseSecondaryFile(String stepDockerRequirement, String secondary\n         return stepDockerRequirement;\n     }\n \n+    /**\n+     * Converts a JSON Object in CWL to JSON Array\n+     * @param keyName Name of key to convert (Ex. requirements, hints)\n+     * @param entryJson JSON representation of file\n+     * @return Updated JSON representation of file\n+     */\n+    private JSONObject convertJSONObjectToArray(String keyName, JSONObject entryJson) {\n+        if (entryJson.has(keyName)) {\n+            if (entryJson.get(keyName) instanceof JSONObject) {\n+                JSONArray reqArray = new JSONArray();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MTg5OTc4", "url": "https://github.com/dockstore/dockstore/pull/3587#pullrequestreview-434189978", "createdAt": "2020-06-19T16:02:36Z", "commit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2de6d812c602a346a1be2f7c65bce36b64c4e425", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/2de6d812c602a346a1be2f7c65bce36b64c4e425", "committedDate": "2020-06-19T17:06:06Z", "message": "updates from PR"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjYyMjgx", "url": "https://github.com/dockstore/dockstore/pull/3587#pullrequestreview-434262281", "createdAt": "2020-06-19T18:12:43Z", "commit": {"oid": "2de6d812c602a346a1be2f7c65bce36b64c4e425"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1OTYzOTM2", "url": "https://github.com/dockstore/dockstore/pull/3587#pullrequestreview-435963936", "createdAt": "2020-06-23T16:41:47Z", "commit": {"oid": "2de6d812c602a346a1be2f7c65bce36b64c4e425"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d09222d40015a8e1a0a86cf8af50c1ce5270dc27", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/d09222d40015a8e1a0a86cf8af50c1ce5270dc27", "committedDate": "2020-06-23T18:12:13Z", "message": "Update pull_robot swagger (#3584)\n\n* Update pull_robot swagger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb95ea66fd29a6c9185acc12c65e11dfed9c9def", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/eb95ea66fd29a6c9185acc12c65e11dfed9c9def", "committedDate": "2020-06-24T13:29:50Z", "message": "Merge branch 'develop' into feature/3035/requirements-map-error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9a88af3f9a9020bf163de4654df7588e66b6661", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/a9a88af3f9a9020bf163de4654df7588e66b6661", "committedDate": "2020-06-24T13:35:13Z", "message": "Revert \"Merge branch 'develop' into feature/3035/requirements-map-error\"\n\nThis reverts commit eb95ea66fd29a6c9185acc12c65e11dfed9c9def, reversing\nchanges made to 2de6d812c602a346a1be2f7c65bce36b64c4e425."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1757, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}