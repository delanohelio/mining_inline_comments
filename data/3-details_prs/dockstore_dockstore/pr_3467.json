{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2MzE3NDgz", "number": 3467, "title": "Fix/seab 1132/collection entries", "bodyText": "For SEAB-1132\nReduces the payload size from ~182 KB to ~800 B\nDB reduced from ~6000 statements to ~125", "createdAt": "2020-05-11T20:08:10Z", "url": "https://github.com/dockstore/dockstore/pull/3467", "merged": true, "mergeCommit": {"oid": "e1277af897f1f15156fa9a88bc1c4d56777826ad"}, "closed": true, "closedAt": "2020-05-15T19:09:00Z", "author": {"login": "garyluu"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgVahXAH2gAyNDE2MzE3NDgzOmUzZjRlMWJkNjhjZGUwZTAzMjQ3NTFjYmQ4MzllYWY0MDI1NDRmOWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchRljLgFqTQxMjA2Njk0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e3f4e1bd68cde0e0324751cbd839eaf402544f9f", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/e3f4e1bd68cde0e0324751cbd839eaf402544f9f", "committedDate": "2020-05-11T20:08:38Z", "message": "Custom type for collection entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dd3c45511951505a4888f262ec902b513c5e4b6", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/7dd3c45511951505a4888f262ec902b513c5e4b6", "committedDate": "2020-05-11T20:13:28Z", "message": "Update swagger/openapi"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2273a39a84d39a057fa5150059f49483b48b88d", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/e2273a39a84d39a057fa5150059f49483b48b88d", "committedDate": "2020-05-11T19:48:19Z", "message": "Update swagger/openapi"}, "afterCommit": {"oid": "7dd3c45511951505a4888f262ec902b513c5e4b6", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/7dd3c45511951505a4888f262ec902b513c5e4b6", "committedDate": "2020-05-11T20:13:28Z", "message": "Update swagger/openapi"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTE5OTYw", "url": "https://github.com/dockstore/dockstore/pull/3467#pullrequestreview-409519960", "createdAt": "2020-05-11T20:50:09Z", "commit": {"oid": "7dd3c45511951505a4888f262ec902b513c5e4b6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMDo1MDowOVrOGTs3Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMDo1MDowOVrOGTs3Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMxMTEyMw==", "bodyText": "This does reduce response size but getEntries will still load all entries (and thus their versions) into memory.\nIs there a reason the named query strategy was not used in this case?\nhttps://github.com/dockstore/dockstore/pull/3462/files#diff-f57cce37c04c1e6fa1392a205af9efefR41", "url": "https://github.com/dockstore/dockstore/pull/3467#discussion_r423311123", "createdAt": "2020-05-11T20:50:09Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Collection.java", "diffHunk": "@@ -142,6 +141,11 @@ public void setDescription(String description) {\n         return entries.stream().filter(entry -> entry.getIsPublished()).collect(Collectors.toSet());\n     }\n \n+    @JsonProperty(\"entries\")\n+    public Set<CollectionEntry> getCollectionEntries() {\n+        return getEntries().stream().map(entry -> new CollectionEntry(entry)).collect(Collectors.toSet());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7dd3c45511951505a4888f262ec902b513c5e4b6"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMDEzNzY5", "url": "https://github.com/dockstore/dockstore/pull/3467#pullrequestreview-410013769", "createdAt": "2020-05-12T12:59:26Z", "commit": {"oid": "7dd3c45511951505a4888f262ec902b513c5e4b6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMDg4OTA1", "url": "https://github.com/dockstore/dockstore/pull/3467#pullrequestreview-410088905", "createdAt": "2020-05-12T14:16:58Z", "commit": {"oid": "7dd3c45511951505a4888f262ec902b513c5e4b6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNDoxNjo1OFrOGUI3ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNDoxNjo1OFrOGUI3ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc3MDAxNA==", "bodyText": "Yes, I think you will need to modify the DAO and tackle specific endpoints to avoid loading entries and their versions and avert OOM\nAt least until #3455", "url": "https://github.com/dockstore/dockstore/pull/3467#discussion_r423770014", "createdAt": "2020-05-12T14:16:58Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Collection.java", "diffHunk": "@@ -142,6 +141,11 @@ public void setDescription(String description) {\n         return entries.stream().filter(entry -> entry.getIsPublished()).collect(Collectors.toSet());\n     }\n \n+    @JsonProperty(\"entries\")\n+    public Set<CollectionEntry> getCollectionEntries() {\n+        return getEntries().stream().map(entry -> new CollectionEntry(entry)).collect(Collectors.toSet());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMxMTEyMw=="}, "originalCommit": {"oid": "7dd3c45511951505a4888f262ec902b513c5e4b6"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cc22319d290c557e83f03da888d318fe735e6d9", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/8cc22319d290c557e83f03da888d318fe735e6d9", "committedDate": "2020-05-13T16:45:33Z", "message": "Database optimization"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5aa1b8d0f78d4a848fa837c4e57a29a2dad18d16", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/5aa1b8d0f78d4a848fa837c4e57a29a2dad18d16", "committedDate": "2020-05-13T14:52:33Z", "message": "Fix spotbugs"}, "afterCommit": {"oid": "8cc22319d290c557e83f03da888d318fe735e6d9", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/8cc22319d290c557e83f03da888d318fe735e6d9", "committedDate": "2020-05-13T16:45:33Z", "message": "Database optimization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6d0d8d2b75c86580bc17c0208697d94fa7ae1dd", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/f6d0d8d2b75c86580bc17c0208697d94fa7ae1dd", "committedDate": "2020-05-13T16:53:34Z", "message": "Update openapi/swagger again"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjU4OTgz", "url": "https://github.com/dockstore/dockstore/pull/3467#pullrequestreview-411258983", "createdAt": "2020-05-13T20:05:17Z", "commit": {"oid": "f6d0d8d2b75c86580bc17c0208697d94fa7ae1dd"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDowNToxN1rOGVBmIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDowNToxN1rOGVBmIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5OTQyNQ==", "bodyText": "I know it's a hassle, but why isn't the name value following the same naming convention as the other queries?", "url": "https://github.com/dockstore/dockstore/pull/3467#discussion_r424699425", "createdAt": "2020-05-13T20:05:17Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Entry.java", "diffHunk": "@@ -78,7 +78,10 @@\n @NamedQueries({\n     @NamedQuery(name = \"Entry.getGenericEntryById\", query = \"SELECT e from Entry e WHERE :id = e.id\"),\n         @NamedQuery(name = \"Entry.getGenericEntryByAlias\", query = \"SELECT e from Entry e JOIN e.aliases a WHERE KEY(a) IN :alias\"),\n-        @NamedQuery(name = \"io.dockstore.webservice.core.Entry.findCollectionsByEntryId\", query = \"select new io.dockstore.webservice.core.CollectionOrganization(col.id, col.name, col.displayName, organization.id, organization.name, organization.displayName) from Collection col join col.entries as entry join col.organization as organization where entry.id = :entryId\")\n+        @NamedQuery(name = \"io.dockstore.webservice.core.Entry.findCollectionsByEntryId\", query = \"select new io.dockstore.webservice.core.CollectionOrganization(col.id, col.name, col.displayName, organization.id, organization.name, organization.displayName) from Collection col join col.entries as entry join col.organization as organization where entry.id = :entryId\"),\n+        @NamedQuery(name = \"getCollectionWorkflows\", query = \"SELECT new io.dockstore.webservice.core.CollectionEntry(w.id, w.dbUpdateDate, 'workflow', w.sourceControl, w.organization, w.repository, w.workflowName) from BioWorkflow w, Collection col join col.entries as e where col.id = :collectionId and w.id = e.id and w.isPublished = true\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6d0d8d2b75c86580bc17c0208697d94fa7ae1dd"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExODcwOTU1", "url": "https://github.com/dockstore/dockstore/pull/3467#pullrequestreview-411870955", "createdAt": "2020-05-14T14:37:17Z", "commit": {"oid": "f6d0d8d2b75c86580bc17c0208697d94fa7ae1dd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNDozNzoxN1rOGVfZEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNDozOTozNVrOGVff1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE4NzYwMQ==", "bodyText": "Would like Javadoc for the class", "url": "https://github.com/dockstore/dockstore/pull/3467#discussion_r425187601", "createdAt": "2020-05-14T14:37:17Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/CollectionEntry.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package io.dockstore.webservice.core;\n+\n+import java.io.Serializable;\n+import java.util.Date;\n+\n+import io.dockstore.common.SourceControl;\n+\n+public class CollectionEntry implements Serializable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6d0d8d2b75c86580bc17c0208697d94fa7ae1dd"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE4OTMzNA==", "bodyText": "My understanding is that JPA named queries should have a namespace of some kind to avoid accidental collisions.\nI don't have a preference between package + class name or just class name since we don't have a Entry class in multiple packages\n\nDo note that query names are part of a global namespace and are not automatically put in any namespace  based on the file they are defined in. In the example above queries are pre-fixed with \"Website.\", which happens  to be the name of the entity but you can choose anything you want here.\n\nhttps://arjan-tijms.omnifaces.org/2010/09/where-to-put-named-queries-in-jpa.html", "url": "https://github.com/dockstore/dockstore/pull/3467#discussion_r425189334", "createdAt": "2020-05-14T14:39:35Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Entry.java", "diffHunk": "@@ -78,7 +78,10 @@\n @NamedQueries({\n     @NamedQuery(name = \"Entry.getGenericEntryById\", query = \"SELECT e from Entry e WHERE :id = e.id\"),\n         @NamedQuery(name = \"Entry.getGenericEntryByAlias\", query = \"SELECT e from Entry e JOIN e.aliases a WHERE KEY(a) IN :alias\"),\n-        @NamedQuery(name = \"io.dockstore.webservice.core.Entry.findCollectionsByEntryId\", query = \"select new io.dockstore.webservice.core.CollectionOrganization(col.id, col.name, col.displayName, organization.id, organization.name, organization.displayName) from Collection col join col.entries as entry join col.organization as organization where entry.id = :entryId\")\n+        @NamedQuery(name = \"io.dockstore.webservice.core.Entry.findCollectionsByEntryId\", query = \"select new io.dockstore.webservice.core.CollectionOrganization(col.id, col.name, col.displayName, organization.id, organization.name, organization.displayName) from Collection col join col.entries as entry join col.organization as organization where entry.id = :entryId\"),\n+        @NamedQuery(name = \"getCollectionWorkflows\", query = \"SELECT new io.dockstore.webservice.core.CollectionEntry(w.id, w.dbUpdateDate, 'workflow', w.sourceControl, w.organization, w.repository, w.workflowName) from BioWorkflow w, Collection col join col.entries as e where col.id = :collectionId and w.id = e.id and w.isPublished = true\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5OTQyNQ=="}, "originalCommit": {"oid": "f6d0d8d2b75c86580bc17c0208697d94fa7ae1dd"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2446b86fe8f80015f360a1f92ffe574c8d1ea296", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/2446b86fe8f80015f360a1f92ffe574c8d1ea296", "committedDate": "2020-05-14T14:51:54Z", "message": "PR changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExOTAxOTc1", "url": "https://github.com/dockstore/dockstore/pull/3467#pullrequestreview-411901975", "createdAt": "2020-05-14T15:07:56Z", "commit": {"oid": "2446b86fe8f80015f360a1f92ffe574c8d1ea296"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExOTg1MTQ4", "url": "https://github.com/dockstore/dockstore/pull/3467#pullrequestreview-411985148", "createdAt": "2020-05-14T16:35:07Z", "commit": {"oid": "2446b86fe8f80015f360a1f92ffe574c8d1ea296"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMDY2OTQ3", "url": "https://github.com/dockstore/dockstore/pull/3467#pullrequestreview-412066947", "createdAt": "2020-05-14T18:14:59Z", "commit": {"oid": "2446b86fe8f80015f360a1f92ffe574c8d1ea296"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1880, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}