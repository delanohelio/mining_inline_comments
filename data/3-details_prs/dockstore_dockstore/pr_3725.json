{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0ODg2NDAy", "number": 3725, "title": "Delete non-approved organizations", "bodyText": "#3254\nImplemented a new endpoint '/{organizationId}/deleteNonApprovedOrg' in\nOrganizationResource to delete a non-approved organization\nNew endpoint would delete all rows from multiple tables using\norganizationId before deleting the organization to avoid an FKEY error\nAdded a cascade parameter to 'users' in Organization.java in order\nto address and delete the organizationid FKEY\nImplemented a new method in EventDAO.java to delete a list of events\nhaving a specific organizationId\nAdded a new NamedQuery to Event.java to execute the SQL statement of\ndeleting events based on a given organizationId\nAdded a @consumes annotation for 'createOrganization' in order to\nspecify the content-type header as application/json so the test would\npass\nAdded a new test and stubObject for the new endpoint", "createdAt": "2020-08-07T23:44:43Z", "url": "https://github.com/dockstore/dockstore/pull/3725", "merged": true, "mergeCommit": {"oid": "8c4d0bc0590a155641f93ad769d5ae3bd32e7bab"}, "closed": true, "closedAt": "2020-08-13T17:16:49Z", "author": {"login": "ByteMap"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8tzBqAFqTQ2MzY5NzE5MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-TB5HgBqjM2NDk2NTQxMDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNjk3MTkw", "url": "https://github.com/dockstore/dockstore/pull/3725#pullrequestreview-463697190", "createdAt": "2020-08-08T00:21:33Z", "commit": {"oid": "5904406f6c2e5af519ff1314145deb6aabcdc6bc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQwMDoyMTozM1rOG9r7AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQwMDoyMTozM1rOG9r7AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMzNTkzNw==", "bodyText": "Path should simply be /{organizationId}. The @DELETE already says what it is doing to the org. In REST, think of paths as resources, not actions. The resource is the organization, specified by the id.", "url": "https://github.com/dockstore/dockstore/pull/3725#discussion_r467335937", "createdAt": "2020-08-08T00:21:33Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/OrganizationResource.java", "diffHunk": "@@ -409,6 +410,31 @@ private Organization getOrganizationByIdOptionalAuth(Optional<User> user, Long o\n         }\n     }\n \n+    @DELETE\n+    @Path(\"/{organizationId}/deleteNonApprovedOrg\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5904406f6c2e5af519ff1314145deb6aabcdc6bc"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NDAyOTgx", "url": "https://github.com/dockstore/dockstore/pull/3725#pullrequestreview-464402981", "createdAt": "2020-08-10T16:48:58Z", "commit": {"oid": "5904406f6c2e5af519ff1314145deb6aabcdc6bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNjo0ODo1OFrOG-W_RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNjo0ODo1OFrOG-W_RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA0MTU0MA==", "bodyText": "Doesn't seem quite correct. I'd expect something like https://swagger.io/docs/specification/describing-responses/  Empty Response Body", "url": "https://github.com/dockstore/dockstore/pull/3725#discussion_r468041540", "createdAt": "2020-08-10T16:48:58Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "diffHunk": "@@ -4930,6 +4927,26 @@ paths:\n       summary: Add an entry to a collection.\n       tags:\n         - organizations\n+  /organizations/{organizationId}/deleteNonApprovedOrg:\n+    delete:\n+      description: Delete rejected organization\n+      operationId: deleteRejectedOrPendingOrganization\n+      parameters:\n+        - description: Organization ID.\n+          in: path\n+          name: organizationId\n+          required: true\n+          schema:\n+            format: int64\n+            type: integer\n+      responses:\n+        default:\n+          content:\n+            application/json: {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5904406f6c2e5af519ff1314145deb6aabcdc6bc"}, "originalPosition": 101}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NDA1OTUz", "url": "https://github.com/dockstore/dockstore/pull/3725#pullrequestreview-464405953", "createdAt": "2020-08-10T16:52:59Z", "commit": {"oid": "5904406f6c2e5af519ff1314145deb6aabcdc6bc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNjo1Mjo1OVrOG-XIXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNzowNToyMVrOG-XkQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA0Mzg2OA==", "bodyText": "Why do you have two flushes here?\nWhy do have them at all? Is it because you need it to execute before the deleting of the org?\nIf you need either or both, can you please add a code comment explaining why.", "url": "https://github.com/dockstore/dockstore/pull/3725#discussion_r468043868", "createdAt": "2020-08-10T16:52:59Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/jdbi/EventDAO.java", "diffHunk": "@@ -91,6 +91,14 @@ public void deleteEventByEntryID(long entryId) {\n         currentSession().flush();\n     }\n \n+    public void deleteEventByOrganizationID(long organizationId) {\n+        currentSession().flush();\n+        Query<Event> query = this.currentSession().getNamedQuery(\"io.dockstore.webservice.core.Event.deleteByOrganizationId\");\n+        query.setParameter(\"organizationId\", organizationId);\n+        query.executeUpdate();\n+        currentSession().flush();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5904406f6c2e5af519ff1314145deb6aabcdc6bc"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA0NDEwMg==", "bodyText": "There is a namedQuery method you should be able to use.", "url": "https://github.com/dockstore/dockstore/pull/3725#discussion_r468044102", "createdAt": "2020-08-10T16:53:26Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/jdbi/EventDAO.java", "diffHunk": "@@ -91,6 +91,14 @@ public void deleteEventByEntryID(long entryId) {\n         currentSession().flush();\n     }\n \n+    public void deleteEventByOrganizationID(long organizationId) {\n+        currentSession().flush();\n+        Query<Event> query = this.currentSession().getNamedQuery(\"io.dockstore.webservice.core.Event.deleteByOrganizationId\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5904406f6c2e5af519ff1314145deb6aabcdc6bc"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA1MDE1MA==", "bodyText": "You are checking that it is not approved, not that it is rejected. We had some discussion about whether to also support allowing the deletion of pending organizations; if your intent is to support, which I guess it, based on the method name, then:\n\nYour error message and the annotations on line 417 and 418 should reflect both deleted and rejected.\nIt would be better to explicitly check for the states we allow deletion for rather than the states we don't allow deletion for. IOW, check for the org being rejected or pending, instead of checking that is approved. This may sound silly, since they are today logically equivalent, but maybe someday we'll add a new state, I don't know, like SUSPENDED, which we wouldn't want to be deletable. This code as is would by default allow deletion of any new states.", "url": "https://github.com/dockstore/dockstore/pull/3725#discussion_r468050150", "createdAt": "2020-08-10T17:03:44Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/OrganizationResource.java", "diffHunk": "@@ -409,6 +410,31 @@ private Organization getOrganizationByIdOptionalAuth(Optional<User> user, Long o\n         }\n     }\n \n+    @DELETE\n+    @Path(\"/{organizationId}/deleteNonApprovedOrg\")\n+    @Timed\n+    @UnitOfWork\n+    @ApiOperation(value = \"Deletes an organization that has been rejected\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = void.class, hidden = true)\n+    @Operation(operationId = \"deleteRejectedOrPendingOrganization\", summary = \"Delete rejected organization\", description = \"Delete rejected organization\")\n+    public void deleteRejectedOrPendingOrganization(\n+            @ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\") @Auth Optional<User> user,\n+            @Parameter(description = \"Organization ID.\", name = \"organizationId\", in = ParameterIn.PATH, required = true) @PathParam(\"organizationId\") Long organizationId) {\n+        Organization organization = organizationDAO.findById(organizationId);\n+\n+        if (organization.getStatus() == Organization.ApplicationState.APPROVED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5904406f6c2e5af519ff1314145deb6aabcdc6bc"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA1MDQyMw==", "bodyText": "User must be required", "url": "https://github.com/dockstore/dockstore/pull/3725#discussion_r468050423", "createdAt": "2020-08-10T17:04:17Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/OrganizationResource.java", "diffHunk": "@@ -409,6 +410,31 @@ private Organization getOrganizationByIdOptionalAuth(Optional<User> user, Long o\n         }\n     }\n \n+    @DELETE\n+    @Path(\"/{organizationId}/deleteNonApprovedOrg\")\n+    @Timed\n+    @UnitOfWork\n+    @ApiOperation(value = \"Deletes an organization that has been rejected\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = void.class, hidden = true)\n+    @Operation(operationId = \"deleteRejectedOrPendingOrganization\", summary = \"Delete rejected organization\", description = \"Delete rejected organization\")\n+    public void deleteRejectedOrPendingOrganization(\n+            @ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\") @Auth Optional<User> user,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5904406f6c2e5af519ff1314145deb6aabcdc6bc"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA1MTAwOA==", "bodyText": "You need to check if user owns the org and/or is an admin or curator. Otherwise any user could delete any org. In fixing this, please add a test that ensures a user cannot delete an org they don't have permissions to.", "url": "https://github.com/dockstore/dockstore/pull/3725#discussion_r468051008", "createdAt": "2020-08-10T17:05:21Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/OrganizationResource.java", "diffHunk": "@@ -409,6 +410,31 @@ private Organization getOrganizationByIdOptionalAuth(Optional<User> user, Long o\n         }\n     }\n \n+    @DELETE\n+    @Path(\"/{organizationId}/deleteNonApprovedOrg\")\n+    @Timed\n+    @UnitOfWork\n+    @ApiOperation(value = \"Deletes an organization that has been rejected\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = void.class, hidden = true)\n+    @Operation(operationId = \"deleteRejectedOrPendingOrganization\", summary = \"Delete rejected organization\", description = \"Delete rejected organization\")\n+    public void deleteRejectedOrPendingOrganization(\n+            @ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\") @Auth Optional<User> user,\n+            @Parameter(description = \"Organization ID.\", name = \"organizationId\", in = ParameterIn.PATH, required = true) @PathParam(\"organizationId\") Long organizationId) {\n+        Organization organization = organizationDAO.findById(organizationId);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5904406f6c2e5af519ff1314145deb6aabcdc6bc"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NDM0NjE0", "url": "https://github.com/dockstore/dockstore/pull/3725#pullrequestreview-464434614", "createdAt": "2020-08-10T17:33:49Z", "commit": {"oid": "5904406f6c2e5af519ff1314145deb6aabcdc6bc"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MzA4NDIw", "url": "https://github.com/dockstore/dockstore/pull/3725#pullrequestreview-465308420", "createdAt": "2020-08-11T18:08:16Z", "commit": {"oid": "2fc56e081f6d3fcc14b928bd0113a16abb29c13a"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxODowODoxNlrOG_DY3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxODoxNTo0OFrOG_Dpsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc2ODk4OA==", "bodyText": "I think these two lines are redundant.", "url": "https://github.com/dockstore/dockstore/pull/3725#discussion_r468768988", "createdAt": "2020-08-11T18:08:16Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/jdbi/EventDAO.java", "diffHunk": "@@ -91,6 +91,17 @@ public void deleteEventByEntryID(long entryId) {\n         currentSession().flush();\n     }\n \n+    public void deleteEventByOrganizationID(long organizationId) {\n+        Query query = namedQuery(\"io.dockstore.webservice.core.Event.deleteByOrganizationId\");\n+        query.setParameter(\"organizationId\", organizationId);\n+        query.executeUpdate();\n+        // Flush after executing the DELETE query. This would force Hibernate to synchronize the state of the\n+        // current session with the database so the session can see that an organization has been deleted\n+        // NOTE: Flushing does not commit the changes; manually accessing the DB will result with no changes to the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fc56e081f6d3fcc14b928bd0113a16abb29c13a"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc2OTMxMw==", "bodyText": "You're deleting events here, not an organization.", "url": "https://github.com/dockstore/dockstore/pull/3725#discussion_r468769313", "createdAt": "2020-08-11T18:08:53Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/jdbi/EventDAO.java", "diffHunk": "@@ -91,6 +91,17 @@ public void deleteEventByEntryID(long entryId) {\n         currentSession().flush();\n     }\n \n+    public void deleteEventByOrganizationID(long organizationId) {\n+        Query query = namedQuery(\"io.dockstore.webservice.core.Event.deleteByOrganizationId\");\n+        query.setParameter(\"organizationId\", organizationId);\n+        query.executeUpdate();\n+        // Flush after executing the DELETE query. This would force Hibernate to synchronize the state of the\n+        // current session with the database so the session can see that an organization has been deleted", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fc56e081f6d3fcc14b928bd0113a16abb29c13a"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc3MTI5Ng==", "bodyText": "Do you need this line? May be necessary because of the interaction with related entities, but it seems weird that you have to update it in order to delete it.\nNot 100% sure of this, but I like it better how for users you don't have to explicitly delete (clear) them here any more. For lines 433 and 434, could you accomplish via annotations instead, and just have lines 436 and 438 in this block?", "url": "https://github.com/dockstore/dockstore/pull/3725#discussion_r468771296", "createdAt": "2020-08-11T18:12:27Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/OrganizationResource.java", "diffHunk": "@@ -409,6 +410,37 @@ private Organization getOrganizationByIdOptionalAuth(Optional<User> user, Long o\n         }\n     }\n \n+    @DELETE\n+    @Path(\"/{organizationId}\")\n+    @Timed\n+    @UnitOfWork\n+    @ApiOperation(value = \"Deletes an organization that is pending or rejected\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, hidden = true)\n+    @Operation(operationId = \"deleteRejectedOrPendingOrganization\", summary = \"Delete pending or rejected organization\", description = \"Delete pending or rejected organization\", security = @SecurityRequirement(name = \"bearer\"))\n+    public void deleteRejectedOrPendingOrganization(\n+            @Parameter(hidden = true, name = \"user\") @Auth User user,\n+            @Parameter(description = \"Organization ID.\", name = \"organizationId\", in = ParameterIn.PATH, required = true) @PathParam(\"organizationId\") Long organizationId) {\n+        Organization organization = organizationDAO.findById(organizationId);\n+        OrganizationUser orgUser = getUserOrgRole(organization, user.getId());\n+\n+        // If the user does not belong to the organization or if the user is not a maintainer of the organization\n+        // and if the user is neither an admin nor curator, then throw an error\n+        if ((orgUser == null || orgUser.getRole() != OrganizationUser.Role.MAINTAINER) && (!user.isCurator() && !user.getIsAdmin())) {\n+            throw new CustomWebApplicationException(\"You do not have access to delete this organization\", HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        // If the organization to be deleted is pending or has been rejected, then delete the organization\n+        if (organization.getStatus() == Organization.ApplicationState.PENDING || organization.getStatus() == Organization.ApplicationState.REJECTED) {\n+            organization.getStarredUsers().clear();\n+            organization.getAliases().clear();\n+\n+            eventDAO.deleteEventByOrganizationID(organizationId);\n+            organizationDAO.update(organization);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fc56e081f6d3fcc14b928bd0113a16abb29c13a"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc3MzI5OA==", "bodyText": "You have a double negative, and it's generally easier to understand positive statements, so I suggest \"You can only delete pending or rejected organizations\".", "url": "https://github.com/dockstore/dockstore/pull/3725#discussion_r468773298", "createdAt": "2020-08-11T18:15:48Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/OrganizationResource.java", "diffHunk": "@@ -409,6 +410,37 @@ private Organization getOrganizationByIdOptionalAuth(Optional<User> user, Long o\n         }\n     }\n \n+    @DELETE\n+    @Path(\"/{organizationId}\")\n+    @Timed\n+    @UnitOfWork\n+    @ApiOperation(value = \"Deletes an organization that is pending or rejected\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, hidden = true)\n+    @Operation(operationId = \"deleteRejectedOrPendingOrganization\", summary = \"Delete pending or rejected organization\", description = \"Delete pending or rejected organization\", security = @SecurityRequirement(name = \"bearer\"))\n+    public void deleteRejectedOrPendingOrganization(\n+            @Parameter(hidden = true, name = \"user\") @Auth User user,\n+            @Parameter(description = \"Organization ID.\", name = \"organizationId\", in = ParameterIn.PATH, required = true) @PathParam(\"organizationId\") Long organizationId) {\n+        Organization organization = organizationDAO.findById(organizationId);\n+        OrganizationUser orgUser = getUserOrgRole(organization, user.getId());\n+\n+        // If the user does not belong to the organization or if the user is not a maintainer of the organization\n+        // and if the user is neither an admin nor curator, then throw an error\n+        if ((orgUser == null || orgUser.getRole() != OrganizationUser.Role.MAINTAINER) && (!user.isCurator() && !user.getIsAdmin())) {\n+            throw new CustomWebApplicationException(\"You do not have access to delete this organization\", HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        // If the organization to be deleted is pending or has been rejected, then delete the organization\n+        if (organization.getStatus() == Organization.ApplicationState.PENDING || organization.getStatus() == Organization.ApplicationState.REJECTED) {\n+            organization.getStarredUsers().clear();\n+            organization.getAliases().clear();\n+\n+            eventDAO.deleteEventByOrganizationID(organizationId);\n+            organizationDAO.update(organization);\n+            organizationDAO.delete(organization);\n+        } else { // else if the organization is not pending nor rejected, then throw an error\n+            throw new CustomWebApplicationException(\"You cannot delete an organization that is not currently pending or rejected\", HttpStatus.SC_BAD_REQUEST);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fc56e081f6d3fcc14b928bd0113a16abb29c13a"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MzM5OTg4", "url": "https://github.com/dockstore/dockstore/pull/3725#pullrequestreview-465339988", "createdAt": "2020-08-11T18:51:05Z", "commit": {"oid": "2fc56e081f6d3fcc14b928bd0113a16abb29c13a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxODo1MTowNVrOG_E-Zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxODo1MTowNVrOG_E-Zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc5NDk4Mg==", "bodyText": "I think this annotation may be confusing (people may be under the impression that adding/removing anything here will have some effect.  Just make it @ApiOperation(value = \"hidden\", hidden = true)", "url": "https://github.com/dockstore/dockstore/pull/3725#discussion_r468794982", "createdAt": "2020-08-11T18:51:05Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/OrganizationResource.java", "diffHunk": "@@ -409,6 +410,37 @@ private Organization getOrganizationByIdOptionalAuth(Optional<User> user, Long o\n         }\n     }\n \n+    @DELETE\n+    @Path(\"/{organizationId}\")\n+    @Timed\n+    @UnitOfWork\n+    @ApiOperation(value = \"Deletes an organization that is pending or rejected\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, hidden = true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fc56e081f6d3fcc14b928bd0113a16abb29c13a"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NDQzMjc0", "url": "https://github.com/dockstore/dockstore/pull/3725#pullrequestreview-465443274", "createdAt": "2020-08-11T21:30:58Z", "commit": {"oid": "f3a721de4cf671041916cbb896721c4bb3c6230a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMTozMDo1OFrOG_J8nQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMTozMDo1OFrOG_J8nQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg3NjQ0NQ==", "bodyText": "200 is OK,\n204 is No Content", "url": "https://github.com/dockstore/dockstore/pull/3725#discussion_r468876445", "createdAt": "2020-08-11T21:30:58Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "diffHunk": "@@ -4550,6 +4547,29 @@ paths:\n       tags:\n         - organizations\n   /organizations/{organizationId}:\n+    delete:\n+      description: Delete pending or rejected organization\n+      operationId: deleteRejectedOrPendingOrganization\n+      parameters:\n+        - description: Organization ID.\n+          in: path\n+          name: organizationId\n+          required: true\n+          schema:\n+            format: int64\n+            type: integer\n+      responses:\n+        \"204\":\n+          description: OK", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3a721de4cf671041916cbb896721c4bb3c6230a"}, "originalPosition": 90}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3a721de4cf671041916cbb896721c4bb3c6230a", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/f3a721de4cf671041916cbb896721c4bb3c6230a", "committedDate": "2020-08-11T21:29:17Z", "message": "Fixed openAPI empty response body"}, "afterCommit": {"oid": "91a6dea323cc950c05de68cbb090a74d7d4ca2ba", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/91a6dea323cc950c05de68cbb090a74d7d4ca2ba", "committedDate": "2020-08-11T21:31:43Z", "message": "Fixed openAPI empty response body"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NDg0NTE5", "url": "https://github.com/dockstore/dockstore/pull/3725#pullrequestreview-465484519", "createdAt": "2020-08-11T23:01:07Z", "commit": {"oid": "cf3bbd7083e84bad20d4ae3cab0c21a10c920b13"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MDk2MDg5", "url": "https://github.com/dockstore/dockstore/pull/3725#pullrequestreview-466096089", "createdAt": "2020-08-12T16:48:33Z", "commit": {"oid": "cf3bbd7083e84bad20d4ae3cab0c21a10c920b13"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNjo0ODozM1rOG_p4NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNjo0ODozM1rOG_p4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM5OTYwNA==", "bodyText": "Should be \"have been rejected\" -- the subject is plural -- \"organizations\".", "url": "https://github.com/dockstore/dockstore/pull/3725#discussion_r469399604", "createdAt": "2020-08-12T16:48:33Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/OrganizationResource.java", "diffHunk": "@@ -409,6 +412,38 @@ private Organization getOrganizationByIdOptionalAuth(Optional<User> user, Long o\n         }\n     }\n \n+    @DELETE\n+    @Path(\"/{organizationId}\")\n+    @Timed\n+    @UnitOfWork\n+    @ApiOperation(value = \"hidden\", hidden = true)\n+    @Operation(operationId = \"deleteRejectedOrPendingOrganization\", summary = \"Delete pending or rejected organization\", description = \"Delete pending or rejected organization\", security = @SecurityRequirement(name = \"bearer\"))\n+    @ApiResponses(value = {\n+            @ApiResponse(responseCode = \"204\", description = \"NO CONTENT\"),\n+            @ApiResponse(responseCode = \"400\", description = \"BAD REQUEST\"),\n+            @ApiResponse(responseCode = \"403\", description = \"FORBIDDEN\")\n+    })\n+    public void deleteRejectedOrPendingOrganization(\n+            @Parameter(hidden = true, name = \"user\") @Auth User user,\n+            @Parameter(description = \"Organization ID.\", name = \"organizationId\", in = ParameterIn.PATH, required = true) @PathParam(\"organizationId\") Long organizationId) {\n+        Organization organization = organizationDAO.findById(organizationId);\n+        OrganizationUser orgUser = getUserOrgRole(organization, user.getId());\n+\n+        // If the user does not belong to the organization or if the user is not a maintainer of the organization\n+        // and if the user is neither an admin nor curator, then throw an error\n+        if ((orgUser == null || orgUser.getRole() != OrganizationUser.Role.MAINTAINER) && (!user.isCurator() && !user.getIsAdmin())) {\n+            throw new CustomWebApplicationException(\"You do not have access to delete this organization\", HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        // If the organization to be deleted is pending or has been rejected, then delete the organization\n+        if (organization.getStatus() == Organization.ApplicationState.PENDING || organization.getStatus() == Organization.ApplicationState.REJECTED) {\n+            eventDAO.deleteEventByOrganizationID(organizationId);\n+            organizationDAO.delete(organization);\n+        } else { // else if the organization is not pending nor rejected, then throw an error\n+            throw new CustomWebApplicationException(\"You can only delete organizations that are pending or has been rejected\", HttpStatus.SC_BAD_REQUEST);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf3bbd7083e84bad20d4ae3cab0c21a10c920b13"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MjUxOTE1", "url": "https://github.com/dockstore/dockstore/pull/3725#pullrequestreview-466251915", "createdAt": "2020-08-12T20:30:13Z", "commit": {"oid": "f0dcad8df10bf926d62f273326745c2a533e0b53"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MjYxMzk5", "url": "https://github.com/dockstore/dockstore/pull/3725#pullrequestreview-466261399", "createdAt": "2020-08-12T20:41:33Z", "commit": {"oid": "f0dcad8df10bf926d62f273326745c2a533e0b53"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a488988a7b66617b4043c1168d3a1e1e8ed2a7e", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/1a488988a7b66617b4043c1168d3a1e1e8ed2a7e", "committedDate": "2020-08-12T22:19:27Z", "message": "Delete non-approved organizations\n\ndockstore/dockstore#3254\n\nImplemented a new endpoint '/{organizationId}/deleteNonApprovedOrg' in\nOrganizationResource to delete a non-approved organization\n\nNew endpoint would delete all rows from multiple tables using\norganizationId before deleting the organization to avoid an FKEY error\n\nAdded a cascade parameter to 'users' in Organization.java in order\nto address and delete the organizationid FKEY\n\nImplemented a new method in EventDAO.java to delete a list of events\nhaving a specific organizationId\n\nAdded a new NamedQuery to Event.java to execute the SQL statement of\ndeleting events based on a given organizationId\n\nAdded a @Consumes annotation for 'createOrganization' in order to\nspecify the content-type header as application/json so the test would\npass\n\nAdded a new test and stubObject for the new endpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a93a636dee4d770338e8e5768a40ad70b53520cc", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/a93a636dee4d770338e8e5768a40ad70b53520cc", "committedDate": "2020-08-12T22:19:27Z", "message": "Addressed comments and improved endpoint\n\nAPI call now allows for admins/curators to delete any rejected or\npending organizations regardless whether or not the admins/curators are\npart of\n\nRemoved 'getUsers().clear()'' and 'getCollections().clear()' from\nendpoint as the functionality of getDataFromColumn() only applies\nto those columns who have the '@JoinTable' annotation\n\nMigrated from cascade to orphanRemoval for oganization.users as\nCascadeType.REMOVE or CascadeType.ALL does not always remove\nchild entities using organizationid, which causes FKEY errors\n\nRefactored endpoint path name to be more RESTful\n\nRefactored endpoint description to match the functionality of the API\ncall\n\nRemoved the first flush() for 'deleteEventByOrganizationID' as it was\nnot necessary and included a comment for the purpose of the second\nflush()\n\nMigrated to using 'namedQuery()' for deleteEventByOrganizationID\n\nIncluded additional tests for functionality with admins/curators"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "724afc88d04cb2d86322994689892d21eb6673f2", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/724afc88d04cb2d86322994689892d21eb6673f2", "committedDate": "2020-08-12T22:19:27Z", "message": "Addressed PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90e00824a6a01155d527eafd4df9980057840476", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/90e00824a6a01155d527eafd4df9980057840476", "committedDate": "2020-08-12T22:19:27Z", "message": "Fixed openAPI empty response body"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d572bcceb244742cf8ba53a2c2479c65d020a1f2", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/d572bcceb244742cf8ba53a2c2479c65d020a1f2", "committedDate": "2020-08-12T22:19:27Z", "message": "Fixed response code description"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de2e50778cee5e844e52f06bf2f0dcabeb1cc225", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/de2e50778cee5e844e52f06bf2f0dcabeb1cc225", "committedDate": "2020-08-12T22:19:27Z", "message": "Updated openapi.yaml and fixed grammar"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f0dcad8df10bf926d62f273326745c2a533e0b53", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/f0dcad8df10bf926d62f273326745c2a533e0b53", "committedDate": "2020-08-12T18:59:19Z", "message": "Updated openapi.yaml and fixed grammar"}, "afterCommit": {"oid": "de2e50778cee5e844e52f06bf2f0dcabeb1cc225", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/de2e50778cee5e844e52f06bf2f0dcabeb1cc225", "committedDate": "2020-08-12T22:19:27Z", "message": "Updated openapi.yaml and fixed grammar"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1716, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}