{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxNTAxNDM3", "number": 3491, "title": "Feature/3486/endpoint add user to workflows", "bodyText": "#3486\nEndpoint that adds a user to all workflows that they should have access to that already exist on Dockstore.", "createdAt": "2020-05-21T18:15:07Z", "url": "https://github.com/dockstore/dockstore/pull/3491", "merged": true, "mergeCommit": {"oid": "30b8f385025de5697d7537c6ee5b27b38d9aafe2"}, "closed": true, "closedAt": "2020-05-29T20:00:17Z", "author": {"login": "agduncan94"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjfSfSgH2gAyNDIxNTAxNDM3OjExNGJkMzM2MmUwNGUwYjVlNzZkMjhiMDEyOTg3N2E4MGE2ZWM2ZTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcmGjtFAH2gAyNDIxNTAxNDM3OjhkNTk5YzEyM2QwZjEwMTkwMGFiNjVlZjRmY2IxMWEzYjEwNGM0MzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "114bd3362e04e0b5e76d28b0129877a80a6ec6e1", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/114bd3362e04e0b5e76d28b0129877a80a6ec6e1", "committedDate": "2020-05-21T15:20:41Z", "message": "add endpoint for adding user to all workflows they should have access to"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "134ca6e2236d4d85c7f83ea473eceed59b315e62", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/134ca6e2236d4d85c7f83ea473eceed59b315e62", "committedDate": "2020-05-21T18:12:24Z", "message": "only refresh bioworkflows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5bdcd9dbedd43b380a00874bf246f2143446c98", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/d5bdcd9dbedd43b380a00874bf246f2143446c98", "committedDate": "2020-05-21T20:16:21Z", "message": "refresh bitbucket token"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a9407be5f95e922cff3e23eb45617b8a3b05323", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/8a9407be5f95e922cff3e23eb45617b8a3b05323", "committedDate": "2020-05-21T20:16:53Z", "message": "add test for new endpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebc25070b2bd37303e27e09c4de22be3353a6616", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/ebc25070b2bd37303e27e09c4de22be3353a6616", "committedDate": "2020-05-21T20:31:55Z", "message": "parameter number ignore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NTA3MDYz", "url": "https://github.com/dockstore/dockstore/pull/3491#pullrequestreview-416507063", "createdAt": "2020-05-21T21:30:27Z", "commit": {"oid": "ebc25070b2bd37303e27e09c4de22be3353a6616"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMTo0Mjo1NVrOGZD-Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMTo0Mjo1NVrOGZD-Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkzMjY0Ng==", "bodyText": "This looks like this was it copied from AbstractWorkflowResource. We should avoid the duplication, and rename it in the process -- when I saw its invocation above, I started to enter a comment, based on the name, that it was only going return BitBucket tokens.\nNot for this PR, but for down the road, if we get more BitBucket users, we  should consider updating this method, which is why it would be good if it only existed once -- we shouldn't be generating a new access token every time, but only when the curent one has  expired or is close to expired.", "url": "https://github.com/dockstore/dockstore/pull/3491#discussion_r428932646", "createdAt": "2020-05-21T21:42:55Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -840,6 +891,19 @@ private boolean canDeleteWorkflow(String path) {\n         }\n     }\n \n+    protected List<Token> checkOnBitbucketToken(User user) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebc25070b2bd37303e27e09c4de22be3353a6616"}, "originalPosition": 118}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95e9a08eeb0dd8e12637a5895e7ca2bfdaab836c", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/95e9a08eeb0dd8e12637a5895e7ca2bfdaab836c", "committedDate": "2020-05-22T12:54:35Z", "message": "suggestions from pr"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2OTM5MTI4", "url": "https://github.com/dockstore/dockstore/pull/3491#pullrequestreview-416939128", "createdAt": "2020-05-22T14:06:57Z", "commit": {"oid": "95e9a08eeb0dd8e12637a5895e7ca2bfdaab836c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNDowNjo1N1rOGZYawA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNDoxMzo0MlrOGZYpng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI2NzY0OA==", "bodyText": "Readd", "url": "https://github.com/dockstore/dockstore/pull/3491#discussion_r429267648", "createdAt": "2020-05-22T14:06:57Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -85,6 +85,24 @@ public void resetDBBetweenTests() throws Exception {\n         CommonTestUtilities.cleanStatePrivate2(SUPPORT, false);\n     }\n \n+    @Test\n+    public void testAddUserToOrgs() {\n+        ApiClient client = getWebClient(USER_2_USERNAME, testingPostgres);\n+        UsersApi userApi = new UsersApi(client);\n+        List<Workflow> workflows = userApi.refreshWorkflowsByOrganization((long)1, \"DockstoreTestUser\");\n+\n+        // Remove an association with an entry\n+        long numberOfWorkflows = workflows.size();\n+        testingPostgres.runUpdateStatement(\"delete from user_entry where entryid = 951\");\n+        long newNumberOfWorkflows = userApi.userWorkflows((long)1).size();\n+        assertEquals(\"Should have one less workflow\", numberOfWorkflows - 1, newNumberOfWorkflows);\n+\n+        // Readd user", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e9a08eeb0dd8e12637a5895e7ca2bfdaab836c"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI3MTQ1NA==", "bodyText": "Does this work, it looks like you're asking the serviceDAO for workflows when it seems like workflowDAO is what I would have expected. Tests are passing though ... which might mean that this needs tests?", "url": "https://github.com/dockstore/dockstore/pull/3491#discussion_r429271454", "createdAt": "2020-05-22T14:13:42Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -554,6 +562,16 @@ private void checkToolTokens(User authUser, Long userId, String organization) {\n         return services;\n     }\n \n+    private List<Workflow> getBioworkflows(User user) {\n+        return serviceDAO.findMyEntries(user.getId()).stream().map(BioWorkflow.class::cast).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e9a08eeb0dd8e12637a5895e7ca2bfdaab836c"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f27bc218d7422e294af902094c257a5a866c5749", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/f27bc218d7422e294af902094c257a5a866c5749", "committedDate": "2020-05-25T14:49:57Z", "message": "suggested fixes from pr"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NzY5MDcw", "url": "https://github.com/dockstore/dockstore/pull/3491#pullrequestreview-417769070", "createdAt": "2020-05-25T15:08:44Z", "commit": {"oid": "f27bc218d7422e294af902094c257a5a866c5749"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNTowODo0NFrOGaEC1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNToxMToxNVrOGaEG0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4MjQyMQ==", "bodyText": "Channeling Charles, is this a PUT because it is idempotent?", "url": "https://github.com/dockstore/dockstore/pull/3491#discussion_r429982421", "createdAt": "2020-05-25T15:08:44Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -762,6 +780,39 @@ public Limits setUserLimits(@ApiParam(hidden = true) @Auth User authUser,\n         return getStrippedWorkflowsAndServices(userDAO.findById(user.getId()));\n     }\n \n+    @POST", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f27bc218d7422e294af902094c257a5a866c5749"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4MzQ0Mg==", "bodyText": "Should test something about the workflows (follow up on serviceDAO discussion)\ne.g. if by some bizarro coincidence this returned an equal number of services vs workflows", "url": "https://github.com/dockstore/dockstore/pull/3491#discussion_r429983442", "createdAt": "2020-05-25T15:11:15Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -85,6 +85,23 @@ public void resetDBBetweenTests() throws Exception {\n         CommonTestUtilities.cleanStatePrivate2(SUPPORT, false);\n     }\n \n+    @Test\n+    public void testAddUserToOrgs() {\n+        ApiClient client = getWebClient(USER_2_USERNAME, testingPostgres);\n+        UsersApi userApi = new UsersApi(client);\n+        List<Workflow> workflows = userApi.refreshWorkflowsByOrganization((long)1, \"DockstoreTestUser\");\n+\n+        // Remove an association with an entry\n+        long numberOfWorkflows = workflows.size();\n+        testingPostgres.runUpdateStatement(\"delete from user_entry where entryid = 951\");\n+        long newNumberOfWorkflows = userApi.userWorkflows((long)1).size();\n+        assertEquals(\"Should have one less workflow\", numberOfWorkflows - 1, newNumberOfWorkflows);\n+\n+        // Add user again\n+        newNumberOfWorkflows= userApi.addUserToDockstoreWorkflows().size();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f27bc218d7422e294af902094c257a5a866c5749"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c4e33b01c8eb4346d2f5b7b28dd522b2c44bd6a", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/0c4e33b01c8eb4346d2f5b7b28dd522b2c44bd6a", "committedDate": "2020-05-25T18:30:10Z", "message": "fix checkstyle; better test; PUT endpoint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3ODI4ODU0", "url": "https://github.com/dockstore/dockstore/pull/3491#pullrequestreview-417828854", "createdAt": "2020-05-25T17:54:03Z", "commit": {"oid": "f27bc218d7422e294af902094c257a5a866c5749"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNzo1NDowM1rOGaHJqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxODo0NTo0NlrOGaH5GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAzMzMyMA==", "bodyText": "For new endpoints just use OpenAPI only, remove the Swagger", "url": "https://github.com/dockstore/dockstore/pull/3491#discussion_r430033320", "createdAt": "2020-05-25T17:54:03Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -762,6 +780,39 @@ public Limits setUserLimits(@ApiParam(hidden = true) @Auth User authUser,\n         return getStrippedWorkflowsAndServices(userDAO.findById(user.getId()));\n     }\n \n+    @POST\n+    @Path(\"/workflow\")\n+    @Timed\n+    @UnitOfWork\n+    @Operation(operationId = \"addUserToDockstoreWorkflows\", description = \"Adds a user to any Dockstore workflows that they should have access to.\", security = @SecurityRequirement(name = ResourceConstants.OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Adds a user to any Dockstore workflows that they should have access to.\", authorizations = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f27bc218d7422e294af902094c257a5a866c5749"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAzMzM4OA==", "bodyText": "Should be using OpenAPI client", "url": "https://github.com/dockstore/dockstore/pull/3491#discussion_r430033388", "createdAt": "2020-05-25T17:54:22Z", "author": {"login": "garyluu"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -85,6 +85,23 @@ public void resetDBBetweenTests() throws Exception {\n         CommonTestUtilities.cleanStatePrivate2(SUPPORT, false);\n     }\n \n+    @Test\n+    public void testAddUserToOrgs() {\n+        ApiClient client = getWebClient(USER_2_USERNAME, testingPostgres);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f27bc218d7422e294af902094c257a5a866c5749"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAzMzY2MA==", "bodyText": "anything not /{userId} should be avoided to be RESTful.", "url": "https://github.com/dockstore/dockstore/pull/3491#discussion_r430033660", "createdAt": "2020-05-25T17:55:24Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -762,6 +780,39 @@ public Limits setUserLimits(@ApiParam(hidden = true) @Auth User authUser,\n         return getStrippedWorkflowsAndServices(userDAO.findById(user.getId()));\n     }\n \n+    @POST\n+    @Path(\"/workflow\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f27bc218d7422e294af902094c257a5a866c5749"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAzODI2NQ==", "bodyText": "Fine for now, someone should probably just call similar code to the userWorkflows endpoint after it's been optimized", "url": "https://github.com/dockstore/dockstore/pull/3491#discussion_r430038265", "createdAt": "2020-05-25T18:13:37Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -762,6 +780,39 @@ public Limits setUserLimits(@ApiParam(hidden = true) @Auth User authUser,\n         return getStrippedWorkflowsAndServices(userDAO.findById(user.getId()));\n     }\n \n+    @POST\n+    @Path(\"/workflow\")\n+    @Timed\n+    @UnitOfWork\n+    @Operation(operationId = \"addUserToDockstoreWorkflows\", description = \"Adds a user to any Dockstore workflows that they should have access to.\", security = @SecurityRequirement(name = ResourceConstants.OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Adds a user to any Dockstore workflows that they should have access to.\", authorizations = {\n+            @Authorization(value = JWT_SECURITY_DEFINITION_NAME) },\n+            response = Workflow.class, responseContainer = \"List\")\n+    public List<Workflow> addUserToDockstoreWorkflows(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\", in = ParameterIn.HEADER) @Auth User authUser) {\n+        final User user = userDAO.findById(authUser.getId());\n+        // Ignore hosted workflows\n+        List<SourceControl> sourceControls = Arrays.stream(SourceControl.values()).filter(sourceControl -> !Objects.equals(sourceControl, SourceControl.DOCKSTORE)).collect(\n+                Collectors.toList());\n+\n+        List<Token> scTokens = getAndRefreshTokens(user, tokenDAO, client, bitbucketClientID, bitbucketClientSecret)\n+                .stream()\n+                .filter(token -> sourceControls.contains(token.getTokenSource().getSourceControl()))\n+                .collect(Collectors.toList());\n+\n+        scTokens.stream().forEach(token -> {\n+            SourceCodeRepoInterface sourceCodeRepo =  SourceCodeRepoFactory.createSourceCodeRepo(token, client);\n+            Map<String, String> gitUrlToRepositoryId = sourceCodeRepo.getWorkflowGitUrl2RepositoryId();\n+            Set<String> organizations = gitUrlToRepositoryId.values().stream().map(repository -> repository.split(\"/\")[0]).collect(Collectors.toSet());\n+\n+            organizations.forEach(organization -> {\n+                List<Workflow> workflows = workflowDAO.findByOrganization(token.getTokenSource().getSourceControl(), organization);\n+                workflows.stream().forEach(workflow -> workflow.getUsers().add(user));\n+            });\n+        });\n+\n+        return getStrippedBioworkflows(userDAO.findById(user.getId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f27bc218d7422e294af902094c257a5a866c5749"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAzOTIxMg==", "bodyText": "Might actually be worth putting an actual description for what it's returning.  I was slightly confused for a second.", "url": "https://github.com/dockstore/dockstore/pull/3491#discussion_r430039212", "createdAt": "2020-05-25T18:17:37Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "diffHunk": "@@ -4125,6 +4125,24 @@ paths:\n       - bearer: []\n       tags:\n       - users\n+  /users/workflow:\n+    post:\n+      description: Adds a user to any Dockstore workflows that they should have access\n+        to.\n+      operationId: addUserToDockstoreWorkflows\n+      responses:\n+        default:\n+          content:\n+            application/json:\n+              schema:\n+                items:\n+                  $ref: '#/components/schemas/Workflow'\n+                type: array\n+          description: default response", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f27bc218d7422e294af902094c257a5a866c5749"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0NTQ2NA==", "bodyText": "Should mention \"logged-in user\" like the endpoints below", "url": "https://github.com/dockstore/dockstore/pull/3491#discussion_r430045464", "createdAt": "2020-05-25T18:45:46Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -762,6 +780,39 @@ public Limits setUserLimits(@ApiParam(hidden = true) @Auth User authUser,\n         return getStrippedWorkflowsAndServices(userDAO.findById(user.getId()));\n     }\n \n+    @POST\n+    @Path(\"/workflow\")\n+    @Timed\n+    @UnitOfWork\n+    @Operation(operationId = \"addUserToDockstoreWorkflows\", description = \"Adds a user to any Dockstore workflows that they should have access to.\", security = @SecurityRequirement(name = ResourceConstants.OPENAPI_JWT_SECURITY_DEFINITION_NAME))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f27bc218d7422e294af902094c257a5a866c5749"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d04ff39f2cb50faa1dafb191e5eee35ae66ce849", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/d04ff39f2cb50faa1dafb191e5eee35ae66ce849", "committedDate": "2020-05-25T18:58:42Z", "message": "Merge branch 'develop' into feature/3486/endpoint-add-user-to-workflows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6996ac9dd1bb0ef156face669373f858ce29b84", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/b6996ac9dd1bb0ef156face669373f858ce29b84", "committedDate": "2020-05-26T14:41:30Z", "message": "changed test to open api (had to change some endpoints too)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88c5aa62ae0f9aa682ccff6e9a87976a2d816a8f", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/88c5aa62ae0f9aa682ccff6e9a87976a2d816a8f", "committedDate": "2020-05-26T20:06:23Z", "message": "Merge branch 'feature/3486/endpoint-add-user-to-workflows' of github.com:ga4gh/dockstore into feature/3486/endpoint-add-user-to-workflows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1598141e59922eaf43931fdc55d628c0750a8b05", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/1598141e59922eaf43931fdc55d628c0750a8b05", "committedDate": "2020-05-27T15:05:52Z", "message": "change to patch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e585f98e907b91a45d87817fa418a52ef55f94d", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/6e585f98e907b91a45d87817fa418a52ef55f94d", "committedDate": "2020-05-28T20:28:09Z", "message": "change to patch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c9246729c4963a790eed707e71c8dd7de1e885a", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/6c9246729c4963a790eed707e71c8dd7de1e885a", "committedDate": "2020-05-28T20:30:48Z", "message": "Merge branch 'develop' into feature/3486/endpoint-add-user-to-workflows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21c2e93a0f29098a78f1f168d8932807ff4d5a33", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/21c2e93a0f29098a78f1f168d8932807ff4d5a33", "committedDate": "2020-05-28T20:39:57Z", "message": "change to workflows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e5fdfbe8208f3c0800faa9a7c8350d017648351", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/8e5fdfbe8208f3c0800faa9a7c8350d017648351", "committedDate": "2020-05-28T20:41:37Z", "message": "Merge branch 'feature/3486/endpoint-add-user-to-workflows' of github.com:ga4gh/dockstore into feature/3486/endpoint-add-user-to-workflows"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNTU0NDM1", "url": "https://github.com/dockstore/dockstore/pull/3491#pullrequestreview-420554435", "createdAt": "2020-05-28T23:15:58Z", "commit": {"oid": "8e5fdfbe8208f3c0800faa9a7c8350d017648351"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMzoxNTo1OFrOGcJ2Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMzoxNjoxNFrOGcJ2UA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3NDU5NQ==", "bodyText": "You will get an NPE if user is null. It shouldn't ever happen, unless the user gets deleted after it has been cached in SimpleAuthenticator, and given that we make it hard to delete users... Still, the Objects.equals isn't adding anything.", "url": "https://github.com/dockstore/dockstore/pull/3491#discussion_r432174595", "createdAt": "2020-05-28T23:15:58Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -762,6 +786,42 @@ public Limits setUserLimits(@ApiParam(hidden = true) @Auth User authUser,\n         return getStrippedWorkflowsAndServices(userDAO.findById(user.getId()));\n     }\n \n+    @PATCH\n+    @Timed\n+    @UnitOfWork\n+    @Path(\"/{userId}/workflows\")\n+    @ApiOperation(value = \"Adds a user to any Dockstore workflows that they should have access to.\", authorizations = {@Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = Workflow.class, responseContainer = \"List\")\n+    @Operation(operationId = \"addUserToDockstoreWorkflows\", description = \"Adds the logged-in user to any Dockstore workflows that they should have access to.\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    public List<Workflow> addUserToDockstoreWorkflows(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\", in = ParameterIn.HEADER) @Auth User authUser,\n+            @ApiParam(name = \"userId\", required = true, value = \"User to update\") @PathParam(\"userId\") @Parameter(name = \"userId\", in = ParameterIn.PATH, description = \"User to update\", required = true) long userId,\n+            @ApiParam(name = \"emptyBody\", value = APPEASE_SWAGGER_PATCH) @Parameter(description = APPEASE_SWAGGER_PATCH, name = \"emptyBody\") String emptyBody) {\n+        final User user = userDAO.findById(authUser.getId());\n+        if (!Objects.equals(userId, user.getId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e5fdfbe8208f3c0800faa9a7c8350d017648351"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3NDY3Mg==", "bodyText": "Id and 'id` -- should be consistent.", "url": "https://github.com/dockstore/dockstore/pull/3491#discussion_r432174672", "createdAt": "2020-05-28T23:16:14Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -762,6 +786,42 @@ public Limits setUserLimits(@ApiParam(hidden = true) @Auth User authUser,\n         return getStrippedWorkflowsAndServices(userDAO.findById(user.getId()));\n     }\n \n+    @PATCH\n+    @Timed\n+    @UnitOfWork\n+    @Path(\"/{userId}/workflows\")\n+    @ApiOperation(value = \"Adds a user to any Dockstore workflows that they should have access to.\", authorizations = {@Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = Workflow.class, responseContainer = \"List\")\n+    @Operation(operationId = \"addUserToDockstoreWorkflows\", description = \"Adds the logged-in user to any Dockstore workflows that they should have access to.\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    public List<Workflow> addUserToDockstoreWorkflows(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\", in = ParameterIn.HEADER) @Auth User authUser,\n+            @ApiParam(name = \"userId\", required = true, value = \"User to update\") @PathParam(\"userId\") @Parameter(name = \"userId\", in = ParameterIn.PATH, description = \"User to update\", required = true) long userId,\n+            @ApiParam(name = \"emptyBody\", value = APPEASE_SWAGGER_PATCH) @Parameter(description = APPEASE_SWAGGER_PATCH, name = \"emptyBody\") String emptyBody) {\n+        final User user = userDAO.findById(authUser.getId());\n+        if (!Objects.equals(userId, user.getId())) {\n+            throw new CustomWebApplicationException(\"The user Id provided does not match the logged-in user id.\", HttpStatus.SC_BAD_REQUEST);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e5fdfbe8208f3c0800faa9a7c8350d017648351"}, "originalPosition": 126}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNTkzMDY0", "url": "https://github.com/dockstore/dockstore/pull/3491#pullrequestreview-420593064", "createdAt": "2020-05-29T01:17:22Z", "commit": {"oid": "8e5fdfbe8208f3c0800faa9a7c8350d017648351"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d9b34781785801456721b389ac5acfbb9016f7b", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/1d9b34781785801456721b389ac5acfbb9016f7b", "committedDate": "2020-05-29T13:52:39Z", "message": "changes from pr"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwOTkwOTYz", "url": "https://github.com/dockstore/dockstore/pull/3491#pullrequestreview-420990963", "createdAt": "2020-05-29T14:12:22Z", "commit": {"oid": "1d9b34781785801456721b389ac5acfbb9016f7b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMDM4NDA5", "url": "https://github.com/dockstore/dockstore/pull/3491#pullrequestreview-421038409", "createdAt": "2020-05-29T15:03:19Z", "commit": {"oid": "1d9b34781785801456721b389ac5acfbb9016f7b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNTowMzoxOVrOGcgnbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNTowMzoxOVrOGcgnbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU0NzY5NQ==", "bodyText": "Ugh, this is a sign it should be POST (and not PUT or PATCH).  Do we have a PATCH without a body before?", "url": "https://github.com/dockstore/dockstore/pull/3491#discussion_r432547695", "createdAt": "2020-05-29T15:03:19Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "diffHunk": "@@ -4201,6 +4201,95 @@ paths:\n           description: default response\n       tags:\n       - users\n+  /users/{userId}/workflows:\n+    get:\n+      description: List all workflows owned by the authenticated user.\n+      operationId: userWorkflows\n+      parameters:\n+      - description: User ID\n+        in: path\n+        name: userId\n+        required: true\n+        schema:\n+          format: int64\n+          type: integer\n+      responses:\n+        default:\n+          content:\n+            application/json:\n+              schema:\n+                items:\n+                  $ref: '#/components/schemas/Workflow'\n+                type: array\n+          description: default response\n+      security:\n+      - bearer: []\n+      tags:\n+      - users\n+    patch:\n+      description: Adds the logged-in user to any Dockstore workflows that they should\n+        have access to.\n+      operationId: addUserToDockstoreWorkflows\n+      parameters:\n+      - description: User to update\n+        in: path\n+        name: userId\n+        required: true\n+        schema:\n+          format: int64\n+          type: integer\n+      requestBody:\n+        content:\n+          '*/*':\n+            schema:\n+              type: string\n+        description: This is here to appease Swagger. It requires PATCH methods to", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d9b34781785801456721b389ac5acfbb9016f7b"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMDY0MTA2", "url": "https://github.com/dockstore/dockstore/pull/3491#pullrequestreview-421064106", "createdAt": "2020-05-29T15:34:40Z", "commit": {"oid": "1d9b34781785801456721b389ac5acfbb9016f7b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMDkwMzM2", "url": "https://github.com/dockstore/dockstore/pull/3491#pullrequestreview-421090336", "createdAt": "2020-05-29T16:06:20Z", "commit": {"oid": "1d9b34781785801456721b389ac5acfbb9016f7b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d9e5b8189640507bbd426beb45f380914686eb4", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/9d9e5b8189640507bbd426beb45f380914686eb4", "committedDate": "2020-05-29T16:49:22Z", "message": "Merge branch 'develop' into feature/3486/endpoint-add-user-to-workflows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d599c123d0f101900ab65ef4fcb11a3b104c435", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/8d599c123d0f101900ab65ef4fcb11a3b104c435", "committedDate": "2020-05-29T18:13:38Z", "message": "Merge branch 'develop' into feature/3486/endpoint-add-user-to-workflows"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1899, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}