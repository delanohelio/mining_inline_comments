{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5NjI5NjUw", "number": 3706, "title": "Gather remaining GitHub emails", "bodyText": "SEAB-1532\nThe API method updateUserMetadata() will no longer throw an error\nwhen no GitHub or Google tokens are found to ensure that the metadata\nis updated for users with tokens\nIncluded a new updateUserMetadata() signature that is only affiliated\nwith the endpoint /users/updateUserMetadata\nIncluded a boolean parameter to the main updateUserMetadata() method\nto toggle the option to throw an error when no GitHub or Google tokens\nare found\nAdded a check in the if-statements of the main updateUserMetadata()\nmethod to see if errors should be thrown if tokens do not exist\nRefactored existing calls to updateUserMetadata() to include a boolean\nparameter", "createdAt": "2020-07-30T22:01:55Z", "url": "https://github.com/dockstore/dockstore/pull/3706", "merged": true, "mergeCommit": {"oid": "2ed4d1584abbcfe58ee94796565fdcf613f034ec"}, "closed": true, "closedAt": "2020-08-05T06:43:10Z", "author": {"login": "ByteMap"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6H9m3gFqTQ1ODgyMTE1OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7utw5AH2gAyNDU5NjI5NjUwOjlkYWFlMTA0ODFmMTVhOTQzZWMwMTA4YmUwYjQxZjA4MDk2Y2RkYmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODIxMTU5", "url": "https://github.com/dockstore/dockstore/pull/3706#pullrequestreview-458821159", "createdAt": "2020-07-30T23:05:33Z", "commit": {"oid": "cdebbbd88464bedf4bd702bc874291058d0a858d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMzowNTozNFrOG52v9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMzowNTozNFrOG52v9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMxOTAzMA==", "bodyText": "Given that you explicitly specifying the parameter here that it should throw an exception, does anybody still call the method on line 235 of User.java? If not then delete it.", "url": "https://github.com/dockstore/dockstore/pull/3706#discussion_r463319030", "createdAt": "2020-07-30T23:05:34Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -751,7 +751,7 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         if (source.equals(TokenType.GOOGLE_COM)) {\n             updateGoogleAccessToken(user.getId());\n         }\n-        dbuser.updateUserMetadata(tokenDAO, source);\n+        dbuser.updateUserMetadata(tokenDAO, source, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdebbbd88464bedf4bd702bc874291058d0a858d"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5Mjg4MzE0", "url": "https://github.com/dockstore/dockstore/pull/3706#pullrequestreview-459288314", "createdAt": "2020-07-31T16:02:48Z", "commit": {"oid": "cdebbbd88464bedf4bd702bc874291058d0a858d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b553d02c1a42fa4e0737f65714afd52aec0ebe55", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/b553d02c1a42fa4e0737f65714afd52aec0ebe55", "committedDate": "2020-08-03T01:58:39Z", "message": "Gather remaining GitHub emails\n\nSEAB-1532\n\nThe API method updateUserMetadata() will no longer throw an error\nwhen no GitHub or Google tokens are found to ensure that the metadata\nis updated for users with tokens\n\nIncluded a new updateUserMetadata() signature that is only affiliated\nwith the endpoint /users/updateUserMetadata\n\nIncluded a boolean parameter to the main updateUserMetadata() method\nto toggle the option to throw an error when no GitHub or Google tokens\nare found\n\nAdded a check in the if-statements of the main updateUserMetadata()\nmethod to see if errors should be thrown if tokens do not exist\n\nRefactored existing calls to updateUserMetadata() to include a boolean\nparameter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db81f65b26c513376199a8f4905a0a090023f4e3", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/db81f65b26c513376199a8f4905a0a090023f4e3", "committedDate": "2020-08-03T01:58:39Z", "message": "Reformatted logic for toggling throwing exceptions and added tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "17ec10a8e13c49babf749e688fd004d4586ed5a8", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/17ec10a8e13c49babf749e688fd004d4586ed5a8", "committedDate": "2020-08-03T01:56:40Z", "message": "fixing merge conflict"}, "afterCommit": {"oid": "db81f65b26c513376199a8f4905a0a090023f4e3", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/db81f65b26c513376199a8f4905a0a090023f4e3", "committedDate": "2020-08-03T01:58:39Z", "message": "Reformatted logic for toggling throwing exceptions and added tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMjE5OTc5", "url": "https://github.com/dockstore/dockstore/pull/3706#pullrequestreview-460219979", "createdAt": "2020-08-03T17:41:07Z", "commit": {"oid": "db81f65b26c513376199a8f4905a0a090023f4e3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNzo0MTowOFrOG7Cw_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNzo0ODowNFrOG7DBLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU2NDQ3OQ==", "bodyText": "Document new parameter", "url": "https://github.com/dockstore/dockstore/pull/3706#discussion_r464564479", "createdAt": "2020-08-03T17:41:08Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/User.java", "diffHunk": "@@ -243,28 +247,34 @@ public void updateUserMetadata(final TokenDAO tokenDAO) {\n      * @param tokenDAO The TokenDAO to access the user's tokens\n      * @param source   The source to update the user's profile (GITHUB_COM, GOOGLE_COM, NULL)\n      */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db81f65b26c513376199a8f4905a0a090023f4e3"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU2ODYyMQ==", "bodyText": "If you delete the Dockstore token, then all authenticated endpoints are going to fail; it shouldn't even get into UserResource.updateUserMetadata. So then you are testing that the method is not being called at all, which isn't that useful in this scenario.\nNote: if you were debugging this and seeing the method get invoked and seeming to contradict my previous statement, that would have been because the token is cached, and so even after you delete the token, calls may work for a bit. But it's not deterministic and you shouldn't rely on it.\nThis is a long-winded way of saying you should just delete the GitHub and/or Google tokens, not the Dockstore tokens.", "url": "https://github.com/dockstore/dockstore/pull/3706#discussion_r464568621", "createdAt": "2020-08-03T17:48:04Z", "author": {"login": "coverbeck"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -562,4 +562,71 @@ public void testSetUserPrivilege() {\n             assertEquals(HttpStatus.SC_FORBIDDEN, ex.getCode());\n         }\n     }\n+\n+    /**\n+     * Tests the endpoint used to sync all users' Github information called by a user who has a valid GitHub token\n+     * and one user who has a missing or outdated GitHub token\n+     */\n+    @Test\n+    public void testUpdateUserMetadataWithTokens() {\n+        io.dockstore.openapi.client.ApiClient adminWebClient = getOpenAPIWebClient(ADMIN_USERNAME, testingPostgres);\n+        io.dockstore.openapi.client.ApiClient userWebClient = getOpenAPIWebClient(USER_2_USERNAME, testingPostgres);\n+        io.dockstore.openapi.client.api.UsersApi adminApi = new io.dockstore.openapi.client.api.UsersApi(adminWebClient);\n+        io.dockstore.openapi.client.api.UsersApi userApi = new io.dockstore.openapi.client.api.UsersApi(userWebClient);\n+        io.dockstore.openapi.client.model.User admin = adminApi.getUser();\n+        io.dockstore.openapi.client.model.Profile userProfile = userApi.getUser().getUserProfiles().get(\"github.com\");\n+\n+        // Should add a test above this to check that the API call should pass once the admin tokens are up to date\n+        // Testing that the updateLoggedInUserMetadata() should fail if GitHub tokens are expired or absent\n+        testingPostgres.runUpdateStatement(String.format(\"DELETE FROM token WHERE userid = %d\", admin.getId()));\n+        try {\n+            adminApi.updateLoggedInUserMetadata(\"github.com\");\n+            fail(\"API call should fail and throw an error when no GitHub tokens are found or if tokens are out of date\");\n+        } catch (io.dockstore.openapi.client.ApiException ex) {\n+            assertEquals(HttpStatus.SC_FORBIDDEN, ex.getCode());\n+        }\n+\n+        // DockstoreUser2's profile elements should be initially set to null since the GitHub metadata isn't synced yet\n+        assertNull(userProfile.getEmail());\n+        assertNull(userProfile.getAvatarURL());\n+        assertNull(userProfile.getLocation());\n+\n+        // The API call updateUserMetadata() should not throw an error and exit if any users' tokens are out of date or absent\n+        // Additionally, the API call should go through and sync DockstoreTestUser2's GitHub data\n+        userApi.updateUserMetadata();\n+\n+        userProfile = userApi.getUser().getUserProfiles().get(\"github.com\");\n+        assertEquals(\"dockstore.test.user2@gmail.com\", userProfile.getEmail());\n+        assertEquals(\"https://avatars1.githubusercontent.com/u/17859829?v=4\", userProfile.getAvatarURL());\n+        assertEquals(\"Toronto\", userProfile.getLocation());\n+    }\n+\n+    /**\n+     * Tests the endpoint while all users have no valid GitHub token and the caller also does not have a valid token\n+     */\n+    @Test\n+    public void testUpdateUserMetadataWithoutTokens() {\n+        io.dockstore.openapi.client.ApiClient adminWebClient = getOpenAPIWebClient(ADMIN_USERNAME, testingPostgres);\n+        io.dockstore.openapi.client.ApiClient userWebClient = getOpenAPIWebClient(USER_2_USERNAME, testingPostgres);\n+        io.dockstore.openapi.client.api.UsersApi adminApi = new io.dockstore.openapi.client.api.UsersApi(adminWebClient);\n+        io.dockstore.openapi.client.api.UsersApi userApi = new io.dockstore.openapi.client.api.UsersApi(userWebClient);\n+        io.dockstore.openapi.client.model.User admin = adminApi.getUser();\n+        io.dockstore.openapi.client.model.Profile userProfile = userApi.getUser().getUserProfiles().get(\"github.com\");\n+\n+        // Delete all of the tokens for every user\n+        testingPostgres.runUpdateStatement(\"DELETE FROM token\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db81f65b26c513376199a8f4905a0a090023f4e3"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86b1a47558f5ab870a128a8c7b4a56a3c96dfb4a", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/86b1a47558f5ab870a128a8c7b4a56a3c96dfb4a", "committedDate": "2020-08-03T18:19:24Z", "message": "Updated test to not delete dockstore tokens"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "347d5a8b67aafbbe0a7264c0aa031699a744b2d4", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/347d5a8b67aafbbe0a7264c0aa031699a744b2d4", "committedDate": "2020-08-03T20:17:37Z", "message": "Documented new parameter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNDk0NDI1", "url": "https://github.com/dockstore/dockstore/pull/3706#pullrequestreview-460494425", "createdAt": "2020-08-04T04:53:17Z", "commit": {"oid": "347d5a8b67aafbbe0a7264c0aa031699a744b2d4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNDo1MzoxN1rOG7RCGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNDo1MzoxN1rOG7RCGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc5ODIzMg==", "bodyText": "Comment is not quite correct, but I would only fix if you have to make other changes.", "url": "https://github.com/dockstore/dockstore/pull/3706#discussion_r464798232", "createdAt": "2020-08-04T04:53:17Z", "author": {"login": "coverbeck"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -562,4 +562,71 @@ public void testSetUserPrivilege() {\n             assertEquals(HttpStatus.SC_FORBIDDEN, ex.getCode());\n         }\n     }\n+\n+    /**\n+     * Tests the endpoint used to sync all users' Github information called by a user who has a valid GitHub token\n+     * and one user who has a missing or outdated GitHub token\n+     */\n+    @Test\n+    public void testUpdateUserMetadataWithTokens() {\n+        io.dockstore.openapi.client.ApiClient adminWebClient = getOpenAPIWebClient(ADMIN_USERNAME, testingPostgres);\n+        io.dockstore.openapi.client.ApiClient userWebClient = getOpenAPIWebClient(USER_2_USERNAME, testingPostgres);\n+        io.dockstore.openapi.client.api.UsersApi adminApi = new io.dockstore.openapi.client.api.UsersApi(adminWebClient);\n+        io.dockstore.openapi.client.api.UsersApi userApi = new io.dockstore.openapi.client.api.UsersApi(userWebClient);\n+        io.dockstore.openapi.client.model.User admin = adminApi.getUser();\n+        io.dockstore.openapi.client.model.Profile userProfile = userApi.getUser().getUserProfiles().get(\"github.com\");\n+\n+        // Should add a test above this to check that the API call should pass once the admin tokens are up to date\n+        // Testing that the updateLoggedInUserMetadata() should fail if GitHub tokens are expired or absent\n+        testingPostgres.runUpdateStatement(String.format(\"DELETE FROM token WHERE userid = %d\", admin.getId()));\n+        try {\n+            adminApi.updateLoggedInUserMetadata(\"github.com\");\n+            fail(\"API call should fail and throw an error when no GitHub tokens are found or if tokens are out of date\");\n+        } catch (io.dockstore.openapi.client.ApiException ex) {\n+            assertEquals(HttpStatus.SC_FORBIDDEN, ex.getCode());\n+        }\n+\n+        // DockstoreUser2's profile elements should be initially set to null since the GitHub metadata isn't synced yet\n+        assertNull(userProfile.getEmail());\n+        assertNull(userProfile.getAvatarURL());\n+        assertNull(userProfile.getLocation());\n+\n+        // The API call updateUserMetadata() should not throw an error and exit if any users' tokens are out of date or absent\n+        // Additionally, the API call should go through and sync DockstoreTestUser2's GitHub data\n+        userApi.updateUserMetadata();\n+\n+        userProfile = userApi.getUser().getUserProfiles().get(\"github.com\");\n+        assertEquals(\"dockstore.test.user2@gmail.com\", userProfile.getEmail());\n+        assertEquals(\"https://avatars1.githubusercontent.com/u/17859829?v=4\", userProfile.getAvatarURL());\n+        assertEquals(\"Toronto\", userProfile.getLocation());\n+    }\n+\n+    /**\n+     * Tests the endpoint while all users have no valid GitHub token and the caller also does not have a valid token\n+     */\n+    @Test\n+    public void testUpdateUserMetadataWithoutTokens() {\n+        io.dockstore.openapi.client.ApiClient adminWebClient = getOpenAPIWebClient(ADMIN_USERNAME, testingPostgres);\n+        io.dockstore.openapi.client.ApiClient userWebClient = getOpenAPIWebClient(USER_2_USERNAME, testingPostgres);\n+        io.dockstore.openapi.client.api.UsersApi adminApi = new io.dockstore.openapi.client.api.UsersApi(adminWebClient);\n+        io.dockstore.openapi.client.api.UsersApi userApi = new io.dockstore.openapi.client.api.UsersApi(userWebClient);\n+        io.dockstore.openapi.client.model.User admin = adminApi.getUser();\n+        io.dockstore.openapi.client.model.Profile userProfile = userApi.getUser().getUserProfiles().get(\"github.com\");\n+\n+        // Delete all of the tokens for every user", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "347d5a8b67aafbbe0a7264c0aa031699a744b2d4"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwODY2MTgx", "url": "https://github.com/dockstore/dockstore/pull/3706#pullrequestreview-460866181", "createdAt": "2020-08-04T14:26:17Z", "commit": {"oid": "347d5a8b67aafbbe0a7264c0aa031699a744b2d4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNDoyNjoxN1rOG7i7_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNDoyNjozMlrOG7i8tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA5MTU4MA==", "bodyText": "Head-up @garyluu not sure why these are changing in ParsedInformation", "url": "https://github.com/dockstore/dockstore/pull/3706#discussion_r465091580", "createdAt": "2020-08-04T14:26:17Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "diffHunk": "@@ -694,15 +694,13 @@ components:\n             - SWL\n             - NFL\n             - service\n-            - cwl", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "347d5a8b67aafbbe0a7264c0aa031699a744b2d4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA5MTc2Ng==", "bodyText": "Diito @garyluu not sure why these are changing in ParsedInformation", "url": "https://github.com/dockstore/dockstore/pull/3706#discussion_r465091766", "createdAt": "2020-08-04T14:26:32Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/resources/swagger.yaml", "diffHunk": "@@ -7271,8 +7271,6 @@ definitions:\n         format: \"int64\"\n   ParsedInformation:\n     type: \"object\"\n-    required:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "347d5a8b67aafbbe0a7264c0aa031699a744b2d4"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwOTE2NTMx", "url": "https://github.com/dockstore/dockstore/pull/3706#pullrequestreview-460916531", "createdAt": "2020-08-04T15:18:28Z", "commit": {"oid": "347d5a8b67aafbbe0a7264c0aa031699a744b2d4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTc2NTY1", "url": "https://github.com/dockstore/dockstore/pull/3706#pullrequestreview-461176565", "createdAt": "2020-08-04T21:09:09Z", "commit": {"oid": "347d5a8b67aafbbe0a7264c0aa031699a744b2d4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTkxNTA5", "url": "https://github.com/dockstore/dockstore/pull/3706#pullrequestreview-461191509", "createdAt": "2020-08-04T21:35:39Z", "commit": {"oid": "347d5a8b67aafbbe0a7264c0aa031699a744b2d4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae62285332f0b277a47a9e89555152610cfa458c", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/ae62285332f0b277a47a9e89555152610cfa458c", "committedDate": "2020-08-04T22:44:45Z", "message": "Merge branch 'develop' into feature/SEAB-1532/gatherRemainingEmails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9daae10481f15a943ec0108be0b41f08096cddba", "author": {"user": {"login": "ByteMap", "name": "Andy Chen"}}, "url": "https://github.com/dockstore/dockstore/commit/9daae10481f15a943ec0108be0b41f08096cddba", "committedDate": "2020-08-04T22:53:14Z", "message": "Updated comment and rebased from develop"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1695, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}