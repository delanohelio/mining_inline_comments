{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMjExMjg0", "number": 3630, "title": "delete user's services in UserResource.deleteSelfFromEntries() (#3291)", "bodyText": "Main issue: #3291\nRelated (deleting workflows/tools): #1766 / #1697", "createdAt": "2020-06-30T18:12:15Z", "url": "https://github.com/dockstore/dockstore/pull/3630", "merged": true, "mergeCommit": {"oid": "610ba9a1c8078b265c52f2c19c13869d6b755f93"}, "closed": true, "closedAt": "2020-07-09T15:37:34Z", "author": {"login": "GFJHogue"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwZdjMgH2gAyNDQyMjExMjg0OjA4ZjIzMTAyNjY2MmZjNzczNzY3NzFkZGJmZTY5NzZjYWQ5OWRlMjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczPovrAFqTQ0NTY1MzMzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "08f231026662fc77376771ddbfe6976cad99de26", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/08f231026662fc77376771ddbfe6976cad99de26", "committedDate": "2020-06-30T17:54:21Z", "message": "delete user's services in UserResource.deleteSelfFromEntries() (#3291)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMzI2NzQz", "url": "https://github.com/dockstore/dockstore/pull/3630#pullrequestreview-440326743", "createdAt": "2020-06-30T19:36:49Z", "commit": {"oid": "08f231026662fc77376771ddbfe6976cad99de26"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMjQyODA2", "url": "https://github.com/dockstore/dockstore/pull/3630#pullrequestreview-443242806", "createdAt": "2020-07-06T16:43:30Z", "commit": {"oid": "08f231026662fc77376771ddbfe6976cad99de26"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4dd8339b7be9e5da233a3e22330f584170184ef1", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/4dd8339b7be9e5da233a3e22330f584170184ef1", "committedDate": "2020-07-07T21:03:41Z", "message": "test if user's services are deleted on selfDestruct(); revert previous"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08990df20330b1a3ae8338d1aa680aa7ca05e34c", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/08990df20330b1a3ae8338d1aa680aa7ca05e34c", "committedDate": "2020-07-07T21:03:59Z", "message": "Merge branch 'develop' into feature/3291/delete-user-orphan-services"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0ODI4MDI1", "url": "https://github.com/dockstore/dockstore/pull/3630#pullrequestreview-444828025", "createdAt": "2020-07-08T14:33:11Z", "commit": {"oid": "08990df20330b1a3ae8338d1aa680aa7ca05e34c"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNDozMzoxMVrOGurBiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNDozNDo1NVrOGurGiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU5MjU4NA==", "bodyText": "Probably a bit more readable as SourceControl.GITHUB + '/' + serviceRepo", "url": "https://github.com/dockstore/dockstore/pull/3630#discussion_r451592584", "createdAt": "2020-07-08T14:33:11Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -249,6 +255,7 @@ public void testSelfDestruct() throws ApiException {\n         // Verify that admin can access unpublished workflow, because admin is going to verify later\n         // that the workflow is gone\n         adminWorkflowsApi.getWorkflowByPath(WorkflowIT.DOCKSTORE_TEST_USER2_HELLO_DOCKSTORE_WORKFLOW, null, false);\n+        adminWorkflowsApi.getWorkflowByPath(github + \"/\" + serviceRepo, null, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08990df20330b1a3ae8338d1aa680aa7ca05e34c"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU5Mjg5OQ==", "bodyText": "Ditto, can use constant", "url": "https://github.com/dockstore/dockstore/pull/3630#discussion_r451592899", "createdAt": "2020-07-08T14:33:36Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -278,6 +285,15 @@ public void testSelfDestruct() throws ApiException {\n         }\n         assertTrue(expectedAdminAccessToFail);\n \n+        // Verify that self-destruct also deleted the service\n+        boolean expectedAdminServiceAccessToFail = false;\n+        try {\n+            adminWorkflowsApi.getWorkflowByPath(github + \"/\" + serviceRepo, null, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08990df20330b1a3ae8338d1aa680aa7ca05e34c"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU5Mzg2NA==", "bodyText": "Should assert that the exception is due to it being missing (would have expected a relevant error message or a wrapped 404 or something)\nOtherwise, this could \"pass\" if the api is just broken in some other way.", "url": "https://github.com/dockstore/dockstore/pull/3630#discussion_r451593864", "createdAt": "2020-07-08T14:34:55Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -278,6 +285,15 @@ public void testSelfDestruct() throws ApiException {\n         }\n         assertTrue(expectedAdminAccessToFail);\n \n+        // Verify that self-destruct also deleted the service\n+        boolean expectedAdminServiceAccessToFail = false;\n+        try {\n+            adminWorkflowsApi.getWorkflowByPath(github + \"/\" + serviceRepo, null, true);\n+        } catch (ApiException e) {\n+            expectedAdminServiceAccessToFail = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08990df20330b1a3ae8338d1aa680aa7ca05e34c"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0ODQwNDMz", "url": "https://github.com/dockstore/dockstore/pull/3630#pullrequestreview-444840433", "createdAt": "2020-07-08T14:45:56Z", "commit": {"oid": "08990df20330b1a3ae8338d1aa680aa7ca05e34c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNDo0NTo1NlrOGurmaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNDo0NTo1NlrOGurmaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYwMjAyNw==", "bodyText": "what's the difference between this filter and the DAO findByUser?", "url": "https://github.com/dockstore/dockstore/pull/3630#discussion_r451602027", "createdAt": "2020-07-08T14:45:56Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -313,6 +314,13 @@ private void deleteSelfFromEntries(User user) {\n                 });\n     }\n \n+    // We don't delete the LambdaEvent because it is useful for other users\n+    private void deleteSelfFromLambdaEvents(User user) {\n+        lambdaEventDAO.findByUser(user).stream()\n+                .filter(lambdaEvent -> lambdaEvent.getUser() == user)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08990df20330b1a3ae8338d1aa680aa7ca05e34c"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "312c765fb8be6208d13fc5c47e3175e7ca2badfc", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/312c765fb8be6208d13fc5c47e3175e7ca2badfc", "committedDate": "2020-07-08T18:24:58Z", "message": "review revisions - user self destruct & test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb817e48e91a67e2f731672d8866aea960cea86d", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/bb817e48e91a67e2f731672d8866aea960cea86d", "committedDate": "2020-07-08T18:25:42Z", "message": "Merge remote-tracking branch 'origin/develop' into feature/3291/delete-user-orphan-services"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MTIwMTg5", "url": "https://github.com/dockstore/dockstore/pull/3630#pullrequestreview-445120189", "createdAt": "2020-07-08T20:52:29Z", "commit": {"oid": "bb817e48e91a67e2f731672d8866aea960cea86d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMDo1MjoyOVrOGu40CA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMDo1MjoyOVrOGu40CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxODUwNA==", "bodyText": "Can use a constant to be more readable, something like the version 4 equivalent\nhttps://hc.apache.org/httpclient-3.x/apidocs/org/apache/commons/httpclient/HttpStatus.html#SC_BAD_REQUEST", "url": "https://github.com/dockstore/dockstore/pull/3630#discussion_r451818504", "createdAt": "2020-07-08T20:52:29Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -274,10 +280,21 @@ public void testSelfDestruct() throws ApiException {\n             adminWorkflowsApi.getWorkflowByPath(WorkflowIT.DOCKSTORE_TEST_USER2_HELLO_DOCKSTORE_WORKFLOW, null, false);\n \n         } catch (ApiException e) {\n+            assertTrue(e.getCode() == 400);\n             expectedAdminAccessToFail = true;\n         }\n         assertTrue(expectedAdminAccessToFail);\n \n+        // Verify that self-destruct also deleted the service\n+        boolean expectedAdminServiceAccessToFail = false;\n+        try {\n+            adminWorkflowsApi.getWorkflowByPath(SourceControl.GITHUB + \"/\" + serviceRepo, null, true);\n+        } catch (ApiException e) {\n+            assertTrue(e.getCode() == 400);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb817e48e91a67e2f731672d8866aea960cea86d"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6093b55ca776f1f50adaf7b6a75d58e53dc02b55", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/6093b55ca776f1f50adaf7b6a75d58e53dc02b55", "committedDate": "2020-07-08T21:05:09Z", "message": "use HttpStatus constant"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MTQ4MjM1", "url": "https://github.com/dockstore/dockstore/pull/3630#pullrequestreview-445148235", "createdAt": "2020-07-08T21:39:55Z", "commit": {"oid": "6093b55ca776f1f50adaf7b6a75d58e53dc02b55"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMTozOTo1NVrOGu6KtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMTozOTo1NVrOGu6KtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg0MDY5Mg==", "bodyText": "assertEquals(expected, actual) or assertEquals(message, expected, actual) here and below", "url": "https://github.com/dockstore/dockstore/pull/3630#discussion_r451840692", "createdAt": "2020-07-08T21:39:55Z", "author": {"login": "garyluu"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -274,10 +280,21 @@ public void testSelfDestruct() throws ApiException {\n             adminWorkflowsApi.getWorkflowByPath(WorkflowIT.DOCKSTORE_TEST_USER2_HELLO_DOCKSTORE_WORKFLOW, null, false);\n \n         } catch (ApiException e) {\n+            assertTrue(e.getCode() == HttpStatus.SC_BAD_REQUEST);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6093b55ca776f1f50adaf7b6a75d58e53dc02b55"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MjA2NzE5", "url": "https://github.com/dockstore/dockstore/pull/3630#pullrequestreview-445206719", "createdAt": "2020-07-09T00:05:41Z", "commit": {"oid": "6093b55ca776f1f50adaf7b6a75d58e53dc02b55"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MjI5MDM2", "url": "https://github.com/dockstore/dockstore/pull/3630#pullrequestreview-445229036", "createdAt": "2020-07-09T01:21:59Z", "commit": {"oid": "6093b55ca776f1f50adaf7b6a75d58e53dc02b55"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b2520923834967aaba4073c56cc1532674c9e5e", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/3b2520923834967aaba4073c56cc1532674c9e5e", "committedDate": "2020-07-09T14:00:17Z", "message": "Merge branch 'develop' into feature/3291/delete-user-orphan-services"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b364d84abcb6c9a1496d54169e1c2ee030397f72", "author": {"user": {"login": "GFJHogue", "name": "Gregory F J Hogue"}}, "url": "https://github.com/dockstore/dockstore/commit/b364d84abcb6c9a1496d54169e1c2ee030397f72", "committedDate": "2020-07-09T14:03:26Z", "message": "use assertEquals()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NjUzMzM1", "url": "https://github.com/dockstore/dockstore/pull/3630#pullrequestreview-445653335", "createdAt": "2020-07-09T14:09:18Z", "commit": {"oid": "b364d84abcb6c9a1496d54169e1c2ee030397f72"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1763, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}