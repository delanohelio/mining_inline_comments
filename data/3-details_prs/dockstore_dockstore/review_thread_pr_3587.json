{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3MTU3MjQ0", "number": 3587, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTozNjo0N1rOEHKFZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTo1MDo1MVrOEHKXHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTQwNzEwOnYy", "diffSide": "RIGHT", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTozNjo0N1rOGmZFMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTozNjo0N1rOGmZFMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxMDAwMw==", "bodyText": "cwl => CWL", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442910003", "createdAt": "2020-06-19T15:36:47Z", "author": {"login": "garyluu"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java", "diffHunk": "@@ -118,6 +118,25 @@ public void testWorkflowDAGCWL() throws ApiException {\n \n     }\n \n+    @Test\n+    public void testWorkflowDAGCWLRequirementMap() throws ApiException {\n+        // Input: snaptools_create_snap_file.cwl\n+        // Repo: SnapTools\n+        // Branch: feature/docker_cwl_req_in_min\n+        // Test: normal cwl workflow DAG with requirement map", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTQxMTEwOnYy", "diffSide": "RIGHT", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTozODowMVrOGmZHkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTozODowMVrOGmZHkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxMDYxMQ==", "bodyText": "cwl => DescriptorLanguage.CWL.getShortName()", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442910611", "createdAt": "2020-06-19T15:38:01Z", "author": {"login": "garyluu"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java", "diffHunk": "@@ -118,6 +118,25 @@ public void testWorkflowDAGCWL() throws ApiException {\n \n     }\n \n+    @Test\n+    public void testWorkflowDAGCWLRequirementMap() throws ApiException {\n+        // Input: snaptools_create_snap_file.cwl\n+        // Repo: SnapTools\n+        // Branch: feature/docker_cwl_req_in_min\n+        // Test: normal cwl workflow DAG with requirement map\n+\n+        final List<String> strings = getJSON(\"DockstoreTestUser2/SnapTools\", \"/snaptools_create_snap_file.cwl\", \"cwl\", \"feature/docker_cwl_req_in_main\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTQxMjE2OnYy", "diffSide": "RIGHT", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTozODoyMFrOGmZINQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTozODoyMFrOGmZINQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxMDc3Mw==", "bodyText": "expected then actual", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442910773", "createdAt": "2020-06-19T15:38:20Z", "author": {"login": "garyluu"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/DAGWorkflowTestIT.java", "diffHunk": "@@ -118,6 +118,25 @@ public void testWorkflowDAGCWL() throws ApiException {\n \n     }\n \n+    @Test\n+    public void testWorkflowDAGCWLRequirementMap() throws ApiException {\n+        // Input: snaptools_create_snap_file.cwl\n+        // Repo: SnapTools\n+        // Branch: feature/docker_cwl_req_in_min\n+        // Test: normal cwl workflow DAG with requirement map\n+\n+        final List<String> strings = getJSON(\"DockstoreTestUser2/SnapTools\", \"/snaptools_create_snap_file.cwl\", \"cwl\", \"feature/docker_cwl_req_in_main\");\n+        int countNode = countNodeInJSON(strings);\n+\n+        Assert.assertTrue(\"JSON should not be blank\", strings.size() > 0);\n+        Assert.assertEquals(\"JSON should have eight nodes (including start and end)\", countNode, 8);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTQxMjgyOnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTozODozNlrOGmZIoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTozODozNlrOGmZIoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxMDg4MA==", "bodyText": "CWL \ud83d\udc4d", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442910880", "createdAt": "2020-06-19T15:38:36Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -583,6 +592,28 @@ private String parseSecondaryFile(String stepDockerRequirement, String secondary\n         return stepDockerRequirement;\n     }\n \n+    /**\n+     * Converts a JSON Object in CWL to JSON Array", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTQzOTE5OnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTo0Njo1MVrOGmZZPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTo0Njo1MVrOGmZZPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxNTEzNQ==", "bodyText": "You could create constants for \"requirements\" and \"hints\", since they're each referenced twice in the file, but not worth going through another iteration of the PR.", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442915135", "createdAt": "2020-06-19T15:46:51Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -564,6 +569,10 @@ private String parseSecondaryFile(String stepDockerRequirement, String secondary\n             List<Object> cltRequirements = null;\n             List<Object> cltHints = null;\n \n+            // CWLAvro only supports requirements and hints as an array, must be converted\n+            entryJson = convertJSONObjectToArray(\"requirements\", entryJson);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTQ1MjQ0OnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTo1MDo1MVrOGmZhXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTo1MDo1MVrOGmZhXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxNzIxMw==", "bodyText": "Optional: should be a way to stream + map requirements to reqArray", "url": "https://github.com/dockstore/dockstore/pull/3587#discussion_r442917213", "createdAt": "2020-06-19T15:50:51Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -583,6 +592,28 @@ private String parseSecondaryFile(String stepDockerRequirement, String secondary\n         return stepDockerRequirement;\n     }\n \n+    /**\n+     * Converts a JSON Object in CWL to JSON Array\n+     * @param keyName Name of key to convert (Ex. requirements, hints)\n+     * @param entryJson JSON representation of file\n+     * @return Updated JSON representation of file\n+     */\n+    private JSONObject convertJSONObjectToArray(String keyName, JSONObject entryJson) {\n+        if (entryJson.has(keyName)) {\n+            if (entryJson.get(keyName) instanceof JSONObject) {\n+                JSONArray reqArray = new JSONArray();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbf26fa997f50e3ba36987a0a18ab87cc4fc9c41"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2984, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}