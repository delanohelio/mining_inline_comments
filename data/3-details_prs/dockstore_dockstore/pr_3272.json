{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNTM3NDgz", "number": 3272, "title": "Feature/local recursive import", "bodyText": "There was no check in the WDL validation code for a recursive local import so I added one\nAlso added a test for it in the WDL parse test file", "createdAt": "2020-02-26T22:22:12Z", "url": "https://github.com/dockstore/dockstore/pull/3272", "merged": true, "mergeCommit": {"oid": "a625e6d792f801786bde1f363c71828896f38756"}, "closed": true, "closedAt": "2020-03-11T23:42:29Z", "author": {"login": "wshands"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcH691RgH2gAyMzgwNTM3NDgzOjQxN2M3NWUxOTU0ZjY0NDIzZWU4NDQ2OGNmYzBiODE5M2MwOTk5ZmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMv4mYAFqTM3MzE5NjM2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "417c75e1954f64423ee84468cfc0b8193c0999fe", "author": {"user": {"login": "wshands", "name": "Walter Shands"}}, "url": "https://github.com/dockstore/dockstore/commit/417c75e1954f64423ee84468cfc0b8193c0999fe", "committedDate": "2020-02-25T23:45:35Z", "message": "add local recursive import check to validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13fc40c6e9d09c4e6b3a5cd62f4e9b67634d376e", "author": {"user": {"login": "wshands", "name": "Walter Shands"}}, "url": "https://github.com/dockstore/dockstore/commit/13fc40c6e9d09c4e6b3a5cd62f4e9b67634d376e", "committedDate": "2020-02-26T22:18:32Z", "message": "add check for and test for local recursive import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MzQzNDI2", "url": "https://github.com/dockstore/dockstore/pull/3272#pullrequestreview-365343426", "createdAt": "2020-02-27T00:35:45Z", "commit": {"oid": "13fc40c6e9d09c4e6b3a5cd62f4e9b67634d376e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMDozNTo0NVrOFvBbUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMDozNTo0NVrOFvBbUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1MDc2OQ==", "bodyText": "If instead of validation.getMessage().entrySet... you did validation.getMessage.values()... and it would make your code a little less complicated.", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r384850769", "createdAt": "2020-02-27T00:35:45Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/test/java/core/WDLParseTest.java", "diffHunk": "@@ -130,6 +134,49 @@ private static SourceFile getSourceFile2() {\n     }\n \n \n+    /**\n+     * Tests that Dockstore can handle a workflow with locally recursive imports\n+     */\n+    @Test\n+    public void testLocallyRecursiveImport() {\n+        String type = \"workflow\";\n+        File recursiveWDL = new File(ResourceHelpers.resourceFilePath(\"local-recursive-import/localrecursive.wdl\"));\n+        //String primaryDescriptorFilePath = recursiveWDL.getAbsolutePath();\n+        String primaryDescriptorFilePath = \"localrecursive.wdl\";\n+        SourceFile sourceFile = new SourceFile();\n+\n+        File recursiveimportWDL = new File(ResourceHelpers.resourceFilePath(\"local-recursive-import/first-import.wdl\"));\n+        SourceFile importsourceFile = new SourceFile();\n+\n+        try {\n+            sourceFile.setContent(FileUtils.readFileToString(recursiveWDL, StandardCharsets.UTF_8));\n+            sourceFile.setAbsolutePath(\"/localrecursive.wdl\");\n+            sourceFile.setPath(\"localrecursive.wdl\");\n+            sourceFile.setType(DescriptorLanguage.FileType.DOCKSTORE_WDL);\n+\n+            importsourceFile.setContent(FileUtils.readFileToString(recursiveimportWDL, StandardCharsets.UTF_8));\n+            importsourceFile.setAbsolutePath(\"/first-import.wdl\");\n+            importsourceFile.setPath(\"first-import.wdl\");\n+            importsourceFile.setType(DescriptorLanguage.FileType.DOCKSTORE_WDL);\n+\n+            Set<SourceFile> sourceFileSet = new HashSet<>();\n+            sourceFileSet.add(sourceFile);\n+\n+            sourceFileSet.add(importsourceFile);\n+\n+            WDLHandler wdlHandler = new WDLHandler();\n+            VersionTypeValidation validation = wdlHandler.validateEntrySet(sourceFileSet, primaryDescriptorFilePath, type);\n+            Assert.assertFalse(validation.isValid());\n+            // Go through message part and verify it says 'Recursive local import detected'\n+            Optional<Map.Entry<String, String>> validationEntryMap = validation.getMessage().entrySet().stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13fc40c6e9d09c4e6b3a5cd62f4e9b67634d376e"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd85dc59208f78e9fc6acf5533de444bc8ba1418", "author": {"user": {"login": "wshands", "name": "Walter Shands"}}, "url": "https://github.com/dockstore/dockstore/commit/bd85dc59208f78e9fc6acf5533de444bc8ba1418", "committedDate": "2020-02-27T23:15:30Z", "message": "simplify java stream command"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de19fe1cb7fa70c3229831e0f2099241487c2056", "author": {"user": {"login": "wshands", "name": "Walter Shands"}}, "url": "https://github.com/dockstore/dockstore/commit/de19fe1cb7fa70c3229831e0f2099241487c2056", "committedDate": "2020-02-28T00:02:42Z", "message": "fix assert"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NTM4NjU3", "url": "https://github.com/dockstore/dockstore/pull/3272#pullrequestreview-366538657", "createdAt": "2020-02-28T16:48:05Z", "commit": {"oid": "de19fe1cb7fa70c3229831e0f2099241487c2056"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NTU3Njg4", "url": "https://github.com/dockstore/dockstore/pull/3272#pullrequestreview-366557688", "createdAt": "2020-02-28T17:18:08Z", "commit": {"oid": "de19fe1cb7fa70c3229831e0f2099241487c2056"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzoxODowOFrOFv8m5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzozOTo1M1rOFv9PxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgyMDM5MQ==", "bodyText": "No need to change, but FYI, if you change findAny to anyMatch you directly get a boolean and makes your life slightly easier.", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r385820391", "createdAt": "2020-02-28T17:18:08Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/test/java/core/WDLParseTest.java", "diffHunk": "@@ -130,6 +134,49 @@ private static SourceFile getSourceFile2() {\n     }\n \n \n+    /**\n+     * Tests that Dockstore can handle a workflow with locally recursive imports\n+     */\n+    @Test\n+    public void testLocallyRecursiveImport() {\n+        String type = \"workflow\";\n+        File recursiveWDL = new File(ResourceHelpers.resourceFilePath(\"local-recursive-import/localrecursive.wdl\"));\n+        //String primaryDescriptorFilePath = recursiveWDL.getAbsolutePath();\n+        String primaryDescriptorFilePath = \"localrecursive.wdl\";\n+        SourceFile sourceFile = new SourceFile();\n+\n+        File recursiveimportWDL = new File(ResourceHelpers.resourceFilePath(\"local-recursive-import/first-import.wdl\"));\n+        SourceFile importsourceFile = new SourceFile();\n+\n+        try {\n+            sourceFile.setContent(FileUtils.readFileToString(recursiveWDL, StandardCharsets.UTF_8));\n+            sourceFile.setAbsolutePath(\"/localrecursive.wdl\");\n+            sourceFile.setPath(\"localrecursive.wdl\");\n+            sourceFile.setType(DescriptorLanguage.FileType.DOCKSTORE_WDL);\n+\n+            importsourceFile.setContent(FileUtils.readFileToString(recursiveimportWDL, StandardCharsets.UTF_8));\n+            importsourceFile.setAbsolutePath(\"/first-import.wdl\");\n+            importsourceFile.setPath(\"first-import.wdl\");\n+            importsourceFile.setType(DescriptorLanguage.FileType.DOCKSTORE_WDL);\n+\n+            Set<SourceFile> sourceFileSet = new HashSet<>();\n+            sourceFileSet.add(sourceFile);\n+\n+            sourceFileSet.add(importsourceFile);\n+\n+            WDLHandler wdlHandler = new WDLHandler();\n+            VersionTypeValidation validation = wdlHandler.validateEntrySet(sourceFileSet, primaryDescriptorFilePath, type);\n+            assertFalse(validation.isValid());\n+            // Go through message part and verify it says 'Recursive local import detected'\n+            Optional<String> validationEntryMap = validation.getMessage().values().stream()\n+                    .filter(msg -> StringUtils.contains(msg, \"Recursive local import detected\")).findAny();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de19fe1cb7fa70c3229831e0f2099241487c2056"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgzMDg1Mg==", "bodyText": "This code mostly duplicates similary code in parseWorkflowContent. Could you create a new function and call from both places?", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r385830852", "createdAt": "2020-02-28T17:39:53Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/WDLHandler.java", "diffHunk": "@@ -226,6 +226,16 @@ public VersionTypeValidation validateEntrySet(Set<SourceFile> sourcefiles, Strin\n                 String content = FileUtils.readFileToString(tempMainDescriptor, StandardCharsets.UTF_8);\n                 checkForRecursiveHTTPImports(content, new HashSet<>());\n \n+                // Check for local recursive imports in the WDL files", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de19fe1cb7fa70c3229831e0f2099241487c2056"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88e5ae0e36a7206777da3505b87b07a9875f9f34", "author": {"user": {"login": "wshands", "name": "Walter Shands"}}, "url": "https://github.com/dockstore/dockstore/commit/88e5ae0e36a7206777da3505b87b07a9875f9f34", "committedDate": "2020-03-03T00:22:52Z", "message": "add new local recursive check function"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NzIzMDgz", "url": "https://github.com/dockstore/dockstore/pull/3272#pullrequestreview-367723083", "createdAt": "2020-03-03T06:12:19Z", "commit": {"oid": "88e5ae0e36a7206777da3505b87b07a9875f9f34"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwNjoxMjoxOVrOFw5aYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwNjoxMjoxOVrOFw5aYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgxNjYwOQ==", "bodyText": "This feels wrong to either append the result to an existing map or create a new map -- it's not very functional.\nI would suggest changing this method to just return an Optional, then have the caller append to the result to the map, if present. The caller will have the key.", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r386816609", "createdAt": "2020-03-03T06:12:19Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/WDLHandler.java", "diffHunk": "@@ -173,6 +171,31 @@ public Version parseWorkflowContent(String filepath, String content, Set<SourceF\n         return version;\n     }\n \n+\n+    /**\n+     * A common helper method for checking for local recursive imports\n+     * @param primaryDescriptorContent content of primary descriptor\n+     * @param sourcefiles Set of sourcefiles to validate\n+     * @param primaryDescriptorFilePath Path of primary descriptor\n+     * @param validationMessageObject Object in which to store messages\n+     * @return an optional validationMessageObject\n+     */\n+    public Optional<Map<String, String>>  reportValidationForLocalRecursiveImports(String primaryDescriptorContent, Set<SourceFile> sourcefiles,\n+            String primaryDescriptorFilePath, Map<String, String> validationMessageObject) {\n+        try {\n+            String parent = primaryDescriptorFilePath.startsWith(\"/\") ? new File(primaryDescriptorFilePath).getParent() : \"/\";\n+            checkForRecursiveLocalImports(primaryDescriptorContent, sourcefiles, new HashSet<>(), parent);\n+        } catch (ParseException e) {\n+            LOG.error(\"Recursive local imports found: \", e);\n+            if (validationMessageObject == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e5ae0e36a7206777da3505b87b07a9875f9f34"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MDgyMTM3", "url": "https://github.com/dockstore/dockstore/pull/3272#pullrequestreview-368082137", "createdAt": "2020-03-03T15:34:53Z", "commit": {"oid": "88e5ae0e36a7206777da3505b87b07a9875f9f34"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fd27c81874e4d222bb0180a0d6867d8cc89209c", "author": {"user": {"login": "wshands", "name": "Walter Shands"}}, "url": "https://github.com/dockstore/dockstore/commit/8fd27c81874e4d222bb0180a0d6867d8cc89209c", "committedDate": "2020-03-04T00:10:31Z", "message": "fix recursive import check to return just an optional"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NzczNzkz", "url": "https://github.com/dockstore/dockstore/pull/3272#pullrequestreview-369773793", "createdAt": "2020-03-05T17:34:38Z", "commit": {"oid": "8fd27c81874e4d222bb0180a0d6867d8cc89209c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNzozNDozOVrOFydKAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNzozNDozOVrOFydKAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ1MDgxOQ==", "bodyText": "Returns a string", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r388450819", "createdAt": "2020-03-05T17:34:39Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/WDLHandler.java", "diffHunk": "@@ -173,6 +173,26 @@ public Version parseWorkflowContent(String filepath, String content, Set<SourceF\n         return version;\n     }\n \n+\n+    /**\n+     * A common helper method for checking for local recursive imports\n+     * @param primaryDescriptorContent content of primary descriptor\n+     * @param sourcefiles Set of sourcefiles to validate\n+     * @param primaryDescriptorFilePath Path of primary descriptor\n+     * @return an optional validationMessageObject", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fd27c81874e4d222bb0180a0d6867d8cc89209c"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODAzOTI1", "url": "https://github.com/dockstore/dockstore/pull/3272#pullrequestreview-369803925", "createdAt": "2020-03-05T18:18:32Z", "commit": {"oid": "8fd27c81874e4d222bb0180a0d6867d8cc89209c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7155be2eee1d2392951a30179c1b9c91c9a0866d", "author": {"user": {"login": "wshands", "name": "Walter Shands"}}, "url": "https://github.com/dockstore/dockstore/commit/7155be2eee1d2392951a30179c1b9c91c9a0866d", "committedDate": "2020-03-06T00:21:03Z", "message": "fix parameter comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMzI4NTIy", "url": "https://github.com/dockstore/dockstore/pull/3272#pullrequestreview-370328522", "createdAt": "2020-03-06T13:42:24Z", "commit": {"oid": "7155be2eee1d2392951a30179c1b9c91c9a0866d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzo0MjoyNFrOFy5FVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzo0MjoyNFrOFy5FVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwODM3NQ==", "bodyText": "If keeping this commented code in the PR I would add a note saying why it is there.", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r388908375", "createdAt": "2020-03-06T13:42:24Z", "author": {"login": "agduncan94"}, "path": "dockstore-webservice/src/test/java/core/WDLParseTest.java", "diffHunk": "@@ -130,6 +134,47 @@ private static SourceFile getSourceFile2() {\n     }\n \n \n+    /**\n+     * Tests that Dockstore can handle a workflow with locally recursive imports\n+     */\n+    @Test\n+    public void testLocallyRecursiveImport() {\n+        String type = \"workflow\";\n+        File recursiveWDL = new File(ResourceHelpers.resourceFilePath(\"local-recursive-import/localrecursive.wdl\"));\n+        //String primaryDescriptorFilePath = recursiveWDL.getAbsolutePath();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7155be2eee1d2392951a30179c1b9c91c9a0866d"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "460a66db2618fc4f20de3d65bd53e71766a8fbd6", "author": {"user": {"login": "wshands", "name": "Walter Shands"}}, "url": "https://github.com/dockstore/dockstore/commit/460a66db2618fc4f20de3d65bd53e71766a8fbd6", "committedDate": "2020-03-06T16:38:18Z", "message": "remove commented code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1a14af41b345ae6a14c0f199e3c4b04c70e8010", "author": {"user": {"login": "wshands", "name": "Walter Shands"}}, "url": "https://github.com/dockstore/dockstore/commit/f1a14af41b345ae6a14c0f199e3c4b04c70e8010", "committedDate": "2020-03-10T16:18:21Z", "message": "Merge branch 'develop' into feature/local-recursive-import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMTk2MzY4", "url": "https://github.com/dockstore/dockstore/pull/3272#pullrequestreview-373196368", "createdAt": "2020-03-11T23:40:32Z", "commit": {"oid": "f1a14af41b345ae6a14c0f199e3c4b04c70e8010"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1788, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}