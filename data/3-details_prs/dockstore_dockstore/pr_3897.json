{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExODE1Njc5", "number": 3897, "title": "log all admin actions, remove some admin permissions, see what tests \u2026", "bodyText": "https://ucsc-cgl.atlassian.net/browse/SEAB-1812\nBased off of story time discussion, this PR does the following:\n\nLog every authenticated endpoint that's called by an admin user\nRemoves the following permissions from admins:\n\n\nRefresh another user's workflow, workflow versions, tool\nupdate, delete another user's container\npublish/unpublish another user's entry\nrequest DOI for another user's version\nrestub, update workflow, update workflow version, update workflow path\nadd/delete test parameter files for another user's entry\nedit/delete hosted entries\nadd alias to another user's entry/entry versions (found this out after story time: curators/admins used to be able to to add aliases to another user's entry and be able to bypass some prefix check)\nupdate lables for another user's entry", "createdAt": "2020-10-28T20:22:59Z", "url": "https://github.com/dockstore/dockstore/pull/3897", "merged": true, "mergeCommit": {"oid": "466db09e83fd866ad7e52b1348cf400bc1ccabd0"}, "closed": true, "closedAt": "2020-11-02T17:01:49Z", "author": {"login": "NatalieEO"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXDYBlgH2gAyNTExODE1Njc5OjlhZDY2ZDg0YTdmZjI0Y2VjODI2MTFiZWQyZGVlMjJlYjE5MDk3MmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYmqPggFqTUyMTc1Nzk0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9ad66d84a7ff24cec82611bed2dee22eb190972b", "author": {"user": {"login": "NatalieEO", "name": null}}, "url": "https://github.com/dockstore/dockstore/commit/9ad66d84a7ff24cec82611bed2dee22eb190972b", "committedDate": "2020-10-28T20:13:27Z", "message": "log all admin actions, remove some admin permissions, see what tests fail"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90fe2967a83575bcc0d93c3108617c2a2da5bdd1", "author": {"user": {"login": "NatalieEO", "name": null}}, "url": "https://github.com/dockstore/dockstore/commit/90fe2967a83575bcc0d93c3108617c2a2da5bdd1", "committedDate": "2020-10-29T17:28:23Z", "message": "fix broken tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMTAzMzE0", "url": "https://github.com/dockstore/dockstore/pull/3897#pullrequestreview-520103314", "createdAt": "2020-10-29T21:30:41Z", "commit": {"oid": "90fe2967a83575bcc0d93c3108617c2a2da5bdd1"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMTozMDo0MVrOHqvdfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMTo0Njo0MlrOHqv5GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU3OTgzOQ==", "bodyText": "You could change this to if (principal instanceof User) {. If present, I'm guessing the principal must always be a User, but even so, it would give you more confidence for the next line where you cast it.", "url": "https://github.com/dockstore/dockstore/pull/3897#discussion_r514579839", "createdAt": "2020-10-29T21:30:41Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AdminPrivilegesFilter.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package io.dockstore.webservice.resources;\n+\n+import java.io.IOException;\n+import java.security.Principal;\n+\n+import javax.ws.rs.container.ContainerRequestContext;\n+import javax.ws.rs.container.ContainerResponseContext;\n+import javax.ws.rs.container.ContainerResponseFilter;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.UriInfo;\n+import javax.ws.rs.ext.Provider;\n+\n+import io.dockstore.webservice.core.User;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Provider\n+public class AdminPrivilegesFilter implements ContainerResponseFilter {\n+    private static final Logger LOG = LoggerFactory.getLogger(AdminPrivilegesFilter.class);\n+    @Context\n+    UriInfo uriInfo;\n+\n+    @Override\n+    public void filter(ContainerRequestContext requestContext, ContainerResponseContext responseContext) throws IOException {\n+        if (requestContext != null) {\n+            Principal principal = requestContext.getSecurityContext().getUserPrincipal();\n+            if (principal != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90fe2967a83575bcc0d93c3108617c2a2da5bdd1"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU4MDg3Ng==", "bodyText": "You shouldn't need to cast u to User -- I think it should already be one.", "url": "https://github.com/dockstore/dockstore/pull/3897#discussion_r514580876", "createdAt": "2020-10-29T21:32:58Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AuthenticatedResourceInterface.java", "diffHunk": "@@ -112,6 +112,19 @@ default void checkUser(User user, long id) {\n         }\n     }\n \n+    /**\n+     * Check if entry belongs to user\n+     *\n+     * @param user the user that is requesting something\n+     * @param entry entry to check permissions for\n+     */\n+    default void checkUserOwnsEntry(User user, Entry entry) {\n+        if (entry.getUsers().stream().noneMatch(u -> ((User)(u)).getId() == user.getId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90fe2967a83575bcc0d93c3108617c2a2da5bdd1"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU4MjUxMQ==", "bodyText": "Have you merged/rebased from develop recently? I thought this had been fixed by Gary (I just verified the ticket).", "url": "https://github.com/dockstore/dockstore/pull/3897#discussion_r514582511", "createdAt": "2020-10-29T21:36:32Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "diffHunk": "@@ -1841,7 +1841,7 @@ paths:\n           content:\n             application/json:\n               schema:\n-                $ref: '#/components/schemas/Aliasable'\n+                $ref: '#/components/schemas/WorkflowVersion'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90fe2967a83575bcc0d93c3108617c2a2da5bdd1"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU4NDU0OQ==", "bodyText": "Comment two lines up implies this is a renderer; it's not.", "url": "https://github.com/dockstore/dockstore/pull/3897#discussion_r514584549", "createdAt": "2020-10-29T21:41:13Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/DockstoreWebserviceApplication.java", "diffHunk": "@@ -387,6 +388,7 @@ public void run(DockstoreWebserviceConfiguration configuration, Environment envi\n \n         // extra renderers\n         environment.jersey().register(new CharsetResponseFilter());\n+        environment.jersey().register(new AdminPrivilegesFilter());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90fe2967a83575bcc0d93c3108617c2a2da5bdd1"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU4NTExNA==", "bodyText": "A little JavaDoc explaining what this does would be nice.", "url": "https://github.com/dockstore/dockstore/pull/3897#discussion_r514585114", "createdAt": "2020-10-29T21:42:32Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AdminPrivilegesFilter.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package io.dockstore.webservice.resources;\n+\n+import java.io.IOException;\n+import java.security.Principal;\n+\n+import javax.ws.rs.container.ContainerRequestContext;\n+import javax.ws.rs.container.ContainerResponseContext;\n+import javax.ws.rs.container.ContainerResponseFilter;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.UriInfo;\n+import javax.ws.rs.ext.Provider;\n+\n+import io.dockstore.webservice.core.User;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Provider", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90fe2967a83575bcc0d93c3108617c2a2da5bdd1"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU4NjkwNQ==", "bodyText": "Should this be a ContainerRequestFilter instead? I think the way you have it now it's logging the request when it's sending the response. Ideally you want to log the request right when it comes in. It's a stretch, but if some admin request request crashed the server before the response could be sent, nothing would be logged.\nYou need for the principal to have been set though, or it won't work, so you'll have to see if it's feasible.", "url": "https://github.com/dockstore/dockstore/pull/3897#discussion_r514586905", "createdAt": "2020-10-29T21:46:42Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AdminPrivilegesFilter.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package io.dockstore.webservice.resources;\n+\n+import java.io.IOException;\n+import java.security.Principal;\n+\n+import javax.ws.rs.container.ContainerRequestContext;\n+import javax.ws.rs.container.ContainerResponseContext;\n+import javax.ws.rs.container.ContainerResponseFilter;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.UriInfo;\n+import javax.ws.rs.ext.Provider;\n+\n+import io.dockstore.webservice.core.User;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Provider\n+public class AdminPrivilegesFilter implements ContainerResponseFilter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90fe2967a83575bcc0d93c3108617c2a2da5bdd1"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47446a98a4597d66044394145d23776554187977", "author": {"user": {"login": "NatalieEO", "name": null}}, "url": "https://github.com/dockstore/dockstore/commit/47446a98a4597d66044394145d23776554187977", "committedDate": "2020-10-30T17:00:35Z", "message": "PR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb4d52860ca6def4adcb5ccadd8dba7a902f8485", "author": {"user": {"login": "NatalieEO", "name": null}}, "url": "https://github.com/dockstore/dockstore/commit/cb4d52860ca6def4adcb5ccadd8dba7a902f8485", "committedDate": "2020-10-30T17:01:25Z", "message": "Merge branch 'develop' into feature/seab-1812/logAdminActions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "920390067e0360ded23d2c29711d8a9d96fe83fe", "author": {"user": {"login": "NatalieEO", "name": null}}, "url": "https://github.com/dockstore/dockstore/commit/920390067e0360ded23d2c29711d8a9d96fe83fe", "committedDate": "2020-10-30T17:09:37Z", "message": "build after merge from develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTAyODYx", "url": "https://github.com/dockstore/dockstore/pull/3897#pullrequestreview-520902861", "createdAt": "2020-10-30T17:48:23Z", "commit": {"oid": "920390067e0360ded23d2c29711d8a9d96fe83fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDM1NTM1", "url": "https://github.com/dockstore/dockstore/pull/3897#pullrequestreview-521035535", "createdAt": "2020-10-30T21:05:19Z", "commit": {"oid": "920390067e0360ded23d2c29711d8a9d96fe83fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNzU3OTQz", "url": "https://github.com/dockstore/dockstore/pull/3897#pullrequestreview-521757943", "createdAt": "2020-11-02T15:53:57Z", "commit": {"oid": "920390067e0360ded23d2c29711d8a9d96fe83fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1606, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}