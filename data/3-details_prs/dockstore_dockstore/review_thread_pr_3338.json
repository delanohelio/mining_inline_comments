{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNzMyMzU3", "number": 3338, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNToxNjoxOFrODqbDOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNToxNjoxOFrODqbDOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1ODA5OTc4OnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/QuayImageRegistry.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNToxNjoxOFrOF6KKgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QyMDo0NDo1N1rOF6XaJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyODI1OA==", "bodyText": "Seems possible to simplify.\nIf I understand correctly, this loop is handling the case when we need to paginate. The loop below is when you do not.\nBut all getAllQuayTags is doing is putting all tags into one big collection.\nIt should be possible to simplify by modifying getAllQuayTags to be tolerant of results that are one page.", "url": "https://github.com/dockstore/dockstore/pull/3338#discussion_r396528258", "createdAt": "2020-03-23T15:16:18Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/QuayImageRegistry.java", "diffHunk": "@@ -65,45 +69,72 @@\n     private static final Logger LOG = LoggerFactory.getLogger(QuayImageRegistry.class);\n \n     private final Token quayToken;\n-    private final ApiClient apiClient;\n     private final BuildApi buildApi;\n     private final RepositoryApi repositoryApi;\n     private final UserApi userApi;\n+    private final TagApi tagApi;\n \n     public QuayImageRegistry(final Token quayToken) {\n         this.quayToken = quayToken;\n-\n-        apiClient = Configuration.getDefaultApiClient();\n+        ApiClient apiClient = Configuration.getDefaultApiClient();\n         apiClient.addDefaultHeader(\"Authorization\", \"Bearer \" + quayToken.getContent());\n         this.buildApi = new BuildApi(apiClient);\n         this.repositoryApi = new RepositoryApi(apiClient);\n         this.userApi = new UserApi(apiClient);\n+        this.tagApi = new TagApi((apiClient));\n+\n     }\n \n+    private List<QuayTag> getAllQuayTags(String repository) throws ApiException {\n+        List<QuayTag> allQuayTags = new ArrayList<>();\n+        // Completely arbitrary maxPageSize in the weird event that Quay.io's pagination results in an infinite loop or something\n+        final int maxPageSize = 100;\n+        for (int page = 1; page < Integer.MAX_VALUE; page++) {\n+            InlineResponse2002 inlineResponse2002 = tagApi.listRepoTags(repository, page, maxPageSize, null, true);\n+            List<QuayTag> quayTags = inlineResponse2002.getTags();\n+            allQuayTags.addAll(quayTags);\n+            if (!inlineResponse2002.isHasAdditional()) {\n+                break;\n+            }\n+        }\n+        return allQuayTags;\n+    }\n+\n+\n     @Override\n     public List<Tag> getTags(Tool tool) {\n         LOG.info(quayToken.getUsername() + \" ======================= Getting tags for: {}================================\", tool.getPath());\n-\n+        final String repo = tool.getNamespace() + '/' + tool.getName();\n         final List<Tag> tags = new ArrayList<>();\n         final Optional<QuayRepo> toolFromQuay = getToolFromQuay(tool);\n         if (toolFromQuay.isPresent()) {\n             final QuayRepo quayRepo = toolFromQuay.get();\n             final Map<String, QuayTag> tagsFromRepo = quayRepo.getTags();\n-            for (QuayTag tagItem : tagsFromRepo.values()) {\n+            final int maxQuayTagsReturnedByRepo = 500;\n+            if (tagsFromRepo.size() == maxQuayTagsReturnedByRepo) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eccaf067dada0b686d12c944305e7eac5cd5c3f"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU0NzQ3Nw==", "bodyText": "The loop below is for converting all QuayTags to Tags. getAllQuayTags works even if there's one page (not that it'll ever get to that point).", "url": "https://github.com/dockstore/dockstore/pull/3338#discussion_r396547477", "createdAt": "2020-03-23T15:40:54Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/QuayImageRegistry.java", "diffHunk": "@@ -65,45 +69,72 @@\n     private static final Logger LOG = LoggerFactory.getLogger(QuayImageRegistry.class);\n \n     private final Token quayToken;\n-    private final ApiClient apiClient;\n     private final BuildApi buildApi;\n     private final RepositoryApi repositoryApi;\n     private final UserApi userApi;\n+    private final TagApi tagApi;\n \n     public QuayImageRegistry(final Token quayToken) {\n         this.quayToken = quayToken;\n-\n-        apiClient = Configuration.getDefaultApiClient();\n+        ApiClient apiClient = Configuration.getDefaultApiClient();\n         apiClient.addDefaultHeader(\"Authorization\", \"Bearer \" + quayToken.getContent());\n         this.buildApi = new BuildApi(apiClient);\n         this.repositoryApi = new RepositoryApi(apiClient);\n         this.userApi = new UserApi(apiClient);\n+        this.tagApi = new TagApi((apiClient));\n+\n     }\n \n+    private List<QuayTag> getAllQuayTags(String repository) throws ApiException {\n+        List<QuayTag> allQuayTags = new ArrayList<>();\n+        // Completely arbitrary maxPageSize in the weird event that Quay.io's pagination results in an infinite loop or something\n+        final int maxPageSize = 100;\n+        for (int page = 1; page < Integer.MAX_VALUE; page++) {\n+            InlineResponse2002 inlineResponse2002 = tagApi.listRepoTags(repository, page, maxPageSize, null, true);\n+            List<QuayTag> quayTags = inlineResponse2002.getTags();\n+            allQuayTags.addAll(quayTags);\n+            if (!inlineResponse2002.isHasAdditional()) {\n+                break;\n+            }\n+        }\n+        return allQuayTags;\n+    }\n+\n+\n     @Override\n     public List<Tag> getTags(Tool tool) {\n         LOG.info(quayToken.getUsername() + \" ======================= Getting tags for: {}================================\", tool.getPath());\n-\n+        final String repo = tool.getNamespace() + '/' + tool.getName();\n         final List<Tag> tags = new ArrayList<>();\n         final Optional<QuayRepo> toolFromQuay = getToolFromQuay(tool);\n         if (toolFromQuay.isPresent()) {\n             final QuayRepo quayRepo = toolFromQuay.get();\n             final Map<String, QuayTag> tagsFromRepo = quayRepo.getTags();\n-            for (QuayTag tagItem : tagsFromRepo.values()) {\n+            final int maxQuayTagsReturnedByRepo = 500;\n+            if (tagsFromRepo.size() == maxQuayTagsReturnedByRepo) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyODI1OA=="}, "originalCommit": {"oid": "3eccaf067dada0b686d12c944305e7eac5cd5c3f"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYyNTkyOA==", "bodyText": "Not sure if we're talking about the same thing.\nTo me it looks like the loop on line 117 and the look on 129 are the same, they just run across different collections. It should be possible to\n\nHave one method with a conditional in it to build the right collection in the two cases\nrun one loop on the built collection", "url": "https://github.com/dockstore/dockstore/pull/3338#discussion_r396625928", "createdAt": "2020-03-23T17:26:43Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/QuayImageRegistry.java", "diffHunk": "@@ -65,45 +69,72 @@\n     private static final Logger LOG = LoggerFactory.getLogger(QuayImageRegistry.class);\n \n     private final Token quayToken;\n-    private final ApiClient apiClient;\n     private final BuildApi buildApi;\n     private final RepositoryApi repositoryApi;\n     private final UserApi userApi;\n+    private final TagApi tagApi;\n \n     public QuayImageRegistry(final Token quayToken) {\n         this.quayToken = quayToken;\n-\n-        apiClient = Configuration.getDefaultApiClient();\n+        ApiClient apiClient = Configuration.getDefaultApiClient();\n         apiClient.addDefaultHeader(\"Authorization\", \"Bearer \" + quayToken.getContent());\n         this.buildApi = new BuildApi(apiClient);\n         this.repositoryApi = new RepositoryApi(apiClient);\n         this.userApi = new UserApi(apiClient);\n+        this.tagApi = new TagApi((apiClient));\n+\n     }\n \n+    private List<QuayTag> getAllQuayTags(String repository) throws ApiException {\n+        List<QuayTag> allQuayTags = new ArrayList<>();\n+        // Completely arbitrary maxPageSize in the weird event that Quay.io's pagination results in an infinite loop or something\n+        final int maxPageSize = 100;\n+        for (int page = 1; page < Integer.MAX_VALUE; page++) {\n+            InlineResponse2002 inlineResponse2002 = tagApi.listRepoTags(repository, page, maxPageSize, null, true);\n+            List<QuayTag> quayTags = inlineResponse2002.getTags();\n+            allQuayTags.addAll(quayTags);\n+            if (!inlineResponse2002.isHasAdditional()) {\n+                break;\n+            }\n+        }\n+        return allQuayTags;\n+    }\n+\n+\n     @Override\n     public List<Tag> getTags(Tool tool) {\n         LOG.info(quayToken.getUsername() + \" ======================= Getting tags for: {}================================\", tool.getPath());\n-\n+        final String repo = tool.getNamespace() + '/' + tool.getName();\n         final List<Tag> tags = new ArrayList<>();\n         final Optional<QuayRepo> toolFromQuay = getToolFromQuay(tool);\n         if (toolFromQuay.isPresent()) {\n             final QuayRepo quayRepo = toolFromQuay.get();\n             final Map<String, QuayTag> tagsFromRepo = quayRepo.getTags();\n-            for (QuayTag tagItem : tagsFromRepo.values()) {\n+            final int maxQuayTagsReturnedByRepo = 500;\n+            if (tagsFromRepo.size() == maxQuayTagsReturnedByRepo) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyODI1OA=="}, "originalCommit": {"oid": "3eccaf067dada0b686d12c944305e7eac5cd5c3f"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc0NTI1Mg==", "bodyText": "Changed a few things, but it's one loop now", "url": "https://github.com/dockstore/dockstore/pull/3338#discussion_r396745252", "createdAt": "2020-03-23T20:44:57Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/QuayImageRegistry.java", "diffHunk": "@@ -65,45 +69,72 @@\n     private static final Logger LOG = LoggerFactory.getLogger(QuayImageRegistry.class);\n \n     private final Token quayToken;\n-    private final ApiClient apiClient;\n     private final BuildApi buildApi;\n     private final RepositoryApi repositoryApi;\n     private final UserApi userApi;\n+    private final TagApi tagApi;\n \n     public QuayImageRegistry(final Token quayToken) {\n         this.quayToken = quayToken;\n-\n-        apiClient = Configuration.getDefaultApiClient();\n+        ApiClient apiClient = Configuration.getDefaultApiClient();\n         apiClient.addDefaultHeader(\"Authorization\", \"Bearer \" + quayToken.getContent());\n         this.buildApi = new BuildApi(apiClient);\n         this.repositoryApi = new RepositoryApi(apiClient);\n         this.userApi = new UserApi(apiClient);\n+        this.tagApi = new TagApi((apiClient));\n+\n     }\n \n+    private List<QuayTag> getAllQuayTags(String repository) throws ApiException {\n+        List<QuayTag> allQuayTags = new ArrayList<>();\n+        // Completely arbitrary maxPageSize in the weird event that Quay.io's pagination results in an infinite loop or something\n+        final int maxPageSize = 100;\n+        for (int page = 1; page < Integer.MAX_VALUE; page++) {\n+            InlineResponse2002 inlineResponse2002 = tagApi.listRepoTags(repository, page, maxPageSize, null, true);\n+            List<QuayTag> quayTags = inlineResponse2002.getTags();\n+            allQuayTags.addAll(quayTags);\n+            if (!inlineResponse2002.isHasAdditional()) {\n+                break;\n+            }\n+        }\n+        return allQuayTags;\n+    }\n+\n+\n     @Override\n     public List<Tag> getTags(Tool tool) {\n         LOG.info(quayToken.getUsername() + \" ======================= Getting tags for: {}================================\", tool.getPath());\n-\n+        final String repo = tool.getNamespace() + '/' + tool.getName();\n         final List<Tag> tags = new ArrayList<>();\n         final Optional<QuayRepo> toolFromQuay = getToolFromQuay(tool);\n         if (toolFromQuay.isPresent()) {\n             final QuayRepo quayRepo = toolFromQuay.get();\n             final Map<String, QuayTag> tagsFromRepo = quayRepo.getTags();\n-            for (QuayTag tagItem : tagsFromRepo.values()) {\n+            final int maxQuayTagsReturnedByRepo = 500;\n+            if (tagsFromRepo.size() == maxQuayTagsReturnedByRepo) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyODI1OA=="}, "originalCommit": {"oid": "3eccaf067dada0b686d12c944305e7eac5cd5c3f"}, "originalPosition": 77}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3064, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}