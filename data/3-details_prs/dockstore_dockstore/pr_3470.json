{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2ODMwNDkz", "number": 3470, "title": "Feature/3456/track git commit", "bodyText": "#3456\nKeep track of commit ID for Bitbucket workflows and GitLab workflows. Previously we were only keeping track of GitHub.\nAlso updated two tests (Note GitLab test is currently ignored due to it taking way too long, but it works locally for the sake of this PR).", "createdAt": "2020-05-12T16:18:18Z", "url": "https://github.com/dockstore/dockstore/pull/3470", "merged": true, "mergeCommit": {"oid": "7966409a3af739c473420c611d4f7f2d19ec6116"}, "closed": true, "closedAt": "2020-05-13T20:02:51Z", "author": {"login": "agduncan94"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgV0mTgH2gAyNDE2ODMwNDkzOmM3YzlmYWQ0OTdkZThhZmQyODMyZmJlMzM4ZTI2Y2Y3MzQ0ZjRhZTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcg-dMyAFqTQxMTI1MzY1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c7c9fad497de8afd2832fbe338e26cf7344f4ae7", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/c7c9fad497de8afd2832fbe338e26cf7344f4ae7", "committedDate": "2020-05-11T20:37:07Z", "message": "keep track of bitbucket commit id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dd6da37f92d2ff60d4a70d988c5348bc934b443", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/3dd6da37f92d2ff60d4a70d988c5348bc934b443", "committedDate": "2020-05-11T20:56:11Z", "message": "add support for commit ID for gitlab workflows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfb7b5436ab438e2729cc2179b39acee66ac28c0", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/cfb7b5436ab438e2729cc2179b39acee66ac28c0", "committedDate": "2020-05-12T14:21:00Z", "message": "fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8493766987a7d0ae59f119d8c2e3247eb3a81d7", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/f8493766987a7d0ae59f119d8c2e3247eb3a81d7", "committedDate": "2020-05-12T15:24:29Z", "message": "fix for bitbucket commit id; tests for gitlab and bitbucket commit id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9449ff9a45f697094ff86b932e156a6f7bbc1e1", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/c9449ff9a45f697094ff86b932e156a6f7bbc1e1", "committedDate": "2020-05-12T17:22:54Z", "message": "Merge branch 'develop' into feature/3456/track-git-commit-id"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDI1ODY3", "url": "https://github.com/dockstore/dockstore/pull/3470#pullrequestreview-410425867", "createdAt": "2020-05-12T21:12:14Z", "commit": {"oid": "c9449ff9a45f697094ff86b932e156a6f7bbc1e1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDk5NjY1", "url": "https://github.com/dockstore/dockstore/pull/3470#pullrequestreview-410499665", "createdAt": "2020-05-12T23:51:11Z", "commit": {"oid": "c9449ff9a45f697094ff86b932e156a6f7bbc1e1"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzo1MToxMVrOGUc3EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzo1NDowNFrOGUc6XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5NzU1Mw==", "bodyText": "Log the exception", "url": "https://github.com/dockstore/dockstore/pull/3470#discussion_r424097553", "createdAt": "2020-05-12T23:51:11Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/BitBucketSourceCodeRepo.java", "diffHunk": "@@ -249,17 +249,23 @@ protected String getCommitID(String repositoryId, Version version) {\n         RefsApi refsApi = new RefsApi(apiClient);\n         try {\n             Branch branch = refsApi.repositoriesUsernameRepoSlugRefsBranchesNameGet(repositoryId.split(\"/\")[0], version.getReference(),\n-                repositoryId.split(\"/\")[0]);\n-            Tag tag = refsApi.repositoriesUsernameRepoSlugRefsTagsNameGet(repositoryId.split(\"/\")[0], version.getReference(),\n-                repositoryId.split(\"/\")[0]);\n+                repositoryId.split(\"/\")[1]);\n             if (branch != null) {\n                 return branch.getTarget().getHash();\n             }\n+        } catch (ApiException e) {\n+            LOG.error(gitUsername + \": apiexception on reading branch commitid\" + e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9449ff9a45f697094ff86b932e156a6f7bbc1e1"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5NzYyMg==", "bodyText": "Log the exception", "url": "https://github.com/dockstore/dockstore/pull/3470#discussion_r424097622", "createdAt": "2020-05-12T23:51:24Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/BitBucketSourceCodeRepo.java", "diffHunk": "@@ -249,17 +249,23 @@ protected String getCommitID(String repositoryId, Version version) {\n         RefsApi refsApi = new RefsApi(apiClient);\n         try {\n             Branch branch = refsApi.repositoriesUsernameRepoSlugRefsBranchesNameGet(repositoryId.split(\"/\")[0], version.getReference(),\n-                repositoryId.split(\"/\")[0]);\n-            Tag tag = refsApi.repositoriesUsernameRepoSlugRefsTagsNameGet(repositoryId.split(\"/\")[0], version.getReference(),\n-                repositoryId.split(\"/\")[0]);\n+                repositoryId.split(\"/\")[1]);\n             if (branch != null) {\n                 return branch.getTarget().getHash();\n             }\n+        } catch (ApiException e) {\n+            LOG.error(gitUsername + \": apiexception on reading branch commitid\" + e.getMessage());\n+            // this is not so critical to warrant a http error code\n+        }\n+\n+        try {\n+            Tag tag = refsApi.repositoriesUsernameRepoSlugRefsTagsNameGet(repositoryId.split(\"/\")[0], version.getReference(),\n+                    repositoryId.split(\"/\")[1]);\n             if (tag != null) {\n                 return tag.getTarget().getHash();\n             }\n         } catch (ApiException e) {\n-            LOG.error(gitUsername + \": apiexception on reading commitid\" + e.getMessage());\n+            LOG.error(gitUsername + \": apiexception on reading tag commitid\" + e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9449ff9a45f697094ff86b932e156a6f7bbc1e1"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5ODM5Ng==", "bodyText": "Without understanding the whole flow, why can't this return version.getCommitId()? If not, what is the TODO that you need to do?", "url": "https://github.com/dockstore/dockstore/pull/3470#discussion_r424098396", "createdAt": "2020-05-12T23:54:04Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitLabSourceCodeRepo.java", "diffHunk": "@@ -185,7 +188,7 @@ public void updateReferenceType(String repositoryId, Version version) {\n \n     @Override\n     protected String getCommitID(String repositoryId, Version version) {\n-        //TODO: optimize here for gitlab by returning actual sha1\n+        //TODO: Commit ID is returned by an existing API call", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9449ff9a45f697094ff86b932e156a6f7bbc1e1"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de15bef16ca17e69c42f73d104973a1c9151dd83", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/de15bef16ca17e69c42f73d104973a1c9151dd83", "committedDate": "2020-05-13T12:37:11Z", "message": "changes from pr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae3e570b4325f1c807b7e6804d30c1858687c807", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/ae3e570b4325f1c807b7e6804d30c1858687c807", "committedDate": "2020-05-13T12:54:51Z", "message": "Merge branch 'feature/3456/track-git-commit-id' of github.com:ga4gh/dockstore into feature/3456/track-git-commit-id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60a9bc076a4144bdff4398779c0f2e38912f2dab", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/60a9bc076a4144bdff4398779c0f2e38912f2dab", "committedDate": "2020-05-13T12:55:09Z", "message": "track gitlab commit for tools"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f560d7d93fe527d32378d21de0964294d11c86cd", "author": {"user": {"login": "agduncan94", "name": "Andrew Duncan"}}, "url": "https://github.com/dockstore/dockstore/commit/f560d7d93fe527d32378d21de0964294d11c86cd", "committedDate": "2020-05-13T13:03:29Z", "message": "fix whitespace issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMDkxODk2", "url": "https://github.com/dockstore/dockstore/pull/3470#pullrequestreview-411091896", "createdAt": "2020-05-13T16:21:27Z", "commit": {"oid": "f560d7d93fe527d32378d21de0964294d11c86cd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjIzMzQ0", "url": "https://github.com/dockstore/dockstore/pull/3470#pullrequestreview-411223344", "createdAt": "2020-05-13T19:13:36Z", "commit": {"oid": "f560d7d93fe527d32378d21de0964294d11c86cd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjUzNjU0", "url": "https://github.com/dockstore/dockstore/pull/3470#pullrequestreview-411253654", "createdAt": "2020-05-13T19:57:40Z", "commit": {"oid": "f560d7d93fe527d32378d21de0964294d11c86cd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1883, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}