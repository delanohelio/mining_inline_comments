{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4MDAyMDA0", "number": 3846, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNjoxMjo1MlrOErQTGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMTozMzozOVrOEsNA5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNzkxMjU5OnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/resources/migrations.1.10.0.xml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNjoxMjo1MlrOHd7EKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMDo1NjozNFrOHewHZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzODQ3Mw==", "bodyText": "Can you have a unique constraint on all 3 columns together (entry_id, version_id, collection_id)? The problem is that version_id is nullable; I don't know if that will work.\nMaybe this: https://stackoverflow.com/questions/8289100/create-unique-constraint-with-null-columns", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r501138473", "createdAt": "2020-10-07T16:12:52Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/resources/migrations.1.10.0.xml", "diffHunk": "@@ -77,4 +77,22 @@\n     <changeSet author=\"nolwarre (generated)\" id=\"notificationsCharLimit\">\n         <modifyDataType columnName=\"message\" newDataType=\"varchar(1024)\" tableName=\"notification\"/>\n     </changeSet>\n+    <changeSet author=\"gluu (generated)\" id=\"1601569350016-13\">\n+        <createTable tableName=\"collection_entry_version\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c543ee52d2ef51d928735653b95fcc5c563eae2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwNzM4NA==", "bodyText": "We did this before to enforce the nullable but unique workflow names", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r501307384", "createdAt": "2020-10-07T21:01:06Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/resources/migrations.1.10.0.xml", "diffHunk": "@@ -77,4 +77,22 @@\n     <changeSet author=\"nolwarre (generated)\" id=\"notificationsCharLimit\">\n         <modifyDataType columnName=\"message\" newDataType=\"varchar(1024)\" tableName=\"notification\"/>\n     </changeSet>\n+    <changeSet author=\"gluu (generated)\" id=\"1601569350016-13\">\n+        <createTable tableName=\"collection_entry_version\">", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzODQ3Mw=="}, "originalCommit": {"oid": "0c543ee52d2ef51d928735653b95fcc5c563eae2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAwNzY1NQ==", "bodyText": "Done", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r502007655", "createdAt": "2020-10-08T20:56:34Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/resources/migrations.1.10.0.xml", "diffHunk": "@@ -77,4 +77,22 @@\n     <changeSet author=\"nolwarre (generated)\" id=\"notificationsCharLimit\">\n         <modifyDataType columnName=\"message\" newDataType=\"varchar(1024)\" tableName=\"notification\"/>\n     </changeSet>\n+    <changeSet author=\"gluu (generated)\" id=\"1601569350016-13\">\n+        <createTable tableName=\"collection_entry_version\">", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzODQ3Mw=="}, "originalCommit": {"oid": "0c543ee52d2ef51d928735653b95fcc5c563eae2"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzODk3OTc3OnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Collection.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMTowMjo1NFrOHeFbpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMTowMjo1NFrOHeFbpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwODMyNQ==", "bodyText": "Bike-shedding, but really not a fan of this formatting style in Java", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r501308325", "createdAt": "2020-10-07T21:02:54Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Collection.java", "diffHunk": "@@ -85,10 +87,16 @@\n     @Schema(description = \"Short description of the collection\", required = true, example = \"A collection of alignment algorithms\")\n     private String topic;\n \n-    @ManyToMany(fetch = FetchType.LAZY)\n-    @JoinTable(name = \"collection_entry\", joinColumns = @JoinColumn(name = \"collectionid\"), inverseJoinColumns = @JoinColumn(name = \"entryid\"))\n+    @OneToMany(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c543ee52d2ef51d928735653b95fcc5c563eae2"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzODk5NDE5OnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/resources/migrations.1.10.0.xml", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMTowNzoyNFrOHeFkPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoyNzozMFrOHeygvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMxMDUyNg==", "bodyText": "Why does this join table have its own id (possible inspiration from user_entry or organization_user which don't have their own id.", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r501310526", "createdAt": "2020-10-07T21:07:24Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/resources/migrations.1.10.0.xml", "diffHunk": "@@ -77,4 +77,22 @@\n     <changeSet author=\"nolwarre (generated)\" id=\"notificationsCharLimit\">\n         <modifyDataType columnName=\"message\" newDataType=\"varchar(1024)\" tableName=\"notification\"/>\n     </changeSet>\n+    <changeSet author=\"gluu (generated)\" id=\"1601569350016-13\">\n+        <createTable tableName=\"collection_entry_version\">\n+            <column autoIncrement=\"true\" name=\"id\" type=\"SERIAL\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c543ee52d2ef51d928735653b95fcc5c563eae2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg3NjEyMg==", "bodyText": "Other tables don't need an ID because they use a composite key (based on all their non-nullable) columns, since version id is null-able, it isn't possible.", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r501876122", "createdAt": "2020-10-08T17:04:45Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/resources/migrations.1.10.0.xml", "diffHunk": "@@ -77,4 +77,22 @@\n     <changeSet author=\"nolwarre (generated)\" id=\"notificationsCharLimit\">\n         <modifyDataType columnName=\"message\" newDataType=\"varchar(1024)\" tableName=\"notification\"/>\n     </changeSet>\n+    <changeSet author=\"gluu (generated)\" id=\"1601569350016-13\">\n+        <createTable tableName=\"collection_entry_version\">\n+            <column autoIncrement=\"true\" name=\"id\" type=\"SERIAL\">", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMxMDUyNg=="}, "originalCommit": {"oid": "0c543ee52d2ef51d928735653b95fcc5c563eae2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0NjkxMA==", "bodyText": "interesting", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r502046910", "createdAt": "2020-10-08T22:27:30Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/resources/migrations.1.10.0.xml", "diffHunk": "@@ -77,4 +77,22 @@\n     <changeSet author=\"nolwarre (generated)\" id=\"notificationsCharLimit\">\n         <modifyDataType columnName=\"message\" newDataType=\"varchar(1024)\" tableName=\"notification\"/>\n     </changeSet>\n+    <changeSet author=\"gluu (generated)\" id=\"1601569350016-13\">\n+        <createTable tableName=\"collection_entry_version\">\n+            <column autoIncrement=\"true\" name=\"id\" type=\"SERIAL\">", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMxMDUyNg=="}, "originalCommit": {"oid": "0c543ee52d2ef51d928735653b95fcc5c563eae2"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MzU0MDQyOnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/resources/import.sql", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMTowOTozNFrOHewgKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMTowOTozNFrOHewgKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAxMzk5Mw==", "bodyText": "Missing newline per GitHub", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r502013993", "createdAt": "2020-10-08T21:09:34Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/resources/import.sql", "diffHunk": "@@ -38,3 +38,6 @@ ALTER TABLE workflowversion ADD CONSTRAINT fk_workflowVersionMetadata FOREIGN KE\n \n -- cannot seem to define these due to inheritance\n ALTER TABLE tag ADD CONSTRAINT parentid_constraint FOREIGN KEY(parentid) REFERENCES tool (id) DEFERRABLE INITIALLY DEFERRED;\n+\n+CREATE UNIQUE INDEX unique_collection_entry ON collection_entry_version USING btree (collection_id, entry_id) WHERE version_id IS NULL;\n+CREATE UNIQUE INDEX unique_collection_entry_version ON collection_entry_version USING btree (collection_id, entry_id, version_id) WHERE version_id IS NOT NULL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1827310df08b52be7ec3b2c7d86e4f5a0df69911"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MzU1NjYwOnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/resources/import.sql", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMToxNDo0NlrOHewp1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoyNDozMlrOHeycUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAxNjQ3MQ==", "bodyText": "What is this file for again? This SQL is already in the migrations XML..", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r502016471", "createdAt": "2020-10-08T21:14:46Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/resources/import.sql", "diffHunk": "@@ -38,3 +38,6 @@ ALTER TABLE workflowversion ADD CONSTRAINT fk_workflowVersionMetadata FOREIGN KE\n \n -- cannot seem to define these due to inheritance\n ALTER TABLE tag ADD CONSTRAINT parentid_constraint FOREIGN KEY(parentid) REFERENCES tool (id) DEFERRABLE INITIALLY DEFERRED;\n+\n+CREATE UNIQUE INDEX unique_collection_entry ON collection_entry_version USING btree (collection_id, entry_id) WHERE version_id IS NULL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1827310df08b52be7ec3b2c7d86e4f5a0df69911"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzODA1NA==", "bodyText": "I just discovered this file today.  So what happens is if I just do the migrations in the usual place, liquibase will complain and try to drop the constraint. So I had to put it here to in order to override it. I'm guessing it's what the file is for", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r502038054", "createdAt": "2020-10-08T22:03:41Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/resources/import.sql", "diffHunk": "@@ -38,3 +38,6 @@ ALTER TABLE workflowversion ADD CONSTRAINT fk_workflowVersionMetadata FOREIGN KE\n \n -- cannot seem to define these due to inheritance\n ALTER TABLE tag ADD CONSTRAINT parentid_constraint FOREIGN KEY(parentid) REFERENCES tool (id) DEFERRABLE INITIALLY DEFERRED;\n+\n+CREATE UNIQUE INDEX unique_collection_entry ON collection_entry_version USING btree (collection_id, entry_id) WHERE version_id IS NULL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAxNjQ3MQ=="}, "originalCommit": {"oid": "1827310df08b52be7ec3b2c7d86e4f5a0df69911"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0NTc3Ng==", "bodyText": "there's a comment above\n-- this file is a last chance to modify any database schema in hibernate (hbm2ddl) create mode with postgres-specific\n-- changes not possible in JPA\n\nbasically, if you can't create something (like partial indexes) in JPA because they're postgres specific, create them here and in migrations", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r502045776", "createdAt": "2020-10-08T22:24:32Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/resources/import.sql", "diffHunk": "@@ -38,3 +38,6 @@ ALTER TABLE workflowversion ADD CONSTRAINT fk_workflowVersionMetadata FOREIGN KE\n \n -- cannot seem to define these due to inheritance\n ALTER TABLE tag ADD CONSTRAINT parentid_constraint FOREIGN KEY(parentid) REFERENCES tool (id) DEFERRABLE INITIALLY DEFERRED;\n+\n+CREATE UNIQUE INDEX unique_collection_entry ON collection_entry_version USING btree (collection_id, entry_id) WHERE version_id IS NULL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAxNjQ3MQ=="}, "originalCommit": {"oid": "1827310df08b52be7ec3b2c7d86e4f5a0df69911"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0Nzg2MDEzOnYy", "diffSide": "RIGHT", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/OrganizationIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMTozMzozNlrOHfZNYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMTozMzozNlrOHfZNYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MDkyOQ==", "bodyText": "Codacy found an issue: '9L' is a magic number.", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r502680929", "createdAt": "2020-10-09T21:33:36Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/OrganizationIT.java", "diffHunk": "@@ -1314,6 +1312,25 @@ public void testBasicCollections() {\n             fail(\"Was able to reject an approved collection\");\n         }\n \n+        // version 8 and 9 belong to entryId 2\n+        long versionId = 9L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5aff7e13c6f4ab8506532117c33c9761be30bd1b"}, "originalPosition": 130}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0Nzg2MDIzOnYy", "diffSide": "RIGHT", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/OrganizationIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMTozMzozOVrOHfZNcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMTozMzozOVrOHfZNcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MDk0NA==", "bodyText": "Codacy found an issue: '3' is a magic number.", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r502680944", "createdAt": "2020-10-09T21:33:39Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/OrganizationIT.java", "diffHunk": "@@ -1314,6 +1312,25 @@ public void testBasicCollections() {\n             fail(\"Was able to reject an approved collection\");\n         }\n \n+        // version 8 and 9 belong to entryId 2\n+        long versionId = 9L;\n+\n+        // Add tool and specific version to collection\n+        organizationsApi.addEntryToCollection(organization.getId(), collectionId, entryId, versionId);\n+        organizationsApi.addEntryToCollection(organization.getId(), collectionId, entryId, null);\n+\n+        // There should now be two entries for collection with ID 1 (one with version, one without), 3 entries in total\n+        collectionById = organizationsApi.getCollectionById(organizationID, collectionId);\n+        assertEquals(3, collectionById.getEntries().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5aff7e13c6f4ab8506532117c33c9761be30bd1b"}, "originalPosition": 138}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2871, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}