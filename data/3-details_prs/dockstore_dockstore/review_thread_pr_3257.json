{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NDcyMzkz", "number": 3257, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMzozNTo1MFrODihBjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwNTowMDo1MlrODikPeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3NTE5MjQ3OnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/resources/migrations.1.8.0.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMzozNTo1MFrOFtzvVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNjoxMTo0MFrOFuMV4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU3Nzk0MQ==", "bodyText": "constraint names", "url": "https://github.com/dockstore/dockstore/pull/3257#discussion_r383577941", "createdAt": "2020-02-24T23:35:50Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/resources/migrations.1.8.0.xml", "diffHunk": "@@ -181,4 +181,85 @@\n         <addNotNullConstraint tableName=\"tag\" columnName=\"dbcreatedate\"/>\n         <addNotNullConstraint tableName=\"tag\" columnName=\"dbupdatedate\"/>\n     </changeSet>\n+\n+    <changeSet author=\"dyuen\" id=\"restructure_workflowversions\">\n+        <addColumn tableName=\"tag\">\n+            <column name=\"parentid\" type=\"int8\">\n+            </column>\n+        </addColumn>\n+        <addColumn tableName=\"workflowversion\">\n+            <column name=\"parentid\" type=\"int8\">\n+            </column>\n+        </addColumn>\n+        <!-- migrate data -->\n+        <sql dbms=\"postgresql\">\n+            update workflowversion set parentid = wwv.workflowid from workflowversion as wv join workflow_workflowversion as wwv on wv.id = wwv.workflowversionid where workflowversion.id = wv.id;\n+            update tag set parentid = tt.toolid from tag as t join tool_tag as tt on t.id = tt.tagid where tag.id = t.id;\n+        </sql>\n+\n+        <!-- clean-up -->\n+        <dropForeignKeyConstraint baseTableName=\"tool_tag\" constraintName=\"fkjkn6qubuvn25bun52eqjleyl6\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b03a7143725f56c9611541026529976ee8bd694"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk4MTAyNg==", "bodyText": "I might not follow, but unfortunately they do appear to have these names in prod", "url": "https://github.com/dockstore/dockstore/pull/3257#discussion_r383981026", "createdAt": "2020-02-25T16:11:40Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/resources/migrations.1.8.0.xml", "diffHunk": "@@ -181,4 +181,85 @@\n         <addNotNullConstraint tableName=\"tag\" columnName=\"dbcreatedate\"/>\n         <addNotNullConstraint tableName=\"tag\" columnName=\"dbupdatedate\"/>\n     </changeSet>\n+\n+    <changeSet author=\"dyuen\" id=\"restructure_workflowversions\">\n+        <addColumn tableName=\"tag\">\n+            <column name=\"parentid\" type=\"int8\">\n+            </column>\n+        </addColumn>\n+        <addColumn tableName=\"workflowversion\">\n+            <column name=\"parentid\" type=\"int8\">\n+            </column>\n+        </addColumn>\n+        <!-- migrate data -->\n+        <sql dbms=\"postgresql\">\n+            update workflowversion set parentid = wwv.workflowid from workflowversion as wv join workflow_workflowversion as wwv on wv.id = wwv.workflowversionid where workflowversion.id = wv.id;\n+            update tag set parentid = tt.toolid from tag as t join tool_tag as tt on t.id = tt.tagid where tag.id = t.id;\n+        </sql>\n+\n+        <!-- clean-up -->\n+        <dropForeignKeyConstraint baseTableName=\"tool_tag\" constraintName=\"fkjkn6qubuvn25bun52eqjleyl6\"/>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU3Nzk0MQ=="}, "originalCommit": {"oid": "8b03a7143725f56c9611541026529976ee8bd694"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3NTY5Nzc0OnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/resources/migrations.1.8.0.xml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwNDo0NDo1MVrOFt4g9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNTo1MDowNVrOFuLceQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY1NjE4MQ==", "bodyText": "Do you need or want to delete the now orphaned source files as well? Or handle that after this shakes out?", "url": "https://github.com/dockstore/dockstore/pull/3257#discussion_r383656181", "createdAt": "2020-02-25T04:44:51Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/resources/migrations.1.8.0.xml", "diffHunk": "@@ -181,4 +181,85 @@\n         <addNotNullConstraint tableName=\"tag\" columnName=\"dbcreatedate\"/>\n         <addNotNullConstraint tableName=\"tag\" columnName=\"dbupdatedate\"/>\n     </changeSet>\n+\n+    <changeSet author=\"dyuen\" id=\"restructure_workflowversions\">\n+        <addColumn tableName=\"tag\">\n+            <column name=\"parentid\" type=\"int8\">\n+            </column>\n+        </addColumn>\n+        <addColumn tableName=\"workflowversion\">\n+            <column name=\"parentid\" type=\"int8\">\n+            </column>\n+        </addColumn>\n+        <!-- migrate data -->\n+        <sql dbms=\"postgresql\">\n+            update workflowversion set parentid = wwv.workflowid from workflowversion as wv join workflow_workflowversion as wwv on wv.id = wwv.workflowversionid where workflowversion.id = wv.id;\n+            update tag set parentid = tt.toolid from tag as t join tool_tag as tt on t.id = tt.tagid where tag.id = t.id;\n+        </sql>\n+\n+        <!-- clean-up -->\n+        <dropForeignKeyConstraint baseTableName=\"tool_tag\" constraintName=\"fkjkn6qubuvn25bun52eqjleyl6\"/>\n+        <dropForeignKeyConstraint baseTableName=\"tool_tag\" constraintName=\"fkjtsjg6jdnwxoeicd27ujmeeaj\"/>\n+        <dropForeignKeyConstraint baseTableName=\"workflow_workflowversion\" constraintName=\"fkibmeux3552ua8dwnqdb8w6991\"/>\n+        <dropUniqueConstraint constraintName=\"uk_encl8hnebnkcaxj9tlugr9cxh\" tableName=\"workflow_workflowversion\"/>\n+        <dropTable tableName=\"workflow_workflowversion\"/>\n+        <dropTable tableName=\"tool_tag\"/>\n+    </changeSet>\n+\n+    <changeSet author=\"dyuen\" id=\"cleanup invalid content\">\n+        <!-- need to investigate whether too much content is being dropped and whether the right content is being dropped -->\n+        <comment>some orphaned versions are protected by security</comment>\n+        <sql dbms=\"postgresql\">\n+            alter table workflowversion disable row level security;\n+            alter table tag disable row level security;\n+        </sql>\n+\n+        <comment>delete the versions that are orphaned already</comment>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b03a7143725f56c9611541026529976ee8bd694"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk2NjMyOQ==", "bodyText": "I think that would be reasonable to do, I'll add it to the TODO when this spawns new tickets", "url": "https://github.com/dockstore/dockstore/pull/3257#discussion_r383966329", "createdAt": "2020-02-25T15:50:05Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/resources/migrations.1.8.0.xml", "diffHunk": "@@ -181,4 +181,85 @@\n         <addNotNullConstraint tableName=\"tag\" columnName=\"dbcreatedate\"/>\n         <addNotNullConstraint tableName=\"tag\" columnName=\"dbupdatedate\"/>\n     </changeSet>\n+\n+    <changeSet author=\"dyuen\" id=\"restructure_workflowversions\">\n+        <addColumn tableName=\"tag\">\n+            <column name=\"parentid\" type=\"int8\">\n+            </column>\n+        </addColumn>\n+        <addColumn tableName=\"workflowversion\">\n+            <column name=\"parentid\" type=\"int8\">\n+            </column>\n+        </addColumn>\n+        <!-- migrate data -->\n+        <sql dbms=\"postgresql\">\n+            update workflowversion set parentid = wwv.workflowid from workflowversion as wv join workflow_workflowversion as wwv on wv.id = wwv.workflowversionid where workflowversion.id = wv.id;\n+            update tag set parentid = tt.toolid from tag as t join tool_tag as tt on t.id = tt.tagid where tag.id = t.id;\n+        </sql>\n+\n+        <!-- clean-up -->\n+        <dropForeignKeyConstraint baseTableName=\"tool_tag\" constraintName=\"fkjkn6qubuvn25bun52eqjleyl6\"/>\n+        <dropForeignKeyConstraint baseTableName=\"tool_tag\" constraintName=\"fkjtsjg6jdnwxoeicd27ujmeeaj\"/>\n+        <dropForeignKeyConstraint baseTableName=\"workflow_workflowversion\" constraintName=\"fkibmeux3552ua8dwnqdb8w6991\"/>\n+        <dropUniqueConstraint constraintName=\"uk_encl8hnebnkcaxj9tlugr9cxh\" tableName=\"workflow_workflowversion\"/>\n+        <dropTable tableName=\"workflow_workflowversion\"/>\n+        <dropTable tableName=\"tool_tag\"/>\n+    </changeSet>\n+\n+    <changeSet author=\"dyuen\" id=\"cleanup invalid content\">\n+        <!-- need to investigate whether too much content is being dropped and whether the right content is being dropped -->\n+        <comment>some orphaned versions are protected by security</comment>\n+        <sql dbms=\"postgresql\">\n+            alter table workflowversion disable row level security;\n+            alter table tag disable row level security;\n+        </sql>\n+\n+        <comment>delete the versions that are orphaned already</comment>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY1NjE4MQ=="}, "originalCommit": {"oid": "8b03a7143725f56c9611541026529976ee8bd694"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3NTcxOTYyOnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwNTowMDo1MlrOFt4tsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNjowNjoyNVrOFuMH_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY1OTQ0MQ==", "bodyText": "I don't understand the need for this -- on line 214 you've already verified that the map does not contain the name. How could the map now contain the name? Can line 221/223 change the name? Otherwise this seems redundant. Or I'm missing something.", "url": "https://github.com/dockstore/dockstore/pull/3257#discussion_r383659441", "createdAt": "2020-02-25T05:00:52Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -217,11 +217,17 @@ protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Work\n                 }\n                 workflowVersionFromDB.update(version);\n             } else {\n-                // create a new one and replace the old one\n+                // attach real workflow\n+                workflow.addWorkflowVersion(version);\n+\n                 final long workflowVersionId = workflowVersionDAO.create(version);\n                 releaseCreated = true;\n                 workflowVersionFromDB = workflowVersionDAO.findById(workflowVersionId);\n                 workflow.getWorkflowVersions().add(workflowVersionFromDB);\n+                // create a new one and replace the old one if it exists\n+                if (existingVersionMap.containsKey(workflowVersionFromDB.getName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b03a7143725f56c9611541026529976ee8bd694"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk3NzQ2OQ==", "bodyText": "I think it should be redundant, I probably had something else in mind.", "url": "https://github.com/dockstore/dockstore/pull/3257#discussion_r383977469", "createdAt": "2020-02-25T16:06:25Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -217,11 +217,17 @@ protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Work\n                 }\n                 workflowVersionFromDB.update(version);\n             } else {\n-                // create a new one and replace the old one\n+                // attach real workflow\n+                workflow.addWorkflowVersion(version);\n+\n                 final long workflowVersionId = workflowVersionDAO.create(version);\n                 releaseCreated = true;\n                 workflowVersionFromDB = workflowVersionDAO.findById(workflowVersionId);\n                 workflow.getWorkflowVersions().add(workflowVersionFromDB);\n+                // create a new one and replace the old one if it exists\n+                if (existingVersionMap.containsKey(workflowVersionFromDB.getName())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY1OTQ0MQ=="}, "originalCommit": {"oid": "8b03a7143725f56c9611541026529976ee8bd694"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2998, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}