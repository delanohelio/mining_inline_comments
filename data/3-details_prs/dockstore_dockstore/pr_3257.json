{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NDcyMzkz", "number": 3257, "title": "Constrain unique version names for workflow versions plus tags", "bodyText": "A structural fix which is probably controversial for what would normally be considered a hotfix. Getting reviews for discussion\n\nlocally working fix for #3252\nintroduces constraints (note that constraints for tags can be foreign keys since they always go with tools, workflowversions are used for both services and bioworkflow, so we can't put in a foreign key constraint .... both get not null constraints and unique constraints though)\na number of endpoints are changed, when working with DAOs you can no longer create a tag/workflowversion without a valid parent at the time of creation(not null constraints are not deferrable), in some parts of the code we used to create versions and link them up afterwards\na handful of named queries are changed and two join tables are deleted\n\nOverall, this is a tricky PR that could have side-effects/needs some careful testing (thanks for existing testing for catching a number of edge cases already)\nTODO: https://ucsc-cgl.atlassian.net/browse/SEAB-870\nmay need help with these items\n\nwill need further testing and/or better migration to make sure we're not deleting too much when introducing constraints, but also delete source files and other dependent records linked to the now deleted versions\nwill need to test adding aliases more carefully (had to update native query, so converted to JPQL while at it)", "createdAt": "2020-02-21T21:05:59Z", "url": "https://github.com/dockstore/dockstore/pull/3257", "merged": true, "mergeCommit": {"oid": "77ee6c775cb83dd04f895a4eca9b2b1345fe1a94"}, "closed": true, "closedAt": "2020-02-28T16:39:29Z", "author": {"login": "denis-yuen"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGhjitgH2gAyMzc4NDcyMzkzOjg3MTc4NDNmY2FhMDkxMDhkYjE4YzM3MDc4NGNhZjNhYWJhMmVjMzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcH2RJIgFqTM2NDMzODc3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8717843fcaa09108db18c370784caf3aaba2ec36", "author": {"user": {"login": "denis-yuen", "name": "Denis Yuen"}}, "url": "https://github.com/dockstore/dockstore/commit/8717843fcaa09108db18c370784caf3aaba2ec36", "committedDate": "2020-02-21T15:35:19Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c157f2c2f142f5d5b135c10690dff0c422f1ab6", "author": {"user": {"login": "denis-yuen", "name": "Denis Yuen"}}, "url": "https://github.com/dockstore/dockstore/commit/0c157f2c2f142f5d5b135c10690dff0c422f1ab6", "committedDate": "2020-02-21T21:02:11Z", "message": "Locally working db changes\n\n* addresses duplicate workflow versions\n* no way to not touch tags at the same time due to inheritance\n* will need to test well for side-effects\n* particularly refresh/upsert/etc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4151582f527d26780e1113458b72bfa701662cfe", "author": {"user": {"login": "denis-yuen", "name": "Denis Yuen"}}, "url": "https://github.com/dockstore/dockstore/commit/4151582f527d26780e1113458b72bfa701662cfe", "committedDate": "2020-02-21T21:53:54Z", "message": "Remove constraint for version due to inheritance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ce552e6779411a48a25430514194ac6918a7de4", "author": {"user": {"login": "denis-yuen", "name": "Denis Yuen"}}, "url": "https://github.com/dockstore/dockstore/commit/8ce552e6779411a48a25430514194ac6918a7de4", "committedDate": "2020-02-21T22:09:24Z", "message": "Delete less content in migration due to services"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b03a7143725f56c9611541026529976ee8bd694", "author": {"user": {"login": "denis-yuen", "name": "Denis Yuen"}}, "url": "https://github.com/dockstore/dockstore/commit/8b03a7143725f56c9611541026529976ee8bd694", "committedDate": "2020-02-24T19:58:07Z", "message": "Some patches for edge cases, probably need more"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04399624b0b5cb43130e55362320b3a10cd1cdf3", "author": {"user": {"login": "denis-yuen", "name": "Denis Yuen"}}, "url": "https://github.com/dockstore/dockstore/commit/04399624b0b5cb43130e55362320b3a10cd1cdf3", "committedDate": "2020-02-24T20:54:23Z", "message": "validation fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzODY3Njc2", "url": "https://github.com/dockstore/dockstore/pull/3257#pullrequestreview-363867676", "createdAt": "2020-02-25T04:44:51Z", "commit": {"oid": "8b03a7143725f56c9611541026529976ee8bd694"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwNDo0NDo1MVrOFt4g9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwNTowMDo1MlrOFt4tsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY1NjE4MQ==", "bodyText": "Do you need or want to delete the now orphaned source files as well? Or handle that after this shakes out?", "url": "https://github.com/dockstore/dockstore/pull/3257#discussion_r383656181", "createdAt": "2020-02-25T04:44:51Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/resources/migrations.1.8.0.xml", "diffHunk": "@@ -181,4 +181,85 @@\n         <addNotNullConstraint tableName=\"tag\" columnName=\"dbcreatedate\"/>\n         <addNotNullConstraint tableName=\"tag\" columnName=\"dbupdatedate\"/>\n     </changeSet>\n+\n+    <changeSet author=\"dyuen\" id=\"restructure_workflowversions\">\n+        <addColumn tableName=\"tag\">\n+            <column name=\"parentid\" type=\"int8\">\n+            </column>\n+        </addColumn>\n+        <addColumn tableName=\"workflowversion\">\n+            <column name=\"parentid\" type=\"int8\">\n+            </column>\n+        </addColumn>\n+        <!-- migrate data -->\n+        <sql dbms=\"postgresql\">\n+            update workflowversion set parentid = wwv.workflowid from workflowversion as wv join workflow_workflowversion as wwv on wv.id = wwv.workflowversionid where workflowversion.id = wv.id;\n+            update tag set parentid = tt.toolid from tag as t join tool_tag as tt on t.id = tt.tagid where tag.id = t.id;\n+        </sql>\n+\n+        <!-- clean-up -->\n+        <dropForeignKeyConstraint baseTableName=\"tool_tag\" constraintName=\"fkjkn6qubuvn25bun52eqjleyl6\"/>\n+        <dropForeignKeyConstraint baseTableName=\"tool_tag\" constraintName=\"fkjtsjg6jdnwxoeicd27ujmeeaj\"/>\n+        <dropForeignKeyConstraint baseTableName=\"workflow_workflowversion\" constraintName=\"fkibmeux3552ua8dwnqdb8w6991\"/>\n+        <dropUniqueConstraint constraintName=\"uk_encl8hnebnkcaxj9tlugr9cxh\" tableName=\"workflow_workflowversion\"/>\n+        <dropTable tableName=\"workflow_workflowversion\"/>\n+        <dropTable tableName=\"tool_tag\"/>\n+    </changeSet>\n+\n+    <changeSet author=\"dyuen\" id=\"cleanup invalid content\">\n+        <!-- need to investigate whether too much content is being dropped and whether the right content is being dropped -->\n+        <comment>some orphaned versions are protected by security</comment>\n+        <sql dbms=\"postgresql\">\n+            alter table workflowversion disable row level security;\n+            alter table tag disable row level security;\n+        </sql>\n+\n+        <comment>delete the versions that are orphaned already</comment>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b03a7143725f56c9611541026529976ee8bd694"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY1OTQ0MQ==", "bodyText": "I don't understand the need for this -- on line 214 you've already verified that the map does not contain the name. How could the map now contain the name? Can line 221/223 change the name? Otherwise this seems redundant. Or I'm missing something.", "url": "https://github.com/dockstore/dockstore/pull/3257#discussion_r383659441", "createdAt": "2020-02-25T05:00:52Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -217,11 +217,17 @@ protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Work\n                 }\n                 workflowVersionFromDB.update(version);\n             } else {\n-                // create a new one and replace the old one\n+                // attach real workflow\n+                workflow.addWorkflowVersion(version);\n+\n                 final long workflowVersionId = workflowVersionDAO.create(version);\n                 releaseCreated = true;\n                 workflowVersionFromDB = workflowVersionDAO.findById(workflowVersionId);\n                 workflow.getWorkflowVersions().add(workflowVersionFromDB);\n+                // create a new one and replace the old one if it exists\n+                if (existingVersionMap.containsKey(workflowVersionFromDB.getName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b03a7143725f56c9611541026529976ee8bd694"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNzc3NTQy", "url": "https://github.com/dockstore/dockstore/pull/3257#pullrequestreview-363777542", "createdAt": "2020-02-24T23:35:50Z", "commit": {"oid": "8b03a7143725f56c9611541026529976ee8bd694"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMzozNTo1MFrOFtzvVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMzozNTo1MFrOFtzvVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU3Nzk0MQ==", "bodyText": "constraint names", "url": "https://github.com/dockstore/dockstore/pull/3257#discussion_r383577941", "createdAt": "2020-02-24T23:35:50Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/resources/migrations.1.8.0.xml", "diffHunk": "@@ -181,4 +181,85 @@\n         <addNotNullConstraint tableName=\"tag\" columnName=\"dbcreatedate\"/>\n         <addNotNullConstraint tableName=\"tag\" columnName=\"dbupdatedate\"/>\n     </changeSet>\n+\n+    <changeSet author=\"dyuen\" id=\"restructure_workflowversions\">\n+        <addColumn tableName=\"tag\">\n+            <column name=\"parentid\" type=\"int8\">\n+            </column>\n+        </addColumn>\n+        <addColumn tableName=\"workflowversion\">\n+            <column name=\"parentid\" type=\"int8\">\n+            </column>\n+        </addColumn>\n+        <!-- migrate data -->\n+        <sql dbms=\"postgresql\">\n+            update workflowversion set parentid = wwv.workflowid from workflowversion as wv join workflow_workflowversion as wwv on wv.id = wwv.workflowversionid where workflowversion.id = wv.id;\n+            update tag set parentid = tt.toolid from tag as t join tool_tag as tt on t.id = tt.tagid where tag.id = t.id;\n+        </sql>\n+\n+        <!-- clean-up -->\n+        <dropForeignKeyConstraint baseTableName=\"tool_tag\" constraintName=\"fkjkn6qubuvn25bun52eqjleyl6\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b03a7143725f56c9611541026529976ee8bd694"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d73182c9884431e7ee3ac2527db2d93211a0a29", "author": {"user": {"login": "denis-yuen", "name": "Denis Yuen"}}, "url": "https://github.com/dockstore/dockstore/commit/7d73182c9884431e7ee3ac2527db2d93211a0a29", "committedDate": "2020-02-25T16:12:00Z", "message": "PR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bc0d2dc45e5300c996f6fd7f4f5388e55546fd1", "author": {"user": {"login": "denis-yuen", "name": "Denis Yuen"}}, "url": "https://github.com/dockstore/dockstore/commit/6bc0d2dc45e5300c996f6fd7f4f5388e55546fd1", "committedDate": "2020-02-25T16:22:46Z", "message": "Travis-CI update?\n\nhttps://changelog.travis-ci.com/"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MzEwODEw", "url": "https://github.com/dockstore/dockstore/pull/3257#pullrequestreview-364310810", "createdAt": "2020-02-25T17:19:18Z", "commit": {"oid": "6bc0d2dc45e5300c996f6fd7f4f5388e55546fd1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MzM4Nzc1", "url": "https://github.com/dockstore/dockstore/pull/3257#pullrequestreview-364338775", "createdAt": "2020-02-25T18:17:09Z", "commit": {"oid": "6bc0d2dc45e5300c996f6fd7f4f5388e55546fd1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1773, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}