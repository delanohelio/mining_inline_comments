{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NDk1MDQ3", "number": 3693, "reviewThreads": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMToyNDoyMFrOER-FMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwNDo1NDoyNVrOEThRYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3Mjc4Mzg3OnYy", "diffSide": "RIGHT", "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMToyNDoyMVrOG2-JvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMjowNDo1MFrOG2-8dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI5NDU4OA==", "bodyText": "Think this will pass if no exception is thrown", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r460294588", "createdAt": "2020-07-24T21:24:21Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -513,4 +513,41 @@ public void testUpdateUserMetadataFromGithub() {\n         assertEquals(\"DockstoreTestUser2\", userProfile.getUsername());\n     }\n \n+    @Test\n+    public void testSetUserPrivilege() {\n+        ApiClient adminWebClient = getWebClient(ADMIN_USERNAME, testingPostgres);\n+        ApiClient userWebClient = getWebClient(USER_2_USERNAME, testingPostgres);\n+\n+        PrivilegeRequest privilegeRequest = new PrivilegeRequest();\n+        UsersApi adminApi = new UsersApi(adminWebClient);\n+        UsersApi userApi = new UsersApi(userWebClient);\n+        User admin = adminApi.getUser();\n+        User user = userApi.getUser();\n+\n+        privilegeRequest.setAdmin(false);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+\n+        privilegeRequest.setCurator(true);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertTrue(userApi.getUser().isCurator());\n+\n+        try {\n+            userApi.setUserPrivilege(admin.getId(), privilegeRequest);\n+        } catch (ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06100d7decc5bba2dd8fe74bf7923e6cb3c064ae"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwMzU5NA==", "bodyText": "Not sure what you mean exactly. Im testing if the exception is thrown correctly if a curator tries to add admin privileges, since a curator should not be able to add/remove admin privileges.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r460303594", "createdAt": "2020-07-24T21:51:33Z", "author": {"login": "ByteMap"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -513,4 +513,41 @@ public void testUpdateUserMetadataFromGithub() {\n         assertEquals(\"DockstoreTestUser2\", userProfile.getUsername());\n     }\n \n+    @Test\n+    public void testSetUserPrivilege() {\n+        ApiClient adminWebClient = getWebClient(ADMIN_USERNAME, testingPostgres);\n+        ApiClient userWebClient = getWebClient(USER_2_USERNAME, testingPostgres);\n+\n+        PrivilegeRequest privilegeRequest = new PrivilegeRequest();\n+        UsersApi adminApi = new UsersApi(adminWebClient);\n+        UsersApi userApi = new UsersApi(userWebClient);\n+        User admin = adminApi.getUser();\n+        User user = userApi.getUser();\n+\n+        privilegeRequest.setAdmin(false);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+\n+        privilegeRequest.setCurator(true);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertTrue(userApi.getUser().isCurator());\n+\n+        try {\n+            userApi.setUserPrivilege(admin.getId(), privilegeRequest);\n+        } catch (ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI5NDU4OA=="}, "originalCommit": {"oid": "06100d7decc5bba2dd8fe74bf7923e6cb3c064ae"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwNTc5Nw==", "bodyText": "If your\ntry {\n  userApi.setUserPrivilege(admin.getId(), privilegeRequest);\n}\n\nwas instead\ntry {\n  // Do absolutely nothing\n}\n\nyour test still passes.\nSo you need to:\ntry {\n  userApi.setUserPrivilege(admin.getId(), privilegeRequest);\n  assertFail(\"Should have triggered an exception\");\n}", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r460305797", "createdAt": "2020-07-24T21:58:43Z", "author": {"login": "garyluu"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -513,4 +513,41 @@ public void testUpdateUserMetadataFromGithub() {\n         assertEquals(\"DockstoreTestUser2\", userProfile.getUsername());\n     }\n \n+    @Test\n+    public void testSetUserPrivilege() {\n+        ApiClient adminWebClient = getWebClient(ADMIN_USERNAME, testingPostgres);\n+        ApiClient userWebClient = getWebClient(USER_2_USERNAME, testingPostgres);\n+\n+        PrivilegeRequest privilegeRequest = new PrivilegeRequest();\n+        UsersApi adminApi = new UsersApi(adminWebClient);\n+        UsersApi userApi = new UsersApi(userWebClient);\n+        User admin = adminApi.getUser();\n+        User user = userApi.getUser();\n+\n+        privilegeRequest.setAdmin(false);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+\n+        privilegeRequest.setCurator(true);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertTrue(userApi.getUser().isCurator());\n+\n+        try {\n+            userApi.setUserPrivilege(admin.getId(), privilegeRequest);\n+        } catch (ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI5NDU4OA=="}, "originalCommit": {"oid": "06100d7decc5bba2dd8fe74bf7923e6cb3c064ae"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwNzU3Mw==", "bodyText": "Ah gotcha, thanks for the clarification!", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r460307573", "createdAt": "2020-07-24T22:04:50Z", "author": {"login": "ByteMap"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -513,4 +513,41 @@ public void testUpdateUserMetadataFromGithub() {\n         assertEquals(\"DockstoreTestUser2\", userProfile.getUsername());\n     }\n \n+    @Test\n+    public void testSetUserPrivilege() {\n+        ApiClient adminWebClient = getWebClient(ADMIN_USERNAME, testingPostgres);\n+        ApiClient userWebClient = getWebClient(USER_2_USERNAME, testingPostgres);\n+\n+        PrivilegeRequest privilegeRequest = new PrivilegeRequest();\n+        UsersApi adminApi = new UsersApi(adminWebClient);\n+        UsersApi userApi = new UsersApi(userWebClient);\n+        User admin = adminApi.getUser();\n+        User user = userApi.getUser();\n+\n+        privilegeRequest.setAdmin(false);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+\n+        privilegeRequest.setCurator(true);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertTrue(userApi.getUser().isCurator());\n+\n+        try {\n+            userApi.setUserPrivilege(admin.getId(), privilegeRequest);\n+        } catch (ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI5NDU4OA=="}, "originalCommit": {"oid": "06100d7decc5bba2dd8fe74bf7923e6cb3c064ae"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3Mjc4NDI0OnYy", "diffSide": "RIGHT", "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMToyNDozMFrOG2-J7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMTo1MzoxOFrOG2-u_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI5NDYzNw==", "bodyText": "Ditto", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r460294637", "createdAt": "2020-07-24T21:24:30Z", "author": {"login": "denis-yuen"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -513,4 +513,41 @@ public void testUpdateUserMetadataFromGithub() {\n         assertEquals(\"DockstoreTestUser2\", userProfile.getUsername());\n     }\n \n+    @Test\n+    public void testSetUserPrivilege() {\n+        ApiClient adminWebClient = getWebClient(ADMIN_USERNAME, testingPostgres);\n+        ApiClient userWebClient = getWebClient(USER_2_USERNAME, testingPostgres);\n+\n+        PrivilegeRequest privilegeRequest = new PrivilegeRequest();\n+        UsersApi adminApi = new UsersApi(adminWebClient);\n+        UsersApi userApi = new UsersApi(userWebClient);\n+        User admin = adminApi.getUser();\n+        User user = userApi.getUser();\n+\n+        privilegeRequest.setAdmin(false);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+\n+        privilegeRequest.setCurator(true);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertTrue(userApi.getUser().isCurator());\n+\n+        try {\n+            userApi.setUserPrivilege(admin.getId(), privilegeRequest);\n+        } catch (ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        privilegeRequest.setAdmin(true);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertTrue(userApi.getUser().isIsAdmin());\n+\n+        privilegeRequest.setAdmin(false);\n+        try {\n+            adminApi.setUserPrivilege(admin.getId(), privilegeRequest);\n+        } catch (ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06100d7decc5bba2dd8fe74bf7923e6cb3c064ae"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwNDEyNg==", "bodyText": "Same for above, but in the case where the admin tries to remove themselves. Talked to Charles about it and it may be an issue if an admin were to accidentally remove admin privileges for themselves, which is why an error is thrown if an admin were to try and remove themselves.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r460304126", "createdAt": "2020-07-24T21:53:18Z", "author": {"login": "ByteMap"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -513,4 +513,41 @@ public void testUpdateUserMetadataFromGithub() {\n         assertEquals(\"DockstoreTestUser2\", userProfile.getUsername());\n     }\n \n+    @Test\n+    public void testSetUserPrivilege() {\n+        ApiClient adminWebClient = getWebClient(ADMIN_USERNAME, testingPostgres);\n+        ApiClient userWebClient = getWebClient(USER_2_USERNAME, testingPostgres);\n+\n+        PrivilegeRequest privilegeRequest = new PrivilegeRequest();\n+        UsersApi adminApi = new UsersApi(adminWebClient);\n+        UsersApi userApi = new UsersApi(userWebClient);\n+        User admin = adminApi.getUser();\n+        User user = userApi.getUser();\n+\n+        privilegeRequest.setAdmin(false);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+\n+        privilegeRequest.setCurator(true);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertTrue(userApi.getUser().isCurator());\n+\n+        try {\n+            userApi.setUserPrivilege(admin.getId(), privilegeRequest);\n+        } catch (ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        privilegeRequest.setAdmin(true);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertTrue(userApi.getUser().isIsAdmin());\n+\n+        privilegeRequest.setAdmin(false);\n+        try {\n+            adminApi.setUserPrivilege(admin.getId(), privilegeRequest);\n+        } catch (ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI5NDYzNw=="}, "originalCommit": {"oid": "06100d7decc5bba2dd8fe74bf7923e6cb3c064ae"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3Mjc5ODg1OnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMTozMDo1N1rOG2-SmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxOTo1MDowM1rOG3xIHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI5Njg1Nw==", "bodyText": "Not sure I'm reading correctly\nIt seems possible to simplify, is this something akin to :\nonly admins can create admins, curators and admins can create curators?", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r460296857", "createdAt": "2020-07-24T21:30:57Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +748,33 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Operation(operationId = \"addUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class)\n+    public User setUserPrivilege(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\")@Auth User authUser,\n+                                 @ApiParam(value = \"User ID\", required = true) @PathParam(\"userId\") Long userID,\n+                                 @ApiParam(value = \"Set privilege for a user\", required = true) PrivilegeRequest privilegeRequest) {\n+        User user = userDAO.findById(userID);\n+        if (user == null) {\n+            throw new CustomWebApplicationException(\"User not found\", HttpStatus.SC_NOT_FOUND);\n+        }\n+\n+        if (privilegeRequest.isAdmin() != user.getIsAdmin() && !authUser.getIsAdmin()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06100d7decc5bba2dd8fe74bf7923e6cb3c064ae"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwMjU5Ng==", "bodyText": "Right, only admins can create/remove admins with the exception of the admin removing admin privileges for themselves, but both admins and curators can create/remove curators.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r460302596", "createdAt": "2020-07-24T21:48:22Z", "author": {"login": "ByteMap"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +748,33 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Operation(operationId = \"addUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class)\n+    public User setUserPrivilege(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\")@Auth User authUser,\n+                                 @ApiParam(value = \"User ID\", required = true) @PathParam(\"userId\") Long userID,\n+                                 @ApiParam(value = \"Set privilege for a user\", required = true) PrivilegeRequest privilegeRequest) {\n+        User user = userDAO.findById(userID);\n+        if (user == null) {\n+            throw new CustomWebApplicationException(\"User not found\", HttpStatus.SC_NOT_FOUND);\n+        }\n+\n+        if (privilegeRequest.isAdmin() != user.getIsAdmin() && !authUser.getIsAdmin()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI5Njg1Nw=="}, "originalCommit": {"oid": "06100d7decc5bba2dd8fe74bf7923e6cb3c064ae"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwOTk3Ng==", "bodyText": "Agreed, it is a little complex and a little hard to read.\nI suggest just not allowing a user to modify their own privileges, period. Add that as a test after line 764. Then  the logic is not buried in another else if.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r460309976", "createdAt": "2020-07-24T22:13:15Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +748,33 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Operation(operationId = \"addUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class)\n+    public User setUserPrivilege(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\")@Auth User authUser,\n+                                 @ApiParam(value = \"User ID\", required = true) @PathParam(\"userId\") Long userID,\n+                                 @ApiParam(value = \"Set privilege for a user\", required = true) PrivilegeRequest privilegeRequest) {\n+        User user = userDAO.findById(userID);\n+        if (user == null) {\n+            throw new CustomWebApplicationException(\"User not found\", HttpStatus.SC_NOT_FOUND);\n+        }\n+\n+        if (privilegeRequest.isAdmin() != user.getIsAdmin() && !authUser.getIsAdmin()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI5Njg1Nw=="}, "originalCommit": {"oid": "06100d7decc5bba2dd8fe74bf7923e6cb3c064ae"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyOTc1Ng==", "bodyText": "Added the logic to prevent a user to modify their own privileges after line 764.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461129756", "createdAt": "2020-07-27T19:50:03Z", "author": {"login": "ByteMap"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +748,33 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Operation(operationId = \"addUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class)\n+    public User setUserPrivilege(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\")@Auth User authUser,\n+                                 @ApiParam(value = \"User ID\", required = true) @PathParam(\"userId\") Long userID,\n+                                 @ApiParam(value = \"Set privilege for a user\", required = true) PrivilegeRequest privilegeRequest) {\n+        User user = userDAO.findById(userID);\n+        if (user == null) {\n+            throw new CustomWebApplicationException(\"User not found\", HttpStatus.SC_NOT_FOUND);\n+        }\n+\n+        if (privilegeRequest.isAdmin() != user.getIsAdmin() && !authUser.getIsAdmin()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI5Njg1Nw=="}, "originalCommit": {"oid": "06100d7decc5bba2dd8fe74bf7923e6cb3c064ae"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3Mjg4MDI1OnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMjoxMDo1N1rOG2_DKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxOTo0ODoyOFrOG3xEvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwOTI5MA==", "bodyText": "authUser == user is not correct; that verifies if they are the same objects, not if they are equal. You need to compare ids.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r460309290", "createdAt": "2020-07-24T22:10:57Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +748,33 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Operation(operationId = \"addUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class)\n+    public User setUserPrivilege(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\")@Auth User authUser,\n+                                 @ApiParam(value = \"User ID\", required = true) @PathParam(\"userId\") Long userID,\n+                                 @ApiParam(value = \"Set privilege for a user\", required = true) PrivilegeRequest privilegeRequest) {\n+        User user = userDAO.findById(userID);\n+        if (user == null) {\n+            throw new CustomWebApplicationException(\"User not found\", HttpStatus.SC_NOT_FOUND);\n+        }\n+\n+        if (privilegeRequest.isAdmin() != user.getIsAdmin() && !authUser.getIsAdmin()) {\n+            throw new CustomWebApplicationException(\"You do not have privileges to set/remove administrative rights\", HttpStatus.SC_FORBIDDEN);\n+        } else if (privilegeRequest.isAdmin() != user.getIsAdmin() && authUser == user) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06100d7decc5bba2dd8fe74bf7923e6cb3c064ae"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyODg5NQ==", "bodyText": "Done.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461128895", "createdAt": "2020-07-27T19:48:28Z", "author": {"login": "ByteMap"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +748,33 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Operation(operationId = \"addUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class)\n+    public User setUserPrivilege(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\")@Auth User authUser,\n+                                 @ApiParam(value = \"User ID\", required = true) @PathParam(\"userId\") Long userID,\n+                                 @ApiParam(value = \"Set privilege for a user\", required = true) PrivilegeRequest privilegeRequest) {\n+        User user = userDAO.findById(userID);\n+        if (user == null) {\n+            throw new CustomWebApplicationException(\"User not found\", HttpStatus.SC_NOT_FOUND);\n+        }\n+\n+        if (privilegeRequest.isAdmin() != user.getIsAdmin() && !authUser.getIsAdmin()) {\n+            throw new CustomWebApplicationException(\"You do not have privileges to set/remove administrative rights\", HttpStatus.SC_FORBIDDEN);\n+        } else if (privilegeRequest.isAdmin() != user.getIsAdmin() && authUser == user) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwOTI5MA=="}, "originalCommit": {"oid": "06100d7decc5bba2dd8fe74bf7923e6cb3c064ae"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3Mjg5MDkwOnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMjoxNTo0NFrOG2_I-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxOTo0ODo1MVrOG3xFcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMxMDc3OA==", "bodyText": "Instead of set/remove, I suggest modify", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r460310778", "createdAt": "2020-07-24T22:15:44Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +748,33 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Operation(operationId = \"addUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class)\n+    public User setUserPrivilege(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\")@Auth User authUser,\n+                                 @ApiParam(value = \"User ID\", required = true) @PathParam(\"userId\") Long userID,\n+                                 @ApiParam(value = \"Set privilege for a user\", required = true) PrivilegeRequest privilegeRequest) {\n+        User user = userDAO.findById(userID);\n+        if (user == null) {\n+            throw new CustomWebApplicationException(\"User not found\", HttpStatus.SC_NOT_FOUND);\n+        }\n+\n+        if (privilegeRequest.isAdmin() != user.getIsAdmin() && !authUser.getIsAdmin()) {\n+            throw new CustomWebApplicationException(\"You do not have privileges to set/remove administrative rights\", HttpStatus.SC_FORBIDDEN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06100d7decc5bba2dd8fe74bf7923e6cb3c064ae"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyOTA3NQ==", "bodyText": "Done.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461129075", "createdAt": "2020-07-27T19:48:51Z", "author": {"login": "ByteMap"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +748,33 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Operation(operationId = \"addUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class)\n+    public User setUserPrivilege(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\")@Auth User authUser,\n+                                 @ApiParam(value = \"User ID\", required = true) @PathParam(\"userId\") Long userID,\n+                                 @ApiParam(value = \"Set privilege for a user\", required = true) PrivilegeRequest privilegeRequest) {\n+        User user = userDAO.findById(userID);\n+        if (user == null) {\n+            throw new CustomWebApplicationException(\"User not found\", HttpStatus.SC_NOT_FOUND);\n+        }\n+\n+        if (privilegeRequest.isAdmin() != user.getIsAdmin() && !authUser.getIsAdmin()) {\n+            throw new CustomWebApplicationException(\"You do not have privileges to set/remove administrative rights\", HttpStatus.SC_FORBIDDEN);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMxMDc3OA=="}, "originalCommit": {"oid": "06100d7decc5bba2dd8fe74bf7923e6cb3c064ae"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3MjkwMDE1OnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/User.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMjoyMDo1OFrOG2_OfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxOTo0OToyOFrOG3xGxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMxMjE4OQ==", "bodyText": "There already is a setCurator; you shouldn't add another setter.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r460312189", "createdAt": "2020-07-24T22:20:58Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/User.java", "diffHunk": "@@ -327,6 +327,10 @@ public void setIsAdmin(boolean isAdmin) {\n         this.isAdmin = isAdmin;\n     }\n \n+    public void setIsCurator(boolean isCurator) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06100d7decc5bba2dd8fe74bf7923e6cb3c064ae"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyOTQxNQ==", "bodyText": "Removed setIsCurator() and refactored to using setCurator()", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461129415", "createdAt": "2020-07-27T19:49:28Z", "author": {"login": "ByteMap"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/User.java", "diffHunk": "@@ -327,6 +327,10 @@ public void setIsAdmin(boolean isAdmin) {\n         this.isAdmin = isAdmin;\n     }\n \n+    public void setIsCurator(boolean isCurator) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMxMjE4OQ=="}, "originalCommit": {"oid": "06100d7decc5bba2dd8fe74bf7923e6cb3c064ae"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3ODczNDE0OnYy", "diffSide": "RIGHT", "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMDowMjo0OFrOG3xjHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMDowMjo0OFrOG3xjHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEzNjY2OA==", "bodyText": "FYI, you could just save the result instead of making 2 api calls, but this is fine.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461136668", "createdAt": "2020-07-27T20:02:48Z", "author": {"login": "coverbeck"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -513,4 +513,43 @@ public void testUpdateUserMetadataFromGithub() {\n         assertEquals(\"DockstoreTestUser2\", userProfile.getUsername());\n     }\n \n+    @Test\n+    public void testSetUserPrivilege() {\n+        ApiClient adminWebClient = getWebClient(ADMIN_USERNAME, testingPostgres);\n+        ApiClient userWebClient = getWebClient(USER_2_USERNAME, testingPostgres);\n+\n+        PrivilegeRequest privilegeRequest = new PrivilegeRequest();\n+        UsersApi adminApi = new UsersApi(adminWebClient);\n+        UsersApi userApi = new UsersApi(userWebClient);\n+        User admin = adminApi.getUser();\n+        User user = userApi.getUser();\n+\n+        privilegeRequest.setAdmin(false);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertFalse(userApi.getUser().isIsAdmin());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37ea2eaa68c21a5c0a513fb28a708b7428af29ca"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3ODk1NzM5OnYy", "diffSide": "RIGHT", "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMTowOTowN1rOG3zqsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMjowNDo1MVrOG31Pyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3MTM3Ng==", "bodyText": "Use fail instead of assertFalse.\nYour error message should better indicate the problem to somebody looking at the code for the first time, e.g, fail(\"Curator should not be able to create an admin\")", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461171376", "createdAt": "2020-07-27T21:09:07Z", "author": {"login": "coverbeck"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -513,4 +513,43 @@ public void testUpdateUserMetadataFromGithub() {\n         assertEquals(\"DockstoreTestUser2\", userProfile.getUsername());\n     }\n \n+    @Test\n+    public void testSetUserPrivilege() {\n+        ApiClient adminWebClient = getWebClient(ADMIN_USERNAME, testingPostgres);\n+        ApiClient userWebClient = getWebClient(USER_2_USERNAME, testingPostgres);\n+\n+        PrivilegeRequest privilegeRequest = new PrivilegeRequest();\n+        UsersApi adminApi = new UsersApi(adminWebClient);\n+        UsersApi userApi = new UsersApi(userWebClient);\n+        User admin = adminApi.getUser();\n+        User user = userApi.getUser();\n+\n+        privilegeRequest.setAdmin(false);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+\n+        privilegeRequest.setCurator(true);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertTrue(userApi.getUser().isCurator());\n+\n+        try {\n+            userApi.setUserPrivilege(admin.getId(), privilegeRequest);\n+            assertFalse(\"Should have triggered an exception\", false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37ea2eaa68c21a5c0a513fb28a708b7428af29ca"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5NzI1OA==", "bodyText": "Used fail() instead of assertFalse() and specified error message.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461197258", "createdAt": "2020-07-27T22:04:51Z", "author": {"login": "ByteMap"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -513,4 +513,43 @@ public void testUpdateUserMetadataFromGithub() {\n         assertEquals(\"DockstoreTestUser2\", userProfile.getUsername());\n     }\n \n+    @Test\n+    public void testSetUserPrivilege() {\n+        ApiClient adminWebClient = getWebClient(ADMIN_USERNAME, testingPostgres);\n+        ApiClient userWebClient = getWebClient(USER_2_USERNAME, testingPostgres);\n+\n+        PrivilegeRequest privilegeRequest = new PrivilegeRequest();\n+        UsersApi adminApi = new UsersApi(adminWebClient);\n+        UsersApi userApi = new UsersApi(userWebClient);\n+        User admin = adminApi.getUser();\n+        User user = userApi.getUser();\n+\n+        privilegeRequest.setAdmin(false);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+\n+        privilegeRequest.setCurator(true);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertTrue(userApi.getUser().isCurator());\n+\n+        try {\n+            userApi.setUserPrivilege(admin.getId(), privilegeRequest);\n+            assertFalse(\"Should have triggered an exception\", false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3MTM3Ng=="}, "originalCommit": {"oid": "37ea2eaa68c21a5c0a513fb28a708b7428af29ca"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3ODk1ODk0OnYy", "diffSide": "RIGHT", "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMTowOTozMVrOG3zriA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMjowNDo1OFrOG31QCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3MTU5Mg==", "bodyText": "Same as other comment", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461171592", "createdAt": "2020-07-27T21:09:31Z", "author": {"login": "coverbeck"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -513,4 +513,43 @@ public void testUpdateUserMetadataFromGithub() {\n         assertEquals(\"DockstoreTestUser2\", userProfile.getUsername());\n     }\n \n+    @Test\n+    public void testSetUserPrivilege() {\n+        ApiClient adminWebClient = getWebClient(ADMIN_USERNAME, testingPostgres);\n+        ApiClient userWebClient = getWebClient(USER_2_USERNAME, testingPostgres);\n+\n+        PrivilegeRequest privilegeRequest = new PrivilegeRequest();\n+        UsersApi adminApi = new UsersApi(adminWebClient);\n+        UsersApi userApi = new UsersApi(userWebClient);\n+        User admin = adminApi.getUser();\n+        User user = userApi.getUser();\n+\n+        privilegeRequest.setAdmin(false);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+\n+        privilegeRequest.setCurator(true);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertTrue(userApi.getUser().isCurator());\n+\n+        try {\n+            userApi.setUserPrivilege(admin.getId(), privilegeRequest);\n+            assertFalse(\"Should have triggered an exception\", false);\n+        } catch (ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        privilegeRequest.setAdmin(true);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertTrue(userApi.getUser().isIsAdmin());\n+\n+        privilegeRequest.setAdmin(false);\n+        try {\n+            adminApi.setUserPrivilege(admin.getId(), privilegeRequest);\n+            assertFalse(\"Should have triggered an exception\", false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37ea2eaa68c21a5c0a513fb28a708b7428af29ca"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5NzMyMA==", "bodyText": "Done.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461197320", "createdAt": "2020-07-27T22:04:58Z", "author": {"login": "ByteMap"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -513,4 +513,43 @@ public void testUpdateUserMetadataFromGithub() {\n         assertEquals(\"DockstoreTestUser2\", userProfile.getUsername());\n     }\n \n+    @Test\n+    public void testSetUserPrivilege() {\n+        ApiClient adminWebClient = getWebClient(ADMIN_USERNAME, testingPostgres);\n+        ApiClient userWebClient = getWebClient(USER_2_USERNAME, testingPostgres);\n+\n+        PrivilegeRequest privilegeRequest = new PrivilegeRequest();\n+        UsersApi adminApi = new UsersApi(adminWebClient);\n+        UsersApi userApi = new UsersApi(userWebClient);\n+        User admin = adminApi.getUser();\n+        User user = userApi.getUser();\n+\n+        privilegeRequest.setAdmin(false);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+\n+        privilegeRequest.setCurator(true);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertTrue(userApi.getUser().isCurator());\n+\n+        try {\n+            userApi.setUserPrivilege(admin.getId(), privilegeRequest);\n+            assertFalse(\"Should have triggered an exception\", false);\n+        } catch (ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        privilegeRequest.setAdmin(true);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertTrue(userApi.getUser().isIsAdmin());\n+\n+        privilegeRequest.setAdmin(false);\n+        try {\n+            adminApi.setUserPrivilege(admin.getId(), privilegeRequest);\n+            assertFalse(\"Should have triggered an exception\", false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3MTU5Mg=="}, "originalCommit": {"oid": "37ea2eaa68c21a5c0a513fb28a708b7428af29ca"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3ODk2NTkwOnYy", "diffSide": "RIGHT", "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMToxMTo0NVrOG3zvtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMjowMjowNFrOG31Lnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3MjY2Mg==", "bodyText": "You should also assert the user is not an admin.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461172662", "createdAt": "2020-07-27T21:11:45Z", "author": {"login": "coverbeck"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -513,4 +513,43 @@ public void testUpdateUserMetadataFromGithub() {\n         assertEquals(\"DockstoreTestUser2\", userProfile.getUsername());\n     }\n \n+    @Test\n+    public void testSetUserPrivilege() {\n+        ApiClient adminWebClient = getWebClient(ADMIN_USERNAME, testingPostgres);\n+        ApiClient userWebClient = getWebClient(USER_2_USERNAME, testingPostgres);\n+\n+        PrivilegeRequest privilegeRequest = new PrivilegeRequest();\n+        UsersApi adminApi = new UsersApi(adminWebClient);\n+        UsersApi userApi = new UsersApi(userWebClient);\n+        User admin = adminApi.getUser();\n+        User user = userApi.getUser();\n+\n+        privilegeRequest.setAdmin(false);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+\n+        privilegeRequest.setCurator(true);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertTrue(userApi.getUser().isCurator());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37ea2eaa68c21a5c0a513fb28a708b7428af29ca"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5NjE5MQ==", "bodyText": "Done.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461196191", "createdAt": "2020-07-27T22:02:04Z", "author": {"login": "ByteMap"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -513,4 +513,43 @@ public void testUpdateUserMetadataFromGithub() {\n         assertEquals(\"DockstoreTestUser2\", userProfile.getUsername());\n     }\n \n+    @Test\n+    public void testSetUserPrivilege() {\n+        ApiClient adminWebClient = getWebClient(ADMIN_USERNAME, testingPostgres);\n+        ApiClient userWebClient = getWebClient(USER_2_USERNAME, testingPostgres);\n+\n+        PrivilegeRequest privilegeRequest = new PrivilegeRequest();\n+        UsersApi adminApi = new UsersApi(adminWebClient);\n+        UsersApi userApi = new UsersApi(userWebClient);\n+        User admin = adminApi.getUser();\n+        User user = userApi.getUser();\n+\n+        privilegeRequest.setAdmin(false);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+\n+        privilegeRequest.setCurator(true);\n+        adminApi.setUserPrivilege(user.getId(), privilegeRequest);\n+        assertTrue(userApi.getUser().isCurator());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3MjY2Mg=="}, "originalCommit": {"oid": "37ea2eaa68c21a5c0a513fb28a708b7428af29ca"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3ODk2NTk0OnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMToxMTo0NlrOG3zvwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMzowODo0OFrOG32tVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3MjY3Mg==", "bodyText": "Should add a comment on both clauses, conditions are better but still not arguably simply readable", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461172672", "createdAt": "2020-07-27T21:11:46Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +748,35 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Operation(operationId = \"addUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class)\n+    public User setUserPrivilege(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\")@Auth User authUser,\n+                                 @ApiParam(value = \"User ID\", required = true) @PathParam(\"userId\") Long userID,\n+                                 @ApiParam(value = \"Set privilege for a user\", required = true) PrivilegeRequest privilegeRequest) {\n+        User user = userDAO.findById(userID);\n+        if (user == null) {\n+            throw new CustomWebApplicationException(\"User not found\", HttpStatus.SC_NOT_FOUND);\n+        }\n+\n+        if (authUser.getId() == user.getId()) {\n+            throw new CustomWebApplicationException(\"You cannot modify your own privileges\", HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        if (privilegeRequest.isAdmin() != user.getIsAdmin() && !authUser.getIsAdmin()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37ea2eaa68c21a5c0a513fb28a708b7428af29ca"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3NDQwNQ==", "bodyText": "I might be overlooking something, but is (privilegeRequest.isAdmin() != user.getIsAdmin() && !authUser.getIsAdmin())  simpler as (privilegeRequest.isAdmin()  && !authUser.getIsAdmin())", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461174405", "createdAt": "2020-07-27T21:15:12Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +748,35 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Operation(operationId = \"addUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class)\n+    public User setUserPrivilege(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\")@Auth User authUser,\n+                                 @ApiParam(value = \"User ID\", required = true) @PathParam(\"userId\") Long userID,\n+                                 @ApiParam(value = \"Set privilege for a user\", required = true) PrivilegeRequest privilegeRequest) {\n+        User user = userDAO.findById(userID);\n+        if (user == null) {\n+            throw new CustomWebApplicationException(\"User not found\", HttpStatus.SC_NOT_FOUND);\n+        }\n+\n+        if (authUser.getId() == user.getId()) {\n+            throw new CustomWebApplicationException(\"You cannot modify your own privileges\", HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        if (privilegeRequest.isAdmin() != user.getIsAdmin() && !authUser.getIsAdmin()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3MjY3Mg=="}, "originalCommit": {"oid": "37ea2eaa68c21a5c0a513fb28a708b7428af29ca"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwMDUwNg==", "bodyText": "I think the original logic is that an error should be thrown if the user admin status is different from the privilege request and that the authuser is not an admin. That way a curator can set the curator status only for an admin and not get blocked by it. Also, with (privilegeRequest.isAdmin() && !authUser.getIsAdmin()), the curator would be able to remove adminship since privilegeRequest.isAdmin() would be false and the error would not be thrown.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461200506", "createdAt": "2020-07-27T22:12:49Z", "author": {"login": "ByteMap"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +748,35 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Operation(operationId = \"addUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class)\n+    public User setUserPrivilege(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\")@Auth User authUser,\n+                                 @ApiParam(value = \"User ID\", required = true) @PathParam(\"userId\") Long userID,\n+                                 @ApiParam(value = \"Set privilege for a user\", required = true) PrivilegeRequest privilegeRequest) {\n+        User user = userDAO.findById(userID);\n+        if (user == null) {\n+            throw new CustomWebApplicationException(\"User not found\", HttpStatus.SC_NOT_FOUND);\n+        }\n+\n+        if (authUser.getId() == user.getId()) {\n+            throw new CustomWebApplicationException(\"You cannot modify your own privileges\", HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        if (privilegeRequest.isAdmin() != user.getIsAdmin() && !authUser.getIsAdmin()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3MjY3Mg=="}, "originalCommit": {"oid": "37ea2eaa68c21a5c0a513fb28a708b7428af29ca"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwMDYzMA==", "bodyText": "Added a comment on both clauses.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461200630", "createdAt": "2020-07-27T22:13:09Z", "author": {"login": "ByteMap"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +748,35 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Operation(operationId = \"addUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class)\n+    public User setUserPrivilege(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\")@Auth User authUser,\n+                                 @ApiParam(value = \"User ID\", required = true) @PathParam(\"userId\") Long userID,\n+                                 @ApiParam(value = \"Set privilege for a user\", required = true) PrivilegeRequest privilegeRequest) {\n+        User user = userDAO.findById(userID);\n+        if (user == null) {\n+            throw new CustomWebApplicationException(\"User not found\", HttpStatus.SC_NOT_FOUND);\n+        }\n+\n+        if (authUser.getId() == user.getId()) {\n+            throw new CustomWebApplicationException(\"You cannot modify your own privileges\", HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        if (privilegeRequest.isAdmin() != user.getIsAdmin() && !authUser.getIsAdmin()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3MjY3Mg=="}, "originalCommit": {"oid": "37ea2eaa68c21a5c0a513fb28a708b7428af29ca"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwODg4OQ==", "bodyText": "Ok, thanks for the explanation. I think I'm not reading the curator logic properly here.\nThis code might be more readable with one branch for curator logic and one branch for admin logic.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461208889", "createdAt": "2020-07-27T22:34:54Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +748,35 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Operation(operationId = \"addUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class)\n+    public User setUserPrivilege(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\")@Auth User authUser,\n+                                 @ApiParam(value = \"User ID\", required = true) @PathParam(\"userId\") Long userID,\n+                                 @ApiParam(value = \"Set privilege for a user\", required = true) PrivilegeRequest privilegeRequest) {\n+        User user = userDAO.findById(userID);\n+        if (user == null) {\n+            throw new CustomWebApplicationException(\"User not found\", HttpStatus.SC_NOT_FOUND);\n+        }\n+\n+        if (authUser.getId() == user.getId()) {\n+            throw new CustomWebApplicationException(\"You cannot modify your own privileges\", HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        if (privilegeRequest.isAdmin() != user.getIsAdmin() && !authUser.getIsAdmin()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3MjY3Mg=="}, "originalCommit": {"oid": "37ea2eaa68c21a5c0a513fb28a708b7428af29ca"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyMTIwNw==", "bodyText": "There isn't really an admin logic branch. It's more of the first branch checking for curator status and creating restrictions and the second branch setting the privileges since no errors were thrown. I have created two if statements instead of doing an if - else if and added additional comments. Hopefully that will make the logic more clear to read.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461221207", "createdAt": "2020-07-27T23:08:48Z", "author": {"login": "ByteMap"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +748,35 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Operation(operationId = \"addUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class)\n+    public User setUserPrivilege(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\")@Auth User authUser,\n+                                 @ApiParam(value = \"User ID\", required = true) @PathParam(\"userId\") Long userID,\n+                                 @ApiParam(value = \"Set privilege for a user\", required = true) PrivilegeRequest privilegeRequest) {\n+        User user = userDAO.findById(userID);\n+        if (user == null) {\n+            throw new CustomWebApplicationException(\"User not found\", HttpStatus.SC_NOT_FOUND);\n+        }\n+\n+        if (authUser.getId() == user.getId()) {\n+            throw new CustomWebApplicationException(\"You cannot modify your own privileges\", HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        if (privilegeRequest.isAdmin() != user.getIsAdmin() && !authUser.getIsAdmin()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3MjY3Mg=="}, "originalCommit": {"oid": "37ea2eaa68c21a5c0a513fb28a708b7428af29ca"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3ODk3MjY2OnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMToxNDowMlrOG3z0Iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMjowMjoyOFrOG31MOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3Mzc5NQ==", "bodyText": "The API also supports removing user privileges. I would call this setUserPrivileges", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461173795", "createdAt": "2020-07-27T21:14:02Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +748,35 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Operation(operationId = \"addUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37ea2eaa68c21a5c0a513fb28a708b7428af29ca"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5NjM0Nw==", "bodyText": "Done.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461196347", "createdAt": "2020-07-27T22:02:28Z", "author": {"login": "ByteMap"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +748,35 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Operation(operationId = \"addUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3Mzc5NQ=="}, "originalCommit": {"oid": "37ea2eaa68c21a5c0a513fb28a708b7428af29ca"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MzkxNTQwOnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMzowMTozMFrOG4irWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDoxODo1NVrOG5IoKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk0MTU5Mw==", "bodyText": "You should remove this; see Gary's comment about both adding OpenAPI and removing Swagger", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461941593", "createdAt": "2020-07-28T23:01:30Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +749,42 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Consumes(\"application/json\")\n+    @Operation(operationId = \"setUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class, hidden = true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a344f9baa26762f3574fc165db8206a54690e52d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1MzI1Mg==", "bodyText": "Removing @ApiOperation would enable the method to be written into the swagger.yaml file since the hidden field in the annotation is preventing that from happening.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r462553252", "createdAt": "2020-07-29T20:01:02Z", "author": {"login": "ByteMap"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +749,42 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Consumes(\"application/json\")\n+    @Operation(operationId = \"setUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class, hidden = true)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk0MTU5Mw=="}, "originalCommit": {"oid": "a344f9baa26762f3574fc165db8206a54690e52d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2MzM3MA==", "bodyText": "You can remove the bulk of the annotation (@Authorization, response) to avoid confusion. Example: @ApiOperation(value = \"hidden\", hidden = true)", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r462563370", "createdAt": "2020-07-29T20:18:55Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +749,42 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Consumes(\"application/json\")\n+    @Operation(operationId = \"setUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class, hidden = true)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk0MTU5Mw=="}, "originalCommit": {"oid": "a344f9baa26762f3574fc165db8206a54690e52d"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MzkxOTAwOnYy", "diffSide": "RIGHT", "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMzowMzoxMVrOG4itdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMDowOTo0MVrOG4kA-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk0MjEzNQ==", "bodyText": "Can you assert that the user is both not an admin nor a curator? I have to follow your code from above to figure that out; and what if that code changes? -- it could have a side effect on this test. Just to make sure you are testing with the right thing.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461942135", "createdAt": "2020-07-28T23:03:11Z", "author": {"login": "coverbeck"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -513,4 +513,54 @@ public void testUpdateUserMetadataFromGithub() {\n         assertEquals(\"DockstoreTestUser2\", userProfile.getUsername());\n     }\n \n+    @Test\n+    public void testSetUserPrivilege() {\n+        io.dockstore.openapi.client.ApiClient adminWebClient = getOpenAPIWebClient(ADMIN_USERNAME, testingPostgres);\n+        io.dockstore.openapi.client.ApiClient userWebClient = getOpenAPIWebClient(USER_2_USERNAME, testingPostgres);\n+\n+        io.dockstore.openapi.client.model.PrivilegeRequest privilegeRequest = new PrivilegeRequest();\n+        io.dockstore.openapi.client.api.UsersApi adminApi = new io.dockstore.openapi.client.api.UsersApi(adminWebClient);\n+        io.dockstore.openapi.client.api.UsersApi userApi = new io.dockstore.openapi.client.api.UsersApi(userWebClient);\n+        io.dockstore.openapi.client.model.User admin = adminApi.getUser();\n+        io.dockstore.openapi.client.model.User user = userApi.getUser();\n+\n+        privilegeRequest.setAdmin(false);\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+\n+        privilegeRequest.setCurator(true);\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertTrue(userApi.getUser().isCurator());\n+\n+        try {\n+            userApi.setUserPrivileges(privilegeRequest, admin.getId());\n+            fail(\"Curator should not be able to set admin permissions\");\n+        } catch (ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        privilegeRequest.setAdmin(true);\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        assertTrue(userApi.getUser().isIsAdmin());\n+\n+        privilegeRequest.setAdmin(false);\n+        try {\n+            adminApi.setUserPrivileges(privilegeRequest, admin.getId());\n+            fail(\"User should not be able to set their own permissions\");\n+        } catch (ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        privilegeRequest.setCurator(false);\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a344f9baa26762f3574fc165db8206a54690e52d"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk2MzUxNA==", "bodyText": "Done.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461963514", "createdAt": "2020-07-29T00:09:41Z", "author": {"login": "ByteMap"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -513,4 +513,54 @@ public void testUpdateUserMetadataFromGithub() {\n         assertEquals(\"DockstoreTestUser2\", userProfile.getUsername());\n     }\n \n+    @Test\n+    public void testSetUserPrivilege() {\n+        io.dockstore.openapi.client.ApiClient adminWebClient = getOpenAPIWebClient(ADMIN_USERNAME, testingPostgres);\n+        io.dockstore.openapi.client.ApiClient userWebClient = getOpenAPIWebClient(USER_2_USERNAME, testingPostgres);\n+\n+        io.dockstore.openapi.client.model.PrivilegeRequest privilegeRequest = new PrivilegeRequest();\n+        io.dockstore.openapi.client.api.UsersApi adminApi = new io.dockstore.openapi.client.api.UsersApi(adminWebClient);\n+        io.dockstore.openapi.client.api.UsersApi userApi = new io.dockstore.openapi.client.api.UsersApi(userWebClient);\n+        io.dockstore.openapi.client.model.User admin = adminApi.getUser();\n+        io.dockstore.openapi.client.model.User user = userApi.getUser();\n+\n+        privilegeRequest.setAdmin(false);\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+\n+        privilegeRequest.setCurator(true);\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertTrue(userApi.getUser().isCurator());\n+\n+        try {\n+            userApi.setUserPrivileges(privilegeRequest, admin.getId());\n+            fail(\"Curator should not be able to set admin permissions\");\n+        } catch (ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        privilegeRequest.setAdmin(true);\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        assertTrue(userApi.getUser().isIsAdmin());\n+\n+        privilegeRequest.setAdmin(false);\n+        try {\n+            adminApi.setUserPrivileges(privilegeRequest, admin.getId());\n+            fail(\"User should not be able to set their own permissions\");\n+        } catch (ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        privilegeRequest.setCurator(false);\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk0MjEzNQ=="}, "originalCommit": {"oid": "a344f9baa26762f3574fc165db8206a54690e52d"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MzkyNDc2OnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMzowNTo1M1rOG4iw7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMDowOTo1MFrOG4kBJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk0MzAyMA==", "bodyText": "This real nit-picky, and I'm surprised the checkstyle isn't flagging it already (maybe it only catches it in TypeScript, because I'm pretty sure I've seen it in my code), but you can put a space before \"Else\" --> // Else...", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461943020", "createdAt": "2020-07-28T23:05:53Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +749,42 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Consumes(\"application/json\")\n+    @Operation(operationId = \"setUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class, hidden = true)\n+    public User setUserPrivilege(@Parameter(hidden = true, name = \"user\")@Auth User authUser,\n+                                 @Parameter(name = \"User ID\", required = true) @PathParam(\"userId\") Long userID,\n+                                 @Parameter(name = \"Set privilege for a user\", required = true) PrivilegeRequest privilegeRequest) {\n+        User user = userDAO.findById(userID);\n+        if (user == null) {\n+            throw new CustomWebApplicationException(\"User not found\", HttpStatus.SC_NOT_FOUND);\n+        }\n+\n+        //This ensures that the user cannot modify their own privileges.\n+        if (authUser.getId() == user.getId()) {\n+            throw new CustomWebApplicationException(\"You cannot modify your own privileges\", HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        //If the request's admin setting is different than the admin status of the user that is being modified, and the auth user is not an admin: Throw an error.\n+        //This ensures that a curator cannot modify the admin status of any user.\n+        if (privilegeRequest.isAdmin() != user.getIsAdmin() && !authUser.getIsAdmin()) {\n+            throw new CustomWebApplicationException(\"You do not have privileges to modify administrative rights\", HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        //Else if the request's settings is different from the privileges of the user that is being modified: update the privileges with the request", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a344f9baa26762f3574fc165db8206a54690e52d"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk2MzU1Nw==", "bodyText": "Done.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r461963557", "createdAt": "2020-07-29T00:09:50Z", "author": {"login": "ByteMap"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -747,6 +749,42 @@ public User updateLoggedInUserMetadata(@ApiParam(hidden = true)@Parameter(hidden\n         return dbuser;\n     }\n \n+    @PUT\n+    @Timed\n+    @UnitOfWork\n+    @RolesAllowed({\"admin\", \"curator\"})\n+    @Path(\"/user/{userId}/privileges\")\n+    @Consumes(\"application/json\")\n+    @Operation(operationId = \"setUserPrivileges\", description = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"Updates the provided userID to admin or curator status, ADMIN or CURATOR only\", authorizations = { @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = User.class, hidden = true)\n+    public User setUserPrivilege(@Parameter(hidden = true, name = \"user\")@Auth User authUser,\n+                                 @Parameter(name = \"User ID\", required = true) @PathParam(\"userId\") Long userID,\n+                                 @Parameter(name = \"Set privilege for a user\", required = true) PrivilegeRequest privilegeRequest) {\n+        User user = userDAO.findById(userID);\n+        if (user == null) {\n+            throw new CustomWebApplicationException(\"User not found\", HttpStatus.SC_NOT_FOUND);\n+        }\n+\n+        //This ensures that the user cannot modify their own privileges.\n+        if (authUser.getId() == user.getId()) {\n+            throw new CustomWebApplicationException(\"You cannot modify your own privileges\", HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        //If the request's admin setting is different than the admin status of the user that is being modified, and the auth user is not an admin: Throw an error.\n+        //This ensures that a curator cannot modify the admin status of any user.\n+        if (privilegeRequest.isAdmin() != user.getIsAdmin() && !authUser.getIsAdmin()) {\n+            throw new CustomWebApplicationException(\"You do not have privileges to modify administrative rights\", HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        //Else if the request's settings is different from the privileges of the user that is being modified: update the privileges with the request", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk0MzAyMA=="}, "originalCommit": {"oid": "a344f9baa26762f3574fc165db8206a54690e52d"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4Nzg5NjI4OnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDoxNzowOVrOG5Ikhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMjowODoyOVrOG5L-xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2MjQzOA==", "bodyText": "This seems wrong. You need the indentation. Are you not using the latest yq?", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r462562438", "createdAt": "2020-07-29T20:17:09Z", "author": {"login": "coverbeck"}, "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "diffHunk": "@@ -14,28 +14,34 @@ components:\n       type: object\n     BioWorkflow:\n       allOf:\n-        - $ref: '#/components/schemas/Workflow'\n-        - properties:\n-            is_checker:\n-              type: boolean\n-            parent_id:\n-              format: int64\n-              type: integer\n-          type: object\n+      - $ref: '#/components/schemas/Workflow'\n+      - properties:\n+          is_checker:\n+            type: boolean\n+          parent_id:\n+            format: int64\n+            type: integer\n+        type: object\n       type: object\n     Checksum:\n-      description: A production (immutable) tool version is required to have a hashcode. Not required otherwise, but might be useful to detect changes.  This exposes the hashcode for specific image versions to verify that the container version pulled is actually the version that was indexed by the registry.\n-      example: '[{checksum=77af4d6b9913e693e8d0b4b294fa62ade6054e6b2f1ffb617ac955dd63fb0182, type=sha256}]'\n+      description: 'A production (immutable) tool version is required to have a hashcode.\n+        Not required otherwise, but might be useful to detect changes. '\n+      example: '[{checksum=ea2a5db69bd20a42976838790bc29294df3af02b, type=sha1}]'\n       properties:\n         checksum:\n           description: 'The hex-string encoded checksum for the data. '\n           type: string\n         type:\n-          description: The digest method used to create the checksum. The value (e.g. `sha-256`) SHOULD be listed as `Hash Name String` in the https://github.com/ga4gh-discovery/ga4gh-checksum/blob/master/hash-alg.csv[GA4GH Checksum Hash Algorithm Registry]. Other values MAY be used, as long as implementors are aware of the issues discussed in https://tools.ietf.org/html/rfc6920#section-9.4[RFC6920]. GA4GH may provide more explicit guidance for use of non-IANA-registered algorithms in the future.\n+          description: The digest method used to create the checksum. The value (e.g.\n+            `sha-256`) SHOULD be listed as `Hash Name String` in the https://github.com/ga4gh-discovery/ga4gh-checksum/blob/master/hash-alg.csv[GA4GH\n+            Checksum Hash Algorithm Registry]. Other values MAY be used, as long as\n+            implementors are aware of the issues discussed in https://tools.ietf.org/html/rfc6920#section-9.4[RFC6920].\n+            GA4GH may provide more explicit guidance for use of non-IANA-registered\n+            algorithms in the future.\n           type: string\n       required:\n-        - checksum\n-        - type\n+      - checksum", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078a90da9e14bfa05d646c5cd4db718be26fca62"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxODMxMQ==", "bodyText": "Just updated to the latest yq.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r462618311", "createdAt": "2020-07-29T22:08:29Z", "author": {"login": "ByteMap"}, "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "diffHunk": "@@ -14,28 +14,34 @@ components:\n       type: object\n     BioWorkflow:\n       allOf:\n-        - $ref: '#/components/schemas/Workflow'\n-        - properties:\n-            is_checker:\n-              type: boolean\n-            parent_id:\n-              format: int64\n-              type: integer\n-          type: object\n+      - $ref: '#/components/schemas/Workflow'\n+      - properties:\n+          is_checker:\n+            type: boolean\n+          parent_id:\n+            format: int64\n+            type: integer\n+        type: object\n       type: object\n     Checksum:\n-      description: A production (immutable) tool version is required to have a hashcode. Not required otherwise, but might be useful to detect changes.  This exposes the hashcode for specific image versions to verify that the container version pulled is actually the version that was indexed by the registry.\n-      example: '[{checksum=77af4d6b9913e693e8d0b4b294fa62ade6054e6b2f1ffb617ac955dd63fb0182, type=sha256}]'\n+      description: 'A production (immutable) tool version is required to have a hashcode.\n+        Not required otherwise, but might be useful to detect changes. '\n+      example: '[{checksum=ea2a5db69bd20a42976838790bc29294df3af02b, type=sha1}]'\n       properties:\n         checksum:\n           description: 'The hex-string encoded checksum for the data. '\n           type: string\n         type:\n-          description: The digest method used to create the checksum. The value (e.g. `sha-256`) SHOULD be listed as `Hash Name String` in the https://github.com/ga4gh-discovery/ga4gh-checksum/blob/master/hash-alg.csv[GA4GH Checksum Hash Algorithm Registry]. Other values MAY be used, as long as implementors are aware of the issues discussed in https://tools.ietf.org/html/rfc6920#section-9.4[RFC6920]. GA4GH may provide more explicit guidance for use of non-IANA-registered algorithms in the future.\n+          description: The digest method used to create the checksum. The value (e.g.\n+            `sha-256`) SHOULD be listed as `Hash Name String` in the https://github.com/ga4gh-discovery/ga4gh-checksum/blob/master/hash-alg.csv[GA4GH\n+            Checksum Hash Algorithm Registry]. Other values MAY be used, as long as\n+            implementors are aware of the issues discussed in https://tools.ietf.org/html/rfc6920#section-9.4[RFC6920].\n+            GA4GH may provide more explicit guidance for use of non-IANA-registered\n+            algorithms in the future.\n           type: string\n       required:\n-        - checksum\n-        - type\n+      - checksum", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2MjQzOA=="}, "originalCommit": {"oid": "078a90da9e14bfa05d646c5cd4db718be26fca62"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4Nzk0NzYyOnYy", "diffSide": "RIGHT", "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDozMjoxOVrOG5JEhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMjo0OTowMFrOG5M8MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3MDYzMQ==", "bodyText": "assertEquals(expected, actual).  here and everywhere", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r462570631", "createdAt": "2020-07-29T20:32:19Z", "author": {"login": "garyluu"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -513,4 +513,56 @@ public void testUpdateUserMetadataFromGithub() {\n         assertEquals(\"DockstoreTestUser2\", userProfile.getUsername());\n     }\n \n+    @Test\n+    public void testSetUserPrivilege() {\n+        io.dockstore.openapi.client.ApiClient adminWebClient = getOpenAPIWebClient(ADMIN_USERNAME, testingPostgres);\n+        io.dockstore.openapi.client.ApiClient userWebClient = getOpenAPIWebClient(USER_2_USERNAME, testingPostgres);\n+\n+        io.dockstore.openapi.client.model.PrivilegeRequest privilegeRequest = new PrivilegeRequest();\n+        io.dockstore.openapi.client.api.UsersApi adminApi = new io.dockstore.openapi.client.api.UsersApi(adminWebClient);\n+        io.dockstore.openapi.client.api.UsersApi userApi = new io.dockstore.openapi.client.api.UsersApi(userWebClient);\n+        io.dockstore.openapi.client.model.User admin = adminApi.getUser();\n+        io.dockstore.openapi.client.model.User user = userApi.getUser();\n+\n+        privilegeRequest.setAdmin(false);\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+\n+        privilegeRequest.setCurator(true);\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertTrue(userApi.getUser().isCurator());\n+\n+        try {\n+            userApi.setUserPrivileges(privilegeRequest, admin.getId());\n+            fail(\"Curator should not be able to set admin permissions\");\n+        } catch (io.dockstore.openapi.client.ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        privilegeRequest.setAdmin(true);\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        assertTrue(userApi.getUser().isIsAdmin());\n+\n+        privilegeRequest.setAdmin(false);\n+        try {\n+            adminApi.setUserPrivileges(privilegeRequest, admin.getId());\n+            fail(\"User should not be able to set their own permissions\");\n+        } catch (io.dockstore.openapi.client.ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        privilegeRequest.setCurator(false);\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+        try {\n+            userApi.setUserPrivileges(privilegeRequest, admin.getId());\n+            fail(\"User with no curator or admin rights should not be able to access the API call\");\n+        } catch (io.dockstore.openapi.client.ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078a90da9e14bfa05d646c5cd4db718be26fca62"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYzNDAzMw==", "bodyText": "Done.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r462634033", "createdAt": "2020-07-29T22:49:00Z", "author": {"login": "ByteMap"}, "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -513,4 +513,56 @@ public void testUpdateUserMetadataFromGithub() {\n         assertEquals(\"DockstoreTestUser2\", userProfile.getUsername());\n     }\n \n+    @Test\n+    public void testSetUserPrivilege() {\n+        io.dockstore.openapi.client.ApiClient adminWebClient = getOpenAPIWebClient(ADMIN_USERNAME, testingPostgres);\n+        io.dockstore.openapi.client.ApiClient userWebClient = getOpenAPIWebClient(USER_2_USERNAME, testingPostgres);\n+\n+        io.dockstore.openapi.client.model.PrivilegeRequest privilegeRequest = new PrivilegeRequest();\n+        io.dockstore.openapi.client.api.UsersApi adminApi = new io.dockstore.openapi.client.api.UsersApi(adminWebClient);\n+        io.dockstore.openapi.client.api.UsersApi userApi = new io.dockstore.openapi.client.api.UsersApi(userWebClient);\n+        io.dockstore.openapi.client.model.User admin = adminApi.getUser();\n+        io.dockstore.openapi.client.model.User user = userApi.getUser();\n+\n+        privilegeRequest.setAdmin(false);\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+\n+        privilegeRequest.setCurator(true);\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertTrue(userApi.getUser().isCurator());\n+\n+        try {\n+            userApi.setUserPrivileges(privilegeRequest, admin.getId());\n+            fail(\"Curator should not be able to set admin permissions\");\n+        } catch (io.dockstore.openapi.client.ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        privilegeRequest.setAdmin(true);\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        assertTrue(userApi.getUser().isIsAdmin());\n+\n+        privilegeRequest.setAdmin(false);\n+        try {\n+            adminApi.setUserPrivileges(privilegeRequest, admin.getId());\n+            fail(\"User should not be able to set their own permissions\");\n+        } catch (io.dockstore.openapi.client.ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);\n+        }\n+\n+        privilegeRequest.setCurator(false);\n+        adminApi.setUserPrivileges(privilegeRequest, user.getId());\n+        assertFalse(userApi.getUser().isIsAdmin());\n+        assertFalse(userApi.getUser().isCurator());\n+        try {\n+            userApi.setUserPrivileges(privilegeRequest, admin.getId());\n+            fail(\"User with no curator or admin rights should not be able to access the API call\");\n+        } catch (io.dockstore.openapi.client.ApiException ex) {\n+            assertEquals(ex.getCode(), HttpStatus.SC_FORBIDDEN);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3MDYzMQ=="}, "originalCommit": {"oid": "078a90da9e14bfa05d646c5cd4db718be26fca62"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4Nzk1NDcyOnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/api/PrivilegeRequest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDozNDoyNVrOG5JI7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMjo0OTowNlrOG5M8TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3MTc1OA==", "bodyText": "make this endpoint /users/{userId}/privledges to be more restful", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r462571758", "createdAt": "2020-07-29T20:34:25Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/api/PrivilegeRequest.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package io.dockstore.webservice.api;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.swagger.annotations.ApiModel;\n+\n+/**\n+ * This is an object to encapsulate the privilege request. Used for requests in\n+ * /users/user/{userid}/privileges", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078a90da9e14bfa05d646c5cd4db718be26fca62"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYzNDA2MA==", "bodyText": "Done.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r462634060", "createdAt": "2020-07-29T22:49:06Z", "author": {"login": "ByteMap"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/api/PrivilegeRequest.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package io.dockstore.webservice.api;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.swagger.annotations.ApiModel;\n+\n+/**\n+ * This is an object to encapsulate the privilege request. Used for requests in\n+ * /users/user/{userid}/privileges", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3MTc1OA=="}, "originalCommit": {"oid": "078a90da9e14bfa05d646c5cd4db718be26fca62"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4OTAzNTIxOnYy", "diffSide": "RIGHT", "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwNDo1NDoyNVrOG5TGYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxODozODoxNVrOG5vORQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjczNDk0Nw==", "bodyText": "Looks out of date", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r462734947", "createdAt": "2020-07-30T04:54:25Z", "author": {"login": "garyluu"}, "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "diffHunk": "@@ -5881,6 +5888,34 @@ paths:\n         - bearer: []\n       tags:\n         - users\n+  /users/user/{userId}/privileges:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "449ab4488170a57a707cfb2f75c5e8442774ad2f"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE5NTcxNw==", "bodyText": "Done, forgot to maven build.", "url": "https://github.com/dockstore/dockstore/pull/3693#discussion_r463195717", "createdAt": "2020-07-30T18:38:15Z", "author": {"login": "ByteMap"}, "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "diffHunk": "@@ -5881,6 +5888,34 @@ paths:\n         - bearer: []\n       tags:\n         - users\n+  /users/user/{userId}/privileges:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjczNDk0Nw=="}, "originalCommit": {"oid": "449ab4488170a57a707cfb2f75c5e8442774ad2f"}, "originalPosition": 38}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2790, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}