{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNzMyMzU3", "number": 3338, "title": "Feature/3233/paginated tags", "bodyText": "For #3233\nGetting builds is not paginated, you just specify an amount and it retrieves that amount (was not able to find max amount, only tried up to ~459 builds).\nAs for tags...Previously we used the get-repo endpoint, it returns up to 500 tags with it.  The get tags endpoint is paginated and can eventually get all tags.\nThis PR does not affect builds (since there's no pagination), but allows us to get all tags.", "createdAt": "2020-03-20T20:42:06Z", "url": "https://github.com/dockstore/dockstore/pull/3338", "merged": true, "mergeCommit": {"oid": "3835dbfaac1f93e1c38af10dfecd9fdca582a093"}, "closed": true, "closedAt": "2020-03-27T13:07:54Z", "author": {"login": "garyluu"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPh7ivgH2gAyMzkxNzMyMzU3OmI0ZTRmMDRlMGFlOWQ4M2Q0MWU5YWEzMGI1ZGRkYTNjNWE3OGJjYmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRf3PDgFqTM4MjI2MDY1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b4e4f04e0ae9d83d41e9aa30b5ddda3c5a78bcba", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/b4e4f04e0ae9d83d41e9aa30b5ddda3c5a78bcba", "committedDate": "2020-03-20T15:06:51Z", "message": "Add function to get all tags"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c754ed2a55c09cad1410e6ffc69723f3b06dc2d7", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/c754ed2a55c09cad1410e6ffc69723f3b06dc2d7", "committedDate": "2020-03-20T15:06:59Z", "message": "Add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40ab891c0b11ce31339e8ce46b790820d184d68c", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/40ab891c0b11ce31339e8ce46b790820d184d68c", "committedDate": "2020-03-20T15:08:01Z", "message": "Mute successful"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "994593cc6f418397f1eb5938f80d0ab365cb8e68", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/994593cc6f418397f1eb5938f80d0ab365cb8e68", "committedDate": "2020-03-20T15:58:55Z", "message": "Modify Quay api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "307378a0a29d85f1d799d7a76e51c67138656cfa", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/307378a0a29d85f1d799d7a76e51c67138656cfa", "committedDate": "2020-03-20T16:15:05Z", "message": "?"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eccaf067dada0b686d12c944305e7eac5cd5c3f", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/3eccaf067dada0b686d12c944305e7eac5cd5c3f", "committedDate": "2020-03-20T17:33:51Z", "message": "Fix casting issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODczOTc3", "url": "https://github.com/dockstore/dockstore/pull/3338#pullrequestreview-378873977", "createdAt": "2020-03-21T00:34:15Z", "commit": {"oid": "3eccaf067dada0b686d12c944305e7eac5cd5c3f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NDE0MTg2", "url": "https://github.com/dockstore/dockstore/pull/3338#pullrequestreview-379414186", "createdAt": "2020-03-23T13:13:11Z", "commit": {"oid": "3eccaf067dada0b686d12c944305e7eac5cd5c3f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NTI5MDg1", "url": "https://github.com/dockstore/dockstore/pull/3338#pullrequestreview-379529085", "createdAt": "2020-03-23T15:16:18Z", "commit": {"oid": "3eccaf067dada0b686d12c944305e7eac5cd5c3f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNToxNjoxOFrOF6KKgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNToxNjoxOFrOF6KKgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyODI1OA==", "bodyText": "Seems possible to simplify.\nIf I understand correctly, this loop is handling the case when we need to paginate. The loop below is when you do not.\nBut all getAllQuayTags is doing is putting all tags into one big collection.\nIt should be possible to simplify by modifying getAllQuayTags to be tolerant of results that are one page.", "url": "https://github.com/dockstore/dockstore/pull/3338#discussion_r396528258", "createdAt": "2020-03-23T15:16:18Z", "author": {"login": "denis-yuen"}, "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/QuayImageRegistry.java", "diffHunk": "@@ -65,45 +69,72 @@\n     private static final Logger LOG = LoggerFactory.getLogger(QuayImageRegistry.class);\n \n     private final Token quayToken;\n-    private final ApiClient apiClient;\n     private final BuildApi buildApi;\n     private final RepositoryApi repositoryApi;\n     private final UserApi userApi;\n+    private final TagApi tagApi;\n \n     public QuayImageRegistry(final Token quayToken) {\n         this.quayToken = quayToken;\n-\n-        apiClient = Configuration.getDefaultApiClient();\n+        ApiClient apiClient = Configuration.getDefaultApiClient();\n         apiClient.addDefaultHeader(\"Authorization\", \"Bearer \" + quayToken.getContent());\n         this.buildApi = new BuildApi(apiClient);\n         this.repositoryApi = new RepositoryApi(apiClient);\n         this.userApi = new UserApi(apiClient);\n+        this.tagApi = new TagApi((apiClient));\n+\n     }\n \n+    private List<QuayTag> getAllQuayTags(String repository) throws ApiException {\n+        List<QuayTag> allQuayTags = new ArrayList<>();\n+        // Completely arbitrary maxPageSize in the weird event that Quay.io's pagination results in an infinite loop or something\n+        final int maxPageSize = 100;\n+        for (int page = 1; page < Integer.MAX_VALUE; page++) {\n+            InlineResponse2002 inlineResponse2002 = tagApi.listRepoTags(repository, page, maxPageSize, null, true);\n+            List<QuayTag> quayTags = inlineResponse2002.getTags();\n+            allQuayTags.addAll(quayTags);\n+            if (!inlineResponse2002.isHasAdditional()) {\n+                break;\n+            }\n+        }\n+        return allQuayTags;\n+    }\n+\n+\n     @Override\n     public List<Tag> getTags(Tool tool) {\n         LOG.info(quayToken.getUsername() + \" ======================= Getting tags for: {}================================\", tool.getPath());\n-\n+        final String repo = tool.getNamespace() + '/' + tool.getName();\n         final List<Tag> tags = new ArrayList<>();\n         final Optional<QuayRepo> toolFromQuay = getToolFromQuay(tool);\n         if (toolFromQuay.isPresent()) {\n             final QuayRepo quayRepo = toolFromQuay.get();\n             final Map<String, QuayTag> tagsFromRepo = quayRepo.getTags();\n-            for (QuayTag tagItem : tagsFromRepo.values()) {\n+            final int maxQuayTagsReturnedByRepo = 500;\n+            if (tagsFromRepo.size() == maxQuayTagsReturnedByRepo) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eccaf067dada0b686d12c944305e7eac5cd5c3f"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NTg5NjA3", "url": "https://github.com/dockstore/dockstore/pull/3338#pullrequestreview-379589607", "createdAt": "2020-03-23T16:17:17Z", "commit": {"oid": "3eccaf067dada0b686d12c944305e7eac5cd5c3f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b673f87b5758b7f456bad3716360c3a7496ca234", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/b673f87b5758b7f456bad3716360c3a7496ca234", "committedDate": "2020-03-23T20:32:49Z", "message": "Simplify"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5ODU3NzI0", "url": "https://github.com/dockstore/dockstore/pull/3338#pullrequestreview-379857724", "createdAt": "2020-03-23T22:07:10Z", "commit": {"oid": "b673f87b5758b7f456bad3716360c3a7496ca234"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4db4edc5a1c67e6612b4a2795c30e806e88ff31", "author": {"user": {"login": "garyluu", "name": "Gary Luu"}}, "url": "https://github.com/dockstore/dockstore/commit/f4db4edc5a1c67e6612b4a2795c30e806e88ff31", "committedDate": "2020-03-24T16:27:39Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMTYzNDk5", "url": "https://github.com/dockstore/dockstore/pull/3338#pullrequestreview-382163499", "createdAt": "2020-03-26T16:06:20Z", "commit": {"oid": "f4db4edc5a1c67e6612b4a2795c30e806e88ff31"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMjYwNjUy", "url": "https://github.com/dockstore/dockstore/pull/3338#pullrequestreview-382260652", "createdAt": "2020-03-26T17:50:11Z", "commit": {"oid": "f4db4edc5a1c67e6612b4a2795c30e806e88ff31"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1840, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}