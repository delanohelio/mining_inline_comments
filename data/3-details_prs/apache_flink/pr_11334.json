{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0ODkyOTU3", "number": 11334, "title": "[FLINK-16464][sql-client]result-mode tableau may shift when content contains Chinese String in SQL CLI", "bodyText": "What is the purpose of the change\n\nThis pull request  fix result-mode tableau may shift when content contains Chinese String. *\n\nBrief change log\n\nupdate file org/apache/flink/table/client/cli/CliTableauResultView.java\n\nVerifying this change\nAdd test in CliTableauResultViewTest.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (no)\nThe serializers: (no)\nThe runtime per-record code paths (performance sensitive): ( no)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)\nThe S3 file system connector: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-03-06T15:53:04Z", "url": "https://github.com/apache/flink/pull/11334", "merged": true, "mergeCommit": {"oid": "22915d051d614249ea2d2eae4a2366b5533136d8"}, "closed": true, "closedAt": "2020-03-13T07:12:09Z", "author": {"login": "leonardBang"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcLCIfaAH2gAyMzg0ODkyOTU3OjM4NzJjZWZhODg1OTcyNWZhM2Y1MWUwZTczNjk4ZTVkMWUwODZlM2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZqB2EgFqTM5NjMyNzQ4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3872cefa8859725fa3f51e0e73698e5d1e086e3b", "author": {"user": {"login": "leonardBang", "name": "Leonard Xu"}}, "url": "https://github.com/apache/flink/commit/3872cefa8859725fa3f51e0e73698e5d1e086e3b", "committedDate": "2020-03-06T15:48:20Z", "message": "[FLINK-16464][sql-client]result-mode tableau may shift when content contains Chinese String in SQL CLI"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNDM0ODYz", "url": "https://github.com/apache/flink/pull/11334#pullrequestreview-370434863", "createdAt": "2020-03-06T16:01:09Z", "commit": {"oid": "3872cefa8859725fa3f51e0e73698e5d1e086e3b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNjowMTowOVrOFy9-SQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNjowMTowOVrOFy9-SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk4ODQ4OQ==", "bodyText": "Looks like we can not use UTF-8 length too...", "url": "https://github.com/apache/flink/pull/11334#discussion_r388988489", "createdAt": "2020-03-06T16:01:09Z", "author": {"login": "JingsongLi"}, "path": "flink-table/flink-sql-client/src/test/java/org/apache/flink/table/client/cli/CliTableauResultViewTest.java", "diffHunk": "@@ -167,8 +177,9 @@ public void testBatchResult() {\n \t\t\t\t\"|   false | -2147483648 |  9223372036854775807 |                     (NULL) |    12345.06789 |    2020-03-01 18:39:14.123 |\\n\" +\n \t\t\t\t\"|    true |         100 | -9223372036854775808 |                 abcdefg111 |         (NULL) | 2020-03-01 18:39:14.123456 |\\n\" +\n \t\t\t\t\"|  (NULL) |          -1 |                   -1 | abcdefghijklmnopqrstuvwxyz |   -12345.06789 |                     (NULL) |\\n\" +\n+\t\t\t\t\"|  (NULL) |          -1 |                   -1 |         \u8fd9\u662f\u4e00\u6bb5\u4e2d\u6587 |   -12345.06789 |      2020-03-04 18:39:14.0 |\\n\"\t+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3872cefa8859725fa3f51e0e73698e5d1e086e3b"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbef90ead12cfccbb50a04b1f59d809df9b7fc40", "author": {"user": {"login": "leonardBang", "name": "Leonard Xu"}}, "url": "https://github.com/apache/flink/commit/dbef90ead12cfccbb50a04b1f59d809df9b7fc40", "committedDate": "2020-03-09T15:35:26Z", "message": "[FLINK-16464][sql-client]result-mode tableau may shift when content contains Chinese String in SQL CLI"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNjU4ODQ5", "url": "https://github.com/apache/flink/pull/11334#pullrequestreview-371658849", "createdAt": "2020-03-10T03:19:55Z", "commit": {"oid": "dbef90ead12cfccbb50a04b1f59d809df9b7fc40"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMzoxOTo1NVrOF0AR3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMzo0MTowMFrOF0Aj0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3NDg0NA==", "bodyText": "We should also shade this jar into flink-sql-client jar?\nIf yes, then please also update the license files", "url": "https://github.com/apache/flink/pull/11334#discussion_r390074844", "createdAt": "2020-03-10T03:19:55Z", "author": {"login": "KurtYoung"}, "path": "flink-table/flink-sql-client/pom.xml", "diffHunk": "@@ -109,6 +109,13 @@ under the License.\n \t\t\t<version>3.9.0</version>\n \t\t</dependency>\n \n+\t\t<!-- Tools to Unify display format for different languages -->\n+\t\t<dependency>\n+\t\t\t<groupId>com.ibm.icu</groupId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbef90ead12cfccbb50a04b1f59d809df9b7fc40"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3NTQ5NA==", "bodyText": "use COLUMN_TRUNCATED_FLAG.length() instead?", "url": "https://github.com/apache/flink/pull/11334#discussion_r390075494", "createdAt": "2020-03-10T03:22:49Z", "author": {"login": "KurtYoung"}, "path": "flink-table/flink-sql-client/src/main/java/org/apache/flink/table/client/cli/CliTableauResultView.java", "diffHunk": "@@ -60,9 +61,9 @@\n \tprivate static final int NULL_COLUMN_WIDTH = CliStrings.NULL_COLUMN.length();\n \tprivate static final int MAX_COLUMN_WIDTH = 30;\n \tprivate static final int DEFAULT_COLUMN_WIDTH = 20;\n+\tprivate static final int COLUMN_TRUNCATED_FLAG_WIDTH = 3;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbef90ead12cfccbb50a04b1f59d809df9b7fc40"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3NjIwMg==", "bodyText": "int displayWidth = getStringDisplayWidth(col)  would be more clear and accurate", "url": "https://github.com/apache/flink/pull/11334#discussion_r390076202", "createdAt": "2020-03-10T03:25:59Z", "author": {"login": "KurtYoung"}, "path": "flink-table/flink-sql-client/src/main/java/org/apache/flink/table/client/cli/CliTableauResultView.java", "diffHunk": "@@ -276,13 +277,13 @@ private void printSingleRow(int[] colWidths, String[] cols) {\n \t\tsb.append(\"|\");\n \t\tint idx = 0;\n \t\tfor (String col : cols) {\n-\t\t\tbyte[] colBytes = getUTF8Bytes(col);\n \t\t\tsb.append(\" \");\n-\t\t\tif (colBytes.length <= colWidths[idx]) {\n-\t\t\t\tsb.append(StringUtils.repeat(' ', colWidths[idx] - colBytes.length));\n+\t\t\tint colWidth = getStringWidth(col);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbef90ead12cfccbb50a04b1f59d809df9b7fc40"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3NjQzNA==", "bodyText": "getFixedString => truncateString?", "url": "https://github.com/apache/flink/pull/11334#discussion_r390076434", "createdAt": "2020-03-10T03:27:01Z", "author": {"login": "KurtYoung"}, "path": "flink-table/flink-sql-client/src/main/java/org/apache/flink/table/client/cli/CliTableauResultView.java", "diffHunk": "@@ -276,13 +277,13 @@ private void printSingleRow(int[] colWidths, String[] cols) {\n \t\tsb.append(\"|\");\n \t\tint idx = 0;\n \t\tfor (String col : cols) {\n-\t\t\tbyte[] colBytes = getUTF8Bytes(col);\n \t\t\tsb.append(\" \");\n-\t\t\tif (colBytes.length <= colWidths[idx]) {\n-\t\t\t\tsb.append(StringUtils.repeat(' ', colWidths[idx] - colBytes.length));\n+\t\t\tint colWidth = getStringWidth(col);\n+\t\t\tif (colWidth <= colWidths[idx]) {\n+\t\t\t\tsb.append(StringUtils.repeat(' ', colWidths[idx] - colWidth));\n \t\t\t\tsb.append(col);\n \t\t\t} else {\n-\t\t\t\tsb.append(subMaxString(col, colWidths[idx]));\n+\t\t\t\tsb.append(getFixedString(col, colWidths[idx]));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbef90ead12cfccbb50a04b1f59d809df9b7fc40"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3OTE5Mw==", "bodyText": "and second parameter can be replaced with colWidths[idx] - COLUMN_TRUNCATED_FLAG_WIDTH as targetLength", "url": "https://github.com/apache/flink/pull/11334#discussion_r390079193", "createdAt": "2020-03-10T03:39:55Z", "author": {"login": "KurtYoung"}, "path": "flink-table/flink-sql-client/src/main/java/org/apache/flink/table/client/cli/CliTableauResultView.java", "diffHunk": "@@ -276,13 +277,13 @@ private void printSingleRow(int[] colWidths, String[] cols) {\n \t\tsb.append(\"|\");\n \t\tint idx = 0;\n \t\tfor (String col : cols) {\n-\t\t\tbyte[] colBytes = getUTF8Bytes(col);\n \t\t\tsb.append(\" \");\n-\t\t\tif (colBytes.length <= colWidths[idx]) {\n-\t\t\t\tsb.append(StringUtils.repeat(' ', colWidths[idx] - colBytes.length));\n+\t\t\tint colWidth = getStringWidth(col);\n+\t\t\tif (colWidth <= colWidths[idx]) {\n+\t\t\t\tsb.append(StringUtils.repeat(' ', colWidths[idx] - colWidth));\n \t\t\t\tsb.append(col);\n \t\t\t} else {\n-\t\t\t\tsb.append(subMaxString(col, colWidths[idx]));\n+\t\t\t\tsb.append(getFixedString(col, colWidths[idx]));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3NjQzNA=="}, "originalCommit": {"oid": "dbef90ead12cfccbb50a04b1f59d809df9b7fc40"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3OTM1OQ==", "bodyText": "please add unit tests for both newly added methods.", "url": "https://github.com/apache/flink/pull/11334#discussion_r390079359", "createdAt": "2020-03-10T03:40:40Z", "author": {"login": "KurtYoung"}, "path": "flink-table/flink-sql-client/src/main/java/org/apache/flink/table/client/cli/CliUtils.java", "diffHunk": "@@ -111,4 +113,33 @@ public static void normalizeColumn(AttributedStringBuilder sb, String col, int m\n \t\t}\n \t\treturn typesAsString;\n \t}\n+\n+\tpublic static int getStringWidth(String str) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbef90ead12cfccbb50a04b1f59d809df9b7fc40"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3OTQ0MA==", "bodyText": "what's this?", "url": "https://github.com/apache/flink/pull/11334#discussion_r390079440", "createdAt": "2020-03-10T03:41:00Z", "author": {"login": "KurtYoung"}, "path": "flink-table/flink-sql-client/src/test/java/org/apache/flink/table/client/cli/CliTableauResultViewTest.java", "diffHunk": "@@ -156,19 +176,21 @@ public void testBatchResult() {\n \n \t\tview.displayBatchResults();\n \t\tview.close();\n-\n+\t\t// note: about", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbef90ead12cfccbb50a04b1f59d809df9b7fc40"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8aa3b784db3bdd4b0c5bc455c96cfa59092cbe6f", "author": {"user": {"login": "leonardBang", "name": "Leonard Xu"}}, "url": "https://github.com/apache/flink/commit/8aa3b784db3bdd4b0c5bc455c96cfa59092cbe6f", "committedDate": "2020-03-11T15:53:53Z", "message": "address comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71e99474dc27f501c2c512e80761edd2057c00d0", "author": {"user": {"login": "leonardBang", "name": "Leonard Xu"}}, "url": "https://github.com/apache/flink/commit/71e99474dc27f501c2c512e80761edd2057c00d0", "committedDate": "2020-03-12T02:45:09Z", "message": "add license and unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczOTk5OTM1", "url": "https://github.com/apache/flink/pull/11334#pullrequestreview-373999935", "createdAt": "2020-03-13T01:45:58Z", "commit": {"oid": "71e99474dc27f501c2c512e80761edd2057c00d0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMTo0NTo1OVrOF11Hiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMTo0NTo1OVrOF11Hiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk4OTEzMQ==", "bodyText": "revert this", "url": "https://github.com/apache/flink/pull/11334#discussion_r391989131", "createdAt": "2020-03-13T01:45:59Z", "author": {"login": "KurtYoung"}, "path": "flink-table/flink-sql-client/pom.xml", "diffHunk": "@@ -7,7 +7,9 @@ regarding copyright ownership.  The ASF licenses this file\n to you under the Apache License, Version 2.0 (the\n \"License\"); you may not use this file except in compliance\n with the License.  You may obtain a copy of the License at\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71e99474dc27f501c2c512e80761edd2057c00d0"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3dea1922d35f3a023fd1f70e8dfe5a13fb3f14a", "author": {"user": {"login": "leonardBang", "name": "Leonard Xu"}}, "url": "https://github.com/apache/flink/commit/b3dea1922d35f3a023fd1f70e8dfe5a13fb3f14a", "committedDate": "2020-03-13T05:06:39Z", "message": "revert pom header format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2Mjg0NTg4", "url": "https://github.com/apache/flink/pull/11334#pullrequestreview-396284588", "createdAt": "2020-04-20T09:24:59Z", "commit": {"oid": "b3dea1922d35f3a023fd1f70e8dfe5a13fb3f14a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwOToyNDo1OVrOGILX7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwOToyNDo1OVrOGILX7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIyODE0Mw==", "bodyText": "@KurtYoung @leonardBang I don't think icu is a BSD license. Could you please fix this, or revert the changes.", "url": "https://github.com/apache/flink/pull/11334#discussion_r411228143", "createdAt": "2020-04-20T09:24:59Z", "author": {"login": "aljoscha"}, "path": "flink-table/flink-sql-client/src/main/resources/META-INF/NOTICE", "diffHunk": "@@ -9,3 +9,4 @@ See bundled license files for details.\n \n - org.jline:jline-terminal:3.9.0\n - org.jline:jline-reader:3.9.0\n+- com.ibm.icu:icu4j:65.1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3dea1922d35f3a023fd1f70e8dfe5a13fb3f14a"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2MzI3NDgx", "url": "https://github.com/apache/flink/pull/11334#pullrequestreview-396327481", "createdAt": "2020-04-20T10:24:00Z", "commit": {"oid": "b3dea1922d35f3a023fd1f70e8dfe5a13fb3f14a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMDoyNDowMFrOGINqYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMjowNzowNVrOGIROPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2NTYzMw==", "bodyText": "@aljoscha Thanks for your feedback, you're wright that icu is not a pure BSD license, I hesitate to import it at the beginning, but decided to add it after references hive https://github.com/apache/hive/blob/master/binary-package-licenses/com.ibm.icu.icu4j-LICENSE", "url": "https://github.com/apache/flink/pull/11334#discussion_r411265633", "createdAt": "2020-04-20T10:24:00Z", "author": {"login": "leonardBang"}, "path": "flink-table/flink-sql-client/src/main/resources/META-INF/NOTICE", "diffHunk": "@@ -9,3 +9,4 @@ See bundled license files for details.\n \n - org.jline:jline-terminal:3.9.0\n - org.jline:jline-reader:3.9.0\n+- com.ibm.icu:icu4j:65.1", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIyODE0Mw=="}, "originalCommit": {"oid": "b3dea1922d35f3a023fd1f70e8dfe5a13fb3f14a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMyMzk2NA==", "bodyText": "And camel using it too ,apache/camel@83ae6d4", "url": "https://github.com/apache/flink/pull/11334#discussion_r411323964", "createdAt": "2020-04-20T12:07:05Z", "author": {"login": "leonardBang"}, "path": "flink-table/flink-sql-client/src/main/resources/META-INF/NOTICE", "diffHunk": "@@ -9,3 +9,4 @@ See bundled license files for details.\n \n - org.jline:jline-terminal:3.9.0\n - org.jline:jline-reader:3.9.0\n+- com.ibm.icu:icu4j:65.1", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIyODE0Mw=="}, "originalCommit": {"oid": "b3dea1922d35f3a023fd1f70e8dfe5a13fb3f14a"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3120, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}