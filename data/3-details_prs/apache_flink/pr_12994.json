{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2OTkwMzA3", "number": 12994, "title": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final", "bodyText": "What is the purpose of the change\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\nBrief change log\n\nMake initialCredit of RemoteInputChannel final\n\nVerifying this change\nThis change is already covered by existing tests.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-07-27T08:14:36Z", "url": "https://github.com/apache/flink/pull/12994", "merged": true, "mergeCommit": {"oid": "a3ba0eb172b74945a3152b7a4d5631c209309f96"}, "closed": true, "closedAt": "2020-08-13T09:48:02Z", "author": {"login": "wsry"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5DY65ABqjM1OTAzNTc5NTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-cy9BgFqTQ2NjYwNTMwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a031dfe63cc4494e4cb7fe599b9bcafe6ba0ce92", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/a031dfe63cc4494e4cb7fe599b9bcafe6ba0ce92", "committedDate": "2020-07-27T08:09:52Z", "message": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final\n\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\n\nThis closes #11877."}, "afterCommit": {"oid": "20ea916ccc154c7d53d40d273b346533b8409b12", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/20ea916ccc154c7d53d40d273b346533b8409b12", "committedDate": "2020-07-27T15:14:15Z", "message": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final\n\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\n\nThis closes #11877."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "20ea916ccc154c7d53d40d273b346533b8409b12", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/20ea916ccc154c7d53d40d273b346533b8409b12", "committedDate": "2020-07-27T15:14:15Z", "message": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final\n\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\n\nThis closes #11877."}, "afterCommit": {"oid": "e254b80defcac6316bc542918d382159c2ebda5e", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/e254b80defcac6316bc542918d382159c2ebda5e", "committedDate": "2020-07-28T06:50:57Z", "message": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final\n\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\n\nThis closes #11877."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e254b80defcac6316bc542918d382159c2ebda5e", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/e254b80defcac6316bc542918d382159c2ebda5e", "committedDate": "2020-07-28T06:50:57Z", "message": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final\n\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\n\nThis closes #11877."}, "afterCommit": {"oid": "d164d2a94a4fa87a9f56f7238512d79134a722ee", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/d164d2a94a4fa87a9f56f7238512d79134a722ee", "committedDate": "2020-07-29T03:08:21Z", "message": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final\n\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\n\nThis closes #11877."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d164d2a94a4fa87a9f56f7238512d79134a722ee", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/d164d2a94a4fa87a9f56f7238512d79134a722ee", "committedDate": "2020-07-29T03:08:21Z", "message": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final\n\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\n\nThis closes #11877."}, "afterCommit": {"oid": "2efaa69c5791a59239feec7c122ba4fd39462238", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/2efaa69c5791a59239feec7c122ba4fd39462238", "committedDate": "2020-07-29T03:15:48Z", "message": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final\n\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\n\nThis closes #11877."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMzUzNzY1", "url": "https://github.com/apache/flink/pull/12994#pullrequestreview-462353765", "createdAt": "2020-08-06T09:23:25Z", "commit": {"oid": "2efaa69c5791a59239feec7c122ba4fd39462238"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwOToyMzoyNlrOG8q_VA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwOToyMzoyNlrOG8q_VA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI3MjA4NA==", "bodyText": "The previous initial credit seems to be got from the returned collection size of globalPool.requestMemorySegments() somehow. If we can get the initial credit in advance, then it would be better to also pass it as argument into requestMemorySegments to get required size. To do so, the NetworkBufferPool#requestMemorySegments seems more general to decouple with credit semantic.", "url": "https://github.com/apache/flink/pull/12994#discussion_r466272084", "createdAt": "2020-08-06T09:23:26Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/BufferManager.java", "diffHunk": "@@ -125,9 +125,9 @@ private boolean shouldContinueRequest(BufferPool bufferPool) {\n \t}\n \n \t/**\n-\t * Requests exclusive buffers from the provider and returns the number of requested amount.\n+\t * Requests exclusive buffers from the provider.\n \t */\n-\tint requestExclusiveBuffers() throws IOException {\n+\tvoid requestExclusiveBuffers() throws IOException {\n \t\tCollection<MemorySegment> segments = globalPool.requestMemorySegments();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2efaa69c5791a59239feec7c122ba4fd39462238"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40d884bc7ab51689d54592a3f99289912abd71d3", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/40d884bc7ab51689d54592a3f99289912abd71d3", "committedDate": "2020-08-07T03:55:40Z", "message": "[hotfix] Rename BufferManager#unsynchronizedGetExclusiveBuffersUsed to BufferManager#unsynchronizedGetAvailableExclusiveBuffers\n\nThis closes #12994."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2efaa69c5791a59239feec7c122ba4fd39462238", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/2efaa69c5791a59239feec7c122ba4fd39462238", "committedDate": "2020-07-29T03:15:48Z", "message": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final\n\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\n\nThis closes #11877."}, "afterCommit": {"oid": "2aab77e658b25b810fcbc29c5977e16cb375c759", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/2aab77e658b25b810fcbc29c5977e16cb375c759", "committedDate": "2020-08-07T04:03:13Z", "message": "[hotfix] Change signature of MemorySegmentProvider#requestMemorySegments from requestMemorySegments() to requestMemorySegments(int)\n\nThis change makes the interface more flexible and decouples NetworkBufferPool from the concept of exclusive buffer.\n\nThis close #12994."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2aab77e658b25b810fcbc29c5977e16cb375c759", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/2aab77e658b25b810fcbc29c5977e16cb375c759", "committedDate": "2020-08-07T04:03:13Z", "message": "[hotfix] Change signature of MemorySegmentProvider#requestMemorySegments from requestMemorySegments() to requestMemorySegments(int)\n\nThis change makes the interface more flexible and decouples NetworkBufferPool from the concept of exclusive buffer.\n\nThis close #12994."}, "afterCommit": {"oid": "511d2dba850a677f5297ff75c6a911ed56efbacd", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/511d2dba850a677f5297ff75c6a911ed56efbacd", "committedDate": "2020-08-07T08:06:50Z", "message": "[hotfix] Change signature of MemorySegmentProvider#requestMemorySegments from requestMemorySegments() to requestMemorySegments(int)\n\nThis change makes the interface more flexible and decouples NetworkBufferPool from the concept of exclusive buffer.\n\nThis close #12994."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "511d2dba850a677f5297ff75c6a911ed56efbacd", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/511d2dba850a677f5297ff75c6a911ed56efbacd", "committedDate": "2020-08-07T08:06:50Z", "message": "[hotfix] Change signature of MemorySegmentProvider#requestMemorySegments from requestMemorySegments() to requestMemorySegments(int)\n\nThis change makes the interface more flexible and decouples NetworkBufferPool from the concept of exclusive buffer.\n\nThis close #12994."}, "afterCommit": {"oid": "707c67f554cf59d2ba1e848e05cef0aea1fe7a89", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/707c67f554cf59d2ba1e848e05cef0aea1fe7a89", "committedDate": "2020-08-07T09:17:28Z", "message": "[hotfix] Change signature of MemorySegmentProvider#requestMemorySegments from requestMemorySegments() to requestMemorySegments(int)\n\nThis change makes the interface more flexible and decouples NetworkBufferPool from the concept of exclusive buffer.\n\nThis close #12994."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMTY2NDU4", "url": "https://github.com/apache/flink/pull/12994#pullrequestreview-463166458", "createdAt": "2020-08-07T09:23:14Z", "commit": {"oid": "511d2dba850a677f5297ff75c6a911ed56efbacd"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwOToyNDo1NFrOG9S--Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwOTozMjo1OVrOG9TO5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyNzM1Mw==", "bodyText": "Do you think we should check the passed argument more than 0 in advance?", "url": "https://github.com/apache/flink/pull/12994#discussion_r466927353", "createdAt": "2020-08-07T09:24:54Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/NetworkBufferPool.java", "diffHunk": "@@ -161,13 +155,13 @@ public void recycle(MemorySegment segment) {\n \t}\n \n \t@Override\n-\tpublic List<MemorySegment> requestMemorySegments() throws IOException {\n+\tpublic List<MemorySegment> requestMemorySegments(int numberOfSegmentsToRequest) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707c67f554cf59d2ba1e848e05cef0aea1fe7a89"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyNzQzMg==", "bodyText": "nit: if we want to check this argument, it would be better to be done in the initialization of constructor.\nI think we can remove it directly since the passed networkBuffersPerChannel in constructor should already be checked in previous component.", "url": "https://github.com/apache/flink/pull/12994#discussion_r466927432", "createdAt": "2020-08-07T09:25:03Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -128,8 +128,9 @@ public RemoteInputChannel(\n \tvoid assignExclusiveSegments() throws IOException {\n \t\tcheckState(bufferManager.unsynchronizedGetAvailableExclusiveBuffers() == 0,\n \t\t\t\"Bug in input channel setup logic: exclusive buffers have already been set for this input channel.\");\n+\t\tcheckState(initialCredit > 0, \"Number of exclusive buffers must be larger than 0.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707c67f554cf59d2ba1e848e05cef0aea1fe7a89"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkzMTA3Mg==", "bodyText": "This change seems unnecessary?", "url": "https://github.com/apache/flink/pull/12994#discussion_r466931072", "createdAt": "2020-08-07T09:32:18Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannelTest.java", "diffHunk": "@@ -1121,14 +1118,15 @@ public void testUnblockReleasedChannel() throws Exception {\n \t\tremoteChannel.resumeConsumption();\n \t}\n \n-\t// ---------------------------------------------------------------------------------------------\n-\n-\tpublic static RemoteInputChannel createRemoteInputChannel(SingleInputGate inputGate, int numExclusiveSegments) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707c67f554cf59d2ba1e848e05cef0aea1fe7a89"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkzMTQyOA==", "bodyText": "I guess this test should be adjusted as well based on above comments.", "url": "https://github.com/apache/flink/pull/12994#discussion_r466931428", "createdAt": "2020-08-07T09:32:59Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannelTest.java", "diffHunk": "@@ -1121,14 +1118,15 @@ public void testUnblockReleasedChannel() throws Exception {\n \t\tremoteChannel.resumeConsumption();\n \t}\n \n-\t// ---------------------------------------------------------------------------------------------\n-\n-\tpublic static RemoteInputChannel createRemoteInputChannel(SingleInputGate inputGate, int numExclusiveSegments) {\n-\t\treturn InputChannelBuilder.newBuilder()\n-\t\t\t.setNetworkBuffersPerChannel(numExclusiveSegments)\n-\t\t\t.buildRemoteChannel(inputGate);\n+\t@Test(expected = IllegalStateException.class)\n+\tpublic void testIllegalNumberOfExclusiveBuffers() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "707c67f554cf59d2ba1e848e05cef0aea1fe7a89"}, "originalPosition": 120}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "370e0fc44226f5a616c459cc68d51cf6a3686991", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/370e0fc44226f5a616c459cc68d51cf6a3686991", "committedDate": "2020-08-09T03:53:29Z", "message": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final\n\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\n\nThis closes #12994."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "707c67f554cf59d2ba1e848e05cef0aea1fe7a89", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/707c67f554cf59d2ba1e848e05cef0aea1fe7a89", "committedDate": "2020-08-07T09:17:28Z", "message": "[hotfix] Change signature of MemorySegmentProvider#requestMemorySegments from requestMemorySegments() to requestMemorySegments(int)\n\nThis change makes the interface more flexible and decouples NetworkBufferPool from the concept of exclusive buffer.\n\nThis close #12994."}, "afterCommit": {"oid": "370e0fc44226f5a616c459cc68d51cf6a3686991", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/370e0fc44226f5a616c459cc68d51cf6a3686991", "committedDate": "2020-08-09T03:53:29Z", "message": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final\n\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\n\nThis closes #12994."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "453eabc11a5acfbf6cca97959b6bf6e57a93b0e9", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/453eabc11a5acfbf6cca97959b6bf6e57a93b0e9", "committedDate": "2020-08-09T05:26:39Z", "message": "[hotfix] Change signature of MemorySegmentProvider#requestMemorySegments from requestMemorySegments() to requestMemorySegments(int)\n\nThis change makes the interface more flexible and decouples NetworkBufferPool from the concept of exclusive buffer.\n\nThis close #12994."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NjA1MzA0", "url": "https://github.com/apache/flink/pull/12994#pullrequestreview-466605304", "createdAt": "2020-08-13T09:42:23Z", "commit": {"oid": "453eabc11a5acfbf6cca97959b6bf6e57a93b0e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2969, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}