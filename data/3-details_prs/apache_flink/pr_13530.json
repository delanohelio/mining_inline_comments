{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NzM3MjIy", "number": 13530, "title": "[FLINK-19123] Use shared MiniCluster for executeAsync() in TestStreamEnvironment", "bodyText": "What is the purpose of the change\nTestStreamEnvironment only overrides execute() but not executeAsync(). Calls against the latter therefore don't use the shared MiniCluster but a new cluster is spun up for every job.\nThis changes TestStreamEnvironment to always use the shared MiniCluster by injecting a custom PipelineExecutorServiceLoader and not overriding any of the execute*() methods.\nBrief change log\nAs always, the commit messages describe what each commit does.\n\nremodel PerJobMiniClusterClient to be usable for all MiniCluster job purposes\nchange TestStreamEnvironment to use a custom PipelineExecutorServiceLoader\nthe custom  PipelineExecutorServiceLoader goes directly against a MiniCluster instead of the JobExecutor because we want to do async job submission\nremove now-unused JobExecutor interface\n\nThis quote describes the rationale behind removing JobExecutor and mentions an alternative solution:\n\nInstead, we use a custom PipelineExecutorServiceLoader to inject a\nMiniClusterExecutor. This requires that we directly use MiniCluster\ninstead of the JobExecutor interface in the test environments because we\nneed to use asynchronous job submission. The alternative would be to\nextend the JobExecutor interface to allow async job submission.\n\nVerifying this change\nCovered by existing tests that use TestStreamEnvironment.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? not applicable", "createdAt": "2020-10-02T07:29:28Z", "url": "https://github.com/apache/flink/pull/13530", "merged": true, "mergeCommit": {"oid": "47ca19a74e11c72842124852875262959477c459"}, "closed": true, "closedAt": "2020-10-06T07:07:42Z", "author": {"login": "aljoscha"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOhGangBqjM4MzI3NzQxOTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPlSceABqjM4NDEwMDQ5OTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c0c3a012813e6bf76ee374073218ab647f1aa1be", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/c0c3a012813e6bf76ee374073218ab647f1aa1be", "committedDate": "2020-10-02T07:25:07Z", "message": "[FLINK-19123] Remove unused JobExecutor interfaces\n\nThey were introduced to allow two different MiniCluster implementations\nwhen the \"new\" FLIP-6 code was introduced.\n\nIn the previous commit we changed the TestEnvironments to directlu use a\nMiniCluster so these interfaces are not required anymore."}, "afterCommit": {"oid": "2513a954016debd48694a5097a5c2a48943ca532", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/2513a954016debd48694a5097a5c2a48943ca532", "committedDate": "2020-10-02T07:45:35Z", "message": "[FLINK-19123] Remove unused JobExecutor interfaces\n\nThey were introduced to allow two different MiniCluster implementations\nwhen the \"new\" FLIP-6 code was introduced.\n\nIn the previous commit we changed the TestEnvironments to directly use a\nMiniCluster so these interfaces are not required anymore."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjc1NjA2", "url": "https://github.com/apache/flink/pull/13530#pullrequestreview-501275606", "createdAt": "2020-10-02T16:22:41Z", "commit": {"oid": "6d4b30a92c9dd7b13bf4d906b58b9cf591edf036"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjoyMjo0MVrOHbzzRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjoyOTowN1rOHbz_wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyMjMwOA==", "bodyText": "I tend to prefer enums instead of booleans for parameters because it makes it explicit what true and false means.", "url": "https://github.com/apache/flink/pull/13530#discussion_r498922308", "createdAt": "2020-10-02T16:22:41Z", "author": {"login": "tillrohrmann"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/minicluster/MiniClusterJobClient.java", "diffHunk": "@@ -43,23 +43,30 @@\n /**\n  * A {@link JobClient} for a {@link MiniCluster}.\n  */\n-public final class PerJobMiniClusterJobClient implements JobClient, CoordinationRequestGateway {\n+public final class MiniClusterJobClient implements JobClient, CoordinationRequestGateway {\n \n-\tprivate static final Logger LOG = LoggerFactory.getLogger(PerJobMiniClusterJobClient.class);\n+\tprivate static final Logger LOG = LoggerFactory.getLogger(MiniClusterJobClient.class);\n \n \tprivate final JobID jobID;\n \tprivate final MiniCluster miniCluster;\n-\tprivate final CompletableFuture<JobResult> jobResultFuture;\n \tprivate final ClassLoader classLoader;\n+\tprivate final CompletableFuture<JobResult> jobResultFuture;\n \n-\tpublic PerJobMiniClusterJobClient(JobID jobID, MiniCluster miniCluster, ClassLoader classLoader) {\n+\t/**\n+\t * Creates a {@link MiniClusterJobClient} for the given {@link JobID} and {@link MiniCluster}.\n+\t * This will shut down the {@code MiniCluster} after job result retrieval if {@code\n+\t * shutdownCluster} is {@code true}.\n+\t */\n+\tpublic MiniClusterJobClient(JobID jobID, MiniCluster miniCluster, ClassLoader classLoader, boolean shutdownCluster) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d4b30a92c9dd7b13bf4d906b58b9cf591edf036"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyNTA1OQ==", "bodyText": "I think an extra tab of indentation is probably not correct here.", "url": "https://github.com/apache/flink/pull/13530#discussion_r498925059", "createdAt": "2020-10-02T16:28:14Z", "author": {"login": "tillrohrmann"}, "path": "flink-test-utils-parent/flink-test-utils/src/main/java/org/apache/flink/test/util/TestEnvironment.java", "diffHunk": "@@ -78,58 +63,33 @@ public TestEnvironment(\n \t}\n \n \tpublic TestEnvironment(\n-\t\t\tJobExecutor executor,\n+\t\t\tMiniCluster executor,\n \t\t\tint parallelism,\n \t\t\tboolean isObjectReuseEnabled) {\n \t\tthis(\n-\t\t\texecutor,\n-\t\t\tparallelism,\n-\t\t\tisObjectReuseEnabled,\n-\t\t\tCollections.emptyList(),\n-\t\t\tCollections.emptyList());\n+\t\t\t\texecutor,\n+\t\t\t\tparallelism,\n+\t\t\t\tisObjectReuseEnabled,\n+\t\t\t\tCollections.emptyList(),\n+\t\t\t\tCollections.emptyList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0349d078595fe3b752d4b606413e6bb30e1e18a8"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyNTI4OQ==", "bodyText": "nit: this looks too deeply intended.", "url": "https://github.com/apache/flink/pull/13530#discussion_r498925289", "createdAt": "2020-10-02T16:28:43Z", "author": {"login": "tillrohrmann"}, "path": "flink-test-utils-parent/flink-test-utils/src/main/java/org/apache/flink/test/util/TestEnvironment.java", "diffHunk": "@@ -19,52 +19,37 @@\n package org.apache.flink.test.util;\n \n import org.apache.flink.api.common.JobExecutionResult;\n-import org.apache.flink.api.common.Plan;\n import org.apache.flink.api.java.ExecutionEnvironment;\n import org.apache.flink.api.java.ExecutionEnvironmentFactory;\n-import org.apache.flink.client.deployment.executors.LocalExecutor;\n-import org.apache.flink.configuration.Configuration;\n-import org.apache.flink.configuration.DeploymentOptions;\n import org.apache.flink.core.fs.Path;\n-import org.apache.flink.optimizer.DataStatistics;\n-import org.apache.flink.optimizer.Optimizer;\n-import org.apache.flink.optimizer.plan.OptimizedPlan;\n-import org.apache.flink.optimizer.plantranslate.JobGraphGenerator;\n-import org.apache.flink.runtime.jobgraph.JobGraph;\n-import org.apache.flink.runtime.minicluster.JobExecutor;\n import org.apache.flink.runtime.minicluster.MiniCluster;\n import org.apache.flink.util.Preconditions;\n \n import java.net.URL;\n-import java.util.ArrayList;\n import java.util.Collection;\n import java.util.Collections;\n \n /**\n- * A {@link ExecutionEnvironment} implementation which executes its jobs on a\n- * {@link MiniCluster}.\n+ * A {@link ExecutionEnvironment} implementation which executes its jobs on a {@link MiniCluster}.\n  */\n public class TestEnvironment extends ExecutionEnvironment {\n \n-\tprivate final JobExecutor jobExecutor;\n-\n-\tprivate final Collection<Path> jarFiles;\n-\n-\tprivate final Collection<URL> classPaths;\n+\tprivate final MiniCluster miniCluster;\n \n \tprivate TestEnvironment lastEnv;\n \n \tpublic TestEnvironment(\n-\t\t\tJobExecutor jobExecutor,\n+\t\t\tMiniCluster miniCluster,\n \t\t\tint parallelism,\n \t\t\tboolean isObjectReuseEnabled,\n \t\t\tCollection<Path> jarFiles,\n \t\t\tCollection<URL> classPaths) {\n-\t\tthis.jobExecutor = Preconditions.checkNotNull(jobExecutor);\n-\t\tthis.jarFiles = Preconditions.checkNotNull(jarFiles);\n-\t\tthis.classPaths = Preconditions.checkNotNull(classPaths);\n-\t\tgetConfiguration().set(DeploymentOptions.TARGET, LocalExecutor.NAME);\n-\t\tgetConfiguration().set(DeploymentOptions.ATTACHED, true);\n+\t\tsuper(\n+\t\t\t\tnew MiniClusterPipelineExecutorServiceLoader(miniCluster),\n+\t\t\t\tMiniClusterPipelineExecutorServiceLoader.createConfiguration(jarFiles, classPaths),\n+\t\t\t\tnull);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0349d078595fe3b752d4b606413e6bb30e1e18a8"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyNTUwNQ==", "bodyText": "nit: I am not sure about this indentation here.", "url": "https://github.com/apache/flink/pull/13530#discussion_r498925505", "createdAt": "2020-10-02T16:29:07Z", "author": {"login": "tillrohrmann"}, "path": "flink-test-utils-parent/flink-test-utils/src/main/java/org/apache/flink/test/util/TestEnvironment.java", "diffHunk": "@@ -174,15 +129,15 @@ public ExecutionEnvironment createExecutionEnvironment() {\n \t * environment executes the given jobs on a Flink mini cluster with the given default\n \t * parallelism and the additional jar files and class paths.\n \t *\n-\t * @param jobExecutor The executor to run the jobs on\n+\t * @param miniCluster The MiniCluster to execute jobs on.\n \t * @param parallelism The default parallelism\n \t */\n-\tpublic static void setAsContext(final JobExecutor jobExecutor, final int parallelism) {\n+\tpublic static void setAsContext(final MiniCluster miniCluster, final int parallelism) {\n \t\tsetAsContext(\n-\t\t\tjobExecutor,\n-\t\t\tparallelism,\n-\t\t\tCollections.emptyList(),\n-\t\t\tCollections.emptyList());\n+\t\t\t\tminiCluster,\n+\t\t\t\tparallelism,\n+\t\t\t\tCollections.emptyList(),\n+\t\t\t\tCollections.emptyList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0349d078595fe3b752d4b606413e6bb30e1e18a8"}, "originalPosition": 195}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "443a959cc0cf0ff48cdad25d180d1214f1b4ac74", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/443a959cc0cf0ff48cdad25d180d1214f1b4ac74", "committedDate": "2020-10-05T15:07:18Z", "message": "[FLINK-19123] Move PerJobMiniClusterJobClient to top level"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b336c72a676125d3fe9b6b42d1bc2a8fc99c6868", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/b336c72a676125d3fe9b6b42d1bc2a8fc99c6868", "committedDate": "2020-10-05T15:07:18Z", "message": "[FLINK-19123] Move PerJobMiniClusterJobClient to runtime.minicluster package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a842b684123e42b517d59adb2f0b21d173a105d3", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/a842b684123e42b517d59adb2f0b21d173a105d3", "committedDate": "2020-10-05T15:07:19Z", "message": "[FLINK-19123] Make MiniClusterJobClient shutdown behaviour configurable\n\nWe also rename it from PerJobMiniClusterJobClient to\nMiniClusterJobClient to reflect the change."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9fc140ada79130d11739fb213a6a1c6f1148140", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/f9fc140ada79130d11739fb213a6a1c6f1148140", "committedDate": "2020-10-05T15:07:19Z", "message": "[FLINK-19123] Don't override execute()/executeAsync() in TestStreamEnvironment\n\nInstead, we use a custom PipelineExecutorServiceLoader to inject a\nMiniClusterExecutor. This requires that we directly use MiniCluster\ninstead of the JobExecutor interface in the test environments because we\nneed to use asynchronous job submission. The alternative would be to\nextend the JobExecutor interface to allow async job submission.\n\nWe have to fix OrcFileSystemITCase to actually wait for the job that\nfills the test table to finish because now the async execution method\nreturns too fast."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47ca19a74e11c72842124852875262959477c459", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/47ca19a74e11c72842124852875262959477c459", "committedDate": "2020-10-05T15:07:19Z", "message": "[FLINK-19123] Remove unused JobExecutor interfaces\n\nThey were introduced to allow two different MiniCluster implementations\nwhen the \"new\" FLIP-6 code was introduced.\n\nIn the previous commit we changed the TestEnvironments to directly use a\nMiniCluster so these interfaces are not required anymore."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "88ec25aa3dc2db1f5d35a4351d5a26a5e353c7cc", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/88ec25aa3dc2db1f5d35a4351d5a26a5e353c7cc", "committedDate": "2020-10-05T09:18:57Z", "message": "fixup! undo formatting changes in TestEnvironment"}, "afterCommit": {"oid": "47ca19a74e11c72842124852875262959477c459", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/47ca19a74e11c72842124852875262959477c459", "committedDate": "2020-10-05T15:07:19Z", "message": "[FLINK-19123] Remove unused JobExecutor interfaces\n\nThey were introduced to allow two different MiniCluster implementations\nwhen the \"new\" FLIP-6 code was introduced.\n\nIn the previous commit we changed the TestEnvironments to directly use a\nMiniCluster so these interfaces are not required anymore."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3622, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}