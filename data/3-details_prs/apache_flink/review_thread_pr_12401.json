{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0OTUxNjk4", "number": 12401, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOTozNjowMFrOEA0trQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQwODo0NzozM1rOEBGFtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5Mjk5MTE3OnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/MailboxExecutorImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOTozNjowMFrOGcVxlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOTozNjowMFrOGcVxlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3MDA3MQ==", "bodyText": "@Nullable - but check other comments first (for a better solution)", "url": "https://github.com/apache/flink/pull/12401#discussion_r432370071", "createdAt": "2020-05-29T09:36:00Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/MailboxExecutorImpl.java", "diffHunk": "@@ -43,10 +43,22 @@\n \n \tprivate final StreamTaskActionExecutor actionExecutor;\n \n+\tprivate MailboxProcessor mailboxProcessor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa16f36730c8a0794cfc9aa55bb99dbaa8ef4239"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5Mjk5MzM1OnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/MailboxExecutorImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOTozNjo0MlrOGcVzCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOTozNjo0MlrOGcVzCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3MDQ0MQ==", "bodyText": "mailboxProcessor != null && mailboxProcessor.isDefaultActionUnavailable()?  - but check other comments first (for a better solution)", "url": "https://github.com/apache/flink/pull/12401#discussion_r432370441", "createdAt": "2020-05-29T09:36:42Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/MailboxExecutorImpl.java", "diffHunk": "@@ -43,10 +43,22 @@\n \n \tprivate final StreamTaskActionExecutor actionExecutor;\n \n+\tprivate MailboxProcessor mailboxProcessor;\n+\n \tpublic MailboxExecutorImpl(@Nonnull TaskMailbox mailbox, int priority, StreamTaskActionExecutor actionExecutor) {\n+\t\tthis(mailbox, priority, actionExecutor, null);\n+\t}\n+\n+\tpublic MailboxExecutorImpl(@Nonnull TaskMailbox mailbox, int priority, StreamTaskActionExecutor actionExecutor, MailboxProcessor mailboxProcessor) {\n \t\tthis.mailbox = mailbox;\n \t\tthis.priority = priority;\n \t\tthis.actionExecutor = Preconditions.checkNotNull(actionExecutor);\n+\t\tthis.mailboxProcessor = mailboxProcessor;\n+\t}\n+\n+\tpublic boolean isIdle() {\n+\t\treturn !mailboxProcessor.isMailboxLoopRunning() ||\n+\t\t\t(mailboxProcessor.isDefaultActionUnavailable() && !mailbox.hasMail() && mailbox.getState().isAcceptingMails());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa16f36730c8a0794cfc9aa55bb99dbaa8ef4239"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MzAxNDE3OnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/MailboxProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOTo0MzowOVrOGcWAdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNzowMTozNFrOGck7dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3Mzg3OQ==", "bodyText": "Couple of problems:\n\nit changes an object passed from the outside\nrequires cast (could be solved by changing the signature of the constructor)\n\nI'm thinking that maybe a better solution is to get rid of the mainMailboxExecutor and replace getter getMainMailboxExecutor with:\n\tpublic MailboxExecutor getMainMailboxExecutor() {\n\t\treturn new MailboxExecutorImpl(mailbox, MIN_PRIORITY, actionExecutor, this);\n\t}\n\nplus caching access to mailboxProcessor.getMainMailboxExecutor() inside StreamTask via creating a field in  StreamTask: private final MailboxExecutor mainMailboxExecutor?\nThis would solve the problem of circular dependency and nullable non final field inside MailboxExecutorImpl.\nWDYT?", "url": "https://github.com/apache/flink/pull/12401#discussion_r432373879", "createdAt": "2020-05-29T09:43:09Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/MailboxProcessor.java", "diffHunk": "@@ -114,6 +114,7 @@ public MailboxProcessor(\n \t\tthis.actionExecutor = Preconditions.checkNotNull(actionExecutor);\n \t\tthis.mailbox = Preconditions.checkNotNull(mailbox);\n \t\tthis.mainMailboxExecutor = Preconditions.checkNotNull(mainMailboxExecutor);\n+\t\t((MailboxExecutorImpl) this.mainMailboxExecutor).setMailboxProcessor(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa16f36730c8a0794cfc9aa55bb99dbaa8ef4239"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYxODM1OA==", "bodyText": "Good idea!\nRemoved MailboxProcessor.mainMailboxExecutor field.", "url": "https://github.com/apache/flink/pull/12401#discussion_r432618358", "createdAt": "2020-05-29T17:01:34Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/MailboxProcessor.java", "diffHunk": "@@ -114,6 +114,7 @@ public MailboxProcessor(\n \t\tthis.actionExecutor = Preconditions.checkNotNull(actionExecutor);\n \t\tthis.mailbox = Preconditions.checkNotNull(mailbox);\n \t\tthis.mainMailboxExecutor = Preconditions.checkNotNull(mainMailboxExecutor);\n+\t\t((MailboxExecutorImpl) this.mainMailboxExecutor).setMailboxProcessor(this);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3Mzg3OQ=="}, "originalCommit": {"oid": "fa16f36730c8a0794cfc9aa55bb99dbaa8ef4239"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MzAyMTM0OnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/source/ContinuousFileReaderOperator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOTo0NToyMVrOGcWFJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOTo0NToyMVrOGcWFJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NTA3OA==", "bodyText": "nit: I would be slightly in favour of adding this method to the MailboxExecutor interface, but if you think opposite let it be for now.", "url": "https://github.com/apache/flink/pull/12401#discussion_r432375078", "createdAt": "2020-05-29T09:45:21Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/source/ContinuousFileReaderOperator.java", "diffHunk": "@@ -311,17 +312,19 @@ private void enqueueProcessRecord() {\n \t}\n \n \tprivate void processRecord() throws IOException {\n-\t\tif (!state.prepareToProcessRecord(this)) {\n-\t\t\treturn;\n-\t\t}\n+\t\tdo {\n+\t\t\tif (!state.prepareToProcessRecord(this)) {\n+\t\t\t\treturn;\n+\t\t\t}\n \n-\t\treadAndCollectRecord();\n+\t\t\treadAndCollectRecord();\n \n-\t\tif (format.reachedEnd()) {\n-\t\t\tonSplitProcessed();\n-\t\t} else {\n-\t\t\tenqueueProcessRecord();\n-\t\t}\n+\t\t\tif (format.reachedEnd()) {\n+\t\t\t\tonSplitProcessed();\n+\t\t\t\treturn;\n+\t\t\t}\n+\t\t} while (executor.isIdle()); // todo: consider moving this loop into MailboxProcessor (return boolean \"re-execute\" from enqueued action)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa16f36730c8a0794cfc9aa55bb99dbaa8ef4239"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MzAyNDYwOnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/MailboxExecutorImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOTo0NjoxOVrOGcWHFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOTo0NjoxOVrOGcWHFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NTU3NQ==", "bodyText": "revert this change?", "url": "https://github.com/apache/flink/pull/12401#discussion_r432375575", "createdAt": "2020-05-29T09:46:19Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/MailboxExecutorImpl.java", "diffHunk": "@@ -50,7 +50,7 @@ public MailboxExecutorImpl(@Nonnull TaskMailbox mailbox, int priority, StreamTas\n \t}\n \n \tpublic MailboxExecutorImpl(@Nonnull TaskMailbox mailbox, int priority, StreamTaskActionExecutor actionExecutor, MailboxProcessor mailboxProcessor) {\n-\t\tthis.mailbox = mailbox;\n+\t\tthis.mailbox = (TaskMailboxImpl) mailbox;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ae178ffebe69903ebe8d09bdd8709c299c86dc0"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NTgzNzk4OnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQwODo0NzozM1rOGcxerA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwNzoyMDo1OVrOGdlIYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgyMzk4MA==", "bodyText": "I was thinking about doing here:\nthis.mainMailboxExecutor = mailboxProcessor.getMainMailboxExecutor();\n\nor\nthis.mainMailboxExecutor = mailboxProcessor.getMinPriorityMailboxExecutor();\n\nto maintain the contract, that everything goes via MailboxProcessor one way or another.\nAs it is now, some actions are going via mailbox and actionExecutor bypassing the processor, which I'm not sure if it's as clean? But I'm not entirely sure.", "url": "https://github.com/apache/flink/pull/12401#discussion_r432823980", "createdAt": "2020-05-30T08:47:33Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java", "diffHunk": "@@ -276,6 +281,7 @@ protected StreamTask(\n \t\tthis.actionExecutor = Preconditions.checkNotNull(actionExecutor);\n \t\tthis.mailboxProcessor = new MailboxProcessor(this::processInput, mailbox, actionExecutor);\n \t\tthis.mailboxProcessor.initMetric(environment.getMetricGroup());\n+\t\tthis.mainMailboxExecutor = new MailboxExecutorImpl(mailbox, MIN_PRIORITY, actionExecutor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "810c8f3a23dd3bdf402bd7659f972b741d1fce8d"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY3MDI0MA==", "bodyText": "Done.", "url": "https://github.com/apache/flink/pull/12401#discussion_r433670240", "createdAt": "2020-06-02T07:20:59Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java", "diffHunk": "@@ -276,6 +281,7 @@ protected StreamTask(\n \t\tthis.actionExecutor = Preconditions.checkNotNull(actionExecutor);\n \t\tthis.mailboxProcessor = new MailboxProcessor(this::processInput, mailbox, actionExecutor);\n \t\tthis.mailboxProcessor.initMetric(environment.getMetricGroup());\n+\t\tthis.mainMailboxExecutor = new MailboxExecutorImpl(mailbox, MIN_PRIORITY, actionExecutor);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgyMzk4MA=="}, "originalCommit": {"oid": "810c8f3a23dd3bdf402bd7659f972b741d1fce8d"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4493, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}