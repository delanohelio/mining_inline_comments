{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0NjAwNTE3", "number": 12826, "title": "[FLINK-18419] Create catalog in TableEnvironment using user classloader ", "bodyText": "What is the purpose of the change\nFix creating a catalog with DDL when the catalog implementation comes from a user jar.\nBrief change log\n\nMake user classloader available in TableEnvironmentImpl\nMove instantiation of the catalog to the point when CreateCatalogOperation is executed\nUse the user classloader when creating a catalog from DDL\n\nVerifying this change\n\nAdded test testCreateCatalogFromUserClassLoader\nTry creating a catalog from a sql-client with the catalog dependencies are passed with the -j parameter.\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-07-06T07:47:51Z", "url": "https://github.com/apache/flink/pull/12826", "merged": true, "mergeCommit": {"oid": "69ef4b7cffb446cca655f7c426a49d9fbb3a8cc3"}, "closed": true, "closedAt": "2020-07-10T07:09:03Z", "author": {"login": "dawidwys"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxUJeGgH2gAyNDQ0NjAwNTE3Ojc5OGY5YWZkMGIxM2VjZTNhZWI3MThmYjI5ZWI2NzMxYWUyN2NhNjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczPOGmAFqTQ0NTYyNTc0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "798f9afd0b13ece3aeb718fb29eb6731ae27ca62", "author": {"user": {"login": "dawidwys", "name": "Dawid Wysakowicz"}}, "url": "https://github.com/apache/flink/commit/798f9afd0b13ece3aeb718fb29eb6731ae27ca62", "committedDate": "2020-07-03T14:16:49Z", "message": "[hotfix] Extend ClassLoaderUtils with a way to add resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de2d51a6b9b75f343b7d21b4bc0aaa1a842b26b1", "author": {"user": {"login": "dawidwys", "name": "Dawid Wysakowicz"}}, "url": "https://github.com/apache/flink/commit/de2d51a6b9b75f343b7d21b4bc0aaa1a842b26b1", "committedDate": "2020-07-03T14:30:34Z", "message": "[FLINK-18419] Make user ClassLoader available in TableEnvironment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0691185bcfe408b32b0f61a2bb2313c04c69b0e2", "author": {"user": {"login": "dawidwys", "name": "Dawid Wysakowicz"}}, "url": "https://github.com/apache/flink/commit/0691185bcfe408b32b0f61a2bb2313c04c69b0e2", "committedDate": "2020-07-03T14:31:23Z", "message": "[FLINK-18419] Create catalog in TableEnvironment using user ClassLoader"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NDA1MDc1", "url": "https://github.com/apache/flink/pull/12826#pullrequestreview-445405075", "createdAt": "2020-07-09T08:37:35Z", "commit": {"oid": "0691185bcfe408b32b0f61a2bb2313c04c69b0e2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NDY1ODY0", "url": "https://github.com/apache/flink/pull/12826#pullrequestreview-445465864", "createdAt": "2020-07-09T09:56:48Z", "commit": {"oid": "0691185bcfe408b32b0f61a2bb2313c04c69b0e2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwOTo1Njo0OFrOGvKM3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwOTo1Njo0OFrOGvKM3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEwMzM5MQ==", "bodyText": "This case can run successfully even without the commit [FLINK-18419] Create catalog in TableEnvironment using user ClassLoader. Because TemporaryClassLoaderContext.of method sets the user classloader to the current thread, and TableFactoryService#discoverFactories method will use the classloader in the current thread to find factories.", "url": "https://github.com/apache/flink/pull/12826#discussion_r452103391", "createdAt": "2020-07-09T09:56:48Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/test/java/org/apache/flink/table/planner/catalog/CatalogITCase.java", "diffHunk": "@@ -61,9 +70,54 @@ public void testDropCatalog() {\n \t\tassertFalse(tableEnv.getCatalog(name).isPresent());\n \t}\n \n+\t@Test\n+\tpublic void testCreateCatalogFromUserClassLoader() throws Exception {\n+\t\tfinal String className = \"UserCatalogFactory\";\n+\t\tURLClassLoader classLoader = ClassLoaderUtils.withRoot(temporaryFolder.newFolder())\n+\t\t\t.addResource(\"META-INF/services/org.apache.flink.table.factories.TableFactory\", \"UserCatalogFactory\")\n+\t\t\t.addClass(\n+\t\t\t\tclassName,\n+\t\t\t\t\"import org.apache.flink.table.catalog.GenericInMemoryCatalog;\\n\" +\n+\t\t\t\t\t\"import org.apache.flink.table.factories.CatalogFactory;\\n\" +\n+\t\t\t\t\t\"import java.util.Collections;\\n\" +\n+\t\t\t\t\t\"import org.apache.flink.table.catalog.Catalog;\\n\" +\n+\t\t\t\t\t\"import java.util.HashMap;\\n\" +\n+\t\t\t\t\t\"import java.util.List;\\n\" +\n+\t\t\t\t\t\"import java.util.Map;\\n\" +\n+\t\t\t\t\t\"\\tpublic class UserCatalogFactory implements CatalogFactory {\\n\" +\n+\t\t\t\t\t\"\\t\\t@Override\\n\" +\n+\t\t\t\t\t\"\\t\\tpublic Catalog createCatalog(\\n\" +\n+\t\t\t\t\t\"\\t\\t\\t\\tString name,\\n\" +\n+\t\t\t\t\t\"\\t\\t\\t\\tMap<String, String> properties) {\\n\" +\n+\t\t\t\t\t\"\\t\\t\\treturn new GenericInMemoryCatalog(name);\\n\" +\n+\t\t\t\t\t\"\\t\\t}\\n\" +\n+\t\t\t\t\t\"\\n\" +\n+\t\t\t\t\t\"\\t\\t@Override\\n\" +\n+\t\t\t\t\t\"\\t\\tpublic Map<String, String> requiredContext() {\\n\" +\n+\t\t\t\t\t\"\\t\\t\\tHashMap<String, String> hashMap = new HashMap<>();\\n\" +\n+\t\t\t\t\t\"\\t\\t\\thashMap.put(\\\"type\\\", \\\"userCatalog\\\");\\n\" +\n+\t\t\t\t\t\"\\t\\t\\treturn hashMap;\\n\" +\n+\t\t\t\t\t\"\\t\\t}\\n\" +\n+\t\t\t\t\t\"\\n\" +\n+\t\t\t\t\t\"\\t\\t@Override\\n\" +\n+\t\t\t\t\t\"\\t\\tpublic List<String> supportedProperties() {\\n\" +\n+\t\t\t\t\t\"\\t\\t\\treturn Collections.emptyList();\\n\" +\n+\t\t\t\t\t\"\\t\\t}\\n\" +\n+\t\t\t\t\t\"\\t}\"\n+\t\t\t).build();\n+\n+\t\ttry (TemporaryClassLoaderContext context = TemporaryClassLoaderContext.of(classLoader)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0691185bcfe408b32b0f61a2bb2313c04c69b0e2"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NjI1NzQy", "url": "https://github.com/apache/flink/pull/12826#pullrequestreview-445625742", "createdAt": "2020-07-09T13:40:12Z", "commit": {"oid": "0691185bcfe408b32b0f61a2bb2313c04c69b0e2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3051, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}