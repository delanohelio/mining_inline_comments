{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1ODU0NjEz", "number": 11814, "title": "[FLINK-17218][tests] Adding recoverable failures and correctness chec\u2026", "bodyText": "\u2026ks to UnalignedCheckpointITCase.\n\nWhat is the purpose of the change\nThis pull request adds recovery logic and verification to integration tests of unaligned checkpoints.\nBrief change log\n\nExpand the UnalignedCheckpointITCase with induced failures, recovery, and correctness checks.\n\nVerifying this change\nOnly changes in tests.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-04-20T06:27:47Z", "url": "https://github.com/apache/flink/pull/11814", "merged": true, "mergeCommit": {"oid": "cd1f858b5b69a6722dabd8491d1c327a086a719d"}, "closed": true, "closedAt": "2020-05-15T17:22:35Z", "author": {"login": "AHeise"}, "timelineItems": {"totalCount": 32, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaCmkXgBqjMyNTkwOTYzNDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchgN0FAFqTQxMjU1ODkyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b64d49dac7f89d4abf600fda1d7beb5b34d3fc5", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/2b64d49dac7f89d4abf600fda1d7beb5b34d3fc5", "committedDate": "2020-04-20T06:25:12Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}, "afterCommit": {"oid": "8e840d32b0adfc38e039e7194f6938c9188d8e0a", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/8e840d32b0adfc38e039e7194f6938c9188d8e0a", "committedDate": "2020-04-21T18:31:11Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e840d32b0adfc38e039e7194f6938c9188d8e0a", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/8e840d32b0adfc38e039e7194f6938c9188d8e0a", "committedDate": "2020-04-21T18:31:11Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}, "afterCommit": {"oid": "e69396820172b1a22786b1f533999eb401b44244", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/e69396820172b1a22786b1f533999eb401b44244", "committedDate": "2020-04-22T06:53:52Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e69396820172b1a22786b1f533999eb401b44244", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/e69396820172b1a22786b1f533999eb401b44244", "committedDate": "2020-04-22T06:53:52Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}, "afterCommit": {"oid": "3c40823bc020362db1808d744481c5e77f59340e", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/3c40823bc020362db1808d744481c5e77f59340e", "committedDate": "2020-04-22T06:58:58Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c40823bc020362db1808d744481c5e77f59340e", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/3c40823bc020362db1808d744481c5e77f59340e", "committedDate": "2020-04-22T06:58:58Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}, "afterCommit": {"oid": "186430ff68a28ee39cff541c61dfc76dd4332375", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/186430ff68a28ee39cff541c61dfc76dd4332375", "committedDate": "2020-04-22T11:30:15Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "186430ff68a28ee39cff541c61dfc76dd4332375", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/186430ff68a28ee39cff541c61dfc76dd4332375", "committedDate": "2020-04-22T11:30:15Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}, "afterCommit": {"oid": "f474d64516f4f472100d5d9783767a62e7d4d097", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/f474d64516f4f472100d5d9783767a62e7d4d097", "committedDate": "2020-04-22T13:28:06Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f474d64516f4f472100d5d9783767a62e7d4d097", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/f474d64516f4f472100d5d9783767a62e7d4d097", "committedDate": "2020-04-22T13:28:06Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}, "afterCommit": {"oid": "1e0c61b438830bd4d377ae16f7f8d2b1bc0ce047", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/1e0c61b438830bd4d377ae16f7f8d2b1bc0ce047", "committedDate": "2020-04-22T14:11:51Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e0c61b438830bd4d377ae16f7f8d2b1bc0ce047", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/1e0c61b438830bd4d377ae16f7f8d2b1bc0ce047", "committedDate": "2020-04-22T14:11:51Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}, "afterCommit": {"oid": "c49c41e5b98a8e48b35d880552e6da17888c93dc", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/c49c41e5b98a8e48b35d880552e6da17888c93dc", "committedDate": "2020-04-25T19:16:41Z", "message": "[temp] Lots of debug"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c49c41e5b98a8e48b35d880552e6da17888c93dc", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/c49c41e5b98a8e48b35d880552e6da17888c93dc", "committedDate": "2020-04-25T19:16:41Z", "message": "[temp] Lots of debug"}, "afterCommit": {"oid": "161c6e917c3797cfdbae58954576d0a03ab38b42", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/161c6e917c3797cfdbae58954576d0a03ab38b42", "committedDate": "2020-04-25T19:22:21Z", "message": "[temp] Lots of debug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDUzNTg4", "url": "https://github.com/apache/flink/pull/11814#pullrequestreview-400453588", "createdAt": "2020-04-26T03:26:54Z", "commit": {"oid": "42653324e6245cf58b547928f0b90d151fcf8f48"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQwMzoyNjo1NFrOGL99Rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQwMzoyNjo1NFrOGL99Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTIwMjYzMA==", "bodyText": "Thanks for finding this bug!\nI think the root cause was the state inconsistency among {leftOverLimit, leftOverStart} with leftOverData. During #clear() we only reset leftOverData as null, but now reset the derived {leftOverLimit, leftOverStart} from leftOverData. So we have to check the condition only by leftOverData here. Another option is also to reset {leftOverLimit, leftOverStart} during #clear() to keep all consistency.", "url": "https://github.com/apache/flink/pull/11814#discussion_r415202630", "createdAt": "2020-04-26T03:26:54Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/serialization/SpillingAdaptiveSpanningRecordDeserializer.java", "diffHunk": "@@ -597,12 +597,12 @@ private void addNextChunkFromMemorySegment(MemorySegment segment, int offset, in\n \t\t\t\tthrow new UnsupportedOperationException(\"Unaligned checkpoint currently do not support spilled \" +\n \t\t\t\t\t\"records.\");\n \t\t\t} else if (recordLength != -1) {\n-\t\t\t\tint leftOverSize = leftOverLimit - leftOverStart;\n+\t\t\t\tint leftOverSize = leftOverData != null ? leftOverLimit - leftOverStart : 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42653324e6245cf58b547928f0b90d151fcf8f48"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "161c6e917c3797cfdbae58954576d0a03ab38b42", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/161c6e917c3797cfdbae58954576d0a03ab38b42", "committedDate": "2020-04-25T19:22:21Z", "message": "[temp] Lots of debug"}, "afterCommit": {"oid": "cbca6f0d98e1cb9e1a60086a32a9c058150fa97b", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/cbca6f0d98e1cb9e1a60086a32a9c058150fa97b", "committedDate": "2020-04-27T12:09:56Z", "message": "[temp] Lots of debug"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a2d006dd6d8084ccd6ad6b68046d1e037088b2ad", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/a2d006dd6d8084ccd6ad6b68046d1e037088b2ad", "committedDate": "2020-04-27T18:55:01Z", "message": "[temp?] Disable priority event listener"}, "afterCommit": {"oid": "0118f76b444e2347aa3b5f30d2e1800962a42427", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/0118f76b444e2347aa3b5f30d2e1800962a42427", "committedDate": "2020-04-29T15:29:04Z", "message": "[temp] Lots of debug"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0118f76b444e2347aa3b5f30d2e1800962a42427", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/0118f76b444e2347aa3b5f30d2e1800962a42427", "committedDate": "2020-04-29T15:29:04Z", "message": "[temp] Lots of debug"}, "afterCommit": {"oid": "d2440367edb82698de508066a900555739b7cafb", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/d2440367edb82698de508066a900555739b7cafb", "committedDate": "2020-04-29T19:27:41Z", "message": "[temp] Lots of debug"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2440367edb82698de508066a900555739b7cafb", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/d2440367edb82698de508066a900555739b7cafb", "committedDate": "2020-04-29T19:27:41Z", "message": "[temp] Lots of debug"}, "afterCommit": {"oid": "6abf4ce6e94c0b9d16370bc58381c4e4c3951267", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/6abf4ce6e94c0b9d16370bc58381c4e4c3951267", "committedDate": "2020-04-29T20:35:26Z", "message": "[temp] Lots of debug"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6abf4ce6e94c0b9d16370bc58381c4e4c3951267", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/6abf4ce6e94c0b9d16370bc58381c4e4c3951267", "committedDate": "2020-04-29T20:35:26Z", "message": "[temp] Lots of debug"}, "afterCommit": {"oid": "1d73dbf463d9f7e88d1899502d38d3a112b19647", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/1d73dbf463d9f7e88d1899502d38d3a112b19647", "committedDate": "2020-04-30T06:37:13Z", "message": "[temp] Lots of debug"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1d73dbf463d9f7e88d1899502d38d3a112b19647", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/1d73dbf463d9f7e88d1899502d38d3a112b19647", "committedDate": "2020-04-30T06:37:13Z", "message": "[temp] Lots of debug"}, "afterCommit": {"oid": "0ea51bf82cd4ac18d8003632cd4b817ca3223008", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/0ea51bf82cd4ac18d8003632cd4b817ca3223008", "committedDate": "2020-04-30T07:31:19Z", "message": "[temp] Lots of debug"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ea51bf82cd4ac18d8003632cd4b817ca3223008", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/0ea51bf82cd4ac18d8003632cd4b817ca3223008", "committedDate": "2020-04-30T07:31:19Z", "message": "[temp] Lots of debug"}, "afterCommit": {"oid": "f239d680e9b8f3f5ace621b7806e0bb7e14d3fdd", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/f239d680e9b8f3f5ace621b7806e0bb7e14d3fdd", "committedDate": "2020-04-30T20:12:43Z", "message": "[temp] Lots of debug"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f239d680e9b8f3f5ace621b7806e0bb7e14d3fdd", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/f239d680e9b8f3f5ace621b7806e0bb7e14d3fdd", "committedDate": "2020-04-30T20:12:43Z", "message": "[temp] Lots of debug"}, "afterCommit": {"oid": "1644392eb3e33382aa22ad51ecae555c64126c5f", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/1644392eb3e33382aa22ad51ecae555c64126c5f", "committedDate": "2020-05-12T21:55:20Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1644392eb3e33382aa22ad51ecae555c64126c5f", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/1644392eb3e33382aa22ad51ecae555c64126c5f", "committedDate": "2020-05-12T21:55:20Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}, "afterCommit": {"oid": "b65da8bfe23d55c5280799a579c19895701d7ce5", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/b65da8bfe23d55c5280799a579c19895701d7ce5", "committedDate": "2020-05-13T08:09:41Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b65da8bfe23d55c5280799a579c19895701d7ce5", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/b65da8bfe23d55c5280799a579c19895701d7ce5", "committedDate": "2020-05-13T08:09:41Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}, "afterCommit": {"oid": "d9df481e7ac96ad50b4ed1925aad7a1d09058604", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/d9df481e7ac96ad50b4ed1925aad7a1d09058604", "committedDate": "2020-05-13T12:17:26Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83f26b5a797355f9c0f485e09d403a4516f8fead", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/83f26b5a797355f9c0f485e09d403a4516f8fead", "committedDate": "2020-05-14T06:30:12Z", "message": "[hotfix][checkpointing] Cleaning up ChannelStateWriter state after sync checkpoint failure."}, "afterCommit": {"oid": "ff781564fa208312e8be7d57f99430dc26080bcc", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/ff781564fa208312e8be7d57f99430dc26080bcc", "committedDate": "2020-05-14T13:35:42Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff781564fa208312e8be7d57f99430dc26080bcc", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/ff781564fa208312e8be7d57f99430dc26080bcc", "committedDate": "2020-05-14T13:35:42Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}, "afterCommit": {"oid": "fee2a79881ee92f2200b130a6133dc4e763e77dd", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/fee2a79881ee92f2200b130a6133dc4e763e77dd", "committedDate": "2020-05-14T16:42:26Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fee2a79881ee92f2200b130a6133dc4e763e77dd", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/fee2a79881ee92f2200b130a6133dc4e763e77dd", "committedDate": "2020-05-14T16:42:26Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}, "afterCommit": {"oid": "72db310d8d648cb662f9161af83ec13255e747c8", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/72db310d8d648cb662f9161af83ec13255e747c8", "committedDate": "2020-05-14T16:48:56Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "72db310d8d648cb662f9161af83ec13255e747c8", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/72db310d8d648cb662f9161af83ec13255e747c8", "committedDate": "2020-05-14T16:48:56Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}, "afterCommit": {"oid": "2bc36cbe132b1f0c5ecc026edda07ecc143970e0", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/2bc36cbe132b1f0c5ecc026edda07ecc143970e0", "committedDate": "2020-05-14T17:00:49Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bc36cbe132b1f0c5ecc026edda07ecc143970e0", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/2bc36cbe132b1f0c5ecc026edda07ecc143970e0", "committedDate": "2020-05-14T17:00:49Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}, "afterCommit": {"oid": "0e5c18befed1d83308beb55c0e426b3c5f14eebe", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/0e5c18befed1d83308beb55c0e426b3c5f14eebe", "committedDate": "2020-05-14T18:26:31Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMDI4MTc4", "url": "https://github.com/apache/flink/pull/11814#pullrequestreview-412028178", "createdAt": "2020-05-14T17:24:14Z", "commit": {"oid": "2e688933309bb8c7476facd2b7e6a52da74ede67"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNzoyNDoxNFrOGVmtag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNzoyNDo0N1rOGVmulw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMwNzQ5OA==", "bodyText": "#8693 will add extra notifyCheckpointAborted that we could use here. I guess it's a race which PR is going to be merged first.", "url": "https://github.com/apache/flink/pull/11814#discussion_r425307498", "createdAt": "2020-05-14T17:24:14Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -189,6 +188,7 @@ private void cleanup(\n \t\t\tCheckpointMetrics metrics, CheckpointOptions options,\n \t\t\tException ex) throws Exception {\n \n+\t\tchannelStateWriter.abort(metadata.getCheckpointId(), ex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e688933309bb8c7476facd2b7e6a52da74ede67"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMwNzc5OQ==", "bodyText": "nit: I guess it's no longer notifyCheckpointComplete, but finishedWriting(...)?", "url": "https://github.com/apache/flink/pull/11814#discussion_r425307799", "createdAt": "2020-05-14T17:24:47Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -240,7 +240,8 @@ private void finishAndReportAsync(Map<OperatorID, OperatorSnapshotFutures> snaps\n \t\tfinal Future<?> channelWrittenFuture;\n \t\tif (unalignedCheckpointEnabled) {\n \t\t\tChannelStateWriteResult writeResult = channelStateWriter.getWriteResult(metadata.getCheckpointId());\n-\t\t\tchannelWrittenFuture = writeResult.getJointFuture();\n+\t\t\tchannelWrittenFuture = writeResult.getJointFuture()\n+\t\t\t\t.whenComplete((dummy, ex) -> channelStateWriter.notifyCheckpointComplete(metadata.getCheckpointId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e688933309bb8c7476facd2b7e6a52da74ede67"}, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0e5c18befed1d83308beb55c0e426b3c5f14eebe", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/0e5c18befed1d83308beb55c0e426b3c5f14eebe", "committedDate": "2020-05-14T18:26:31Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}, "afterCommit": {"oid": "7be02873084fae3c416270044162f98a0193230e", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/7be02873084fae3c416270044162f98a0193230e", "committedDate": "2020-05-14T19:48:32Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7be02873084fae3c416270044162f98a0193230e", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/7be02873084fae3c416270044162f98a0193230e", "committedDate": "2020-05-14T19:48:32Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}, "afterCommit": {"oid": "b9f7b7cf2702efc6e11f69a820e9ab4a8f2a60cb", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/b9f7b7cf2702efc6e11f69a820e9ab4a8f2a60cb", "committedDate": "2020-05-15T06:00:58Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29aed91c6b7319398eb972ad51bd581e9f2e8ea8", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/29aed91c6b7319398eb972ad51bd581e9f2e8ea8", "committedDate": "2020-05-15T08:54:02Z", "message": "[FLINK-17218][checkpointing] Ensuring that ChannelStateWriter aborts previous checkpoints before a new checkpoint is started."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ee814ce07ebc6054d06eaaa587f76a8e2bf51f8", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/9ee814ce07ebc6054d06eaaa587f76a8e2bf51f8", "committedDate": "2020-05-15T08:54:02Z", "message": "[FLINK-17218][checkpointing] Cleaning up ChannelStateWriter state after all data has been written and after sync checkpoint failure."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd4011ecc3dc8bb29d4d365dcb00f0b7505b6832", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/bd4011ecc3dc8bb29d4d365dcb00f0b7505b6832", "committedDate": "2020-05-15T08:54:02Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b9f7b7cf2702efc6e11f69a820e9ab4a8f2a60cb", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/b9f7b7cf2702efc6e11f69a820e9ab4a8f2a60cb", "committedDate": "2020-05-15T06:00:58Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}, "afterCommit": {"oid": "bd4011ecc3dc8bb29d4d365dcb00f0b7505b6832", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/bd4011ecc3dc8bb29d4d365dcb00f0b7505b6832", "committedDate": "2020-05-15T08:54:02Z", "message": "[FLINK-17218][tests] Adding recoverable failures and correctness checks to UnalignedCheckpointITCase."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNTU4OTIx", "url": "https://github.com/apache/flink/pull/11814#pullrequestreview-412558921", "createdAt": "2020-05-15T11:17:38Z", "commit": {"oid": "bd4011ecc3dc8bb29d4d365dcb00f0b7505b6832"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMToxNzozOFrOGWAvvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMToxNzozOFrOGWAvvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTczNDA3OQ==", "bodyText": "I guess the below Preconditions.checkState(results.size() < maxCheckpoints, \"results.size() > maxCheckpoints\", results.size(), maxCheckpoints); might be invalid if we remove the old ones here?", "url": "https://github.com/apache/flink/pull/11814#discussion_r425734079", "createdAt": "2020-05-15T11:17:38Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateWriterImpl.java", "diffHunk": "@@ -91,6 +91,7 @@ public ChannelStateWriterImpl(CheckpointStorageWorkerView streamFactoryResolver)\n \n \t@Override\n \tpublic void start(long checkpointId, CheckpointOptions checkpointOptions) {\n+\t\tresults.keySet().forEach(oldCheckpointId -> abort(oldCheckpointId, new Exception(\"Starting new checkpoint \" + checkpointId)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd4011ecc3dc8bb29d4d365dcb00f0b7505b6832"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1916, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}