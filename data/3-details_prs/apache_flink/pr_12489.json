{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3OTU2ODUz", "number": 12489, "title": "[FLINK-18136] Don't start channel state writing for savepoints (RPC)", "bodyText": "What is the purpose of the change\nStreamTask.triggerCheckpoint calls channelStateWriter.start unconditionally.\nFor savepoints and when unaligned mode is disabled this is incorrect.\nBrief change log\n\nadd subtaskCheckpointCoordinator.initCheckpoint and use it in StreamTask\nreplace ChannelStateWriter with SubtaskCheckpointCoordinator in Barrierhandler and call initCheckpoint there too; this change is optional in terms of correctness\n\nVerifying this change\n\nAdded SubtaskCheckpointCoordinatorTest.testInitCheckpoint (unit test)\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? no", "createdAt": "2020-06-04T16:34:01Z", "url": "https://github.com/apache/flink/pull/12489", "merged": true, "mergeCommit": {"oid": "6dc624d931858e0ee5da14bc6b41b834c94cbba7"}, "closed": true, "closedAt": "2020-06-09T08:58:47Z", "author": {"login": "rkhachatryan"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoB0DkgBqjM0MDgwMzg0Nzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpNmbZgBqjM0MTkyOTUzNzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5136fc6b80380c9ff9be14c67d6a286dbac118a5", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/5136fc6b80380c9ff9be14c67d6a286dbac118a5", "committedDate": "2020-06-04T16:21:28Z", "message": "[FLINK-18136] Use initCheckpoint in CheckpointBarrierUnaligner"}, "afterCommit": {"oid": "53b83b75e1f9023ea0ee96b42ca9f6d53af183bb", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/53b83b75e1f9023ea0ee96b42ca9f6d53af183bb", "committedDate": "2020-06-04T17:49:32Z", "message": "[FLINK-18136] Use initCheckpoint in CheckpointBarrierUnaligner"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53b83b75e1f9023ea0ee96b42ca9f6d53af183bb", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/53b83b75e1f9023ea0ee96b42ca9f6d53af183bb", "committedDate": "2020-06-04T17:49:32Z", "message": "[FLINK-18136] Use initCheckpoint in CheckpointBarrierUnaligner"}, "afterCommit": {"oid": "96626c47c1a15025a0c240aac2a45d04a29f0120", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/96626c47c1a15025a0c240aac2a45d04a29f0120", "committedDate": "2020-06-04T17:51:10Z", "message": "[FLINK-18136] Use initCheckpoint in CheckpointBarrierUnaligner"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDYwNzI0", "url": "https://github.com/apache/flink/pull/12489#pullrequestreview-425060724", "createdAt": "2020-06-05T07:33:44Z", "commit": {"oid": "96651fc6d199bad117ee85669e3b04029f64d2e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzozMzo0NVrOGfjgHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzozMzo0NVrOGfjgHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0MDcwMw==", "bodyText": "nit: can use new TestCheckpointStorageWorkerView(100) for simple.", "url": "https://github.com/apache/flink/pull/12489#discussion_r435740703", "createdAt": "2020-06-05T07:33:45Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorTest.java", "diffHunk": "@@ -373,4 +405,35 @@ public void processWatermark(Watermark mark) throws Exception {\n \t\tpublic void processLatencyMarker(LatencyMarker latencyMarker) {\n \t\t}\n \t}\n+\n+\tprivate static SubtaskCheckpointCoordinator coordinator(boolean unalignedCheckpointEnabled, ChannelStateWriter channelStateWriter) throws IOException {\n+\t\treturn new SubtaskCheckpointCoordinatorImpl(\n+\t\t\tcheckpointStorageWorkerView(100),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96651fc6d199bad117ee85669e3b04029f64d2e3"}, "originalPosition": 83}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDYwODAz", "url": "https://github.com/apache/flink/pull/12489#pullrequestreview-425060803", "createdAt": "2020-06-05T07:33:53Z", "commit": {"oid": "96651fc6d199bad117ee85669e3b04029f64d2e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzozMzo1M1rOGfjgUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzozMzo1M1rOGfjgUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0MDc1Mw==", "bodyText": "nit: checkNotNull(channelStateWriter)", "url": "https://github.com/apache/flink/pull/12489#discussion_r435740753", "createdAt": "2020-06-05T07:33:53Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -142,7 +166,7 @@\n \t\tthis.env = checkNotNull(env);\n \t\tthis.asyncExceptionHandler = checkNotNull(asyncExceptionHandler);\n \t\tthis.actionExecutor = checkNotNull(actionExecutor);\n-\t\tthis.channelStateWriter = unalignedCheckpointEnabled ? openChannelStateWriter() : ChannelStateWriter.NO_OP;\n+\t\tthis.channelStateWriter = channelStateWriter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96651fc6d199bad117ee85669e3b04029f64d2e3"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDYwODQz", "url": "https://github.com/apache/flink/pull/12489#pullrequestreview-425060843", "createdAt": "2020-06-05T07:33:57Z", "commit": {"oid": "96651fc6d199bad117ee85669e3b04029f64d2e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzozMzo1N1rOGfjgbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzozMzo1N1rOGfjgbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0MDc4MQ==", "bodyText": "nit: checkpointStorage argument also in separate line", "url": "https://github.com/apache/flink/pull/12489#discussion_r435740781", "createdAt": "2020-06-05T07:33:57Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -134,6 +132,32 @@\n \t\t\tboolean unalignedCheckpointEnabled,\n \t\t\tBiFunctionWithException<ChannelStateWriter, Long, CompletableFuture<Void>, IOException> prepareInputSnapshot,\n \t\t\tint maxRecordAbortedCheckpoints) throws IOException {\n+\t\tthis(checkpointStorage,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96651fc6d199bad117ee85669e3b04029f64d2e3"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDc0MjIy", "url": "https://github.com/apache/flink/pull/12489#pullrequestreview-425074222", "createdAt": "2020-06-05T07:52:08Z", "commit": {"oid": "96626c47c1a15025a0c240aac2a45d04a29f0120"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo1MjowOVrOGfkEHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo1MjowOVrOGfkEHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0OTkxOA==", "bodyText": "return taskOwnedCheckpointStreamFactory directly?", "url": "https://github.com/apache/flink/pull/12489#discussion_r435749918", "createdAt": "2020-06-05T07:52:09Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/state/TestCheckpointStorageWorkerView.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.state;\n+\n+import org.apache.flink.runtime.state.memory.MemCheckpointStreamFactory;\n+\n+import java.io.IOException;\n+\n+/**\n+ * Non-persistent {@link CheckpointStorageWorkerView} for tests. Uses {@link MemCheckpointStreamFactory}.\n+ */\n+public class TestCheckpointStorageWorkerView implements CheckpointStorageWorkerView {\n+\n+\tprivate final int maxStateSize;\n+\tprivate final MemCheckpointStreamFactory taskOwnedCheckpointStreamFactory;\n+\tprivate final CheckpointedStateScope taskOwnedStateScope;\n+\n+\tpublic TestCheckpointStorageWorkerView(int maxStateSize) {\n+\t\tthis(maxStateSize, CheckpointedStateScope.EXCLUSIVE);\n+\t}\n+\n+\tprivate TestCheckpointStorageWorkerView(int maxStateSize, CheckpointedStateScope taskOwnedStateScope) {\n+\t\tthis.maxStateSize = maxStateSize;\n+\t\tthis.taskOwnedCheckpointStreamFactory = new MemCheckpointStreamFactory(maxStateSize);\n+\t\tthis.taskOwnedStateScope = taskOwnedStateScope;\n+\t}\n+\n+\t@Override\n+\tpublic CheckpointStreamFactory resolveCheckpointStorageLocation(long checkpointId, CheckpointStorageLocationReference reference) {\n+\t\treturn new MemCheckpointStreamFactory(maxStateSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96626c47c1a15025a0c240aac2a45d04a29f0120"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDgxNTUz", "url": "https://github.com/apache/flink/pull/12489#pullrequestreview-425081553", "createdAt": "2020-06-05T08:03:06Z", "commit": {"oid": "96626c47c1a15025a0c240aac2a45d04a29f0120"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7099ecb1efa408ddef934b8d1eb14b2bdd71ea6", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/f7099ecb1efa408ddef934b8d1eb14b2bdd71ea6", "committedDate": "2020-06-08T10:05:00Z", "message": "[FLINK-18136] Extract SubtaskCheckpointCoordinator#initCheckpoint and use in StreamTask"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba1441f6ae19db9c69eb2d1e45c061cd232e9cf6", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/ba1441f6ae19db9c69eb2d1e45c061cd232e9cf6", "committedDate": "2020-06-08T10:07:20Z", "message": "[FLINK-18136] Use initCheckpoint in CheckpointBarrierUnaligner"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "96626c47c1a15025a0c240aac2a45d04a29f0120", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/96626c47c1a15025a0c240aac2a45d04a29f0120", "committedDate": "2020-06-04T17:51:10Z", "message": "[FLINK-18136] Use initCheckpoint in CheckpointBarrierUnaligner"}, "afterCommit": {"oid": "ba1441f6ae19db9c69eb2d1e45c061cd232e9cf6", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/ba1441f6ae19db9c69eb2d1e45c061cd232e9cf6", "committedDate": "2020-06-08T10:07:20Z", "message": "[FLINK-18136] Use initCheckpoint in CheckpointBarrierUnaligner"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4323, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}