{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1NTE0MzMw", "number": 13110, "title": "[FLINK-18821][network] Fix indefinite wait in PartitionRequestClientFactory.createPartitionRequestClient - 1.11", "bodyText": "What is the purpose of the change\nFix of FLINK-18821 for FLINK-1.11 release (similar to #13067 for 1.12).\nCurrently, an exception in PartitionRequestClientFactory is propagated to the client directly.\nThe future in the internal PartitionRequestClientFactory map is not completed exceptionally.\nThis causes subsequent calls to wait indefinitely for the future to complete (see FLINK-18821).\nThis PR fixes it by completing the future exceptionally in case of error.\nVerifying this change\nAdded unit test: PartitionRequestClientFactoryTest.testFailureReportedToSubsequentRequests\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? no", "createdAt": "2020-08-10T13:51:19Z", "url": "https://github.com/apache/flink/pull/13110", "merged": true, "mergeCommit": {"oid": "ded539e85444f9c8d34f88da31784775ed281aba"}, "closed": true, "closedAt": "2020-08-12T08:28:11Z", "author": {"login": "rkhachatryan"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9iar7gH2gAyNDY1NTE0MzMwOjFiZTFkMDVhM2Y4ZDMxYzhiNTQ3YjQyMmRlMjZkOTExYTVhYmY3ZTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-FhpmAFqTQ2NTYyNjY1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1be1d05a3f8d31c8b547b422de26d911a5abf7e8", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/1be1d05a3f8d31c8b547b422de26d911a5abf7e8", "committedDate": "2020-08-10T13:41:23Z", "message": "[hotfix][tests] Unignore PartitionRequestClientFactoryTest class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afc114a64db9d1e5a99e7277fc032109673c6613", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/afc114a64db9d1e5a99e7277fc032109673c6613", "committedDate": "2020-08-10T13:56:49Z", "message": "[FLINK-18821][network] Fix indefinite wait in PartitionRequestClientFactory.createPartitionRequestClient"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "90bcc57e06e08131d3187bc5e3fd6c5fc4030de4", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/90bcc57e06e08131d3187bc5e3fd6c5fc4030de4", "committedDate": "2020-08-10T13:44:22Z", "message": "[FLINK-18821][network] Fix indefinite wait in PartitionRequestClientFactory.createPartitionRequestClient"}, "afterCommit": {"oid": "afc114a64db9d1e5a99e7277fc032109673c6613", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/afc114a64db9d1e5a99e7277fc032109673c6613", "committedDate": "2020-08-10T13:56:49Z", "message": "[FLINK-18821][network] Fix indefinite wait in PartitionRequestClientFactory.createPartitionRequestClient"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NjI2MzMz", "url": "https://github.com/apache/flink/pull/13110#pullrequestreview-465626333", "createdAt": "2020-08-12T06:35:02Z", "commit": {"oid": "afc114a64db9d1e5a99e7277fc032109673c6613"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNjozNTowM1rOG_Tofg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNjozNTowM1rOG_Tofg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAzNTEzNA==", "bodyText": "nit: define the local connectionId for above two places.\nIt is up to you whether to adjust it. I am also fine with current way.", "url": "https://github.com/apache/flink/pull/13110#discussion_r469035134", "createdAt": "2020-08-12T06:35:03Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/netty/PartitionRequestClientFactoryTest.java", "diffHunk": "@@ -49,6 +51,18 @@\n \n \tprivate final static int SERVER_PORT = NetUtils.getAvailablePort();\n \n+\t// see https://issues.apache.org/jira/browse/FLINK-18821\n+\t@Test(expected = IOException.class)\n+\tpublic void testFailureReportedToSubsequentRequests() throws Exception {\n+\t\tPartitionRequestClientFactory factory = new PartitionRequestClientFactory(new FailingNettyClient());\n+\t\ttry {\n+\t\t\tfactory.createPartitionRequestClient(new ConnectionID(new InetSocketAddress(InetAddress.getLocalHost(), 8080), 0));\n+\t\t} catch (IOException e) {\n+\t\t\t// expected\n+\t\t}\n+\t\tfactory.createPartitionRequestClient(new ConnectionID(new InetSocketAddress(InetAddress.getLocalHost(), 8080), 0));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afc114a64db9d1e5a99e7277fc032109673c6613"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NjI2NjUx", "url": "https://github.com/apache/flink/pull/13110#pullrequestreview-465626651", "createdAt": "2020-08-12T06:35:40Z", "commit": {"oid": "afc114a64db9d1e5a99e7277fc032109673c6613"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2868, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}