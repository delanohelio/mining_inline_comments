{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0NDkzODY3", "number": 12656, "title": "[FLINK-17666][table-planner-blink] Insert into partitioned table can \u2026", "bodyText": "\u2026fail with select *\nWhat is the purpose of the change\nBefore this patch, Blink planner throws for query insert into target_table partition ... select * from src_table.\nBrief change log\n\nFix the blink planner\nAdd ITCase for blink-planner and Hive connector\n\nVerifying this change\nAdded ITCases.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no", "createdAt": "2020-06-15T12:03:39Z", "url": "https://github.com/apache/flink/pull/12656", "merged": true, "mergeCommit": {"oid": "3792f8f0868a3a3a41fb8badb5345891594ad172"}, "closed": true, "closedAt": "2020-06-16T08:18:47Z", "author": {"login": "danny0405"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrf9vNgFqTQzMDU4ODk5Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrw1NJgFqTQzMTI2NzQ2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNTg4OTky", "url": "https://github.com/apache/flink/pull/12656#pullrequestreview-430588992", "createdAt": "2020-06-15T12:20:16Z", "commit": {"oid": "e35de4a21f5cf007341a71a1461b796b286c9948"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMjoyMDoxNlrOGjvvQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMjoyMTo0NFrOGjvySg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEzNTQ4OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\thiveShell.execute(\"create table src (x int,y string)\");\n          \n          \n            \n            \t\thiveShell.insertInto(\"default\", \"src\").addRow(1, \"a\").commit();\n          \n          \n            \n            \t\thiveShell.execute(\"create table dest (x int) partitioned by (p1 int,p2 string)\");\n          \n          \n            \n            \t\tTableEnvironment tableEnv = getTableEnvWithHiveCatalog();\n          \n          \n            \n            \t\tTableEnvironment tableEnv = getTableEnvWithHiveCatalog();\n          \n          \n            \n            \t\ttableEnv.executeSql(\"create table src (x int,y string)\");\n          \n          \n            \n            \t\tHiveTestUtils.createTextTableInserter(hiveShell, \"default\", \"src\").addRow(new Object[]{1, \"a\"}).commit();\n          \n          \n            \n            \t\ttableEnv.executeSql(\"create table dest (x int) partitioned by (p1 int,p2 string)\");", "url": "https://github.com/apache/flink/pull/12656#discussion_r440135489", "createdAt": "2020-06-15T12:20:16Z", "author": {"login": "lirui-apache"}, "path": "flink-connectors/flink-connector-hive/src/test/java/org/apache/flink/connectors/hive/TableEnvHiveConnectorITCase.java", "diffHunk": "@@ -669,6 +669,18 @@ public void testNonExistingPartitionFolder() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testInsertPartitionWithStarSource() throws Exception {\n+\t\thiveShell.execute(\"create table src (x int,y string)\");\n+\t\thiveShell.insertInto(\"default\", \"src\").addRow(1, \"a\").commit();\n+\t\thiveShell.execute(\"create table dest (x int) partitioned by (p1 int,p2 string)\");\n+\t\tTableEnvironment tableEnv = getTableEnvWithHiveCatalog();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e35de4a21f5cf007341a71a1461b796b286c9948"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEzNjI2Ng==", "bodyText": "Need to drop table src and dest after the test, because the catalog is reused across all test cases. And you can just use tableEnv to execute DDLs -- it's using the hive dialect", "url": "https://github.com/apache/flink/pull/12656#discussion_r440136266", "createdAt": "2020-06-15T12:21:44Z", "author": {"login": "lirui-apache"}, "path": "flink-connectors/flink-connector-hive/src/test/java/org/apache/flink/connectors/hive/TableEnvHiveConnectorITCase.java", "diffHunk": "@@ -669,6 +669,18 @@ public void testNonExistingPartitionFolder() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testInsertPartitionWithStarSource() throws Exception {\n+\t\thiveShell.execute(\"create table src (x int,y string)\");\n+\t\thiveShell.insertInto(\"default\", \"src\").addRow(1, \"a\").commit();\n+\t\thiveShell.execute(\"create table dest (x int) partitioned by (p1 int,p2 string)\");\n+\t\tTableEnvironment tableEnv = getTableEnvWithHiveCatalog();\n+\t\tTableEnvUtil.execInsertSqlAndWaitResult(tableEnv,\n+\t\t\t\t\"insert into dest partition (p1=1) select * from src\");\n+\t\tList<Row> results = Lists.newArrayList(tableEnv.sqlQuery(\"select * from dest\").execute().collect());\n+\t\tassertEquals(\"[1,1,a]\", results.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e35de4a21f5cf007341a71a1461b796b286c9948"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMTIwNjE2", "url": "https://github.com/apache/flink/pull/12656#pullrequestreview-431120616", "createdAt": "2020-06-16T02:40:29Z", "commit": {"oid": "35454e38388a139ba65943e1c876cbcfb9d9e87c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cec6fea4e3f8fe1edab5aab8484b8d315feae11", "author": {"user": {"login": "danny0405", "name": "Danny Chan"}}, "url": "https://github.com/apache/flink/commit/8cec6fea4e3f8fe1edab5aab8484b8d315feae11", "committedDate": "2020-06-16T03:56:31Z", "message": "[FLINK-17666][table-planner-blink] Insert into partitioned table can fail with select *"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "35454e38388a139ba65943e1c876cbcfb9d9e87c", "author": {"user": {"login": "danny0405", "name": "Danny Chan"}}, "url": "https://github.com/apache/flink/commit/35454e38388a139ba65943e1c876cbcfb9d9e87c", "committedDate": "2020-06-16T02:01:00Z", "message": "Fix RuiLi's review comment address"}, "afterCommit": {"oid": "8cec6fea4e3f8fe1edab5aab8484b8d315feae11", "author": {"user": {"login": "danny0405", "name": "Danny Chan"}}, "url": "https://github.com/apache/flink/commit/8cec6fea4e3f8fe1edab5aab8484b8d315feae11", "committedDate": "2020-06-16T03:56:31Z", "message": "[FLINK-17666][table-planner-blink] Insert into partitioned table can fail with select *"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMjY3NDY4", "url": "https://github.com/apache/flink/pull/12656#pullrequestreview-431267468", "createdAt": "2020-06-16T08:18:23Z", "commit": {"oid": "8cec6fea4e3f8fe1edab5aab8484b8d315feae11"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3477, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}