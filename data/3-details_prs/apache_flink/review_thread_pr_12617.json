{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzMjgzODAz", "number": 12617, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMDo1NToyMFrOEE2KSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNDoxNDozN1rOEE7R7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTE3MTI5OnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMDo1NToyMFrOGiucyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMDo1NToyMFrOGiucyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTA2NTgwMg==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/apache/flink/pull/12617#discussion_r439065802", "createdAt": "2020-06-11T20:55:20Z", "author": {"login": "rkhachatryan"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java", "diffHunk": "@@ -732,7 +732,7 @@ private void snapshotTaskState(\n \t\t\tprops.getCheckpointType(),\n \t\t\tcheckpointStorageLocation.getLocationReference(),\n \t\t\tisExactlyOnceMode,\n-\t\t\tunalignedCheckpointsEnabled);\n+\t\t\tprops.getCheckpointType() == CheckpointType.CHECKPOINT && unalignedCheckpointsEnabled);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e534d1a704430e11761cab5d978608e33be6f1d"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTE4MzgzOnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMDo1OTozNlrOGiukpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMDo1OTozNlrOGiukpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTA2NzgxNQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/apache/flink/pull/12617#discussion_r439067815", "createdAt": "2020-06-11T20:59:36Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorTest.java", "diffHunk": "@@ -119,10 +122,40 @@ public void testNotifyCheckpointComplete() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testSavepointNotResultingInPriorityEvents() throws Exception {\n+\t\tMockEnvironment mockEnvironment = MockEnvironment.builder().build();\n+\n+\t\tSubtaskCheckpointCoordinator coordinator = new MockSubtaskCheckpointCoordinatorBuilder()\n+\t\t\t\t.setUnalignedCheckpointEnabled(true)\n+\t\t\t\t.setEnvironment(mockEnvironment)\n+\t\t\t\t.build();\n+\n+\t\tAtomicReference<Boolean> broadcastedPriorityEvent = new AtomicReference<>(null);\n+\t\tfinal OperatorChain<?, ?> operatorChain = new OperatorChain(\n+\t\t\t\tnew MockStreamTaskBuilder(mockEnvironment).build(),\n+\t\t\t\tnew NonRecordWriter<>()) {\n+\t\t\t@Override\n+\t\t\tpublic void broadcastEvent(AbstractEvent event, boolean isPriorityEvent) throws IOException {\n+\t\t\t\tsuper.broadcastEvent(event, isPriorityEvent);\n+\t\t\t\tbroadcastedPriorityEvent.set(isPriorityEvent);\n+\t\t\t}\n+\t\t};\n+\n+\t\tcoordinator.checkpointState(\n+\t\t\t\tnew CheckpointMetaData(0, 0),\n+\t\t\t\tnew CheckpointOptions(SAVEPOINT, CheckpointStorageLocationReference.getDefault()),\n+\t\t\t\tnew CheckpointMetrics(),\n+\t\t\t\toperatorChain,\n+\t\t\t\t() -> false);\n+\n+\t\tassertEquals(false, broadcastedPriorityEvent.get());\n+\t}\n+\n \t@Test\n \tpublic void testSkipChannelStateForSavepoints() throws Exception {\n \t\tSubtaskCheckpointCoordinator coordinator = new MockSubtaskCheckpointCoordinatorBuilder()\n-\t\t\t.setUnalignedCheckpointEnabled(false)\n+\t\t\t.setUnalignedCheckpointEnabled(true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e534d1a704430e11761cab5d978608e33be6f1d"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTE5NTY2OnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMTowMzo1OVrOGiuseA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMTowMzo1OVrOGiuseA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTA2OTgxNg==", "bodyText": "I like the idea of using barrier options instead of local task configuration.", "url": "https://github.com/apache/flink/pull/12617#discussion_r439069816", "createdAt": "2020-06-11T21:03:59Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -253,7 +249,7 @@ public void checkpointState(\n \t\t// Step (2): Send the checkpoint barrier downstream\n \t\toperatorChain.broadcastEvent(\n \t\t\tnew CheckpointBarrier(metadata.getCheckpointId(), metadata.getTimestamp(), options),\n-\t\t\tunalignedCheckpointEnabled);\n+\t\t\toptions.isUnalignedCheckpoint());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e534d1a704430e11761cab5d978608e33be6f1d"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNjAxMDA3OnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNDoxNDozN1rOGi2fMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwODoxNDoyMFrOGi7MJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE5NzQ5MA==", "bodyText": "nit: might seem more consistent if we either remove below #includeChannelState method or use that method in all the places.", "url": "https://github.com/apache/flink/pull/12617#discussion_r439197490", "createdAt": "2020-06-12T04:14:37Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -253,7 +249,7 @@ public void checkpointState(\n \t\t// Step (2): Send the checkpoint barrier downstream\n \t\toperatorChain.broadcastEvent(\n \t\t\tnew CheckpointBarrier(metadata.getCheckpointId(), metadata.getTimestamp(), options),\n-\t\t\tunalignedCheckpointEnabled);\n+\t\t\toptions.isUnalignedCheckpoint());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e534d1a704430e11761cab5d978608e33be6f1d"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI3NDUzMg==", "bodyText": "inlined", "url": "https://github.com/apache/flink/pull/12617#discussion_r439274532", "createdAt": "2020-06-12T08:14:20Z", "author": {"login": "AHeise"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -253,7 +249,7 @@ public void checkpointState(\n \t\t// Step (2): Send the checkpoint barrier downstream\n \t\toperatorChain.broadcastEvent(\n \t\t\tnew CheckpointBarrier(metadata.getCheckpointId(), metadata.getTimestamp(), options),\n-\t\t\tunalignedCheckpointEnabled);\n+\t\t\toptions.isUnalignedCheckpoint());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE5NzQ5MA=="}, "originalCommit": {"oid": "1e534d1a704430e11761cab5d978608e33be6f1d"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4257, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}