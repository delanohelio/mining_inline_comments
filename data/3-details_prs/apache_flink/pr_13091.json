{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MDQ5MDIw", "number": 13091, "title": "[FLINK-18856][checkpointing] Don't ignore minPauseBetweenCheckpoints", "bodyText": "What is the purpose of the change\nCheckpointRequestDecider uses lastCheckpointCompletionTime and pendingRequests.size to make a decision.\nWhile latter is currently checked under a lock, the former is not.\nSo it can see \"no pending checkpoints\" (fresh value of pendingRequests.size) and \"last checkpoint completed long time ago\" (stale value of lastCheckpointCompletionTime).\nTherefore, it decides to execute request, effictevely ignoring minPauseBetweenCheckpoint setting.\nThis increases checkpoint frequency, and in some cases decreases throughput (see ML thread).\nThis PR replaces function argument for lastCheckpointCompletionTime with a supplier, which is called under lock (similar to pendingRequests.size()).\nVerifying this change\nAdded unit test: CheckpointCoordinatorTest.testMinCheckpointPause.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: yes, Checkpointing\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? not applicable", "createdAt": "2020-08-08T16:27:08Z", "url": "https://github.com/apache/flink/pull/13091", "merged": true, "mergeCommit": {"oid": "91298b803c8121d11fb4ed64e40e0b06aa4bc82f"}, "closed": true, "closedAt": "2020-08-13T10:28:14Z", "author": {"login": "rkhachatryan"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9HyoXAFqTQ2Mzg0NzU2Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-dcwzgFqTQ2NjYzNjc4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzODQ3NTYy", "url": "https://github.com/apache/flink/pull/13091#pullrequestreview-463847562", "createdAt": "2020-08-09T06:40:05Z", "commit": {"oid": "6339ff6f9b1acdb6f7cd163c9f866f77fd65c708"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQwNjo0MDowNlrOG94o0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQwNjo0MDowNlrOG94o0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzU0NDI3Mg==", "bodyText": "@rkhachatryan thanks for the fix.\nAfter this change, the behavior is equal to 1.10 and would respect the min-pause setting now.\nI'm wandering do we need to make the lastCheckpointCompletionRelativeTime and pendingCheckpoints.size  volatile.", "url": "https://github.com/apache/flink/pull/13091#discussion_r467544272", "createdAt": "2020-08-09T06:40:06Z", "author": {"login": "klion26"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java", "diffHunk": "@@ -318,6 +318,7 @@ public CheckpointCoordinator(\n \t\t\tthis.clock,\n \t\t\tthis.minPauseBetweenCheckpoints,\n \t\t\tthis.pendingCheckpoints::size,\n+\t\t\t() -> this.lastCheckpointCompletionRelativeTime,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6339ff6f9b1acdb6f7cd163c9f866f77fd65c708"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MTM3OTU4", "url": "https://github.com/apache/flink/pull/13091#pullrequestreview-464137958", "createdAt": "2020-08-10T11:09:39Z", "commit": {"oid": "5c5cc7ba30a61db136551bd956c079e7fb5d3ad8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMTowOTozOVrOG-KPnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMTowOTozOVrOG-KPnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgzMjczNQ==", "bodyText": "Those suppliers/consumers are making this class harder to follow and I think they are showing some deeper design problem - too tight coupling between CheckpointCoordinator/CheckpointRequestDecider.\nIn particular, it looks like adding Supplier<Long> completionTimeSupplier reveals quite weird concurrency contract between those two. Both are using the same lock object, and they are cross accessing the CheckpointCoordinator#lastCheckpointCompletionRelativeTime field from within the lock CheckpointRequestDecider#lock for read access and CheckpointCoordinator#lock for the write access.\nWhat about making CheckpointRequestDecider a non thread safe class, remove the CheckpointRequestDecider#lock and just relay on the caller (CheckpointCoordinator) to either access CheckpointRequestDecider from a single thread or provide thread safety. For now CheckpointCoordinator would be acquiring CheckpointCoordinator#lock before calling CheckpointRequestDecider, while after completing threading model refactor, the CheckpointCoordinator#lock would be simply removed, without a need to modify CheckpointRequestDecider?", "url": "https://github.com/apache/flink/pull/13091#discussion_r467832735", "createdAt": "2020-08-10T11:09:39Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointRequestDecider.java", "diffHunk": "@@ -55,20 +55,23 @@\n \t@GuardedBy(\"lock\")\n \tprivate final NavigableSet<CheckpointTriggerRequest> queuedRequests = new TreeSet<>(checkpointTriggerRequestsComparator());\n \tprivate final int maxQueuedRequests;\n+\tprivate final Supplier<Long> completionTimeSupplier;\n \n \tCheckpointRequestDecider(\n \t\t\tint maxConcurrentCheckpointAttempts,\n \t\t\tConsumer<Long> rescheduleTrigger,\n \t\t\tClock clock,\n \t\t\tlong minPauseBetweenCheckpoints,\n \t\t\tSupplier<Integer> pendingCheckpointsSizeSupplier,\n+\t\t\tSupplier<Long> completionTimeSupplier,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c5cc7ba30a61db136551bd956c079e7fb5d3ad8"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8beb140d8d3fad1c07816ebcc90b7ac17b73edfb", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/8beb140d8d3fad1c07816ebcc90b7ac17b73edfb", "committedDate": "2020-08-12T13:35:09Z", "message": "[FLINK-18856][checkpointing] Synchronize access to CheckpointCoordinator.lastCheckpointCompletionRelativeTime"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85fbcfce4d26b31d9a55931e36e877d27b5009fd", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/85fbcfce4d26b31d9a55931e36e877d27b5009fd", "committedDate": "2020-08-12T13:35:13Z", "message": "[hotfix][test] Fix formatting in CheckpointRequestDeciderTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3373a315374003a67dc8c2a32e3bdb7aadc80d8d", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/3373a315374003a67dc8c2a32e3bdb7aadc80d8d", "committedDate": "2020-08-12T13:37:05Z", "message": "[hotfix][docs] Add javadoc to CheckpointRequestDecider"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6339ff6f9b1acdb6f7cd163c9f866f77fd65c708", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/6339ff6f9b1acdb6f7cd163c9f866f77fd65c708", "committedDate": "2020-08-08T11:13:08Z", "message": "[hotfix][docs] Add javadoc to CheckpointRequestDecider"}, "afterCommit": {"oid": "3373a315374003a67dc8c2a32e3bdb7aadc80d8d", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/3373a315374003a67dc8c2a32e3bdb7aadc80d8d", "committedDate": "2020-08-12T13:37:05Z", "message": "[hotfix][docs] Add javadoc to CheckpointRequestDecider"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NjM2Nzg2", "url": "https://github.com/apache/flink/pull/13091#pullrequestreview-466636786", "createdAt": "2020-08-13T10:28:03Z", "commit": {"oid": "3373a315374003a67dc8c2a32e3bdb7aadc80d8d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2819, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}