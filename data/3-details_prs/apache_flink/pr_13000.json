{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3NDE2NzEw", "number": 13000, "title": "[FLINK-15467][task] Wait for sourceTaskThread to finish before exiting from StreamTask.invoke", "bodyText": "What is the purpose of the change\nWait for the LegacySourceFunctionThread to finish when cancelling the task.\nThis prevents premature freeing of resources, particularly LibraryCache (see FLINK-15467 discussion).\nImplemented by waiting in SourceStreamTask.invoke() for the sourceThread to complete.\nThere were several existing tests failures (listed below) which were fixed by completing the future if thread isn't alive; or by returning a completed future if a task is failing.\nVerifying this change\n\nAdded unit test: SourceStreamTaskTest.testWaitsForSourceThreadOnCancel\nTested manually on a local cluster\nExisting tests covering different scenarios of task exit and cancellation: InterruptSensitiveRestoreTest, StreamTaskTest.testEarlyCanceling, FastFailuresITCase\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? no", "createdAt": "2020-07-27T21:39:43Z", "url": "https://github.com/apache/flink/pull/13000", "merged": true, "mergeCommit": {"oid": "61d06ace57dc11b9445a506ba918b5a90f0376b3"}, "closed": true, "closedAt": "2020-07-29T14:21:12Z", "author": {"login": "rkhachatryan"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5I6_DABqjM1OTE3NjExMTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5lyVhAFqTQ1NzI1NjAwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "246e726a347494bb8c90aa9aee169a989b4d45d7", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/246e726a347494bb8c90aa9aee169a989b4d45d7", "committedDate": "2020-07-27T21:10:20Z", "message": "[FLINK-15467][task] Wait for sourceTaskThread to finish before exiting from invoke"}, "afterCommit": {"oid": "fd25ce73cad9903cd1d76b3fa84f8d0dd6b6df9c", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/fd25ce73cad9903cd1d76b3fa84f8d0dd6b6df9c", "committedDate": "2020-07-27T21:42:17Z", "message": "[FLINK-15467][task] Wait for sourceTaskThread to finish before exiting from invoke"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd25ce73cad9903cd1d76b3fa84f8d0dd6b6df9c", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/fd25ce73cad9903cd1d76b3fa84f8d0dd6b6df9c", "committedDate": "2020-07-27T21:42:17Z", "message": "[FLINK-15467][task] Wait for sourceTaskThread to finish before exiting from invoke"}, "afterCommit": {"oid": "021d4da6003e5c381c25af6d7bf4697d65db6b0e", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/021d4da6003e5c381c25af6d7bf4697d65db6b0e", "committedDate": "2020-07-28T07:20:40Z", "message": "[FLINK-15467][task] Wait for sourceTaskThread to finish before exiting from invoke"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "021d4da6003e5c381c25af6d7bf4697d65db6b0e", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/021d4da6003e5c381c25af6d7bf4697d65db6b0e", "committedDate": "2020-07-28T07:20:40Z", "message": "[FLINK-15467][task] Wait for sourceTaskThread to finish before exiting from invoke"}, "afterCommit": {"oid": "9cdd842c8447827394ea5dac56995574a532cde5", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/9cdd842c8447827394ea5dac56995574a532cde5", "committedDate": "2020-07-28T09:33:58Z", "message": "[FLINK-15467][task] Wait for sourceTaskThread to finish before exiting from invoke"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d946d97789255f15c8821dbdb9961dcbe325edf", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/4d946d97789255f15c8821dbdb9961dcbe325edf", "committedDate": "2020-07-28T11:25:35Z", "message": "[FLINK-15467][task] Wait for sourceTaskThread to finish before exiting from invoke"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9cdd842c8447827394ea5dac56995574a532cde5", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/9cdd842c8447827394ea5dac56995574a532cde5", "committedDate": "2020-07-28T09:33:58Z", "message": "[FLINK-15467][task] Wait for sourceTaskThread to finish before exiting from invoke"}, "afterCommit": {"oid": "4d946d97789255f15c8821dbdb9961dcbe325edf", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/4d946d97789255f15c8821dbdb9961dcbe325edf", "committedDate": "2020-07-28T11:25:35Z", "message": "[FLINK-15467][task] Wait for sourceTaskThread to finish before exiting from invoke"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MjU2MDA3", "url": "https://github.com/apache/flink/pull/13000#pullrequestreview-457256007", "createdAt": "2020-07-29T07:19:55Z", "commit": {"oid": "4d946d97789255f15c8821dbdb9961dcbe325edf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzoxOTo1NVrOG4rwCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzoxOTo1NVrOG4rwCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA5MDI0OQ==", "bodyText": "Two questions:\n\nShould we not ignore the exception? Just in case of some unexpected exceptions/bugs/problems? I guess the expected exception is InterruptedException?\nShouldn't this be in a while (true) loop with ignoring interruptions?", "url": "https://github.com/apache/flink/pull/13000#discussion_r462090249", "createdAt": "2020-07-29T07:19:55Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java", "diffHunk": "@@ -562,6 +567,7 @@ private void runMailboxLoop() throws Exception {\n \n \tprotected void afterInvoke() throws Exception {\n \t\tLOG.debug(\"Finished task {}\", getName());\n+\t\tgetCompletionFuture().exceptionally(unused -> null).join();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d946d97789255f15c8821dbdb9961dcbe325edf"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2982, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}