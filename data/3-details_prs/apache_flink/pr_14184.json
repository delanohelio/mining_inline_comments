{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1OTkwNzc2", "number": 14184, "title": "[FLINK-19852][task] Reuse TempBarrier memory between iterations", "bodyText": "What is the purpose of the change\nReuse allocated memory segments between the iterations of an iterative job.\nBrief change log\n\nfix checkstyle and IDE warnings\nintroduce a method to close TempBarrier without releasing memory\nadd TempBarrier constructor argument to use preallocated memory\nuse new method/argument in BatchTask.resetAllInputs\n\nVerifying this change\nThis change is already covered by existing tests.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): yes\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? no", "createdAt": "2020-11-23T20:59:19Z", "url": "https://github.com/apache/flink/pull/14184", "merged": true, "mergeCommit": {"oid": "e46ee85824796db83b994d37cd757d4fe52a0dd2"}, "closed": true, "closedAt": "2020-11-25T13:16:59Z", "author": {"login": "rkhachatryan"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfXe6SAH2gAyNTI1OTkwNzc2OjE2MTU4MTg1OWM0MGRhNTliY2JlNWY4MTcxYWExMWZkMmI1NmUyYmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdf-MlkgFqTUzODQ4MzkyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "161581859c40da59bcbe5f8171aa11fd2b56e2bf", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/161581859c40da59bcbe5f8171aa11fd2b56e2bf", "committedDate": "2020-11-23T16:10:28Z", "message": "[hotfix][task] Fix checkstyle/IDE warnings in BatchTask and TempBarrier"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NDg0NTg5", "url": "https://github.com/apache/flink/pull/14184#pullrequestreview-537484589", "createdAt": "2020-11-24T13:22:05Z", "commit": {"oid": "b5cb5d73481a41652fe13e99b427d50d41cd73e1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMzoyMjowNVrOH5AkIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMzoyMjowNVrOH5AkIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU0MDEzMA==", "bodyText": "This condition seems the wrong way around.", "url": "https://github.com/apache/flink/pull/14184#discussion_r529540130", "createdAt": "2020-11-24T13:22:05Z", "author": {"login": "StephanEwen"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/operators/BatchTask.java", "diffHunk": "@@ -893,21 +896,34 @@ protected void resetAllInputs() throws Exception {\n \t\t\t\t\t}\n \t\t\t\t} else {\n \t\t\t\t\t// close the async barrier if there is one\n-\t\t\t\t\tif (this.tempBarriers[i] != null) {\n-\t\t\t\t\t\tthis.tempBarriers[i].close();\n-\t\t\t\t\t\tthis.tempBarriers[i] = null;\n-\t\t\t\t\t}\n+\t\t\t\t\tList<MemorySegment> allocated = tempBarriers[i] == null ? emptyList() :\n+\t\t\t\t\t\ttempBarriers[i].closeAndGetLeftoverMemory();\n+\t\t\t\t\ttempBarriers[i] = null;\n \n-\t\t\t\t\t// recreate the local strategy\n-\t\t\t\t\tinitInputLocalStrategy(i);\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tinitInputLocalStrategy(i);\n \n-\t\t\t\t\tif (this.inputIsAsyncMaterialized[i]) {\n-\t\t\t\t\t\tfinal int pages = this.materializationMemory[i];\n-\t\t\t\t\t\t@SuppressWarnings({ \"unchecked\", \"rawtypes\" })\n-\t\t\t\t\t\tTempBarrier<?> barrier = new TempBarrier(this, getInput(i), this.inputSerializers[i], memMan, ioMan, pages);\n-\t\t\t\t\t\tbarrier.startReading();\n-\t\t\t\t\t\tthis.tempBarriers[i] = barrier;\n-\t\t\t\t\t\tthis.inputs[i] = null;\n+\t\t\t\t\t\tif (this.inputIsAsyncMaterialized[i]) {\n+\t\t\t\t\t\t\tfinal int pages = this.materializationMemory[i];\n+\t\t\t\t\t\t\tif (pages > allocated.size()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5cb5d73481a41652fe13e99b427d50d41cd73e1"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5da44513c122deddcc354e16337a7fb7cd2370e", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/c5da44513c122deddcc354e16337a7fb7cd2370e", "committedDate": "2020-11-24T13:32:41Z", "message": "[FLINK-19852][task] Reuse TempBarrier memory between iterations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5cb5d73481a41652fe13e99b427d50d41cd73e1", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/b5cb5d73481a41652fe13e99b427d50d41cd73e1", "committedDate": "2020-11-23T17:10:11Z", "message": "[FLINK-19852][task] Reuse TempBarrier memory between iterations"}, "afterCommit": {"oid": "c5da44513c122deddcc354e16337a7fb7cd2370e", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/c5da44513c122deddcc354e16337a7fb7cd2370e", "committedDate": "2020-11-24T13:32:41Z", "message": "[FLINK-19852][task] Reuse TempBarrier memory between iterations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NDgzOTI1", "url": "https://github.com/apache/flink/pull/14184#pullrequestreview-538483925", "createdAt": "2020-11-25T13:16:45Z", "commit": {"oid": "c5da44513c122deddcc354e16337a7fb7cd2370e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4081, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}