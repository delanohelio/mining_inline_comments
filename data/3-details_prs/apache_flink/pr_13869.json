{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzNjU4MjMz", "number": 13869, "title": "[FLINK-19908][table-planner-blink] FlinkLogicalTableSourceScan and CommonPhysicalTableSourceScan should respect source reuse config option", "bodyText": "What is the purpose of the change\nCurrently we have the table.optimizer.reuse-sub-plan-enabled config option to configure the reuse of sources. However FlinkLogicalTableSourceScan and CommonPhysicalTableSourceScan do not respect this option and are always reused.\nThis PR fixes the related code in SubplanReuser so that FlinkLogicalTableSourceScan and CommonPhysicalTableSourceScan now respect the config option,\nBrief change log\n\nFlinkLogicalTableSourceScan and CommonPhysicalTableSourceScan now respect the config option\n\nVerifying this change\nThis change added tests and can be verified by running the added tests.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? not applicable", "createdAt": "2020-11-01T17:11:15Z", "url": "https://github.com/apache/flink/pull/13869", "merged": true, "mergeCommit": {"oid": "4467277dcf80d18b2898d4ec93c634dc33d25b2d"}, "closed": true, "closedAt": "2020-11-02T06:40:59Z", "author": {"login": "tsreaper"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYCPFLAH2gAyNTEzNjU4MjMzOjMxMGM1M2VhZjBhOTJkZWUxYmZkZWE3MjZmNWE1ZjQ4OWM1NmIyY2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYevCkgFqTUyMTM2MTQ4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "310c53eaf0a92dee1bfdea726f5a5f489c56b2cb", "author": {"user": {"login": "tsreaper", "name": null}}, "url": "https://github.com/apache/flink/commit/310c53eaf0a92dee1bfdea726f5a5f489c56b2cb", "committedDate": "2020-10-31T21:27:42Z", "message": "[FLINK-19908][table-planner-blink] FlinkLogicalTableSourceScan and CommonPhysicalTableSourceScan should respect source reuse config option"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMjU4NzU3", "url": "https://github.com/apache/flink/pull/13869#pullrequestreview-521258757", "createdAt": "2020-11-01T20:35:52Z", "commit": {"oid": "310c53eaf0a92dee1bfdea726f5a5f489c56b2cb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMVQyMDozNTo1MlrOHrx7Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMVQyMDozNTo1MlrOHrx7Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY2ODgzMA==", "bodyText": "extract them into a common method?", "url": "https://github.com/apache/flink/pull/13869#discussion_r515668830", "createdAt": "2020-11-01T20:35:52Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/batch/sql/SubplanReuseTest.scala", "diffHunk": "@@ -448,4 +448,61 @@ class SubplanReuseTest extends TableTestBase {\n       \"\"\".stripMargin\n     util.verifyPlan(sqlQuery)\n   }\n+\n+  @Test\n+  def testEnableReuseTableSourceOnNewSource(): Unit = {\n+    util.tableEnv.getConfig.getConfiguration.setBoolean(\n+      OptimizerConfigOptions.TABLE_OPTIMIZER_REUSE_SOURCE_ENABLED, true)\n+    addNewSource()\n+    val sqlQuery =\n+      \"\"\"\n+        |WITH t AS (\n+        |  SELECT newX.a AS a, newX.b AS b, newY.d AS d, newY.e AS e\n+        |  FROM newX, newY\n+        |  WHERE newX.a = newY.d)\n+        |SELECT t1.*, t2.* FROM t t1, t t2 WHERE t1.b = t2.e AND t1.a < 10 AND t2.a > 5\n+      \"\"\".stripMargin\n+    util.verifyPlan(sqlQuery)\n+  }\n+\n+  @Test\n+  def testDisableReuseTableSourceOnNewSource(): Unit = {\n+    util.tableEnv.getConfig.getConfiguration.setBoolean(\n+      OptimizerConfigOptions.TABLE_OPTIMIZER_REUSE_SOURCE_ENABLED, false)\n+    addNewSource()\n+    val sqlQuery =\n+      \"\"\"\n+        |WITH t AS (\n+        |  SELECT newX.a AS a, newX.b AS b, newY.d AS d, newY.e AS e\n+        |  FROM newX, newY\n+        |  WHERE newX.a = newY.d)\n+        |SELECT t1.*, t2.* FROM t t1, t t2 WHERE t1.b = t2.e AND t1.a < 10 AND t2.a > 5\n+      \"\"\".stripMargin\n+    util.verifyPlan(sqlQuery)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "310c53eaf0a92dee1bfdea726f5a5f489c56b2cb"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff538d40c90389eef216ab1e152c65267034f9d1", "author": {"user": {"login": "tsreaper", "name": null}}, "url": "https://github.com/apache/flink/commit/ff538d40c90389eef216ab1e152c65267034f9d1", "committedDate": "2020-11-02T06:10:27Z", "message": "[fix] Fix comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMzYxNDg0", "url": "https://github.com/apache/flink/pull/13869#pullrequestreview-521361484", "createdAt": "2020-11-02T06:39:57Z", "commit": {"oid": "ff538d40c90389eef216ab1e152c65267034f9d1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2843, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}