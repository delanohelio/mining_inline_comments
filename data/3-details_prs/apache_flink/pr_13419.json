{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MTY1MDQz", "number": 13419, "title": "[FLINK-18842][e2e] Added 10min timeout to building the container.", "bodyText": "What is the purpose of the change\nThe docker build of test_docker_embedded_job.sh is failing once in a while. We haven't come up with a reason for it, yet. We also struggled to reproduce it. The discussion is happening in FLINK-18842.\nBrief change log\nFor now, I added a timeout to the docker build to enable the retry that is already in place.\nVerifying this change\nThis change is already covered by existing tests, such as test_docker_embedded_job.sh.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? not applicable", "createdAt": "2020-09-18T08:36:07Z", "url": "https://github.com/apache/flink/pull/13419", "merged": true, "mergeCommit": {"oid": "51fe48737398af49ddadb41f9459dfe272c22c93"}, "closed": true, "closedAt": "2020-09-28T09:35:21Z", "author": {"login": "XComp"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLUYOlAFqTQ5MzI2ODYwNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNQIxngH2gAyNDg5MTY1MDQzOjI5MzRlNmY3ZDg3NWVlNWM2YmUzNjg4ODRiYWFiNGZkMmUzNzk3YjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMjY4NjA0", "url": "https://github.com/apache/flink/pull/13419#pullrequestreview-493268604", "createdAt": "2020-09-22T09:14:58Z", "commit": {"oid": "eedc94a8daeab56af338a0783e3bb2aa014d7191"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOToxNDo1OFrOHVxMFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOToxNDo1OFrOHVxMFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU4ODA1Mg==", "bodyText": "We should be able to re-use run_test_with_timeout. All we basically need to do is move this\necho \"Printing Flink logs and killing it:\"\ncat ${FLINK_DIR}/log/*\n\ninto a separate function, and add a new run_with_timeout that accepts a timeout, run-command, and on-failure-command.\nrun_test_with_timeout() {\n  local TEST_TIMEOUT_SECONDS=$1\n  shift\n  local TEST_COMMAND=$@\n  internal_run_with_timeout $TEST_TIMEOUT_SECONDS \"$TEST_COMMAND\" print_logs\n}\n\nrun_with_timeout() {\n  internal_run_with_timeout $1 \"$2\" \"\"\n}\n\ninternal_run_with_timeout() {\n  local timeout=$1\n  local runCommand=$2\n  local onFailureCommand=$3\n\n  // do stuff\n}\n\nprint_logs() {\n  echo \"Printing Flink logs and killing it:\"\n   cat ${FLINK_DIR}/log/*\n}", "url": "https://github.com/apache/flink/pull/13419#discussion_r492588052", "createdAt": "2020-09-22T09:14:58Z", "author": {"login": "zentol"}, "path": "flink-end-to-end-tests/test-scripts/common.sh", "diffHunk": "@@ -830,3 +830,30 @@ run_test_with_timeout() {\n       $TEST_COMMAND\n   )\n }\n+\n+run_with_timeout() {\n+  local timeout=\"$1\"\n+  shift\n+  local pidFile=\"$1\"\n+  shift\n+  local command=\"$@\"\n+\n+  # invoke command\n+  (eval \"$command\"; rm $pidFile; ) &\n+  pid=$!\n+  echo $pid > $pidFile\n+\n+  # invoke timeout guard\n+  (\n+    sleep $timeout\n+    if [[ -e $pidFile ]]; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eedc94a8daeab56af338a0783e3bb2aa014d7191"}, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eedc94a8daeab56af338a0783e3bb2aa014d7191", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/eedc94a8daeab56af338a0783e3bb2aa014d7191", "committedDate": "2020-09-18T08:32:07Z", "message": "[FLINK-18842][e2e] Added 10min timeout to building the container."}, "afterCommit": {"oid": "f49a8ca77cab83df2a0a5c11bc968ac2864fa48c", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/f49a8ca77cab83df2a0a5c11bc968ac2864fa48c", "committedDate": "2020-09-22T13:42:32Z", "message": "[FLINK-18842][e2e] Added 10min timeout to building the container."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f49a8ca77cab83df2a0a5c11bc968ac2864fa48c", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/f49a8ca77cab83df2a0a5c11bc968ac2864fa48c", "committedDate": "2020-09-22T13:42:32Z", "message": "[FLINK-18842][e2e] Added 10min timeout to building the container."}, "afterCommit": {"oid": "2d8d50ef9228af65e2df4393e5be8fb1752304a6", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/2d8d50ef9228af65e2df4393e5be8fb1752304a6", "committedDate": "2020-09-22T13:47:32Z", "message": "[FLINK-18842][e2e] Added 10min timeout to building the container."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d8d50ef9228af65e2df4393e5be8fb1752304a6", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/2d8d50ef9228af65e2df4393e5be8fb1752304a6", "committedDate": "2020-09-22T13:47:32Z", "message": "[FLINK-18842][e2e] Added 10min timeout to building the container."}, "afterCommit": {"oid": "13127f0fb01159538233c928cdc1f1d7f74dbcd9", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/13127f0fb01159538233c928cdc1f1d7f74dbcd9", "committedDate": "2020-09-23T13:59:39Z", "message": "[FLINK-18842][e2e] Switched back to old implementation."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MDM5NTQ0", "url": "https://github.com/apache/flink/pull/13419#pullrequestreview-495039544", "createdAt": "2020-09-23T20:53:02Z", "commit": {"oid": "13127f0fb01159538233c928cdc1f1d7f74dbcd9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMDo1MzowM1rOHXAjUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMDo1MzowM1rOHXAjUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg4ODMzNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                run_with_timeout 600 \"${TEST_DATA_DIR}/docker-build-${RANDOM}.pid\" docker build --no-cache --network=\"host\" -t ${image_name} dev/${image_name}-debian\n          \n          \n            \n                run_with_timeout 600 docker build --no-cache --network=\"host\" -t ${image_name} dev/${image_name}-debian", "url": "https://github.com/apache/flink/pull/13419#discussion_r493888336", "createdAt": "2020-09-23T20:53:03Z", "author": {"login": "zentol"}, "path": "flink-end-to-end-tests/test-scripts/common_docker.sh", "diffHunk": "@@ -50,7 +50,7 @@ function build_image() {\n     ./add-custom.sh -u localhost:9999/flink.tgz -n ${image_name}\n \n     echo \"Building images\"\n-    docker build --no-cache --network=\"host\" -t ${image_name} dev/${image_name}-debian\n+    run_with_timeout 600 \"${TEST_DATA_DIR}/docker-build-${RANDOM}.pid\" docker build --no-cache --network=\"host\" -t ${image_name} dev/${image_name}-debian", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13127f0fb01159538233c928cdc1f1d7f74dbcd9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa980bb0e5fb9cf2bbe3707def174ac02e70170d", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/fa980bb0e5fb9cf2bbe3707def174ac02e70170d", "committedDate": "2020-09-25T05:16:50Z", "message": "[FLINK-18842][e2e] Added 10min timeout to building the container."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e955f78bf582ca3b1c50e357d6ed5d7bfe159268", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/e955f78bf582ca3b1c50e357d6ed5d7bfe159268", "committedDate": "2020-09-25T05:21:22Z", "message": "[FLINK-18842][e2e] Moved comment down to the actual function that is affected. Additionally, I added the specific feature that causes this comment."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf0418c1332c5371f14820d80af9ceea7507bedc", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/bf0418c1332c5371f14820d80af9ceea7507bedc", "committedDate": "2020-09-24T13:20:40Z", "message": "[FLINK-18842][e2e] Removed shift and replaced backticks by $(..) notation."}, "afterCommit": {"oid": "e955f78bf582ca3b1c50e357d6ed5d7bfe159268", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/e955f78bf582ca3b1c50e357d6ed5d7bfe159268", "committedDate": "2020-09-25T05:21:22Z", "message": "[FLINK-18842][e2e] Moved comment down to the actual function that is affected. Additionally, I added the specific feature that causes this comment."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MzM0ODk5", "url": "https://github.com/apache/flink/pull/13419#pullrequestreview-497334899", "createdAt": "2020-09-28T09:23:55Z", "commit": {"oid": "e955f78bf582ca3b1c50e357d6ed5d7bfe159268"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQwOToyMzo1NVrOHY1drQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQwOToyMzo1NVrOHY1drQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgwMzgyMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  (sleep \"${timeout_in_seconds}\" # set a timeout for this test\n          \n          \n            \n                  (sleep \"${timeout_in_seconds}\" # set a timeout for this command", "url": "https://github.com/apache/flink/pull/13419#discussion_r495803821", "createdAt": "2020-09-28T09:23:55Z", "author": {"login": "zentol"}, "path": "flink-end-to-end-tests/test-scripts/common.sh", "diffHunk": "@@ -801,32 +801,44 @@ function extract_job_id_from_job_submission_return() {\n     echo \"$JOB_ID\"\n }\n \n-\n-#\n-# NOTE: This function requires at least Bash version >= 4. Mac OS in 2020 still ships 3.x\n-#\n kill_test_watchdog() {\n-    local watchdog_pid=`cat $TEST_DATA_DIR/job_watchdog.pid`\n+    local watchdog_pid=$(cat $TEST_DATA_DIR/job_watchdog.pid)\n     echo \"Stopping job timeout watchdog (with pid=$watchdog_pid)\"\n     kill $watchdog_pid\n }\n \n-run_test_with_timeout() {\n-  local TEST_TIMEOUT_SECONDS=$1\n-  shift\n-  local TEST_COMMAND=$@\n+#\n+# NOTE: This function requires at least Bash version >= 4 due to the usage of $BASHPID. Mac OS in 2020 still ships 3.x\n+#\n+internal_run_with_timeout() {\n+  local timeout_in_seconds=\"$1\"\n+  local on_failure=\"$2\"\n+  local command_label=\"$3\"\n+  local command=\"${@:4}\"\n \n   on_exit kill_test_watchdog\n \n   (\n-      cmdpid=$BASHPID\n-      (sleep $TEST_TIMEOUT_SECONDS # set a timeout for this test\n-      echo \"Test (pid: $cmdpid) did not finish after $TEST_TIMEOUT_SECONDS seconds.\"\n-      echo \"Printing Flink logs and killing it:\"\n-      cat ${FLINK_DIR}/log/*\n-      kill \"$cmdpid\") & watchdog_pid=$!\n+      command_pid=$BASHPID\n+      (sleep \"${timeout_in_seconds}\" # set a timeout for this test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e955f78bf582ca3b1c50e357d6ed5d7bfe159268"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2934e6f7d875ee5c6be368884baab4fd2e3797b0", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/2934e6f7d875ee5c6be368884baab4fd2e3797b0", "committedDate": "2020-09-28T09:26:19Z", "message": "Update flink-end-to-end-tests/test-scripts/common.sh"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4078, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}