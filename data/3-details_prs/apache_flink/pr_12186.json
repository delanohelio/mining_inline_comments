{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4ODA2MjQ0", "number": 12186, "title": "[FLINK-16383][task] Do not relay notifyCheckpointComplete to closed operators", "bodyText": "What is the purpose of the change\nThrough StreamOperatorWrapper an operator may already be closed while the StreamTask is still running. Notification might be relayed in that time from the task to the closed operator causing issues on operators reacting on completed checkpoints, such as two phase commit sinks.\nBrief change log\n\nThis commit adds the information of the closing to the wrapper and avoids relaying notifications to closed operators.\nAlso fixes a potential related issue in SubtaskCheckpointCoordinatorImpl#takeSnapshotSync.\n\nVerifying this change\n\nAdded StreamTaskTest#testNotifyCheckpointOnClosedOperator\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-05-15T20:51:42Z", "url": "https://github.com/apache/flink/pull/12186", "merged": true, "mergeCommit": {"oid": "cbd9ca0ca3c6d2ff1ae36a7c3aa8f88d41506929"}, "closed": true, "closedAt": "2020-05-19T13:09:44Z", "author": {"login": "AHeise"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchvHOogFqTQxMzA0Njg1OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABciZ1jtABqjMzNDU3MjU1MTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMDQ2ODU4", "url": "https://github.com/apache/flink/pull/12186#pullrequestreview-413046858", "createdAt": "2020-05-16T04:36:24Z", "commit": {"oid": "a3129c8853f1b9af6ceb3a1f8749a70a7dc2f9f2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQwNDozNjoyNFrOGWYJqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQwNDozODowN1rOGWYKGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExNzU0NQ==", "bodyText": "I wonder if we shouldn't throw some exception?", "url": "https://github.com/apache/flink/pull/12186#discussion_r426117545", "createdAt": "2020-05-16T04:36:24Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -174,7 +174,9 @@ public void notifyCheckpointComplete(long checkpointId, OperatorChain<?, ?> oper\n \t\t\tLOG.debug(\"Notification of complete checkpoint for task {}\", taskName);\n \n \t\t\tfor (StreamOperatorWrapper<?, ?> operatorWrapper : operatorChain.getAllOperators(true)) {\n-\t\t\t\toperatorWrapper.getStreamOperator().notifyCheckpointComplete(checkpointId);\n+\t\t\t\tif (!operatorWrapper.isClosed()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3129c8853f1b9af6ceb3a1f8749a70a7dc2f9f2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExNzY1OA==", "bodyText": "ditto about exception or letting checkpoint coordinator know, that this checkpoint was declined. Otherwise, aren't we risking a situation where this checkpoint will complete, despite this operator not participating in it?\nAlso it might be better to move this if check much higher, somewhere to the top of checkpointState method?", "url": "https://github.com/apache/flink/pull/12186#discussion_r426117658", "createdAt": "2020-05-16T04:38:07Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -279,16 +281,18 @@ private void takeSnapshotSync(\n \n \t\ttry {\n \t\t\tfor (StreamOperatorWrapper<?, ?> operatorWrapper : operatorChain.getAllOperators(true)) {\n-\t\t\t\toperatorSnapshotsInProgress.put(\n-\t\t\t\t\toperatorWrapper.getStreamOperator().getOperatorID(),\n-\t\t\t\t\tbuildOperatorSnapshotFutures(\n-\t\t\t\t\t\tcheckpointMetaData,\n-\t\t\t\t\t\tcheckpointOptions,\n-\t\t\t\t\t\toperatorChain,\n-\t\t\t\t\t\toperatorWrapper.getStreamOperator(),\n-\t\t\t\t\t\tisCanceled,\n-\t\t\t\t\t\tchannelStateWriteResult,\n-\t\t\t\t\t\tstorage));\n+\t\t\t\tif (!operatorWrapper.isClosed()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3129c8853f1b9af6ceb3a1f8749a70a7dc2f9f2"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3129c8853f1b9af6ceb3a1f8749a70a7dc2f9f2", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/a3129c8853f1b9af6ceb3a1f8749a70a7dc2f9f2", "committedDate": "2020-05-15T20:49:44Z", "message": "[FLINK-16383][task] Do not relay notifyCheckpointComplete to closed operators.\n\nThrough StreamOperatorWrapper an operator may already be closed while the StreamTask is still running. Notification might be relayed in that time from the task to the closed operator causing issues on operators reacting on completed checkpoints, such as two phase commit sinks.\n\nThis commit adds the information of the closing to the wrapper and avoids relaying notifications to closed operators.\nAlso fixes a potential related issue in SubtaskCheckpointCoordinatorImpl#takeSnapshotSync."}, "afterCommit": {"oid": "25f5493bb635b3876ef629cdfb87b3d7a6aa8fff", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/25f5493bb635b3876ef629cdfb87b3d7a6aa8fff", "committedDate": "2020-05-16T08:14:52Z", "message": "[FLINK-16383][task] Do not relay notifyCheckpointComplete to closed operators.\n\nThrough StreamOperatorWrapper an operator may already be closed while the StreamTask is still running. Notification might be relayed in that time from the task to the closed operator causing issues on operators reacting on completed checkpoints, such as two phase commit sinks.\n\nThis commit adds the information of the closing to the wrapper and avoids relaying notifications to closed operators.\nAlso fixes a potential related issue in SubtaskCheckpointCoordinatorImpl#takeSnapshotSync."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMDU5MjM0", "url": "https://github.com/apache/flink/pull/12186#pullrequestreview-413059234", "createdAt": "2020-05-16T08:30:48Z", "commit": {"oid": "25f5493bb635b3876ef629cdfb87b3d7a6aa8fff"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQwODozMDo0OFrOGWZFBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQwODo0MTowN1rOGWZH7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEzMjc0MQ==", "bodyText": "Maybe it would be better push the isClosed() checks into the wrapper class? And instead of:\nif (!operatorWrapper.isClosed()) {\n\toperatorWrapper.getStreamOperator().prepareSnapshotPreBarrier(checkpointId);\n}\n\nhave here (and in other places):\noperatorWrapper.prepareSnapshotPreBarrier(checkpointId);\n\n?", "url": "https://github.com/apache/flink/pull/12186#discussion_r426132741", "createdAt": "2020-05-16T08:30:48Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/OperatorChain.java", "diffHunk": "@@ -262,7 +262,9 @@ public void prepareSnapshotPreBarrier(long checkpointId) throws Exception {\n \t\t// go forward through the operator chain and tell each operator\n \t\t// to prepare the checkpoint\n \t\tfor (StreamOperatorWrapper<?, ?> operatorWrapper : getAllOperators()) {\n-\t\t\toperatorWrapper.getStreamOperator().prepareSnapshotPreBarrier(checkpointId);\n+\t\t\tif (!operatorWrapper.isClosed()) {\n+\t\t\t\toperatorWrapper.getStreamOperator().prepareSnapshotPreBarrier(checkpointId);\n+\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25f5493bb635b3876ef629cdfb87b3d7a6aa8fff"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEzMzI4MA==", "bodyText": "isn't this a duplicated call, now with the same check above?", "url": "https://github.com/apache/flink/pull/12186#discussion_r426133280", "createdAt": "2020-05-16T08:39:14Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -269,16 +284,18 @@ private void takeSnapshotSync(\n \n \t\ttry {\n \t\t\tfor (StreamOperatorWrapper<?, ?> operatorWrapper : operatorChain.getAllOperators(true)) {\n-\t\t\t\toperatorSnapshotsInProgress.put(\n-\t\t\t\t\toperatorWrapper.getStreamOperator().getOperatorID(),\n-\t\t\t\t\tbuildOperatorSnapshotFutures(\n-\t\t\t\t\t\tcheckpointMetaData,\n-\t\t\t\t\t\tcheckpointOptions,\n-\t\t\t\t\t\toperatorChain,\n-\t\t\t\t\t\toperatorWrapper.getStreamOperator(),\n-\t\t\t\t\t\tisCanceled,\n-\t\t\t\t\t\tchannelStateWriteResult,\n-\t\t\t\t\t\tstorage));\n+\t\t\t\tif (!operatorWrapper.isClosed()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25f5493bb635b3876ef629cdfb87b3d7a6aa8fff"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEzMzQ4Nw==", "bodyText": "oO I haven't tested it with OneInputStreamTask::new :) Good to know that it's working.", "url": "https://github.com/apache/flink/pull/12186#discussion_r426133487", "createdAt": "2020-05-16T08:41:07Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskTest.java", "diffHunk": "@@ -934,6 +936,62 @@ public void testOperatorClosingBeforeStopRunning() throws Throwable {\n \t\t}\n \t}\n \n+\t/**\n+\t * Tests that {@link StreamTask#notifyCheckpointCompleteAsync(long)} is not relayed to closed operators.\n+\t *\n+\t * <p>See FLINK-16383.\n+\t */\n+\t@Test\n+\tpublic void testNotifyCheckpointOnClosedOperator() throws Throwable {\n+\t\tClosingOperator operator = new ClosingOperator();\n+\t\tMultipleInputStreamTaskTestHarnessBuilder<Integer> builder =\n+\t\t\tnew MultipleInputStreamTaskTestHarnessBuilder<>(OneInputStreamTask::new, BasicTypeInfo.INT_TYPE_INFO)\n+\t\t\t\t.addInput(BasicTypeInfo.INT_TYPE_INFO);\n+\t\tStreamTaskMailboxTestHarness<Integer> harness = builder\n+\t\t\t.setupOutputForSingletonOperatorChain(operator)\n+\t\t\t.build();\n+\t\t// keeps the mailbox from suspending\n+\t\tharness.setAutoProcess(false);\n+\t\tharness.processElement(new StreamRecord<>(1));\n+\n+\t\tharness.streamTask.notifyCheckpointCompleteAsync(1);\n+\t\tharness.streamTask.runMailboxStep();\n+\t\tassertEquals(1, operator.notified.get());\n+\t\tassertEquals(false, operator.closed.get());\n+\n+\t\t// close operators directly, so that task is still fully running\n+\t\tharness.streamTask.operatorChain.closeOperators(harness.streamTask.getActionExecutor());\n+\t\tharness.streamTask.notifyCheckpointCompleteAsync(2);\n+\t\tharness.streamTask.runMailboxStep();\n+\t\tassertEquals(1, operator.notified.get());\n+\t\tassertEquals(true, operator.closed.get());\n+\t}\n+\n+\t/**\n+\t * Tests that checkpoints are declined if operators are (partially) closed.\n+\t *\n+\t * <p>See FLINK-16383.\n+\t */\n+\t@Test\n+\tpublic void testCheckpointDeclinedOnClosedOperator() throws Throwable {\n+\t\tClosingOperator operator = new ClosingOperator();\n+\t\tMultipleInputStreamTaskTestHarnessBuilder<Integer> builder =\n+\t\t\tnew MultipleInputStreamTaskTestHarnessBuilder<>(OneInputStreamTask::new, BasicTypeInfo.INT_TYPE_INFO)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25f5493bb635b3876ef629cdfb87b3d7a6aa8fff"}, "originalPosition": 53}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "25f5493bb635b3876ef629cdfb87b3d7a6aa8fff", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/25f5493bb635b3876ef629cdfb87b3d7a6aa8fff", "committedDate": "2020-05-16T08:14:52Z", "message": "[FLINK-16383][task] Do not relay notifyCheckpointComplete to closed operators.\n\nThrough StreamOperatorWrapper an operator may already be closed while the StreamTask is still running. Notification might be relayed in that time from the task to the closed operator causing issues on operators reacting on completed checkpoints, such as two phase commit sinks.\n\nThis commit adds the information of the closing to the wrapper and avoids relaying notifications to closed operators.\nAlso fixes a potential related issue in SubtaskCheckpointCoordinatorImpl#takeSnapshotSync."}, "afterCommit": {"oid": "17deb1ace51d274715027adbeb607feb3958347a", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/17deb1ace51d274715027adbeb607feb3958347a", "committedDate": "2020-05-16T19:50:08Z", "message": "[FLINK-16383][task] Do not relay notifyCheckpointComplete to closed operators.\n\nThrough StreamOperatorWrapper an operator may already be closed while the StreamTask is still running. Notification might be relayed in that time from the task to the closed operator causing issues on operators reacting on completed checkpoints, such as two phase commit sinks.\n\nThis commit adds the information of the closing to the wrapper and avoids relaying notifications to closed operators.\nAlso fixes a potential related issue in SubtaskCheckpointCoordinatorImpl#takeSnapshotSync."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMTQwNzgy", "url": "https://github.com/apache/flink/pull/12186#pullrequestreview-413140782", "createdAt": "2020-05-17T08:49:39Z", "commit": {"oid": "17deb1ace51d274715027adbeb607feb3958347a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QwODo0OTozOVrOGWfVBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QwODo0OTozOVrOGWfVBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIzNTE0Mg==", "bodyText": "I think this is missing a relevant entry in CheckpointFailureManager switch/case", "url": "https://github.com/apache/flink/pull/12186#discussion_r426235142", "createdAt": "2020-05-17T08:49:39Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointFailureReason.java", "diffHunk": "@@ -44,6 +44,8 @@\n \n \tCHECKPOINT_DECLINED_TASK_NOT_READY(false, \"Checkpoint was declined (tasks not ready)\"),\n \n+\tCHECKPOINT_DECLINED_TASK_CLOSING(false, \"Checkpoint was declined (task's operators partially closed)\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17deb1ace51d274715027adbeb607feb3958347a"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "17deb1ace51d274715027adbeb607feb3958347a", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/17deb1ace51d274715027adbeb607feb3958347a", "committedDate": "2020-05-16T19:50:08Z", "message": "[FLINK-16383][task] Do not relay notifyCheckpointComplete to closed operators.\n\nThrough StreamOperatorWrapper an operator may already be closed while the StreamTask is still running. Notification might be relayed in that time from the task to the closed operator causing issues on operators reacting on completed checkpoints, such as two phase commit sinks.\n\nThis commit adds the information of the closing to the wrapper and avoids relaying notifications to closed operators.\nAlso fixes a potential related issue in SubtaskCheckpointCoordinatorImpl#takeSnapshotSync."}, "afterCommit": {"oid": "f512eeef60f86107d945f975b1ca8dead57db9c4", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/f512eeef60f86107d945f975b1ca8dead57db9c4", "committedDate": "2020-05-17T15:42:42Z", "message": "[FLINK-16383][task] Do not relay notifyCheckpointComplete to closed operators.\n\nThrough StreamOperatorWrapper an operator may already be closed while the StreamTask is still running. Notification might be relayed in that time from the task to the closed operator causing issues on operators reacting on completed checkpoints, such as two phase commit sinks.\n\nThis commit adds the information of the closing to the wrapper and avoids relaying notifications to closed operators.\nAlso fixes a potential related issue in SubtaskCheckpointCoordinatorImpl#takeSnapshotSync."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMTgzNDM5", "url": "https://github.com/apache/flink/pull/12186#pullrequestreview-413183439", "createdAt": "2020-05-17T17:42:11Z", "commit": {"oid": "f512eeef60f86107d945f975b1ca8dead57db9c4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26b98ea10d229f1a49fbbc232dc5cdb83572ac3b", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/26b98ea10d229f1a49fbbc232dc5cdb83572ac3b", "committedDate": "2020-05-18T06:25:24Z", "message": "[FLINK-16383][task] Do not relay notifyCheckpointComplete to closed operators.\n\nThrough StreamOperatorWrapper an operator may already be closed while the StreamTask is still running. Notification might be relayed in that time from the task to the closed operator causing issues on operators reacting on completed checkpoints, such as two phase commit sinks.\n\nThis commit adds the information of the closing to the wrapper and avoids relaying notifications to closed operators.\nAlso fixes a potential related issue in SubtaskCheckpointCoordinatorImpl#takeSnapshotSync."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f512eeef60f86107d945f975b1ca8dead57db9c4", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/f512eeef60f86107d945f975b1ca8dead57db9c4", "committedDate": "2020-05-17T15:42:42Z", "message": "[FLINK-16383][task] Do not relay notifyCheckpointComplete to closed operators.\n\nThrough StreamOperatorWrapper an operator may already be closed while the StreamTask is still running. Notification might be relayed in that time from the task to the closed operator causing issues on operators reacting on completed checkpoints, such as two phase commit sinks.\n\nThis commit adds the information of the closing to the wrapper and avoids relaying notifications to closed operators.\nAlso fixes a potential related issue in SubtaskCheckpointCoordinatorImpl#takeSnapshotSync."}, "afterCommit": {"oid": "26b98ea10d229f1a49fbbc232dc5cdb83572ac3b", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/26b98ea10d229f1a49fbbc232dc5cdb83572ac3b", "committedDate": "2020-05-18T06:25:24Z", "message": "[FLINK-16383][task] Do not relay notifyCheckpointComplete to closed operators.\n\nThrough StreamOperatorWrapper an operator may already be closed while the StreamTask is still running. Notification might be relayed in that time from the task to the closed operator causing issues on operators reacting on completed checkpoints, such as two phase commit sinks.\n\nThis commit adds the information of the closing to the wrapper and avoids relaying notifications to closed operators.\nAlso fixes a potential related issue in SubtaskCheckpointCoordinatorImpl#takeSnapshotSync."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4102, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}