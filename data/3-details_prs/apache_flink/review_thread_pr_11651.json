{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwMDEwMDA4", "number": 11651, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMzowMzoxN1rODwvaAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwODowNjozOVrOD0G5eQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNDM0OTQ3OnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/data/StringData.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMzowMzoxN1rOGD56bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxMDowODowOFrOGFHl8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc0Nzc1OQ==", "bodyText": "BinaryStringData is mutable, because it is lazy (de)serialized. The binary is lazily materialized when needed, so it's not thread-safe.", "url": "https://github.com/apache/flink/pull/11651#discussion_r406747759", "createdAt": "2020-04-10T13:03:17Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/data/StringData.java", "diffHunk": "@@ -23,43 +23,48 @@\n import org.apache.flink.table.types.logical.VarCharType;\n \n /**\n- * {@link StringData} is an internal data structure represents data of {@link VarCharType}\n- * and {@link CharType} in Flink Table/SQL.\n+ * An internal data structure representing data of {@link CharType} and {@link VarCharType}.\n+ *\n+ * <p>This data structure is immutable.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f24fe42d98e90e7419aaba8c250f44f6e855e6a5"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAyMDQ2NQ==", "bodyText": "@wuchong What I meant with immutable is that it does not provide any setters. Because GenericRowData has setters. But I'm fine with removing it here.", "url": "https://github.com/apache/flink/pull/11651#discussion_r408020465", "createdAt": "2020-04-14T10:08:08Z", "author": {"login": "twalthr"}, "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/data/StringData.java", "diffHunk": "@@ -23,43 +23,48 @@\n import org.apache.flink.table.types.logical.VarCharType;\n \n /**\n- * {@link StringData} is an internal data structure represents data of {@link VarCharType}\n- * and {@link CharType} in Flink Table/SQL.\n+ * An internal data structure representing data of {@link CharType} and {@link VarCharType}.\n+ *\n+ * <p>This data structure is immutable.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc0Nzc1OQ=="}, "originalCommit": {"oid": "f24fe42d98e90e7419aaba8c250f44f6e855e6a5"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1OTY1NTYxOnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/data/DecimalData.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwODowNjozOVrOGI4aMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwODozMDozMFrOGI5cOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk2NjAwMA==", "bodyText": "Hi @wuchong , this is a wrong implementation here. Can you take https://issues.apache.org/jira/browse/FLINK-16922 and fix that?", "url": "https://github.com/apache/flink/pull/11651#discussion_r411966000", "createdAt": "2020-04-21T08:06:39Z", "author": {"login": "JingsongLi"}, "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/data/DecimalData.java", "diffHunk": "@@ -0,0 +1,260 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.table.data;\n+\n+import org.apache.flink.annotation.PublicEvolving;\n+import org.apache.flink.table.types.logical.DecimalType;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import java.math.RoundingMode;\n+\n+import static org.apache.flink.util.Preconditions.checkArgument;\n+\n+/**\n+ * An internal data structure representing data of {@link DecimalType}.\n+ *\n+ * <p>This data structure is immutable and might store decimal values in a compact representation (as\n+ * a long value) if values are small enough.\n+ */\n+@PublicEvolving\n+public final class DecimalData implements Comparable<DecimalData> {\n+\n+\t// member fields and static fields are package-visible,\n+\t// in order to be accessible for DecimalDataUtils\n+\n+\tstatic final int MAX_COMPACT_PRECISION = 18;\n+\n+\t/**\n+\t * Maximum number of decimal digits an Int can represent. (1e9 < Int.MaxValue < 1e10)\n+\t */\n+\tstatic final int MAX_INT_DIGITS = 9;\n+\n+\t/**\n+\t * Maximum number of decimal digits a Long can represent. (1e18 < Long.MaxValue < 1e19)\n+\t */\n+\tstatic final int MAX_LONG_DIGITS = 18;\n+\n+\tstatic final long[] POW10 = new long[MAX_COMPACT_PRECISION + 1];\n+\n+\tstatic {\n+\t\tPOW10[0] = 1;\n+\t\tfor (int i = 1; i < POW10.length; i++) {\n+\t\t\tPOW10[i] = 10 * POW10[i - 1];\n+\t\t}\n+\t}\n+\n+\t// The semantics of the fields are as follows:\n+\t//  - `precision` and `scale` represent the precision and scale of SQL decimal type\n+\t//  - If `decimalVal` is set, it represents the whole decimal value\n+\t//  - Otherwise, the decimal value is longVal/(10^scale).\n+\t//\n+\t// Note that the (precision, scale) must be correct.\n+\t// if precision > MAX_COMPACT_PRECISION,\n+\t//   `decimalVal` represents the value. `longVal` is undefined\n+\t// otherwise, (longVal, scale) represents the value\n+\t//   `decimalVal` may be set and cached\n+\n+\tfinal int precision;\n+\tfinal int scale;\n+\n+\tfinal long longVal;\n+\tBigDecimal decimalVal;\n+\n+\t// this constructor does not perform any sanity check.\n+\tDecimalData(int precision, int scale, long longVal, BigDecimal decimalVal) {\n+\t\tthis.precision = precision;\n+\t\tthis.scale = scale;\n+\t\tthis.longVal = longVal;\n+\t\tthis.decimalVal = decimalVal;\n+\t}\n+\n+\t// ------------------------------------------------------------------------------------------\n+\t// Public Interfaces\n+\t// ------------------------------------------------------------------------------------------\n+\n+\t/**\n+\t * Returns the <i>precision</i> of this {@link DecimalData}.\n+\t *\n+\t * <p>The precision is the number of digits in the unscaled value.\n+\t */\n+\tpublic int precision() {\n+\t\treturn precision;\n+\t}\n+\n+\t/**\n+\t * Returns the <i>scale</i> of this {@link DecimalData}.\n+\t */\n+\tpublic int scale() {\n+\t\treturn scale;\n+\t}\n+\n+\t/**\n+\t * Converts this {@link DecimalData} into an instance of {@link BigDecimal}.\n+\t */\n+\tpublic BigDecimal toBigDecimal() {\n+\t\tBigDecimal bd = decimalVal;\n+\t\tif (bd == null) {\n+\t\t\tdecimalVal = bd = BigDecimal.valueOf(longVal, scale);\n+\t\t}\n+\t\treturn bd;\n+\t}\n+\n+\t/**\n+\t * Returns a long describing the <i>unscaled value</i> of this {@link DecimalData}.\n+\t *\n+\t * @throws ArithmeticException if this {@link DecimalData} does not exactly fit in a long.\n+\t */\n+\tpublic long toUnscaledLong() {\n+\t\tif (isCompact()) {\n+\t\t\treturn longVal;\n+\t\t} else {\n+\t\t\treturn toBigDecimal().unscaledValue().longValueExact();\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Returns a byte array describing the <i>unscaled value</i> of this {@link DecimalData}.\n+\t *\n+\t * @return the unscaled byte array of this {@link DecimalData}.\n+\t */\n+\tpublic byte[] toUnscaledBytes() {\n+\t\tif (!isCompact()) {\n+\t\t\treturn toBigDecimal().unscaledValue().toByteArray();\n+\t\t}\n+\n+\t\t// big endian; consistent with BigInteger.toByteArray()\n+\t\tbyte[] bytes = new byte[8];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6123b4f30f049238128d277a864a02caa96d8f31"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk4MjkwNw==", "bodyText": "OK. Will do that in FLINK-16996.", "url": "https://github.com/apache/flink/pull/11651#discussion_r411982907", "createdAt": "2020-04-21T08:30:30Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/data/DecimalData.java", "diffHunk": "@@ -0,0 +1,260 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.table.data;\n+\n+import org.apache.flink.annotation.PublicEvolving;\n+import org.apache.flink.table.types.logical.DecimalType;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import java.math.RoundingMode;\n+\n+import static org.apache.flink.util.Preconditions.checkArgument;\n+\n+/**\n+ * An internal data structure representing data of {@link DecimalType}.\n+ *\n+ * <p>This data structure is immutable and might store decimal values in a compact representation (as\n+ * a long value) if values are small enough.\n+ */\n+@PublicEvolving\n+public final class DecimalData implements Comparable<DecimalData> {\n+\n+\t// member fields and static fields are package-visible,\n+\t// in order to be accessible for DecimalDataUtils\n+\n+\tstatic final int MAX_COMPACT_PRECISION = 18;\n+\n+\t/**\n+\t * Maximum number of decimal digits an Int can represent. (1e9 < Int.MaxValue < 1e10)\n+\t */\n+\tstatic final int MAX_INT_DIGITS = 9;\n+\n+\t/**\n+\t * Maximum number of decimal digits a Long can represent. (1e18 < Long.MaxValue < 1e19)\n+\t */\n+\tstatic final int MAX_LONG_DIGITS = 18;\n+\n+\tstatic final long[] POW10 = new long[MAX_COMPACT_PRECISION + 1];\n+\n+\tstatic {\n+\t\tPOW10[0] = 1;\n+\t\tfor (int i = 1; i < POW10.length; i++) {\n+\t\t\tPOW10[i] = 10 * POW10[i - 1];\n+\t\t}\n+\t}\n+\n+\t// The semantics of the fields are as follows:\n+\t//  - `precision` and `scale` represent the precision and scale of SQL decimal type\n+\t//  - If `decimalVal` is set, it represents the whole decimal value\n+\t//  - Otherwise, the decimal value is longVal/(10^scale).\n+\t//\n+\t// Note that the (precision, scale) must be correct.\n+\t// if precision > MAX_COMPACT_PRECISION,\n+\t//   `decimalVal` represents the value. `longVal` is undefined\n+\t// otherwise, (longVal, scale) represents the value\n+\t//   `decimalVal` may be set and cached\n+\n+\tfinal int precision;\n+\tfinal int scale;\n+\n+\tfinal long longVal;\n+\tBigDecimal decimalVal;\n+\n+\t// this constructor does not perform any sanity check.\n+\tDecimalData(int precision, int scale, long longVal, BigDecimal decimalVal) {\n+\t\tthis.precision = precision;\n+\t\tthis.scale = scale;\n+\t\tthis.longVal = longVal;\n+\t\tthis.decimalVal = decimalVal;\n+\t}\n+\n+\t// ------------------------------------------------------------------------------------------\n+\t// Public Interfaces\n+\t// ------------------------------------------------------------------------------------------\n+\n+\t/**\n+\t * Returns the <i>precision</i> of this {@link DecimalData}.\n+\t *\n+\t * <p>The precision is the number of digits in the unscaled value.\n+\t */\n+\tpublic int precision() {\n+\t\treturn precision;\n+\t}\n+\n+\t/**\n+\t * Returns the <i>scale</i> of this {@link DecimalData}.\n+\t */\n+\tpublic int scale() {\n+\t\treturn scale;\n+\t}\n+\n+\t/**\n+\t * Converts this {@link DecimalData} into an instance of {@link BigDecimal}.\n+\t */\n+\tpublic BigDecimal toBigDecimal() {\n+\t\tBigDecimal bd = decimalVal;\n+\t\tif (bd == null) {\n+\t\t\tdecimalVal = bd = BigDecimal.valueOf(longVal, scale);\n+\t\t}\n+\t\treturn bd;\n+\t}\n+\n+\t/**\n+\t * Returns a long describing the <i>unscaled value</i> of this {@link DecimalData}.\n+\t *\n+\t * @throws ArithmeticException if this {@link DecimalData} does not exactly fit in a long.\n+\t */\n+\tpublic long toUnscaledLong() {\n+\t\tif (isCompact()) {\n+\t\t\treturn longVal;\n+\t\t} else {\n+\t\t\treturn toBigDecimal().unscaledValue().longValueExact();\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Returns a byte array describing the <i>unscaled value</i> of this {@link DecimalData}.\n+\t *\n+\t * @return the unscaled byte array of this {@link DecimalData}.\n+\t */\n+\tpublic byte[] toUnscaledBytes() {\n+\t\tif (!isCompact()) {\n+\t\t\treturn toBigDecimal().unscaledValue().toByteArray();\n+\t\t}\n+\n+\t\t// big endian; consistent with BigInteger.toByteArray()\n+\t\tbyte[] bytes = new byte[8];", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk2NjAwMA=="}, "originalCommit": {"oid": "6123b4f30f049238128d277a864a02caa96d8f31"}, "originalPosition": 146}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 649, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}