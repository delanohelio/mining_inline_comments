{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4NDY3NjE4", "number": 11630, "title": "[FLINK-16921][e2e] Describe all resources and show pods logs before cleanup when failed", "bodyText": "What is the purpose of the change\nThe pods may be pending because of not enough resources, disk pressure, or other problems. Then wait_rest_endpoint_up will timeout. Describing all resources will help to debug these problems.\nWe still have some failed instances and can not reproduce in the local environment(Mac/Linux). Open this PR to run e2e tests more times to find the root cause.\n\nhttps://dev.azure.com/rmetzger/Flink/_build/results?buildId=7046&view=logs&j=c88eea3b-64a0-564d-0031-9fdcd7b8abee&t=1e2bbe5b-4657-50be-1f07-d84bfce5b1f5\n\nBrief change log\n\nDescribe all resources so that we could find more information about why the K8s e2e tests failed\nDebug log could not show up in sometimes, so move debug_and_show_logs before cleanup\n\nVerifying this change\n\nRun e2e tests more times, K8s related tests should pass\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-04-04T04:36:45Z", "url": "https://github.com/apache/flink/pull/11630", "merged": true, "mergeCommit": {"oid": "d2d91b62d0bd07f7127c90daa42a5f46745865f9"}, "closed": true, "closedAt": "2020-04-04T08:02:23Z", "author": {"login": "wangyang0918"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcULq4vAH2gAyMzk4NDY3NjE4OjlhOTA3M2YyNzlhMWJjMmJiNDQzNTIxOTkxMzRjMzcyODI1Y2I3Njk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcURH0xAFqTM4NzY3OTU1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9a9073f279a1bc2bb44352199134c372825cb769", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/9a9073f279a1bc2bb44352199134c372825cb769", "committedDate": "2020-04-04T02:00:22Z", "message": "[FLINK-16921][e2e] Describe all resources and show pods logs before cleanup when failed\n\nThe pods may be pending because of not enough resources, disk pressure, or other problems. Then wait_rest_endpoint_up will timeout. Describing all resources will help to debug these problems."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3Njc4NDE1", "url": "https://github.com/apache/flink/pull/11630#pullrequestreview-387678415", "createdAt": "2020-04-04T08:02:08Z", "commit": {"oid": "9a9073f279a1bc2bb44352199134c372825cb769"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3Njc5NDc3", "url": "https://github.com/apache/flink/pull/11630#pullrequestreview-387679477", "createdAt": "2020-04-04T08:20:15Z", "commit": {"oid": "9a9073f279a1bc2bb44352199134c372825cb769"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQwODoyMDoxNVrOGAwKCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQwODoyMDoxNVrOGAwKCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0MjE4Nw==", "bodyText": "If this also doesn't help, I used these commands for debugging the k8s the last time it was unstable:\nkubectl get pods -o json -n kube-system\nkubectl get pods -o json\nkubectl get events -o json\nkubectl get deployments -o json\nkubectl describe pods\nkubectl describe nodes\nkubectl get nodes -o json", "url": "https://github.com/apache/flink/pull/11630#discussion_r403442187", "createdAt": "2020-04-04T08:20:15Z", "author": {"login": "rmetzger"}, "path": "flink-end-to-end-tests/test-scripts/common_kubernetes.sh", "diffHunk": "@@ -114,10 +114,11 @@ function stop_kubernetes {\n     fi\n }\n \n-function debug_copy_and_show_logs {\n+function debug_and_show_logs {\n     echo \"Debugging failed Kubernetes test:\"\n     echo \"Currently existing Kubernetes resources\"\n     kubectl get all\n+    kubectl describe all", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a9073f279a1bc2bb44352199134c372825cb769"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3Njc5NTU2", "url": "https://github.com/apache/flink/pull/11630#pullrequestreview-387679556", "createdAt": "2020-04-04T08:21:30Z", "commit": {"oid": "9a9073f279a1bc2bb44352199134c372825cb769"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQwODoyMTozMFrOGAwKaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQwODoyMTozMFrOGAwKaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0MjI4MQ==", "bodyText": "I recently got to know bash traps, which are basically signal handlers.\nYou can do trap debug_and_show_logs EXIT, which will run debug_and_show_logs whenever the script exists.", "url": "https://github.com/apache/flink/pull/11630#discussion_r403442281", "createdAt": "2020-04-04T08:21:30Z", "author": {"login": "rmetzger"}, "path": "flink-end-to-end-tests/test-scripts/test_kubernetes_embedded_job.sh", "diffHunk": "@@ -49,7 +54,4 @@ kubectl wait --for=condition=complete job/flink-job-cluster --timeout=1h\n kubectl cp `kubectl get pods | awk '/task-manager/ {print $1}'`:/cache/${OUTPUT_FILE} ${OUTPUT_VOLUME}/${OUTPUT_FILE}\n \n check_result_hash \"WordCount\" ${OUTPUT_VOLUME}/${OUTPUT_FILE} \"${RESULT_HASH}\"\n-\n-if [ $? != 0 ];then\n-  debug_copy_and_show_logs\n-fi\n+SUCCEEDED=$?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a9073f279a1bc2bb44352199134c372825cb769"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2299, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}