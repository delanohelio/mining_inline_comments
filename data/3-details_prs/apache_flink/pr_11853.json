{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3MDczMzM2", "number": 11853, "title": "[FLINK-15006][table-planner] Add option to shuffle-by-partition when dynamic inserting", "bodyText": "What is the purpose of the change\nWhen partition values are rare or have skew, if we shuffle by dynamic partitions, will break the performance.\nWe can have an option to close shuffle in such cases:\n\u2018sink.shuffle-by-partition.enable\u2019 = ...\nBrief change log\n\nModify BatchExecSinkRule and StreamExecSinkRule to default not shuffle\n\nVerifying this change\nPartitionSinkTest\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no", "createdAt": "2020-04-22T06:22:35Z", "url": "https://github.com/apache/flink/pull/11853", "merged": true, "mergeCommit": {"oid": "ba54a8da70acc847498e3584c71a9fbbc8208597"}, "closed": true, "closedAt": "2020-04-26T07:33:20Z", "author": {"login": "JingsongLi"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcapVUBABqjMyNjc3MjcwNzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbUp4WgFqTQwMDQ2NDE0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "99b58fba1e22bdbba0896f0aba181eafc6a28e7f", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/99b58fba1e22bdbba0896f0aba181eafc6a28e7f", "committedDate": "2020-04-22T14:43:12Z", "message": "Fix cases"}, "afterCommit": {"oid": "258a96c64c409102c679382b054d17602df65953", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/258a96c64c409102c679382b054d17602df65953", "committedDate": "2020-04-24T03:57:11Z", "message": "[FLINK-15006][table-planner] Add option to shuffle-by-partition when dynamic partition inserting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMDE0OTkx", "url": "https://github.com/apache/flink/pull/11853#pullrequestreview-400014991", "createdAt": "2020-04-24T14:48:23Z", "commit": {"oid": "258a96c64c409102c679382b054d17602df65953"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNDo0ODoyNFrOGLbTgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNDo1MDoyOFrOGLbZbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYzNDg4Mw==", "bodyText": "How about this \uff1f\"The option to enable shuffle data by dynamic partition fields in sink phase, this can greatly reduce the number of file for filesystem sink but may lead data skew, the default value is disabled.\"", "url": "https://github.com/apache/flink/pull/11853#discussion_r414634883", "createdAt": "2020-04-24T14:48:24Z", "author": {"login": "leonardBang"}, "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/FileSystemTableFactory.java", "diffHunk": "@@ -71,6 +71,12 @@\n \t\t\t.withDescription(\"The default partition name in case the dynamic partition\" +\n \t\t\t\t\t\" column value is null/empty string\");\n \n+\tpublic static final ConfigOption<Boolean> SINK_SHUFFLE_BY_PARTITION = key(\"sink.shuffle-by-partition.enable\")\n+\t\t\t.booleanType()\n+\t\t\t.defaultValue(false)\n+\t\t\t.withDescription(\"Before sink, can shuffle by dynamic partition fields to sink parallelisms,\" +\n+\t\t\t\t\t\" this can greatly reduce the number of files. But will lead to data skew too.\");\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "258a96c64c409102c679382b054d17602df65953"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYzNjM5Ng==", "bodyText": "DataStreamTableSink is a special Type, this change will make all stream sink nodes have chance to use the shuffle enable config?", "url": "https://github.com/apache/flink/pull/11853#discussion_r414636396", "createdAt": "2020-04-24T14:50:28Z", "author": {"login": "leonardBang"}, "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/rules/physical/stream/StreamExecSinkRule.scala", "diffHunk": "@@ -53,15 +53,20 @@ class StreamExecSinkRule extends ConverterRule(\n             val dynamicPartIndices =\n               dynamicPartFields.map(partitionSink.getTableSchema.getFieldNames.indexOf(_))\n \n-            if (partitionSink.configurePartitionGrouping(false)) {\n-              throw new TableException(\"Partition grouping in stream mode is not supported yet!\")\n-            }\n+            val shuffleEnable = sinkNode\n+                .catalogTable\n+                .getProperties\n+                .get(FileSystemTableFactory.SINK_SHUFFLE_BY_PARTITION.key())\n \n-            if (!partitionSink.isInstanceOf[DataStreamTableSink[_]]) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "258a96c64c409102c679382b054d17602df65953"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44db9715e7ff6ba4f650eea1cff50bf2cb769f7a", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/44db9715e7ff6ba4f650eea1cff50bf2cb769f7a", "committedDate": "2020-04-26T05:09:29Z", "message": "[FLINK-15006][table-planner] Add option to shuffle-by-partition when dynamic partition inserting"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb94cc0f80d06537d231e6fbaf90898e2b02c1ac", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/fb94cc0f80d06537d231e6fbaf90898e2b02c1ac", "committedDate": "2020-04-26T04:00:30Z", "message": "checkstyle"}, "afterCommit": {"oid": "44db9715e7ff6ba4f650eea1cff50bf2cb769f7a", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/44db9715e7ff6ba4f650eea1cff50bf2cb769f7a", "committedDate": "2020-04-26T05:09:29Z", "message": "[FLINK-15006][table-planner] Add option to shuffle-by-partition when dynamic partition inserting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d131987407d758558ea29386d9e1d8a100625a28", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/d131987407d758558ea29386d9e1d8a100625a28", "committedDate": "2020-04-26T05:11:33Z", "message": "minor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDY0MTQ5", "url": "https://github.com/apache/flink/pull/11853#pullrequestreview-400464149", "createdAt": "2020-04-26T06:25:53Z", "commit": {"oid": "d131987407d758558ea29386d9e1d8a100625a28"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4740, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}