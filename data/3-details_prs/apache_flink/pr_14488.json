{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1Mzg2NjI1", "number": 14488, "title": "[FLINK-20651] Use Spotless/google-java-format for code formatting/enforcement", "bodyText": "Please see the ML discussion for background: https://lists.apache.org/thread.html/rfb079ec4cfd35bcb93df9c2163aaa121e392282f0f3d9710c8ade811%40%3Cdev.flink.apache.org%3E. There was broad consensus in the discussion.\nThe basic idea is that we use the Spotless plugin to format our code with google-java-format and we use CI to enforce that style.\nA note on checkstyle: There are still a lot of checkstyle rules that make sense and that are not covered by Spotless, such as disallowed imports and Javadocs rules.\nAlso, the checkstyle suppression files are still valid and checkstyle still largely fails in the few modules where we have them without them. You can remove the suppressions to get a sense of the scale of the problem. I can't fix those issues in this PR.\nNote: when I'll actually merge this PR I have to rebase on latest master and reformat the code again and fix up the \"ignores\" file again.\nBrief change log\nThe changes are clearly outlined in the individual commits, please have a look at those.\nRough outline of changes:\n\nmove inline CHECKSTYLE:OFF comments to supressions file because inline comments in the imports don't work with the version of google-java-format we're using (which we have to use because we're using an older java version for our build\nremove checkstyle checks that don't make sense after reformatting the code; it's the check for \"tabs as indentation\"\nadd checkstyle suppressions for things that break with reformatting; this is only about file length, some files are getting to long\nfix formatting that doesn't work nicely with Spotless + Checkstyle, this is mostly about superfluous or missing <p> tags\nactually reformat the code\nadd the Spotless plugin, I'm adding this after reformatting to ensure that the build passes at each intermediate step\nadd .git-blame-ignore-revs for ignoring the reformatting commit\nupdate .editorconfig and update IDE setup instructions\n\nI did the reformatting commit as Rufus Refactor <dev@flink.apache.org> and all the other commits as myself.\nVerifying this change\nYou can play around with the formatter, try and change a file and run the checks. If you \"break\" a file the CI build should break.", "createdAt": "2020-12-24T14:15:23Z", "url": "https://github.com/apache/flink/pull/14488", "merged": true, "mergeCommit": {"oid": "97bfd049951f8d52a2e0aed14265074c4255ead0"}, "closed": true, "closedAt": "2020-12-28T13:35:15Z", "author": {"login": "aljoscha"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdqhmhiAFqTU1OTAyOTgwNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdqmOmwABqjQxNTIwNDgxMjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MDI5ODA1", "url": "https://github.com/apache/flink/pull/14488#pullrequestreview-559029805", "createdAt": "2020-12-28T07:44:34Z", "commit": {"oid": "f5ebdcc418bb91843f9a22a97a0229a6682c8824"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQwNzo0NDozNFrOILzaQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQwODowMDozMlrOILzp-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI0NzU1NQ==", "bodyText": "Don't we require <p> in comments? at least in java docs?  Or is it the issue, that we shouldn't have them in the license headers, but only in the java docs?", "url": "https://github.com/apache/flink/pull/14488#discussion_r549247555", "createdAt": "2020-12-28T07:44:34Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/api/operators/KeyedProcessOperatorTest.java", "diffHunk": "@@ -6,9 +6,9 @@\n  * to you under the Apache License, Version 2.0 (the\n  * \"License\"); you may not use this file except in compliance\n  * with the License.  You may obtain a copy of the License at\n- * <p>\n+ *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5ebdcc418bb91843f9a22a97a0229a6682c8824"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI1MTEyMQ==", "bodyText": "Could this be fixed? What's causing this issue?", "url": "https://github.com/apache/flink/pull/14488#discussion_r549251121", "createdAt": "2020-12-28T07:58:41Z", "author": {"login": "pnowojski"}, "path": "pom.xml", "diffHunk": "@@ -1815,6 +1827,47 @@ under the License.\n \t\t\t\t\t</configuration>\n \t\t\t\t</plugin>\n \n+\t\t\t\t<!-- Due to the Flink build setup, \"mvn spotless:apply\" and \"mvn spotless:check\"\n+\t\t\t\tdon't work. You have to use the fully qualified name, i.e.\n+\t\t\t\t\"mvn com.diffplug.spotless:spotless-maven-plugin:apply\" -->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ad565c78d1a5bc03502ec929f98d1fde6154b6a"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI1MTU3OQ==", "bodyText": "git config blame.ignoreRevsFile .git-blame-ignore-revs\n\nCan you document this somewhere? In the project's .README?", "url": "https://github.com/apache/flink/pull/14488#discussion_r549251579", "createdAt": "2020-12-28T08:00:32Z", "author": {"login": "pnowojski"}, "path": ".git-blame-ignore-revs", "diffHunk": "@@ -0,0 +1 @@\n+c996ed9372fc550d0a8a97b2b986bf96d26e304c", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a91ef723429a4fa0c262a148e8129bfcf611ba9"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MDg4ODQ3", "url": "https://github.com/apache/flink/pull/14488#pullrequestreview-559088847", "createdAt": "2020-12-28T10:39:08Z", "commit": {"oid": "5f7065c3f2fdf604f743f7034e2a32a0e7c7c7cd"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMDozOTowOVrOIL2mRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMDozOTowOVrOIL2mRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI5OTc4MA==", "bodyText": "indentation", "url": "https://github.com/apache/flink/pull/14488#discussion_r549299780", "createdAt": "2020-12-28T10:39:09Z", "author": {"login": "zentol"}, "path": "flink-connectors/flink-connector-files/src/main/java/org/apache/flink/connector/file/src/AbstractFileSource.java", "diffHunk": "@@ -230,12 +230,14 @@ public Boundedness getBoundedness() {\n \t/**\n \t * The generic base builder. This builder carries a <i>SELF</i> type to make it convenient to\n \t * extend this for subclasses, using the following pattern.\n+\t *\n \t * <pre>{@code\n \t * public class SubBuilder<T> extends AbstractFileSourceBuilder<T, SubBuilder<T>> {\n \t *     ...\n \t * }\n \t * }</pre>\n-\t * That way, all return values from builder method defined here are typed to the sub-class\n+\t *\n+     * <p>That way, all return values from builder method defined here are typed to the sub-class", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f7065c3f2fdf604f743f7034e2a32a0e7c7c7cd"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MTI4NDE2", "url": "https://github.com/apache/flink/pull/14488#pullrequestreview-559128416", "createdAt": "2020-12-28T12:39:14Z", "commit": {"oid": "57d28f1f00ec4f019496c1f501a39d4afb2910fc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "896268e61a2b78e19c2493dad3cf2c2c039d5d0f", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/896268e61a2b78e19c2493dad3cf2c2c039d5d0f", "committedDate": "2020-12-28T13:24:49Z", "message": "[hotfix] Fix incorrect license headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdef67836e157f443acf609630bd529154a817ea", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/bdef67836e157f443acf609630bd529154a817ea", "committedDate": "2020-12-28T13:24:49Z", "message": "[refactor] Use tabs in checkstyle.xml to conform to our other XML files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58d0ec16ebbc18bbf236bfded85f4f99799d0b16", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/58d0ec16ebbc18bbf236bfded85f4f99799d0b16", "committedDate": "2020-12-28T13:24:50Z", "message": "[FLINK-20651] Move checkstyle ignores to suppressions.xml\n\nKeeping them inline does not work with google-java-format."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6848163e3db9024662c58566c1d1036484bd0b8", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/c6848163e3db9024662c58566c1d1036484bd0b8", "committedDate": "2020-12-28T13:24:50Z", "message": "[FLINK-20651] Remove checkstyle checks that don't work/are not needed with google-java-format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edc65d794f3d746a7e87fec8443af6981051585e", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/edc65d794f3d746a7e87fec8443af6981051585e", "committedDate": "2020-12-28T13:24:50Z", "message": "[FLINK-20651] Add suppressions for breakage after google-java-format formatting\n\nThe reformatting increases file length for some files."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37f35d03bfa9c9066d54ede44ae40eed48b5e774", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/37f35d03bfa9c9066d54ede44ae40eed48b5e774", "committedDate": "2020-12-28T13:24:50Z", "message": "[FLINK-20651] Fix formatting that doesn't work with google-java-format/checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a9483a3856cf94ea04b94e9539034e1543e7739", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/7a9483a3856cf94ea04b94e9539034e1543e7739", "committedDate": "2020-12-28T13:24:51Z", "message": "[FLINK-20651] Add Spotless plugin with Google AOSP style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dd338d65d968b437f88363d84b99ffbd7ad05d4", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/8dd338d65d968b437f88363d84b99ffbd7ad05d4", "committedDate": "2020-12-28T13:30:59Z", "message": "[FLINK-20651] Format code with Spotless/google-java-format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54576e4383a54f5914f4e969f89532a543143567", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/54576e4383a54f5914f4e969f89532a543143567", "committedDate": "2020-12-28T13:34:01Z", "message": "[FLINK-20651] Add .git-blame-ignore-revs for ignoring refactor commit\n\nThis file can be used via:\n\n$ git config blame.ignoreRevsFile .git-blame-ignore-revs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f47db55d02fdb0f9d4da710e64881986ecc3d185", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/f47db55d02fdb0f9d4da710e64881986ecc3d185", "committedDate": "2020-12-28T13:34:06Z", "message": "[FLINK-20651] Update .editorconfig to match google-java-format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a68434df3dabfead8bc97ac0818563dbce6fb79", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/1a68434df3dabfead8bc97ac0818563dbce6fb79", "committedDate": "2020-12-28T13:34:06Z", "message": "[FLINK-20651] Add IDE instructions for google-java-format"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57d28f1f00ec4f019496c1f501a39d4afb2910fc", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/57d28f1f00ec4f019496c1f501a39d4afb2910fc", "committedDate": "2020-12-28T09:39:09Z", "message": "fixup! IDE instructions"}, "afterCommit": {"oid": "1a68434df3dabfead8bc97ac0818563dbce6fb79", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/1a68434df3dabfead8bc97ac0818563dbce6fb79", "committedDate": "2020-12-28T13:34:06Z", "message": "[FLINK-20651] Add IDE instructions for google-java-format"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3420, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}