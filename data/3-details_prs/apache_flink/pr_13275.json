{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1MjQ5NDg5", "number": 13275, "title": "[FLINK-19064][hbase] HBaseRowDataInputFormat is leaking resources", "bodyText": "What is the purpose of the change\nMethod configure() of HBaseRowInputFormat and HBaseRowDataInputFormat is calling connectToTable(), which creates a connection to HBase that is not closed again. The HBase connection should be opened in open() and closed in close().\nBrief change log\n\nDefine connection which is opened in open() and closed in close() in AbstractTableInputFormat.\n\nVerifying this change\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-08-28T07:57:37Z", "url": "https://github.com/apache/flink/pull/13275", "merged": true, "mergeCommit": {"oid": "a4d037b406185cd5864357b83ddbb823b611de9e"}, "closed": true, "closedAt": "2020-09-21T02:23:07Z", "author": {"login": "SteNicholas"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDQDbZAH2gAyNDc1MjQ5NDg5Ojg1MzRjODk3MjViYjg3NGY2YzYxMjZiYmU2ZGI0ZTljY2Y2NGE4MjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKD7OcgFqTQ5MTM4Mjk5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8534c89725bb874f6c6126bbe6db4e9ccf64a820", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/8534c89725bb874f6c6126bbe6db4e9ccf64a820", "committedDate": "2020-08-28T07:41:14Z", "message": "[FLINK-19064][hbase] HBaseRowDataInputFormat is leaking resources"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4Mjg5NDk1", "url": "https://github.com/apache/flink/pull/13275#pullrequestreview-478289495", "createdAt": "2020-08-31T03:44:29Z", "commit": {"oid": "8534c89725bb874f6c6126bbe6db4e9ccf64a820"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f9eaf6163562083066c4e6a7d22b7f4c6ee65e5", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/1f9eaf6163562083066c4e6a7d22b7f4c6ee65e5", "committedDate": "2020-09-02T13:12:14Z", "message": "[FLINK-19064][hbase] HBaseRowDataInputFormat is leaking resources"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae07b33c4aa55527b4324a9418d5f4dda8147e82", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/ae07b33c4aa55527b4324a9418d5f4dda8147e82", "committedDate": "2020-09-02T12:55:54Z", "message": "[FLINK-19064][hbase] HBaseRowDataInputFormat is leaking resources"}, "afterCommit": {"oid": "1f9eaf6163562083066c4e6a7d22b7f4c6ee65e5", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/1f9eaf6163562083066c4e6a7d22b7f4c6ee65e5", "committedDate": "2020-09-02T13:12:14Z", "message": "[FLINK-19064][hbase] HBaseRowDataInputFormat is leaking resources"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNTU3MTM3", "url": "https://github.com/apache/flink/pull/13275#pullrequestreview-483557137", "createdAt": "2020-09-07T13:30:35Z", "commit": {"oid": "1f9eaf6163562083066c4e6a7d22b7f4c6ee65e5"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74ac3764e017be069dd2eae07e893a0c8cad40e4", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/74ac3764e017be069dd2eae07e893a0c8cad40e4", "committedDate": "2020-09-08T02:04:37Z", "message": "[FLINK-19064][hbase] HBaseRowDataInputFormat is leaking resources"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzODgyMzU0", "url": "https://github.com/apache/flink/pull/13275#pullrequestreview-483882354", "createdAt": "2020-09-08T07:54:06Z", "commit": {"oid": "74ac3764e017be069dd2eae07e893a0c8cad40e4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNzo1NDowN1rOHORFUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNzo1NDo1OFrOHORHSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcyMjAwMA==", "bodyText": "1.HBaseTestBase will pull up a HBase cluster which is a heavy action.\nwe can move this test to HBaseConnectorITCase avoid pulling up the cluster twice.", "url": "https://github.com/apache/flink/pull/13275#discussion_r484722000", "createdAt": "2020-09-08T07:54:07Z", "author": {"login": "leonardBang"}, "path": "flink-connectors/flink-connector-hbase/src/test/java/org/apache/flink/connector/hbase/HBaseTableInputFormatTest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.connector.hbase;\n+\n+import org.apache.flink.connector.hbase.source.HBaseRowInputFormat;\n+import org.apache.flink.connector.hbase.source.TableInputSplit;\n+import org.apache.flink.connector.hbase.util.HBaseTableSchema;\n+import org.apache.flink.connector.hbase.util.HBaseTestBase;\n+import org.apache.flink.connector.hbase.util.PlannerType;\n+\n+import org.apache.hadoop.hbase.TableName;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertNull;\n+\n+/**\n+ * Test case for {@link HBaseRowInputFormat} table input format.\n+ */\n+public class HBaseTableInputFormatTest extends HBaseTestBase {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ac3764e017be069dd2eae07e893a0c8cad40e4"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcyMjUwNA==", "bodyText": "2.HBaseRowInputFormat is used by legacy connector, HBaseRowDataInputFormat is used by new connector,\nwe can cover them in HBaseConnectorITCase via parameterized parameter 'isLegacyConnector' easily", "url": "https://github.com/apache/flink/pull/13275#discussion_r484722504", "createdAt": "2020-09-08T07:54:58Z", "author": {"login": "leonardBang"}, "path": "flink-connectors/flink-connector-hbase/src/test/java/org/apache/flink/connector/hbase/HBaseTableInputFormatTest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.connector.hbase;\n+\n+import org.apache.flink.connector.hbase.source.HBaseRowInputFormat;\n+import org.apache.flink.connector.hbase.source.TableInputSplit;\n+import org.apache.flink.connector.hbase.util.HBaseTableSchema;\n+import org.apache.flink.connector.hbase.util.HBaseTestBase;\n+import org.apache.flink.connector.hbase.util.PlannerType;\n+\n+import org.apache.hadoop.hbase.TableName;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertNull;\n+\n+/**\n+ * Test case for {@link HBaseRowInputFormat} table input format.\n+ */\n+public class HBaseTableInputFormatTest extends HBaseTestBase {\n+\n+\tprotected PlannerType planner() {\n+\t\treturn PlannerType.BLINK_PLANNER;\n+\t}\n+\n+\t@Test\n+\tpublic void testOpenClose() throws IOException {\n+\t\tHBaseTableSchema tableSchema = new HBaseTableSchema();\n+\t\ttableSchema.addColumn(FAMILY1, F1COL1, byte[].class);\n+\t\tHBaseRowInputFormat inputFormat = new HBaseRowInputFormat(getConf(), TEST_TABLE_1, tableSchema);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ac3764e017be069dd2eae07e893a0c8cad40e4"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/27d9c90c0393f1febaec84f28e850867eed6222d", "committedDate": "2020-09-09T01:12:07Z", "message": "[FLINK-19064][hbase] HBaseRowDataInputFormat is leaking resources"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NjUzNTY2", "url": "https://github.com/apache/flink/pull/13275#pullrequestreview-484653566", "createdAt": "2020-09-09T04:33:04Z", "commit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNDozMzowNVrOHO2RpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNDozNjoxNlrOHO2Uyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMzMTM2NQ==", "bodyText": "We don't need to declare it public.", "url": "https://github.com/apache/flink/pull/13275#discussion_r485331365", "createdAt": "2020-09-09T04:33:05Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/TableInputSplit.java", "diffHunk": "@@ -26,7 +26,7 @@\n  * references to row below refer to the key of the row.\n  */\n @Internal\n-class TableInputSplit extends LocatableInputSplit {\n+public class TableInputSplit extends LocatableInputSplit {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMzMjE3MQ==", "bodyText": "This is never closed ?", "url": "https://github.com/apache/flink/pull/13275#discussion_r485332171", "createdAt": "2020-09-09T04:36:16Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -186,24 +193,22 @@ public void close() throws IOException {\n \t\t\tif (resultScanner != null) {\n \t\t\t\tresultScanner.close();\n \t\t\t}\n-\t\t} finally {\n-\t\t\tresultScanner = null;\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void closeInputFormat() throws IOException {\n-\t\ttry {\n \t\t\tif (table != null) {\n \t\t\t\ttable.close();\n \t\t\t}\n+\t\t\tif (connection != null) {\n+\t\t\t\tconnection.close();\n+\t\t\t}\n \t\t} finally {\n+\t\t\tresultScanner = null;\n \t\t\ttable = null;\n+\t\t\tconnection = null;\n \t\t}\n \t}\n \n \t@Override\n \tpublic TableInputSplit[] createInputSplits(final int minNumSplits) throws IOException {\n+\t\tinitTable();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 109}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0Njg5ODky", "url": "https://github.com/apache/flink/pull/13275#pullrequestreview-484689892", "createdAt": "2020-09-09T06:16:20Z", "commit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNjoxNjoyMVrOHO4LsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNjoyOToyN1rOHO4gpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM2MjYwOQ==", "bodyText": "I believe this (and below) exception messages are not correct anymore.", "url": "https://github.com/apache/flink/pull/13275#discussion_r485362609", "createdAt": "2020-09-09T06:16:21Z", "author": {"login": "rmetzger"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -94,25 +102,24 @@ public AbstractTableInputFormat(org.apache.hadoop.conf.Configuration hConf) {\n \t */\n \tprotected abstract T mapResultToOutType(Result r);\n \n-\t/**\n-\t * Creates a {@link Scan} object and opens the {@link HTable} connection.\n-\t *\n-\t * <p>These are opened here because they are needed in the createInputSplits\n-\t * which is called before the openInputFormat method.\n-\t *\n-\t * <p>The connection is opened in this method and closed in {@link #closeInputFormat()}.\n-\t *\n-\t * @param parameters The configuration that is to be used\n-\t * @see Configuration\n-\t */\n-\tpublic abstract void configure(Configuration parameters);\n+\t@Override\n+\tpublic void configure(Configuration parameters) {\n+\t}\n \n \tprotected org.apache.hadoop.conf.Configuration getHadoopConfiguration() {\n \t\treturn HBaseConfigurationUtil.deserializeConfiguration(serializedConfig, HBaseConfigurationUtil.getHBaseConfiguration());\n \t}\n \n+\t/**\n+\t * Creates a {@link Scan} object and opens the {@link HTable} connection.\n+\t * The connection is opened in this method and closed in {@link #close()}.\n+\t *\n+\t * @param split The split to be opened.\n+\t * @throws IOException Thrown, if the spit could not be opened due to an I/O problem.\n+\t */\n \t@Override\n \tpublic void open(TableInputSplit split) throws IOException {\n+\t\tinitTable();\n \t\tif (table == null) {\n \t\t\tthrow new IOException(\"The HBase table has not been opened! \" +\n \t\t\t\t\"This needs to be done in configure().\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM2MzI0NA==", "bodyText": "Revisit exception message.", "url": "https://github.com/apache/flink/pull/13275#discussion_r485363244", "createdAt": "2020-09-09T06:18:08Z", "author": {"login": "rmetzger"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -186,24 +193,22 @@ public void close() throws IOException {\n \t\t\tif (resultScanner != null) {\n \t\t\t\tresultScanner.close();\n \t\t\t}\n-\t\t} finally {\n-\t\t\tresultScanner = null;\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void closeInputFormat() throws IOException {\n-\t\ttry {\n \t\t\tif (table != null) {\n \t\t\t\ttable.close();\n \t\t\t}\n+\t\t\tif (connection != null) {\n+\t\t\t\tconnection.close();\n+\t\t\t}\n \t\t} finally {\n+\t\t\tresultScanner = null;\n \t\t\ttable = null;\n+\t\t\tconnection = null;\n \t\t}\n \t}\n \n \t@Override\n \tpublic TableInputSplit[] createInputSplits(final int minNumSplits) throws IOException {\n+\t\tinitTable();\n \t\tif (table == null) {\n \t\t\tthrow new IOException(\"The HBase table has not been opened! \" +\n \t\t\t\t\"This needs to be done in configure().\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM2NjUxOQ==", "bodyText": "We will leak the connection if table.close() or resultScanner.close() fails with an exception.\nI believe the proper way would be to wrap each close in a separate try block, and catch and log the error.", "url": "https://github.com/apache/flink/pull/13275#discussion_r485366519", "createdAt": "2020-09-09T06:25:53Z", "author": {"login": "rmetzger"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -186,24 +193,22 @@ public void close() throws IOException {\n \t\t\tif (resultScanner != null) {\n \t\t\t\tresultScanner.close();\n \t\t\t}\n-\t\t} finally {\n-\t\t\tresultScanner = null;\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void closeInputFormat() throws IOException {\n-\t\ttry {\n \t\t\tif (table != null) {\n \t\t\t\ttable.close();\n \t\t\t}\n+\t\t\tif (connection != null) {\n+\t\t\t\tconnection.close();\n+\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM2Nzk3Mw==", "bodyText": "If you make this method throws IOException, you don't need to wrap the IOExceptions in HBaseRowDataInputFormat.connectToTable() into RuntimeExceptions.\nThrowing an IOException is not a problem, because initTable is called in open(); which throws an IOException as well.", "url": "https://github.com/apache/flink/pull/13275#discussion_r485367973", "createdAt": "2020-09-09T06:29:27Z", "author": {"login": "rmetzger"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -68,6 +71,11 @@ public AbstractTableInputFormat(org.apache.hadoop.conf.Configuration hConf) {\n \t\tserializedConfig = HBaseConfigurationUtil.serializeConfiguration(hConf);\n \t}\n \n+\t/**\n+\t * Creates a {@link Scan} object and opens the {@link HTable} connection to initialize the HBase table.\n+\t */\n+\tprotected abstract void initTable();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de2e4b8c2d1c6e7701c34b47169247da3d89efb5", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/de2e4b8c2d1c6e7701c34b47169247da3d89efb5", "committedDate": "2020-09-17T08:37:27Z", "message": "[FLINK-19064][hbase] HBaseRowDataInputFormat is leaking resources"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c25f4cc12679b9b313909c7c4e0e9d0391ecb25", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/5c25f4cc12679b9b313909c7c4e0e9d0391ecb25", "committedDate": "2020-09-17T08:34:06Z", "message": "[FLINK-19064][hbase] HBaseRowDataInputFormat is leaking resources"}, "afterCommit": {"oid": "de2e4b8c2d1c6e7701c34b47169247da3d89efb5", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/de2e4b8c2d1c6e7701c34b47169247da3d89efb5", "committedDate": "2020-09-17T08:37:27Z", "message": "[FLINK-19064][hbase] HBaseRowDataInputFormat is leaking resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eed5b15d8d10f1c1228e39650bb844385d7a2283", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/eed5b15d8d10f1c1228e39650bb844385d7a2283", "committedDate": "2020-09-17T11:43:52Z", "message": "[FLINK-19064][hbase] HBaseRowDataInputFormat is leaking resources"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMjk1MDA0", "url": "https://github.com/apache/flink/pull/13275#pullrequestreview-491295004", "createdAt": "2020-09-18T09:21:36Z", "commit": {"oid": "eed5b15d8d10f1c1228e39650bb844385d7a2283"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwOToyMTozNlrOHUFGPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwOToyOTowNVrOHUFWUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgxNzA4NA==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t}  finally {\n          \n          \n            \n            \t\t} finally {", "url": "https://github.com/apache/flink/pull/13275#discussion_r490817084", "createdAt": "2020-09-18T09:21:36Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -186,73 +188,79 @@ public void close() throws IOException {\n \t\t\tif (resultScanner != null) {\n \t\t\t\tresultScanner.close();\n \t\t\t}\n-\t\t} finally {\n+\t\t\tcloseTable();\n+\t\t}  finally {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eed5b15d8d10f1c1228e39650bb844385d7a2283"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyMTIwMA==", "bodyText": "The duplicate close looks strange to me. I think @rmetzger gave a nice idea above. You can just catch and log the error and move each close in a separate try block. You can take org.apache.flink.connector.hbase.sink.HBaseSinkFunction#close as an example. That will be much clean.", "url": "https://github.com/apache/flink/pull/13275#discussion_r490821200", "createdAt": "2020-09-18T09:29:05Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -186,73 +188,79 @@ public void close() throws IOException {\n \t\t\tif (resultScanner != null) {\n \t\t\t\tresultScanner.close();\n \t\t\t}\n-\t\t} finally {\n+\t\t\tcloseTable();\n+\t\t}  finally {\n \t\t\tresultScanner = null;\n \t\t}\n \t}\n \n-\t@Override\n-\tpublic void closeInputFormat() throws IOException {\n+\tpublic void closeTable() throws IOException {\n \t\ttry {\n \t\t\tif (table != null) {\n \t\t\t\ttable.close();\n \t\t\t}\n+\t\t\tif (connection != null) {\n+\t\t\t\tconnection.close();\n+\t\t\t}\n+\t\t} catch (IOException e) {\n+\t\t\tif (connection != null) {\n+\t\t\t\tconnection.close();\n+\t\t\t}\n+\t\t\tthrow e;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eed5b15d8d10f1c1228e39650bb844385d7a2283"}, "originalPosition": 118}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a1bd39b87efb3680010a3ba9a9fce8485411546", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/4a1bd39b87efb3680010a3ba9a9fce8485411546", "committedDate": "2020-09-18T10:00:44Z", "message": "[FLINK-19064][hbase] HBaseRowDataInputFormat is leaking resources"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMzgyOTky", "url": "https://github.com/apache/flink/pull/13275#pullrequestreview-491382992", "createdAt": "2020-09-18T11:30:53Z", "commit": {"oid": "4a1bd39b87efb3680010a3ba9a9fce8485411546"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4248, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}