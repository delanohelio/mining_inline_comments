{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzOTg2MTM3", "number": 12364, "title": "[FLINK-17986] Fix check in FsCheckpointStateOutputStream.write", "bodyText": "What is the purpose of the change\nWhile implementing #12258 the check outStream != null was placed in write instead of flush. This PR fixes it.\nVerifying this change\nThis change is a trivial rework without any test coverage.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? not applicable", "createdAt": "2020-05-27T16:55:10Z", "url": "https://github.com/apache/flink/pull/12364", "merged": true, "mergeCommit": {"oid": "0179156ee67a2e50752d2bcab1bf44aebc23b491"}, "closed": true, "closedAt": "2020-05-28T11:52:03Z", "author": {"login": "rkhachatryan"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclcgmnAFqTQxOTQ0MTc4Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABclo6F0AFqTQxOTg1MjYyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NDQxNzgy", "url": "https://github.com/apache/flink/pull/12364#pullrequestreview-419441782", "createdAt": "2020-05-27T17:14:14Z", "commit": {"oid": "773fda6a238b2eaf4203df9e232445c5e4236b74"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "773fda6a238b2eaf4203df9e232445c5e4236b74", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/773fda6a238b2eaf4203df9e232445c5e4236b74", "committedDate": "2020-05-27T16:54:50Z", "message": "[FLINK-17986] Fix check in FsCheckpointStateOutputStream.write"}, "afterCommit": {"oid": "6eef6ad43c519d62837d4e22246a4090a1aa1bd8", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/6eef6ad43c519d62837d4e22246a4090a1aa1bd8", "committedDate": "2020-05-27T18:11:36Z", "message": "[FLINK-17986] Fix check in FsCheckpointStateOutputStream.write"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODAxMTk5", "url": "https://github.com/apache/flink/pull/12364#pullrequestreview-419801199", "createdAt": "2020-05-28T06:07:39Z", "commit": {"oid": "6eef6ad43c519d62837d4e22246a4090a1aa1bd8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNjowNzozOVrOGbm15g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNjowNzozOVrOGbm15g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYwMTEyNg==", "bodyText": "add an additional\nstream.write(new byte[10]);\n\ncall to also check the other write method for the flushing problem?", "url": "https://github.com/apache/flink/pull/12364#discussion_r431601126", "createdAt": "2020-05-28T06:07:39Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/state/filesystem/FsCheckpointStreamFactoryTest.java", "diffHunk": "@@ -57,6 +57,23 @@ public void createStateDirectories() throws IOException {\n \t//  tests\n \t// ------------------------------------------------------------------------\n \n+\t@Test\n+\t@SuppressWarnings(\"ConstantConditions\")\n+\tpublic void testWriteFlushesIfAboveThreshold() throws IOException {\n+\t\tint fileSizeThreshold = 100;\n+\t\tfinal FsCheckpointStreamFactory factory = createFactory(FileSystem.getLocalFileSystem(), fileSizeThreshold, fileSizeThreshold);\n+\t\tfinal FsCheckpointStreamFactory.FsCheckpointStateOutputStream stream = factory.createCheckpointStateOutputStream(CheckpointedStateScope.EXCLUSIVE);\n+\t\tstream.write(new byte[fileSizeThreshold]);\n+\t\tFile[] files = new File(exclusiveStateDir.toUri()).listFiles();\n+\t\tassertEquals(1, files.length);\n+\t\tFile file = files[0];\n+\t\tassertEquals(fileSizeThreshold, file.length());\n+\t\tfor (int i = 0; i < fileSizeThreshold; i++) {\n+\t\t\tstream.write(127); // should buffer without flushing\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6eef6ad43c519d62837d4e22246a4090a1aa1bd8"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa65f31c2e89e08a8671a3748e2a516ee183220c", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/aa65f31c2e89e08a8671a3748e2a516ee183220c", "committedDate": "2020-05-28T07:20:00Z", "message": "[FLINK-17986] Fix check in FsCheckpointStateOutputStream.write"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6eef6ad43c519d62837d4e22246a4090a1aa1bd8", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/6eef6ad43c519d62837d4e22246a4090a1aa1bd8", "committedDate": "2020-05-27T18:11:36Z", "message": "[FLINK-17986] Fix check in FsCheckpointStateOutputStream.write"}, "afterCommit": {"oid": "aa65f31c2e89e08a8671a3748e2a516ee183220c", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/aa65f31c2e89e08a8671a3748e2a516ee183220c", "committedDate": "2020-05-28T07:20:00Z", "message": "[FLINK-17986] Fix check in FsCheckpointStateOutputStream.write"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODUyNjI0", "url": "https://github.com/apache/flink/pull/12364#pullrequestreview-419852624", "createdAt": "2020-05-28T07:40:56Z", "commit": {"oid": "aa65f31c2e89e08a8671a3748e2a516ee183220c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4500, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}