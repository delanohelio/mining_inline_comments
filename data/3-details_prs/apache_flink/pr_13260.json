{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0NTA1MTkw", "number": 13260, "title": "[FLINK-16768][tests] Let the watchdog also monitor mvn logs", "bodyText": "This experimental change aims to make the watchdog more accurate by extending the monitoring from the output to log files produced by the tests.\nIn particular the S3 tests seem to produce no output while they are producing output to the log files.\nThe risk of this change is that a hanging test is still producing log output (e.g. the test is stuck in a retry-loop).", "createdAt": "2020-08-27T07:21:12Z", "url": "https://github.com/apache/flink/pull/13260", "merged": true, "mergeCommit": {"oid": "79e74f5ea1c8fe33bee1a5a142ce113d49ebae8e"}, "closed": true, "closedAt": "2020-09-01T13:43:26Z", "author": {"login": "rmetzger"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdC7JqNAH2gAyNDc0NTA1MTkwOjg1ODIzOGNiNDcxNzU0MzljNTYzYmMyYzZkMjNkZWQ1N2IxYWI2ZjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdC_cEtAFqTQ3NjY2MzAwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "858238cb47175439c563bc2c6d23ded57b1ab6f2", "author": {"user": {"login": "rmetzger", "name": "Robert Metzger"}}, "url": "https://github.com/apache/flink/commit/858238cb47175439c563bc2c6d23ded57b1ab6f2", "committedDate": "2020-08-27T07:20:02Z", "message": "[FLINK-16768][tests] Let the watchdog also monitor mvn logs\n\nThis experimental change aims to make the watchdog more accurate by extending the monitoring from the output to log files produced by the tests.\nIn particular the S3 tests seem to produce no output while they are producing output to the log files.\n\nThe risk of this change is that a hanging test is still producing log output (e.g. the test is stuck in a retry-loop)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NjQ0MTY5", "url": "https://github.com/apache/flink/pull/13260#pullrequestreview-476644169", "createdAt": "2020-08-27T11:54:58Z", "commit": {"oid": "858238cb47175439c563bc2c6d23ded57b1ab6f2"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMTo1NDo1OFrOHIMziw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMjowMjo1N1rOHINGGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM2MDQ1OQ==", "bodyText": "It looks alright. FYI: The following one-liner should do the same:\nmod_time() {\n  stat -c \"%Y\" \"$CMD_OUT $WATCHDOG_ADDITIONAL_MONITORING_FILES\" | sort -nr | head -1\n}", "url": "https://github.com/apache/flink/pull/13260#discussion_r478360459", "createdAt": "2020-08-27T11:54:58Z", "author": {"login": "XComp"}, "path": "tools/ci/watchdog.sh", "diffHunk": "@@ -38,8 +38,26 @@ CMD_EXIT=\"/tmp/watchdog.exit\"\n # Utility functions\n # ============================================= \n \n+max_of() {\n+  local max number\n+\n+  max=\"$1\"\n+\n+  for number in \"${@:2}\"; do\n+    if ((number > max)); then\n+      max=\"$number\"\n+    fi\n+  done\n+\n+  printf '%d\\n' \"$max\"\n+}\n+\n+# Returns the highest modification time out of $CMD_OUT (which is the command output file)\n+# and any file(s) named \"mvn-*.log\" (which are logging files created by Flink's tests)\n mod_time () {\n-\techo `stat -c \"%Y\" $CMD_OUT`\n+\tCMD_OUT_MOD_TIME=`stat -c \"%Y\" $CMD_OUT`\n+\tADDITIONAL_FILES_MOD_TIMES=`stat -c \"%Y\" $WATCHDOG_ADDITIONAL_MONITORING_FILES 2> /dev/null`\n+\techo `max_of $CMD_OUT_MOD_TIME $ADDITIONAL_FILES_MOD_TIMES`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "858238cb47175439c563bc2c6d23ded57b1ab6f2"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM2NTIxMQ==", "bodyText": "Wouldn't it be better to pass this variable as a parameter to source \"${HERE}/watchdog.sh\"? Of course, we would have to handle the variable in watchdog.sh properly, then, since it has to be accessed through $1. The variable $WATCHDOG_ADDITIONAL_MONITORING_FILES is nowhere else used.", "url": "https://github.com/apache/flink/pull/13260#discussion_r478365211", "createdAt": "2020-08-27T12:02:57Z", "author": {"login": "XComp"}, "path": "tools/ci/test_controller.sh", "diffHunk": "@@ -69,6 +69,10 @@ export JAVA_TOOL_OPTIONS=\"-XX:+HeapDumpOnOutOfMemoryError\"\n # some tests provide additional logs if they find this variable\n export IS_CI=true\n \n+export WATCHDOG_ADDITIONAL_MONITORING_FILES=\"$DEBUG_FILES_OUTPUT_DIR/mvn-*.log\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "858238cb47175439c563bc2c6d23ded57b1ab6f2"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NjYzMDAz", "url": "https://github.com/apache/flink/pull/13260#pullrequestreview-476663003", "createdAt": "2020-08-27T12:19:45Z", "commit": {"oid": "858238cb47175439c563bc2c6d23ded57b1ab6f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMjoxOTo0NlrOHINuCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMjoxOTo0NlrOHINuCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM3NTQzNQ==", "bodyText": "I forgot to ask here: Is there a reason why you didn't just use echo \"$max\" instead?", "url": "https://github.com/apache/flink/pull/13260#discussion_r478375435", "createdAt": "2020-08-27T12:19:46Z", "author": {"login": "XComp"}, "path": "tools/ci/watchdog.sh", "diffHunk": "@@ -38,8 +38,26 @@ CMD_EXIT=\"/tmp/watchdog.exit\"\n # Utility functions\n # ============================================= \n \n+max_of() {\n+  local max number\n+\n+  max=\"$1\"\n+\n+  for number in \"${@:2}\"; do\n+    if ((number > max)); then\n+      max=\"$number\"\n+    fi\n+  done\n+\n+  printf '%d\\n' \"$max\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "858238cb47175439c563bc2c6d23ded57b1ab6f2"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4770, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}