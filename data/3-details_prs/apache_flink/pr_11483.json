{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyMDQ4Mjk1", "number": 11483, "title": "[FLINK-15438][metrics][datadog] Report counter deltas and not totals", "bodyText": "What is the purpose of the change\nThe Flink semantics of a counter are not matching with the counters\nin DataDog. In Flink a counter counts the total of increment and\ndecrement calls. In DataDog a counter is the number of increment\nand decrement calls during the reporting interval.\nBrief change log\n\nChanged DCounter to report a delta since the last report and not the total value\n\nVerifying this change\nThis change is already covered by existing tests, such as (please describe tests).\nThere is an existing unit test for the datadog metrics component. No change was done to it.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no", "createdAt": "2020-03-22T18:16:36Z", "url": "https://github.com/apache/flink/pull/11483", "merged": true, "mergeCommit": {"oid": "69f20e929b9f6c58b3220dd41b41b21ad5f4bcdd"}, "closed": true, "closedAt": "2020-03-26T09:08:53Z", "author": {"login": "kottmann"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRFoMEgFqTM4MTA1MDgxMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRQCwOgBqjMxNjYxMjQzNDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMDUwODEz", "url": "https://github.com/apache/flink/pull/11483#pullrequestreview-381050813", "createdAt": "2020-03-25T11:10:52Z", "commit": {"oid": "734a0bc7631586f212a22d9a71e60518d49d2274"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxMToxMDo1MlrOF7WNhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxMToxMDo1MlrOF7WNhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc3NDIxNA==", "bodyText": "I think we can simplify this mechanism a bit; my suggestion would be:\npublic class DCounter extends DMetric {\n\t...\n\tprivate long lastReportCount = 0;\n\tprivate long currentReportCount = 0;\n\t...\n\tpublic Number getMetricValue() {\n\t\tlong currentCount = counter.getCount();\n\t\tlong difference = currentCount - lastReportCount;\n\t\tcurrentReportCount = currentCount;\n\t\treturn difference;\n\t}\n\n\tpublic void ackReport() {\n\t\tlastReportCount = currentReportCount;\n\t}\n}\n\npublic class DatadogHttpReporter ... {\n\t...\n\tpublic void report() {\n\t\t...\n\t\tcounters.values().forEach(request::addCounter);\n\t\t...\n\t\ttry {\n\t\t\tclient.send(request);\n\t\t\tcounters.values().forEach(request::ackReport);\n\t\t} ...\n\t}\n}\n\nThis way we don't assemble another map, we have less of a back-and-forth between the reporter/metric and the error handling remains as is.", "url": "https://github.com/apache/flink/pull/11483#discussion_r397774214", "createdAt": "2020-03-25T11:10:52Z", "author": {"login": "zentol"}, "path": "flink-metrics/flink-metrics-datadog/src/main/java/org/apache/flink/metrics/datadog/DCounter.java", "diffHunk": "@@ -28,17 +28,34 @@\n public class DCounter extends DMetric {\n \tprivate final Counter counter;\n \n+\tprivate long lastReportedValue = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "734a0bc7631586f212a22d9a71e60518d49d2274"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ac54f0d5858be27c66f55fb56b96664f4252256", "author": {"user": {"login": "kottmann", "name": "Joern Kottmann"}}, "url": "https://github.com/apache/flink/commit/1ac54f0d5858be27c66f55fb56b96664f4252256", "committedDate": "2020-03-25T23:22:50Z", "message": "[FLINK-15438][metrics][datadog] Report counter deltas and not totals\n\nThe Flink semantics of a counter are not matching with the counters\nin DataDog. In Flink a counter counts the total of increment and\ndecrement calls. In DataDog a counter is the number of increment\nand decrement calls during the reporting interval."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "734a0bc7631586f212a22d9a71e60518d49d2274", "author": {"user": {"login": "kottmann", "name": "Joern Kottmann"}}, "url": "https://github.com/apache/flink/commit/734a0bc7631586f212a22d9a71e60518d49d2274", "committedDate": "2020-03-22T18:04:45Z", "message": "[FLINK-15438][metrics][datadog] Report counter deltas and not totals\n\nThe Flink semantics of a counter are not matching with the counters\nin DataDog. In Flink a counter counts the total of increment and\ndecrement calls. In DataDog a counter is the number of increment\nand decrement calls during the reporting interval."}, "afterCommit": {"oid": "1ac54f0d5858be27c66f55fb56b96664f4252256", "author": {"user": {"login": "kottmann", "name": "Joern Kottmann"}}, "url": "https://github.com/apache/flink/commit/1ac54f0d5858be27c66f55fb56b96664f4252256", "committedDate": "2020-03-25T23:22:50Z", "message": "[FLINK-15438][metrics][datadog] Report counter deltas and not totals\n\nThe Flink semantics of a counter are not matching with the counters\nin DataDog. In Flink a counter counts the total of increment and\ndecrement calls. In DataDog a counter is the number of increment\nand decrement calls during the reporting interval."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2437, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}