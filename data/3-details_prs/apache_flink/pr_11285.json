{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyMzkxOTY3", "number": 11285, "title": " [FLINK-16189][e2e] Remove test logic from FlinkDistribution", "bodyText": "Based on #11240.\nRemoves all test-specific logic from the FlinkDistribution and moves it one layer up into the FlinkResource.\nThe FlinkDistribution is now a simple wrapper for interacting with an actual distribution.\nThis removes a few limitations; for example so far it was not possible to work against 2 separate distributions.\nAdditionally it reduces the number of points where we access system properties, making things a bit easier to understand.", "createdAt": "2020-03-02T13:43:32Z", "url": "https://github.com/apache/flink/pull/11285", "merged": true, "mergeCommit": {"oid": "1924f82512e17a43f874b8c86492d9ce6c8d7dd1"}, "closed": true, "closedAt": "2020-03-05T15:12:38Z", "author": {"login": "zentol"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKVpRugFqTM2ODY2OTc4Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKWh8rgFqTM2ODc1NjA2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NjY5Nzg3", "url": "https://github.com/apache/flink/pull/11285#pullrequestreview-368669787", "createdAt": "2020-03-04T10:38:25Z", "commit": {"oid": "281fa884afd6a76ece952ce5245227fec2d86bce"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDozODoyNlrOFxoIBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMTo1ODoxOVrOFxqe1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU4MTk1OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tLocalStandaloneFlinkResource(Path distributionDirectory, Optional<Path> logBackupDirectory, FlinkResourceSetup setup) {\n          \n          \n            \n            \tLocalStandaloneFlinkResource(Path distributionDirectory, @Nullable Path logBackupDirectory, FlinkResourceSetup setup) {\n          \n      \n    \n    \n  \n\ncode style", "url": "https://github.com/apache/flink/pull/11285#discussion_r387581958", "createdAt": "2020-03-04T10:38:26Z", "author": {"login": "azagrebin"}, "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResource.java", "diffHunk": "@@ -51,16 +58,28 @@\n \n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResource.class);\n \n-\tprivate final FlinkDistribution distribution = new FlinkDistribution();\n+\tprivate final TemporaryFolder temporaryFolder = new TemporaryFolder();\n+\tprivate final Path distributionDirectory;\n+\t@Nullable\n+\tprivate final Path logBackupDirectory;\n \tprivate final FlinkResourceSetup setup;\n \n-\tLocalStandaloneFlinkResource(FlinkResourceSetup setup) {\n+\tprivate FlinkDistribution distribution;\n+\n+\tLocalStandaloneFlinkResource(Path distributionDirectory, Optional<Path> logBackupDirectory, FlinkResourceSetup setup) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "281fa884afd6a76ece952ce5245227fec2d86bce"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU4Mzg0Mg==", "bodyText": "nit for hotfix, can be IOException", "url": "https://github.com/apache/flink/pull/11285#discussion_r387583842", "createdAt": "2020-03-04T10:41:43Z", "author": {"login": "azagrebin"}, "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResource.java", "diffHunk": "@@ -51,16 +58,28 @@\n \n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResource.class);\n \n-\tprivate final FlinkDistribution distribution = new FlinkDistribution();\n+\tprivate final TemporaryFolder temporaryFolder = new TemporaryFolder();\n+\tprivate final Path distributionDirectory;\n+\t@Nullable\n+\tprivate final Path logBackupDirectory;\n \tprivate final FlinkResourceSetup setup;\n \n-\tLocalStandaloneFlinkResource(FlinkResourceSetup setup) {\n+\tprivate FlinkDistribution distribution;\n+\n+\tLocalStandaloneFlinkResource(Path distributionDirectory, Optional<Path> logBackupDirectory, FlinkResourceSetup setup) {\n+\t\tthis.distributionDirectory = distributionDirectory;\n+\t\tthis.logBackupDirectory = logBackupDirectory.orElse(null);\n \t\tthis.setup = setup;\n \t}\n \n \t@Override\n \tpublic void before() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "281fa884afd6a76ece952ce5245227fec2d86bce"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYxMTk0MQ==", "bodyText": "backupLogs();", "url": "https://github.com/apache/flink/pull/11285#discussion_r387611941", "createdAt": "2020-03-04T11:39:19Z", "author": {"login": "azagrebin"}, "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResource.java", "diffHunk": "@@ -71,12 +90,33 @@ public void before() throws Exception {\n \n \t@Override\n \tpublic void afterTestSuccess() {\n-\t\tdistribution.afterTestSuccess();\n+\t\tshutdownCluster();\n+\t\ttemporaryFolder.delete();\n \t}\n \n \t@Override\n \tpublic void afterTestFailure() {\n-\t\tdistribution.afterTestFailure();\n+\t\tif (distribution != null) {\n+\t\t\tshutdownCluster();\n+\t\t\tif (logBackupDirectory != null) {\n+\t\t\t\tfinal Path targetDirectory = logBackupDirectory.resolve(UUID.randomUUID().toString());\n+\t\t\t\ttry {\n+\t\t\t\t\tdistribution.copyLogsTo(targetDirectory);\n+\t\t\t\t\tLOG.info(\"Backed up logs to {}.\", targetDirectory);\n+\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\tLOG.warn(\"An error has occurred while backing up logs to {}.\", targetDirectory, e);\n+\t\t\t\t}\n+\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "281fa884afd6a76ece952ce5245227fec2d86bce"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYxNTA0NA==", "bodyText": "distribution = createFlinkDistribution();", "url": "https://github.com/apache/flink/pull/11285#discussion_r387615044", "createdAt": "2020-03-04T11:46:20Z", "author": {"login": "azagrebin"}, "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResource.java", "diffHunk": "@@ -51,16 +58,28 @@\n \n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResource.class);\n \n-\tprivate final FlinkDistribution distribution = new FlinkDistribution();\n+\tprivate final TemporaryFolder temporaryFolder = new TemporaryFolder();\n+\tprivate final Path distributionDirectory;\n+\t@Nullable\n+\tprivate final Path logBackupDirectory;\n \tprivate final FlinkResourceSetup setup;\n \n-\tLocalStandaloneFlinkResource(FlinkResourceSetup setup) {\n+\tprivate FlinkDistribution distribution;\n+\n+\tLocalStandaloneFlinkResource(Path distributionDirectory, Optional<Path> logBackupDirectory, FlinkResourceSetup setup) {\n+\t\tthis.distributionDirectory = distributionDirectory;\n+\t\tthis.logBackupDirectory = logBackupDirectory.orElse(null);\n \t\tthis.setup = setup;\n \t}\n \n \t@Override\n \tpublic void before() throws Exception {\n-\t\tdistribution.before();\n+\t\ttemporaryFolder.create();\n+\t\tPath tmp = temporaryFolder.newFolder().toPath();\n+\t\tLOG.info(\"Copying distribution to {}.\", tmp);\n+\t\tTestUtils.copyDirectory(distributionDirectory, tmp);\n+\n+\t\tdistribution = new FlinkDistribution(tmp);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "281fa884afd6a76ece952ce5245227fec2d86bce"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYyMDU2NQ==", "bodyText": "Does it mean that running e2e tests from IDE will always need to set distDir manually?", "url": "https://github.com/apache/flink/pull/11285#discussion_r387620565", "createdAt": "2020-03-04T11:58:19Z", "author": {"login": "azagrebin"}, "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResourceFactory.java", "diffHunk": "@@ -29,9 +33,21 @@\n public final class LocalStandaloneFlinkResourceFactory implements FlinkResourceFactory {\n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResourceFactory.class);\n \n+\tprivate static final ParameterProperty<Path> DISTRIBUTION_DIRECTORY = new ParameterProperty<>(\"distDir\", Paths::get);\n+\tprivate static final ParameterProperty<Path> DISTRIBUTION_LOG_BACKUP_DIRECTORY = new ParameterProperty<>(\"logBackupDir\", Paths::get);\n+\n \t@Override\n \tpublic Optional<FlinkResource> create(FlinkResourceSetup setup) {\n+\t\tOptional<Path> distributionDirectory = DISTRIBUTION_DIRECTORY.get();\n+\t\tif (!distributionDirectory.isPresent()) {\n+\t\t\tLOG.warn(\"The distDir property was not set. You can set it when running maven via -DdistDir=<path> .\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "281fa884afd6a76ece952ce5245227fec2d86bce"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "275e0876a79f4016bccd0f2c8c3c5dc76bc4b85f", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/275e0876a79f4016bccd0f2c8c3c5dc76bc4b85f", "committedDate": "2020-03-04T12:37:21Z", "message": "[FLINK-16189][e2e] Remove test logic from FlinkDistribution\n\nThe FlinkDistribution is now a simple wrapper, which makes it easier to use in ways that do not match the jUnit resource life-cycle."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22ee00c4ac414fc6546ce4bd5158a1fb745b2947", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/22ee00c4ac414fc6546ce4bd5158a1fb745b2947", "committedDate": "2020-03-04T12:37:21Z", "message": "address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "281fa884afd6a76ece952ce5245227fec2d86bce", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/281fa884afd6a76ece952ce5245227fec2d86bce", "committedDate": "2020-03-02T13:33:21Z", "message": "[FLINK-16189][e2e] Remove test logic from FlinkDistribution\n\nThe FlinkDistribution is now a simple wrapper, which makes it easier to use in ways that do not match the jUnit resource life-cycle."}, "afterCommit": {"oid": "22ee00c4ac414fc6546ce4bd5158a1fb745b2947", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/22ee00c4ac414fc6546ce4bd5158a1fb745b2947", "committedDate": "2020-03-04T12:37:21Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzU2MDYw", "url": "https://github.com/apache/flink/pull/11285#pullrequestreview-368756060", "createdAt": "2020-03-04T13:00:19Z", "commit": {"oid": "22ee00c4ac414fc6546ce4bd5158a1fb745b2947"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2976, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}