{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NjY3Njc2", "number": 12181, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMzoyMDozNlrOD9OpFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNzoyNDowMFrOD-FvuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NTI5NjIxOnYy", "diffSide": "RIGHT", "path": "flink-core/src/test/java/org/apache/flink/core/fs/SafetyNetCloseableRegistryTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMzoyMDozNlrOGWmZMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwNToyNToxM1rOGWn6qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM1MDg5Ng==", "bodyText": "Mockito is not recommended for Flink tests.\nAn alternative is to introduce a new constructor SafetyNetCloseableRegistry(CloseableReaperThread) and a test class which overrides CloseableReaperThread.", "url": "https://github.com/apache/flink/pull/12181#discussion_r426350896", "createdAt": "2020-05-18T03:20:36Z", "author": {"login": "zhuzhurk"}, "path": "flink-core/src/test/java/org/apache/flink/core/fs/SafetyNetCloseableRegistryTest.java", "diffHunk": "@@ -27,18 +27,31 @@\n import org.junit.Rule;\n import org.junit.Test;\n import org.junit.rules.TemporaryFolder;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.powermock.core.classloader.annotations.PrepareForTest;\n+import org.powermock.modules.junit4.PowerMockRunner;\n \n import java.io.Closeable;\n import java.io.IOException;\n import java.util.concurrent.atomic.AtomicInteger;\n \n+import static org.powermock.api.mockito.PowerMockito.doNothing;\n+import static org.powermock.api.mockito.PowerMockito.doThrow;\n+import static org.powermock.api.mockito.PowerMockito.whenNew;\n+\n /**\n  * Tests for the {@link SafetyNetCloseableRegistry}.\n  */\n+@RunWith(PowerMockRunner.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7df4077fb5715e0a9ce097b773f49a197eb27dd"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM3NTg1MQ==", "bodyText": "Thanks for reivew, @zhuzhurk . I will considier your comment. But CloseableReaperThread  is final class and can't be inherited, I will change this for override.", "url": "https://github.com/apache/flink/pull/12181#discussion_r426375851", "createdAt": "2020-05-18T05:25:13Z", "author": {"login": "wanglijie95"}, "path": "flink-core/src/test/java/org/apache/flink/core/fs/SafetyNetCloseableRegistryTest.java", "diffHunk": "@@ -27,18 +27,31 @@\n import org.junit.Rule;\n import org.junit.Test;\n import org.junit.rules.TemporaryFolder;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.powermock.core.classloader.annotations.PrepareForTest;\n+import org.powermock.modules.junit4.PowerMockRunner;\n \n import java.io.Closeable;\n import java.io.IOException;\n import java.util.concurrent.atomic.AtomicInteger;\n \n+import static org.powermock.api.mockito.PowerMockito.doNothing;\n+import static org.powermock.api.mockito.PowerMockito.doThrow;\n+import static org.powermock.api.mockito.PowerMockito.whenNew;\n+\n /**\n  * Tests for the {@link SafetyNetCloseableRegistry}.\n  */\n+@RunWith(PowerMockRunner.class)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM1MDg5Ng=="}, "originalCommit": {"oid": "a7df4077fb5715e0a9ce097b773f49a197eb27dd"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NTM0NTIzOnYy", "diffSide": "RIGHT", "path": "flink-core/src/test/java/org/apache/flink/core/fs/SafetyNetCloseableRegistryTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwNDowMTozM1rOGWm27g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwNjoxNDozNVrOGWowVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM1ODUxMA==", "bodyText": "I think this line is not needed. It can be tracked via git log.", "url": "https://github.com/apache/flink/pull/12181#discussion_r426358510", "createdAt": "2020-05-18T04:01:33Z", "author": {"login": "zhuzhurk"}, "path": "flink-core/src/test/java/org/apache/flink/core/fs/SafetyNetCloseableRegistryTest.java", "diffHunk": "@@ -198,4 +211,27 @@ public void testReaperThreadSpawnAndStop() throws Exception {\n \t\t}\n \t\tAssert.assertFalse(SafetyNetCloseableRegistry.isReaperThreadRunning());\n \t}\n+\n+\t/**\n+\t * Test for FLINK-17645.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7df4077fb5715e0a9ce097b773f49a197eb27dd"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM4OTU5MQ==", "bodyText": "I got it. I will delete this line.", "url": "https://github.com/apache/flink/pull/12181#discussion_r426389591", "createdAt": "2020-05-18T06:14:35Z", "author": {"login": "wanglijie95"}, "path": "flink-core/src/test/java/org/apache/flink/core/fs/SafetyNetCloseableRegistryTest.java", "diffHunk": "@@ -198,4 +211,27 @@ public void testReaperThreadSpawnAndStop() throws Exception {\n \t\t}\n \t\tAssert.assertFalse(SafetyNetCloseableRegistry.isReaperThreadRunning());\n \t}\n+\n+\t/**\n+\t * Test for FLINK-17645.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM1ODUxMA=="}, "originalCommit": {"oid": "a7df4077fb5715e0a9ce097b773f49a197eb27dd"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1OTQ1MDMwOnYy", "diffSide": "RIGHT", "path": "flink-core/src/main/java/org/apache/flink/core/fs/SafetyNetCloseableRegistry.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMzozNTo1OVrOGXOrbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMzozNTo1OVrOGXOrbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAxMDkyNQ==", "bodyText": "We should avoid duplicating the codes.\nBelow is a possible way to make it.\n\tSafetyNetCloseableRegistry() {\n\t\tthis(() -> new CloseableReaperThread());\n\t}\n\n\t@VisibleForTesting\n\tSafetyNetCloseableRegistry(Supplier<CloseableReaperThread> reaperThreadSupplier) {\n\t\tsuper(new IdentityHashMap<>());\n\n\t\tsynchronized (REAPER_THREAD_LOCK) {\n\t\t\tif (0 == GLOBAL_SAFETY_NET_REGISTRY_COUNT) {\n\t\t\t\tPreconditions.checkState(null == REAPER_THREAD);\n\t\t\t\ttry {\n\t\t\t\t\tREAPER_THREAD = reaperThreadSupplier.get();\n\t\t\t\t\tREAPER_THREAD.start();\n\t\t\t\t} catch (Throwable throwable) {\n\t\t\t\t\tREAPER_THREAD = null;\n\t\t\t\t\tthrow throwable;\n\t\t\t\t}\n\t\t\t}\n\t\t\t++GLOBAL_SAFETY_NET_REGISTRY_COUNT;\n\t\t}\n\t}", "url": "https://github.com/apache/flink/pull/12181#discussion_r427010925", "createdAt": "2020-05-19T03:35:59Z", "author": {"login": "zhuzhurk"}, "path": "flink-core/src/main/java/org/apache/flink/core/fs/SafetyNetCloseableRegistry.java", "diffHunk": "@@ -73,8 +73,34 @@\n \t\tsynchronized (REAPER_THREAD_LOCK) {\n \t\t\tif (0 == GLOBAL_SAFETY_NET_REGISTRY_COUNT) {\n \t\t\t\tPreconditions.checkState(null == REAPER_THREAD);\n-\t\t\t\tREAPER_THREAD = new CloseableReaperThread();\n-\t\t\t\tREAPER_THREAD.start();\n+\t\t\t\ttry {\n+\t\t\t\t\tREAPER_THREAD = new CloseableReaperThread();\n+\t\t\t\t\tREAPER_THREAD.start();\n+\t\t\t\t} catch (Throwable throwable) {\n+\t\t\t\t\t// thread create or start error.\n+\t\t\t\t\tREAPER_THREAD = null;\n+\t\t\t\t\tthrow throwable;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\t++GLOBAL_SAFETY_NET_REGISTRY_COUNT;\n+\t\t}\n+\t}\n+\n+\t@VisibleForTesting\n+\tSafetyNetCloseableRegistry(CloseableReaperThread reaperThread) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "757a2307f027acba2aca26f7f5ec6f9639ce9079"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1OTQ2NDYwOnYy", "diffSide": "RIGHT", "path": "flink-core/src/main/java/org/apache/flink/core/fs/SafetyNetCloseableRegistry.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMzo0MzoxM1rOGXOzVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMzo1MzozOFrOGXO8vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAxMjk0OA==", "bodyText": "Why adding a new constructor here?\nIf you are blocked by the existing private constructor, you can just change it to protected.", "url": "https://github.com/apache/flink/pull/12181#discussion_r427012948", "createdAt": "2020-05-19T03:43:13Z", "author": {"login": "zhuzhurk"}, "path": "flink-core/src/main/java/org/apache/flink/core/fs/SafetyNetCloseableRegistry.java", "diffHunk": "@@ -186,6 +212,15 @@ private CloseableReaperThread() {\n \t\t\tthis.running = true;\n \t\t}\n \n+\t\t@VisibleForTesting\n+\t\tCloseableReaperThread(String name) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "757a2307f027acba2aca26f7f5ec6f9639ce9079"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAxNTM1Nw==", "bodyText": "OK, I will change it to protected.", "url": "https://github.com/apache/flink/pull/12181#discussion_r427015357", "createdAt": "2020-05-19T03:53:38Z", "author": {"login": "wanglijie95"}, "path": "flink-core/src/main/java/org/apache/flink/core/fs/SafetyNetCloseableRegistry.java", "diffHunk": "@@ -186,6 +212,15 @@ private CloseableReaperThread() {\n \t\t\tthis.running = true;\n \t\t}\n \n+\t\t@VisibleForTesting\n+\t\tCloseableReaperThread(String name) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAxMjk0OA=="}, "originalCommit": {"oid": "757a2307f027acba2aca26f7f5ec6f9639ce9079"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NDMxMjYyOnYy", "diffSide": "RIGHT", "path": "flink-core/src/test/java/org/apache/flink/core/fs/SafetyNetCloseableRegistryTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNzoyMDoxM1rOGX-YOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwODozOTo1NFrOGYBMuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc5MjQ0MA==", "bodyText": "can be private", "url": "https://github.com/apache/flink/pull/12181#discussion_r427792440", "createdAt": "2020-05-20T07:20:13Z", "author": {"login": "zhuzhurk"}, "path": "flink-core/src/test/java/org/apache/flink/core/fs/SafetyNetCloseableRegistryTest.java", "diffHunk": "@@ -198,4 +198,29 @@ public void testReaperThreadSpawnAndStop() throws Exception {\n \t\t}\n \t\tAssert.assertFalse(SafetyNetCloseableRegistry.isReaperThreadRunning());\n \t}\n+\n+\t/**\n+\t * Test whether failure to start thread in {@link SafetyNetCloseableRegistry}\n+\t * constructor can lead to failure of subsequent state check.\n+\t */\n+\t@Test\n+\tpublic void testReaperThreadStartFailed() throws Exception {\n+\n+\t\ttry {\n+\t\t\tnew SafetyNetCloseableRegistry(() -> new OutOfMemoryReaperThread());\n+\t\t} catch (java.lang.OutOfMemoryError error) {\n+\t\t}\n+\n+\t\t// the OOM error will not lead to failure of subsequent constructor call.\n+\t\tSafetyNetCloseableRegistry closeableRegistry = new SafetyNetCloseableRegistry();\n+\t\tcloseableRegistry.close();\n+\t}\n+\n+\tstatic class OutOfMemoryReaperThread extends SafetyNetCloseableRegistry.CloseableReaperThread {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd9add8e480455265ca95b863601f6608918b334"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzgzODY1MQ==", "bodyText": "done.", "url": "https://github.com/apache/flink/pull/12181#discussion_r427838651", "createdAt": "2020-05-20T08:39:54Z", "author": {"login": "wanglijie95"}, "path": "flink-core/src/test/java/org/apache/flink/core/fs/SafetyNetCloseableRegistryTest.java", "diffHunk": "@@ -198,4 +198,29 @@ public void testReaperThreadSpawnAndStop() throws Exception {\n \t\t}\n \t\tAssert.assertFalse(SafetyNetCloseableRegistry.isReaperThreadRunning());\n \t}\n+\n+\t/**\n+\t * Test whether failure to start thread in {@link SafetyNetCloseableRegistry}\n+\t * constructor can lead to failure of subsequent state check.\n+\t */\n+\t@Test\n+\tpublic void testReaperThreadStartFailed() throws Exception {\n+\n+\t\ttry {\n+\t\t\tnew SafetyNetCloseableRegistry(() -> new OutOfMemoryReaperThread());\n+\t\t} catch (java.lang.OutOfMemoryError error) {\n+\t\t}\n+\n+\t\t// the OOM error will not lead to failure of subsequent constructor call.\n+\t\tSafetyNetCloseableRegistry closeableRegistry = new SafetyNetCloseableRegistry();\n+\t\tcloseableRegistry.close();\n+\t}\n+\n+\tstatic class OutOfMemoryReaperThread extends SafetyNetCloseableRegistry.CloseableReaperThread {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc5MjQ0MA=="}, "originalCommit": {"oid": "bd9add8e480455265ca95b863601f6608918b334"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NDMyNDQxOnYy", "diffSide": "RIGHT", "path": "flink-core/src/test/java/org/apache/flink/core/fs/SafetyNetCloseableRegistryTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNzoyNDowMFrOGX-fow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwODoyODoxN1rOGYAvpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc5NDMzOQ==", "bodyText": "We can add isReaperThreadRunning checks after the failed creation and the succeeded creation.\nThis helps to verify that a reaper thread is really created and running.", "url": "https://github.com/apache/flink/pull/12181#discussion_r427794339", "createdAt": "2020-05-20T07:24:00Z", "author": {"login": "zhuzhurk"}, "path": "flink-core/src/test/java/org/apache/flink/core/fs/SafetyNetCloseableRegistryTest.java", "diffHunk": "@@ -198,4 +198,29 @@ public void testReaperThreadSpawnAndStop() throws Exception {\n \t\t}\n \t\tAssert.assertFalse(SafetyNetCloseableRegistry.isReaperThreadRunning());\n \t}\n+\n+\t/**\n+\t * Test whether failure to start thread in {@link SafetyNetCloseableRegistry}\n+\t * constructor can lead to failure of subsequent state check.\n+\t */\n+\t@Test\n+\tpublic void testReaperThreadStartFailed() throws Exception {\n+\n+\t\ttry {\n+\t\t\tnew SafetyNetCloseableRegistry(() -> new OutOfMemoryReaperThread());\n+\t\t} catch (java.lang.OutOfMemoryError error) {\n+\t\t}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd9add8e480455265ca95b863601f6608918b334"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzgzMTIwNQ==", "bodyText": "OK, I will add the check.", "url": "https://github.com/apache/flink/pull/12181#discussion_r427831205", "createdAt": "2020-05-20T08:28:17Z", "author": {"login": "wanglijie95"}, "path": "flink-core/src/test/java/org/apache/flink/core/fs/SafetyNetCloseableRegistryTest.java", "diffHunk": "@@ -198,4 +198,29 @@ public void testReaperThreadSpawnAndStop() throws Exception {\n \t\t}\n \t\tAssert.assertFalse(SafetyNetCloseableRegistry.isReaperThreadRunning());\n \t}\n+\n+\t/**\n+\t * Test whether failure to start thread in {@link SafetyNetCloseableRegistry}\n+\t * constructor can lead to failure of subsequent state check.\n+\t */\n+\t@Test\n+\tpublic void testReaperThreadStartFailed() throws Exception {\n+\n+\t\ttry {\n+\t\t\tnew SafetyNetCloseableRegistry(() -> new OutOfMemoryReaperThread());\n+\t\t} catch (java.lang.OutOfMemoryError error) {\n+\t\t}\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc5NDMzOQ=="}, "originalCommit": {"oid": "bd9add8e480455265ca95b863601f6608918b334"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1337, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}