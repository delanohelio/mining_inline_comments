{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2MjkyOTM3", "number": 13286, "title": "[FLINK-19093][task] Fix isActive check in AsyncCheckpointRunnable", "bodyText": "What is the purpose of the change\nThis is a follow up fix for #13267:\nOn close, SubtaskCheckpointCoordinator \"collects\" runnables to close under the lock,\nbut it actually closes them outside of the synchronized section.\nTherefore, runnable can observe coordinator.isClosed && runnable.isRunning state and throws an exception.\nThis PR replaces asyncCheckpointRunnable.isRunning() check with !checkpoints.containsKey(checkpointId).\nVerifying this change\nThis change is a trivial rework without any test coverage.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager no, Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? no", "createdAt": "2020-08-31T13:17:32Z", "url": "https://github.com/apache/flink/pull/13286", "merged": true, "mergeCommit": {"oid": "76f37551ad51f7eae9688495130a39b0f202c3bf"}, "closed": true, "closedAt": "2020-09-02T10:46:51Z", "author": {"login": "rkhachatryan"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEiBkUgFqTQ3OTQ1Nzk2NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE5YyqAFqTQ4MDY4NDA5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NDU3OTY1", "url": "https://github.com/apache/flink/pull/13286#pullrequestreview-479457965", "createdAt": "2020-09-01T07:11:25Z", "commit": {"oid": "358ebf0c0aaffb505bc95a97d6133183ec749d7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwNzoxMToyNVrOHKoDeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwNzoxMToyNVrOHKoDeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDkwNDA1Nw==", "bodyText": "nit: I guess it seem not very readable for message like .....releasing asyncCheckpointRunnable, 12. Maybe change to ......releasing asyncCheckpointRunnable for checkpoint 12? (Take checkpointId = 12 as example).", "url": "https://github.com/apache/flink/pull/13286#discussion_r480904057", "createdAt": "2020-09-01T07:11:25Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -366,11 +366,10 @@ private void registerAsyncCheckpointRunnable(long checkpointId, AsyncCheckpointR\n \t\tsynchronized (lock) {\n \t\t\tif (closed) {\n \t\t\t\tLOG.debug(\"Cannot register Closeable, this subtaskCheckpointCoordinator is already closed. Closing argument.\");\n-\t\t\t\tfinal boolean running = asyncCheckpointRunnable.isRunning();\n \t\t\t\tcloseQuietly(asyncCheckpointRunnable);\n \t\t\t\tcheckState(\n-\t\t\t\t\t!running,\n-\t\t\t\t\t\"SubtaskCheckpointCoordinatorImpl was closed without closing asyncCheckpointRunnable %s\",\n+\t\t\t\t\t!checkpoints.containsKey(checkpointId),\n+\t\t\t\t\t\"SubtaskCheckpointCoordinator was closed without releasing asyncCheckpointRunnable, %s\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "358ebf0c0aaffb505bc95a97d6133183ec749d7a"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NDYzNTMw", "url": "https://github.com/apache/flink/pull/13286#pullrequestreview-479463530", "createdAt": "2020-09-01T07:20:17Z", "commit": {"oid": "358ebf0c0aaffb505bc95a97d6133183ec749d7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwNzoyMDoxN1rOHKoe8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwNzoyMDoxN1rOHKoe8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDkxMTA5MQ==", "bodyText": "In the past we might encounter unnecessary exception while #registerAsyncCheckpointRunnable and AsyncCheckpointRunnable#close execute concurrently. Now we only close the runnable quietly without throwing any exception for closed case.\nI agree with this fix, but do we have any existing ITCase for covering/verifying this change?", "url": "https://github.com/apache/flink/pull/13286#discussion_r480911091", "createdAt": "2020-09-01T07:20:17Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -366,11 +366,10 @@ private void registerAsyncCheckpointRunnable(long checkpointId, AsyncCheckpointR\n \t\tsynchronized (lock) {\n \t\t\tif (closed) {\n \t\t\t\tLOG.debug(\"Cannot register Closeable, this subtaskCheckpointCoordinator is already closed. Closing argument.\");\n-\t\t\t\tfinal boolean running = asyncCheckpointRunnable.isRunning();\n \t\t\t\tcloseQuietly(asyncCheckpointRunnable);\n \t\t\t\tcheckState(\n-\t\t\t\t\t!running,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "358ebf0c0aaffb505bc95a97d6133183ec749d7a"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NDY1MTcx", "url": "https://github.com/apache/flink/pull/13286#pullrequestreview-479465171", "createdAt": "2020-09-01T07:22:46Z", "commit": {"oid": "358ebf0c0aaffb505bc95a97d6133183ec749d7a"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9578eb8c57698bec3490503073833a93a810847a", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/9578eb8c57698bec3490503073833a93a810847a", "committedDate": "2020-09-01T07:26:58Z", "message": "[FLINK-19093][task] Fix isActive check in AsyncCheckpointRunnable\n\nCurrently, the check relies on synchronization on lock.\nHowever, the lock is obtained only to update checkpoints map, actual\nclose is done outside of the synchronized block.\nThis change adds a check whether this Runnable is still in checkpoints\nmap."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "358ebf0c0aaffb505bc95a97d6133183ec749d7a", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/358ebf0c0aaffb505bc95a97d6133183ec749d7a", "committedDate": "2020-08-31T13:13:01Z", "message": "[FLINK-19093][task] Fix isActive check in AsyncCheckpointRunnable\n\nCurrently, the check relies on synchronization on lock.\nHowever, the lock is obtained only to update checkpoints map, actual\nclose is done outside of the synchronized block.\nThis change adds a check whether this Runnable is still in checkpoints\nmap."}, "afterCommit": {"oid": "9578eb8c57698bec3490503073833a93a810847a", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/9578eb8c57698bec3490503073833a93a810847a", "committedDate": "2020-09-01T07:26:58Z", "message": "[FLINK-19093][task] Fix isActive check in AsyncCheckpointRunnable\n\nCurrently, the check relies on synchronization on lock.\nHowever, the lock is obtained only to update checkpoints map, actual\nclose is done outside of the synchronized block.\nThis change adds a check whether this Runnable is still in checkpoints\nmap."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNjg0MDk1", "url": "https://github.com/apache/flink/pull/13286#pullrequestreview-480684095", "createdAt": "2020-09-02T10:24:36Z", "commit": {"oid": "9578eb8c57698bec3490503073833a93a810847a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4285, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}