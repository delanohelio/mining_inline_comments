{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwMDA2MDg2", "number": 12243, "title": "[FLINK-17805][networ] Fix ArrayIndexOutOfBound for rotated input gate indexes     ", "bodyText": "It's possible that indexes of passed InputGates are not monotonic - that left input has higher input gate index. This commit fixes an ArrayIndexOutOfBound caused by this.\nVerifying this change\nThis PR adds a dedicated unit test.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-05-19T09:51:16Z", "url": "https://github.com/apache/flink/pull/12243", "merged": true, "mergeCommit": {"oid": "c9fd502c5a508536b5d91477316e35ac168dee9b"}, "closed": true, "closedAt": "2020-05-21T19:08:19Z", "author": {"login": "pnowojski"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABci19YLgFqTQxNDU0OTQwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjhPB_gBqjMzNjE2MjIxNDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NTQ5NDAz", "url": "https://github.com/apache/flink/pull/12243#pullrequestreview-414549403", "createdAt": "2020-05-19T15:11:31Z", "commit": {"oid": "b956522108b0344ff004e859c0bc399dc8c38348"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNToxMTozMVrOGXlRFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNToxMTozMVrOGXlRFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM4MTAxMw==", "bodyText": "Yes... It took me a while to understand their usage. Why don't we make them consistent by easily sorting the inputGates before doing anything here (there's no risk if I understand correctly), so that it won't bother us in the future.", "url": "https://github.com/apache/flink/pull/12243#discussion_r427381013", "createdAt": "2020-05-19T15:11:31Z", "author": {"login": "Jiayi-Liao"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/InputProcessorUtil.java", "diffHunk": "@@ -79,11 +80,26 @@ public static CheckpointedInputGate createCheckpointedInputGate(\n \t\t\tunionedInputGates[i] = InputGateUtil.createInputGate(inputGates[i].toArray(new IndexedInputGate[0]));\n \t\t}\n \n+\t\tIntStream numberOfInputChannelsPerGate =\n+\t\t\tArrays\n+\t\t\t\t.stream(inputGates)\n+\t\t\t\t.flatMap(collection -> collection.stream())\n+\t\t\t\t.sorted(Comparator.comparingInt(IndexedInputGate::getGateIndex))\n+\t\t\t\t.mapToInt(InputGate::getNumberOfInputChannels);\n+\n \t\tMap<InputGate, Integer> inputGateToChannelIndexOffset = generateInputGateToChannelIndexOffsetMap(unionedInputGates);\n+\t\t// Note that numberOfInputChannelsPerGate and inputGateToChannelIndexOffset have a bit different", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b956522108b0344ff004e859c0bc399dc8c38348"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NTkxNjgz", "url": "https://github.com/apache/flink/pull/12243#pullrequestreview-414591683", "createdAt": "2020-05-19T15:55:30Z", "commit": {"oid": "b956522108b0344ff004e859c0bc399dc8c38348"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo1NTozMVrOGXnPtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo1NTozMVrOGXnPtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxMzQzMQ==", "bodyText": "seems redundant codes new MockChannelStateWriter()", "url": "https://github.com/apache/flink/pull/12243#discussion_r427413431", "createdAt": "2020-05-19T15:55:31Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/InputProcessorUtilTest.java", "diffHunk": "@@ -58,4 +79,57 @@ public void testGenerateInputGateToChannelIndexOffsetMap() {\n \t\tassertEquals(0, inputGateToChannelIndexOffsetMap.get(ig1).intValue());\n \t\tassertEquals(3, inputGateToChannelIndexOffsetMap.get(ig2).intValue());\n \t}\n+\n+\t@Test\n+\tpublic void testCreateCheckpointedMultipleInputGate() throws Exception {\n+\t\ttry (CloseableRegistry registry = new CloseableRegistry()) {\n+\t\t\tMockEnvironment environment = new MockEnvironmentBuilder().build();\n+\t\t\tMockStreamTask streamTask = new MockStreamTaskBuilder(environment).build();\n+\t\t\tStreamConfig streamConfig = new StreamConfig(environment.getJobConfiguration());\n+\t\t\tstreamConfig.setCheckpointMode(CheckpointingMode.EXACTLY_ONCE);\n+\t\t\tstreamConfig.setUnalignedCheckpointsEnabled(true);\n+\n+\t\t\t// First input gate has index larger than the second\n+\t\t\tCollection<IndexedInputGate>[] inputGates = new Collection[] {\n+\t\t\t\tCollections.singletonList(new MockIndexedInputGate(1, 4)),\n+\t\t\t\tCollections.singletonList(new MockIndexedInputGate(0, 2)),\n+\t\t\t};\n+\n+\t\t\tnew MockChannelStateWriter() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b956522108b0344ff004e859c0bc399dc8c38348"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NTkzMjQx", "url": "https://github.com/apache/flink/pull/12243#pullrequestreview-414593241", "createdAt": "2020-05-19T15:57:13Z", "commit": {"oid": "b956522108b0344ff004e859c0bc399dc8c38348"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo1NzoxM1rOGXnUig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo1NzoxM1rOGXnUig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxNDY2Ng==", "bodyText": "nit: might be better to place these two lines out of loop to together with barrierHandler\nCheckpointBarrierHandler barrierHandler = checkpointedMultipleInputGate[0].getCheckpointBarrierHandler();\nassertTrue(barrierHandler.getBufferReceivedListener().isPresent());\nBufferReceivedListener bufferReceivedListener = barrierHandler.getBufferReceivedListener().get();", "url": "https://github.com/apache/flink/pull/12243#discussion_r427414666", "createdAt": "2020-05-19T15:57:13Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/InputProcessorUtilTest.java", "diffHunk": "@@ -58,4 +79,57 @@ public void testGenerateInputGateToChannelIndexOffsetMap() {\n \t\tassertEquals(0, inputGateToChannelIndexOffsetMap.get(ig1).intValue());\n \t\tassertEquals(3, inputGateToChannelIndexOffsetMap.get(ig2).intValue());\n \t}\n+\n+\t@Test\n+\tpublic void testCreateCheckpointedMultipleInputGate() throws Exception {\n+\t\ttry (CloseableRegistry registry = new CloseableRegistry()) {\n+\t\t\tMockEnvironment environment = new MockEnvironmentBuilder().build();\n+\t\t\tMockStreamTask streamTask = new MockStreamTaskBuilder(environment).build();\n+\t\t\tStreamConfig streamConfig = new StreamConfig(environment.getJobConfiguration());\n+\t\t\tstreamConfig.setCheckpointMode(CheckpointingMode.EXACTLY_ONCE);\n+\t\t\tstreamConfig.setUnalignedCheckpointsEnabled(true);\n+\n+\t\t\t// First input gate has index larger than the second\n+\t\t\tCollection<IndexedInputGate>[] inputGates = new Collection[] {\n+\t\t\t\tCollections.singletonList(new MockIndexedInputGate(1, 4)),\n+\t\t\t\tCollections.singletonList(new MockIndexedInputGate(0, 2)),\n+\t\t\t};\n+\n+\t\t\tnew MockChannelStateWriter() {\n+\t\t\t\t@Override\n+\t\t\t\tpublic void addInputData(\n+\t\t\t\t\tlong checkpointId,\n+\t\t\t\t\tInputChannelInfo info,\n+\t\t\t\t\tint startSeqNum,\n+\t\t\t\t\tBuffer... data) {\n+\t\t\t\t\tsuper.addInputData(checkpointId, info, startSeqNum, data);\n+\t\t\t\t}\n+\t\t\t};\n+\n+\t\t\tCheckpointedInputGate[] checkpointedMultipleInputGate = InputProcessorUtil.createCheckpointedMultipleInputGate(\n+\t\t\t\tstreamTask,\n+\t\t\t\tstreamConfig,\n+\t\t\t\tnew MockChannelStateWriter(),\n+\t\t\t\tenvironment.getMetricGroup().getIOMetricGroup(),\n+\t\t\t\tstreamTask.getName(),\n+\t\t\t\tinputGates);\n+\t\t\tfor (CheckpointedInputGate checkpointedInputGate : checkpointedMultipleInputGate) {\n+\t\t\t\tregistry.registerCloseable(checkpointedInputGate);\n+\t\t\t}\n+\n+\t\t\tCheckpointBarrierHandler barrierHandler = checkpointedMultipleInputGate[0].getCheckpointBarrierHandler();\n+\n+\t\t\tList<IndexedInputGate> allInputGates = Arrays.stream(inputGates).flatMap(gates -> gates.stream()).collect(Collectors.toList());\n+\t\t\tfor (IndexedInputGate inputGate : allInputGates) {\n+\t\t\t\tfor (int channelId = 0; channelId < inputGate.getNumberOfInputChannels(); channelId++) {\n+\t\t\t\t\tassertTrue(barrierHandler.getBufferReceivedListener().isPresent());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b956522108b0344ff004e859c0bc399dc8c38348"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NTk0MzE5", "url": "https://github.com/apache/flink/pull/12243#pullrequestreview-414594319", "createdAt": "2020-05-19T15:58:24Z", "commit": {"oid": "b956522108b0344ff004e859c0bc399dc8c38348"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo1ODoyNFrOGXnXvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo1ODoyNFrOGXnXvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxNTQ4NQ==", "bodyText": "I am not sure why we need to verify this because it never process the barrier in this test. Maybe verify assertTrue(barrierHandler.getAllBarriersReceivedFuture(1).isDone()) instead?", "url": "https://github.com/apache/flink/pull/12243#discussion_r427415485", "createdAt": "2020-05-19T15:58:24Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/InputProcessorUtilTest.java", "diffHunk": "@@ -58,4 +79,57 @@ public void testGenerateInputGateToChannelIndexOffsetMap() {\n \t\tassertEquals(0, inputGateToChannelIndexOffsetMap.get(ig1).intValue());\n \t\tassertEquals(3, inputGateToChannelIndexOffsetMap.get(ig2).intValue());\n \t}\n+\n+\t@Test\n+\tpublic void testCreateCheckpointedMultipleInputGate() throws Exception {\n+\t\ttry (CloseableRegistry registry = new CloseableRegistry()) {\n+\t\t\tMockEnvironment environment = new MockEnvironmentBuilder().build();\n+\t\t\tMockStreamTask streamTask = new MockStreamTaskBuilder(environment).build();\n+\t\t\tStreamConfig streamConfig = new StreamConfig(environment.getJobConfiguration());\n+\t\t\tstreamConfig.setCheckpointMode(CheckpointingMode.EXACTLY_ONCE);\n+\t\t\tstreamConfig.setUnalignedCheckpointsEnabled(true);\n+\n+\t\t\t// First input gate has index larger than the second\n+\t\t\tCollection<IndexedInputGate>[] inputGates = new Collection[] {\n+\t\t\t\tCollections.singletonList(new MockIndexedInputGate(1, 4)),\n+\t\t\t\tCollections.singletonList(new MockIndexedInputGate(0, 2)),\n+\t\t\t};\n+\n+\t\t\tnew MockChannelStateWriter() {\n+\t\t\t\t@Override\n+\t\t\t\tpublic void addInputData(\n+\t\t\t\t\tlong checkpointId,\n+\t\t\t\t\tInputChannelInfo info,\n+\t\t\t\t\tint startSeqNum,\n+\t\t\t\t\tBuffer... data) {\n+\t\t\t\t\tsuper.addInputData(checkpointId, info, startSeqNum, data);\n+\t\t\t\t}\n+\t\t\t};\n+\n+\t\t\tCheckpointedInputGate[] checkpointedMultipleInputGate = InputProcessorUtil.createCheckpointedMultipleInputGate(\n+\t\t\t\tstreamTask,\n+\t\t\t\tstreamConfig,\n+\t\t\t\tnew MockChannelStateWriter(),\n+\t\t\t\tenvironment.getMetricGroup().getIOMetricGroup(),\n+\t\t\t\tstreamTask.getName(),\n+\t\t\t\tinputGates);\n+\t\t\tfor (CheckpointedInputGate checkpointedInputGate : checkpointedMultipleInputGate) {\n+\t\t\t\tregistry.registerCloseable(checkpointedInputGate);\n+\t\t\t}\n+\n+\t\t\tCheckpointBarrierHandler barrierHandler = checkpointedMultipleInputGate[0].getCheckpointBarrierHandler();\n+\n+\t\t\tList<IndexedInputGate> allInputGates = Arrays.stream(inputGates).flatMap(gates -> gates.stream()).collect(Collectors.toList());\n+\t\t\tfor (IndexedInputGate inputGate : allInputGates) {\n+\t\t\t\tfor (int channelId = 0; channelId < inputGate.getNumberOfInputChannels(); channelId++) {\n+\t\t\t\t\tassertTrue(barrierHandler.getBufferReceivedListener().isPresent());\n+\t\t\t\t\tBufferReceivedListener bufferReceivedListener = barrierHandler.getBufferReceivedListener().get();\n+\t\t\t\t\tbufferReceivedListener.notifyBarrierReceived(\n+\t\t\t\t\t\tnew CheckpointBarrier(1, 42, CheckpointOptions.forCheckpointWithDefaultLocation(true, true)),\n+\t\t\t\t\t\tnew InputChannelInfo(inputGate.getGateIndex(), channelId));\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tassertFalse(barrierHandler.isCheckpointPending());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b956522108b0344ff004e859c0bc399dc8c38348"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NTk1OTM5", "url": "https://github.com/apache/flink/pull/12243#pullrequestreview-414595939", "createdAt": "2020-05-19T16:00:08Z", "commit": {"oid": "b956522108b0344ff004e859c0bc399dc8c38348"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b956522108b0344ff004e859c0bc399dc8c38348", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/b956522108b0344ff004e859c0bc399dc8c38348", "committedDate": "2020-05-19T09:47:42Z", "message": "[FLINK-17805][networ] Fix ArrayIndexOutOfBound for rotated input gate indexes\n\nIt's possible that indexes of passed InputGates are not monotonic - that left\ninput has higher input gate index. This commit fixes an ArrayIndexOutOfBound caused\nby this."}, "afterCommit": {"oid": "ea3576b316c88212dfaf820e99ee783aeb4c2cae", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/ea3576b316c88212dfaf820e99ee783aeb4c2cae", "committedDate": "2020-05-20T13:42:09Z", "message": "[FLINK-17805][networ] Fix ArrayIndexOutOfBound for rotated input gate indexes\n\nIt's possible that indexes of passed InputGates are not monotonic - that left\ninput has higher input gate index. This commit fixes an ArrayIndexOutOfBound caused\nby this."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ea3576b316c88212dfaf820e99ee783aeb4c2cae", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/ea3576b316c88212dfaf820e99ee783aeb4c2cae", "committedDate": "2020-05-20T13:42:09Z", "message": "[FLINK-17805][networ] Fix ArrayIndexOutOfBound for rotated input gate indexes\n\nIt's possible that indexes of passed InputGates are not monotonic - that left\ninput has higher input gate index. This commit fixes an ArrayIndexOutOfBound caused\nby this."}, "afterCommit": {"oid": "08898ef30e14a10fdc27c4e79f8c9b0e2532bc3c", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/08898ef30e14a10fdc27c4e79f8c9b0e2532bc3c", "committedDate": "2020-05-20T13:42:31Z", "message": "[FLINK-17805][network] Fix ArrayIndexOutOfBound for rotated input gate indexes\n\nIt's possible that indexes of passed InputGates are not monotonic - that left\ninput has higher input gate index. This commit fixes an ArrayIndexOutOfBound caused\nby this."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6eecd749f06765d087659716e1bdba431f5b692", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/d6eecd749f06765d087659716e1bdba431f5b692", "committedDate": "2020-05-20T13:43:07Z", "message": "[FLINK-17805][hotfix][network] Fix/update/rename InputProcessorUtil.createCheckpointedInputGatePair method"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "08898ef30e14a10fdc27c4e79f8c9b0e2532bc3c", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/08898ef30e14a10fdc27c4e79f8c9b0e2532bc3c", "committedDate": "2020-05-20T13:42:31Z", "message": "[FLINK-17805][network] Fix ArrayIndexOutOfBound for rotated input gate indexes\n\nIt's possible that indexes of passed InputGates are not monotonic - that left\ninput has higher input gate index. This commit fixes an ArrayIndexOutOfBound caused\nby this."}, "afterCommit": {"oid": "a3be362324a56a5f9b118a09ea3552a3039acffe", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/a3be362324a56a5f9b118a09ea3552a3039acffe", "committedDate": "2020-05-20T13:43:07Z", "message": "[FLINK-17805][network] Fix ArrayIndexOutOfBound for rotated input gate indexes\n\nIt's possible that indexes of passed InputGates are not monotonic - that left\ninput has higher input gate index. This commit fixes an ArrayIndexOutOfBound caused\nby this."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67c3ff5187719aa012122785db68af1d9de77dc2", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/67c3ff5187719aa012122785db68af1d9de77dc2", "committedDate": "2020-05-21T17:36:14Z", "message": "[FLINK-17805][network] Fix ArrayIndexOutOfBound for rotated input gate indexes\n\nIt's possible that indexes of passed InputGates are not monotonic - that left\ninput has higher input gate index. This commit fixes an ArrayIndexOutOfBound caused\nby this."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3be362324a56a5f9b118a09ea3552a3039acffe", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/a3be362324a56a5f9b118a09ea3552a3039acffe", "committedDate": "2020-05-20T13:43:07Z", "message": "[FLINK-17805][network] Fix ArrayIndexOutOfBound for rotated input gate indexes\n\nIt's possible that indexes of passed InputGates are not monotonic - that left\ninput has higher input gate index. This commit fixes an ArrayIndexOutOfBound caused\nby this."}, "afterCommit": {"oid": "67c3ff5187719aa012122785db68af1d9de77dc2", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/67c3ff5187719aa012122785db68af1d9de77dc2", "committedDate": "2020-05-21T17:36:14Z", "message": "[FLINK-17805][network] Fix ArrayIndexOutOfBound for rotated input gate indexes\n\nIt's possible that indexes of passed InputGates are not monotonic - that left\ninput has higher input gate index. This commit fixes an ArrayIndexOutOfBound caused\nby this."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4604, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}