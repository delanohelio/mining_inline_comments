{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwOTkzMjEw", "number": 13209, "title": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout", "bodyText": "What is the purpose of the change\nThe current BoundedBlockingSubpartition in runtime does not support positive flush timeout setting by design based on the current scheduler strategy. So it is nice to check this compatibility during job graph generation and give some helpful messages for guiding users, which can avoid potential concurrent issues in runtime stack.\nBrief change log\n\nRemove default buffer timeout setting in StreamGraphGenerator\nAdd checkCompatible method in StreamingJobGraphGenerator\n\nVerifying this change\nAdd new testNormalShuffleModeWithBufferTimeout and testConflictShuffleModeWithBufferTimeout for verifying the effect.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-08-20T15:30:57Z", "url": "https://github.com/apache/flink/pull/13209", "merged": true, "mergeCommit": {"oid": "13e0b355d1d9ba513671de1638d3c35edb6b96a3"}, "closed": true, "closedAt": "2020-09-07T15:01:42Z", "author": {"login": "zhijiangW"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBBhinABqjM2Nzg4Mjg4NTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGeieFgBqjM3MzU4OTc3NjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "92b731b4954f21979b22765e84725974942273e3", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/92b731b4954f21979b22765e84725974942273e3", "committedDate": "2020-08-20T15:26:50Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout\n\nThe current BoundedBlockingSubpartition in runtime does not support positive flush timeout setting by design\nbased on the current scheduler strategy. So it is nice to check this compatibility during job graph generation\nand give some helpful messages for guiding users, which can avoid potential concurrent issues in runtime stack."}, "afterCommit": {"oid": "22f17388c9b9beba64aa8ab4bcd2c0ae6d344308", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/22f17388c9b9beba64aa8ab4bcd2c0ae6d344308", "committedDate": "2020-08-21T07:53:30Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout\n\nThe current BoundedBlockingSubpartition in runtime does not support positive flush timeout setting."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "22f17388c9b9beba64aa8ab4bcd2c0ae6d344308", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/22f17388c9b9beba64aa8ab4bcd2c0ae6d344308", "committedDate": "2020-08-21T07:53:30Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout\n\nThe current BoundedBlockingSubpartition in runtime does not support positive flush timeout setting."}, "afterCommit": {"oid": "16693da5e62a40ab86491c9d67679b838078725f", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/16693da5e62a40ab86491c9d67679b838078725f", "committedDate": "2020-08-26T07:03:18Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout\n\nThe current BoundedBlockingSubpartition in runtime does not support positive flush timeout setting."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "16693da5e62a40ab86491c9d67679b838078725f", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/16693da5e62a40ab86491c9d67679b838078725f", "committedDate": "2020-08-26T07:03:18Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout\n\nThe current BoundedBlockingSubpartition in runtime does not support positive flush timeout setting."}, "afterCommit": {"oid": "454310e0df591eac9dd81940f3cf690185155c70", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/454310e0df591eac9dd81940f3cf690185155c70", "committedDate": "2020-08-26T10:58:27Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout\n\nThe current BoundedBlockingSubpartition in runtime does not support positive flush timeout setting."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NzkzNDE1", "url": "https://github.com/apache/flink/pull/13209#pullrequestreview-475793415", "createdAt": "2020-08-26T19:26:22Z", "commit": {"oid": "454310e0df591eac9dd81940f3cf690185155c70"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOToyNjoyM1rOHHakOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOTo0Mzo1MVrOHHbIHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzNzMzOA==", "bodyText": "Can you explain the reasoning behind removing this branch?\nI think we still need it, because if the user doesn't set a timeout for transformation then default job timeout should be used.", "url": "https://github.com/apache/flink/pull/13209#discussion_r477537338", "createdAt": "2020-08-26T19:26:23Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamGraphGenerator.java", "diffHunk": "@@ -285,11 +285,7 @@ public StreamGraph generate() {\n \t\t\talreadyTransformed.put(transform, transformedIds);\n \t\t}\n \n-\t\tif (transform.getBufferTimeout() >= 0) {\n-\t\t\tstreamGraph.setBufferTimeout(transform.getId(), transform.getBufferTimeout());\n-\t\t} else {\n-\t\t\tstreamGraph.setBufferTimeout(transform.getId(), defaultBufferTimeout);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454310e0df591eac9dd81940f3cf690185155c70"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0MjAxOA==", "bodyText": "I think adding the timeout value and edge.toString could help to find out misconfguration to the user.", "url": "https://github.com/apache/flink/pull/13209#discussion_r477542018", "createdAt": "2020-08-26T19:35:19Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java", "diffHunk": "@@ -591,6 +593,13 @@ private void connect(Integer headOfChain, StreamEdge edge) {\n \t\t}\n \t}\n \n+\tprivate void checkCompatible(ResultPartitionType type, long bufferTimeout) {\n+\t\tif (type.isBlocking() && bufferTimeout != -1) {\n+\t\t\tthrow new UnsupportedOperationException(\"Blocking partition does not support buffer timeout at the\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454310e0df591eac9dd81940f3cf690185155c70"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0NjUyNw==", "bodyText": "If we keep using the default timeout (discussion above),\nthen the issue also happens with StreamExecutionEnvironment.setBufferTimeout(100) or even default, right?", "url": "https://github.com/apache/flink/pull/13209#discussion_r477546527", "createdAt": "2020-08-26T19:43:51Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGeneratorTest.java", "diffHunk": "@@ -609,6 +609,33 @@ public void testShuffleModeUndefined() {\n \t\t\tsourceAndMapVertex.getProducedDataSets().get(0).getResultType());\n \t}\n \n+\t@Test(expected = UnsupportedOperationException.class)\n+\tpublic void testConflictShuffleModeWithBufferTimeout() {\n+\t\ttestCompatibleShuffleModeWithBufferTimeout(ShuffleMode.BATCH);\n+\t}\n+\n+\t@Test\n+\tpublic void testNormalShuffleModeWithBufferTimeout() {\n+\t\ttestCompatibleShuffleModeWithBufferTimeout(ShuffleMode.PIPELINED);\n+\t}\n+\n+\tprivate void testCompatibleShuffleModeWithBufferTimeout(ShuffleMode shuffleMode) {\n+\t\tStreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+\n+\t\tDataStream<Integer> sourceDataStream = env.fromElements(1, 2, 3);\n+\t\tsourceDataStream.getTransformation().setBufferTimeout(100);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454310e0df591eac9dd81940f3cf690185155c70"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "454310e0df591eac9dd81940f3cf690185155c70", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/454310e0df591eac9dd81940f3cf690185155c70", "committedDate": "2020-08-26T10:58:27Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout\n\nThe current BoundedBlockingSubpartition in runtime does not support positive flush timeout setting."}, "afterCommit": {"oid": "6c9e08bd3fecd65c7ea696f7285a106393739bdc", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/6c9e08bd3fecd65c7ea696f7285a106393739bdc", "committedDate": "2020-08-28T10:09:29Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c9e08bd3fecd65c7ea696f7285a106393739bdc", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/6c9e08bd3fecd65c7ea696f7285a106393739bdc", "committedDate": "2020-08-28T10:09:29Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}, "afterCommit": {"oid": "6b299eb84623c97e80fcd15d64702fb993947186", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/6b299eb84623c97e80fcd15d64702fb993947186", "committedDate": "2020-08-28T10:12:08Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6b299eb84623c97e80fcd15d64702fb993947186", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/6b299eb84623c97e80fcd15d64702fb993947186", "committedDate": "2020-08-28T10:12:08Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}, "afterCommit": {"oid": "b05578c2b19808e488db3f520a0f09faee07a6ce", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/b05578c2b19808e488db3f520a0f09faee07a6ce", "committedDate": "2020-08-28T10:49:11Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b05578c2b19808e488db3f520a0f09faee07a6ce", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/b05578c2b19808e488db3f520a0f09faee07a6ce", "committedDate": "2020-08-28T10:49:11Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}, "afterCommit": {"oid": "a343c2c3bf36c97dca7045c65eccbcccfbbef5bf", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/a343c2c3bf36c97dca7045c65eccbcccfbbef5bf", "committedDate": "2020-08-28T10:52:07Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a343c2c3bf36c97dca7045c65eccbcccfbbef5bf", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/a343c2c3bf36c97dca7045c65eccbcccfbbef5bf", "committedDate": "2020-08-28T10:52:07Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}, "afterCommit": {"oid": "ac0be4b2ad8d19ecaa24923b7cdbd4a5edcd3601", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/ac0be4b2ad8d19ecaa24923b7cdbd4a5edcd3601", "committedDate": "2020-08-28T10:55:02Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac0be4b2ad8d19ecaa24923b7cdbd4a5edcd3601", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/ac0be4b2ad8d19ecaa24923b7cdbd4a5edcd3601", "committedDate": "2020-08-28T10:55:02Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}, "afterCommit": {"oid": "3de3f59281d22f21dfbb30cf7d93b1ecd3165a9e", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/3de3f59281d22f21dfbb30cf7d93b1ecd3165a9e", "committedDate": "2020-08-28T11:08:22Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3de3f59281d22f21dfbb30cf7d93b1ecd3165a9e", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/3de3f59281d22f21dfbb30cf7d93b1ecd3165a9e", "committedDate": "2020-08-28T11:08:22Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}, "afterCommit": {"oid": "0ae129370bd5135099c3d195cc36e656f656e35d", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/0ae129370bd5135099c3d195cc36e656f656e35d", "committedDate": "2020-08-31T04:00:14Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ae129370bd5135099c3d195cc36e656f656e35d", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/0ae129370bd5135099c3d195cc36e656f656e35d", "committedDate": "2020-08-31T04:00:14Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}, "afterCommit": {"oid": "ec3be2e6f417e344583e984579a6734825750546", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/ec3be2e6f417e344583e984579a6734825750546", "committedDate": "2020-08-31T04:40:10Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ec3be2e6f417e344583e984579a6734825750546", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/ec3be2e6f417e344583e984579a6734825750546", "committedDate": "2020-08-31T04:40:10Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}, "afterCommit": {"oid": "895da41424f7b688b26c469b61e3d024b0e325ed", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/895da41424f7b688b26c469b61e3d024b0e325ed", "committedDate": "2020-09-01T03:06:07Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "895da41424f7b688b26c469b61e3d024b0e325ed", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/895da41424f7b688b26c469b61e3d024b0e325ed", "committedDate": "2020-09-01T03:06:07Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}, "afterCommit": {"oid": "b8fbd1b09c94299a7f0de5ec7897d962572b38f1", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/b8fbd1b09c94299a7f0de5ec7897d962572b38f1", "committedDate": "2020-09-01T09:55:50Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b8fbd1b09c94299a7f0de5ec7897d962572b38f1", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/b8fbd1b09c94299a7f0de5ec7897d962572b38f1", "committedDate": "2020-09-01T09:55:50Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}, "afterCommit": {"oid": "3564146f76e2ee9152f1afdccbb75d29dd0efbe8", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/3564146f76e2ee9152f1afdccbb75d29dd0efbe8", "committedDate": "2020-09-03T10:23:51Z", "message": "modf8"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3564146f76e2ee9152f1afdccbb75d29dd0efbe8", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/3564146f76e2ee9152f1afdccbb75d29dd0efbe8", "committedDate": "2020-09-03T10:23:51Z", "message": "modf8"}, "afterCommit": {"oid": "11331396d796e39661c2ced405a6db61be745927", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/11331396d796e39661c2ced405a6db61be745927", "committedDate": "2020-09-03T10:25:02Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "11331396d796e39661c2ced405a6db61be745927", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/11331396d796e39661c2ced405a6db61be745927", "committedDate": "2020-09-03T10:25:02Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}, "afterCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/5c5e70c8a3a1831c1e4715378158eafa93bed707", "committedDate": "2020-09-03T10:34:23Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxOTQ0NjM5", "url": "https://github.com/apache/flink/pull/13209#pullrequestreview-481944639", "createdAt": "2020-09-03T15:16:19Z", "commit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNToxNjoxOVrOHMrfZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNTozNDoyMVrOHMsTFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1NzUwOQ==", "bodyText": "nit: define constant, e.g. FLUSH_ALWAYS?", "url": "https://github.com/apache/flink/pull/13209#discussion_r483057509", "createdAt": "2020-09-03T15:16:19Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamEdge.java", "diffHunk": "@@ -76,32 +76,68 @@\n \n \tprivate final ShuffleMode shuffleMode;\n \n-\tpublic StreamEdge(StreamNode sourceVertex, StreamNode targetVertex, int typeNumber,\n-\t\t\tList<String> selectedNames, StreamPartitioner<?> outputPartitioner, OutputTag outputTag) {\n-\t\tthis(sourceVertex,\n-\t\t\t\ttargetVertex,\n-\t\t\t\ttypeNumber,\n-\t\t\t\tselectedNames,\n-\t\t\t\toutputPartitioner,\n-\t\t\t\toutputTag,\n-\t\t\t\tShuffleMode.UNDEFINED);\n-\t}\n-\n-\tpublic StreamEdge(StreamNode sourceVertex, StreamNode targetVertex, int typeNumber,\n-\t\t\tList<String> selectedNames, StreamPartitioner<?> outputPartitioner, OutputTag outputTag,\n-\t\t\tShuffleMode shuffleMode) {\n+\tprivate long bufferTimeout;\n+\n+\tpublic StreamEdge(\n+\t\tStreamNode sourceVertex,\n+\t\tStreamNode targetVertex,\n+\t\tint typeNumber,\n+\t\tList<String> selectedNames,\n+\t\tStreamPartitioner<?> outputPartitioner,\n+\t\tOutputTag outputTag) {\n+\n+\t\tthis(\n+\t\t\tsourceVertex,\n+\t\t\ttargetVertex,\n+\t\t\ttypeNumber,\n+\t\t\t0,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1NzY3Mg==", "bodyText": "nit: indentation (other constructors too).", "url": "https://github.com/apache/flink/pull/13209#discussion_r483057672", "createdAt": "2020-09-03T15:16:33Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamEdge.java", "diffHunk": "@@ -76,32 +76,68 @@\n \n \tprivate final ShuffleMode shuffleMode;\n \n-\tpublic StreamEdge(StreamNode sourceVertex, StreamNode targetVertex, int typeNumber,\n-\t\t\tList<String> selectedNames, StreamPartitioner<?> outputPartitioner, OutputTag outputTag) {\n-\t\tthis(sourceVertex,\n-\t\t\t\ttargetVertex,\n-\t\t\t\ttypeNumber,\n-\t\t\t\tselectedNames,\n-\t\t\t\toutputPartitioner,\n-\t\t\t\toutputTag,\n-\t\t\t\tShuffleMode.UNDEFINED);\n-\t}\n-\n-\tpublic StreamEdge(StreamNode sourceVertex, StreamNode targetVertex, int typeNumber,\n-\t\t\tList<String> selectedNames, StreamPartitioner<?> outputPartitioner, OutputTag outputTag,\n-\t\t\tShuffleMode shuffleMode) {\n+\tprivate long bufferTimeout;\n+\n+\tpublic StreamEdge(\n+\t\tStreamNode sourceVertex,\n+\t\tStreamNode targetVertex,\n+\t\tint typeNumber,\n+\t\tList<String> selectedNames,\n+\t\tStreamPartitioner<?> outputPartitioner,\n+\t\tOutputTag outputTag) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA2MTA3Mw==", "bodyText": "nit: use constant? (already defined below)", "url": "https://github.com/apache/flink/pull/13209#discussion_r483061073", "createdAt": "2020-09-03T15:20:59Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamGraphGenerator.java", "diffHunk": "@@ -127,7 +124,7 @@\n \n \tprivate TimeCharacteristic timeCharacteristic = DEFAULT_TIME_CHARACTERISTIC;\n \n-\tprivate long defaultBufferTimeout = DEFAULT_NETWORK_BUFFER_TIMEOUT;\n+\tprivate long defaultBufferTimeout = -1L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA2MjQzOQ==", "bodyText": "nit: rename to UNSPECIFIED or ON_BUFFER_FULL?", "url": "https://github.com/apache/flink/pull/13209#discussion_r483062439", "createdAt": "2020-09-03T15:22:53Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java", "diffHunk": "@@ -99,6 +99,10 @@\n \n \tprivate static final int MANAGED_MEMORY_FRACTION_SCALE = 16;\n \n+\tprivate static final long DEFAULT_PIPELINED_BUFFER_TIMEOUT = 100L;\n+\n+\tprivate static final long DEFAULT_BLOCKING_BUFFER_TIMEOUT = -1L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA2OTA4NQ==", "bodyText": "nit: check that current buffer timeout is not set (-1)? or alternatively move checkAndResetBufferTimeout logic into StreamEdge", "url": "https://github.com/apache/flink/pull/13209#discussion_r483069085", "createdAt": "2020-09-03T15:31:56Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamEdge.java", "diffHunk": "@@ -136,6 +172,14 @@ public void setPartitioner(StreamPartitioner<?> partitioner) {\n \t\tthis.outputPartitioner = partitioner;\n \t}\n \n+\tpublic void setBufferTimeout(long bufferTimeout) {\n+\t\tthis.bufferTimeout = bufferTimeout;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA3MDc0Mg==", "bodyText": "I'd also test for 0 timeout as it is treated specially.", "url": "https://github.com/apache/flink/pull/13209#discussion_r483070742", "createdAt": "2020-09-03T15:34:21Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGeneratorTest.java", "diffHunk": "@@ -609,6 +609,32 @@ public void testShuffleModeUndefined() {\n \t\t\tsourceAndMapVertex.getProducedDataSets().get(0).getResultType());\n \t}\n \n+\t@Test(expected = UnsupportedOperationException.class)\n+\tpublic void testConflictShuffleModeWithBufferTimeout() {\n+\t\ttestCompatibleShuffleModeWithBufferTimeout(ShuffleMode.BATCH);\n+\t}\n+\n+\t@Test\n+\tpublic void testNormalShuffleModeWithBufferTimeout() {\n+\t\ttestCompatibleShuffleModeWithBufferTimeout(ShuffleMode.PIPELINED);\n+\t}\n+\n+\tprivate void testCompatibleShuffleModeWithBufferTimeout(ShuffleMode shuffleMode) {\n+\t\tStreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+\t\tenv.setBufferTimeout(100);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/5c5e70c8a3a1831c1e4715378158eafa93bed707", "committedDate": "2020-09-03T10:34:23Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}, "afterCommit": {"oid": "fd8b1df7cebdeaeeea8f271a8c42c45f8f861f83", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/fd8b1df7cebdeaeeea8f271a8c42c45f8f861f83", "committedDate": "2020-09-07T03:51:47Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd8b1df7cebdeaeeea8f271a8c42c45f8f861f83", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/fd8b1df7cebdeaeeea8f271a8c42c45f8f861f83", "committedDate": "2020-09-07T03:51:47Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout"}, "afterCommit": {"oid": "e1fe91323c1bf710d16a9ab02150a70a7a7e14e1", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/e1fe91323c1bf710d16a9ab02150a70a7a7e14e1", "committedDate": "2020-09-07T03:55:48Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout\n\nFrom the requirement it is no need to enable buffer timeout for batch jobs since the downstream can only consume data when the upstream finishes.\nFurthermore the current implementation of BoundedBlockingSubpartition does not consider the concurrent issue from the flusher thread by enabling\nbuffer timeout. So it is nice to check this compatibility during job graph generation in advance and give a friendly message hint for users.\n\nThis closes #13209."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85c2b040fe9c9275fa03ce075ac60a3e3fcd0f5a", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/85c2b040fe9c9275fa03ce075ac60a3e3fcd0f5a", "committedDate": "2020-09-07T04:10:35Z", "message": "[hotfix][datastream] Fix the formatting of StreamEdge class"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1fe91323c1bf710d16a9ab02150a70a7a7e14e1", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/e1fe91323c1bf710d16a9ab02150a70a7a7e14e1", "committedDate": "2020-09-07T03:55:48Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout\n\nFrom the requirement it is no need to enable buffer timeout for batch jobs since the downstream can only consume data when the upstream finishes.\nFurthermore the current implementation of BoundedBlockingSubpartition does not consider the concurrent issue from the flusher thread by enabling\nbuffer timeout. So it is nice to check this compatibility during job graph generation in advance and give a friendly message hint for users.\n\nThis closes #13209."}, "afterCommit": {"oid": "d41657dbc2a5610ab94e6463b32c87a53224f30c", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/d41657dbc2a5610ab94e6463b32c87a53224f30c", "committedDate": "2020-09-07T04:12:06Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout\n\nFrom the requirement it is no need to enable buffer timeout for batch jobs since the downstream can only consume data when the upstream finishes.\nFurthermore the current implementation of BoundedBlockingSubpartition does not consider the concurrent issue from the flusher thread by enabling\nbuffer timeout. So it is nice to check this compatibility during job graph generation in advance and give a friendly message hint for users.\n\nThis closes #13209."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d41657dbc2a5610ab94e6463b32c87a53224f30c", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/d41657dbc2a5610ab94e6463b32c87a53224f30c", "committedDate": "2020-09-07T04:12:06Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout\n\nFrom the requirement it is no need to enable buffer timeout for batch jobs since the downstream can only consume data when the upstream finishes.\nFurthermore the current implementation of BoundedBlockingSubpartition does not consider the concurrent issue from the flusher thread by enabling\nbuffer timeout. So it is nice to check this compatibility during job graph generation in advance and give a friendly message hint for users.\n\nThis closes #13209."}, "afterCommit": {"oid": "79b151e66afb2420c4d41d24961ac853d217ba76", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/79b151e66afb2420c4d41d24961ac853d217ba76", "committedDate": "2020-09-07T04:14:42Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout\n\nFrom the requirement it is no need to enable buffer timeout for batch jobs since the downstream can only consume data when the upstream finishes.\nFurthermore the current implementation of BoundedBlockingSubpartition does not consider the concurrent issue from the flusher thread by enabling\nbuffer timeout. So it is nice to check this compatibility during job graph generation in advance and give a friendly message hint for users.\n\nThis closes #13209."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "873283f82fa92bd1634f39846ac8142d3f580094", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/873283f82fa92bd1634f39846ac8142d3f580094", "committedDate": "2020-09-07T08:15:07Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout\n\nFrom the requirement it is no need to enable buffer timeout for batch jobs since the downstream can only consume data when the upstream finishes.\nFurthermore the current implementation of BoundedBlockingSubpartition does not consider the concurrent issue from the flusher thread by enabling\nbuffer timeout. So it is nice to check this compatibility during job graph generation in advance and give a friendly message hint for users.\n\nThis closes #13209."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79b151e66afb2420c4d41d24961ac853d217ba76", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/79b151e66afb2420c4d41d24961ac853d217ba76", "committedDate": "2020-09-07T04:14:42Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout\n\nFrom the requirement it is no need to enable buffer timeout for batch jobs since the downstream can only consume data when the upstream finishes.\nFurthermore the current implementation of BoundedBlockingSubpartition does not consider the concurrent issue from the flusher thread by enabling\nbuffer timeout. So it is nice to check this compatibility during job graph generation in advance and give a friendly message hint for users.\n\nThis closes #13209."}, "afterCommit": {"oid": "873283f82fa92bd1634f39846ac8142d3f580094", "author": {"user": {"login": "zhijiangW", "name": "zhijiang"}}, "url": "https://github.com/apache/flink/commit/873283f82fa92bd1634f39846ac8142d3f580094", "committedDate": "2020-09-07T08:15:07Z", "message": "[FLINK-18832][datastream] Add compatible check for blocking partition with buffer timeout\n\nFrom the requirement it is no need to enable buffer timeout for batch jobs since the downstream can only consume data when the upstream finishes.\nFurthermore the current implementation of BoundedBlockingSubpartition does not consider the concurrent issue from the flusher thread by enabling\nbuffer timeout. So it is nice to check this compatibility during job graph generation in advance and give a friendly message hint for users.\n\nThis closes #13209."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4670, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}