{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2NjcyMjcw", "number": 12099, "title": "[FLINK-17633][table-common] Improve FactoryUtil to align with new format options keys", "bodyText": "What is the purpose of the change\nThe current discoverScan/SinkFormat implementation in FactoryUtil uses value.format.fail-on-missing-field as the format options. However, as discussed in mailing list,  the following format options are proposed to use:\nformat = json\njson.fail-on-missing-field = true\njson.ignore-parse-error = true\n\nvalue.format = json\nvalue.json.fail-on-missing-field = true\nvalue.json.ignore-parse-error = true\n\nSo that we should update the format discovery in FactoryUtil to make it more easy to use in connectors.\nBrief change log\n\nremove formatPrefix parameter from discoverScanFormat and discoverSinkFormat.\nderive the formatPrefix according to the identifier and formatOption in TableFactoryHelper.\n\nVerifying this change\n\nUpdate TestDynamicTableFactory to use the new format options.\nUpdate TestDynamicTableFactory to support discover alternative value format which uses format key.\nUpdate FactoryUtilTest.\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): yes\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? not applicable", "createdAt": "2020-05-12T11:46:08Z", "url": "https://github.com/apache/flink/pull/12099", "merged": true, "mergeCommit": {"oid": "646be5a4c635e069614ce6254556b614bf7b9657"}, "closed": true, "closedAt": "2020-05-13T02:57:55Z", "author": {"login": "wuchong"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgiw4EgH2gAyNDE2NjcyMjcwOjhiODI4OTE0NDg3MWQ0MGU0N2IwZDg4NTZlMmU3M2MyOGY0MDZlZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgkvGMgH2gAyNDE2NjcyMjcwOmQwYWQzZjdjNjczMTk0MmEyZWU2NmQwMmI2MzczYTIyZGMxMDg1ZTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8b8289144871d40e47b0d8856e2e73c28f406ee2", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/8b8289144871d40e47b0d8856e2e73c28f406ee2", "committedDate": "2020-05-12T11:41:49Z", "message": "[FLINK-17633][table-common] Improve FactoryUtil to align with new format options keys"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5OTY1MTYw", "url": "https://github.com/apache/flink/pull/12099#pullrequestreview-409965160", "createdAt": "2020-05-12T11:55:26Z", "commit": {"oid": "8b8289144871d40e47b0d8856e2e73c28f406ee2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMTo1NToyN1rOGUDBMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMjowODo0NVrOGUDdgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY3NDE2MQ==", "bodyText": "We can move those 3 format options into FactoryUtil and add a description to them. Because there is a implicit dependency on the string format.", "url": "https://github.com/apache/flink/pull/12099#discussion_r423674161", "createdAt": "2020-05-12T11:55:27Z", "author": {"login": "twalthr"}, "path": "flink-table/flink-table-common/src/test/java/org/apache/flink/table/factories/TestDynamicTableFactory.java", "diffHunk": "@@ -56,12 +56,17 @@\n \t\t.defaultValue(100L);\n \n \tpublic static final ConfigOption<String> KEY_FORMAT = ConfigOptions", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b8289144871d40e47b0d8856e2e73c28f406ee2"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY4MTQwOQ==", "bodyText": "If we require an formatOption here, we should definitely provide the default ones as static fields in FactoryUtil. We can then also link them in the Java doc. Instead of copying this big text 4 times, I would suggest to add it to the createTableFactoryHelper.", "url": "https://github.com/apache/flink/pull/12099#discussion_r423681409", "createdAt": "2020-05-12T12:08:45Z", "author": {"login": "twalthr"}, "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/factories/FactoryUtil.java", "diffHunk": "@@ -378,13 +376,17 @@ private TableFactoryHelper(DynamicTableFactory tableFactory, DynamicTableFactory\n \t\t/**\n \t\t * Discovers a {@link ScanFormat} of the given type using the given option as factory identifier.\n \t\t *\n-\t\t * <p>A prefix, e.g. {@link #KEY_FORMAT_PREFIX}, projects the options for the format factory.\n+\t\t * <p>The format option key must be 'format' or with '.format' suffix. The discovery logic\n+\t\t * will replace 'format' with the factory identifier value as the format prefix.\n+\t\t * For example, assuming the identifier is 'json', if format option key is 'format',\n+\t\t * then format prefix is 'json.'. If format option key is 'value.format', then format\n+\t\t * prefix is 'value.json'. The format prefix is used to project the options for the\n+\t\t * format factory.\n \t\t */\n \t\tpublic <I, F extends ScanFormatFactory<I>> ScanFormat<I> discoverScanFormat(\n \t\t\t\tClass<F> formatFactoryClass,\n-\t\t\t\tConfigOption<String> formatOption,\n-\t\t\t\tString formatPrefix) {\n-\t\t\treturn discoverOptionalScanFormat(formatFactoryClass, formatOption, formatPrefix)\n+\t\t\t\tConfigOption<String> formatOption) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b8289144871d40e47b0d8856e2e73c28f406ee2"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5c28dbc318a940e8a5f0611b5ae1be8a295b98c", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/f5c28dbc318a940e8a5f0611b5ae1be8a295b98c", "committedDate": "2020-05-12T12:46:26Z", "message": "address comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMDcwNjk5", "url": "https://github.com/apache/flink/pull/12099#pullrequestreview-410070699", "createdAt": "2020-05-12T13:58:59Z", "commit": {"oid": "f5c28dbc318a940e8a5f0611b5ae1be8a295b98c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0ad3f7c6731942a2ee66d02b6373a22dc1085e3", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/d0ad3f7c6731942a2ee66d02b6373a22dc1085e3", "committedDate": "2020-05-12T13:59:41Z", "message": "add description for format ConfigOptions."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4314, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}