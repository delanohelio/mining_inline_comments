{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1MDY1Njcx", "number": 12028, "title": "[FLINK-17553][table]fix plan error when constant exists in group window key", "bodyText": "What is the purpose of the change\n*When constant exists in group window key leads to  error:  Unsupported call:TUMBLE_END(TIMESTAMP(3) NOT NULL), detail exception can be found in FLINK-17553. This pr aims to solve this problem. *\nBrief change log\n\n#e51960b add ProjectMergeRule after AggregateProjectPullUpConstantsRule.INSTANCE to solve the bug\n\nVerifying this change\nThis change added tests and can be verified as follows:\n\nAdded test testWindowGroupByOnConstant  to verify the plan as expect\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (no)\nThe serializers: (no)\nThe runtime per-record code paths (performance sensitive): (no)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (no)\nThe S3 file system connector: ( no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (no)\nIf yes, how is the feature documented? (not applicable)", "createdAt": "2020-05-08T06:10:43Z", "url": "https://github.com/apache/flink/pull/12028", "merged": true, "mergeCommit": {"oid": "c67109e99437d1dcca9fb6fca9f2741747c82a04"}, "closed": true, "closedAt": "2020-06-05T08:27:55Z", "author": {"login": "zjuwangg"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABckoXPygFqTQxNzQ0OTcwMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoKqoUAFqTQyNDk4MzE1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NDQ5NzAy", "url": "https://github.com/apache/flink/pull/12028#pullrequestreview-417449702", "createdAt": "2020-05-25T04:27:03Z", "commit": {"oid": "e51960bfa9933fc5515fde87896dbee100ef41f8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNDoyNzowM1rOGZ0a8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNDoyNzowM1rOGZ0a8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTcyNjQ1MQ==", "bodyText": "please give a more clear comment here", "url": "https://github.com/apache/flink/pull/12028#discussion_r429726451", "createdAt": "2020-05-25T04:27:03Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/rules/FlinkStreamRuleSets.scala", "diffHunk": "@@ -109,6 +109,8 @@ object FlinkStreamRuleSets {\n       List(\n         //removes constant keys from an Agg\n         AggregateProjectPullUpConstantsRule.INSTANCE,\n+        //fix: FLINK-17553", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e51960bfa9933fc5515fde87896dbee100ef41f8"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16ddb21da79c3369bb7b7cbc6634ae3eed27b2e1", "author": {"user": {"login": "zjuwangg", "name": "Terry Wang"}}, "url": "https://github.com/apache/flink/commit/16ddb21da79c3369bb7b7cbc6634ae3eed27b2e1", "committedDate": "2020-05-25T05:53:09Z", "message": "[FLINK-17553][table]fix plan error when constant exists in group window key"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "004b3125aaed2507a0b3047e8bdc3d83fab2314c", "author": {"user": {"login": "zjuwangg", "name": "Terry Wang"}}, "url": "https://github.com/apache/flink/commit/004b3125aaed2507a0b3047e8bdc3d83fab2314c", "committedDate": "2020-05-25T06:26:53Z", "message": "modify comment more"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ffb28916f4d997ff9294f2df87389c79a7d1951", "author": {"user": {"login": "zjuwangg", "name": "Terry Wang"}}, "url": "https://github.com/apache/flink/commit/5ffb28916f4d997ff9294f2df87389c79a7d1951", "committedDate": "2020-05-25T06:37:28Z", "message": "add itcase to verify fix work normally"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e51960bfa9933fc5515fde87896dbee100ef41f8", "author": {"user": {"login": "zjuwangg", "name": "Terry Wang"}}, "url": "https://github.com/apache/flink/commit/e51960bfa9933fc5515fde87896dbee100ef41f8", "committedDate": "2020-05-08T05:32:44Z", "message": "[FLINK-17553][table]fix plan error when constant exists in group window key"}, "afterCommit": {"oid": "5ffb28916f4d997ff9294f2df87389c79a7d1951", "author": {"user": {"login": "zjuwangg", "name": "Terry Wang"}}, "url": "https://github.com/apache/flink/commit/5ffb28916f4d997ff9294f2df87389c79a7d1951", "committedDate": "2020-05-25T06:37:28Z", "message": "add itcase to verify fix work normally"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3OTQ0MTA5", "url": "https://github.com/apache/flink/pull/12028#pullrequestreview-417944109", "createdAt": "2020-05-26T03:08:59Z", "commit": {"oid": "5ffb28916f4d997ff9294f2df87389c79a7d1951"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwMzowODo1OVrOGaNUjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwMzoyMjoxNVrOGaNeow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEzNDQxMg==", "bodyText": "nit: redundant empty line", "url": "https://github.com/apache/flink/pull/12028#discussion_r430134412", "createdAt": "2020-05-26T03:08:59Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/stream/sql/WindowAggregateITCase.scala", "diffHunk": "@@ -319,6 +319,49 @@ class WindowAggregateITCase(mode: StateBackendMode)\n     assertEquals(expected.sorted, sink.getRetractResults.sorted)\n   }\n \n+  // used to verify compile works normally when constants exists in group window key (FLINK-17553)\n+  @Test\n+  def testWindowAggregateOnConstantValue(): Unit = {\n+    val ddl1 =\n+      \"\"\"\n+        |CREATE TABLE src (\n+        |  log_ts STRING,\n+        |  ts TIMESTAMP(3),\n+        |  a INT,\n+        |  b DOUBLE,\n+        |  rowtime AS CAST(log_ts AS TIMESTAMP(3)),\n+        |  WATERMARK FOR rowtime AS rowtime - INTERVAL '0.001' SECOND\n+        |) WITH (\n+        |  'connector' = 'COLLECTION',\n+        |  'is-bounded' = 'false'\n+        |)\n+      \"\"\".stripMargin\n+    val ddl2 =\n+      \"\"\"\n+        |CREATE TABLE dst (\n+        |  ts TIMESTAMP(3),\n+        |  a BIGINT,\n+        |  b DOUBLE\n+        |) WITH (\n+        |  'connector.type' = 'filesystem',\n+        |  'connector.path' = '/tmp/1',\n+        |  'format.type' = 'csv'\n+        |)\n+      \"\"\".stripMargin\n+    val query =\n+      \"\"\"\n+        |INSERT INTO dst\n+        |SELECT TUMBLE_END(rowtime, INTERVAL '0.003' SECOND), COUNT(ts), SUM(b)\n+        |FROM src\n+        | GROUP BY 'a', TUMBLE(rowtime, INTERVAL '0.003' SECOND)\n+      \"\"\".stripMargin\n+    tEnv.sqlUpdate(ddl1)\n+    tEnv.sqlUpdate(ddl2)\n+    tEnv.sqlUpdate(query)\n+    tEnv.explain(true)\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ffb28916f4d997ff9294f2df87389c79a7d1951"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEzNjk5NQ==", "bodyText": "add the following sentence: this rule will merge the project generated by AggregateProjectPullUpConstantsRule and make sure window aggregate can be correctly rewritten by StreamLogicalWindowAggregateRule", "url": "https://github.com/apache/flink/pull/12028#discussion_r430136995", "createdAt": "2020-05-26T03:22:15Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/rules/FlinkStreamRuleSets.scala", "diffHunk": "@@ -109,6 +109,8 @@ object FlinkStreamRuleSets {\n       List(\n         //removes constant keys from an Agg\n         AggregateProjectPullUpConstantsRule.INSTANCE,\n+        //fix: FLINK-17553 unsupported call error when constant exists in group window key\n+        ProjectMergeRule.INSTANCE,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ffb28916f4d997ff9294f2df87389c79a7d1951"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86e04bf10b62c7dd52655fc8a20340c3c0ba4d38", "author": {"user": {"login": "zjuwangg", "name": "Terry Wang"}}, "url": "https://github.com/apache/flink/commit/86e04bf10b62c7dd52655fc8a20340c3c0ba4d38", "committedDate": "2020-05-26T03:32:14Z", "message": "modify code style and address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3OTYwODY0", "url": "https://github.com/apache/flink/pull/12028#pullrequestreview-417960864", "createdAt": "2020-05-26T04:21:43Z", "commit": {"oid": "86e04bf10b62c7dd52655fc8a20340c3c0ba4d38"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNjMxNzkz", "url": "https://github.com/apache/flink/pull/12028#pullrequestreview-422631793", "createdAt": "2020-06-02T12:37:56Z", "commit": {"oid": "86e04bf10b62c7dd52655fc8a20340c3c0ba4d38"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMjozNzo1NlrOGdvngg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMjozNzo1NlrOGdvngg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0MjA1MA==", "bodyText": "I think we should verify the result, otherwise, it doesn't need to be added to ITCase.", "url": "https://github.com/apache/flink/pull/12028#discussion_r433842050", "createdAt": "2020-06-02T12:37:56Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/stream/sql/WindowAggregateITCase.scala", "diffHunk": "@@ -319,6 +319,48 @@ class WindowAggregateITCase(mode: StateBackendMode)\n     assertEquals(expected.sorted, sink.getRetractResults.sorted)\n   }\n \n+  // used to verify compile works normally when constants exists in group window key (FLINK-17553)\n+  @Test\n+  def testWindowAggregateOnConstantValue(): Unit = {\n+    val ddl1 =\n+      \"\"\"\n+        |CREATE TABLE src (\n+        |  log_ts STRING,\n+        |  ts TIMESTAMP(3),\n+        |  a INT,\n+        |  b DOUBLE,\n+        |  rowtime AS CAST(log_ts AS TIMESTAMP(3)),\n+        |  WATERMARK FOR rowtime AS rowtime - INTERVAL '0.001' SECOND\n+        |) WITH (\n+        |  'connector' = 'COLLECTION',\n+        |  'is-bounded' = 'false'\n+        |)\n+      \"\"\".stripMargin\n+    val ddl2 =\n+      \"\"\"\n+        |CREATE TABLE dst (\n+        |  ts TIMESTAMP(3),\n+        |  a BIGINT,\n+        |  b DOUBLE\n+        |) WITH (\n+        |  'connector.type' = 'filesystem',\n+        |  'connector.path' = '/tmp/1',\n+        |  'format.type' = 'csv'\n+        |)\n+      \"\"\".stripMargin\n+    val query =\n+      \"\"\"\n+        |INSERT INTO dst\n+        |SELECT TUMBLE_END(rowtime, INTERVAL '0.003' SECOND), COUNT(ts), SUM(b)\n+        |FROM src\n+        | GROUP BY 'a', TUMBLE(rowtime, INTERVAL '0.003' SECOND)\n+      \"\"\".stripMargin\n+    tEnv.sqlUpdate(ddl1)\n+    tEnv.sqlUpdate(ddl2)\n+    tEnv.sqlUpdate(query)\n+    tEnv.explain(true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86e04bf10b62c7dd52655fc8a20340c3c0ba4d38"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8a455a8cc508ab9f8b9d28bfe4e4548709dd93a", "author": {"user": {"login": "zjuwangg", "name": "Terry Wang"}}, "url": "https://github.com/apache/flink/commit/e8a455a8cc508ab9f8b9d28bfe4e4548709dd93a", "committedDate": "2020-06-05T03:24:32Z", "message": "update WindowAggreateITCase#testWindowAggregateOnConstantValue to check the result"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0OTgzMTU0", "url": "https://github.com/apache/flink/pull/12028#pullrequestreview-424983154", "createdAt": "2020-06-05T04:08:40Z", "commit": {"oid": "e8a455a8cc508ab9f8b9d28bfe4e4548709dd93a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4667, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}