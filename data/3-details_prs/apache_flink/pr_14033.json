{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5MTQ0NTk5", "number": 14033, "title": "[FLINK-19979][e2e] Add sanity check after bash e2e tests for no leftovers", "bodyText": "What is the purpose of the change\nThe purpose of this change is to increase the robustness of the e2e tests overall.\nBrief change log\n\nCheck of leftover JVMs after a e2e test, and fails if there's one\nCheck for \"more ports open than before\", and fail if there are more open\nincrease robustness of process stopping: wait until a process has finished, potentially shooting it with a sigkill\nincrease robustness of run_with_timeout. It used to leave a dangling sleep in the system\n\nVerifying this change\nI ran this change through 3 CI runs, to make sure all the tests adhere to the stricter requirements of \"no leftover stuff\".\nI will also manually test the watchdog again (proper killing and reporting).", "createdAt": "2020-11-11T11:43:44Z", "url": "https://github.com/apache/flink/pull/14033", "merged": true, "mergeCommit": {"oid": "4cc0e72208f57c33bcd1314342d97b9f3341f380"}, "closed": true, "closedAt": "2020-11-16T20:08:33Z", "author": {"login": "rmetzger"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcCXEFgH2gAyNTE5MTQ0NTk5OjllNTE3OWQ5OWFjM2YxZWU2NzM4OGY2MjM2YTVmZmQwODc5NDFhOTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdc4F5DAFqTUzMDg0MjM2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9e5179d99ac3f1ee67388f6236a5ffd087941a94", "author": {"user": {"login": "rmetzger", "name": "Robert Metzger"}}, "url": "https://github.com/apache/flink/commit/9e5179d99ac3f1ee67388f6236a5ffd087941a94", "committedDate": "2020-11-13T07:52:07Z", "message": "[FLINK-19979][e2e] Add sanity check after bash e2e tests for no leftover processes\n\nThis commit also contains a number of robustness improvements."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "43dee710e0f873adfd5b521183fc1492375d7800", "author": {"user": {"login": "rmetzger", "name": "Robert Metzger"}}, "url": "https://github.com/apache/flink/commit/43dee710e0f873adfd5b521183fc1492375d7800", "committedDate": "2020-11-11T11:38:48Z", "message": "[FLINK-19979][e2e] Add sanity check after bash e2e tests for no leftover processes\n\nThis commit also contains a number of robustness improvements."}, "afterCommit": {"oid": "9e5179d99ac3f1ee67388f6236a5ffd087941a94", "author": {"user": {"login": "rmetzger", "name": "Robert Metzger"}}, "url": "https://github.com/apache/flink/commit/9e5179d99ac3f1ee67388f6236a5ffd087941a94", "committedDate": "2020-11-13T07:52:07Z", "message": "[FLINK-19979][e2e] Add sanity check after bash e2e tests for no leftover processes\n\nThis commit also contains a number of robustness improvements."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMjc4OTA5", "url": "https://github.com/apache/flink/pull/14033#pullrequestreview-530278909", "createdAt": "2020-11-13T17:48:14Z", "commit": {"oid": "9e5179d99ac3f1ee67388f6236a5ffd087941a94"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNzo0ODoxNVrOHy43xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxODowNDoxMlrOHy5ZLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEyMjYzMA==", "bodyText": "Shouldn't we move that out into its own common utility function considering that we used almost the exact same code in PR #14062 (FLINK-17470)?", "url": "https://github.com/apache/flink/pull/14033#discussion_r523122630", "createdAt": "2020-11-13T17:48:15Z", "author": {"login": "XComp"}, "path": "flink-end-to-end-tests/test-scripts/common.sh", "diffHunk": "@@ -587,9 +588,25 @@ function tm_kill_all {\n \n # Kills all processes that match the given name.\n function kill_all {\n-  local pid=`jps | grep -E \"${1}\" | cut -d \" \" -f 1 || true`\n-  kill ${pid} 2> /dev/null || true\n-  wait ${pid} 2> /dev/null || true\n+  # using ps instead of jps to identify jvms in shutdown as well, so that we can wait for the shutdown to finish (jps doesn't show killed JVMs while shutting down)\n+  # use awk to strip leading and trailing whitespaces\n+  # use cut to get the pid\n+  for pid in $(ps ax | grep \"java\" | grep -E \"${1}\" | awk '{$1=$1;print}' | cut -d \" \" -f 1)\n+  do\n+      echo \"Waiting till process is stopped: pid = $pid pattern = '${1}'\"\n+      kill ${pid} 2> /dev/null || true\n+      if [[ \"$OS_TYPE\" == \"mac\" ]]; then\n+          # works on mac, but does seem to return before the process has finished on Linux\n+          wait ${pid} 2> /dev/null || true\n+      else\n+          # use tail to wait for a process to finish: https://stackoverflow.com/questions/1058047/wait-for-a-process-to-finish/11719943\n+          timeout 60 tail --pid=${pid} -f /dev/null\n+          if [ \"$?\" -eq 124 ]; then\n+            echo \"Process (pid = $pid) didn't stop within 60 seconds. Killing it:\"\n+            kill -9 $pid\n+          fi\n+      fi", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e5179d99ac3f1ee67388f6236a5ffd087941a94"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEyNzIyOQ==", "bodyText": "I couldn't verify it that's why I'm asking: Are you sure that this is what you want to do? AFAIK, pkill would need some pattern and -P just restricts the parent PID?! \ud83e\udd14", "url": "https://github.com/apache/flink/pull/14033#discussion_r523127229", "createdAt": "2020-11-13T17:56:50Z", "author": {"login": "XComp"}, "path": "flink-end-to-end-tests/test-scripts/common.sh", "diffHunk": "@@ -822,11 +839,20 @@ internal_run_with_timeout() {\n \n   (\n       command_pid=$BASHPID\n-      (sleep \"${timeout_in_seconds}\" # set a timeout for this command\n-      echo \"${command_label:-\"The command '${command}'\"} (pid: $command_pid) did not finish after $timeout_in_seconds seconds.\"\n-      eval \"${on_failure}\"\n-      kill \"$command_pid\") & watchdog_pid=$!\n+      (# this subshell contains the watchdog\n+        local wakeup_time=$(( ${timeout_in_seconds} + $(date +%s) ))\n+        while true; do\n+          sleep 1\n+          if [ $wakeup_time -le $(date +%s) ]; then\n+            echo \"${command_label:-\"The command '${command}'\"} (pid: $command_pid) did not finish after $timeout_in_seconds seconds.\"\n+            eval \"${on_failure}\"\n+            kill \"$command_pid\"\n+            pkill -P \"$command_pid\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e5179d99ac3f1ee67388f6236a5ffd087941a94"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEzMTE4Mw==", "bodyText": "why do we have to run sudo here? Isn't the test executed by root? \ud83e\udd14", "url": "https://github.com/apache/flink/pull/14033#discussion_r523131183", "createdAt": "2020-11-13T18:04:12Z", "author": {"login": "XComp"}, "path": "flink-end-to-end-tests/test-scripts/test-runner-common.sh", "diffHunk": "@@ -110,10 +114,40 @@ function post_test_validation {\n     fi\n }\n \n+# returns the number of allocated ports\n+function get_num_ports {\n+    # \"ps --ppid 2 -p 2 --deselect\" shows all non-kernel processes\n+    # \"ps --ppid $$\" shows all children of this bash process\n+    # \"ps -o pid= -o comm=\" removes the header line\n+    echo $(sudo netstat -tulpn | wc -l)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e5179d99ac3f1ee67388f6236a5ffd087941a94"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc9f926baa63a9070e7522e17211b43fd7003bca", "author": {"user": {"login": "rmetzger", "name": "Robert Metzger"}}, "url": "https://github.com/apache/flink/commit/fc9f926baa63a9070e7522e17211b43fd7003bca", "committedDate": "2020-11-13T18:43:07Z", "message": "print pstree for debugging dotnet"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwODQyMzY0", "url": "https://github.com/apache/flink/pull/14033#pullrequestreview-530842364", "createdAt": "2020-11-15T22:28:14Z", "commit": {"oid": "fc9f926baa63a9070e7522e17211b43fd7003bca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4618, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}