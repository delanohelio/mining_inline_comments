{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4MDYyNDQx", "number": 13741, "title": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers", "bodyText": "This PR adds CheckpointBarrierAnnouncement messages\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-10-22T06:52:35Z", "url": "https://github.com/apache/flink/pull/13741", "merged": true, "mergeCommit": {"oid": "eb24d384599f66acc292dbf7e3db8e2c2b4972f0"}, "closed": true, "closedAt": "2020-10-29T11:30:42Z", "author": {"login": "pnowojski"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVBm6PgBqjM5MDg5NDU2MDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW_hgPgBqjM5MzE5OTA0NDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a68242a90fd180fcd0b4b4c60b5e1e49136c00f", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/8a68242a90fd180fcd0b4b4c60b5e1e49136c00f", "committedDate": "2020-10-21T10:46:04Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}, "afterCommit": {"oid": "1d5e07a51aa4c2ad129dae99e1e34c02f217ec4b", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/1d5e07a51aa4c2ad129dae99e1e34c02f217ec4b", "committedDate": "2020-10-22T13:01:52Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1d5e07a51aa4c2ad129dae99e1e34c02f217ec4b", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/1d5e07a51aa4c2ad129dae99e1e34c02f217ec4b", "committedDate": "2020-10-22T13:01:52Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}, "afterCommit": {"oid": "152532018780b987ea2447abd20097375457655f", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/152532018780b987ea2447abd20097375457655f", "committedDate": "2020-10-22T20:39:09Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "152532018780b987ea2447abd20097375457655f", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/152532018780b987ea2447abd20097375457655f", "committedDate": "2020-10-22T20:39:09Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}, "afterCommit": {"oid": "eef96ff91e5f02a5f777d17cce91e860816ca15b", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/eef96ff91e5f02a5f777d17cce91e860816ca15b", "committedDate": "2020-10-24T15:07:42Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eef96ff91e5f02a5f777d17cce91e860816ca15b", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/eef96ff91e5f02a5f777d17cce91e860816ca15b", "committedDate": "2020-10-24T15:07:42Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}, "afterCommit": {"oid": "827c2f19269d5ef5ff2ff6fb214b30dd12955b01", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/827c2f19269d5ef5ff2ff6fb214b30dd12955b01", "committedDate": "2020-10-24T16:28:49Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "827c2f19269d5ef5ff2ff6fb214b30dd12955b01", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/827c2f19269d5ef5ff2ff6fb214b30dd12955b01", "committedDate": "2020-10-24T16:28:49Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}, "afterCommit": {"oid": "33b05f3143953a3bcb7a526326034cfd3bc6da5b", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/33b05f3143953a3bcb7a526326034cfd3bc6da5b", "committedDate": "2020-10-25T09:59:31Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "33b05f3143953a3bcb7a526326034cfd3bc6da5b", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/33b05f3143953a3bcb7a526326034cfd3bc6da5b", "committedDate": "2020-10-25T09:59:31Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}, "afterCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/35aaad405a63bb56ff1be4aa45028b22058c0858", "committedDate": "2020-10-25T13:35:08Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NzMxMzkw", "url": "https://github.com/apache/flink/pull/13741#pullrequestreview-516731390", "createdAt": "2020-10-26T12:34:53Z", "commit": {"oid": "d5799cc5ba94c7268fac36dfcaf10981a6b5579b"}, "state": "COMMENTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjozNDo1NFrOHoNeCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMzoxMDoxOVrOHoOtpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkyNTc3MA==", "bodyText": "Typo is commit msg.", "url": "https://github.com/apache/flink/pull/13741#discussion_r511925770", "createdAt": "2020-10-26T12:34:54Z", "author": {"login": "AHeise"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/AlternatingController.java", "diffHunk": "@@ -35,7 +35,6 @@\n \tprivate final AlignedController alignedController;\n \tprivate final UnalignedController unalignedController;\n \tprivate  CheckpointBarrierBehaviourController activeController;\n-\tprivate long lastSeenBarrierId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5799cc5ba94c7268fac36dfcaf10981a6b5579b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkyNTk1Ng==", "bodyText": "Can you fix the double-spacing here as well?", "url": "https://github.com/apache/flink/pull/13741#discussion_r511925956", "createdAt": "2020-10-26T12:35:12Z", "author": {"login": "AHeise"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/AlternatingController.java", "diffHunk": "@@ -35,7 +35,6 @@\n \tprivate final AlignedController alignedController;\n \tprivate final UnalignedController unalignedController;\n \tprivate  CheckpointBarrierBehaviourController activeController;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5799cc5ba94c7268fac36dfcaf10981a6b5579b"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkyNzY1MQ==", "bodyText": "nit: double indent. Also in various other places in this commit. Ignore if intended.", "url": "https://github.com/apache/flink/pull/13741#discussion_r511927651", "createdAt": "2020-10-26T12:38:13Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java", "diffHunk": "@@ -773,11 +776,12 @@ private void snapshotTaskState(\n \t\tExecution[] executions,\n \t\tboolean advanceToEndOfTime) {\n \n-\t\tfinal CheckpointOptions checkpointOptions = new CheckpointOptions(\n-\t\t\tprops.getCheckpointType(),\n-\t\t\tcheckpointStorageLocation.getLocationReference(),\n-\t\t\tisExactlyOnceMode,\n-\t\t\tprops.getCheckpointType() == CheckpointType.CHECKPOINT && unalignedCheckpointsEnabled);\n+\t\tfinal CheckpointOptions checkpointOptions = CheckpointOptions.create(\n+\t\t\t\tprops.getCheckpointType(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e26fb076f97cb27397a1d76d26aff11790e438f"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMDE3Mg==", "bodyText": "Could you motivate (in commit msg) why this is a property of the checkpoint vs. a config of the task?\nI don't mind this solution but I want to understand the reason. Intuitively, I'd put it into the task config, which would ultimately allow a fine-grain checkpoint configuration for each operator.\nDo you plan to adjust the alignmentTimeout when the barrier travels downstream?", "url": "https://github.com/apache/flink/pull/13741#discussion_r511930172", "createdAt": "2020-10-26T12:42:38Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointOptions.java", "diffHunk": "@@ -47,29 +50,56 @@\n \n \tprivate final boolean isUnalignedCheckpoint;\n \n+\tprivate final long alignmentTimeout;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e26fb076f97cb27397a1d76d26aff11790e438f"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMDg1Mg==", "bodyText": "Have NO_ALIGNMENT_TIME_OUT = -1?", "url": "https://github.com/apache/flink/pull/13741#discussion_r511930852", "createdAt": "2020-10-26T12:43:53Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointOptions.java", "diffHunk": "@@ -47,29 +50,56 @@\n \n \tprivate final boolean isUnalignedCheckpoint;\n \n+\tprivate final long alignmentTimeout;\n+\n+\tpublic static CheckpointOptions create(\n+\t\t\tCheckpointType checkpointType,\n+\t\t\tCheckpointStorageLocationReference locationReference,\n+\t\t\tboolean isExactlyOnceMode,\n+\t\t\tboolean unalignedCheckpointsEnabled,\n+\t\t\tlong alignmentTimeout) {\n+\t\tboolean canBeUnaligned = checkpointType == CheckpointType.CHECKPOINT && unalignedCheckpointsEnabled;\n+\t\treturn new CheckpointOptions(\n+\t\t\t\tcheckpointType,\n+\t\t\t\tlocationReference,\n+\t\t\t\tisExactlyOnceMode,\n+\t\t\t\tcanBeUnaligned && alignmentTimeout == 0,\n+\t\t\t\tcanBeUnaligned ? alignmentTimeout : NO_ALIGNMENT_TIME_OUT);\n+\t}\n+\n \t@VisibleForTesting\n \tpublic CheckpointOptions(\n \t\t\tCheckpointType checkpointType,\n \t\t\tCheckpointStorageLocationReference targetLocation) {\n-\t\tthis(checkpointType, targetLocation, true, false);\n+\t\tthis(checkpointType, targetLocation, true, false, NO_ALIGNMENT_TIME_OUT);\n \t}\n \n \tpublic CheckpointOptions(\n \t\t\tCheckpointType checkpointType,\n \t\t\tCheckpointStorageLocationReference targetLocation,\n \t\t\tboolean isExactlyOnceMode,\n-\t\t\tboolean isUnalignedCheckpoint) {\n+\t\t\tboolean isUnalignedCheckpoint,\n+\t\t\tlong alignmentTimeout) {\n \n \t\tthis.checkpointType = checkNotNull(checkpointType);\n \t\tthis.targetLocation = checkNotNull(targetLocation);\n \t\tthis.isExactlyOnceMode = isExactlyOnceMode;\n \t\tthis.isUnalignedCheckpoint = isUnalignedCheckpoint;\n+\t\tthis.alignmentTimeout = alignmentTimeout;\n \t}\n \n \tpublic boolean needsAlignment() {\n \t\treturn isExactlyOnceMode() && (getCheckpointType().isSavepoint() || !isUnalignedCheckpoint());\n \t}\n \n+\tpublic long getAlignmentTimeout() {\n+\t\treturn alignmentTimeout;\n+\t}\n+\n+\tpublic boolean isTimeoutable() {\n+\t\treturn alignmentTimeout > 0 && alignmentTimeout != NO_ALIGNMENT_TIME_OUT;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e26fb076f97cb27397a1d76d26aff11790e438f"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMjQwNw==", "bodyText": "Quite technical compared to the other descriptions (=too precise).\n\n\"If timeout is (set to) 0, checkpoints will always start unaligned.\"", "url": "https://github.com/apache/flink/pull/13741#discussion_r511932407", "createdAt": "2020-10-26T12:46:40Z", "author": {"login": "AHeise"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/ExecutionCheckpointingOptions.java", "diffHunk": "@@ -143,4 +143,20 @@\n \t\t\t\t\tTextElement.code(CheckpointingMode.EXACTLY_ONCE.toString()),\n \t\t\t\t\tTextElement.code(MAX_CONCURRENT_CHECKPOINTS.key()))\n \t\t\t\t.build());\n+\n+\tpublic static final ConfigOption<Duration> ALIGNMENT_TIMEOUT =\n+\t\tConfigOptions.key(\"execution.checkpointing.alignment-timeout\")\n+\t\t\t.durationType()\n+\t\t\t.defaultValue(Duration.ofSeconds(30))\n+\t\t\t.withDescription(Description.builder()\n+\t\t\t\t.text(\"Only relevant if %s is enabled.\", TextElement.code(ENABLE_UNALIGNED.key()))\n+\t\t\t\t.linebreak()\n+\t\t\t\t.linebreak()\n+\t\t\t\t.text(\"If timeout has value equal to 0, checkpoints will always start unaligned.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e26fb076f97cb27397a1d76d26aff11790e438f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzNjcxNw==", "bodyText": "\"If timeout is (set to) non-zero/positive value, checkpoints will...\"", "url": "https://github.com/apache/flink/pull/13741#discussion_r511936717", "createdAt": "2020-10-26T12:54:09Z", "author": {"login": "AHeise"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/ExecutionCheckpointingOptions.java", "diffHunk": "@@ -143,4 +143,20 @@\n \t\t\t\t\tTextElement.code(CheckpointingMode.EXACTLY_ONCE.toString()),\n \t\t\t\t\tTextElement.code(MAX_CONCURRENT_CHECKPOINTS.key()))\n \t\t\t\t.build());\n+\n+\tpublic static final ConfigOption<Duration> ALIGNMENT_TIMEOUT =\n+\t\tConfigOptions.key(\"execution.checkpointing.alignment-timeout\")\n+\t\t\t.durationType()\n+\t\t\t.defaultValue(Duration.ofSeconds(30))\n+\t\t\t.withDescription(Description.builder()\n+\t\t\t\t.text(\"Only relevant if %s is enabled.\", TextElement.code(ENABLE_UNALIGNED.key()))\n+\t\t\t\t.linebreak()\n+\t\t\t\t.linebreak()\n+\t\t\t\t.text(\"If timeout has value equal to 0, checkpoints will always start unaligned.\")\n+\t\t\t\t.linebreak()\n+\t\t\t\t.linebreak()\n+\t\t\t\t.text(\"If time has value greater then 0, checkpoints will start aligned. \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e26fb076f97cb27397a1d76d26aff11790e438f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzOTI4OQ==", "bodyText": "Instead of checking it during deserialization on all buffers, why not simply check it in DataType enum once?\nIn particular, I don't see the need to ever announce priority events.", "url": "https://github.com/apache/flink/pull/13741#discussion_r511939289", "createdAt": "2020-10-26T12:58:27Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -471,6 +475,40 @@ public void onBuffer(Buffer buffer, int sequenceNumber, int backlog) throws IOEx\n \t\t}\n \t}\n \n+\tprivate void checkPriorityXorAnnouncement(Buffer buffer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0MTA2Nw==", "bodyText": "if (dataType.hasPriority() || dataType.requiresAnnouncement()) {\n  firstPriorityEvent = addPriorityBuffer(announce(sequenceBuffer));\n}\nif (!dataType.hasPriority()) {\n  receivedBuffers.add(sequenceBuffer);\n  channelStatePersister.maybePersist(buffer);\n}", "url": "https://github.com/apache/flink/pull/13741#discussion_r511941067", "createdAt": "2020-10-26T13:01:34Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -437,19 +440,20 @@ public void onBuffer(Buffer buffer, int sequenceNumber, int backlog) throws IOEx\n \n \t\t\t\twasEmpty = receivedBuffers.isEmpty();\n \n-\t\t\t\tif (buffer.getDataType().hasPriority()) {\n-\t\t\t\t\treceivedBuffers.addPriorityElement(new SequenceBuffer(buffer, sequenceNumber));\n-\t\t\t\t\tif (channelStatePersister.checkForBarrier(buffer)) {\n-\t\t\t\t\t\t// checkpoint was not yet started by task thread,\n-\t\t\t\t\t\t// so remember the numbers of buffers to spill for the time when it will be started\n-\t\t\t\t\t\tnumBuffersOvertaken = receivedBuffers.getNumUnprioritizedElements();\n-\t\t\t\t\t}\n-\t\t\t\t\tfirstPriorityEvent = receivedBuffers.getNumPriorityElements() == 1;\n+\t\t\t\tSequenceBuffer sequenceBuffer = new SequenceBuffer(buffer, sequenceNumber);\n+\t\t\t\tDataType dataType = buffer.getDataType();\n+\t\t\t\tif (dataType.hasPriority()) {\n+\t\t\t\t\tcheckPriorityXorAnnouncement(buffer);\n+\t\t\t\t\tfirstPriorityEvent = addPriorityBuffer(sequenceBuffer);\n \t\t\t\t} else {\n-\t\t\t\t\treceivedBuffers.add(new SequenceBuffer(buffer, sequenceNumber));\n+\t\t\t\t\treceivedBuffers.add(sequenceBuffer);\n \t\t\t\t\tchannelStatePersister.maybePersist(buffer);\n-\t\t\t\t}\n \n+\t\t\t\t\tif (dataType.requiresAnnouncement()) {\n+\t\t\t\t\t\tcheckPriorityXorAnnouncement(buffer);\n+\t\t\t\t\t\tfirstPriorityEvent = addPriorityBuffer(announce(sequenceBuffer));\n+\t\t\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0MzMxMg==", "bodyText": "I was hoping that we could make the announcement mechanism a bit independent of checkpoints. I don't see how we can generalize DataType, but I could imagine having a generic AnnouncementEvent.", "url": "https://github.com/apache/flink/pull/13741#discussion_r511943312", "createdAt": "2020-10-26T13:05:37Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/CheckpointBarrierAnnouncement.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.io.network.api;\n+\n+import org.apache.flink.core.memory.DataInputView;\n+import org.apache.flink.core.memory.DataOutputView;\n+import org.apache.flink.runtime.event.RuntimeEvent;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+\n+/**\n+ * {@link CheckpointBarrierAnnouncement} is announcing presence or receiving of a {@link CheckpointBarrier}.\n+ * That {@link #announcedBarrier} is identified by it's sequence number.\n+ */\n+public class CheckpointBarrierAnnouncement extends RuntimeEvent {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0NTgxOA==", "bodyText": "Why did you move this method?", "url": "https://github.com/apache/flink/pull/13741#discussion_r511945818", "createdAt": "2020-10-26T13:09:46Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/Buffer.java", "diffHunk": "@@ -292,21 +313,37 @@ public boolean isEvent() {\n \t\t\treturn isEvent;\n \t\t}\n \n+\t\tpublic boolean isBlockingUpstream() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0NTg0NA==", "bodyText": "As a set before, I'm not a huge fan of this very specific DataTypes. (Why don't we have an DataType just for EndOfPartitionEvents as well?) I also think that ALIGNED_CHECKPOINT_BARRIER is on a different level than all other types.\nOne option that I could see is to just have ANNOUNCED_EVENT_BUFFER(false, true, true, false, true).", "url": "https://github.com/apache/flink/pull/13741#discussion_r511945844", "createdAt": "2020-10-26T13:09:50Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/Buffer.java", "diffHunk": "@@ -247,41 +247,62 @@\n \t\t/**\n \t\t * {@link #NONE} indicates that there is no buffer.\n \t\t */\n-\t\tNONE(false, false, false, false),\n+\t\tNONE(false, false, false, false, false),\n \n \t\t/**\n \t\t * {@link #DATA_BUFFER} indicates that this buffer represents a non-event data buffer.\n \t\t */\n-\t\tDATA_BUFFER(true, false, false, false),\n+\t\tDATA_BUFFER(true, false, false, false, false),\n \n \t\t/**\n \t\t * {@link #EVENT_BUFFER} indicates that this buffer represents serialized data of an event.\n \t\t * Note that this type can be further divided into more fine-grained event types\n \t\t * like {@link #ALIGNED_CHECKPOINT_BARRIER} and etc.\n \t\t */\n-\t\tEVENT_BUFFER(false, true, false, false),\n+\t\tEVENT_BUFFER(false, true, false, false, false),\n \n \t\t/**\n \t\t * Same as EVENT_BUFFER, but the event has been prioritized (e.g. it skipped buffers).\n \t\t */\n-\t\tPRIORITIZED_EVENT_BUFFER(false, true, false, true),\n+\t\tPRIORITIZED_EVENT_BUFFER(false, true, false, true, false),\n \n \t\t/**\n \t\t * {@link #ALIGNED_CHECKPOINT_BARRIER} indicates that this buffer represents a\n \t\t * serialized checkpoint barrier of aligned exactly-once checkpoint mode.\n \t\t */\n-\t\tALIGNED_CHECKPOINT_BARRIER(false, true, true, false);\n+\t\tALIGNED_CHECKPOINT_BARRIER(false, true, true, false, false),\n+\n+\t\t/**\n+\t\t * {@link #TIMEOUTABLE_ALIGNED_CHECKPOINT_BARRIER} indicates that this buffer represents a\n+\t\t * serialized checkpoint barrier of aligned exactly-once checkpoint mode, that can be time-out'ed\n+\t\t * to an unaligned checkpoint barrier.\n+\t\t */\n+\t\tTIMEOUTABLE_ALIGNED_CHECKPOINT_BARRIER(false, true, true, false, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0NjE1MQ==", "bodyText": "Add TODO instead?", "url": "https://github.com/apache/flink/pull/13741#discussion_r511946151", "createdAt": "2020-10-26T13:10:19Z", "author": {"login": "AHeise"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/SingleCheckpointBarrierHandler.java", "diffHunk": "@@ -147,6 +148,13 @@ public void processBarrier(CheckpointBarrier barrier, InputChannelInfo channelIn\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic void processBarrierAnnouncement(\n+\t\t\tCheckpointBarrierAnnouncement barrierAnnouncement,\n+\t\t\tInputChannelInfo channelInfo) throws IOException {\n+\t\t// Ignore for now.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/35aaad405a63bb56ff1be4aa45028b22058c0858", "committedDate": "2020-10-25T13:35:08Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}, "afterCommit": {"oid": "564a0cc9738ae323ad037c72258f86f7f03d7409", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/564a0cc9738ae323ad037c72258f86f7f03d7409", "committedDate": "2020-10-27T16:49:17Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "564a0cc9738ae323ad037c72258f86f7f03d7409", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/564a0cc9738ae323ad037c72258f86f7f03d7409", "committedDate": "2020-10-27T16:49:17Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}, "afterCommit": {"oid": "fd9a7059d4b4fa7c0760f2c82731436fe1d1312a", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/fd9a7059d4b4fa7c0760f2c82731436fe1d1312a", "committedDate": "2020-10-27T17:05:01Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NTkyMzI0", "url": "https://github.com/apache/flink/pull/13741#pullrequestreview-518592324", "createdAt": "2020-10-28T12:09:16Z", "commit": {"oid": "fd9a7059d4b4fa7c0760f2c82731436fe1d1312a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd9a7059d4b4fa7c0760f2c82731436fe1d1312a", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/fd9a7059d4b4fa7c0760f2c82731436fe1d1312a", "committedDate": "2020-10-27T17:05:01Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}, "afterCommit": {"oid": "ab71efa489d12df19be9eeb6cc814ee60206598c", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/ab71efa489d12df19be9eeb6cc814ee60206598c", "committedDate": "2020-10-28T12:09:00Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d10faf6bd4440199a69cd13663b646fc6af1550", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/0d10faf6bd4440199a69cd13663b646fc6af1550", "committedDate": "2020-10-28T15:42:22Z", "message": "[hotfix][network] Remove unused EventSerializer#isEvent method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fad496c9938cbbdd84e4c26b88ef51159790c9a", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/5fad496c9938cbbdd84e4c26b88ef51159790c9a", "committedDate": "2020-10-28T15:42:23Z", "message": "[hotfix][network] Rename ALIGNED_EXACTLY_ONCE_CHECKPOINT_BARRIER and improve java docs in DataType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dfa0ec0c990a8ea94bfc36339ea35629eca8f90", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/1dfa0ec0c990a8ea94bfc36339ea35629eca8f90", "committedDate": "2020-10-28T15:42:23Z", "message": "[hotfix][checkpointing] Remove unused variable in AlternatingController"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d1c13ab6c67e122c1750ab1a3120ae2dc8f67a6", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/1d1c13ab6c67e122c1750ab1a3120ae2dc8f67a6", "committedDate": "2020-10-28T15:42:23Z", "message": "[FLINK-19680][checkpointing] Provide alignment timeout checkpoint option"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42483b09d6194fdab365ee9696522c9c75688391", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/42483b09d6194fdab365ee9696522c9c75688391", "committedDate": "2020-10-28T15:43:49Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab71efa489d12df19be9eeb6cc814ee60206598c", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/ab71efa489d12df19be9eeb6cc814ee60206598c", "committedDate": "2020-10-28T12:09:00Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}, "afterCommit": {"oid": "42483b09d6194fdab365ee9696522c9c75688391", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/42483b09d6194fdab365ee9696522c9c75688391", "committedDate": "2020-10-28T15:43:49Z", "message": "[FLINK-19680][checkpointing] Announce timeoutable CheckpointBarriers"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3027, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}