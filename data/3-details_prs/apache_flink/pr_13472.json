{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMjM4MjA2", "number": 13472, "title": "[FLINK-19291][Formats] Fix `SchemaParseException` when use `AvroSchemaConverter` converts flink logical type ", "bodyText": "What is the purpose of the change\nFix a bug in AvroSchemaConverter.convertToSchema, it will throw SchemaParseException when there are multiple row type fields and the field names in each row type are different. the rowTypeCounter will be duplicate which causes this problem.\nBrief change log\n\nConcating parant and child name as row name to replace rowTypeCounter.\nSet top name to record in AvroSchemaConverter.convertToSchema.\n\nVerifying this change\nThis change added tests and can be verified as follows:\n\nConstruct a logical type with multiple row type fields and the field names in each row type are different.\nInvoke method AvroSchemaConverter.convertToSchema and return Schema.\nNo SchemaParseException should be thrown during execute Schema.toString() and check the result is as expected.\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (no)\nThe serializers: (no)\nThe runtime per-record code paths (performance sensitive): (no)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (no)\nThe S3 file system connector: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (no)", "createdAt": "2020-09-24T07:13:26Z", "url": "https://github.com/apache/flink/pull/13472", "merged": true, "mergeCommit": {"oid": "de87a2debde8546e6741390a81f43c032521c3c0"}, "closed": true, "closedAt": "2020-10-10T10:55:31Z", "author": {"login": "V1ncentzzZ"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLrFnLgH2gAyNDkyMjM4MjA2OjNlNzBiMjlmNDc3NjdhNDIyMWNjMTU4ODhkNDY5ZTFlOWQ5MGQyMmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdREzFdAFqTUwNjA3MTUyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3e70b29f47767a4221cc15888d469e1e9d90d22e", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/3e70b29f47767a4221cc15888d469e1e9d90d22e", "committedDate": "2020-09-23T11:42:27Z", "message": "[FLINK-19291][Formats] Fix `SchemaParseException` caused by the `rowTypeCounter` may be duplicate when there are multiple row types"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MzUzNTIw", "url": "https://github.com/apache/flink/pull/13472#pullrequestreview-505353520", "createdAt": "2020-10-09T04:18:50Z", "commit": {"oid": "3e70b29f47767a4221cc15888d469e1e9d90d22e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNDoxODo1MVrOHe6rsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNDoxOToyOFrOHe6sbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4MDc4NA==", "bodyText": "I think this will conflict if a field name is \"row_0\".", "url": "https://github.com/apache/flink/pull/13472#discussion_r502180784", "createdAt": "2020-10-09T04:18:51Z", "author": {"login": "wuchong"}, "path": "flink-formats/flink-avro/src/main/java/org/apache/flink/formats/avro/typeutils/AvroSchemaConverter.java", "diffHunk": "@@ -297,10 +297,10 @@ private static DataType convertToDataType(Schema schema) {\n \t * @return Avro's {@link Schema} matching this logical type.\n \t */\n \tpublic static Schema convertToSchema(LogicalType logicalType) {\n-\t\treturn convertToSchema(logicalType, 0);\n+\t\treturn convertToSchema(logicalType, \"row_0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e70b29f47767a4221cc15888d469e1e9d90d22e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4MDk3NA==", "bodyText": "I think this doesn't work. Because field names may conflict. We may need to concat the parent row name and the field name as the child name.", "url": "https://github.com/apache/flink/pull/13472#discussion_r502180974", "createdAt": "2020-10-09T04:19:28Z", "author": {"login": "wuchong"}, "path": "flink-formats/flink-avro/src/main/java/org/apache/flink/formats/avro/typeutils/AvroSchemaConverter.java", "diffHunk": "@@ -359,13 +359,13 @@ public static Schema convertToSchema(LogicalType logicalType, int rowTypeCounter\n \t\t\t\t// we have to make sure the record name is different in a Schema\n \t\t\t\tSchemaBuilder.FieldAssembler<Schema> builder = SchemaBuilder\n \t\t\t\t\t.builder()\n-\t\t\t\t\t.record(\"row_\" + rowTypeCounter)\n+\t\t\t\t\t.record(rowName)\n \t\t\t\t\t.fields();\n-\t\t\t\trowTypeCounter++;\n \t\t\t\tfor (int i = 0; i < rowType.getFieldCount(); i++) {\n+\t\t\t\t\tString fieldName = fieldNames.get(i);\n \t\t\t\t\tbuilder = builder\n-\t\t\t\t\t\t.name(fieldNames.get(i))\n-\t\t\t\t\t\t.type(convertToSchema(rowType.getTypeAt(i), rowTypeCounter))\n+\t\t\t\t\t\t.name(fieldName)\n+\t\t\t\t\t\t.type(convertToSchema(rowType.getTypeAt(i), fieldName))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e70b29f47767a4221cc15888d469e1e9d90d22e"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "673132483e8def970c4e4ea44da5a761978a8106", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/673132483e8def970c4e4ea44da5a761978a8106", "committedDate": "2020-10-10T02:52:59Z", "message": "[FLINK-19291][Formats] Updating test case to reproduce the problem."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f81fd9dbee3210951156366f041d45dae4301ed", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/8f81fd9dbee3210951156366f041d45dae4301ed", "committedDate": "2020-10-10T03:00:04Z", "message": "[FLINK-19291][Formats] hot fix for code formats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27a70ae047774c0474519bea4f7a95a25d40c371", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/27a70ae047774c0474519bea4f7a95a25d40c371", "committedDate": "2020-10-10T03:27:58Z", "message": "[FLINK-19291][Formats] Updating test case and concat parent and child name as row name to fix this problem and set \"row_\" append current time millis as default row name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8b88bc4d52ac3d0aa6fe7a5681bd80a18501934", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/a8b88bc4d52ac3d0aa6fe7a5681bd80a18501934", "committedDate": "2020-10-10T06:08:58Z", "message": "[FLINK-19291][Formats] Use \"record\" as top name and optimization test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDcxNTIx", "url": "https://github.com/apache/flink/pull/13472#pullrequestreview-506071521", "createdAt": "2020-10-10T06:29:22Z", "commit": {"oid": "a8b88bc4d52ac3d0aa6fe7a5681bd80a18501934"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3374, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}