{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2MTIyODg3", "number": 14509, "title": "[FLINK-20654][checkpointing] Decline checkpoints until restored channel state is consumed", "bodyText": "What is the purpose of the change\nIn scenarios with multiple inputs (e.g. co-group; not union) one input may receive a\ncheckpoint barrier while the second input is still restoring state. This (previous)\nstate is currently not included into the snapshot, which therefore will be incomplete.\nBrief change log\n\nDisable alignment timeout by default in UnalignedCheckpointITCase\nDecline checkpoint if state of the input gate was not yet consumed\n\nVerifying this change\n\nAdded unit test SingleInputGateTest#testCheckpointsDeclinedUnlessStateConsumed.\nExisting UnalignedCheckpointITCase un-ignored - without the change it fails once per ~10 runs\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: yes\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? no", "createdAt": "2020-12-28T14:52:52Z", "url": "https://github.com/apache/flink/pull/14509", "merged": true, "mergeCommit": {"oid": "b137bbd19198d3302749e7b84ec9f6fcf7af6073"}, "closed": true, "closedAt": "2020-12-30T08:43:48Z", "author": {"login": "rkhachatryan"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdqoNEgAFqTU1OTE5OTgzMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdq7gbAABqjQxNTQ3Nzc3MDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MTk5ODMy", "url": "https://github.com/apache/flink/pull/14509#pullrequestreview-559199832", "createdAt": "2020-12-28T15:51:56Z", "commit": {"oid": "53e02e1ff19305c2ae291727b9ae58a7488a3157"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxNTo1MTo1NlrOIL8biA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxNTo1MTo1NlrOIL8biA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTM5NTMzNg==", "bodyText": "nit formatting", "url": "https://github.com/apache/flink/pull/14509#discussion_r549395336", "createdAt": "2020-12-28T15:51:56Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateTest.java", "diffHunk": "@@ -88,7 +94,14 @@\n /** Tests for {@link SingleInputGate}. */\n public class SingleInputGateTest extends InputGateTestBase {\n \n-    /**\n+    @Test(expected = CheckpointException.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53e02e1ff19305c2ae291727b9ae58a7488a3157"}, "originalPosition": 37}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53e02e1ff19305c2ae291727b9ae58a7488a3157", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/53e02e1ff19305c2ae291727b9ae58a7488a3157", "committedDate": "2020-12-28T14:47:59Z", "message": "[FLINK-20654][checkpointing] Decline checkpoints until restored channel state is consumed\n\nIn scenarios with multiple inputs (e.g. co-group; not union) one input may receive a\ncheckpoint barrier while the second input is still restoring state. This (previous)\nstate is currently not included into the snapshot, which therefore will be incomplete."}, "afterCommit": {"oid": "692de7c951bd21f3841560cc351c3aae3f33719c", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/692de7c951bd21f3841560cc351c3aae3f33719c", "committedDate": "2020-12-28T20:37:09Z", "message": "[FLINK-20654][network] Fix channel indices in StreamTaskNetworkInput\n\nIn StreamTaskNetworkInput.prepareSnapshot, internal channelIndex\nis inconsistent with CheckpointedInputGate channelIndex.\n\nThis change fixes data loss in UnalignedCheckpointITCase.cogroup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "692de7c951bd21f3841560cc351c3aae3f33719c", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/692de7c951bd21f3841560cc351c3aae3f33719c", "committedDate": "2020-12-28T20:37:09Z", "message": "[FLINK-20654][network] Fix channel indices in StreamTaskNetworkInput\n\nIn StreamTaskNetworkInput.prepareSnapshot, internal channelIndex\nis inconsistent with CheckpointedInputGate channelIndex.\n\nThis change fixes data loss in UnalignedCheckpointITCase.cogroup."}, "afterCommit": {"oid": "89cc24da926665e094006c6a825429c1efb7697c", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/89cc24da926665e094006c6a825429c1efb7697c", "committedDate": "2020-12-28T21:04:13Z", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "89cc24da926665e094006c6a825429c1efb7697c", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/89cc24da926665e094006c6a825429c1efb7697c", "committedDate": "2020-12-28T21:04:13Z", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100."}, "afterCommit": {"oid": "ad643bad232902ff5e2f5878dfd43776e2142ef1", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/ad643bad232902ff5e2f5878dfd43776e2142ef1", "committedDate": "2020-12-28T22:49:15Z", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NDIxNDc4", "url": "https://github.com/apache/flink/pull/14509#pullrequestreview-559421478", "createdAt": "2020-12-29T08:13:23Z", "commit": {"oid": "36adcd40bc836c05b2dc63cff0a779ea4aeec41c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwODoxMzoyM1rOIMJktA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwODoxMzoyM1rOIMJktA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYxMDY3Ng==", "bodyText": "As I understand from the offline discussion. Parallel union doesn't work while cogroup is almost working, but not quite - it's still failing? In that case I would keep this test ignored.", "url": "https://github.com/apache/flink/pull/14509#discussion_r549610676", "createdAt": "2020-12-29T08:13:23Z", "author": {"login": "pnowojski"}, "path": "flink-tests/src/test/java/org/apache/flink/test/checkpointing/UnalignedCheckpointITCase.java", "diffHunk": "@@ -189,7 +189,6 @@ public UnalignedCheckpointITCase(String desc, UnalignedSettings settings) {\n     }\n \n     @Test\n-    @Ignore", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36adcd40bc836c05b2dc63cff0a779ea4aeec41c"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad643bad232902ff5e2f5878dfd43776e2142ef1", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/ad643bad232902ff5e2f5878dfd43776e2142ef1", "committedDate": "2020-12-28T22:49:15Z", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100."}, "afterCommit": {"oid": "72bcb262c1443a4fe0f2cb2817c568e450ef0ae8", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/72bcb262c1443a4fe0f2cb2817c568e450ef0ae8", "committedDate": "2020-12-29T08:36:31Z", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "72bcb262c1443a4fe0f2cb2817c568e450ef0ae8", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/72bcb262c1443a4fe0f2cb2817c568e450ef0ae8", "committedDate": "2020-12-29T08:36:31Z", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100."}, "afterCommit": {"oid": "eda1fc4ace1e19652c97a883bc7411f6cbb99946", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/eda1fc4ace1e19652c97a883bc7411f6cbb99946", "committedDate": "2020-12-29T09:31:02Z", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NDc2OTM0", "url": "https://github.com/apache/flink/pull/14509#pullrequestreview-559476934", "createdAt": "2020-12-29T10:46:13Z", "commit": {"oid": "fbe634b6ea1ba38207ccc1fdb0cd5b19d11ab05c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxMDo0NjoxNFrOIMMeMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxMDo0NzoyMFrOIMMfng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY1ODE2MA==", "bodyText": "The only reason why we need this, is because of StatusWatermarkValve? And theoretically we could migrate StatusWatermarkValve from raw indexes to InputChannelInfo and get rid of this conversion as well?\nIf so, that brings another question. Could there be a similar bugs in StatusWatermarkValve that originate from using raw int as channel index?", "url": "https://github.com/apache/flink/pull/14509#discussion_r549658160", "createdAt": "2020-12-29T10:46:14Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/StreamTaskNetworkInput.java", "diffHunk": "@@ -73,21 +72,20 @@\n \n     private final DeserializationDelegate<StreamElement> deserializationDelegate;\n \n-    private final RecordDeserializer<DeserializationDelegate<StreamElement>>[] recordDeserializers;\n+    private final Map<InputChannelInfo, RecordDeserializer<DeserializationDelegate<StreamElement>>>\n+            recordDeserializers;\n+    private final Map<InputChannelInfo, Integer> flattenedChannelIndices;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbe634b6ea1ba38207ccc1fdb0cd5b19d11ab05c"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY1ODUyNg==", "bodyText": "We are accessing this Map just once per buffer, so there should be no performance penalty?", "url": "https://github.com/apache/flink/pull/14509#discussion_r549658526", "createdAt": "2020-12-29T10:47:20Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/StreamTaskNetworkInput.java", "diffHunk": "@@ -73,21 +72,20 @@\n \n     private final DeserializationDelegate<StreamElement> deserializationDelegate;\n \n-    private final RecordDeserializer<DeserializationDelegate<StreamElement>>[] recordDeserializers;\n+    private final Map<InputChannelInfo, RecordDeserializer<DeserializationDelegate<StreamElement>>>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbe634b6ea1ba38207ccc1fdb0cd5b19d11ab05c"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "172bf20d5196845436c6638c347df70366f4834d", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/172bf20d5196845436c6638c347df70366f4834d", "committedDate": "2020-12-29T14:00:43Z", "message": "[hotfix][tests] Disable alignment timeout by default in UnalignedCheckpointITCase\n\nMost of the bugs in UC are revealed with higher back-pressure which is not created with alignment timeout.\nThis change disables it by default and adds a new test (p=20) with the timeout enabled."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa92894ad9ef442323b89fc6694b5afd59f8637b", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/aa92894ad9ef442323b89fc6694b5afd59f8637b", "committedDate": "2020-12-29T10:27:56Z", "message": "fixup! [FLINK-20654][network] Fix channel indices in StreamTaskNetworkInput"}, "afterCommit": {"oid": "f0285f6c6e5305d84aea3de039e8debd81655ac6", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/f0285f6c6e5305d84aea3de039e8debd81655ac6", "committedDate": "2020-12-29T14:01:02Z", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfa8f599148497a91dae150e9a67030066389108", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/cfa8f599148497a91dae150e9a67030066389108", "committedDate": "2020-12-29T14:21:31Z", "message": "[FLINK-20654][network] Fix channel indices in StreamTaskNetworkInput\n\nIn StreamTaskNetworkInput.prepareSnapshot, internal channelIndex\nis inconsistent with CheckpointedInputGate channelIndex.\n\nThis change fixes data loss in UnalignedCheckpointITCase.cogroup."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0194d5be34fbb0bd7558d0e46c7f373846587c3", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/c0194d5be34fbb0bd7558d0e46c7f373846587c3", "committedDate": "2020-12-29T14:21:31Z", "message": "[FLINK-20654][checkpointing] Decline checkpoints until restored channel state is consumed\n\nIn scenarios with multiple inputs (e.g. co-group; not union) one input may receive a\ncheckpoint barrier while the second input is still restoring state. This (previous)\nstate is currently not included into the snapshot, which therefore will be incomplete."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0205568cf7f7436f2c3639cb26b8315085582da", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/c0205568cf7f7436f2c3639cb26b8315085582da", "committedDate": "2020-12-29T14:21:31Z", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f0285f6c6e5305d84aea3de039e8debd81655ac6", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/f0285f6c6e5305d84aea3de039e8debd81655ac6", "committedDate": "2020-12-29T14:01:02Z", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100."}, "afterCommit": {"oid": "c0205568cf7f7436f2c3639cb26b8315085582da", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/c0205568cf7f7436f2c3639cb26b8315085582da", "committedDate": "2020-12-29T14:21:31Z", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3464, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}