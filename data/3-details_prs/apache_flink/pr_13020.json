{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MzY1ODU5", "number": 13020, "title": "[FLINK-18663][rest] Fix the exception occurred on AbstractHandler#handleException but not handled", "bodyText": "What is the purpose of the change\nhttps://issues.apache.org/jira/browse/FLINK-18663\nFix the exception occurred on AbstractHandler#handleException but not handled, then JM not exit.\nBrief change log\nFix the exception occurred on AbstractHandler#handleException but not handled, then JM not exit.\nVerifying this change\nno\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (no)\nThe serializers: (no)\nThe runtime per-record code paths (performance sensitive): (no)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (no)\nThe S3 file system connector: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (no)", "createdAt": "2020-07-29T11:08:21Z", "url": "https://github.com/apache/flink/pull/13020", "merged": true, "mergeCommit": {"oid": "91a4c03d3445ddb52e4265faade5167edb6372d2"}, "closed": true, "closedAt": "2020-08-03T20:17:49Z", "author": {"login": "Tartarus0zm"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5p5y2ABqjM1OTg3MzQ3MzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-K76ugFqTQ2NTg4NjA5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c77cbb4f388d463cf480ee77bde715c2b287ad37", "author": {"user": {"login": "Tartarus0zm", "name": "zhangmang"}}, "url": "https://github.com/apache/flink/commit/c77cbb4f388d463cf480ee77bde715c2b287ad37", "committedDate": "2020-07-29T11:59:12Z", "message": "[FLINK-18663][rest] does not handle new request if handler had been closed"}, "afterCommit": {"oid": "e746fc298c474c9be8a80ecdc21ebb60a3c6b815", "author": {"user": {"login": "Tartarus0zm", "name": "zhangmang"}}, "url": "https://github.com/apache/flink/commit/e746fc298c474c9be8a80ecdc21ebb60a3c6b815", "committedDate": "2020-07-29T12:08:14Z", "message": "[FLINK-18663][rest] does not handle new request if handler had been closed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NjU4ODIw", "url": "https://github.com/apache/flink/pull/13020#pullrequestreview-457658820", "createdAt": "2020-07-29T15:51:15Z", "commit": {"oid": "e746fc298c474c9be8a80ecdc21ebb60a3c6b815"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNTo1MToxNVrOG4-8aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNTo1MToxNVrOG4-8aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQwNDcxMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tsynchronized (this) {\n          \n          \n            \n            \t\tsynchronized (lock) {", "url": "https://github.com/apache/flink/pull/13020#discussion_r462404713", "createdAt": "2020-07-29T15:51:15Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/AbstractHandler.java", "diffHunk": "@@ -114,6 +115,21 @@ protected void respondAsLeader(ChannelHandlerContext ctx, RoutedRequest routedRe\n \t\t\tlog.trace(\"Received request \" + httpRequest.uri() + '.');\n \t\t}\n \n+\t\tsynchronized (this) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e746fc298c474c9be8a80ecdc21ebb60a3c6b815"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NjYwNzc4", "url": "https://github.com/apache/flink/pull/13020#pullrequestreview-457660778", "createdAt": "2020-07-29T15:53:22Z", "commit": {"oid": "e746fc298c474c9be8a80ecdc21ebb60a3c6b815"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNTo1MzoyMlrOG4_CVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNTo1Mzo1M1rOG4_Duw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQwNjIyOA==", "bodyText": "We should not try to submit a response; since we are either already shutdown or in the process of shutting down the response may or may not go through. Better to be consistent and not respond in either case.\nOne thing we can do though is close the channel via ctx.channel().close().", "url": "https://github.com/apache/flink/pull/13020#discussion_r462406228", "createdAt": "2020-07-29T15:53:22Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/AbstractHandler.java", "diffHunk": "@@ -114,6 +115,21 @@ protected void respondAsLeader(ChannelHandlerContext ctx, RoutedRequest routedRe\n \t\t\tlog.trace(\"Received request \" + httpRequest.uri() + '.');\n \t\t}\n \n+\t\tsynchronized (this) {\n+\t\t\tif (terminationFuture != null) {\n+\t\t\t\tString errorMsg = \"The handler instance for \" + untypedResponseMessageHeaders.getTargetRestEndpointURL()\n+\t\t\t\t\t+ \" had already been closed\";\n+\t\t\t\tlog.warn(errorMsg);\n+\t\t\t\tHandlerUtils.sendErrorResponse(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e746fc298c474c9be8a80ecdc21ebb60a3c6b815"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQwNjU4Nw==", "bodyText": "this also needs to happen under the lock, otherwise the race condition isn't fixed. (just move the entire synchronized block here)", "url": "https://github.com/apache/flink/pull/13020#discussion_r462406587", "createdAt": "2020-07-29T15:53:53Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/AbstractHandler.java", "diffHunk": "@@ -114,6 +115,21 @@ protected void respondAsLeader(ChannelHandlerContext ctx, RoutedRequest routedRe\n \t\t\tlog.trace(\"Received request \" + httpRequest.uri() + '.');\n \t\t}\n \n+\t\tsynchronized (this) {\n+\t\t\tif (terminationFuture != null) {\n+\t\t\t\tString errorMsg = \"The handler instance for \" + untypedResponseMessageHeaders.getTargetRestEndpointURL()\n+\t\t\t\t\t+ \" had already been closed\";\n+\t\t\t\tlog.warn(errorMsg);\n+\t\t\t\tHandlerUtils.sendErrorResponse(\n+\t\t\t\t\tctx,\n+\t\t\t\t\thttpRequest,\n+\t\t\t\t\tnew ErrorResponseBody(errorMsg),\n+\t\t\t\t\tHttpResponseStatus.BAD_REQUEST,\n+\t\t\t\t\tresponseHeaders);\n+\t\t\t\treturn;\n+\t\t\t}\n+\t\t}\n+\n \t\tFileUploads uploadedFiles = null;\n \t\ttry {\n \t\t\tinFlightRequestTracker.registerRequest();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e746fc298c474c9be8a80ecdc21ebb60a3c6b815"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db1ab9b53dfb3744eb3f09ff5059cce4d7de31de", "author": {"user": {"login": "Tartarus0zm", "name": "zhangmang"}}, "url": "https://github.com/apache/flink/commit/db1ab9b53dfb3744eb3f09ff5059cce4d7de31de", "committedDate": "2020-07-30T10:04:07Z", "message": "[FLINK-18663][rest] does not handle new request if handler had been closed"}, "afterCommit": {"oid": "41ac35d96c420b40628fc9a64aca80c54cb78081", "author": {"user": {"login": "Tartarus0zm", "name": "zhangmang"}}, "url": "https://github.com/apache/flink/commit/41ac35d96c420b40628fc9a64aca80c54cb78081", "committedDate": "2020-07-30T13:07:08Z", "message": "[FLINK-18663][rest] does not handle new request if handler had been closed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90f1c667ed460cca944aed31402e89a4216b2d14", "author": {"user": {"login": "Tartarus0zm", "name": "zhangmang"}}, "url": "https://github.com/apache/flink/commit/90f1c667ed460cca944aed31402e89a4216b2d14", "committedDate": "2020-08-03T08:46:33Z", "message": "[FLINK-18663][rest] Improve exception handling\n\n- ensure that request finalization runs even if handleException throws an exception\n- catch NPE in handleException, which occurs if the client closes the connection"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "41ac35d96c420b40628fc9a64aca80c54cb78081", "author": {"user": {"login": "Tartarus0zm", "name": "zhangmang"}}, "url": "https://github.com/apache/flink/commit/41ac35d96c420b40628fc9a64aca80c54cb78081", "committedDate": "2020-07-30T13:07:08Z", "message": "[FLINK-18663][rest] does not handle new request if handler had been closed"}, "afterCommit": {"oid": "14688aa89dbf3d9c5f0df1052f0f804ae6f79b07", "author": {"user": {"login": "Tartarus0zm", "name": "zhangmang"}}, "url": "https://github.com/apache/flink/commit/14688aa89dbf3d9c5f0df1052f0f804ae6f79b07", "committedDate": "2020-08-03T08:46:33Z", "message": "[FLINK-18663][rest] Exit early if shutdown has started"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fd5769688d1f66c54dceca0b135ebc3d5c4b604", "author": {"user": {"login": "Tartarus0zm", "name": "zhangmang"}}, "url": "https://github.com/apache/flink/commit/5fd5769688d1f66c54dceca0b135ebc3d5c4b604", "committedDate": "2020-08-03T13:01:39Z", "message": "[FLINK-18663][rest] Exit early if shutdown has started"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d374f52f0c0c40585dc9bad5962aa52cb602b21", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/0d374f52f0c0c40585dc9bad5962aa52cb602b21", "committedDate": "2020-08-03T13:01:39Z", "message": "[hotfix][rest][tests] Replace HandlerBlocker with BlockerSync"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "14688aa89dbf3d9c5f0df1052f0f804ae6f79b07", "author": {"user": {"login": "Tartarus0zm", "name": "zhangmang"}}, "url": "https://github.com/apache/flink/commit/14688aa89dbf3d9c5f0df1052f0f804ae6f79b07", "committedDate": "2020-08-03T08:46:33Z", "message": "[FLINK-18663][rest] Exit early if shutdown has started"}, "afterCommit": {"oid": "0d374f52f0c0c40585dc9bad5962aa52cb602b21", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/0d374f52f0c0c40585dc9bad5962aa52cb602b21", "committedDate": "2020-08-03T13:01:39Z", "message": "[hotfix][rest][tests] Replace HandlerBlocker with BlockerSync"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1ODg2MDk3", "url": "https://github.com/apache/flink/pull/13020#pullrequestreview-465886097", "createdAt": "2020-08-12T12:53:52Z", "commit": {"oid": "0d374f52f0c0c40585dc9bad5962aa52cb602b21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMjo1Mzo1MlrOG_f7Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMjo1Mzo1MlrOG_f7Bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIzNjQ4Nw==", "bodyText": "I think I have given you ill-advice here @Tartarus0zm and @zentol. Since we want to support asynchronous operations such as cancel-with-savepoint which only shuts down the cluster (per-job-mode) if the result has been served, it is a valid state that terminationFuture is non null and we still want to process the request.\nWhat I would suggest is to change this line into if (terminationFuture != null && terminationFuture.isDone()) {. Moreover, all inFlightRequestTracker modifying calls should happen under this lock.", "url": "https://github.com/apache/flink/pull/13020#discussion_r469236487", "createdAt": "2020-08-12T12:53:52Z", "author": {"login": "tillrohrmann"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/rest/handler/AbstractHandler.java", "diffHunk": "@@ -116,7 +117,15 @@ protected void respondAsLeader(ChannelHandlerContext ctx, RoutedRequest routedRe\n \n \t\tFileUploads uploadedFiles = null;\n \t\ttry {\n-\t\t\tinFlightRequestTracker.registerRequest();\n+\t\t\tsynchronized (this) {\n+\t\t\t\tif (terminationFuture != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d374f52f0c0c40585dc9bad5962aa52cb602b21"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4865, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}