{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MDQ5MDIw", "number": 13091, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQwNjo0MDowNlrOEWi_5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMTowOTozOVrOEWv5eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMDc3NTQxOnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQwNjo0MDowNlrOG94o0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQyMTozMTo1M1rOG998EA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzU0NDI3Mg==", "bodyText": "@rkhachatryan thanks for the fix.\nAfter this change, the behavior is equal to 1.10 and would respect the min-pause setting now.\nI'm wandering do we need to make the lastCheckpointCompletionRelativeTime and pendingCheckpoints.size  volatile.", "url": "https://github.com/apache/flink/pull/13091#discussion_r467544272", "createdAt": "2020-08-09T06:40:06Z", "author": {"login": "klion26"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java", "diffHunk": "@@ -318,6 +318,7 @@ public CheckpointCoordinator(\n \t\t\tthis.clock,\n \t\t\tthis.minPauseBetweenCheckpoints,\n \t\t\tthis.pendingCheckpoints::size,\n+\t\t\t() -> this.lastCheckpointCompletionRelativeTime,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6339ff6f9b1acdb6f7cd163c9f866f77fd65c708"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzYzMTEyMA==", "bodyText": "Thanks for reviewing @klion26.\nvolatile seems unnecessary because (both) values are written and read under the same lock.", "url": "https://github.com/apache/flink/pull/13091#discussion_r467631120", "createdAt": "2020-08-09T21:31:53Z", "author": {"login": "rkhachatryan"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java", "diffHunk": "@@ -318,6 +318,7 @@ public CheckpointCoordinator(\n \t\t\tthis.clock,\n \t\t\tthis.minPauseBetweenCheckpoints,\n \t\t\tthis.pendingCheckpoints::size,\n+\t\t\t() -> this.lastCheckpointCompletionRelativeTime,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzU0NDI3Mg=="}, "originalCommit": {"oid": "6339ff6f9b1acdb6f7cd163c9f866f77fd65c708"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMjg4ODkwOnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointRequestDecider.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMTowOTozOVrOG-KPnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMzo0MjozOVrOG_h4zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgzMjczNQ==", "bodyText": "Those suppliers/consumers are making this class harder to follow and I think they are showing some deeper design problem - too tight coupling between CheckpointCoordinator/CheckpointRequestDecider.\nIn particular, it looks like adding Supplier<Long> completionTimeSupplier reveals quite weird concurrency contract between those two. Both are using the same lock object, and they are cross accessing the CheckpointCoordinator#lastCheckpointCompletionRelativeTime field from within the lock CheckpointRequestDecider#lock for read access and CheckpointCoordinator#lock for the write access.\nWhat about making CheckpointRequestDecider a non thread safe class, remove the CheckpointRequestDecider#lock and just relay on the caller (CheckpointCoordinator) to either access CheckpointRequestDecider from a single thread or provide thread safety. For now CheckpointCoordinator would be acquiring CheckpointCoordinator#lock before calling CheckpointRequestDecider, while after completing threading model refactor, the CheckpointCoordinator#lock would be simply removed, without a need to modify CheckpointRequestDecider?", "url": "https://github.com/apache/flink/pull/13091#discussion_r467832735", "createdAt": "2020-08-10T11:09:39Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointRequestDecider.java", "diffHunk": "@@ -55,20 +55,23 @@\n \t@GuardedBy(\"lock\")\n \tprivate final NavigableSet<CheckpointTriggerRequest> queuedRequests = new TreeSet<>(checkpointTriggerRequestsComparator());\n \tprivate final int maxQueuedRequests;\n+\tprivate final Supplier<Long> completionTimeSupplier;\n \n \tCheckpointRequestDecider(\n \t\t\tint maxConcurrentCheckpointAttempts,\n \t\t\tConsumer<Long> rescheduleTrigger,\n \t\t\tClock clock,\n \t\t\tlong minPauseBetweenCheckpoints,\n \t\t\tSupplier<Integer> pendingCheckpointsSizeSupplier,\n+\t\t\tSupplier<Long> completionTimeSupplier,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c5cc7ba30a61db136551bd956c079e7fb5d3ad8"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1MzYyNg==", "bodyText": "I agree that the current design has these two issues:\n\nUnnecessary complex\nUnclear synchronization semantics\n\nTo deal with both of them I proposed to use actor-based approach.\nOTH, the proposed change of \"making CheckpointRequestDecider a non thread safe class\":\n\nreplaces Suppliers with arguments, but doesn't remove the complexity\nmoves synchronization to another class, but doesn't remove it (we'll need to synchronize more sections in CheckpointCoordinator)\n\nI like these changes, but not in the context of the upcoming refactoring (even if not actor-based - I tried to follow the original sync logic when extracting CheckpointRequestDecider, so changing it now can make the refactoring more difficult).\nBesides that, the fix should be backported to 1.11, so I'd prefer a smaller changeset.", "url": "https://github.com/apache/flink/pull/13091#discussion_r467853626", "createdAt": "2020-08-10T11:56:41Z", "author": {"login": "rkhachatryan"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointRequestDecider.java", "diffHunk": "@@ -55,20 +55,23 @@\n \t@GuardedBy(\"lock\")\n \tprivate final NavigableSet<CheckpointTriggerRequest> queuedRequests = new TreeSet<>(checkpointTriggerRequestsComparator());\n \tprivate final int maxQueuedRequests;\n+\tprivate final Supplier<Long> completionTimeSupplier;\n \n \tCheckpointRequestDecider(\n \t\t\tint maxConcurrentCheckpointAttempts,\n \t\t\tConsumer<Long> rescheduleTrigger,\n \t\t\tClock clock,\n \t\t\tlong minPauseBetweenCheckpoints,\n \t\t\tSupplier<Integer> pendingCheckpointsSizeSupplier,\n+\t\t\tSupplier<Long> completionTimeSupplier,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgzMjczNQ=="}, "originalCommit": {"oid": "5c5cc7ba30a61db136551bd956c079e7fb5d3ad8"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI2ODY4NQ==", "bodyText": "As clarified offline, the proposal was not \"remove existing suppliers\" but \"not to add a new one\"; which is indeed a smaller changeset.\nI've updated the PR, please take a look @pnowojski .", "url": "https://github.com/apache/flink/pull/13091#discussion_r469268685", "createdAt": "2020-08-12T13:42:39Z", "author": {"login": "rkhachatryan"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointRequestDecider.java", "diffHunk": "@@ -55,20 +55,23 @@\n \t@GuardedBy(\"lock\")\n \tprivate final NavigableSet<CheckpointTriggerRequest> queuedRequests = new TreeSet<>(checkpointTriggerRequestsComparator());\n \tprivate final int maxQueuedRequests;\n+\tprivate final Supplier<Long> completionTimeSupplier;\n \n \tCheckpointRequestDecider(\n \t\t\tint maxConcurrentCheckpointAttempts,\n \t\t\tConsumer<Long> rescheduleTrigger,\n \t\t\tClock clock,\n \t\t\tlong minPauseBetweenCheckpoints,\n \t\t\tSupplier<Integer> pendingCheckpointsSizeSupplier,\n+\t\t\tSupplier<Long> completionTimeSupplier,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgzMjczNQ=="}, "originalCommit": {"oid": "5c5cc7ba30a61db136551bd956c079e7fb5d3ad8"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4925, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}