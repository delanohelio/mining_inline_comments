{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3MDgyNzQ0", "number": 14206, "title": "[FLINK-20314][planner] Add rule to remove empty calc", "bodyText": "What is the purpose of the change\nRemove the empty calc node in the logical rewrite phase.\nThe empty calc is produced by the rule PushWatermarkIntoTableSourceScanAcrossCalcRule. However, it's difficult to eliminate the empty calc in the PushWatermarkIntoTableSourceScanAcrossCalcRule.  Let me explain why it may get trivial calc.  For example,\nCREATE TABLE SimpleTable(\n   a INT,\n   b INT,\n   c TIMESTAMP(3),\n   d AS c + INTERVAL '5' SECOND,\n  WATERMARK FOR d AS d - INTERVAL '5' SECOND\n) WITH (\n ...\n)\n\nWith the query SELECT a, b, c FROM SimpleTable, we have the following plan after logical phase before logical rewrite phase\nFlinkLogicalCalc(select=[a, b, c])\n+- FlinkLogicalWatermarkAssigner(rowtime=[d], watermark=[-($3, 5000:INTERVAL SECOND)])\n   +- FlinkLogicalCalc(select=[a, b, c, +(c, 5000:INTERVAL SECOND) AS d])\n      +- FlinkLogicalTableSourceScan(table=[[default_catalog, default_database, VirtualTable]], fields=[a, b, c])\n\nAfter PushWatermarkIntoTableSourceScanAcrossCalcRule applies, we will get the plan\nFlinkLogicalCalc(select=[a, b, c])\n+- FlinkLogicalCalc(select=[a, b, c, +(c, 5000:INTERVAL SECOND) AS d])\n    +- FlinkLogicalTableSourceScan(table=[[default_catalog, default_database, VirtualTable]], fields=[a, b, c], watermark=[-($3, 5000:INTERVAL SECOND)])\n\nAfter calc merge rule applies, we will have the following plan\nFlinkLogicalCalc(select=[a, b, c])\n+- FlinkLogicalTableSourceScan(table=[[default_catalog, default_database, VirtualTable]], fields=[a, b, c], watermark=[-($3, 5000:INTERVAL SECOND)])\n\nNow we has the trivial calc. It's out of scope for the push-watermark-down rule to prune the trivial calc. Therefore, we'd better to keep the push-watermark-down rule unchanged and add a new rule to remove the empty calc.\nBrief change log\n\nAdd FlinkLogicalCalcRemoveRule to remove empty calc\n\nVerifying this change\nThis change added tests and can be verified as follows:\n\nAdd unit test and itcase\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)", "createdAt": "2020-11-25T04:16:09Z", "url": "https://github.com/apache/flink/pull/14206", "merged": true, "mergeCommit": {"oid": "4cc1da96e88ddc6166181a7f83c891761db283a1"}, "closed": true, "closedAt": "2020-11-26T01:56:45Z", "author": {"login": "fsk119"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdf2lTDAH2gAyNTI3MDgyNzQ0OmZlODY3ZTRmNDg3MDk2YzU5MDhlYmFjZTRlMjBiNGYyZjZiOTg2Nzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdf6nhagFqTUzODI4Mzg4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fe867e4f487096c5908ebace4e20b4f2f6b98677", "author": {"user": {"login": "fsk119", "name": "Shengkai "}}, "url": "https://github.com/apache/flink/commit/fe867e4f487096c5908ebace4e20b4f2f6b98677", "committedDate": "2020-11-25T04:24:30Z", "message": "[FLINK-20314][planner] Add rule to remove empty calc"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a06b6ce2f629cd6fdea5ab86b67bf2a855a90e8", "author": {"user": {"login": "fsk119", "name": "Shengkai "}}, "url": "https://github.com/apache/flink/commit/0a06b6ce2f629cd6fdea5ab86b67bf2a855a90e8", "committedDate": "2020-11-25T03:46:53Z", "message": "[FLINK-20314][planner] Add rule to remove empty calc"}, "afterCommit": {"oid": "fe867e4f487096c5908ebace4e20b4f2f6b98677", "author": {"user": {"login": "fsk119", "name": "Shengkai "}}, "url": "https://github.com/apache/flink/commit/fe867e4f487096c5908ebace4e20b4f2f6b98677", "committedDate": "2020-11-25T04:24:30Z", "message": "[FLINK-20314][planner] Add rule to remove empty calc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MTg0OTEz", "url": "https://github.com/apache/flink/pull/14206#pullrequestreview-538184913", "createdAt": "2020-11-25T06:18:49Z", "commit": {"oid": "fe867e4f487096c5908ebace4e20b4f2f6b98677"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjoxODo1MFrOH5kpBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjoxODo1MFrOH5kpBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzMTIwNg==", "bodyText": "Why not use CoreRules.CALC_REMOVE directly ?\nplease also add this rule to FlinkBatchRuleSets", "url": "https://github.com/apache/flink/pull/14206#discussion_r530131206", "createdAt": "2020-11-25T06:18:50Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/rules/FlinkStreamRuleSets.scala", "diffHunk": "@@ -365,6 +365,8 @@ object FlinkStreamRuleSets {\n     PythonCorrelateSplitRule.INSTANCE,\n     // merge calc after calc transpose\n     FlinkCalcMergeRule.INSTANCE,\n+    // remove trivial calc\n+    FlinkLogicalCalcRemoveRule.INSTANCE,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe867e4f487096c5908ebace4e20b4f2f6b98677"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba57ad2bb9df819719a803bb7003989510131e07", "author": {"user": {"login": "fsk119", "name": "Shengkai "}}, "url": "https://github.com/apache/flink/commit/ba57ad2bb9df819719a803bb7003989510131e07", "committedDate": "2020-11-25T06:29:25Z", "message": "address comments: add calc remove rule to batch rule set"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c93214df9098974e3a3f2f7e2af12cfc35167cb", "author": {"user": {"login": "fsk119", "name": "Shengkai "}}, "url": "https://github.com/apache/flink/commit/5c93214df9098974e3a3f2f7e2af12cfc35167cb", "committedDate": "2020-11-25T07:19:31Z", "message": "add comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MjgzODg5", "url": "https://github.com/apache/flink/pull/14206#pullrequestreview-538283889", "createdAt": "2020-11-25T09:06:33Z", "commit": {"oid": "5c93214df9098974e3a3f2f7e2af12cfc35167cb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4125, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}