{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1OTA1NTA1", "number": 13939, "title": "[FLINK-19992][hive] Integrate new orc to Hive source", "bodyText": "What is the purpose of the change\nAfter introducing OrcColumnarRowFileInputFormat\nWe need integrate it to Hive, including Hive 2+ and Hive 1.X\nBrief change log\n\nIntroduce OrcNoHiveColumnarRowInputFormat\nIntegrate orc in HiveBulkFormatAdapter\n\nVerifying this change\nThis change is already covered by existing tests.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no", "createdAt": "2020-11-05T09:01:05Z", "url": "https://github.com/apache/flink/pull/13939", "merged": true, "mergeCommit": {"oid": "c33e1adbd401a2030d51863c940b8822f06005e5"}, "closed": true, "closedAt": "2020-11-07T02:24:03Z", "author": {"login": "JingsongLi"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZyKIuAFqTUyNDkxNzQ1OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZ37x8gBqjM5Njc0NzQwNTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0OTE3NDU4", "url": "https://github.com/apache/flink/pull/13939#pullrequestreview-524917458", "createdAt": "2020-11-06T07:45:04Z", "commit": {"oid": "a7bfb90cbeffd83a836343f55f0535c7e3c487de"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwNzo0NTowNFrOHujMaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwNzo0OToxMVrOHujTEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU3MzE2Mw==", "bodyText": "We already have a computeSelectedFields method, can it be reused?", "url": "https://github.com/apache/flink/pull/13939#discussion_r518573163", "createdAt": "2020-11-06T07:45:04Z", "author": {"login": "lirui-apache"}, "path": "flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/connectors/hive/read/HiveBulkFormatAdapter.java", "diffHunk": "@@ -107,24 +114,78 @@ public boolean isSplittable() {\n \t\treturn InternalTypeInfo.of(producedRowType);\n \t}\n \n+\tprivate RowType tableRowType() {\n+\t\tLogicalType[] types = Arrays.stream(fieldTypes).map(DataType::getLogicalType).toArray(LogicalType[]::new);\n+\t\treturn RowType.of(types, fieldNames);\n+\t}\n+\n+\tprivate int[] projectedFields() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7bfb90cbeffd83a836343f55f0535c7e3c487de"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU3NDg2Ng==", "bodyText": "Collections.emptyList()?", "url": "https://github.com/apache/flink/pull/13939#discussion_r518574866", "createdAt": "2020-11-06T07:49:11Z", "author": {"login": "lirui-apache"}, "path": "flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/connectors/hive/read/HiveBulkFormatAdapter.java", "diffHunk": "@@ -107,24 +114,78 @@ public boolean isSplittable() {\n \t\treturn InternalTypeInfo.of(producedRowType);\n \t}\n \n+\tprivate RowType tableRowType() {\n+\t\tLogicalType[] types = Arrays.stream(fieldTypes).map(DataType::getLogicalType).toArray(LogicalType[]::new);\n+\t\treturn RowType.of(types, fieldNames);\n+\t}\n+\n+\tprivate int[] projectedFields() {\n+\t\tList<String> nameList = Arrays.asList(fieldNames);\n+\t\tint[] projectedFields = new int[producedRowType.getFieldCount()];\n+\t\tList<String> projectedNames = producedRowType.getFieldNames();\n+\t\tfor (int i = 0; i < projectedFields.length; i++) {\n+\t\t\tprojectedFields[i] = nameList.indexOf(projectedNames.get(i));\n+\t\t}\n+\t\treturn projectedFields;\n+\t}\n+\n \tprivate BulkFormat<RowData, ? super HiveSourceSplit> createBulkFormatForSplit(HiveSourceSplit split) {\n \t\tif (!useMapRedReader && useParquetVectorizedRead(split.getHiveTablePartition())) {\n-\t\t\tPartitionFieldExtractor<HiveSourceSplit> extractor = (PartitionFieldExtractor<HiveSourceSplit>)\n-\t\t\t\t\t(split1, fieldName, fieldType) -> split1.getHiveTablePartition().getPartitionSpec().get(fieldName);\n \t\t\treturn ParquetColumnarRowInputFormat.createPartitionedFormat(\n \t\t\t\t\tjobConfWrapper.conf(),\n \t\t\t\t\tproducedRowType,\n \t\t\t\t\tpartitionKeys,\n-\t\t\t\t\textractor,\n+\t\t\t\t\tPARTITION_FIELD_EXTRACTOR,\n \t\t\t\t\tDEFAULT_SIZE,\n \t\t\t\t\thiveVersion.startsWith(\"3\"),\n \t\t\t\t\tfalse\n \t\t\t);\n+\t\t} else if (!useMapRedReader && useOrcVectorizedRead(split.getHiveTablePartition())) {\n+\t\t\treturn createOrcFormat();\n \t\t} else {\n \t\t\treturn new HiveMapRedBulkFormat();\n \t\t}\n \t}\n \n+\tprivate OrcColumnarRowFileInputFormat<?, HiveSourceSplit> createOrcFormat() {\n+\t\treturn hiveVersion.startsWith(\"1.\") ?\n+\t\t\t\tOrcColumnarRowFileInputFormat.createPartitionedFormat(\n+\t\t\t\t\tOrcShim.createShim(hiveVersion),\n+\t\t\t\t\tjobConfWrapper.conf(),\n+\t\t\t\t\ttableRowType(),\n+\t\t\t\t\tpartitionKeys,\n+\t\t\t\t\tPARTITION_FIELD_EXTRACTOR,\n+\t\t\t\t\tprojectedFields(),\n+\t\t\t\t\tnew ArrayList<>(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7bfb90cbeffd83a836343f55f0535c7e3c487de"}, "originalPosition": 77}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c4689ba5707f4e5001e1d2fd2d344f6baa28574", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/6c4689ba5707f4e5001e1d2fd2d344f6baa28574", "committedDate": "2020-11-05T09:34:15Z", "message": "Fix"}, "afterCommit": {"oid": "670c1f199ad98fb4814f172cdee5158dbb3ed97a", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/670c1f199ad98fb4814f172cdee5158dbb3ed97a", "committedDate": "2020-11-06T08:40:12Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0OTY0ODg2", "url": "https://github.com/apache/flink/pull/13939#pullrequestreview-524964886", "createdAt": "2020-11-06T09:00:34Z", "commit": {"oid": "670c1f199ad98fb4814f172cdee5158dbb3ed97a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd9245e045185c8740872596237a675547c1058d", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/cd9245e045185c8740872596237a675547c1058d", "committedDate": "2020-11-06T14:35:08Z", "message": "[FLINK-19992][hive] Integrate new orc to Hive source"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "670c1f199ad98fb4814f172cdee5158dbb3ed97a", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/670c1f199ad98fb4814f172cdee5158dbb3ed97a", "committedDate": "2020-11-06T08:40:12Z", "message": "Address comments"}, "afterCommit": {"oid": "cd9245e045185c8740872596237a675547c1058d", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/cd9245e045185c8740872596237a675547c1058d", "committedDate": "2020-11-06T14:35:08Z", "message": "[FLINK-19992][hive] Integrate new orc to Hive source"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4823, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}