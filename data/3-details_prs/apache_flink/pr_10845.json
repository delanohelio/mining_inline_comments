{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyMTg0OTIz", "number": 10845, "title": "[FLINK-15355][plugins]Classloader restricts access to parent to whitelist.", "bodyText": "What is the purpose of the change\nClassloader restricts access to parent to whitelist.\nNo class/resource in the system class loader (everything in lib/) can be seen in the plugin except those starting with a whitelist prefix.\nBrief change log\n\nClassloader restricts access to parent to whitelist.\n\nVerifying this change\n\nShaded Hadoop S3A with credentials provider end-to-end test\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-01-13T15:43:03Z", "url": "https://github.com/apache/flink/pull/10845", "merged": true, "mergeCommit": {"oid": "deb3a4d71b6516bf9da1e0b923e4ca9bdae24643"}, "closed": true, "closedAt": "2020-01-16T11:54:06Z", "author": {"login": "AHeise"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6BITvgBqjI5NDQzODUzNDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb64z8AgFqTM0Mzg1ODg5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0942cb8b913ba50ecf8d7ca28832c4c92bf78e6c", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/0942cb8b913ba50ecf8d7ca28832c4c92bf78e6c", "committedDate": "2020-01-13T15:41:22Z", "message": "[temp] enabling all e2e tests in basic build"}, "afterCommit": {"oid": "ce62e6539d1394a5d27d8ef51db010104852e433", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/ce62e6539d1394a5d27d8ef51db010104852e433", "committedDate": "2020-01-13T15:41:21Z", "message": "[FLINK-15355][plugins] Classloader avoids loading unrelated services.\n\nExtends child-first class loader to a child-only classloader for service definitions.\n\nPlugins are considered self-contained such that all required services are contained within it. Thus, it would even be possible to use different versions of security providers for different classes.\n\nThis behavior also avoids accidental loading of services outside of the plugin, especially for hadoop distributions in /lib. A service loader from the plugin would detect such services but cannot load them successfully because parts of the service' class hierarchy would have been loaded with the system class loader."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce62e6539d1394a5d27d8ef51db010104852e433", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/ce62e6539d1394a5d27d8ef51db010104852e433", "committedDate": "2020-01-13T15:41:21Z", "message": "[FLINK-15355][plugins] Classloader avoids loading unrelated services.\n\nExtends child-first class loader to a child-only classloader for service definitions.\n\nPlugins are considered self-contained such that all required services are contained within it. Thus, it would even be possible to use different versions of security providers for different classes.\n\nThis behavior also avoids accidental loading of services outside of the plugin, especially for hadoop distributions in /lib. A service loader from the plugin would detect such services but cannot load them successfully because parts of the service' class hierarchy would have been loaded with the system class loader."}, "afterCommit": {"oid": "76bd16a406b4bbbee5d4189b66f1fdd36f98798f", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/76bd16a406b4bbbee5d4189b66f1fdd36f98798f", "committedDate": "2020-01-14T17:31:14Z", "message": "[FLINK-15355][plugins]Classloader restricts access to parent to whitelist.\n\nNo class/resource in the system class loader (everything in lib/) can be seen in the plugin except those starting with a whitelist prefix."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76bd16a406b4bbbee5d4189b66f1fdd36f98798f", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/76bd16a406b4bbbee5d4189b66f1fdd36f98798f", "committedDate": "2020-01-14T17:31:14Z", "message": "[FLINK-15355][plugins]Classloader restricts access to parent to whitelist.\n\nNo class/resource in the system class loader (everything in lib/) can be seen in the plugin except those starting with a whitelist prefix."}, "afterCommit": {"oid": "726f81492a05cc47657a9c30caf2e397e8c1bd02", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/726f81492a05cc47657a9c30caf2e397e8c1bd02", "committedDate": "2020-01-14T19:55:57Z", "message": "[FLINK-15355][plugins]Classloader restricts access to parent to whitelist.\n\nNo class/resource in the system class loader (everything in lib/) can be seen in the plugin except those starting with a whitelist prefix."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "726f81492a05cc47657a9c30caf2e397e8c1bd02", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/726f81492a05cc47657a9c30caf2e397e8c1bd02", "committedDate": "2020-01-14T19:55:57Z", "message": "[FLINK-15355][plugins]Classloader restricts access to parent to whitelist.\n\nNo class/resource in the system class loader (everything in lib/) can be seen in the plugin except those starting with a whitelist prefix."}, "afterCommit": {"oid": "18934ef582e5ba278289541d8602b081c4f63367", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/18934ef582e5ba278289541d8602b081c4f63367", "committedDate": "2020-01-14T21:52:38Z", "message": "[FLINK-15355][plugins]Classloader restricts access to parent to whitelist.\n\nNo class/resource in the system class loader (everything in lib/) can be seen in the plugin except those starting with a whitelist prefix."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "18934ef582e5ba278289541d8602b081c4f63367", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/18934ef582e5ba278289541d8602b081c4f63367", "committedDate": "2020-01-14T21:52:38Z", "message": "[FLINK-15355][plugins]Classloader restricts access to parent to whitelist.\n\nNo class/resource in the system class loader (everything in lib/) can be seen in the plugin except those starting with a whitelist prefix."}, "afterCommit": {"oid": "ebd3076a0b24751eca2dce1d3faf646b56fe6426", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/ebd3076a0b24751eca2dce1d3faf646b56fe6426", "committedDate": "2020-01-15T08:50:26Z", "message": "[FLINK-15355][plugins]Classloader restricts access to whitelisted system classes.\n\nNo class/resource in the system class loader (everything in lib/) can be seen in the plugin except those starting with a whitelist prefix."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ebd3076a0b24751eca2dce1d3faf646b56fe6426", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/ebd3076a0b24751eca2dce1d3faf646b56fe6426", "committedDate": "2020-01-15T08:50:26Z", "message": "[FLINK-15355][plugins]Classloader restricts access to whitelisted system classes.\n\nNo class/resource in the system class loader (everything in lib/) can be seen in the plugin except those starting with a whitelist prefix."}, "afterCommit": {"oid": "ac9c94daa036cec2cb2bb2d53890e67594046479", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/ac9c94daa036cec2cb2bb2d53890e67594046479", "committedDate": "2020-01-15T09:25:58Z", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac9c94daa036cec2cb2bb2d53890e67594046479", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/ac9c94daa036cec2cb2bb2d53890e67594046479", "committedDate": "2020-01-15T09:25:58Z", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader."}, "afterCommit": {"oid": "82749633c593106d881301f9ffe59d28e96d4d38", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/82749633c593106d881301f9ffe59d28e96d4d38", "committedDate": "2020-01-15T12:20:30Z", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "82749633c593106d881301f9ffe59d28e96d4d38", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/82749633c593106d881301f9ffe59d28e96d4d38", "committedDate": "2020-01-15T12:20:30Z", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader."}, "afterCommit": {"oid": "1034dba580372caff0bb82196ff9cfb4dde746bd", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/1034dba580372caff0bb82196ff9cfb4dde746bd", "committedDate": "2020-01-15T16:44:58Z", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1034dba580372caff0bb82196ff9cfb4dde746bd", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/1034dba580372caff0bb82196ff9cfb4dde746bd", "committedDate": "2020-01-15T16:44:58Z", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader."}, "afterCommit": {"oid": "50b191d8a123d0e6277bbd6f60bd0c0b4e1db09d", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/50b191d8a123d0e6277bbd6f60bd0c0b4e1db09d", "committedDate": "2020-01-15T17:27:32Z", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50b191d8a123d0e6277bbd6f60bd0c0b4e1db09d", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/50b191d8a123d0e6277bbd6f60bd0c0b4e1db09d", "committedDate": "2020-01-15T17:27:32Z", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader."}, "afterCommit": {"oid": "8cf994af7e606da2c92da33d4003293e96ba4c16", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/8cf994af7e606da2c92da33d4003293e96ba4c16", "committedDate": "2020-01-15T19:06:01Z", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8cf994af7e606da2c92da33d4003293e96ba4c16", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/8cf994af7e606da2c92da33d4003293e96ba4c16", "committedDate": "2020-01-15T19:06:01Z", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader."}, "afterCommit": {"oid": "d87188f93fc355553279ec5b0b9343ee09ac478b", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/d87188f93fc355553279ec5b0b9343ee09ac478b", "committedDate": "2020-01-15T21:00:13Z", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNzI4MzY2", "url": "https://github.com/apache/flink/pull/10845#pullrequestreview-343728366", "createdAt": "2020-01-16T08:02:41Z", "commit": {"oid": "c1bd37255a1fbdffba63def90f85f9c1a0557d32"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwODowMjo0MVrOFeQxfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwODoxMzoxM1rOFeQ_Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI3NjQxNA==", "bodyText": "revert?", "url": "https://github.com/apache/flink/pull/10845#discussion_r367276414", "createdAt": "2020-01-16T08:02:41Z", "author": {"login": "pnowojski"}, "path": "flink-core/src/main/java/org/apache/flink/configuration/CoreOptions.java", "diffHunk": "@@ -121,7 +121,7 @@\n \tpublic static final ConfigOption<String> PLUGIN_ALWAYS_PARENT_FIRST_LOADER_PATTERNS = ConfigOptions\n \t\t.key(\"plugin.classloader.parent-first-patterns.default\")\n \t\t.stringType()\n-\t\t.defaultValue(\"java.;scala.;org.apache.flink.;javax.annotation.;org.slf4j;org.apache.log4j;org.apache\" +\n+\t\t.defaultValue(\"java.;javax.;scala.;org.apache.flink.;org.slf4j;org.apache.log4j;org.apache\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1bd37255a1fbdffba63def90f85f9c1a0557d32"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI3OTUxOQ==", "bodyText": "return super.getResource(name);\n\n?", "url": "https://github.com/apache/flink/pull/10845#discussion_r367279519", "createdAt": "2020-01-16T08:12:06Z", "author": {"login": "pnowojski"}, "path": "flink-core/src/main/java/org/apache/flink/core/plugin/PluginLoader.java", "diffHunk": "@@ -100,4 +105,97 @@ public P next() {\n \t\t}\n \t}\n \n+\t/**\n+\t * Loads all classes from the plugin jar except for explicitly white-listed packages (org.apache.flink, logging).\n+\t *\n+\t * <p>No class/resource in the system class loader (everything in lib/) can be seen in the plugin except those\n+\t * starting with a whitelist prefix.\n+\t */\n+\tprivate static final class PluginClassLoader extends URLClassLoader {\n+\t\tprivate final ClassLoader flinkClassLoader;\n+\n+\t\tprivate final String[] allowedFlinkPackages;\n+\n+\t\tprivate final String[] allowedResourcePrefixes;\n+\n+\t\tPluginClassLoader(URL[] pluginResourceURLs, ClassLoader flinkClassLoader, String[] allowedFlinkPackages) {\n+\t\t\tsuper(pluginResourceURLs, null);\n+\t\t\tthis.flinkClassLoader = flinkClassLoader;\n+\t\t\tthis.allowedFlinkPackages = allowedFlinkPackages;\n+\t\t\tallowedResourcePrefixes = Arrays.stream(allowedFlinkPackages)\n+\t\t\t\t.map(packageName -> packageName.replace('.', '/'))\n+\t\t\t\t.toArray(String[]::new);\n+\t\t}\n+\n+\t\t@Override\n+\t\tprotected Class<?> loadClass(final String name, final boolean resolve) throws ClassNotFoundException {\n+\t\t\tsynchronized (getClassLoadingLock(name)) {\n+\t\t\t\tfinal Class<?> loadedClass = findLoadedClass(name);\n+\t\t\t\tif (loadedClass != null) {\n+\t\t\t\t\treturn resolveIfNeeded(resolve, loadedClass);\n+\t\t\t\t}\n+\n+\t\t\t\tif (isAllowedFlinkClass(name)) {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\treturn resolveIfNeeded(resolve, flinkClassLoader.loadClass(name));\n+\t\t\t\t\t} catch (ClassNotFoundException e) {\n+\t\t\t\t\t\t// fallback to resolving it in this classloader\n+\t\t\t\t\t\t// for cases where the plugin uses org.apache.flink namespace\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\n+\t\t\t\treturn super.loadClass(name, resolve);\n+\t\t\t}\n+\t\t}\n+\n+\t\tprivate Class<?> resolveIfNeeded(final boolean resolve, final Class<?> loadedClass) {\n+\t\t\tif (resolve) {\n+\t\t\t\tresolveClass(loadedClass);\n+\t\t\t}\n+\t\t\treturn loadedClass;\n+\t\t}\n+\n+\t\t@Override\n+\t\tpublic URL getResource(final String name) {\n+\t\t\tif (isAllowedFlinkResource(name)) {\n+\t\t\t\treturn flinkClassLoader.getResource(name);\n+\t\t\t}\n+\n+\t\t\tURL urlClassLoaderResource = findResource(name);\n+\n+\t\t\tif (urlClassLoaderResource != null) {\n+\t\t\t\treturn urlClassLoaderResource;\n+\t\t\t}\n+\n+\t\t\treturn null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1bd37255a1fbdffba63def90f85f9c1a0557d32"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI3OTkxNQ==", "bodyText": "Why have all the tests changed in this commit?", "url": "https://github.com/apache/flink/pull/10845#discussion_r367279915", "createdAt": "2020-01-16T08:13:13Z", "author": {"login": "pnowojski"}, "path": "flink-tests/src/test/java/org/apache/flink/test/plugin/PluginLoaderTest.java", "diffHunk": "@@ -21,6 +21,7 @@\n import org.apache.flink.core.plugin.PluginDescriptor;\n import org.apache.flink.core.plugin.PluginLoader;\n import org.apache.flink.test.plugin.jar.plugina.TestServiceA;\n+import org.apache.flink.test.plugin.spi.TestSpi;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1bd37255a1fbdffba63def90f85f9c1a0557d32"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e725912b1cf6f948c5aa4d3b8c3c647deada9387", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/e725912b1cf6f948c5aa4d3b8c3c647deada9387", "committedDate": "2020-01-16T09:56:28Z", "message": " [FLINK-15355][plugins]Classloader restricted to whitelisted system classes.\n\nNo class/resource in the system class loader (everything in lib/) can be seen in the plugin except those starting with a whitelist prefix."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cfc8526790aeb1adf7bcb8ca39b4bd33dd6098b", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/8cfc8526790aeb1adf7bcb8ca39b4bd33dd6098b", "committedDate": "2020-01-16T10:06:28Z", "message": "[hotfix][plugins]Hide classloader pattern options from documentation."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d87188f93fc355553279ec5b0b9343ee09ac478b", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/d87188f93fc355553279ec5b0b9343ee09ac478b", "committedDate": "2020-01-15T21:00:13Z", "message": "[hotfix][core] Renamed parent first pattern to parent patterns.\n\nClasses with the given pattern have never been resolved through the child loader. The new name makes clear that these classes are only loaded through the parent loader."}, "afterCommit": {"oid": "8cfc8526790aeb1adf7bcb8ca39b4bd33dd6098b", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/8cfc8526790aeb1adf7bcb8ca39b4bd33dd6098b", "committedDate": "2020-01-16T10:06:28Z", "message": "[hotfix][plugins]Hide classloader pattern options from documentation."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzODU4ODkw", "url": "https://github.com/apache/flink/pull/10845#pullrequestreview-343858890", "createdAt": "2020-01-16T11:53:57Z", "commit": {"oid": "8cfc8526790aeb1adf7bcb8ca39b4bd33dd6098b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4693, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}