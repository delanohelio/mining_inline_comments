{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NTcxMTEz", "number": 12172, "title": " [FLINK-17656][tests] Migrate docker e2e tests to flink-docker ", "bodyText": "Migrates e2e tests relying on flink-container/docker to [flink-docker|https://github.com/apache/flink-docker].\nThe changes mostly cover how the Docker image is built.\nWe now first create a custom Dockerfile, by checking out flink-docker/dev-master and using the add-custom.sh script. This requires the distribution to be accessible from some URL, so we tar the locally built distribution and server it with a local python webserver.\nFor job clusters, instead of backing in the job artifacts into the image we now use instead mount them into the usrlib directory, which is the new default approach.\nSome arguments had to be modified, since flink-docker closely follows the existing CLI scripts, which flink-container/docker did not.", "createdAt": "2020-05-15T12:44:40Z", "url": "https://github.com/apache/flink/pull/12172", "merged": true, "mergeCommit": {"oid": "fa0b303556538b896afbfa5ae475c4bd7a60cc98"}, "closed": true, "closedAt": "2020-05-17T19:34:57Z", "author": {"login": "zentol"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchiwJugFqTQxMjY3MDcxOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABciN7IyABqjMzNDQ3MjAyNjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNjcwNzE5", "url": "https://github.com/apache/flink/pull/12172#pullrequestreview-412670719", "createdAt": "2020-05-15T13:55:07Z", "commit": {"oid": "ff37e0c1c648d9b80bb7d009f6b559d12ad3aeb7"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMzo1NTowN1rOGWF5jA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNDowNToxM1rOGWGTYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgxODUwOA==", "bodyText": "This doesn't work with python3 anymore. Python 2 support has been discontinued.\nI'm a bit concerned that this blows up at some point. We could add a python version check, and use the equivalent python 3 call (python3 -m http.server), download a python binary from somewhere, dockerize it? ...", "url": "https://github.com/apache/flink/pull/12172#discussion_r425818508", "createdAt": "2020-05-15T13:55:07Z", "author": {"login": "rmetzger"}, "path": "flink-end-to-end-tests/test-scripts/common_docker.sh", "diffHunk": "@@ -33,8 +33,25 @@ function containers_health_check() {\n   done\n }\n \n-function build_image_with_jar() {\n-    local job_artifacts=$1\n-    local image_name=${2:-flink-job}\n-    ./build.sh --from-local-dist --job-artifacts ${job_artifacts} --image-name ${image_name}\n+function build_image() {\n+    local image_name=${1:-flink-job}\n+\n+    echo \"Starting fileserver for Flink distribution\"\n+    pushd ${FLINK_DIR}/..\n+    tar -czf \"${TEST_DATA_DIR}/flink.tgz\" flink-*\n+    popd\n+    pushd ${TEST_DATA_DIR}\n+    python -m SimpleHTTPServer 9999 &", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff37e0c1c648d9b80bb7d009f6b559d12ad3aeb7"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgyMDUyNw==", "bodyText": "This mechanism is quite useful for developers of Flink. Does it make sense to move this code into a script in \"flink-docker.git\" and use this here?\ngit clone https://github.com/apache/flink-docker.git\ncd flink-docker\n./build-from-local.sh /path/to/my/build/target username/image:tag", "url": "https://github.com/apache/flink/pull/12172#discussion_r425820527", "createdAt": "2020-05-15T13:58:07Z", "author": {"login": "rmetzger"}, "path": "flink-end-to-end-tests/test-scripts/common_docker.sh", "diffHunk": "@@ -33,8 +33,25 @@ function containers_health_check() {\n   done\n }\n \n-function build_image_with_jar() {\n-    local job_artifacts=$1\n-    local image_name=${2:-flink-job}\n-    ./build.sh --from-local-dist --job-artifacts ${job_artifacts} --image-name ${image_name}\n+function build_image() {\n+    local image_name=${1:-flink-job}\n+\n+    echo \"Starting fileserver for Flink distribution\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff37e0c1c648d9b80bb7d009f6b559d12ad3aeb7"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgyNTEyMw==", "bodyText": "default seems to be flink-job, w/o the :latest.", "url": "https://github.com/apache/flink/pull/12172#discussion_r425825123", "createdAt": "2020-05-15T14:05:13Z", "author": {"login": "rmetzger"}, "path": "flink-end-to-end-tests/test-scripts/container-scripts/docker-compose.test.yml", "diffHunk": "@@ -16,15 +16,31 @@\n # limitations under the License.\n ################################################################################\n \n-# Extensions to flink-container/docker/docker-compose.yml that mounts volumes needed for tests\n+# Docker compose file for a Flink job cluster deployment.\n+#\n+# Parameters:\n+# * FLINK_DOCKER_IMAGE_NAME - Image name to use for the deployment (default: flink-job:latest)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff37e0c1c648d9b80bb7d009f6b559d12ad3aeb7"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNzM3MzM0", "url": "https://github.com/apache/flink/pull/12172#pullrequestreview-412737334", "createdAt": "2020-05-15T15:13:18Z", "commit": {"oid": "53535b6bfbf308d4a5e1d209a11ce8cac6265a13"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0f4bffb49fe59cda55a92e9608f678ed0d93259", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/b0f4bffb49fe59cda55a92e9608f678ed0d93259", "committedDate": "2020-05-17T16:32:41Z", "message": "[FLINK-17656][tests] Migrate docker e2e tests to flink-docker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b450055a1e9f35a286342105e0da83ed8c74faa", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/8b450055a1e9f35a286342105e0da83ed8c74faa", "committedDate": "2020-05-17T16:32:42Z", "message": "[hotfix][docker] Prevent docker-compose caching\n\nThe caching is overly aggressive and potentially even ignores changes to the .yml files."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da355ac23cca4c125508f661d9d6d16416ced16b", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/da355ac23cca4c125508f661d9d6d16416ced16b", "committedDate": "2020-05-17T14:01:21Z", "message": "auto-shutdown + reuse address"}, "afterCommit": {"oid": "8b450055a1e9f35a286342105e0da83ed8c74faa", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/8b450055a1e9f35a286342105e0da83ed8c74faa", "committedDate": "2020-05-17T16:32:42Z", "message": "[hotfix][docker] Prevent docker-compose caching\n\nThe caching is overly aggressive and potentially even ignores changes to the .yml files."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4072, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}