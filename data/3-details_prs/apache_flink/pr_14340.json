{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0NTU3ODMw", "number": 14340, "title": "[FLINK-20533][datadog] Add Histogram support ", "bodyText": "Adds support for histograms to the datadog reporter, and does a bunch of cleanup work in the code.\nHistograms are mapped to a series of gauges; while datadog does have a histogram metric type it is not supported via the HTTP API that we use.", "createdAt": "2020-12-08T16:11:13Z", "url": "https://github.com/apache/flink/pull/14340", "merged": true, "mergeCommit": {"oid": "313e20e8e03953a5e1cec9daa467f561ccfbd599"}, "closed": true, "closedAt": "2020-12-15T21:26:39Z", "author": {"login": "zentol"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlG066AFqTU1MDAzOTAyNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmZL0zABqjQxMTQyNDA5Nzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMDM5MDI1", "url": "https://github.com/apache/flink/pull/14340#pullrequestreview-550039025", "createdAt": "2020-12-11T12:01:19Z", "commit": {"oid": "4f62e23c4ec3c38a510b4d3eb93935c6972b7e7e"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMjowMToxOVrOID11NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMjowNzowMVrOID2Axg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5ODYxMg==", "bodyText": "This runs in a separate thread, but seems quite expensive with the string concat and the MetricsMetaData allocation each time we send the metric.\nDoes it make sense to initialize the MetaData with the different name suffixes in the constructor?", "url": "https://github.com/apache/flink/pull/14340#discussion_r540898612", "createdAt": "2020-12-11T12:01:19Z", "author": {"login": "rmetzger"}, "path": "flink-metrics/flink-metrics-datadog/src/main/java/org/apache/flink/metrics/datadog/DHistogram.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.metrics.datadog;\n+\n+import org.apache.flink.metrics.Histogram;\n+import org.apache.flink.metrics.HistogramStatistics;\n+\n+import java.util.List;\n+\n+/**\n+ * Maps histograms to datadog gauges.\n+ *\n+ * <p>Note: We cannot map them to datadog histograms because the HTTP API does not support them.\n+ */\n+public class DHistogram {\n+\tprivate final Histogram histogram;\n+\tprivate final MetricMetaData metaData;\n+\n+\tpublic DHistogram(Histogram histogram, String metricName, String host, List<String> tags, Clock clock) {\n+\t\tthis.histogram = histogram;\n+\t\tthis.metaData = new MetricMetaData(MetricType.gauge, metricName, host, tags, clock);\n+\t}\n+\n+\tpublic void addTo(DSeries series) {\n+\t\tfinal HistogramStatistics statistics = histogram.getStatistics();\n+\n+\t\t// this selection is based on https://docs.datadoghq.com/developers/metrics/types/?tab=histogram\n+\t\t// we only exclude 'sum' (which is optional), because we cannot compute it\n+\t\t// the semantics for count are also slightly different, because we don't reset it after a report\n+\t\tseries.add(new StaticDMetric(statistics.getMean(), withMetricNameSuffix(metaData, \"avg\")));\n+\t\tseries.add(new StaticDMetric(histogram.getCount(), withMetricNameSuffix(metaData, \"count\")));\n+\t\tseries.add(new StaticDMetric(statistics.getQuantile(.5), withMetricNameSuffix(metaData, \"median\")));\n+\t\tseries.add(new StaticDMetric(statistics.getQuantile(.95), withMetricNameSuffix(metaData, \"95percentile\")));\n+\t\tseries.add(new StaticDMetric(statistics.getMin(), withMetricNameSuffix(metaData, \"min\")));\n+\t\tseries.add(new StaticDMetric(statistics.getMax(), withMetricNameSuffix(metaData, \"max\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f62e23c4ec3c38a510b4d3eb93935c6972b7e7e"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5OTQzMA==", "bodyText": "I understand you changed this for the tests, but it's a bit ugly. Maybe add a comment?", "url": "https://github.com/apache/flink/pull/14340#discussion_r540899430", "createdAt": "2020-12-11T12:02:52Z", "author": {"login": "rmetzger"}, "path": "flink-metrics/flink-metrics-datadog/src/main/java/org/apache/flink/metrics/datadog/DatadogHttpClient.java", "diffHunk": "@@ -113,8 +113,8 @@ public void send(DSeries request) throws Exception {\n \t\tclient.newCall(r).enqueue(EmptyCallback.getEmptyCallback());\n \t}\n \n-\tpublic static String serialize(Object obj) throws JsonProcessingException {\n-\t\treturn MAPPER.writeValueAsString(obj);\n+\tpublic static String serialize(Object obj, ObjectMapper mapper) throws JsonProcessingException {\n+\t\treturn mapper.writeValueAsString(obj);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f62e23c4ec3c38a510b4d3eb93935c6972b7e7e"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkwMTU3NA==", "bodyText": "Strictly speaking this mapper is only necessary for having deterministic test results. The proper solution would probably be parsing the JSON response and compare the results not as a string.", "url": "https://github.com/apache/flink/pull/14340#discussion_r540901574", "createdAt": "2020-12-11T12:07:01Z", "author": {"login": "rmetzger"}, "path": "flink-metrics/flink-metrics-datadog/src/main/java/org/apache/flink/metrics/datadog/DatadogHttpClient.java", "diffHunk": "@@ -113,8 +113,8 @@ public void send(DSeries request) throws Exception {\n \t\tclient.newCall(r).enqueue(EmptyCallback.getEmptyCallback());\n \t}\n \n-\tpublic static String serialize(Object obj) throws JsonProcessingException {\n-\t\treturn MAPPER.writeValueAsString(obj);\n+\tpublic static String serialize(Object obj, ObjectMapper mapper) throws JsonProcessingException {\n+\t\treturn mapper.writeValueAsString(obj);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5OTQzMA=="}, "originalCommit": {"oid": "4f62e23c4ec3c38a510b4d3eb93935c6972b7e7e"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f62e23c4ec3c38a510b4d3eb93935c6972b7e7e", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/4f62e23c4ec3c38a510b4d3eb93935c6972b7e7e", "committedDate": "2020-12-08T16:02:32Z", "message": "[FLINK-20533][datadog] Add Histogram support"}, "afterCommit": {"oid": "ccbb7ca839b16f8d587fbcc88cb42be1fee636fc", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/ccbb7ca839b16f8d587fbcc88cb42be1fee636fc", "committedDate": "2020-12-13T23:36:21Z", "message": "[FLINK-20533][datadog] Add Histogram support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2806b98f4e8c4702435847a5d6d9016a1e5decf", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/b2806b98f4e8c4702435847a5d6d9016a1e5decf", "committedDate": "2020-12-15T10:40:23Z", "message": "[hotfix][datadog][tests] Cleanup code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b993db3d01accf1f037129acc421d178a62e2449", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/b993db3d01accf1f037129acc421d178a62e2449", "committedDate": "2020-12-15T10:40:23Z", "message": "[hotfix][datadog] Merge DSeries#add*()\n\nThe distinction between metric types adds unnecessary complexity."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6c7054176fe825ab9f3d53460afb992314f02e2", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/f6c7054176fe825ab9f3d53460afb992314f02e2", "committedDate": "2020-12-15T10:40:23Z", "message": "[hotfix][datadog] Explicitly mark fields relevant for serialization\n\nIt was difficult to tell which fields are relevant for serialization. Adding annotations makes this more obvious, and allows us more freedom in regards to naming."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e6bc099b1ae8eb988f9ef5da218b111daae0689", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/6e6bc099b1ae8eb988f9ef5da218b111daae0689", "committedDate": "2020-12-15T10:40:23Z", "message": "[hotfix][datadog][tests] Rework tests\n\n- re-parse JSON to ignore order of serialization\n- restrict 'DatadogHttpClient.serialize()' to 'DSeries'\n- test series serialization\n- refer to constants where possible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98b53561048c58a6140b15a5ba6dcc511dc8e78d", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/98b53561048c58a6140b15a5ba6dcc511dc8e78d", "committedDate": "2020-12-15T10:40:23Z", "message": "[hotfix][datadog] Remove outdated comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "700c1788f6127ded1c49a103e01e8c8e0c6897be", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/700c1788f6127ded1c49a103e01e8c8e0c6897be", "committedDate": "2020-12-15T10:40:23Z", "message": "[FLINK-20533][datadog] Encapsulate metric meta data\n\nThis allows us to use the 'MetricMetaData' container for histograms later on, which will not directly extend 'DMetric'."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dfcdba2dc6932632be7ef4391a03c7db3688b63", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/3dfcdba2dc6932632be7ef4391a03c7db3688b63", "committedDate": "2020-12-15T12:06:38Z", "message": "[FLINK-20533][datadog] Add Histogram support"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1618c8c9d6639b774ea6336b90a0c0b2ce888b80", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/1618c8c9d6639b774ea6336b90a0c0b2ce888b80", "committedDate": "2020-12-14T00:16:35Z", "message": "+documentation"}, "afterCommit": {"oid": "3dfcdba2dc6932632be7ef4391a03c7db3688b63", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/3dfcdba2dc6932632be7ef4391a03c7db3688b63", "committedDate": "2020-12-15T12:06:38Z", "message": "[FLINK-20533][datadog] Add Histogram support"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3977, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}