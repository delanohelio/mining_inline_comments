{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyMDc1NzI3", "number": 13837, "title": "[FLINK-19874][table-planner-blink] Apply JoinDeriveNullFilterRule after join reorder", "bodyText": "What is the purpose of the change\nJoinDeriveNullFilterRule will filter out null join keys to prevent data skew for joins. Currently this rule is only applied before join reorder. After join reorder the join keys for some inputs might change and we need to apply this rule again.\nThis PR applies the rule again after join reorder.\nBrief change log\n\nApply JoinDeriveNullFilterRule after join reorder\n\nVerifying this change\nThis change added tests and can be verified by running the added tests.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? not applicable", "createdAt": "2020-10-29T07:24:56Z", "url": "https://github.com/apache/flink/pull/13837", "merged": true, "mergeCommit": {"oid": "d0458aa649255a37bc2af7ddfeaea109abdac44a"}, "closed": true, "closedAt": "2020-11-03T11:36:44Z", "author": {"login": "tsreaper"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXM9RogH2gAyNTEyMDc1NzI3OjI0N2E4YjRhMWFjNjk1NThkMzhmYTgyYjhjMzQ2ZGJjNDA3Yjc5YzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYjPUxAFqTUyMTU2NDIzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "247a8b4a1ac69558d38fa82b8c346dbc407b79c6", "author": {"user": {"login": "tsreaper", "name": null}}, "url": "https://github.com/apache/flink/commit/247a8b4a1ac69558d38fa82b8c346dbc407b79c6", "committedDate": "2020-10-29T07:23:17Z", "message": "[FLINK-19874][table-planner-blink] Apply JoinDeriveNullFilterRule after join reorder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNDI0ODE1", "url": "https://github.com/apache/flink/pull/13837#pullrequestreview-520424815", "createdAt": "2020-10-30T07:25:36Z", "commit": {"oid": "247a8b4a1ac69558d38fa82b8c346dbc407b79c6"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNzoyNTozNlrOHrDvSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNzoyODoxN1rOHrDy0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkxMjA3NQ==", "bodyText": "It's better we do not put JoinDeriveNullFilterRule  into JOIN_COND_EQUAL_TRANSFER_RULES collection, instead I suggest we can add a program into  JOIN_REWRITE stage after JOIN_COND_EQUAL_TRANSFER_RULES", "url": "https://github.com/apache/flink/pull/13837#discussion_r514912075", "createdAt": "2020-10-30T07:25:36Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/rules/FlinkBatchRuleSets.scala", "diffHunk": "@@ -222,7 +222,8 @@ object FlinkBatchRuleSets {\n   val JOIN_COND_EQUAL_TRANSFER_RULES: RuleSet = RuleSets.ofList((\n     RuleSets.ofList(JoinConditionEqualityTransferRule.INSTANCE).asScala ++\n       PREDICATE_SIMPLIFY_EXPRESSION_RULES.asScala ++\n-      FILTER_RULES.asScala\n+      FILTER_RULES.asScala ++\n+      RuleSets.ofList(JoinDeriveNullFilterRule.INSTANCE).asScala", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "247a8b4a1ac69558d38fa82b8c346dbc407b79c6"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkxMjU3MQ==", "bodyText": "if they are only used in one test method, we can move them into the specific method", "url": "https://github.com/apache/flink/pull/13837#discussion_r514912571", "createdAt": "2020-10-30T07:27:06Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/common/JoinReorderTestBase.scala", "diffHunk": "@@ -69,6 +70,27 @@ abstract class JoinReorderTestBase extends TableTestBase {\n         \"b5\" -> new ColumnStats(200L, 0L, 8.0, 8, null, null)\n       ))).build())\n \n+    util.addTableSource(\"T6\", types, Array(\"a6\", \"b6\", \"c6\"), FlinkStatistic.builder()\n+      .tableStats(new TableStats(500000L, Map(\n+        \"a6\" -> new ColumnStats(200000L, 50000L, 4.0, 4, null, null),\n+        \"b6\" -> new ColumnStats(100000L, 0L, 8.0, 8, null, null),\n+        \"c6\" -> new ColumnStats(50000L, 20000L, 8.0, 8, null, null)\n+      ))).build())\n+\n+    util.addTableSource(\"T7\", types, Array(\"a7\", \"b7\", \"c7\"), FlinkStatistic.builder()\n+      .tableStats(new TableStats(500000L, Map(\n+        \"a7\" -> new ColumnStats(200000L, 50000L, 4.0, 4, null, null),\n+        \"b7\" -> new ColumnStats(100000L, 0L, 8.0, 8, null, null),\n+        \"c7\" -> new ColumnStats(50000L, 20000L, 8.0, 8, null, null)\n+      ))).build())\n+\n+    util.addTableSource(\"T8\", types, Array(\"a8\", \"b8\", \"c8\"), FlinkStatistic.builder()\n+      .tableStats(new TableStats(500000L, Map(\n+        \"a8\" -> new ColumnStats(200000L, 50000L, 4.0, 4, null, null),\n+        \"b8\" -> new ColumnStats(100000L, 0L, 8.0, 8, null, null),\n+        \"c8\" -> new ColumnStats(50000L, 20000L, 8.0, 8, null, null)\n+      ))).build())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "247a8b4a1ac69558d38fa82b8c346dbc407b79c6"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkxMjk3Ng==", "bodyText": "please do not use deprecated constructor", "url": "https://github.com/apache/flink/pull/13837#discussion_r514912976", "createdAt": "2020-10-30T07:28:17Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/common/JoinReorderTestBase.scala", "diffHunk": "@@ -69,6 +70,27 @@ abstract class JoinReorderTestBase extends TableTestBase {\n         \"b5\" -> new ColumnStats(200L, 0L, 8.0, 8, null, null)\n       ))).build())\n \n+    util.addTableSource(\"T6\", types, Array(\"a6\", \"b6\", \"c6\"), FlinkStatistic.builder()\n+      .tableStats(new TableStats(500000L, Map(\n+        \"a6\" -> new ColumnStats(200000L, 50000L, 4.0, 4, null, null),\n+        \"b6\" -> new ColumnStats(100000L, 0L, 8.0, 8, null, null),\n+        \"c6\" -> new ColumnStats(50000L, 20000L, 8.0, 8, null, null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "247a8b4a1ac69558d38fa82b8c346dbc407b79c6"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70ef6a8a21a39d9f6811baed3e2ca080fec2cd36", "author": {"user": {"login": "tsreaper", "name": null}}, "url": "https://github.com/apache/flink/commit/70ef6a8a21a39d9f6811baed3e2ca080fec2cd36", "committedDate": "2020-10-31T19:59:02Z", "message": "[fix] Fix comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMzc1MzQ4", "url": "https://github.com/apache/flink/pull/13837#pullrequestreview-521375348", "createdAt": "2020-11-02T07:16:22Z", "commit": {"oid": "70ef6a8a21a39d9f6811baed3e2ca080fec2cd36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwNzoxNjoyMlrOHr4d3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwNzoxNjoyMlrOHr4d3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc3NTk2NQ==", "bodyText": "It's better JOIN_PREDICATE_REWRITE_RULES could reuse this rule set", "url": "https://github.com/apache/flink/pull/13837#discussion_r515775965", "createdAt": "2020-11-02T07:16:22Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/rules/FlinkBatchRuleSets.scala", "diffHunk": "@@ -222,10 +222,13 @@ object FlinkBatchRuleSets {\n   val JOIN_COND_EQUAL_TRANSFER_RULES: RuleSet = RuleSets.ofList((\n     RuleSets.ofList(JoinConditionEqualityTransferRule.INSTANCE).asScala ++\n       PREDICATE_SIMPLIFY_EXPRESSION_RULES.asScala ++\n-      FILTER_RULES.asScala ++\n-      RuleSets.ofList(JoinDeriveNullFilterRule.INSTANCE).asScala\n+      FILTER_RULES.asScala\n     ).asJava)\n \n+  val JOIN_NULL_FILTER_RULES: RuleSet = RuleSets.ofList(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70ef6a8a21a39d9f6811baed3e2ca080fec2cd36"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5eb6c0fda626550a66b3beb699c3c6bfbbd5d743", "author": {"user": {"login": "tsreaper", "name": null}}, "url": "https://github.com/apache/flink/commit/5eb6c0fda626550a66b3beb699c3c6bfbbd5d743", "committedDate": "2020-11-02T09:20:53Z", "message": "[fix] Fix comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNTY0MjM5", "url": "https://github.com/apache/flink/pull/13837#pullrequestreview-521564239", "createdAt": "2020-11-02T11:54:50Z", "commit": {"oid": "5eb6c0fda626550a66b3beb699c3c6bfbbd5d743"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4937, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}