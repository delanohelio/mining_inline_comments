{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzNzEwOTgw", "number": 12355, "title": "[FLINK-17893] [sql-client] SQL CLI should print the root cause if the statement is invalid", "bodyText": "What is the purpose of the change\nFLINK-17728 supports parsing statements via sql parser, the SqlCommandParser will parse a statement via sql parser first (only ValidationException will be checked). If parse failed, then SqlCommandParser parses a statement via regex matching. So the SqlParseException and other exception are missing. The pr aims to fix this. The solution is changing the parse strategy: try to use regex matching to find a command. if nothing is found, use sql parser to parse the statement and don't catch any exception in SqlCommandParser.\nBrief change log\n\nUpdate the parse strategy\nCatch and print the SqlExecutionException in CliClient#parseCommand method\n\nVerifying this change\nThis change added tests and can be verified as follows:\n\nSimplify SqlCommandParseTest\nadd CliClientTest#testCreateTableWithInvalidDdl case to validate the case mentioned in the jira\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-05-27T09:01:53Z", "url": "https://github.com/apache/flink/pull/12355", "merged": true, "mergeCommit": {"oid": "02b915a80a92307cc16bec229ec5faf175a2251d"}, "closed": true, "closedAt": "2020-06-09T03:58:03Z", "author": {"login": "godfreyhe"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclVd29ABqjMzNzcxMjY2ODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpc5uNAFqTQyNjc3MjAxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b76275661c50c6ec0b8f463e055cbe973cbfa8b0", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/b76275661c50c6ec0b8f463e055cbe973cbfa8b0", "committedDate": "2020-05-27T08:13:45Z", "message": "[FLINK-17893] [sql-client] SQL CLI should print the root cause if the statement is invalid"}, "afterCommit": {"oid": "578b299f37b20eab2cd6ce64160cbbfc3ba10479", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/578b299f37b20eab2cd6ce64160cbbfc3ba10479", "committedDate": "2020-05-27T08:51:04Z", "message": "[FLINK-17893] [sql-client] SQL CLI should print the root cause if the statement is invalid"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1c6c2a8dc337e9d01bfbe48af599441571b0d4ee", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/1c6c2a8dc337e9d01bfbe48af599441571b0d4ee", "committedDate": "2020-05-28T03:07:37Z", "message": "fix checkstyle error"}, "afterCommit": {"oid": "18758d007d909ad3427c384140bf36a71e06ea1b", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/18758d007d909ad3427c384140bf36a71e06ea1b", "committedDate": "2020-06-02T07:56:17Z", "message": "fix checkstyle error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNjEyMTg4", "url": "https://github.com/apache/flink/pull/12355#pullrequestreview-422612188", "createdAt": "2020-06-02T12:11:10Z", "commit": {"oid": "18758d007d909ad3427c384140bf36a71e06ea1b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMzU0MzM5", "url": "https://github.com/apache/flink/pull/12355#pullrequestreview-423354339", "createdAt": "2020-06-03T08:58:59Z", "commit": {"oid": "18758d007d909ad3427c384140bf36a71e06ea1b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwODo1ODo1OVrOGeSmyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwODo1ODo1OVrOGeSmyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQxNTMwNA==", "bodyText": "We may never run into this code branch now ~", "url": "https://github.com/apache/flink/pull/12355#discussion_r434415304", "createdAt": "2020-06-03T08:58:59Z", "author": {"login": "danny0405"}, "path": "flink-table/flink-sql-client/src/main/java/org/apache/flink/table/client/cli/CliClient.java", "diffHunk": "@@ -253,7 +253,13 @@ public boolean submitUpdate(String statement) {\n \t// --------------------------------------------------------------------------------------------\n \n \tprivate Optional<SqlCommandCall> parseCommand(String line) {\n-\t\tfinal Optional<SqlCommandCall> parsedLine = SqlCommandParser.parse(executor.getSqlParser(sessionId), line);\n+\t\tfinal Optional<SqlCommandCall> parsedLine;\n+\t\ttry {\n+\t\t\tparsedLine = SqlCommandParser.parse(executor.getSqlParser(sessionId), line);\n+\t\t} catch (SqlExecutionException e) {\n+\t\t\tprintExecutionException(e);\n+\t\t\treturn Optional.empty();\n+\t\t}\n \t\tif (!parsedLine.isPresent()) {\n \t\t\tprintError(CliStrings.MESSAGE_UNKNOWN_SQL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18758d007d909ad3427c384140bf36a71e06ea1b"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMzU0OTc3", "url": "https://github.com/apache/flink/pull/12355#pullrequestreview-423354977", "createdAt": "2020-06-03T08:59:43Z", "commit": {"oid": "18758d007d909ad3427c384140bf36a71e06ea1b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwODo1OTo0M1rOGeSonA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwODo1OTo0M1rOGeSonA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQxNTc3Mg==", "bodyText": "Add some comment to explain why to match the SELECT and INSERT keyword explicitly.", "url": "https://github.com/apache/flink/pull/12355#discussion_r434415772", "createdAt": "2020-06-03T08:59:43Z", "author": {"login": "danny0405"}, "path": "flink-table/flink-sql-client/src/main/java/org/apache/flink/table/client/cli/SqlCommandParser.java", "diffHunk": "@@ -253,8 +247,10 @@ private SqlCommandParser() {\n \t\t// supports both `explain xx` and `explain plan for xx` now\n \t\t// TODO should keep `explain xx` ?\n \t\tEXPLAIN(\n-\t\t\t\"EXPLAIN\\\\s+(.*)\",\n-\t\t\tSINGLE_OPERAND),\n+\t\t\t\"EXPLAIN\\\\s+(SELECT|INSERT)\\\\s+(.*)\",\n+\t\t\t(operands) -> {\n+\t\t\t\treturn Optional.of(new String[] { operands[0], operands[1] });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18758d007d909ad3427c384140bf36a71e06ea1b"}, "originalPosition": 55}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e733198f517f74de94d68622a3a039d3f888acaa", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/e733198f517f74de94d68622a3a039d3f888acaa", "committedDate": "2020-06-03T09:41:05Z", "message": "address Danny's comments"}, "afterCommit": {"oid": "35be5d6088100c8e99655061e13161b7de9b5173", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/35be5d6088100c8e99655061e13161b7de9b5173", "committedDate": "2020-06-05T02:22:44Z", "message": "address Danny's comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDU1MDEz", "url": "https://github.com/apache/flink/pull/12355#pullrequestreview-425055013", "createdAt": "2020-06-05T07:24:24Z", "commit": {"oid": "35be5d6088100c8e99655061e13161b7de9b5173"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "35be5d6088100c8e99655061e13161b7de9b5173", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/35be5d6088100c8e99655061e13161b7de9b5173", "committedDate": "2020-06-05T02:22:44Z", "message": "address Danny's comments"}, "afterCommit": {"oid": "d0acf33548d2b0a38e6c757666e20ad988de73a2", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/d0acf33548d2b0a38e6c757666e20ad988de73a2", "committedDate": "2020-06-05T11:09:27Z", "message": "address Danny's comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7b337a6e2e22337580a7993ad8ced8dcf8adca1", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/c7b337a6e2e22337580a7993ad8ced8dcf8adca1", "committedDate": "2020-06-07T13:12:16Z", "message": "[FLINK-17893] [sql-client] SQL CLI should print the root cause if the statement is invalid"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bab05936db40722989c25315f90a1016e10a246e", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/bab05936db40722989c25315f90a1016e10a246e", "committedDate": "2020-06-07T13:12:17Z", "message": "fix checkstyle error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d27a26142df7cb72ab663798be9fc7387125321", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/1d27a26142df7cb72ab663798be9fc7387125321", "committedDate": "2020-06-07T13:12:17Z", "message": "address Danny's comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0acf33548d2b0a38e6c757666e20ad988de73a2", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/d0acf33548d2b0a38e6c757666e20ad988de73a2", "committedDate": "2020-06-05T11:09:27Z", "message": "address Danny's comments"}, "afterCommit": {"oid": "1d27a26142df7cb72ab663798be9fc7387125321", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/1d27a26142df7cb72ab663798be9fc7387125321", "committedDate": "2020-06-07T13:12:17Z", "message": "address Danny's comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NzcyMDE4", "url": "https://github.com/apache/flink/pull/12355#pullrequestreview-426772018", "createdAt": "2020-06-09T03:57:22Z", "commit": {"oid": "1d27a26142df7cb72ab663798be9fc7387125321"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4481, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}