{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyMzkxOTY3", "number": 11285, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDozODoyNVrODk_itQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMTo1ODoxOVrODlBC3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTE2NDA1OnYy", "diffSide": "RIGHT", "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDozODoyNlrOFxoIBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDozODoyNlrOFxoIBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU4MTk1OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tLocalStandaloneFlinkResource(Path distributionDirectory, Optional<Path> logBackupDirectory, FlinkResourceSetup setup) {\n          \n          \n            \n            \tLocalStandaloneFlinkResource(Path distributionDirectory, @Nullable Path logBackupDirectory, FlinkResourceSetup setup) {\n          \n      \n    \n    \n  \n\ncode style", "url": "https://github.com/apache/flink/pull/11285#discussion_r387581958", "createdAt": "2020-03-04T10:38:26Z", "author": {"login": "azagrebin"}, "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResource.java", "diffHunk": "@@ -51,16 +58,28 @@\n \n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResource.class);\n \n-\tprivate final FlinkDistribution distribution = new FlinkDistribution();\n+\tprivate final TemporaryFolder temporaryFolder = new TemporaryFolder();\n+\tprivate final Path distributionDirectory;\n+\t@Nullable\n+\tprivate final Path logBackupDirectory;\n \tprivate final FlinkResourceSetup setup;\n \n-\tLocalStandaloneFlinkResource(FlinkResourceSetup setup) {\n+\tprivate FlinkDistribution distribution;\n+\n+\tLocalStandaloneFlinkResource(Path distributionDirectory, Optional<Path> logBackupDirectory, FlinkResourceSetup setup) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "281fa884afd6a76ece952ce5245227fec2d86bce"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTE3NjA5OnYy", "diffSide": "RIGHT", "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDo0MTo0M1rOFxoPYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDo0MTo0M1rOFxoPYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU4Mzg0Mg==", "bodyText": "nit for hotfix, can be IOException", "url": "https://github.com/apache/flink/pull/11285#discussion_r387583842", "createdAt": "2020-03-04T10:41:43Z", "author": {"login": "azagrebin"}, "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResource.java", "diffHunk": "@@ -51,16 +58,28 @@\n \n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResource.class);\n \n-\tprivate final FlinkDistribution distribution = new FlinkDistribution();\n+\tprivate final TemporaryFolder temporaryFolder = new TemporaryFolder();\n+\tprivate final Path distributionDirectory;\n+\t@Nullable\n+\tprivate final Path logBackupDirectory;\n \tprivate final FlinkResourceSetup setup;\n \n-\tLocalStandaloneFlinkResource(FlinkResourceSetup setup) {\n+\tprivate FlinkDistribution distribution;\n+\n+\tLocalStandaloneFlinkResource(Path distributionDirectory, Optional<Path> logBackupDirectory, FlinkResourceSetup setup) {\n+\t\tthis.distributionDirectory = distributionDirectory;\n+\t\tthis.logBackupDirectory = logBackupDirectory.orElse(null);\n \t\tthis.setup = setup;\n \t}\n \n \t@Override\n \tpublic void before() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "281fa884afd6a76ece952ce5245227fec2d86bce"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTM1MzgwOnYy", "diffSide": "RIGHT", "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMTozOToxOVrOFxp9JQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMTozOToxOVrOFxp9JQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYxMTk0MQ==", "bodyText": "backupLogs();", "url": "https://github.com/apache/flink/pull/11285#discussion_r387611941", "createdAt": "2020-03-04T11:39:19Z", "author": {"login": "azagrebin"}, "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResource.java", "diffHunk": "@@ -71,12 +90,33 @@ public void before() throws Exception {\n \n \t@Override\n \tpublic void afterTestSuccess() {\n-\t\tdistribution.afterTestSuccess();\n+\t\tshutdownCluster();\n+\t\ttemporaryFolder.delete();\n \t}\n \n \t@Override\n \tpublic void afterTestFailure() {\n-\t\tdistribution.afterTestFailure();\n+\t\tif (distribution != null) {\n+\t\t\tshutdownCluster();\n+\t\t\tif (logBackupDirectory != null) {\n+\t\t\t\tfinal Path targetDirectory = logBackupDirectory.resolve(UUID.randomUUID().toString());\n+\t\t\t\ttry {\n+\t\t\t\t\tdistribution.copyLogsTo(targetDirectory);\n+\t\t\t\t\tLOG.info(\"Backed up logs to {}.\", targetDirectory);\n+\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\tLOG.warn(\"An error has occurred while backing up logs to {}.\", targetDirectory, e);\n+\t\t\t\t}\n+\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "281fa884afd6a76ece952ce5245227fec2d86bce"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTM3NDA0OnYy", "diffSide": "RIGHT", "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMTo0NjoyMFrOFxqJRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMjozNjozMlrOFxrjbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYxNTA0NA==", "bodyText": "distribution = createFlinkDistribution();", "url": "https://github.com/apache/flink/pull/11285#discussion_r387615044", "createdAt": "2020-03-04T11:46:20Z", "author": {"login": "azagrebin"}, "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResource.java", "diffHunk": "@@ -51,16 +58,28 @@\n \n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResource.class);\n \n-\tprivate final FlinkDistribution distribution = new FlinkDistribution();\n+\tprivate final TemporaryFolder temporaryFolder = new TemporaryFolder();\n+\tprivate final Path distributionDirectory;\n+\t@Nullable\n+\tprivate final Path logBackupDirectory;\n \tprivate final FlinkResourceSetup setup;\n \n-\tLocalStandaloneFlinkResource(FlinkResourceSetup setup) {\n+\tprivate FlinkDistribution distribution;\n+\n+\tLocalStandaloneFlinkResource(Path distributionDirectory, Optional<Path> logBackupDirectory, FlinkResourceSetup setup) {\n+\t\tthis.distributionDirectory = distributionDirectory;\n+\t\tthis.logBackupDirectory = logBackupDirectory.orElse(null);\n \t\tthis.setup = setup;\n \t}\n \n \t@Override\n \tpublic void before() throws Exception {\n-\t\tdistribution.before();\n+\t\ttemporaryFolder.create();\n+\t\tPath tmp = temporaryFolder.newFolder().toPath();\n+\t\tLOG.info(\"Copying distribution to {}.\", tmp);\n+\t\tTestUtils.copyDirectory(distributionDirectory, tmp);\n+\n+\t\tdistribution = new FlinkDistribution(tmp);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "281fa884afd6a76ece952ce5245227fec2d86bce"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYzODEyNw==", "bodyText": "meh, seems unnecessary. The whole method is about setting up the distribution; it seems arbitrary to move some of that into another method.", "url": "https://github.com/apache/flink/pull/11285#discussion_r387638127", "createdAt": "2020-03-04T12:36:32Z", "author": {"login": "zentol"}, "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResource.java", "diffHunk": "@@ -51,16 +58,28 @@\n \n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResource.class);\n \n-\tprivate final FlinkDistribution distribution = new FlinkDistribution();\n+\tprivate final TemporaryFolder temporaryFolder = new TemporaryFolder();\n+\tprivate final Path distributionDirectory;\n+\t@Nullable\n+\tprivate final Path logBackupDirectory;\n \tprivate final FlinkResourceSetup setup;\n \n-\tLocalStandaloneFlinkResource(FlinkResourceSetup setup) {\n+\tprivate FlinkDistribution distribution;\n+\n+\tLocalStandaloneFlinkResource(Path distributionDirectory, Optional<Path> logBackupDirectory, FlinkResourceSetup setup) {\n+\t\tthis.distributionDirectory = distributionDirectory;\n+\t\tthis.logBackupDirectory = logBackupDirectory.orElse(null);\n \t\tthis.setup = setup;\n \t}\n \n \t@Override\n \tpublic void before() throws Exception {\n-\t\tdistribution.before();\n+\t\ttemporaryFolder.create();\n+\t\tPath tmp = temporaryFolder.newFolder().toPath();\n+\t\tLOG.info(\"Copying distribution to {}.\", tmp);\n+\t\tTestUtils.copyDirectory(distributionDirectory, tmp);\n+\n+\t\tdistribution = new FlinkDistribution(tmp);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYxNTA0NA=="}, "originalCommit": {"oid": "281fa884afd6a76ece952ce5245227fec2d86bce"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTQxMDIwOnYy", "diffSide": "RIGHT", "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResourceFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMTo1ODoxOVrOFxqe1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMjozMTozOVrOFxra1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYyMDU2NQ==", "bodyText": "Does it mean that running e2e tests from IDE will always need to set distDir manually?", "url": "https://github.com/apache/flink/pull/11285#discussion_r387620565", "createdAt": "2020-03-04T11:58:19Z", "author": {"login": "azagrebin"}, "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResourceFactory.java", "diffHunk": "@@ -29,9 +33,21 @@\n public final class LocalStandaloneFlinkResourceFactory implements FlinkResourceFactory {\n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResourceFactory.class);\n \n+\tprivate static final ParameterProperty<Path> DISTRIBUTION_DIRECTORY = new ParameterProperty<>(\"distDir\", Paths::get);\n+\tprivate static final ParameterProperty<Path> DISTRIBUTION_LOG_BACKUP_DIRECTORY = new ParameterProperty<>(\"logBackupDir\", Paths::get);\n+\n \t@Override\n \tpublic Optional<FlinkResource> create(FlinkResourceSetup setup) {\n+\t\tOptional<Path> distributionDirectory = DISTRIBUTION_DIRECTORY.get();\n+\t\tif (!distributionDirectory.isPresent()) {\n+\t\t\tLOG.warn(\"The distDir property was not set. You can set it when running maven via -DdistDir=<path> .\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "281fa884afd6a76ece952ce5245227fec2d86bce"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYzNTkyNg==", "bodyText": "yes, this isn't new.", "url": "https://github.com/apache/flink/pull/11285#discussion_r387635926", "createdAt": "2020-03-04T12:31:39Z", "author": {"login": "zentol"}, "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResourceFactory.java", "diffHunk": "@@ -29,9 +33,21 @@\n public final class LocalStandaloneFlinkResourceFactory implements FlinkResourceFactory {\n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResourceFactory.class);\n \n+\tprivate static final ParameterProperty<Path> DISTRIBUTION_DIRECTORY = new ParameterProperty<>(\"distDir\", Paths::get);\n+\tprivate static final ParameterProperty<Path> DISTRIBUTION_LOG_BACKUP_DIRECTORY = new ParameterProperty<>(\"logBackupDir\", Paths::get);\n+\n \t@Override\n \tpublic Optional<FlinkResource> create(FlinkResourceSetup setup) {\n+\t\tOptional<Path> distributionDirectory = DISTRIBUTION_DIRECTORY.get();\n+\t\tif (!distributionDirectory.isPresent()) {\n+\t\t\tLOG.warn(\"The distDir property was not set. You can set it when running maven via -DdistDir=<path> .\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYyMDU2NQ=="}, "originalCommit": {"oid": "281fa884afd6a76ece952ce5245227fec2d86bce"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 838, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}