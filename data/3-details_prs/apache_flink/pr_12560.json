{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxODg0ODgy", "number": 12560, "title": "[FLINK-18097][history-server] Cleaning job files in history server", "bodyText": "What is the purpose of the change\nAfter deleting (or moving) a file from location specified in historyserver.archive.fs.dir there are some files left in history server working directory.\nThis problem was already addressed in #9759, but there are still json files created in webDir/jobs/ left and never cleaned. With high number of jobs, those files can eventualy take quite some drive space.\nCurrent behaviour also allows for supposedly deleted job to be accessed over web UI <HistoryServerURL>/#/job/<jobId>/overview, though it is not listed in Completed Jobs list.\nBrief change log\n\nupdated how files are cleaned in HistoryServerArchiveFetcher\n\nVerifying this change\n\nExtended existing tests with file existence check before and after it is deleted\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no", "createdAt": "2020-06-09T15:28:12Z", "url": "https://github.com/apache/flink/pull/12560", "merged": true, "mergeCommit": {"oid": "78d6ee1cef6d9c0d5d28e4e228f7050de1c6c7a2"}, "closed": true, "closedAt": "2020-07-08T10:14:14Z", "author": {"login": "Draczech"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpz9ZkAFqTQyNzc1MjUyOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyrU--ABqjM1MjIwMjc1Mjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NzUyNTI5", "url": "https://github.com/apache/flink/pull/12560#pullrequestreview-427752529", "createdAt": "2020-06-10T06:44:16Z", "commit": {"oid": "3e40dddf2d2559baabc544e1254b942c853dd595"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwNjo0NDoxN1rOGhm5wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwNjo0NjoxMlrOGhm9ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg5MzU2OQ==", "bodyText": "nit: can we reuse the variable defined in HistoryServerArchiveFetcher.java?", "url": "https://github.com/apache/flink/pull/12560#discussion_r437893569", "createdAt": "2020-06-10T06:44:17Z", "author": {"login": "dmvk"}, "path": "flink-runtime-web/src/test/java/org/apache/flink/runtime/webmonitor/history/HistoryServerTest.java", "diffHunk": "@@ -78,6 +78,7 @@\n \t\t.disable(JsonGenerator.Feature.AUTO_CLOSE_JSON_CONTENT);\n \tprivate static final ObjectMapper OBJECT_MAPPER = new ObjectMapper()\n \t\t.enable(DeserializationFeature.FAIL_ON_MISSING_CREATOR_PROPERTIES);\n+\tprivate static final String JSON_FILE_ENDING = \".json\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e40dddf2d2559baabc544e1254b942c853dd595"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg5NDUwMQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/apache/flink/pull/12560#discussion_r437894501", "createdAt": "2020-06-10T06:46:12Z", "author": {"login": "dmvk"}, "path": "flink-runtime-web/src/main/java/org/apache/flink/runtime/webmonitor/history/HistoryServerArchiveFetcher.java", "diffHunk": "@@ -302,18 +289,37 @@ public void run() {\n \n \t\t\tcachedArchives.removeAll(jobsToRemove);\n \t\t\tjobsToRemove.forEach(removedJobID -> {\n-\t\t\t\ttry {\n-\t\t\t\t\tFiles.deleteIfExists(new File(webOverviewDir, removedJobID + JSON_FILE_ENDING).toPath());\n-\t\t\t\t\tFileUtils.deleteDirectory(new File(webJobDir, removedJobID));\n-\t\t\t\t} catch (IOException e) {\n-\t\t\t\t\tLOG.error(\"Failure while removing job overview for job {}.\", removedJobID, e);\n-\t\t\t\t}\n+\t\t\t\tdeleteJobFiles(removedJobID);\n \t\t\t\tdeleteLog.add(new ArchiveEvent(removedJobID, ArchiveEventType.DELETED));\n \t\t\t});\n \n \t\t\treturn deleteLog;\n \t\t}\n \n+\t\tprivate void deleteJobFiles(String jobID) {\n+\t\t\t// Make sure we do not include this job in the overview\n+\t\t\ttry {\n+\t\t\t\tFiles.deleteIfExists(new File(webOverviewDir, jobID + JSON_FILE_ENDING).toPath());\n+\t\t\t} catch (IOException ioe) {\n+\t\t\t\tLOG.warn(\"Could not delete file from overview directory.\", ioe);\n+\t\t\t}\n+\n+\t\t\t// Clean up job files we may have created\n+\t\t\tFile jobDirectory = new File(webJobDir, jobID);\n+\t\t\ttry {\n+\t\t\t\tFileUtils.deleteDirectory(jobDirectory);\n+\t\t\t} catch (IOException ioe) {\n+\t\t\t\tLOG.warn(\"Could not clean up job directory.\", ioe);\n+\t\t\t}\n+\n+\t\t\t// Also clean up job json file in webJobDir\n+\t\t\ttry {\n+\t\t\t\tFiles.deleteIfExists(new File(webJobDir, jobID + JSON_FILE_ENDING).toPath());\n+\t\t\t} catch (IOException ioe) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e40dddf2d2559baabc544e1254b942c853dd595"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3OTg0ODg0", "url": "https://github.com/apache/flink/pull/12560#pullrequestreview-427984884", "createdAt": "2020-06-10T12:06:28Z", "commit": {"oid": "02f47cea448880d6d2f6185c3086158875818adb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMjowNjoyOFrOGhxs0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMjowNjoyOFrOGhxs0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA3MDQ4Mw==", "bodyText": "This test is written more from a user perspective, and as such I'd prefer if we instead check that /job/<jobId>/overview does (not) return a 404, instead of diving into the nitty-gritty details of how the files are stored on disk.", "url": "https://github.com/apache/flink/pull/12560#discussion_r438070483", "createdAt": "2020-06-10T12:06:28Z", "author": {"login": "zentol"}, "path": "flink-runtime-web/src/test/java/org/apache/flink/runtime/webmonitor/history/HistoryServerTest.java", "diffHunk": "@@ -217,11 +219,19 @@ private void runArchiveExpirationTest(boolean cleanupExpiredJobs) throws Excepti\n \t\t\t\t.map(JobID::toString)\n \t\t\t\t.filter(jobId -> jobId.equals(jobIdToDelete))\n \t\t\t\t.count());\n+\t\t\tassertHSFilesExistence(jobIdToDelete, !cleanupExpiredJobs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02f47cea448880d6d2f6185c3086158875818adb"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3OTg3NTQ0", "url": "https://github.com/apache/flink/pull/12560#pullrequestreview-427987544", "createdAt": "2020-06-10T12:10:25Z", "commit": {"oid": "02f47cea448880d6d2f6185c3086158875818adb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMjoxMDoyNVrOGhx0zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMjoxMDoyNVrOGhx0zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA3MjUyNQ==", "bodyText": "This changes the log level, which is a bit annoying for the cleanup if a download fails. In that case it is quite likely that we will try to delete something that was never created; for which we shouldn't be logging a warning.", "url": "https://github.com/apache/flink/pull/12560#discussion_r438072525", "createdAt": "2020-06-10T12:10:25Z", "author": {"login": "zentol"}, "path": "flink-runtime-web/src/main/java/org/apache/flink/runtime/webmonitor/history/HistoryServerArchiveFetcher.java", "diffHunk": "@@ -302,18 +289,37 @@ public void run() {\n \n \t\t\tcachedArchives.removeAll(jobsToRemove);\n \t\t\tjobsToRemove.forEach(removedJobID -> {\n-\t\t\t\ttry {\n-\t\t\t\t\tFiles.deleteIfExists(new File(webOverviewDir, removedJobID + JSON_FILE_ENDING).toPath());\n-\t\t\t\t\tFileUtils.deleteDirectory(new File(webJobDir, removedJobID));\n-\t\t\t\t} catch (IOException e) {\n-\t\t\t\t\tLOG.error(\"Failure while removing job overview for job {}.\", removedJobID, e);\n-\t\t\t\t}\n+\t\t\t\tdeleteJobFiles(removedJobID);\n \t\t\t\tdeleteLog.add(new ArchiveEvent(removedJobID, ArchiveEventType.DELETED));\n \t\t\t});\n \n \t\t\treturn deleteLog;\n \t\t}\n \n+\t\tprivate void deleteJobFiles(String jobID) {\n+\t\t\t// Make sure we do not include this job in the overview\n+\t\t\ttry {\n+\t\t\t\tFiles.deleteIfExists(new File(webOverviewDir, jobID + JSON_FILE_ENDING).toPath());\n+\t\t\t} catch (IOException ioe) {\n+\t\t\t\tLOG.warn(\"Could not delete file from overview directory.\", ioe);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02f47cea448880d6d2f6185c3086158875818adb"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e0e2e644ac40574191fe2fc0ef0da237ba9272f", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/8e0e2e644ac40574191fe2fc0ef0da237ba9272f", "committedDate": "2020-07-07T19:50:12Z", "message": "[FLINK-18097][history] Delete all job-related files on expiration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02f47cea448880d6d2f6185c3086158875818adb", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/02f47cea448880d6d2f6185c3086158875818adb", "committedDate": "2020-06-10T08:01:50Z", "message": "[FLINK-18097][history-server] JSON_FILE_ENDING constant is package private now to be reused in test"}, "afterCommit": {"oid": "8e0e2e644ac40574191fe2fc0ef0da237ba9272f", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/8e0e2e644ac40574191fe2fc0ef0da237ba9272f", "committedDate": "2020-07-07T19:50:12Z", "message": "[FLINK-18097][history] Delete all job-related files on expiration"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3926, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}