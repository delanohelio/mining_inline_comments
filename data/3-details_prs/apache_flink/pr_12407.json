{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1MDM0OTgw", "number": 12407, "title": "[FLINK-17842][network] Remove NextRecordResponse to improve deserialisation performance", "bodyText": "This removes NextRecordResponse and inlines NonSpanningWrapper#getNextRecord to fix second performance regression that happened on May 19th. This second regression is visible as a difference between results from Mat 19th (before regression) and May 22nd - 29th (period after fixing the first performance regression):\nhttp://codespeed.dak8s.net:8000/timeline/?ben=networkBroadcastThroughput&env=2\nIt was introduced by the following commit:\n\n[824100e] [FLINK-17547][task][hotfix] Extract methods from RecordsDeserializer\n\nnetworkBroadcastThroughput benchmark results are restored from ~1000 to ~1100 ops/ms on the Hetzner worker.\nVerifying this change\nChange is covered by existing tests.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-05-29T10:58:33Z", "url": "https://github.com/apache/flink/pull/12407", "merged": true, "mergeCommit": {"oid": "955a6832b9fc3f68c5accef3a22a0b4d45140d68"}, "closed": true, "closedAt": "2020-05-29T14:56:47Z", "author": {"login": "pnowojski"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcmClATAFqTQyMDk1MzU2Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcmCt8kABqjMzODcyNTIxMTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwOTUzNTY3", "url": "https://github.com/apache/flink/pull/12407#pullrequestreview-420953567", "createdAt": "2020-05-29T13:33:19Z", "commit": {"oid": "cc1b0b49d02982ca88dfea41393cbbf34748806b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMzozMzoyMFrOGccyuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMzozMzoyMFrOGccyuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ4NTA0OA==", "bodyText": "nit: leave a comment that this can't be turned into POJO/Tuple because of performance?", "url": "https://github.com/apache/flink/pull/12407#discussion_r432485048", "createdAt": "2020-05-29T13:33:20Z", "author": {"login": "rkhachatryan"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/serialization/SpillingAdaptiveSpanningRecordDeserializer.java", "diffHunk": "@@ -101,11 +99,13 @@ public DeserializationResult getNextRecord(T target) throws IOException {\n \t}\n \n \tprivate DeserializationResult readNonSpanningRecord(T target) throws IOException {\n-\t\tNextRecordResponse response = nonSpanningWrapper.getNextRecord(target);\n-\t\tif (response.result == PARTIAL_RECORD) {\n-\t\t\tspanningWrapper.transferFrom(nonSpanningWrapper, response.bytesLeft);\n+\t\tint recordLen = nonSpanningWrapper.readInt();\n+\t\tif (nonSpanningWrapper.canReadRecord(recordLen)) {\n+\t\t\treturn nonSpanningWrapper.readInto(target);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc1b0b49d02982ca88dfea41393cbbf34748806b"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "695516408f92a0dc4138ff2aa046a72eab78827a", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/695516408f92a0dc4138ff2aa046a72eab78827a", "committedDate": "2020-05-29T13:41:39Z", "message": "[FLINK-17842][network] Remove NextRecordResponse to improve deserialisation performance\n\nThis removes NextRecordResponse and inlines NonSpanningWrapper#getNextRecord to\nfix second performance regression that happened on May 19th. This second regression\nis visible as a difference between results from Mat 19th (before regression)\nand May 22nd - 29th (period after fixing the first performance regression):\n\nhttp://codespeed.dak8s.net:8000/timeline/?ben=networkBroadcastThroughput&env=2\n\nIt was introduced by the following commit:\n[824100e1460dd2f78f689da72bc5d7b0c9dcbbde] [FLINK-17547][task][hotfix] Extract methods from RecordsDeserializer\n\nnetworkBroadcastThroughput benchmark results are restored from ~1000 to ~1100 ops/ms on the Hetzner worker."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc1b0b49d02982ca88dfea41393cbbf34748806b", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/cc1b0b49d02982ca88dfea41393cbbf34748806b", "committedDate": "2020-05-29T10:49:33Z", "message": "[FLINK-17842][network] Remove NextRecordResponse to improve deserialisation performance\n\nThis removes NextRecordResponse and inlines NonSpanningWrapper#getNextRecord to\nfix performance regression introduced by the following commit:\n[824100e1460dd2f78f689da72bc5d7b0c9dcbbde] [FLINK-17547][task][hotfix] Extract methods from RecordsDeserializer"}, "afterCommit": {"oid": "695516408f92a0dc4138ff2aa046a72eab78827a", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/695516408f92a0dc4138ff2aa046a72eab78827a", "committedDate": "2020-05-29T13:41:39Z", "message": "[FLINK-17842][network] Remove NextRecordResponse to improve deserialisation performance\n\nThis removes NextRecordResponse and inlines NonSpanningWrapper#getNextRecord to\nfix second performance regression that happened on May 19th. This second regression\nis visible as a difference between results from Mat 19th (before regression)\nand May 22nd - 29th (period after fixing the first performance regression):\n\nhttp://codespeed.dak8s.net:8000/timeline/?ben=networkBroadcastThroughput&env=2\n\nIt was introduced by the following commit:\n[824100e1460dd2f78f689da72bc5d7b0c9dcbbde] [FLINK-17547][task][hotfix] Extract methods from RecordsDeserializer\n\nnetworkBroadcastThroughput benchmark results are restored from ~1000 to ~1100 ops/ms on the Hetzner worker."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4574, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}