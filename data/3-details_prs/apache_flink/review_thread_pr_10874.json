{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNjgzMTA0", "number": 10874, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMjowMzo0OFrODYsg8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQwNDoxNzowOFrODZBo3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MjIxNzQ0OnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/factories/TableFactoryService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMjowMzo0OFrOFes_eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMjoxMjo1NFrOFetGiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzczODc0NA==", "bodyText": "We can simplify it a bit more:\n\t\t\tClassLoader cl = classLoader.orElse(Thread.currentThread().getContextClassLoader());\n\t\t\tServiceLoader\n\t\t\t\t.load(TableFactory.class, cl)\n\t\t\t\t.iterator()\n\t\t\t\t.forEachRemaining(result::add);", "url": "https://github.com/apache/flink/pull/10874#discussion_r367738744", "createdAt": "2020-01-17T02:03:48Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/factories/TableFactoryService.java", "diffHunk": "@@ -214,7 +213,10 @@\n \t\t\t\t\t.iterator()\n \t\t\t\t\t.forEachRemaining(result::add);\n \t\t\t} else {\n-\t\t\t\tdefaultLoader.iterator().forEachRemaining(result::add);\n+\t\t\t\tServiceLoader\n+\t\t\t\t\t.load(TableFactory.class, Thread.currentThread().getContextClassLoader())\n+\t\t\t\t\t.iterator()\n+\t\t\t\t\t.forEachRemaining(result::add);\n \t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d55a80e9da0760f4a1d39ff60f50ac9cb8e40557"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc0MDU1Mw==", "bodyText": "nice tips", "url": "https://github.com/apache/flink/pull/10874#discussion_r367740553", "createdAt": "2020-01-17T02:12:54Z", "author": {"login": "leonardBang"}, "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/factories/TableFactoryService.java", "diffHunk": "@@ -214,7 +213,10 @@\n \t\t\t\t\t.iterator()\n \t\t\t\t\t.forEachRemaining(result::add);\n \t\t\t} else {\n-\t\t\t\tdefaultLoader.iterator().forEachRemaining(result::add);\n+\t\t\t\tServiceLoader\n+\t\t\t\t\t.load(TableFactory.class, Thread.currentThread().getContextClassLoader())\n+\t\t\t\t\t.iterator()\n+\t\t\t\t\t.forEachRemaining(result::add);\n \t\t\t}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzczODc0NA=="}, "originalCommit": {"oid": "d55a80e9da0760f4a1d39ff60f50ac9cb8e40557"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NTY3ODM4OnYy", "diffSide": "RIGHT", "path": "flink-scala-shell/src/test/scala/org/apache/flink/api/scala/ScalaShellITCase.scala", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQwNDoxNzowOFrOFfNFUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNDozNTowMFrOFgeTSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2NDUzMA==", "bodyText": "This resets classloader after each tests instead of after class. Because TableFactoryService relies to the correct thread context class loader now. Does this make sense to you @twalthr  @aljoscha  ?", "url": "https://github.com/apache/flink/pull/10874#discussion_r368264530", "createdAt": "2020-01-19T04:17:08Z", "author": {"login": "wuchong"}, "path": "flink-scala-shell/src/test/scala/org/apache/flink/api/scala/ScalaShellITCase.scala", "diffHunk": "@@ -43,6 +43,13 @@ class ScalaShellITCase extends TestLogger {\n   @Rule\n   def temporaryFolder = _temporaryFolder\n \n+  @After\n+  def resetClassLoder(): Unit = {\n+    // The Scala interpreter changes current class loader to ScalaClassLoader in every execution\n+    // refer to [[ILoop.process()]]. So, we need reset it to original class loader after every Test.\n+    Thread.currentThread().setContextClassLoader(classOf[ScalaShellITCase].getClassLoader)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0012c39e883a1d1685dd1f09d08d460370b82151"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU1Njc5NQ==", "bodyText": "The basic change makes sense, yes. But why doesn't it work if we only reset it after all tests? Is it because there are multiple tests where the scala shell test uses the table environment?", "url": "https://github.com/apache/flink/pull/10874#discussion_r369556795", "createdAt": "2020-01-22T13:26:21Z", "author": {"login": "aljoscha"}, "path": "flink-scala-shell/src/test/scala/org/apache/flink/api/scala/ScalaShellITCase.scala", "diffHunk": "@@ -43,6 +43,13 @@ class ScalaShellITCase extends TestLogger {\n   @Rule\n   def temporaryFolder = _temporaryFolder\n \n+  @After\n+  def resetClassLoder(): Unit = {\n+    // The Scala interpreter changes current class loader to ScalaClassLoader in every execution\n+    // refer to [[ILoop.process()]]. So, we need reset it to original class loader after every Test.\n+    Thread.currentThread().setContextClassLoader(classOf[ScalaShellITCase].getClassLoader)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2NDUzMA=="}, "originalCommit": {"oid": "0012c39e883a1d1685dd1f09d08d460370b82151"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU5NTIxMQ==", "bodyText": "Yes, there are multiple Table API tests in it.  Because the thread's classloader will be set to ScalaClassLoader in each test, and TableFactoryService can't find the correct factory from ScalaClassLoader, that's why we have to reset thread's classloader after each test.", "url": "https://github.com/apache/flink/pull/10874#discussion_r369595211", "createdAt": "2020-01-22T14:35:00Z", "author": {"login": "wuchong"}, "path": "flink-scala-shell/src/test/scala/org/apache/flink/api/scala/ScalaShellITCase.scala", "diffHunk": "@@ -43,6 +43,13 @@ class ScalaShellITCase extends TestLogger {\n   @Rule\n   def temporaryFolder = _temporaryFolder\n \n+  @After\n+  def resetClassLoder(): Unit = {\n+    // The Scala interpreter changes current class loader to ScalaClassLoader in every execution\n+    // refer to [[ILoop.process()]]. So, we need reset it to original class loader after every Test.\n+    Thread.currentThread().setContextClassLoader(classOf[ScalaShellITCase].getClassLoader)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2NDUzMA=="}, "originalCommit": {"oid": "0012c39e883a1d1685dd1f09d08d460370b82151"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1228, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}