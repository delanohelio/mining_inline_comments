{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NjY3Njc2", "number": 12181, "title": "[FLINK-17645][runtime] Reset SafetyNetCloseableRegistry#REAPER_THREAD if it fails to start", "bodyText": "What is the purpose of the change\nThis Pull Request is to fix the bug that REAPER_THREAD.start() failure in SafetyNetCloseableRegistry lead to the repeated failover, as described in FLINK-17645\nBrief change log\nReset SafetyNetCloseableRegistry#REAPER_THREAD if it fails to start\nVerifying this change\nAdd testReaperThreadStartFailed in SafetyNetCloseableRegistryTest for this case.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency):  no\nThe public API, i.e., is any changed class annotated with @Public(Evolving):  no\nThe serializers:  no\nThe runtime per-record code paths (performance sensitive):  no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature?  no\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-05-15T15:49:31Z", "url": "https://github.com/apache/flink/pull/12181", "merged": true, "mergeCommit": {"oid": "9f3a71183ea4b14a396ecf66e4377da07b06a689"}, "closed": true, "closedAt": "2020-05-21T02:21:33Z", "author": {"login": "wanglijie95"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABciXMJ6AFqTQxMzI0OTIwMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjFTuTABqjMzNTU0NjM1NzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMjQ5MjAw", "url": "https://github.com/apache/flink/pull/12181#pullrequestreview-413249200", "createdAt": "2020-05-18T03:20:36Z", "commit": {"oid": "a7df4077fb5715e0a9ce097b773f49a197eb27dd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMzoyMDozNlrOGWmZMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMzoyMDozNlrOGWmZMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM1MDg5Ng==", "bodyText": "Mockito is not recommended for Flink tests.\nAn alternative is to introduce a new constructor SafetyNetCloseableRegistry(CloseableReaperThread) and a test class which overrides CloseableReaperThread.", "url": "https://github.com/apache/flink/pull/12181#discussion_r426350896", "createdAt": "2020-05-18T03:20:36Z", "author": {"login": "zhuzhurk"}, "path": "flink-core/src/test/java/org/apache/flink/core/fs/SafetyNetCloseableRegistryTest.java", "diffHunk": "@@ -27,18 +27,31 @@\n import org.junit.Rule;\n import org.junit.Test;\n import org.junit.rules.TemporaryFolder;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.powermock.core.classloader.annotations.PrepareForTest;\n+import org.powermock.modules.junit4.PowerMockRunner;\n \n import java.io.Closeable;\n import java.io.IOException;\n import java.util.concurrent.atomic.AtomicInteger;\n \n+import static org.powermock.api.mockito.PowerMockito.doNothing;\n+import static org.powermock.api.mockito.PowerMockito.doThrow;\n+import static org.powermock.api.mockito.PowerMockito.whenNew;\n+\n /**\n  * Tests for the {@link SafetyNetCloseableRegistry}.\n  */\n+@RunWith(PowerMockRunner.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7df4077fb5715e0a9ce097b773f49a197eb27dd"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMjU4MjIz", "url": "https://github.com/apache/flink/pull/12181#pullrequestreview-413258223", "createdAt": "2020-05-18T04:01:32Z", "commit": {"oid": "a7df4077fb5715e0a9ce097b773f49a197eb27dd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwNDowMTozM1rOGWm27g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwNDowMTozM1rOGWm27g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM1ODUxMA==", "bodyText": "I think this line is not needed. It can be tracked via git log.", "url": "https://github.com/apache/flink/pull/12181#discussion_r426358510", "createdAt": "2020-05-18T04:01:33Z", "author": {"login": "zhuzhurk"}, "path": "flink-core/src/test/java/org/apache/flink/core/fs/SafetyNetCloseableRegistryTest.java", "diffHunk": "@@ -198,4 +211,27 @@ public void testReaperThreadSpawnAndStop() throws Exception {\n \t\t}\n \t\tAssert.assertFalse(SafetyNetCloseableRegistry.isReaperThreadRunning());\n \t}\n+\n+\t/**\n+\t * Test for FLINK-17645.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7df4077fb5715e0a9ce097b773f49a197eb27dd"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MDc4NzIw", "url": "https://github.com/apache/flink/pull/12181#pullrequestreview-414078720", "createdAt": "2020-05-19T03:35:59Z", "commit": {"oid": "757a2307f027acba2aca26f7f5ec6f9639ce9079"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMzozNTo1OVrOGXOrbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMzozNTo1OVrOGXOrbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAxMDkyNQ==", "bodyText": "We should avoid duplicating the codes.\nBelow is a possible way to make it.\n\tSafetyNetCloseableRegistry() {\n\t\tthis(() -> new CloseableReaperThread());\n\t}\n\n\t@VisibleForTesting\n\tSafetyNetCloseableRegistry(Supplier<CloseableReaperThread> reaperThreadSupplier) {\n\t\tsuper(new IdentityHashMap<>());\n\n\t\tsynchronized (REAPER_THREAD_LOCK) {\n\t\t\tif (0 == GLOBAL_SAFETY_NET_REGISTRY_COUNT) {\n\t\t\t\tPreconditions.checkState(null == REAPER_THREAD);\n\t\t\t\ttry {\n\t\t\t\t\tREAPER_THREAD = reaperThreadSupplier.get();\n\t\t\t\t\tREAPER_THREAD.start();\n\t\t\t\t} catch (Throwable throwable) {\n\t\t\t\t\tREAPER_THREAD = null;\n\t\t\t\t\tthrow throwable;\n\t\t\t\t}\n\t\t\t}\n\t\t\t++GLOBAL_SAFETY_NET_REGISTRY_COUNT;\n\t\t}\n\t}", "url": "https://github.com/apache/flink/pull/12181#discussion_r427010925", "createdAt": "2020-05-19T03:35:59Z", "author": {"login": "zhuzhurk"}, "path": "flink-core/src/main/java/org/apache/flink/core/fs/SafetyNetCloseableRegistry.java", "diffHunk": "@@ -73,8 +73,34 @@\n \t\tsynchronized (REAPER_THREAD_LOCK) {\n \t\t\tif (0 == GLOBAL_SAFETY_NET_REGISTRY_COUNT) {\n \t\t\t\tPreconditions.checkState(null == REAPER_THREAD);\n-\t\t\t\tREAPER_THREAD = new CloseableReaperThread();\n-\t\t\t\tREAPER_THREAD.start();\n+\t\t\t\ttry {\n+\t\t\t\t\tREAPER_THREAD = new CloseableReaperThread();\n+\t\t\t\t\tREAPER_THREAD.start();\n+\t\t\t\t} catch (Throwable throwable) {\n+\t\t\t\t\t// thread create or start error.\n+\t\t\t\t\tREAPER_THREAD = null;\n+\t\t\t\t\tthrow throwable;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\t++GLOBAL_SAFETY_NET_REGISTRY_COUNT;\n+\t\t}\n+\t}\n+\n+\t@VisibleForTesting\n+\tSafetyNetCloseableRegistry(CloseableReaperThread reaperThread) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "757a2307f027acba2aca26f7f5ec6f9639ce9079"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MDgwOTQ0", "url": "https://github.com/apache/flink/pull/12181#pullrequestreview-414080944", "createdAt": "2020-05-19T03:43:13Z", "commit": {"oid": "757a2307f027acba2aca26f7f5ec6f9639ce9079"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMzo0MzoxM1rOGXOzVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMzo0MzoxM1rOGXOzVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAxMjk0OA==", "bodyText": "Why adding a new constructor here?\nIf you are blocked by the existing private constructor, you can just change it to protected.", "url": "https://github.com/apache/flink/pull/12181#discussion_r427012948", "createdAt": "2020-05-19T03:43:13Z", "author": {"login": "zhuzhurk"}, "path": "flink-core/src/main/java/org/apache/flink/core/fs/SafetyNetCloseableRegistry.java", "diffHunk": "@@ -186,6 +212,15 @@ private CloseableReaperThread() {\n \t\t\tthis.running = true;\n \t\t}\n \n+\t\t@VisibleForTesting\n+\t\tCloseableReaperThread(String name) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "757a2307f027acba2aca26f7f5ec6f9639ce9079"}, "originalPosition": 51}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19e8cc19c44ba362eb08afda0ebdb092af5b0ac3", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/19e8cc19c44ba362eb08afda0ebdb092af5b0ac3", "committedDate": "2020-05-19T09:22:54Z", "message": "Rebase master"}, "afterCommit": {"oid": "37dbf5a71db743b3aaef83538be71bc5bd1a7415", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/37dbf5a71db743b3aaef83538be71bc5bd1a7415", "committedDate": "2020-05-19T09:18:26Z", "message": "Fix comment."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "37dbf5a71db743b3aaef83538be71bc5bd1a7415", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/37dbf5a71db743b3aaef83538be71bc5bd1a7415", "committedDate": "2020-05-19T09:18:26Z", "message": "Fix comment."}, "afterCommit": {"oid": "0bf2aa2f54e22e76fed071e3c614139d4d187fc4", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/0bf2aa2f54e22e76fed071e3c614139d4d187fc4", "committedDate": "2020-05-19T13:26:30Z", "message": "Fix comment."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0bf2aa2f54e22e76fed071e3c614139d4d187fc4", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/0bf2aa2f54e22e76fed071e3c614139d4d187fc4", "committedDate": "2020-05-19T13:26:30Z", "message": "Fix comment."}, "afterCommit": {"oid": "bd9add8e480455265ca95b863601f6608918b334", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/bd9add8e480455265ca95b863601f6608918b334", "committedDate": "2020-05-20T04:23:18Z", "message": "Fix comment."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1MDU1NTcx", "url": "https://github.com/apache/flink/pull/12181#pullrequestreview-415055571", "createdAt": "2020-05-20T07:20:13Z", "commit": {"oid": "bd9add8e480455265ca95b863601f6608918b334"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNzoyMDoxM1rOGX-YOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNzoyMDoxM1rOGX-YOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc5MjQ0MA==", "bodyText": "can be private", "url": "https://github.com/apache/flink/pull/12181#discussion_r427792440", "createdAt": "2020-05-20T07:20:13Z", "author": {"login": "zhuzhurk"}, "path": "flink-core/src/test/java/org/apache/flink/core/fs/SafetyNetCloseableRegistryTest.java", "diffHunk": "@@ -198,4 +198,29 @@ public void testReaperThreadSpawnAndStop() throws Exception {\n \t\t}\n \t\tAssert.assertFalse(SafetyNetCloseableRegistry.isReaperThreadRunning());\n \t}\n+\n+\t/**\n+\t * Test whether failure to start thread in {@link SafetyNetCloseableRegistry}\n+\t * constructor can lead to failure of subsequent state check.\n+\t */\n+\t@Test\n+\tpublic void testReaperThreadStartFailed() throws Exception {\n+\n+\t\ttry {\n+\t\t\tnew SafetyNetCloseableRegistry(() -> new OutOfMemoryReaperThread());\n+\t\t} catch (java.lang.OutOfMemoryError error) {\n+\t\t}\n+\n+\t\t// the OOM error will not lead to failure of subsequent constructor call.\n+\t\tSafetyNetCloseableRegistry closeableRegistry = new SafetyNetCloseableRegistry();\n+\t\tcloseableRegistry.close();\n+\t}\n+\n+\tstatic class OutOfMemoryReaperThread extends SafetyNetCloseableRegistry.CloseableReaperThread {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd9add8e480455265ca95b863601f6608918b334"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1MDU4MDYz", "url": "https://github.com/apache/flink/pull/12181#pullrequestreview-415058063", "createdAt": "2020-05-20T07:24:00Z", "commit": {"oid": "bd9add8e480455265ca95b863601f6608918b334"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNzoyNDowMFrOGX-fow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNzoyNDowMFrOGX-fow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc5NDMzOQ==", "bodyText": "We can add isReaperThreadRunning checks after the failed creation and the succeeded creation.\nThis helps to verify that a reaper thread is really created and running.", "url": "https://github.com/apache/flink/pull/12181#discussion_r427794339", "createdAt": "2020-05-20T07:24:00Z", "author": {"login": "zhuzhurk"}, "path": "flink-core/src/test/java/org/apache/flink/core/fs/SafetyNetCloseableRegistryTest.java", "diffHunk": "@@ -198,4 +198,29 @@ public void testReaperThreadSpawnAndStop() throws Exception {\n \t\t}\n \t\tAssert.assertFalse(SafetyNetCloseableRegistry.isReaperThreadRunning());\n \t}\n+\n+\t/**\n+\t * Test whether failure to start thread in {@link SafetyNetCloseableRegistry}\n+\t * constructor can lead to failure of subsequent state check.\n+\t */\n+\t@Test\n+\tpublic void testReaperThreadStartFailed() throws Exception {\n+\n+\t\ttry {\n+\t\t\tnew SafetyNetCloseableRegistry(() -> new OutOfMemoryReaperThread());\n+\t\t} catch (java.lang.OutOfMemoryError error) {\n+\t\t}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd9add8e480455265ca95b863601f6608918b334"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1MTI1NDQ0", "url": "https://github.com/apache/flink/pull/12181#pullrequestreview-415125444", "createdAt": "2020-05-20T08:53:05Z", "commit": {"oid": "05e0b2b0379e0b05c62631147b82711c32f11fcb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbefe16eb3f7769b6daf6cfe1fa26b7a0f7130a8", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/fbefe16eb3f7769b6daf6cfe1fa26b7a0f7130a8", "committedDate": "2020-05-20T09:02:37Z", "message": "[FLINK-17645][runtime] Reset SafetyNetCloseableRegistry#REAPER_THREAD if it fails to start"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "05e0b2b0379e0b05c62631147b82711c32f11fcb", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/05e0b2b0379e0b05c62631147b82711c32f11fcb", "committedDate": "2020-05-20T08:28:55Z", "message": "Fix comment."}, "afterCommit": {"oid": "fbefe16eb3f7769b6daf6cfe1fa26b7a0f7130a8", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/fbefe16eb3f7769b6daf6cfe1fa26b7a0f7130a8", "committedDate": "2020-05-20T09:02:37Z", "message": "[FLINK-17645][runtime] Reset SafetyNetCloseableRegistry#REAPER_THREAD if it fails to start"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4093, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}