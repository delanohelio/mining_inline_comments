{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MDQ5Mzg5", "number": 11524, "title": "[FLINK-16803][hive] Need to make sure partition inherit table spec wh\u2026", "bodyText": "\u2026en writing to Hive tables\n\nWhat is the purpose of the change\nWhen inserting to a partition, Hive will update the partition's SD according to table SD. For example, consider the following use case:\ncreate table foo (x int,y int) partitioned by (p string);\ninsert overwrite table foo partition (p='1') select * from ...;\nalter table foo set fileformat rcfile;\ninsert overwrite table foo partition (p='1') select * from ...;\n\nThe second INSERT will write RC files to the partition and therefore the partition SD needs to be updated to use RC file input format. Otherwise we hit exception when reading from this partition.\nBrief change log\n\nAdd new interface to alter partition in TableMetaStore.\nAlter existing partition in PartitionLoader.\nAdd test case.\n\nVerifying this change\nExisting and added test cases.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\nNA", "createdAt": "2020-03-26T09:23:31Z", "url": "https://github.com/apache/flink/pull/11524", "merged": true, "mergeCommit": {"oid": "5d9e5d46b37bb6e72e7c130323fa84518f691fbb"}, "closed": true, "closedAt": "2020-04-13T05:14:36Z", "author": {"login": "lirui-apache"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRosf0ABqjMxNzA4OTc0NDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXH1C-gFqTM5MTk2MDkxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "985fa46da9bba98a0ddd34788edc34a404be321f", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/985fa46da9bba98a0ddd34788edc34a404be321f", "committedDate": "2020-03-26T09:19:45Z", "message": "[FLINK-16803][hive] Need to make sure partition inherit table spec when writing to Hive tables"}, "afterCommit": {"oid": "0430a4524f511b4d070cd79666f0fb58d26eb981", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/0430a4524f511b4d070cd79666f0fb58d26eb981", "committedDate": "2020-03-27T04:07:25Z", "message": "checkstyle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0430a4524f511b4d070cd79666f0fb58d26eb981", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/0430a4524f511b4d070cd79666f0fb58d26eb981", "committedDate": "2020-03-27T04:07:25Z", "message": "checkstyle"}, "afterCommit": {"oid": "b9207cac2383c334d16ab33f517f8b23984081f8", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/b9207cac2383c334d16ab33f517f8b23984081f8", "committedDate": "2020-04-01T08:48:32Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1Mzk2MTI0", "url": "https://github.com/apache/flink/pull/11524#pullrequestreview-385396124", "createdAt": "2020-04-01T09:06:02Z", "commit": {"oid": "b9207cac2383c334d16ab33f517f8b23984081f8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOTowNjowMlrOF-3a5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOTowNjowMlrOF-3a5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ2NDAzOA==", "bodyText": "Can we introduce a createOrAlterPartition?", "url": "https://github.com/apache/flink/pull/11524#discussion_r401464038", "createdAt": "2020-04-01T09:06:02Z", "author": {"login": "JingsongLi"}, "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/TableMetaStoreFactory.java", "diffHunk": "@@ -68,5 +68,14 @@\n \t\t * @param partitionPath partition location path.\n \t\t */\n \t\tvoid createPartition(LinkedHashMap<String, String> partitionSpec, Path partitionPath) throws Exception;\n+\n+\t\t/**\n+\t\t * When inserting to an existing partition, the existing partition may need to be updated.\n+\t\t *\n+\t\t * @param partitionSpec the full spec of the target partition\n+\t\t * @param partitionPath partition location path\n+\t\t */\n+\t\tdefault void alterPartition(LinkedHashMap<String, String> partitionSpec, Path partitionPath) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9207cac2383c334d16ab33f517f8b23984081f8"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1Mzk3MTIx", "url": "https://github.com/apache/flink/pull/11524#pullrequestreview-385397121", "createdAt": "2020-04-01T09:07:20Z", "commit": {"oid": "b9207cac2383c334d16ab33f517f8b23984081f8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOTowNzoyMFrOF-3d6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOTowNzoyMFrOF-3d6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ2NDgxMQ==", "bodyText": "Can we use the copy of thrift object?", "url": "https://github.com/apache/flink/pull/11524#discussion_r401464811", "createdAt": "2020-04-01T09:07:20Z", "author": {"login": "JingsongLi"}, "path": "flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/connectors/hive/HiveTableMetaStoreFactory.java", "diffHunk": "@@ -105,6 +105,22 @@ public void createPartition(LinkedHashMap<String, String> partSpec, Path path) t\n \t\t\tclient.add_partition(partition);\n \t\t}\n \n+\t\t@Override\n+\t\tpublic void alterPartition(LinkedHashMap<String, String> partitionSpec, Path partitionPath) throws Exception {\n+\t\t\tPartition partition = client.getPartition(database, tableName, new ArrayList<>(partitionSpec.values()));\n+\t\t\tStorageDescriptor partSD = partition.getSd();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9207cac2383c334d16ab33f517f8b23984081f8"}, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b9207cac2383c334d16ab33f517f8b23984081f8", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/b9207cac2383c334d16ab33f517f8b23984081f8", "committedDate": "2020-04-01T08:48:32Z", "message": "checkstyle"}, "afterCommit": {"oid": "688fd0fb4f56559521f7d0319d344f5d1f6c9555", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/688fd0fb4f56559521f7d0319d344f5d1f6c9555", "committedDate": "2020-04-01T12:55:16Z", "message": "address comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1a4ee9b7cfba86c6e2d44ce38759b839159865d", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/c1a4ee9b7cfba86c6e2d44ce38759b839159865d", "committedDate": "2020-04-10T10:17:56Z", "message": "[FLINK-16803][hive] Need to make sure partition inherit table spec when writing to Hive tables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89a3fe3e1e7205cc440c28493eb79352d07f623d", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/89a3fe3e1e7205cc440c28493eb79352d07f623d", "committedDate": "2020-04-10T10:17:56Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e09d7f4b31f9051294c5e9231477f7da637144c", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/5e09d7f4b31f9051294c5e9231477f7da637144c", "committedDate": "2020-04-10T10:17:56Z", "message": "address comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "688fd0fb4f56559521f7d0319d344f5d1f6c9555", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/688fd0fb4f56559521f7d0319d344f5d1f6c9555", "committedDate": "2020-04-01T12:55:16Z", "message": "address comment"}, "afterCommit": {"oid": "5e09d7f4b31f9051294c5e9231477f7da637144c", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/5e09d7f4b31f9051294c5e9231477f7da637144c", "committedDate": "2020-04-10T10:17:56Z", "message": "address comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f33c1297548afd19f532b4eee941c3c89e31f513", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/f33c1297548afd19f532b4eee941c3c89e31f513", "committedDate": "2020-04-10T11:14:39Z", "message": "fix compile"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxOTYwOTEz", "url": "https://github.com/apache/flink/pull/11524#pullrequestreview-391960913", "createdAt": "2020-04-13T05:13:37Z", "commit": {"oid": "f33c1297548afd19f532b4eee941c3c89e31f513"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2569, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}