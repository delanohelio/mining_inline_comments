{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3NTE4MDk1", "number": 11619, "title": "[FLINK-16921][e2e] Make Kubernetes e2e test stable", "bodyText": "What is the purpose of the change\nUse the following optimization to make this K8s e2e test more stable both in azure/travis and local.\n\nRemove start/stop code for non-linux environment, let the user manually start/stop minikube. Since we will encounter various problem in local environment(e.g. Mac), including disk problem, network problem, docker daemon, driver setup(virtualbox, etc.).\nPrint more debug information so that when the test failed it is easier to investigate\nExplicitly wait for the dispatcher running and then submit the job to the existing cluster\n\nBrief change log\n\nDo not start/stop minikube in non-linux environment for k8s e2e tests\nPrint more information for debugging when Kubernetes e2e tests failed\nWait for rest endpoint up and then submit Flink job to existing Kubernetes session\n\nVerifying this change\n\nRun in local environment(Mac) more than 10 times, all should pass\nRun in azure more that 3 times, all should pass\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (no)\nThe serializers: (no)\nThe runtime per-record code paths (performance sensitive): (no)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (no)\nThe S3 file system connector: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (no)\nIf yes, how is the feature documented? (not applicable)", "createdAt": "2020-04-02T11:26:12Z", "url": "https://github.com/apache/flink/pull/11619", "merged": true, "mergeCommit": {"oid": "0d20a6d5b7dc4c2ea0567981ed8b08d278763d00"}, "closed": true, "closedAt": "2020-04-03T08:35:10Z", "author": {"login": "wangyang0918"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTpixiAH2gAyMzk3NTE4MDk1OmY5YWVjZGUyYzE4ZjkyMmU0NzdkZjhmZTM5OWMyZDI3Yzk3M2JhZmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcT4Qk7ABqjMxOTQ2ODg2NTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f9aecde2c18f922e477df8fe399c2d27c973bafa", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/f9aecde2c18f922e477df8fe399c2d27c973bafa", "committedDate": "2020-04-02T10:14:44Z", "message": "[FLINK-16921][e2e] Do not start/stop minikube in non-linux environment for k8s e2e tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MzYwMTQ3", "url": "https://github.com/apache/flink/pull/11619#pullrequestreview-386360147", "createdAt": "2020-04-02T12:06:46Z", "commit": {"oid": "68c82eef3469c403b1a0f8a64c13f04d989bf145"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxMjowNjo0NlrOF_oFdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxMjowNjo0NlrOF_oFdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2MTM2Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                echo \"Currently exiting Kubernetes resources\"\n          \n          \n            \n                echo \"Currently existing Kubernetes resources\"", "url": "https://github.com/apache/flink/pull/11619#discussion_r402261366", "createdAt": "2020-04-02T12:06:46Z", "author": {"login": "rmetzger"}, "path": "flink-end-to-end-tests/test-scripts/common_kubernetes.sh", "diffHunk": "@@ -88,22 +86,43 @@ function start_kubernetes_if_not_running {\n }\n \n function start_kubernetes {\n-    [[ \"${OS_TYPE}\" = \"linux\" ]] && setup_kubernetes_for_linux\n-    if ! retry_times ${MINIKUBE_START_RETRIES} ${MINIKUBE_START_BACKOFF} start_kubernetes_if_not_running; then\n-        echo \"Could not start minikube. Aborting...\"\n-        exit 1\n+    if [[ \"${OS_TYPE}\" != \"linux\" ]]; then\n+        if ! check_kubernetes_status; then\n+            echo \"$NON_LINUX_ENV_NOTE\"\n+            exit 1\n+        fi\n+    else\n+        setup_kubernetes_for_linux\n+        if ! retry_times ${MINIKUBE_START_RETRIES} ${MINIKUBE_START_BACKOFF} start_kubernetes_if_not_running; then\n+            echo \"Could not start minikube. Aborting...\"\n+            exit 1\n+        fi\n     fi\n     eval $(minikube docker-env)\n }\n \n function stop_kubernetes {\n-    echo \"Stopping minikube ...\"\n-    stop_command=\"minikube stop\"\n-    [[ \"${OS_TYPE}\" = \"linux\" ]] && stop_command=\"sudo ${stop_command}\"\n-    if ! retry_times ${MINIKUBE_START_RETRIES} ${MINIKUBE_START_BACKOFF} \"${stop_command}\"; then\n-        echo \"Could not stop minikube. Aborting...\"\n-        exit 1\n+    if [[ \"${OS_TYPE}\" != \"linux\" ]]; then\n+        echo \"$NON_LINUX_ENV_NOTE\"\n+    else\n+        echo \"Stopping minikube ...\"\n+        stop_command=\"sudo minikube stop\"\n+        if ! retry_times ${MINIKUBE_START_RETRIES} ${MINIKUBE_START_BACKOFF} \"${stop_command}\"; then\n+            echo \"Could not stop minikube. Aborting...\"\n+            exit 1\n+        fi\n     fi\n }\n \n+function debug_copy_and_show_logs {\n+    echo \"Debugging failed Kubernetes test:\"\n+    echo \"Currently exiting Kubernetes resources\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68c82eef3469c403b1a0f8a64c13f04d989bf145"}, "originalPosition": 108}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MzYzMzY5", "url": "https://github.com/apache/flink/pull/11619#pullrequestreview-386363369", "createdAt": "2020-04-02T12:11:29Z", "commit": {"oid": "68c82eef3469c403b1a0f8a64c13f04d989bf145"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3747069ee6d5365440d04ec2bf521540877065e0", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/3747069ee6d5365440d04ec2bf521540877065e0", "committedDate": "2020-04-03T03:23:15Z", "message": "[FLINK-16921][e2e] Print more information for debugging when Kubernetes e2e tests failed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bd37e40b9333d646bbf1bb1fbe286ad21d1e709", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/6bd37e40b9333d646bbf1bb1fbe286ad21d1e709", "committedDate": "2020-04-03T03:23:15Z", "message": "[FLINK-16921][e2e] Wait for rest endpoint up and then submit Flink job to existing Kubernetes session"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "482d537e3c57570c106ebc30a23525aa8e63bef9", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/482d537e3c57570c106ebc30a23525aa8e63bef9", "committedDate": "2020-04-03T03:22:33Z", "message": "fixup! [FLINK-16921][e2e] Print more information for debugging when Kubernetes e2e tests failed"}, "afterCommit": {"oid": "6bd37e40b9333d646bbf1bb1fbe286ad21d1e709", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/6bd37e40b9333d646bbf1bb1fbe286ad21d1e709", "committedDate": "2020-04-03T03:23:15Z", "message": "[FLINK-16921][e2e] Wait for rest endpoint up and then submit Flink job to existing Kubernetes session"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2269, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}