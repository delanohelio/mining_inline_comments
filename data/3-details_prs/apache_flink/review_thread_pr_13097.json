{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MjQ5ODI3", "number": 13097, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNjozNzozM1rOEWq81Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODoyNjo1N1rOEWsyVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMjA3ODI5OnYy", "diffSide": "RIGHT", "path": "flink-python/src/main/java/org/apache/flink/datastream/runtime/functions/python/PickledKeySelector.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNjozNzozM1rOG-Cz9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNjozNzozM1rOG-Cz9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxMDk2NQ==", "bodyText": "The key can be other types if key_by with type information. For example, ds.key_by(MyKeySelector(), Types.INT())", "url": "https://github.com/apache/flink/pull/13097#discussion_r467710965", "createdAt": "2020-08-10T06:37:33Z", "author": {"login": "hequn8128"}, "path": "flink-python/src/main/java/org/apache/flink/datastream/runtime/functions/python/PickledKeySelector.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.datastream.runtime.functions.python;\n+\n+import org.apache.flink.api.java.functions.KeySelector;\n+import org.apache.flink.types.Row;\n+\n+import net.razorvine.pickle.Unpickler;\n+\n+/**\n+ * PickledKeySelector is responsible for extracting the first filed of the input row as key.\n+ * The input row is generated by python DataStream map function in the format of (key_selector.get_key(value), value)\n+ * tuple2.\n+ */\n+public class PickledKeySelector implements KeySelector<Row, Object> {\n+\n+\tprivate Unpickler unpickler = null;\n+\n+\t@Override\n+\tpublic Object getKey(Row value) throws Exception {\n+\n+\t\tif (this.unpickler == null) {\n+\t\t\tunpickler = new Unpickler();\n+\t\t}\n+\n+\t\tObject key = value.getField(0);\n+\t\tif (key instanceof byte[]) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52e8670eef5651d09ad0defeb1a8729aa7c589ba"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMjA4Nzk0OnYy", "diffSide": "RIGHT", "path": "flink-python/src/main/java/org/apache/flink/datastream/runtime/functions/python/PickledKeySelector.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNjo0MTo1OFrOG-C5kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNjo0MTo1OFrOG-C5kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxMjQwMA==", "bodyText": "Use java annotation to describe Java class(e.g., PickledKeySelector, DataStream).", "url": "https://github.com/apache/flink/pull/13097#discussion_r467712400", "createdAt": "2020-08-10T06:41:58Z", "author": {"login": "hequn8128"}, "path": "flink-python/src/main/java/org/apache/flink/datastream/runtime/functions/python/PickledKeySelector.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.datastream.runtime.functions.python;\n+\n+import org.apache.flink.api.java.functions.KeySelector;\n+import org.apache.flink.types.Row;\n+\n+import net.razorvine.pickle.Unpickler;\n+\n+/**\n+ * PickledKeySelector is responsible for extracting the first filed of the input row as key.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52e8670eef5651d09ad0defeb1a8729aa7c589ba"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMjA5ODI5OnYy", "diffSide": "RIGHT", "path": "flink-python/pyflink/datastream/data_stream.py", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNjo0Njo0OFrOG-C_WQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNjo0Njo0OFrOG-C_WQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxMzg4MQ==", "bodyText": ".keyBy(PickledKeySelector(), key_type_info)", "url": "https://github.com/apache/flink/pull/13097#discussion_r467713881", "createdAt": "2020-08-10T06:46:48Z", "author": {"login": "hequn8128"}, "path": "flink-python/pyflink/datastream/data_stream.py", "diffHunk": "@@ -233,6 +234,54 @@ def flat_map(self, func: Union[Callable, FlatMapFunction], type_info: TypeInform\n             j_python_data_stream_scalar_function_operator\n         ))\n \n+    def key_by(self, key_selector: Union[Callable, KeySelector],\n+               key_type_info: TypeInformation = None) -> 'KeyedStream':\n+        \"\"\"\n+        Creates a new KeyedStream that uses the provided key for partitioning its operator states.\n+\n+        :param key_selector: The KeySelector to be used for extracting the key for partitioning.\n+        :param key_type_info: The type information describing the key type.\n+        :return: The DataStream with partitioned state(i.e. KeyedStream).\n+        \"\"\"\n+        if callable(key_selector):\n+            key_selector = KeySelectorFunctionWrapper(key_selector)\n+        if not isinstance(key_selector, (KeySelector, KeySelectorFunctionWrapper)):\n+            raise TypeError(\"Parameter key_selector should be a type of KeySelector.\")\n+\n+        gateway = get_gateway()\n+        PickledKeySelector = gateway.jvm \\\n+            .org.apache.flink.datastream.runtime.functions.python.PickledKeySelector\n+        j_output_type_info = self._j_data_stream.getTransformation().getOutputType()\n+        output_type_info = typeinfo._from_java_type(j_output_type_info)\n+        if key_type_info is None:\n+            key_type_info = Types.PICKLED_BYTE_ARRAY()\n+        generated_key_stream = KeyedStream(self.map(lambda x: (key_selector.get_key(x), x),\n+                                                    type_info=Types.ROW([key_type_info,\n+                                                                         output_type_info]))\n+                                           ._j_data_stream\n+                                           .keyBy(PickledKeySelector()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52e8670eef5651d09ad0defeb1a8729aa7c589ba"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMjEwMzk1OnYy", "diffSide": "RIGHT", "path": "flink-python/pyflink/datastream/data_stream.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNjo0OToyOFrOG-DCkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODoyODoyNlrOG-Fj5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxNDcwNA==", "bodyText": "The method has never been used.", "url": "https://github.com/apache/flink/pull/13097#discussion_r467714704", "createdAt": "2020-08-10T06:49:28Z", "author": {"login": "hequn8128"}, "path": "flink-python/pyflink/datastream/data_stream.py", "diffHunk": "@@ -233,6 +234,54 @@ def flat_map(self, func: Union[Callable, FlatMapFunction], type_info: TypeInform\n             j_python_data_stream_scalar_function_operator\n         ))\n \n+    def key_by(self, key_selector: Union[Callable, KeySelector],\n+               key_type_info: TypeInformation = None) -> 'KeyedStream':\n+        \"\"\"\n+        Creates a new KeyedStream that uses the provided key for partitioning its operator states.\n+\n+        :param key_selector: The KeySelector to be used for extracting the key for partitioning.\n+        :param key_type_info: The type information describing the key type.\n+        :return: The DataStream with partitioned state(i.e. KeyedStream).\n+        \"\"\"\n+        if callable(key_selector):\n+            key_selector = KeySelectorFunctionWrapper(key_selector)\n+        if not isinstance(key_selector, (KeySelector, KeySelectorFunctionWrapper)):\n+            raise TypeError(\"Parameter key_selector should be a type of KeySelector.\")\n+\n+        gateway = get_gateway()\n+        PickledKeySelector = gateway.jvm \\\n+            .org.apache.flink.datastream.runtime.functions.python.PickledKeySelector\n+        j_output_type_info = self._j_data_stream.getTransformation().getOutputType()\n+        output_type_info = typeinfo._from_java_type(j_output_type_info)\n+        if key_type_info is None:\n+            key_type_info = Types.PICKLED_BYTE_ARRAY()\n+        generated_key_stream = KeyedStream(self.map(lambda x: (key_selector.get_key(x), x),\n+                                                    type_info=Types.ROW([key_type_info,\n+                                                                         output_type_info]))\n+                                           ._j_data_stream\n+                                           .keyBy(PickledKeySelector()))\n+        generated_key_stream._original_data_type_info = output_type_info\n+        return generated_key_stream\n+\n+    def _align_output_type(self) -> 'DataStream':", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52e8670eef5651d09ad0defeb1a8729aa7c589ba"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1NjAwNQ==", "bodyText": "Ok, I will remove it in this pr.", "url": "https://github.com/apache/flink/pull/13097#discussion_r467756005", "createdAt": "2020-08-10T08:28:26Z", "author": {"login": "shuiqiangchen"}, "path": "flink-python/pyflink/datastream/data_stream.py", "diffHunk": "@@ -233,6 +234,54 @@ def flat_map(self, func: Union[Callable, FlatMapFunction], type_info: TypeInform\n             j_python_data_stream_scalar_function_operator\n         ))\n \n+    def key_by(self, key_selector: Union[Callable, KeySelector],\n+               key_type_info: TypeInformation = None) -> 'KeyedStream':\n+        \"\"\"\n+        Creates a new KeyedStream that uses the provided key for partitioning its operator states.\n+\n+        :param key_selector: The KeySelector to be used for extracting the key for partitioning.\n+        :param key_type_info: The type information describing the key type.\n+        :return: The DataStream with partitioned state(i.e. KeyedStream).\n+        \"\"\"\n+        if callable(key_selector):\n+            key_selector = KeySelectorFunctionWrapper(key_selector)\n+        if not isinstance(key_selector, (KeySelector, KeySelectorFunctionWrapper)):\n+            raise TypeError(\"Parameter key_selector should be a type of KeySelector.\")\n+\n+        gateway = get_gateway()\n+        PickledKeySelector = gateway.jvm \\\n+            .org.apache.flink.datastream.runtime.functions.python.PickledKeySelector\n+        j_output_type_info = self._j_data_stream.getTransformation().getOutputType()\n+        output_type_info = typeinfo._from_java_type(j_output_type_info)\n+        if key_type_info is None:\n+            key_type_info = Types.PICKLED_BYTE_ARRAY()\n+        generated_key_stream = KeyedStream(self.map(lambda x: (key_selector.get_key(x), x),\n+                                                    type_info=Types.ROW([key_type_info,\n+                                                                         output_type_info]))\n+                                           ._j_data_stream\n+                                           .keyBy(PickledKeySelector()))\n+        generated_key_stream._original_data_type_info = output_type_info\n+        return generated_key_stream\n+\n+    def _align_output_type(self) -> 'DataStream':", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxNDcwNA=="}, "originalCommit": {"oid": "52e8670eef5651d09ad0defeb1a8729aa7c589ba"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMjEyMjY1OnYy", "diffSide": "RIGHT", "path": "flink-python/pyflink/datastream/data_stream.py", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNjo1NzozNVrOG-DNRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNjo1NzozNVrOG-DNRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxNzQ0NQ==", "bodyText": "Throw exception when perform set_parallelism, name, uid, etc.", "url": "https://github.com/apache/flink/pull/13097#discussion_r467717445", "createdAt": "2020-08-10T06:57:35Z", "author": {"login": "hequn8128"}, "path": "flink-python/pyflink/datastream/data_stream.py", "diffHunk": "@@ -290,3 +339,39 @@ def _get_java_python_function_operator(self, func: Union[Function, FunctionWrapp\n             output_type_info.get_java_type_info(),\n             j_python_data_stream_function_info)\n         return j_python_data_stream_scalar_function_operator, output_type_info\n+\n+\n+class KeyedStream(DataStream):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52e8670eef5651d09ad0defeb1a8729aa7c589ba"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMjEzNjkwOnYy", "diffSide": "RIGHT", "path": "flink-python/pyflink/datastream/tests/test_data_stream.py", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNzowMzozN1rOG-DVlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODoyODozOFrOG-FkRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxOTU3NQ==", "bodyText": "The two tests are duplicated?", "url": "https://github.com/apache/flink/pull/13097#discussion_r467719575", "createdAt": "2020-08-10T07:03:37Z", "author": {"login": "hequn8128"}, "path": "flink-python/pyflink/datastream/tests/test_data_stream.py", "diffHunk": "@@ -140,15 +135,68 @@ def flat_map(value):\n \n         flat_mapped_stream = ds.flat_map(flat_map, type_info=Types.ROW([Types.STRING(),\n                                                                         Types.INT()]))\n-        collect_util = DataStreamCollectUtil()\n-        collect_util.collect(flat_mapped_stream)\n+        self.collect_util.collect(flat_mapped_stream)\n         self.env.execute('flat_map_test')\n-        results = collect_util.results()\n+        results = self.collect_util.results()\n         expected = ['a,0', 'bdc,2', 'deeefg,4']\n         results.sort()\n         expected.sort()\n         self.assertEqual(expected, results)\n \n+    def test_key_by(self):\n+        element_collection = [('a', 0), ('b', 0), ('c', 1), ('d', 1), ('e', 2)]\n+        self.env.set_parallelism(1)\n+        ds = self.env.from_collection(element_collection,\n+                                      type_info=Types.ROW([Types.STRING(), Types.INT()]))\n+\n+        class AssertKeyMapFunction(MapFunction):\n+            def __init__(self):\n+                self.pre = None\n+\n+            def map(self, value):\n+                if value[0] == 'b':\n+                    assert self.pre == 'a'\n+                if value[0] == 'd':\n+                    assert self.pre == 'c'\n+                self.pre = value[0]\n+                return value\n+\n+        mapped_stream = ds.key_by(MyKeySelector()).map(AssertKeyMapFunction())\n+        self.collect_util.collect(mapped_stream)\n+        self.env.execute('key_by_test')\n+        results = self.collect_util.results()\n+        expected = [\"<Row('a', 0)>\", \"<Row('b', 0)>\", \"<Row('c', 1)>\", \"<Row('d', 1)>\",\n+                    \"<Row('e', 2)>\"]\n+        results.sort()\n+        expected.sort()\n+        self.assertEqual(expected, results)\n+\n+    def test_key_by_map(self):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52e8670eef5651d09ad0defeb1a8729aa7c589ba"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcyMTMwNA==", "bodyText": "They are almost the same, but the second test is to make sure we have not changed the original DataStream after key_by() operation with two way map operation.", "url": "https://github.com/apache/flink/pull/13097#discussion_r467721304", "createdAt": "2020-08-10T07:08:37Z", "author": {"login": "shuiqiangchen"}, "path": "flink-python/pyflink/datastream/tests/test_data_stream.py", "diffHunk": "@@ -140,15 +135,68 @@ def flat_map(value):\n \n         flat_mapped_stream = ds.flat_map(flat_map, type_info=Types.ROW([Types.STRING(),\n                                                                         Types.INT()]))\n-        collect_util = DataStreamCollectUtil()\n-        collect_util.collect(flat_mapped_stream)\n+        self.collect_util.collect(flat_mapped_stream)\n         self.env.execute('flat_map_test')\n-        results = collect_util.results()\n+        results = self.collect_util.results()\n         expected = ['a,0', 'bdc,2', 'deeefg,4']\n         results.sort()\n         expected.sort()\n         self.assertEqual(expected, results)\n \n+    def test_key_by(self):\n+        element_collection = [('a', 0), ('b', 0), ('c', 1), ('d', 1), ('e', 2)]\n+        self.env.set_parallelism(1)\n+        ds = self.env.from_collection(element_collection,\n+                                      type_info=Types.ROW([Types.STRING(), Types.INT()]))\n+\n+        class AssertKeyMapFunction(MapFunction):\n+            def __init__(self):\n+                self.pre = None\n+\n+            def map(self, value):\n+                if value[0] == 'b':\n+                    assert self.pre == 'a'\n+                if value[0] == 'd':\n+                    assert self.pre == 'c'\n+                self.pre = value[0]\n+                return value\n+\n+        mapped_stream = ds.key_by(MyKeySelector()).map(AssertKeyMapFunction())\n+        self.collect_util.collect(mapped_stream)\n+        self.env.execute('key_by_test')\n+        results = self.collect_util.results()\n+        expected = [\"<Row('a', 0)>\", \"<Row('b', 0)>\", \"<Row('c', 1)>\", \"<Row('d', 1)>\",\n+                    \"<Row('e', 2)>\"]\n+        results.sort()\n+        expected.sort()\n+        self.assertEqual(expected, results)\n+\n+    def test_key_by_map(self):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxOTU3NQ=="}, "originalCommit": {"oid": "52e8670eef5651d09ad0defeb1a8729aa7c589ba"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcyOTI2Ng==", "bodyText": "then we can use the second one to cover the first one.", "url": "https://github.com/apache/flink/pull/13097#discussion_r467729266", "createdAt": "2020-08-10T07:29:07Z", "author": {"login": "hequn8128"}, "path": "flink-python/pyflink/datastream/tests/test_data_stream.py", "diffHunk": "@@ -140,15 +135,68 @@ def flat_map(value):\n \n         flat_mapped_stream = ds.flat_map(flat_map, type_info=Types.ROW([Types.STRING(),\n                                                                         Types.INT()]))\n-        collect_util = DataStreamCollectUtil()\n-        collect_util.collect(flat_mapped_stream)\n+        self.collect_util.collect(flat_mapped_stream)\n         self.env.execute('flat_map_test')\n-        results = collect_util.results()\n+        results = self.collect_util.results()\n         expected = ['a,0', 'bdc,2', 'deeefg,4']\n         results.sort()\n         expected.sort()\n         self.assertEqual(expected, results)\n \n+    def test_key_by(self):\n+        element_collection = [('a', 0), ('b', 0), ('c', 1), ('d', 1), ('e', 2)]\n+        self.env.set_parallelism(1)\n+        ds = self.env.from_collection(element_collection,\n+                                      type_info=Types.ROW([Types.STRING(), Types.INT()]))\n+\n+        class AssertKeyMapFunction(MapFunction):\n+            def __init__(self):\n+                self.pre = None\n+\n+            def map(self, value):\n+                if value[0] == 'b':\n+                    assert self.pre == 'a'\n+                if value[0] == 'd':\n+                    assert self.pre == 'c'\n+                self.pre = value[0]\n+                return value\n+\n+        mapped_stream = ds.key_by(MyKeySelector()).map(AssertKeyMapFunction())\n+        self.collect_util.collect(mapped_stream)\n+        self.env.execute('key_by_test')\n+        results = self.collect_util.results()\n+        expected = [\"<Row('a', 0)>\", \"<Row('b', 0)>\", \"<Row('c', 1)>\", \"<Row('d', 1)>\",\n+                    \"<Row('e', 2)>\"]\n+        results.sort()\n+        expected.sort()\n+        self.assertEqual(expected, results)\n+\n+    def test_key_by_map(self):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxOTU3NQ=="}, "originalCommit": {"oid": "52e8670eef5651d09ad0defeb1a8729aa7c589ba"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1NjEwMg==", "bodyText": "Ok", "url": "https://github.com/apache/flink/pull/13097#discussion_r467756102", "createdAt": "2020-08-10T08:28:38Z", "author": {"login": "shuiqiangchen"}, "path": "flink-python/pyflink/datastream/tests/test_data_stream.py", "diffHunk": "@@ -140,15 +135,68 @@ def flat_map(value):\n \n         flat_mapped_stream = ds.flat_map(flat_map, type_info=Types.ROW([Types.STRING(),\n                                                                         Types.INT()]))\n-        collect_util = DataStreamCollectUtil()\n-        collect_util.collect(flat_mapped_stream)\n+        self.collect_util.collect(flat_mapped_stream)\n         self.env.execute('flat_map_test')\n-        results = collect_util.results()\n+        results = self.collect_util.results()\n         expected = ['a,0', 'bdc,2', 'deeefg,4']\n         results.sort()\n         expected.sort()\n         self.assertEqual(expected, results)\n \n+    def test_key_by(self):\n+        element_collection = [('a', 0), ('b', 0), ('c', 1), ('d', 1), ('e', 2)]\n+        self.env.set_parallelism(1)\n+        ds = self.env.from_collection(element_collection,\n+                                      type_info=Types.ROW([Types.STRING(), Types.INT()]))\n+\n+        class AssertKeyMapFunction(MapFunction):\n+            def __init__(self):\n+                self.pre = None\n+\n+            def map(self, value):\n+                if value[0] == 'b':\n+                    assert self.pre == 'a'\n+                if value[0] == 'd':\n+                    assert self.pre == 'c'\n+                self.pre = value[0]\n+                return value\n+\n+        mapped_stream = ds.key_by(MyKeySelector()).map(AssertKeyMapFunction())\n+        self.collect_util.collect(mapped_stream)\n+        self.env.execute('key_by_test')\n+        results = self.collect_util.results()\n+        expected = [\"<Row('a', 0)>\", \"<Row('b', 0)>\", \"<Row('c', 1)>\", \"<Row('d', 1)>\",\n+                    \"<Row('e', 2)>\"]\n+        results.sort()\n+        expected.sort()\n+        self.assertEqual(expected, results)\n+\n+    def test_key_by_map(self):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxOTU3NQ=="}, "originalCommit": {"oid": "52e8670eef5651d09ad0defeb1a8729aa7c589ba"}, "originalPosition": 143}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMjM3NDM1OnYy", "diffSide": "RIGHT", "path": "flink-python/pyflink/datastream/data_stream.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODoyNTozMlrOG-FebQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODoyODo0OVrOG-Fkrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1NDYwNQ==", "bodyText": "Remove this method in this PR.", "url": "https://github.com/apache/flink/pull/13097#discussion_r467754605", "createdAt": "2020-08-10T08:25:32Z", "author": {"login": "hequn8128"}, "path": "flink-python/pyflink/datastream/data_stream.py", "diffHunk": "@@ -233,6 +234,56 @@ def flat_map(self, func: Union[Callable, FlatMapFunction], type_info: TypeInform\n             j_python_data_stream_scalar_function_operator\n         ))\n \n+    def key_by(self, key_selector: Union[Callable, KeySelector],\n+               key_type_info: TypeInformation = None) -> 'KeyedStream':\n+        \"\"\"\n+        Creates a new KeyedStream that uses the provided key for partitioning its operator states.\n+\n+        :param key_selector: The KeySelector to be used for extracting the key for partitioning.\n+        :param key_type_info: The type information describing the key type.\n+        :return: The DataStream with partitioned state(i.e. KeyedStream).\n+        \"\"\"\n+        if callable(key_selector):\n+            key_selector = KeySelectorFunctionWrapper(key_selector)\n+        if not isinstance(key_selector, (KeySelector, KeySelectorFunctionWrapper)):\n+            raise TypeError(\"Parameter key_selector should be a type of KeySelector.\")\n+\n+        gateway = get_gateway()\n+        PickledKeySelector = gateway.jvm \\\n+            .org.apache.flink.datastream.runtime.functions.python.PickledKeySelector\n+        j_output_type_info = self._j_data_stream.getTransformation().getOutputType()\n+        output_type_info = typeinfo._from_java_type(j_output_type_info)\n+        is_key_pickled_byte_array = False\n+        if key_type_info is None:\n+            key_type_info = Types.PICKLED_BYTE_ARRAY()\n+            is_key_pickled_byte_array = True\n+        generated_key_stream = KeyedStream(self.map(lambda x: (key_selector.get_key(x), x),\n+                                                    type_info=Types.ROW([key_type_info,\n+                                                                         output_type_info]))\n+                                           ._j_data_stream\n+                                           .keyBy(PickledKeySelector(is_key_pickled_byte_array)))\n+        generated_key_stream._original_data_type_info = output_type_info\n+        return generated_key_stream\n+\n+    def _align_output_type(self) -> 'DataStream':", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a4fc8cbc9cab1b8395b92c33b960fe4913c6d4a"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1NjIwNg==", "bodyText": "ok", "url": "https://github.com/apache/flink/pull/13097#discussion_r467756206", "createdAt": "2020-08-10T08:28:49Z", "author": {"login": "shuiqiangchen"}, "path": "flink-python/pyflink/datastream/data_stream.py", "diffHunk": "@@ -233,6 +234,56 @@ def flat_map(self, func: Union[Callable, FlatMapFunction], type_info: TypeInform\n             j_python_data_stream_scalar_function_operator\n         ))\n \n+    def key_by(self, key_selector: Union[Callable, KeySelector],\n+               key_type_info: TypeInformation = None) -> 'KeyedStream':\n+        \"\"\"\n+        Creates a new KeyedStream that uses the provided key for partitioning its operator states.\n+\n+        :param key_selector: The KeySelector to be used for extracting the key for partitioning.\n+        :param key_type_info: The type information describing the key type.\n+        :return: The DataStream with partitioned state(i.e. KeyedStream).\n+        \"\"\"\n+        if callable(key_selector):\n+            key_selector = KeySelectorFunctionWrapper(key_selector)\n+        if not isinstance(key_selector, (KeySelector, KeySelectorFunctionWrapper)):\n+            raise TypeError(\"Parameter key_selector should be a type of KeySelector.\")\n+\n+        gateway = get_gateway()\n+        PickledKeySelector = gateway.jvm \\\n+            .org.apache.flink.datastream.runtime.functions.python.PickledKeySelector\n+        j_output_type_info = self._j_data_stream.getTransformation().getOutputType()\n+        output_type_info = typeinfo._from_java_type(j_output_type_info)\n+        is_key_pickled_byte_array = False\n+        if key_type_info is None:\n+            key_type_info = Types.PICKLED_BYTE_ARRAY()\n+            is_key_pickled_byte_array = True\n+        generated_key_stream = KeyedStream(self.map(lambda x: (key_selector.get_key(x), x),\n+                                                    type_info=Types.ROW([key_type_info,\n+                                                                         output_type_info]))\n+                                           ._j_data_stream\n+                                           .keyBy(PickledKeySelector(is_key_pickled_byte_array)))\n+        generated_key_stream._original_data_type_info = output_type_info\n+        return generated_key_stream\n+\n+    def _align_output_type(self) -> 'DataStream':", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1NDYwNQ=="}, "originalCommit": {"oid": "3a4fc8cbc9cab1b8395b92c33b960fe4913c6d4a"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMjM3NjAzOnYy", "diffSide": "RIGHT", "path": "flink-python/pyflink/datastream/data_stream.py", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODoyNTo1N1rOG-FfVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODoyNTo1N1rOG-FfVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1NDgzNw==", "bodyText": "Throw exception when perform set_parallelism, name, uid, etc.", "url": "https://github.com/apache/flink/pull/13097#discussion_r467754837", "createdAt": "2020-08-10T08:25:57Z", "author": {"login": "hequn8128"}, "path": "flink-python/pyflink/datastream/data_stream.py", "diffHunk": "@@ -290,3 +341,39 @@ def _get_java_python_function_operator(self, func: Union[Function, FunctionWrapp\n             output_type_info.get_java_type_info(),\n             j_python_data_stream_function_info)\n         return j_python_data_stream_scalar_function_operator, output_type_info\n+\n+\n+class KeyedStream(DataStream):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a4fc8cbc9cab1b8395b92c33b960fe4913c6d4a"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMjM3OTA4OnYy", "diffSide": "RIGHT", "path": "flink-python/pyflink/datastream/data_stream.py", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODoyNjo1N1rOG-FhIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODoyNjo1N1rOG-FhIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1NTI5Ng==", "bodyText": ".keyBy(PickledKeySelector(), key_type_info)", "url": "https://github.com/apache/flink/pull/13097#discussion_r467755296", "createdAt": "2020-08-10T08:26:57Z", "author": {"login": "hequn8128"}, "path": "flink-python/pyflink/datastream/data_stream.py", "diffHunk": "@@ -233,6 +234,56 @@ def flat_map(self, func: Union[Callable, FlatMapFunction], type_info: TypeInform\n             j_python_data_stream_scalar_function_operator\n         ))\n \n+    def key_by(self, key_selector: Union[Callable, KeySelector],\n+               key_type_info: TypeInformation = None) -> 'KeyedStream':\n+        \"\"\"\n+        Creates a new KeyedStream that uses the provided key for partitioning its operator states.\n+\n+        :param key_selector: The KeySelector to be used for extracting the key for partitioning.\n+        :param key_type_info: The type information describing the key type.\n+        :return: The DataStream with partitioned state(i.e. KeyedStream).\n+        \"\"\"\n+        if callable(key_selector):\n+            key_selector = KeySelectorFunctionWrapper(key_selector)\n+        if not isinstance(key_selector, (KeySelector, KeySelectorFunctionWrapper)):\n+            raise TypeError(\"Parameter key_selector should be a type of KeySelector.\")\n+\n+        gateway = get_gateway()\n+        PickledKeySelector = gateway.jvm \\\n+            .org.apache.flink.datastream.runtime.functions.python.PickledKeySelector\n+        j_output_type_info = self._j_data_stream.getTransformation().getOutputType()\n+        output_type_info = typeinfo._from_java_type(j_output_type_info)\n+        is_key_pickled_byte_array = False\n+        if key_type_info is None:\n+            key_type_info = Types.PICKLED_BYTE_ARRAY()\n+            is_key_pickled_byte_array = True\n+        generated_key_stream = KeyedStream(self.map(lambda x: (key_selector.get_key(x), x),\n+                                                    type_info=Types.ROW([key_type_info,\n+                                                                         output_type_info]))\n+                                           ._j_data_stream\n+                                           .keyBy(PickledKeySelector(is_key_pickled_byte_array)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a4fc8cbc9cab1b8395b92c33b960fe4913c6d4a"}, "originalPosition": 45}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4934, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}