{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMzIzNzY4", "number": 12278, "reviewThreads": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNDowOTowMVrOD_sNQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwODoxMDo1NlrOEGPh4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MTExMTY5OnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNDowOTowMVrOGagCqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwNzowODowNFrOGg7hYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0MTEzMQ==", "bodyText": "Looking into the implementation of DualKeyLinkedMap for pendingRequests, it seems we can just remove the first matching SlotRequestId and then remap the orphaned SlotRequestId to its AllocationID. The original insertion ordering should not suffer in DualKeyLinkedMap.aMap. If so, we could remove  requestedAllocations.\nEDIT: waitingForResourceManager -> pendingRequests", "url": "https://github.com/apache/flink/pull/12278#discussion_r430441131", "createdAt": "2020-05-26T14:09:01Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -112,6 +114,9 @@\n \t/** The requests that are waiting for the resource manager to be connected. */\n \tprivate final LinkedHashMap<SlotRequestId, PendingRequest> waitingForResourceManager;\n \n+\t/** Maps a request to its allocation. */\n+\tprivate final BiMap<SlotRequestId, AllocationID> requestedAllocations;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3a4256ccc6300fcac27d7625461c078a1510604"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYyODI4Mg==", "bodyText": "Yes we can improve DualKeyLinkedMap and drop the requestedAllocations.\nThe needed improvement would be:\n\nre-insert a record does not affect its order\nget keyA from keyB, and vice versa", "url": "https://github.com/apache/flink/pull/12278#discussion_r436628282", "createdAt": "2020-06-08T11:30:42Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -112,6 +114,9 @@\n \t/** The requests that are waiting for the resource manager to be connected. */\n \tprivate final LinkedHashMap<SlotRequestId, PendingRequest> waitingForResourceManager;\n \n+\t/** Maps a request to its allocation. */\n+\tprivate final BiMap<SlotRequestId, AllocationID> requestedAllocations;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0MTEzMQ=="}, "originalCommit": {"oid": "a3a4256ccc6300fcac27d7625461c078a1510604"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE4MjgxOQ==", "bodyText": "done.", "url": "https://github.com/apache/flink/pull/12278#discussion_r437182819", "createdAt": "2020-06-09T07:08:04Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -112,6 +114,9 @@\n \t/** The requests that are waiting for the resource manager to be connected. */\n \tprivate final LinkedHashMap<SlotRequestId, PendingRequest> waitingForResourceManager;\n \n+\t/** Maps a request to its allocation. */\n+\tprivate final BiMap<SlotRequestId, AllocationID> requestedAllocations;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0MTEzMQ=="}, "originalCommit": {"oid": "a3a4256ccc6300fcac27d7625461c078a1510604"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MTEzNDAwOnYy", "diffSide": "LEFT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "isResolved": true, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNDoxMzozOVrOGagQkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNzowMjoyMVrOGi5R2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NDY5MA==", "bodyText": "I am not sure about all consequences of this change for the existing scheduling. I mean that we do not respect SlotRequestId->AllocationID by accepting the slot offer. Would it make sense to keep this behaviour configurable for now depending on scheduling strategy? Or this complication is not needed?", "url": "https://github.com/apache/flink/pull/12278#discussion_r430444690", "createdAt": "2020-05-26T14:13:39Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -648,26 +648,8 @@ boolean offerSlot(\n \t\t\tslotOffer.getResourceProfile(),\n \t\t\ttaskManagerGateway);\n \n-\t\t// check whether we have request waiting for this slot\n-\t\tPendingRequest pendingRequest = pendingRequests.removeKeyB(allocationID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7065a71c2911aa3938c827bdb9029dee9268950c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzYwNzI2OQ==", "bodyText": "I think it's a good idea to make it configurable.\nBesides the benefit to reduce risk for streaming and DataSet jobs, another benefit is that we can also drop the change to remap orphaned allocations. This is because the remapping is for fail-fast of pending requests in failAllocation(...) which makes difference only if it is a streaming job.\nActually I'm thinking whether we need to keep the fail-fast mechanism in failAllocation(...) in the future. It requires the slot pool to differentiate streaming requests and batch requests. And in the future if a slotpool contains both batch slots(occupied temporarily) and streaming slots(occupied indefinitely), a failed allocation for streaming request does not need to fail immediately if it is still fulfillable, just like how we currently deal with batch requests.\nWhat do you think of dropping the commit to remap orphaned allocations?", "url": "https://github.com/apache/flink/pull/12278#discussion_r433607269", "createdAt": "2020-06-02T04:01:03Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -648,26 +648,8 @@ boolean offerSlot(\n \t\t\tslotOffer.getResourceProfile(),\n \t\t\ttaskManagerGateway);\n \n-\t\t// check whether we have request waiting for this slot\n-\t\tPendingRequest pendingRequest = pendingRequests.removeKeyB(allocationID);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NDY5MA=="}, "originalCommit": {"oid": "7065a71c2911aa3938c827bdb9029dee9268950c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM2MjA4NA==", "bodyText": "There is this UnfulfillableSlotRequestException which is still a fail fast route if RM finds that a certain request profile cannot be fulfilled at all with any existing slot and cannot be allocated. It is relevant for both batch and streaming and bulk as I see. I do not know the whole background of this. At first glance, this looks to me as an optimisation that complicates things a bit at the moment. It is probably necessary to avoid timeout waiting to cancel everything if it is already clear that allocation can never succeed.", "url": "https://github.com/apache/flink/pull/12278#discussion_r435362084", "createdAt": "2020-06-04T15:45:43Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -648,26 +648,8 @@ boolean offerSlot(\n \t\t\tslotOffer.getResourceProfile(),\n \t\t\ttaskManagerGateway);\n \n-\t\t// check whether we have request waiting for this slot\n-\t\tPendingRequest pendingRequest = pendingRequests.removeKeyB(allocationID);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NDY5MA=="}, "originalCommit": {"oid": "7065a71c2911aa3938c827bdb9029dee9268950c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUzMzE0OA==", "bodyText": "Yes still need the remapping to allow fail-fast on UnfulfillableSlotRequestException.", "url": "https://github.com/apache/flink/pull/12278#discussion_r436533148", "createdAt": "2020-06-08T08:28:33Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -648,26 +648,8 @@ boolean offerSlot(\n \t\t\tslotOffer.getResourceProfile(),\n \t\t\ttaskManagerGateway);\n \n-\t\t// check whether we have request waiting for this slot\n-\t\tPendingRequest pendingRequest = pendingRequests.removeKeyB(allocationID);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NDY5MA=="}, "originalCommit": {"oid": "7065a71c2911aa3938c827bdb9029dee9268950c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU0MDU2NQ==", "bodyText": "I had another thought and prefer to not make it configurable to fulfill request in request order.\nThe FIFO order works for any scheduling strategy and is even a improvement for lazy from source scheduling. It is not just for pipelined region scheduling.\nThere once was a ticket/PR for the same purpose \"[FLINK-13165] Complete slot requests in request order\" although it did not fully make it at last. LinkedHashMap was introduced by it and eases this PR. SlotPoolRequestCompletionTest was also introduced by it and can be reused.\nThe orphaned allocation remapping also ensures that the fail-fast route will not break with this change.\nWhat do you think?", "url": "https://github.com/apache/flink/pull/12278#discussion_r436540565", "createdAt": "2020-06-08T08:42:04Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -648,26 +648,8 @@ boolean offerSlot(\n \t\t\tslotOffer.getResourceProfile(),\n \t\t\ttaskManagerGateway);\n \n-\t\t// check whether we have request waiting for this slot\n-\t\tPendingRequest pendingRequest = pendingRequests.removeKeyB(allocationID);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NDY5MA=="}, "originalCommit": {"oid": "7065a71c2911aa3938c827bdb9029dee9268950c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNDExOQ==", "bodyText": "Ok, the FLINK-13165 makes slot requests to be completed in order only if the offers come with unknown AllocationIds, right? Generally we expect that RM keeps the AllocationId to match SlotRequestID. I am fine to break the tie SlotRequestId->AllocationID if there is no known consequences. Eventually, I hope it might even help to simplify the SlotPoolImpl.", "url": "https://github.com/apache/flink/pull/12278#discussion_r438824119", "createdAt": "2020-06-11T14:22:34Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -648,26 +648,8 @@ boolean offerSlot(\n \t\t\tslotOffer.getResourceProfile(),\n \t\t\ttaskManagerGateway);\n \n-\t\t// check whether we have request waiting for this slot\n-\t\tPendingRequest pendingRequest = pendingRequests.removeKeyB(allocationID);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NDY5MA=="}, "originalCommit": {"oid": "7065a71c2911aa3938c827bdb9029dee9268950c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg0Mzg5OA==", "bodyText": "I think it should be fine to remap SlotRequestIds and AllocationIds. In the end it is an implementation detail of the SlotPoolImpl how a SlotRequestId is mapped to an AllocationId and no user of the SlotPool should rely on/use it. The only important bit is to assign the orphaned AllocationId so that we can react to signals from the ResourceManager.", "url": "https://github.com/apache/flink/pull/12278#discussion_r438843898", "createdAt": "2020-06-11T14:50:46Z", "author": {"login": "tillrohrmann"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -648,26 +648,8 @@ boolean offerSlot(\n \t\t\tslotOffer.getResourceProfile(),\n \t\t\ttaskManagerGateway);\n \n-\t\t// check whether we have request waiting for this slot\n-\t\tPendingRequest pendingRequest = pendingRequests.removeKeyB(allocationID);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NDY5MA=="}, "originalCommit": {"oid": "7065a71c2911aa3938c827bdb9029dee9268950c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI0MzIyNQ==", "bodyText": "Thanks for confirming it.", "url": "https://github.com/apache/flink/pull/12278#discussion_r439243225", "createdAt": "2020-06-12T07:02:21Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -648,26 +648,8 @@ boolean offerSlot(\n \t\t\tslotOffer.getResourceProfile(),\n \t\t\ttaskManagerGateway);\n \n-\t\t// check whether we have request waiting for this slot\n-\t\tPendingRequest pendingRequest = pendingRequests.removeKeyB(allocationID);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NDY5MA=="}, "originalCommit": {"oid": "7065a71c2911aa3938c827bdb9029dee9268950c"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDA2NDA5OnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolRequestCompletionTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNzo0Mzo1NFrOGa9N7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwODo0NToyNVrOGdDKPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxOTE0OA==", "bodyText": "is(not(nullValue)) reads nicer", "url": "https://github.com/apache/flink/pull/12278#discussion_r430919148", "createdAt": "2020-05-27T07:43:54Z", "author": {"login": "GJL"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolRequestCompletionTest.java", "diffHunk": "@@ -103,7 +123,7 @@ private void runSlotRequestCompletionTest(\n \t\t\t// check that the slot requests get completed in sequential order\n \t\t\tfor (int i = 0; i < slotRequestIds.size(); i++) {\n \t\t\t\tfinal CompletableFuture<PhysicalSlot> slotRequestFuture = slotRequests.get(i);\n-\t\t\t\tslotRequestFuture.get();\n+\t\t\t\tassertThat(slotRequestFuture.getNow(null), not(is(nullValue())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3a4256ccc6300fcac27d7625461c078a1510604"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzExMzY2Mw==", "bodyText": "OK.", "url": "https://github.com/apache/flink/pull/12278#discussion_r433113663", "createdAt": "2020-06-01T08:45:25Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolRequestCompletionTest.java", "diffHunk": "@@ -103,7 +123,7 @@ private void runSlotRequestCompletionTest(\n \t\t\t// check that the slot requests get completed in sequential order\n \t\t\tfor (int i = 0; i < slotRequestIds.size(); i++) {\n \t\t\t\tfinal CompletableFuture<PhysicalSlot> slotRequestFuture = slotRequests.get(i);\n-\t\t\t\tslotRequestFuture.get();\n+\t\t\t\tassertThat(slotRequestFuture.getNow(null), not(is(nullValue())));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxOTE0OA=="}, "originalCommit": {"oid": "a3a4256ccc6300fcac27d7625461c078a1510604"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDIzMDE3OnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODozMDo1MlrOGa-5JQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwODo0NjozMVrOGdDMQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0NjU5Nw==", "bodyText": "It looks like that this should have been in a separate commit.", "url": "https://github.com/apache/flink/pull/12278#discussion_r430946597", "createdAt": "2020-05-27T08:30:52Z", "author": {"login": "GJL"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -698,13 +680,13 @@ boolean offerSlot(\n \n \t\tcomponentMainThreadExecutor.assertRunningInMainThread();\n \n-\t\tfinal PendingRequest pendingRequest = pendingRequests.removeKeyB(allocationID);\n+\t\tfinal PendingRequest pendingRequest = pendingRequests.getKeyB(allocationID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7065a71c2911aa3938c827bdb9029dee9268950c"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzExNDE3OQ==", "bodyText": "Sure we can have a separate PR to centralize pending requests removal.", "url": "https://github.com/apache/flink/pull/12278#discussion_r433114179", "createdAt": "2020-06-01T08:46:31Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -698,13 +680,13 @@ boolean offerSlot(\n \n \t\tcomponentMainThreadExecutor.assertRunningInMainThread();\n \n-\t\tfinal PendingRequest pendingRequest = pendingRequests.removeKeyB(allocationID);\n+\t\tfinal PendingRequest pendingRequest = pendingRequests.getKeyB(allocationID);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0NjU5Nw=="}, "originalCommit": {"oid": "7065a71c2911aa3938c827bdb9029dee9268950c"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMzU1Nzc5OnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwNzoxMDozM1rOGg7mAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNDozODozM1rOGigY8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE4NDAwMQ==", "bodyText": "@azagrebin what do you think of making this class package private?\nIt looks like a common util class but no one other than SlotPoolImpl uses it.", "url": "https://github.com/apache/flink/pull/12278#discussion_r437184001", "createdAt": "2020-06-09T07:10:33Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -37,20 +44,20 @@\n \n \tprivate final LinkedHashMap<A, Tuple2<B, V>> aMap;\n \n-\tprivate final LinkedHashMap<B, A> bMap;\n+\tprivate final HashMap<B, A> bMap;\n \n \tprivate transient Collection<V> values;\n \n \tpublic DualKeyLinkedMap(int initialCapacity) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a0102b7e3b412027bb84b16cf79f85e930ceb81"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgzNTQ0MQ==", "bodyText": "Makes sense to me", "url": "https://github.com/apache/flink/pull/12278#discussion_r438835441", "createdAt": "2020-06-11T14:38:33Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -37,20 +44,20 @@\n \n \tprivate final LinkedHashMap<A, Tuple2<B, V>> aMap;\n \n-\tprivate final LinkedHashMap<B, A> bMap;\n+\tprivate final HashMap<B, A> bMap;\n \n \tprivate transient Collection<V> values;\n \n \tpublic DualKeyLinkedMap(int initialCapacity) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE4NDAwMQ=="}, "originalCommit": {"oid": "9a0102b7e3b412027bb84b16cf79f85e930ceb81"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NTY1MDgxOnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwODo1NDo1N1rOGkRz6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNzo0NjoyM1rOGk5u3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5MzczOQ==", "bodyText": "I would also explicitly document that @param <A> is the primary key.", "url": "https://github.com/apache/flink/pull/12278#discussion_r440693739", "createdAt": "2020-06-16T08:54:57Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -22,12 +22,16 @@\n \n import java.util.AbstractCollection;\n import java.util.Collection;\n+import java.util.HashMap;\n import java.util.Iterator;\n import java.util.LinkedHashMap;\n import java.util.Set;\n \n /**\n- * Map which stores values under two different indices.\n+ * Map which stores values under two different indices. The mapping of the primary key to the\n+ * value is backed by {@link LinkedHashMap} so that the iteration order over the values and\n+ * the primary key set is the insertion order. Note that there is no contract of the iteration\n+ * order over the secondary key set.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0414b71dafa2cf6e5668e1ff6e9def53baf2a850"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc2Nzk2MQ==", "bodyText": "Good suggestion.", "url": "https://github.com/apache/flink/pull/12278#discussion_r440767961", "createdAt": "2020-06-16T11:04:58Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -22,12 +22,16 @@\n \n import java.util.AbstractCollection;\n import java.util.Collection;\n+import java.util.HashMap;\n import java.util.Iterator;\n import java.util.LinkedHashMap;\n import java.util.Set;\n \n /**\n- * Map which stores values under two different indices.\n+ * Map which stores values under two different indices. The mapping of the primary key to the\n+ * value is backed by {@link LinkedHashMap} so that the iteration order over the values and\n+ * the primary key set is the insertion order. Note that there is no contract of the iteration\n+ * order over the secondary key set.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5MzczOQ=="}, "originalCommit": {"oid": "0414b71dafa2cf6e5668e1ff6e9def53baf2a850"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM0NzgwNQ==", "bodyText": "done.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441347805", "createdAt": "2020-06-17T07:46:23Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -22,12 +22,16 @@\n \n import java.util.AbstractCollection;\n import java.util.Collection;\n+import java.util.HashMap;\n import java.util.Iterator;\n import java.util.LinkedHashMap;\n import java.util.Set;\n \n /**\n- * Map which stores values under two different indices.\n+ * Map which stores values under two different indices. The mapping of the primary key to the\n+ * value is backed by {@link LinkedHashMap} so that the iteration order over the values and\n+ * the primary key set is the insertion order. Note that there is no contract of the iteration\n+ * order over the secondary key set.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5MzczOQ=="}, "originalCommit": {"oid": "0414b71dafa2cf6e5668e1ff6e9def53baf2a850"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NTY1MjU0OnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwODo1NToyMlrOGkR1Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwODoxNDoxM1rOGk6vlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5NDAzNQ==", "bodyText": "Does it matter for this PR which type bMap has?", "url": "https://github.com/apache/flink/pull/12278#discussion_r440694035", "createdAt": "2020-06-16T08:55:22Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -37,13 +41,13 @@\n \n \tprivate final LinkedHashMap<A, Tuple2<B, V>> aMap;\n \n-\tprivate final LinkedHashMap<B, A> bMap;\n+\tprivate final HashMap<B, A> bMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0414b71dafa2cf6e5668e1ff6e9def53baf2a850"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc2ODY3OA==", "bodyText": "It might cause confusion so I think it would be better to not make it a LinkedHashMap.", "url": "https://github.com/apache/flink/pull/12278#discussion_r440768678", "createdAt": "2020-06-16T11:06:23Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -37,13 +41,13 @@\n \n \tprivate final LinkedHashMap<A, Tuple2<B, V>> aMap;\n \n-\tprivate final LinkedHashMap<B, A> bMap;\n+\tprivate final HashMap<B, A> bMap;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5NDAzNQ=="}, "originalCommit": {"oid": "0414b71dafa2cf6e5668e1ff6e9def53baf2a850"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM0Njg4NA==", "bodyText": "Hmm, for me, the order would be not obvious anyways w/o either looking into the implementation or the jdoc comment. I am not strictly opposed to the change but I would avoid it if it is not strictly needed.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441346884", "createdAt": "2020-06-17T07:44:52Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -37,13 +41,13 @@\n \n \tprivate final LinkedHashMap<A, Tuple2<B, V>> aMap;\n \n-\tprivate final LinkedHashMap<B, A> bMap;\n+\tprivate final HashMap<B, A> bMap;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5NDAzNQ=="}, "originalCommit": {"oid": "0414b71dafa2cf6e5668e1ff6e9def53baf2a850"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1MTEzNg==", "bodyText": "I means confusion to developers. A LinkedHashMap for bMap indicates it makes some differences than Map but actually not.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441351136", "createdAt": "2020-06-17T07:52:05Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -37,13 +41,13 @@\n \n \tprivate final LinkedHashMap<A, Tuple2<B, V>> aMap;\n \n-\tprivate final LinkedHashMap<B, A> bMap;\n+\tprivate final HashMap<B, A> bMap;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5NDAzNQ=="}, "originalCommit": {"oid": "0414b71dafa2cf6e5668e1ff6e9def53baf2a850"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2NDM3NA==", "bodyText": "Alright", "url": "https://github.com/apache/flink/pull/12278#discussion_r441364374", "createdAt": "2020-06-17T08:14:13Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -37,13 +41,13 @@\n \n \tprivate final LinkedHashMap<A, Tuple2<B, V>> aMap;\n \n-\tprivate final LinkedHashMap<B, A> bMap;\n+\tprivate final HashMap<B, A> bMap;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5NDAzNQ=="}, "originalCommit": {"oid": "0414b71dafa2cf6e5668e1ff6e9def53baf2a850"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NTY1ODE5OnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwODo1Njo1MVrOGkR4rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNzo0NjoxNFrOGk5ulg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5NDk1OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tpublic V getByKeyA(A aKey) {\n          \n          \n            \n            \tpublic V getValueByKeyA(A aKey) {", "url": "https://github.com/apache/flink/pull/12278#discussion_r440694959", "createdAt": "2020-06-16T08:56:51Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -54,7 +54,7 @@ public int size() {\n \t\treturn aMap.size();\n \t}\n \n-\tpublic V getKeyA(A aKey) {\n+\tpublic V getByKeyA(A aKey) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff26b1df329b9ed8b1138b4c75bbf07d5199ac98"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM0NzczNA==", "bodyText": "done.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441347734", "createdAt": "2020-06-17T07:46:14Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -54,7 +54,7 @@ public int size() {\n \t\treturn aMap.size();\n \t}\n \n-\tpublic V getKeyA(A aKey) {\n+\tpublic V getByKeyA(A aKey) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5NDk1OQ=="}, "originalCommit": {"oid": "ff26b1df329b9ed8b1138b4c75bbf07d5199ac98"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NTY1ODcxOnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwODo1Njo1OVrOGkR5EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNzo0NjowOVrOGk5ubA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5NTA1Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tpublic V getByKeyB(B bKey) {\n          \n          \n            \n            \tpublic V getValueByKeyB(B bKey) {", "url": "https://github.com/apache/flink/pull/12278#discussion_r440695056", "createdAt": "2020-06-16T08:56:59Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -64,7 +64,7 @@ public V getKeyA(A aKey) {\n \t\t}\n \t}\n \n-\tpublic V getKeyB(B bKey) {\n+\tpublic V getByKeyB(B bKey) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff26b1df329b9ed8b1138b4c75bbf07d5199ac98"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM0NzY5Mg==", "bodyText": "done.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441347692", "createdAt": "2020-06-17T07:46:09Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -64,7 +64,7 @@ public V getKeyA(A aKey) {\n \t\t}\n \t}\n \n-\tpublic V getKeyB(B bKey) {\n+\tpublic V getByKeyB(B bKey) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5NTA1Ng=="}, "originalCommit": {"oid": "ff26b1df329b9ed8b1138b4c75bbf07d5199ac98"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NTY2MTE0OnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwODo1NzozNVrOGkR6vA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNzo0NjowM1rOGk5uKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5NTQ4NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tpublic A getKeyA(B bKey) {\n          \n          \n            \n            \tpublic A getKeyAByKeyB(B bKey) {", "url": "https://github.com/apache/flink/pull/12278#discussion_r440695484", "createdAt": "2020-06-16T08:57:35Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -74,6 +74,20 @@ public V getKeyB(B bKey) {\n \t\t}\n \t}\n \n+\tpublic A getKeyA(B bKey) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff26b1df329b9ed8b1138b4c75bbf07d5199ac98"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM0NzYyNw==", "bodyText": "done.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441347627", "createdAt": "2020-06-17T07:46:03Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -74,6 +74,20 @@ public V getKeyB(B bKey) {\n \t\t}\n \t}\n \n+\tpublic A getKeyA(B bKey) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5NTQ4NA=="}, "originalCommit": {"oid": "ff26b1df329b9ed8b1138b4c75bbf07d5199ac98"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NTY2MTcyOnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwODo1Nzo0NFrOGkR7FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNzo0NTo1OFrOGk5t7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5NTU3Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tpublic B getKeyB(A aKey) {\n          \n          \n            \n            \tpublic B getKeyBByKeyA(A aKey) {", "url": "https://github.com/apache/flink/pull/12278#discussion_r440695572", "createdAt": "2020-06-16T08:57:44Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -74,6 +74,20 @@ public V getKeyB(B bKey) {\n \t\t}\n \t}\n \n+\tpublic A getKeyA(B bKey) {\n+\t\treturn bMap.get(bKey);\n+\t}\n+\n+\tpublic B getKeyB(A aKey) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff26b1df329b9ed8b1138b4c75bbf07d5199ac98"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM0NzU2Ng==", "bodyText": "done.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441347566", "createdAt": "2020-06-17T07:45:58Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMap.java", "diffHunk": "@@ -74,6 +74,20 @@ public V getKeyB(B bKey) {\n \t\t}\n \t}\n \n+\tpublic A getKeyA(B bKey) {\n+\t\treturn bMap.get(bKey);\n+\t}\n+\n+\tpublic B getKeyB(A aKey) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5NTU3Mg=="}, "originalCommit": {"oid": "ff26b1df329b9ed8b1138b4c75bbf07d5199ac98"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NTY3OTU0OnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMapTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwOTowMjoxOVrOGkSGhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNzo0NTo1M1rOGk5twQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5ODUwMQ==", "bodyText": "I think values() are also interesting to check for both added tests.", "url": "https://github.com/apache/flink/pull/12278#discussion_r440698501", "createdAt": "2020-06-16T09:02:19Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMapTest.java", "diffHunk": "@@ -85,4 +85,28 @@ public void ensuresOneToOneMappingBetweenKeysSameSecondaryKey() {\n \t\tassertThat(map.getByKeyB(1), is(secondValue));\n \t\tassertThat(map.getByKeyA(2), is(secondValue));\n \t}\n+\n+\t@Test\n+\tpublic void testPrimaryKeyOrderIsNotAffectedIfReInsertedWithSameSecondaryKey() {\n+\t\tfinal DualKeyLinkedMap<Integer, Integer, String> map = new DualKeyLinkedMap<>(2);\n+\n+\t\tfinal String value = \"foobar\";\n+\t\tmap.put(1, 1, value);\n+\t\tmap.put(2, 2, value);\n+\n+\t\tmap.put(1, 1, value);\n+\t\tassertThat(map.keySetA().iterator().next(), is(1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf5a5d0fd65dc6cfdf81e59d7cd041cf5d288338"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM0NzUyMQ==", "bodyText": "True. Added verifications for values.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441347521", "createdAt": "2020-06-17T07:45:53Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMapTest.java", "diffHunk": "@@ -85,4 +85,28 @@ public void ensuresOneToOneMappingBetweenKeysSameSecondaryKey() {\n \t\tassertThat(map.getByKeyB(1), is(secondValue));\n \t\tassertThat(map.getByKeyA(2), is(secondValue));\n \t}\n+\n+\t@Test\n+\tpublic void testPrimaryKeyOrderIsNotAffectedIfReInsertedWithSameSecondaryKey() {\n+\t\tfinal DualKeyLinkedMap<Integer, Integer, String> map = new DualKeyLinkedMap<>(2);\n+\n+\t\tfinal String value = \"foobar\";\n+\t\tmap.put(1, 1, value);\n+\t\tmap.put(2, 2, value);\n+\n+\t\tmap.put(1, 1, value);\n+\t\tassertThat(map.keySetA().iterator().next(), is(1));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5ODUwMQ=="}, "originalCommit": {"oid": "bf5a5d0fd65dc6cfdf81e59d7cd041cf5d288338"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NTY4MzUzOnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMapTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwOTowMzoyNlrOGkSI-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNjo0NjoyN1rOGk3zpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5OTEzMA==", "bodyText": "do we also want to check cleanup of key B 3 if it were in the map?", "url": "https://github.com/apache/flink/pull/12278#discussion_r440699130", "createdAt": "2020-06-16T09:03:26Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMapTest.java", "diffHunk": "@@ -85,4 +85,28 @@ public void ensuresOneToOneMappingBetweenKeysSameSecondaryKey() {\n \t\tassertThat(map.getByKeyB(1), is(secondValue));\n \t\tassertThat(map.getByKeyA(2), is(secondValue));\n \t}\n+\n+\t@Test\n+\tpublic void testPrimaryKeyOrderIsNotAffectedIfReInsertedWithSameSecondaryKey() {\n+\t\tfinal DualKeyLinkedMap<Integer, Integer, String> map = new DualKeyLinkedMap<>(2);\n+\n+\t\tfinal String value = \"foobar\";\n+\t\tmap.put(1, 1, value);\n+\t\tmap.put(2, 2, value);\n+\n+\t\tmap.put(1, 1, value);\n+\t\tassertThat(map.keySetA().iterator().next(), is(1));\n+\t}\n+\n+\t@Test\n+\tpublic void testPrimaryKeyOrderIsNotAffectedIfReInsertedWithDifferentSecondaryKey() {\n+\t\tfinal DualKeyLinkedMap<Integer, Integer, String> map = new DualKeyLinkedMap<>(2);\n+\n+\t\tfinal String value = \"foobar\";\n+\t\tmap.put(1, 1, value);\n+\t\tmap.put(2, 2, value);\n+\n+\t\tmap.put(1, 3, value);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf5a5d0fd65dc6cfdf81e59d7cd041cf5d288338"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMxNjI2MQ==", "bodyText": "This is tested in ensuresOneToOneMappingBetweenKeysSameSecondaryKey.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441316261", "createdAt": "2020-06-17T06:46:27Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/DualKeyLinkedMapTest.java", "diffHunk": "@@ -85,4 +85,28 @@ public void ensuresOneToOneMappingBetweenKeysSameSecondaryKey() {\n \t\tassertThat(map.getByKeyB(1), is(secondValue));\n \t\tassertThat(map.getByKeyA(2), is(secondValue));\n \t}\n+\n+\t@Test\n+\tpublic void testPrimaryKeyOrderIsNotAffectedIfReInsertedWithSameSecondaryKey() {\n+\t\tfinal DualKeyLinkedMap<Integer, Integer, String> map = new DualKeyLinkedMap<>(2);\n+\n+\t\tfinal String value = \"foobar\";\n+\t\tmap.put(1, 1, value);\n+\t\tmap.put(2, 2, value);\n+\n+\t\tmap.put(1, 1, value);\n+\t\tassertThat(map.keySetA().iterator().next(), is(1));\n+\t}\n+\n+\t@Test\n+\tpublic void testPrimaryKeyOrderIsNotAffectedIfReInsertedWithDifferentSecondaryKey() {\n+\t\tfinal DualKeyLinkedMap<Integer, Integer, String> map = new DualKeyLinkedMap<>(2);\n+\n+\t\tfinal String value = \"foobar\";\n+\t\tmap.put(1, 1, value);\n+\t\tmap.put(2, 2, value);\n+\n+\t\tmap.put(1, 3, value);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY5OTEzMA=="}, "originalCommit": {"oid": "bf5a5d0fd65dc6cfdf81e59d7cd041cf5d288338"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NTczOTcyOnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwOToxODoxMFrOGkSspA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNzo0NToxOFrOGk5sWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwODI2MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tfinal AllocationID orphanedAllocationId = allocationIdOfRequest.equals(allocationIdOfSlot)\n          \n          \n            \n            \t\t\t? null : allocationIdOfRequest;\n          \n          \n            \n            \n          \n          \n            \n            \t\t// if the request that initiated the allocation is still pending, it should take over the orphaned allocation\n          \n          \n            \n            \t\t// of the fulfilled request so that it can fail fast if the remapped allocation fails\n          \n          \n            \n            \t\tif (orphanedAllocationId != null) {\n          \n          \n            \n            \t\t// if the request that initiated the allocation is still pending, it should take over the orphaned allocation\n          \n          \n            \n            \t\t// of the fulfilled request so that it can fail fast if the remapped allocation fails\n          \n          \n            \n            \t\tif (!allocationIdOfRequest.equals(allocationIdOfSlot)) {\n          \n          \n            \n            \t\t    final AllocationID orphanedAllocationId = allocationIdOfRequest;", "url": "https://github.com/apache/flink/pull/12278#discussion_r440708260", "createdAt": "2020-06-16T09:18:10Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -592,6 +589,31 @@ private PendingRequest findMatchingPendingRequest(final AllocatedSlot slot) {\n \t\treturn null;\n \t}\n \n+\tprivate void maybeRemapOrphanedAllocation(\n+\t\t\tfinal AllocationID allocationIdOfRequest,\n+\t\t\tfinal AllocationID allocationIdOfSlot) {\n+\n+\t\tfinal AllocationID orphanedAllocationId = allocationIdOfRequest.equals(allocationIdOfSlot)\n+\t\t\t? null : allocationIdOfRequest;\n+\n+\t\t// if the request that initiated the allocation is still pending, it should take over the orphaned allocation\n+\t\t// of the fulfilled request so that it can fail fast if the remapped allocation fails\n+\t\tif (orphanedAllocationId != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13ae7d728e12b1f349d1cbb1d555882e5d29b298"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM0NzE2MA==", "bodyText": "done.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441347160", "createdAt": "2020-06-17T07:45:18Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -592,6 +589,31 @@ private PendingRequest findMatchingPendingRequest(final AllocatedSlot slot) {\n \t\treturn null;\n \t}\n \n+\tprivate void maybeRemapOrphanedAllocation(\n+\t\t\tfinal AllocationID allocationIdOfRequest,\n+\t\t\tfinal AllocationID allocationIdOfSlot) {\n+\n+\t\tfinal AllocationID orphanedAllocationId = allocationIdOfRequest.equals(allocationIdOfSlot)\n+\t\t\t? null : allocationIdOfRequest;\n+\n+\t\t// if the request that initiated the allocation is still pending, it should take over the orphaned allocation\n+\t\t// of the fulfilled request so that it can fail fast if the remapped allocation fails\n+\t\tif (orphanedAllocationId != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwODI2MA=="}, "originalCommit": {"oid": "13ae7d728e12b1f349d1cbb1d555882e5d29b298"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NTc2NjA1OnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwOToyNToyNVrOGkS9TA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNzo0NTo0N1rOGk5teQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcxMjUyNA==", "bodyText": "is it about previously allocated slots returned by scheduler after e.g. finishing tasks?\ndo they also have to be cancelled in the RM?", "url": "https://github.com/apache/flink/pull/12278#discussion_r440712524", "createdAt": "2020-06-16T09:25:25Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -592,6 +589,31 @@ private PendingRequest findMatchingPendingRequest(final AllocatedSlot slot) {\n \t\treturn null;\n \t}\n \n+\tprivate void maybeRemapOrphanedAllocation(\n+\t\t\tfinal AllocationID allocationIdOfRequest,\n+\t\t\tfinal AllocationID allocationIdOfSlot) {\n+\n+\t\tfinal AllocationID orphanedAllocationId = allocationIdOfRequest.equals(allocationIdOfSlot)\n+\t\t\t? null : allocationIdOfRequest;\n+\n+\t\t// if the request that initiated the allocation is still pending, it should take over the orphaned allocation\n+\t\t// of the fulfilled request so that it can fail fast if the remapped allocation fails\n+\t\tif (orphanedAllocationId != null) {\n+\t\t\tfinal SlotRequestId requestIdOfAllocatedSlot = pendingRequests.getKeyA(allocationIdOfSlot);\n+\t\t\tif (requestIdOfAllocatedSlot != null) {\n+\t\t\t\tfinal PendingRequest requestOfAllocatedSlot = pendingRequests.getByKeyA(requestIdOfAllocatedSlot);\n+\t\t\t\trequestOfAllocatedSlot.setAllocationId(orphanedAllocationId);\n+\n+\t\t\t\t// this re-insertion of initiatedRequestId will not affect its original insertion order\n+\t\t\t\tpendingRequests.put(requestIdOfAllocatedSlot, orphanedAllocationId, requestOfAllocatedSlot);\n+\t\t\t} else {\n+\t\t\t\t// cancel the slot request if the orphaned allocation is not remapped to a pending request.\n+\t\t\t\t// the request id can be null if the slot is returned by scheduler\n+\t\t\t\tresourceManagerGateway.cancelSlotRequest(orphanedAllocationId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13ae7d728e12b1f349d1cbb1d555882e5d29b298"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMzNjAwNA==", "bodyText": "yes. If such returned slot fulfills a pending request, the orphaned allocation would not be needed by any other pending requests which still have their own allocations.\nSo we can safely cancel them to avoid allocating slots more than needed.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441336004", "createdAt": "2020-06-17T07:26:23Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -592,6 +589,31 @@ private PendingRequest findMatchingPendingRequest(final AllocatedSlot slot) {\n \t\treturn null;\n \t}\n \n+\tprivate void maybeRemapOrphanedAllocation(\n+\t\t\tfinal AllocationID allocationIdOfRequest,\n+\t\t\tfinal AllocationID allocationIdOfSlot) {\n+\n+\t\tfinal AllocationID orphanedAllocationId = allocationIdOfRequest.equals(allocationIdOfSlot)\n+\t\t\t? null : allocationIdOfRequest;\n+\n+\t\t// if the request that initiated the allocation is still pending, it should take over the orphaned allocation\n+\t\t// of the fulfilled request so that it can fail fast if the remapped allocation fails\n+\t\tif (orphanedAllocationId != null) {\n+\t\t\tfinal SlotRequestId requestIdOfAllocatedSlot = pendingRequests.getKeyA(allocationIdOfSlot);\n+\t\t\tif (requestIdOfAllocatedSlot != null) {\n+\t\t\t\tfinal PendingRequest requestOfAllocatedSlot = pendingRequests.getByKeyA(requestIdOfAllocatedSlot);\n+\t\t\t\trequestOfAllocatedSlot.setAllocationId(orphanedAllocationId);\n+\n+\t\t\t\t// this re-insertion of initiatedRequestId will not affect its original insertion order\n+\t\t\t\tpendingRequests.put(requestIdOfAllocatedSlot, orphanedAllocationId, requestOfAllocatedSlot);\n+\t\t\t} else {\n+\t\t\t\t// cancel the slot request if the orphaned allocation is not remapped to a pending request.\n+\t\t\t\t// the request id can be null if the slot is returned by scheduler\n+\t\t\t\tresourceManagerGateway.cancelSlotRequest(orphanedAllocationId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcxMjUyNA=="}, "originalCommit": {"oid": "13ae7d728e12b1f349d1cbb1d555882e5d29b298"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM0MzU4Mg==", "bodyText": "Alright, so this is something like release the slot at the RM at the same time.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441343582", "createdAt": "2020-06-17T07:39:02Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -592,6 +589,31 @@ private PendingRequest findMatchingPendingRequest(final AllocatedSlot slot) {\n \t\treturn null;\n \t}\n \n+\tprivate void maybeRemapOrphanedAllocation(\n+\t\t\tfinal AllocationID allocationIdOfRequest,\n+\t\t\tfinal AllocationID allocationIdOfSlot) {\n+\n+\t\tfinal AllocationID orphanedAllocationId = allocationIdOfRequest.equals(allocationIdOfSlot)\n+\t\t\t? null : allocationIdOfRequest;\n+\n+\t\t// if the request that initiated the allocation is still pending, it should take over the orphaned allocation\n+\t\t// of the fulfilled request so that it can fail fast if the remapped allocation fails\n+\t\tif (orphanedAllocationId != null) {\n+\t\t\tfinal SlotRequestId requestIdOfAllocatedSlot = pendingRequests.getKeyA(allocationIdOfSlot);\n+\t\t\tif (requestIdOfAllocatedSlot != null) {\n+\t\t\t\tfinal PendingRequest requestOfAllocatedSlot = pendingRequests.getByKeyA(requestIdOfAllocatedSlot);\n+\t\t\t\trequestOfAllocatedSlot.setAllocationId(orphanedAllocationId);\n+\n+\t\t\t\t// this re-insertion of initiatedRequestId will not affect its original insertion order\n+\t\t\t\tpendingRequests.put(requestIdOfAllocatedSlot, orphanedAllocationId, requestOfAllocatedSlot);\n+\t\t\t} else {\n+\t\t\t\t// cancel the slot request if the orphaned allocation is not remapped to a pending request.\n+\t\t\t\t// the request id can be null if the slot is returned by scheduler\n+\t\t\t\tresourceManagerGateway.cancelSlotRequest(orphanedAllocationId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcxMjUyNA=="}, "originalCommit": {"oid": "13ae7d728e12b1f349d1cbb1d555882e5d29b298"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM0NzQ0OQ==", "bodyText": "updated the comments to make it easier to understand", "url": "https://github.com/apache/flink/pull/12278#discussion_r441347449", "createdAt": "2020-06-17T07:45:47Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -592,6 +589,31 @@ private PendingRequest findMatchingPendingRequest(final AllocatedSlot slot) {\n \t\treturn null;\n \t}\n \n+\tprivate void maybeRemapOrphanedAllocation(\n+\t\t\tfinal AllocationID allocationIdOfRequest,\n+\t\t\tfinal AllocationID allocationIdOfSlot) {\n+\n+\t\tfinal AllocationID orphanedAllocationId = allocationIdOfRequest.equals(allocationIdOfSlot)\n+\t\t\t? null : allocationIdOfRequest;\n+\n+\t\t// if the request that initiated the allocation is still pending, it should take over the orphaned allocation\n+\t\t// of the fulfilled request so that it can fail fast if the remapped allocation fails\n+\t\tif (orphanedAllocationId != null) {\n+\t\t\tfinal SlotRequestId requestIdOfAllocatedSlot = pendingRequests.getKeyA(allocationIdOfSlot);\n+\t\t\tif (requestIdOfAllocatedSlot != null) {\n+\t\t\t\tfinal PendingRequest requestOfAllocatedSlot = pendingRequests.getByKeyA(requestIdOfAllocatedSlot);\n+\t\t\t\trequestOfAllocatedSlot.setAllocationId(orphanedAllocationId);\n+\n+\t\t\t\t// this re-insertion of initiatedRequestId will not affect its original insertion order\n+\t\t\t\tpendingRequests.put(requestIdOfAllocatedSlot, orphanedAllocationId, requestOfAllocatedSlot);\n+\t\t\t} else {\n+\t\t\t\t// cancel the slot request if the orphaned allocation is not remapped to a pending request.\n+\t\t\t\t// the request id can be null if the slot is returned by scheduler\n+\t\t\t\tresourceManagerGateway.cancelSlotRequest(orphanedAllocationId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcxMjUyNA=="}, "originalCommit": {"oid": "13ae7d728e12b1f349d1cbb1d555882e5d29b298"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0OTc3NjYzOnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImplTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwODowMDozN1rOGk6PkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMDowMzo1MlrOGk-5cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1NjE3Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tscheduler.allocateSlot(\n          \n          \n            \n            \t\t\t\tslotRequestId1,\n          \n          \n            \n            \t\t\t\tnew DummyScheduledUnit(),\n          \n          \n            \n            \t\t\t\tSlotProfile.noRequirements(),\n          \n          \n            \n            \t\t\t\ttimeout);\n          \n          \n            \n            \t\t\tallocateSlot(scheduler, slotRequestId1);", "url": "https://github.com/apache/flink/pull/12278#discussion_r441356176", "createdAt": "2020-06-17T08:00:37Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImplTest.java", "diffHunk": "@@ -738,6 +740,95 @@ public void testCalculationOfTaskExecutorUtilization() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testOrphanedAllocationCanBeRemapped() throws Exception {\n+\t\ttry (SlotPoolImpl slotPool = createSlotPoolImpl()) {\n+\t\t\tfinal List<AllocationID> allocationIds = new ArrayList<>();\n+\t\t\tresourceManagerGateway.setRequestSlotConsumer(\n+\t\t\t\tslotRequest -> allocationIds.add(slotRequest.getAllocationId()));\n+\n+\t\t\tfinal List<AllocationID> canceledAllocations = new ArrayList<>();\n+\t\t\tresourceManagerGateway.setCancelSlotConsumer(canceledAllocations::add);\n+\n+\t\t\tsetupSlotPool(slotPool, resourceManagerGateway, mainThreadExecutor);\n+\t\t\tfinal Scheduler scheduler = setupScheduler(slotPool, mainThreadExecutor);\n+\n+\t\t\tfinal SlotRequestId slotRequestId1 = new SlotRequestId();\n+\t\t\tscheduler.allocateSlot(\n+\t\t\t\tslotRequestId1,\n+\t\t\t\tnew DummyScheduledUnit(),\n+\t\t\t\tSlotProfile.noRequirements(),\n+\t\t\t\ttimeout);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f5b21017451ccae3811069e6534f3fa8aeaf1ad"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1NzI5MA==", "bodyText": "There is already a private method SlotPoolImplTest#allocateSlot for this.\nI would also extend this private method to submit multiple allocations at once in order:\nallocateSlot(Scheduler scheduler, SlotRequestId ... slotRequestIds)", "url": "https://github.com/apache/flink/pull/12278#discussion_r441357290", "createdAt": "2020-06-17T08:02:25Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImplTest.java", "diffHunk": "@@ -738,6 +740,95 @@ public void testCalculationOfTaskExecutorUtilization() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testOrphanedAllocationCanBeRemapped() throws Exception {\n+\t\ttry (SlotPoolImpl slotPool = createSlotPoolImpl()) {\n+\t\t\tfinal List<AllocationID> allocationIds = new ArrayList<>();\n+\t\t\tresourceManagerGateway.setRequestSlotConsumer(\n+\t\t\t\tslotRequest -> allocationIds.add(slotRequest.getAllocationId()));\n+\n+\t\t\tfinal List<AllocationID> canceledAllocations = new ArrayList<>();\n+\t\t\tresourceManagerGateway.setCancelSlotConsumer(canceledAllocations::add);\n+\n+\t\t\tsetupSlotPool(slotPool, resourceManagerGateway, mainThreadExecutor);\n+\t\t\tfinal Scheduler scheduler = setupScheduler(slotPool, mainThreadExecutor);\n+\n+\t\t\tfinal SlotRequestId slotRequestId1 = new SlotRequestId();\n+\t\t\tscheduler.allocateSlot(\n+\t\t\t\tslotRequestId1,\n+\t\t\t\tnew DummyScheduledUnit(),\n+\t\t\t\tSlotProfile.noRequirements(),\n+\t\t\t\ttimeout);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1NjE3Ng=="}, "originalCommit": {"oid": "4f5b21017451ccae3811069e6534f3fa8aeaf1ad"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQzMjQzNQ==", "bodyText": "Done via introducing a requestNewAllocatedSlots(SlotPool, SlotRequestId...).", "url": "https://github.com/apache/flink/pull/12278#discussion_r441432435", "createdAt": "2020-06-17T10:03:52Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImplTest.java", "diffHunk": "@@ -738,6 +740,95 @@ public void testCalculationOfTaskExecutorUtilization() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testOrphanedAllocationCanBeRemapped() throws Exception {\n+\t\ttry (SlotPoolImpl slotPool = createSlotPoolImpl()) {\n+\t\t\tfinal List<AllocationID> allocationIds = new ArrayList<>();\n+\t\t\tresourceManagerGateway.setRequestSlotConsumer(\n+\t\t\t\tslotRequest -> allocationIds.add(slotRequest.getAllocationId()));\n+\n+\t\t\tfinal List<AllocationID> canceledAllocations = new ArrayList<>();\n+\t\t\tresourceManagerGateway.setCancelSlotConsumer(canceledAllocations::add);\n+\n+\t\t\tsetupSlotPool(slotPool, resourceManagerGateway, mainThreadExecutor);\n+\t\t\tfinal Scheduler scheduler = setupScheduler(slotPool, mainThreadExecutor);\n+\n+\t\t\tfinal SlotRequestId slotRequestId1 = new SlotRequestId();\n+\t\t\tscheduler.allocateSlot(\n+\t\t\t\tslotRequestId1,\n+\t\t\t\tnew DummyScheduledUnit(),\n+\t\t\t\tSlotProfile.noRequirements(),\n+\t\t\t\ttimeout);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1NjE3Ng=="}, "originalCommit": {"oid": "4f5b21017451ccae3811069e6534f3fa8aeaf1ad"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0OTc5MDA1OnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImplTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwODowNDoyNVrOGk6YAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMDowMDo0NlrOGk-yXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1ODMzOA==", "bodyText": "nit: maybe, not now but if it can be reused also in other tests, it would be nice to have something like an RM harness:\nclass RmHarness {\nfinal List<AllocationID> allocationIds = new ArrayList<>();\nfinal List<AllocationID> canceledAllocations = new ArrayList<>();\nRmHarness(resourceManagerGateway)\ngetAllocations\ngetCanceled\n}", "url": "https://github.com/apache/flink/pull/12278#discussion_r441358338", "createdAt": "2020-06-17T08:04:25Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImplTest.java", "diffHunk": "@@ -738,6 +740,95 @@ public void testCalculationOfTaskExecutorUtilization() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testOrphanedAllocationCanBeRemapped() throws Exception {\n+\t\ttry (SlotPoolImpl slotPool = createSlotPoolImpl()) {\n+\t\t\tfinal List<AllocationID> allocationIds = new ArrayList<>();\n+\t\t\tresourceManagerGateway.setRequestSlotConsumer(\n+\t\t\t\tslotRequest -> allocationIds.add(slotRequest.getAllocationId()));\n+\n+\t\t\tfinal List<AllocationID> canceledAllocations = new ArrayList<>();\n+\t\t\tresourceManagerGateway.setCancelSlotConsumer(canceledAllocations::add);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f5b21017451ccae3811069e6534f3fa8aeaf1ad"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2MDgxMA==", "bodyText": "it can be partially reused in testFailingAllocationFailsRemappedPendingSlotRequests", "url": "https://github.com/apache/flink/pull/12278#discussion_r441360810", "createdAt": "2020-06-17T08:08:47Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImplTest.java", "diffHunk": "@@ -738,6 +740,95 @@ public void testCalculationOfTaskExecutorUtilization() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testOrphanedAllocationCanBeRemapped() throws Exception {\n+\t\ttry (SlotPoolImpl slotPool = createSlotPoolImpl()) {\n+\t\t\tfinal List<AllocationID> allocationIds = new ArrayList<>();\n+\t\t\tresourceManagerGateway.setRequestSlotConsumer(\n+\t\t\t\tslotRequest -> allocationIds.add(slotRequest.getAllocationId()));\n+\n+\t\t\tfinal List<AllocationID> canceledAllocations = new ArrayList<>();\n+\t\t\tresourceManagerGateway.setCancelSlotConsumer(canceledAllocations::add);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1ODMzOA=="}, "originalCommit": {"oid": "4f5b21017451ccae3811069e6534f3fa8aeaf1ad"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQzMDYyMA==", "bodyText": "Maybe later along with the rework of all SlotPool tests? Because resourceManagerGateway is shared between all cases and it's better to have an overview of the usages.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441430620", "createdAt": "2020-06-17T10:00:46Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImplTest.java", "diffHunk": "@@ -738,6 +740,95 @@ public void testCalculationOfTaskExecutorUtilization() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testOrphanedAllocationCanBeRemapped() throws Exception {\n+\t\ttry (SlotPoolImpl slotPool = createSlotPoolImpl()) {\n+\t\t\tfinal List<AllocationID> allocationIds = new ArrayList<>();\n+\t\t\tresourceManagerGateway.setRequestSlotConsumer(\n+\t\t\t\tslotRequest -> allocationIds.add(slotRequest.getAllocationId()));\n+\n+\t\t\tfinal List<AllocationID> canceledAllocations = new ArrayList<>();\n+\t\t\tresourceManagerGateway.setCancelSlotConsumer(canceledAllocations::add);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1ODMzOA=="}, "originalCommit": {"oid": "4f5b21017451ccae3811069e6534f3fa8aeaf1ad"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0OTc5OTc4OnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImplTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwODowNzoxOFrOGk6eUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMDowMzowMlrOGk-3gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1OTk1Mw==", "bodyText": "why do we use Scheduler to unit test SlotPoolImpl?\nwhy not to call SlotPoolImpl directly, like in testFailingAllocationFailsRemappedPendingSlotRequests?", "url": "https://github.com/apache/flink/pull/12278#discussion_r441359953", "createdAt": "2020-06-17T08:07:18Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImplTest.java", "diffHunk": "@@ -738,6 +740,95 @@ public void testCalculationOfTaskExecutorUtilization() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testOrphanedAllocationCanBeRemapped() throws Exception {\n+\t\ttry (SlotPoolImpl slotPool = createSlotPoolImpl()) {\n+\t\t\tfinal List<AllocationID> allocationIds = new ArrayList<>();\n+\t\t\tresourceManagerGateway.setRequestSlotConsumer(\n+\t\t\t\tslotRequest -> allocationIds.add(slotRequest.getAllocationId()));\n+\n+\t\t\tfinal List<AllocationID> canceledAllocations = new ArrayList<>();\n+\t\t\tresourceManagerGateway.setCancelSlotConsumer(canceledAllocations::add);\n+\n+\t\t\tsetupSlotPool(slotPool, resourceManagerGateway, mainThreadExecutor);\n+\t\t\tfinal Scheduler scheduler = setupScheduler(slotPool, mainThreadExecutor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f5b21017451ccae3811069e6534f3fa8aeaf1ad"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQzMTkzOQ==", "bodyText": "You are right. I have dropped scheduler in the newly added cases.\nHowever, this unnecessary complication is a common problem of most of the SlotPool tests. I think we can simplify them in a separate task as well.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441431939", "createdAt": "2020-06-17T10:03:02Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImplTest.java", "diffHunk": "@@ -738,6 +740,95 @@ public void testCalculationOfTaskExecutorUtilization() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testOrphanedAllocationCanBeRemapped() throws Exception {\n+\t\ttry (SlotPoolImpl slotPool = createSlotPoolImpl()) {\n+\t\t\tfinal List<AllocationID> allocationIds = new ArrayList<>();\n+\t\t\tresourceManagerGateway.setRequestSlotConsumer(\n+\t\t\t\tslotRequest -> allocationIds.add(slotRequest.getAllocationId()));\n+\n+\t\t\tfinal List<AllocationID> canceledAllocations = new ArrayList<>();\n+\t\t\tresourceManagerGateway.setCancelSlotConsumer(canceledAllocations::add);\n+\n+\t\t\tsetupSlotPool(slotPool, resourceManagerGateway, mainThreadExecutor);\n+\t\t\tfinal Scheduler scheduler = setupScheduler(slotPool, mainThreadExecutor);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1OTk1Mw=="}, "originalCommit": {"oid": "4f5b21017451ccae3811069e6534f3fa8aeaf1ad"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0OTgxMzQ3OnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolPendingRequestFailureTest.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwODoxMDo1NlrOGk6m7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMzo0NjoyOVrOGlenJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2MjE1OQ==", "bodyText": "Could we reuse/deduplicate setUpSlotPool also in SlotPoolImplTest?", "url": "https://github.com/apache/flink/pull/12278#discussion_r441362159", "createdAt": "2020-06-17T08:10:56Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolPendingRequestFailureTest.java", "diffHunk": "@@ -99,6 +105,40 @@ public void testFailingAllocationFailsPendingSlotRequests() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testFailingAllocationFailsRemappedPendingSlotRequests() throws Exception {\n+\t\tfinal List<AllocationID> allocations = new ArrayList<>();\n+\t\tresourceManagerGateway.setRequestSlotConsumer(slotRequest -> allocations.add(slotRequest.getAllocationId()));\n+\n+\t\ttry (SlotPoolImpl slotPool = setUpSlotPool()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f5b21017451ccae3811069e6534f3fa8aeaf1ad"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwMDIzNQ==", "bodyText": "It's possible but unrelated. I do not feel like we should cleanup the tests here.\nLike you said, the scheduler might also be not needed. I think it can be a larger task and would be better to be a separate task to fully rework the SlotPoolImpl tests, including those in SlotPoolImplTest, SlotPoolInteractionsTest, SlotPoolSlotSharingTest.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441400235", "createdAt": "2020-06-17T09:11:47Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolPendingRequestFailureTest.java", "diffHunk": "@@ -99,6 +105,40 @@ public void testFailingAllocationFailsPendingSlotRequests() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testFailingAllocationFailsRemappedPendingSlotRequests() throws Exception {\n+\t\tfinal List<AllocationID> allocations = new ArrayList<>();\n+\t\tresourceManagerGateway.setRequestSlotConsumer(slotRequest -> allocations.add(slotRequest.getAllocationId()));\n+\n+\t\ttry (SlotPoolImpl slotPool = setUpSlotPool()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2MjE1OQ=="}, "originalCommit": {"oid": "4f5b21017451ccae3811069e6534f3fa8aeaf1ad"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQxMjQ5Mg==", "bodyText": "Possibly these test classes can share the same test base. So that the util methods and fields can be reused.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441412492", "createdAt": "2020-06-17T09:31:08Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolPendingRequestFailureTest.java", "diffHunk": "@@ -99,6 +105,40 @@ public void testFailingAllocationFailsPendingSlotRequests() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testFailingAllocationFailsRemappedPendingSlotRequests() throws Exception {\n+\t\tfinal List<AllocationID> allocations = new ArrayList<>();\n+\t\tresourceManagerGateway.setRequestSlotConsumer(slotRequest -> allocations.add(slotRequest.getAllocationId()));\n+\n+\t\ttry (SlotPoolImpl slotPool = setUpSlotPool()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2MjE1OQ=="}, "originalCommit": {"oid": "4f5b21017451ccae3811069e6534f3fa8aeaf1ad"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQxMjc0NA==", "bodyText": "I can open a task for it if you feel it is Ok.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441412744", "createdAt": "2020-06-17T09:31:35Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolPendingRequestFailureTest.java", "diffHunk": "@@ -99,6 +105,40 @@ public void testFailingAllocationFailsPendingSlotRequests() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testFailingAllocationFailsRemappedPendingSlotRequests() throws Exception {\n+\t\tfinal List<AllocationID> allocations = new ArrayList<>();\n+\t\tresourceManagerGateway.setRequestSlotConsumer(slotRequest -> allocations.add(slotRequest.getAllocationId()));\n+\n+\t\ttry (SlotPoolImpl slotPool = setUpSlotPool()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2MjE1OQ=="}, "originalCommit": {"oid": "4f5b21017451ccae3811069e6534f3fa8aeaf1ad"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU3NzY5NQ==", "bodyText": "sure, I agree that  we can do the overall test cleanup as a separate issue if it is too much for this PR.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441577695", "createdAt": "2020-06-17T14:13:34Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolPendingRequestFailureTest.java", "diffHunk": "@@ -99,6 +105,40 @@ public void testFailingAllocationFailsPendingSlotRequests() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testFailingAllocationFailsRemappedPendingSlotRequests() throws Exception {\n+\t\tfinal List<AllocationID> allocations = new ArrayList<>();\n+\t\tresourceManagerGateway.setRequestSlotConsumer(slotRequest -> allocations.add(slotRequest.getAllocationId()));\n+\n+\t\ttry (SlotPoolImpl slotPool = setUpSlotPool()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2MjE1OQ=="}, "originalCommit": {"oid": "4f5b21017451ccae3811069e6534f3fa8aeaf1ad"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk1MjAzOQ==", "bodyText": "FLINK-18355 is opened to simplify the tests.", "url": "https://github.com/apache/flink/pull/12278#discussion_r441952039", "createdAt": "2020-06-18T03:46:29Z", "author": {"login": "zhuzhurk"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolPendingRequestFailureTest.java", "diffHunk": "@@ -99,6 +105,40 @@ public void testFailingAllocationFailsPendingSlotRequests() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testFailingAllocationFailsRemappedPendingSlotRequests() throws Exception {\n+\t\tfinal List<AllocationID> allocations = new ArrayList<>();\n+\t\tresourceManagerGateway.setRequestSlotConsumer(slotRequest -> allocations.add(slotRequest.getAllocationId()));\n+\n+\t\ttry (SlotPoolImpl slotPool = setUpSlotPool()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2MjE1OQ=="}, "originalCommit": {"oid": "4f5b21017451ccae3811069e6534f3fa8aeaf1ad"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4542, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}