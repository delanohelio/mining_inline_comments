{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczNzczODAw", "number": 13249, "title": "[FLINK-14087][datastream] Clone the StreamPartitioner to avoid being shared at runtime.", "bodyText": "What is the purpose of the change\nThis PR tries to fix the case that when multiple consumer operators are connected to the same partitioner node, the partitioner would be shared for these consumer operators, thus cause data distributed wrongly.\nTo avoid this issue, we always clone the StreamPartitioner when creating the StreamGraph with the Java internal serializer. The clone would always success since it is also required to deploy the StreamGraph to TaskManagers.\nBrief change log\n\nab39f75 clones the StreamPartitioner for each StreamEdge.\n\nVerifying this change\n(Please pick either of the following options)\nThis change added tests and can be verified as follows:\n\nThis change is tested with UT.\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? not applicable", "createdAt": "2020-08-26T09:22:27Z", "url": "https://github.com/apache/flink/pull/13249", "merged": true, "mergeCommit": {"oid": "d7fe9af0b6caa1c76e811240e53434969be771b1"}, "closed": true, "closedAt": "2020-09-03T14:30:40Z", "author": {"login": "gaoyunhaii"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCooPBABqjM2OTM5NjAzMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFLB4YAH2gAyNDczNzczODAwOjg5NTI1YTc3ODA3OTlkNmFjZjIyMjdiMjI5ZTM1N2MyNmZjMzUzZTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab39f750b7939b089626da89bd21a29e17d98cc3", "author": {"user": {"login": "gaoyunhaii", "name": "Yun Gao"}}, "url": "https://github.com/apache/flink/commit/ab39f750b7939b089626da89bd21a29e17d98cc3", "committedDate": "2020-08-26T08:17:25Z", "message": "[FLINK-14087][datastream] Clone the StreamPartitioner to avoid being shared at runtime."}, "afterCommit": {"oid": "8163b648a532556d5dcac7a13628fd2ac0843b79", "author": {"user": {"login": "gaoyunhaii", "name": "Yun Gao"}}, "url": "https://github.com/apache/flink/commit/8163b648a532556d5dcac7a13628fd2ac0843b79", "committedDate": "2020-08-26T09:44:46Z", "message": "[FLINK-14087][datastream] Clone the StreamPartitioner to avoid being shared at runtime."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MzY3Njg4", "url": "https://github.com/apache/flink/pull/13249#pullrequestreview-475367688", "createdAt": "2020-08-26T10:44:03Z", "commit": {"oid": "8163b648a532556d5dcac7a13628fd2ac0843b79"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxMDo0NDowM1rOHHGYsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxMDo0NDowM1rOHHGYsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzIwNjcwNg==", "bodyText": "shall we name it DataStreamWithSharedPartitionNodeITCase ? I think it is an it test and should be executed with other IT tests.", "url": "https://github.com/apache/flink/pull/13249#discussion_r477206706", "createdAt": "2020-08-26T10:44:03Z", "author": {"login": "dawidwys"}, "path": "flink-tests/src/test/java/org/apache/flink/test/streaming/api/datastream/DataStreamWithSharePartitionNodeTest.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.test.streaming.api.datastream;\n+\n+import org.apache.flink.api.common.functions.Partitioner;\n+import org.apache.flink.runtime.testutils.MiniClusterResourceConfiguration;\n+import org.apache.flink.streaming.api.datastream.DataStream;\n+import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;\n+import org.apache.flink.streaming.api.functions.sink.RichSinkFunction;\n+import org.apache.flink.test.util.MiniClusterWithClientResource;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+\n+import javax.annotation.concurrent.GuardedBy;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+/**\n+ * This tests verifies the data could be partitioned correctly\n+ * if multiple consumers are connected to the same partitioner\n+ * node.\n+ */\n+public class DataStreamWithSharePartitionNodeTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8163b648a532556d5dcac7a13628fd2ac0843b79"}, "originalPosition": 44}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e53b34cb612e02e808008a6792c16fb60ac64e6", "author": {"user": {"login": "gaoyunhaii", "name": "Yun Gao"}}, "url": "https://github.com/apache/flink/commit/6e53b34cb612e02e808008a6792c16fb60ac64e6", "committedDate": "2020-08-26T12:32:40Z", "message": "Fix checkstyle error"}, "afterCommit": {"oid": "4eae231a2cd3edbb2ba34f7bef983f64a4c4fefa", "author": {"user": {"login": "gaoyunhaii", "name": "Yun Gao"}}, "url": "https://github.com/apache/flink/commit/4eae231a2cd3edbb2ba34f7bef983f64a4c4fefa", "committedDate": "2020-08-27T07:42:15Z", "message": "[FLINK-14087][datastream] Clone the StreamPartitioner to avoid being shared at runtime."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07e11ae0c700a4172a854ae4fd108b483bde6003", "author": {"user": {"login": "gaoyunhaii", "name": "Yun Gao"}}, "url": "https://github.com/apache/flink/commit/07e11ae0c700a4172a854ae4fd108b483bde6003", "committedDate": "2020-08-28T03:30:24Z", "message": "[FLINK-14087][datastream] Clone the StreamPartitioner to avoid being shared at runtime."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4eae231a2cd3edbb2ba34f7bef983f64a4c4fefa", "author": {"user": {"login": "gaoyunhaii", "name": "Yun Gao"}}, "url": "https://github.com/apache/flink/commit/4eae231a2cd3edbb2ba34f7bef983f64a4c4fefa", "committedDate": "2020-08-27T07:42:15Z", "message": "[FLINK-14087][datastream] Clone the StreamPartitioner to avoid being shared at runtime."}, "afterCommit": {"oid": "07e11ae0c700a4172a854ae4fd108b483bde6003", "author": {"user": {"login": "gaoyunhaii", "name": "Yun Gao"}}, "url": "https://github.com/apache/flink/commit/07e11ae0c700a4172a854ae4fd108b483bde6003", "committedDate": "2020-08-28T03:30:24Z", "message": "[FLINK-14087][datastream] Clone the StreamPartitioner to avoid being shared at runtime."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NjAwOTUx", "url": "https://github.com/apache/flink/pull/13249#pullrequestreview-479600951", "createdAt": "2020-09-01T10:16:48Z", "commit": {"oid": "07e11ae0c700a4172a854ae4fd108b483bde6003"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMDoxNjo0OFrOHKv1ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMDoxNjo0OFrOHKv1ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAzMTU2Mg==", "bodyText": "In my opinion we should clone the partitioner before configuring it. I think the configure can theoretically initialize some state that is not serializable.", "url": "https://github.com/apache/flink/pull/13249#discussion_r481031562", "createdAt": "2020-09-01T10:16:48Z", "author": {"login": "dawidwys"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java", "diffHunk": "@@ -1180,6 +1181,14 @@ public final CloseableRegistry getCancelables() {\n \t\t\t}\n \t\t}\n \n+\t\t// Clones the partition to avoid multiple stream edges sharing the same stream partitioner,\n+\t\t// like the case of https://issues.apache.org/jira/browse/FLINK-14087.\n+\t\ttry {\n+\t\t\toutputPartitioner = InstantiationUtil.clone(outputPartitioner, Thread.currentThread().getContextClassLoader());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07e11ae0c700a4172a854ae4fd108b483bde6003"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dac56bd078915f2b86835cf5e8cdba3233ee834f", "author": {"user": {"login": "gaoyunhaii", "name": "Yun Gao"}}, "url": "https://github.com/apache/flink/commit/dac56bd078915f2b86835cf5e8cdba3233ee834f", "committedDate": "2020-09-01T17:49:22Z", "message": "Clone the stream partitioner before configuration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNjM5NDQ4", "url": "https://github.com/apache/flink/pull/13249#pullrequestreview-480639448", "createdAt": "2020-09-02T09:22:33Z", "commit": {"oid": "dac56bd078915f2b86835cf5e8cdba3233ee834f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOToyMjozNFrOHLmmIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOToyMjozNFrOHLmmIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkyODczNg==", "bodyText": "I am really sorry for yet another comment, but I've spotted it only now.\nHow about we use the environment.getUserClassLoader() instead of Thread.currentThread().getContextClassLoader()? I think it is safer that way.", "url": "https://github.com/apache/flink/pull/13249#discussion_r481928736", "createdAt": "2020-09-02T09:22:34Z", "author": {"login": "dawidwys"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java", "diffHunk": "@@ -1160,14 +1160,25 @@ public final CloseableRegistry getCancelables() {\n \t\treturn recordWriters;\n \t}\n \n+\t@SuppressWarnings(\"unchecked\")\n \tprivate static <OUT> RecordWriter<SerializationDelegate<StreamRecord<OUT>>> createRecordWriter(\n \t\t\tStreamEdge edge,\n \t\t\tint outputIndex,\n \t\t\tEnvironment environment,\n \t\t\tString taskName,\n \t\t\tlong bufferTimeout) {\n-\t\t@SuppressWarnings(\"unchecked\")\n-\t\tStreamPartitioner<OUT> outputPartitioner = (StreamPartitioner<OUT>) edge.getPartitioner();\n+\n+\t\tStreamPartitioner<OUT> outputPartitioner = null;\n+\n+\t\t// Clones the partition to avoid multiple stream edges sharing the same stream partitioner,\n+\t\t// like the case of https://issues.apache.org/jira/browse/FLINK-14087.\n+\t\ttry {\n+\t\t\toutputPartitioner = InstantiationUtil.clone(\n+\t\t\t\t(StreamPartitioner<OUT>) edge.getPartitioner(),\n+\t\t\t\tThread.currentThread().getContextClassLoader());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dac56bd078915f2b86835cf5e8cdba3233ee834f"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89525a7780799d6acf2227b229e357c26fc353e2", "author": {"user": {"login": "gaoyunhaii", "name": "Yun Gao"}}, "url": "https://github.com/apache/flink/commit/89525a7780799d6acf2227b229e357c26fc353e2", "committedDate": "2020-09-03T06:57:52Z", "message": "Get the classloader from the environment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4751, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}