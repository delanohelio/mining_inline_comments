{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNDM0MTkz", "number": 13640, "title": "[FLINK-19617] Added new metric for monitoring the JVM's Metaspace memory pool usage.", "bodyText": "What is the purpose of the change\nA new metric for monitoring the Metaspace usage needs to be introduced to finish FLIP-102.\nBrief change log\n\nAdded new metric analogous to Heap and NonHeap metric.\nExtended documentation accordingly.\nAdded note to the memory metrics documentation after we ran into problems with IBM's J9 OpenJDK implementation.\nIncluded missing testcase for nonheap metric to check whether the metric's value is not static.\n\nVerifying this change\n\nAdded new tests to MetricUtils to cover the new metric\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): yes\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? yes\nIf yes, how is the feature documented? docs", "createdAt": "2020-10-14T14:52:43Z", "url": "https://github.com/apache/flink/pull/13640", "merged": true, "mergeCommit": {"oid": "c114dd4df7fb91a80a721fe1753b5986ad4e14c2"}, "closed": true, "closedAt": "2020-10-19T09:20:06Z", "author": {"login": "XComp"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSlLDdAFqTUwODgyMzI2Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTE4oCABqjM4ODU5NjM1NDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODIzMjY3", "url": "https://github.com/apache/flink/pull/13640#pullrequestreview-508823267", "createdAt": "2020-10-14T22:46:25Z", "commit": {"oid": "c295945375d779e056cd2503b878c5ea6544a7a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMjo0NjoyNlrOHhpAbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMjo0NjoyNlrOHhpAbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAzNjkwOQ==", "bodyText": "Why not just say that in these cases metrics may not be exposed?", "url": "https://github.com/apache/flink/pull/13640#discussion_r505036909", "createdAt": "2020-10-14T22:46:26Z", "author": {"login": "zentol"}, "path": "docs/monitoring/metrics.md", "diffHunk": "@@ -847,6 +847,8 @@ Thus, in order to infer the metric identifier:\n </table>\n \n ### Memory\n+The memory-related metrics require Oracle's memory management (also included in OpenJDK's Hotspot implementation) to be in place. \n+Other JVM implementations (like IBM's J9) might lead to unexpected behavior.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c295945375d779e056cd2503b878c5ea6544a7a7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODI0MDk4", "url": "https://github.com/apache/flink/pull/13640#pullrequestreview-508824098", "createdAt": "2020-10-14T22:48:28Z", "commit": {"oid": "c295945375d779e056cd2503b878c5ea6544a7a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMjo0ODoyOVrOHhpGFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMjo0ODoyOVrOHhpGFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAzODM1OA==", "bodyText": "We should log a debug message if these nothing is found", "url": "https://github.com/apache/flink/pull/13640#discussion_r505038358", "createdAt": "2020-10-14T22:48:29Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/metrics/util/MetricUtils.java", "diffHunk": "@@ -214,6 +216,15 @@ static void instantiateNonHeapMemoryMetrics(final MetricGroup metricGroup) {\n \t\tinstantiateMemoryUsageMetrics(metricGroup, () -> ManagementFactory.getMemoryMXBean().getNonHeapMemoryUsage());\n \t}\n \n+\t@VisibleForTesting\n+\tstatic void instantiateMetaspaceMemoryMetrics(final MetricGroup metricGroup) {\n+\t\tManagementFactory.getMemoryPoolMXBeans()\n+\t\t\t.stream()\n+\t\t\t.filter(memoryPoolMXBean -> \"Metaspace\".equals(memoryPoolMXBean.getName()))\n+\t\t\t.findFirst()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c295945375d779e056cd2503b878c5ea6544a7a7"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c295945375d779e056cd2503b878c5ea6544a7a7", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/c295945375d779e056cd2503b878c5ea6544a7a7", "committedDate": "2020-10-14T14:27:52Z", "message": "[FLINK][runtime] Extended documentation to cover newly introduced Metaspace metric."}, "afterCommit": {"oid": "f5e746e18b4799208db4ec2954719c27d74df5f5", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/f5e746e18b4799208db4ec2954719c27d74df5f5", "committedDate": "2020-10-15T07:30:18Z", "message": "[FLINK-19617][docs] Extended documentation to cover newly introduced Metaspace metric."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5MjA0MTY2", "url": "https://github.com/apache/flink/pull/13640#pullrequestreview-509204166", "createdAt": "2020-10-15T09:47:22Z", "commit": {"oid": "aa80dacfde367a161ab467905de79dbbeee645ac"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwOTo0NzoyMlrOHh_tzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwOTo0ODozOVrOHh_xsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQwODk3NA==", "bodyText": "I'm fairly sure that this is mostly a theoretical issue; for it to be usable via JMX the MBeans require some unique identification, and according to the MemoryPoolMXBean javadocs the only unique part of the identifier is in fact the name. In other words, multiple pools of this name being present would likely be a bug in the JVM.\nWe can keep this check, but it should be on debug imo.\nIt is also a bit odd to use the metric group name as the pool name, when we used another string for the actual filtering (as in, move \"Metaspace\" into a constant, use that here, and maybe make METRIC_GROUP_METASPACE_NAME an alias for this constant.)", "url": "https://github.com/apache/flink/pull/13640#discussion_r505408974", "createdAt": "2020-10-15T09:47:22Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/metrics/util/MetricUtils.java", "diffHunk": "@@ -214,6 +219,29 @@ static void instantiateNonHeapMemoryMetrics(final MetricGroup metricGroup) {\n \t\tinstantiateMemoryUsageMetrics(metricGroup, () -> ManagementFactory.getMemoryMXBean().getNonHeapMemoryUsage());\n \t}\n \n+\t@VisibleForTesting\n+\tstatic void instantiateMetaspaceMemoryMetrics(final MetricGroup parentMetricGroup) {\n+\t\tfinal List<MemoryPoolMXBean> memoryPoolMXBeans = ManagementFactory.getMemoryPoolMXBeans()\n+\t\t\t.stream()\n+\t\t\t.filter(bean -> \"Metaspace\".equals(bean.getName()))\n+\t\t\t.collect(Collectors.toList());\n+\n+\t\tif (memoryPoolMXBeans.isEmpty()) {\n+\t\t\tLOG.warn(\"No memory pool named 'Metaspace' is present. The '{}' metric group is not going to be instantiated.\", METRIC_GROUP_METASPACE_NAME);\n+\t\t\treturn;\n+\t\t}\n+\n+\t\tfinal MetricGroup metricGroup = parentMetricGroup.addGroup(METRIC_GROUP_METASPACE_NAME);\n+\t\tfinal Iterator<MemoryPoolMXBean> beanIterator = memoryPoolMXBeans.iterator();\n+\n+\t\tfinal MemoryPoolMXBean firstPool = beanIterator.next();\n+\t\tinstantiateMemoryUsageMetrics(metricGroup, firstPool::getUsage);\n+\n+\t\tif (beanIterator.hasNext()) {\n+\t\t\tLOG.warn(\"More than one memory pool named '{}' are present. Only the first pool was used for instantiating the metric.\", METRIC_GROUP_METASPACE_NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa80dacfde367a161ab467905de79dbbeee645ac"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQwOTk3MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tLOG.warn(\"No memory pool named 'Metaspace' is present. The '{}' metric group is not going to be instantiated.\", METRIC_GROUP_METASPACE_NAME);\n          \n          \n            \n            \t\t\tLOG.info(\"Metaspace metrics will not be exposed because no pool named 'Metaspace' could be found. This could be due to the used JVM.\");\n          \n      \n    \n    \n  \n\nUsers typically don't like warning they can't do anything about, and the message is relatively cryptic (\"what is a metric group? what is the consequence of it not being instantiated?\"", "url": "https://github.com/apache/flink/pull/13640#discussion_r505409970", "createdAt": "2020-10-15T09:48:39Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/metrics/util/MetricUtils.java", "diffHunk": "@@ -214,6 +219,29 @@ static void instantiateNonHeapMemoryMetrics(final MetricGroup metricGroup) {\n \t\tinstantiateMemoryUsageMetrics(metricGroup, () -> ManagementFactory.getMemoryMXBean().getNonHeapMemoryUsage());\n \t}\n \n+\t@VisibleForTesting\n+\tstatic void instantiateMetaspaceMemoryMetrics(final MetricGroup parentMetricGroup) {\n+\t\tfinal List<MemoryPoolMXBean> memoryPoolMXBeans = ManagementFactory.getMemoryPoolMXBeans()\n+\t\t\t.stream()\n+\t\t\t.filter(bean -> \"Metaspace\".equals(bean.getName()))\n+\t\t\t.collect(Collectors.toList());\n+\n+\t\tif (memoryPoolMXBeans.isEmpty()) {\n+\t\t\tLOG.warn(\"No memory pool named 'Metaspace' is present. The '{}' metric group is not going to be instantiated.\", METRIC_GROUP_METASPACE_NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa80dacfde367a161ab467905de79dbbeee645ac"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwMzY2MDM0", "url": "https://github.com/apache/flink/pull/13640#pullrequestreview-510366034", "createdAt": "2020-10-16T10:59:19Z", "commit": {"oid": "adb8530ae6bd18071a82319fe9d43aca7b23f5d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMDo1OToxOVrOHi1vnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMDo1OToxOVrOHi1vnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI5NDE3Mg==", "bodyText": "Could we not return this?", "url": "https://github.com/apache/flink/pull/13640#discussion_r506294172", "createdAt": "2020-10-16T10:59:19Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/metrics/util/MetricUtilsTest.java", "diffHunk": "@@ -79,6 +84,23 @@ public void testNonHeapMetricsCompleteness() {\n \t\tAssert.assertNotNull(nonHeapMetrics.get(MetricNames.MEMORY_MAX));\n \t}\n \n+\t@Test\n+\tpublic void testMetaspaceCompleteness() {\n+\t\tfinal InterceptingOperatorMetricGroup metaspaceMetrics = new InterceptingOperatorMetricGroup();\n+\t\tfinal InterceptingOperatorMetricGroup parentMetrics = new InterceptingOperatorMetricGroup() {\n+\t\t\t@Override\n+\t\t\tpublic MetricGroup addGroup(String name) {\n+\t\t\t\treturn metaspaceMetrics;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "adb8530ae6bd18071a82319fe9d43aca7b23f5d4"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwMzY2OTE4", "url": "https://github.com/apache/flink/pull/13640#pullrequestreview-510366918", "createdAt": "2020-10-16T11:00:53Z", "commit": {"oid": "adb8530ae6bd18071a82319fe9d43aca7b23f5d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMTowMDo1M1rOHi10kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMTowMDo1M1rOHi10kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI5NTQ0MA==", "bodyText": "same as above", "url": "https://github.com/apache/flink/pull/13640#discussion_r506295440", "createdAt": "2020-10-16T11:00:53Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/metrics/util/MetricUtilsTest.java", "diffHunk": "@@ -119,4 +141,62 @@ public void testHeapMetrics() throws Exception {\n \t\t}\n \t\tAssert.fail(\"Heap usage metric never changed it's value.\");\n \t}\n+\n+\t@Test\n+\tpublic void testNonHeapMetricUsageNotStatic() throws InterruptedException {\n+\t\tfinal InterceptingOperatorMetricGroup nonHeapMetrics = new InterceptingOperatorMetricGroup();\n+\n+\t\tMetricUtils.instantiateNonHeapMemoryMetrics(nonHeapMetrics);\n+\n+\t\t@SuppressWarnings(\"unchecked\")\n+\t\tfinal Gauge<Long> used = (Gauge<Long>) nonHeapMetrics.get(MetricNames.MEMORY_USED);\n+\n+\t\tfinal long usedNonHeapInitially = used.getValue();\n+\n+\t\t// check memory usage difference multiple times since other tests may affect memory usage as well\n+\t\tfor (int x = 0; x < 10; x++) {\n+\t\t\tfinal ByteBuffer tmpByteBuffer = ByteBuffer.allocateDirect(1024 * 1024 * 8);\n+\t\t\tfinal long usedNonHeapAfterAllocation = used.getValue();\n+\n+\t\t\tif (usedNonHeapInitially != usedNonHeapAfterAllocation) {\n+\t\t\t\treturn;\n+\t\t\t}\n+\t\t\tThread.sleep(50);\n+\t\t}\n+\t\tAssert.fail(\"Non-Heap usage metric never changed it's value.\");\n+\t}\n+\n+\t@Test\n+\tpublic void testMetaspaceMetricUsageNotStatic() throws InterruptedException {\n+\t\tfinal InterceptingOperatorMetricGroup metaspaceMetrics = new InterceptingOperatorMetricGroup();\n+\t\tfinal InterceptingOperatorMetricGroup parentMetrics = new InterceptingOperatorMetricGroup() {\n+\t\t\t@Override\n+\t\t\tpublic MetricGroup addGroup(String name) {\n+\t\t\t\treturn metaspaceMetrics;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "adb8530ae6bd18071a82319fe9d43aca7b23f5d4"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwMzY2OTY2", "url": "https://github.com/apache/flink/pull/13640#pullrequestreview-510366966", "createdAt": "2020-10-16T11:00:59Z", "commit": {"oid": "adb8530ae6bd18071a82319fe9d43aca7b23f5d4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "adb8530ae6bd18071a82319fe9d43aca7b23f5d4", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/adb8530ae6bd18071a82319fe9d43aca7b23f5d4", "committedDate": "2020-10-15T11:37:21Z", "message": "[FLINK-19617][runtime] Fixed log messages."}, "afterCommit": {"oid": "3be4f10f27cb91571c0c96eb522cb4ca66cd2054", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/3be4f10f27cb91571c0c96eb522cb4ca66cd2054", "committedDate": "2020-10-16T11:41:07Z", "message": "[FLINK-19617][runtime] Introduced new metric for monitoring the JVM Metaspace."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb535fe7ac77047fe3ba0991c85620db3a42fb83", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/fb535fe7ac77047fe3ba0991c85620db3a42fb83", "committedDate": "2020-10-16T11:42:31Z", "message": "[hotfix][runtime] Added missing test MetricUtilsTest.testNonHeapMetricUsageNotStatic and renamed testHeapMetric to make it more descriptive."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e957d897105a0bff335d8db266b9bc518942eae1", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/e957d897105a0bff335d8db266b9bc518942eae1", "committedDate": "2020-10-16T11:42:31Z", "message": "[FLINK-19617][runtime] Introduced new metric for monitoring the JVM Metaspace."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3be4f10f27cb91571c0c96eb522cb4ca66cd2054", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/3be4f10f27cb91571c0c96eb522cb4ca66cd2054", "committedDate": "2020-10-16T11:41:07Z", "message": "[FLINK-19617][runtime] Introduced new metric for monitoring the JVM Metaspace."}, "afterCommit": {"oid": "e957d897105a0bff335d8db266b9bc518942eae1", "author": {"user": {"login": "XComp", "name": "Matthias Pohl"}}, "url": "https://github.com/apache/flink/commit/e957d897105a0bff335d8db266b9bc518942eae1", "committedDate": "2020-10-16T11:42:31Z", "message": "[FLINK-19617][runtime] Introduced new metric for monitoring the JVM Metaspace."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3267, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}