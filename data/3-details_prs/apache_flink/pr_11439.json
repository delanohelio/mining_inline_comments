{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMzkwMDM3", "number": 11439, "title": "[FLINK-16650][python] Support LocalZonedTimestampType for Python UDF in blink planner", "bodyText": "What is the purpose of the change\nThis pull request adds support of LocalZonedTimestampType for Python UDF in blink planner.\nBrief change log\n\nUpdate the Python operators to pass the timezone information to the Python process\nAdd support of LocalZonedTimestampType in blink planner\n\nVerifying this change\nThis change added tests and can be verified as follows:\n\nAdded tests test_data_types_only_supported_in_blink_planner in test_udf.py\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (no)\nThe serializers: (no)\nThe runtime per-record code paths (performance sensitive): (no)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (no)\nThe S3 file system connector: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (no)\nIf yes, how is the feature documented? (not applicable)", "createdAt": "2020-03-18T11:52:12Z", "url": "https://github.com/apache/flink/pull/11439", "merged": true, "mergeCommit": {"oid": "5ccb16724769becab0003e0299d9c4a63cd52378"}, "closed": true, "closedAt": "2020-03-20T01:46:37Z", "author": {"login": "dianfu"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcO14UFAH2gAyMzkwMzkwMDM3OmI4YWEyN2VlOTBkYWM5ODIwYzI5NTUxNjQ0NDMxZjAwNDA5NGM1Mjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPIwv7AH2gAyMzkwMzkwMDM3OmUwOTcwM2Y2MTMxOTA5Nzc4NTY4YzE3OTc0ZTI3NWYyMjlhYzZlNjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b8aa27ee90dac9820c29551644431f004094c527", "author": {"user": {"login": "dianfu", "name": "Dian Fu"}}, "url": "https://github.com/apache/flink/commit/b8aa27ee90dac9820c29551644431f004094c527", "committedDate": "2020-03-18T11:47:30Z", "message": "[FLINK-16650][python] Support LocalZonedTimestampType for Python UDF in blink planner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d65c0ec99a4b0ca509ebd83d55a5f9c21aa40db5", "author": {"user": {"login": "dianfu", "name": "Dian Fu"}}, "url": "https://github.com/apache/flink/commit/d65c0ec99a4b0ca509ebd83d55a5f9c21aa40db5", "committedDate": "2020-03-18T15:09:36Z", "message": "fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3Mzk4OTAz", "url": "https://github.com/apache/flink/pull/11439#pullrequestreview-377398903", "createdAt": "2020-03-19T03:26:39Z", "commit": {"oid": "d65c0ec99a4b0ca509ebd83d55a5f9c21aa40db5"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwMzoyNjozOVrOF4e3Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwMzo0MDowMVrOF4fF-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc3MDI2Mw==", "bodyText": "Change to getConfig(planner.getTableConfig)? so that we don't need to change the signature of createPythonOneInputTransformation()", "url": "https://github.com/apache/flink/pull/11439#discussion_r394770263", "createdAt": "2020-03-19T03:26:39Z", "author": {"login": "hequn8128"}, "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/nodes/physical/batch/BatchExecPythonCalc.scala", "diffHunk": "@@ -58,7 +58,7 @@ class BatchExecPythonCalc(\n       inputTransform,\n       calcProgram,\n       \"BatchExecPythonCalc\",\n-      planner.getTableConfig.getConfiguration)\n+      planner.getTableConfig)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d65c0ec99a4b0ca509ebd83d55a5f9c21aa40db5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc3MTk0NQ==", "bodyText": "Take local timezone into consideration? For example, time 0h in Japen should return -1h in China.", "url": "https://github.com/apache/flink/pull/11439#discussion_r394771945", "createdAt": "2020-03-19T03:33:51Z", "author": {"login": "hequn8128"}, "path": "flink-python/pyflink/table/types.py", "diffHunk": "@@ -490,12 +492,20 @@ def need_conversion(self):\n \n     def to_sql_type(self, dt):\n         if dt is not None:\n+            if dt.tzinfo is not None:\n+                offset = dt.utcoffset()\n+                offset = offset if offset else datetime.timedelta()\n+                offset_microseconds =\\\n+                    (offset.days * 86400 + offset.seconds) * 10 ** 6 + offset.microseconds\n+            else:\n+                offset_microseconds = self.EPOCH_ORDINAL\n             seconds = (calendar.timegm(dt.utctimetuple()) if dt.tzinfo\n                        else time.mktime(dt.timetuple()))\n-            return int(seconds) * 10 ** 6 + dt.microsecond\n+            return int(seconds) * 10 ** 6 + dt.microsecond + offset_microseconds", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d65c0ec99a4b0ca509ebd83d55a5f9c21aa40db5"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc3NDAwOQ==", "bodyText": "Add python tests for the coder. e.g. tests in test_coders_common.py.", "url": "https://github.com/apache/flink/pull/11439#discussion_r394774009", "createdAt": "2020-03-19T03:40:01Z", "author": {"login": "hequn8128"}, "path": "flink-python/pyflink/fn_execution/coders.py", "diffHunk": "@@ -377,6 +380,22 @@ def to_type_hint(self):\n         return datetime.datetime\n \n \n+class LocalZonedTimestampCoder(DeterministicCoder):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d65c0ec99a4b0ca509ebd83d55a5f9c21aa40db5"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6a131a49ad032d36abbcf6292a37fe5b83d324b", "author": {"user": {"login": "dianfu", "name": "Dian Fu"}}, "url": "https://github.com/apache/flink/commit/a6a131a49ad032d36abbcf6292a37fe5b83d324b", "committedDate": "2020-03-19T05:43:33Z", "message": "Address review"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "49d8110c15aa07463bf535459eb5fd657603ac10", "author": {"user": {"login": "dianfu", "name": "Dian Fu"}}, "url": "https://github.com/apache/flink/commit/49d8110c15aa07463bf535459eb5fd657603ac10", "committedDate": "2020-03-19T05:37:33Z", "message": "Address review"}, "afterCommit": {"oid": "a6a131a49ad032d36abbcf6292a37fe5b83d324b", "author": {"user": {"login": "dianfu", "name": "Dian Fu"}}, "url": "https://github.com/apache/flink/commit/a6a131a49ad032d36abbcf6292a37fe5b83d324b", "committedDate": "2020-03-19T05:43:33Z", "message": "Address review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7fb7300c3e98559ebf8051b805c06ba95f68446", "author": {"user": {"login": "dianfu", "name": "Dian Fu"}}, "url": "https://github.com/apache/flink/commit/b7fb7300c3e98559ebf8051b805c06ba95f68446", "committedDate": "2020-03-19T07:14:38Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e09703f6131909778568c17974e275f229ac6e66", "author": {"user": {"login": "dianfu", "name": "Dian Fu"}}, "url": "https://github.com/apache/flink/commit/e09703f6131909778568c17974e275f229ac6e66", "committedDate": "2020-03-19T09:47:26Z", "message": "fix tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2855, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}