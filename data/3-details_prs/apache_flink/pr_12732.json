{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3NTE3MjM4", "number": 12732, "title": "[FLINK-18372][runtime] Fix NPE problem when a slot is offered before JM is connected to a RM", "bodyText": "What is the purpose of the change\nThis PR is to fix the NPE problem which can happen when a slot is offered before JM is connected to a RM.\nBrief change log\nSee the commit.\nVerifying this change\n\nAdded unit test for the case that a slot is offered before SlotPool is connected to a RM\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-06-21T08:58:35Z", "url": "https://github.com/apache/flink/pull/12732", "merged": true, "mergeCommit": {"oid": "6d52d0492f9c6655ac95cc34460231376001efa9"}, "closed": true, "closedAt": "2020-06-22T15:47:39Z", "author": {"login": "zhuzhurk"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABctYe40ABqjM0NjUzNDE5NzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABctu4FbABqjM0Njc4MjU2NTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e28cd7873b2886f98562044c5d821fd5b9c1f52", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/8e28cd7873b2886f98562044c5d821fd5b9c1f52", "committedDate": "2020-06-21T08:51:50Z", "message": "[FLINK-18372][runtime] Fix NPE problem when a slot is offered before JM is connected to a RM"}, "afterCommit": {"oid": "e7777affc50bf1433d0aeaad27a285e019fa5f29", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/e7777affc50bf1433d0aeaad27a285e019fa5f29", "committedDate": "2020-06-21T09:03:08Z", "message": "[FLINK-18372][runtime] Fix NPE problem when a slot is offered before JM is connected to a RM"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NzQ3Nzcz", "url": "https://github.com/apache/flink/pull/12732#pullrequestreview-434747773", "createdAt": "2020-06-22T09:20:09Z", "commit": {"oid": "e7777affc50bf1433d0aeaad27a285e019fa5f29"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwOToyMDowOVrOGm4mYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwOToyNDo1OVrOGm4xQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQyNjQwMg==", "bodyText": "I think you could directly ask pendingRequest.getAllocationId(). That way you would not need to query pendingRequests again.", "url": "https://github.com/apache/flink/pull/12732#discussion_r443426402", "createdAt": "2020-06-22T09:20:09Z", "author": {"login": "tillrohrmann"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -561,7 +561,11 @@ private void tryFulfillSlotRequestOrMakeAvailable(AllocatedSlot allocatedSlot) {\n \t\t\tallocatedSlots.add(pendingRequest.getSlotRequestId(), allocatedSlot);\n \t\t\tpendingRequest.getAllocatedSlotFuture().complete(allocatedSlot);\n \n-\t\t\tmaybeRemapOrphanedAllocation(allocationIdOfRequest, allocatedSlot.getAllocationId());\n+\t\t\t// the allocation id can be null if the request was fulfilled by a slot directly offered\n+\t\t\t// by a reconnected TaskExecutor before the ResourceManager is connected\n+\t\t\tif (allocationIdOfRequest != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7777affc50bf1433d0aeaad27a285e019fa5f29"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQyOTE4NA==", "bodyText": "Moreover, there is no invariant which states that pendingRequests contains the mapping. Hence, it would also make sense to directly ask pendingRequest here.", "url": "https://github.com/apache/flink/pull/12732#discussion_r443429184", "createdAt": "2020-06-22T09:24:59Z", "author": {"login": "tillrohrmann"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobmaster/slotpool/SlotPoolImpl.java", "diffHunk": "@@ -561,7 +561,11 @@ private void tryFulfillSlotRequestOrMakeAvailable(AllocatedSlot allocatedSlot) {\n \t\t\tallocatedSlots.add(pendingRequest.getSlotRequestId(), allocatedSlot);\n \t\t\tpendingRequest.getAllocatedSlotFuture().complete(allocatedSlot);\n \n-\t\t\tmaybeRemapOrphanedAllocation(allocationIdOfRequest, allocatedSlot.getAllocationId());\n+\t\t\t// the allocation id can be null if the request was fulfilled by a slot directly offered\n+\t\t\t// by a reconnected TaskExecutor before the ResourceManager is connected\n+\t\t\tif (allocationIdOfRequest != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQyNjQwMg=="}, "originalCommit": {"oid": "e7777affc50bf1433d0aeaad27a285e019fa5f29"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "922cafda024ebd4b1426c8be0404175a443ed017", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/922cafda024ebd4b1426c8be0404175a443ed017", "committedDate": "2020-06-22T10:52:05Z", "message": "[FLINK-18372][runtime] Fix NPE problem when a slot is offered before JM is connected to a RM"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f03311ceaf32aaddf150e96b522f58dfbbebeeb", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/6f03311ceaf32aaddf150e96b522f58dfbbebeeb", "committedDate": "2020-06-22T10:46:19Z", "message": "[hotfix][runtime] Simplify SlotPoolImpl#maybeRemapOrphanedAllocation"}, "afterCommit": {"oid": "16edfbea356cc35919495a13e5f8eda8d0de4961", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/16edfbea356cc35919495a13e5f8eda8d0de4961", "committedDate": "2020-06-22T10:52:06Z", "message": "[hotfix][runtime] Simplify SlotPoolImpl#maybeRemapOrphanedAllocation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "16edfbea356cc35919495a13e5f8eda8d0de4961", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/16edfbea356cc35919495a13e5f8eda8d0de4961", "committedDate": "2020-06-22T10:52:06Z", "message": "[hotfix][runtime] Simplify SlotPoolImpl#maybeRemapOrphanedAllocation"}, "afterCommit": {"oid": "922cafda024ebd4b1426c8be0404175a443ed017", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/922cafda024ebd4b1426c8be0404175a443ed017", "committedDate": "2020-06-22T10:52:05Z", "message": "[FLINK-18372][runtime] Fix NPE problem when a slot is offered before JM is connected to a RM"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3271, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}