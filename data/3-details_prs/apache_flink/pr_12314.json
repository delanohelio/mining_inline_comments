{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyNTU2OTk5", "number": 12314, "title": "[FLINK-17756][table-api-java] Drop table/view shouldn't take effect o\u2026", "bodyText": "\u2026n each other\nThrows exception when we drop table with object identifier that represents a view(and vice versa).", "createdAt": "2020-05-25T05:43:20Z", "url": "https://github.com/apache/flink/pull/12314", "merged": true, "mergeCommit": {"oid": "c8b265456a905b42c53de5dfed5a511ee93f3f8e"}, "closed": true, "closedAt": "2020-05-27T01:51:24Z", "author": {"login": "danny0405"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABckpZm3AH2gAyNDIyNTU2OTk5OmI3YTY4ZjBmMDdhYjliYjJhYmMzMTgyZDcyYzBkYzgwZWQ1OWRkYTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclPTSBgFqTQxODgwNDI4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b7a68f0f07ab9bb2abc3182d72c0dc80ed59dda1", "author": {"user": {"login": "danny0405", "name": "Danny Chan"}}, "url": "https://github.com/apache/flink/commit/b7a68f0f07ab9bb2abc3182d72c0dc80ed59dda1", "committedDate": "2020-05-25T05:41:26Z", "message": "[FLINK-17756][table-api-java] Drop table/view shouldn't take effect on each other"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NDcyOTEz", "url": "https://github.com/apache/flink/pull/12314#pullrequestreview-417472913", "createdAt": "2020-05-25T06:02:30Z", "commit": {"oid": "b7a68f0f07ab9bb2abc3182d72c0dc80ed59dda1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNjowMjozMFrOGZ1kig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNjowMjozMFrOGZ1kig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0NTI5MA==", "bodyText": "Can you move this execute into if (filter.test(result.getTable()))?", "url": "https://github.com/apache/flink/pull/12314#discussion_r429745290", "createdAt": "2020-05-25T06:02:30Z", "author": {"login": "JingsongLi"}, "path": "flink-table/flink-table-api-java/src/main/java/org/apache/flink/table/catalog/CatalogManager.java", "diffHunk": "@@ -682,20 +682,60 @@ public void alterTable(CatalogBaseTable table, ObjectIdentifier objectIdentifier\n \t * Drops a table in a given fully qualified path.\n \t *\n \t * @param objectIdentifier The fully qualified path of the table to drop.\n-\t * @param ignoreIfNotExists If false exception will be thrown if the table or database or catalog to be altered\n+\t * @param ignoreIfNotExists If false exception will be thrown if the table to drop\n \t *                          does not exist.\n \t */\n \tpublic void dropTable(ObjectIdentifier objectIdentifier, boolean ignoreIfNotExists) {\n-\t\tif (temporaryTables.containsKey(objectIdentifier)) {\n-\t\t\tthrow new ValidationException(String.format(\n-\t\t\t\t\"Temporary table with identifier '%s' exists. Drop it first before removing the permanent table.\",\n-\t\t\t\tobjectIdentifier));\n+\t\tdropTableInternal(\n+\t\t\t\tobjectIdentifier,\n+\t\t\t\ttable -> table instanceof CatalogTable,\n+\t\t\t\tignoreIfNotExists);\n+\t}\n+\n+\t/**\n+\t * Drops a view in a given fully qualified path.\n+\t *\n+\t * @param objectIdentifier The fully qualified path of the view to drop.\n+\t * @param ignoreIfNotExists If false exception will be thrown if the view to drop\n+\t *                          does not exist.\n+\t */\n+\tpublic void dropView(ObjectIdentifier objectIdentifier, boolean ignoreIfNotExists) {\n+\t\tdropTableInternal(\n+\t\t\t\tobjectIdentifier,\n+\t\t\t\ttable -> table instanceof CatalogView,\n+\t\t\t\tignoreIfNotExists);\n+\t}\n+\n+\tprivate void dropTableInternal(\n+\t\t\tObjectIdentifier objectIdentifier,\n+\t\t\tPredicate<CatalogBaseTable> filter,\n+\t\t\tboolean ignoreIfNotExists) {\n+\t\tfinal Optional<TableLookupResult> resultOpt = getTable(objectIdentifier);\n+\t\tif (resultOpt.isPresent()) {\n+\t\t\tfinal TableLookupResult result = resultOpt.get();\n+\t\t\tif (filter.test(result.getTable())) {\n+\t\t\t\tif (result.isTemporary()) {\n+\t\t\t\t\t// Same name temporary table or view exists.\n+\t\t\t\t\tthrow new ValidationException(String.format(\n+\t\t\t\t\t\t\t\"Temporary table or view with identifier '%s' exists. \"\n+\t\t\t\t\t\t\t\t\t+ \"Drop it first before removing the permanent table or view.\",\n+\t\t\t\t\t\t\tobjectIdentifier));\n+\t\t\t\t}\n+\t\t\t} else if (!ignoreIfNotExists) {\n+\t\t\t\t// To drop a table but the object identifier represents a view(or vise versa).\n+\t\t\t\tthrow new ValidationException(String.format(\n+\t\t\t\t\t\t\"Table or view with identifier '%s' does not exist.\",\n+\t\t\t\t\t\tobjectIdentifier.asSummaryString()));\n+\t\t\t} else {\n+\t\t\t\t// Table or view does not exist with ignoreIfNotExists true, do nothing.\n+\t\t\t\treturn;\n+\t\t\t}\n \t\t}\n \t\texecute(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7a68f0f07ab9bb2abc3182d72c0dc80ed59dda1"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NDczMTky", "url": "https://github.com/apache/flink/pull/12314#pullrequestreview-417473192", "createdAt": "2020-05-25T06:03:23Z", "commit": {"oid": "b7a68f0f07ab9bb2abc3182d72c0dc80ed59dda1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNjowMzoyM1rOGZ1lgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNjowMzoyM1rOGZ1lgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0NTUzOQ==", "bodyText": "Why not just getPermanentTable? You can keep previous temporaryTables.containsKey(objectIdentifier)", "url": "https://github.com/apache/flink/pull/12314#discussion_r429745539", "createdAt": "2020-05-25T06:03:23Z", "author": {"login": "JingsongLi"}, "path": "flink-table/flink-table-api-java/src/main/java/org/apache/flink/table/catalog/CatalogManager.java", "diffHunk": "@@ -682,20 +682,60 @@ public void alterTable(CatalogBaseTable table, ObjectIdentifier objectIdentifier\n \t * Drops a table in a given fully qualified path.\n \t *\n \t * @param objectIdentifier The fully qualified path of the table to drop.\n-\t * @param ignoreIfNotExists If false exception will be thrown if the table or database or catalog to be altered\n+\t * @param ignoreIfNotExists If false exception will be thrown if the table to drop\n \t *                          does not exist.\n \t */\n \tpublic void dropTable(ObjectIdentifier objectIdentifier, boolean ignoreIfNotExists) {\n-\t\tif (temporaryTables.containsKey(objectIdentifier)) {\n-\t\t\tthrow new ValidationException(String.format(\n-\t\t\t\t\"Temporary table with identifier '%s' exists. Drop it first before removing the permanent table.\",\n-\t\t\t\tobjectIdentifier));\n+\t\tdropTableInternal(\n+\t\t\t\tobjectIdentifier,\n+\t\t\t\ttable -> table instanceof CatalogTable,\n+\t\t\t\tignoreIfNotExists);\n+\t}\n+\n+\t/**\n+\t * Drops a view in a given fully qualified path.\n+\t *\n+\t * @param objectIdentifier The fully qualified path of the view to drop.\n+\t * @param ignoreIfNotExists If false exception will be thrown if the view to drop\n+\t *                          does not exist.\n+\t */\n+\tpublic void dropView(ObjectIdentifier objectIdentifier, boolean ignoreIfNotExists) {\n+\t\tdropTableInternal(\n+\t\t\t\tobjectIdentifier,\n+\t\t\t\ttable -> table instanceof CatalogView,\n+\t\t\t\tignoreIfNotExists);\n+\t}\n+\n+\tprivate void dropTableInternal(\n+\t\t\tObjectIdentifier objectIdentifier,\n+\t\t\tPredicate<CatalogBaseTable> filter,\n+\t\t\tboolean ignoreIfNotExists) {\n+\t\tfinal Optional<TableLookupResult> resultOpt = getTable(objectIdentifier);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7a68f0f07ab9bb2abc3182d72c0dc80ed59dda1"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8180c3272155f8db184013ed79946db1571206e8", "author": {"user": {"login": "danny0405", "name": "Danny Chan"}}, "url": "https://github.com/apache/flink/commit/8180c3272155f8db184013ed79946db1571206e8", "committedDate": "2020-05-25T12:15:11Z", "message": "Fix Jingsong's review comment address"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d0fcabc96b33099fa8413428d30736c3b251fc7", "author": {"user": {"login": "danny0405", "name": "Danny Chan"}}, "url": "https://github.com/apache/flink/commit/6d0fcabc96b33099fa8413428d30736c3b251fc7", "committedDate": "2020-05-25T13:39:35Z", "message": "Fix test faliures"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4ODA0Mjgx", "url": "https://github.com/apache/flink/pull/12314#pullrequestreview-418804281", "createdAt": "2020-05-27T01:50:55Z", "commit": {"oid": "6d0fcabc96b33099fa8413428d30736c3b251fc7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4376, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}