{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3MjE2NDQ2", "number": 11394, "title": "[FLINK-16573] Ensure Kinesis RecordFetcher threads shutdown on cancel", "bodyText": "What is the purpose of the change\nEnsure that the Kinesis RecordFetcher threads shut down on cancel.\nThe threads may not shut down correctly because they do not check for the\nrunning flag in the inner loops. The threads also do not get interrupted because\nthey are not connected to the main task thread.\nThese threads keep lingering around after the job has shut down:\nThread 23168: (state = BLOCKED)\n - java.lang.Object.wait(long) @bci=0 (Compiled frame; information may be imprecise)\n - org.apache.flink.streaming.connectors.kinesis.util.RecordEmitter.emitRecords() @bci=140, line=209 (Compiled frame)\n - org.apache.flink.streaming.connectors.kinesis.util.RecordEmitter.run() @bci=18, line=177 (Interpreted frame)\n - java.lang.Thread.run() @bci=11, line=748 (Compiled frame)\n\nBrief change log\n\nCheck for the running flag in the inner loops which showed up in the stack traces we took\n\nVerifying this change\nI'm going to verify this change on a cluster.", "createdAt": "2020-03-12T12:31:39Z", "url": "https://github.com/apache/flink/pull/11394", "merged": true, "mergeCommit": {"oid": "4da44329e19f0b9bbcd7096b7632bc7b6a663627"}, "closed": true, "closedAt": "2020-03-16T11:44:15Z", "author": {"login": "mxm"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM61teAH2gAyMzg3MjE2NDQ2OjU2OTM1YzAzOWZiNzYzNTc4NGJjYzc2YzlkNTMyMGMwMWRjMjhmMjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNBPh_AFqTM3Mzg1NjYzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "56935c039fb7635784bcc76c9d5320c01dc28f25", "author": {"user": {"login": "mxm", "name": "Maximilian Michels"}}, "url": "https://github.com/apache/flink/commit/56935c039fb7635784bcc76c9d5320c01dc28f25", "committedDate": "2020-03-12T12:26:20Z", "message": "[FLINK-16573] Ensure Kinesis RecordFetcher threads shutdown on cancel\n\nThe threads may not shut down correctly because they do not check for the\nrunning flag in the inner loops. The threads also do not get interrupted because\nthey are not connected to the main task thread.\n\nThese threads keep lingering around after the job has shut down:\n\n```\nThread 23168: (state = BLOCKED)\n - java.lang.Object.wait(long) @bci=0 (Compiled frame; information may be imprecise)\n - org.apache.flink.streaming.connectors.kinesis.util.RecordEmitter.emitRecords() @bci=140, line=209 (Compiled frame)\n - org.apache.flink.streaming.connectors.kinesis.util.RecordEmitter.run() @bci=18, line=177 (Interpreted frame)\n - java.lang.Thread.run() @bci=11, line=748 (Compiled frame)\n```"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczODU2Mjc5", "url": "https://github.com/apache/flink/pull/11394#pullrequestreview-373856279", "createdAt": "2020-03-12T19:53:22Z", "commit": {"oid": "56935c039fb7635784bcc76c9d5320c01dc28f25"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxOTo1MzoyM1rOF1s95Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxOTo1MzoyM1rOF1s95Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg1NTU4OQ==", "bodyText": "This wouldn't be necessary if the thread was interrupted when the fetcher terminates. Once we confirm that this change has the intended effect, let's merge it and cherry-pick into the relevant release branches. I will take a look at improving the thread management in the fetcher as a follow-up.", "url": "https://github.com/apache/flink/pull/11394#discussion_r391855589", "createdAt": "2020-03-12T19:53:23Z", "author": {"login": "tweise"}, "path": "flink-connectors/flink-connector-kinesis/src/main/java/org/apache/flink/streaming/connectors/kinesis/util/RecordEmitter.java", "diffHunk": "@@ -205,6 +205,10 @@ protected void emitRecords() {\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t}\n+\t\t\t\tif (!running) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56935c039fb7635784bcc76c9d5320c01dc28f25"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczODU2NjMz", "url": "https://github.com/apache/flink/pull/11394#pullrequestreview-373856633", "createdAt": "2020-03-12T19:53:58Z", "commit": {"oid": "56935c039fb7635784bcc76c9d5320c01dc28f25"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2739, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}