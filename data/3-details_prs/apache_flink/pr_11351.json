{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1NDA0Njcy", "number": 11351, "title": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment", "bodyText": "What is the purpose of the change\nOne motivation of this issue is for reducing the in-flight data in the case of back pressure to speed up checkpoint. The current default exclusive buffers per channel is 2. If we reduce it to 0 and increase somewhat floating buffers for compensation, it might cause deadlock problem because all the floating buffers might be requested away by some blocked input channels and never recycled until barrier alignment.\nIn order to solve above deadlock concern, we can make some logic changes on both sender and receiver sides.\nSender side: it should revoke previous received credit after sending checkpoint barrier, that means it would not send any following buffers until receiving new credits.\nReceiver side: after processing the barrier from one channel and setting it blocked, it should release the available floating buffers for this blocked channel, and restore requesting floating buffers until barrier alignment. That means the receiver would only announce new credits to sender side after barrier alignment.\nAnother possible benefit to do so is that the floating buffers might be more properly made use of before barrier alignment. We can further verify the performance concern via existing micro-benchmark.\nBrief change log\n\nDownstream always allocate buffers based on the backlog of upstream.\nUpstream blocks output after after sending a checkpoint barrier and at the same time clear the remaining credit.\nDownstream frees all allocated buffers (credit) and never read data from the corresponding channels until the checkpoint completes or is canceled.\nAfter checkpoint completes or is canceled, downstream resume consumption from upstream.\n\nVerifying this change\nThe change is verified by both existing tests and new added tests.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-03-09T06:13:21Z", "url": "https://github.com/apache/flink/pull/11351", "merged": true, "mergeCommit": {"oid": "2e313f026cf3a9e8896cd2816ae5c847894c4fd7"}, "closed": true, "closedAt": "2020-04-27T06:00:54Z", "author": {"login": "wsry"}, "timelineItems": {"totalCount": 148, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWO74zAFqTM5MTM4NjExOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbmFsdgBqjMyNzM3NDQ3OTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzg2MTE4", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-391386118", "createdAt": "2020-04-10T10:56:30Z", "commit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMDo1NjozMFrOGD3icA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMDo1NjozMFrOGD3icA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcwODg0OA==", "bodyText": "why the blocked partition would be pulled buffer since it was unavailable.", "url": "https://github.com/apache/flink/pull/11351#discussion_r406708848", "createdAt": "2020-04-10T10:56:30Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -179,6 +182,10 @@ public void release() {\n \t@Nullable\n \tBufferAndBacklog pollBuffer() {\n \t\tsynchronized (buffers) {\n+\t\t\tif (isBlockedByCheckpoint) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzkwNDc4", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-391390478", "createdAt": "2020-04-10T11:11:11Z", "commit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMToxMToxMVrOGD3xTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMToxMToxMVrOGD3xTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcxMjY1Mg==", "bodyText": "it is ambiguous to distinguish the semantics between isAvailableWithoutCredit and isMoreAvailable if not back to see the implementation. I prefer to using dataAvailable and eventAvailable instead.\nAnd from the outside view, we only provide the isAvailable(int credit) method for hiding the details.", "url": "https://github.com/apache/flink/pull/11351#discussion_r406712652", "createdAt": "2020-04-10T11:11:11Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/ResultSubpartition.java", "diffHunk": "@@ -136,13 +136,13 @@ public void initializeState(ChannelStateReader stateReader) throws IOException,\n \t\tprivate final Buffer buffer;\n \t\tprivate final boolean isMoreAvailable;\n \t\tprivate final int buffersInBacklog;\n-\t\tprivate final boolean nextBufferIsEvent;\n+\t\tprivate final boolean isAvailableWithoutCredit;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzkxNjIz", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-391391623", "createdAt": "2020-04-10T11:14:59Z", "commit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMToxNDo1OVrOGD31Ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMToxNDo1OVrOGD31Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcxMzY4Mg==", "bodyText": "this change worths a separate hotfix commit", "url": "https://github.com/apache/flink/pull/11351#discussion_r406713682", "createdAt": "2020-04-10T11:14:59Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java", "diffHunk": "@@ -883,16 +883,7 @@ private void configureCheckpointing() {\n \n \t\tCheckpointingMode mode = cfg.getCheckpointingMode();\n \n-\t\tboolean isExactlyOnce;\n-\t\tif (mode == CheckpointingMode.EXACTLY_ONCE) {\n-\t\t\tisExactlyOnce = true;\n-\t\t} else if (mode == CheckpointingMode.AT_LEAST_ONCE) {\n-\t\t\tisExactlyOnce = false;\n-\t\t} else {\n-\t\t\tthrow new IllegalStateException(\"Unexpected checkpointing mode. \" +\n-\t\t\t\t\"Did not expect there to be another checkpointing mode besides \" +\n-\t\t\t\t\"exactly-once or at-least-once.\");\n-\t\t}\n+\t\tboolean isExactlyOnce = cfg.isCheckpointingEnabled() && mode == CheckpointingMode.EXACTLY_ONCE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzk4MTg2", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-391398186", "createdAt": "2020-04-10T11:33:56Z", "commit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMTozMzo1N1rOGD4LWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMTozMzo1N1rOGD4LWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcxOTMyMQ==", "bodyText": "nit: Integer -> int", "url": "https://github.com/apache/flink/pull/11351#discussion_r406719321", "createdAt": "2020-04-10T11:33:57Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/CheckpointBarrierAligner.java", "diffHunk": "@@ -318,6 +325,13 @@ public long getAlignmentDurationNanos() {\n \t\t}\n \t}\n \n+\tprivate void unblockCheckpoint(Integer channelToUnblock) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "originalPosition": 185}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTEyMTg1", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-391512185", "createdAt": "2020-04-10T15:45:33Z", "commit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNTo0NTozM1rOGD-Gxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNTo0NTozM1rOGD-Gxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgxNjQ1NQ==", "bodyText": "channelIndexToInputChannel should be protected in sync by requestLock, because in code path this array would be modified by RPC thread via updateInputChannel. Although that method is never invoked in streaming job, it still has the potential risk to break this assumption.", "url": "https://github.com/apache/flink/pull/11351#discussion_r406816455", "createdAt": "2020-04-10T15:45:33Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGate.java", "diffHunk": "@@ -616,6 +622,11 @@ public void sendTaskEvent(TaskEvent event) throws IOException {\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic void unblockCheckpoint(int channelIndex) {\n+\t\tchannelIndexToInputChannel[channelIndex].unblockCheckpoint();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTE0MzI0", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-391514324", "createdAt": "2020-04-10T15:49:41Z", "commit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNTo0OTo0MVrOGD-NzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNTo0OTo0MVrOGD-NzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgxODI1Mg==", "bodyText": "nit: this argument seems redundant because it can be got from channelIndexToInputGate.length", "url": "https://github.com/apache/flink/pull/11351#discussion_r406818252", "createdAt": "2020-04-10T15:49:41Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/CheckpointBarrierAligner.java", "diffHunk": "@@ -69,10 +79,14 @@\n \tCheckpointBarrierAligner(\n \t\t\tint totalNumberOfInputChannels,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTE4OTk1", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-391518995", "createdAt": "2020-04-10T15:58:57Z", "commit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1dd55b189e4e47135083e7f9c7a6893f636c151", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/f1dd55b189e4e47135083e7f9c7a6893f636c151", "committedDate": "2020-04-12T14:18:26Z", "message": "Fixup."}, "afterCommit": {"oid": "3b3428a844d7cb5903f505686881be27970205f0", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/3b3428a844d7cb5903f505686881be27970205f0", "committedDate": "2020-04-13T03:04:02Z", "message": "Fixup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b3428a844d7cb5903f505686881be27970205f0", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/3b3428a844d7cb5903f505686881be27970205f0", "committedDate": "2020-04-13T03:04:02Z", "message": "Fixup."}, "afterCommit": {"oid": "a0c7ff983988f27f5e47f4c71c8fb1ef28f8a24a", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/a0c7ff983988f27f5e47f4c71c8fb1ef28f8a24a", "committedDate": "2020-04-13T03:39:24Z", "message": "Fixup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0c7ff983988f27f5e47f4c71c8fb1ef28f8a24a", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/a0c7ff983988f27f5e47f4c71c8fb1ef28f8a24a", "committedDate": "2020-04-13T03:39:24Z", "message": "Fixup."}, "afterCommit": {"oid": "9673d7ea41a3c7eb78a7e0d723c81086002dcc52", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/9673d7ea41a3c7eb78a7e0d723c81086002dcc52", "committedDate": "2020-04-13T05:19:25Z", "message": "Fixup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9673d7ea41a3c7eb78a7e0d723c81086002dcc52", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/9673d7ea41a3c7eb78a7e0d723c81086002dcc52", "committedDate": "2020-04-13T05:19:25Z", "message": "Fixup."}, "afterCommit": {"oid": "ad77253294c49bf4e967494c3dd520faee6f2033", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/ad77253294c49bf4e967494c3dd520faee6f2033", "committedDate": "2020-04-13T12:47:11Z", "message": "Fixup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad77253294c49bf4e967494c3dd520faee6f2033", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/ad77253294c49bf4e967494c3dd520faee6f2033", "committedDate": "2020-04-13T12:47:11Z", "message": "Fixup."}, "afterCommit": {"oid": "1130ffe32e1f27241f5bf1bd42df0a7c4032a5e0", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/1130ffe32e1f27241f5bf1bd42df0a7c4032a5e0", "committedDate": "2020-04-13T13:36:22Z", "message": "Fixup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1130ffe32e1f27241f5bf1bd42df0a7c4032a5e0", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/1130ffe32e1f27241f5bf1bd42df0a7c4032a5e0", "committedDate": "2020-04-13T13:36:22Z", "message": "Fixup."}, "afterCommit": {"oid": "ad3964bfb00f5b3f93c933ff0d559d9df7d1991c", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/ad3964bfb00f5b3f93c933ff0d559d9df7d1991c", "committedDate": "2020-04-13T13:48:17Z", "message": "Fixup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad3964bfb00f5b3f93c933ff0d559d9df7d1991c", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/ad3964bfb00f5b3f93c933ff0d559d9df7d1991c", "committedDate": "2020-04-13T13:48:17Z", "message": "Fixup."}, "afterCommit": {"oid": "b614959c881f48111893d798a8a0d28a4bbbf44e", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/b614959c881f48111893d798a8a0d28a4bbbf44e", "committedDate": "2020-04-14T06:08:50Z", "message": "Fixup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b614959c881f48111893d798a8a0d28a4bbbf44e", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/b614959c881f48111893d798a8a0d28a4bbbf44e", "committedDate": "2020-04-14T06:08:50Z", "message": "Fixup."}, "afterCommit": {"oid": "f2ba8a55cb8e441a1377b2cc00957e13e7445e47", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/f2ba8a55cb8e441a1377b2cc00957e13e7445e47", "committedDate": "2020-04-15T03:50:00Z", "message": "Fixup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f2ba8a55cb8e441a1377b2cc00957e13e7445e47", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/f2ba8a55cb8e441a1377b2cc00957e13e7445e47", "committedDate": "2020-04-15T03:50:00Z", "message": "Fixup."}, "afterCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/2462af49621e9f2ce29a26879a4b97d4ad752dc2", "committedDate": "2020-04-15T04:02:04Z", "message": "Fixup."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNTQ0Njkz", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-393544693", "createdAt": "2020-04-15T08:05:31Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwODowNTozMVrOGFuZQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwODowNTozMVrOGFuZQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY1NjE5Mg==", "bodyText": "Unify this assert also for above isDataAvailableUnsafe?", "url": "https://github.com/apache/flink/pull/11351#discussion_r408656192", "createdAt": "2020-04-15T08:05:31Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -275,14 +283,24 @@ public PipelinedSubpartitionView createReadView(BufferAvailabilityListener avail\n \t\treturn readView;\n \t}\n \n-\tpublic boolean isAvailable() {\n+\tpublic boolean isAvailable(int numCreditsAvailable) {\n \t\tsynchronized (buffers) {\n-\t\t\treturn isAvailableUnsafe();\n+\t\t\tif (numCreditsAvailable > 0) {\n+\t\t\t\treturn isDataAvailableUnsafe();\n+\t\t\t}\n+\n+\t\t\treturn isEventAvailableUnsafe();\n \t\t}\n \t}\n \n-\tprivate boolean isAvailableUnsafe() {\n-\t\treturn flushRequested || getNumberOfFinishedBuffers() > 0;\n+\tprivate boolean isDataAvailableUnsafe() {\n+\t\treturn !isBlockedByCheckpoint && (flushRequested || getNumberOfFinishedBuffers() > 0);\n+\t}\n+\n+\tprivate boolean isEventAvailableUnsafe() {\n+\t\tassert Thread.holdsLock(buffers);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 93}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNjM3NzQ5", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-393637749", "createdAt": "2020-04-15T10:11:38Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDoxMTozOFrOGFy_EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDoxMTozOFrOGFy_EA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODczMTQwOA==", "bodyText": "nit: better to assert channelIndexToInputChannel[channelIndex] != null in advance and give some rich informations if exception.", "url": "https://github.com/apache/flink/pull/11351#discussion_r408731408", "createdAt": "2020-04-15T10:11:38Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGate.java", "diffHunk": "@@ -616,6 +625,11 @@ public void sendTaskEvent(TaskEvent event) throws IOException {\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic void resumeConsumption(int channelIndex) {\n+\t\tchannelIndexToInputChannel[channelIndex].resumeConsumption();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNjQxNjU5", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-393641659", "createdAt": "2020-04-15T10:17:30Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDoxNzozMFrOGFzLzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDoxNzozMFrOGFzLzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODczNDY3MA==", "bodyText": "@VisibleForTesting", "url": "https://github.com/apache/flink/pull/11351#discussion_r408734670", "createdAt": "2020-04-15T10:17:30Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/UnionInputGate.java", "diffHunk": "@@ -297,4 +312,8 @@ private void queueInputGate(InputGate inputGate) {\n \t\t\treturn Optional.of(inputGate);\n \t\t}\n \t}\n+\n+\tList<InputGate> getChannelIndexToInputGate() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNjQ5NjAw", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-393649600", "createdAt": "2020-04-15T10:29:56Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDoyOTo1NlrOGFzlmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDoyOTo1NlrOGFzlmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0MTI3Mg==", "bodyText": "I guess this channel index change is irrelevant?", "url": "https://github.com/apache/flink/pull/11351#discussion_r408741272", "createdAt": "2020-04-15T10:29:56Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/NettyShuffleEnvironmentTest.java", "diffHunk": "@@ -130,18 +130,18 @@ private void testRegisterTaskWithLimitedBuffers(int bufferPoolSize) throws Excep\n \t\tfinal SingleInputGate[] inputGates = new SingleInputGate[] {ig1, ig2, ig3, ig4};\n \n \t\tcreateRemoteInputChannel(ig4, 0, rp1, connManager, network.getNetworkBufferPool());\n-\t\tcreateRemoteInputChannel(ig4, 0, rp2, connManager, network.getNetworkBufferPool());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNjUyMDU4", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-393652058", "createdAt": "2020-04-15T10:33:44Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDozMzo0NVrOGFztvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDozMzo0NVrOGFztvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0MzM1Nw==", "bodyText": "nit: actually we can still retain testRecycleBuffer(boolean isBuffer) method and get the respective dataType before newBuffer here. Then we can avoid many above changes.", "url": "https://github.com/apache/flink/pull/11351#discussion_r408743357", "createdAt": "2020-04-15T10:33:45Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/buffer/NetworkBufferTest.java", "diffHunk": "@@ -98,79 +98,79 @@ private static NetworkBuffer newBuffer(int length, int maxCapacity, boolean isBu\n \n \t@Test\n \tpublic void testDataBufferIsBuffer() {\n-\t\tassertFalse(newBuffer(1024, 1024, false).isBuffer());\n+\t\tassertFalse(newBuffer(1024, 1024, Buffer.DataType.EVENT_BUFFER).isBuffer());\n \t}\n \n \t@Test\n \tpublic void testEventBufferIsBuffer() {\n-\t\tassertFalse(newBuffer(1024, 1024, false).isBuffer());\n+\t\tassertFalse(newBuffer(1024, 1024, Buffer.DataType.EVENT_BUFFER).isBuffer());\n \t}\n \n \t@Test\n \tpublic void testDataBufferTagAsEvent() {\n-\t\ttestTagAsEvent(true);\n+\t\ttestTagAsEvent(Buffer.DataType.DATA_BUFFER);\n \t}\n \n \t@Test\n \tpublic void testEventBufferTagAsEvent() {\n-\t\ttestTagAsEvent(false);\n+\t\ttestTagAsEvent(Buffer.DataType.EVENT_BUFFER);\n \t}\n \n-\tprivate static void testTagAsEvent(boolean isBuffer) {\n-\t\tNetworkBuffer buffer = newBuffer(1024, 1024, isBuffer);\n-\t\tbuffer.tagAsEvent();\n+\tprivate static void testTagAsEvent(Buffer.DataType dataType) {\n+\t\tNetworkBuffer buffer = newBuffer(1024, 1024, dataType);\n+\t\tbuffer.setDataType(Buffer.DataType.EVENT_BUFFER);\n \t\tassertFalse(buffer.isBuffer());\n \t}\n \n \t@Test\n \tpublic void testDataBufferGetMemorySegment() {\n-\t\ttestGetMemorySegment(true);\n+\t\ttestGetMemorySegment(Buffer.DataType.DATA_BUFFER);\n \t}\n \n \t@Test\n \tpublic void testEventBufferGetMemorySegment() {\n-\t\ttestGetMemorySegment(false);\n+\t\ttestGetMemorySegment(Buffer.DataType.EVENT_BUFFER);\n \t}\n \n-\tprivate static void testGetMemorySegment(boolean isBuffer) {\n+\tprivate static void testGetMemorySegment(Buffer.DataType dataType) {\n \t\tfinal MemorySegment segment = MemorySegmentFactory.allocateUnpooledSegment(1024);\n-\t\tNetworkBuffer buffer = new NetworkBuffer(segment, FreeingBufferRecycler.INSTANCE, isBuffer);\n+\t\tNetworkBuffer buffer = new NetworkBuffer(segment, FreeingBufferRecycler.INSTANCE, dataType);\n \t\tassertSame(segment, buffer.getMemorySegment());\n \t}\n \n \t@Test\n \tpublic void testDataBufferGetRecycler() {\n-\t\ttestGetRecycler(true);\n+\t\ttestGetRecycler(Buffer.DataType.DATA_BUFFER);\n \t}\n \n \t@Test\n \tpublic void testEventBufferGetRecycler() {\n-\t\ttestGetRecycler(false);\n+\t\ttestGetRecycler(Buffer.DataType.EVENT_BUFFER);\n \t}\n \n-\tprivate static void testGetRecycler(boolean isBuffer) {\n+\tprivate static void testGetRecycler(Buffer.DataType dataType) {\n \t\tBufferRecycler recycler = MemorySegment::free;\n \n-\t\tNetworkBuffer dataBuffer = newBuffer(1024, 1024, isBuffer, recycler);\n+\t\tNetworkBuffer dataBuffer = newBuffer(1024, 1024, dataType, recycler);\n \t\tassertSame(recycler, dataBuffer.getRecycler());\n \t}\n \n \t@Test\n \tpublic void testDataBufferRecycleBuffer() {\n-\t\ttestRecycleBuffer(true);\n+\t\ttestRecycleBuffer(Buffer.DataType.DATA_BUFFER);\n \t}\n \n \t@Test\n \tpublic void testEventBufferRecycleBuffer() {\n-\t\ttestRecycleBuffer(false);\n+\t\ttestRecycleBuffer(Buffer.DataType.EVENT_BUFFER);\n \t}\n \n \t/**\n \t * Tests that {@link NetworkBuffer#recycleBuffer()} and {@link NetworkBuffer#isRecycled()} are\n \t * coupled and are also consistent with {@link NetworkBuffer#refCnt()}.\n \t */\n-\tprivate static void testRecycleBuffer(boolean isBuffer) {\n-\t\tNetworkBuffer buffer = newBuffer(1024, 1024, isBuffer);\n+\tprivate static void testRecycleBuffer(Buffer.DataType dataType) {\n+\t\tNetworkBuffer buffer = newBuffer(1024, 1024, dataType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 146}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNjUyMzg4", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-393652388", "createdAt": "2020-04-15T10:34:16Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDozNDoxNlrOGFzu0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDozNDoxNlrOGFzu0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0MzYzNQ==", "bodyText": "ditto", "url": "https://github.com/apache/flink/pull/11351#discussion_r408743635", "createdAt": "2020-04-15T10:34:16Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/buffer/NetworkBufferTest.java", "diffHunk": "@@ -341,16 +341,16 @@ private static void testReadableBytes(boolean isBuffer) {\n \n \t@Test\n \tpublic void testDataBufferGetNioBufferReadable() {\n-\t\ttestGetNioBufferReadable(true);\n+\t\ttestGetNioBufferReadable(Buffer.DataType.DATA_BUFFER);\n \t}\n \n \t@Test\n \tpublic void testEventBufferGetNioBufferReadable() {\n-\t\ttestGetNioBufferReadable(false);\n+\t\ttestGetNioBufferReadable(Buffer.DataType.EVENT_BUFFER);\n \t}\n \n-\tprivate void testGetNioBufferReadable(boolean isBuffer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 319}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNjUzMDM1", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-393653035", "createdAt": "2020-04-15T10:35:19Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDozNToxOVrOGFzwzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMDozNToxOVrOGFzwzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NDE0Mw==", "bodyText": "ditto", "url": "https://github.com/apache/flink/pull/11351#discussion_r408744143", "createdAt": "2020-04-15T10:35:19Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/netty/NettyMessageClientDecoderDelegateTest.java", "diffHunk": "@@ -219,20 +219,17 @@ private void testNettyMessageClientDecoding(\n \tprivate void addBufferResponse(\n \t\tList<NettyMessage> messages,\n \t\tInputChannelID inputChannelId,\n-\t\tboolean isBuffer,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzODU0MjIy", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-393854222", "createdAt": "2020-04-15T14:53:20Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNDo1MzoyMFrOGF9n6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNDo1MzoyMFrOGF9n6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkwNTcwNA==", "bodyText": "\"and after that the buffered elements\" is not invalid", "url": "https://github.com/apache/flink/pull/11351#discussion_r408905704", "createdAt": "2020-04-15T14:53:20Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/MultipleInputStreamTaskTest.java", "diffHunk": "@@ -146,7 +144,6 @@ public void testCheckpointBarriers() throws Exception {\n \n \t\t\t// now we should see the barrier and after that the buffered elements", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzODgzMzc5", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-393883379", "createdAt": "2020-04-15T15:23:40Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNToyMzo0MFrOGF_DPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNToyMzo0MFrOGF_DPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkyOTA4NQ==", "bodyText": "It should be put before testHarness.waitForInputProcessing()", "url": "https://github.com/apache/flink/pull/11351#discussion_r408929085", "createdAt": "2020-04-15T15:23:40Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/OneInputStreamTaskTest.java", "diffHunk": "@@ -464,16 +452,16 @@ public void testOvertakingCheckpointBarriers() throws Exception {\n \t\t// we should not yet see the barrier, only the two elements from non-blocked input\n \t\tTestHarnessUtil.assertOutputEquals(\"Output was not correct.\", expectedOutput, testHarness.getOutput());\n \n-\t\t// Now give a later barrier to all inputs, this should unblock the first channel,\n-\t\t// thereby allowing the two blocked elements through\n-\t\ttestHarness.processEvent(new CheckpointBarrier(1, 1, CheckpointOptions.forCheckpointWithDefaultLocation()), 0, 0);\n+\t\t// Now give a later barrier to all inputs, this should unblock the first channel\n \t\ttestHarness.processEvent(new CheckpointBarrier(1, 1, CheckpointOptions.forCheckpointWithDefaultLocation()), 0, 1);\n \t\ttestHarness.processEvent(new CheckpointBarrier(1, 1, CheckpointOptions.forCheckpointWithDefaultLocation()), 1, 0);\n \t\ttestHarness.processEvent(new CheckpointBarrier(1, 1, CheckpointOptions.forCheckpointWithDefaultLocation()), 1, 1);\n \n+\t\t// wait until the channel is unblocked\n+\t\ttestHarness.waitForInputProcessing();\n+\t\ttestHarness.processEvent(new CheckpointBarrier(1, 1, CheckpointOptions.forCheckpointWithDefaultLocation()), 0, 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzODg0MTE3", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-393884117", "createdAt": "2020-04-15T15:24:27Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNToyNDoyN1rOGF_FlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNToyNDoyN1rOGF_FlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkyOTY4NQ==", "bodyText": "ditto", "url": "https://github.com/apache/flink/pull/11351#discussion_r408929685", "createdAt": "2020-04-15T15:24:27Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/TwoInputStreamTaskTest.java", "diffHunk": "@@ -369,16 +359,16 @@ public void testOvertakingCheckpointBarriers() throws Exception {\n \t\t\t\texpectedOutput,\n \t\t\t\ttestHarness.getOutput());\n \n-\t\t// Now give a later barrier to all inputs, this should unblock the first channel,\n-\t\t// thereby allowing the two blocked elements through\n-\t\ttestHarness.processEvent(new CheckpointBarrier(1, 1, CheckpointOptions.forCheckpointWithDefaultLocation()), 0, 0);\n+\t\t// Now give a later barrier to all inputs, this should unblock the first channel\n \t\ttestHarness.processEvent(new CheckpointBarrier(1, 1, CheckpointOptions.forCheckpointWithDefaultLocation()), 0, 1);\n \t\ttestHarness.processEvent(new CheckpointBarrier(1, 1, CheckpointOptions.forCheckpointWithDefaultLocation()), 1, 0);\n \t\ttestHarness.processEvent(new CheckpointBarrier(1, 1, CheckpointOptions.forCheckpointWithDefaultLocation()), 1, 1);\n \n+\t\t// wait until the channel is unblocked\n+\t\ttestHarness.waitForInputProcessing();\n+\t\ttestHarness.processEvent(new CheckpointBarrier(1, 1, CheckpointOptions.forCheckpointWithDefaultLocation()), 0, 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzOTIyNTA4", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-393922508", "createdAt": "2020-04-15T16:07:31Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNjowNzozMlrOGGA_4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNjowNzozMlrOGGA_4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk2MDk5NA==", "bodyText": "This tests the?", "url": "https://github.com/apache/flink/pull/11351#discussion_r408960994", "createdAt": "2020-04-15T16:07:32Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/CheckpointBarrierAlignerTestBase.java", "diffHunk": "@@ -900,247 +580,185 @@ public void testMultiChannelAbortCheckpoint() throws Exception {\n \t\t\t\t// some buffers and a successful checkpoint\n \t\t\t/* 0 */ createBuffer(0), createBuffer(2), createBuffer(0),\n \t\t\t/* 3 */ createBarrier(1, 1), createBarrier(1, 2),\n-\t\t\t/* 5 */ createBuffer(2), createBuffer(1),\n-\t\t\t/* 7 */ createBarrier(1, 0),\n-\t\t\t/* 8 */ createBuffer(0), createBuffer(2),\n+\t\t\t/* 5 */ createBuffer(0),\n+\t\t\t/* 6 */ createBarrier(1, 0),\n+\t\t\t/* 7 */ createBuffer(0), createBuffer(2),\n \n \t\t\t\t// aborted on last barrier\n-\t\t\t/* 10 */ createBarrier(2, 0), createBarrier(2, 2),\n-\t\t\t/* 12 */ createBuffer(0), createBuffer(2),\n-\t\t\t/* 14 */ createCancellationBarrier(2, 1),\n+\t\t\t/* 9 */  createBarrier(2, 0), createBarrier(2, 2),\n+\t\t\t/* 11 */ createBuffer(1),\n+\t\t\t/* 12 */ createCancellationBarrier(2, 1),\n \n \t\t\t\t// successful checkpoint\n-\t\t\t/* 15 */ createBuffer(2), createBuffer(1),\n-\t\t\t/* 17 */ createBarrier(3, 1), createBarrier(3, 2), createBarrier(3, 0),\n+\t\t\t/* 13 */ createBuffer(2), createBuffer(1),\n+\t\t\t/* 15 */ createBarrier(3, 1), createBarrier(3, 2), createBarrier(3, 0),\n \n \t\t\t\t// abort on first barrier\n-\t\t\t/* 20 */ createBuffer(0), createBuffer(1),\n-\t\t\t/* 22 */ createCancellationBarrier(4, 1), createBarrier(4, 2),\n-\t\t\t/* 24 */ createBuffer(0),\n-\t\t\t/* 25 */ createBarrier(4, 0),\n+\t\t\t/* 18 */ createBuffer(0), createBuffer(1),\n+\t\t\t/* 20 */ createCancellationBarrier(4, 1), createBarrier(4, 2),\n+\t\t\t/* 22 */ createBuffer(2),\n+\t\t\t/* 23 */ createBarrier(4, 0),\n \n \t\t\t\t// another successful checkpoint\n-\t\t\t/* 26 */ createBuffer(0), createBuffer(1), createBuffer(2),\n-\t\t\t/* 29 */ createBarrier(5, 2), createBarrier(5, 1), createBarrier(5, 0),\n-\t\t\t/* 32 */ createBuffer(0), createBuffer(1),\n+\t\t\t/* 24 */ createBuffer(0), createBuffer(1), createBuffer(2),\n+\t\t\t/* 27 */ createBarrier(5, 2), createBarrier(5, 1), createBarrier(5, 0),\n+\t\t\t/* 30 */ createBuffer(0), createBuffer(1),\n \n \t\t\t\t// abort multiple cancellations and a barrier after the cancellations\n-\t\t\t/* 34 */ createCancellationBarrier(6, 1), createCancellationBarrier(6, 2),\n-\t\t\t/* 36 */ createBarrier(6, 0),\n+\t\t\t/* 32 */ createCancellationBarrier(6, 1), createCancellationBarrier(6, 2),\n+\t\t\t/* 34 */ createBarrier(6, 0),\n \n-\t\t\t/* 37 */ createBuffer(0)\n+\t\t\t/* 35 */ createBuffer(0)\n \t\t};\n-\t\tAbstractInvokable toNotify = mock(AbstractInvokable.class);\n+\t\tValidatingCheckpointHandler toNotify = new ValidatingCheckpointHandler();\n \t\tinputGate = createBarrierBuffer(3, sequence, toNotify);\n \n \t\tlong startTs;\n \n \t\t// successful first checkpoint, with some aligned buffers\n+\t\ttoNotify.setNextExpectedCheckpointId(1);\n \t\tcheck(sequence[0], inputGate.pollNext().get(), PAGE_SIZE);\n \t\tcheck(sequence[1], inputGate.pollNext().get(), PAGE_SIZE);\n \t\tcheck(sequence[2], inputGate.pollNext().get(), PAGE_SIZE);\n \t\tstartTs = System.nanoTime();\n \t\tcheck(sequence[5], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tverify(toNotify, times(1)).triggerCheckpointOnBarrier(argThat(new CheckpointMatcher(1L)), any(CheckpointOptions.class), any(CheckpointMetrics.class));\n+\t\tcheck(sequence[7], inputGate.pollNext().get(), PAGE_SIZE);\n \t\tvalidateAlignmentTime(startTs, inputGate);\n+\t\tInteger[] expectedUnblockedChannels1 = new Integer[] {0, 1, 2};\n+\t\tassertArrayEquals(expectedUnblockedChannels1, mockInputGate.getAndResetLastUnblockedChannels().toArray());\n \n-\t\tcheck(sequence[6], inputGate.pollNext().get(), PAGE_SIZE);\n \t\tcheck(sequence[8], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tcheck(sequence[9], inputGate.pollNext().get(), PAGE_SIZE);\n+\t\tcheck(sequence[11], inputGate.pollNext().get(), PAGE_SIZE);\n \n \t\t// canceled checkpoint on last barrier\n-\t\tstartTs = System.nanoTime();\n-\t\tcheck(sequence[12], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tverify(toNotify, times(1)).abortCheckpointOnBarrier(eq(2L),\n-\t\t\targThat(new CheckpointExceptionMatcher(CheckpointFailureReason.CHECKPOINT_DECLINED_ON_CANCELLATION_BARRIER)));\n-\t\tvalidateAlignmentTime(startTs, inputGate);\n \t\tcheck(sequence[13], inputGate.pollNext().get(), PAGE_SIZE);\n+\t\tassertEquals(2, toNotify.getLastCanceledCheckpointId());\n+\t\tInteger[] expectedUnblockedChannels2 = new Integer[] {0, 2};\n+\t\tassertArrayEquals(expectedUnblockedChannels2, mockInputGate.getAndResetLastUnblockedChannels().toArray());\n+\t\tassertEquals(CheckpointFailureReason.CHECKPOINT_DECLINED_ON_CANCELLATION_BARRIER, toNotify.getCheckpointFailureReason());\n+\t\tcheck(sequence[14], inputGate.pollNext().get(), PAGE_SIZE);\n \n \t\t// one more successful checkpoint\n-\t\tcheck(sequence[15], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tcheck(sequence[16], inputGate.pollNext().get(), PAGE_SIZE);\n \t\tstartTs = System.nanoTime();\n-\t\tcheck(sequence[20], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tverify(toNotify, times(1)).triggerCheckpointOnBarrier(argThat(new CheckpointMatcher(3L)), any(CheckpointOptions.class), any(CheckpointMetrics.class));\n+\t\ttoNotify.setNextExpectedCheckpointId(3);\n+\t\tcheck(sequence[18], inputGate.pollNext().get(), PAGE_SIZE);\n \t\tvalidateAlignmentTime(startTs, inputGate);\n-\t\tcheck(sequence[21], inputGate.pollNext().get(), PAGE_SIZE);\n+\t\tInteger[] expectedUnblockedChannels3 = new Integer[] {0, 1, 2};\n+\t\tassertArrayEquals(expectedUnblockedChannels3, mockInputGate.getAndResetLastUnblockedChannels().toArray());\n+\t\tcheck(sequence[19], inputGate.pollNext().get(), PAGE_SIZE);\n \n \t\t// this checkpoint gets immediately canceled\n-\t\tcheck(sequence[24], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tverify(toNotify, times(1)).abortCheckpointOnBarrier(eq(4L),\n-\t\t\targThat(new CheckpointExceptionMatcher(CheckpointFailureReason.CHECKPOINT_DECLINED_ON_CANCELLATION_BARRIER)));\n+\t\tcheck(sequence[22], inputGate.pollNext().get(), PAGE_SIZE);\n+\t\tassertEquals(4, toNotify.getLastCanceledCheckpointId());\n+\t\tassertEquals(CheckpointFailureReason.CHECKPOINT_DECLINED_ON_CANCELLATION_BARRIER, toNotify.getCheckpointFailureReason());\n \t\tassertEquals(0L, inputGate.getAlignmentDurationNanos());\n+\t\tInteger[] expectedUnblockedChannels4 = new Integer[] {2};\n+\t\tassertArrayEquals(expectedUnblockedChannels4, mockInputGate.getAndResetLastUnblockedChannels().toArray());\n \n \t\t// some buffers\n+\t\tcheck(sequence[24], inputGate.pollNext().get(), PAGE_SIZE);\n+\t\tInteger[] expectedUnblockedChannels5 = new Integer[] {0};\n+\t\tassertArrayEquals(expectedUnblockedChannels5, mockInputGate.getAndResetLastUnblockedChannels().toArray());\n+\t\tcheck(sequence[25], inputGate.pollNext().get(), PAGE_SIZE);\n \t\tcheck(sequence[26], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tcheck(sequence[27], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tcheck(sequence[28], inputGate.pollNext().get(), PAGE_SIZE);\n \n \t\t// a simple successful checkpoint\n \t\tstartTs = System.nanoTime();\n-\t\tcheck(sequence[32], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tverify(toNotify, times(1)).triggerCheckpointOnBarrier(argThat(new CheckpointMatcher(5L)), any(CheckpointOptions.class), any(CheckpointMetrics.class));\n-\t\tvalidateAlignmentTime(startTs, inputGate);\n-\t\tcheck(sequence[33], inputGate.pollNext().get(), PAGE_SIZE);\n-\n-\t\tcheck(sequence[37], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tverify(toNotify, times(1)).abortCheckpointOnBarrier(eq(6L),\n-\t\t\targThat(new CheckpointExceptionMatcher(CheckpointFailureReason.CHECKPOINT_DECLINED_ON_CANCELLATION_BARRIER)));\n-\t\tassertEquals(0L, inputGate.getAlignmentDurationNanos());\n-\t}\n-\n-\t@Test\n-\tpublic void testAbortViaQueuedBarriers() throws Exception {\n-\t\tBufferOrEvent[] sequence = {\n-\t\t\t\t// starting a checkpoint\n-\t\t\t/* 0 */ createBuffer(1),\n-\t\t\t/* 1 */ createBarrier(1, 1), createBarrier(1, 2),\n-\t\t\t/* 3 */ createBuffer(2), createBuffer(0), createBuffer(1),\n-\n-\t\t\t\t// queued barrier and cancellation barrier\n-\t\t\t/* 6 */ createCancellationBarrier(2, 2),\n-\t\t\t/* 7 */ createBarrier(2, 1),\n-\n-\t\t\t\t// some intermediate buffers (some queued)\n-\t\t\t/* 8 */ createBuffer(0), createBuffer(1), createBuffer(2),\n-\n-\t\t\t\t// complete initial checkpoint\n-\t\t\t/* 11 */ createBarrier(1, 0),\n-\n-\t\t\t\t// some buffers (none queued, since checkpoint is aborted)\n-\t\t\t/* 12 */ createBuffer(2), createBuffer(1), createBuffer(0),\n-\n-\t\t\t\t// final barrier of aborted checkpoint\n-\t\t\t/* 15 */ createBarrier(2, 0),\n-\n-\t\t\t\t// some more buffers\n-\t\t\t/* 16 */ createBuffer(0), createBuffer(1), createBuffer(2)\n-\t\t};\n-\t\tAbstractInvokable toNotify = mock(AbstractInvokable.class);\n-\t\tinputGate = createBarrierBuffer(3, sequence, toNotify);\n-\n-\t\tlong startTs;\n-\n-\t\tcheck(sequence[0], inputGate.pollNext().get(), PAGE_SIZE);\n-\n-\t\t// starting first checkpoint\n-\t\tstartTs = System.nanoTime();\n-\t\tcheck(sequence[4], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tcheck(sequence[8], inputGate.pollNext().get(), PAGE_SIZE);\n-\n-\t\t// finished first checkpoint\n-\t\tcheck(sequence[3], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tverify(toNotify, times(1)).triggerCheckpointOnBarrier(argThat(new CheckpointMatcher(1L)), any(CheckpointOptions.class), any(CheckpointMetrics.class));\n+\t\ttoNotify.setNextExpectedCheckpointId(5);\n+\t\tcheck(sequence[30], inputGate.pollNext().get(), PAGE_SIZE);\n \t\tvalidateAlignmentTime(startTs, inputGate);\n+\t\tInteger[] expectedUnblockedChannels6 = new Integer[] {0, 1, 2};\n+\t\tassertArrayEquals(expectedUnblockedChannels6, mockInputGate.getAndResetLastUnblockedChannels().toArray());\n+\t\tcheck(sequence[31], inputGate.pollNext().get(), PAGE_SIZE);\n \n-\t\tcheck(sequence[5], inputGate.pollNext().get(), PAGE_SIZE);\n-\n-\t\t// re-read the queued cancellation barriers\n-\t\tcheck(sequence[9], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tverify(toNotify, times(1)).abortCheckpointOnBarrier(eq(2L),\n-\t\t\targThat(new CheckpointExceptionMatcher(CheckpointFailureReason.CHECKPOINT_DECLINED_ON_CANCELLATION_BARRIER)));\n-\t\tassertEquals(0L, inputGate.getAlignmentDurationNanos());\n-\n-\t\tcheck(sequence[10], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tcheck(sequence[12], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tcheck(sequence[13], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tcheck(sequence[14], inputGate.pollNext().get(), PAGE_SIZE);\n-\n-\t\tcheck(sequence[16], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tcheck(sequence[17], inputGate.pollNext().get(), PAGE_SIZE);\n-\t\tcheck(sequence[18], inputGate.pollNext().get(), PAGE_SIZE);\n-\n-\t\t// no further alignment should have happened\n+\t\tcheck(sequence[35], inputGate.pollNext().get(), PAGE_SIZE);\n+\t\tassertEquals(6, toNotify.getLastCanceledCheckpointId());\n+\t\tassertEquals(CheckpointFailureReason.CHECKPOINT_DECLINED_ON_CANCELLATION_BARRIER, toNotify.getCheckpointFailureReason());\n \t\tassertEquals(0L, inputGate.getAlignmentDurationNanos());\n+\t\tInteger[] expectedUnblockedChannels7 = new Integer[] {0};\n+\t\tassertArrayEquals(expectedUnblockedChannels7, mockInputGate.getAndResetLastUnblockedChannels().toArray());\n \n-\t\t// no further checkpoint (abort) notifications\n-\t\tverify(toNotify, times(1)).triggerCheckpointOnBarrier(any(CheckpointMetaData.class), any(CheckpointOptions.class), any(CheckpointMetrics.class));\n-\t\tverify(toNotify, times(1)).abortCheckpointOnBarrier(anyLong(),\n-\t\t\targThat(new CheckpointExceptionMatcher(CheckpointFailureReason.CHECKPOINT_DECLINED_ON_CANCELLATION_BARRIER)));\n+\t\tassertEquals(3, toNotify.getTriggerCheckpointCounter());\n+\t\tassertEquals(3, toNotify.getAbortCheckpointCounter());\n \t}\n \n \t/**\n-\t * This tests the where a replay of queued checkpoint barriers meets\n-\t * a canceled checkpoint.\n+\t * This tests the where a checkpoint barriers meets a canceled checkpoint.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 1085}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzOTI1NDQ4", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-393925448", "createdAt": "2020-04-15T16:11:05Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNjoxMTowNVrOGGBJfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNjoxMTowNVrOGGBJfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk2MzQ1NQ==", "bodyText": "nit: triggeredCheckpointCounter, abortedCheckpointCounter", "url": "https://github.com/apache/flink/pull/11351#discussion_r408963455", "createdAt": "2020-04-15T16:11:05Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/CheckpointBarrierAlignerTestBase.java", "diffHunk": "@@ -1284,8 +902,11 @@ private static void validateAlignmentTime(long alignmentStartTimestamp, Checkpoi\n \t */\n \tprivate static class ValidatingCheckpointHandler extends AbstractInvokable {\n \n+\t\tprivate CheckpointFailureReason failureReason;\n+\t\tprivate long lastCanceledCheckpointId = -1L;\n \t\tprivate long nextExpectedCheckpointId = -1L;\n-\t\tprivate long lastReportedBytesBufferedInAlignment = -1;\n+\t\tprivate long triggerCheckpointCounter = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 1297}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzOTQxODQ1", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-393941845", "createdAt": "2020-04-15T16:31:31Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNjozMTozMVrOGGB9Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNjozMTozMVrOGGB9Zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3Njc0Mw==", "bodyText": "nit: formatting  only make the argument getConfiguration().isExactlyOnceCheckpointMode() as as separate line", "url": "https://github.com/apache/flink/pull/11351#discussion_r408976743", "createdAt": "2020-04-15T16:31:31Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SourceStreamTask.java", "diffHunk": "@@ -89,7 +89,8 @@ public void triggerCheckpoint(long checkpointId) throws FlinkException {\n \t\t\t\t\t// TODO - we need to see how to derive those. We should probably not encode this in the\n \t\t\t\t\t// TODO -   source's trigger message, but do a handshake in this task between the trigger\n \t\t\t\t\t// TODO -   message from the master, and the source's trigger notification\n-\t\t\t\t\tfinal CheckpointOptions checkpointOptions = CheckpointOptions.forCheckpointWithDefaultLocation();\n+\t\t\t\t\tfinal CheckpointOptions checkpointOptions = CheckpointOptions.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0Mjc1MDQz", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-394275043", "createdAt": "2020-04-16T03:29:40Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzoyOTo0MFrOGGTPhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzoyOTo0MFrOGGTPhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI1OTkwOQ==", "bodyText": "it is no need to call finish for this test, otherwise we also need to assert EndofPartitionEvent below.", "url": "https://github.com/apache/flink/pull/11351#discussion_r409259909", "createdAt": "2020-04-16T03:29:40Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartitionWithReadViewTest.java", "diffHunk": "@@ -353,14 +354,32 @@ private void testBacklogConsistentWithNumberOfConsumableBuffers(boolean isFlushR\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testBlockedByCheckpointAndResumeConsumption() throws IOException, InterruptedException {\n+\t\tsubpartition.add(createFilledFinishedBufferConsumer(BUFFER_SIZE));\n+\t\tsubpartition.add(createEventBufferConsumer(BUFFER_SIZE, Buffer.DataType.EXACTLY_ONCE_CHECKPOINT_BARRIER));\n+\t\tsubpartition.add(createEventBufferConsumer(BUFFER_SIZE, Buffer.DataType.EVENT_BUFFER));\n+\t\tsubpartition.add(createFilledFinishedBufferConsumer(BUFFER_SIZE));\n+\t\tsubpartition.finish();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0Mjc1NDY5", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-394275469", "createdAt": "2020-04-16T03:31:12Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzozMToxM1rOGGTQ_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzozMToxM1rOGGTQ_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MDI4NA==", "bodyText": "why we can not verify the real event class here and pass null for all the events, otherwise it is no need to introduce this expectedEventClass argument in assertNextEvent", "url": "https://github.com/apache/flink/pull/11351#discussion_r409260284", "createdAt": "2020-04-16T03:31:13Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartitionWithReadViewTest.java", "diffHunk": "@@ -353,14 +354,32 @@ private void testBacklogConsistentWithNumberOfConsumableBuffers(boolean isFlushR\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testBlockedByCheckpointAndResumeConsumption() throws IOException, InterruptedException {\n+\t\tsubpartition.add(createFilledFinishedBufferConsumer(BUFFER_SIZE));\n+\t\tsubpartition.add(createEventBufferConsumer(BUFFER_SIZE, Buffer.DataType.EXACTLY_ONCE_CHECKPOINT_BARRIER));\n+\t\tsubpartition.add(createEventBufferConsumer(BUFFER_SIZE, Buffer.DataType.EVENT_BUFFER));\n+\t\tsubpartition.add(createFilledFinishedBufferConsumer(BUFFER_SIZE));\n+\t\tsubpartition.finish();\n+\n+\t\tassertNextBuffer(readView, BUFFER_SIZE, true, 1, true, true);\n+\t\tassertNextEvent(readView, BUFFER_SIZE, null, false, 1, false, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0Mjc2NTU5", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-394276559", "createdAt": "2020-04-16T03:35:31Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzozNTozMlrOGGTVAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzozNTozMlrOGGTVAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MTMxMw==", "bodyText": "I guess we also need to supplement the tests for covering the blocked subpartition for flush operation.", "url": "https://github.com/apache/flink/pull/11351#discussion_r409261313", "createdAt": "2020-04-16T03:35:32Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartitionWithReadViewTest.java", "diffHunk": "@@ -353,14 +354,32 @@ private void testBacklogConsistentWithNumberOfConsumableBuffers(boolean isFlushR\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testBlockedByCheckpointAndResumeConsumption() throws IOException, InterruptedException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0Mjc4MTg5", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-394278189", "createdAt": "2020-04-16T03:42:06Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzo0MjowNlrOGGTbJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzo0MjowNlrOGGTbJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2Mjg4Ng==", "bodyText": "Unify the same naming for expectedIsMoreAvailableWithoutCredit as below expectedIsEventAvailable? also for expectedIsMoreAvailable", "url": "https://github.com/apache/flink/pull/11351#discussion_r409262886", "createdAt": "2020-04-16T03:42:06Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartitionWithReadViewTest.java", "diffHunk": "@@ -369,7 +388,7 @@ static void assertNextBuffer(\n \t\t\t\tnull,\n \t\t\t\texpectedIsMoreAvailable,\n \t\t\t\texpectedBuffersInBacklog,\n-\t\t\t\texpectedNextBufferIsEvent,\n+\t\t\t\texpectedIsMoreAvailableWithoutCredit,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 99}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MjgwMDY1", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-394280065", "createdAt": "2020-04-16T03:49:10Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzo0OToxMFrOGGTh_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzo0OToxMFrOGGTh_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2NDYzNg==", "bodyText": "typo adequate?", "url": "https://github.com/apache/flink/pull/11351#discussion_r409264636", "createdAt": "2020-04-16T03:49:10Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/netty/PartitionRequestQueueTest.java", "diffHunk": "@@ -381,6 +387,47 @@ public void testEnqueueReaderByNotifyingBufferAndCredit() throws Exception {\n \t\tassertNull(channel.readOutbound());\n \t}\n \n+\t/**\n+\t * Tests {@link PartitionRequestQueue#enqueueAvailableReader(NetworkSequenceViewReader)},\n+\t * verifying the reader would be enqueued in the pipeline after resuming data consumption if there\n+\t * are credit and data available.\n+\t */\n+\t@Test\n+\tpublic void testEnqueueReaderByResumingConsumption() throws Exception {\n+\t\tPipelinedSubpartition subpartition = PipelinedSubpartitionTest.createPipelinedSubpartition();\n+\t\tsubpartition.add(createEventBufferConsumer(4096, Buffer.DataType.EXACTLY_ONCE_CHECKPOINT_BARRIER));\n+\t\tsubpartition.add(createEventBufferConsumer(4096, Buffer.DataType.DATA_BUFFER));\n+\n+\t\tBufferAvailabilityListener bufferAvailabilityListener = new NoOpBufferAvailablityListener();\n+\t\tPipelinedSubpartitionView view = subpartition.createReadView(bufferAvailabilityListener);\n+\t\tResultPartitionProvider partitionProvider = (partitionId, index, availabilityListener) -> view;\n+\n+\t\tInputChannelID receiverId = new InputChannelID();\n+\t\tPartitionRequestQueue queue = new PartitionRequestQueue();\n+\t\tCreditBasedSequenceNumberingViewReader reader = new CreditBasedSequenceNumberingViewReader(receiverId, 0, queue);\n+\t\tEmbeddedChannel channel = new EmbeddedChannel(queue);\n+\n+\t\treader.requestSubpartitionView(partitionProvider, new ResultPartitionID(), 0);\n+\t\tqueue.notifyReaderCreated(reader);\n+\t\t// we have adequate credits", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 108}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0Mjg3MTY5", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-394287169", "createdAt": "2020-04-16T04:16:54Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNDoxNjo1NFrOGGT8uQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNDoxNjo1NFrOGGT8uQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI3MTQ4MQ==", "bodyText": "is it possible to call inputChannel#resumeConsumption instead of client.resumeConsumption, then we can further verify the interaction between input channel and client.", "url": "https://github.com/apache/flink/pull/11351#discussion_r409271481", "createdAt": "2020-04-16T04:16:54Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/netty/NettyPartitionRequestClientTest.java", "diffHunk": "@@ -142,6 +147,45 @@ public void testDoublePartitionRequest() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testResumeConsumption() throws Exception {\n+\t\tfinal CreditBasedPartitionRequestClientHandler handler = new CreditBasedPartitionRequestClientHandler();\n+\t\tfinal EmbeddedChannel channel = new EmbeddedChannel(handler);\n+\t\tfinal PartitionRequestClient client = createPartitionRequestClient(channel, handler);\n+\n+\t\tfinal NetworkBufferPool networkBufferPool = new NetworkBufferPool(10, 32, 2);\n+\t\tfinal SingleInputGate inputGate = createSingleInputGate(1);\n+\t\tfinal RemoteInputChannel inputChannel = createRemoteInputChannel(inputGate, client, networkBufferPool);\n+\n+\t\ttry {\n+\t\t\tclient.resumeConsumption(inputChannel);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0Mjg3NzU1", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-394287755", "createdAt": "2020-04-16T04:19:21Z", "commit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2462af49621e9f2ce29a26879a4b97d4ad752dc2", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/2462af49621e9f2ce29a26879a4b97d4ad752dc2", "committedDate": "2020-04-15T04:02:04Z", "message": "Fixup."}, "afterCommit": {"oid": "2433d3d69e6e18b138a8672259da42bf619e994e", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/2433d3d69e6e18b138a8672259da42bf619e994e", "committedDate": "2020-04-16T14:12:56Z", "message": "Fixup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2433d3d69e6e18b138a8672259da42bf619e994e", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/2433d3d69e6e18b138a8672259da42bf619e994e", "committedDate": "2020-04-16T14:12:56Z", "message": "Fixup."}, "afterCommit": {"oid": "57564cc22bdc5fb9055a9896fce66bc0305b4e31", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/57564cc22bdc5fb9055a9896fce66bc0305b4e31", "committedDate": "2020-04-16T14:24:39Z", "message": "Fixup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57564cc22bdc5fb9055a9896fce66bc0305b4e31", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/57564cc22bdc5fb9055a9896fce66bc0305b4e31", "committedDate": "2020-04-16T14:24:39Z", "message": "Fixup."}, "afterCommit": {"oid": "3f566d7286ffa73fb26b729d76ccb5129ca3f974", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/3f566d7286ffa73fb26b729d76ccb5129ca3f974", "committedDate": "2020-04-21T06:43:22Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3f566d7286ffa73fb26b729d76ccb5129ca3f974", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/3f566d7286ffa73fb26b729d76ccb5129ca3f974", "committedDate": "2020-04-21T06:43:22Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}, "afterCommit": {"oid": "a11d205402403f51c637b6605e7e97ee98e37151", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/a11d205402403f51c637b6605e7e97ee98e37151", "committedDate": "2020-04-21T07:09:34Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a11d205402403f51c637b6605e7e97ee98e37151", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/a11d205402403f51c637b6605e7e97ee98e37151", "committedDate": "2020-04-21T07:09:34Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}, "afterCommit": {"oid": "f8c88d15d2c173ab2dd0c03b0a6d702d7bcfbf18", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/f8c88d15d2c173ab2dd0c03b0a6d702d7bcfbf18", "committedDate": "2020-04-21T08:31:05Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MTY0MTkz", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-397164193", "createdAt": "2020-04-21T09:42:55Z", "commit": {"oid": "a11d205402403f51c637b6605e7e97ee98e37151"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwOTo0MzoyOVrOGI8sHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwOTo0MzoyOVrOGI8sHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjAzNjEyNQ==", "bodyText": "nit: final", "url": "https://github.com/apache/flink/pull/11351#discussion_r412036125", "createdAt": "2020-04-21T09:43:29Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/api/serialization/EventSerializerTest.java", "diffHunk": "@@ -44,16 +45,16 @@\n  */\n public class EventSerializerTest {\n \n+\tprivate AbstractEvent[] events = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8c88d15d2c173ab2dd0c03b0a6d702d7bcfbf18"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f8c88d15d2c173ab2dd0c03b0a6d702d7bcfbf18", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/f8c88d15d2c173ab2dd0c03b0a6d702d7bcfbf18", "committedDate": "2020-04-21T08:31:05Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}, "afterCommit": {"oid": "da21a760104d6786dcfce33022bd3fd8ce659218", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/da21a760104d6786dcfce33022bd3fd8ce659218", "committedDate": "2020-04-21T13:18:31Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment\n\nThis commit is the first part of implementation to solve the dead lock problem when reducing the exclusive buffer of receiver side to 0.\n\nReducing the number of exclusive buffers of sender side to 0 can bring several advantages (may at the cost of some performance regression). One is that memory can be saved from the reduced network buffer usage. Another important benefit is that the in-flight data can be reduced so we can speed up checkpoint in cases of back pressure. However, for the current implementation, reducing the exclusive buffer of receiver side can incur deadlock problem because all the floating buffers might be requested away by some blocked input channels and never recycled until barrier alignment.\n\nTo solve the problem, this commit mainly makes the following changes:\n1. At sender side, after sending a checkpoint barrier when aligned exactly-once checkpoint mode is used, the outgoing channel will be blocked and no data will be sent out until the channel is unblocked.\n2. At receiver side, no buffer will be stored in BufferStorage any more and after a checkpoint is completed or canceled, the receiver side will resume data consumption and unblock the upstream by sending a special event to the sender side.\n\nNote that after this patch we still can't set the exclusive buffer of receiver side to 0 because there is still deadlock problem which will be totally solved in the following up patches."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da21a760104d6786dcfce33022bd3fd8ce659218", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/da21a760104d6786dcfce33022bd3fd8ce659218", "committedDate": "2020-04-21T13:18:31Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment\n\nThis commit is the first part of implementation to solve the dead lock problem when reducing the exclusive buffer of receiver side to 0.\n\nReducing the number of exclusive buffers of sender side to 0 can bring several advantages (may at the cost of some performance regression). One is that memory can be saved from the reduced network buffer usage. Another important benefit is that the in-flight data can be reduced so we can speed up checkpoint in cases of back pressure. However, for the current implementation, reducing the exclusive buffer of receiver side can incur deadlock problem because all the floating buffers might be requested away by some blocked input channels and never recycled until barrier alignment.\n\nTo solve the problem, this commit mainly makes the following changes:\n1. At sender side, after sending a checkpoint barrier when aligned exactly-once checkpoint mode is used, the outgoing channel will be blocked and no data will be sent out until the channel is unblocked.\n2. At receiver side, no buffer will be stored in BufferStorage any more and after a checkpoint is completed or canceled, the receiver side will resume data consumption and unblock the upstream by sending a special event to the sender side.\n\nNote that after this patch we still can't set the exclusive buffer of receiver side to 0 because there is still deadlock problem which will be totally solved in the following up patches."}, "afterCommit": {"oid": "0058feb1dfb56caaf7e4322948f5b9c05782f8c1", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/0058feb1dfb56caaf7e4322948f5b9c05782f8c1", "committedDate": "2020-04-22T07:09:15Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment\n\nThis commit is the first part of implementation to solve the dead lock problem when reducing the exclusive buffer of receiver side to 0.\n\nReducing the number of exclusive buffers of receiver side to 0 can bring several advantages (may at the cost of some performance regression). One is that memory can be saved from the reduced network buffer usage. Another important benefit is that the in-flight data can be reduced so we can speed up checkpoint in cases of back pressure. However, for the current implementation, reducing the exclusive buffer of receiver side can incur deadlock problem because all the floating buffers might be requested away by some blocked input channels and never recycled until barrier alignment.\n\nTo solve the problem, this commit mainly makes the following changes:\n1. At sender side, after sending a checkpoint barrier when aligned exactly-once checkpoint mode is used, the outgoing channel will be blocked and no data will be sent out until the channel is unblocked.\n2. At receiver side, no buffer will be stored in BufferStorage any more and after a checkpoint is completed or canceled, the receiver side will resume data consumption and unblock the upstream by sending a special event to the sender side.\n\nNote that after this patch we still can't set the exclusive buffer of receiver side to 0 because there is still deadlock problem which will be totally solved in the following up patches."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "725c7e2e4e229cd4a18dab99531ec66457b4ba6d", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/725c7e2e4e229cd4a18dab99531ec66457b4ba6d", "committedDate": "2020-04-27T02:42:56Z", "message": "[hotfix][checkpointing] Make CheckpointBarrierUnaligner#processEndOfPartition always return false\n\nFor unaligned checkpoint, no buffer is stored in BufferStorage so CheckpointBarrierUnaligner#processEndOfPartition should always return false.\n\nThis closes #11351."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d9b20a00c83e8c65904dd9dfc179298481f7759", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/8d9b20a00c83e8c65904dd9dfc179298481f7759", "committedDate": "2020-04-27T02:42:56Z", "message": "[hotfix] Add more information to CheckpointCoordinatorConfiguration#toString\n\nThis closes #11351."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d05bfb1ccc492a22a738da35135e372f7f2c48dc", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/d05bfb1ccc492a22a738da35135e372f7f2c48dc", "committedDate": "2020-04-27T02:42:56Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment\n\nThis commit is the first part of implementation to solve the dead lock problem when reducing the exclusive buffer of receiver side to 0.\n\nReducing the number of exclusive buffers of receiver side to 0 can bring several advantages (may at the cost of some performance regression). One is that memory can be saved from the reduced network buffer usage. Another important benefit is that the in-flight data can be reduced so we can speed up checkpoint in cases of back pressure. However, for the current implementation, reducing the exclusive buffer of receiver side can incur deadlock problem because all the floating buffers might be requested away by some blocked input channels and never recycled until barrier alignment.\n\nTo solve the problem, this commit mainly makes the following changes:\n1. At sender side, after sending a checkpoint barrier when aligned exactly-once checkpoint mode is used, the outgoing channel will be blocked and no data will be sent out until the channel is unblocked.\n2. At receiver side, no buffer will be stored in BufferStorage any more and after a checkpoint is completed or canceled, the receiver side will resume data consumption and unblock the upstream by sending a special event to the sender side.\n\nNote that after this patch we still can't set the exclusive buffer of receiver side to 0 because there is still deadlock problem which will be totally solved in the following up patches."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0058feb1dfb56caaf7e4322948f5b9c05782f8c1", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/0058feb1dfb56caaf7e4322948f5b9c05782f8c1", "committedDate": "2020-04-22T07:09:15Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment\n\nThis commit is the first part of implementation to solve the dead lock problem when reducing the exclusive buffer of receiver side to 0.\n\nReducing the number of exclusive buffers of receiver side to 0 can bring several advantages (may at the cost of some performance regression). One is that memory can be saved from the reduced network buffer usage. Another important benefit is that the in-flight data can be reduced so we can speed up checkpoint in cases of back pressure. However, for the current implementation, reducing the exclusive buffer of receiver side can incur deadlock problem because all the floating buffers might be requested away by some blocked input channels and never recycled until barrier alignment.\n\nTo solve the problem, this commit mainly makes the following changes:\n1. At sender side, after sending a checkpoint barrier when aligned exactly-once checkpoint mode is used, the outgoing channel will be blocked and no data will be sent out until the channel is unblocked.\n2. At receiver side, no buffer will be stored in BufferStorage any more and after a checkpoint is completed or canceled, the receiver side will resume data consumption and unblock the upstream by sending a special event to the sender side.\n\nNote that after this patch we still can't set the exclusive buffer of receiver side to 0 because there is still deadlock problem which will be totally solved in the following up patches."}, "afterCommit": {"oid": "d05bfb1ccc492a22a738da35135e372f7f2c48dc", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/d05bfb1ccc492a22a738da35135e372f7f2c48dc", "committedDate": "2020-04-27T02:42:56Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment\n\nThis commit is the first part of implementation to solve the dead lock problem when reducing the exclusive buffer of receiver side to 0.\n\nReducing the number of exclusive buffers of receiver side to 0 can bring several advantages (may at the cost of some performance regression). One is that memory can be saved from the reduced network buffer usage. Another important benefit is that the in-flight data can be reduced so we can speed up checkpoint in cases of back pressure. However, for the current implementation, reducing the exclusive buffer of receiver side can incur deadlock problem because all the floating buffers might be requested away by some blocked input channels and never recycled until barrier alignment.\n\nTo solve the problem, this commit mainly makes the following changes:\n1. At sender side, after sending a checkpoint barrier when aligned exactly-once checkpoint mode is used, the outgoing channel will be blocked and no data will be sent out until the channel is unblocked.\n2. At receiver side, no buffer will be stored in BufferStorage any more and after a checkpoint is completed or canceled, the receiver side will resume data consumption and unblock the upstream by sending a special event to the sender side.\n\nNote that after this patch we still can't set the exclusive buffer of receiver side to 0 because there is still deadlock problem which will be totally solved in the following up patches."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a599a88c8d07f36ff4c468442692f53a1b5cd507", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/a599a88c8d07f36ff4c468442692f53a1b5cd507", "committedDate": "2020-03-09T04:59:14Z", "message": "POC implementation."}, "afterCommit": {"oid": "715889a35cfcc3aaf1b17f39dadaa86f755cc75d", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/715889a35cfcc3aaf1b17f39dadaa86f755cc75d", "committedDate": "2020-03-09T06:45:35Z", "message": "POC implementation."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "715889a35cfcc3aaf1b17f39dadaa86f755cc75d", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/715889a35cfcc3aaf1b17f39dadaa86f755cc75d", "committedDate": "2020-03-09T06:45:35Z", "message": "POC implementation."}, "afterCommit": {"oid": "5e0b21e2f80bc5c36a535f551b4092d65ecd5b2d", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/5e0b21e2f80bc5c36a535f551b4092d65ecd5b2d", "committedDate": "2020-03-09T11:46:38Z", "message": "Make buffer per incoming/outgoing channel configurable separately."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e0b21e2f80bc5c36a535f551b4092d65ecd5b2d", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/5e0b21e2f80bc5c36a535f551b4092d65ecd5b2d", "committedDate": "2020-03-09T11:46:38Z", "message": "Make buffer per incoming/outgoing channel configurable separately."}, "afterCommit": {"oid": "390cd7b46787bfc633f9389b9ad58e49e6ac5dde", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/390cd7b46787bfc633f9389b9ad58e49e6ac5dde", "committedDate": "2020-03-09T12:44:46Z", "message": "Make buffer per incoming/outgoing channel configurable separately."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "390cd7b46787bfc633f9389b9ad58e49e6ac5dde", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/390cd7b46787bfc633f9389b9ad58e49e6ac5dde", "committedDate": "2020-03-09T12:44:46Z", "message": "Make buffer per incoming/outgoing channel configurable separately."}, "afterCommit": {"oid": "72e2d899c555775ea9c91a34133ea53c1d30b476", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/72e2d899c555775ea9c91a34133ea53c1d30b476", "committedDate": "2020-03-09T12:59:36Z", "message": "Make buffer per incoming/outgoing channel configurable separately."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "72e2d899c555775ea9c91a34133ea53c1d30b476", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/72e2d899c555775ea9c91a34133ea53c1d30b476", "committedDate": "2020-03-09T12:59:36Z", "message": "Make buffer per incoming/outgoing channel configurable separately."}, "afterCommit": {"oid": "75745bb56c70eac5bbb2e5300097bb6a8c7bb59d", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/75745bb56c70eac5bbb2e5300097bb6a8c7bb59d", "committedDate": "2020-03-10T01:08:40Z", "message": "Make buffer per incoming/outgoing channel configurable separately."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "75745bb56c70eac5bbb2e5300097bb6a8c7bb59d", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/75745bb56c70eac5bbb2e5300097bb6a8c7bb59d", "committedDate": "2020-03-10T01:08:40Z", "message": "Make buffer per incoming/outgoing channel configurable separately."}, "afterCommit": {"oid": "548b22258f5e87fd53b45c7f4bb6de40bfd4e6d2", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/548b22258f5e87fd53b45c7f4bb6de40bfd4e6d2", "committedDate": "2020-03-10T01:35:08Z", "message": "Make buffer per incoming/outgoing channel configurable separately."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "548b22258f5e87fd53b45c7f4bb6de40bfd4e6d2", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/548b22258f5e87fd53b45c7f4bb6de40bfd4e6d2", "committedDate": "2020-03-10T01:35:08Z", "message": "Make buffer per incoming/outgoing channel configurable separately."}, "afterCommit": {"oid": "b797d2725d26d67674de8339e6d2714cf5ae98f3", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/b797d2725d26d67674de8339e6d2714cf5ae98f3", "committedDate": "2020-03-10T05:11:46Z", "message": "Make buffer per incoming/outgoing channel configurable separately."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d282e3cb5692915fdd7a45ea5e193feba823c8c3", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/d282e3cb5692915fdd7a45ea5e193feba823c8c3", "committedDate": "2020-03-12T01:40:32Z", "message": "Fix."}, "afterCommit": {"oid": "9dba52d31972da8bc11d85737443253f764c6508", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/9dba52d31972da8bc11d85737443253f764c6508", "committedDate": "2020-03-12T05:36:06Z", "message": "Fix."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9dba52d31972da8bc11d85737443253f764c6508", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/9dba52d31972da8bc11d85737443253f764c6508", "committedDate": "2020-03-12T05:36:06Z", "message": "Fix."}, "afterCommit": {"oid": "00bb983974bea0bed9158d48df1731e16f946495", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/00bb983974bea0bed9158d48df1731e16f946495", "committedDate": "2020-03-12T08:09:13Z", "message": "Fix."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "00bb983974bea0bed9158d48df1731e16f946495", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/00bb983974bea0bed9158d48df1731e16f946495", "committedDate": "2020-03-12T08:09:13Z", "message": "Fix."}, "afterCommit": {"oid": "5397788869b81d0748153365bca510869fcb517a", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/5397788869b81d0748153365bca510869fcb517a", "committedDate": "2020-03-12T10:52:37Z", "message": "Fix."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5397788869b81d0748153365bca510869fcb517a", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/5397788869b81d0748153365bca510869fcb517a", "committedDate": "2020-03-12T10:52:37Z", "message": "Fix."}, "afterCommit": {"oid": "9179aab74eeaf80ea30c0894f3e5a0171338baed", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/9179aab74eeaf80ea30c0894f3e5a0171338baed", "committedDate": "2020-03-12T15:25:59Z", "message": "Fix."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9179aab74eeaf80ea30c0894f3e5a0171338baed", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/9179aab74eeaf80ea30c0894f3e5a0171338baed", "committedDate": "2020-03-12T15:25:59Z", "message": "Fix."}, "afterCommit": {"oid": "b55b4758c11950f6f1458ce707159fa0aca49311", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/b55b4758c11950f6f1458ce707159fa0aca49311", "committedDate": "2020-03-12T15:51:06Z", "message": "Fix."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b55b4758c11950f6f1458ce707159fa0aca49311", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/b55b4758c11950f6f1458ce707159fa0aca49311", "committedDate": "2020-03-12T15:51:06Z", "message": "Fix."}, "afterCommit": {"oid": "7c8f2ea9149fda45a6185323d2ed2312f2999acb", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/7c8f2ea9149fda45a6185323d2ed2312f2999acb", "committedDate": "2020-03-13T01:24:56Z", "message": "Fix."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c8f2ea9149fda45a6185323d2ed2312f2999acb", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/7c8f2ea9149fda45a6185323d2ed2312f2999acb", "committedDate": "2020-03-13T01:24:56Z", "message": "Fix."}, "afterCommit": {"oid": "a90d241233087fe4f3aa753dbf1fe993a4724b3b", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/a90d241233087fe4f3aa753dbf1fe993a4724b3b", "committedDate": "2020-03-13T04:32:55Z", "message": "Fix."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a90d241233087fe4f3aa753dbf1fe993a4724b3b", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/a90d241233087fe4f3aa753dbf1fe993a4724b3b", "committedDate": "2020-03-13T04:32:55Z", "message": "Fix."}, "afterCommit": {"oid": "cd89aaad78cc8d5aaa3189725c8a3a183be23c2c", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/cd89aaad78cc8d5aaa3189725c8a3a183be23c2c", "committedDate": "2020-03-13T06:55:10Z", "message": "Fix."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cd89aaad78cc8d5aaa3189725c8a3a183be23c2c", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/cd89aaad78cc8d5aaa3189725c8a3a183be23c2c", "committedDate": "2020-03-13T06:55:10Z", "message": "Fix."}, "afterCommit": {"oid": "037afa2d30072bcb7822ec2933aac81b7e60a52b", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/037afa2d30072bcb7822ec2933aac81b7e60a52b", "committedDate": "2020-03-18T18:41:11Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "037afa2d30072bcb7822ec2933aac81b7e60a52b", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/037afa2d30072bcb7822ec2933aac81b7e60a52b", "committedDate": "2020-03-18T18:41:11Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}, "afterCommit": {"oid": "eff786e8e89a13d4603daefdbcf841b9bfccf9f5", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/eff786e8e89a13d4603daefdbcf841b9bfccf9f5", "committedDate": "2020-03-19T01:26:32Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eff786e8e89a13d4603daefdbcf841b9bfccf9f5", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/eff786e8e89a13d4603daefdbcf841b9bfccf9f5", "committedDate": "2020-03-19T01:26:32Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}, "afterCommit": {"oid": "659fc3566aa008d1b688d189049add6944fed460", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/659fc3566aa008d1b688d189049add6944fed460", "committedDate": "2020-03-19T03:15:10Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "659fc3566aa008d1b688d189049add6944fed460", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/659fc3566aa008d1b688d189049add6944fed460", "committedDate": "2020-03-19T03:15:10Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}, "afterCommit": {"oid": "7345f2aaac30d38cde01e0e84e7f127287d5c0c6", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/7345f2aaac30d38cde01e0e84e7f127287d5c0c6", "committedDate": "2020-03-19T06:16:04Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7345f2aaac30d38cde01e0e84e7f127287d5c0c6", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/7345f2aaac30d38cde01e0e84e7f127287d5c0c6", "committedDate": "2020-03-19T06:16:04Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}, "afterCommit": {"oid": "e068c1bff7d95844e1e24612abb1e66fc51c7925", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/e068c1bff7d95844e1e24612abb1e66fc51c7925", "committedDate": "2020-03-19T07:59:49Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e068c1bff7d95844e1e24612abb1e66fc51c7925", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/e068c1bff7d95844e1e24612abb1e66fc51c7925", "committedDate": "2020-03-19T07:59:49Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}, "afterCommit": {"oid": "5027d78272e7ff61fb81c07dd3b14da7db0b953d", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/5027d78272e7ff61fb81c07dd3b14da7db0b953d", "committedDate": "2020-03-19T14:55:53Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5027d78272e7ff61fb81c07dd3b14da7db0b953d", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/5027d78272e7ff61fb81c07dd3b14da7db0b953d", "committedDate": "2020-03-19T14:55:53Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}, "afterCommit": {"oid": "618ee8eece00841d86c0566c6e7c68cf0579be9e", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/618ee8eece00841d86c0566c6e7c68cf0579be9e", "committedDate": "2020-03-21T13:27:18Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "618ee8eece00841d86c0566c6e7c68cf0579be9e", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/618ee8eece00841d86c0566c6e7c68cf0579be9e", "committedDate": "2020-03-21T13:27:18Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}, "afterCommit": {"oid": "0a9fd0d3530d2d504d8b535d0892a34a5d2d5e07", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/0a9fd0d3530d2d504d8b535d0892a34a5d2d5e07", "committedDate": "2020-03-22T05:06:03Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a9fd0d3530d2d504d8b535d0892a34a5d2d5e07", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/0a9fd0d3530d2d504d8b535d0892a34a5d2d5e07", "committedDate": "2020-03-22T05:06:03Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}, "afterCommit": {"oid": "cd385c55e9dc111a061e19e2387f2ae9ce21369e", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/cd385c55e9dc111a061e19e2387f2ae9ce21369e", "committedDate": "2020-03-22T05:21:13Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cd385c55e9dc111a061e19e2387f2ae9ce21369e", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/cd385c55e9dc111a061e19e2387f2ae9ce21369e", "committedDate": "2020-03-22T05:21:13Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}, "afterCommit": {"oid": "395bc07a4fca4e2f3ee8b96b4ef8054595227157", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/395bc07a4fca4e2f3ee8b96b4ef8054595227157", "committedDate": "2020-03-22T08:52:35Z", "message": "[FLINK-16404][runtime] Avoid caching buffers for blocked input channels before barrier alignment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MTI1Mzc3", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-379125377", "createdAt": "2020-03-23T04:23:36Z", "commit": {"oid": "395bc07a4fca4e2f3ee8b96b4ef8054595227157"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwNDoyMzozNlrOF52jbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwNDoyMzozNlrOF52jbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIwNjk1Nw==", "bodyText": "This change is irrelated?\nIf so, I suggest not making this change.", "url": "https://github.com/apache/flink/pull/11351#discussion_r396206957", "createdAt": "2020-03-23T04:23:36Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -311,10 +309,13 @@ public void recycle(MemorySegment segment) {\n \t\t\t\t\tExceptionUtils.rethrow(t);\n \t\t\t\t}\n \t\t\t}\n-\t\t\tnumAddedBuffers = bufferQueue.addExclusiveBuffer(new NetworkBuffer(segment, this), numRequiredBuffers);\n+\t\t\tcheckState(!isBlockedByCheckpoint, \"Channel blocked by checkpoint.\");\n+\n+\t\t\tint numAddedBuffers = bufferQueue.addExclusiveBuffer(new NetworkBuffer(segment, this), numRequiredBuffers);\n+\t\t\tnotifyAvailable = numAddedBuffers > 0 && unannouncedCredit++ == 0;\n \t\t}\n \n-\t\tif (numAddedBuffers > 0 && unannouncedCredit.getAndAdd(numAddedBuffers) == 0) {\n+\t\tif (notifyAvailable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "395bc07a4fca4e2f3ee8b96b4ef8054595227157"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MTMwMjc2", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-379130276", "createdAt": "2020-03-23T04:45:07Z", "commit": {"oid": "395bc07a4fca4e2f3ee8b96b4ef8054595227157"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwNDo0NTowN1rOF52zsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwNDo0NTowN1rOF52zsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIxMTEyMA==", "bodyText": "inputChannel ->  optionalInputChannel , irrelated changes, should revert.", "url": "https://github.com/apache/flink/pull/11351#discussion_r396211120", "createdAt": "2020-03-23T04:45:07Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGate.java", "diffHunk": "@@ -507,20 +510,27 @@ public boolean isFinished() {\n \tprivate Optional<InputWithData<InputChannel, BufferAndAvailability>> waitAndGetNextData(boolean blocking)\n \t\t\tthrows IOException, InterruptedException {\n \t\twhile (true) {\n-\t\t\tOptional<InputChannel> inputChannel = getChannel(blocking);\n-\t\t\tif (!inputChannel.isPresent()) {\n+\t\t\tOptional<InputChannel> optionalInputChannel = getChannel(blocking);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "395bc07a4fca4e2f3ee8b96b4ef8054595227157"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MTk2MzY0", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-379196364", "createdAt": "2020-03-23T07:59:21Z", "commit": {"oid": "395bc07a4fca4e2f3ee8b96b4ef8054595227157"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwNzo1OToyMVrOF56FPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwNzo1OToyMVrOF56FPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NDc2NA==", "bodyText": "It is better to reuse the blocked states from CheckpointBarrierAligner if possible to avoid managing it duplicated in another place and causing potential inconsistency.", "url": "https://github.com/apache/flink/pull/11351#discussion_r396264764", "createdAt": "2020-03-23T07:59:21Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGate.java", "diffHunk": "@@ -140,6 +141,8 @@\n \t/** Channels, which notified this input gate about available data. */\n \tprivate final ArrayDeque<InputChannel> inputChannelsWithData = new ArrayDeque<>();\n \n+\tprivate final HashMap<Integer, InputChannel> channelsBlockedByCheckpoint = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "395bc07a4fca4e2f3ee8b96b4ef8054595227157"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MjAyNTI3", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-379202527", "createdAt": "2020-03-23T08:10:28Z", "commit": {"oid": "395bc07a4fca4e2f3ee8b96b4ef8054595227157"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwODoxMDoyOFrOF56YSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwODoxMDoyOFrOF56YSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2OTY0Mw==", "bodyText": "It is tricky to make zero credit has a special meaning, and we also break the previous assumption without negative credits.\nI think it might be better to define a separate message to describe the semantic of barrier alignment to unblock upstream side. Then the credit is always positive to be consistent as before, and we only define another blocked state on upstream side to control the buffer transport besides with positive credits.", "url": "https://github.com/apache/flink/pull/11351#discussion_r396269643", "createdAt": "2020-03-23T08:10:28Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -416,7 +452,18 @@ public int getUnannouncedCredit() {\n \t * @return Credit which was not announced to the sender yet.\n \t */\n \tpublic int getAndResetUnannouncedCredit() {\n-\t\treturn unannouncedCredit.getAndSet(0);\n+\t\tsynchronized (bufferQueue) {\n+\t\t\tint credit = unannouncedCredit;\n+\t\t\tunannouncedCredit = 0;\n+\t\t\tif (credit == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "395bc07a4fca4e2f3ee8b96b4ef8054595227157"}, "originalPosition": 127}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e869d82f1aa639c02af4a82c5026f939bf4e8f6c", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/e869d82f1aa639c02af4a82c5026f939bf4e8f6c", "committedDate": "2020-03-23T10:42:33Z", "message": "Fixup."}, "afterCommit": {"oid": "0603121a692db91a39416b27977843bb7c7db0a7", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/0603121a692db91a39416b27977843bb7c7db0a7", "committedDate": "2020-03-23T10:52:09Z", "message": "Fixup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0603121a692db91a39416b27977843bb7c7db0a7", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/0603121a692db91a39416b27977843bb7c7db0a7", "committedDate": "2020-03-23T10:52:09Z", "message": "Fixup."}, "afterCommit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/47267a0ddd0dd8fded91dc33eeaecac3c83cbb36", "committedDate": "2020-03-23T14:16:19Z", "message": "Fixup."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTgwNTQ0", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-380180544", "createdAt": "2020-03-24T10:32:57Z", "commit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDozMjo1N1rOF6qCqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDozMjo1N1rOF6qCqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA1MDUzNw==", "bodyText": "It seems a bit strange to see this field in BufferConsumer.\nAfter discussing offline, we introduce another enum type for identifying the specific AbstractEvent instance inside Buffer without deserialization. Then the required components can judge the type from buffer to make some improvements. At the beginning we only focus on CheckpointBarrier event and make others unknown.", "url": "https://github.com/apache/flink/pull/11351#discussion_r397050537", "createdAt": "2020-03-24T10:32:57Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/BufferConsumer.java", "diffHunk": "@@ -44,6 +44,8 @@\n \n \tprivate int currentReaderPosition;\n \n+\tprivate final boolean isExactlyOnceBarrier;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMjU5NTUz", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-380259553", "createdAt": "2020-03-24T12:27:30Z", "commit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMjoyNzozMVrOF6t52Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMjoyNzozMVrOF6t52Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzExMzgxNw==", "bodyText": "inputChannels are accessed via synchronized requestLock in other places. Do we need the sync here?", "url": "https://github.com/apache/flink/pull/11351#discussion_r397113817", "createdAt": "2020-03-24T12:27:31Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGate.java", "diffHunk": "@@ -616,6 +628,13 @@ public void sendTaskEvent(TaskEvent event) throws IOException {\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic void onExactlyOnceCheckpointCompletedOrCanceled(long checkpointId) {\n+\t\tfor (InputChannel inputChannel: inputChannels.values()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwODQ2Nzg1", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-380846785", "createdAt": "2020-03-25T04:05:48Z", "commit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDowNTo0OFrOF7Le4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDowNTo0OFrOF7Le4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5ODQzNQ==", "bodyText": "There are five paths for calling notifyCheckpointCompletedOrCanceled in this method, then it is a bit hard to trace every path and analysis whether it needs this call. In contrast, we can analysis this issue from a reverse way to make it easy. E.g. only two paths (begin new alignment and under current alignment) do not need the notify call, so we can make a boolean tag only for these two paths, and handle the unified notification at the end of this method.\nIn detail, we can define a boolean shouldNotify = true at the beginning of this method and also set the notifyCheckpointId = currentCheckpointId. Then tag this boolean as false in below two paths, and finally call notifyCheckpointCompletedOrCanceled at the end of this method if shouldNotify = true.", "url": "https://github.com/apache/flink/pull/11351#discussion_r397598435", "createdAt": "2020-03-25T04:05:48Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/CheckpointBarrierAligner.java", "diffHunk": "@@ -100,21 +105,20 @@ public boolean isBlocked(int channelIndex) {\n \t}\n \n \t@Override\n-\tpublic boolean processBarrier(CheckpointBarrier receivedBarrier, int channelIndex, long bufferedBytes) throws Exception {\n+\tpublic void processBarrier(CheckpointBarrier receivedBarrier, int channelIndex) throws Exception {\n \t\tfinal long barrierId = receivedBarrier.getId();\n \n \t\t// fast path for single channel cases\n \t\tif (totalNumberOfInputChannels == 1) {\n \t\t\tif (barrierId > currentCheckpointId) {\n \t\t\t\t// new checkpoint\n \t\t\t\tcurrentCheckpointId = barrierId;\n-\t\t\t\tnotifyCheckpoint(receivedBarrier, bufferedBytes, latestAlignmentDurationNanos);\n+\t\t\t\tnotifyCheckpoint(receivedBarrier, latestAlignmentDurationNanos);\n \t\t\t}\n-\t\t\treturn false;\n+\t\t\tnotifyCheckpointCompletedOrCanceled(barrierId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwODQ3Mzkz", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-380847393", "createdAt": "2020-03-25T04:08:29Z", "commit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDowODoyOVrOF7LhCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDowODoyOVrOF7LhCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5ODk4NQ==", "bodyText": "we can reduce this path for simple by https://github.com/apache/flink/pull/11351/files#r397598435", "url": "https://github.com/apache/flink/pull/11351#discussion_r397598985", "createdAt": "2020-03-25T04:08:29Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/CheckpointBarrierAligner.java", "diffHunk": "@@ -140,14 +144,15 @@ else if (barrierId > currentCheckpointId) {\n \n \t\t\t\t// abort the current checkpoint\n \t\t\t\treleaseBlocksAndResetBarriers();\n-\t\t\t\tcheckpointAborted = true;\n+\t\t\t\tnotifyCheckpointCompletedOrCanceled(currentCheckpointId);\n \n \t\t\t\t// begin a new checkpoint\n \t\t\t\tbeginNewAlignment(barrierId, channelIndex, receivedBarrier.getTimestamp());\n \t\t\t}\n \t\t\telse {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwODQ3NDY5", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-380847469", "createdAt": "2020-03-25T04:08:45Z", "commit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDowODo0NlrOF7LhXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDowODo0NlrOF7LhXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5OTA2OA==", "bodyText": "we can also reduce this path for simple by https://github.com/apache/flink/pull/11351/files#r397598435", "url": "https://github.com/apache/flink/pull/11351#discussion_r397599068", "createdAt": "2020-03-25T04:08:46Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/CheckpointBarrierAligner.java", "diffHunk": "@@ -157,7 +162,8 @@ else if (barrierId > currentCheckpointId) {\n \t\telse {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwODQ3ODk3", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-380847897", "createdAt": "2020-03-25T04:10:21Z", "commit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDoxMDoyMVrOF7Li9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDoxMDoyMVrOF7Li9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5OTQ3OQ==", "bodyText": "Refer to this idea https://github.com/apache/flink/pull/11351/files#r397598435, we can also avoid calling notifyCheckpointCompletedOrCanceled in five paths.", "url": "https://github.com/apache/flink/pull/11351#discussion_r397599479", "createdAt": "2020-03-25T04:10:21Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/CheckpointBarrierAligner.java", "diffHunk": "@@ -214,7 +219,7 @@ protected void onBarrier(int channelIndex) throws IOException {\n \t}\n \n \t@Override\n-\tpublic boolean processCancellationBarrier(CancelCheckpointMarker cancelBarrier) throws Exception {\n+\tpublic void processCancellationBarrier(CancelCheckpointMarker cancelBarrier) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwODQ4MTU0", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-380848154", "createdAt": "2020-03-25T04:11:26Z", "commit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDoxMToyN1rOF7Ljzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDoxMToyN1rOF7Ljzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5OTY5NA==", "bodyText": "nit: should be private method.", "url": "https://github.com/apache/flink/pull/11351#discussion_r397599694", "createdAt": "2020-03-25T04:11:27Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/CheckpointBarrierAligner.java", "diffHunk": "@@ -318,6 +326,16 @@ public long getAlignmentDurationNanos() {\n \t\t}\n \t}\n \n+\tpublic void registerInputGate(CheckpointedInputGate inputGate) {\n+\t\tinputGates.add(checkNotNull(inputGate));\n+\t}\n+\n+\tpublic void notifyCheckpointCompletedOrCanceled(long checkpointId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "originalPosition": 166}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwODQ5NDI0", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-380849424", "createdAt": "2020-03-25T04:16:56Z", "commit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDoxNjo1NlrOF7Lotg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDoxNjo1NlrOF7Lotg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYwMDk1MA==", "bodyText": "I am considering the call sequence for notifyCheckpoint and notifyCheckpointCompletedOrCanceled.\nnotifyCheckpoint might take some time for local IO operations I guess. If we can notifyCheckpointCompletedOrCanceled beforehand to unblock upstream to send data, then it might get benefit for performance.", "url": "https://github.com/apache/flink/pull/11351#discussion_r397600950", "createdAt": "2020-03-25T04:16:56Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/CheckpointBarrierAligner.java", "diffHunk": "@@ -172,10 +178,9 @@ else if (barrierId > currentCheckpointId) {\n \t\t\t}\n \n \t\t\treleaseBlocksAndResetBarriers();\n-\t\t\tnotifyCheckpoint(receivedBarrier, bufferedBytes, latestAlignmentDurationNanos);\n-\t\t\treturn true;\n+\t\t\tnotifyCheckpoint(receivedBarrier, latestAlignmentDurationNanos);\n+\t\t\tnotifyCheckpointCompletedOrCanceled(barrierId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwODUxMDcx", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-380851071", "createdAt": "2020-03-25T04:24:00Z", "commit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDoyNDowMFrOF7Lu4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDoyNDowMFrOF7Lu4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYwMjUyOQ==", "bodyText": "Another option is passing inputGate in constructor instead to avoid exposing another methods outside. Otherwise in tests if someone constructs the CheckpointBarrierAligner, but forgets to register gate afterwards, then the gates are actually touched in the internal related processes to bring unexpected behaviors.", "url": "https://github.com/apache/flink/pull/11351#discussion_r397602529", "createdAt": "2020-03-25T04:24:00Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/CheckpointBarrierAligner.java", "diffHunk": "@@ -318,6 +326,16 @@ public long getAlignmentDurationNanos() {\n \t\t}\n \t}\n \n+\tpublic void registerInputGate(CheckpointedInputGate inputGate) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "originalPosition": 162}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwODUxNzEy", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-380851712", "createdAt": "2020-03-25T04:26:52Z", "commit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDoyNjo1M1rOF7LxXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDoyNjo1M1rOF7LxXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYwMzE2Nw==", "bodyText": "we can avoid introducing the interface method and this empty implementation by https://github.com/apache/flink/pull/11351/files#r397602529", "url": "https://github.com/apache/flink/pull/11351#discussion_r397603167", "createdAt": "2020-03-25T04:26:53Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/CheckpointBarrierTracker.java", "diffHunk": "@@ -230,8 +227,7 @@ public long getAlignmentDurationNanos() {\n \t}\n \n \t@Override\n-\tpublic void checkpointSizeLimitExceeded(long maxBufferedBytes) throws Exception {\n-\t\tthrow new UnsupportedOperationException(\"This should never happened as this class doesn't block any data\");\n+\tpublic void registerInputGate(CheckpointedInputGate inputGate) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwODU0NjI5", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-380854629", "createdAt": "2020-03-25T04:40:02Z", "commit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDo0MDowM1rOF7L77g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDo0MDowM1rOF7L77g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYwNTg3MA==", "bodyText": "We can also avoid this synchronized after removing states by #11351 (comment)", "url": "https://github.com/apache/flink/pull/11351#discussion_r397605870", "createdAt": "2020-03-25T04:40:03Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -397,6 +409,17 @@ public void notifyBufferDestroyed() {\n \t\t// Nothing to do actually.\n \t}\n \n+\t@Override\n+\tpublic void onExactlyOnceCheckpointCompletedOrCanceled(long checkpointId) {\n+\t\tsynchronized (bufferQueue) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwODU0Nzk2", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-380854796", "createdAt": "2020-03-25T04:40:49Z", "commit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDo0MDo1MFrOF7L8kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNDo0MDo1MFrOF7L8kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYwNjAzNA==", "bodyText": "if (isBlockedByCheckpoint(checkpointId)) {\n    notifyResumeConsumption()\n}", "url": "https://github.com/apache/flink/pull/11351#discussion_r397606034", "createdAt": "2020-03-25T04:40:50Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -397,6 +409,17 @@ public void notifyBufferDestroyed() {\n \t\t// Nothing to do actually.\n \t}\n \n+\t@Override\n+\tpublic void onExactlyOnceCheckpointCompletedOrCanceled(long checkpointId) {\n+\t\tsynchronized (bufferQueue) {\n+\t\t\tif (!isBlockedByCheckpoint(checkpointId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwODU5NjM2", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-380859636", "createdAt": "2020-03-25T05:01:07Z", "commit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNTowMTowN1rOF7MOFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNTowMTowN1rOF7MOFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYxMDUxNw==", "bodyText": "I considered discarding these two states in InputChannel level to unify reuse the states inside CheckpointBarrierAligner.\nRegarding the RemoteInputChannel case, these two states are used for avoiding unnecessary notification for upstream side if the unblock is triggered by other channels.\nOne possible option is to pass the boolean array of blocked channelsfromCheckpointBarrierAlignerwhile callingnotifyCheckpointCompletedOrCanceled. In CheckpointedInputGateandUnionInputGatelevel, they can also  pass the maintainedoffsetIndexto dedicatedSingleInputGate, then the single gate can judge whether the respective RemoteInputChannel` is actually blocked or not to notify the upstream side if necessary.\nRegarding the LocalInputChannel case, we can consider it separately.", "url": "https://github.com/apache/flink/pull/11351#discussion_r397610517", "createdAt": "2020-03-25T05:01:07Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/InputChannel.java", "diffHunk": "@@ -56,6 +57,10 @@\n \n \tprotected final SingleInputGate inputGate;\n \n+\tprotected long currentCheckpointId = -1;\n+\n+\tprotected ChannelState channelState = ChannelState.CONSUMING;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTAwMjk0", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-380900294", "createdAt": "2020-03-25T07:14:53Z", "commit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzoxNDo1M1rOF7OboA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzoxNDo1M1rOF7OboA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY0Njc1Mg==", "bodyText": "This can be removed if removing states by #11351 (comment)", "url": "https://github.com/apache/flink/pull/11351#discussion_r397646752", "createdAt": "2020-03-25T07:14:53Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -419,6 +442,17 @@ public int getAndResetUnannouncedCredit() {\n \t\treturn unannouncedCredit.getAndSet(0);\n \t}\n \n+\t/**\n+\t * Unblocks this channel from exactly once checkpoint.\n+\t */\n+\tpublic void unblockChannel() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTA0NTQ2", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-380904546", "createdAt": "2020-03-25T07:25:24Z", "commit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzoyNToyNFrOF7OqCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzoyNToyNFrOF7OqCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY1MDQ0MQ==", "bodyText": "It should make use of existing writeAndFlushNextMessageIfPossible for writing any messages on downstream side, otherwise we might miss some conditions such as if (channelError.get() != null || !channel.isWritable())  inside previous writeAndFlushNextMessageIfPossible. And also bring much overhead work for maintaining two different paths (e.g. for failure handling).\nWe can refactor the existing inputChannelsWithCredit as a more general outbound message queue to insert both AddCredit and ResumeConsumption messages. And define an abstract ClientOutboundMessage with buildMessage method to be implemented by AddCredit and ResumeConsumption separately during writeAndFlushNextMessageIfPossible.", "url": "https://github.com/apache/flink/pull/11351#discussion_r397650441", "createdAt": "2020-03-25T07:25:24Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedPartitionRequestClientHandler.java", "diffHunk": "@@ -193,6 +199,16 @@ public void userEventTriggered(ChannelHandlerContext ctx, Object msg) throws Exc\n \t\t\tif (triggerWrite) {\n \t\t\t\twriteAndFlushNextMessageIfPossible(ctx.channel());\n \t\t\t}\n+\t\t} else if (msg instanceof ResumeConsumptionEvent) {\n+\t\t\tRemoteInputChannel inputChannel = ((ResumeConsumptionEvent) msg).inputChannel;\n+\t\t\tinputChannel.unblockChannel();\n+\t\t\tResumeConsumption resumeConsumption = new ResumeConsumption(inputChannel.getInputChannelId());\n+\n+\t\t\tctx.channel().writeAndFlush(resumeConsumption).addListener((ChannelFutureListener) channelFuture -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTA5NzM3", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-380909737", "createdAt": "2020-03-25T07:36:54Z", "commit": {"oid": "47267a0ddd0dd8fded91dc33eeaecac3c83cbb36"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "acb13c1bb113f6fadb0aedefd709a441853e0a75", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/acb13c1bb113f6fadb0aedefd709a441853e0a75", "committedDate": "2020-03-26T07:14:18Z", "message": "Fixup."}, "afterCommit": {"oid": "59b1e101500b638019f58c27daa18b19ebcbaa3b", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/59b1e101500b638019f58c27daa18b19ebcbaa3b", "committedDate": "2020-03-26T08:38:10Z", "message": "Fixup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "59b1e101500b638019f58c27daa18b19ebcbaa3b", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/59b1e101500b638019f58c27daa18b19ebcbaa3b", "committedDate": "2020-03-26T08:38:10Z", "message": "Fixup."}, "afterCommit": {"oid": "f86372054c1c4724b8dabc8d06e369475e64ac29", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/f86372054c1c4724b8dabc8d06e369475e64ac29", "committedDate": "2020-03-26T10:43:25Z", "message": "Fixup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f86372054c1c4724b8dabc8d06e369475e64ac29", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/f86372054c1c4724b8dabc8d06e369475e64ac29", "committedDate": "2020-03-26T10:43:25Z", "message": "Fixup."}, "afterCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/ab2741cfd7192d0bbd4269b4cd3334ca084e2b67", "committedDate": "2020-03-26T15:48:18Z", "message": "Fixup."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDI0OTAx", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387024901", "createdAt": "2020-04-03T07:45:37Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzo0NTozN1rOGAIqXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzo0NTozN1rOGAIqXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc5NTEwMA==", "bodyText": "It seems not clear whether the passed dataType must be an event type or not. So the method naming with argument seems not consistent, i prefer to naming the method as tagDataType or setDataType", "url": "https://github.com/apache/flink/pull/11351#discussion_r402795100", "createdAt": "2020-04-03T07:45:37Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/Buffer.java", "diffHunk": "@@ -55,9 +57,9 @@\n \tboolean isBuffer();\n \n \t/**\n-\t * Tags this buffer to represent an event.\n+\t * Tags this buffer to represent an event of the given type.\n \t */\n-\tvoid tagAsEvent();\n+\tvoid tagAsEvent(DataType dataType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDMxNjg0", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387031684", "createdAt": "2020-04-03T07:50:48Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzo1MDo0OFrOGAI2Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzo1MDo0OFrOGAI2Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc5ODE1NA==", "bodyText": "nit: add an empty line after each value.", "url": "https://github.com/apache/flink/pull/11351#discussion_r402798154", "createdAt": "2020-04-03T07:50:48Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/Buffer.java", "diffHunk": "@@ -227,4 +229,53 @@\n \t * Tags the buffer as compressed or uncompressed.\n \t */\n \tvoid setCompressed(boolean isCompressed);\n+\n+\t/**\n+\t * Gets the type of data this buffer contains.\n+\t */\n+\tDataType getDataType();\n+\n+\t/**\n+\t * Used to identify the type of data contained in {@link Buffer}.\n+\t */\n+\tenum DataType {\n+\t\t/**\n+\t\t * DATA_BUFFER indicates that this buffer represents a non-event data buffer.\n+\t\t */\n+\t\tDATA_BUFFER(true, false),\n+\t\t/**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDMyNzc0", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387032774", "createdAt": "2020-04-03T07:52:31Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzo1MjozMVrOGAI7BA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzo1MjozMVrOGAI7BA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc5OTM2NA==", "bodyText": "OTHER_EVENT instead", "url": "https://github.com/apache/flink/pull/11351#discussion_r402799364", "createdAt": "2020-04-03T07:52:31Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/Buffer.java", "diffHunk": "@@ -227,4 +229,53 @@\n \t * Tags the buffer as compressed or uncompressed.\n \t */\n \tvoid setCompressed(boolean isCompressed);\n+\n+\t/**\n+\t * Gets the type of data this buffer contains.\n+\t */\n+\tDataType getDataType();\n+\n+\t/**\n+\t * Used to identify the type of data contained in {@link Buffer}.\n+\t */\n+\tenum DataType {\n+\t\t/**\n+\t\t * DATA_BUFFER indicates that this buffer represents a non-event data buffer.\n+\t\t */\n+\t\tDATA_BUFFER(true, false),\n+\t\t/**\n+\t\t * EXACTLY_ONCE_CHECKPOINT_BARRIER indicates that this buffer represents a\n+\t\t * serialized checkpoint barrier of exactly once checkpoint mode.\n+\t\t */\n+\t\tEXACTLY_ONCE_CHECKPOINT_BARRIER(false, true),\n+\t\t/**\n+\t\t * UNKNOWN_EVENT indicates this buffer represents serialized data of other\n+\t\t * unknown event.\n+\t\t */\n+\t\tUNKNOWN_EVENT(false, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDM2MTYz", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387036163", "createdAt": "2020-04-03T07:58:02Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzo1ODowM1rOGAJMzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzo1ODowM1rOGAJMzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgwMzkxOA==", "bodyText": "It does not need to maintain this so specific property, otherwise when we further extend the data type enum future, it also needs to extend the respective field here.\nisBuffer is a general property to be retained for widely use.  Then we can also judge via getDataType == DataType.EXACTLY_ONCE_CHECKPOINT_BARRIER  to replace isExactlyOnceCheckpointBarrier.", "url": "https://github.com/apache/flink/pull/11351#discussion_r402803918", "createdAt": "2020-04-03T07:58:03Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/Buffer.java", "diffHunk": "@@ -227,4 +229,53 @@\n \t * Tags the buffer as compressed or uncompressed.\n \t */\n \tvoid setCompressed(boolean isCompressed);\n+\n+\t/**\n+\t * Gets the type of data this buffer contains.\n+\t */\n+\tDataType getDataType();\n+\n+\t/**\n+\t * Used to identify the type of data contained in {@link Buffer}.\n+\t */\n+\tenum DataType {\n+\t\t/**\n+\t\t * DATA_BUFFER indicates that this buffer represents a non-event data buffer.\n+\t\t */\n+\t\tDATA_BUFFER(true, false),\n+\t\t/**\n+\t\t * EXACTLY_ONCE_CHECKPOINT_BARRIER indicates that this buffer represents a\n+\t\t * serialized checkpoint barrier of exactly once checkpoint mode.\n+\t\t */\n+\t\tEXACTLY_ONCE_CHECKPOINT_BARRIER(false, true),\n+\t\t/**\n+\t\t * UNKNOWN_EVENT indicates this buffer represents serialized data of other\n+\t\t * unknown event.\n+\t\t */\n+\t\tUNKNOWN_EVENT(false, false);\n+\n+\t\tprivate final boolean isBuffer;\n+\n+\t\tprivate final boolean isExactlyOnceCheckpointBarrier;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDM2ODMx", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387036831", "createdAt": "2020-04-03T07:59:02Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzo1OTowMlrOGAJQkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzo1OTowMlrOGAJQkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgwNDg4MA==", "bodyText": "nit: bufferDataType -> dataType", "url": "https://github.com/apache/flink/pull/11351#discussion_r402804880", "createdAt": "2020-04-03T07:59:02Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/BufferConsumer.java", "diffHunk": "@@ -53,23 +53,23 @@ public BufferConsumer(\n \t\t\tPositionMarker currentWriterPosition,\n \t\t\tint currentReaderPosition) {\n \t\tthis(\n-\t\t\tnew NetworkBuffer(checkNotNull(memorySegment), checkNotNull(recycler), true),\n+\t\t\tnew NetworkBuffer(checkNotNull(memorySegment), checkNotNull(recycler)),\n \t\t\tcurrentWriterPosition,\n \t\t\tcurrentReaderPosition);\n \t}\n \n \t/**\n \t * Constructs {@link BufferConsumer} instance with static content.\n \t */\n-\tpublic BufferConsumer(MemorySegment memorySegment, BufferRecycler recycler, boolean isBuffer) {\n-\t\tthis(memorySegment, recycler, memorySegment.size(), isBuffer);\n+\tpublic BufferConsumer(MemorySegment memorySegment, BufferRecycler recycler, Buffer.DataType bufferDataType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDM3Mzgx", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387037381", "createdAt": "2020-04-03T07:59:53Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzo1OTo1NFrOGAJTmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzo1OTo1NFrOGAJTmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgwNTY1OA==", "bodyText": "ditto: dataType", "url": "https://github.com/apache/flink/pull/11351#discussion_r402805658", "createdAt": "2020-04-03T07:59:54Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/NetworkBuffer.java", "diffHunk": "@@ -52,8 +52,8 @@\n \t/** The recycler for the backing {@link MemorySegment}. */\n \tprivate final BufferRecycler recycler;\n \n-\t/** Whether this buffer represents a buffer or an event. */\n-\tprivate boolean isBuffer;\n+\t/** The {@link DataType} this buffer contains. */\n+\tprivate DataType bufferDataType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDM3NjYy", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387037662", "createdAt": "2020-04-03T08:00:17Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODowMDoxOFrOGAJUvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODowMDoxOFrOGAJUvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgwNTk1MA==", "bodyText": "contains -> represents", "url": "https://github.com/apache/flink/pull/11351#discussion_r402805950", "createdAt": "2020-04-03T08:00:18Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/NetworkBuffer.java", "diffHunk": "@@ -52,8 +52,8 @@\n \t/** The recycler for the backing {@link MemorySegment}. */\n \tprivate final BufferRecycler recycler;\n \n-\t/** Whether this buffer represents a buffer or an event. */\n-\tprivate boolean isBuffer;\n+\t/** The {@link DataType} this buffer contains. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDQyMTAx", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387042101", "createdAt": "2020-04-03T08:07:16Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODowNzoxNlrOGAJr6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODowNzoxNlrOGAJr6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgxMTg4Mg==", "bodyText": "why remove condition of finish?", "url": "https://github.com/apache/flink/pull/11351#discussion_r402811882", "createdAt": "2020-04-03T08:07:16Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -114,7 +114,7 @@ private boolean add(BufferConsumer bufferConsumer, boolean finish) {\n \t\t\tbuffers.add(bufferConsumer);\n \t\t\tupdateStatistics(bufferConsumer);\n \t\t\tincreaseBuffersInBacklog(bufferConsumer);\n-\t\t\tnotifyDataAvailable = shouldNotifyDataAvailable() || finish;\n+\t\t\tnotifyDataAvailable = shouldNotifyDataAvailable();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDQ1MjQ5", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387045249", "createdAt": "2020-04-03T08:11:51Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODoxMTo1MlrOGAJ74w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODoxMTo1MlrOGAJ74w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgxNTk3MQ==", "bodyText": "use buffer.getDataType() == Buffer.DataType.EXACTLY_ONCE_CHECKPOINT_BARRIER instead.", "url": "https://github.com/apache/flink/pull/11351#discussion_r402815971", "createdAt": "2020-04-03T08:11:52Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -197,13 +197,18 @@ BufferAndBacklog pollBuffer() {\n \t\t\t\treturn null;\n \t\t\t}\n \n+\t\t\tboolean isExactlyOnceCheckpointBarrier = buffer.getDataType().isExactlyOnceCheckpointBarrier();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDQ3MTQ5", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387047149", "createdAt": "2020-04-03T08:14:41Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODoxNDo0MVrOGAKFuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODoxNDo0MVrOGAKFuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgxODQ5MQ==", "bodyText": "The readerView maintains the blocked state, then I prefer to moving this judgement inside subpartition view. So we can remove this method blockOnCheckpointBarrier completely.", "url": "https://github.com/apache/flink/pull/11351#discussion_r402818491", "createdAt": "2020-04-03T08:14:41Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -197,13 +197,18 @@ BufferAndBacklog pollBuffer() {\n \t\t\t\treturn null;\n \t\t\t}\n \n+\t\t\tboolean isExactlyOnceCheckpointBarrier = buffer.getDataType().isExactlyOnceCheckpointBarrier();\n+\t\t\tif (isExactlyOnceCheckpointBarrier) {\n+\t\t\t\treadView.blockOnCheckpointBarrier();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDUxNjIw", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387051620", "createdAt": "2020-04-03T08:21:33Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODoyMTozNFrOGAKc1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODoyMTozNFrOGAKc1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgyNDQwNw==", "bodyText": "Remove !isExactlyOnceCheckpointBarrier to not mix this state with ResultSubpartition component, we can get this blocked state separately from ResultSubpartitionView, then every concept is clean.", "url": "https://github.com/apache/flink/pull/11351#discussion_r402824407", "createdAt": "2020-04-03T08:21:34Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -197,13 +197,18 @@ BufferAndBacklog pollBuffer() {\n \t\t\t\treturn null;\n \t\t\t}\n \n+\t\t\tboolean isExactlyOnceCheckpointBarrier = buffer.getDataType().isExactlyOnceCheckpointBarrier();\n+\t\t\tif (isExactlyOnceCheckpointBarrier) {\n+\t\t\t\treadView.blockOnCheckpointBarrier();\n+\t\t\t}\n+\n \t\t\tupdateStatistics(buffer);\n \t\t\t// Do not report last remaining buffer on buffers as available to read (assuming it's unfinished).\n \t\t\t// It will be reported for reading either on flush or when the number of buffers in the queue\n \t\t\t// will be 2 or more.\n \t\t\treturn new BufferAndBacklog(\n \t\t\t\tbuffer,\n-\t\t\t\tisAvailableUnsafe(),\n+\t\t\t\tisAvailableUnsafe() && !isExactlyOnceCheckpointBarrier,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDU4NTg0", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387058584", "createdAt": "2020-04-03T08:32:12Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODozMjoxMlrOGALAhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODozMjoxMlrOGALAhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgzMzU0MA==", "bodyText": "I know it can avoid entering the following actions if readerView is not fitted.  But another issue is that notifyDataAvailable would be called in three places in this class, and it already judges the readerView inside for unification. So I suggested to add the condition readView.isBlockedByCheckpoint() inside notifyDataAvailable.", "url": "https://github.com/apache/flink/pull/11351#discussion_r402833540", "createdAt": "2020-04-03T08:32:12Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -302,7 +307,7 @@ public int unsynchronizedGetNumberOfQueuedBuffers() {\n \tpublic void flush() {\n \t\tfinal boolean notifyDataAvailable;\n \t\tsynchronized (buffers) {\n-\t\t\tif (buffers.isEmpty()) {\n+\t\t\tif (buffers.isEmpty() || readView == null || readView.isBlockedByCheckpoint()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDU5OTU1", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387059955", "createdAt": "2020-04-03T08:34:18Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODozNDoxOVrOGALHuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODozNDoxOVrOGALHuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgzNTM4Nw==", "bodyText": "also we can remove this condition by reusing it inside notifyDataAvailable as mentioned above.", "url": "https://github.com/apache/flink/pull/11351#discussion_r402835387", "createdAt": "2020-04-03T08:34:19Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -376,7 +381,7 @@ public int getBuffersInBacklog() {\n \n \tprivate boolean shouldNotifyDataAvailable() {\n \t\t// Notify only when we added first finished buffer.\n-\t\treturn readView != null && !flushRequested && getNumberOfFinishedBuffers() == 1;\n+\t\treturn readView != null && !flushRequested && !readView.isBlockedByCheckpoint() && getNumberOfFinishedBuffers() == 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTIwMDU1", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387120055", "createdAt": "2020-04-03T10:01:27Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDowMToyN1rOGAO1ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDowMToyN1rOGAO1ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg5NjI5MQ==", "bodyText": "It is sensitive to maintain a volatile variable in core stack. Actually we can avoid it for RemoteInputChannel by accessing it only by netty stack, it would only bring one more unnecessary UserEventTrigger in netty stack. But for local channel, it has problems now, let us think whether they are other options to bypass.", "url": "https://github.com/apache/flink/pull/11351#discussion_r402896291", "createdAt": "2020-04-03T10:01:27Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartitionView.java", "diffHunk": "@@ -39,6 +40,8 @@\n \t/** Flag indicating whether this view has been released. */\n \tprivate final AtomicBoolean isReleased;\n \n+\tprivate volatile boolean isBlockedByCheckpoint = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTI0NTI3", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387124527", "createdAt": "2020-04-03T10:08:17Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDowODoxN1rOGAPDnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDowODoxN1rOGAPDnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg5OTg3MQ==", "bodyText": "From subpartitionView prospective , it is better to give a overall method for judging its condition, not spreading multiple conditions. we might need to refactor the current ResultSubpartition#isAvailable for also considering blocked state with nextBufferIsEvent.", "url": "https://github.com/apache/flink/pull/11351#discussion_r402899871", "createdAt": "2020-04-03T10:08:17Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedSequenceNumberingViewReader.java", "diffHunk": "@@ -119,7 +124,7 @@ public boolean isAvailable() {\n \t\t\treturn subpartitionView.isAvailable();\n \t\t}\n \t\telse {\n-\t\t\treturn subpartitionView.nextBufferIsEvent();\n+\t\t\treturn !subpartitionView.isBlockedByCheckpoint() && subpartitionView.nextBufferIsEvent();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTI1NTAz", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387125503", "createdAt": "2020-04-03T10:09:43Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDowOTo0NFrOGAPG6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDowOTo0NFrOGAPG6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkwMDcxNQ==", "bodyText": "As above commented, if we can avoid task thread touching the blocked state, then together with https://github.com/apache/flink/pull/11351/files#r402899871, we can remove this method completely.", "url": "https://github.com/apache/flink/pull/11351#discussion_r402900715", "createdAt": "2020-04-03T10:09:44Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/ResultSubpartitionView.java", "diffHunk": "@@ -50,6 +50,10 @@\n \n \tboolean isReleased();\n \n+\tboolean isBlockedByCheckpoint();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTM5NTYy", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387139562", "createdAt": "2020-04-03T10:31:57Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDozMTo1OFrOGAPz4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDozMTo1OFrOGAPz4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkxMjIyNA==", "bodyText": "I notice that some usages are relying on the ordinal  of enum value. So do you think we should give some notes to avoid adjusting the existing sequence if extending it future?", "url": "https://github.com/apache/flink/pull/11351#discussion_r402912224", "createdAt": "2020-04-03T10:31:58Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/Buffer.java", "diffHunk": "@@ -227,4 +229,53 @@\n \t * Tags the buffer as compressed or uncompressed.\n \t */\n \tvoid setCompressed(boolean isCompressed);\n+\n+\t/**\n+\t * Gets the type of data this buffer contains.\n+\t */\n+\tDataType getDataType();\n+\n+\t/**\n+\t * Used to identify the type of data contained in {@link Buffer}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTQxNTUy", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387141552", "createdAt": "2020-04-03T10:35:17Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDozNToxOFrOGAP6Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDozNToxOFrOGAP6Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkxMzg3OQ==", "bodyText": "we can still retain the isBuffer as before, because it is enough now to avoid increasing the header size.", "url": "https://github.com/apache/flink/pull/11351#discussion_r402913879", "createdAt": "2020-04-03T10:35:18Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/NettyMessage.java", "diffHunk": "@@ -276,22 +279,22 @@ protected Object decode(ChannelHandlerContext ctx, ByteBuf in) throws Exception\n \n \t\tfinal int backlog;\n \n-\t\tfinal boolean isBuffer;\n+\t\tfinal Buffer.DataType bufferDataType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTQyMzUz", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387142353", "createdAt": "2020-04-03T10:36:41Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDozNjo0MVrOGAP9Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDozNjo0MVrOGAP9Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkxNDU2Ng==", "bodyText": "unrelated change", "url": "https://github.com/apache/flink/pull/11351#discussion_r402914566", "createdAt": "2020-04-03T10:36:41Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -311,10 +310,11 @@ public void recycle(MemorySegment segment) {\n \t\t\t\t\tExceptionUtils.rethrow(t);\n \t\t\t\t}\n \t\t\t}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTQyNDQx", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387142441", "createdAt": "2020-04-03T10:36:49Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDozNjo1MFrOGAP9Sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDozNjo1MFrOGAP9Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkxNDYzNQ==", "bodyText": "unrelated change", "url": "https://github.com/apache/flink/pull/11351#discussion_r402914635", "createdAt": "2020-04-03T10:36:50Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -299,7 +299,6 @@ private void notifyCreditAvailable() {\n \t@Override\n \tpublic void recycle(MemorySegment segment) {\n \t\tint numAddedBuffers;\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTQyNjQ4", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387142648", "createdAt": "2020-04-03T10:37:08Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDozNzowOFrOGAP9-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDozNzowOFrOGAP9-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkxNDgxMQ==", "bodyText": "unrelated change", "url": "https://github.com/apache/flink/pull/11351#discussion_r402914811", "createdAt": "2020-04-03T10:37:08Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -482,7 +492,6 @@ public Buffer requestBuffer() {\n \t */\n \tvoid onSenderBacklog(int backlog) throws IOException {\n \t\tint numRequestedBuffers = 0;\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTQzMTIy", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387143122", "createdAt": "2020-04-03T10:37:54Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDozNzo1NVrOGAP_Yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDozNzo1NVrOGAP_Yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkxNTE3MQ==", "bodyText": "unrelated change?", "url": "https://github.com/apache/flink/pull/11351#discussion_r402915171", "createdAt": "2020-04-03T10:37:55Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -383,7 +383,7 @@ public NotificationResult notifyBufferAvailable(Buffer buffer) {\n \t\t\t\t}\n \t\t\t}\n \n-\t\t\tif (unannouncedCredit.getAndAdd(1) == 0) {\n+\t\t\tif (unannouncedCredit.getAndIncrement() == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTQzMjQw", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387143240", "createdAt": "2020-04-03T10:38:06Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDozODowNlrOGAP_xA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDozODowNlrOGAP_xA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkxNTI2OA==", "bodyText": "unrelated change?", "url": "https://github.com/apache/flink/pull/11351#discussion_r402915268", "createdAt": "2020-04-03T10:38:06Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -311,10 +310,11 @@ public void recycle(MemorySegment segment) {\n \t\t\t\t\tExceptionUtils.rethrow(t);\n \t\t\t\t}\n \t\t\t}\n+\n \t\t\tnumAddedBuffers = bufferQueue.addExclusiveBuffer(new NetworkBuffer(segment, this), numRequiredBuffers);\n \t\t}\n \n-\t\tif (numAddedBuffers > 0 && unannouncedCredit.getAndAdd(numAddedBuffers) == 0) {\n+\t\tif (numAddedBuffers > 0 && unannouncedCredit.getAndIncrement() == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTQzNTgw", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-387143580", "createdAt": "2020-04-03T10:38:39Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDozODozOVrOGAQA1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMDozODozOVrOGAQA1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkxNTU0MA==", "bodyText": "unrelated change?", "url": "https://github.com/apache/flink/pull/11351#discussion_r402915540", "createdAt": "2020-04-03T10:38:39Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/NettyMessage.java", "diffHunk": "@@ -681,8 +684,6 @@ static CloseRequest readFrom(@SuppressWarnings(\"unused\") ByteBuf buffer) throws\n \t\tfinal InputChannelID receiverId;\n \n \t\tAddCredit(int credit, InputChannelID receiverId) {\n-\t\t\tcheckArgument(credit > 0, \"The announced credit should be greater than 0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 108}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzYyNzE0", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-388762714", "createdAt": "2020-04-07T03:40:59Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMzo0MDo1OVrOGBxxNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMzo0MDo1OVrOGBxxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDUxNzE3Mg==", "bodyText": "nit: adjust the comment as well.", "url": "https://github.com/apache/flink/pull/11351#discussion_r404517172", "createdAt": "2020-04-07T03:40:59Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedPartitionRequestClientHandler.java", "diffHunk": "@@ -310,19 +316,17 @@ private void writeAndFlushNextMessageIfPossible(Channel channel) {\n \t\t}\n \n \t\twhile (true) {\n-\t\t\tRemoteInputChannel inputChannel = inputChannelsWithCredit.poll();\n+\t\t\tClientOutboundMessage outboundMessage = clientOutboundMessages.poll();\n \n \t\t\t// The input channel may be null because of the write callbacks\n \t\t\t// that are executed after each write.\n-\t\t\tif (inputChannel == null) {\n+\t\t\tif (outboundMessage == null) {\n \t\t\t\treturn;\n \t\t\t}\n \n \t\t\t//It is no need to notify credit for the released channel.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzYzNTM5", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-388763539", "createdAt": "2020-04-07T03:44:15Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMzo0NDoxNVrOGBx0Qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMzo0NDoxNVrOGBx0Qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDUxNzk1NQ==", "bodyText": "nit: checkNotNull(inputChannel)", "url": "https://github.com/apache/flink/pull/11351#discussion_r404517955", "createdAt": "2020-04-07T03:44:15Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedPartitionRequestClientHandler.java", "diffHunk": "@@ -350,4 +354,38 @@ public void operationComplete(ChannelFuture future) throws Exception {\n \t\t\t}\n \t\t}\n \t}\n+\n+\tprivate static abstract class ClientOutboundMessage {\n+\t\tprotected final RemoteInputChannel inputChannel;\n+\n+\t\tClientOutboundMessage(RemoteInputChannel inputChannel) {\n+\t\t\tthis.inputChannel = inputChannel;\n+\t\t}\n+\n+\t\tabstract Object buildMessage();\n+\t}\n+\n+\tprivate static class AddCreditMessage extends ClientOutboundMessage {\n+\n+\t\tAddCreditMessage(RemoteInputChannel inputChannel) {\n+\t\t\tsuper(inputChannel);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 98}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzYzNTY5", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-388763569", "createdAt": "2020-04-07T03:44:24Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMzo0NDoyNFrOGBx0ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMzo0NDoyNFrOGBx0ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDUxNzk4OQ==", "bodyText": "ditto", "url": "https://github.com/apache/flink/pull/11351#discussion_r404517989", "createdAt": "2020-04-07T03:44:24Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedPartitionRequestClientHandler.java", "diffHunk": "@@ -350,4 +354,38 @@ public void operationComplete(ChannelFuture future) throws Exception {\n \t\t\t}\n \t\t}\n \t}\n+\n+\tprivate static abstract class ClientOutboundMessage {\n+\t\tprotected final RemoteInputChannel inputChannel;\n+\n+\t\tClientOutboundMessage(RemoteInputChannel inputChannel) {\n+\t\t\tthis.inputChannel = inputChannel;\n+\t\t}\n+\n+\t\tabstract Object buildMessage();\n+\t}\n+\n+\tprivate static class AddCreditMessage extends ClientOutboundMessage {\n+\n+\t\tAddCreditMessage(RemoteInputChannel inputChannel) {\n+\t\t\tsuper(inputChannel);\n+\t\t}\n+\n+\t\t@Override\n+\t\tpublic Object buildMessage() {\n+\t\t\treturn new AddCredit(inputChannel.getAndResetUnannouncedCredit(), inputChannel.getInputChannelId());\n+\t\t}\n+\t}\n+\n+\tprivate static class ResumeConsumptionMessage extends ClientOutboundMessage {\n+\n+\t\tResumeConsumptionMessage(RemoteInputChannel inputChannel) {\n+\t\t\tsuper(inputChannel);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 110}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzY4NDMx", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-388768431", "createdAt": "2020-04-07T04:03:30Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNDowMzozMFrOGByEig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNDowMzozMFrOGByEig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDUyMjEyMg==", "bodyText": "request->requests, exactly-once", "url": "https://github.com/apache/flink/pull/11351#discussion_r404522122", "createdAt": "2020-04-07T04:03:30Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/PartitionRequestQueue.java", "diffHunk": "@@ -161,6 +161,26 @@ void addCredit(InputChannelID receiverId, int credit) throws Exception {\n \t\t}\n \t}\n \n+\t/**\n+\t * The consumer request to resume data consumption after an exactly once checkpoint.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4Nzc3NTI2", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-388777526", "createdAt": "2020-04-07T04:36:45Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNDozNjo0NVrOGByi-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNDozNjo0NVrOGByi-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDUyOTkxNQ==", "bodyText": "should we further remove this method because it is always return 0 after this PR? If so, how many changes it will be involved?", "url": "https://github.com/apache/flink/pull/11351#discussion_r404529915", "createdAt": "2020-04-07T04:36:45Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointMetrics.java", "diffHunk": "@@ -59,19 +56,13 @@ public CheckpointMetrics(\n \t\tcheckArgument(bytesBufferedInAlignment >= -1);\n \t\tcheckArgument(alignmentDurationNanos >= -1);\n \n-\t\tthis.bytesBufferedInAlignment = bytesBufferedInAlignment;\n \t\tthis.alignmentDurationNanos = alignmentDurationNanos;\n \t\tthis.syncDurationMillis = syncDurationMillis;\n \t\tthis.asyncDurationMillis = asyncDurationMillis;\n \t}\n \n \tpublic long getBytesBufferedInAlignment() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzkxMjEy", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-388791212", "createdAt": "2020-04-07T05:21:48Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNToyMTo0OFrOGBzRWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNToyMTo0OFrOGBzRWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU0MTc4NA==", "bodyText": "In mostly normal cases, this list should not be created beforehand, so it is better to create based on demand.\nI know it is for unification consideration. Another option is that we can migrate partial resume notification inside releaseBlocksAndResetBarriers which is involved in batch of channels to be notified.\nThen the other cases are all for the single channel notification which can be done inside #processBarrier. Then we can define boolean shouldNotify beforehand, and to remove unnecessary two else conditions below to make the logics seem shorter. And at the end to notify the channelIndex if shouldNotify set as false intermediate steps.\nAnother potential benefit is to make notification happen before notifyCheckpoint. notifyCheckpoint would be involved in some IO operations during sync process, so it is better to notify light-weight unblock actions beforehand to make data ready earlier.", "url": "https://github.com/apache/flink/pull/11351#discussion_r404541784", "createdAt": "2020-04-07T05:21:48Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/CheckpointBarrierAligner.java", "diffHunk": "@@ -100,21 +119,22 @@ public boolean isBlocked(int channelIndex) {\n \t}\n \n \t@Override\n-\tpublic boolean processBarrier(CheckpointBarrier receivedBarrier, int channelIndex, long bufferedBytes) throws Exception {\n+\tpublic void processBarrier(CheckpointBarrier receivedBarrier, int channelIndex) throws Exception {\n \t\tfinal long barrierId = receivedBarrier.getId();\n+\t\tList<Integer> channelsToUnblock = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzkyMTQ2", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-388792146", "createdAt": "2020-04-07T05:24:22Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNToyNDoyM1rOGBzUWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNToyNDoyM1rOGBzUWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU0MjU1NQ==", "bodyText": "Considering my above concerns, all the resume notification can be done inside releaseBlocksAndResetBarriers instead", "url": "https://github.com/apache/flink/pull/11351#discussion_r404542555", "createdAt": "2020-04-07T05:24:23Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/CheckpointBarrierAligner.java", "diffHunk": "@@ -214,8 +233,9 @@ protected void onBarrier(int channelIndex) throws IOException {\n \t}\n \n \t@Override\n-\tpublic boolean processCancellationBarrier(CancelCheckpointMarker cancelBarrier) throws Exception {\n+\tpublic void processCancellationBarrier(CancelCheckpointMarker cancelBarrier) throws Exception {\n \t\tfinal long barrierId = cancelBarrier.getCheckpointId();\n+\t\tList<Integer> channelsToUnblock = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 138}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzkyNTc0", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-388792574", "createdAt": "2020-04-07T05:25:34Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNToyNTozNFrOGBzVxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNToyNTozNFrOGBzVxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU0MjkxOA==", "bodyText": "ditto: make notification inside releaseBlocksAndResetBarriers", "url": "https://github.com/apache/flink/pull/11351#discussion_r404542918", "createdAt": "2020-04-07T05:25:34Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/CheckpointBarrierAligner.java", "diffHunk": "@@ -280,28 +298,29 @@ else if (barrierId > currentCheckpointId) {\n \t\t\t}\n \n \t\t\tnotifyAbortOnCancellationBarrier(barrierId);\n-\t\t\treturn false;\n \t\t}\n \n \t\t// else: trailing barrier from either\n \t\t//   - a previous (subsumed) checkpoint\n \t\t//   - the current checkpoint if it was already canceled\n-\t\treturn false;\n+\n+\t\tunblockCheckpoint(channelsToUnblock);\n \t}\n \n \t@Override\n-\tpublic boolean processEndOfPartition() throws Exception {\n+\tpublic void processEndOfPartition() throws Exception {\n \t\tnumClosedChannels++;\n \n+\t\tList<Integer> channelsToUnblock = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 199}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4ODI5NDIw", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-388829420", "createdAt": "2020-04-07T06:52:57Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNjo1Mjo1N1rOGB1TYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNjo1Mjo1N1rOGB1TYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU3NTA3NQ==", "bodyText": "return Optional.empty(); can be merged in condition. also remove throws Exception\n\nprivate Optional handleEmptyBuffer()  {\nif (inputGate.isFinished()) {\nisFinished = true;\n}\nreturn Optional.empty();\n}", "url": "https://github.com/apache/flink/pull/11351#discussion_r404575075", "createdAt": "2020-04-07T06:52:57Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/CheckpointedInputGate.java", "diffHunk": "@@ -180,40 +141,15 @@ private int offsetChannelIndex(int channelIndex) {\n \t\t\treturn Optional.empty();\n \t\t}\n \n-\t\tif (endOfInputGate) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 146}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4ODM4NDUw", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-388838450", "createdAt": "2020-04-07T07:08:45Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzowODo0NVrOGB1xKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzowODo0NVrOGB1xKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU4MjY5OA==", "bodyText": "it would be better to make isExactlyOnceMode as an internal field of CheckpointOptions, then we can avoid touching the changes of multiple related classes.", "url": "https://github.com/apache/flink/pull/11351#discussion_r404582698", "createdAt": "2020-04-07T07:08:45Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/CheckpointBarrier.java", "diffHunk": "@@ -47,11 +48,18 @@\n \tprivate final long id;\n \tprivate final long timestamp;\n \tprivate final CheckpointOptions checkpointOptions;\n+\tprivate final boolean isExactlyOnceMode;\n \n+\t@VisibleForTesting\n \tpublic CheckpointBarrier(long id, long timestamp, CheckpointOptions checkpointOptions) {\n+\t\tthis(id, timestamp, checkpointOptions, true);\n+\t}\n+\n+\tpublic CheckpointBarrier(long id, long timestamp, CheckpointOptions checkpointOptions, boolean isExactlyOnceMode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4ODQzMDY1", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-388843065", "createdAt": "2020-04-07T07:16:08Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzoxNjowOFrOGB2AMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzoxNjowOFrOGB2AMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU4NjU0Nw==", "bodyText": "nit: package private", "url": "https://github.com/apache/flink/pull/11351#discussion_r404586547", "createdAt": "2020-04-07T07:16:08Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/InputProcessorUtil.java", "diffHunk": "@@ -130,26 +112,26 @@ private static CheckpointBarrierHandler createCheckpointBarrierHandler(\n \t\t}\n \t}\n \n-\tprivate static BufferStorage createBufferStorage(\n-\t\t\tCheckpointingMode checkpointMode,\n-\t\t\tint pageSize,\n-\t\t\tConfiguration taskManagerConfig,\n-\t\t\tString taskName) {\n-\t\tswitch (checkpointMode) {\n-\t\t\tcase EXACTLY_ONCE: {\n-\t\t\t\tlong maxAlign = taskManagerConfig.getLong(TaskManagerOptions.TASK_CHECKPOINT_ALIGNMENT_BYTES_LIMIT);\n-\t\t\t\tif (!(maxAlign == -1 || maxAlign > 0)) {\n-\t\t\t\t\tthrow new IllegalConfigurationException(\n-\t\t\t\t\t\tTaskManagerOptions.TASK_CHECKPOINT_ALIGNMENT_BYTES_LIMIT.key()\n-\t\t\t\t\t\t\t+ \" must be positive or -1 (infinite)\");\n-\t\t\t\t}\n-\t\t\t\treturn new CachedBufferStorage(pageSize, maxAlign, taskName);\n+\tpublic static InputGate[] generateChannelIndexToInputGateMap(int numberOfInputChannels, InputGate ...inputGates) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 146}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4ODQzMTY0", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-388843164", "createdAt": "2020-04-07T07:16:17Z", "commit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzoxNjoxN1rOGB2Afg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzoxNjoxN1rOGB2Afg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU4NjYyMg==", "bodyText": "ditto", "url": "https://github.com/apache/flink/pull/11351#discussion_r404586622", "createdAt": "2020-04-07T07:16:17Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/InputProcessorUtil.java", "diffHunk": "@@ -130,26 +112,26 @@ private static CheckpointBarrierHandler createCheckpointBarrierHandler(\n \t\t}\n \t}\n \n-\tprivate static BufferStorage createBufferStorage(\n-\t\t\tCheckpointingMode checkpointMode,\n-\t\t\tint pageSize,\n-\t\t\tConfiguration taskManagerConfig,\n-\t\t\tString taskName) {\n-\t\tswitch (checkpointMode) {\n-\t\t\tcase EXACTLY_ONCE: {\n-\t\t\t\tlong maxAlign = taskManagerConfig.getLong(TaskManagerOptions.TASK_CHECKPOINT_ALIGNMENT_BYTES_LIMIT);\n-\t\t\t\tif (!(maxAlign == -1 || maxAlign > 0)) {\n-\t\t\t\t\tthrow new IllegalConfigurationException(\n-\t\t\t\t\t\tTaskManagerOptions.TASK_CHECKPOINT_ALIGNMENT_BYTES_LIMIT.key()\n-\t\t\t\t\t\t\t+ \" must be positive or -1 (infinite)\");\n-\t\t\t\t}\n-\t\t\t\treturn new CachedBufferStorage(pageSize, maxAlign, taskName);\n+\tpublic static InputGate[] generateChannelIndexToInputGateMap(int numberOfInputChannels, InputGate ...inputGates) {\n+\t\tInputGate[] channelIndexToInputGate = new InputGate[numberOfInputChannels];\n+\t\tint channelIndexOffset = 0;\n+\t\tfor (InputGate inputGate: inputGates) {\n+\t\t\tfor (int i = 0; i < inputGate.getNumberOfInputChannels(); ++i) {\n+\t\t\t\tchannelIndexToInputGate[channelIndexOffset + i] = inputGate;\n \t\t\t}\n-\t\t\tcase AT_LEAST_ONCE:\n-\t\t\t\treturn new EmptyBufferStorage();\n-\t\t\tdefault:\n-\t\t\t\tthrow new UnsupportedOperationException(\"Unrecognized Checkpointing Mode: \" + checkpointMode);\n+\t\t\tchannelIndexOffset += inputGate.getNumberOfInputChannels();\n+\t\t}\n+\t\treturn channelIndexToInputGate;\n+\t}\n+\n+\tpublic static Map<InputGate, Integer> generateInputGateToChannelIndexOffsetMap(InputGate ...inputGates) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67"}, "originalPosition": 162}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab2741cfd7192d0bbd4269b4cd3334ca084e2b67", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/ab2741cfd7192d0bbd4269b4cd3334ca084e2b67", "committedDate": "2020-03-26T15:48:18Z", "message": "Fixup."}, "afterCommit": {"oid": "302fb27f0a4a3639a442d2c54ddbcf0d323c7c76", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/302fb27f0a4a3639a442d2c54ddbcf0d323c7c76", "committedDate": "2020-04-07T13:30:36Z", "message": "Fixup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "302fb27f0a4a3639a442d2c54ddbcf0d323c7c76", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/302fb27f0a4a3639a442d2c54ddbcf0d323c7c76", "committedDate": "2020-04-07T13:30:36Z", "message": "Fixup."}, "afterCommit": {"oid": "e2b1460ce15ca62960d1e4a4f431d6f7a7022e5a", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/e2b1460ce15ca62960d1e4a4f431d6f7a7022e5a", "committedDate": "2020-04-08T04:32:02Z", "message": "Fixup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2b1460ce15ca62960d1e4a4f431d6f7a7022e5a", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/e2b1460ce15ca62960d1e4a4f431d6f7a7022e5a", "committedDate": "2020-04-08T04:32:02Z", "message": "Fixup."}, "afterCommit": {"oid": "16d04e41554d5244bb4907f1d0afed7826cda523", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/16d04e41554d5244bb4907f1d0afed7826cda523", "committedDate": "2020-04-08T08:08:16Z", "message": "Fixup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "16d04e41554d5244bb4907f1d0afed7826cda523", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/16d04e41554d5244bb4907f1d0afed7826cda523", "committedDate": "2020-04-08T08:08:16Z", "message": "Fixup."}, "afterCommit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/20f4e859705d31fd8a0821241bc9813cb39d0c32", "committedDate": "2020-04-08T15:33:40Z", "message": "Fixup."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMjczMjIy", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-391273222", "createdAt": "2020-04-10T05:30:56Z", "commit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNTozMDo1NlrOGDxcvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNTozMDo1NlrOGDxcvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwOTA4NQ==", "bodyText": "nit: whitespace for { and =", "url": "https://github.com/apache/flink/pull/11351#discussion_r406609085", "createdAt": "2020-04-10T05:30:56Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointOptions.java", "diffHunk": "@@ -90,7 +111,11 @@ else if (obj != null && obj.getClass() == CheckpointOptions.class) {\n \n \t@Override\n \tpublic String toString() {\n-\t\treturn \"CheckpointOptions: \" + checkpointType + \" @ \" + targetLocation;\n+\t\treturn \"CheckpointOptions{\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMjczMzMy", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-391273332", "createdAt": "2020-04-10T05:31:29Z", "commit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNTozMToyOVrOGDxdHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNTozMToyOVrOGDxdHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwOTE4Mw==", "bodyText": "nit: increase indentation for arguments", "url": "https://github.com/apache/flink/pull/11351#discussion_r406609183", "createdAt": "2020-04-10T05:31:29Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointOptions.java", "diffHunk": "@@ -42,12 +43,23 @@\n \t/** Target location for the checkpoint. */\n \tprivate final CheckpointStorageLocationReference targetLocation;\n \n+\tprivate final boolean isExactlyOnceMode;\n+\n+\t@VisibleForTesting\n+\tpublic CheckpointOptions(\n+\t\tCheckpointType checkpointType,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzAxNjA5", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-391301609", "createdAt": "2020-04-10T07:15:41Z", "commit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNzoxNTo0MVrOGDzEGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNzoxNTo0MVrOGDzEGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYzNTU0NQ==", "bodyText": "the description is not correct.", "url": "https://github.com/apache/flink/pull/11351#discussion_r406635545", "createdAt": "2020-04-10T07:15:41Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/PartitionRequestClient.java", "diffHunk": "@@ -50,6 +50,13 @@ void requestSubpartition(\n \t */\n \tvoid notifyCreditAvailable(RemoteInputChannel inputChannel);\n \n+\t/**\n+\t * Notifies available credits from one remote input channel.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzA5NDIz", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-391309423", "createdAt": "2020-04-10T07:36:51Z", "commit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNzozNjo1MVrOGDzecg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNzozNjo1MVrOGDzecg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY0MjI5MA==", "bodyText": "Is it necessary to ensureAccessible for setter?", "url": "https://github.com/apache/flink/pull/11351#discussion_r406642290", "createdAt": "2020-04-10T07:36:51Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/NetworkBuffer.java", "diffHunk": "@@ -639,4 +632,16 @@ public boolean isCompressed() {\n \tpublic void setCompressed(boolean isCompressed) {\n \t\tthis.isCompressed = isCompressed;\n \t}\n+\n+\t@Override\n+\tpublic DataType getDataType() {\n+\t\treturn dataType;\n+\t}\n+\n+\t@Override\n+\tpublic void setDataType(DataType dataType) {\n+\t\tensureAccessible();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "originalPosition": 105}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzEzMTA5", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-391313109", "createdAt": "2020-04-10T07:45:49Z", "commit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNzo0NTo0OVrOGDzqqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNzo0NTo0OVrOGDzqqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY0NTQxNw==", "bodyText": "Some general usages also reference this, so I prefer to defining EVENT_BUFFER instead for general purpose. The semantic here is also covering the above EXACTLY_ONCE_CHECKPOINT_BARRIER. If we defined as OTHER_EVENT, it seems exclude the EXACTLY_ONCE_CHECKPOINT_BARRIER.", "url": "https://github.com/apache/flink/pull/11351#discussion_r406645417", "createdAt": "2020-04-10T07:45:49Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/Buffer.java", "diffHunk": "@@ -227,4 +224,58 @@\n \t * Tags the buffer as compressed or uncompressed.\n \t */\n \tvoid setCompressed(boolean isCompressed);\n+\n+\t/**\n+\t * Gets the type of data this buffer represents.\n+\t */\n+\tDataType getDataType();\n+\n+\t/**\n+\t * Sets the type of data this buffer represents.\n+\t */\n+\tvoid setDataType(DataType dataType);\n+\n+\t/**\n+\t * Used to identify the type of data contained in {@link Buffer}.\n+\t */\n+\tenum DataType {\n+\t\t/**\n+\t\t * DATA_BUFFER indicates that this buffer represents a non-event data buffer.\n+\t\t */\n+\t\tDATA_BUFFER(true),\n+\n+\t\t/**\n+\t\t * EXACTLY_ONCE_CHECKPOINT_BARRIER indicates that this buffer represents a\n+\t\t * serialized checkpoint barrier of exactly once checkpoint mode.\n+\t\t */\n+\t\tEXACTLY_ONCE_CHECKPOINT_BARRIER(false),\n+\n+\t\t/**\n+\t\t * UNKNOWN_EVENT indicates this buffer represents serialized data of other\n+\t\t * unknown event.\n+\t\t */\n+\t\tOTHER_EVENT(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzEzNDgx", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-391313481", "createdAt": "2020-04-10T07:46:42Z", "commit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNzo0Njo0MlrOGDzr6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNzo0Njo0MlrOGDzr6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY0NTczOA==", "bodyText": "The descriptions should also be adjusted.", "url": "https://github.com/apache/flink/pull/11351#discussion_r406645738", "createdAt": "2020-04-10T07:46:42Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/Buffer.java", "diffHunk": "@@ -227,4 +224,58 @@\n \t * Tags the buffer as compressed or uncompressed.\n \t */\n \tvoid setCompressed(boolean isCompressed);\n+\n+\t/**\n+\t * Gets the type of data this buffer represents.\n+\t */\n+\tDataType getDataType();\n+\n+\t/**\n+\t * Sets the type of data this buffer represents.\n+\t */\n+\tvoid setDataType(DataType dataType);\n+\n+\t/**\n+\t * Used to identify the type of data contained in {@link Buffer}.\n+\t */\n+\tenum DataType {\n+\t\t/**\n+\t\t * DATA_BUFFER indicates that this buffer represents a non-event data buffer.\n+\t\t */\n+\t\tDATA_BUFFER(true),\n+\n+\t\t/**\n+\t\t * EXACTLY_ONCE_CHECKPOINT_BARRIER indicates that this buffer represents a\n+\t\t * serialized checkpoint barrier of exactly once checkpoint mode.\n+\t\t */\n+\t\tEXACTLY_ONCE_CHECKPOINT_BARRIER(false),\n+\n+\t\t/**\n+\t\t * UNKNOWN_EVENT indicates this buffer represents serialized data of other", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzc3NDc0", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-391377474", "createdAt": "2020-04-10T10:29:41Z", "commit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMDoyOTo0MVrOGD3EOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMDoyOTo0MVrOGD3EOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcwMTExMw==", "bodyText": "I think we should not modify the condition of flushRequested, and only work on the condition of notifyDataAvailable.\nThen isBlockedByCheckpoint can be added into below notifyDataAvailable, but now touch readerView condition which is out of scope of this PR.", "url": "https://github.com/apache/flink/pull/11351#discussion_r406701113", "createdAt": "2020-04-10T10:29:41Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -322,7 +341,7 @@ public int unsynchronizedGetNumberOfQueuedBuffers() {\n \tpublic void flush() {\n \t\tfinal boolean notifyDataAvailable;\n \t\tsynchronized (buffers) {\n-\t\t\tif (buffers.isEmpty()) {\n+\t\t\tif (buffers.isEmpty() || readView == null || isBlockedByCheckpoint) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzc3ODY2", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-391377866", "createdAt": "2020-04-10T10:30:48Z", "commit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMDozMDo0OFrOGD3FhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMDozMDo0OFrOGD3FhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcwMTQ0NQ==", "bodyText": "better to make this change as a separate hotfix commit", "url": "https://github.com/apache/flink/pull/11351#discussion_r406701445", "createdAt": "2020-04-10T10:30:48Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -396,13 +415,11 @@ public int getBuffersInBacklog() {\n \n \tprivate boolean shouldNotifyDataAvailable() {\n \t\t// Notify only when we added first finished buffer.\n-\t\treturn readView != null && !flushRequested && getNumberOfFinishedBuffers() == 1;\n+\t\treturn readView != null && !flushRequested && !isBlockedByCheckpoint && getNumberOfFinishedBuffers() == 1;\n \t}\n \n \tprivate void notifyDataAvailable() {\n-\t\tif (readView != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzgyMjA0", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-391382204", "createdAt": "2020-04-10T10:43:59Z", "commit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMDo0NDowMFrOGD3U-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMDo0NDowMFrOGD3U-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcwNTQwMQ==", "bodyText": "it is better to merge isAvailableWithoutCredit() with existing isAvailable() to avoid maintaining two separate interface methods. We can integrate them into isAvailable(int credit) method for distinguishing the condition inside implementations.", "url": "https://github.com/apache/flink/pull/11351#discussion_r406705401", "createdAt": "2020-04-10T10:44:00Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/ResultSubpartitionView.java", "diffHunk": "@@ -50,12 +50,14 @@\n \n \tboolean isReleased();\n \n+\tvoid resumeConsumption();\n+\n \tThrowable getFailureCause();\n \n \t/**\n-\t * Returns whether the next buffer is an event or not.\n+\t * Returns true if we can read data without available credits.\n \t */\n-\tboolean nextBufferIsEvent();\n+\tboolean isAvailableWithoutCredit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzgzODkz", "url": "https://github.com/apache/flink/pull/11351#pullrequestreview-391383893", "createdAt": "2020-04-10T10:49:27Z", "commit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMDo0OToyN1rOGD3bEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMDo0OToyN1rOGD3bEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcwNjk2MA==", "bodyText": "@GuardedBy(\"buffers\")", "url": "https://github.com/apache/flink/pull/11351#discussion_r406706960", "createdAt": "2020-04-10T10:49:27Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -86,6 +86,9 @@\n \t/** The total number of bytes (both data and event buffers). */\n \tprivate long totalNumberOfBytes;\n \n+\t/** Whether this subpartition is blocked by exactly once checkpoint and is waiting for resumption. */\n+\tprivate boolean isBlockedByCheckpoint = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f4e859705d31fd8a0821241bc9813cb39d0c32"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3163, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}