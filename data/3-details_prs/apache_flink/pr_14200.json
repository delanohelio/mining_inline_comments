{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NDgxNTU1", "number": 14200, "title": "[FLINK-20306][table-planner-blink] Throw a meaningful exception when accessing temporal table as of constant timestamp", "bodyText": "What is the purpose of the change\nCurrently, the planner throws a cryptic exception message when accessing temporal table with constant timestamp.\nSELECT * from RatesHistory FOR SYSTEM_TIME AS OF TIMESTAMP '2020-11-11 13:12:13';\n\norg.apache.calcite.plan.RelOptPlanner$CannotPlanException: There are not enough rules to produce a node with desired properties: convention=STREAM_PHYSICAL, FlinkRelDistributionTraitDef=any, MiniBatchIntervalTraitDef=None: 0, ModifyKindSetTraitDef=[NONE], UpdateKindTraitDef=[NONE].\nMissing conversion is FlinkLogicalSnapshot[convention: LOGICAL -> STREAM_PHYSICAL]\nThere is 1 empty subset: rel#987:RelSubset#44.STREAM_PHYSICAL.any.None: 0.[NONE].[NONE], the relevant part of the original plan is as follows\n977:FlinkLogicalSnapshot(period=[2020-11-11 13:12:13])\n  975:FlinkLogicalCalc(subset=[rel#976:RelSubset#43.LOGICAL.any.None: 0.[NONE].[NONE]], select=[CAST(Reinterpret(CAST(timestamp))) AS currency_time, currency, CAST(rate) AS rate])\n    962:FlinkLogicalTableSourceScan(subset=[rel#974:RelSubset#42.LOGICAL.any.None: 0.[NONE].[NONE]], table=[[default_catalog, default_database, RatesHistory, watermark=[CAST($2):TIMESTAMP(3)]]], fields=[currency, rate, timestamp])\n\nWe can throw a better exception to indicate this is not supported yet.\nBrief change log\n\nthrow a better exception when constructing FlinkLogicalSnapshot via isValid(...) interface.\n\nVerifying this change\n\nAdded validation tests which can reproduce the problem.\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-11-24T13:31:33Z", "url": "https://github.com/apache/flink/pull/14200", "merged": true, "mergeCommit": {"oid": "c41051f37651c2e81182c2145ac535f657133bbc"}, "closed": true, "closedAt": "2020-11-25T06:36:04Z", "author": {"login": "wuchong"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfpyMMgH2gAyNTI2NDgxNTU1OmI0YWU5NzgyM2FhNDZiZGU3NWY3ODhlMjhlNzA3YzMwZWI4N2M3NGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdf4WhJAFqTUzODE4ODUwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b4ae97823aa46bde75f788e28e707c30eb87c74a", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/b4ae97823aa46bde75f788e28e707c30eb87c74a", "committedDate": "2020-11-24T13:29:49Z", "message": "[FLINK-20306][table-planner-blink] Throw a meaningful exception when accessing temporal table as of constant timestamp"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f816efdff2f65610adeae47e6ce9780066cce7e9", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/f816efdff2f65610adeae47e6ce9780066cce7e9", "committedDate": "2020-11-24T13:27:57Z", "message": "[FLINK-20306][table-planner-blink] Throw a meaningful exception when accessing a versioned table as of constant timestamp"}, "afterCommit": {"oid": "b4ae97823aa46bde75f788e28e707c30eb87c74a", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/b4ae97823aa46bde75f788e28e707c30eb87c74a", "committedDate": "2020-11-24T13:29:49Z", "message": "[FLINK-20306][table-planner-blink] Throw a meaningful exception when accessing temporal table as of constant timestamp"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NTc1MDI4", "url": "https://github.com/apache/flink/pull/14200#pullrequestreview-537575028", "createdAt": "2020-11-24T14:57:00Z", "commit": {"oid": "b4ae97823aa46bde75f788e28e707c30eb87c74a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NTc3NDY1", "url": "https://github.com/apache/flink/pull/14200#pullrequestreview-537577465", "createdAt": "2020-11-24T14:59:13Z", "commit": {"oid": "b4ae97823aa46bde75f788e28e707c30eb87c74a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed0be72260d4b1a51d4d17ead21ee88eb84aa6f2", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/ed0be72260d4b1a51d4d17ead21ee88eb84aa6f2", "committedDate": "2020-11-24T16:14:48Z", "message": "fix tests and improve error messages"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MTM0ODYz", "url": "https://github.com/apache/flink/pull/14200#pullrequestreview-538134863", "createdAt": "2020-11-25T03:42:45Z", "commit": {"oid": "ed0be72260d4b1a51d4d17ead21ee88eb84aa6f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMzo0Mjo0NVrOH5iCJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMzo0Mjo0NVrOH5iCJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA4ODQ4NA==", "bodyText": "Do we check the period type in other place ?", "url": "https://github.com/apache/flink/pull/14200#discussion_r530088484", "createdAt": "2020-11-25T03:42:45Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/rules/common/CommonTemporalTableJoinRule.scala", "diffHunk": "@@ -44,20 +44,15 @@ trait CommonTemporalTableJoinRule {\n \n     // period specification check\n     snapshot.getPeriod match {\n-      // it's left table's field, pass\n-      case r: RexFieldAccess if r.getReferenceExpr.isInstanceOf[RexCorrelVariable] =>\n+      // it should be left table's field and is a time attribute\n+      case r: RexFieldAccess\n+        if r.getType.isInstanceOf[TimeIndicatorRelDataType] &&\n+          r.getReferenceExpr.isInstanceOf[RexCorrelVariable] => // pass\n       case _ =>\n         throw new TableException(\"Temporal table join currently only supports \" +\n-          \"'FOR SYSTEM_TIME AS OF' left table's time attribute field, doesn't support 'PROCTIME()'\")\n+          \"'FOR SYSTEM_TIME AS OF' left table's time attribute field.\")\n     }\n \n-    snapshot.getPeriod.getType match {\n-      // supports both event-time and processing time\n-      case t: TimeIndicatorRelDataType =>\n-      case _ =>\n-        throw new TableException(\"Temporal table join currently only supports \" +\n-          \"'FOR SYSTEM_TIME AS OF' left table's time attribute field\")\n-    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed0be72260d4b1a51d4d17ead21ee88eb84aa6f2"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MTg4NTA5", "url": "https://github.com/apache/flink/pull/14200#pullrequestreview-538188509", "createdAt": "2020-11-25T06:28:10Z", "commit": {"oid": "ed0be72260d4b1a51d4d17ead21ee88eb84aa6f2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4109, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}