{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NTg0Mjcw", "number": 12173, "title": "[FLINK-17727][task] don't create output stream with no channel state (unaligned checkpoints)", "bodyText": "What is the purpose of the change\nWith Unaligned checkpoints enabled, when there are no channel state handles, the underlying FS stream is still created. On discard it is not deleted because it's not referenced by any state handles.\nThis prevents checkpoint from being subsumed.\nThis was causing e2e test test_stateful_stream_job_upgrade.sh to fail (which is re-enabled in this PR).\nBrief change log\n\nadd a check for emptyness of handles before creating an underlying stream\nadd unit test\nrevert reverse of [FLINK-17467][task][e2e] Modify existing upgrade test to verify aligned savepoints\n\nVerifying this change\nThis change added tests and can be verified as follows:\n\nAdded unit test: ChannelStateCheckpointWriterTest.testEmptyState\nRe-enabled e2e test: test_stateful_stream_job_upgrade.sh\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: yes\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? not applicable", "createdAt": "2020-05-15T13:11:25Z", "url": "https://github.com/apache/flink/pull/12173", "merged": true, "mergeCommit": {"oid": "91932ccc0592f969dc7d264f2adaecfa0c65d3da"}, "closed": true, "closedAt": "2020-05-16T04:45:48Z", "author": {"login": "rkhachatryan"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchhiPZgH2gAyNDE4NTg0MjcwOmU2ZjE2ODkwMjQwZmRmZjRmMDY5NzFlZmZiMmViZmVjM2E4MWQ1Nzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchjJZ8AFqTQxMjcxMDE4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e6f16890240fdff4f06971effb2ebfec3a81d578", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/e6f16890240fdff4f06971effb2ebfec3a81d578", "committedDate": "2020-05-15T12:49:51Z", "message": "[FLINK-17727][task] don't create output stream with no channel state (unaligned checkpoints)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a05709a1296e952aa3ed65c92957fc039bd90fc0", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/a05709a1296e952aa3ed65c92957fc039bd90fc0", "committedDate": "2020-05-15T12:51:17Z", "message": "[FLINK-17727][e2e] Re-enable \"[FLINK-17467][task][e2e] Modify existing upgrade test to verify aligned savepoints\" after a fix\n\nThis reverts commit 3af17562eb791e3f486c38dbd94dc3328309b262."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNzEwMTgy", "url": "https://github.com/apache/flink/pull/12173#pullrequestreview-412710182", "createdAt": "2020-05-15T14:42:12Z", "commit": {"oid": "e6f16890240fdff4f06971effb2ebfec3a81d578"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNDo0MjoxMlrOGWHxgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNDo0MjoxMlrOGWHxgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0OTIxNg==", "bodyText": "Don't we have to clean up/remove some empty file? I guess in this branch, dataStream will be empty and we have already created some file for it? In other words, won't this code leave a lingering empty files somewhere?", "url": "https://github.com/apache/flink/pull/12173#discussion_r425849216", "createdAt": "2020-05-15T14:42:12Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateCheckpointWriter.java", "diffHunk": "@@ -150,6 +151,12 @@ private void complete(boolean precondition, RunnableWithException complete) thro\n \t}\n \n \tprivate void finishWriteAndResult() throws IOException {\n+\t\tif (inputChannelOffsets.isEmpty() && resultSubpartitionOffsets.isEmpty()) {\n+\t\t\tdataStream.close();\n+\t\t\tresult.inputChannelStateHandles.complete(emptyList());\n+\t\t\tresult.resultSubpartitionStateHandles.complete(emptyList());\n+\t\t\treturn;\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6f16890240fdff4f06971effb2ebfec3a81d578"}, "originalPosition": 17}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4074, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}