{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMzY5NTI1", "number": 11026, "title": "[FLINK-15811][task] report CancelTaskException from SourceStreamTask", "bodyText": "What is the purpose of the change\nSourceStreamTask has it's own thread and on cancel() it interrupts this thread.\nWhen the thread completes the failure if any is reported via mailbox to the upstream Task.\nSo on cancel it reports InterruptedException.\nBut the contract (or common practice) of AbstractInvokable is to throw CancelTaskException.\nIn PR SourceStreamTask reports CancelTaskException if it was cancelled.\nVerifying this change\nThis change is already covered by existing tests, such as StreamSourceOperatorWatermarksTest#testNoMaxWatermarkOnAsyncCancel\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? not applicable", "createdAt": "2020-02-05T13:19:46Z", "url": "https://github.com/apache/flink/pull/11026", "merged": true, "mergeCommit": {"oid": "7d06b11ec5f0c382fe353ba5437bf74b3b40971f"}, "closed": true, "closedAt": "2020-02-05T16:33:47Z", "author": {"login": "rkhachatryan"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBWO89gFqTM1MzcxNDI0NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBYw5OABqjMwMTA3MDMxODg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNzE0MjQ0", "url": "https://github.com/apache/flink/pull/11026#pullrequestreview-353714244", "createdAt": "2020-02-05T13:30:34Z", "commit": {"oid": "c8eaafb64c3d0d2b9045b2fea974a3bb04927cf8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMzozMDozNVrOFl3tzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMzozMDozNVrOFl3tzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI1NDQ3OA==", "bodyText": "We probably need to restore interruption flag Thread.interrupt().", "url": "https://github.com/apache/flink/pull/11026#discussion_r375254478", "createdAt": "2020-02-05T13:30:35Z", "author": {"login": "AHeise"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SourceStreamTask.java", "diffHunk": "@@ -121,10 +123,12 @@ protected void processInput(MailboxDefaultAction.Controller controller) throws E\n \t\tsourceThread.setTaskDescription(getName());\n \t\tsourceThread.start();\n \t\tsourceThread.getCompletionFuture().whenComplete((Void ignore, Throwable sourceThreadThrowable) -> {\n-\t\t\tif (sourceThreadThrowable == null || isFinished) {\n-\t\t\t\tmailboxProcessor.allActionsCompleted();\n-\t\t\t} else {\n+\t\t\tif (isCanceled() && ExceptionUtils.findThrowable(sourceThreadThrowable, InterruptedException.class).isPresent()) {\n+\t\t\t\tmailboxProcessor.reportThrowable(new CancelTaskException(sourceThreadThrowable));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8eaafb64c3d0d2b9045b2fea974a3bb04927cf8"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNzMzODAw", "url": "https://github.com/apache/flink/pull/11026#pullrequestreview-353733800", "createdAt": "2020-02-05T13:59:01Z", "commit": {"oid": "c8eaafb64c3d0d2b9045b2fea974a3bb04927cf8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "255396a280e23efa5474208f18854580226db5e0", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/255396a280e23efa5474208f18854580226db5e0", "committedDate": "2020-02-05T16:30:46Z", "message": "[FLINK-15811][task] report CancelTaskException on SourceStreamTask cancellation\n\nThread interruption and InterruptedException are implementation details\nand shouldn't be exposed. Throw CancelTaskException instead which is a part of informal contract."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c8eaafb64c3d0d2b9045b2fea974a3bb04927cf8", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/c8eaafb64c3d0d2b9045b2fea974a3bb04927cf8", "committedDate": "2020-02-05T13:10:22Z", "message": "[FLINK-15811][task] report CancelTaskException on SourceStreamTask cancellation\n\nThread interruption and InterruptedException are implementation details\nand shouldn't be exposed. Throw CancelTaskException instead which is a part of informal contract."}, "afterCommit": {"oid": "255396a280e23efa5474208f18854580226db5e0", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/255396a280e23efa5474208f18854580226db5e0", "committedDate": "2020-02-05T16:30:46Z", "message": "[FLINK-15811][task] report CancelTaskException on SourceStreamTask cancellation\n\nThread interruption and InterruptedException are implementation details\nand shouldn't be exposed. Throw CancelTaskException instead which is a part of informal contract."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4225, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}