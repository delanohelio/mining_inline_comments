{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MTg1NjU5", "number": 11170, "title": " [FLINK-16033][table-api] Expose catalog lookup function calls in Scala's expression dsl.", "bodyText": "What is the purpose of the change\nFirst of all it fixes the fact that we were loosing function identifier within the expression resolution stack.\nSecond of all it lets users use catalog functions in scala's expression DSL.\nIt is based on #11156\nVerifying this change\nThis change is already covered by existing tests, which were also updated.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-02-21T09:27:06Z", "url": "https://github.com/apache/flink/pull/11170", "merged": true, "mergeCommit": {"oid": "7cee4b1a1b05e1165d37cd9d1580cfe3205c5bc9"}, "closed": true, "closedAt": "2020-02-24T18:19:23Z", "author": {"login": "dawidwys"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGcp3hABqjMwNTk4ODQzNjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHe7AIgBqjMwNjU3MTk4ODc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c85988d5f5074372ff5363164ebfe0244d0dc57", "author": {"user": {"login": "dawidwys", "name": "Dawid Wysakowicz"}}, "url": "https://github.com/apache/flink/commit/2c85988d5f5074372ff5363164ebfe0244d0dc57", "committedDate": "2020-02-21T09:20:20Z", "message": "[FLINK-16033][table-api] Expose catalog lookup function calls in Scala's\nexpression dsl."}, "afterCommit": {"oid": "e13785504108e6e6373e30df43d245a6b47bb1ce", "author": {"user": {"login": "dawidwys", "name": "Dawid Wysakowicz"}}, "url": "https://github.com/apache/flink/commit/e13785504108e6e6373e30df43d245a6b47bb1ce", "committedDate": "2020-02-21T09:52:06Z", "message": "[FLINK-16033][table-api] Expose catalog lookup function calls in Scala's\nexpression dsl."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzIyMzkz", "url": "https://github.com/apache/flink/pull/11170#pullrequestreview-363322393", "createdAt": "2020-02-24T11:26:48Z", "commit": {"oid": "d4eef40b743be60e236da67edb9b1f5fdd4436d3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMToyNjo0OVrOFtdaqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMTo1OTozMVrOFteOjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIxMjIwMg==", "bodyText": "How about we integrate the identifierParser into FunctionLookup. DataTypeFactory has also a method that takes (String). I would like to reduce the number of instances that we need to pass around.", "url": "https://github.com/apache/flink/pull/11170#discussion_r383212202", "createdAt": "2020-02-24T11:26:49Z", "author": {"login": "twalthr"}, "path": "flink-table/flink-table-api-java/src/main/java/org/apache/flink/table/expressions/resolver/ExpressionResolver.java", "diffHunk": "@@ -382,11 +395,13 @@ public CallExpression get(ResolvedExpression composite, ValueLiteralExpression k\n \t\tprivate ExpressionResolverBuilder(\n \t\t\t\tQueryOperation[] queryOperations,\n \t\t\t\tTableConfig config,\n+\t\t\t\tFunction<String, UnresolvedIdentifier> identifierParser,\n \t\t\t\tTableReferenceLookup tableCatalog,\n \t\t\t\tFunctionLookup functionLookup,\n \t\t\t\tDataTypeFactory typeFactory) {\n \t\t\tthis.config = config;\n \t\t\tthis.queryOperations = Arrays.asList(queryOperations);\n+\t\t\tthis.identifierParser = identifierParser;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4eef40b743be60e236da67edb9b1f5fdd4436d3"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIyMTk5Mw==", "bodyText": "remove local variable", "url": "https://github.com/apache/flink/pull/11170#discussion_r383221993", "createdAt": "2020-02-24T11:51:25Z", "author": {"login": "twalthr"}, "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/calcite/FlinkRelBuilder.scala", "diffHunk": "@@ -59,7 +59,7 @@ class FlinkRelBuilder(\n \n   private val toRelNodeConverter = {\n     val functionCatalog = context.unwrap(classOf[FlinkContext]).getFunctionCatalog", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4eef40b743be60e236da67edb9b1f5fdd4436d3"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIyMzc4MA==", "bodyText": "remove \"external\"?", "url": "https://github.com/apache/flink/pull/11170#discussion_r383223780", "createdAt": "2020-02-24T11:55:40Z", "author": {"login": "twalthr"}, "path": "flink-table/flink-table-api-scala/src/main/scala/org/apache/flink/table/api/expressionDsl.scala", "diffHunk": "@@ -1257,6 +1257,38 @@ trait ImplicitExpressionConversions {\n     convertArray(array)\n   }\n \n+  // ----------------------------------------------------------------------------------------------\n+  // Function calls\n+  // ----------------------------------------------------------------------------------------------\n+\n+  /**\n+   * A call to a function that will be looked up in a catalog. There are two kinds of functions:\n+   *\n+   *  - System functions - which are identified with one part names\n+   *  - Catalog functions - which are identified always with three parts names\n+   *    (catalog, database, function)\n+   *\n+   * Moreover each function can either be a temporary function or permanent one\n+   * (which is stored in an external catalog).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e13785504108e6e6373e30df43d245a6b47bb1ce"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIyNDk3Mw==", "bodyText": "Based on those two properties, the resolution order for looking up a function based on the provided path is as follows:", "url": "https://github.com/apache/flink/pull/11170#discussion_r383224973", "createdAt": "2020-02-24T11:58:19Z", "author": {"login": "twalthr"}, "path": "flink-table/flink-table-api-scala/src/main/scala/org/apache/flink/table/api/expressionDsl.scala", "diffHunk": "@@ -1257,6 +1257,38 @@ trait ImplicitExpressionConversions {\n     convertArray(array)\n   }\n \n+  // ----------------------------------------------------------------------------------------------\n+  // Function calls\n+  // ----------------------------------------------------------------------------------------------\n+\n+  /**\n+   * A call to a function that will be looked up in a catalog. There are two kinds of functions:\n+   *\n+   *  - System functions - which are identified with one part names\n+   *  - Catalog functions - which are identified always with three parts names\n+   *    (catalog, database, function)\n+   *\n+   * Moreover each function can either be a temporary function or permanent one\n+   * (which is stored in an external catalog).\n+   *\n+   * Based on that two properties the resolution order for looking up a function based on\n+   * the provided `functionName` is following:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e13785504108e6e6373e30df43d245a6b47bb1ce"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIyNTA2NA==", "bodyText": "nit: remove double empty line", "url": "https://github.com/apache/flink/pull/11170#discussion_r383225064", "createdAt": "2020-02-24T11:58:31Z", "author": {"login": "twalthr"}, "path": "flink-table/flink-table-api-scala/src/main/scala/org/apache/flink/table/api/expressionDsl.scala", "diffHunk": "@@ -1257,6 +1257,38 @@ trait ImplicitExpressionConversions {\n     convertArray(array)\n   }\n \n+  // ----------------------------------------------------------------------------------------------\n+  // Function calls\n+  // ----------------------------------------------------------------------------------------------\n+\n+  /**\n+   * A call to a function that will be looked up in a catalog. There are two kinds of functions:\n+   *\n+   *  - System functions - which are identified with one part names\n+   *  - Catalog functions - which are identified always with three parts names\n+   *    (catalog, database, function)\n+   *\n+   * Moreover each function can either be a temporary function or permanent one\n+   * (which is stored in an external catalog).\n+   *\n+   * Based on that two properties the resolution order for looking up a function based on\n+   * the provided `functionName` is following:\n+   *\n+   *  - Temporary system function\n+   *  - System function\n+   *  - Temporary catalog function\n+   *  - Catalog function\n+   *\n+   *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e13785504108e6e6373e30df43d245a6b47bb1ce"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIyNTQ4NA==", "bodyText": "Should we also offer call(function: FunctionDefinition, ...) or at least call(function: UserDefinedFunction, ...)?", "url": "https://github.com/apache/flink/pull/11170#discussion_r383225484", "createdAt": "2020-02-24T11:59:31Z", "author": {"login": "twalthr"}, "path": "flink-table/flink-table-api-scala/src/main/scala/org/apache/flink/table/api/expressionDsl.scala", "diffHunk": "@@ -1257,6 +1257,38 @@ trait ImplicitExpressionConversions {\n     convertArray(array)\n   }\n \n+  // ----------------------------------------------------------------------------------------------\n+  // Function calls\n+  // ----------------------------------------------------------------------------------------------\n+\n+  /**\n+   * A call to a function that will be looked up in a catalog. There are two kinds of functions:\n+   *\n+   *  - System functions - which are identified with one part names\n+   *  - Catalog functions - which are identified always with three parts names\n+   *    (catalog, database, function)\n+   *\n+   * Moreover each function can either be a temporary function or permanent one\n+   * (which is stored in an external catalog).\n+   *\n+   * Based on that two properties the resolution order for looking up a function based on\n+   * the provided `functionName` is following:\n+   *\n+   *  - Temporary system function\n+   *  - System function\n+   *  - Temporary catalog function\n+   *  - Catalog function\n+   *\n+   *\n+   * @see TableEnvironment#useCatalog(String)\n+   * @see TableEnvironment#useDatabase(String)\n+   * @see TableEnvironment#createTemporaryFunction\n+   * @see TableEnvironment#createTemporarySystemFunction\n+   */\n+  def call(path: String, params: Expression*): Expression = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e13785504108e6e6373e30df43d245a6b47bb1ce"}, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e13785504108e6e6373e30df43d245a6b47bb1ce", "author": {"user": {"login": "dawidwys", "name": "Dawid Wysakowicz"}}, "url": "https://github.com/apache/flink/commit/e13785504108e6e6373e30df43d245a6b47bb1ce", "committedDate": "2020-02-21T09:52:06Z", "message": "[FLINK-16033][table-api] Expose catalog lookup function calls in Scala's\nexpression dsl."}, "afterCommit": {"oid": "6b38701e19f3818b2336f247d5bf183ee48b5abe", "author": {"user": {"login": "dawidwys", "name": "Dawid Wysakowicz"}}, "url": "https://github.com/apache/flink/commit/6b38701e19f3818b2336f247d5bf183ee48b5abe", "committedDate": "2020-02-24T14:50:02Z", "message": "other comments addressed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNDUzOTc2", "url": "https://github.com/apache/flink/pull/11170#pullrequestreview-363453976", "createdAt": "2020-02-24T15:02:22Z", "commit": {"oid": "6b38701e19f3818b2336f247d5bf183ee48b5abe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bbc82f17cc56dade152b0657f745785a6118c1f", "author": {"user": {"login": "dawidwys", "name": "Dawid Wysakowicz"}}, "url": "https://github.com/apache/flink/commit/1bbc82f17cc56dade152b0657f745785a6118c1f", "committedDate": "2020-02-24T15:04:20Z", "message": "[FLINK-16033][table-api] Fix loosing function identifier in ExpressionResolver rules"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bef14e4c89dc24d6c202ac0e3315e540bb81bc9", "author": {"user": {"login": "dawidwys", "name": "Dawid Wysakowicz"}}, "url": "https://github.com/apache/flink/commit/6bef14e4c89dc24d6c202ac0e3315e540bb81bc9", "committedDate": "2020-02-24T15:04:20Z", "message": "[FLINK-16033][table-api] Parse identifiers in FunctionLookup.\n\nThis change effectively enables querying catalogs for catalog functions\nwith qualified names."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65c4ef141c744fd8a51b17c02861225370f08a79", "author": {"user": {"login": "dawidwys", "name": "Dawid Wysakowicz"}}, "url": "https://github.com/apache/flink/commit/65c4ef141c744fd8a51b17c02861225370f08a79", "committedDate": "2020-02-24T15:04:47Z", "message": "[FLINK-16033][table-api] Expose catalog lookup function calls in Scala's\nexpression dsl."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6b38701e19f3818b2336f247d5bf183ee48b5abe", "author": {"user": {"login": "dawidwys", "name": "Dawid Wysakowicz"}}, "url": "https://github.com/apache/flink/commit/6b38701e19f3818b2336f247d5bf183ee48b5abe", "committedDate": "2020-02-24T14:50:02Z", "message": "other comments addressed"}, "afterCommit": {"oid": "65c4ef141c744fd8a51b17c02861225370f08a79", "author": {"user": {"login": "dawidwys", "name": "Dawid Wysakowicz"}}, "url": "https://github.com/apache/flink/commit/65c4ef141c744fd8a51b17c02861225370f08a79", "committedDate": "2020-02-24T15:04:47Z", "message": "[FLINK-16033][table-api] Expose catalog lookup function calls in Scala's\nexpression dsl."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4899, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}