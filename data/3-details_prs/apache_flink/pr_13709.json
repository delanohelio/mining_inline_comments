{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2OTMxODI1", "number": 13709, "title": "[FLINK-19401][checkpointing] Download checkpoints only if needed", "bodyText": "What is the purpose of the change\nIf checkpoints in ZK are the same as already downloaded then skip\ndownload. This prevents excessive S3 reads and eventually failure to\nstart the job, particularly in multi-region recovery.\nVerifying this change\nAdded testNoDownloadIfCheckpointsNotChanged and testDownloadIfCheckpointsChanged to ZooKeeperCompletedCheckpointStoreTest.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? no", "createdAt": "2020-10-20T16:10:23Z", "url": "https://github.com/apache/flink/pull/13709", "merged": true, "mergeCommit": {"oid": "be448ecbd97ff9f79daac9ec7b6ec022d8c4e18d"}, "closed": true, "closedAt": "2020-10-21T19:33:38Z", "author": {"login": "rkhachatryan"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUeAWHgBqjM5MDA0NTI3NDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUyiOAgFqTUxNDExMDI0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1fa8bf62c353d0b3e087826271476529a5e4622a", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/1fa8bf62c353d0b3e087826271476529a5e4622a", "committedDate": "2020-10-20T15:02:41Z", "message": "[FLINK-19401][checkpointing] Download checkpoints only if needed\n\nIf checkpoints in ZK are the same as already downloaded then skip\ndownload. This prevents excessive S3 reads and eventually failure to\nstart the job, particularly in multi-region recovery."}, "afterCommit": {"oid": "14f7ba792a5ff15a1e6c2ca8cae93c7f3c63fe7c", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/14f7ba792a5ff15a1e6c2ca8cae93c7f3c63fe7c", "committedDate": "2020-10-20T19:32:25Z", "message": "[FLINK-19401][checkpointing] Download checkpoints only if needed\n\nIf checkpoints in ZK are the same as already downloaded then skip\ndownload. This prevents excessive S3 reads and eventually failure to\nstart the job, particularly in multi-region recovery."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMzMwNjMy", "url": "https://github.com/apache/flink/pull/13709#pullrequestreview-513330632", "createdAt": "2020-10-21T06:04:20Z", "commit": {"oid": "14f7ba792a5ff15a1e6c2ca8cae93c7f3c63fe7c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNjowNDoyMVrOHlbg7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNjowNDoyMVrOHlbg7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAxMDE1Nw==", "bodyText": "Also log the count of \"All checkpoints\" ?", "url": "https://github.com/apache/flink/pull/13709#discussion_r509010157", "createdAt": "2020-10-21T06:04:21Z", "author": {"login": "Jiayi-Liao"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/ZooKeeperCompletedCheckpointStore.java", "diffHunk": "@@ -143,6 +145,10 @@ public void recover() throws Exception {\n \t\tint numberOfInitialCheckpoints = initialCheckpoints.size();\n \n \t\tLOG.info(\"Found {} checkpoints in ZooKeeper.\", numberOfInitialCheckpoints);\n+\t\tif (haveAllDownloaded(initialCheckpoints)) {\n+\t\t\tLOG.info(\"All checkpoints found are already downloaded.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14f7ba792a5ff15a1e6c2ca8cae93c7f3c63fe7c"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "14f7ba792a5ff15a1e6c2ca8cae93c7f3c63fe7c", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/14f7ba792a5ff15a1e6c2ca8cae93c7f3c63fe7c", "committedDate": "2020-10-20T19:32:25Z", "message": "[FLINK-19401][checkpointing] Download checkpoints only if needed\n\nIf checkpoints in ZK are the same as already downloaded then skip\ndownload. This prevents excessive S3 reads and eventually failure to\nstart the job, particularly in multi-region recovery."}, "afterCommit": {"oid": "6af74f96aa6de790a7d28afd6d438ed8959da4be", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/6af74f96aa6de790a7d28afd6d438ed8959da4be", "committedDate": "2020-10-21T09:47:15Z", "message": "[FLINK-19401][checkpointing] Download checkpoints only if needed\n\nIf checkpoints in ZK are the same as already downloaded then skip\ndownload. This prevents excessive S3 reads and eventually failure to\nstart the job, particularly in multi-region recovery.\n\nZooKeeperHighAvailabilityITCase is dropped is it now fails\nfalse-positively.  Instead, unit testRetrievalFailsRecovery\nwas added in the previous commit."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNTgyMDg1", "url": "https://github.com/apache/flink/pull/13709#pullrequestreview-513582085", "createdAt": "2020-10-21T11:39:31Z", "commit": {"oid": "6924cfd9a0a8172e3e1ef47649936046163ac2da"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMTo0NDo0OVrOHlnrxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMTo0ODozOFrOHln0Iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTIwOTU0Mw==", "bodyText": "Could we reuse ExpectedTestException from runtime testutils package?", "url": "https://github.com/apache/flink/pull/13709#discussion_r509209543", "createdAt": "2020-10-21T11:44:49Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/checkpoint/ZooKeeperCompletedCheckpointStoreTest.java", "diffHunk": "@@ -58,6 +66,54 @@ public void testPathConversion() {\n \t\tassertEquals(checkpointId, ZooKeeperCompletedCheckpointStore.pathToCheckpointId(path));\n \t}\n \n+\tprivate static class TestException extends RuntimeException{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6924cfd9a0a8172e3e1ef47649936046163ac2da"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTIxMTY4Mw==", "bodyText": "What happens if all but one checkpoint have been downloaded? Would it download all of them or just the missing one?\nIf the former, I'd modify this method to return all missing checkpoints instead.", "url": "https://github.com/apache/flink/pull/13709#discussion_r509211683", "createdAt": "2020-10-21T11:48:38Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/ZooKeeperCompletedCheckpointStore.java", "diffHunk": "@@ -143,6 +145,10 @@ public void recover() throws Exception {\n \t\tint numberOfInitialCheckpoints = initialCheckpoints.size();\n \n \t\tLOG.info(\"Found {} checkpoints in ZooKeeper.\", numberOfInitialCheckpoints);\n+\t\tif (haveAllDownloaded(initialCheckpoints)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6af74f96aa6de790a7d28afd6d438ed8959da4be"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73738e6c4954570a146c10ab3fa088ca956929d7", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/73738e6c4954570a146c10ab3fa088ca956929d7", "committedDate": "2020-10-21T13:15:39Z", "message": "[tests][checkpointing] Test retrieval error fails ZKStore.recover\n\nThe added test, coupled with the next change (download checkpoints\nonly if necessary) allows to drop ZK-HA-ITCase. Otherwise,\nZK-HA-ITCase would fail false-positively."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dd7b648660b9c4ae7fdb2bcff5f19bd02caba5c", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/3dd7b648660b9c4ae7fdb2bcff5f19bd02caba5c", "committedDate": "2020-10-21T13:15:39Z", "message": "[FLINK-19401][checkpointing] Download checkpoints only if needed\n\nIf checkpoints in ZK are the same as already downloaded then skip\ndownload. This prevents excessive S3 reads and eventually failure to\nstart the job, particularly in multi-region recovery.\n\nZooKeeperHighAvailabilityITCase is dropped is it now fails\nfalse-positively.  Instead, unit testRetrievalFailsRecovery\nwas added in the previous commit."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6af74f96aa6de790a7d28afd6d438ed8959da4be", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/6af74f96aa6de790a7d28afd6d438ed8959da4be", "committedDate": "2020-10-21T09:47:15Z", "message": "[FLINK-19401][checkpointing] Download checkpoints only if needed\n\nIf checkpoints in ZK are the same as already downloaded then skip\ndownload. This prevents excessive S3 reads and eventually failure to\nstart the job, particularly in multi-region recovery.\n\nZooKeeperHighAvailabilityITCase is dropped is it now fails\nfalse-positively.  Instead, unit testRetrievalFailsRecovery\nwas added in the previous commit."}, "afterCommit": {"oid": "3dd7b648660b9c4ae7fdb2bcff5f19bd02caba5c", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/3dd7b648660b9c4ae7fdb2bcff5f19bd02caba5c", "committedDate": "2020-10-21T13:15:39Z", "message": "[FLINK-19401][checkpointing] Download checkpoints only if needed\n\nIf checkpoints in ZK are the same as already downloaded then skip\ndownload. This prevents excessive S3 reads and eventually failure to\nstart the job, particularly in multi-region recovery.\n\nZooKeeperHighAvailabilityITCase is dropped is it now fails\nfalse-positively.  Instead, unit testRetrievalFailsRecovery\nwas added in the previous commit."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MTEwMjQ5", "url": "https://github.com/apache/flink/pull/13709#pullrequestreview-514110249", "createdAt": "2020-10-21T19:28:22Z", "commit": {"oid": "3dd7b648660b9c4ae7fdb2bcff5f19bd02caba5c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2947, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}