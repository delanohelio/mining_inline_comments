{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1MjI5NDk0", "number": 12042, "title": "[FLINK-16367] [table] Introduce TableEnvironment#createStatementSet api", "bodyText": "What is the purpose of the change\nIntroduce TableEnvironment#createStatementSet api to support accept DML statements and Tables. The planner can optimize all added statements and Tables in StatementSet together and then submit as one job.\nBrief change log\n\nadd TableEnvironment#createStatementSet method\nadd StatementSet interface\nadd related classes and methods in flink-python\n\nVerifying this change\nThis change added tests and can be verified as follows:\n\nExtended TableEnvironmentITCase to verify StatementSet\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-05-08T13:15:13Z", "url": "https://github.com/apache/flink/pull/12042", "merged": true, "mergeCommit": {"oid": "55d04d59825cb1a365cf2940930f15c176a81988"}, "closed": true, "closedAt": "2020-05-10T11:49:53Z", "author": {"login": "godfreyhe"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfRsajAH2gAyNDE1MjI5NDk0OjRlN2U2ZWQ1MGEzNjI1N2EzZTEyY2Y5MTY2ZDJkNTM3NDJhMTQ4ZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcf5rJVgFqTQwODczNzAzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4e7e6ed50a36257a3e12cf9166d2d53742a148de", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/4e7e6ed50a36257a3e12cf9166d2d53742a148de", "committedDate": "2020-05-08T13:14:38Z", "message": "[FLINK-16367] [table] Introduce TableEnvironment#createStatementSet api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MjUxNjY1", "url": "https://github.com/apache/flink/pull/12042#pullrequestreview-408251665", "createdAt": "2020-05-08T13:49:00Z", "commit": {"oid": "4e7e6ed50a36257a3e12cf9166d2d53742a148de"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxMzo0OTowMFrOGSmNAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxMzo1Njo1NFrOGSmdrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE1MzQ3Mw==", "bodyText": "move this before operations", "url": "https://github.com/apache/flink/pull/12042#discussion_r422153473", "createdAt": "2020-05-08T13:49:00Z", "author": {"login": "KurtYoung"}, "path": "flink-table/flink-table-api-java/src/main/java/org/apache/flink/table/api/internal/StatementSetImpl.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.table.api.internal;\n+\n+import org.apache.flink.annotation.Internal;\n+import org.apache.flink.table.api.ExplainDetail;\n+import org.apache.flink.table.api.StatementSet;\n+import org.apache.flink.table.api.Table;\n+import org.apache.flink.table.api.TableException;\n+import org.apache.flink.table.api.TableResult;\n+import org.apache.flink.table.catalog.ObjectIdentifier;\n+import org.apache.flink.table.catalog.UnresolvedIdentifier;\n+import org.apache.flink.table.operations.CatalogSinkModifyOperation;\n+import org.apache.flink.table.operations.ModifyOperation;\n+import org.apache.flink.table.operations.Operation;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Implementation for {@link StatementSet}.\n+ */\n+@Internal\n+class StatementSetImpl implements StatementSet {\n+\tprivate List<ModifyOperation> operations = new ArrayList<>();\n+\tprivate final TableEnvironmentInternal tableEnvironment;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e7e6ed50a36257a3e12cf9166d2d53742a148de"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE1Nzc0Mw==", "bodyText": "how about using the target table name as the column name?", "url": "https://github.com/apache/flink/pull/12042#discussion_r422157743", "createdAt": "2020-05-08T13:56:54Z", "author": {"login": "KurtYoung"}, "path": "flink-table/flink-table-api-java/src/main/java/org/apache/flink/table/api/internal/TableEnvironmentImpl.java", "diffHunk": "@@ -654,13 +655,39 @@ public TableResult executeSql(String statement) {\n \t\treturn executeOperation(operations.get(0));\n \t}\n \n+\t@Override\n+\tpublic StatementSet createStatementSet() {\n+\t\treturn new StatementSetImpl(this);\n+\t}\n+\n \t@Override\n \tpublic TableResult executeInternal(List<ModifyOperation> operations) {\n-\t\tif (operations.size() != 1) {\n-\t\t\tthrow new TableException(\"Only one ModifyOperation is supported now.\");\n-\t\t}\n+\t\tList<Transformation<?>> transformations = translate(operations);\n+\t\tString jobName = extractJobName(operations);\n+\t\tPipeline pipeline = execEnv.createPipeline(transformations, tableConfig, jobName);\n+\t\ttry {\n+\t\t\tJobClient jobClient = execEnv.executeAsync(pipeline);\n+\t\t\tTableSchema.Builder builder = TableSchema.builder();\n+\t\t\tObject[] affectedRowCounts = new Long[operations.size()];\n+\t\t\tfor (int i = 0; i < operations.size(); ++i) {\n+\t\t\t\t// if only one operation, field name is 'affected_rowcount', else is 'affected_rowcount_$i'\n+\t\t\t\tString fieldName = \"affected_rowcount\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e7e6ed50a36257a3e12cf9166d2d53742a148de"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95af2c710bc1453b1930b46dbed83708f08fcc7a", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/95af2c710bc1453b1930b46dbed83708f08fcc7a", "committedDate": "2020-05-08T16:15:55Z", "message": "minor update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjEyODA5", "url": "https://github.com/apache/flink/pull/12042#pullrequestreview-408612809", "createdAt": "2020-05-09T04:59:51Z", "commit": {"oid": "95af2c710bc1453b1930b46dbed83708f08fcc7a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNDo1OTo1MlrOGS4goQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNToxMDo1MVrOGS4jlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MzQwOQ==", "bodyText": "Add this class in the pyflink/table/__init__.py file", "url": "https://github.com/apache/flink/pull/12042#discussion_r422453409", "createdAt": "2020-05-09T04:59:52Z", "author": {"login": "hequn8128"}, "path": "flink-python/pyflink/table/statement_set.py", "diffHunk": "@@ -0,0 +1,93 @@\n+################################################################################\n+#  Licensed to the Apache Software Foundation (ASF) under one\n+#  or more contributor license agreements.  See the NOTICE file\n+#  distributed with this work for additional information\n+#  regarding copyright ownership.  The ASF licenses this file\n+#  to you under the Apache License, Version 2.0 (the\n+#  \"License\"); you may not use this file except in compliance\n+#  with the License.  You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+#  Unless required by applicable law or agreed to in writing, software\n+#  distributed under the License is distributed on an \"AS IS\" BASIS,\n+#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+#  See the License for the specific language governing permissions and\n+# limitations under the License.\n+################################################################################\n+\n+from abc import ABCMeta\n+\n+from pyflink.util.utils import to_j_explain_detail_arr\n+\n+__all__ = ['StatementSet']\n+\n+\n+class StatementSet(object):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95af2c710bc1453b1930b46dbed83708f08fcc7a"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1NDE2NA==", "bodyText": "It seems we don't need this. The class is not an abstract class in the Python side.", "url": "https://github.com/apache/flink/pull/12042#discussion_r422454164", "createdAt": "2020-05-09T05:10:51Z", "author": {"login": "hequn8128"}, "path": "flink-python/pyflink/table/statement_set.py", "diffHunk": "@@ -0,0 +1,93 @@\n+################################################################################\n+#  Licensed to the Apache Software Foundation (ASF) under one\n+#  or more contributor license agreements.  See the NOTICE file\n+#  distributed with this work for additional information\n+#  regarding copyright ownership.  The ASF licenses this file\n+#  to you under the Apache License, Version 2.0 (the\n+#  \"License\"); you may not use this file except in compliance\n+#  with the License.  You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+#  Unless required by applicable law or agreed to in writing, software\n+#  distributed under the License is distributed on an \"AS IS\" BASIS,\n+#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+#  See the License for the specific language governing permissions and\n+# limitations under the License.\n+################################################################################\n+\n+from abc import ABCMeta\n+\n+from pyflink.util.utils import to_j_explain_detail_arr\n+\n+__all__ = ['StatementSet']\n+\n+\n+class StatementSet(object):\n+    \"\"\"\n+    A StatementSet accepts DML statements or Tables,\n+    the planner can optimize all added statements and Tables together\n+    and then submit as one job.\n+\n+    .. note::\n+    The added statements and Tables will be cleared\n+    when calling the `execute` method.\n+    \"\"\"\n+\n+    __metaclass__ = ABCMeta", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95af2c710bc1453b1930b46dbed83708f08fcc7a"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "124d6f95811f3312e17a1a0fdb5ad10e21d1fe06", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/124d6f95811f3312e17a1a0fdb5ad10e21d1fe06", "committedDate": "2020-05-09T08:41:39Z", "message": "address kurt's comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b565b90f9b2d13629f95c15095229b6c0273c1b", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/8b565b90f9b2d13629f95c15095229b6c0273c1b", "committedDate": "2020-05-09T08:45:07Z", "message": "address hequn's comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67032e8cb903a95ec384d6e5e55150dc5c4a8144", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/67032e8cb903a95ec384d6e5e55150dc5c4a8144", "committedDate": "2020-05-09T10:18:17Z", "message": "add TODO"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjQzNTM3", "url": "https://github.com/apache/flink/pull/12042#pullrequestreview-408643537", "createdAt": "2020-05-09T11:49:18Z", "commit": {"oid": "67032e8cb903a95ec384d6e5e55150dc5c4a8144"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQxMTo0OToxOFrOGS6ijw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQxMTo0OToxOFrOGS6ijw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ4NjY3MQ==", "bodyText": "I would prefer to keep it simple for now, just use the full identify is enough.", "url": "https://github.com/apache/flink/pull/12042#discussion_r422486671", "createdAt": "2020-05-09T11:49:18Z", "author": {"login": "KurtYoung"}, "path": "flink-table/flink-table-api-java/src/main/java/org/apache/flink/table/api/internal/TableEnvironmentImpl.java", "diffHunk": "@@ -894,14 +907,48 @@ private TableResult buildShowResult(String[] objects) {\n \t\t\t\t.build();\n \t}\n \n-\tprivate String extractJobName(Operation operation) {\n-\t\tString tableName;\n-\t\tif (operation instanceof CatalogSinkModifyOperation) {\n-\t\t\ttableName = ((CatalogSinkModifyOperation) operation).getTableIdentifier().toString();\n-\t\t} else {\n-\t\t\tthrow new UnsupportedOperationException(\"Unsupported operation: \" + operation);\n+\t/**\n+\t * extract sink identifier names from {@link ModifyOperation}s.\n+\t *\n+\t * <p>This method will keep the shortest form of an identifier,\n+\t * which should be unique between all identifiers. e.g.\n+\t * cat.db.tbl1, cat.db.tbl2, cat.db1.tbl3, cat.db2.tbl3, cat1.db.tbl4, cat2.db.tbl4\n+\t * the result is\n+\t * tbl1, tbl2, db1.tbl3, db2.tbl3, cat1.db.tbl4, cat2.db.tbl4\n+\t */\n+\tprivate List<String> extractSinkIdentifierNames(List<ModifyOperation> operations) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67032e8cb903a95ec384d6e5e55150dc5c4a8144"}, "originalPosition": 99}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3ce5de621cabc2ca7aba0037d1616afa6178b17", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/a3ce5de621cabc2ca7aba0037d1616afa6178b17", "committedDate": "2020-05-09T14:30:47Z", "message": "address kurt's comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b81c9a59867b94c5941f43087f7dd2a359ba07a5", "author": {"user": {"login": "godfreyhe", "name": "godfrey he"}}, "url": "https://github.com/apache/flink/commit/b81c9a59867b94c5941f43087f7dd2a359ba07a5", "committedDate": "2020-05-10T01:16:07Z", "message": "fix python checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NzM3MDM3", "url": "https://github.com/apache/flink/pull/12042#pullrequestreview-408737037", "createdAt": "2020-05-10T11:49:27Z", "commit": {"oid": "b81c9a59867b94c5941f43087f7dd2a359ba07a5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4202, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}