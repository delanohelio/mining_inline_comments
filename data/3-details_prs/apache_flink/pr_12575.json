{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMjgxMzY0", "number": 12575, "title": "[FLINK-18094][checkpointing] Unifies the creation of BarrierHandlers and CheckpointedInputGate.", "bodyText": "What is the purpose of the change\nFor multi-gate inputs, there existed inconsistent offset handling of BarrierHandlers and CheckpointedInputGates for unaligned checkpoints. This PR unifies the creation of BarrierHandlers and CheckpointedInputGate.\nBrief change log\n\nUse the non-unioned (Indexed)InputGates as the main information source that is needed to create handlers.\nUnioned input gates are only used to create the CheckpointedInputGate.\n\nVerifying this change\nCovered by existing (modified) tests.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-06-10T08:10:15Z", "url": "https://github.com/apache/flink/pull/12575", "merged": true, "mergeCommit": {"oid": "1bacaeeef1ac0ee74af9efc5ec3d812e958e49a0"}, "closed": true, "closedAt": "2020-06-17T13:41:18Z", "author": {"login": "AHeise"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcp1ZNigBqjM0Mjg0NzY0Mzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsKCr2AFqTQzMjQxMjE2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e78203ab52f09faadc63801f5978476053b97df1", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/e78203ab52f09faadc63801f5978476053b97df1", "committedDate": "2020-06-10T08:09:20Z", "message": "[FLINK-18094][checkpointing] Unifies the creation of BarrierHandlers and CheckpointedInputGate.\n\nFor multi-gate inputs, there existed inconsistent offset handling of BarrierHandlers and CheckpointedInputGates for unaligned checkpoints.\nThis commit uses the non-unioned (Indexed)InputGates as the main information source that is needed to create handlers.\nUnioned input gates are only used to create the CheckpointedInputGate."}, "afterCommit": {"oid": "d66b663e744026f16bda9effaa5b4c3481dd72a1", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/d66b663e744026f16bda9effaa5b4c3481dd72a1", "committedDate": "2020-06-10T08:29:14Z", "message": "[FLINK-18094][checkpointing] Unifies the creation of BarrierHandlers and CheckpointedInputGate.\n\nFor multi-gate inputs, there existed inconsistent offset handling of BarrierHandlers and CheckpointedInputGates for unaligned checkpoints.\nThis commit uses the non-unioned (Indexed)InputGates as the main information source that is needed to create handlers.\nUnioned input gates are only used to create the CheckpointedInputGate."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d66b663e744026f16bda9effaa5b4c3481dd72a1", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/d66b663e744026f16bda9effaa5b4c3481dd72a1", "committedDate": "2020-06-10T08:29:14Z", "message": "[FLINK-18094][checkpointing] Unifies the creation of BarrierHandlers and CheckpointedInputGate.\n\nFor multi-gate inputs, there existed inconsistent offset handling of BarrierHandlers and CheckpointedInputGates for unaligned checkpoints.\nThis commit uses the non-unioned (Indexed)InputGates as the main information source that is needed to create handlers.\nUnioned input gates are only used to create the CheckpointedInputGate."}, "afterCommit": {"oid": "0f4937a770629aaedc86bdf206fd225667965595", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/0f4937a770629aaedc86bdf206fd225667965595", "committedDate": "2020-06-10T09:46:38Z", "message": "[FLINK-18094][checkpointing] Unifies the creation of BarrierHandlers and CheckpointedInputGate.\n\nFor multi-gate inputs, there existed inconsistent offset handling of BarrierHandlers and CheckpointedInputGates for unaligned checkpoints.\nThis commit uses the non-unioned (Indexed)InputGates as the main information source that is needed to create handlers.\nUnioned input gates are only used to create the CheckpointedInputGate."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3OTA2NTU1", "url": "https://github.com/apache/flink/pull/12575#pullrequestreview-427906555", "createdAt": "2020-06-10T10:06:14Z", "commit": {"oid": "d66b663e744026f16bda9effaa5b4c3481dd72a1"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMDoxMTozN1rOGhuPig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMTo0Mzo0OFrOGhxBMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODAxMzgzNA==", "bodyText": "Can we add a check that returned value is a single-element array to prevent future bugs?", "url": "https://github.com/apache/flink/pull/12575#discussion_r438013834", "createdAt": "2020-06-10T10:11:37Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/InputProcessorUtil.java", "diffHunk": "@@ -28,39 +29,28 @@\n \n import java.util.Arrays;\n import java.util.Collection;\n-import java.util.Comparator;\n-import java.util.HashMap;\n-import java.util.Map;\n-import java.util.stream.IntStream;\n \n /**\n  * Utility for creating {@link CheckpointedInputGate} based on checkpoint mode\n  * for {@link StreamOneInputProcessor} and {@link StreamTwoInputProcessor}.\n  */\n @Internal\n public class InputProcessorUtil {\n-\n+\t@SuppressWarnings(\"unchecked\")\n \tpublic static CheckpointedInputGate createCheckpointedInputGate(\n \t\t\tAbstractInvokable toNotifyOnCheckpoint,\n \t\t\tStreamConfig config,\n \t\t\tSubtaskCheckpointCoordinator checkpointCoordinator,\n \t\t\tIndexedInputGate[] inputGates,\n \t\t\tTaskIOMetricGroup taskIOMetricGroup,\n \t\t\tString taskName) {\n-\t\tInputGate inputGate = InputGateUtil.createInputGate(inputGates);\n-\t\tCheckpointBarrierHandler barrierHandler = createCheckpointBarrierHandler(\n+\t\treturn createCheckpointedMultipleInputGate(\n+\t\t\ttoNotifyOnCheckpoint,\n \t\t\tconfig,\n-\t\t\tArrays.stream(inputGates).mapToInt(InputGate::getNumberOfInputChannels),\n \t\t\tcheckpointCoordinator,\n+\t\t\ttaskIOMetricGroup,\n \t\t\ttaskName,\n-\t\t\tgenerateChannelIndexToInputGateMap(inputGate),\n-\t\t\tgenerateInputGateToChannelIndexOffsetMap(inputGate),\n-\t\t\ttoNotifyOnCheckpoint);\n-\t\tregisterCheckpointMetrics(taskIOMetricGroup, barrierHandler);\n-\n-\t\tbarrierHandler.getBufferReceivedListener().ifPresent(inputGate::registerBufferReceivedListener);\n-\n-\t\treturn new CheckpointedInputGate(inputGate, barrierHandler);\n+\t\t\tArrays.asList(inputGates))[0];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f4937a770629aaedc86bdf206fd225667965595"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA1ODcxNg==", "bodyText": "I see similar code in CheckpointBarrierAligner constructor and same in InputProcessorUtil.createCheckpointedInputGates.\nWDYT about extracting it into something like InputGateResolver and passing it to barrier handlers, input gates and whoever else need it?\nIdeally, I think we should use self-sufficient IDs, but I guess this would be too invasive change.", "url": "https://github.com/apache/flink/pull/12575#discussion_r438058716", "createdAt": "2020-06-10T11:42:27Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/CheckpointBarrierUnaligner.java", "diffHunk": "@@ -91,31 +91,25 @@\n \tprivate final ThreadSafeUnaligner threadSafeUnaligner;\n \n \tCheckpointBarrierUnaligner(\n-\t\t\tint[] numberOfInputChannelsPerGate,\n \t\t\tSubtaskCheckpointCoordinator checkpointCoordinator,\n \t\t\tString taskName,\n-\t\t\tAbstractInvokable toNotifyOnCheckpoint) {\n+\t\t\tAbstractInvokable toNotifyOnCheckpoint,\n+\t\t\tIndexedInputGate... inputGates) {\n \t\tsuper(toNotifyOnCheckpoint);\n \n \t\tthis.taskName = taskName;\n-\n-\t\tfinal int numGates = numberOfInputChannelsPerGate.length;\n-\n-\t\tgateChannelOffsets = new int[numGates];\n-\t\tfor (int index = 1; index < numGates; index++) {\n-\t\t\tgateChannelOffsets[index] = gateChannelOffsets[index - 1] + numberOfInputChannelsPerGate[index - 1];\n-\t\t}\n-\n-\t\tfinal int totalNumChannels = gateChannelOffsets[numGates - 1] + numberOfInputChannelsPerGate[numGates - 1];\n-\t\thasInflightBuffers = new boolean[totalNumChannels];\n-\n-\t\tchannelInfos = IntStream.range(0, numGates)\n-\t\t\t.mapToObj(gateIndex -> IntStream.range(0, numberOfInputChannelsPerGate[gateIndex])\n-\t\t\t\t.mapToObj(channelIndex -> new InputChannelInfo(gateIndex, channelIndex)))\n-\t\t\t.flatMap(Function.identity())\n+\t\tthis.channelInfos = Arrays.stream(inputGates)\n+\t\t\t.flatMap(gate -> gate.getChannels().stream().map(InputChannel::getChannelInfo))\n \t\t\t.toArray(InputChannelInfo[]::new);\n-\n-\t\tthreadSafeUnaligner = new ThreadSafeUnaligner(totalNumChannels,\tcheckNotNull(checkpointCoordinator), this);\n+\t\thasInflightBuffers = new boolean[channelInfos.length];\n+\t\tthreadSafeUnaligner = new ThreadSafeUnaligner(channelInfos.length, checkNotNull(checkpointCoordinator), this);\n+\n+\t\tgateChannelOffsets = new int[inputGates.length];\n+\t\tint offset = 0;\n+\t\tfor (final IndexedInputGate gate: inputGates) {\n+\t\t\tgateChannelOffsets[gate.getGateIndex()] = offset;\n+\t\t\toffset += gate.getNumberOfInputChannels();\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f4937a770629aaedc86bdf206fd225667965595"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA1OTMxMg==", "bodyText": "Replacing an array with Collection allows to lose ordering. Why not to use List instead?", "url": "https://github.com/apache/flink/pull/12575#discussion_r438059312", "createdAt": "2020-06-10T11:43:48Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/InputGateUtil.java", "diffHunk": "@@ -38,18 +40,18 @@ public static InputGate createInputGate(Collection<IndexedInputGate> inputGates1\n \t\tList<IndexedInputGate> gates = new ArrayList<>(inputGates1.size() + inputGates2.size());\n \t\tgates.addAll(inputGates1);\n \t\tgates.addAll(inputGates2);\n-\t\treturn createInputGate(gates.toArray(new IndexedInputGate[gates.size()]));\n+\t\treturn createInputGate(gates);\n \t}\n \n-\tpublic static InputGate createInputGate(IndexedInputGate[] inputGates) {\n-\t\tif (inputGates.length <= 0) {\n+\tpublic static InputGate createInputGate(Collection<IndexedInputGate> inputGates) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f4937a770629aaedc86bdf206fd225667965595"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f4937a770629aaedc86bdf206fd225667965595", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/0f4937a770629aaedc86bdf206fd225667965595", "committedDate": "2020-06-10T09:46:38Z", "message": "[FLINK-18094][checkpointing] Unifies the creation of BarrierHandlers and CheckpointedInputGate.\n\nFor multi-gate inputs, there existed inconsistent offset handling of BarrierHandlers and CheckpointedInputGates for unaligned checkpoints.\nThis commit uses the non-unioned (Indexed)InputGates as the main information source that is needed to create handlers.\nUnioned input gates are only used to create the CheckpointedInputGate."}, "afterCommit": {"oid": "636087d7dbb0ee504de703c83b9a10e934785fb6", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/636087d7dbb0ee504de703c83b9a10e934785fb6", "committedDate": "2020-06-11T19:38:11Z", "message": "[FLINK-18094][checkpointing] Unifies the creation of BarrierHandlers and CheckpointedInputGate.\n\nFor multi-gate inputs, there existed inconsistent offset handling of BarrierHandlers and CheckpointedInputGates for unaligned checkpoints.\nThis commit uses the non-unioned (Indexed)InputGates as the main information source that is needed to create handlers.\nUnioned input gates are only used to create the CheckpointedInputGate."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "636087d7dbb0ee504de703c83b9a10e934785fb6", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/636087d7dbb0ee504de703c83b9a10e934785fb6", "committedDate": "2020-06-11T19:38:11Z", "message": "[FLINK-18094][checkpointing] Unifies the creation of BarrierHandlers and CheckpointedInputGate.\n\nFor multi-gate inputs, there existed inconsistent offset handling of BarrierHandlers and CheckpointedInputGates for unaligned checkpoints.\nThis commit uses the non-unioned (Indexed)InputGates as the main information source that is needed to create handlers.\nUnioned input gates are only used to create the CheckpointedInputGate."}, "afterCommit": {"oid": "358bc25b01b746ad9e27d99359f120b66feaa4dc", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/358bc25b01b746ad9e27d99359f120b66feaa4dc", "committedDate": "2020-06-12T13:04:40Z", "message": "[FLINK-18094][checkpointing] Unifies the creation of BarrierHandlers and CheckpointedInputGate.\n\nFor multi-gate inputs, there existed inconsistent offset handling of BarrierHandlers and CheckpointedInputGates for unaligned checkpoints.\nThis commit uses the non-unioned (Indexed)InputGates as the main information source that is needed to create handlers.\nUnioned input gates are only used to create the CheckpointedInputGate."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "358bc25b01b746ad9e27d99359f120b66feaa4dc", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/358bc25b01b746ad9e27d99359f120b66feaa4dc", "committedDate": "2020-06-12T13:04:40Z", "message": "[FLINK-18094][checkpointing] Unifies the creation of BarrierHandlers and CheckpointedInputGate.\n\nFor multi-gate inputs, there existed inconsistent offset handling of BarrierHandlers and CheckpointedInputGates for unaligned checkpoints.\nThis commit uses the non-unioned (Indexed)InputGates as the main information source that is needed to create handlers.\nUnioned input gates are only used to create the CheckpointedInputGate."}, "afterCommit": {"oid": "931f49223353cc7bd913f17dcfb91df970a24944", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/931f49223353cc7bd913f17dcfb91df970a24944", "committedDate": "2020-06-12T13:52:02Z", "message": "[FLINK-18094][checkpointing] Unifies the creation of BarrierHandlers and CheckpointedInputGate.\n\nFor multi-gate inputs, there existed inconsistent offset handling of BarrierHandlers and CheckpointedInputGates for unaligned checkpoints.\nThis commit uses the non-unioned (Indexed)InputGates as the main information source that is needed to create handlers.\nUnioned input gates are only used to create the CheckpointedInputGate."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "931f49223353cc7bd913f17dcfb91df970a24944", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/931f49223353cc7bd913f17dcfb91df970a24944", "committedDate": "2020-06-12T13:52:02Z", "message": "[FLINK-18094][checkpointing] Unifies the creation of BarrierHandlers and CheckpointedInputGate.\n\nFor multi-gate inputs, there existed inconsistent offset handling of BarrierHandlers and CheckpointedInputGates for unaligned checkpoints.\nThis commit uses the non-unioned (Indexed)InputGates as the main information source that is needed to create handlers.\nUnioned input gates are only used to create the CheckpointedInputGate."}, "afterCommit": {"oid": "d34667c4703367173ab26e84caa111b4b2d5e652", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/d34667c4703367173ab26e84caa111b4b2d5e652", "committedDate": "2020-06-13T11:53:52Z", "message": "[FLINK-18094][checkpointing] Unifies the creation of BarrierHandlers and CheckpointedInputGate.\n\nFor multi-gate inputs, there existed inconsistent offset handling of BarrierHandlers and CheckpointedInputGates for unaligned checkpoints.\nThis commit uses the non-unioned (Indexed)InputGates as the main information source that is needed to create handlers.\nUnioned input gates are only used to create the CheckpointedInputGate."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c64b38313d76096a3e9017897912deb9024a6f85", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/c64b38313d76096a3e9017897912deb9024a6f85", "committedDate": "2020-06-15T09:23:57Z", "message": "[FLINK-18094][network] Performance improvements."}, "afterCommit": {"oid": "09707a507eb7346c5b3782385c416fcaa99ebbd5", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/09707a507eb7346c5b3782385c416fcaa99ebbd5", "committedDate": "2020-06-15T19:38:48Z", "message": "[FLINK-18094][network] Buffers are only addressed through InputChannelInfo.\n\nThis removes the need to translate the InputChannelInfo back and forth to flattened indexes across all InputGates.\nAll index-based data structures are replaced by maps that associate a certain state to a given InputChannelInfo. For performance reasons, these maps are fully initialized upon construction, such that no nodes need to be added/removed during runtime and only values are updated.\nAdditionally, this commit unifies the creation of BarrierHandlers (similar signature) and removes the error-prone offset handling from CheckpointedInputGate."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "09707a507eb7346c5b3782385c416fcaa99ebbd5", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/09707a507eb7346c5b3782385c416fcaa99ebbd5", "committedDate": "2020-06-15T19:38:48Z", "message": "[FLINK-18094][network] Buffers are only addressed through InputChannelInfo.\n\nThis removes the need to translate the InputChannelInfo back and forth to flattened indexes across all InputGates.\nAll index-based data structures are replaced by maps that associate a certain state to a given InputChannelInfo. For performance reasons, these maps are fully initialized upon construction, such that no nodes need to be added/removed during runtime and only values are updated.\nAdditionally, this commit unifies the creation of BarrierHandlers (similar signature) and removes the error-prone offset handling from CheckpointedInputGate."}, "afterCommit": {"oid": "cf35ad99fab120c4ea7795406e65dcb1073ab0ed", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/cf35ad99fab120c4ea7795406e65dcb1073ab0ed", "committedDate": "2020-06-15T19:43:53Z", "message": "[FLINK-18094][network] Buffers are only addressed through InputChannelInfo.\n\nThis removes the need to translate the InputChannelInfo back and forth to flattened indexes across all InputGates.\nAll index-based data structures are replaced by maps that associate a certain state to a given InputChannelInfo. For performance reasons, these maps are fully initialized upon construction, such that no nodes need to be added/removed during runtime and only values are updated.\nAdditionally, this commit unifies the creation of BarrierHandlers (similar signature) and removes the error-prone offset handling from CheckpointedInputGate."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMTcxMzM2", "url": "https://github.com/apache/flink/pull/12575#pullrequestreview-431171336", "createdAt": "2020-06-16T05:33:03Z", "commit": {"oid": "da20240bb34b4ba4b516d67867f9d84819f894fe"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNTozMzowM1rOGkL04w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNTo1NDoyMVrOGkMMcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU5NTY4Mw==", "bodyText": "This seems to be going in the opposite direction - we are replacing indexing based on the real IDs with those based on the order?", "url": "https://github.com/apache/flink/pull/12575#discussion_r440595683", "createdAt": "2020-06-16T05:33:03Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/UnionInputGate.java", "diffHunk": "@@ -105,11 +105,11 @@ public UnionInputGate(IndexedInputGate... inputGates) {\n \t\tinputChannelToInputGateIndex = new int[totalNumberOfInputChannels];\n \n \t\tint currentNumberOfInputChannels = 0;\n-\t\tfor (final IndexedInputGate inputGate : inputGates) {\n-\t\t\tinputGateChannelIndexOffsets[inputGate.getGateIndex()] = currentNumberOfInputChannels;\n+\t\tfor (int index = 0; index < inputGates.length; index++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da20240bb34b4ba4b516d67867f9d84819f894fe"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDYwMTcxMg==", "bodyText": "It's a bit confusing that above we have sortedInputGates and those input gates here are not sorted. It means we end up with a confusing state, where CheckpointBarrierHandler#inputGates can be accessed via inputGateIndex while UnionInputGate#inputGates can not be.\nI understand why is it so, first one is flattened structure of all input gates, while the other has only a subset of gates. Maybe we can keep it as it is for now, as this commit is already simplifying things, but maybe we should replace UnionInputGate#inputGates array with a map?", "url": "https://github.com/apache/flink/pull/12575#discussion_r440601712", "createdAt": "2020-06-16T05:54:21Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/InputProcessorUtil.java", "diffHunk": "@@ -71,108 +69,55 @@ public static CheckpointedInputGate createCheckpointedInputGate(\n \t\t\tString taskName,\n \t\t\tList<IndexedInputGate>... inputGates) {\n \n-\t\tIntStream numberOfInputChannelsPerGate =\n-\t\t\tArrays\n-\t\t\t\t.stream(inputGates)\n-\t\t\t\t.flatMap(collection -> collection.stream())\n-\t\t\t\t.sorted(Comparator.comparingInt(IndexedInputGate::getGateIndex))\n-\t\t\t\t.mapToInt(InputGate::getNumberOfInputChannels);\n-\n-\t\tMap<InputGate, Integer> inputGateToChannelIndexOffset = generateInputGateToChannelIndexOffsetMap(unionedInputGates);\n-\t\t// Note that numberOfInputChannelsPerGate and inputGateToChannelIndexOffset have a bit different\n-\t\t// indexing and purposes.\n-\t\t//\n-\t\t// The numberOfInputChannelsPerGate is indexed based on flattened input gates, and sorted based on GateIndex,\n-\t\t// so that it can be used in combination with InputChannelInfo class.\n-\t\t//\n-\t\t// The inputGateToChannelIndexOffset is based upon unioned input gates and it's use for translating channel\n-\t\t// indexes from perspective of UnionInputGate to perspective of SingleInputGate.\n-\n+\t\tIndexedInputGate[] sortedInputGates = Arrays.stream(inputGates)\n+\t\t\t.flatMap(Collection::stream)\n+\t\t\t.sorted(Comparator.comparing(IndexedInputGate::getGateIndex))\n+\t\t\t.toArray(IndexedInputGate[]::new);\n \t\tCheckpointBarrierHandler barrierHandler = createCheckpointBarrierHandler(\n \t\t\tconfig,\n-\t\t\tnumberOfInputChannelsPerGate,\n+\t\t\tsortedInputGates,\n \t\t\tcheckpointCoordinator,\n \t\t\ttaskName,\n-\t\t\tgenerateChannelIndexToInputGateMap(unionedInputGates),\n-\t\t\tinputGateToChannelIndexOffset,\n \t\t\ttoNotifyOnCheckpoint);\n \t\tregisterCheckpointMetrics(taskIOMetricGroup, barrierHandler);\n \n+\t\tInputGate[] unionedInputGates = Arrays.stream(inputGates)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf35ad99fab120c4ea7795406e65dcb1073ab0ed"}, "originalPosition": 47}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf35ad99fab120c4ea7795406e65dcb1073ab0ed", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/cf35ad99fab120c4ea7795406e65dcb1073ab0ed", "committedDate": "2020-06-15T19:43:53Z", "message": "[FLINK-18094][network] Buffers are only addressed through InputChannelInfo.\n\nThis removes the need to translate the InputChannelInfo back and forth to flattened indexes across all InputGates.\nAll index-based data structures are replaced by maps that associate a certain state to a given InputChannelInfo. For performance reasons, these maps are fully initialized upon construction, such that no nodes need to be added/removed during runtime and only values are updated.\nAdditionally, this commit unifies the creation of BarrierHandlers (similar signature) and removes the error-prone offset handling from CheckpointedInputGate."}, "afterCommit": {"oid": "6713d2a86c8d3c95d14246a404c38aa9b7d97a32", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/6713d2a86c8d3c95d14246a404c38aa9b7d97a32", "committedDate": "2020-06-16T07:23:44Z", "message": "[FLINK-18094][network] Buffers are only addressed through InputChannelInfo.\n\nThis removes the need to translate the InputChannelInfo back and forth to flattened indexes across all InputGates.\nAll index-based data structures are replaced by maps that associate a certain state to a given InputChannelInfo. For performance reasons, these maps are fully initialized upon construction, such that no nodes need to be added/removed during runtime and only values are updated.\nAdditionally, this commit unifies the creation of BarrierHandlers (similar signature) and removes the error-prone offset handling from CheckpointedInputGate."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "685bc5914bc96fbe89be63b64a9668cb38c995ed", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/685bc5914bc96fbe89be63b64a9668cb38c995ed", "committedDate": "2020-06-16T07:35:01Z", "message": "[FLINK-18094][network] Fixed UnionInputGate#getChannel.\n\nThe method assumed that the gates have consecutive indexes starting at 0."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "193c2ba7d80ed5e3a1dccc4b9da69a422361c732", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/193c2ba7d80ed5e3a1dccc4b9da69a422361c732", "committedDate": "2020-06-16T07:35:24Z", "message": "[FLINK-18094][network] Add InputGate#getChannelInfos for easier testing.\n\nIn the following commits, this method will be used to fetch information about all channels without explicitly needing to access the channels. Thus, for tests mocks just need to return meaningful InputChannelInfos instead of actually creating the respective channels."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d7deb349f271c6befc0d27e54113e40ddaed401", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/4d7deb349f271c6befc0d27e54113e40ddaed401", "committedDate": "2020-06-16T07:35:24Z", "message": "[FLINK-18094][network] Simplifying InputProcessorUtil by delegating createCheckpointedInputGate to createCheckpointedMultipleInputGate."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae8782594f13b4bdaa92f1b8dc4ae77e4c701d24", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/ae8782594f13b4bdaa92f1b8dc4ae77e4c701d24", "committedDate": "2020-06-16T07:35:24Z", "message": "[FLINK-18094][network] Using lists instead of collections of gates while creating checkpoint handlers.\n\nThe actual implementation have been lists all along and we assume ordering anyways."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cd0ba630cea402c2aa45e8c5472858e93be757b", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/0cd0ba630cea402c2aa45e8c5472858e93be757b", "committedDate": "2020-06-16T07:35:24Z", "message": "[FLINK-18094][network] Buffers are only addressed through InputChannelInfo.\n\nThis removes the need to translate the InputChannelInfo back and forth to flattened indexes across all InputGates.\nAll index-based data structures are replaced by maps that associate a certain state to a given InputChannelInfo. For performance reasons, these maps are fully initialized upon construction, such that no nodes need to be added/removed during runtime and only values are updated.\nAdditionally, this commit unifies the creation of BarrierHandlers (similar signature) and removes the error-prone offset handling from CheckpointedInputGate."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6713d2a86c8d3c95d14246a404c38aa9b7d97a32", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/6713d2a86c8d3c95d14246a404c38aa9b7d97a32", "committedDate": "2020-06-16T07:23:44Z", "message": "[FLINK-18094][network] Buffers are only addressed through InputChannelInfo.\n\nThis removes the need to translate the InputChannelInfo back and forth to flattened indexes across all InputGates.\nAll index-based data structures are replaced by maps that associate a certain state to a given InputChannelInfo. For performance reasons, these maps are fully initialized upon construction, such that no nodes need to be added/removed during runtime and only values are updated.\nAdditionally, this commit unifies the creation of BarrierHandlers (similar signature) and removes the error-prone offset handling from CheckpointedInputGate."}, "afterCommit": {"oid": "0cd0ba630cea402c2aa45e8c5472858e93be757b", "author": {"user": {"login": "AHeise", "name": "Arvid Heise"}}, "url": "https://github.com/apache/flink/commit/0cd0ba630cea402c2aa45e8c5472858e93be757b", "committedDate": "2020-06-16T07:35:24Z", "message": "[FLINK-18094][network] Buffers are only addressed through InputChannelInfo.\n\nThis removes the need to translate the InputChannelInfo back and forth to flattened indexes across all InputGates.\nAll index-based data structures are replaced by maps that associate a certain state to a given InputChannelInfo. For performance reasons, these maps are fully initialized upon construction, such that no nodes need to be added/removed during runtime and only values are updated.\nAdditionally, this commit unifies the creation of BarrierHandlers (similar signature) and removes the error-prone offset handling from CheckpointedInputGate."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMjQ0ODUx", "url": "https://github.com/apache/flink/pull/12575#pullrequestreview-431244851", "createdAt": "2020-06-16T07:49:10Z", "commit": {"oid": "cf35ad99fab120c4ea7795406e65dcb1073ab0ed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNzo0OTo0MlrOGkPW2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNzo0OTo0MlrOGkPW2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY1MzUyOQ==", "bodyText": "Why do we use Map<Key, Boolean> instead of just  Set<Key> (also in CheckpointBarrierUnaligner, ThreadSafeUnaligner)?\n(I guess we can avoid the penalty of dynamic reallocation by setting set capacity in advance)", "url": "https://github.com/apache/flink/pull/12575#discussion_r440653529", "createdAt": "2020-06-16T07:49:42Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/CheckpointBarrierAligner.java", "diffHunk": "@@ -46,14 +49,8 @@\n \n \tprivate static final Logger LOG = LoggerFactory.getLogger(CheckpointBarrierAligner.class);\n \n-\t/** Used to get InputGate by channel index. */\n-\tprivate final InputGate[] channelIndexToInputGate;\n-\n-\t/** Used to get channel index offset by InputGate. */\n-\tprivate final Map<InputGate, Integer> inputGateToChannelIndexOffset;\n-\n \t/** Flags that indicate whether a channel is currently blocked/buffered. */\n-\tprivate final boolean[] blockedChannels;\n+\tprivate final Map<InputChannelInfo, Boolean> blockedChannels;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cd0ba630cea402c2aa45e8c5472858e93be757b"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMTUxNjE4", "url": "https://github.com/apache/flink/pull/12575#pullrequestreview-432151618", "createdAt": "2020-06-17T07:59:29Z", "commit": {"oid": "0cd0ba630cea402c2aa45e8c5472858e93be757b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNDEyMTYy", "url": "https://github.com/apache/flink/pull/12575#pullrequestreview-432412162", "createdAt": "2020-06-17T13:40:44Z", "commit": {"oid": "0cd0ba630cea402c2aa45e8c5472858e93be757b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3998, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}