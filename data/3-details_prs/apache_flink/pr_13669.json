{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0OTY5MjY0", "number": 13669, "title": "[FLINK-19684][Connector][jdbc]  Fix the Jdbc-connector's  'lookup.max-retries' option implementation ", "bodyText": "What is the purpose of the change\nThe Jdbc-connector's 'lookup.max-retries' option implementation is different from the meaning.\nBrief change log\n\nJdbcRowDataLookupFunction#eval\n\nVerifying this change\nThis change is a trivial rework / code cleanup without any test coverage.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency):no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-10-16T16:42:42Z", "url": "https://github.com/apache/flink/pull/13669", "merged": true, "mergeCommit": {"oid": "bca8e472f943f59c0b226734a7a7c889ff4ba321"}, "closed": true, "closedAt": "2020-10-27T14:06:48Z", "author": {"login": "caozhen1937"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTRLK5gFqTUxMDg2NTEwNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWihYQAFqTUxNzMzNTMzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODY1MTA0", "url": "https://github.com/apache/flink/pull/13669#pullrequestreview-510865104", "createdAt": "2020-10-17T02:01:22Z", "commit": {"oid": "9af35f28ff24e32827dd43dce1009045d0ae671f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QwMjowMToyMlrOHjTeMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QwMjowMToyMlrOHjTeMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc4MTIzNQ==", "bodyText": "sink.max-retries configuration in JdbcBatchingOutputFormat is similar with this, could you also have a change?\nBTW, Commit message should contain issue id etc, following\nhttps://flink.apache.org/contributing/code-style-and-quality-pull-requests.html", "url": "https://github.com/apache/flink/pull/13669#discussion_r506781235", "createdAt": "2020-10-17T02:01:22Z", "author": {"login": "wangxlong"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/table/JdbcRowDataLookupFunction.java", "diffHunk": "@@ -147,7 +147,7 @@ public void eval(Object... keys) {\n \t\t\t}\n \t\t}\n \n-\t\tfor (int retry = 1; retry <= maxRetryTimes; retry++) {\n+\t\tfor (int retry = 0; retry <= maxRetryTimes; retry++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9af35f28ff24e32827dd43dce1009045d0ae671f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNjYxMTIz", "url": "https://github.com/apache/flink/pull/13669#pullrequestreview-512661123", "createdAt": "2020-10-20T12:40:37Z", "commit": {"oid": "d1ac38bd0191d3595711142498ba0c37203be49c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMjo0MDozN1rOHk6TsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMjo0MjoxNFrOHk6X4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2NjA5Nw==", "bodyText": "throw new IllegalArgumentException(String.format(\n    \"The value of '%s' option shouldn't be negative, but is %s.\",\n    LOOKUP_MAX_RETRIES.key(),\n    config.get(LOOKUP_MAX_RETRIES)));", "url": "https://github.com/apache/flink/pull/13669#discussion_r508466097", "createdAt": "2020-10-20T12:40:37Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableFactory.java", "diffHunk": "@@ -308,6 +308,14 @@ private void validateConfigOptions(ReadableConfig config) {\n \t\t\tLOOKUP_CACHE_MAX_ROWS,\n \t\t\tLOOKUP_CACHE_TTL\n \t\t});\n+\n+\t\tif (config.get(LOOKUP_MAX_RETRIES) <= 0) {\n+\t\t\tthrow new IllegalArgumentException(\"The 'lookup.max-retries' should be greater than 0.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1ac38bd0191d3595711142498ba0c37203be49c"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2NjM2OQ==", "bodyText": "Use the option variable instead of hard code the option key.", "url": "https://github.com/apache/flink/pull/13669#discussion_r508466369", "createdAt": "2020-10-20T12:41:01Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableFactory.java", "diffHunk": "@@ -308,6 +308,14 @@ private void validateConfigOptions(ReadableConfig config) {\n \t\t\tLOOKUP_CACHE_MAX_ROWS,\n \t\t\tLOOKUP_CACHE_TTL\n \t\t});\n+\n+\t\tif (config.get(LOOKUP_MAX_RETRIES) <= 0) {\n+\t\t\tthrow new IllegalArgumentException(\"The 'lookup.max-retries' should be greater than 0.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2NjA5Nw=="}, "originalCommit": {"oid": "d1ac38bd0191d3595711142498ba0c37203be49c"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2Njk4Mw==", "bodyText": "ditto.", "url": "https://github.com/apache/flink/pull/13669#discussion_r508466983", "createdAt": "2020-10-20T12:41:58Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableFactory.java", "diffHunk": "@@ -308,6 +308,14 @@ private void validateConfigOptions(ReadableConfig config) {\n \t\t\tLOOKUP_CACHE_MAX_ROWS,\n \t\t\tLOOKUP_CACHE_TTL\n \t\t});\n+\n+\t\tif (config.get(LOOKUP_MAX_RETRIES) <= 0) {\n+\t\t\tthrow new IllegalArgumentException(\"The 'lookup.max-retries' should be greater than 0.\");\n+\t\t}\n+\n+\t\tif (config.get(SINK_MAX_RETRIES) <= 0) {\n+\t\t\tthrow new IllegalArgumentException(\"The 'sink.max-retries' should be greater than 0.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1ac38bd0191d3595711142498ba0c37203be49c"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2NzE2OA==", "bodyText": "I think it can equal to zero?", "url": "https://github.com/apache/flink/pull/13669#discussion_r508467168", "createdAt": "2020-10-20T12:42:14Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableFactory.java", "diffHunk": "@@ -308,6 +308,14 @@ private void validateConfigOptions(ReadableConfig config) {\n \t\t\tLOOKUP_CACHE_MAX_ROWS,\n \t\t\tLOOKUP_CACHE_TTL\n \t\t});\n+\n+\t\tif (config.get(LOOKUP_MAX_RETRIES) <= 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1ac38bd0191d3595711142498ba0c37203be49c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91c30bcb00e8bdfae2d14f6a4dfd0924517ce071", "author": {"user": {"login": "caozhen1937", "name": "caozhen"}}, "url": "https://github.com/apache/flink/commit/91c30bcb00e8bdfae2d14f6a4dfd0924517ce071", "committedDate": "2020-10-27T05:54:24Z", "message": "[FLINK-19684][jdbc] Fix 'max-retries' option doesn't work when set to zero"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "43d89c648207fe8dd3ecb6be95df0d5255381138", "author": {"user": {"login": "caozhen1937", "name": "caozhen"}}, "url": "https://github.com/apache/flink/commit/43d89c648207fe8dd3ecb6be95df0d5255381138", "committedDate": "2020-10-26T11:30:36Z", "message": "[FLINK-19684] Add ITCase and fix bug."}, "afterCommit": {"oid": "91c30bcb00e8bdfae2d14f6a4dfd0924517ce071", "author": {"user": {"login": "caozhen1937", "name": "caozhen"}}, "url": "https://github.com/apache/flink/commit/91c30bcb00e8bdfae2d14f6a4dfd0924517ce071", "committedDate": "2020-10-27T05:54:24Z", "message": "[FLINK-19684][jdbc] Fix 'max-retries' option doesn't work when set to zero"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MzM1MzM0", "url": "https://github.com/apache/flink/pull/13669#pullrequestreview-517335334", "createdAt": "2020-10-27T04:11:13Z", "commit": {"oid": "43d89c648207fe8dd3ecb6be95df0d5255381138"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNDoxMToxM1rOHoqw4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNDoxMToxM1rOHoqw4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQwNTczMQ==", "bodyText": "SELECT * can't test lookup ability.", "url": "https://github.com/apache/flink/pull/13669#discussion_r512405731", "createdAt": "2020-10-27T04:11:13Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-jdbc/src/test/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableSourceITCase.java", "diffHunk": "@@ -125,6 +125,45 @@ public void testJdbcSource() throws Exception {\n \t\tassertEquals(expected, result);\n \t}\n \n+\t@Test\n+\tpublic void testJdbcSourceWithLookupMaxRetries() throws Exception {\n+\t\tStreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+\t\tEnvironmentSettings envSettings = EnvironmentSettings.newInstance()\n+\t\t\t.useBlinkPlanner()\n+\t\t\t.inStreamingMode()\n+\t\t\t.build();\n+\t\tStreamTableEnvironment tEnv = StreamTableEnvironment.create(env, envSettings);\n+\n+\t\ttEnv.executeSql(\n+\t\t\t\"CREATE TABLE \" + INPUT_TABLE + \"(\" +\n+\t\t\t\t\"id BIGINT,\" +\n+\t\t\t\t\"timestamp6_col TIMESTAMP(6),\" +\n+\t\t\t\t\"timestamp9_col TIMESTAMP(9),\" +\n+\t\t\t\t\"time_col TIME,\" +\n+\t\t\t\t\"real_col FLOAT,\" +\n+\t\t\t\t\"double_col DOUBLE,\" +\n+\t\t\t\t\"decimal_col DECIMAL(10, 4)\" +\n+\t\t\t\t\") WITH (\" +\n+\t\t\t\t\"  'connector'='jdbc',\" +\n+\t\t\t\t\"  'url'='\" + DB_URL + \"',\" +\n+\t\t\t\t\"  'lookup.max-retries'='0',\" +\n+\t\t\t\t\"  'table-name'='\" + INPUT_TABLE + \"'\" +\n+\t\t\t\t\")\"\n+\t\t);\n+\n+\t\tIterator<Row> collected = tEnv.executeSql(\"SELECT id FROM \" + INPUT_TABLE).collect();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43d89c648207fe8dd3ecb6be95df0d5255381138"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3365, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}