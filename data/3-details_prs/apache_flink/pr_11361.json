{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MDA0Nzgy", "number": 11361, "title": "[FLINK-15727] Let BashJavaUtils return dynamic configs and JVM parame\u2026", "bodyText": "\u2026ters in one call\nWhat is the purpose of the change\nLet BashJavaUtils return dynamic configs and JVM parameters in one call.\nBrief change log\nLet BashJavaUtils return dynamic configs and JVM parameters in one call. The second last line of output is JVM parameters and the last line is dynamic configs.\nVerifying this change\nThis change is already covered by tests: BashJavaUtilsITCase\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: yes\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no", "createdAt": "2020-03-10T08:46:55Z", "url": "https://github.com/apache/flink/pull/11361", "merged": true, "mergeCommit": {"oid": "ab37867c474a9e5754e79045fa06c9ac145a3787"}, "closed": true, "closedAt": "2020-03-12T12:16:05Z", "author": {"login": "KarmaGYZ"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMmEl_gFqTM3MjY5NzE3OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMyMNpABqjMxMjExNzExMTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNjk3MTc4", "url": "https://github.com/apache/flink/pull/11361#pullrequestreview-372697178", "createdAt": "2020-03-11T12:03:52Z", "commit": {"oid": "cd09736f8968ac04c685e0bd502a18bd163388bf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjowMzo1MlrOF00HXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjoxNDowMVrOF00ZgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyNDEyNA==", "bodyText": "head -n 1 should be sufficient since output already only contains 2 lines.", "url": "https://github.com/apache/flink/pull/11361#discussion_r390924124", "createdAt": "2020-03-11T12:03:52Z", "author": {"login": "zentol"}, "path": "flink-dist/src/test/bin/runBashJavaUtilsCmd.sh", "diffHunk": "@@ -36,5 +36,6 @@ FLINK_DIST_JAR=`find $FLINK_TARGET_DIR -name 'flink-dist*.jar'`\n \n . ${bin}/../../main/flink-bin/bin/config.sh > /dev/null\n \n-output=`runBashJavaUtilsCmd ${COMMAND} ${FLINK_CONF_DIR} \"$FLINK_TARGET_DIR/bash-java-utils.jar:$FLINK_DIST_JAR}\"`\n-extractExecutionParams \"$output\"\n+output=$(runBashJavaUtilsCmd GET_TM_RESOURCE_PARAMS ${FLINK_CONF_DIR} \"$FLINK_TARGET_DIR/bash-java-utils.jar:$FLINK_DIST_JAR}\" | tail -n 2)\n+extractExecutionParams \"$(echo \"$output\" | tail -n 2 | head -n 1)\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd09736f8968ac04c685e0bd502a18bd163388bf"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyNTAzNw==", "bodyText": "head -n 1 should be sufficient since params_output already only contains 2 lines.", "url": "https://github.com/apache/flink/pull/11361#discussion_r390925037", "createdAt": "2020-03-11T12:05:51Z", "author": {"login": "zentol"}, "path": "flink-dist/src/main/flink-bin/bin/taskmanager.sh", "diffHunk": "@@ -48,8 +48,9 @@ if [[ $STARTSTOP == \"start\" ]] || [[ $STARTSTOP == \"start-foreground\" ]]; then\n \n     # Startup parameters\n \n-    jvm_params_output=`runBashJavaUtilsCmd GET_TM_RESOURCE_JVM_PARAMS ${FLINK_CONF_DIR}`\n-    jvm_params=`extractExecutionParams \"$jvm_params_output\"`\n+    params_output=$(runBashJavaUtilsCmd GET_TM_RESOURCE_PARAMS ${FLINK_CONF_DIR} | tail -n 2)\n+\n+    jvm_params=$(extractExecutionParams \"$(echo \"$params_output\" | tail -n 2 | head -n 1)\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd09736f8968ac04c685e0bd502a18bd163388bf"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyNTMyMQ==", "bodyText": "we could just remove the concept of commands.", "url": "https://github.com/apache/flink/pull/11361#discussion_r390925321", "createdAt": "2020-03-11T12:06:28Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/util/BashJavaUtils.java", "diffHunk": "@@ -74,13 +70,8 @@ private static Configuration getConfigurationForStandaloneTaskManagers(String[]\n \t */\n \tpublic enum Command {\n \t\t/**\n-\t\t * Get dynamic configs of task executor resources.\n-\t\t */\n-\t\tGET_TM_RESOURCE_DYNAMIC_CONFIGS,\n-\n-\t\t/**\n-\t\t * Get JVM parameters of task executor resources.\n+\t\t * Get JVM parameters and dynamic configs of task executor resources.\n \t\t */\n-\t\tGET_TM_RESOURCE_JVM_PARAMS\n+\t\tGET_TM_RESOURCE_PARAMS", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd09736f8968ac04c685e0bd502a18bd163388bf"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyODc2OQ==", "bodyText": "shouldn't this be exactly 2 lines? (and if so, use assertEquals)", "url": "https://github.com/apache/flink/pull/11361#discussion_r390928769", "createdAt": "2020-03-11T12:14:01Z", "author": {"login": "zentol"}, "path": "flink-dist/src/test/java/org/apache/flink/dist/BashJavaUtilsITCase.java", "diffHunk": "@@ -36,32 +37,13 @@\n \n \tprivate static final String RUN_BASH_JAVA_UTILS_CMD_SCRIPT = \"src/test/bin/runBashJavaUtilsCmd.sh\";\n \n-\t/**\n-\t * Executes the given shell script wrapper and returns the last line.\n-\t */\n-\tprivate String executeScriptAndFetchLastLine(final String command) throws IOException {\n-\t\tString[] commands = {RUN_BASH_JAVA_UTILS_CMD_SCRIPT, command};\n-\t\tString[] lines = executeScript(commands).split(System.lineSeparator());\n-\t\tif (lines.length == 0) {\n-\t\t\treturn \"\";\n-\t\t} else {\n-\t\t\treturn lines[lines.length - 1];\n-\t\t}\n-\t}\n-\n-\t@Test\n-\tpublic void testGetTmResourceDynamicConfigs() throws Exception {\n-\t\tString result = executeScriptAndFetchLastLine(BashJavaUtils.Command.GET_TM_RESOURCE_DYNAMIC_CONFIGS.toString());\n-\n-\t\tassertNotNull(result);\n-\t\tConfigurationUtils.parseTmResourceDynamicConfigs(result);\n-\t}\n-\n \t@Test\n-\tpublic void testGetTmResourceJvmParams() throws Exception {\n-\t\tString result = executeScriptAndFetchLastLine(BashJavaUtils.Command.GET_TM_RESOURCE_JVM_PARAMS.toString());\n+\tpublic void testGetTmResourceParamsConfigs() throws Exception {\n+\t\tString[] commands = {RUN_BASH_JAVA_UTILS_CMD_SCRIPT, BashJavaUtils.Command.GET_TM_RESOURCE_PARAMS.toString()};\n+\t\tList<String> lines = Arrays.asList(executeScript(commands).split(System.lineSeparator()));\n \n-\t\tassertNotNull(result);\n-\t\tConfigurationUtils.parseTmResourceJvmParams(result);\n+\t\tassertTrue(lines.size() >= 2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd09736f8968ac04c685e0bd502a18bd163388bf"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ffc375e2b14f76c86e56d6d7aa888094a45d475", "author": {"user": {"login": "KarmaGYZ", "name": "Yangze Guo"}}, "url": "https://github.com/apache/flink/commit/1ffc375e2b14f76c86e56d6d7aa888094a45d475", "committedDate": "2020-03-12T02:21:20Z", "message": "[FLINK-15727] Let BashJavaUtils return dynamic configs and JVM parameters in one call"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cd09736f8968ac04c685e0bd502a18bd163388bf", "author": {"user": {"login": "KarmaGYZ", "name": "Yangze Guo"}}, "url": "https://github.com/apache/flink/commit/cd09736f8968ac04c685e0bd502a18bd163388bf", "committedDate": "2020-03-10T07:22:01Z", "message": "[FLINK-15727] Let BashJavaUtils return dynamic configs and JVM parameters in one call"}, "afterCommit": {"oid": "1ffc375e2b14f76c86e56d6d7aa888094a45d475", "author": {"user": {"login": "KarmaGYZ", "name": "Yangze Guo"}}, "url": "https://github.com/apache/flink/commit/1ffc375e2b14f76c86e56d6d7aa888094a45d475", "committedDate": "2020-03-12T02:21:20Z", "message": "[FLINK-15727] Let BashJavaUtils return dynamic configs and JVM parameters in one call"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3202, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}