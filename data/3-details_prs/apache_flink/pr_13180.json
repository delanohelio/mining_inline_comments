{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4OTMyMTUx", "number": 13180, "title": "[FLINK-18962][checkpointing] Improve logging when checkpoint declined", "bodyText": "What is the purpose of the change\nImprove logging when a checkpoint is declined (e.g. target directory is not writable).\nVerifying this change\nTested manually on a local cluster.\nJob Manager\n2020-08-17 18:06:47,238 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Decline checkpoint 4 by task 5271c210329e73bd743f3227edfb3b71_0_0 of job 815316dcc17ceea916d2a4da019aca13 at 127.0.1.1:44861-e3cf2c @ roman-ThinkPad-L380 (dataPort=33273).\norg.apache.flink.util.SerializedThrowable: Could not materialize checkpoint 4 for operator ArtificalKeyedStateMapper_Kryo_and_Custom_Stateful (1/2).\nCaused by: org.apache.flink.util.SerializedThrowable: com.esotericsoftware.kryo.KryoException: java.io.IOException: Could not open output stream for state backend\n\t... \nCaused by: org.apache.flink.util.SerializedThrowable: java.io.IOException: Could not open output stream for state backend\n\t...\nCaused by: org.apache.flink.util.SerializedThrowable: Could not open output stream for state backend\n\t... \nCaused by: org.apache.flink.util.SerializedThrowable: Mkdirs failed to create file:/tmp/forbidden/savepoint-e2e-test-chckpt-dir/815316dcc17ceea916d2a4da019aca13/chk-4\n\t...\n\nTask Manager\n2020-08-17 18:06:45,239 INFO  org.apache.flink.streaming.runtime.tasks.AsyncCheckpointRunnable [] - ArtificalKeyedStateMapper_Kryo_and_Custom_Stateful (2/2) - asynchronous part of checkpoint 2 could not be completed.\njava.util.concurrent.ExecutionException: com.esotericsoftware.kryo.KryoException: java.io.IOException: Could not open output stream for state backend\nCaused by: com.esotericsoftware.kryo.KryoException: java.io.IOException: Could not open output stream for state backend\n\t... \nCaused by: java.io.IOException: Could not open output stream for state backend\n\t...\nCaused by: java.io.IOException: Mkdirs failed to create file:/tmp/forbidden/savepoint-e2e-test-chckpt-dir/815316dcc17ceea916d2a4da019aca13/chk-2\n\t... \n\ncc: @NicoK", "createdAt": "2020-08-17T16:22:01Z", "url": "https://github.com/apache/flink/pull/13180", "merged": true, "mergeCommit": {"oid": "f8ce30a50b8dd803d4476ea5d83e7d48708d54fa"}, "closed": true, "closedAt": "2020-08-20T09:20:01Z", "author": {"login": "rkhachatryan"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAGTJpgFqTQ2OTQwNTg0NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAKM7AAFqTQ2OTY1OTE4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NDA1ODQ1", "url": "https://github.com/apache/flink/pull/13180#pullrequestreview-469405845", "createdAt": "2020-08-18T12:32:15Z", "commit": {"oid": "b823669c9164f5a6d12f2fa4f42621958a1bdcc4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxMjozMjoxNlrOHCROzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxMjozMzozNFrOHCRRjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE0MTUxNg==", "bodyText": "Isn't this is missing a pattern/format change? Also how would you like it to be logged? Just the message.getReason().toString()? Do we care about the stack trace?", "url": "https://github.com/apache/flink/pull/13180#discussion_r472141516", "createdAt": "2020-08-18T12:32:16Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java", "diffHunk": "@@ -887,7 +887,8 @@ public void receiveDeclineMessage(DeclineCheckpoint message, String taskManagerL\n \t\t\t\t\tcheckpointId,\n \t\t\t\t\tmessage.getTaskExecutionId(),\n \t\t\t\t\tjob,\n-\t\t\t\t\ttaskManagerLocationInfo);\n+\t\t\t\t\ttaskManagerLocationInfo,\n+\t\t\t\t\tmessage.getReason());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b823669c9164f5a6d12f2fa4f42621958a1bdcc4"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE0MjIyMg==", "bodyText": "Why has this had to be added? Is it caused by one of your change?", "url": "https://github.com/apache/flink/pull/13180#discussion_r472142222", "createdAt": "2020-08-18T12:33:34Z", "author": {"login": "pnowojski"}, "path": "flink-end-to-end-tests/test-scripts/common.sh", "diffHunk": "@@ -387,6 +387,7 @@ function check_logs_for_exceptions {\n    | grep -v  \"WARN  org.apache.flink.shaded.akka.org.jboss.netty.channel.DefaultChannelPipeline\" \\\n    | grep -v 'INFO.*AWSErrorCode' \\\n    | grep -v \"RejectedExecutionException\" \\\n+   | grep -v \"CancellationException\" \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a1887f46b6baf1b9c09e13691380de416302c01"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bcfb80835ebec1a8e4bd240515852a240631e83", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/0bcfb80835ebec1a8e4bd240515852a240631e83", "committedDate": "2020-08-18T14:28:09Z", "message": "[FLINK-18962][checkpointing][task] Change log level from DEBUG fto INFO or async part errors\n\nNOTE: code change causes CancellationException to be logged at INFO level.\nTo prevent this from failing e2e tests, CancellationException is ignored in e2e error parsing script."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64786549e36be42acbdfb4f63b071f9ded615ad9", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/64786549e36be42acbdfb4f63b071f9ded615ad9", "committedDate": "2020-08-18T14:30:24Z", "message": "[FLINK-18962][checkpointing] Log checkpoint decline reason"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4aea992b6d30869cc742525b56225e3bcead1439", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/4aea992b6d30869cc742525b56225e3bcead1439", "committedDate": "2020-08-18T14:30:24Z", "message": "[hotfix][tests] e2e/common.sh: add -type parameter to find\n\nThis prevents \"Is a directory\" error when running \"head\":\nChecking for exceptions...\nFound exception in log files; printing first 500 lines; see full logs for details:\nhead: error reading '/home/vsts/work/1/s/flink-dist/target/flink-1.12-SNAPSHOT-bin/flink-1.12-SNAPSHOT/log/': Is a directory"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a1887f46b6baf1b9c09e13691380de416302c01", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/2a1887f46b6baf1b9c09e13691380de416302c01", "committedDate": "2020-08-17T22:22:34Z", "message": "[hotfix][tests] Ignore CancellationException in logs"}, "afterCommit": {"oid": "4aea992b6d30869cc742525b56225e3bcead1439", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/4aea992b6d30869cc742525b56225e3bcead1439", "committedDate": "2020-08-18T14:30:24Z", "message": "[hotfix][tests] e2e/common.sh: add -type parameter to find\n\nThis prevents \"Is a directory\" error when running \"head\":\nChecking for exceptions...\nFound exception in log files; printing first 500 lines; see full logs for details:\nhead: error reading '/home/vsts/work/1/s/flink-dist/target/flink-1.12-SNAPSHOT-bin/flink-1.12-SNAPSHOT/log/': Is a directory"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NjU5MTgy", "url": "https://github.com/apache/flink/pull/13180#pullrequestreview-469659182", "createdAt": "2020-08-18T17:10:05Z", "commit": {"oid": "0bcfb80835ebec1a8e4bd240515852a240631e83"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNzoxMDowNVrOHCeGgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNzoxMDowNVrOHCeGgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM1MjM4Nw==", "bodyText": "Won't this flood log with exceptions in some cases?\nThere was some relevant discussion about this when it was being introduced.\nCC @klion26 ?", "url": "https://github.com/apache/flink/pull/13180#discussion_r472352387", "createdAt": "2020-08-18T17:10:05Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/AsyncCheckpointRunnable.java", "diffHunk": "@@ -129,12 +129,10 @@ public void run() {\n \t\t\t\t\tcheckpointMetaData.getCheckpointId());\n \t\t\t}\n \t\t} catch (Exception e) {\n-\t\t\tif (LOG.isDebugEnabled()) {\n-\t\t\t\tLOG.debug(\"{} - asynchronous part of checkpoint {} could not be completed.\",\n-\t\t\t\t\ttaskName,\n-\t\t\t\t\tcheckpointMetaData.getCheckpointId(),\n-\t\t\t\t\te);\n-\t\t\t}\n+\t\t\tLOG.info(\"{} - asynchronous part of checkpoint {} could not be completed.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bcfb80835ebec1a8e4bd240515852a240631e83"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4602, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}