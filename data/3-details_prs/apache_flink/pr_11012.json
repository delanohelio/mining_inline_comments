{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwNjc2MDEz", "number": 11012, "title": "[FLINK-15858][hive] Store generic table schema as properties", "bodyText": "What is the purpose of the change\nStore schema of generic table as properties, so that HiveCatalog is able to support types that are not supported by Hive, e.g. TIMESTAMP(!=9).\nBrief change log\n\nStore table schema as properties when creating generic tables\nRetrieve table schema from properties when getting generic tables\nAdd test\n\nVerifying this change\nExisting and new test cases.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? yes\nIf yes, how is the feature documented? docs", "createdAt": "2020-02-04T06:57:31Z", "url": "https://github.com/apache/flink/pull/11012", "merged": true, "mergeCommit": {"oid": "4fcd877e5c3290412f4a71d1cd01ff3a0b3a4562"}, "closed": true, "closedAt": "2020-02-05T06:47:22Z", "author": {"login": "lirui-apache"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcA8OlbgFqTM1Mjc2MjMwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBOFcAgFqTM1MzQ1NTA4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNzYyMzA4", "url": "https://github.com/apache/flink/pull/11012#pullrequestreview-352762308", "createdAt": "2020-02-04T07:16:18Z", "commit": {"oid": "df658c89289171ef60b8939090fd53982ce46061"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwNzoxNjoxOFrOFlKBbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwNzoxNjoxOFrOFlKBbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUwNTgzNw==", "bodyText": "For compatibility issue, should throw exception now.", "url": "https://github.com/apache/flink/pull/11012#discussion_r374505837", "createdAt": "2020-02-04T07:16:18Z", "author": {"login": "JingsongLi"}, "path": "flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/table/catalog/hive/HiveCatalog.java", "diffHunk": "@@ -587,57 +599,67 @@ protected static Table instantiateHiveTable(ObjectPath tablePath, CatalogBaseTab\n \t\t// When creating a table, A hive table needs explicitly have a key is_generic = false\n \t\t// otherwise, this is a generic table if 1) the key is missing 2) is_generic = true\n \t\t// this is opposite to reading a table and instantiating a CatalogTable. See instantiateCatalogTable()\n+\t\tboolean isGeneric;\n \t\tif (!properties.containsKey(CatalogConfig.IS_GENERIC)) {\n-\t\t\t// must be a generic catalog\n+\t\t\t// must be a generic table\n+\t\t\tisGeneric = true;\n \t\t\tproperties.put(CatalogConfig.IS_GENERIC, String.valueOf(true));\n-\t\t\tproperties = maskFlinkProperties(properties);\n \t\t} else {\n-\t\t\tboolean isGeneric = Boolean.valueOf(properties.get(CatalogConfig.IS_GENERIC));\n-\n-\t\t\tif (isGeneric) {\n-\t\t\t\tproperties = maskFlinkProperties(properties);\n-\t\t\t}\n+\t\t\tisGeneric = Boolean.parseBoolean(properties.get(CatalogConfig.IS_GENERIC));\n \t\t}\n \n-\t\t// Table properties\n-\t\thiveTable.setParameters(properties);\n-\n \t\t// Hive table's StorageDescriptor\n \t\tStorageDescriptor sd = hiveTable.getSd();\n \t\tsetStorageFormat(sd, properties);\n \n-\t\tList<FieldSchema> allColumns = HiveTableUtil.createHiveColumns(table.getSchema());\n-\n-\t\t// Table columns and partition keys\n-\t\tif (table instanceof CatalogTableImpl) {\n-\t\t\tCatalogTable catalogTable = (CatalogTableImpl) table;\n-\n-\t\t\tif (catalogTable.isPartitioned()) {\n-\t\t\t\tint partitionKeySize = catalogTable.getPartitionKeys().size();\n-\t\t\t\tList<FieldSchema> regularColumns = allColumns.subList(0, allColumns.size() - partitionKeySize);\n-\t\t\t\tList<FieldSchema> partitionColumns = allColumns.subList(allColumns.size() - partitionKeySize, allColumns.size());\n+\t\tif (isGeneric) {\n+\t\t\tDescriptorProperties tableSchemaProps = new DescriptorProperties(true);\n+\t\t\ttableSchemaProps.putTableSchema(HiveCatalogConfig.GENERIC_TABLE_SCHEMA_PREFIX, table.getSchema());\n+\t\t\tproperties.putAll(tableSchemaProps.asMap());\n+\n+\t\t\tif (table instanceof CatalogTableImpl) {\n+\t\t\t\tList<String> partColNames = ((CatalogTableImpl) table).getPartitionKeys();\n+\t\t\t\tif (!partColNames.isEmpty()) {\n+\t\t\t\t\tproperties.put(HiveCatalogConfig.GENERIC_PART_COL_NAMES, String.join(\",\", partColNames));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df658c89289171ef60b8939090fd53982ce46061"}, "originalPosition": 144}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNzYyNjY1", "url": "https://github.com/apache/flink/pull/11012#pullrequestreview-352762665", "createdAt": "2020-02-04T07:17:22Z", "commit": {"oid": "df658c89289171ef60b8939090fd53982ce46061"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwNzoxNzoyM1rOFlKCsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwNzoxNzoyM1rOFlKCsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUwNjE2Mw==", "bodyText": "consistent with CatalogConfig.FLINK_PROPERTY_PREFIX?", "url": "https://github.com/apache/flink/pull/11012#discussion_r374506163", "createdAt": "2020-02-04T07:17:23Z", "author": {"login": "JingsongLi"}, "path": "flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/table/catalog/hive/HiveCatalogConfig.java", "diffHunk": "@@ -32,4 +32,9 @@\n \n \t// Partition related configs\n \tpublic static final String PARTITION_LOCATION = \"partition.location\";\n+\n+\t// config prefix for the table schema of a generic table\n+\tpublic static final String GENERIC_TABLE_SCHEMA_PREFIX = \"generic.table.schema\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df658c89289171ef60b8939090fd53982ce46061"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyODc4OTMz", "url": "https://github.com/apache/flink/pull/11012#pullrequestreview-352878933", "createdAt": "2020-02-04T10:44:21Z", "commit": {"oid": "ec67bb7cabd8f8c8cb705b6ea17c955a786da16f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28e964e959d71315532e7f9ce57034e3f736d9f4", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/28e964e959d71315532e7f9ce57034e3f736d9f4", "committedDate": "2020-02-05T01:31:51Z", "message": "[FLINK-15858][hive] Store generic table schema as properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d8b959225a2e800689e829c88b406ae357e2732", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/0d8b959225a2e800689e829c88b406ae357e2732", "committedDate": "2020-02-05T01:31:51Z", "message": "don't support generic partitioned table in HiveCatalog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0a903f95212da071f39bba248900ce6e1b3f3a2", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/a0a903f95212da071f39bba248900ce6e1b3f3a2", "committedDate": "2020-02-05T02:38:39Z", "message": "update UT and doc"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ec67bb7cabd8f8c8cb705b6ea17c955a786da16f", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/ec67bb7cabd8f8c8cb705b6ea17c955a786da16f", "committedDate": "2020-02-04T08:55:53Z", "message": "don't support generic partitioned table in HiveCatalog"}, "afterCommit": {"oid": "a0a903f95212da071f39bba248900ce6e1b3f3a2", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/a0a903f95212da071f39bba248900ce6e1b3f3a2", "committedDate": "2020-02-05T02:38:39Z", "message": "update UT and doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b04ce5c7f696686449f706ee475347cd9d5280e5", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/b04ce5c7f696686449f706ee475347cd9d5280e5", "committedDate": "2020-02-05T03:49:05Z", "message": "add IT case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNDU1MDgz", "url": "https://github.com/apache/flink/pull/11012#pullrequestreview-353455083", "createdAt": "2020-02-05T04:04:37Z", "commit": {"oid": "b04ce5c7f696686449f706ee475347cd9d5280e5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4627, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}