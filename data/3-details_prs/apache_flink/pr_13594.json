{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxNTcwOTk4", "number": 13594, "title": "[FLINK-19423][jdbc] Fix ArrayIndexOutOfBoundsException when executing DELETE statement in JDBC upsert sink", "bodyText": "What is the purpose of the change\nFix ArrayIndexOutOfBoundsException when executing DELETE statement in JDBC upsert sink\nBrief change log\n\nFix JdbcDynamicOutputFormatBuilder#createDeleteExecutor\n\nVerifying this change\n\nAdded a test which can reproduce this problem.\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-10-12T13:15:49Z", "url": "https://github.com/apache/flink/pull/13594", "merged": true, "mergeCommit": {"oid": "42320ef205cb6afd98ffc9c2756a4abc7dc042e6"}, "closed": true, "closedAt": "2020-10-13T10:44:56Z", "author": {"login": "wuchong"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRzxbtAH2gAyNTAxNTcwOTk4OjliY2ViZTdiMWVjNzMzMTkyZjZiOTYwNjdlZGU5ZWNkN2MxODExNWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSFJdoAFqTUwNzI0MTIzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9bcebe7b1ec733192f6b96067ede9ecd7c18115a", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/9bcebe7b1ec733192f6b96067ede9ecd7c18115a", "committedDate": "2020-10-12T13:13:06Z", "message": "[FLINK-19423][jdbc] Fix ArrayIndexOutOfBoundsException when executing DELETE statement in JDBC upsert sink"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MjQxMjMw", "url": "https://github.com/apache/flink/pull/13594#pullrequestreview-507241230", "createdAt": "2020-10-13T09:26:52Z", "commit": {"oid": "9bcebe7b1ec733192f6b96067ede9ecd7c18115a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwOToyNjo1MlrOHgdsng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwOToyNjo1MlrOHgdsng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgwMzAzOA==", "bodyText": "nice catch", "url": "https://github.com/apache/flink/pull/13594#discussion_r503803038", "createdAt": "2020-10-13T09:26:52Z", "author": {"login": "leonardBang"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/table/JdbcDynamicOutputFormatBuilder.java", "diffHunk": "@@ -182,7 +168,12 @@ public JdbcDynamicOutputFormatBuilder setFieldDataTypes(DataType[] fieldDataType\n \t\tcheckArgument(dmlOptions.getKeyFields().isPresent());\n \t\tString[] pkNames = Arrays.stream(pkFields).mapToObj(k -> dmlOptions.getFieldNames()[k]).toArray(String[]::new);\n \t\tString deleteSql = dmlOptions.getDialect().getDeleteStatement(dmlOptions.getTableName(), pkNames);\n-\t\treturn createKeyedRowExecutor(dmlOptions.getDialect(), pkFields, pkTypes, deleteSql, fieldTypes);\n+\t\tJdbcRowConverter rowConverter = dmlOptions.getDialect().getRowConverter(RowType.of(pkTypes));\n+\t\tFunction<RowData, RowData> keyExtractor = createRowKeyExtractor(fieldTypes, pkFields);\n+\t\treturn JdbcBatchStatementExecutor.keyed(\n+\t\t\tdeleteSql,\n+\t\t\tkeyExtractor,\n+\t\t\t(st, key) -> rowConverter.toExternal(key, st));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bcebe7b1ec733192f6b96067ede9ecd7c18115a"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3157, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}