{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzNTUzOTk5", "number": 11509, "title": "[FLINK-16753] Use CheckpointException to wrap exceptions thrown from AsyncCheckpointRunnable", "bodyText": "What is the purpose of the change\nIf an exception is thrown from task's async checkpoint process, the checkpoint will be declined as expected, but the reason for declining checkpoint will be regarded as #CheckpointFailureReason.JOB_FAILURE, which gives a wrong message to users. We should replace #CheckpointFailureReason.JOB_FAILURE with #CheckpointFailureReason.EXCEPTION, otherwise user will see \"The job has failed\" on Checkpoint UI.\nBrief change log\nUse #CheckpointException to wrap the exception thrown from #AsyncCheckpointRunnable.\nVerifying this change\nA trival rework without testing.\nDoes this pull request potentially affect one of the following parts:\nThis change will correct the error message when circumstances mentioned above happen.\nDocumentation\nNo need.", "createdAt": "2020-03-25T12:16:18Z", "url": "https://github.com/apache/flink/pull/11509", "merged": true, "mergeCommit": {"oid": "a1b1dc95210e99e6c23069415283fce4ec3793a5"}, "closed": true, "closedAt": "2020-10-13T06:09:21Z", "author": {"login": "Jiayi-Liao"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRHV-cAFqTM4MTEzNDU1Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSCR8ggFqTUwNzA5MzY5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMTM0NTU2", "url": "https://github.com/apache/flink/pull/11509#pullrequestreview-381134556", "createdAt": "2020-03-25T13:16:08Z", "commit": {"oid": "8bcdb469500c027bf943b1828d15eebf06e09029"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8bcdb469500c027bf943b1828d15eebf06e09029", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/8bcdb469500c027bf943b1828d15eebf06e09029", "committedDate": "2020-03-25T12:12:51Z", "message": "use CheckpointException to wrap exceptions thrown from async checkpointing process"}, "afterCommit": {"oid": "f2abe6b16e459e6b5143c06e9205a8cf93d78ff4", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/f2abe6b16e459e6b5143c06e9205a8cf93d78ff4", "committedDate": "2020-03-30T07:23:00Z", "message": "use CheckpointException to wrap exceptions thrown from AsyncCheckpointRunnable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e01cd5124932776df8549097e1d0d57a31bf3cc4", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/e01cd5124932776df8549097e1d0d57a31bf3cc4", "committedDate": "2020-09-27T07:44:23Z", "message": "use CheckpointException to wrap exceptions thrown from AsyncCheckpointRunnable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f2abe6b16e459e6b5143c06e9205a8cf93d78ff4", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/f2abe6b16e459e6b5143c06e9205a8cf93d78ff4", "committedDate": "2020-03-30T07:23:00Z", "message": "use CheckpointException to wrap exceptions thrown from AsyncCheckpointRunnable"}, "afterCommit": {"oid": "e01cd5124932776df8549097e1d0d57a31bf3cc4", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/e01cd5124932776df8549097e1d0d57a31bf3cc4", "committedDate": "2020-09-27T07:44:23Z", "message": "use CheckpointException to wrap exceptions thrown from AsyncCheckpointRunnable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDc1MzU5", "url": "https://github.com/apache/flink/pull/11509#pullrequestreview-497075359", "createdAt": "2020-09-27T11:40:30Z", "commit": {"oid": "e01cd5124932776df8549097e1d0d57a31bf3cc4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxMTo0MDozMFrOHYm09A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxMTo0MDozMFrOHYm09A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU2NDAyMA==", "bodyText": "I have two concerns for this change:\n\nI saw the motivation from the respective jira description that it wants to resolve the misleading CheckpointFailureReason.JOB_FAILURE. But when I traced the codes, I found the JOB_FAILURE was used in the below region of CheckpointCoordinator#receiveDeclineMessage:\n\nfinal CheckpointException checkpointException;\nif (message.getReason() == null) {\n\t\tcheckpointException = new CheckpointException(CheckpointFailureReason.CHECKPOINT_DECLINED);\n} else {\n\t\tcheckpointException = getCheckpointException(CheckpointFailureReason.JOB_FAILURE, message.getReason());\n}\n\nSo I guess whatever which exception is wrapped here, it would be all regarded as JOB_FAILURE unless null reason. Or I misunderstood something else?\n\nThe semantic seems not correct when we use CheckpointFailureReason.EXCEPTION here, because CheckpointFailureReason#preFlight will be true for this exception. But we know that if the exception happens during async checkpoint process, the semantic of #preFlight should be false.\n\nAnother tiny comment for the formatting is to either make every argument in separate line or both in the same line. :)", "url": "https://github.com/apache/flink/pull/11509#discussion_r495564020", "createdAt": "2020-09-27T11:40:30Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/AsyncCheckpointRunnable.java", "diffHunk": "@@ -197,7 +199,8 @@ private void handleExecutionException(Exception e) {\n \t\t\t\t// We only report the exception for the original cause of fail and cleanup.\n \t\t\t\t// Otherwise this followup exception could race the original exception in failing the task.\n \t\t\t\ttry {\n-\t\t\t\t\ttaskEnvironment.declineCheckpoint(checkpointMetaData.getCheckpointId(), checkpointException);\n+\t\t\t\t\ttaskEnvironment.declineCheckpoint(checkpointMetaData.getCheckpointId(),\n+\t\t\t\t\t\t\tnew CheckpointException(CheckpointFailureReason.EXCEPTION, checkpointException));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e01cd5124932776df8549097e1d0d57a31bf3cc4"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdde82701ae1a784c81ecb14c0f7b779e0c9f65f", "author": {"user": {"login": "Jiayi-Liao", "name": "Jiayi Liao"}}, "url": "https://github.com/apache/flink/commit/fdde82701ae1a784c81ecb14c0f7b779e0c9f65f", "committedDate": "2020-09-29T12:44:01Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a96025249d753072b8eaab23b404ded9b6ddf47", "author": {"user": {"login": "Jiayi-Liao", "name": "Jiayi Liao"}}, "url": "https://github.com/apache/flink/commit/0a96025249d753072b8eaab23b404ded9b6ddf47", "committedDate": "2020-09-29T13:02:49Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "086b22995f36319eff14d180e91a5aae4d1fbcb5", "author": {"user": {"login": "Jiayi-Liao", "name": "Jiayi Liao"}}, "url": "https://github.com/apache/flink/commit/086b22995f36319eff14d180e91a5aae4d1fbcb5", "committedDate": "2020-09-30T02:47:35Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MDkzNjkz", "url": "https://github.com/apache/flink/pull/11509#pullrequestreview-507093693", "createdAt": "2020-10-13T06:07:17Z", "commit": {"oid": "086b22995f36319eff14d180e91a5aae4d1fbcb5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2524, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}