{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0MTY0OTM1", "number": 10887, "title": "[FLINK-15150][tests] Prevent job from reaching terminal state", "bodyText": "Fixes an instability in the ZookeeperLeaderElectionITCase where the shutdown of the Dispatcher caused a slot allocation to fail, resulting in the job failing, reaching a terminal state and afterwards being removed from Zookeeper.\nWe now prevent the job from reaching a terminal state by enabling a fixed-delay restart strategy. Should the allocation fail the JM will retry until the JM itself is being shut down. On shutdown the JM will suspend the job, allowing it to be recovered by other Dispatchers.\nI verified the fix by re-running the test until I ran into the same exception as reporter in the JIRA.\nThe exact behavior for what happens to running jobs when the Dispatcher is shut down in an orderly fashion is currently undefined, and this PR makes no attempt remedy this.", "createdAt": "2020-01-17T14:23:11Z", "url": "https://github.com/apache/flink/pull/10887", "merged": true, "mergeCommit": {"oid": "1b6a07441bc4d31252fa47f67f73fda8bdc85399"}, "closed": true, "closedAt": "2020-01-22T13:54:34Z", "author": {"login": "zentol"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7PaHrAH2gAyMzY0MTY0OTM1OmExNGM5OTMwOTIyM2NiMzZmNmRhNDA0Mjk5MTAyNDdkYmEzNWUyMjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb81cJjAFqTM0NjU3MDc3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a14c99309223cb36f6da40429910247dba35e226", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/a14c99309223cb36f6da40429910247dba35e226", "committedDate": "2020-01-17T14:13:34Z", "message": "[FLINK-15150][tests] Prevent job from reaching terminal state\n\nExplicitly enable restarts; this is necessary since the shutdown may result in the job failing and hence being removed from ZooKeeper.\nWhat happens to running jobs if the Dispatcher shuts down in an orderly fashion is undefined behavior.\nBy allowing restarts we prevent the job from reaching a globally terminal state, causing it to be recovered by the next Dispatcher."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f91b3855bca5e7e2d2d9abf196cca861e122312", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/7f91b3855bca5e7e2d2d9abf196cca861e122312", "committedDate": "2020-01-17T14:14:03Z", "message": "[hotfix][zookeeper] Log changes to SchedulingState"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MDg4ODQ2", "url": "https://github.com/apache/flink/pull/10887#pullrequestreview-346088846", "createdAt": "2020-01-21T18:17:29Z", "commit": {"oid": "7f91b3855bca5e7e2d2d9abf196cca861e122312"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxODoxNzoyOVrOFgD8Ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxODoxNzoyOVrOFgD8Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE2MzM0Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\texecutionConfig.setRestartStrategy(RestartStrategies.fixedDelayRestart(10, Duration.ofSeconds(10).toMillis()));\n          \n          \n            \n            \t\texecutionConfig.setRestartStrategy(RestartStrategies.fixedDelayRestart(100, Duration.ofMillis(100).toMillis()));", "url": "https://github.com/apache/flink/pull/10887#discussion_r369163346", "createdAt": "2020-01-21T18:17:29Z", "author": {"login": "tillrohrmann"}, "path": "flink-tests/src/test/java/org/apache/flink/test/runtime/leaderelection/ZooKeeperLeaderElectionITCase.java", "diffHunk": "@@ -141,13 +144,23 @@ private DispatcherGateway getNextLeadingDispatcherGateway(TestingMiniCluster min\n \t\treturn miniCluster.getDispatcherGatewayFuture().get();\n \t}\n \n-\tprivate JobGraph createJobGraph(int parallelism) {\n+\tprivate JobGraph createJobGraph(int parallelism) throws IOException {\n \t\tBlockingOperator.isBlocking = true;\n \t\tfinal JobVertex vertex = new JobVertex(\"blocking operator\");\n \t\tvertex.setParallelism(parallelism);\n \t\tvertex.setInvokableClass(BlockingOperator.class);\n \n-\t\treturn new JobGraph(\"Blocking test job\", vertex);\n+\t\tJobGraph jobGraph = new JobGraph(\"Blocking test job\", vertex);\n+\n+\t\t// explicitly allow restarts; this is necessary since the shutdown may result in the job failing and hence being\n+\t\t// removed from ZooKeeper. What happens to running jobs if the Dispatcher shuts down in an orderly fashion\n+\t\t// is undefined behavior. By allowing restarts we prevent the job from reaching a globally terminal state,\n+\t\t// causing it to be recovered by the next Dispatcher.\n+\t\tExecutionConfig executionConfig = new ExecutionConfig();\n+\t\texecutionConfig.setRestartStrategy(RestartStrategies.fixedDelayRestart(10, Duration.ofSeconds(10).toMillis()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f91b3855bca5e7e2d2d9abf196cca861e122312"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NTcwNzc0", "url": "https://github.com/apache/flink/pull/10887#pullrequestreview-346570774", "createdAt": "2020-01-22T13:06:06Z", "commit": {"oid": "7f91b3855bca5e7e2d2d9abf196cca861e122312"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4801, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}