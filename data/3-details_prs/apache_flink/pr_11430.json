{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5OTY1OTU2", "number": 11430, "title": "[FLINK-16633][AZP] Fix builds without s3 credentials", "bodyText": "What is the purpose of the change\nProblem: Builds on Azure where failing if S3 credentials were not provided, because the syntax in the pipeline definition was incorrect.\nThis mostly affected PR builds, because they don't have access to the credentials.\nBrief change log\n\nUse a way to access secret variables that leads to an empty value (instead of the variable name). Also, extend the check in the unit tests to \"variable empty\" instead of just \"variable not set\".\n\nVerifying this change\nI triggered a build with and without credentials + there is the test run of this PR.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)", "createdAt": "2020-03-17T17:10:40Z", "url": "https://github.com/apache/flink/pull/11430", "merged": true, "mergeCommit": {"oid": "b226cbd1f595b405f5da376fa3d22e1850fbf4e1"}, "closed": true, "closedAt": "2020-03-20T10:46:21Z", "author": {"login": "rmetzger"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOmYdkAFqTM3NjI2NDA3OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPeK2cgFqTM3ODM3OTM5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MjY0MDc5", "url": "https://github.com/apache/flink/pull/11430#pullrequestreview-376264079", "createdAt": "2020-03-17T17:42:40Z", "commit": {"oid": "25282859e69411e8320cb694679c1404921b5305"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNzo0Mjo0MVrOF3nLrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNzo0NDowNVrOF3nPMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg1Nzk2NQ==", "bodyText": "Add a simple utility function boolean isNotEmpty(@Nullable String) that you call 3 times. This is both more readable and would've prevented bugs like in the second line below where S3_TEST_SECRET_KEY.isEmpty() is missing a negation.", "url": "https://github.com/apache/flink/pull/11430#discussion_r393857965", "createdAt": "2020-03-17T17:42:41Z", "author": {"login": "zentol"}, "path": "flink-test-utils-parent/flink-test-utils-junit/src/main/java/org/apache/flink/testutils/s3/S3TestCredentials.java", "diffHunk": "@@ -44,7 +44,8 @@\n \t * of this JVM.\n \t */\n \tpublic static boolean credentialsAvailable() {\n-\t\treturn S3_TEST_BUCKET != null && S3_TEST_ACCESS_KEY != null && S3_TEST_SECRET_KEY != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25282859e69411e8320cb694679c1404921b5305"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg1ODg2Nw==", "bodyText": "So this was completely broken from the start?", "url": "https://github.com/apache/flink/pull/11430#discussion_r393858867", "createdAt": "2020-03-17T17:44:05Z", "author": {"login": "zentol"}, "path": "tools/azure-pipelines/jobs-template.yml", "diffHunk": "@@ -123,9 +123,9 @@ jobs:\n   - script: STAGE=test ${{parameters.environment}} ./tools/azure_controller.sh $(module)\n     displayName: Test - $(module)\n     env:\n-      IT_CASE_S3_BUCKET: $(IT_CASE_S3_BUCKET)\n-      IT_CASE_S3_ACCESS_KEY: $(IT_CASE_S3_ACCESS_KEY)\n-      IT_CASE_S3_SECRET_KEY: $(IT_CASE_S3_SECRET_KEY)\n+      IT_CASE_S3_BUCKET: ${{variables['IT_CASE_S3_BUCKET']}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25282859e69411e8320cb694679c1404921b5305"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NjMxNjc4", "url": "https://github.com/apache/flink/pull/11430#pullrequestreview-376631678", "createdAt": "2020-03-18T07:58:09Z", "commit": {"oid": "4a2938805ce595d3263da2684bd8f44ff815ab36"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNzo1ODowOVrOF35rlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNzo1ODowOVrOF35rlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE2MTA0Nw==", "bodyText": "let's make it private for no", "url": "https://github.com/apache/flink/pull/11430#discussion_r394161047", "createdAt": "2020-03-18T07:58:09Z", "author": {"login": "zentol"}, "path": "flink-test-utils-parent/flink-test-utils-junit/src/main/java/org/apache/flink/testutils/s3/S3TestCredentials.java", "diffHunk": "@@ -44,7 +44,14 @@\n \t * of this JVM.\n \t */\n \tpublic static boolean credentialsAvailable() {\n-\t\treturn S3_TEST_BUCKET != null && S3_TEST_ACCESS_KEY != null && S3_TEST_SECRET_KEY != null;\n+\t\treturn isNotEmpty(S3_TEST_BUCKET) && isNotEmpty(S3_TEST_ACCESS_KEY) && isNotEmpty(S3_TEST_SECRET_KEY);\n+\t}\n+\n+\t/**\n+\t * Checks if a String is not null and not empty.\n+\t */\n+\tpublic static boolean isNotEmpty(@Nullable String str) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a2938805ce595d3263da2684bd8f44ff815ab36"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85a7515407184f45009e7cbe7f6c7099ea4a41be", "author": {"user": {"login": "rmetzger", "name": "Robert Metzger"}}, "url": "https://github.com/apache/flink/commit/85a7515407184f45009e7cbe7f6c7099ea4a41be", "committedDate": "2020-03-19T14:23:41Z", "message": "[FLINK-16633][AZP] Fix builds without s3 credentials\n\nProblem: Builds on Azure where failing if S3 credentails were not provided, because the syntax in the pipeline definition was incorrect.\n\nSolution: Use a way to access secret variables that leads to an empty value (instead of the variable name). Also, extend the check in the unit tests to \"variable empty\" instead of just \"variable not set\"."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4a2938805ce595d3263da2684bd8f44ff815ab36", "author": {"user": {"login": "rmetzger", "name": "Robert Metzger"}}, "url": "https://github.com/apache/flink/commit/4a2938805ce595d3263da2684bd8f44ff815ab36", "committedDate": "2020-03-18T07:07:07Z", "message": "resolve PR feedback"}, "afterCommit": {"oid": "85a7515407184f45009e7cbe7f6c7099ea4a41be", "author": {"user": {"login": "rmetzger", "name": "Robert Metzger"}}, "url": "https://github.com/apache/flink/commit/85a7515407184f45009e7cbe7f6c7099ea4a41be", "committedDate": "2020-03-19T14:23:41Z", "message": "[FLINK-16633][AZP] Fix builds without s3 credentials\n\nProblem: Builds on Azure where failing if S3 credentails were not provided, because the syntax in the pipeline definition was incorrect.\n\nSolution: Use a way to access secret variables that leads to an empty value (instead of the variable name). Also, extend the check in the unit tests to \"variable empty\" instead of just \"variable not set\"."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3OTA4NzAx", "url": "https://github.com/apache/flink/pull/11430#pullrequestreview-377908701", "createdAt": "2020-03-19T16:51:05Z", "commit": {"oid": "85a7515407184f45009e7cbe7f6c7099ea4a41be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNjo1MTowNlrOF43dgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNjo1MTowNlrOF43dgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE3MzI1MQ==", "bodyText": "Were you not trying $[variables.IT_CASE_S3_BUCKET] in your original post? what else had to be change for things to work?", "url": "https://github.com/apache/flink/pull/11430#discussion_r395173251", "createdAt": "2020-03-19T16:51:06Z", "author": {"login": "zentol"}, "path": "azure-pipelines.yml", "diffHunk": "@@ -40,13 +40,19 @@ resources:\n   - container: flink-build-container\n     image: rmetzger/flink-ci:ubuntu-amd64-3528acd\n \n-# See tools/azure-pipelines/jobs-template.yml for a short summary of the caching\n+# Define variables:\n+# - See tools/azure-pipelines/jobs-template.yml for a short summary of the caching\n+# - See https://stackoverflow.com/questions/60742105/how-can-i-access-a-secret-value-from-an-azure-pipelines-expression", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85a7515407184f45009e7cbe7f6c7099ea4a41be"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4Mzc5Mzk1", "url": "https://github.com/apache/flink/pull/11430#pullrequestreview-378379395", "createdAt": "2020-03-20T10:43:57Z", "commit": {"oid": "85a7515407184f45009e7cbe7f6c7099ea4a41be"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2836, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}