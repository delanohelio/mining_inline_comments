{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MDIxMDky", "number": 12457, "title": "[FLINK-18050][task][checkpointing] Fix double buffer recycling", "bodyText": "What is the purpose of the change\nFix double buffer recycling in ChannelStateWriteRequest.execute and then in cancel.\nVerifying this change\nAdded unit test ChannelStateWriteRequestDispatcherImplTest (testPartialInputChannelStateWrite, testPartialResultSubpartitionStateWrite).\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? no", "createdAt": "2020-06-03T07:40:58Z", "url": "https://github.com/apache/flink/pull/12457", "merged": true, "mergeCommit": {"oid": "f2dd4b8500a82532dae17087c227ce34e1aeac9b"}, "closed": true, "closedAt": "2020-06-08T08:14:15Z", "author": {"login": "rkhachatryan"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnuvMzgFqTQyMzg2OTQ0MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpL4yzABqjM0MTg3MjY4Mjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzODY5NDQw", "url": "https://github.com/apache/flink/pull/12457#pullrequestreview-423869440", "createdAt": "2020-06-03T19:36:06Z", "commit": {"oid": "7e7fa184fdc100b55d436011081b645dc4ef069c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxOTozNjowNlrOGeqepg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxOTozNjowNlrOGeqepg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgwNjQzOA==", "bodyText": "Should be flinkBuffer (or simply buffer).", "url": "https://github.com/apache/flink/pull/12457#discussion_r434806438", "createdAt": "2020-06-03T19:36:06Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateCheckpointWriter.java", "diffHunk": "@@ -108,32 +108,30 @@\n \t\trunWithChecks(() -> serializer.writeHeader(dataStream));\n \t}\n \n-\tvoid writeInput(InputChannelInfo info, Buffer... flinkBuffers) throws Exception {\n+\tvoid writeInput(InputChannelInfo info, Buffer flinkBuffers) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e7fa184fdc100b55d436011081b645dc4ef069c"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e7fa184fdc100b55d436011081b645dc4ef069c", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/7e7fa184fdc100b55d436011081b645dc4ef069c", "committedDate": "2020-06-02T17:56:05Z", "message": "[FLINK-18050][task][checkpointing] Simplify ChannelStateCheckpointWriter interface"}, "afterCommit": {"oid": "c82a846fddbc958f8f7dbd34b67e720147e517d5", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/c82a846fddbc958f8f7dbd34b67e720147e517d5", "committedDate": "2020-06-04T07:47:46Z", "message": "[FLINK-18050][task][checkpointing] Simplify ChannelStateCheckpointWriter interface"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c82a846fddbc958f8f7dbd34b67e720147e517d5", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/c82a846fddbc958f8f7dbd34b67e720147e517d5", "committedDate": "2020-06-04T07:47:46Z", "message": "[FLINK-18050][task][checkpointing] Simplify ChannelStateCheckpointWriter interface"}, "afterCommit": {"oid": "3f7a6a0cdf9514bd87fcbd4738b8373b73771d4f", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/3f7a6a0cdf9514bd87fcbd4738b8373b73771d4f", "committedDate": "2020-06-04T07:48:12Z", "message": "[FLINK-18050][task][checkpointing] Simplify ChannelStateCheckpointWriter interface"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0OTkyNTg0", "url": "https://github.com/apache/flink/pull/12457#pullrequestreview-424992584", "createdAt": "2020-06-05T04:45:50Z", "commit": {"oid": "16d10ec923bd6af73a5188d9d4b86105f252d6f7"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNDo0NTo1MFrOGfgPgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNDo0ODoxNlrOGfgRvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY4NzI5OA==", "bodyText": "What's the difference to the previous version? Especially in the behaviour? It looks like a subtle change that I'm missing.", "url": "https://github.com/apache/flink/pull/12457#discussion_r435687298", "createdAt": "2020-06-05T04:45:50Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateWriteRequest.java", "diffHunk": "@@ -52,6 +53,10 @@ static ChannelStateWriteRequest write(long checkpointId, InputChannelInfo info,\n \t\treturn buildWriteRequest(checkpointId, \"writeInput\", iterator, (writer, buffer) -> writer.writeInput(info, buffer));\n \t}\n \n+\tstatic ChannelStateWriteRequest write(long checkpointId, ResultSubpartitionInfo info, Buffer... buffers) {\n+\t\treturn buildWriteRequest(checkpointId, \"writeOutput\", ofElements(Buffer::recycleBuffer, buffers), (writer, buffer) -> writer.writeOutput(info, buffer));\n+\t}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16d10ec923bd6af73a5188d9d4b86105f252d6f7"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY4NzM5MQ==", "bodyText": "Can you copy JIRA description to this commit description? By looking at it, it's quite hard to understand what is it fixing and how.", "url": "https://github.com/apache/flink/pull/12457#discussion_r435687391", "createdAt": "2020-06-05T04:46:17Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateWriteRequest.java", "diffHunk": "@@ -32,6 +32,7 @@\n import static org.apache.flink.runtime.checkpoint.channel.CheckpointInProgressRequestState.EXECUTING;\n import static org.apache.flink.runtime.checkpoint.channel.CheckpointInProgressRequestState.FAILED;\n import static org.apache.flink.runtime.checkpoint.channel.CheckpointInProgressRequestState.NEW;\n+import static org.apache.flink.util.CloseableIterator.ofElements;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16d10ec923bd6af73a5188d9d4b86105f252d6f7"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY4Nzg2OQ==", "bodyText": "Why have you dropped checkBufferType call? It was actually quite helpful couple of times when debugging. Can not we try to keep it?", "url": "https://github.com/apache/flink/pull/12457#discussion_r435687869", "createdAt": "2020-06-05T04:48:16Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateWriterImpl.java", "diffHunk": "@@ -129,7 +129,7 @@ public void addOutputData(long checkpointId, ResultSubpartitionInfo info, int st\n \t\t\tinfo,\n \t\t\tstartSeqNum,\n \t\t\tdata == null ? 0 : data.length);\n-\t\tenqueue(write(checkpointId, info, checkBufferType(data)), false);\n+\t\tenqueue(write(checkpointId, info, data), false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16d10ec923bd6af73a5188d9d4b86105f252d6f7"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3f7a6a0cdf9514bd87fcbd4738b8373b73771d4f", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/3f7a6a0cdf9514bd87fcbd4738b8373b73771d4f", "committedDate": "2020-06-04T07:48:12Z", "message": "[FLINK-18050][task][checkpointing] Simplify ChannelStateCheckpointWriter interface"}, "afterCommit": {"oid": "a90076edd01cef67caa4afd80fa2e0d7bca50c68", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/a90076edd01cef67caa4afd80fa2e0d7bca50c68", "committedDate": "2020-06-05T07:44:14Z", "message": "[FLINK-18050][task][checkpointing] Simplify ChannelStateCheckpointWriter interface"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1OTk0MDMw", "url": "https://github.com/apache/flink/pull/12457#pullrequestreview-425994030", "createdAt": "2020-06-08T08:00:14Z", "commit": {"oid": "a90076edd01cef67caa4afd80fa2e0d7bca50c68"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f13d5351c3aab2467703f61f4c214ae914c9997", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/4f13d5351c3aab2467703f61f4c214ae914c9997", "committedDate": "2020-06-08T08:06:18Z", "message": "[FLINK-18050][task][checkpointing] Use CloseableIterator to write ResultSubpartition state\n\nCurrently, buffers passed to ChannelStateWriterImpl can be recycled\ntwice: once in normal case after writing; second in\nCheckpointInProgressRequest.cancel (called from ChannelStateWriteRequestDispatcher\nand other places).\n\nThis change prevents this by using CloseableIterator which distinguishes\nused and unused elements."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecde35e592929909c3151aeefdb0f7a934447dd3", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/ecde35e592929909c3151aeefdb0f7a934447dd3", "committedDate": "2020-06-08T08:07:27Z", "message": "[FLINK-18050][task][checkpointing] Simplify ChannelStateCheckpointWriter interface"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a90076edd01cef67caa4afd80fa2e0d7bca50c68", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/a90076edd01cef67caa4afd80fa2e0d7bca50c68", "committedDate": "2020-06-05T07:44:14Z", "message": "[FLINK-18050][task][checkpointing] Simplify ChannelStateCheckpointWriter interface"}, "afterCommit": {"oid": "ecde35e592929909c3151aeefdb0f7a934447dd3", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/ecde35e592929909c3151aeefdb0f7a934447dd3", "committedDate": "2020-06-08T08:07:27Z", "message": "[FLINK-18050][task][checkpointing] Simplify ChannelStateCheckpointWriter interface"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4242, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}