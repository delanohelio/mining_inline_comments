{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2NjE3MDU5", "number": 13958, "title": "[FLINK-19994][runtime] Do not force iteration job to generate one only pipelined region", "bodyText": "What is the purpose of the change\nAfter switching to pipelined region scheduling, all vertices in an DataSet iteration job will be eagerly scheduled, which means BLOCKING result consumers can be deployed even before the result finishes and resource waste happens. This is because all vertices will be put into one pipelined region if the job contains ColocationConstraint, see PipelinedRegionComputeUtil.\nThis makeAllOneRegion() behavior was introduced to ensure co-located iteration head and tail to be restarted together in pipelined region failover. However, given that edges within an iteration will always be PIPELINED (ref), co-located iteration head and tail will always be in the same region. So we can drop the PipelinedRegionComputeUtil#makeAllOneRegion() code path and build regions for iteration jobs in the normal way.\nVerifying this change\nAdded UT for the checking that iteration head and tail must be in one pipelined region.\nThis change is already covered by existing iteration tests.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-11-06T09:22:50Z", "url": "https://github.com/apache/flink/pull/13958", "merged": true, "mergeCommit": {"oid": "a9d859b36b47cb433d2bb159d4a8848b769c8710"}, "closed": true, "closedAt": "2020-11-10T19:08:43Z", "author": {"login": "zhuzhurk"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZ2ILggBqjM5NjY5OTE3NjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbJvClgFqTUyNzIyMjExNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa6d5df960eef81ded0853988124244a13381844", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/fa6d5df960eef81ded0853988124244a13381844", "committedDate": "2020-11-06T09:16:22Z", "message": "[FLINK-19994][runtime] Remove unused interface method BaseTopology#containsCoLocationConstraints()"}, "afterCommit": {"oid": "e6c7892e55dd4baaff4968e4257a63a51023d841", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/e6c7892e55dd4baaff4968e4257a63a51023d841", "committedDate": "2020-11-06T12:28:43Z", "message": "[FLINK-19994][runtime] Remove unused interface method BaseTopology#containsCoLocationConstraints()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MjA4Nzk0", "url": "https://github.com/apache/flink/pull/13958#pullrequestreview-525208794", "createdAt": "2020-11-06T14:34:46Z", "commit": {"oid": "e6c7892e55dd4baaff4968e4257a63a51023d841"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDozNDo0N1rOHuwaGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDozNDo0N1rOHuwaGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc4OTY1Nw==", "bodyText": "This seems to also put CoLocationConstraint == null into the map.\nThe test also passes because of it. Is it expected? The test graph (2 disjoint JVs w/o CoLocationConstraints) seems to be a normal graph. Why should the test fail?", "url": "https://github.com/apache/flink/pull/13958#discussion_r518789657", "createdAt": "2020-11-06T14:34:47Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/scheduler/adapter/DefaultExecutionTopology.java", "diffHunk": "@@ -201,4 +195,32 @@ private static void connectVerticesToConsumedPartitions(\n \t\t\t}\n \t\t}\n \t}\n+\n+\t/**\n+\t * Co-location constraints are only used for iteration head and tail.\n+\t * A paired head and tail needs to be in the same pipelined region so\n+\t * that they can be restarted together.\n+\t */\n+\tprivate void ensureCoLocatedVerticesInSameRegion() {\n+\t\tfinal Map<CoLocationConstraint, DefaultSchedulingPipelinedRegion> constraintToRegion = new IdentityHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6c7892e55dd4baaff4968e4257a63a51023d841"}, "originalPosition": 82}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MjEwODUz", "url": "https://github.com/apache/flink/pull/13958#pullrequestreview-525210853", "createdAt": "2020-11-06T14:37:05Z", "commit": {"oid": "e6c7892e55dd4baaff4968e4257a63a51023d841"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDozNzowNVrOHuwgGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDozNzowNVrOHuwgGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5MTE5Mg==", "bodyText": "Maybe a side note not for this PR: I would put initializePipelinedRegions and ensureCoLocatedVerticesInSameRegion into a factory method fromExecutionGraph.", "url": "https://github.com/apache/flink/pull/13958#discussion_r518791192", "createdAt": "2020-11-06T14:37:05Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/scheduler/adapter/DefaultExecutionTopology.java", "diffHunk": "@@ -91,6 +88,8 @@ public DefaultExecutionTopology(ExecutionGraph graph) {\n \t\tthis.pipelinedRegionsByVertex = new HashMap<>();\n \t\tthis.pipelinedRegions = new ArrayList<>();\n \t\tinitializePipelinedRegions();\n+\n+\t\tensureCoLocatedVerticesInSameRegion();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6c7892e55dd4baaff4968e4257a63a51023d841"}, "originalPosition": 55}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e6c7892e55dd4baaff4968e4257a63a51023d841", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/e6c7892e55dd4baaff4968e4257a63a51023d841", "committedDate": "2020-11-06T12:28:43Z", "message": "[FLINK-19994][runtime] Remove unused interface method BaseTopology#containsCoLocationConstraints()"}, "afterCommit": {"oid": "c1b246f5f8538f9bf313c9456a04aac3fdf54b67", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/c1b246f5f8538f9bf313c9456a04aac3fdf54b67", "committedDate": "2020-11-07T06:35:42Z", "message": "refine check of colocated region"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c1b246f5f8538f9bf313c9456a04aac3fdf54b67", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/c1b246f5f8538f9bf313c9456a04aac3fdf54b67", "committedDate": "2020-11-07T06:35:42Z", "message": "refine check of colocated region"}, "afterCommit": {"oid": "964580e303ef47cb868c3cfe5e3d0fb855c0c2a3", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/964580e303ef47cb868c3cfe5e3d0fb855c0c2a3", "committedDate": "2020-11-07T07:08:29Z", "message": "[FLINK-19994][hotfix][runtime] Build pipelined regions only after DefaultExecutionTopology is fully constructed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "964580e303ef47cb868c3cfe5e3d0fb855c0c2a3", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/964580e303ef47cb868c3cfe5e3d0fb855c0c2a3", "committedDate": "2020-11-07T07:08:29Z", "message": "[FLINK-19994][hotfix][runtime] Build pipelined regions only after DefaultExecutionTopology is fully constructed"}, "afterCommit": {"oid": "f66208c7971d2010aa0d43b4e589a0ed399192a6", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/f66208c7971d2010aa0d43b4e589a0ed399192a6", "committedDate": "2020-11-07T11:32:45Z", "message": "fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MDgxMDE4", "url": "https://github.com/apache/flink/pull/13958#pullrequestreview-526081018", "createdAt": "2020-11-09T09:47:01Z", "commit": {"oid": "2925bc7e08598f79841cb3add571292bcf87127b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwOTo0NzowMVrOHvmgyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwOTo0NzowMVrOHvmgyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY3NjEwNA==", "bodyText": "If we are already factoring out initializePipelinedRegions, could we generate all dependencies of DefaultExecutionTopology in the factory method fromExecutionGraph? This should generally separate concerns and make potential testing simpler.\nI also would put this commit before the actual change of this PR if this is not much effort.", "url": "https://github.com/apache/flink/pull/13958#discussion_r519676104", "createdAt": "2020-11-09T09:47:01Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/scheduler/adapter/DefaultExecutionTopology.java", "diffHunk": "@@ -51,20 +53,20 @@\n \n \tprivate static final Logger LOG = LoggerFactory.getLogger(DefaultExecutionTopology.class);\n \n-\tprivate final ExecutionGraph executionGraph;\n-\n \tprivate final Map<ExecutionVertexID, DefaultExecutionVertex> executionVerticesById;\n \n \tprivate final List<DefaultExecutionVertex> executionVerticesList;\n \n \tprivate final Map<IntermediateResultPartitionID, DefaultResultPartition> resultPartitionsById;\n \n-\tprivate final Map<ExecutionVertexID, DefaultSchedulingPipelinedRegion> pipelinedRegionsByVertex;\n+\t@Nullable\n+\tprivate Map<ExecutionVertexID, DefaultSchedulingPipelinedRegion> pipelinedRegionsByVertex;\n \n-\tprivate final List<DefaultSchedulingPipelinedRegion> pipelinedRegions;\n+\t@Nullable\n+\tprivate List<DefaultSchedulingPipelinedRegion> pipelinedRegions;\n \n-\tpublic DefaultExecutionTopology(ExecutionGraph graph) {\n-\t\tthis.executionGraph = checkNotNull(graph, \"execution graph can not be null\");\n+\tprivate DefaultExecutionTopology(ExecutionGraph graph) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2925bc7e08598f79841cb3add571292bcf87127b"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f66208c7971d2010aa0d43b4e589a0ed399192a6", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/f66208c7971d2010aa0d43b4e589a0ed399192a6", "committedDate": "2020-11-07T11:32:45Z", "message": "fix tests"}, "afterCommit": {"oid": "dd4f926834e2ad0209e72f288d04b1c2d0208cb0", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/dd4f926834e2ad0209e72f288d04b1c2d0208cb0", "committedDate": "2020-11-09T13:04:27Z", "message": "[FLINK-19994][runtime] Remove unused interface method BaseTopology#containsCoLocationConstraints()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d90cc11078d496cfe3355afc95711501f9f692bb", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/d90cc11078d496cfe3355afc95711501f9f692bb", "committedDate": "2020-11-10T11:55:35Z", "message": "[FLINK-19994][hotfix][runtime] Build pipelined regions only after DefaultExecutionTopology is fully constructed\n\nCurrently the `this` ref of DefaultExecutionTopology is published to PipelinedRegionComputeUtil in the constructor. This is a dangerous behavior and this commit targets to fix it."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b02cb6f27e881e06e81af50ee6e101240ee888c", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/6b02cb6f27e881e06e81af50ee6e101240ee888c", "committedDate": "2020-11-10T11:55:35Z", "message": "[FLINK-19994][runtime] Do not force iteration job to generate one only pipelined region"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e08b6b6d4a8dd32da4885944b31b682563f7070", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/7e08b6b6d4a8dd32da4885944b31b682563f7070", "committedDate": "2020-11-10T11:55:35Z", "message": "[FLINK-19994][runtime] Remove unused interface method BaseTopology#containsCoLocationConstraints()"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dd4f926834e2ad0209e72f288d04b1c2d0208cb0", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/dd4f926834e2ad0209e72f288d04b1c2d0208cb0", "committedDate": "2020-11-09T13:04:27Z", "message": "[FLINK-19994][runtime] Remove unused interface method BaseTopology#containsCoLocationConstraints()"}, "afterCommit": {"oid": "7e08b6b6d4a8dd32da4885944b31b682563f7070", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/7e08b6b6d4a8dd32da4885944b31b682563f7070", "committedDate": "2020-11-10T11:55:35Z", "message": "[FLINK-19994][runtime] Remove unused interface method BaseTopology#containsCoLocationConstraints()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MjIyMTE1", "url": "https://github.com/apache/flink/pull/13958#pullrequestreview-527222115", "createdAt": "2020-11-10T13:53:43Z", "commit": {"oid": "7e08b6b6d4a8dd32da4885944b31b682563f7070"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4430, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}