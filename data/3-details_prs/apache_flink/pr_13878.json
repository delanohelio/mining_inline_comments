{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzOTUzNzk5", "number": 13878, "title": "[FLINK-19924][config] Disallow UC for iterative jobs", "bodyText": "What is the purpose of the change\nFrom 1.12, Unaligned checkpoints will support rescaling.\nBut it will be limited to non-iterative jobs.\nThis PR adds:\n\nvalidation: non-iterative or non-UC\na flag to skip validation\npassing a flag to subtasks (whether the job is iterative)\n\nBrief change log\n\nDisallow Unaligned Checkpoints for iterative jobs by default\nAdd an option to force Unaligned Checkpoints\nAdd StreamConfig.isGraphContainingLoops\n\nVerifying this change\nThis change is a trivial rework without any test coverage.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): yes\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: yes\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? not applicable", "createdAt": "2020-11-02T10:21:37Z", "url": "https://github.com/apache/flink/pull/13878", "merged": true, "mergeCommit": {"oid": "1f40502d90aefe9ede6945d692bce678071200eb"}, "closed": true, "closedAt": "2020-11-03T12:25:31Z", "author": {"login": "rkhachatryan"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYiG3EgFqTUyMTUwNDAzNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY4P8bgBqjM5NTI2MDM3NTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNTA0MDM1", "url": "https://github.com/apache/flink/pull/13878#pullrequestreview-521504035", "createdAt": "2020-11-02T10:26:55Z", "commit": {"oid": "3d255dc9980995cb82f157e28876a41092b64fe9"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMDoyNjo1NlrOHr-hnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMDozNToxMlrOHr-0mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg3NTIzMQ==", "bodyText": "You probably need to generate docs and add them to this commit.\n mvn install -Dgenerate-config-docs -pl flink-docs", "url": "https://github.com/apache/flink/pull/13878#discussion_r515875231", "createdAt": "2020-11-02T10:26:56Z", "author": {"login": "AHeise"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/ExecutionCheckpointingOptions.java", "diffHunk": "@@ -159,4 +159,12 @@\n \t\t\t\t\t\"If during checkpointing, checkpoint start delay exceeds this timeout, alignment \" +\n \t\t\t\t\t\"will timeout and checkpoint barrier will start working as unaligned checkpoint.\")\n \t\t\t\t.build());\n+\n+\tpublic static final ConfigOption<Boolean> FORCE_UNALIGNED =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d255dc9980995cb82f157e28876a41092b64fe9"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg3NTcyNQ==", "bodyText": "The first getter looks odd. At least the description and tags are wrong.", "url": "https://github.com/apache/flink/pull/13878#discussion_r515875725", "createdAt": "2020-11-02T10:27:47Z", "author": {"login": "AHeise"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/StreamExecutionEnvironment.java", "diffHunk": "@@ -524,6 +524,28 @@ public boolean isForceCheckpointing() {\n \t\treturn checkpointCfg.isForceCheckpointing();\n \t}\n \n+\t/**\n+\t * Returns whether Unaligned Checkpoints are force-enabled.\n+\t *\n+\t * @deprecated Forcing Unaligned Checkpoints will be removed in future version.\n+\t */\n+\t@Deprecated\n+\t@PublicEvolving\n+\tpublic boolean isUnalignedCheckpointsEnabled() {\n+\t\treturn checkpointCfg.isUnalignedCheckpointsEnabled();\n+\t}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d255dc9980995cb82f157e28876a41092b64fe9"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg3NjM2NA==", "bodyText": "I'd not deprecate it at this point. I see it decoupled from the deprecation of forcing checkpoints.", "url": "https://github.com/apache/flink/pull/13878#discussion_r515876364", "createdAt": "2020-11-02T10:28:45Z", "author": {"login": "AHeise"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/StreamExecutionEnvironment.java", "diffHunk": "@@ -524,6 +524,28 @@ public boolean isForceCheckpointing() {\n \t\treturn checkpointCfg.isForceCheckpointing();\n \t}\n \n+\t/**\n+\t * Returns whether Unaligned Checkpoints are force-enabled.\n+\t *\n+\t * @deprecated Forcing Unaligned Checkpoints will be removed in future version.\n+\t */\n+\t@Deprecated\n+\t@PublicEvolving\n+\tpublic boolean isUnalignedCheckpointsEnabled() {\n+\t\treturn checkpointCfg.isUnalignedCheckpointsEnabled();\n+\t}\n+\n+\t/**\n+\t * Returns whether Unaligned Checkpoints are force-enabled.\n+\t *\n+\t * @deprecated Forcing checkpoints will be removed in future version.\n+\t */\n+\t@Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d255dc9980995cb82f157e28876a41092b64fe9"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg3NzEzMg==", "bodyText": "Just to clarify: this is intended for failing late after the user has forced UC and then rescales, right?", "url": "https://github.com/apache/flink/pull/13878#discussion_r515877132", "createdAt": "2020-11-02T10:29:59Z", "author": {"login": "AHeise"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamConfig.java", "diffHunk": "@@ -663,6 +664,14 @@ public boolean shouldSortInputs() {\n \t\treturn config.get(SORTED_INPUTS);\n \t}\n \n+\tpublic void setGraphContainingLoops(boolean graphContainingLoops) {\n+\t\tconfig.setBoolean(GRAPH_CONTAINING_LOOPS, graphContainingLoops);\n+\t}\n+\n+\tpublic boolean isGraphContainingLoops() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f394642651c37a82c95bd59c5552f6464e94d824"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg4MDA5MQ==", "bodyText": "I'd add more details similar to forcing checkpoints\n\n\"Unaligned Checkpoints are currently not supported for iterative jobs, as Flink cannot rescale from these checkpoints. \"\n+ \"\\nYou can force enable unaligned checkpoints if you don't intend to rescale: env.setForceUnalignedCheckpoints(true)\"", "url": "https://github.com/apache/flink/pull/13878#discussion_r515880091", "createdAt": "2020-11-02T10:35:12Z", "author": {"login": "AHeise"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java", "diffHunk": "@@ -216,6 +216,9 @@ private void preValidate() {\n \t\t\t\t\t\t+ \"State checkpoints happen normally, but records in-transit during the snapshot will be lost upon failure. \"\n \t\t\t\t\t\t+ \"\\nThe user can force enable state checkpoints with the reduced guarantees by calling: env.enableCheckpointing(interval,true)\");\n \t\t\t}\n+\t\t\tif (streamGraph.isIterative() && !checkpointConfig.isForceUnalignedCheckpoints()) {\n+\t\t\t\tthrow new UnsupportedOperationException(\"Unaligned Checkpoints are currently not supported for iterative jobs\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a3c8b71bb5bb06638b01cad68cbf5c9ba59ce8d"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1a3c8b71bb5bb06638b01cad68cbf5c9ba59ce8d", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/1a3c8b71bb5bb06638b01cad68cbf5c9ba59ce8d", "committedDate": "2020-11-02T10:16:49Z", "message": "[FLINK-19924][config] Disallow Unaligned Checkpoints for iterative jobs by default"}, "afterCommit": {"oid": "f00cf8809a7dce41c441fde3dffde5532548f58e", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/f00cf8809a7dce41c441fde3dffde5532548f58e", "committedDate": "2020-11-02T12:16:31Z", "message": "[FLINK-19924][config] Disallow Unaligned Checkpoints for iterative jobs by default"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f00cf8809a7dce41c441fde3dffde5532548f58e", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/f00cf8809a7dce41c441fde3dffde5532548f58e", "committedDate": "2020-11-02T12:16:31Z", "message": "[FLINK-19924][config] Disallow Unaligned Checkpoints for iterative jobs by default"}, "afterCommit": {"oid": "457daf914d01f2f8b21d5141368ae0faf918e0e1", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/457daf914d01f2f8b21d5141368ae0faf918e0e1", "committedDate": "2020-11-02T14:07:50Z", "message": "[FLINK-19924][config] Disallow Unaligned Checkpoints for iterative jobs by default"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNjc0NDgw", "url": "https://github.com/apache/flink/pull/13878#pullrequestreview-521674480", "createdAt": "2020-11-02T14:26:02Z", "commit": {"oid": "aabf026fb07f0d439e8da17a8dec39f8d5f1a3ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNDoyNjowMlrOHsGjTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNDoyNjowMlrOHsGjTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjAwNjczNQ==", "bodyText": "just noticed that you probably also need to adjust flink-python/pyflink/datastream/checkpoint_config.py", "url": "https://github.com/apache/flink/pull/13878#discussion_r516006735", "createdAt": "2020-11-02T14:26:02Z", "author": {"login": "AHeise"}, "path": "flink-streaming-scala/src/main/scala/org/apache/flink/streaming/api/scala/StreamExecutionEnvironment.scala", "diffHunk": "@@ -881,6 +881,16 @@ class StreamExecutionEnvironment(javaEnv: JavaEnv) {\n   def registerCachedFile(filePath: String, name: String, executable: Boolean): Unit = {\n     javaEnv.registerCachedFile(filePath, name, executable)\n   }\n+\n+  /**\n+   * Returns whether Unaligned Checkpoints are enabled.\n+   */\n+  def isUnalignedCheckpointsEnabled: Boolean = javaEnv.isUnalignedCheckpointsEnabled\n+\n+  /**\n+   * Returns whether Unaligned Checkpoints are force-enabled.\n+   */\n+  def isForceUnalignedCheckpoints: Boolean = javaEnv.isForceUnalignedCheckpoints", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aabf026fb07f0d439e8da17a8dec39f8d5f1a3ff"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "457daf914d01f2f8b21d5141368ae0faf918e0e1", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/457daf914d01f2f8b21d5141368ae0faf918e0e1", "committedDate": "2020-11-02T14:07:50Z", "message": "[FLINK-19924][config] Disallow Unaligned Checkpoints for iterative jobs by default"}, "afterCommit": {"oid": "d82f13461fcb7fe573a1994e41fc282298156f82", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/d82f13461fcb7fe573a1994e41fc282298156f82", "committedDate": "2020-11-02T18:14:23Z", "message": "[FLINK-19924][config] Add StreamConfig.isGraphContainingLoops\n\nThis allows subtasks to decide how to proceed with the recovery of\nchannel state."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d82f13461fcb7fe573a1994e41fc282298156f82", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/d82f13461fcb7fe573a1994e41fc282298156f82", "committedDate": "2020-11-02T18:14:23Z", "message": "[FLINK-19924][config] Add StreamConfig.isGraphContainingLoops\n\nThis allows subtasks to decide how to proceed with the recovery of\nchannel state."}, "afterCommit": {"oid": "cacd065dad27b5db28139605c97d923f168dfd98", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/cacd065dad27b5db28139605c97d923f168dfd98", "committedDate": "2020-11-03T05:57:44Z", "message": "[FLINK-19924][config] Add StreamConfig.isGraphContainingLoops\n\nThis allows subtasks to decide how to proceed with the recovery of\nchannel state."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad5bbf9f1dc80d6864e78e1bed110334ac044c31", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/ad5bbf9f1dc80d6864e78e1bed110334ac044c31", "committedDate": "2020-11-03T12:23:11Z", "message": "[hotfix][config] Add env.isUnalignedCheckpointsEnabled() (java/scala/python)\n\nThe next commits adds a force option, so this method is needed for\nconsistency."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a4242b8317955b05f207b92795e5a68c44d912a", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/5a4242b8317955b05f207b92795e5a68c44d912a", "committedDate": "2020-11-03T12:23:11Z", "message": "[FLINK-19924][config] Add an option to force Unaligned Checkpoints"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a62f23c729ea377b830353c3111bedd1bbc44777", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/a62f23c729ea377b830353c3111bedd1bbc44777", "committedDate": "2020-11-03T12:23:11Z", "message": "[FLINK-19924][config] Disallow Unaligned Checkpoints for iterative jobs by default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0954e7c3abc4ecb6d971ba1956c23138761df3c9", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/0954e7c3abc4ecb6d971ba1956c23138761df3c9", "committedDate": "2020-11-03T12:23:11Z", "message": "[FLINK-19924][config] Add StreamConfig.isGraphContainingLoops\n\nThis allows subtasks to decide how to proceed with the recovery of\nchannel state."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cacd065dad27b5db28139605c97d923f168dfd98", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/cacd065dad27b5db28139605c97d923f168dfd98", "committedDate": "2020-11-03T05:57:44Z", "message": "[FLINK-19924][config] Add StreamConfig.isGraphContainingLoops\n\nThis allows subtasks to decide how to proceed with the recovery of\nchannel state."}, "afterCommit": {"oid": "0954e7c3abc4ecb6d971ba1956c23138761df3c9", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/0954e7c3abc4ecb6d971ba1956c23138761df3c9", "committedDate": "2020-11-03T12:23:11Z", "message": "[FLINK-19924][config] Add StreamConfig.isGraphContainingLoops\n\nThis allows subtasks to decide how to proceed with the recovery of\nchannel state."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4658, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}