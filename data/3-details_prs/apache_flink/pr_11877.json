{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3NzY2MTA0", "number": 11877, "title": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers", "bodyText": "What is the purpose of the change\nThis is the second ingredient besides FLINK-16404 to solve the deadlock problem without exclusive buffers.\nThe scenario is as follows:\nThe data in subpartition with positive backlog can be sent without doubt because the exclusive credits would be feedback finally.\nWithout exclusive buffers, the receiver would not request floating buffers for 0 backlog. But when the new backlog is added into such subpartition, it has no way to notify the receiver side without positive credits ATM.\nSo it would result in waiting for each other between receiver and sender sides to cause deadlock. The sender waits for credit to notify backlog and the receiver waits for backlog to request floating credits.\nTo solve the above problem, the sender needs a separate message to announce backlog sometimes besides existing BufferResponse. Then the receiver can get this info to request floating buffers to feedback.\nIn the current implementation, the upstream task will announce backlog to the downstream task and the downstream task will allocate buffers (credit) to receive data from upstream. This PR enhances the current implementation in three main aspects:\n\nIf there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\nThe downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\nFor empty buffers of upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for these empty buffers.\n\nBrief change log\n\nIf there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\nThe downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\nFor empty buffers of upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for these empty buffers.\n\nVerifying this change\nThis change is verified by both existing tests and newly added tests.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-04-23T08:37:09Z", "url": "https://github.com/apache/flink/pull/11877", "merged": true, "mergeCommit": {"oid": "60d015cfc65d9f4b1a5765916ae14100d5dac70c"}, "closed": true, "closedAt": "2021-07-12T15:33:30Z", "author": {"login": "wsry"}, "timelineItems": {"totalCount": 93, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaagsGgBqjMyNjQ0NzU2NjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABeprJdaAFqTcwNDA3NzA1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "452ba169e20663de86d84ab6ea938bdf772be482", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/452ba169e20663de86d84ab6ea938bdf772be482", "committedDate": "2020-04-23T07:49:13Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "929403a9ae1b734c4e72a4585862f994d8c1f5e9", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/929403a9ae1b734c4e72a4585862f994d8c1f5e9", "committedDate": "2020-04-23T10:40:36Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "929403a9ae1b734c4e72a4585862f994d8c1f5e9", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/929403a9ae1b734c4e72a4585862f994d8c1f5e9", "committedDate": "2020-04-23T10:40:36Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/ca6f75c37da358874cc38d7998bce5c4445feff5", "committedDate": "2020-04-27T06:28:06Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjI0MzU0", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-408624354", "createdAt": "2020-05-09T07:54:27Z", "commit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNzo1NDoyN1rOGS5SjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNzo1NDoyN1rOGS5SjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NjE4OA==", "bodyText": "Make the following condition out of synchronized part, then we do not need to touch the lock for most of the cases.\nCheckpointOptions options = barrier.getCheckpointOptions();\nif (!(initialCredit == 0 && options.isExactlyOnceMode() && !options.isUnalignedCheckpoint()))  {\n     return;\n}", "url": "https://github.com/apache/flink/pull/11877#discussion_r422466188", "createdAt": "2020-05-09T07:54:27Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -428,6 +423,23 @@ public void notifyBufferDestroyed() {\n \t\t// Nothing to do actually.\n \t}\n \n+\t@Override\n+\tpublic void onCheckpointBarrier(CheckpointBarrier barrier) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5"}, "originalPosition": 100}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4OTM2Mjc0", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-408936274", "createdAt": "2020-05-11T07:47:45Z", "commit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwNzo0Nzo0NVrOGTQjvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwNzo0Nzo0NVrOGTQjvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg0NzQyMw==", "bodyText": "The different message path is distinguished in both PartitionRequestQueue and CreditBasedSequenceNumberingViewReader now. We can improve it to judge only in one place instead.\n\nIntroduce ServerOutboundMessage class to extend NettyMessage and make AddBacklog and BufferResponse both extend ServerOutboundMessage.\nIntroduce NetworkSequenceViewReader#getNextMessage instead of existing NetworkSequenceViewReader#getNextBuffer. And inside CreditBasedSequenceNumberingViewReader implementation, we can judge the condition for distinguish.\n\npublic NettyMessage.ServerOutboundMessage getNextMessage() throws IOException {\n\t\tif (numCreditsAvailable == 0 && initialCredit == 0 && !subpartitionView.isAvailable(numCreditsAvailable)) {\n\t\t\treturn getBacklogMessage();\n\t\t} else {\n\t\t\treturn getNextBufferResponse();\n\t\t}\n\t}\n\nTo do so we can also reduce the necessary transformation between BufferAndAvailability and BufferResponse.", "url": "https://github.com/apache/flink/pull/11877#discussion_r422847423", "createdAt": "2020-05-11T07:47:45Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/PartitionRequestQueue.java", "diffHunk": "@@ -234,11 +236,16 @@ private void writeAndFlushNextMessageIfPossible(final Channel channel) throws IO\n \t\t\t\t\t\tregisterAvailableReader(reader);\n \t\t\t\t\t}\n \n-\t\t\t\t\tBufferResponse msg = new BufferResponse(\n-\t\t\t\t\t\tnext.buffer(),\n-\t\t\t\t\t\treader.getSequenceNumber(),\n-\t\t\t\t\t\treader.getReceiverId(),\n-\t\t\t\t\t\tnext.buffersInBacklog());\n+\t\t\t\t\tObject msg;\n+\t\t\t\t\tif (next.buffer() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4OTU1NzA5", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-408955709", "createdAt": "2020-05-11T08:16:32Z", "commit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoxNjozMlrOGTRjTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoxNjozMlrOGTRjTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg2MzY5NQ==", "bodyText": "The previous buffersInBacklog variable should be replaced by this new variable, to avoid maintaining two variables.", "url": "https://github.com/apache/flink/pull/11877#discussion_r422863695", "createdAt": "2020-05-11T08:16:32Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -70,6 +70,10 @@\n \t@GuardedBy(\"buffers\")\n \tprivate int buffersInBacklog;\n \n+\t/** The number of non-event buffers to be announced to the downstream. */\n+\t@GuardedBy(\"buffers\")\n+\tprivate int unannouncedBacklog;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4OTU3MjY2", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-408957266", "createdAt": "2020-05-11T08:18:44Z", "commit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoxODo0NFrOGTRoVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoxODo0NFrOGTRoVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg2NDk4MA==", "bodyText": "buffersInBacklog and unannouncedBacklog should be retained only one finally.", "url": "https://github.com/apache/flink/pull/11877#discussion_r422864980", "createdAt": "2020-05-11T08:18:44Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/ResultSubpartition.java", "diffHunk": "@@ -158,11 +158,18 @@ public boolean add(BufferConsumer bufferConsumer) throws IOException {\n \t\tprivate final Buffer buffer;\n \t\tprivate final boolean isDataAvailable;\n \t\tprivate final int buffersInBacklog;\n+\t\tprivate final int unannouncedBacklog;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4OTYyMDMz", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-408962033", "createdAt": "2020-05-11T08:25:22Z", "commit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNToyM1rOGTR39w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNToyM1rOGTR39w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg2ODk4Mw==", "bodyText": "why we need to trigger announce backlog while adding credit?\nI assume since the added creditDeltas is always more than zero, then we have the chance to announce the backlog later via sending BufferResponse.", "url": "https://github.com/apache/flink/pull/11877#discussion_r422868983", "createdAt": "2020-05-11T08:25:23Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedSequenceNumberingViewReader.java", "diffHunk": "@@ -94,13 +99,27 @@ public void requestSubpartitionView(\n \t}\n \n \t@Override\n-\tpublic void addCredit(int creditDeltas) {\n+\tpublic boolean addCredit(int creditDeltas) {\n \t\tnumCreditsAvailable += creditDeltas;\n+\t\treturn shouldAnnounceBacklog();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4OTgwNDI5", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-408980429", "createdAt": "2020-05-11T08:51:01Z", "commit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODo1MTowMVrOGTS0xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODo1MTowMVrOGTS0xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg4NDU1MA==", "bodyText": "We can also avoid introducing nullable buffer by this comment https://github.com/apache/flink/pull/11877/files#r422847423", "url": "https://github.com/apache/flink/pull/11877#discussion_r422884550", "createdAt": "2020-05-11T08:51:01Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/InputChannel.java", "diffHunk": "@@ -305,19 +311,18 @@ protected CheckpointBarrier parseCheckpointBarrierOrNull(Buffer buffer) throws I\n \n \t/**\n \t * A combination of a {@link Buffer} and a flag indicating availability of further buffers,\n-\t * and the backlog length indicating how many non-event buffers are available in the\n-\t * subpartition.\n+\t * and the backlog length indicating how many credits the subpartition.\n \t */\n \tpublic static final class BufferAndAvailability {\n \n \t\tprivate final Buffer buffer;\n \t\tprivate final boolean moreAvailable;\n-\t\tprivate final int buffersInBacklog;\n+\t\tprivate final int backlog;\n \n-\t\tpublic BufferAndAvailability(Buffer buffer, boolean moreAvailable, int buffersInBacklog) {\n-\t\t\tthis.buffer = checkNotNull(buffer);\n+\t\tpublic BufferAndAvailability(@Nullable Buffer buffer, boolean moreAvailable, int backlog) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4OTg1Njcx", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-408985671", "createdAt": "2020-05-11T08:57:56Z", "commit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODo1Nzo1NlrOGTTGPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODo1Nzo1NlrOGTTGPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg4OTAyMg==", "bodyText": "I guess this check is not necessary or invalid.", "url": "https://github.com/apache/flink/pull/11877#discussion_r422889022", "createdAt": "2020-05-11T08:57:56Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedSequenceNumberingViewReader.java", "diffHunk": "@@ -94,13 +99,27 @@ public void requestSubpartitionView(\n \t}\n \n \t@Override\n-\tpublic void addCredit(int creditDeltas) {\n+\tpublic boolean addCredit(int creditDeltas) {\n \t\tnumCreditsAvailable += creditDeltas;\n+\t\treturn shouldAnnounceBacklog();\n+\t}\n+\n+\t@Override\n+\tpublic boolean shouldAnnounceBacklog() {\n+\t\treturn initialCredit == 0 && numCreditsAvailable == 0 && subpartitionView.isAvailable(Integer.MAX_VALUE);\n \t}\n \n \t@Override\n-\tpublic void resumeConsumption() {\n+\tpublic boolean resumeConsumption(int availableCredit, int unfulfilledBacklog) {\n+\t\tif (initialCredit > 0) {\n+\t\t\tcheckState(numCreditsAvailable == availableCredit, \"Illegal number of available credit.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MDYwMjgw", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-409060280", "createdAt": "2020-05-11T10:44:35Z", "commit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMDo0NDozNVrOGTW3Ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMDo0NDozNVrOGTW3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk1MDcxMA==", "bodyText": "nit: might rename to numRequiredFloatingBuffers for better reflecting the current semantic.", "url": "https://github.com/apache/flink/pull/11877#discussion_r422950710", "createdAt": "2020-05-11T10:44:35Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -99,7 +100,7 @@\n \t/** The number of available buffers that have not been announced to the producer yet. */\n \tprivate final AtomicInteger unannouncedCredit = new AtomicInteger(0);\n \n-\t/** The number of required buffers that equals to sender's backlog plus initial credit. */\n+\t/** The number of buffers to requested that equals to unfulfilled sender's backlog. */\n \t@GuardedBy(\"bufferQueue\")\n \tprivate int numRequiredBuffers;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca6f75c37da358874cc38d7998bce5c4445feff5", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/ca6f75c37da358874cc38d7998bce5c4445feff5", "committedDate": "2020-04-27T06:28:06Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "3046802f6bfcf476af447fffbc9af3f20a96ed61", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/3046802f6bfcf476af447fffbc9af3f20a96ed61", "committedDate": "2020-05-12T13:04:00Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNTY3OTQz", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-410567943", "createdAt": "2020-05-13T03:46:23Z", "commit": {"oid": "8a9dba521dd41e70cb5c4be10669372b1c674d22"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwMzo0NjoyM1rOGUgdDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwMzo0NjoyM1rOGUgdDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE1NjQyOQ==", "bodyText": "fix the javadoc accordingly.", "url": "https://github.com/apache/flink/pull/11877#discussion_r424156429", "createdAt": "2020-05-13T03:46:23Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/BufferManager.java", "diffHunk": "@@ -127,7 +127,7 @@ private boolean shouldContinueRequest(BufferPool bufferPool) {\n \t/**\n \t * Requests exclusive buffers from the provider and returns the number of requested amount.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a9dba521dd41e70cb5c4be10669372b1c674d22"}, "originalPosition": 2}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNTY4ODE5", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-410568819", "createdAt": "2020-05-13T03:49:35Z", "commit": {"oid": "8a9dba521dd41e70cb5c4be10669372b1c674d22"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwMzo0OTozNlrOGUgf4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwMzo0OTozNlrOGUgf4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE1NzE1Mw==", "bodyText": "It is better to supplement the similar check to avoid this action is called multiple times in practice.\nMaybe we can check the available exclusive buffers should be 0 in BufferManager instead?", "url": "https://github.com/apache/flink/pull/11877#discussion_r424157153", "createdAt": "2020-05-13T03:49:36Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -122,10 +124,7 @@ public RemoteInputChannel(\n \t * after this input channel is created.\n \t */\n \tvoid assignExclusiveSegments() throws IOException {\n-\t\tcheckState(initialCredit == 0, \"Bug in input channel setup logic: exclusive buffers have \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a9dba521dd41e70cb5c4be10669372b1c674d22"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3046802f6bfcf476af447fffbc9af3f20a96ed61", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/3046802f6bfcf476af447fffbc9af3f20a96ed61", "committedDate": "2020-05-12T13:04:00Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "fc3e9f5b7933d0b74b53946e6f506916f73aba14", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/fc3e9f5b7933d0b74b53946e6f506916f73aba14", "committedDate": "2020-05-13T03:57:50Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fc3e9f5b7933d0b74b53946e6f506916f73aba14", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/fc3e9f5b7933d0b74b53946e6f506916f73aba14", "committedDate": "2020-05-13T03:57:50Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "708b2ceb97564084900c555d6f38e6ba1174d735", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/708b2ceb97564084900c555d6f38e6ba1174d735", "committedDate": "2020-05-13T04:00:32Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNTc1Njgw", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-410575680", "createdAt": "2020-05-13T04:15:48Z", "commit": {"oid": "3046802f6bfcf476af447fffbc9af3f20a96ed61"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNDoxNjoyOFrOGUg3OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNDozNzowN1rOGUhJEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE2MzEyOQ==", "bodyText": "numberOfSegmentsToRequest  should never be negative because we already check this argument in constructor.\nif (numberOfSegmentsToRequest == 0) instead?", "url": "https://github.com/apache/flink/pull/11877#discussion_r424163129", "createdAt": "2020-05-13T04:16:28Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/NetworkBufferPool.java", "diffHunk": "@@ -162,6 +162,10 @@ public void recycle(MemorySegment segment) {\n \n \t@Override\n \tpublic List<MemorySegment> requestMemorySegments() throws IOException {\n+\t\tif (numberOfSegmentsToRequest <= 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "708b2ceb97564084900c555d6f38e6ba1174d735"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE2MzQyOQ==", "bodyText": "nit: import NettyMessage.AddBacklog because it occurs many times in this part.", "url": "https://github.com/apache/flink/pull/11877#discussion_r424163429", "createdAt": "2020-05-13T04:17:48Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedPartitionRequestClientHandler.java", "diffHunk": "@@ -291,6 +290,11 @@ private void decodeMsg(Object msg) throws Throwable {\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t}\n+\t\t} else if (msgClazz == NettyMessage.AddBacklog.class) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "708b2ceb97564084900c555d6f38e6ba1174d735"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE2NDM5NQ==", "bodyText": "this change should be together with the previous hotfix commit \" making initialCredit as final\"", "url": "https://github.com/apache/flink/pull/11877#discussion_r424164395", "createdAt": "2020-05-13T04:22:07Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/BufferManager.java", "diffHunk": "@@ -129,7 +132,6 @@ private boolean shouldContinueRequest(BufferPool bufferPool) {\n \t */\n \tvoid requestExclusiveBuffers() throws IOException {\n \t\tCollection<MemorySegment> segments = globalPool.requestMemorySegments();\n-\t\tcheckArgument(!segments.isEmpty(), \"The number of exclusive buffers per channel should be larger than 0.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "708b2ceb97564084900c555d6f38e6ba1174d735"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE2NTEwMg==", "bodyText": "This renaming is not necessary.\nBufferManager is abstracted as a general purpose, not coupled with credit-based process, so it is better to not define a argument strongly related to credit-based purpose. numRequired seems more general to describe the semantic.", "url": "https://github.com/apache/flink/pull/11877#discussion_r424165102", "createdAt": "2020-05-13T04:25:12Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/BufferManager.java", "diffHunk": "@@ -139,10 +141,10 @@ void requestExclusiveBuffers() throws IOException {\n \t}\n \n \t/**\n-\t * Requests floating buffers from the buffer pool based on the given required amount, and returns the actual\n+\t * Requests floating buffers from the buffer pool based on the given backlog, and returns the actual\n \t * requested amount. If the required amount is not fully satisfied, it will register as a listener.\n \t */\n-\tint requestFloatingBuffers(int numRequired) throws IOException {\n+\tint requestFloatingBuffers(int backlog) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "708b2ceb97564084900c555d6f38e6ba1174d735"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE2NzY5OA==", "bodyText": "Keep in mind that BufferManager is only for buffer request/release related operations, so it should not understand the other specific logics which should be done inside the respective InputChannel. Otherwise we would dirty this component and have ambiguous definition what is the role of this component.\nIn detail, the following should be done inside RemoteInputChannel\nCheckpointOptions options = barrier.getCheckpointOptions();\nif (initialCredit == 0 && options.isExactlyOnceMode() && !options.isUnalignedCheckpoint()) \n\nAnd rename  the method onCheckpointBarrier to distinguish with existing releaseFloatingBuffers(). From the perspective of outside caller, we should give a clear semantic method naming in order to be reused future.", "url": "https://github.com/apache/flink/pull/11877#discussion_r424167698", "createdAt": "2020-05-13T04:37:07Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/BufferManager.java", "diffHunk": "@@ -151,23 +153,63 @@ int requestFloatingBuffers(int numRequired) throws IOException {\n \t\t\t\treturn numRequestedBuffers;\n \t\t\t}\n \n-\t\t\tnumRequiredBuffers = numRequired;\n+\t\t\tnumRequiredBuffers += backlog;\n+\t\t\tnumRequestedBuffers = internalRequestFloatingBuffers(numRequiredBuffers);\n+\t\t\tnumRequiredBuffers -= numRequestedBuffers;\n+\t\t}\n+\t\treturn numRequestedBuffers;\n+\t}\n \n-\t\t\twhile (bufferQueue.getAvailableBufferSize() < numRequiredBuffers && !isWaitingForFloatingBuffers) {\n-\t\t\t\tBufferPool bufferPool = inputChannel.inputGate.getBufferPool();\n-\t\t\t\tBuffer buffer = bufferPool.requestBuffer();\n-\t\t\t\tif (buffer != null) {\n-\t\t\t\t\tbufferQueue.addFloatingBuffer(buffer);\n-\t\t\t\t\tnumRequestedBuffers++;\n-\t\t\t\t} else if (bufferPool.addBufferListener(this)) {\n-\t\t\t\t\tisWaitingForFloatingBuffers = true;\n-\t\t\t\t\tbreak;\n-\t\t\t\t}\n+\tprivate int internalRequestFloatingBuffers(int numBuffersToRequest) throws IOException {\n+\t\tassert Thread.holdsLock(bufferQueue);\n+\n+\t\tint numRequestedBuffers = 0;\n+\t\twhile (numRequestedBuffers < numBuffersToRequest && !isWaitingForFloatingBuffers) {\n+\t\t\tBufferPool bufferPool = inputChannel.inputGate.getBufferPool();\n+\t\t\tBuffer buffer = bufferPool.requestBuffer();\n+\t\t\tif (buffer != null) {\n+\t\t\t\tbufferQueue.addFloatingBuffer(buffer);\n+\t\t\t\tnumRequestedBuffers++;\n+\t\t\t} else if (bufferPool.addBufferListener(this)) {\n+\t\t\t\tisWaitingForFloatingBuffers = true;\n+\t\t\t\tbreak;\n \t\t\t}\n \t\t}\n \t\treturn numRequestedBuffers;\n \t}\n \n+\tpublic NettyMessage.ResumeConsumption resumeAndGetResumptionMessage(\n+\t\t\tInputChannelID channelID,\n+\t\t\tint initialCredit) throws IOException {\n+\t\tsynchronized (bufferQueue) {\n+\t\t\tcheckState(numRequiredBuffers >= 0, \"Number of required buffers should be non-negative.\");\n+\t\t\tcheckState(bufferQueue.getAvailableBufferSize() == initialCredit, \"Illegal number of available buffers.\");\n+\n+\t\t\tif (initialCredit > 0) {\n+\t\t\t\treturn new NettyMessage.ResumeConsumption(channelID, initialCredit, numRequiredBuffers);\n+\t\t\t}\n+\n+\t\t\tint numCredit = internalRequestFloatingBuffers(numRequiredBuffers);\n+\t\t\tnumRequiredBuffers -= numCredit;\n+\t\t\treturn new NettyMessage.ResumeConsumption(channelID, numCredit, numRequiredBuffers);\n+\t\t}\n+\t}\n+\n+\tpublic void onCheckpointBarrier(CheckpointBarrier barrier, int initialCredit) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "708b2ceb97564084900c555d6f38e6ba1174d735"}, "originalPosition": 112}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNTgxOTYz", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-410581963", "createdAt": "2020-05-13T04:39:46Z", "commit": {"oid": "708b2ceb97564084900c555d6f38e6ba1174d735"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNDozOTo0NlrOGUhLSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNDozOTo0NlrOGUhLSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE2ODI2NA==", "bodyText": "As mentioned in 708b2ce#r424167698, this logic should be done inside RemoteInputChannel, because the BufferManager should not understand the specific logics unless buffer request/release.", "url": "https://github.com/apache/flink/pull/11877#discussion_r424168264", "createdAt": "2020-05-13T04:39:46Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/BufferManager.java", "diffHunk": "@@ -151,23 +153,63 @@ int requestFloatingBuffers(int numRequired) throws IOException {\n \t\t\t\treturn numRequestedBuffers;\n \t\t\t}\n \n-\t\t\tnumRequiredBuffers = numRequired;\n+\t\t\tnumRequiredBuffers += backlog;\n+\t\t\tnumRequestedBuffers = internalRequestFloatingBuffers(numRequiredBuffers);\n+\t\t\tnumRequiredBuffers -= numRequestedBuffers;\n+\t\t}\n+\t\treturn numRequestedBuffers;\n+\t}\n \n-\t\t\twhile (bufferQueue.getAvailableBufferSize() < numRequiredBuffers && !isWaitingForFloatingBuffers) {\n-\t\t\t\tBufferPool bufferPool = inputChannel.inputGate.getBufferPool();\n-\t\t\t\tBuffer buffer = bufferPool.requestBuffer();\n-\t\t\t\tif (buffer != null) {\n-\t\t\t\t\tbufferQueue.addFloatingBuffer(buffer);\n-\t\t\t\t\tnumRequestedBuffers++;\n-\t\t\t\t} else if (bufferPool.addBufferListener(this)) {\n-\t\t\t\t\tisWaitingForFloatingBuffers = true;\n-\t\t\t\t\tbreak;\n-\t\t\t\t}\n+\tprivate int internalRequestFloatingBuffers(int numBuffersToRequest) throws IOException {\n+\t\tassert Thread.holdsLock(bufferQueue);\n+\n+\t\tint numRequestedBuffers = 0;\n+\t\twhile (numRequestedBuffers < numBuffersToRequest && !isWaitingForFloatingBuffers) {\n+\t\t\tBufferPool bufferPool = inputChannel.inputGate.getBufferPool();\n+\t\t\tBuffer buffer = bufferPool.requestBuffer();\n+\t\t\tif (buffer != null) {\n+\t\t\t\tbufferQueue.addFloatingBuffer(buffer);\n+\t\t\t\tnumRequestedBuffers++;\n+\t\t\t} else if (bufferPool.addBufferListener(this)) {\n+\t\t\t\tisWaitingForFloatingBuffers = true;\n+\t\t\t\tbreak;\n \t\t\t}\n \t\t}\n \t\treturn numRequestedBuffers;\n \t}\n \n+\tpublic NettyMessage.ResumeConsumption resumeAndGetResumptionMessage(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "708b2ceb97564084900c555d6f38e6ba1174d735"}, "originalPosition": 95}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNTk5OTE5", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-410599919", "createdAt": "2020-05-13T05:36:17Z", "commit": {"oid": "708b2ceb97564084900c555d6f38e6ba1174d735"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNTozNjoxN1rOGUiEdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNTozNjoxN1rOGUiEdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE4MjkwMg==", "bodyText": "resumeAndGetResumptionMessage() -> getResumeConsumptionMessage()", "url": "https://github.com/apache/flink/pull/11877#discussion_r424182902", "createdAt": "2020-05-13T05:36:17Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -334,6 +335,15 @@ public void resumeConsumption() {\n \t\tpartitionRequestClient.resumeConsumption(this);\n \t}\n \n+\t/**\n+\t * Called by netty thread to request buffers and generate {@link NettyMessage.ResumeConsumption} message.\n+\t */\n+\tpublic NettyMessage.ResumeConsumption resumeAndGetResumptionMessage() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "708b2ceb97564084900c555d6f38e6ba1174d735"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNjA0MTMz", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-410604133", "createdAt": "2020-05-13T05:48:14Z", "commit": {"oid": "708b2ceb97564084900c555d6f38e6ba1174d735"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNTo0ODoxNFrOGUiRxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNTo0ODoxNFrOGUiRxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE4NjMwOA==", "bodyText": "Make this change a separate hotfix?", "url": "https://github.com/apache/flink/pull/11877#discussion_r424186308", "createdAt": "2020-05-13T05:48:14Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -415,11 +425,8 @@ public Buffer requestBuffer() {\n \t *\n \t * @param backlog The number of unsent buffers in the producer's sub partition.\n \t */\n-\tvoid onSenderBacklog(int backlog) throws IOException {\n-\t\tint numRequestedBuffers = bufferManager.requestFloatingBuffers(backlog + initialCredit);\n-\t\tif (numRequestedBuffers > 0 && unannouncedCredit.getAndAdd(numRequestedBuffers) == 0) {\n-\t\t\tnotifyCreditAvailable();\n-\t\t}\n+\tpublic void onSenderBacklog(int backlog) throws IOException {\n+\t\tnotifyBufferAvailable(bufferManager.requestFloatingBuffers(backlog));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "708b2ceb97564084900c555d6f38e6ba1174d735"}, "originalPosition": 67}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "708b2ceb97564084900c555d6f38e6ba1174d735", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/708b2ceb97564084900c555d6f38e6ba1174d735", "committedDate": "2020-05-13T04:00:32Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "59b651c070adcca2b7e4e4a78e6b10411429c589", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/59b651c070adcca2b7e4e4a78e6b10411429c589", "committedDate": "2020-05-13T10:25:24Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwODE1ODkx", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-410815891", "createdAt": "2020-05-13T11:04:03Z", "commit": {"oid": "708b2ceb97564084900c555d6f38e6ba1174d735"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMTowNDo0NVrOGUsenw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMTowNDo0NVrOGUsenw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM1MzQzOQ==", "bodyText": "Actually the logic for adding credit does not need needAnnounceBacklog, so it might bring trouble to understand the logic of addCredit by reusing the common codes here.\nOne possible solution is to call enqueueAvailableReader in reader stack while applying the function, then the NetworkSequenceViewReader#addCredit and NetworkSequenceViewReader#resumeConsumption can judge the separate conditions before calling enqueueAvailableReader.", "url": "https://github.com/apache/flink/pull/11877#discussion_r424353439", "createdAt": "2020-05-13T11:04:45Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/PartitionRequestQueue.java", "diffHunk": "@@ -145,20 +148,20 @@ public void close() throws IOException {\n \t * checkpoint and enqueues the corresponding reader for this consumer (if not enqueued yet).\n \t *\n \t * @param receiverId The input channel id to identify the consumer.\n-\t * @param operation The operation to be performed (add credit or resume data consumption).\n+\t * @param function The operation to be performed (add credit or resume data consumption).\n \t */\n \tvoid addCreditOrResumeConsumption(\n \t\t\tInputChannelID receiverId,\n-\t\t\tConsumer<NetworkSequenceViewReader> operation) throws Exception {\n+\t\t\tFunction<NetworkSequenceViewReader, Boolean> function) throws Exception {\n \t\tif (fatalError) {\n \t\t\treturn;\n \t\t}\n \n \t\tNetworkSequenceViewReader reader = allReaders.get(receiverId);\n \t\tif (reader != null) {\n-\t\t\toperation.accept(reader);\n+\t\t\tboolean needAnnounceBacklog = function.apply(reader);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b651c070adcca2b7e4e4a78e6b10411429c589"}, "originalPosition": 79}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwODE4MDA4", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-410818008", "createdAt": "2020-05-13T11:07:27Z", "commit": {"oid": "59b651c070adcca2b7e4e4a78e6b10411429c589"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMTowNzoyN1rOGUsjew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMTowNzoyN1rOGUsjew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM1NDY4Mw==", "bodyText": "Based on this comment, we might not need to bring announceBacklog argument in this method, to understand all the related processes together.", "url": "https://github.com/apache/flink/pull/11877#discussion_r424354683", "createdAt": "2020-05-13T11:07:27Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/PartitionRequestQueue.java", "diffHunk": "@@ -94,10 +96,11 @@ void notifyReaderNonEmpty(final NetworkSequenceViewReader reader) {\n \t * <p>NOTE: Only one thread would trigger the actual enqueue after checking the reader's\n \t * availability, so there is no race condition here.\n \t */\n-\tprivate void enqueueAvailableReader(final NetworkSequenceViewReader reader) throws Exception {\n-\t\tif (reader.isRegisteredAsAvailable() || !reader.isAvailable()) {\n+\tprivate void enqueueAvailableReader(final NetworkSequenceViewReader reader, boolean announceBacklog) throws Exception {\n+\t\tif (reader.isRegisteredAsAvailable() || (!reader.isAvailable() && !announceBacklog)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b651c070adcca2b7e4e4a78e6b10411429c589"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwODQzOTg4", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-410843988", "createdAt": "2020-05-13T11:48:33Z", "commit": {"oid": "59b651c070adcca2b7e4e4a78e6b10411429c589"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMTo0ODozNFrOGUtyvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMTo0ODozNFrOGUtyvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3NDk3NQ==", "bodyText": "Renaming it to a boolean type withoutExclusiveCredits seems more direct to understand", "url": "https://github.com/apache/flink/pull/11877#discussion_r424374975", "createdAt": "2020-05-13T11:48:34Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedSequenceNumberingViewReader.java", "diffHunk": "@@ -45,6 +47,8 @@\n \n \tprivate final PartitionRequestQueue requestQueue;\n \n+\tprivate final int initialCredit;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b651c070adcca2b7e4e4a78e6b10411429c589"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDUyODk5", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-411452899", "createdAt": "2020-05-14T04:14:31Z", "commit": {"oid": "59b651c070adcca2b7e4e4a78e6b10411429c589"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNDoxNDozMlrOGVLdDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNDoxNDozMlrOGVLdDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg2MDk0MA==", "bodyText": "nit: bufferReleased  -> numReleasedBuffers", "url": "https://github.com/apache/flink/pull/11877#discussion_r424860940", "createdAt": "2020-05-14T04:14:32Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/BufferManager.java", "diffHunk": "@@ -151,23 +150,43 @@ int requestFloatingBuffers(int numRequired) throws IOException {\n \t\t\t\treturn numRequestedBuffers;\n \t\t\t}\n \n-\t\t\tnumRequiredBuffers = numRequired;\n+\t\t\tnumRequiredBuffers += numRequired;\n+\t\t\tnumRequestedBuffers = internalRequestFloatingBuffers(numRequiredBuffers);\n+\t\t\tnumRequiredBuffers -= numRequestedBuffers;\n+\t\t}\n+\t\treturn numRequestedBuffers;\n+\t}\n \n-\t\t\twhile (bufferQueue.getAvailableBufferSize() < numRequiredBuffers && !isWaitingForFloatingBuffers) {\n-\t\t\t\tBufferPool bufferPool = inputChannel.inputGate.getBufferPool();\n-\t\t\t\tBuffer buffer = bufferPool.requestBuffer();\n-\t\t\t\tif (buffer != null) {\n-\t\t\t\t\tbufferQueue.addFloatingBuffer(buffer);\n-\t\t\t\t\tnumRequestedBuffers++;\n-\t\t\t\t} else if (bufferPool.addBufferListener(this)) {\n-\t\t\t\t\tisWaitingForFloatingBuffers = true;\n-\t\t\t\t\tbreak;\n-\t\t\t\t}\n+\tprivate int internalRequestFloatingBuffers(int numBuffersToRequest) throws IOException {\n+\t\tassert Thread.holdsLock(bufferQueue);\n+\n+\t\tint numRequestedBuffers = 0;\n+\t\twhile (numRequestedBuffers < numBuffersToRequest && !isWaitingForFloatingBuffers) {\n+\t\t\tBufferPool bufferPool = inputChannel.inputGate.getBufferPool();\n+\t\t\tBuffer buffer = bufferPool.requestBuffer();\n+\t\t\tif (buffer != null) {\n+\t\t\t\tbufferQueue.addFloatingBuffer(buffer);\n+\t\t\t\tnumRequestedBuffers++;\n+\t\t\t} else if (bufferPool.addBufferListener(this)) {\n+\t\t\t\tisWaitingForFloatingBuffers = true;\n+\t\t\t\tbreak;\n \t\t\t}\n \t\t}\n \t\treturn numRequestedBuffers;\n \t}\n \n+\tpublic void unregisterBufferListenerAndReleaseFloatingBuffers() {\n+\t\tsynchronized (bufferQueue) {\n+\t\t\tif (isWaitingForFloatingBuffers) {\n+\t\t\t\tinputChannel.inputGate.getBufferPool().removeBufferListener(this);\n+\t\t\t\tisWaitingForFloatingBuffers = false;\n+\t\t\t}\n+\n+\t\t\tint bufferReleased = bufferQueue.releaseFloatingBuffers();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b651c070adcca2b7e4e4a78e6b10411429c589"}, "originalPosition": 73}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "59b651c070adcca2b7e4e4a78e6b10411429c589", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/59b651c070adcca2b7e4e4a78e6b10411429c589", "committedDate": "2020-05-13T10:25:24Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "b0bc4fc762c88de29509bb7ffb16c71203327fa8", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/b0bc4fc762c88de29509bb7ffb16c71203327fa8", "committedDate": "2020-05-14T04:17:19Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b0bc4fc762c88de29509bb7ffb16c71203327fa8", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/b0bc4fc762c88de29509bb7ffb16c71203327fa8", "committedDate": "2020-05-14T04:17:19Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "e033307ba22ee660cd6c39063896500075b60671", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/e033307ba22ee660cd6c39063896500075b60671", "committedDate": "2020-05-14T04:22:18Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDU1Njgx", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-411455681", "createdAt": "2020-05-14T04:25:09Z", "commit": {"oid": "59b651c070adcca2b7e4e4a78e6b10411429c589"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNDoyNTo0NFrOGVLnIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNDoyNTo0NFrOGVLnIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg2MzUyMg==", "bodyText": "This method should be placed into the below section Buffer recycle.\nI think it is better to integrate this method with existing #releaseFloatingBuffers to provide a general one, otherwise it might bring confusing to understand the difference among them, especially for the different handle of numRequiredBuffers, to make them seem customized logic.\nThe integration is as below\nvoid releaseFloatingBuffers(boolean isTemporaryRelease) {\n\t\tsynchronized (bufferQueue) {\n\t\t\tif (isWaitingForFloatingBuffers) {\n\t\t\t\tinputChannel.inputGate.getBufferPool().removeBufferListener(this);\n\t\t\t\tisWaitingForFloatingBuffers = false;\n\t\t\t}\n\n\t\t\tint numReleasedBuffers = bufferQueue.releaseFloatingBuffers();\n\t\t\tif (isTemporaryRelease) {\n\t\t\t\tnumRequiredBuffers += numReleasedBuffers;\n\t\t\t} else {\n\t\t\t\tnumRequiredBuffers = 0;\n\t\t\t}\n\t\t}\n\t}", "url": "https://github.com/apache/flink/pull/11877#discussion_r424863522", "createdAt": "2020-05-14T04:25:44Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/BufferManager.java", "diffHunk": "@@ -151,23 +149,42 @@ int requestFloatingBuffers(int numRequired) throws IOException {\n \t\t\t\treturn numRequestedBuffers;\n \t\t\t}\n \n-\t\t\tnumRequiredBuffers = numRequired;\n+\t\t\tnumRequiredBuffers += numRequired;\n+\t\t\tnumRequestedBuffers = internalRequestFloatingBuffers(numRequiredBuffers);\n+\t\t\tnumRequiredBuffers -= numRequestedBuffers;\n+\t\t}\n+\t\treturn numRequestedBuffers;\n+\t}\n \n-\t\t\twhile (bufferQueue.getAvailableBufferSize() < numRequiredBuffers && !isWaitingForFloatingBuffers) {\n-\t\t\t\tBufferPool bufferPool = inputChannel.inputGate.getBufferPool();\n-\t\t\t\tBuffer buffer = bufferPool.requestBuffer();\n-\t\t\t\tif (buffer != null) {\n-\t\t\t\t\tbufferQueue.addFloatingBuffer(buffer);\n-\t\t\t\t\tnumRequestedBuffers++;\n-\t\t\t\t} else if (bufferPool.addBufferListener(this)) {\n-\t\t\t\t\tisWaitingForFloatingBuffers = true;\n-\t\t\t\t\tbreak;\n-\t\t\t\t}\n+\tprivate int internalRequestFloatingBuffers(int numBuffersToRequest) throws IOException {\n+\t\tassert Thread.holdsLock(bufferQueue);\n+\n+\t\tint numRequestedBuffers = 0;\n+\t\twhile (numRequestedBuffers < numBuffersToRequest && !isWaitingForFloatingBuffers) {\n+\t\t\tBufferPool bufferPool = inputChannel.inputGate.getBufferPool();\n+\t\t\tBuffer buffer = bufferPool.requestBuffer();\n+\t\t\tif (buffer != null) {\n+\t\t\t\tbufferQueue.addFloatingBuffer(buffer);\n+\t\t\t\tnumRequestedBuffers++;\n+\t\t\t} else if (bufferPool.addBufferListener(this)) {\n+\t\t\t\tisWaitingForFloatingBuffers = true;\n+\t\t\t\tbreak;\n \t\t\t}\n \t\t}\n \t\treturn numRequestedBuffers;\n \t}\n \n+\tpublic void unregisterBufferListenerAndReleaseFloatingBuffers() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e033307ba22ee660cd6c39063896500075b60671"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDU4NzQx", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-411458741", "createdAt": "2020-05-14T04:36:33Z", "commit": {"oid": "e033307ba22ee660cd6c39063896500075b60671"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNDozNjozM1rOGVLxHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNDozNjozM1rOGVLxHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg2NjA3Ng==", "bodyText": "It should not be changed here. If the numRequiredBuffers is 0, getAvailableBufferSize() must be more than it. If numRequiredBuffers is 1 or something else, as long as the getAvailableBufferSize() is more than it, we also need to release a floating buffer.", "url": "https://github.com/apache/flink/pull/11877#discussion_r424866076", "createdAt": "2020-05-14T04:36:33Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/BufferManager.java", "diffHunk": "@@ -349,7 +373,7 @@ int unsynchronizedGetFloatingBuffersAvailable() {\n \t\t */\n \t\tint addExclusiveBuffer(Buffer buffer, int numRequiredBuffers) {\n \t\t\texclusiveBuffers.add(buffer);\n-\t\t\tif (getAvailableBufferSize() > numRequiredBuffers) {\n+\t\t\tif (numRequiredBuffers == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e033307ba22ee660cd6c39063896500075b60671"}, "originalPosition": 152}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e033307ba22ee660cd6c39063896500075b60671", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/e033307ba22ee660cd6c39063896500075b60671", "committedDate": "2020-05-14T04:22:18Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "10deae9993244cb215af6f0bb3bd6a9b0f9ef9fd", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/10deae9993244cb215af6f0bb3bd6a9b0f9ef9fd", "committedDate": "2020-05-14T06:16:06Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDk5MzYx", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-411499361", "createdAt": "2020-05-14T06:31:28Z", "commit": {"oid": "e033307ba22ee660cd6c39063896500075b60671"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNjozMjoxOVrOGVNzvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNjozODoyNVrOGVN9iA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5OTUxNw==", "bodyText": "make it only private method inside RemoteInputChannel, because it is never used outside.", "url": "https://github.com/apache/flink/pull/11877#discussion_r424899517", "createdAt": "2020-05-14T06:32:19Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -327,6 +322,14 @@ public void notifyBufferAvailable(int numAvailableBuffers) {\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic void onCheckpointBarrier(CheckpointBarrier barrier) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10deae9993244cb215af6f0bb3bd6a9b0f9ef9fd"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkwMjAyNA==", "bodyText": "nit: also adjust the javadoc of this method accordingly.", "url": "https://github.com/apache/flink/pull/11877#discussion_r424902024", "createdAt": "2020-05-14T06:38:25Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -418,8 +437,8 @@ public Buffer requestBuffer() {\n \t *\n \t * @param backlog The number of unsent buffers in the producer's sub partition.\n \t */\n-\tvoid onSenderBacklog(int backlog) throws IOException {\n-\t\tnotifyBufferAvailable(bufferManager.requestFloatingBuffers(backlog + initialCredit));\n+\tpublic void onSenderBacklog(int backlog) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10deae9993244cb215af6f0bb3bd6a9b0f9ef9fd"}, "originalPosition": 96}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNTA4NzU5", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-411508759", "createdAt": "2020-05-14T06:49:30Z", "commit": {"oid": "2ea543cf392fb1f2d8d7691fa358a93b6765d195"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNjo0OTozMFrOGVOQ3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNjo0OTozMFrOGVOQ3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkwNjk3Mg==", "bodyText": "unsynchronizedGetAvailableExclusiveBuffers?", "url": "https://github.com/apache/flink/pull/11877#discussion_r424906972", "createdAt": "2020-05-14T06:49:30Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/BufferManager.java", "diffHunk": "@@ -313,7 +313,7 @@ int getNumberOfAvailableBuffers() {\n \t\t}\n \t}\n \n-\tint unsynchronizedGetExclusiveBuffersUsed() {\n+\tint unsynchronizedGetExclusiveBuffers() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ea543cf392fb1f2d8d7691fa358a93b6765d195"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10deae9993244cb215af6f0bb3bd6a9b0f9ef9fd", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/10deae9993244cb215af6f0bb3bd6a9b0f9ef9fd", "committedDate": "2020-05-14T06:16:06Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "2cb05ba959c5ac264eb8fa85d711f499301ed767", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/2cb05ba959c5ac264eb8fa85d711f499301ed767", "committedDate": "2020-05-14T09:43:23Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2cb05ba959c5ac264eb8fa85d711f499301ed767", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/2cb05ba959c5ac264eb8fa85d711f499301ed767", "committedDate": "2020-05-14T09:43:23Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "a933d700d53457d7743252c2a3c735a04fbd87f8", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/a933d700d53457d7743252c2a3c735a04fbd87f8", "committedDate": "2020-05-14T09:47:15Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a933d700d53457d7743252c2a3c735a04fbd87f8", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/a933d700d53457d7743252c2a3c735a04fbd87f8", "committedDate": "2020-05-14T09:47:15Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "ae90bc7d6d3753da3e9bbadcc99c80a152801e43", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/ae90bc7d6d3753da3e9bbadcc99c80a152801e43", "committedDate": "2020-05-14T09:52:27Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNzE5NDA1", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-411719405", "createdAt": "2020-05-14T11:40:56Z", "commit": {"oid": "10deae9993244cb215af6f0bb3bd6a9b0f9ef9fd"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMTo0MToyM1rOGVYV1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMTo0MzoxNVrOGVYZqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA3MjA4NA==", "bodyText": "remove moreAvailable argument from the constructor, because it seems strange for AddBacklogMessage, then we can give false in below super instead.", "url": "https://github.com/apache/flink/pull/11877#discussion_r425072084", "createdAt": "2020-05-14T11:41:23Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/PartitionRequestQueue.java", "diffHunk": "@@ -328,4 +325,67 @@ public void operationComplete(ChannelFuture future) throws Exception {\n \t\t\t}\n \t\t}\n \t}\n+\n+\t/**\n+\t * Outbound message to be sent to the client.\n+\t */\n+\tpublic static abstract class ServerOutboundMessage {\n+\t\tprotected final InputChannelID receiverId;\n+\t\tprotected final int backlog;\n+\t\tprivate final boolean moreAvailable;\n+\n+\t\tServerOutboundMessage(InputChannelID receiverId, int backlog, boolean moreAvailable) {\n+\t\t\tcheckArgument(backlog >= 0, \"Number of backlog must be non-negative.\");\n+\t\t\tthis.receiverId = checkNotNull(receiverId);\n+\t\t\tthis.backlog = backlog;\n+\t\t\tthis.moreAvailable = moreAvailable;\n+\t\t}\n+\n+\t\tabstract Object build();\n+\n+\t\tpublic boolean isMoreAvailable() {\n+\t\t\treturn moreAvailable;\n+\t\t}\n+\n+\t\tvoid recycleBufferIfNeeded() {\n+\t\t}\n+\t}\n+\n+\tstatic class BufferResponseMessage extends ServerOutboundMessage {\n+\t\tprivate final Buffer buffer;\n+\t\tprivate final int sequenceNumber;\n+\n+\t\tBufferResponseMessage(\n+\t\t\t\tBuffer buffer,\n+\t\t\t\tInputChannelID receiverId,\n+\t\t\t\tint sequenceNumber,\n+\t\t\t\tint backlog,\n+\t\t\t\tboolean moreAvailable) {\n+\t\t\tsuper(receiverId, backlog, moreAvailable);\n+\t\t\tthis.buffer = checkNotNull(buffer);\n+\t\t\tthis.sequenceNumber = sequenceNumber;\n+\t\t}\n+\n+\t\t@Override\n+\t\tObject build() {\n+\t\t\treturn new BufferResponse(buffer, sequenceNumber, receiverId, backlog);\n+\t\t}\n+\n+\t\t@Override\n+\t\tvoid recycleBufferIfNeeded() {\n+\t\t\tbuffer.recycleBuffer();\n+\t\t}\n+\t}\n+\n+\tstatic class AddBacklogMessage extends ServerOutboundMessage {\n+\n+\t\tAddBacklogMessage(InputChannelID receiverId, int backlog, boolean moreAvailable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae90bc7d6d3753da3e9bbadcc99c80a152801e43"}, "originalPosition": 198}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA3MzA2Ng==", "bodyText": "Adjust the javadoc accordingly", "url": "https://github.com/apache/flink/pull/11877#discussion_r425073066", "createdAt": "2020-05-14T11:43:15Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/PartitionRequestQueue.java", "diffHunk": "@@ -94,10 +97,11 @@ void notifyReaderNonEmpty(final NetworkSequenceViewReader reader) {\n \t * <p>NOTE: Only one thread would trigger the actual enqueue after checking the reader's\n \t * availability, so there is no race condition here.\n \t */\n-\tprivate void enqueueAvailableReader(final NetworkSequenceViewReader reader) throws Exception {\n-\t\tif (reader.isRegisteredAsAvailable() || !reader.isAvailable()) {\n+\tvoid enqueueAvailableReader(final NetworkSequenceViewReader reader, BooleanSupplier condition) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae90bc7d6d3753da3e9bbadcc99c80a152801e43"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNzI3ODQy", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-411727842", "createdAt": "2020-05-14T11:53:48Z", "commit": {"oid": "ae90bc7d6d3753da3e9bbadcc99c80a152801e43"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMTo1Mzo0OFrOGVYu-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMTo1Mzo0OFrOGVYu-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA3ODUyMg==", "bodyText": "I guess we should not expect null return here. As long as the code path enters getAddBacklogMessage, then we should guarantee that the respective backlog should be more than 0.\nMaybe add assert backlog instead?", "url": "https://github.com/apache/flink/pull/11877#discussion_r425078522", "createdAt": "2020-05-14T11:53:48Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedSequenceNumberingViewReader.java", "diffHunk": "@@ -163,8 +172,15 @@ boolean hasBuffersAvailable() {\n \t\treturn subpartitionView.isAvailable(Integer.MAX_VALUE);\n \t}\n \n-\t@Override\n-\tpublic BufferAndAvailability getNextBuffer() throws IOException {\n+\tprivate AddBacklogMessage getAddBacklogMessage() {\n+\t\tint backlog = subpartitionView.getAndResetUnannouncedBacklog();\n+\t\tif (backlog > 0) {\n+\t\t\treturn new AddBacklogMessage(receiverId, backlog, false);\n+\t\t}\n+\t\treturn null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae90bc7d6d3753da3e9bbadcc99c80a152801e43"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNzI4MDg0", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-411728084", "createdAt": "2020-05-14T11:54:14Z", "commit": {"oid": "ae90bc7d6d3753da3e9bbadcc99c80a152801e43"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMTo1NDoxNFrOGVYvsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMTo1NDoxNFrOGVYvsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA3ODcwNw==", "bodyText": "initialCredit  == 0", "url": "https://github.com/apache/flink/pull/11877#discussion_r425078707", "createdAt": "2020-05-14T11:54:14Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedSequenceNumberingViewReader.java", "diffHunk": "@@ -69,6 +73,7 @@\n \t\tthis.receiverId = receiverId;\n \t\tthis.numCreditsAvailable = initialCredit;\n \t\tthis.requestQueue = requestQueue;\n+\t\tthis.withoutExclusiveCredits = initialCredit > 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae90bc7d6d3753da3e9bbadcc99c80a152801e43"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNzI4ODc3", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-411728877", "createdAt": "2020-05-14T11:55:25Z", "commit": {"oid": "ae90bc7d6d3753da3e9bbadcc99c80a152801e43"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMTo1NToyNVrOGVYyKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMTo1NToyNVrOGVYyKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA3OTMzOQ==", "bodyText": "nit: availableCredit -> availableCredits", "url": "https://github.com/apache/flink/pull/11877#discussion_r425079339", "createdAt": "2020-05-14T11:55:25Z", "author": {"login": "zhijiangW"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedSequenceNumberingViewReader.java", "diffHunk": "@@ -94,13 +99,22 @@ public void requestSubpartitionView(\n \t}\n \n \t@Override\n-\tpublic void addCredit(int creditDeltas) {\n+\tpublic void addCredit(int creditDeltas) throws Exception {\n \t\tnumCreditsAvailable += creditDeltas;\n+\t\trequestQueue.enqueueAvailableReader(this, this::isAvailable);\n+\t}\n+\n+\t@Override\n+\tpublic boolean shouldAnnounceBacklog() {\n+\t\treturn !withoutExclusiveCredits && numCreditsAvailable == 0 && subpartitionView.isAvailable(Integer.MAX_VALUE);\n \t}\n \n \t@Override\n-\tpublic void resumeConsumption() {\n+\tpublic void resumeConsumption(int availableCredit, boolean hasUnfulfilledBacklog) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae90bc7d6d3753da3e9bbadcc99c80a152801e43"}, "originalPosition": 50}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae90bc7d6d3753da3e9bbadcc99c80a152801e43", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/ae90bc7d6d3753da3e9bbadcc99c80a152801e43", "committedDate": "2020-05-14T09:52:27Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "fb4c607a5c4780729143d458b1c7633adcba59bf", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/fb4c607a5c4780729143d458b1c7633adcba59bf", "committedDate": "2020-05-14T13:08:16Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb4c607a5c4780729143d458b1c7633adcba59bf", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/fb4c607a5c4780729143d458b1c7633adcba59bf", "committedDate": "2020-05-14T13:08:16Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "a51d7760c34c0652321427daa153070874c54a61", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/a51d7760c34c0652321427daa153070874c54a61", "committedDate": "2020-05-15T18:27:12Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a51d7760c34c0652321427daa153070874c54a61", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/a51d7760c34c0652321427daa153070874c54a61", "committedDate": "2020-05-15T18:27:12Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "0ed54d10e01403ccbe4478ad086d4859f6f511cf", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/0ed54d10e01403ccbe4478ad086d4859f6f511cf", "committedDate": "2020-05-15T18:44:42Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ed54d10e01403ccbe4478ad086d4859f6f511cf", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/0ed54d10e01403ccbe4478ad086d4859f6f511cf", "committedDate": "2020-05-15T18:44:42Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "edabda8971fb299b278a0bd0b42c2dca82c8a6a4", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/edabda8971fb299b278a0bd0b42c2dca82c8a6a4", "committedDate": "2020-05-16T03:03:56Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "edabda8971fb299b278a0bd0b42c2dca82c8a6a4", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/edabda8971fb299b278a0bd0b42c2dca82c8a6a4", "committedDate": "2020-05-16T03:03:56Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "d8b233f483d45b8901cc28770be9da71a39929ef", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/d8b233f483d45b8901cc28770be9da71a39929ef", "committedDate": "2020-05-16T04:52:00Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d8b233f483d45b8901cc28770be9da71a39929ef", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/d8b233f483d45b8901cc28770be9da71a39929ef", "committedDate": "2020-05-16T04:52:00Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "ab13e8a7dff7dcf53ed919196908437c30e78158", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/ab13e8a7dff7dcf53ed919196908437c30e78158", "committedDate": "2020-05-18T03:56:00Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab13e8a7dff7dcf53ed919196908437c30e78158", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/ab13e8a7dff7dcf53ed919196908437c30e78158", "committedDate": "2020-05-18T03:56:00Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "3f89d29a4cee4917ff8087e16ab35c5d1274220c", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/3f89d29a4cee4917ff8087e16ab35c5d1274220c", "committedDate": "2020-05-18T04:05:48Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3f89d29a4cee4917ff8087e16ab35c5d1274220c", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/3f89d29a4cee4917ff8087e16ab35c5d1274220c", "committedDate": "2020-05-18T04:05:48Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "7dfdb8bfa05b783479697bd3aa3de3fac2628482", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/7dfdb8bfa05b783479697bd3aa3de3fac2628482", "committedDate": "2020-06-28T05:30:04Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7dfdb8bfa05b783479697bd3aa3de3fac2628482", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/7dfdb8bfa05b783479697bd3aa3de3fac2628482", "committedDate": "2020-06-28T05:30:04Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "66de3ded5740c19aab5984c8650b5d6a355ed6e8", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/66de3ded5740c19aab5984c8650b5d6a355ed6e8", "committedDate": "2020-06-28T08:14:19Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "66de3ded5740c19aab5984c8650b5d6a355ed6e8", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/66de3ded5740c19aab5984c8650b5d6a355ed6e8", "committedDate": "2020-06-28T08:14:19Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "9963994d6a37e8c1721d31519ac7346e25922248", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/9963994d6a37e8c1721d31519ac7346e25922248", "committedDate": "2020-07-01T16:03:05Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9963994d6a37e8c1721d31519ac7346e25922248", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/9963994d6a37e8c1721d31519ac7346e25922248", "committedDate": "2020-07-01T16:03:05Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "5682e0256634e2ce1a38ca132cdaaddc79ee71c0", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/5682e0256634e2ce1a38ca132cdaaddc79ee71c0", "committedDate": "2020-07-02T03:27:27Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5682e0256634e2ce1a38ca132cdaaddc79ee71c0", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/5682e0256634e2ce1a38ca132cdaaddc79ee71c0", "committedDate": "2020-07-02T03:27:27Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers"}, "afterCommit": {"oid": "1440a6f1d30fc6cb7f4107facb3f9a5d08f34e87", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/1440a6f1d30fc6cb7f4107facb3f9a5d08f34e87", "committedDate": "2021-03-07T13:57:47Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1440a6f1d30fc6cb7f4107facb3f9a5d08f34e87", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/1440a6f1d30fc6cb7f4107facb3f9a5d08f34e87", "committedDate": "2021-03-07T13:57:47Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion."}, "afterCommit": {"oid": "57cd88378e64e7c534d592d4538b2aa8222a2b00", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/57cd88378e64e7c534d592d4538b2aa8222a2b00", "committedDate": "2021-03-07T15:25:00Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57cd88378e64e7c534d592d4538b2aa8222a2b00", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/57cd88378e64e7c534d592d4538b2aa8222a2b00", "committedDate": "2021-03-07T15:25:00Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}, "afterCommit": {"oid": "379905b396355d37f565230cbcbee323dc626dce", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/379905b396355d37f565230cbcbee323dc626dce", "committedDate": "2021-03-08T03:36:48Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "379905b396355d37f565230cbcbee323dc626dce", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/379905b396355d37f565230cbcbee323dc626dce", "committedDate": "2021-03-08T03:36:48Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}, "afterCommit": {"oid": "522dfaaf4295b903fa0c2d88e79db6d267086730", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/522dfaaf4295b903fa0c2d88e79db6d267086730", "committedDate": "2021-03-08T05:48:19Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "522dfaaf4295b903fa0c2d88e79db6d267086730", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/522dfaaf4295b903fa0c2d88e79db6d267086730", "committedDate": "2021-03-08T05:48:19Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}, "afterCommit": {"oid": "8006bdc42eddf90eaaf8b1a426e3ee3c9b635e3c", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/8006bdc42eddf90eaaf8b1a426e3ee3c9b635e3c", "committedDate": "2021-03-08T12:38:46Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8006bdc42eddf90eaaf8b1a426e3ee3c9b635e3c", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/8006bdc42eddf90eaaf8b1a426e3ee3c9b635e3c", "committedDate": "2021-03-08T12:38:46Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}, "afterCommit": {"oid": "4b4b098f5eb40c7caf885c30b8c12aced99bbe05", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/4b4b098f5eb40c7caf885c30b8c12aced99bbe05", "committedDate": "2021-03-08T13:58:14Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4b4b098f5eb40c7caf885c30b8c12aced99bbe05", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/4b4b098f5eb40c7caf885c30b8c12aced99bbe05", "committedDate": "2021-03-08T13:58:14Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}, "afterCommit": {"oid": "87c4d9e67b205d7ca2fedf25a5a59402500de2ce", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/87c4d9e67b205d7ca2fedf25a5a59402500de2ce", "committedDate": "2021-03-28T12:53:34Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87c4d9e67b205d7ca2fedf25a5a59402500de2ce", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/87c4d9e67b205d7ca2fedf25a5a59402500de2ce", "committedDate": "2021-03-28T12:53:34Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}, "afterCommit": {"oid": "86af5b748a70ba9bb997d654b6f76c0f3a343bc0", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/86af5b748a70ba9bb997d654b6f76c0f3a343bc0", "committedDate": "2021-05-08T07:29:43Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a5c416aee052ec8ed5b4ad88d6b7707c3df9d061", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/a5c416aee052ec8ed5b4ad88d6b7707c3df9d061", "committedDate": "2021-05-10T03:54:25Z", "message": "Commit for test"}, "afterCommit": {"oid": "ae312385b57ca67cdb73ee96be38c4edbe56478d", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/ae312385b57ca67cdb73ee96be38c4edbe56478d", "committedDate": "2021-05-10T06:49:44Z", "message": "Commit for test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae312385b57ca67cdb73ee96be38c4edbe56478d", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/ae312385b57ca67cdb73ee96be38c4edbe56478d", "committedDate": "2021-05-10T06:49:44Z", "message": "Commit for test"}, "afterCommit": {"oid": "4f4ce33b815167b23c8ee3dc8d65e1e97cc0cd07", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/4f4ce33b815167b23c8ee3dc8d65e1e97cc0cd07", "committedDate": "2021-05-10T10:06:29Z", "message": "Commit for test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f4ce33b815167b23c8ee3dc8d65e1e97cc0cd07", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/4f4ce33b815167b23c8ee3dc8d65e1e97cc0cd07", "committedDate": "2021-05-10T10:06:29Z", "message": "Commit for test"}, "afterCommit": {"oid": "8550965d808fe7b4d6ff2d48034612878937a579", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/8550965d808fe7b4d6ff2d48034612878937a579", "committedDate": "2021-05-11T08:33:04Z", "message": "Fix commit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8550965d808fe7b4d6ff2d48034612878937a579", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/8550965d808fe7b4d6ff2d48034612878937a579", "committedDate": "2021-05-11T08:33:04Z", "message": "Fix commit"}, "afterCommit": {"oid": "7b6eb661923f59967a116e9074cf790fd694c578", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/7b6eb661923f59967a116e9074cf790fd694c578", "committedDate": "2021-05-11T12:15:11Z", "message": "Commit for test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b6eb661923f59967a116e9074cf790fd694c578", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/7b6eb661923f59967a116e9074cf790fd694c578", "committedDate": "2021-05-11T12:15:11Z", "message": "Commit for test"}, "afterCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/2c49d1a8cee6485e8f367190f152e58960c901ff", "committedDate": "2021-05-11T12:14:09Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Njk2MjYyMDA2", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-696262006", "createdAt": "2021-06-30T14:46:42Z", "commit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "state": "COMMENTED", "comments": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0zMFQxNDo0Njo0MlrOJ25nvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0zMFQxNjowNTo0NVrOJ297dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTU0Njk0MA==", "bodyText": "Before these changes where this buffer was recycled? or was it the bug?", "url": "https://github.com/apache/flink/pull/11877#discussion_r661546940", "createdAt": "2021-06-30T14:46:42Z", "author": {"login": "akalash"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedPartitionRequestClientHandler.java", "diffHunk": "@@ -340,7 +355,15 @@ private void decodeBufferOrEvent(\n             RemoteInputChannel inputChannel, NettyMessage.BufferResponse bufferOrEvent)\n             throws Throwable {\n         if (bufferOrEvent.isBuffer() && bufferOrEvent.bufferSize == 0) {\n-            inputChannel.onEmptyBuffer(bufferOrEvent.sequenceNumber, bufferOrEvent.backlog);\n+            try {\n+                inputChannel.onEmptyBuffer(bufferOrEvent.sequenceNumber, bufferOrEvent.backlog);\n+            } finally {\n+                // recycle the empty buffer directly\n+                Buffer buffer = bufferOrEvent.getBuffer();\n+                if (buffer != null) {\n+                    buffer.recycleBuffer();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTU1NDAyOQ==", "bodyText": "as I understand, the backlog can not be less or equal to 0 here. So maybe convert it to checkArgument? Or I missed something?", "url": "https://github.com/apache/flink/pull/11877#discussion_r661554029", "createdAt": "2021-06-30T14:53:56Z", "author": {"login": "akalash"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/PartitionRequestQueue.java", "diffHunk": "@@ -164,6 +168,27 @@ void addCreditOrResumeConsumption(\n         }\n     }\n \n+    /**\n+     * Announces remaining backlog to the consumer after the available data notification or data\n+     * consumption resumption.\n+     */\n+    private void announceBacklog(NetworkSequenceViewReader reader) {\n+        int backlog = reader.getRemainingBacklog();\n+        if (backlog > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTU1NzYxOA==", "bodyText": "Is it also a bug? Or why do we distinguish EVENT_BUFFER and DATA_BUFFER now?", "url": "https://github.com/apache/flink/pull/11877#discussion_r661557618", "createdAt": "2021-06-30T14:57:48Z", "author": {"login": "akalash"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/BoundedBlockingSubpartitionDirectTransferReader.java", "diffHunk": "@@ -91,10 +91,14 @@ public BufferAndBacklog getNextBuffer() throws IOException {\n \n         updateStatistics(current);\n \n-        // We simply assume all the data are non-events for batch jobs to avoid pre-fetching the\n-        // next header\n-        Buffer.DataType nextDataType =\n-                numDataAndEventBuffers > 0 ? Buffer.DataType.DATA_BUFFER : Buffer.DataType.NONE;\n+        // We simply assume all the data except for the last one (EndOfPartitionEvent)\n+        // are non-events for batch jobs to avoid pre-fetching the next header\n+        Buffer.DataType nextDataType = Buffer.DataType.NONE;\n+        if (numDataBuffers > 0) {\n+            nextDataType = Buffer.DataType.DATA_BUFFER;\n+        } else if (numDataAndEventBuffers > 0) {\n+            nextDataType = Buffer.DataType.EVENT_BUFFER;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTU2MzMwNA==", "bodyText": "Does this mean that we don't need the credit for sending the event?", "url": "https://github.com/apache/flink/pull/11877#discussion_r661563304", "createdAt": "2021-06-30T15:04:06Z", "author": {"login": "akalash"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/BoundedBlockingSubpartitionDirectTransferReader.java", "diffHunk": "@@ -110,7 +114,12 @@ private void updateStatistics(Buffer buffer) {\n     public boolean isAvailable(int numCreditsAvailable) {\n         // We simply assume there are no events except EndOfPartitionEvent for bath jobs,\n         // then it has no essential effect to ignore the judgement of next event buffer.\n-        return numCreditsAvailable > 0 && numDataAndEventBuffers > 0;\n+        return (numCreditsAvailable > 0 || numDataBuffers == 0) && numDataAndEventBuffers > 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTU4OTY5MA==", "bodyText": "I don't really get the idea of these changes.\nLet's suppose PipelindedSubpartition#buffers contain several but the first one is empty and finished already.\nHow it was before the changes:\n\nPartitionRequestQueue requests the buffer.\nin any case, PipelindedSubpartition#pollBuffer returns a buffer(it skip the first one because it is empty and finished but it returns the buffer from the next consumer)\nPartitionRequestQueue continues to request from this Reader until PipelindedSubpartition#buffers is not empty.\n\nAfter the changes:\n\nPartitionRequestQueue requests the buffer.\nPipelindedSubpartition#pollBuffer returns null.\nPartitionRequestQueue remove this reader from the available readers\nOther buffers from PipelindedSubpartition#buffers will be sent only when timeout happens and this reader is added to the available list again.\n\nWhat the point to delay the sending if we already have credit for it and we have the buffer ready to be sent?", "url": "https://github.com/apache/flink/pull/11877#discussion_r661589690", "createdAt": "2021-06-30T15:33:14Z", "author": {"login": "akalash"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -288,9 +288,7 @@ BufferAndBacklog pollBuffer() {\n \n             if (buffers.isEmpty()) {\n                 flushRequested = false;\n-            }\n-\n-            while (!buffers.isEmpty()) {\n+            } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTU5MjQ2Ng==", "bodyText": "So dangerous, why you so sure that buffers contain at least one object?", "url": "https://github.com/apache/flink/pull/11877#discussion_r661592466", "createdAt": "2021-06-30T15:36:17Z", "author": {"login": "akalash"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -513,19 +514,20 @@ private void increaseBuffersInBacklog(BufferConsumer buffer) {\n         }\n     }\n \n-    /**\n-     * Gets the number of non-event buffers in this subpartition.\n-     *\n-     * <p><strong>Beware:</strong> This method should only be used in tests in non-concurrent access\n-     * scenarios since it does not make any concurrency guarantees.\n-     */\n-    @SuppressWarnings(\"FieldAccessNotGuarded\")\n-    @VisibleForTesting\n+    /** Gets the number of non-event buffers in this subpartition. */\n     public int getBuffersInBacklog() {\n-        if (flushRequested || isFinished) {\n-            return buffersInBacklog;\n-        } else {\n-            return Math.max(buffersInBacklog - 1, 0);\n+        synchronized (buffers) {\n+            if (isBlocked || buffers.isEmpty()) {\n+                return 0;\n+            }\n+\n+            if (flushRequested\n+                    || isFinished\n+                    || !checkNotNull(buffers.peekLast()).getBufferConsumer().isBuffer()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTU5NzQ4Mg==", "bodyText": "It seems that it is the wrong place for such condition. Logically, even if the subpartition is blocked it still has the buffers. But as I understand, specifically for the case where 'initialCredit == 0' it should return 0. So it needs to think how does it do better.", "url": "https://github.com/apache/flink/pull/11877#discussion_r661597482", "createdAt": "2021-06-30T15:42:05Z", "author": {"login": "akalash"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -513,19 +514,20 @@ private void increaseBuffersInBacklog(BufferConsumer buffer) {\n         }\n     }\n \n-    /**\n-     * Gets the number of non-event buffers in this subpartition.\n-     *\n-     * <p><strong>Beware:</strong> This method should only be used in tests in non-concurrent access\n-     * scenarios since it does not make any concurrency guarantees.\n-     */\n-    @SuppressWarnings(\"FieldAccessNotGuarded\")\n-    @VisibleForTesting\n+    /** Gets the number of non-event buffers in this subpartition. */\n     public int getBuffersInBacklog() {\n-        if (flushRequested || isFinished) {\n-            return buffersInBacklog;\n-        } else {\n-            return Math.max(buffersInBacklog - 1, 0);\n+        synchronized (buffers) {\n+            if (isBlocked || buffers.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTU5OTQ1Ng==", "bodyText": "As I understand, initialCredit is an unchangeable value, and BufferManager and AvailableBufferQueue know this value so maybe it is better to avoid this parameter?", "url": "https://github.com/apache/flink/pull/11877#discussion_r661599456", "createdAt": "2021-06-30T15:44:30Z", "author": {"login": "akalash"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/BufferManager.java", "diffHunk": "@@ -83,8 +84,13 @@ public BufferManager(\n     // ------------------------------------------------------------------------\n \n     @Nullable\n-    Buffer requestBuffer() {\n+    Buffer requestBuffer(int initialCredit) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTYwMjExMw==", "bodyText": "I don't understand why initialCredit == 0 should be handled differently here. Even if initialCredit == 1 and the Buffer is requested we should decrease this value, or am I wrong?", "url": "https://github.com/apache/flink/pull/11877#discussion_r661602113", "createdAt": "2021-06-30T15:47:15Z", "author": {"login": "akalash"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/BufferManager.java", "diffHunk": "@@ -83,8 +84,13 @@ public BufferManager(\n     // ------------------------------------------------------------------------\n \n     @Nullable\n-    Buffer requestBuffer() {\n+    Buffer requestBuffer(int initialCredit) {\n         synchronized (bufferQueue) {\n+            // decrease the number of buffers require to avoid the possibility of\n+            // allocating more than required buffers after the buffer is taken\n+            if (initialCredit == 0) {\n+                --numRequiredBuffers;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTYwMzY2MA==", "bodyText": "As I understand, the negative number is still illegal. So maybe it makes sense to add checkArgument for numExclusiveBuffers < 0?", "url": "https://github.com/apache/flink/pull/11877#discussion_r661603660", "createdAt": "2021-06-30T15:49:02Z", "author": {"login": "akalash"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/BufferManager.java", "diffHunk": "@@ -130,11 +136,11 @@ private boolean shouldContinueRequest(BufferPool bufferPool) {\n \n     /** Requests exclusive buffers from the provider. */\n     void requestExclusiveBuffers(int numExclusiveBuffers) throws IOException {\n-        Collection<MemorySegment> segments = globalPool.requestMemorySegments(numExclusiveBuffers);\n-        checkArgument(\n-                !segments.isEmpty(),\n-                \"The number of exclusive buffers per channel should be larger than 0.\");\n+        if (numExclusiveBuffers <= 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTYwNTE3Mw==", "bodyText": "Can you explain what kind of deadlock can happen? Between LocalBufferPool and BufferManager?", "url": "https://github.com/apache/flink/pull/11877#discussion_r661605173", "createdAt": "2021-06-30T15:50:49Z", "author": {"login": "akalash"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/BufferManager.java", "diffHunk": "@@ -215,9 +221,15 @@ public void recycle(MemorySegment segment) {\n     }\n \n     void releaseFloatingBuffers() {\n+        Queue<Buffer> buffers;\n         synchronized (bufferQueue) {\n             numRequiredBuffers = 0;\n-            bufferQueue.releaseFloatingBuffers();\n+            buffers = bufferQueue.clearFloatingBuffers();\n+        }\n+\n+        // recycle all buffers out of the synchronization block to avoid dead lock", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTYwNjUwMg==", "bodyText": "The same question that earlier - is this bug? or where did we recycle the buffer before this changes?", "url": "https://github.com/apache/flink/pull/11877#discussion_r661606502", "createdAt": "2021-06-30T15:52:17Z", "author": {"login": "akalash"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/LocalInputChannel.java", "diffHunk": "@@ -265,6 +265,13 @@ public void run() {\n                 channelInfo,\n                 channelStatePersister,\n                 next.getSequenceNumber());\n+\n+        // ignore the empty buffer directly\n+        if (buffer.readableBytes() == 0) {\n+            buffer.recycleBuffer();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTYxMDY0Nw==", "bodyText": "How is it even possible to get an empty buffer? Who is sending it?", "url": "https://github.com/apache/flink/pull/11877#discussion_r661610647", "createdAt": "2021-06-30T15:57:06Z", "author": {"login": "akalash"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/LocalInputChannel.java", "diffHunk": "@@ -265,6 +265,13 @@ public void run() {\n                 channelInfo,\n                 channelStatePersister,\n                 next.getSequenceNumber());\n+\n+        // ignore the empty buffer directly\n+        if (buffer.readableBytes() == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTYxMzIwMQ==", "bodyText": "Why can not we do the same thing for any number of credits not only for initialCredit == 0? Or does it slow down the load after resuming?", "url": "https://github.com/apache/flink/pull/11877#discussion_r661613201", "createdAt": "2021-06-30T16:00:20Z", "author": {"login": "akalash"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -357,11 +359,26 @@ public void resumeConsumption() throws IOException {\n         checkState(!isReleased.get(), \"Channel released.\");\n         checkPartitionRequestQueueInitialized();\n \n+        if (initialCredit == 0) {\n+            unannouncedCredit.set(0);\n+        }\n+\n         // notifies the producer that this channel is ready to\n         // unblock from checkpoint and resume data consumption\n         partitionRequestClient.resumeConsumption(this);\n     }\n \n+    private void onBlockingUpstream() {\n+        if (initialCredit == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTYxNDc2Nw==", "bodyText": "Do we need to do so because we released all buffers in onBlockingUpstream? If so can we hold this code in one place, ex. to move it into onBlockingUpstream?", "url": "https://github.com/apache/flink/pull/11877#discussion_r661614767", "createdAt": "2021-06-30T16:02:14Z", "author": {"login": "akalash"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -357,11 +359,26 @@ public void resumeConsumption() throws IOException {\n         checkState(!isReleased.get(), \"Channel released.\");\n         checkPartitionRequestQueueInitialized();\n \n+        if (initialCredit == 0) {\n+            unannouncedCredit.set(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTYxNzUyNg==", "bodyText": "Do we do it because we know that all floating buffers would be released before the checkpoint when initialCredit == 0?", "url": "https://github.com/apache/flink/pull/11877#discussion_r661617526", "createdAt": "2021-06-30T16:05:45Z", "author": {"login": "akalash"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedSequenceNumberingViewReader.java", "diffHunk": "@@ -100,8 +106,19 @@ public void addCredit(int creditDeltas) {\n         numCreditsAvailable += creditDeltas;\n     }\n \n+    @Override\n+    public boolean needAnnounceBacklog() {\n+        return initialCredit == 0 && numCreditsAvailable == 0;\n+    }\n+\n     @Override\n     public void resumeConsumption() {\n+        if (initialCredit == 0) {\n+            // reset available credit if no exclusive buffer is available at the\n+            // consumer side for all floating buffers must have been released\n+            numCreditsAvailable = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 43}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/2c49d1a8cee6485e8f367190f152e58960c901ff", "committedDate": "2021-05-11T12:14:09Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}, "afterCommit": {"oid": "c161aff32e5aed483ca0722e0504ec8493348947", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/c161aff32e5aed483ca0722e0504ec8493348947", "committedDate": "2021-07-01T07:53:09Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c161aff32e5aed483ca0722e0504ec8493348947", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/c161aff32e5aed483ca0722e0504ec8493348947", "committedDate": "2021-07-01T07:53:09Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}, "afterCommit": {"oid": "159596e8f11586211a5f54e6aaae2c9fdee532a2", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/159596e8f11586211a5f54e6aaae2c9fdee532a2", "committedDate": "2021-07-02T02:08:29Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "159596e8f11586211a5f54e6aaae2c9fdee532a2", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/159596e8f11586211a5f54e6aaae2c9fdee532a2", "committedDate": "2021-07-02T02:08:29Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}, "afterCommit": {"oid": "1814aee57851711782cc2d922c4ef8f118a74c13", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/1814aee57851711782cc2d922c4ef8f118a74c13", "committedDate": "2021-07-05T01:55:10Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1814aee57851711782cc2d922c4ef8f118a74c13", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/1814aee57851711782cc2d922c4ef8f118a74c13", "committedDate": "2021-07-05T01:55:10Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}, "afterCommit": {"oid": "f28812c2d19b7109e851d4cce6cdb9df82868117", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/f28812c2d19b7109e851d4cce6cdb9df82868117", "committedDate": "2021-07-05T07:02:25Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f28812c2d19b7109e851d4cce6cdb9df82868117", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/f28812c2d19b7109e851d4cce6cdb9df82868117", "committedDate": "2021-07-05T07:02:25Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}, "afterCommit": {"oid": "048818bd8e4548d20febf9308b83e42146806b6e", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/048818bd8e4548d20febf9308b83e42146806b6e", "committedDate": "2021-07-05T07:13:41Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "048818bd8e4548d20febf9308b83e42146806b6e", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/048818bd8e4548d20febf9308b83e42146806b6e", "committedDate": "2021-07-05T07:13:41Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}, "afterCommit": {"oid": "ae5a618edba91af4656de9bab058e4a372a01331", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/ae5a618edba91af4656de9bab058e4a372a01331", "committedDate": "2021-07-05T08:17:11Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae5a618edba91af4656de9bab058e4a372a01331", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/ae5a618edba91af4656de9bab058e4a372a01331", "committedDate": "2021-07-05T08:17:11Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}, "afterCommit": {"oid": "109e1d36469b537f997a7c844e57e23729a1af21", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/109e1d36469b537f997a7c844e57e23729a1af21", "committedDate": "2021-07-05T08:39:29Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "109e1d36469b537f997a7c844e57e23729a1af21", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/109e1d36469b537f997a7c844e57e23729a1af21", "committedDate": "2021-07-05T08:39:29Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}, "afterCommit": {"oid": "028f2185c0bb15c542006065550d04f69b0b06bd", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/028f2185c0bb15c542006065550d04f69b0b06bd", "committedDate": "2021-07-06T04:02:58Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Njk5ODgzMDk0", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-699883094", "createdAt": "2021-07-06T12:20:30Z", "commit": {"oid": "028f2185c0bb15c542006065550d04f69b0b06bd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0wNlQxMjoyMDozMVrOJ5uE5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0wNlQxNTo1NDo0OFrOJ55B7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDUwMzUyNw==", "bodyText": "What do you mean by that @wsry ? That previously bufferOrEevnt.getBuffer() was always null?\nIf so why do we need to keep suport for sending both empty buffers or null buffer?", "url": "https://github.com/apache/flink/pull/11877#discussion_r664503527", "createdAt": "2021-07-06T12:20:31Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedPartitionRequestClientHandler.java", "diffHunk": "@@ -340,7 +355,15 @@ private void decodeBufferOrEvent(\n             RemoteInputChannel inputChannel, NettyMessage.BufferResponse bufferOrEvent)\n             throws Throwable {\n         if (bufferOrEvent.isBuffer() && bufferOrEvent.bufferSize == 0) {\n-            inputChannel.onEmptyBuffer(bufferOrEvent.sequenceNumber, bufferOrEvent.backlog);\n+            try {\n+                inputChannel.onEmptyBuffer(bufferOrEvent.sequenceNumber, bufferOrEvent.backlog);\n+            } finally {\n+                // recycle the empty buffer directly\n+                Buffer buffer = bufferOrEvent.getBuffer();\n+                if (buffer != null) {\n+                    buffer.recycleBuffer();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTU0Njk0MA=="}, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDY0NDA3Ng==", "bodyText": "Why is this an issue? Is this an independent optimisation or is it relate with the other parts of the PR?", "url": "https://github.com/apache/flink/pull/11877#discussion_r664644076", "createdAt": "2021-07-06T15:08:46Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedPartitionRequestClientHandler.java", "diffHunk": "@@ -433,8 +459,8 @@ public void operationComplete(ChannelFuture future) throws Exception {\n \n         @Override\n         public Object buildMessage() {\n-            return new AddCredit(\n-                    inputChannel.getAndResetUnannouncedCredit(), inputChannel.getInputChannelId());\n+            int credits = inputChannel.getAndResetUnannouncedCredit();\n+            return credits > 0 ? new AddCredit(credits, inputChannel.getInputChannelId()) : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "028f2185c0bb15c542006065550d04f69b0b06bd"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDY0ODA4NA==", "bodyText": "Have you tested this @wsry ? After all it seems like if reader is available, it should have backlog > 0, shouldn't it?", "url": "https://github.com/apache/flink/pull/11877#discussion_r664648084", "createdAt": "2021-07-06T15:13:14Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/PartitionRequestQueue.java", "diffHunk": "@@ -164,6 +168,27 @@ void addCreditOrResumeConsumption(\n         }\n     }\n \n+    /**\n+     * Announces remaining backlog to the consumer after the available data notification or data\n+     * consumption resumption.\n+     */\n+    private void announceBacklog(NetworkSequenceViewReader reader) {\n+        int backlog = reader.getRemainingBacklog();\n+        if (backlog > 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTU1NDAyOQ=="}, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDY1MDU4Nw==", "bodyText": "Secondly, return type of the buildMessage() is not annotated @Nullable, so if we need this code for correctness we need to add this annotation (but it would be better to avoid null here)", "url": "https://github.com/apache/flink/pull/11877#discussion_r664650587", "createdAt": "2021-07-06T15:16:14Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/CreditBasedPartitionRequestClientHandler.java", "diffHunk": "@@ -433,8 +459,8 @@ public void operationComplete(ChannelFuture future) throws Exception {\n \n         @Override\n         public Object buildMessage() {\n-            return new AddCredit(\n-                    inputChannel.getAndResetUnannouncedCredit(), inputChannel.getInputChannelId());\n+            int credits = inputChannel.getAndResetUnannouncedCredit();\n+            return credits > 0 ? new AddCredit(credits, inputChannel.getInputChannelId()) : null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDY0NDA3Ng=="}, "originalCommit": {"oid": "028f2185c0bb15c542006065550d04f69b0b06bd"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDY1MTgwOA==", "bodyText": "@Nullable\nDo we really need to support null here? Can not we return empty Buffer?", "url": "https://github.com/apache/flink/pull/11877#discussion_r664651808", "createdAt": "2021-07-06T15:17:45Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/NetworkBufferAllocator.java", "diffHunk": "@@ -69,6 +69,9 @@ Buffer allocatePooledNetworkBuffer(InputChannelID receiverId) {\n      * @return The un-pooled network buffer.\n      */\n     Buffer allocateUnPooledNetworkBuffer(int size, Buffer.DataType dataType) {\n+        if (size <= 0) {\n+            return null;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "028f2185c0bb15c542006065550d04f69b0b06bd"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDY1NDk0OQ==", "bodyText": "But what would be a problem with requesting for a credit for the EndOfPartitionEvent? In other words, what's wrong with doing it as it was done previously: always returning DATA_BUFFER or NONE?", "url": "https://github.com/apache/flink/pull/11877#discussion_r664654949", "createdAt": "2021-07-06T15:21:25Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/BoundedBlockingSubpartitionDirectTransferReader.java", "diffHunk": "@@ -91,10 +91,14 @@ public BufferAndBacklog getNextBuffer() throws IOException {\n \n         updateStatistics(current);\n \n-        // We simply assume all the data are non-events for batch jobs to avoid pre-fetching the\n-        // next header\n-        Buffer.DataType nextDataType =\n-                numDataAndEventBuffers > 0 ? Buffer.DataType.DATA_BUFFER : Buffer.DataType.NONE;\n+        // We simply assume all the data except for the last one (EndOfPartitionEvent)\n+        // are non-events for batch jobs to avoid pre-fetching the next header\n+        Buffer.DataType nextDataType = Buffer.DataType.NONE;\n+        if (numDataBuffers > 0) {\n+            nextDataType = Buffer.DataType.DATA_BUFFER;\n+        } else if (numDataAndEventBuffers > 0) {\n+            nextDataType = Buffer.DataType.EVENT_BUFFER;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTU1NzYxOA=="}, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDY1OTk5NQ==", "bodyText": "Instead of this check here, can not we add similar check outside of the while (...) loop? For example replace:\nif (buffer == null) {\n    return null;\n}\n\nwith something like:\nif (buffer == null) {\n   if (buffersPerChannel == 0) {\n       return EMPTY_BUFFER;\n    }\n    else {\n       return null;\n    }\n}\n\n?\nThat way, we would avoid sending empty buffer if there are still more buffers in the backlog that are already enqueued?", "url": "https://github.com/apache/flink/pull/11877#discussion_r664659995", "createdAt": "2021-07-06T15:27:16Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -315,6 +326,17 @@ BufferAndBacklog pollBuffer() {\n                 if (buffer.readableBytes() > 0) {\n                     break;\n                 }\n+\n+                // if we have an empty finished buffer and the exclusive credit is 0, we just return\n+                // the empty buffer so that the downstream task can release the allocated credit for\n+                // this empty buffer, this happens in two main scenarios currently:\n+                // 1. all data of a buffer builder has been read and after that the buffer builder\n+                // is finished\n+                // 2. in approximate recovery mode, a partial record takes a whole buffer builder\n+                if (buffersPerChannel == 0 && bufferConsumer.isFinished()) {\n+                    break;\n+                }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "028f2185c0bb15c542006065550d04f69b0b06bd"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDY2MjE1Mw==", "bodyText": "pollBuffer() would be acquiring the lock twice, wouldn't it? If you really need to make this method public you should keep private int getBuffersInBacklogUnsafe() without any synchronisation.", "url": "https://github.com/apache/flink/pull/11877#discussion_r664662153", "createdAt": "2021-07-06T15:29:41Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -517,19 +539,20 @@ private void increaseBuffersInBacklog(BufferConsumer buffer) {\n         }\n     }\n \n-    /**\n-     * Gets the number of non-event buffers in this subpartition.\n-     *\n-     * <p><strong>Beware:</strong> This method should only be used in tests in non-concurrent access\n-     * scenarios since it does not make any concurrency guarantees.\n-     */\n-    @SuppressWarnings(\"FieldAccessNotGuarded\")\n-    @VisibleForTesting\n+    /** Gets the number of non-event buffers in this subpartition. */\n     public int getBuffersInBacklog() {\n-        if (flushRequested || isFinished) {\n-            return buffersInBacklog;\n-        } else {\n-            return Math.max(buffersInBacklog - 1, 0);\n+        synchronized (buffers) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "028f2185c0bb15c542006065550d04f69b0b06bd"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDY2OTg1NA==", "bodyText": "Secondly, getRemainingBacklog() is a very costly operation (additional synchronisation) that I think could have been avoided:\n\nBacklog can go up only as a result of org.apache.flink.runtime.io.network.netty.PartitionRequestQueue#notifyReaderNonEmpty(reader).\nBacklog can go down, only as a result of polling the data from the reader.\nSo instead of using thread safe reader.getRemainingBacklog(), we could re-use existing synchronisation in 1. and 2., to maintain remainingBacklog in the netty thread (in the PartitionRequestQueue.\n\nBut it would be even better to completely avoid this check (my comment above).", "url": "https://github.com/apache/flink/pull/11877#discussion_r664669854", "createdAt": "2021-07-06T15:38:50Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/netty/PartitionRequestQueue.java", "diffHunk": "@@ -164,6 +168,27 @@ void addCreditOrResumeConsumption(\n         }\n     }\n \n+    /**\n+     * Announces remaining backlog to the consumer after the available data notification or data\n+     * consumption resumption.\n+     */\n+    private void announceBacklog(NetworkSequenceViewReader reader) {\n+        int backlog = reader.getRemainingBacklog();\n+        if (backlog > 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTU1NDAyOQ=="}, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDY3NTg2Nw==", "bodyText": "add the backlog value to the error message?", "url": "https://github.com/apache/flink/pull/11877#discussion_r664675867", "createdAt": "2021-07-06T15:46:08Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -468,6 +485,11 @@ public void onBuffer(Buffer buffer, int sequenceNumber, int backlog) throws IOEx\n                 return;\n             }\n \n+            if (buffer.getDataType().isBlockingUpstream()) {\n+                onBlockingUpstream();\n+                checkArgument(backlog == 0, \"Illegal number of backlog.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "028f2185c0bb15c542006065550d04f69b0b06bd"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDY4Mjk4OA==", "bodyText": "But how can this floating credit be assigned to this blocked RemoteInputChannel? Wouldn't it cause the same deadlock, when floating buffers are assigned to blocked channels and job/task can not make any progress?\nIt sounds like maybe this should have been handled sooner when trying to increase unannouncedCredit?", "url": "https://github.com/apache/flink/pull/11877#discussion_r664682988", "createdAt": "2021-07-06T15:54:48Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -357,11 +359,26 @@ public void resumeConsumption() throws IOException {\n         checkState(!isReleased.get(), \"Channel released.\");\n         checkPartitionRequestQueueInitialized();\n \n+        if (initialCredit == 0) {\n+            unannouncedCredit.set(0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTYxNDc2Nw=="}, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "028f2185c0bb15c542006065550d04f69b0b06bd", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/028f2185c0bb15c542006065550d04f69b0b06bd", "committedDate": "2021-07-06T04:02:58Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}, "afterCommit": {"oid": "fb631b77700e2f05dcfdd50cd50cdea35e7cfb13", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/fb631b77700e2f05dcfdd50cd50cdea35e7cfb13", "committedDate": "2021-07-07T02:10:53Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb631b77700e2f05dcfdd50cd50cdea35e7cfb13", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/fb631b77700e2f05dcfdd50cd50cdea35e7cfb13", "committedDate": "2021-07-07T02:10:53Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}, "afterCommit": {"oid": "826c1aaddfc41d54a5b3f52be9feb73a0b193ebc", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/826c1aaddfc41d54a5b3f52be9feb73a0b193ebc", "committedDate": "2021-07-07T08:46:21Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "826c1aaddfc41d54a5b3f52be9feb73a0b193ebc", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/826c1aaddfc41d54a5b3f52be9feb73a0b193ebc", "committedDate": "2021-07-07T08:46:21Z", "message": "[FLINK-16641][network] Announce sender's backlog to solve the deadlock issue without exclusive buffers\n\nThis commit improves the current backlog announcement logic in two main aspects:\n1. If there is no initial credit, the upstream producer task will announce the available backlog to the downstream consumer task when available data is notified.\n2. The downstream consumer task will release all allocated buffers (credit) on receiving the aligned checkpoint barrier. Besides, it will never allocate any credit before checkpoint completion.\n3. For empty buffers of the upstream task, instead of released directly, they will be sent to the downstream task to release the buffers (credit) allocated for them."}, "afterCommit": {"oid": "01b2bc58b30a2a3730895f7c50ff59099bd273d2", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/01b2bc58b30a2a3730895f7c50ff59099bd273d2", "committedDate": "2021-07-08T12:39:09Z", "message": "[FLINK-16641][network] (Part#6) Enable to set network buffers per channel to 0\n\nThis PR enables to set the number of network buffer per channel (taskmanager.network.memory.buffers-per-channel) to 0. Previously, the value can not be set to 0 because of dead lock, FLINK-16641 solves the problem and we can set it to 0 now."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzAyMjEyOTk1", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-702212995", "createdAt": "2021-07-08T15:31:22Z", "commit": {"oid": "c9956bc098175364585e5661d5d4ca097b2fe876"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0wOFQxNTozMToyMlrOJ7b42A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0wOFQxNjoxOToyN1rOJ7eNow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjMwMjY4MA==", "bodyText": "nit: Rename to getBuffersInBacklogUnsafe() (previously it was a private method just made @VisibleForTesting)", "url": "https://github.com/apache/flink/pull/11877#discussion_r666302680", "createdAt": "2021-07-08T15:31:22Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -517,16 +520,16 @@ private void increaseBuffersInBacklog(BufferConsumer buffer) {\n         }\n     }\n \n-    /**\n-     * Gets the number of non-event buffers in this subpartition.\n-     *\n-     * <p><strong>Beware:</strong> This method should only be used in tests in non-concurrent access\n-     * scenarios since it does not make any concurrency guarantees.\n-     */\n-    @SuppressWarnings(\"FieldAccessNotGuarded\")\n-    @VisibleForTesting\n+    /** Gets the number of non-event buffers in this subpartition. */\n+    @Override\n     public int getBuffersInBacklog() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9956bc098175364585e5661d5d4ca097b2fe876"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjMzNDUwNg==", "bodyText": "Ok, can you at least add a comment explaining why this is set to 0 here?", "url": "https://github.com/apache/flink/pull/11877#discussion_r666334506", "createdAt": "2021-07-08T16:11:06Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -357,11 +359,26 @@ public void resumeConsumption() throws IOException {\n         checkState(!isReleased.get(), \"Channel released.\");\n         checkPartitionRequestQueueInitialized();\n \n+        if (initialCredit == 0) {\n+            unannouncedCredit.set(0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTYxNDc2Nw=="}, "originalCommit": {"oid": "2c49d1a8cee6485e8f367190f152e58960c901ff"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjM0MDc3MQ==", "bodyText": "I can not seem to respond in the previous thread, so I need to start a new one.\n\nLet's maybe focus on the 3rd case first and we assume that the exclusive credit is 0.\n\nThere are only one data buffer in the queue.\nFlush triggered.\nAll data of the first buffer is committed but the buffer is still not finished.\nAll data of the buffer is consumed by pollBuffer and the available credit becomes 0.\nThe first buffer is finished, the second event is added and the data available notification is triggered.\nThe upstream announces backlog to the downstream to request a credit.\nThe upstream receives available credit and start to pollBuffer.\nSkip the first empty buffer and send the second event.\nThe downstream receive the event but the event does not consume any credit.\n\nDo you mean we should change the current logic and release the floating buffer for event in some cases (including reduce the available credit by 1 at the upstream, currently the available credit is not decreased for event)?\n\nNo, but I think we could send this regardless if any is credit available or not as we are doing right now. I think we are also already attaching information about the backlog to such event. One thing to add (unless we are not doing it already) would be to use this backlog information, to maybe release floating buffers if backlog dropped to 0?\n\nIf there are multiple empty buffers, should we just skip the first one or should we skip all?\n\nWe could skip all of them, until we reach one of the three options:\n\nnon empty data buffer\nevent (check above)\nlast empty buffer, without any events after it - here we would indeed need to send that empty buffer", "url": "https://github.com/apache/flink/pull/11877#discussion_r666340771", "createdAt": "2021-07-08T16:19:27Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -312,6 +323,16 @@ BufferAndBacklog pollBuffer() {\n                     decreaseBuffersInBacklogUnsafe(bufferConsumer.isBuffer());\n                 }\n \n+                // if we have an empty finished buffer and the exclusive credit is 0, we just return\n+                // the empty buffer so that the downstream task can release the allocated credit for\n+                // this empty buffer, this happens in two main scenarios currently:\n+                // 1. all data of a buffer builder has been read and after that the buffer builder\n+                // is finished\n+                // 2. in approximate recovery mode, a partial record takes a whole buffer builder\n+                if (buffersPerChannel == 0 && bufferConsumer.isFinished()) {\n+                    break;\n+                }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faee760500feb1a2f793a6d691a1d061b1d17917"}, "originalPosition": 48}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "01b2bc58b30a2a3730895f7c50ff59099bd273d2", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/01b2bc58b30a2a3730895f7c50ff59099bd273d2", "committedDate": "2021-07-08T12:39:09Z", "message": "[FLINK-16641][network] (Part#6) Enable to set network buffers per channel to 0\n\nThis PR enables to set the number of network buffer per channel (taskmanager.network.memory.buffers-per-channel) to 0. Previously, the value can not be set to 0 because of dead lock, FLINK-16641 solves the problem and we can set it to 0 now."}, "afterCommit": {"oid": "2792e1a43d72ffc013bb60bdea52a577316d933a", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/2792e1a43d72ffc013bb60bdea52a577316d933a", "committedDate": "2021-07-09T03:57:07Z", "message": "Fixup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2792e1a43d72ffc013bb60bdea52a577316d933a", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/2792e1a43d72ffc013bb60bdea52a577316d933a", "committedDate": "2021-07-09T03:57:07Z", "message": "Fixup"}, "afterCommit": {"oid": "d4b35b61d395564b24dd98896b785e22c6e3ab30", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/d4b35b61d395564b24dd98896b785e22c6e3ab30", "committedDate": "2021-07-09T03:59:19Z", "message": "Fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzAyNzg5NTk1", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-702789595", "createdAt": "2021-07-09T08:05:29Z", "commit": {"oid": "a3f6a9f67fcb3429ce0b086c3384f14ff4a31b29"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0wOVQwODowNToyOVrOJ73kkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0wOVQwODowNjo0OVrOJ73ngw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Njc1NjI0MQ==", "bodyText": "rename networkBuffersPerChannel -> configuredNetworkBuffersPerChannel to better reflect that we are actually overriding this value for the output?", "url": "https://github.com/apache/flink/pull/11877#discussion_r666756241", "createdAt": "2021-07-09T08:05:29Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/ResultPartitionFactory.java", "diffHunk": "@@ -156,15 +155,16 @@ public ResultPartition create(\n                             bufferCompressor,\n                             bufferPoolFactory);\n \n-            BiFunction<Integer, PipelinedResultPartition, PipelinedSubpartition> factory;\n-            if (type == ResultPartitionType.PIPELINED_APPROXIMATE) {\n-                factory = PipelinedApproximateSubpartition::new;\n-            } else {\n-                factory = PipelinedSubpartition::new;\n-            }\n-\n             for (int i = 0; i < subpartitions.length; i++) {\n-                subpartitions[i] = factory.apply(i, pipelinedPartition);\n+                if (type == ResultPartitionType.PIPELINED_APPROXIMATE) {\n+                    subpartitions[i] =\n+                            new PipelinedApproximateSubpartition(\n+                                    i, networkBuffersPerChannel, pipelinedPartition);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3f6a9f67fcb3429ce0b086c3384f14ff4a31b29"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Njc1Njk5NQ==", "bodyText": "Can we rename this property to something like receiverExclusiveBuffersPerChannel?  Because actually this is not the number of buffersPerChannel for the sender.", "url": "https://github.com/apache/flink/pull/11877#discussion_r666756995", "createdAt": "2021-07-09T08:06:49Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -112,8 +120,11 @@\n \n     // ------------------------------------------------------------------------\n \n-    PipelinedSubpartition(int index, ResultPartition parent) {\n+    PipelinedSubpartition(int index, int buffersPerChannel, ResultPartition parent) {\n         super(index, parent);\n+\n+        checkArgument(buffersPerChannel >= 0, \"Buffers per channel must be non-negative.\");\n+        this.buffersPerChannel = buffersPerChannel;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3f6a9f67fcb3429ce0b086c3384f14ff4a31b29"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4b35b61d395564b24dd98896b785e22c6e3ab30", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/d4b35b61d395564b24dd98896b785e22c6e3ab30", "committedDate": "2021-07-09T03:59:19Z", "message": "Fixup"}, "afterCommit": {"oid": "da81fde5fc9e110075cff4982048b7f7ee3a0d61", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/da81fde5fc9e110075cff4982048b7f7ee3a0d61", "committedDate": "2021-07-10T10:18:42Z", "message": "Fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzAzOTM4Mzgz", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-703938383", "createdAt": "2021-07-12T10:05:54Z", "commit": {"oid": "da81fde5fc9e110075cff4982048b7f7ee3a0d61"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0xMlQxMDowNTo1NFrOJ83LoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0xMlQxMDowNTo1NFrOJ83LoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Nzc5ODQzMg==", "bodyText": "Maybe a minor reword to:\n\nThe minimum valid value that can be configured is 0. When 0 buffers-per-channel is configured, the exclusive network buffers used per downstream incoming channel will be 0, but for each upstream outgoing channel, max(1, configured value) will be used. In other words we ensure that, for performance reasons, there is at least one buffer per outgoing channel regardless of the configuration.", "url": "https://github.com/apache/flink/pull/11877#discussion_r667798432", "createdAt": "2021-07-12T10:05:54Z", "author": {"login": "pnowojski"}, "path": "docs/layouts/shortcodes/generated/all_taskmanager_network_section.html", "diffHunk": "@@ -30,7 +30,7 @@\n             <td><h5>taskmanager.network.memory.buffers-per-channel</h5></td>\n             <td style=\"word-wrap: break-word;\">2</td>\n             <td>Integer</td>\n-            <td>Number of exclusive network buffers to use for each outgoing/incoming channel (subpartition/inputchannel) in the credit-based flow control model. It should be configured at least 2 for good performance. 1 buffer is for receiving in-flight data in the subpartition and 1 buffer is for parallel serialization.</td>\n+            <td>Number of exclusive network buffers to use for each outgoing/incoming channel (subpartition/input channel) in the credit-based flow control model. It should be configured at least 2 for good performance. 1 buffer is for receiving in-flight data in the subpartition and 1 buffer is for parallel serialization. The minimum valid value can be configured is 0 and when 0 is configured, the exclusive network buffers used per downstream incoming channel will be 0, but for each upstream outgoing channel, max(1, configured value) will be used which means that at least one buffer is needed and this behavior is for performance. If it's not guaranteed that each outgoing channel can get at least one buffer, more partial buffers with little data will be outputted to network/disk and recycled to be used by other channels which can not get a buffer for data caching.</td>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da81fde5fc9e110075cff4982048b7f7ee3a0d61"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbb34f9ce26fdec9ee5a6d67b9545dd2cbb18903", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/dbb34f9ce26fdec9ee5a6d67b9545dd2cbb18903", "committedDate": "2021-07-12T10:30:47Z", "message": "[hotfix] Remove redundant if condition in BufferManager\n\nThis closes #11877."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29d20e309908eea85d077c9f96f9c337217ee89b", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/29d20e309908eea85d077c9f96f9c337217ee89b", "committedDate": "2021-07-12T10:30:47Z", "message": "[hotfix] Remove outdated comments in UnionInputGate\n\nThis closes #11877."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3428a92d528b20b61d030429b9099347144256d", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/c3428a92d528b20b61d030429b9099347144256d", "committedDate": "2021-07-12T10:30:47Z", "message": "[hotfix] Simplify RemoteInputChannel#onSenderBacklog and call the existing method directly\n\nThis closes #11877."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b23c8f4778af071cb16b0f80b8357db4477ff812", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/b23c8f4778af071cb16b0f80b8357db4477ff812", "committedDate": "2021-07-12T10:30:47Z", "message": "[hotfix] Fix typos in NettyShuffleUtils\n\nThis closes #11877."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bede6d39163df06f22a1d64df440d1067408b2ec", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/bede6d39163df06f22a1d64df440d1067408b2ec", "committedDate": "2021-07-12T10:30:47Z", "message": "[FLINK-16641][network] (Part#1) Introduce a new network message BacklogAnnouncement which can bring the upstream buffer backlog to the downstream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ffa4e02e374cc5724552a4af8a15d03c8e31cca", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/0ffa4e02e374cc5724552a4af8a15d03c8e31cca", "committedDate": "2021-07-12T10:30:47Z", "message": "[FLINK-16641][network] (Part#2) Distinguish data buffer and event buffer for BoundedBlockingSubpartitionDirectTransferReader\n\nCurrently, the BoundedBlockingSubpartitionDirectTransferReader does not distinguish data buffer and event buffer but it does not allocate floating credits for events, which means it relies on at least one exclusive credit to send the events. This patch changes the logic and distinguishes data buffer and event buffer for BoundedBlockingSubpartitionDirectTransferReader, after which the BoundedBlockingSubpartitionDirectTransferReader does not rely on the exclusive credits any more and we can set the exclusive credit to 0 after we finish FLINK-16641."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "639672bb7f1223ab6612090d72ad7cf20fb8bfcc", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/639672bb7f1223ab6612090d72ad7cf20fb8bfcc", "committedDate": "2021-07-12T10:30:47Z", "message": "[FLINK-16641][network] (Part#3) Support to announce the upstream backlog to the downstream tasks\n\nThis batch introduce the ability of announcing upstream backlog to the downstream tasks through the BacklogAnnouncement message when the exclusive credit is 0. This gives the upstream tasks the ability to actively allocate credits from the downstream tasks, which is needed by FLINK-16641."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "412f55d8faa4ce6d8b014db6044da2ddac6b1e3b", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/412f55d8faa4ce6d8b014db6044da2ddac6b1e3b", "committedDate": "2021-07-12T10:30:47Z", "message": "[FLINK-16641][network] (Part#4) Release all allocated floating buffers of RemoteInputChannel on receiving any channel blocking event if the exclusive credit is 0\n\nThis patch tries to release all allocated floating buffers of RemoteInputChannel on receiving any channel blocking event if the exclusive credit is 0 because a blocked channel does not need any credit and after that, these released credits can be used by other active channels. This can avoid the deadlock where credits are assigned to channels which do need them and those channels who need credits can not get any when the exclusive credit is 0."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "941de53b0ae20ae40a820a1bb0e35c6d189a7221", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/941de53b0ae20ae40a820a1bb0e35c6d189a7221", "committedDate": "2021-07-12T10:45:01Z", "message": "[FLINK-16641][network] (Part#5) Send empty buffers to the downstream tasks to release the allocated credits if the exclusive credit is 0\n\nCurrently,the empty buffers are not sent to the downstream tasks. This patch changes the logic and sends empty buffers to the downstream tasks when the exclusive credit is 0 release the allocated floating credits. If we do not do that, the downstream task may allocate more credits than needed which may lead to dead lock without exclusive credits."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4609625eac16247f2d70d8c36c42b3e2dfec8768", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/4609625eac16247f2d70d8c36c42b3e2dfec8768", "committedDate": "2021-07-12T11:16:21Z", "message": "[FLINK-16641][network] (Part#6) Enable to set network buffers per channel to 0\n\nThis PR enables to set the number of network buffer per channel (taskmanager.network.memory.buffers-per-channel) to 0. Previously, the value can not be set to 0 because of dead lock, FLINK-16641 solves the problem and we can set it to 0 now."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da81fde5fc9e110075cff4982048b7f7ee3a0d61", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/da81fde5fc9e110075cff4982048b7f7ee3a0d61", "committedDate": "2021-07-10T10:18:42Z", "message": "Fixup"}, "afterCommit": {"oid": "4609625eac16247f2d70d8c36c42b3e2dfec8768", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/4609625eac16247f2d70d8c36c42b3e2dfec8768", "committedDate": "2021-07-12T11:16:21Z", "message": "[FLINK-16641][network] (Part#6) Enable to set network buffers per channel to 0\n\nThis PR enables to set the number of network buffer per channel (taskmanager.network.memory.buffers-per-channel) to 0. Previously, the value can not be set to 0 because of dead lock, FLINK-16641 solves the problem and we can set it to 0 now."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzA0MDc3MDU2", "url": "https://github.com/apache/flink/pull/11877#pullrequestreview-704077056", "createdAt": "2021-07-12T12:55:33Z", "commit": {"oid": "4609625eac16247f2d70d8c36c42b3e2dfec8768"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4819, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}