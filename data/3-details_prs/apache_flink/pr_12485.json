{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3ODIwMDM3", "number": 12485, "title": "[FLINK-18130][hive][fs-connector] File name conflict for different jobs in filesystem/hive sink", "bodyText": "What is the purpose of the change\nThe sink of different jobs (or the same SQL runs multiple times) will produce the same file name, the rename will fail, and different file systems will produce different results:\n\nHadoopFileSystem: ignore new data.\nLocalFileSystem: overwrite old data.\n\nBrief change log\nWe can add UUID to prefix, make sure there is no conflict between jobs.\nVerifying this change\n\nHiveTableSinkITCase.testBatchAppend\nHiveTableSinkITCase.testStreamingAppend\nFileSystemITCaseBase.testInsertAppend\nFileSystemITCaseBase.testInsertOverwrite\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no", "createdAt": "2020-06-04T13:03:13Z", "url": "https://github.com/apache/flink/pull/12485", "merged": true, "mergeCommit": {"oid": "603cd830073f95d1b48cf8fa6817100ac17e1eb3"}, "closed": true, "closedAt": "2020-06-09T05:48:42Z", "author": {"login": "JingsongLi"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoN4o4gH2gAyNDI3ODIwMDM3Ojc2NWZmZDVkNjE0Mzc2YzJmZGU5MzQ0MGM5YzkwNGE4MGUxZWFiOTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpeU_BgFqTQyNjgwMTQyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "765ffd5d614376c2fde93440c9c904a80e1eab94", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/765ffd5d614376c2fde93440c9c904a80e1eab94", "committedDate": "2020-06-05T07:53:41Z", "message": "[FLINK-18130][hive][fs-connector] File name conflict for different jobs in filesystem/hive sink"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa51d430e64af7aa9d18cc5f463218aa91bf0d96", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/fa51d430e64af7aa9d18cc5f463218aa91bf0d96", "committedDate": "2020-06-05T03:43:46Z", "message": "Fix cases"}, "afterCommit": {"oid": "765ffd5d614376c2fde93440c9c904a80e1eab94", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/765ffd5d614376c2fde93440c9c904a80e1eab94", "committedDate": "2020-06-05T07:53:41Z", "message": "[FLINK-18130][hive][fs-connector] File name conflict for different jobs in filesystem/hive sink"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1ODk5MjUw", "url": "https://github.com/apache/flink/pull/12485#pullrequestreview-425899250", "createdAt": "2020-06-08T03:42:02Z", "commit": {"oid": "765ffd5d614376c2fde93440c9c904a80e1eab94"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwMzo0MjowMlrOGgOZQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwMzo0MjowMlrOGgOZQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ0MzQ1Nw==", "bodyText": "Here seems inconsistent with this method's comment: rename does not delete the dest path if it exists on HDFS. Instead, it will keep the srcPath and dest Path unchanged.", "url": "https://github.com/apache/flink/pull/12485#discussion_r436443457", "createdAt": "2020-06-08T03:42:02Z", "author": {"login": "gaoyunhaii"}, "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/PartitionLoader.java", "diffHunk": "@@ -113,12 +113,7 @@ private void renameFiles(List<Path> srcDirs, Path destDir) throws Exception {\n \t\t\t\t\tfor (FileStatus srcFile : srcFiles) {\n \t\t\t\t\t\tPath srcPath = srcFile.getPath();\n \t\t\t\t\t\tPath destPath = new Path(destDir, srcPath.getName());\n-\t\t\t\t\t\tint count = 1;\n-\t\t\t\t\t\twhile (!fs.rename(srcPath, destPath)) {\n-\t\t\t\t\t\t\tString name = srcPath.getName() + \"_copy_\" + count;\n-\t\t\t\t\t\t\tdestPath = new Path(destDir, name);\n-\t\t\t\t\t\t\tcount++;\n-\t\t\t\t\t\t}\n+\t\t\t\t\t\tfs.rename(srcPath, destPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "765ffd5d614376c2fde93440c9c904a80e1eab94"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f5f67699dfce0b311bf197f3d26df4ac16fa6a0", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/8f5f67699dfce0b311bf197f3d26df4ac16fa6a0", "committedDate": "2020-06-08T03:52:21Z", "message": "Update comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2ODAxNDI2", "url": "https://github.com/apache/flink/pull/12485#pullrequestreview-426801426", "createdAt": "2020-06-09T05:37:04Z", "commit": {"oid": "8f5f67699dfce0b311bf197f3d26df4ac16fa6a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4312, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}