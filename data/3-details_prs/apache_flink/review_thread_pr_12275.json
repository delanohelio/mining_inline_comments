{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMTc3ODQz", "number": 12275, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNjowODoyM1rOD_RVnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODozMTo0M1rOD__QkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NjcwOTQxOnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/descriptors/DescriptorProperties.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNjowODoyM1rOGZ1qYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNjowODoyM1rOGZ1qYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0Njc4NQ==", "bodyText": "Because we only support primary key now. I think we can have a dedicate primary key properties, so that we don't need to handle the index. For example:\npublic static final String PRIMARY_KEY_NAME = \"primary-key.name\";\npublic static final String PRIMARY_KEY_COLUMNS = \"primary-key.columns\";\n\nschema.getPrimaryKey().ifPresent(pk -> {\n    putString(key + \".\" + PRIMARY_KEY_NAME, pk.getName());\n    putString(key + \".\" + PRIMARY_KEY_COLUMNS, String.join(\",\", pk.getColumns()));\n});\nThis is also helpful for users who write yaml:\ntables:\n  - name: TableNumber1\n    type: source-table\n    schema:\n      primary-key\n        name: constraint1\n        columns: f1, f2", "url": "https://github.com/apache/flink/pull/12275#discussion_r429746785", "createdAt": "2020-05-25T06:08:23Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/descriptors/DescriptorProperties.java", "diffHunk": "@@ -241,6 +244,19 @@ public void putTableSchema(String key, TableSchema schema) {\n \t\t\t\tArrays.asList(WATERMARK_ROWTIME, WATERMARK_STRATEGY_EXPR, WATERMARK_STRATEGY_DATA_TYPE),\n \t\t\t\twatermarkValues);\n \t\t}\n+\n+\t\tif (schema.getPrimaryKey().isPresent()) {\n+\t\t\tfinal UniqueConstraint uniqueConstraint = schema.getPrimaryKey().get();\n+\t\t\tfinal List<List<String>> uniqueConstraintValues = new ArrayList<>();\n+\t\t\tuniqueConstraintValues.add(Arrays.asList(\n+\t\t\t\t\tuniqueConstraint.getName(),\n+\t\t\t\t\tuniqueConstraint.getType().name(),\n+\t\t\t\t\tString.join(\",\", uniqueConstraint.getColumns())));\n+\t\t\tputIndexedFixedProperties(\n+\t\t\t\t\tkey + '.' + CONSTRAINT_UNIQUE,\n+\t\t\t\t\tArrays.asList(NAME, TYPE, CONSTRAINT_UNIQUE_COLUMNS),\n+\t\t\t\t\tuniqueConstraintValues);\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc6de4913b48c82a220eda620fb58667e7e93642"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NjcyNTAxOnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/descriptors/DescriptorProperties.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNjoxNzo1MVrOGZ1z9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwODoyNDozMVrOGaTwPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0OTIzNg==", "bodyText": "We can just to exclude the primary key, then don't need the regex matching.\n.filter((k) -> k.startsWith(key) && !k.startsWith(key + \".\" + PRIMARY_KEY) && k.endsWith('.' + NAME))", "url": "https://github.com/apache/flink/pull/12275#discussion_r429749236", "createdAt": "2020-05-25T06:17:51Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/descriptors/DescriptorProperties.java", "diffHunk": "@@ -610,7 +626,9 @@ public DataType getDataType(String key) {\n \tpublic Optional<TableSchema> getOptionalTableSchema(String key) {\n \t\t// filter for number of fields\n \t\tfinal int fieldCount = properties.keySet().stream()\n-\t\t\t.filter((k) -> k.startsWith(key) && k.endsWith('.' + TABLE_SCHEMA_NAME))\n+\t\t\t.filter((k) -> k.startsWith(key)\n+\t\t\t\t\t// \"key.\" is the prefix.\n+\t\t\t\t\t&& SCHEMA_COLUMN_NAME_SUFFIX.matcher(k.substring(key.length() + 1)).matches())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc6de4913b48c82a220eda620fb58667e7e93642"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIzOTgwNQ==", "bodyText": "I think the regex matching is a more general way to match column names for the long run, just remove some specific keys seems hacky from my side.", "url": "https://github.com/apache/flink/pull/12275#discussion_r430239805", "createdAt": "2020-05-26T08:24:31Z", "author": {"login": "danny0405"}, "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/descriptors/DescriptorProperties.java", "diffHunk": "@@ -610,7 +626,9 @@ public DataType getDataType(String key) {\n \tpublic Optional<TableSchema> getOptionalTableSchema(String key) {\n \t\t// filter for number of fields\n \t\tfinal int fieldCount = properties.keySet().stream()\n-\t\t\t.filter((k) -> k.startsWith(key) && k.endsWith('.' + TABLE_SCHEMA_NAME))\n+\t\t\t.filter((k) -> k.startsWith(key)\n+\t\t\t\t\t// \"key.\" is the prefix.\n+\t\t\t\t\t&& SCHEMA_COLUMN_NAME_SUFFIX.matcher(k.substring(key.length() + 1)).matches())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0OTIzNg=="}, "originalCommit": {"oid": "bc6de4913b48c82a220eda620fb58667e7e93642"}, "originalPosition": 99}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDIzMzEzOnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/descriptors/DescriptorProperties.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODozMTo0M1rOGa-6_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwOTo1NTowMVrOGbCCeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0NzA3MQ==", "bodyText": "Throw an exception if the the name is not present?", "url": "https://github.com/apache/flink/pull/12275#discussion_r430947071", "createdAt": "2020-05-27T08:31:43Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/descriptors/DescriptorProperties.java", "diffHunk": "@@ -669,6 +677,14 @@ public DataType getDataType(String key) {\n \t\t\t}\n \t\t}\n \n+\t\t// Extract unique constraints.\n+\t\tString pkConstraintNameKey = key + '.' + PRIMARY_KEY_NAME;\n+\t\tfinal Optional<String> pkConstraintNameOpt = optionalGet(pkConstraintNameKey);\n+\t\tif (pkConstraintNameOpt.isPresent()) {\n+\t\t\tfinal String pkColumnsKey = key + '.' + PRIMARY_KEY_COLUMNS;\n+\t\t\tfinal String columns = optionalGet(pkColumnsKey).orElseThrow(exceptionSupplier(pkColumnsKey));\n+\t\t\tschemaBuilder.primaryKey(pkConstraintNameOpt.get(), columns.split(\",\"));\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e027ff0822c8621eb8f061888cc15fd7465133ba"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk4OTk5OQ==", "bodyText": "I think it is not necessary, the schema.primary-key.columns should never appear as a single(e.g. comes from #putTableSchema).", "url": "https://github.com/apache/flink/pull/12275#discussion_r430989999", "createdAt": "2020-05-27T09:40:58Z", "author": {"login": "danny0405"}, "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/descriptors/DescriptorProperties.java", "diffHunk": "@@ -669,6 +677,14 @@ public DataType getDataType(String key) {\n \t\t\t}\n \t\t}\n \n+\t\t// Extract unique constraints.\n+\t\tString pkConstraintNameKey = key + '.' + PRIMARY_KEY_NAME;\n+\t\tfinal Optional<String> pkConstraintNameOpt = optionalGet(pkConstraintNameKey);\n+\t\tif (pkConstraintNameOpt.isPresent()) {\n+\t\t\tfinal String pkColumnsKey = key + '.' + PRIMARY_KEY_COLUMNS;\n+\t\t\tfinal String columns = optionalGet(pkColumnsKey).orElseThrow(exceptionSupplier(pkColumnsKey));\n+\t\t\tschemaBuilder.primaryKey(pkConstraintNameOpt.get(), columns.split(\",\"));\n+\t\t}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0NzA3MQ=="}, "originalCommit": {"oid": "e027ff0822c8621eb8f061888cc15fd7465133ba"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk5ODEzNg==", "bodyText": "Then I think we don't need to use optionalGet here, we can use getString directly.", "url": "https://github.com/apache/flink/pull/12275#discussion_r430998136", "createdAt": "2020-05-27T09:55:01Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/descriptors/DescriptorProperties.java", "diffHunk": "@@ -669,6 +677,14 @@ public DataType getDataType(String key) {\n \t\t\t}\n \t\t}\n \n+\t\t// Extract unique constraints.\n+\t\tString pkConstraintNameKey = key + '.' + PRIMARY_KEY_NAME;\n+\t\tfinal Optional<String> pkConstraintNameOpt = optionalGet(pkConstraintNameKey);\n+\t\tif (pkConstraintNameOpt.isPresent()) {\n+\t\t\tfinal String pkColumnsKey = key + '.' + PRIMARY_KEY_COLUMNS;\n+\t\t\tfinal String columns = optionalGet(pkColumnsKey).orElseThrow(exceptionSupplier(pkColumnsKey));\n+\t\t\tschemaBuilder.primaryKey(pkConstraintNameOpt.get(), columns.split(\",\"));\n+\t\t}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0NzA3MQ=="}, "originalCommit": {"oid": "e027ff0822c8621eb8f061888cc15fd7465133ba"}, "originalPosition": 112}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4536, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}