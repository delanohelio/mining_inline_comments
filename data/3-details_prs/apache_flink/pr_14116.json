{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzMDgxMTQy", "number": 14116, "title": "[FLINK-20213][fs-connector] Partition commit is delayed when records keep coming", "bodyText": "What is the purpose of the change\nWhen set partition-commit.delay=0, Users expect partitions to be committed immediately.\nHowever, if the record of this partition continues to flow in, the bucket for the partition will be activated, and no inactive bucket will appear.\nBrief change log\nConsider listening to bucket created.\nCollect partitions from bucket created listener. Emit partitions when notify checkpoint complete.\nVerifying this change\nStreamingFileWriterTest\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no", "createdAt": "2020-11-18T10:28:59Z", "url": "https://github.com/apache/flink/pull/14116", "merged": true, "mergeCommit": {"oid": "75b759d6a3a7e193521ab7f0c738b9faf908601c"}, "closed": true, "closedAt": "2020-11-25T12:36:48Z", "author": {"login": "JingsongLi"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddrjutgH2gAyNTIzMDgxMTQyOjRkNTllODdjMDljMmIyNzE4ZDA1OTgwNGYyNmM2YTVhNjAzNzQzMjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdf8UpygFqTUzODM4NTMxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4d59e87c09c2b2718d059804f26c6a5a60374326", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/4d59e87c09c2b2718d059804f26c6a5a60374326", "committedDate": "2020-11-18T10:25:59Z", "message": "[FLINK-20213][fs-connector] Partition commit is delayed when records keep coming"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MjU0NDc4", "url": "https://github.com/apache/flink/pull/14116#pullrequestreview-538254478", "createdAt": "2020-11-25T08:28:50Z", "commit": {"oid": "4d59e87c09c2b2718d059804f26c6a5a60374326"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwODoyODo1MVrOH5oBYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwODozNDo0M1rOH5oOrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE4NjU5NQ==", "bodyText": "Change to another name to avoid override variable names ?", "url": "https://github.com/apache/flink/pull/14116#discussion_r530186595", "createdAt": "2020-11-25T08:28:51Z", "author": {"login": "gaoyunhaii"}, "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/stream/StreamingFileWriter.java", "diffHunk": "@@ -134,13 +143,19 @@ public void notifyCheckpointComplete(long checkpointId) throws Exception {\n \n \tprivate void commitUpToCheckpoint(long checkpointId) throws Exception {\n \t\thelper.commitUpToCheckpoint(checkpointId);\n+\n+\t\tNavigableMap<Long, Set<String>> newPartitions = this.newPartitions.headMap(checkpointId, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d59e87c09c2b2718d059804f26c6a5a60374326"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE4OTk5OA==", "bodyText": "Will clear the headMap also cleans the part before the current checkpoint in this.newPartitions ?", "url": "https://github.com/apache/flink/pull/14116#discussion_r530189998", "createdAt": "2020-11-25T08:34:43Z", "author": {"login": "gaoyunhaii"}, "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/stream/StreamingFileWriter.java", "diffHunk": "@@ -134,13 +143,19 @@ public void notifyCheckpointComplete(long checkpointId) throws Exception {\n \n \tprivate void commitUpToCheckpoint(long checkpointId) throws Exception {\n \t\thelper.commitUpToCheckpoint(checkpointId);\n+\n+\t\tNavigableMap<Long, Set<String>> newPartitions = this.newPartitions.headMap(checkpointId, true);\n+\t\tSet<String> partitions = new HashSet<>(committablePartitions);\n+\t\tcommittablePartitions.clear();\n+\t\tnewPartitions.values().forEach(partitions::addAll);\n+\t\tnewPartitions.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d59e87c09c2b2718d059804f26c6a5a60374326"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "088811826ab3a6a5a403260556c4f476b4802e2d", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/088811826ab3a6a5a403260556c4f476b4802e2d", "committedDate": "2020-11-25T09:44:04Z", "message": "Address comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4Mzg1MzEy", "url": "https://github.com/apache/flink/pull/14116#pullrequestreview-538385312", "createdAt": "2020-11-25T11:05:45Z", "commit": {"oid": "088811826ab3a6a5a403260556c4f476b4802e2d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4358, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}