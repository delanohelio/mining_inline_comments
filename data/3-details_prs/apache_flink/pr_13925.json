{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MjMzMzI0", "number": 13925, "title": "[FLINK-19868][csv] Csv Serialization schema contains line delimiter", "bodyText": "What is the purpose of the change\nCsvRowSerializationSchema and CsvRowDataSerializationSchema serialize Row and RowData to byte array end with \\n at default. For the row-wise formats, it should consume and produce the bytes for a row.  csv.line-delimiter option is not a good option for csv format and shoud be removed for CsvRowSerializationSchema and CsvRowDataSerializationSchema to not append a new line.\nBrief change log\n\nCsvSchema in CsvRowSerializationSchema and CsvRowDataSerializationSchema configures the line separator to empty string.\nline-delimiter option in CsvFormatFactory, CsvRowFormatFactory and CsvFileSystemFormatFactory is removed.\n*CsvFileSystemFormatFactory encodes RowData record end with line delimiter \\n to write.\n\nVerifying this change\n\nRemove the line delimiter config of test cases in CsvRowDataSerDeSchemaTest and CsvRowDeSerializationSchemaTest to verify whether the byte array which CsvRowSerializationSchema and CsvRowDataSerializationSchema serialize Row and RowData to includes line delimiter \\n.\nRemove theline-delimiter option of test cases in CsvFormatFactoryTest and CsvRowFormatFactoryTest to verify whether the line-delimiter option could be removed normally.\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-11-04T08:54:46Z", "url": "https://github.com/apache/flink/pull/13925", "merged": true, "mergeCommit": {"oid": "2d12d325d77e4727cb74d8a58597eb0ce9ab5aa2"}, "closed": true, "closedAt": "2020-11-06T03:29:43Z", "author": {"login": "SteNicholas"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZOse6ABqjM5NTc4NzE4MTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZiP9ogFqTUyNDI1MDQ2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e91a4e54fe468110ab4ad89d86a759220a6b91a", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/8e91a4e54fe468110ab4ad89d86a759220a6b91a", "committedDate": "2020-11-04T08:34:43Z", "message": "[FLINK-19868][csv] Csv Serialization schema contains line delimiter"}, "afterCommit": {"oid": "7bf259abd7c06ad3dcc5039c0795d5939e3d55c8", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/7bf259abd7c06ad3dcc5039c0795d5939e3d55c8", "committedDate": "2020-11-04T14:32:03Z", "message": "[FLINK-19868][csv] Csv Serialization schema contains line delimiter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23f1d6db28364c2ab4f7c4c368d8034d74dfccc3", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/23f1d6db28364c2ab4f7c4c368d8034d74dfccc3", "committedDate": "2020-11-04T14:42:01Z", "message": "[FLINK-19868][csv] Csv Serialization schema contains line delimiter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7bf259abd7c06ad3dcc5039c0795d5939e3d55c8", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/7bf259abd7c06ad3dcc5039c0795d5939e3d55c8", "committedDate": "2020-11-04T14:32:03Z", "message": "[FLINK-19868][csv] Csv Serialization schema contains line delimiter"}, "afterCommit": {"oid": "23f1d6db28364c2ab4f7c4c368d8034d74dfccc3", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/23f1d6db28364c2ab4f7c4c368d8034d74dfccc3", "committedDate": "2020-11-04T14:42:01Z", "message": "[FLINK-19868][csv] Csv Serialization schema contains line delimiter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzOTUzMjIz", "url": "https://github.com/apache/flink/pull/13925#pullrequestreview-523953223", "createdAt": "2020-11-05T06:20:24Z", "commit": {"oid": "23f1d6db28364c2ab4f7c4c368d8034d74dfccc3"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNjoyMDoyNVrOHt078A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNjoyNzozMFrOHt1FEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgxNTI4MA==", "bodyText": "Move this notes to {{field-delimiter}} option.", "url": "https://github.com/apache/flink/pull/13925#discussion_r517815280", "createdAt": "2020-11-05T06:20:25Z", "author": {"login": "wuchong"}, "path": "docs/dev/table/connectors/formats/csv.md", "diffHunk": "@@ -95,18 +95,6 @@ Format Options\n       <td>String</td>\n       <td>Field delimiter character (<code>','</code> by default).</td>\n     </tr>\n-    <tr>\n-      <td><h5>csv.line-delimiter</h5></td>\n-      <td>optional</td>\n-      <td style=\"word-wrap: break-word;\"><code>\\n</code></td>\n-      <td>String</td>\n-      <td>Line delimiter, <code>\\n</code> by default. Note the <code>\\n</code> and <code>\\r</code> are invisible special characters, you have to use unicode to specify them in plain SQL.\n-          <ul>\n-           <li>e.g. <code>'csv.line-delimiter' = U&'\\000D'</code> specifies the to use carriage return <code>\\r</code> as line delimiter.</li>\n-           <li>e.g. <code>'csv.line-delimiter' = U&'\\000A'</code> specifies the to use line feed <code>\\n</code> as line delimiter.</li>\n-          </ul>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23f1d6db28364c2ab4f7c4c368d8034d74dfccc3"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgxNjI4Ng==", "bodyText": "Why we hard code \\n ? I think the purpose of this issue is removing the \"\\n\".", "url": "https://github.com/apache/flink/pull/13925#discussion_r517816286", "createdAt": "2020-11-05T06:23:30Z", "author": {"login": "wuchong"}, "path": "flink-formats/flink-csv/src/main/java/org/apache/flink/formats/csv/CsvFileSystemFormatFactory.java", "diffHunk": "@@ -194,7 +186,12 @@ private CsvSchema buildCsvSchema(RowType rowType, ReadableConfig options) {\n \n \t\tfinal CsvRowDataSerializationSchema serializationSchema = builder.build();\n \n-\t\treturn Optional.of((record, stream) -> stream.write(serializationSchema.serialize(record)));\n+\t\treturn Optional.of((record, stream) -> {\n+\t\t\tStringBuilder sb = new StringBuilder();\n+\t\t\tsb.append(new String(serializationSchema.serialize(record)));\n+\t\t\tsb.append(\"\\n\");\n+\t\t\tstream.write(sb.toString().getBytes());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23f1d6db28364c2ab4f7c4c368d8034d74dfccc3"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgxNzUxMA==", "bodyText": "I would recommend not changing the legacy csv format.", "url": "https://github.com/apache/flink/pull/13925#discussion_r517817510", "createdAt": "2020-11-05T06:27:10Z", "author": {"login": "wuchong"}, "path": "flink-formats/flink-csv/src/main/java/org/apache/flink/formats/csv/CsvRowFormatFactory.java", "diffHunk": "@@ -101,9 +100,6 @@ public CsvRowFormatFactory() {\n \t\tdescriptorProperties.getOptionalCharacter(CsvValidator.FORMAT_FIELD_DELIMITER)\n \t\t\t.ifPresent(schemaBuilder::setFieldDelimiter);\n \n-\t\tdescriptorProperties.getOptionalString(CsvValidator.FORMAT_LINE_DELIMITER)\n-\t\t\t.ifPresent(schemaBuilder::setLineDelimiter);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23f1d6db28364c2ab4f7c4c368d8034d74dfccc3"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgxNzYxOQ==", "bodyText": "ditto. I would recommend not changing the legacy csv format.", "url": "https://github.com/apache/flink/pull/13925#discussion_r517817619", "createdAt": "2020-11-05T06:27:30Z", "author": {"login": "wuchong"}, "path": "flink-formats/flink-csv/src/main/java/org/apache/flink/formats/csv/CsvRowSerializationSchema.java", "diffHunk": "@@ -86,8 +86,8 @@ private CsvRowSerializationSchema(\n \t\tthis.typeInfo = typeInfo;\n \t\tthis.runtimeConverter = createRowRuntimeConverter(typeInfo, true);\n \t\tthis.csvMapper = new CsvMapper();\n-\t\tthis.csvSchema = csvSchema;\n-\t\tthis.objectWriter = csvMapper.writer(csvSchema);\n+\t\tthis.csvSchema = csvSchema.withLineSeparator(\"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23f1d6db28364c2ab4f7c4c368d8034d74dfccc3"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a00a1dec1f9e13b04a25b7368faf4df98f138448", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/a00a1dec1f9e13b04a25b7368faf4df98f138448", "committedDate": "2020-11-05T10:04:26Z", "message": "[FLINK-19868][csv] Csv Serialization schema contains line delimiter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MjUwNDY3", "url": "https://github.com/apache/flink/pull/13925#pullrequestreview-524250467", "createdAt": "2020-11-05T13:19:33Z", "commit": {"oid": "a00a1dec1f9e13b04a25b7368faf4df98f138448"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4786, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}