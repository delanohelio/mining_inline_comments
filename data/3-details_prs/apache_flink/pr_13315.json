{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4NTE1Nzg0", "number": 13315, "title": "[FLINK-19070][hive] Hive connector should throw a meaningful exception if user reads/writes ACID tables", "bodyText": "What is the purpose of the change\nHive ACID table configures tblproperties with 'transactional=true'. Currently Hive connector couldn't support to read and write on ACID tables. Therefore, Hive connector should throw a meaningful exception to users for reading or writing ACID tables.\nBrief change log\n\nHiveTableSource#getDataStream adds checkAcidTable to check whether the tblproperties transactional of the Hive source table is true. If the tblproperties transactional is true, this should throw FlinkHiveException to prompt user meaningful exception.\nHiveTableSink#consumeDataStream adds checkAcidTable to check whether the tblproperties transactional of the Hive sink table is true. If the tblproperties transactional is true, this should throw FlinkHiveException to prompt user meaningful exception.\nAdd HiveUtils#checkAcidTable which utils for Hive connector to check whether to read or write on the hive ACID table.\n\nVerifying this change\n\nAdd TableEnvHiveConnectorITCase#testStreamTransactionalTable and TableEnvHiveConnectorITCase#testBatchTransactionalTableto verify the test case that create hive table with the tblproperties transactional=true for the meaningful exception message.\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-09-03T10:05:19Z", "url": "https://github.com/apache/flink/pull/13315", "merged": true, "mergeCommit": {"oid": "fa651801ac3ba711beb57594ac58e4c36090af40"}, "closed": true, "closedAt": "2020-09-10T04:08:55Z", "author": {"login": "SteNicholas"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFNR1RAH2gAyNDc4NTE1Nzg0OjJlMGRhODQ1Y2FmMDAwMDYzNTViODk4YmRjZmYyOWUzYjdhYzU2YjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHIXzsgBqjM3NDQ3NTUwMDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2e0da845caf00006355b898bdcff29e3b7ac56b3", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/2e0da845caf00006355b898bdcff29e3b7ac56b3", "committedDate": "2020-09-03T09:35:06Z", "message": "[FLINK-19070][hive] Hive connector should throw a meaningful exception if user reads/writes ACID tables"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "451016cf861606ffe150929a9ad096d7aa665259", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/451016cf861606ffe150929a9ad096d7aa665259", "committedDate": "2020-09-04T13:08:51Z", "message": "Merge branch 'master' into hive-acid-exception"}, "afterCommit": {"oid": "b9e54a84b88a37bf16c73597f8bbbea8ab169f99", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/b9e54a84b88a37bf16c73597f8bbbea8ab169f99", "committedDate": "2020-09-04T13:10:44Z", "message": "[FLINK-19070][hive] Hive connector should throw a meaningful exception if user reads/writes ACID tables"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNjM2Mzc5", "url": "https://github.com/apache/flink/pull/13315#pullrequestreview-482636379", "createdAt": "2020-09-04T13:07:52Z", "commit": {"oid": "2ed647fc736a248d536d6f5422e0a50a7119045f"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxMzowNzo1MlrOHNM2TA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxMzoxNDo0OVrOHNNEew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzYwNDA0NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\tthrow new TableException(String.format(\"Cannot write on the ACID table %s.\", identifier.asSummaryString()));\n          \n          \n            \n            \t\t\t\tthrow new FlinkHiveException(String.format(\"Writing ACID table %s is not supported\", identifier.asSummaryString()));", "url": "https://github.com/apache/flink/pull/13315#discussion_r483604044", "createdAt": "2020-09-04T13:07:52Z", "author": {"login": "lirui-apache"}, "path": "flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/connectors/hive/HiveTableSink.java", "diffHunk": "@@ -328,4 +330,16 @@ public void setStaticPartition(Map<String, String> partitionSpec) {\n \tpublic void setOverwrite(boolean overwrite) {\n \t\tthis.overwrite = overwrite;\n \t}\n+\n+\tprivate void checkAcidTable() {\n+\t\tif (catalogTable != null && catalogTable.getOptions() != null) {\n+\t\t\tString tableIsTransactional = catalogTable.getOptions().get(\"transactional\");\n+\t\t\tif (tableIsTransactional == null) {\n+\t\t\t\ttableIsTransactional = catalogTable.getOptions().get(\"transactional\".toUpperCase());\n+\t\t\t}\n+\t\t\tif (tableIsTransactional != null && tableIsTransactional.equalsIgnoreCase(\"true\")) {\n+\t\t\t\tthrow new TableException(String.format(\"Cannot write on the ACID table %s.\", identifier.asSummaryString()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ed647fc736a248d536d6f5422e0a50a7119045f"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzYwNDU2Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\tthrow new TableException(String.format(\"Cannot read on the ACID table %s.\", tablePath));\n          \n          \n            \n            \t\t\t\tthrow new FlinkHiveException(String.format(\"Reading ACID table %s is not supported\", tablePath));", "url": "https://github.com/apache/flink/pull/13315#discussion_r483604562", "createdAt": "2020-09-04T13:08:56Z", "author": {"login": "lirui-apache"}, "path": "flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/connectors/hive/HiveTableSource.java", "diffHunk": "@@ -556,4 +558,16 @@ public String explainSource() {\n \tpublic boolean isAsyncEnabled() {\n \t\treturn false;\n \t}\n+\n+\tprivate void checkAcidTable() {\n+\t\tif (catalogTable != null && catalogTable.getOptions() != null) {\n+\t\t\tString tableIsTransactional = catalogTable.getOptions().get(\"transactional\");\n+\t\t\tif (tableIsTransactional == null) {\n+\t\t\t\ttableIsTransactional = catalogTable.getOptions().get(\"transactional\".toUpperCase());\n+\t\t\t}\n+\t\t\tif (tableIsTransactional != null && tableIsTransactional.equalsIgnoreCase(\"true\")) {\n+\t\t\t\tthrow new TableException(String.format(\"Cannot read on the ACID table %s.\", tablePath));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ed647fc736a248d536d6f5422e0a50a7119045f"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzYwNTAxOQ==", "bodyText": "Let's extract these into a util method", "url": "https://github.com/apache/flink/pull/13315#discussion_r483605019", "createdAt": "2020-09-04T13:09:46Z", "author": {"login": "lirui-apache"}, "path": "flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/connectors/hive/HiveTableSink.java", "diffHunk": "@@ -330,6 +332,18 @@ public void setOverwrite(boolean overwrite) {\n \t\tthis.overwrite = overwrite;\n \t}\n \n+\tprivate void checkAcidTable() {\n+\t\tif (catalogTable != null && catalogTable.getOptions() != null) {\n+\t\t\tString tableIsTransactional = catalogTable.getOptions().get(\"transactional\");\n+\t\t\tif (tableIsTransactional == null) {\n+\t\t\t\ttableIsTransactional = catalogTable.getOptions().get(\"transactional\".toUpperCase());\n+\t\t\t}\n+\t\t\tif (tableIsTransactional != null && tableIsTransactional.equalsIgnoreCase(\"true\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "451016cf861606ffe150929a9ad096d7aa665259"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzYwNzY3NQ==", "bodyText": "No need to insert data", "url": "https://github.com/apache/flink/pull/13315#discussion_r483607675", "createdAt": "2020-09-04T13:14:49Z", "author": {"login": "lirui-apache"}, "path": "flink-connectors/flink-connector-hive/src/test/java/org/apache/flink/connectors/hive/TableEnvHiveConnectorITCase.java", "diffHunk": "@@ -574,6 +575,43 @@ public void testStreamCompressTextTable() throws Exception {\n \t\ttestCompressTextTable(false);\n \t}\n \n+\tprivate void testTransactionalTable(boolean batch) {\n+\t\tTableEnvironment tableEnv = batch ?\n+\t\t\tgetTableEnvWithHiveCatalog() :\n+\t\t\tgetStreamTableEnvWithHiveCatalog();\n+\t\ttableEnv.executeSql(\"create database db1\");\n+\t\ttry {\n+\t\t\ttableEnv.executeSql(\"create table db1.src (x string,y string)\");\n+\t\t\thiveShell.execute(\"create table db1.dest (x string,y string) clustered by (x) into 3 buckets stored as orc tblproperties ('transactional'='true')\");\n+\t\t\tHiveTestUtils.createTextTableInserter(hiveShell, \"db1\", \"src\")\n+\t\t\t\t.addRow(new Object[]{\"a\", \"b\"})\n+\t\t\t\t.addRow(new Object[]{\"c\", \"d\"})\n+\t\t\t\t.commit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9e54a84b88a37bf16c73597f8bbbea8ab169f99"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b9e54a84b88a37bf16c73597f8bbbea8ab169f99", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/b9e54a84b88a37bf16c73597f8bbbea8ab169f99", "committedDate": "2020-09-04T13:10:44Z", "message": "[FLINK-19070][hive] Hive connector should throw a meaningful exception if user reads/writes ACID tables"}, "afterCommit": {"oid": "6f796f529a1dc3aed87785eaeb251725c4dd17c2", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/6f796f529a1dc3aed87785eaeb251725c4dd17c2", "committedDate": "2020-09-04T13:15:44Z", "message": "[FLINK-19070][hive] Hive connector should throw a meaningful exception if user reads/writes ACID tables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c4a9a348dcec07dc2b990fe770132c1b5ed61a7", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/2c4a9a348dcec07dc2b990fe770132c1b5ed61a7", "committedDate": "2020-09-05T06:27:53Z", "message": "[FLINK-19070][hive] Hive connector should throw a meaningful exception if user reads/writes ACID tables"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c724d8f21242ae5573136e88e0c983dc776d4cf3", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/c724d8f21242ae5573136e88e0c983dc776d4cf3", "committedDate": "2020-09-05T05:53:43Z", "message": "[FLINK-19070][hive] Hive connector should throw a meaningful exception if user reads/writes ACID tables"}, "afterCommit": {"oid": "2c4a9a348dcec07dc2b990fe770132c1b5ed61a7", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/2c4a9a348dcec07dc2b990fe770132c1b5ed61a7", "committedDate": "2020-09-05T06:27:53Z", "message": "[FLINK-19070][hive] Hive connector should throw a meaningful exception if user reads/writes ACID tables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3afac861f83784588ae5deeddbc549c4e54d09c", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/e3afac861f83784588ae5deeddbc549c4e54d09c", "committedDate": "2020-09-05T06:31:58Z", "message": "Merge branch 'master' of github.com:SteNicholas/flink into hive-acid-exception\n\n* 'master' of github.com:SteNicholas/flink: (30 commits)\n  [FLINK-19036][docs-zh] Translate page 'Application Profiling & Debugging' of 'Debugging & Monitoring' into Chinese\n  [FLINK-18984][python][docs] Add tutorial documentation for Python DataStream API (#13203)\n  [FLINK-15974][python] Support to use the Python UDF directly in the Python Table API (#13325)\n  [FLINK-19121][hive] Avoid accessing HDFS frequently in HiveBulkWriterFactory\n  [FLINK-18959][Runtime] Try to revert MiniDispatcher for archiveExecutionGraph and shutdown cluster upon cancel.\n  [FLINK-18536][kinesis] Adding enhanced fan-out related configurations.\n  [FLINK-19108][table] Stop expanding the identifiers with scope aliased by the system with 'EXPR$' prefix\n  [FLINK-19118][python] Support Expression in the operations of Python Table API (#13304)\n  [FLINK-14087][datastream] Clone the StreamPartitioner to avoid being shared at runtime.\n  [FLINK-18513][Kinesis] Omitting AWS SDK services from shaded jar\n  [hotfix] Exclude test AWS credentials profile from license checks\n  [FLINK-18513][Kinesis] Inverting dependency control of KinesisProxyV2\n  [FLINK-18513][Kinesis] Adding explicit CBOR dependency to fix runtime issue\n  [FLINK-18513][Kinesis] Updated NOTICE file to reflect bundled dependencies\n  [FLINK-18513][Kinesis] Add AWS SDK v2.x dependency and KinesisProxyV2\n  [hotfix][task] Add SuppressWarnings to StreamMultipleInputProcessor\n  [FLINK-18905][hotfix][task] Simplify exception handling in StreamTask#dispatchOperatorEvent\n  [FLINK-18905][task] Allow SourceOperator chaining with MultipleInputStreamTask\n  [FLINK-18905][task/datastream] Convert OneInputStreamOperator to Input\n  [FLINK-18905][hotfix] Extract common OutputTag#isResponsibleFor with explicit Nonnull check\n  ..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d8f174b90ce3efd668bb7d53709d55eab2cbfa0", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/6d8f174b90ce3efd668bb7d53709d55eab2cbfa0", "committedDate": "2020-09-08T10:59:54Z", "message": "[FLINK-19070][hive] Hive connector should throw a meaningful exception if user reads/writes ACID tables"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MTMzMDEy", "url": "https://github.com/apache/flink/pull/13315#pullrequestreview-484133012", "createdAt": "2020-09-08T13:22:03Z", "commit": {"oid": "6d8f174b90ce3efd668bb7d53709d55eab2cbfa0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NzYzMTIy", "url": "https://github.com/apache/flink/pull/13315#pullrequestreview-484763122", "createdAt": "2020-09-09T08:11:34Z", "commit": {"oid": "6d8f174b90ce3efd668bb7d53709d55eab2cbfa0"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwODoxMTozNVrOHO7w_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwODoxMTozNVrOHO7w_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQyMTMxMQ==", "bodyText": "catalogTable and tablePath never null, you can take a look to the constructor of HiveTableSource", "url": "https://github.com/apache/flink/pull/13315#discussion_r485421311", "createdAt": "2020-09-09T08:11:35Z", "author": {"login": "JingsongLi"}, "path": "flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/table/catalog/hive/util/HiveTableUtil.java", "diffHunk": "@@ -403,6 +404,25 @@ public static Table instantiateHiveTable(ObjectPath tablePath, CatalogBaseTable\n \t\t\t\t.collect(Collectors.toMap(t -> t.f0, t -> t.f1));\n \t}\n \n+\t/**\n+\t * Check whether to read or write on the hive ACID table.\n+\t *\n+\t * @param catalogTable Hive catalog table.\n+\t * @param tablePath    Identifier table path.\n+\t * @throws FlinkHiveException Thrown, if the source or sink table is transactional.\n+\t */\n+\tpublic static void checkAcidTable(CatalogTable catalogTable, ObjectPath tablePath) {\n+\t\tif (catalogTable != null && catalogTable.getOptions() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d8f174b90ce3efd668bb7d53709d55eab2cbfa0"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ba3f117db423f0670562a740ed990937cb03d7f", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/5ba3f117db423f0670562a740ed990937cb03d7f", "committedDate": "2020-09-09T08:59:20Z", "message": "[FLINK-19070][hive] Hive connector should throw a meaningful exception if user reads/writes ACID tables"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "28000c0814e5deffae6db49d35d72e9f927d580f", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/28000c0814e5deffae6db49d35d72e9f927d580f", "committedDate": "2020-09-09T08:38:46Z", "message": "[FLINK-19070][hive] Hive connector should throw a meaningful exception if user reads/writes ACID tables"}, "afterCommit": {"oid": "5ba3f117db423f0670562a740ed990937cb03d7f", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/5ba3f117db423f0670562a740ed990937cb03d7f", "committedDate": "2020-09-09T08:59:20Z", "message": "[FLINK-19070][hive] Hive connector should throw a meaningful exception if user reads/writes ACID tables"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4410, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}