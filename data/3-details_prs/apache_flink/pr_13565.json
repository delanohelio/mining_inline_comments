{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwMDg2ODc2", "number": 13565, "title": "[FLINK-17073][checkpointing] Backpressure checkpointing on slow cleanup", "bodyText": "What is the purpose of the change\nThis PR includes changes from #13040 and some refactorings of new and existing code.\nVerifying this change\nChanges for backpressure tested by new ZooKeeperCompletedCheckpointStoreITCase.testChekpointingPausesAndResumeWhenTooManyCheckpoints test\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: yes\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? not applicable", "createdAt": "2020-10-08T17:47:09Z", "url": "https://github.com/apache/flink/pull/13565", "merged": true, "mergeCommit": {"oid": "318c7b66593efd1cb3cd7aff39cc9447f9460775"}, "closed": true, "closedAt": "2020-10-14T14:27:12Z", "author": {"login": "rkhachatryan"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQh4TFgH2gAyNTAwMDg2ODc2OjBlY2M0MDIwMTVmNTNkOGUxMzc5N2Y1MTVlN2IyMzBlMTVlYzZiYmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABds4aSbAFqTU2MTEzNzMwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0ecc402015f53d8e13797f515e7b230e15ec6bbf", "author": {"user": {"login": "echauchot", "name": "Etienne Chauchot"}}, "url": "https://github.com/apache/flink/commit/0ecc402015f53d8e13797f515e7b230e15ec6bbf", "committedDate": "2020-10-08T13:48:23Z", "message": "[FLINK-17073] [checkpointing] Introduce CheckpointsCleaner responsible for asynchronous checkpoints cleaning via the ioExecutor. This class counts the number of checkpoints to clean and reports it to CheckpointRequestDecider. Add a test for too many checkpoints to clean."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2455dcb7c3e5a2c9bbf894896d82a1d7db352cc7", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/2455dcb7c3e5a2c9bbf894896d82a1d7db352cc7", "committedDate": "2020-10-08T14:07:20Z", "message": "[FLINK-17073][checkpointing][refactor] Remove callbacks from Checkpoint classes\n\nPass CheckpointsCleaner and postCleanup as arguments\ninstead of storing them in Checkpoints classes as callbacks."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d75e4997366ca955978cd582ca3e67a897d90df", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/5d75e4997366ca955978cd582ca3e67a897d90df", "committedDate": "2020-10-08T14:11:07Z", "message": "[hotfix][checkpointing][refactor] Remove PendingCheckpoint.executor\n\nPass Executor as an argument instead of storing it as a field."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24423325af15daec9939199fbed5063b621f0cd9", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/24423325af15daec9939199fbed5063b621f0cd9", "committedDate": "2020-10-08T14:11:07Z", "message": "[FLINK-17073][checkpointing][refactor] Remove callback in ZK checkpoint store"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NjkxMDIw", "url": "https://github.com/apache/flink/pull/13565#pullrequestreview-506691020", "createdAt": "2020-10-12T14:53:00Z", "commit": {"oid": "5feafbbf87c7cefaf7ebe3a36c1e3f346386d629"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDo1MzowMVrOHgCFWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDo1MzowMVrOHgCFWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM1MDYxNg==", "bodyText": "Why do we need this check now? As far as I can tell, previously it was not needed?", "url": "https://github.com/apache/flink/pull/13565#discussion_r503350616", "createdAt": "2020-10-12T14:53:01Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/PendingCheckpoint.java", "diffHunk": "@@ -531,6 +527,30 @@ private void dispose(boolean releaseState, CheckpointsCleaner checkpointsCleaner\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic void discard() {\n+\t\tsynchronized (lock) {\n+\t\t\tif (stateDiscarded) {\n+\t\t\t\tPreconditions.checkState(discarded, \"Checkpoint should be disposed before being discarded\");\n+\t\t\t\treturn;\n+\t\t\t} else {\n+\t\t\t\tstateDiscarded = true;\n+\t\t\t}\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5feafbbf87c7cefaf7ebe3a36c1e3f346386d629"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MTc1ODg5", "url": "https://github.com/apache/flink/pull/13565#pullrequestreview-508175889", "createdAt": "2020-10-14T09:46:03Z", "commit": {"oid": "2d4a962962cb0cbac8d0a3fbf8e242261184b7c8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82386f6b770e774839f3c3d4d28de2019e072775", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/82386f6b770e774839f3c3d4d28de2019e072775", "committedDate": "2020-10-14T10:13:56Z", "message": "[FLINK-17073][checkpointing][refactor] Remove callback from CheckpointsCleaner\n\nReplace cleanup Runnable with a direct call to CheckpointsCleaner."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d4a962962cb0cbac8d0a3fbf8e242261184b7c8", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/2d4a962962cb0cbac8d0a3fbf8e242261184b7c8", "committedDate": "2020-10-13T11:11:14Z", "message": "fixup! [FLINK-17073][checkpointing][refactor] Remove callback from CheckpointsCleaner"}, "afterCommit": {"oid": "82386f6b770e774839f3c3d4d28de2019e072775", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/82386f6b770e774839f3c3d4d28de2019e072775", "committedDate": "2020-10-14T10:13:56Z", "message": "[FLINK-17073][checkpointing][refactor] Remove callback from CheckpointsCleaner\n\nReplace cleanup Runnable with a direct call to CheckpointsCleaner."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMTM3MzAx", "url": "https://github.com/apache/flink/pull/13565#pullrequestreview-561137301", "createdAt": "2021-01-04T15:53:18Z", "commit": {"oid": "82386f6b770e774839f3c3d4d28de2019e072775"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNTo1MzoxOFrOIN203g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNTo1MzoxOFrOIN203g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQwMDY3MA==", "bodyText": "Why do we need the postCleanup? In the current code base I couldn't find a single usage where we don't pass () -> {} @rkhachatryan and @pnowojski? If this is not needed, can we get rid of it? I think it does not make a very nice API with the no-ops.\nMoreover, it would be nice if we could update the JavaDocs if we change the signature of interfaces.", "url": "https://github.com/apache/flink/pull/13565#discussion_r551400670", "createdAt": "2021-01-04T15:53:18Z", "author": {"login": "tillrohrmann"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CompletedCheckpointStore.java", "diffHunk": "@@ -84,7 +85,7 @@ default CompletedCheckpoint getLatestCheckpoint(boolean isPreferCheckpointForRec\n \t *\n \t * @param jobStatus Job state on shut down\n \t */\n-\tvoid shutdown(JobStatus jobStatus) throws Exception;\n+\tvoid shutdown(JobStatus jobStatus, CheckpointsCleaner checkpointsCleaner, Runnable postCleanup) throws Exception;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82386f6b770e774839f3c3d4d28de2019e072775"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3853, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}