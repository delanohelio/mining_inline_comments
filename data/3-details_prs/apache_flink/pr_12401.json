{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0OTUxNjk4", "number": 12401, "title": "[FLINK-16057] Optimize ContinuousFileReaderOperator", "bodyText": "What is the purpose of the change\nMigrating ContinuousFileReaderOperator to mailbox execution model caused performance regression.\nThis PR eliminates it by avoiding going through the mailbox unnecessarily.\nLocal results before and after optimization (with benchmark fix applied):\nContinuousFileReaderOperatorBenchmark.readFileSplit  thrpt   30  10444.184 \u00b1 228.434  ops/ms\nContinuousFileReaderOperatorBenchmark.readFileSplit  thrpt   30  31451.848 \u00b1 849.005  ops/ms\n\nWithout the fix, results are better because it then does all the job in CLOSING phase in a loop.\nSo it's preferable to merge benchmark fix first.\nBrief change log\n\nloop in ContinuousFileReaderOperator if mailbox executor is idle\noptimize MailboxExecutor.isIdle\n\nVerifying this change\n\ncorrectness is covered by existing tests such as ContinuousFileProcessingTest\nperformance if measured by http://codespeed.dak8s.net:8000/\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): yes\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? not applicable", "createdAt": "2020-05-29T08:04:24Z", "url": "https://github.com/apache/flink/pull/12401", "merged": true, "mergeCommit": {"oid": "31d661dfaf3798e1a80bff437e358e3bfc40bbce"}, "closed": true, "closedAt": "2020-06-02T17:41:22Z", "author": {"login": "rkhachatryan"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcl983LABqjMzODYxMTk3ODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnYffngFqTQyMjkxMDA2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1205b16ae32a45c11759d0f27898363ab988ecfb", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/1205b16ae32a45c11759d0f27898363ab988ecfb", "committedDate": "2020-05-29T07:52:20Z", "message": "[FLINK-16057][task] Optimize TaskMailbox state retrieval\n\nDon't lock in TaskMailboxImpl.getState for task thread.\nThis makes ContinuousFileReaderOperator about 29% faster."}, "afterCommit": {"oid": "5ae178ffebe69903ebe8d09bdd8709c299c86dc0", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/5ae178ffebe69903ebe8d09bdd8709c299c86dc0", "committedDate": "2020-05-29T08:11:46Z", "message": "[FLINK-16057][task] Optimize TaskMailbox state retrieval\n\nDon't lock in TaskMailboxImpl.getState for task thread.\nThis makes ContinuousFileReaderOperator about 29% faster."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNzk5ODAx", "url": "https://github.com/apache/flink/pull/12401#pullrequestreview-420799801", "createdAt": "2020-05-29T09:36:00Z", "commit": {"oid": "fa16f36730c8a0794cfc9aa55bb99dbaa8ef4239"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOTozNjowMFrOGcVxlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOTo0NjoxOVrOGcWHFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3MDA3MQ==", "bodyText": "@Nullable - but check other comments first (for a better solution)", "url": "https://github.com/apache/flink/pull/12401#discussion_r432370071", "createdAt": "2020-05-29T09:36:00Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/MailboxExecutorImpl.java", "diffHunk": "@@ -43,10 +43,22 @@\n \n \tprivate final StreamTaskActionExecutor actionExecutor;\n \n+\tprivate MailboxProcessor mailboxProcessor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa16f36730c8a0794cfc9aa55bb99dbaa8ef4239"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3MDQ0MQ==", "bodyText": "mailboxProcessor != null && mailboxProcessor.isDefaultActionUnavailable()?  - but check other comments first (for a better solution)", "url": "https://github.com/apache/flink/pull/12401#discussion_r432370441", "createdAt": "2020-05-29T09:36:42Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/MailboxExecutorImpl.java", "diffHunk": "@@ -43,10 +43,22 @@\n \n \tprivate final StreamTaskActionExecutor actionExecutor;\n \n+\tprivate MailboxProcessor mailboxProcessor;\n+\n \tpublic MailboxExecutorImpl(@Nonnull TaskMailbox mailbox, int priority, StreamTaskActionExecutor actionExecutor) {\n+\t\tthis(mailbox, priority, actionExecutor, null);\n+\t}\n+\n+\tpublic MailboxExecutorImpl(@Nonnull TaskMailbox mailbox, int priority, StreamTaskActionExecutor actionExecutor, MailboxProcessor mailboxProcessor) {\n \t\tthis.mailbox = mailbox;\n \t\tthis.priority = priority;\n \t\tthis.actionExecutor = Preconditions.checkNotNull(actionExecutor);\n+\t\tthis.mailboxProcessor = mailboxProcessor;\n+\t}\n+\n+\tpublic boolean isIdle() {\n+\t\treturn !mailboxProcessor.isMailboxLoopRunning() ||\n+\t\t\t(mailboxProcessor.isDefaultActionUnavailable() && !mailbox.hasMail() && mailbox.getState().isAcceptingMails());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa16f36730c8a0794cfc9aa55bb99dbaa8ef4239"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3Mzg3OQ==", "bodyText": "Couple of problems:\n\nit changes an object passed from the outside\nrequires cast (could be solved by changing the signature of the constructor)\n\nI'm thinking that maybe a better solution is to get rid of the mainMailboxExecutor and replace getter getMainMailboxExecutor with:\n\tpublic MailboxExecutor getMainMailboxExecutor() {\n\t\treturn new MailboxExecutorImpl(mailbox, MIN_PRIORITY, actionExecutor, this);\n\t}\n\nplus caching access to mailboxProcessor.getMainMailboxExecutor() inside StreamTask via creating a field in  StreamTask: private final MailboxExecutor mainMailboxExecutor?\nThis would solve the problem of circular dependency and nullable non final field inside MailboxExecutorImpl.\nWDYT?", "url": "https://github.com/apache/flink/pull/12401#discussion_r432373879", "createdAt": "2020-05-29T09:43:09Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/MailboxProcessor.java", "diffHunk": "@@ -114,6 +114,7 @@ public MailboxProcessor(\n \t\tthis.actionExecutor = Preconditions.checkNotNull(actionExecutor);\n \t\tthis.mailbox = Preconditions.checkNotNull(mailbox);\n \t\tthis.mainMailboxExecutor = Preconditions.checkNotNull(mainMailboxExecutor);\n+\t\t((MailboxExecutorImpl) this.mainMailboxExecutor).setMailboxProcessor(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa16f36730c8a0794cfc9aa55bb99dbaa8ef4239"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NTA3OA==", "bodyText": "nit: I would be slightly in favour of adding this method to the MailboxExecutor interface, but if you think opposite let it be for now.", "url": "https://github.com/apache/flink/pull/12401#discussion_r432375078", "createdAt": "2020-05-29T09:45:21Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/source/ContinuousFileReaderOperator.java", "diffHunk": "@@ -311,17 +312,19 @@ private void enqueueProcessRecord() {\n \t}\n \n \tprivate void processRecord() throws IOException {\n-\t\tif (!state.prepareToProcessRecord(this)) {\n-\t\t\treturn;\n-\t\t}\n+\t\tdo {\n+\t\t\tif (!state.prepareToProcessRecord(this)) {\n+\t\t\t\treturn;\n+\t\t\t}\n \n-\t\treadAndCollectRecord();\n+\t\t\treadAndCollectRecord();\n \n-\t\tif (format.reachedEnd()) {\n-\t\t\tonSplitProcessed();\n-\t\t} else {\n-\t\t\tenqueueProcessRecord();\n-\t\t}\n+\t\t\tif (format.reachedEnd()) {\n+\t\t\t\tonSplitProcessed();\n+\t\t\t\treturn;\n+\t\t\t}\n+\t\t} while (executor.isIdle()); // todo: consider moving this loop into MailboxProcessor (return boolean \"re-execute\" from enqueued action)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa16f36730c8a0794cfc9aa55bb99dbaa8ef4239"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NTU3NQ==", "bodyText": "revert this change?", "url": "https://github.com/apache/flink/pull/12401#discussion_r432375575", "createdAt": "2020-05-29T09:46:19Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/MailboxExecutorImpl.java", "diffHunk": "@@ -50,7 +50,7 @@ public MailboxExecutorImpl(@Nonnull TaskMailbox mailbox, int priority, StreamTas\n \t}\n \n \tpublic MailboxExecutorImpl(@Nonnull TaskMailbox mailbox, int priority, StreamTaskActionExecutor actionExecutor, MailboxProcessor mailboxProcessor) {\n-\t\tthis.mailbox = mailbox;\n+\t\tthis.mailbox = (TaskMailboxImpl) mailbox;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ae178ffebe69903ebe8d09bdd8709c299c86dc0"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ae178ffebe69903ebe8d09bdd8709c299c86dc0", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/5ae178ffebe69903ebe8d09bdd8709c299c86dc0", "committedDate": "2020-05-29T08:11:46Z", "message": "[FLINK-16057][task] Optimize TaskMailbox state retrieval\n\nDon't lock in TaskMailboxImpl.getState for task thread.\nThis makes ContinuousFileReaderOperator about 29% faster."}, "afterCommit": {"oid": "3bde38fba011e5c786da8f072543b673a5b25eb0", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/3bde38fba011e5c786da8f072543b673a5b25eb0", "committedDate": "2020-05-29T16:23:29Z", "message": "[FLINK-16057][task] Optimize TaskMailbox state retrieval\n\nDon't lock in TaskMailboxImpl.getState for task thread.\nThis makes ContinuousFileReaderOperator about 29% faster."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMzkwMDYx", "url": "https://github.com/apache/flink/pull/12401#pullrequestreview-421390061", "createdAt": "2020-05-30T08:47:33Z", "commit": {"oid": "810c8f3a23dd3bdf402bd7659f972b741d1fce8d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQwODo0NzozM1rOGcxerA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQwODo0NzozM1rOGcxerA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgyMzk4MA==", "bodyText": "I was thinking about doing here:\nthis.mainMailboxExecutor = mailboxProcessor.getMainMailboxExecutor();\n\nor\nthis.mainMailboxExecutor = mailboxProcessor.getMinPriorityMailboxExecutor();\n\nto maintain the contract, that everything goes via MailboxProcessor one way or another.\nAs it is now, some actions are going via mailbox and actionExecutor bypassing the processor, which I'm not sure if it's as clean? But I'm not entirely sure.", "url": "https://github.com/apache/flink/pull/12401#discussion_r432823980", "createdAt": "2020-05-30T08:47:33Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java", "diffHunk": "@@ -276,6 +281,7 @@ protected StreamTask(\n \t\tthis.actionExecutor = Preconditions.checkNotNull(actionExecutor);\n \t\tthis.mailboxProcessor = new MailboxProcessor(this::processInput, mailbox, actionExecutor);\n \t\tthis.mailboxProcessor.initMetric(environment.getMetricGroup());\n+\t\tthis.mainMailboxExecutor = new MailboxExecutorImpl(mailbox, MIN_PRIORITY, actionExecutor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "810c8f3a23dd3bdf402bd7659f972b741d1fce8d"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5414f176c2421b92c2c7880f516ae4046f41513", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/e5414f176c2421b92c2c7880f516ae4046f41513", "committedDate": "2020-06-02T07:19:14Z", "message": "[FLINK-16057][hotfix][task] Remove MailboxProcessor.mainMailboxExecutor field\n\nCurrently, the field is unnecessary; further adding MailboxProcessor\nfield to MailboxExecutor creates cyclic dependency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5378d6643fb985dff068bd6c13b73047bf7f91ce", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/5378d6643fb985dff068bd6c13b73047bf7f91ce", "committedDate": "2020-06-02T07:19:22Z", "message": "[FLINK-16057][task] Optimize ContinuousFileReaderOperator\n\nCurrent approach of re-enqueuing mails creates an overhead\nvisible in benchmarks. This change eliminates unnecessary\nre-enqueueing of mails by checking mailboxExecutor.isIdle."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ee16834faff9045e1f356f4696b7b3e7834527c", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/9ee16834faff9045e1f356f4696b7b3e7834527c", "committedDate": "2020-06-02T07:19:22Z", "message": "[FLINK-16057][task] Optimize TaskMailbox state retrieval\n\nDon't lock in TaskMailboxImpl.getState for task thread.\nThis makes ContinuousFileReaderOperator about 29% faster."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3bde38fba011e5c786da8f072543b673a5b25eb0", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/3bde38fba011e5c786da8f072543b673a5b25eb0", "committedDate": "2020-05-29T16:23:29Z", "message": "[FLINK-16057][task] Optimize TaskMailbox state retrieval\n\nDon't lock in TaskMailboxImpl.getState for task thread.\nThis makes ContinuousFileReaderOperator about 29% faster."}, "afterCommit": {"oid": "9ee16834faff9045e1f356f4696b7b3e7834527c", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/9ee16834faff9045e1f356f4696b7b3e7834527c", "committedDate": "2020-06-02T07:19:22Z", "message": "[FLINK-16057][task] Optimize TaskMailbox state retrieval\n\nDon't lock in TaskMailboxImpl.getState for task thread.\nThis makes ContinuousFileReaderOperator about 29% faster."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyOTEwMDY5", "url": "https://github.com/apache/flink/pull/12401#pullrequestreview-422910069", "createdAt": "2020-06-02T17:41:15Z", "commit": {"oid": "9ee16834faff9045e1f356f4696b7b3e7834527c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4564, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}