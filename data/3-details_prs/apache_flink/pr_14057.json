{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwMTU2NTY0", "number": 14057, "title": "[FLINK-19681][checkpointing] Timeout aligned checkpoints", "bodyText": "This is an updated version of #13827 to pass the tests and address the remaining feedback.", "createdAt": "2020-11-12T21:03:25Z", "url": "https://github.com/apache/flink/pull/14057", "merged": true, "mergeCommit": {"oid": "cd6967c7259de29e04fbcb6c5e31fa483f98faf6"}, "closed": true, "closedAt": "2020-12-21T14:24:59Z", "author": {"login": "rkhachatryan"}, "timelineItems": {"totalCount": 36, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcFEwTABqjM5OTI5NzU0MDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdoSRUkgFqTU1NjIzMDM5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "86f96719e726d0225aa7201bb43f7c315aa74eea", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/86f96719e726d0225aa7201bb43f7c315aa74eea", "committedDate": "2020-11-12T20:47:25Z", "message": "(fixup) [FLINK-19681][checkpointing] Cancel really subsumed checkpoint, not the new one"}, "afterCommit": {"oid": "bcd846138434e9990c388d970ff4d313c5099978", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/bcd846138434e9990c388d970ff4d313c5099978", "committedDate": "2020-11-13T11:01:19Z", "message": "Revert \"(fixup) [FLINK-19681][checkpointing] Use time of start of alignment instead of checkpoint to timeout\"\n\nThis reverts commit 0236bbaabd478b18ab0e90497b8ec5d28cc4172f."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bcd846138434e9990c388d970ff4d313c5099978", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/bcd846138434e9990c388d970ff4d313c5099978", "committedDate": "2020-11-13T11:01:19Z", "message": "Revert \"(fixup) [FLINK-19681][checkpointing] Use time of start of alignment instead of checkpoint to timeout\"\n\nThis reverts commit 0236bbaabd478b18ab0e90497b8ec5d28cc4172f."}, "afterCommit": {"oid": "94b400f3a36ba2d65950b196a9d2650effb64cdc", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/94b400f3a36ba2d65950b196a9d2650effb64cdc", "committedDate": "2020-11-13T21:04:08Z", "message": "Convert barrier to unaligned on announcement lest surprise UnalignedController"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12984bc6635f56465bce2fc81695e4e8dd46233c", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/12984bc6635f56465bce2fc81695e4e8dd46233c", "committedDate": "2020-11-14T23:00:28Z", "message": "[FLINK-20145][task] Don't expose modifiable PrioritizedDeque.iterator"}, "afterCommit": {"oid": "a0225769113bc5163d40f7dfa600f7636629a530", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/a0225769113bc5163d40f7dfa600f7636629a530", "committedDate": "2020-11-14T23:17:20Z", "message": "[FLINK-20145][task] Don't expose modifiable PrioritizedDeque.iterator"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0225769113bc5163d40f7dfa600f7636629a530", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/a0225769113bc5163d40f7dfa600f7636629a530", "committedDate": "2020-11-14T23:17:20Z", "message": "[FLINK-20145][task] Don't expose modifiable PrioritizedDeque.iterator"}, "afterCommit": {"oid": "6435a7da42247e8a59fc8bd3159470d761bd7127", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/6435a7da42247e8a59fc8bd3159470d761bd7127", "committedDate": "2020-11-15T07:20:29Z", "message": "[FLINK-20145][task] Don't expose modifiable PrioritizedDeque.iterator"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6435a7da42247e8a59fc8bd3159470d761bd7127", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/6435a7da42247e8a59fc8bd3159470d761bd7127", "committedDate": "2020-11-15T07:20:29Z", "message": "[FLINK-20145][task] Don't expose modifiable PrioritizedDeque.iterator"}, "afterCommit": {"oid": "b3aa80f54805a5ca4b583c531c35aa64bf3d8d55", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/b3aa80f54805a5ca4b583c531c35aa64bf3d8d55", "committedDate": "2020-12-03T09:53:44Z", "message": "[FLINK-19681][checkpointing] Don't timeout checkpoint on last barrier"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3aa80f54805a5ca4b583c531c35aa64bf3d8d55", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/b3aa80f54805a5ca4b583c531c35aa64bf3d8d55", "committedDate": "2020-12-03T09:53:44Z", "message": "[FLINK-19681][checkpointing] Don't timeout checkpoint on last barrier"}, "afterCommit": {"oid": "3ecb27dc1ef7cb838d556c53aabb7bf327bc2491", "author": {"user": {"login": "aljoscha", "name": "Aljoscha Krettek"}}, "url": "https://github.com/apache/flink/commit/3ecb27dc1ef7cb838d556c53aabb7bf327bc2491", "committedDate": "2020-12-01T10:39:39Z", "message": "[refactor] Delegate option printing fully to CLIs\n\nBefore, the \"-t\" option was hardcoded in CliFrontendParser although that\noption comes from GenericCLI.\n\nNow, print printHelpForRunApplication() has the same signature and\nbehaviour as the other printHelp...() methods.\n\nThis lessens coupling but introduces the problem that we now filter\nmanually on the CLIs that support application mode in CliFrontendParser.\n\nIf we really wanted we could add a \"supportsApplicationMode()\" flag to\nCLIs but I think that would be pushing it a bit."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ab9b0a1089b92378f993bba6757af495d125a86", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/3ab9b0a1089b92378f993bba6757af495d125a86", "committedDate": "2020-12-03T11:27:16Z", "message": "[hotfix][checkpointing] Explicit creation of CheckpointOptions\n\nThe motivation is to eliminate subtle bugs when changing checkpoint\ntype on the fly.\n1. Only guess options when creating a new barrier from configuration\n2. For other cases provide explicit factory methods\n2. Carry the current checkpoint/barrier requirements instead of the\ninitial configuration."}, "afterCommit": {"oid": "107985b487f186beaeddd7187a383fd268b997db", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/107985b487f186beaeddd7187a383fd268b997db", "committedDate": "2020-12-03T11:31:43Z", "message": "[hotfix][checkpointing] Explicit creation of CheckpointOptions\n\nThe motivation is to eliminate subtle bugs when changing checkpoint\ntype on the fly.\n1. Only guess options when creating a new barrier from configuration\n2. For other cases provide explicit factory methods\n2. Carry the current checkpoint/barrier requirements instead of the\ninitial configuration."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "107985b487f186beaeddd7187a383fd268b997db", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/107985b487f186beaeddd7187a383fd268b997db", "committedDate": "2020-12-03T11:31:43Z", "message": "[hotfix][checkpointing] Explicit creation of CheckpointOptions\n\nThe motivation is to eliminate subtle bugs when changing checkpoint\ntype on the fly.\n1. Only guess options when creating a new barrier from configuration\n2. For other cases provide explicit factory methods\n2. Carry the current checkpoint/barrier requirements instead of the\ninitial configuration."}, "afterCommit": {"oid": "e470bcdae1694f36a466767a457a54006432e5a8", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/e470bcdae1694f36a466767a457a54006432e5a8", "committedDate": "2020-12-03T21:05:10Z", "message": "[FLINK-19681][network] Force priority for converted barriers\n\nWithout this, gate interprets barrier as outdated\nbecause it has already seen its SQN during the announcement.\n\nPreventing announcements from updating gate lastSeenSqn\ndoesn't work because it provokes concurrency issue with\nnotification (by efficitively disable lastSeenSqn guard)."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e470bcdae1694f36a466767a457a54006432e5a8", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/e470bcdae1694f36a466767a457a54006432e5a8", "committedDate": "2020-12-03T21:05:10Z", "message": "[FLINK-19681][network] Force priority for converted barriers\n\nWithout this, gate interprets barrier as outdated\nbecause it has already seen its SQN during the announcement.\n\nPreventing announcements from updating gate lastSeenSqn\ndoesn't work because it provokes concurrency issue with\nnotification (by efficitively disable lastSeenSqn guard)."}, "afterCommit": {"oid": "64f5b48580f748cc15bc7ee65db45dd937b4821a", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/64f5b48580f748cc15bc7ee65db45dd937b4821a", "committedDate": "2020-12-04T09:41:48Z", "message": "[FLINK-19681][network] Force priority for converted barriers\n\nWithout this, gate interprets barrier as outdated\nbecause it has already seen its SQN during the announcement.\n\nPreventing announcements from updating gate lastSeenSqn\ndoesn't work because it provokes concurrency issue with\nnotification (by efficitively disable lastSeenSqn guard)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MTE2NDM5", "url": "https://github.com/apache/flink/pull/14057#pullrequestreview-549116439", "createdAt": "2020-12-10T11:46:53Z", "commit": {"oid": "3e08db569433493d0dc192ce5a1bed064d464f6a"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMTo0Njo1NFrOIDFT3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNToyOTo0NlrOIDPAmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDEwMzY0NQ==", "bodyText": "optional nit: I would prefer to static import checkState for shorter code (we are using it frequently enough, that I think Preconditions.checkState is too verbose).", "url": "https://github.com/apache/flink/pull/14057#discussion_r540103645", "createdAt": "2020-12-10T11:46:54Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/AlignedController.java", "diffHunk": "@@ -23,6 +23,7 @@\n import org.apache.flink.runtime.checkpoint.channel.InputChannelInfo;\n import org.apache.flink.runtime.io.network.api.CheckpointBarrier;\n import org.apache.flink.runtime.io.network.partition.consumer.CheckpointableInput;\n+import org.apache.flink.util.Preconditions;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e08db569433493d0dc192ce5a1bed064d464f6a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDExMjg3OA==", "bodyText": "Commit message is a bit misleading/out dated (pendingBarrier -> lastSeenBarrier). (also in a some of the following commits)", "url": "https://github.com/apache/flink/pull/14057#discussion_r540112878", "createdAt": "2020-12-10T12:01:52Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/ChannelStatePersister.java", "diffHunk": "@@ -88,16 +88,16 @@ protected void maybePersist(Buffer buffer) {\n \t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3bb1e044f3716d12abb0241589364889766fe82"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDExNzQ1NA==", "bodyText": "Can you add a unit test that would show/explain the problem?", "url": "https://github.com/apache/flink/pull/14057#discussion_r540117454", "createdAt": "2020-12-10T12:09:32Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/LocalInputChannel.java", "diffHunk": "@@ -229,11 +229,8 @@ public void run() {\n \n \t\tnumBytesIn.inc(buffer.getSize());\n \t\tnumBuffersIn.inc();\n-\t\tif (buffer.getDataType().hasPriority()) {\n-\t\t\tchannelStatePersister.checkForBarrier(buffer);\n-\t\t} else {\n-\t\t\tchannelStatePersister.maybePersist(buffer);\n-\t\t}\n+\t\tchannelStatePersister.checkForBarrier(buffer);\n+\t\tchannelStatePersister.maybePersist(buffer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3bb1e044f3716d12abb0241589364889766fe82"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDEyMjk1Nw==", "bodyText": "ditto about a unit test? (What is the scenario that is working differently and how is it is supposed to be working)", "url": "https://github.com/apache/flink/pull/14057#discussion_r540122957", "createdAt": "2020-12-10T12:18:33Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -451,11 +451,17 @@ public void onBuffer(Buffer buffer, int sequenceNumber, int backlog) throws IOEx\n \t\t\t\t}\n \t\t\t\telse {\n \t\t\t\t\treceivedBuffers.add(sequenceBuffer);\n-\t\t\t\t\tchannelStatePersister.maybePersist(buffer);\n \t\t\t\t\tif (dataType.requiresAnnouncement()) {\n \t\t\t\t\t\tfirstPriorityEvent = addPriorityBuffer(announce(sequenceBuffer));\n \t\t\t\t\t}\n \t\t\t\t}\n+\t\t\t\tchannelStatePersister.checkForBarrier(sequenceBuffer.buffer).ifPresent(id -> {\n+\t\t\t\t\t// checkpoint was not yet started by task thread,\n+\t\t\t\t\t// so remember the numbers of buffers to spill for the time when it will be started\n+\t\t\t\t\tlastBarrierSequenceNumber = sequenceBuffer.sequenceNumber;\n+\t\t\t\t\tlastBarrierId = id;\n+\t\t\t\t});\n+\t\t\t\tchannelStatePersister.maybePersist(buffer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3bb1e044f3716d12abb0241589364889766fe82"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDEyNDc2NA==", "bodyText": "ditto unit test", "url": "https://github.com/apache/flink/pull/14057#discussion_r540124764", "createdAt": "2020-12-10T12:21:20Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/AlignedController.java", "diffHunk": "@@ -120,6 +122,12 @@ public void obsoleteBarrierReceived(\n \t\tresumeConsumption(channelInfo);\n \t}\n \n+\tprotected void resetPendingCheckpoint(long cancelledId) {\n+\t\tfor (final CheckpointableInput input : inputs) {\n+\t\t\tinput.checkpointStopped(cancelledId);\n+\t\t}\n+\t}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f066cdb9d50b0be0967d458581a855781b4e43ee"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI0OTE3Ng==", "bodyText": "I'm not entirely convinced if this a better approach.\nFor me, using global checkpoint time (in other words recently added checkpoinStartDelay metric) seemed easier to understand for the user. If aligned checkpoint barrier is taking too much time to reach given tasks - we are timeouting it to unaligned checkpoint that overtakes in-flight data. This seemed easier to comprehend and easier to explain  compared to time outing alignment on some subtask?\nSecondly your proposed change will not work with single input tasks without active timeouts?", "url": "https://github.com/apache/flink/pull/14057#discussion_r540249176", "createdAt": "2020-12-10T15:13:53Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/AlternatingController.java", "diffHunk": "@@ -193,6 +202,11 @@ private CheckpointBarrierBehaviourController chooseController(CheckpointBarrier\n \n \tprivate boolean canTimeout(CheckpointBarrier barrier) {\n \t\treturn barrier.getCheckpointOptions().isTimeoutable() &&\n-\t\t\tbarrier.getCheckpointOptions().getAlignmentTimeout() < (System.currentTimeMillis() - barrier.getTimestamp());\n+\t\t\tbarrier.getId() <= lastSeenBarrier &&\n+\t\t\tbarrier.getCheckpointOptions().getAlignmentTimeout() * 1_000_000 < (System.nanoTime() - firstBarrierArrivalTime);\n+\t}\n+\n+\tprivate long getArrivalTime(CheckpointBarrier announcedBarrier) {\n+\t\treturn announcedBarrier.getCheckpointOptions().isTimeoutable() ? System.nanoTime() : Long.MAX_VALUE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "781e25d56e06bcf4668470a393c1caeb35944e33"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI1MDg2OQ==", "bodyText": "?\nWhy is it not enough to do this in preProcessFirstBarrierOrAnnouncement?\n(as in other places: a unit test would be helpful)", "url": "https://github.com/apache/flink/pull/14057#discussion_r540250869", "createdAt": "2020-12-10T15:15:56Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/AlternatingController.java", "diffHunk": "@@ -114,6 +114,7 @@ public void barrierAnnouncement(\n \t\t\tlastSeenBarrier = barrier.getId();\n \t\t\tfirstBarrierArrivalTime = getArrivalTime(barrier);\n \t\t}\n+\t\tactiveController = chooseController(barrier);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8317386822507ae18c796b34c886aca0e1c8b351"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI1NTI3OA==", "bodyText": "Why have you removed this code? What was the problem?\nWas it subsumed by switchToUnaligned  call happening in the last barrierReceived call?", "url": "https://github.com/apache/flink/pull/14057#discussion_r540255278", "createdAt": "2020-12-10T15:21:15Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/AlternatingController.java", "diffHunk": "@@ -146,28 +146,7 @@ private void switchToUnaligned(\n \n \t@Override\n \tpublic Optional<CheckpointBarrier> postProcessLastBarrier(InputChannelInfo channelInfo, CheckpointBarrier barrier) throws IOException, CheckpointException {\n-\t\tOptional<CheckpointBarrier> maybeTimeOut = asTimedOut(barrier);\n-\t\tif (maybeTimeOut.isPresent() && activeController == alignedController) {\n-\t\t\tswitchToUnaligned(channelInfo, maybeTimeOut.get());\n-\t\t\tcheckState(activeController == unalignedController);\n-\t\t\tcheckState(!activeController.postProcessLastBarrier(channelInfo, maybeTimeOut.orElse(barrier)).isPresent());\n-\t\t\treturn maybeTimeOut;\n-\t\t}\n-\n-\t\tbarrier = maybeTimeOut.orElse(barrier);\n-\t\tif (barrier.getCheckpointOptions().isUnalignedCheckpoint()) {\n-\t\t\tcheckState(activeController == unalignedController);\n-\t\t\tcheckState(!activeController.postProcessLastBarrier(channelInfo, maybeTimeOut.orElse(barrier)).isPresent());\n-\t\t\treturn Optional.empty();\n-\t\t}\n-\t\telse {\n-\t\t\tcheckState(activeController == alignedController);\n-\t\t\tOptional<CheckpointBarrier> triggerResult = activeController.postProcessLastBarrier(\n-\t\t\t\tchannelInfo,\n-\t\t\t\tbarrier);\n-\t\t\tcheckState(triggerResult.isPresent());\n-\t\t\treturn triggerResult;\n-\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a28800009950ce82faf214cfd2540d92d858089d"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI1NzgzOQ==", "bodyText": "part of a previous fixup?", "url": "https://github.com/apache/flink/pull/14057#discussion_r540257839", "createdAt": "2020-12-10T15:24:17Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/CheckpointBarrier.java", "diffHunk": "@@ -119,6 +119,6 @@ public boolean isCheckpoint() {\n \t}\n \n \tpublic CheckpointBarrier asUnaligned() {\n-\t\treturn checkpointOptions.isUnalignedCheckpoint() ? this : new CheckpointBarrier(getId(), getTimestamp(), getCheckpointOptions().asTimedOut());\n+\t\treturn checkpointOptions.isUnalignedCheckpoint() ? this : new CheckpointBarrier(getId(), getTimestamp(), getCheckpointOptions().toUnaligned());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d17f1c3fdc7bdf4632f58d7d52150f45f5cb11cd"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI2MjU1NA==", "bodyText": "nit: I don't understand this comment, can you rephrase/elaborate a bit?", "url": "https://github.com/apache/flink/pull/14057#discussion_r540262554", "createdAt": "2020-12-10T15:29:46Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -569,14 +569,23 @@ public void convertToPriorityEvent(int sequenceNumber) throws IOException {\n \t\t\t\t\"Attempted to convertToPriorityEvent an event [%s] that has already been prioritized [%s]\",\n \t\t\t\ttoPrioritize,\n \t\t\t\tnumPriorityElementsBeforeRemoval);\n+\t\t\t// set the priority flag (checked on poll)\n+\t\t\t// don't convert the barrier itself (barrier controller might not have been switched yet)\n+\t\t\tAbstractEvent e = EventSerializer.fromBuffer(toPrioritize.buffer, this.getClass().getClassLoader());\n+\t\t\ttoPrioritize.buffer.setReaderIndex(0);\n+\t\t\ttoPrioritize = new SequenceBuffer(EventSerializer.toBuffer(e, true), toPrioritize.sequenceNumber);\n \t\t\tfirstPriorityEvent = addPriorityBuffer(toPrioritize); \t// note that only position of the element is changed\n \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// converting the event itself would require switching the controller sooner\n \t\t}\n \t\tif (firstPriorityEvent) {\n-\t\t\tnotifyPriorityEvent(sequenceNumber);\n+\t\t\tnotifyPriorityEventForce(); // use force here because the barrier SQN might be seen by gate during the announcement", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64f5b48580f748cc15bc7ee65db45dd937b4821a"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "334d437db83c7e4cdc1085cc568b1a7f134f047a", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/334d437db83c7e4cdc1085cc568b1a7f134f047a", "committedDate": "2020-12-15T19:33:08Z", "message": "[hotfix][test] Improve error message in ValidatingCheckpointHandler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "293fa78e92782f7c57d6bbc955a9492632e74944", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/293fa78e92782f7c57d6bbc955a9492632e74944", "committedDate": "2020-12-15T19:33:08Z", "message": "[hotfix][test] Fix StreamConfig propagation to StreamTask in StreamTaskMailboxTestHarnessBuilder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "64f5b48580f748cc15bc7ee65db45dd937b4821a", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/64f5b48580f748cc15bc7ee65db45dd937b4821a", "committedDate": "2020-12-04T09:41:48Z", "message": "[FLINK-19681][network] Force priority for converted barriers\n\nWithout this, gate interprets barrier as outdated\nbecause it has already seen its SQN during the announcement.\n\nPreventing announcements from updating gate lastSeenSqn\ndoesn't work because it provokes concurrency issue with\nnotification (by efficitively disable lastSeenSqn guard)."}, "afterCommit": {"oid": "cbce4fc8b854e23dc7128b161336dc09e2d81e03", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/cbce4fc8b854e23dc7128b161336dc09e2d81e03", "committedDate": "2020-12-15T19:33:08Z", "message": "[FLINK-19681][network] Force priority for converted barriers\n\nWithout this, gate interprets barrier as outdated\nbecause it has already seen its SQN during the announcement.\n\nPreventing announcements from updating gate lastSeenSqn\ndoesn't work because it provokes concurrency issue with\nnotification (by efficitively disable lastSeenSqn guard)."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cbce4fc8b854e23dc7128b161336dc09e2d81e03", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/cbce4fc8b854e23dc7128b161336dc09e2d81e03", "committedDate": "2020-12-15T19:33:08Z", "message": "[FLINK-19681][network] Force priority for converted barriers\n\nWithout this, gate interprets barrier as outdated\nbecause it has already seen its SQN during the announcement.\n\nPreventing announcements from updating gate lastSeenSqn\ndoesn't work because it provokes concurrency issue with\nnotification (by efficitively disable lastSeenSqn guard)."}, "afterCommit": {"oid": "c98b6606d03656b144f18c76a8af8b14c0b65b17", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/c98b6606d03656b144f18c76a8af8b14c0b65b17", "committedDate": "2020-12-15T20:20:34Z", "message": "[FLINK-19681][network] Force priority for converted barriers\n\nWithout this, gate interprets barrier as outdated\nbecause it has already seen its SQN during the announcement.\n\nPreventing announcements from updating gate lastSeenSqn\ndoesn't work because it provokes concurrency issue with\nnotification (by efficitively disable lastSeenSqn guard)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNzgzNTUy", "url": "https://github.com/apache/flink/pull/14057#pullrequestreview-553783552", "createdAt": "2020-12-16T15:11:33Z", "commit": {"oid": "1bc2357282481837865c7c16a8d46e08a35a0b50"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNToxMTozM1rOIHKJGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNTo0ODowNlrOIHL_yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM3NzExNA==", "bodyText": "And what about test coverage for  those changes?\nSide question, shouldn't those two fixes be separate commits?", "url": "https://github.com/apache/flink/pull/14057#discussion_r544377114", "createdAt": "2020-12-16T15:11:33Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -451,11 +451,20 @@ public void onBuffer(Buffer buffer, int sequenceNumber, int backlog) throws IOEx\n \t\t\t\t}\n \t\t\t\telse {\n \t\t\t\t\treceivedBuffers.add(sequenceBuffer);\n-\t\t\t\t\tchannelStatePersister.maybePersist(buffer);\n \t\t\t\t\tif (dataType.requiresAnnouncement()) {\n \t\t\t\t\t\tfirstPriorityEvent = addPriorityBuffer(announce(sequenceBuffer));\n \t\t\t\t\t}\n \t\t\t\t}\n+\t\t\t\tchannelStatePersister\n+\t\t\t\t\t.checkForBarrier(sequenceBuffer.buffer)\n+\t\t\t\t\t.filter(id -> id > lastBarrierId)\n+\t\t\t\t\t.ifPresent(id -> {\n+\t\t\t\t\t\t// checkpoint was not yet started by task thread,\n+\t\t\t\t\t\t// so remember the numbers of buffers to spill for the time when it will be started\n+\t\t\t\t\t\tlastBarrierId = id;\n+\t\t\t\t\t\tlastBarrierSequenceNumber = sequenceBuffer.sequenceNumber;\n+\t\t\t\t\t});\n+\t\t\t\tchannelStatePersister.maybePersist(buffer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bc2357282481837865c7c16a8d46e08a35a0b50"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM5NTg1NA==", "bodyText": "Otherwise, channels may capture in-flight buffers from an older checkpoint\n\nIs this test actually checking for that? I do not see any buffer that would belong to an older checkpoint?\n(I think I still do not understand this fix)", "url": "https://github.com/apache/flink/pull/14057#discussion_r544395854", "createdAt": "2020-12-16T15:34:21Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/AlternatingControllerTest.java", "diffHunk": "@@ -68,6 +68,22 @@\n  */\n public class AlternatingControllerTest {\n \n+\t/**\n+\t * Upon subsuming (or canceling) a checkpoint, channels should be notified regardless of whether UC controller is\n+\t * currently being used or not. Otherwise, channels may capture in-flight buffers from an older checkpoint.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "007d12dad11d4b24f24bebf6388f273a54b7c1f4"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQwMTQ0NA==", "bodyText": "* If a checkpoint announcement was processed and then UC-barrier arrives (from the upstream)\n\t * then it should be processed by the UC controller.\n\n->\n\t * If a checkpoint announcement was processed from one channel and then UC-barrier arrives \n\t * on another channel, this UC barrier should be processed by the UC controller.\n\n?", "url": "https://github.com/apache/flink/pull/14057#discussion_r544401444", "createdAt": "2020-12-16T15:41:01Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/AlternatingControllerTest.java", "diffHunk": "@@ -84,6 +84,24 @@ public void testChannelResetOnNewBarrier() throws Exception {\n \t\tassertFalse(stateWriter.getAddedInput().isEmpty());\n \t}\n \n+\t/**\n+\t * If a checkpoint announcement was processed and then UC-barrier arrives (from the upstream)\n+\t * then it should be processed by the UC controller.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bf08a45c31dacf497440b2cc889ccb7bef95cce"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQwMTkxNQ==", "bodyText": "Aren't we missing some assertion?", "url": "https://github.com/apache/flink/pull/14057#discussion_r544401915", "createdAt": "2020-12-16T15:41:35Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/AlternatingControllerTest.java", "diffHunk": "@@ -84,6 +84,24 @@ public void testChannelResetOnNewBarrier() throws Exception {\n \t\tassertFalse(stateWriter.getAddedInput().isEmpty());\n \t}\n \n+\t/**\n+\t * If a checkpoint announcement was processed and then UC-barrier arrives (from the upstream)\n+\t * then it should be processed by the UC controller.\n+\t */\n+\t@Test\n+\tpublic void testSwitchToUnalignedByUpstream() throws Exception {\n+\t\tSingleInputGate inputGate = new SingleInputGateBuilder().setNumberOfChannels(2).build();\n+\t\tinputGate.setInputChannels(new TestInputChannel(inputGate, 0), new TestInputChannel(inputGate, 1));\n+\t\tValidatingCheckpointHandler target = new ValidatingCheckpointHandler();\n+\t\tSingleCheckpointBarrierHandler barrierHandler = barrierHandler(inputGate, target);\n+\t\tCheckpointedInputGate gate = buildGate(target, 2);\n+\n+\t\tCheckpointBarrier aligned = new CheckpointBarrier(1, System.currentTimeMillis(), alignedWithTimeout(getDefault(), Integer.MAX_VALUE));\n+\n+\t\tsend(toBuffer(new EventAnnouncement(aligned, 0), true), 0, gate); // process announcement but not the barrier\n+\t\tsend(toBuffer(aligned.asUnaligned(), true), 1, gate); // pretend it came from upstream before the first (AC) barrier was picked up\n+\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bf08a45c31dacf497440b2cc889ccb7bef95cce"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQwNzQ5OA==", "bodyText": "I still don't get this fix.\n\nBut there is a preProcessFirstBarrier before the switch in barrierReceived.\n\nYes, but my intention was that in that case, preProcessFirstBarrier would be called on the AlignedController. Next on the first barrier, we would switch to unaligned controller, which is doing this:\n\t\t// alignedController might has already processed some barriers, so \"migrate\"/forward those calls to unalignedController.\n\t\tunalignedController.preProcessFirstBarrier(channelInfo, barrier);\n\t\tfor (InputChannelInfo blockedChannel : blockedChannels) {\n\t\t\tunalignedController.barrierReceived(blockedChannel, barrier);\n\t\t}\n\nso preProcessFirstBarrier would be eventually called on the unaligned controller.", "url": "https://github.com/apache/flink/pull/14057#discussion_r544407498", "createdAt": "2020-12-16T15:48:06Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/AlternatingController.java", "diffHunk": "@@ -114,6 +114,7 @@ public void barrierAnnouncement(\n \t\t\tlastSeenBarrier = barrier.getId();\n \t\t\tfirstBarrierArrivalTime = getArrivalTime(barrier);\n \t\t}\n+\t\tactiveController = chooseController(barrier);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI1MDg2OQ=="}, "originalCommit": {"oid": "8317386822507ae18c796b34c886aca0e1c8b351"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c98b6606d03656b144f18c76a8af8b14c0b65b17", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/c98b6606d03656b144f18c76a8af8b14c0b65b17", "committedDate": "2020-12-15T20:20:34Z", "message": "[FLINK-19681][network] Force priority for converted barriers\n\nWithout this, gate interprets barrier as outdated\nbecause it has already seen its SQN during the announcement.\n\nPreventing announcements from updating gate lastSeenSqn\ndoesn't work because it provokes concurrency issue with\nnotification (by efficitively disable lastSeenSqn guard)."}, "afterCommit": {"oid": "ababe2b0e179a44c59cd0a3b6909a3a79c10a8f5", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/ababe2b0e179a44c59cd0a3b6909a3a79c10a8f5", "committedDate": "2020-12-17T07:53:13Z", "message": "[FLINK-19681][network] Force priority for converted barriers\n\nWithout this, gate interprets barrier as outdated\nbecause it has already seen its SQN during the announcement.\n\nPreventing announcements from updating gate lastSeenSqn\ndoesn't work because it provokes concurrency issue with\nnotification (by efficitively disable lastSeenSqn guard)."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ababe2b0e179a44c59cd0a3b6909a3a79c10a8f5", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/ababe2b0e179a44c59cd0a3b6909a3a79c10a8f5", "committedDate": "2020-12-17T07:53:13Z", "message": "[FLINK-19681][network] Force priority for converted barriers\n\nWithout this, gate interprets barrier as outdated\nbecause it has already seen its SQN during the announcement.\n\nPreventing announcements from updating gate lastSeenSqn\ndoesn't work because it provokes concurrency issue with\nnotification (by efficitively disable lastSeenSqn guard)."}, "afterCommit": {"oid": "8e85c514fcd09a767d76498da227d741e1b2d7e9", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/8e85c514fcd09a767d76498da227d741e1b2d7e9", "committedDate": "2020-12-17T08:12:06Z", "message": "[FLINK-19681][network] Force priority for converted barriers\n\nWithout this, gate interprets barrier as outdated\nbecause it has already seen its SQN during the announcement.\n\nPreventing announcements from updating gate lastSeenSqn\ndoesn't work because it provokes concurrency issue with\nnotification (by efficitively disable lastSeenSqn guard)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6fbb7d193e03d325ad2dc4ab2369826cf3be069", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/b6fbb7d193e03d325ad2dc4ab2369826cf3be069", "committedDate": "2020-12-17T13:45:25Z", "message": "[FLINK-19681][checkpointing] Choose controler before processing first barrier or announcement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e24882f117c9bcc486f76db44119e4e35c77299c", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/e24882f117c9bcc486f76db44119e4e35c77299c", "committedDate": "2020-12-17T13:45:30Z", "message": "[FLINK-19681][checkpointing] Timeout aligned checkpoints based on checkpointStartDelay"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69827b6309f20667cbcdc59c68e8199cf2e133f6", "author": {"user": {"login": "pnowojski", "name": "Piotr Nowojski"}}, "url": "https://github.com/apache/flink/commit/69827b6309f20667cbcdc59c68e8199cf2e133f6", "committedDate": "2020-12-17T13:45:30Z", "message": "[FLINK-19681][tests] Adjust alignmentTimeout in unaligned checkpoint ITCases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5784531fa1332fa542b2e65b0a5889dad68fc3ce", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/5784531fa1332fa542b2e65b0a5889dad68fc3ce", "committedDate": "2020-12-17T13:45:30Z", "message": "[FLINK-19681][config][checkpointing] Un-hide alignment timeout option"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ad51ad90ecc973442da18520ddff19d6456f453", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/8ad51ad90ecc973442da18520ddff19d6456f453", "committedDate": "2020-12-17T13:45:30Z", "message": "[hotfix][network] Report channel index if failied to deserialize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7645fe8892095d7590f6bd3c0e2b0fbc4b2c2e2a", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/7645fe8892095d7590f6bd3c0e2b0fbc4b2c2e2a", "committedDate": "2020-12-17T13:45:30Z", "message": "[hotfix][checkpointing] Add preconditions to channels and controllers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "348a71f216132c8fa5afa93c90414eaf6e86719e", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/348a71f216132c8fa5afa93c90414eaf6e86719e", "committedDate": "2020-12-17T13:45:30Z", "message": "[FLINK-19681][checkpointing] Fix barrier tracking in input channels\n\nLocalInputChannel:\nReset lastSeenBarrier for any barriers, not just UC.\nIn local channels, there are no announcements,\ntherefore lastSeenBarrier may not be reset for AC,\ntherefore extra buffers may be added to state.\n\nReduces failure frequency in UnalignedCheckpointIT par-local case.\n\nRemoteInputChannel:\nDon't update tracking state during conversion. Only do it\nupon receiving a barrier.\n\nReduces failure frequency in UnalignedCheckpointIT par-remote case."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23261e05db735b0885978078e776ece3b4dabcee", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/23261e05db735b0885978078e776ece3b4dabcee", "committedDate": "2020-12-17T13:45:30Z", "message": "[FLINK-19681][checkpointing] Reset channel barrier tracking from AlignedController\n\nInput channels are unaware of controller types and always update their\npendingCheckpointBarrierId.  Therefore, resetting it also should be done\nin either case.  Otherwise, pendingCheckpointBarrierId may be left in a\nwrong state upon receiving a new barrier."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c59de8b0fe47edc681c0a82c8465013c34c92b46", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/c59de8b0fe47edc681c0a82c8465013c34c92b46", "committedDate": "2020-12-17T17:17:16Z", "message": "[FLINK-19681][checkpointing] Resume consumption when receiving different upstream signals\n\nSolves hanging up in 1/12 uc tests."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e85c514fcd09a767d76498da227d741e1b2d7e9", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/8e85c514fcd09a767d76498da227d741e1b2d7e9", "committedDate": "2020-12-17T08:12:06Z", "message": "[FLINK-19681][network] Force priority for converted barriers\n\nWithout this, gate interprets barrier as outdated\nbecause it has already seen its SQN during the announcement.\n\nPreventing announcements from updating gate lastSeenSqn\ndoesn't work because it provokes concurrency issue with\nnotification (by efficitively disable lastSeenSqn guard)."}, "afterCommit": {"oid": "a74097650256dde7e570ea1cd98bbaa31142799a", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/a74097650256dde7e570ea1cd98bbaa31142799a", "committedDate": "2020-12-17T17:19:13Z", "message": "[FLINK-19681][network] Force priority for converted barriers\n\nWithout this, gate interprets barrier as outdated\nbecause it has already seen its SQN during the announcement.\n\nPreventing announcements from updating gate lastSeenSqn\ndoesn't work because it provokes concurrency issue with\nnotification (by efficitively disable lastSeenSqn guard)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f6cb76abfc95b8a935ff660f30242605d3b6920", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/6f6cb76abfc95b8a935ff660f30242605d3b6920", "committedDate": "2020-12-17T17:40:53Z", "message": "[FLINK-19681][checkpointing] Use converted barrier after disabling alignment\n\nOtherwise, further components (e.g. SubtaskCheckpointCoordinator) can\nget an AC barrier for the UC checkpoint."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d77f6e8b65a8399ca107b0272c4e00e6512e8b2", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/3d77f6e8b65a8399ca107b0272c4e00e6512e8b2", "committedDate": "2020-12-17T17:40:57Z", "message": "[FLINK-19681][checkpointing] Address minor feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6e5654be7d12fa9dc04655dc3fdd756c701885f", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/a6e5654be7d12fa9dc04655dc3fdd756c701885f", "committedDate": "2020-12-17T17:40:57Z", "message": "[FLINK-19681][checkpointing] Use time of start of alignment instead of checkpoint to timeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "922c91ab69909da49bb36f344c96039d4c2a643f", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/922c91ab69909da49bb36f344c96039d4c2a643f", "committedDate": "2020-12-17T17:40:57Z", "message": "[FLINK-19681][checkpointing] Switch controller before processing the first barrier\n\nIf a checkpoint announcement was processed and then UC-barrier arrives\n(from the upstream) then it should be processed by the UC controller."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2eca343e852b8438cc566435a0cce0f3ef771fa5", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/2eca343e852b8438cc566435a0cce0f3ef771fa5", "committedDate": "2020-12-17T17:40:57Z", "message": "[FLINK-19681][checkpointing] Don't timeout checkpoint on last barrier"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e7a7ce0e682eabc4c4d37e7b5ab910b6a75364a", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/0e7a7ce0e682eabc4c4d37e7b5ab910b6a75364a", "committedDate": "2020-12-17T17:40:57Z", "message": "[hotfix][checkpointing] Explicit creation of CheckpointOptions\n\nThe motivation is to eliminate subtle bugs when changing checkpoint\ntype on the fly.\n1. Only guess options when creating a new barrier from configuration\n2. For other cases provide explicit factory methods\n2. Carry the current checkpoint/barrier requirements instead of the\ninitial configuration."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f984efa3d7eedacd36d5f2c12f1256a10cfbc87d", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/f984efa3d7eedacd36d5f2c12f1256a10cfbc87d", "committedDate": "2020-12-17T17:40:57Z", "message": "[FLINK-19681][network] Force priority for converted barriers\n\nWithout this, gate interprets barrier as outdated\nbecause it has already seen its SQN during the announcement.\n\nPreventing announcements from updating gate lastSeenSqn\ndoesn't work because it provokes concurrency issue with\nnotification (by efficitively disable lastSeenSqn guard)."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a74097650256dde7e570ea1cd98bbaa31142799a", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/a74097650256dde7e570ea1cd98bbaa31142799a", "committedDate": "2020-12-17T17:19:13Z", "message": "[FLINK-19681][network] Force priority for converted barriers\n\nWithout this, gate interprets barrier as outdated\nbecause it has already seen its SQN during the announcement.\n\nPreventing announcements from updating gate lastSeenSqn\ndoesn't work because it provokes concurrency issue with\nnotification (by efficitively disable lastSeenSqn guard)."}, "afterCommit": {"oid": "f984efa3d7eedacd36d5f2c12f1256a10cfbc87d", "author": {"user": {"login": "rkhachatryan", "name": "Roman"}}, "url": "https://github.com/apache/flink/commit/f984efa3d7eedacd36d5f2c12f1256a10cfbc87d", "committedDate": "2020-12-17T17:40:57Z", "message": "[FLINK-19681][network] Force priority for converted barriers\n\nWithout this, gate interprets barrier as outdated\nbecause it has already seen its SQN during the announcement.\n\nPreventing announcements from updating gate lastSeenSqn\ndoesn't work because it provokes concurrency issue with\nnotification (by efficitively disable lastSeenSqn guard)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MjMwMzk1", "url": "https://github.com/apache/flink/pull/14057#pullrequestreview-556230395", "createdAt": "2020-12-21T09:11:25Z", "commit": {"oid": "f984efa3d7eedacd36d5f2c12f1256a10cfbc87d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4241, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}