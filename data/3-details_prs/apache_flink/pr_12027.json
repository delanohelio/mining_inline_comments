{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1MDU0NDM1", "number": 12027, "title": "[FLINK-17564][checkpointing] Fix buffer disorder issue of RemoteInputChannel for unaligned checkpoint", "bodyText": "What is the purpose of the change\nFor unaligned checkpoint, when checkpointing the inflight data of incoming channel, both task thread and Netty thread may add data to the channel state writer. More specifically, the task thread will first request inflight buffers from the input channel and add the buffers to the channel state writer, and then the Netty thread will add the following up buffers (if any) to the channel state writer. The buffer adding of task thread and Netty thread is not synchronized so the Netty thread may add buffers before the task thread which leads to disorder of the data and corruption of the data stream.\nThis PR tries to fix the problem.\nBrief change log\n\nMake requesting and adding of  inflight buffer of task thread happen in synchronized block to avoid race condition.\n\nVerifying this change\nThis change is already covered by existing tests.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-05-08T05:32:00Z", "url": "https://github.com/apache/flink/pull/12027", "merged": true, "mergeCommit": {"oid": "5bf121a726b6b0d6910db8a5ca63b8593617e4b4"}, "closed": true, "closedAt": "2020-05-10T09:26:13Z", "author": {"login": "wsry"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfLGqXABqjMzMTU2NTAzMDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcf3mxqAFqTQwODcyNTcxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "92a186a6082a66ae2cd0dd3ffa34f7b99a60307f", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/92a186a6082a66ae2cd0dd3ffa34f7b99a60307f", "committedDate": "2020-05-08T05:24:25Z", "message": "[FLINK-17564][checkpointing] Fix buffer disorder issue of RemoteInputChannel for unaligned checkpoint."}, "afterCommit": {"oid": "0e3ac198efdf799e34ffc78d2c2e5996d9e2d326", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/0e3ac198efdf799e34ffc78d2c2e5996d9e2d326", "committedDate": "2020-05-08T05:32:35Z", "message": "[FLINK-17564][checkpointing] Fix buffer disorder issue of RemoteInputChannel for unaligned checkpoint"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0e3ac198efdf799e34ffc78d2c2e5996d9e2d326", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/0e3ac198efdf799e34ffc78d2c2e5996d9e2d326", "committedDate": "2020-05-08T05:32:35Z", "message": "[FLINK-17564][checkpointing] Fix buffer disorder issue of RemoteInputChannel for unaligned checkpoint"}, "afterCommit": {"oid": "42f0a0401969ac05f42aa592a39c2431c9f3aed4", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/42f0a0401969ac05f42aa592a39c2431c9f3aed4", "committedDate": "2020-05-08T06:02:16Z", "message": "[FLINK-17564][checkpointing] Fix buffer disorder issue of RemoteInputChannel for unaligned checkpoint"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "42f0a0401969ac05f42aa592a39c2431c9f3aed4", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/42f0a0401969ac05f42aa592a39c2431c9f3aed4", "committedDate": "2020-05-08T06:02:16Z", "message": "[FLINK-17564][checkpointing] Fix buffer disorder issue of RemoteInputChannel for unaligned checkpoint"}, "afterCommit": {"oid": "914db8df1506edc8bd9dea08f1d35208d077e850", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/914db8df1506edc8bd9dea08f1d35208d077e850", "committedDate": "2020-05-09T07:55:36Z", "message": "[FLINK-17564][checkpointing] Fix buffer disorder issue of RemoteInputChannel for unaligned checkpoint"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "914db8df1506edc8bd9dea08f1d35208d077e850", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/914db8df1506edc8bd9dea08f1d35208d077e850", "committedDate": "2020-05-09T07:55:36Z", "message": "[FLINK-17564][checkpointing] Fix buffer disorder issue of RemoteInputChannel for unaligned checkpoint"}, "afterCommit": {"oid": "39c357488ab03b5771bad5e1d135a7109d4efcca", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/39c357488ab03b5771bad5e1d135a7109d4efcca", "committedDate": "2020-05-09T09:15:54Z", "message": "[FLINK-17564][checkpointing] Fix buffer disorder issue of RemoteInputChannel for unaligned checkpoint\n\nFor unaligned checkpoint, when checkpointing the inflight data of incoming channels, both task thread and Netty thread may add data to the ChannelStateWriter. More specifically, the task thread will first request inflight buffers from the input channel and add the buffers to the ChannelStateWriter, and then the Netty thread will add the following up buffers (if any) to the ChannelStateWriter. The buffer adding action of task thread and Netty thread is not synchronized so the Netty thread may add buffers before the task thread which leads to disorder of the data and corruption of the data stream.\n\nThis PR fixes the problem by requesting and enqueuing the inflight buffers in the synchronized block."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjQxNDkz", "url": "https://github.com/apache/flink/pull/12027#pullrequestreview-408641493", "createdAt": "2020-05-09T11:16:17Z", "commit": {"oid": "39c357488ab03b5771bad5e1d135a7109d4efcca"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQxMToxNjoxN1rOGS6ZNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQxMToxNjoxN1rOGS6ZNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ4NDI3OQ==", "bodyText": "rename all of the methods requestInflightBuffers -> spillInflightBuffers? As this method is no longer returning/requesting but spilling inflight buffers?", "url": "https://github.com/apache/flink/pull/12027#discussion_r422484279", "createdAt": "2020-05-09T11:16:17Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -216,7 +220,7 @@ void retriggerSubpartitionRequest(int subpartitionIndex) throws IOException {\n \t}\n \n \t@Override\n-\tpublic List<Buffer> requestInflightBuffers(long checkpointId) throws IOException {\n+\tpublic void requestInflightBuffers(long checkpointId, ChannelStateWriter channelStateWriter) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39c357488ab03b5771bad5e1d135a7109d4efcca"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39c357488ab03b5771bad5e1d135a7109d4efcca", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/39c357488ab03b5771bad5e1d135a7109d4efcca", "committedDate": "2020-05-09T09:15:54Z", "message": "[FLINK-17564][checkpointing] Fix buffer disorder issue of RemoteInputChannel for unaligned checkpoint\n\nFor unaligned checkpoint, when checkpointing the inflight data of incoming channels, both task thread and Netty thread may add data to the ChannelStateWriter. More specifically, the task thread will first request inflight buffers from the input channel and add the buffers to the ChannelStateWriter, and then the Netty thread will add the following up buffers (if any) to the ChannelStateWriter. The buffer adding action of task thread and Netty thread is not synchronized so the Netty thread may add buffers before the task thread which leads to disorder of the data and corruption of the data stream.\n\nThis PR fixes the problem by requesting and enqueuing the inflight buffers in the synchronized block."}, "afterCommit": {"oid": "8c2f01f2d9d3bbc9cfcb4608482bc487f2922f9e", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/8c2f01f2d9d3bbc9cfcb4608482bc487f2922f9e", "committedDate": "2020-05-09T12:52:08Z", "message": "[FLINK-17564][checkpointing] Fix buffer disorder issue of RemoteInputChannel for unaligned checkpoint\n\nFor unaligned checkpoint, when checkpointing the inflight data of incoming channels, both task thread and Netty thread may add data to the ChannelStateWriter. More specifically, the task thread will first request inflight buffers from the input channel and add the buffers to the ChannelStateWriter, and then the Netty thread will add the following up buffers (if any) to the ChannelStateWriter. The buffer adding action of task thread and Netty thread is not synchronized so the Netty thread may add buffers before the task thread which leads to disorder of the data and corruption of the data stream.\n\nThis PR fixes the problem by requesting and enqueuing the inflight buffers in the synchronized block."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8c2f01f2d9d3bbc9cfcb4608482bc487f2922f9e", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/8c2f01f2d9d3bbc9cfcb4608482bc487f2922f9e", "committedDate": "2020-05-09T12:52:08Z", "message": "[FLINK-17564][checkpointing] Fix buffer disorder issue of RemoteInputChannel for unaligned checkpoint\n\nFor unaligned checkpoint, when checkpointing the inflight data of incoming channels, both task thread and Netty thread may add data to the ChannelStateWriter. More specifically, the task thread will first request inflight buffers from the input channel and add the buffers to the ChannelStateWriter, and then the Netty thread will add the following up buffers (if any) to the ChannelStateWriter. The buffer adding action of task thread and Netty thread is not synchronized so the Netty thread may add buffers before the task thread which leads to disorder of the data and corruption of the data stream.\n\nThis PR fixes the problem by requesting and enqueuing the inflight buffers in the synchronized block."}, "afterCommit": {"oid": "68d8c93c0bf932a53689325005a9cdd79b2cdbed", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/68d8c93c0bf932a53689325005a9cdd79b2cdbed", "committedDate": "2020-05-09T12:58:43Z", "message": "[FLINK-17564][checkpointing] Fix buffer disorder issue of RemoteInputChannel for unaligned checkpoint\n\nFor unaligned checkpoint, when checkpointing the inflight data of incoming channels, both task thread and Netty thread may add data to the ChannelStateWriter. More specifically, the task thread will first request inflight buffers from the input channel and add the buffers to the ChannelStateWriter, and then the Netty thread will add the following up buffers (if any) to the ChannelStateWriter. The buffer adding action of task thread and Netty thread is not synchronized so the Netty thread may add buffers before the task thread which leads to disorder of the data and corruption of the data stream.\n\nThis PR fixes the problem by requesting and enqueuing the inflight buffers in the synchronized block."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7bc0776ec4eb009b23ca26e5282f7fafdd13a6b", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/a7bc0776ec4eb009b23ca26e5282f7fafdd13a6b", "committedDate": "2020-05-10T04:13:58Z", "message": "[FLINK-17564][checkpointing] Fix buffer disorder issue of RemoteInputChannel for unaligned checkpoint\n\nFor unaligned checkpoint, when checkpointing the inflight data of incoming channels, both task thread and Netty thread may add data to the ChannelStateWriter. More specifically, the task thread will first request inflight buffers from the input channel and add the buffers to the ChannelStateWriter, and then the Netty thread will add the following up buffers (if any) to the ChannelStateWriter. The buffer adding action of task thread and Netty thread is not synchronized so the Netty thread may add buffers before the task thread which leads to disorder of the data and corruption of the data stream.\n\nThis PR fixes the problem by requesting and enqueuing the inflight buffers in the synchronized block."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "68d8c93c0bf932a53689325005a9cdd79b2cdbed", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/68d8c93c0bf932a53689325005a9cdd79b2cdbed", "committedDate": "2020-05-09T12:58:43Z", "message": "[FLINK-17564][checkpointing] Fix buffer disorder issue of RemoteInputChannel for unaligned checkpoint\n\nFor unaligned checkpoint, when checkpointing the inflight data of incoming channels, both task thread and Netty thread may add data to the ChannelStateWriter. More specifically, the task thread will first request inflight buffers from the input channel and add the buffers to the ChannelStateWriter, and then the Netty thread will add the following up buffers (if any) to the ChannelStateWriter. The buffer adding action of task thread and Netty thread is not synchronized so the Netty thread may add buffers before the task thread which leads to disorder of the data and corruption of the data stream.\n\nThis PR fixes the problem by requesting and enqueuing the inflight buffers in the synchronized block."}, "afterCommit": {"oid": "a7bc0776ec4eb009b23ca26e5282f7fafdd13a6b", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/a7bc0776ec4eb009b23ca26e5282f7fafdd13a6b", "committedDate": "2020-05-10T04:13:58Z", "message": "[FLINK-17564][checkpointing] Fix buffer disorder issue of RemoteInputChannel for unaligned checkpoint\n\nFor unaligned checkpoint, when checkpointing the inflight data of incoming channels, both task thread and Netty thread may add data to the ChannelStateWriter. More specifically, the task thread will first request inflight buffers from the input channel and add the buffers to the ChannelStateWriter, and then the Netty thread will add the following up buffers (if any) to the ChannelStateWriter. The buffer adding action of task thread and Netty thread is not synchronized so the Netty thread may add buffers before the task thread which leads to disorder of the data and corruption of the data stream.\n\nThis PR fixes the problem by requesting and enqueuing the inflight buffers in the synchronized block."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NzI1NzEz", "url": "https://github.com/apache/flink/pull/12027#pullrequestreview-408725713", "createdAt": "2020-05-10T09:24:52Z", "commit": {"oid": "a7bc0776ec4eb009b23ca26e5282f7fafdd13a6b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4663, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}