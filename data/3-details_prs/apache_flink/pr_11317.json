{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0MTcwOTEw", "number": 11317, "title": "[FLINK-16433][table-api] TableEnvironmentImpl doesn't clear\u2026", "bodyText": "\u2026 buffered operations when it fails to translate the operation\n\nWhat is the purpose of the change\nTableEnvironmentImpl won't clear buffered operations if the translation throws an exception. This can cause problem for following DMLs.\nBrief change log\n\nAlways clear the buffered operations.\nAdd test case.\n\nVerifying this change\nAdded test case\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? NA", "createdAt": "2020-03-05T09:49:31Z", "url": "https://github.com/apache/flink/pull/11317", "merged": true, "mergeCommit": {"oid": "cd51ffc00de58eae6baa6f2e7c31d9fdf54016b4"}, "closed": true, "closedAt": "2020-03-18T08:50:07Z", "author": {"login": "lirui-apache"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKoeDMgBqjMxMDA0NDc3NDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOzVWZAFqTM3NjY2MjUyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "087dde306dcb08f70e14195ae6e1eb3c12fbdf78", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/087dde306dcb08f70e14195ae6e1eb3c12fbdf78", "committedDate": "2020-03-05T09:46:16Z", "message": "[FLINK-16433][table-planner-blink] TableEnvironmentImpl doesn't clear buffered operations when it fails to translate the operation"}, "afterCommit": {"oid": "9c6d3fcae177e05bba552a967d0cf75587412693", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/9c6d3fcae177e05bba552a967d0cf75587412693", "committedDate": "2020-03-05T09:51:57Z", "message": "[FLINK-16433][table-api] TableEnvironmentImpl doesn't clear buffered operations when it fails to translate the operation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxOTI2MDA0", "url": "https://github.com/apache/flink/pull/11317#pullrequestreview-371926004", "createdAt": "2020-03-10T12:58:51Z", "commit": {"oid": "6cb26ab23d18cd85dda0501861873fa9382332ff"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMjo1ODo1MVrOF0No_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMzowMToyOVrOF0NuPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI5Mzc1Ng==", "bodyText": "please add some comments about why this query will fail ?", "url": "https://github.com/apache/flink/pull/11317#discussion_r390293756", "createdAt": "2020-03-10T12:58:51Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/api/TableEnvironmentITCase.scala", "diffHunk": "@@ -135,6 +135,25 @@ class TableEnvironmentITCase(settings: EnvironmentSettings, mode: String) {\n     assertEquals(TableTestUtil.replaceStageId(result1), TableTestUtil.replaceStageId(result2))\n   }\n \n+  @Test\n+  def testClearOperation(): Unit = {\n+    val tableEnv = TableEnvironmentImpl.create(settings)\n+    tableEnv.sqlUpdate(\"create table dest1(x map<int,bigint>) with('connector' = 'COLLECTION')\")\n+    tableEnv.sqlUpdate(\"create table dest2(x int) with('connector' = 'COLLECTION')\")\n+    tableEnv.sqlUpdate(\"create table src(x int) with('connector' = 'COLLECTION')\")\n+\n+    try {\n+      tableEnv.sqlUpdate(\"insert into dest1 select count(*) from src\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb26ab23d18cd85dda0501861873fa9382332ff"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI5NDIxOQ==", "bodyText": "add an Assert.fail() here", "url": "https://github.com/apache/flink/pull/11317#discussion_r390294219", "createdAt": "2020-03-10T12:59:48Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/api/TableEnvironmentITCase.scala", "diffHunk": "@@ -135,6 +135,25 @@ class TableEnvironmentITCase(settings: EnvironmentSettings, mode: String) {\n     assertEquals(TableTestUtil.replaceStageId(result1), TableTestUtil.replaceStageId(result2))\n   }\n \n+  @Test\n+  def testClearOperation(): Unit = {\n+    val tableEnv = TableEnvironmentImpl.create(settings)\n+    tableEnv.sqlUpdate(\"create table dest1(x map<int,bigint>) with('connector' = 'COLLECTION')\")\n+    tableEnv.sqlUpdate(\"create table dest2(x int) with('connector' = 'COLLECTION')\")\n+    tableEnv.sqlUpdate(\"create table src(x int) with('connector' = 'COLLECTION')\")\n+\n+    try {\n+      tableEnv.sqlUpdate(\"insert into dest1 select count(*) from src\")\n+      tableEnv.execute(\"insert dest1\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb26ab23d18cd85dda0501861873fa9382332ff"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI5NTEwMQ==", "bodyText": "add some comments in TableEnvironment#execute to explain the buffer clear behavior", "url": "https://github.com/apache/flink/pull/11317#discussion_r390295101", "createdAt": "2020-03-10T13:01:29Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-api-java/src/main/java/org/apache/flink/table/api/internal/TableEnvironmentImpl.java", "diffHunk": "@@ -723,8 +723,11 @@ public TableConfig getConfig() {\n \n \t@Override\n \tpublic JobExecutionResult execute(String jobName) throws Exception {\n-\t\ttranslate(bufferedModifyOperations);\n-\t\tbufferedModifyOperations.clear();\n+\t\ttry {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb26ab23d18cd85dda0501861873fa9382332ff"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cb26ab23d18cd85dda0501861873fa9382332ff", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/6cb26ab23d18cd85dda0501861873fa9382332ff", "committedDate": "2020-03-05T10:23:00Z", "message": "make sure exception is triggered"}, "afterCommit": {"oid": "1592dcea466941555f1f16fd2172b1ee2f196783", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/1592dcea466941555f1f16fd2172b1ee2f196783", "committedDate": "2020-03-11T06:35:51Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "654c2709eb7b26d12212347e6b9f779a9b7824d0", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/654c2709eb7b26d12212347e6b9f779a9b7824d0", "committedDate": "2020-03-11T12:24:44Z", "message": "[FLINK-16433][table-api] TableEnvironmentImpl doesn't clear buffered operations when it fails to translate the operation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9b84502f4512e0eda1847abf0b6f076a65bd5bf", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/e9b84502f4512e0eda1847abf0b6f076a65bd5bf", "committedDate": "2020-03-11T12:24:44Z", "message": "make sure exception is triggered"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ff8370c3ff065556fd1889ebefb23aca2161515", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/8ff8370c3ff065556fd1889ebefb23aca2161515", "committedDate": "2020-03-11T12:26:29Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b044fa7bc048d0f2381eb80f438bdf0db00bd56", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/6b044fa7bc048d0f2381eb80f438bdf0db00bd56", "committedDate": "2020-03-11T12:45:33Z", "message": "minor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1592dcea466941555f1f16fd2172b1ee2f196783", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/1592dcea466941555f1f16fd2172b1ee2f196783", "committedDate": "2020-03-11T06:35:51Z", "message": "address comments"}, "afterCommit": {"oid": "6b044fa7bc048d0f2381eb80f438bdf0db00bd56", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/6b044fa7bc048d0f2381eb80f438bdf0db00bd56", "committedDate": "2020-03-11T12:45:33Z", "message": "minor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bfc593562df2a1b7026ea7474c558edd0472566", "author": {"user": {"login": "lirui-apache", "name": "Rui Li"}}, "url": "https://github.com/apache/flink/commit/3bfc593562df2a1b7026ea7474c558edd0472566", "committedDate": "2020-03-12T02:28:08Z", "message": "update doc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjQzNzgw", "url": "https://github.com/apache/flink/pull/11317#pullrequestreview-373243780", "createdAt": "2020-03-12T02:36:58Z", "commit": {"oid": "3bfc593562df2a1b7026ea7474c558edd0472566"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NjYyNTIw", "url": "https://github.com/apache/flink/pull/11317#pullrequestreview-376662520", "createdAt": "2020-03-18T08:49:30Z", "commit": {"oid": "3bfc593562df2a1b7026ea7474c558edd0472566"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3067, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}