{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5ODQwMzYz", "number": 11649, "title": "[FLINK-15812][runtime] Archive jobs asynchronously", "bodyText": "Moves the job archiving in the Dispatchers ioExecutor.\nTheHistoryServerArchivist interface already indicated that the archiving should be done asynchronously due to returning a future, so I introduced the executor into the archivist, instead of asychronously calling HistoryServerArchivist#archiveExecutionGraph.", "createdAt": "2020-04-06T18:55:23Z", "url": "https://github.com/apache/flink/pull/11649", "merged": true, "mergeCommit": {"oid": "446dda14993161d96f6768438a5d226064dee871"}, "closed": true, "closedAt": "2020-04-08T20:26:06Z", "author": {"login": "zentol"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVDVNBAH2gAyMzk5ODQwMzYzOmIxYmRmODNmOGJiOGZkZGI1NmUwYjRjZWY1NzJkZmZmZmU1NjY4ZGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVkc3OAH2gAyMzk5ODQwMzYzOjA0ZjJlN2EwYmNmY2M1YjM3YTU1ZDMzNWY4OTNmMGQ1ZjI2Njg1ZmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b1bdf83f8bb8fddb56e0b4cef572dffffe5668dc", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/b1bdf83f8bb8fddb56e0b4cef572dffffe5668dc", "committedDate": "2020-04-06T18:51:22Z", "message": "[FLINK-15812][runtime] Archive jobs asynchronously"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MjAwMjUx", "url": "https://github.com/apache/flink/pull/11649#pullrequestreview-389200251", "createdAt": "2020-04-07T14:55:35Z", "commit": {"oid": "b1bdf83f8bb8fddb56e0b4cef572dffffe5668dc"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNDo1NTozNVrOGCHmoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNTowMDozMlrOGCH3Fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg3NDkxMw==", "bodyText": "nit in order to make it symmetric:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tthis.ioExecutor = ioExecutor;\n          \n          \n            \n            \t\tthis.ioExecutor = Preconditions.checkNotNull(ioExecutor);", "url": "https://github.com/apache/flink/pull/11649#discussion_r404874913", "createdAt": "2020-04-07T14:55:35Z", "author": {"login": "tillrohrmann"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/JsonResponseHistoryServerArchivist.java", "diffHunk": "@@ -39,18 +39,25 @@\n \n \tprivate final Path archivePath;\n \n-\tJsonResponseHistoryServerArchivist(JsonArchivist jsonArchivist, Path archivePath) {\n+\tprivate final Executor ioExecutor;\n+\n+\tJsonResponseHistoryServerArchivist(JsonArchivist jsonArchivist, Path archivePath, Executor ioExecutor) {\n \t\tthis.jsonArchivist = Preconditions.checkNotNull(jsonArchivist);\n \t\tthis.archivePath = Preconditions.checkNotNull(archivePath);\n+\t\tthis.ioExecutor = ioExecutor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1bdf83f8bb8fddb56e0b4cef572dffffe5668dc"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg3OTEyNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tfinal CompletableFuture<Acknowledge> ackFuture = new CompletableFuture<>();\n          \n          \n            \n            \t\tioExecutor.execute(() -> {\n          \n          \n            \n            \t\t\ttry {\n          \n          \n            \n            \t\t\t\tFsJobArchivist.archiveJob(archivePath, executionGraph.getJobID(), jsonArchivist.archiveJsonWithPath(executionGraph));\n          \n          \n            \n            \t\t\t\tackFuture.complete(Acknowledge.get());\n          \n          \n            \n            \t\t\t} catch (IOException e) {\n          \n          \n            \n            \t\t\t\tackFuture.completeExceptionally(e);\n          \n          \n            \n            \t\t\t}\n          \n          \n            \n            \t\t});\n          \n          \n            \n            \t\treturn ackFuture;\n          \n          \n            \n            return CompletableFuture\n          \n          \n            \n            \t\t\t.runAsync(\n          \n          \n            \n            \t\t\t\tThrowingRunnable.unchecked(() -> FsJobArchivist.archiveJob(\n          \n          \n            \n            \t\t\t\t\tarchivePath,\n          \n          \n            \n            \t\t\t\t\texecutionGraph.getJobID(),\n          \n          \n            \n            \t\t\t\t\tjsonArchivist.archiveJsonWithPath(executionGraph))),\n          \n          \n            \n            \t\t\t\tioExecutor)\n          \n          \n            \n            \t\t\t.thenApply(ignored -> Acknowledge.get());", "url": "https://github.com/apache/flink/pull/11649#discussion_r404879127", "createdAt": "2020-04-07T15:00:32Z", "author": {"login": "tillrohrmann"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/JsonResponseHistoryServerArchivist.java", "diffHunk": "@@ -39,18 +39,25 @@\n \n \tprivate final Path archivePath;\n \n-\tJsonResponseHistoryServerArchivist(JsonArchivist jsonArchivist, Path archivePath) {\n+\tprivate final Executor ioExecutor;\n+\n+\tJsonResponseHistoryServerArchivist(JsonArchivist jsonArchivist, Path archivePath, Executor ioExecutor) {\n \t\tthis.jsonArchivist = Preconditions.checkNotNull(jsonArchivist);\n \t\tthis.archivePath = Preconditions.checkNotNull(archivePath);\n+\t\tthis.ioExecutor = ioExecutor;\n \t}\n \n \t@Override\n \tpublic CompletableFuture<Acknowledge> archiveExecutionGraph(AccessExecutionGraph executionGraph) {\n-\t\ttry {\n-\t\t\tFsJobArchivist.archiveJob(archivePath, executionGraph.getJobID(), jsonArchivist.archiveJsonWithPath(executionGraph));\n-\t\t\treturn CompletableFuture.completedFuture(Acknowledge.get());\n-\t\t} catch (IOException e) {\n-\t\t\treturn FutureUtils.completedExceptionally(e);\n-\t\t}\n+\t\tfinal CompletableFuture<Acknowledge> ackFuture = new CompletableFuture<>();\n+\t\tioExecutor.execute(() -> {\n+\t\t\ttry {\n+\t\t\t\tFsJobArchivist.archiveJob(archivePath, executionGraph.getJobID(), jsonArchivist.archiveJsonWithPath(executionGraph));\n+\t\t\t\tackFuture.complete(Acknowledge.get());\n+\t\t\t} catch (IOException e) {\n+\t\t\t\tackFuture.completeExceptionally(e);\n+\t\t\t}\n+\t\t});\n+\t\treturn ackFuture;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1bdf83f8bb8fddb56e0b4cef572dffffe5668dc"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04f2e7a0bcfcc5b37a55d335f893f0d5f26685fd", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/04f2e7a0bcfcc5b37a55d335f893f0d5f26685fd", "committedDate": "2020-04-08T09:26:36Z", "message": "address comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2335, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}