{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyOTMyODU1", "number": 13859, "title": "[FLINK-19902][coordination][tests] Adjust JobMasterTest to be compatible with declarative resource management", "bodyText": "Makes some adjustments to the JobMasterTest to make it compatible with declarative resource management.\ntestAcceptSlotOfferAfterLeaderChange:\n\nuse a JobGraph with at least 1 vertex; an empty JG has no resource requirements, causing the slot pool to reject all slot offers\n\ntestSlotRequestTimeoutWhenNoSlotOffering:\n\ndo not intercept slot requests, and instead wait until the job has restarted a few times\n\nslot requests are not issued with declarative resource management\n\n\nfurthermore, register the task executor right away, instead of waiting for the slot request\n\nseemed unnecessary\n\n\n\ntestReleasingTaskExecutorIfNoMoreSlotsRegistered:\n\n\nmigrate from JM#notifyAllocationFailure to JM#failSlot\n\nnotifyAllocationFailure must not be called with declarative resource management\nalso uses a fixed TaskManagerLocation, since the slot offer must match a registered task executor\n\n\n\nuse random AllocationIDs for slot offers; similar to FLINK-19637.", "createdAt": "2020-10-30T11:28:24Z", "url": "https://github.com/apache/flink/pull/13859", "merged": true, "mergeCommit": {"oid": "4dfcc8e863bf3528a01f72f11a26b6cc8cd42e48"}, "closed": true, "closedAt": "2020-11-06T09:16:58Z", "author": {"login": "zentol"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZlG2tgFqTUyNDQ0NTQ2NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZzX7PABqjM5NjYyNjY4MzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NDQ1NDY0", "url": "https://github.com/apache/flink/pull/13859#pullrequestreview-524445464", "createdAt": "2020-11-05T16:33:29Z", "commit": {"oid": "30a05a4fe4a92077162d823bc115413141fdeb57"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjozMzoyOVrOHuLxUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjozNzo1NlrOHuL95A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE4OTM5Mw==", "bodyText": "This is a busy waiting loop, right? Maybe we can add a pause.", "url": "https://github.com/apache/flink/pull/13859#discussion_r518189393", "createdAt": "2020-11-05T16:33:29Z", "author": {"login": "tillrohrmann"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java", "diffHunk": "@@ -962,30 +952,23 @@ public void testSlotRequestTimeoutWhenNoSlotOffering() throws Exception {\n \n \t\t\tjobMasterGateway.registerTaskManager(taskExecutorGateway.getAddress(), taskManagerUnresolvedLocation, testingTimeout).get();\n \n-\t\t\t// wait for the slot request timeout\n-\t\t\tfinal SlotRequest slotRequest = blockingQueue.take();\n+\t\t\t// wait for the job to restart, due to the slot request timing out\n+\t\t\twhile (jobMasterGateway.requestJob(testingTimeout).join().getStatusTimestamp(JobStatus.RESTARTING) <= 0) {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30a05a4fe4a92077162d823bc115413141fdeb57"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5MjYxMg==", "bodyText": "You might also use CommonTestUtils.waitUntilCondition.", "url": "https://github.com/apache/flink/pull/13859#discussion_r518192612", "createdAt": "2020-11-05T16:37:56Z", "author": {"login": "tillrohrmann"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/JobMasterTest.java", "diffHunk": "@@ -962,30 +952,23 @@ public void testSlotRequestTimeoutWhenNoSlotOffering() throws Exception {\n \n \t\t\tjobMasterGateway.registerTaskManager(taskExecutorGateway.getAddress(), taskManagerUnresolvedLocation, testingTimeout).get();\n \n-\t\t\t// wait for the slot request timeout\n-\t\t\tfinal SlotRequest slotRequest = blockingQueue.take();\n+\t\t\t// wait for the job to restart, due to the slot request timing out\n+\t\t\twhile (jobMasterGateway.requestJob(testingTimeout).join().getStatusTimestamp(JobStatus.RESTARTING) <= 0) {}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE4OTM5Mw=="}, "originalCommit": {"oid": "30a05a4fe4a92077162d823bc115413141fdeb57"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0a258918865e4383c06f7048e6523d8d13aacb0", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/c0a258918865e4383c06f7048e6523d8d13aacb0", "committedDate": "2020-11-06T09:16:25Z", "message": "[FLINK-19902][coordination][tests] Adjust JobMasterTest to be compatible with declarative resource management"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30a05a4fe4a92077162d823bc115413141fdeb57", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/30a05a4fe4a92077162d823bc115413141fdeb57", "committedDate": "2020-10-30T11:15:30Z", "message": "[FLINK-19902][coordination][tests] Adjust JobMasterTest to be compatible with declarative resource management"}, "afterCommit": {"oid": "c0a258918865e4383c06f7048e6523d8d13aacb0", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/c0a258918865e4383c06f7048e6523d8d13aacb0", "committedDate": "2020-11-06T09:16:25Z", "message": "[FLINK-19902][coordination][tests] Adjust JobMasterTest to be compatible with declarative resource management"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2806, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}