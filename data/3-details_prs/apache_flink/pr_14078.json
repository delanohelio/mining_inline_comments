{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxNTMyMTg2", "number": 14078, "title": "[FLINK-20169] Move emitting MAX_WATERMARK out of the SourceOperator processing loop", "bodyText": "What is the purpose of the change\nThis commit reverts some of the changes introduced in fada6fb.\nInstead of checking for END_OF_INPUT in the SourceOperator, I emit the MAX_WATERMARK from SourceOperatorStreamTask#afterInvoke. I check if the Task was cancelled or not. If it was not that means the Task finished succesfully and we emit the MAX_WATERMARK.\nVerifying this change\nThis change added tests in SourceOperatorStreamTaskTest\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-11-16T09:28:17Z", "url": "https://github.com/apache/flink/pull/14078", "merged": true, "mergeCommit": {"oid": "b878f54d54bbf1b8f966924e3d1dab8c23f7c628"}, "closed": true, "closedAt": "2020-11-16T16:23:21Z", "author": {"login": "dawidwys"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddBgL7AH2gAyNTIxNTMyMTg2OjJiODJiOTQ0OGUzYmI0M2QzZTdkYTUwYmNlNTU3ZjUwYzA3YWUxOWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddCiCxAFqTUzMTE5ODQ3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2b82b9448e3bb43d3e7da50bce557f50c07ae19b", "author": {"user": {"login": "dawidwys", "name": "Dawid Wysakowicz"}}, "url": "https://github.com/apache/flink/commit/2b82b9448e3bb43d3e7da50bce557f50c07ae19b", "committedDate": "2020-11-16T09:26:06Z", "message": "[FLINK-20169] Move emitting MAX_WATERMARK out of the SourceOperator processing loop\n\nThis commit reverts some of the changes introduced in\nfada6fb6ac9fd7f6510f1f2d77b6baa06563e222.\n\nInstead of checking for END_OF_INPUT in the SourceOperator, I\nemit the MAX_WATERMARK from SourceOperatorStreamTask#afterInvoke. I check if the Task was cancelled or not. If it was not\nthat means the Task finished succesfully and we emit the MAX_WATERMARK."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMTk4NDc1", "url": "https://github.com/apache/flink/pull/14078#pullrequestreview-531198475", "createdAt": "2020-11-16T10:35:50Z", "commit": {"oid": "2b82b9448e3bb43d3e7da50bce557f50c07ae19b"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDozNTo1MFrOHz0Thw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDozNzozNFrOHz0bcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA5NjM5MQ==", "bodyText": "Why is this one needed here and not in the other test?", "url": "https://github.com/apache/flink/pull/14078#discussion_r524096391", "createdAt": "2020-11-16T10:35:50Z", "author": {"login": "aljoscha"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/SourceOperatorStreamTaskTest.java", "diffHunk": "@@ -99,6 +102,29 @@ public void testSnapshotAndAdvanceToEndOfEventTime() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testEmittingMaxWatermarkAfterReadingAllRecords() throws Exception {\n+\t\ttry (StreamTaskMailboxTestHarness<Integer> testHarness = createTestHarness()) {\n+\t\t\ttestHarness.processAll();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b82b9448e3bb43d3e7da50bce557f50c07ae19b"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA5ODQxOA==", "bodyText": "It's a bit strange that we replicate the shutdown/cancel logic in the TestHarness and don't re-use the production logic. Just noticing it here, it was like this before the PR.", "url": "https://github.com/apache/flink/pull/14078#discussion_r524098418", "createdAt": "2020-11-16T10:37:34Z", "author": {"login": "aljoscha"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskMailboxTestHarness.java", "diffHunk": "@@ -143,12 +143,17 @@ public void waitForTaskCompletion() throws Exception {\n \t\t}\n \t}\n \n-\t@Override\n-\tpublic void close() throws Exception {\n-\t\tstreamTask.cancel();\n-\n+\tpublic void finishProcessing() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b82b9448e3bb43d3e7da50bce557f50c07ae19b"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4280, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}