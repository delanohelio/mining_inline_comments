{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1NjA1Mzgy", "number": 11564, "title": "[FLINK-16864][metrics] Add IdleTime metric for task.", "bodyText": "What is the purpose of the change\nThis pr adds an IdleTime metric which measures idle time of a task including the time cost for mail processor to wait for new mail and the time cost in record writer to waiting a new buffer.\n\nwhen a job can not catch up with the speed of data generating, the vertex which idle time is near to zero is the bottle neck of the job.\nwhen a job is not busy, idle time can be used to guide user how much he can scale down the job.\n\nBrief change log\nA meter metrics named idleTimeMsPerSecond is added in TaskIOMetricGroup:\n\n*idleTime contains time waiting mail and time waiting output buffer. *\nwaiting mail time is collected when mail processor is trying to process a new mail but no mail submitted.\nwaiting output buffer time is collected when record writer is trying to request a new buffer from result partition but no buffer available.\n\nVerifying this change\nThis change is already covered by existing tests, such as\n\nTaskIOMetricGroupTest\nRecordWriterTest\nTaskMailboxProcessorTest\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? yes\nIf yes, how is the feature documented? docs", "createdAt": "2020-03-30T12:03:31Z", "url": "https://github.com/apache/flink/pull/11564", "merged": true, "mergeCommit": {"oid": "18787230ea0bb3b502a8002b9f4f0fa0afb85f63"}, "closed": true, "closedAt": "2020-04-08T08:00:08Z", "author": {"login": "wenlong88"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcS5aAlgBqjMxODEyMTY3NjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVjAbNABqjMyMTI5MTk1MTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "623248594914ebf2dab46965390f72ba7f3c1346", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/623248594914ebf2dab46965390f72ba7f3c1346", "committedDate": "2020-03-30T11:41:35Z", "message": "add metric doc"}, "afterCommit": {"oid": "0542c5dc966c56853433d487858711cbba1d9eb3", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/0542c5dc966c56853433d487858711cbba1d9eb3", "committedDate": "2020-03-31T02:09:13Z", "message": "add doc for idle metric"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NTgyMjI4", "url": "https://github.com/apache/flink/pull/11564#pullrequestreview-384582228", "createdAt": "2020-03-31T10:02:09Z", "commit": {"oid": "0542c5dc966c56853433d487858711cbba1d9eb3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDowMjowOVrOF-OUCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDoyMDoxOVrOF-O-VA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc5MDUzOQ==", "bodyText": "The time (in milliseconds) this task is idle (either has no data to process or it is back pressured) per second.", "url": "https://github.com/apache/flink/pull/11564#discussion_r400790539", "createdAt": "2020-03-31T10:02:09Z", "author": {"login": "pnowojski"}, "path": "docs/monitoring/metrics.md", "diffHunk": "@@ -1440,6 +1440,11 @@ Certain RocksDB native metrics are available but disabled by default, you can fi\n       <td>Whether the task is back-pressured.</td>\n       <td>Gauge</td>\n     </tr>\n+    <tr>\n+      <td>idleTimeMsPerSecond</td>\n+      <td>The time(in milliseconds) this task is dile(eithor waiting mails or waiting output buffer) per second.</td>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0542c5dc966c56853433d487858711cbba1d9eb3"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc5MTY1MQ==", "bodyText": "typo idleTimePerSecond", "url": "https://github.com/apache/flink/pull/11564#discussion_r400791651", "createdAt": "2020-03-31T10:03:57Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/TaskIOMetricGroup.java", "diffHunk": "@@ -45,6 +45,7 @@\n \tprivate final Meter numRecordsInRate;\n \tprivate final Meter numRecordsOutRate;\n \tprivate final Meter numBuffersOutRate;\n+\tprivate final Meter idlTimePerSecond;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0542c5dc966c56853433d487858711cbba1d9eb3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgwMTM2NA==", "bodyText": "I think this is most of the times correct, however there might be a race condition with NetworkBufferPool#redistributeBuffers and isApproximatelyAvailable() check. Check might return available, while the method would still block.\nThe proper way of doing it would be to add non blocking version of the method getBufferBuilder() (or rather rename the existing one to getBufferBuilderBlocking() and implement new getBufferBuilder() which would be non blocking)   to the ResultPartition (and BufferPool + LocalBufferPool). It should be easy, as there are already non blocking methods for requesting memory segments.", "url": "https://github.com/apache/flink/pull/11564#discussion_r400801364", "createdAt": "2020-03-31T10:20:19Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/writer/RecordWriter.java", "diffHunk": "@@ -276,6 +281,21 @@ protected void checkErroneous() throws IOException {\n \t\t}\n \t}\n \n+\tprotected void addBufferConsumer(BufferConsumer consumer, int targetChannel) throws IOException {\n+\t\ttargetPartition.addBufferConsumer(consumer, targetChannel);\n+\t}\n+\n+\tprotected BufferBuilder getBufferBuilder() throws IOException, InterruptedException {\n+\t\tBufferBuilder builder;\n+\t\tif (!targetPartition.isApproximatelyAvailable()) {\n+\t\t\tlong start = System.currentTimeMillis();\n+\t\t\tbuilder = targetPartition.getBufferBuilder();\n+\t\t\tidleTimeMsPerSecond.markEvent(System.currentTimeMillis() - start);\n+\t\t} else {\n+\t\t\tbuilder = targetPartition.getBufferBuilder();\n+\t\t}\n+\t\treturn builder;\n+\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0542c5dc966c56853433d487858711cbba1d9eb3"}, "originalPosition": 53}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b709e1952df66cba5a316f9a46902538bf8cf245", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/b709e1952df66cba5a316f9a46902538bf8cf245", "committedDate": "2020-04-03T03:28:52Z", "message": "fix unstable ut."}, "afterCommit": {"oid": "dfc6f9642a2fe6fca383707a11d53ef6ed2ea381", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/dfc6f9642a2fe6fca383707a11d53ef6ed2ea381", "committedDate": "2020-04-03T03:51:42Z", "message": "add idle time metrics for task."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MzAwNTMy", "url": "https://github.com/apache/flink/pull/11564#pullrequestreview-387300532", "createdAt": "2020-04-03T14:20:29Z", "commit": {"oid": "dfc6f9642a2fe6fca383707a11d53ef6ed2ea381"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDoyMDoyOVrOGAXlqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDoyMDoyOVrOGAXlqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzAzOTY1Nw==", "bodyText": "nit: still missing spaces in front of opening braces (", "url": "https://github.com/apache/flink/pull/11564#discussion_r403039657", "createdAt": "2020-04-03T14:20:29Z", "author": {"login": "pnowojski"}, "path": "docs/monitoring/metrics.zh.md", "diffHunk": "@@ -1440,6 +1440,11 @@ Certain RocksDB native metrics are available but disabled by default, you can fi\n       <td>Whether the task is back-pressured.</td>\n       <td>Gauge</td>\n     </tr>\n+    <tr>\n+      <td>idleTimeMsPerSecond</td>\n+      <td>The time(in milliseconds) this task is idle(either has no data to process or it is back pressured) per second.</td>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfc6f9642a2fe6fca383707a11d53ef6ed2ea381"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MzA3NTAz", "url": "https://github.com/apache/flink/pull/11564#pullrequestreview-387307503", "createdAt": "2020-04-03T14:28:09Z", "commit": {"oid": "dfc6f9642a2fe6fca383707a11d53ef6ed2ea381"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDoyODowOVrOGAX6_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNDoyODowOVrOGAX6_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA0NTExNw==", "bodyText": "Test is failing on azure:\n[ERROR] Failures: \n[ERROR]   BroadcastRecordWriterTest>RecordWriterTest.testIdleTime:505 \nExpected: a value equal to or greater than <10L>\n     but: <0L> was less than <10L>\n[ERROR]   RecordWriterTest.testIdleTime:505 \nExpected: a value equal to or greater than <10L>\n     but: <0L> was less than <10L>", "url": "https://github.com/apache/flink/pull/11564#discussion_r403045117", "createdAt": "2020-04-03T14:28:09Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/api/writer/RecordWriterTest.java", "diffHunk": "@@ -464,6 +466,46 @@ public void testIsAvailableOrNot() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testIdleTime() throws IOException, InterruptedException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfc6f9642a2fe6fca383707a11d53ef6ed2ea381"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MDg2ODQx", "url": "https://github.com/apache/flink/pull/11564#pullrequestreview-389086841", "createdAt": "2020-04-07T12:56:26Z", "commit": {"oid": "b39a8920fa705cd5cb0afa48bf5f092ebc3d8399"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b39a8920fa705cd5cb0afa48bf5f092ebc3d8399", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/b39a8920fa705cd5cb0afa48bf5f092ebc3d8399", "committedDate": "2020-04-07T12:17:44Z", "message": "add non blocking request buffer builder."}, "afterCommit": {"oid": "e41026b4385126ab1405cba5ec96298f490be248", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/e41026b4385126ab1405cba5ec96298f490be248", "committedDate": "2020-04-07T15:44:14Z", "message": "add non blocking request buffer builder."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3aa5c9ddf82d9ac50f5a0e0ce8f3161f19545dde", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/3aa5c9ddf82d9ac50f5a0e0ce8f3161f19545dde", "committedDate": "2020-04-08T07:44:58Z", "message": "[FLINK-16864][metrics] Add IdleTime metric for task\n\nThis pr adds an IdleTime metric which measures idle time of a task including the time cost for mail processor to wait for new mail and the time cost in record writer to waiting a new buffer.\n\n1. when a job can not catch up with the speed of data generating, the vertex which idle time is near to zero is the bottle neck of the job.\n2. when a job is not busy, idle time can be used to guide user how much he can scale down the job."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e41026b4385126ab1405cba5ec96298f490be248", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/e41026b4385126ab1405cba5ec96298f490be248", "committedDate": "2020-04-07T15:44:14Z", "message": "add non blocking request buffer builder."}, "afterCommit": {"oid": "3aa5c9ddf82d9ac50f5a0e0ce8f3161f19545dde", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/3aa5c9ddf82d9ac50f5a0e0ce8f3161f19545dde", "committedDate": "2020-04-08T07:44:58Z", "message": "[FLINK-16864][metrics] Add IdleTime metric for task\n\nThis pr adds an IdleTime metric which measures idle time of a task including the time cost for mail processor to wait for new mail and the time cost in record writer to waiting a new buffer.\n\n1. when a job can not catch up with the speed of data generating, the vertex which idle time is near to zero is the bottle neck of the job.\n2. when a job is not busy, idle time can be used to guide user how much he can scale down the job."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2155, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}