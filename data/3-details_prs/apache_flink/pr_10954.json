{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3OTk2NDIy", "number": 10954, "title": "[FLINK-15785][travis][e2e] Rework E2E test activations", "bodyText": "This PR reworks the activation logic for java end-to-end tests.\nIntroduces a new framework for specifying category inclusions/exclusions in flink-end-to-end-tests, that is capable of automatically aggregating properties across profiles.\nInclusions are defined by setting the e2e.include.<category-class>, conversely exclusions by setting e2e.exclude.<category-class>. The value of the property is a boolean that controls whether the inclusion/exclusions is enabled or not.\nA groovy script searches for all properties matching the naming scheme, extracts the category class, aggregates inclusions/exclusions and sets the appropriate properties.\nThe script also prints the final inclusions/exclusions; I'd recommend trying it out and specifying different profile sets to see how it behaves.\nBackground: Maven does not really support combining categories. The surefire-plugin only accepts values like catA,catB, instead of a list where individual items have their own XML element. This implies that in order to combine category definitions one would have to concatenate the current value with some other value, i.e., do categories = categories + \"hello\". Maven doesn't support this however since it is a recursive definition of a property.\nThe following is a listing of every problem and how it was addressed:\n\ntravis activations are spread out over multiple files (.travis.yml, travis_watchdoh.sh)\nThey are now consolidated in .travis.yml. While this does introduce some redundancy it is still preferable because .travis.yml is the most visible travis file, and it is easier to mvoe the pre-commit activation around.\nsetting multiple categories in .travis.yml is incredibly verbose\nEach category now has their dedicated profile in flink-end-to-end-tests that set the appropriate category. This is significantly more concise and provides an abstraction of the specific categories used. (In other words, we can modify things at will without breaking setups)\nhadoop tests are not excluded by default\nNow disabled by default.\nhadoop exclusions aren't setup (causing FLINK-15685)\nAre now setup.\nautomatic java11 exclusion is prone to not working as intended\nThere is now a dedicated java11 profile in flink-end-to-end-tests to ensure the java11 exclusions is always applied.", "createdAt": "2020-01-28T12:51:28Z", "url": "https://github.com/apache/flink/pull/10954", "merged": true, "mergeCommit": {"oid": "d2ea1fcdaca5f81639cbfbc0fc5ef683feb5ec3c"}, "closed": true, "closedAt": "2020-02-06T09:42:57Z", "author": {"login": "zentol"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-k28pAH2gAyMzY3OTk2NDIyOjMwNjA0ODk4OTJiNTNhODdlYWU4YWQ0OGQ4MzdiMWYwNjYxNWU2MDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_fVbMgBqjI5OTQ1Mzk5MTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3060489892b53a87eae8ad48d837b1f06615e602", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/3060489892b53a87eae8ad48d837b1f06615e602", "committedDate": "2020-01-27T22:54:50Z", "message": "[hotfix][travis] Remove outdated activation properties"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwOTY3MjMy", "url": "https://github.com/apache/flink/pull/10954#pullrequestreview-350967232", "createdAt": "2020-01-30T16:34:37Z", "commit": {"oid": "4219501d35f7b13eaf4e3319c321b82211a56ad4"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNjozNDozOFrOFjxrgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNjo0Mjo1OFrOFjx-EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA1ODQzMw==", "bodyText": "Should <e2e.include.org.apache.flink.tests.util.categories.PreCommit>false</e2e.include.org.apache.flink.tests.util.categories.PreCommit> be added here?", "url": "https://github.com/apache/flink/pull/10954#discussion_r373058433", "createdAt": "2020-01-30T16:34:38Z", "author": {"login": "tillrohrmann"}, "path": "flink-end-to-end-tests/pom.xml", "diffHunk": "@@ -35,8 +35,19 @@ under the License.\n \t<name>flink-end-to-end-tests</name>\n \n \t<properties>\n-\t\t<includeE2E>org.apache.flink.tests.util.categories.Dummy</includeE2E>\n-\t\t<excludeE2E></excludeE2E>\n+\t\t<includeE2E/> <!-- keep this empty -->\n+\t\t<excludeE2E/> <!-- keep this empty -->\n+\t\t<!-- functions as a global exclude; required since an empty set of included groups implicitly includes all -->\n+\t\t<includeE2E.default>org.apache.flink.tests.util.categories.Dummy</includeE2E.default>\n+\t\t<!-- default inclusions / exclusions -->\n+\t\t<e2e.include.org.apache.flink.tests.util.categories.TravisGroup1>false</e2e.include.org.apache.flink.tests.util.categories.TravisGroup1>\n+\t\t<e2e.include.org.apache.flink.tests.util.categories.TravisGroup2>false</e2e.include.org.apache.flink.tests.util.categories.TravisGroup2>\n+\t\t<e2e.include.org.apache.flink.tests.util.categories.TravisGroup3>false</e2e.include.org.apache.flink.tests.util.categories.TravisGroup3>\n+\t\t<e2e.include.org.apache.flink.tests.util.categories.TravisGroup4>false</e2e.include.org.apache.flink.tests.util.categories.TravisGroup4>\n+\t\t<e2e.include.org.apache.flink.tests.util.categories.TravisGroup5>false</e2e.include.org.apache.flink.tests.util.categories.TravisGroup5>\n+\t\t<e2e.include.org.apache.flink.tests.util.categories.TravisGroup6>false</e2e.include.org.apache.flink.tests.util.categories.TravisGroup6>\n+\t\t<e2e.exclude.org.apache.flink.tests.util.categories.Hadoop>true</e2e.exclude.org.apache.flink.tests.util.categories.Hadoop>\n+\t\t<e2e.exclude.org.apache.flink.testutils.junit.FailsOnJava11>true</e2e.exclude.org.apache.flink.testutils.junit.FailsOnJava11>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4219501d35f7b13eaf4e3319c321b82211a56ad4"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA2MzE4NQ==", "bodyText": "Do we want to keep these printlns?", "url": "https://github.com/apache/flink/pull/10954#discussion_r373063185", "createdAt": "2020-01-30T16:42:58Z", "author": {"login": "tillrohrmann"}, "path": "flink-end-to-end-tests/pom.xml", "diffHunk": "@@ -90,6 +162,66 @@ under the License.\n \t\t\t\t\t<skip>true</skip>\n \t\t\t\t</configuration>\n \t\t\t</plugin>\n+\t\t\t<plugin>\n+\t\t\t\t<groupId>org.codehaus.gmavenplus</groupId>\n+\t\t\t\t<artifactId>gmavenplus-plugin</artifactId>\n+\t\t\t\t<version>1.8.1</version>\n+\t\t\t\t<dependencies>\n+\t\t\t\t\t<dependency>\n+\t\t\t\t\t\t<groupId>org.codehaus.groovy</groupId>\n+\t\t\t\t\t\t<artifactId>groovy-all</artifactId>\n+\t\t\t\t\t\t<version>2.5.9</version>\n+\t\t\t\t\t\t<scope>runtime</scope>\n+\t\t\t\t\t\t<type>pom</type>\n+\t\t\t\t\t</dependency>\n+\t\t\t\t</dependencies>\n+\t\t\t\t<executions>\n+\t\t\t\t\t<execution>\n+\t\t\t\t\t\t<id>merge-categories</id>\n+\t\t\t\t\t\t<phase>initialize</phase>\n+\t\t\t\t\t\t<goals>\n+\t\t\t\t\t\t\t<goal>execute</goal>\n+\t\t\t\t\t\t</goals>\n+\t\t\t\t\t\t<configuration>\n+\t\t\t\t\t\t\t<scripts>\n+\t\t\t\t\t\t\t\t<script>\n+\t\t\t\t\t\t\t\t\t<![CDATA[\n+\t\t\t\t\t\t\t\t\tdef categorySearcher = { String propertyPrefix ->\n+\t\t\t\t\t\t\t\t\t\tproject.properties.entrySet().stream()\n+\t\t\t\t\t\t\t\t\t\t\t.filter { p -> p.getKey().startsWith(propertyPrefix) }\n+\t\t\t\t\t\t\t\t\t\t\t.filter { p -> p.getValue().toBoolean() }\n+\t\t\t\t\t\t\t\t\t\t\t.map { p -> p.getKey() }\n+\t\t\t\t\t\t\t\t\t\t\t.map { p -> p.substring(propertyPrefix.size(), p.size()) }\n+\t\t\t\t\t\t\t\t\t\t\t.toList()\n+\t\t\t\t\t\t\t\t\t}\n+\n+\t\t\t\t\t\t\t\t\tdef includes = categorySearcher('e2e.include.')\n+\t\t\t\t\t\t\t\t\t// allow overrides from the command-line\n+\t\t\t\t\t\t\t\t\tif (!project.properties.includeE2E.isEmpty()) {\n+\t\t\t\t\t\t\t\t\t\tincludes.add(project.properties.includeE2E)\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\tif (includes.size() > 0) {\n+\t\t\t\t\t\t\t\t\t\tproject.properties.includeE2E = includes.join(',')\n+\t\t\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\t\t\tproject.properties.includeE2E = project.properties.'includeE2E.default'\n+\t\t\t\t\t\t\t\t\t}\n+\n+\t\t\t\t\t\t\t\t\tdef excludes = categorySearcher('e2e.exclude.')\n+\t\t\t\t\t\t\t\t\t// allow overrides from the command-line\n+\t\t\t\t\t\t\t\t\tif (!project.properties.excludeE2E.isEmpty()) {\n+\t\t\t\t\t\t\t\t\t\texcludes.add(project.properties.excludeE2E)\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\tproject.properties.excludeE2E = excludes.join(',')\n+\n+\t\t\t\t\t\t\t\t\tprintln \"includes: \" + project.properties.includeE2E\n+\t\t\t\t\t\t\t\t\tprintln \"excludes: \" + project.properties.excludeE2E", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4219501d35f7b13eaf4e3319c321b82211a56ad4"}, "originalPosition": 146}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "661c05a3de9bba96e7c4442da39d8da81124fa78", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/661c05a3de9bba96e7c4442da39d8da81124fa78", "committedDate": "2020-01-30T19:02:25Z", "message": "[FLINK-15785][travis][e2e] Rework E2E test activations\n\n- consolidate travis activations in .travis.yml\n- introduce dedicated profile for each category to reduce verbosity\n- use gmavenplus-plugin to merge inclusion/exclusions across profiles\n- add java11 profile (i.e., don't rely on exclusion setup in root pom)\n- disable tests with Hadoop category by default\n- add Hadoop activations to e2e profiles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73b8f36264985692b35cf2e2ddb3c619df97d299", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/73b8f36264985692b35cf2e2ddb3c619df97d299", "committedDate": "2020-01-30T19:02:25Z", "message": "[FLINK-15685][e2e] Kafka SQL test requires Hadoop"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a4cdba97fcfbb788402b890e6e958cb2949646b", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/0a4cdba97fcfbb788402b890e6e958cb2949646b", "committedDate": "2020-01-28T12:33:26Z", "message": "[FLINK-15685][e2e] Kafka SQL test requires Hadoop"}, "afterCommit": {"oid": "73b8f36264985692b35cf2e2ddb3c619df97d299", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/73b8f36264985692b35cf2e2ddb3c619df97d299", "committedDate": "2020-01-30T19:02:25Z", "message": "[FLINK-15685][e2e] Kafka SQL test requires Hadoop"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4502, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}