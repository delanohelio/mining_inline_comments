{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1MzA4MjI1", "number": 14160, "title": "[FLINK-19795][table-blink] Fix Flink SQL throws exception when changelog source contains duplicate change events", "bodyText": "What is the purpose of the change\nUsually, CDC tools deliver change events to message queue in an at-least-once semantic. There might be duplicate INSERT/UPDATE/DELETE messages for the same primary key. However, when appling TopN query on this created source table, the TopN operator will thrown exception: Caused by: java.lang.RuntimeException: Can not retract a non-existent record.\nWe introduced a configuration table.exec.source.cdc-events-duplicate=true|false to indicate whether the cdc source produce duplicate messages that require the framework to deduplicate. By default, the value is false (for backward-compatibility). When it is set to true, it requires to set a primary key on the source, and the framework will this the primary key to deduplicate/normalize the changelog (using the ChangelogNormalize operator).\nThis option only take effect on the cdc sources which will produce full changelog, including INSERT/UPDATE_BEFORE/UPDATE_AFTER/DELETE events. So it doesn't affect the upsert sources, because upsert sources always generate a ChangelogNormalize operator after it.\nThis pull request also fixes FLINK-20205 to not send UPDATE_BEFORE messages if the downstream doesn't need it for CDC sources.\nBrief change log\n\nAdd validation if the configuration is enabled but primary key is not defined.\nGenerate ChangelogNormalize node after CDC source if table.exec.source.cdc-events-duplicate=true.\nDrop UPDATE_BEFORE messages for CDC source if downstream doesn't need it, because ChangelogNormalize also doesn't need the before messages.\n\nVerifying this change\n\nAdded plan tests for the configuration is enabled.\nAdded IT cases for the configuration is enabled.\nAdded unit tests for metadata handler tests for the new StreamExecDropUpdateBefore node.\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-11-22T16:18:49Z", "url": "https://github.com/apache/flink/pull/14160", "merged": true, "mergeCommit": {"oid": "6e1b8427451d1ecb7a9bb2839ae834e11bd5e8bf"}, "closed": true, "closedAt": "2020-11-25T13:49:34Z", "author": {"login": "wuchong"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfRKZnAFqTUzNjI2NTI3Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdf5zYgAFqTUzODI0MDkzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MjY1Mjc2", "url": "https://github.com/apache/flink/pull/14160#pullrequestreview-536265276", "createdAt": "2020-11-23T08:48:37Z", "commit": {"oid": "bdea131f32cf7f25237f44e7246e93a219ea1d8d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODo0ODozOFrOH4DwNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODo0ODozOFrOH4DwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU0Mzc5Ng==", "bodyText": "We drop the before messages in the temporal table, therefore, 1,Euro can correlate a value now.", "url": "https://github.com/apache/flink/pull/14160#discussion_r528543796", "createdAt": "2020-11-23T08:48:38Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/stream/sql/TemporalJoinITCase.scala", "diffHunk": "@@ -537,51 +523,35 @@ class TemporalJoinITCase(state: StateBackendMode)\n       \" ON o.currency = r.currency\"\n     tEnv.executeSql(sql).await()\n \n-    val rawResult = getRawResults(\"rowtime_default_sink\")\n     // Note: the event time semantics in delete event is when the delete event happened,\n     // records \"+I(2,US Dollar)\" and \"+I(3,RMB)\" would not correlate the deleted events\n     val expected = List(\n-      \"+I(1,Euro,12,2020-08-15T00:01,null,null)\",\n-      \"+I(2,US Dollar,1,2020-08-15T00:02,null,null)\",\n-      \"+I(3,RMB,40,2020-08-15T00:03,null,null)\",\n-      \"+I(4,Euro,14,2020-08-16T00:04,118,2020-08-16T00:01)\",\n-      \"-U(2,US Dollar,1,2020-08-16T00:03,106,2020-08-16T00:02)\",\n-      \"+U(2,US Dollar,18,2020-08-16T00:03,106,2020-08-16T00:02)\",\n-      \"+I(5,RMB,40,2020-08-16T00:03,null,null)\",\n-      \"+I(6,RMB,40,2020-08-16T00:04,null,null)\",\n-      \"-D(6,RMB,40,2020-08-16T00:04,null,null)\")\n-    assertEquals(expected.sorted, rawResult.sorted)\n+      \"1,Euro,12,2020-08-15T00:01,114,2020-08-15T00:00:01\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdea131f32cf7f25237f44e7246e93a219ea1d8d"}, "originalPosition": 141}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bdea131f32cf7f25237f44e7246e93a219ea1d8d", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/bdea131f32cf7f25237f44e7246e93a219ea1d8d", "committedDate": "2020-11-23T08:46:43Z", "message": "update TemporalJoinITCase"}, "afterCommit": {"oid": "250fae8059b6141ed0bb3e244a522751f20c2e8b", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/250fae8059b6141ed0bb3e244a522751f20c2e8b", "committedDate": "2020-11-23T13:19:16Z", "message": "[FLINK-19795][table-blink] Fix Flink SQL throws exception when changelog source contains duplicate change events"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MTQ5NTEy", "url": "https://github.com/apache/flink/pull/14160#pullrequestreview-538149512", "createdAt": "2020-11-25T04:31:01Z", "commit": {"oid": "af478685f91c3cf99c0553eeddd320bb8c3f4b35"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNDozMTowMlrOH5i0zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNDo0NzozOVrOH5jFvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwMTQ1NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \u5728\u6b63\u5e38\u7684\u64cd\u4f5c\u73af\u5883\u4e0b\uff0cCanal \u5e94\u7528\u80fd\u4ee5 **exactly-once** \u7684\u8bed\u4e49\u6295\u9012\u6bcf\u6761\u53d8\u66f4\u4e8b\u4ef6\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0cFlink \u6d88\u8d39 Canal \u4ea7\u751f\u7684\u53d8\u66f4\u4e8b\u4ef6\u80fd\u591f\u5de5\u4f5c\u5730\u5f88\u597d\u3002\n          \n          \n            \n            \u5728\u6b63\u5e38\u7684\u64cd\u4f5c\u73af\u5883\u4e0b\uff0cCanal \u5e94\u7528\u80fd\u4ee5 **exactly-once** \u7684\u8bed\u4e49\u6295\u9012\u6bcf\u6761\u53d8\u66f4\u4e8b\u4ef6\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0cFlink \u6d88\u8d39 Canal \u4ea7\u751f\u7684\u53d8\u66f4\u4e8b\u4ef6\u80fd\u591f\u5de5\u4f5c\u5f97\u5f88\u597d\u3002", "url": "https://github.com/apache/flink/pull/14160#discussion_r530101454", "createdAt": "2020-11-25T04:31:02Z", "author": {"login": "leonardBang"}, "path": "docs/dev/table/connectors/formats/canal.zh.md", "diffHunk": "@@ -219,6 +219,17 @@ Format \u53c2\u6570\n     </tbody>\n </table>\n \n+\u6ce8\u610f\u4e8b\u9879\n+----------------\n+\n+### \u91cd\u590d\u7684\u53d8\u66f4\u4e8b\u4ef6\n+\n+\u5728\u6b63\u5e38\u7684\u64cd\u4f5c\u73af\u5883\u4e0b\uff0cCanal \u5e94\u7528\u80fd\u4ee5 **exactly-once** \u7684\u8bed\u4e49\u6295\u9012\u6bcf\u6761\u53d8\u66f4\u4e8b\u4ef6\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0cFlink \u6d88\u8d39 Canal \u4ea7\u751f\u7684\u53d8\u66f4\u4e8b\u4ef6\u80fd\u591f\u5de5\u4f5c\u5730\u5f88\u597d\u3002", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af478685f91c3cf99c0553eeddd320bb8c3f4b35"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwMTk2Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Under normal operating scenarios, the Debezium application delivers every change event **exactly-once**. This works pretty well when Flink consumes Debezium produced events in this situation.\n          \n          \n            \n            Under normal operating scenarios, the Debezium application delivers every change event **exactly-once**. Flink works pretty well when consumes Debezium produced events in this situation.", "url": "https://github.com/apache/flink/pull/14160#discussion_r530101963", "createdAt": "2020-11-25T04:33:17Z", "author": {"login": "leonardBang"}, "path": "docs/dev/table/connectors/formats/debezium.md", "diffHunk": "@@ -282,6 +282,14 @@ Use format `debezium-avro-confluent` to interpret Debezium Avro messages and for\n Caveats\n ----------------\n \n+### Duplicate change events\n+\n+Under normal operating scenarios, the Debezium application delivers every change event **exactly-once**. This works pretty well when Flink consumes Debezium produced events in this situation.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af478685f91c3cf99c0553eeddd320bb8c3f4b35"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwNDYwNQ==", "bodyText": "The condition!changelogMode.containsOnly(RowKind.INSERT) does not indicate the source is a CDC source which is non-upsert", "url": "https://github.com/apache/flink/pull/14160#discussion_r530104605", "createdAt": "2020-11-25T04:43:01Z", "author": {"login": "leonardBang"}, "path": "flink-table/flink-table-planner-blink/src/main/java/org/apache/flink/table/planner/sources/DynamicSourceUtils.java", "diffHunk": "@@ -267,6 +302,20 @@ private static void validateScanSourceForStreaming(\n \t\t\t\t\tscanSource.getClass().getName()\n \t\t\t\t)\n \t\t\t);\n+\t\t} else if (!changelogMode.containsOnly(RowKind.INSERT)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af478685f91c3cf99c0553eeddd320bb8c3f4b35"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwNTc5MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  \"1,Euro,12,2020-08-15T00:01,114,2020-08-15T00:00:01\",\n          \n          \n            \n                  \"3,RMB,40,2020-08-15T00:03,702,2020-08-15T00:00:04\",\n          \n          \n            \n                  \"4,Euro,14,2020-08-16T00:04,118,2020-08-16T00:01\",\n          \n          \n            \n                  \"2,US Dollar,18,2020-08-16T00:03,106,2020-08-16T00:02\")\n          \n          \n            \n                  \"1,Euro,12,2020-08-15T00:01,114,2020-08-15T00:00:01\",\n          \n          \n            \n                  \"2,US Dollar,18,2020-08-16T00:03,106,2020-08-16T00:02\",\n          \n          \n            \n                  \"3,RMB,40,2020-08-15T00:03,702,2020-08-15T00:00:04\",\n          \n          \n            \n                  \"4,Euro,14,2020-08-16T00:04,118,2020-08-16T00:01\")\n          \n      \n    \n    \n  \n\nminor\uff1a we can give a more readable order that is same as the left table input.", "url": "https://github.com/apache/flink/pull/14160#discussion_r530105790", "createdAt": "2020-11-25T04:47:39Z", "author": {"login": "leonardBang"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/stream/sql/TemporalJoinITCase.scala", "diffHunk": "@@ -455,15 +455,12 @@ class TemporalJoinITCase(state: StateBackendMode)\n       \" ON o.currency = r.currency\"\n \n     tEnv.executeSql(sql).await()\n-    val rawResult = getRawResults(\"rowtime_default_sink\")\n     val expected = List(\n-      \"+I(1,Euro,12,2020-08-15T00:01,114,2020-08-15T00:00:01)\",\n-      \"+I(2,US Dollar,1,2020-08-15T00:02,102,2020-08-15T00:00:02)\",\n-      \"+I(3,RMB,40,2020-08-15T00:03,702,2020-08-15T00:00:04)\",\n-      \"+I(4,Euro,14,2020-08-16T00:04,118,2020-08-16T00:01)\",\n-      \"-U(2,US Dollar,1,2020-08-16T00:03,106,2020-08-16T00:02)\",\n-      \"+U(2,US Dollar,18,2020-08-16T00:03,106,2020-08-16T00:02)\")\n-    assertEquals(expected.sorted, rawResult.sorted)\n+      \"1,Euro,12,2020-08-15T00:01,114,2020-08-15T00:00:01\",\n+      \"3,RMB,40,2020-08-15T00:03,702,2020-08-15T00:00:04\",\n+      \"4,Euro,14,2020-08-16T00:04,118,2020-08-16T00:01\",\n+      \"2,US Dollar,18,2020-08-16T00:03,106,2020-08-16T00:02\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af478685f91c3cf99c0553eeddd320bb8c3f4b35"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5507e70adece61819ef8e20e7333be58e460c6b2", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/5507e70adece61819ef8e20e7333be58e460c6b2", "committedDate": "2020-11-25T07:25:54Z", "message": "[hotfix][docs] Update YARN config docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ee27f0eff7494ea4a75f20f3a2309132af341bc", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/2ee27f0eff7494ea4a75f20f3a2309132af341bc", "committedDate": "2020-11-25T07:25:54Z", "message": "[hotfix][table-planner-blink] Enable idle state cleanup for ChangelogNormalize operator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b67c5115a88afff62c32307f8cfe7210dd10d646", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/b67c5115a88afff62c32307f8cfe7210dd10d646", "committedDate": "2020-11-25T07:25:57Z", "message": "[FLINK-19795][table-blink] Fix Flink SQL throws exception when changelog source contains duplicate change events\n\nThis closes #14160\n\nfixup docs\n\naddress review comments.\n\nupdate comment\n\nfix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b9ebebcf46ca6bd618fec1cc430907f029701c0", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/2b9ebebcf46ca6bd618fec1cc430907f029701c0", "committedDate": "2020-11-25T07:16:41Z", "message": "update comment"}, "afterCommit": {"oid": "b67c5115a88afff62c32307f8cfe7210dd10d646", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/b67c5115a88afff62c32307f8cfe7210dd10d646", "committedDate": "2020-11-25T07:25:57Z", "message": "[FLINK-19795][table-blink] Fix Flink SQL throws exception when changelog source contains duplicate change events\n\nThis closes #14160\n\nfixup docs\n\naddress review comments.\n\nupdate comment\n\nfix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MjQwOTM1", "url": "https://github.com/apache/flink/pull/14160#pullrequestreview-538240935", "createdAt": "2020-11-25T08:09:36Z", "commit": {"oid": "b67c5115a88afff62c32307f8cfe7210dd10d646"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4027, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}