{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4Njk1MTQ4", "number": 13321, "title": "[FLINK-14870] Remove nullable assumption of task slot sharing group", "bodyText": "What is the purpose of the change\nThis PR is to remove the nullable assumption of task slot sharing group.\nAnd as a result it also removes the single logical slot allocation code path which is not used anymore.\nIt can decrease the maintenance burden and the complexity to develop the scheduler, including pipelined\nregion scheduler and declarative scheduler.\nVerifying this change\nThis change is already covered by existing tests, such as (please describe tests).\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-09-03T15:01:03Z", "url": "https://github.com/apache/flink/pull/13321", "merged": true, "mergeCommit": {"oid": "bfc92189ef0fdacd749ca9a5282a49bd10b07bd5"}, "closed": true, "closedAt": "2020-09-10T08:57:16Z", "author": {"login": "zhuzhurk"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdF6Kg1ABqjM3MzI5NzExMDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHcrM1AFqTQ4NTcxMDA3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bcd04d78e47e1c3a9b0cb0165d625f424dea4951", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/bcd04d78e47e1c3a9b0cb0165d625f424dea4951", "committedDate": "2020-09-04T07:35:04Z", "message": "Fixup! [FLINK-14870][runtime] Drop the nullable assumption of JobVertex slot sharing group"}, "afterCommit": {"oid": "4e21b1f0db7493be16bcae0565beafa14e913cc9", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/4e21b1f0db7493be16bcae0565beafa14e913cc9", "committedDate": "2020-09-05T13:52:23Z", "message": "[FLINK-14870][runtime] Drop the nullable assumption of slot sharing group in ScheduledUnit and remove the consequently unused methods in SchedulerImpl"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e21b1f0db7493be16bcae0565beafa14e913cc9", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/4e21b1f0db7493be16bcae0565beafa14e913cc9", "committedDate": "2020-09-05T13:52:23Z", "message": "[FLINK-14870][runtime] Drop the nullable assumption of slot sharing group in ScheduledUnit and remove the consequently unused methods in SchedulerImpl"}, "afterCommit": {"oid": "96e983d10c7095847b404461abd01b4d1ebb0aac", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/96e983d10c7095847b404461abd01b4d1ebb0aac", "committedDate": "2020-09-07T10:01:06Z", "message": "[FLINK-14870][runtime] Drop the nullable assumption of slot sharing group in ScheduledUnit and remove the consequently unused methods in SchedulerImpl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MjI0MDg4", "url": "https://github.com/apache/flink/pull/13321#pullrequestreview-484224088", "createdAt": "2020-09-08T14:54:37Z", "commit": {"oid": "d25691da795ac975151e7021120f7f7a734bc902"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNDo1NDozN1rOHOhHbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTowNzoyMFrOHOhw4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk4NDY4Nw==", "bodyText": "Maybe Releasing TaskManager in SlotPool for tests?", "url": "https://github.com/apache/flink/pull/13321#discussion_r484984687", "createdAt": "2020-09-08T14:54:37Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmanager/scheduler/SchedulerTestBase.java", "diffHunk": "@@ -161,7 +161,7 @@ public TaskManagerLocation addTaskManager(int numberSlots) {\n \n \t\tpublic void releaseTaskManager(ResourceID resourceId) {\n \t\t\ttry {\n-\t\t\t\tsupplyInMainThreadExecutor(() -> slotPool.releaseTaskManager(resourceId, null));\n+\t\t\t\tsupplyInMainThreadExecutor(() -> slotPool.releaseTaskManager(resourceId, new Exception(\"Test Exception\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d25691da795ac975151e7021120f7f7a734bc902"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk4NzgyNQ==", "bodyText": "is it a lot of effort to fix this in tests so that we can remove this check?", "url": "https://github.com/apache/flink/pull/13321#discussion_r484987825", "createdAt": "2020-09-08T14:57:37Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/jobgraph/JobVertex.java", "diffHunk": "@@ -364,25 +365,29 @@ public void addOperatorCoordinator(SerializedValue<OperatorCoordinator.Provider>\n \t * @param grp The slot sharing group to associate the vertex with.\n \t */\n \tpublic void setSlotSharingGroup(SlotSharingGroup grp) {\n+\t\tcheckNotNull(grp);\n+\n \t\tif (this.slotSharingGroup != null) {\n \t\t\tthis.slotSharingGroup.removeVertexFromGroup(this.getID(), this.getMinResources());\n \t\t}\n \n+\t\tgrp.addVertexToGroup(this.getID(), this.getMinResources());\n \t\tthis.slotSharingGroup = grp;\n-\t\tif (grp != null) {\n-\t\t\tgrp.addVertexToGroup(this.getID(), this.getMinResources());\n-\t\t}\n \t}\n \n \t/**\n \t * Gets the slot sharing group that this vertex is associated with. Different vertices in the same\n-\t * slot sharing group can run one subtask each in the same slot. If the vertex is not associated with\n-\t * a slot sharing group, this method returns {@code null}.\n+\t * slot sharing group can run one subtask each in the same slot.\n \t *\n-\t * @return The slot sharing group to associate the vertex with, or {@code null}, if not associated with one.\n+\t * @return The slot sharing group to associate the vertex with\n \t */\n-\t@Nullable\n \tpublic SlotSharingGroup getSlotSharingGroup() {\n+\t\tif (slotSharingGroup == null) {\n+\t\t\t// create a new slot sharing group for this vertex if it was in no other slot sharing group.\n+\t\t\t// this should only happen in testing cases at the moment because production code path will\n+\t\t\t// always set a value to it before used", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdf61a096142909d16c02adea86b0f6b3dac76e0"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk5NDI2NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tprivate ExecutionVertexSchedulingRequirements createSchedulingRequirement(\n          \n          \n            \n            \t\t\tfinal ExecutionVertexID executionVertexId) {\n          \n          \n            \n            \t\treturn createSchedulingRequirement(executionVertexId, null);\n          \n          \n            \n            \t}\n          \n          \n            \n            \tprivate ExecutionVertexSchedulingRequirements createSchedulingRequirement(\n          \n          \n            \n            \t\t\tfinal int subtaskIndex) {\n          \n          \n            \n            \t\treturn createSchedulingRequirement(new ExecutionVertexID(new JobVertexID(), subtaskIndex), null);\n          \n          \n            \n            \t}", "url": "https://github.com/apache/flink/pull/13321#discussion_r484994264", "createdAt": "2020-09-08T15:05:46Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/scheduler/AbstractExecutionSlotAllocatorTest.java", "diffHunk": "@@ -114,38 +118,30 @@ public void testCompletedExecutionVertexAssignmentWillBeUnregistered() {\n \tpublic void testComputeAllPriorAllocationIds() {\n \t\tfinal List<AllocationID> expectAllocationIds = Arrays.asList(new AllocationID(), new AllocationID());\n \t\tfinal List<ExecutionVertexSchedulingRequirements> testSchedulingRequirements = Arrays.asList(\n-\t\t\tnew ExecutionVertexSchedulingRequirements.Builder().\n-\t\t\t\twithExecutionVertexId(new ExecutionVertexID(new JobVertexID(), 0)).\n-\t\t\t\twithPreviousAllocationId(expectAllocationIds.get(0)).\n-\t\t\t\tbuild(),\n-\t\t\tnew ExecutionVertexSchedulingRequirements.Builder().\n-\t\t\t\twithExecutionVertexId(new ExecutionVertexID(new JobVertexID(), 1)).\n-\t\t\t\twithPreviousAllocationId(expectAllocationIds.get(0)).\n-\t\t\t\tbuild(),\n-\t\t\tnew ExecutionVertexSchedulingRequirements.Builder().\n-\t\t\t\twithExecutionVertexId(new ExecutionVertexID(new JobVertexID(), 2)).\n-\t\t\t\twithPreviousAllocationId(expectAllocationIds.get(1)).\n-\t\t\t\tbuild(),\n-\t\t\tnew ExecutionVertexSchedulingRequirements.Builder().\n-\t\t\t\twithExecutionVertexId(new ExecutionVertexID(new JobVertexID(), 3)).\n-\t\t\t\tbuild()\n+\t\t\tcreateSchedulingRequirement(new ExecutionVertexID(new JobVertexID(), 0), expectAllocationIds.get(0)),\n+\t\t\tcreateSchedulingRequirement(new ExecutionVertexID(new JobVertexID(), 1), expectAllocationIds.get(0)),\n+\t\t\tcreateSchedulingRequirement(new ExecutionVertexID(new JobVertexID(), 2), expectAllocationIds.get(1)),\n+\t\t\tcreateSchedulingRequirement(new ExecutionVertexID(new JobVertexID(), 3))\n \t\t);\n \n \t\tfinal Set<AllocationID> allPriorAllocationIds =\n \t\t\tAbstractExecutionSlotAllocator.computeAllPriorAllocationIds(testSchedulingRequirements);\n \t\tassertThat(allPriorAllocationIds, containsInAnyOrder(expectAllocationIds.toArray()));\n \t}\n \n-\tprivate List<ExecutionVertexSchedulingRequirements> createSchedulingRequirements(\n-\t\t\tfinal ExecutionVertexID... executionVertexIds) {\n-\n-\t\tfinal List<ExecutionVertexSchedulingRequirements> schedulingRequirements = new ArrayList<>(executionVertexIds.length);\n+\tprivate ExecutionVertexSchedulingRequirements createSchedulingRequirement(\n+\t\t\tfinal ExecutionVertexID executionVertexId) {\n+\t\treturn createSchedulingRequirement(executionVertexId, null);\n+\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4d7c975180ec4cf13537d67ebcd8fe63ed41525"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk5NTI5OA==", "bodyText": "why not to add new SlotSharingGroupId() as a default value of slotSharingGroupId in ExecutionVertexSchedulingRequirements.Builder?", "url": "https://github.com/apache/flink/pull/13321#discussion_r484995298", "createdAt": "2020-09-08T15:07:20Z", "author": {"login": "azagrebin"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/scheduler/OneSlotPerExecutionSlotAllocatorTest.java", "diffHunk": "@@ -224,6 +224,7 @@ public void testCoLocationConstraintThrowsException() {\n \t\tfinal List<ExecutionVertexSchedulingRequirements> schedulingRequirements = Collections.singletonList(\n \t\t\tnew ExecutionVertexSchedulingRequirements.Builder()\n \t\t\t\t.withExecutionVertexId(new ExecutionVertexID(new JobVertexID(), 0))\n+\t\t\t\t.withSlotSharingGroupId(new SlotSharingGroupId())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4d7c975180ec4cf13537d67ebcd8fe63ed41525"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "96e983d10c7095847b404461abd01b4d1ebb0aac", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/96e983d10c7095847b404461abd01b4d1ebb0aac", "committedDate": "2020-09-07T10:01:06Z", "message": "[FLINK-14870][runtime] Drop the nullable assumption of slot sharing group in ScheduledUnit and remove the consequently unused methods in SchedulerImpl"}, "afterCommit": {"oid": "181e73983ad41f287d91792136d13c59b2ea037d", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/181e73983ad41f287d91792136d13c59b2ea037d", "committedDate": "2020-09-08T16:46:58Z", "message": "[FLINK-14870][runtime] Drop the nullable assumption of slot sharing group in ScheduledUnit and remove the consequently unused methods in SchedulerImpl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9403799a039e2852d8c4395b648c8d7ee9b2038", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/d9403799a039e2852d8c4395b648c8d7ee9b2038", "committedDate": "2020-09-09T08:10:42Z", "message": "[hotfix][runtime] Add missing Nullable annotations to vertex colocation group"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "405cc6eabf58596d9e5f3911505584d74b58e2d3", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/405cc6eabf58596d9e5f3911505584d74b58e2d3", "committedDate": "2020-09-09T08:10:43Z", "message": "[FLINK-14870][runtime] Ensure JobVertex slot sharing group to be non-null when created from a StreamNode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e15ce0f14f62be17d6f0ec713809f84168f1ad66", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/e15ce0f14f62be17d6f0ec713809f84168f1ad66", "committedDate": "2020-09-09T08:10:43Z", "message": "[hotfix][runtime] Close SlotPool in main thread\n\nOtherwise main thread check violation can happen if the SlotPool#close() triggers SlotPool#releaseSlot()."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cce99904e9eeb759ac34f3cdb21d33cf28de94f9", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/cce99904e9eeb759ac34f3cdb21d33cf28de94f9", "committedDate": "2020-09-09T08:10:43Z", "message": "[hotfix][runtime] Always invoke SlotPool#releaseTaskManager() with a non-null error\n\nThe error will be used to complete futures exceptionally. A null error can cause unexpected NullPointerException."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9ae2af7bf59a37c592b3dcdb246f0825129074c", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/f9ae2af7bf59a37c592b3dcdb246f0825129074c", "committedDate": "2020-09-09T08:10:43Z", "message": "[FLINK-14870][runtime] Drop the nullable assumption of JobVertex slot sharing group"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cba7e88c3f7cb390b82d6ad264575f951397ab6", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/1cba7e88c3f7cb390b82d6ad264575f951397ab6", "committedDate": "2020-09-09T08:14:52Z", "message": "[FLINK-14870][runtime] Drop the nullable assumption of slot sharing group in scheduler components"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b49791a2ae6a03e80105f12cd6d49fd6fdbe2b64", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/b49791a2ae6a03e80105f12cd6d49fd6fdbe2b64", "committedDate": "2020-09-09T08:14:53Z", "message": "[FLINK-14870][runtime] Drop the nullable assumption of slot sharing group in ScheduledUnit and remove the consequently unused methods in SchedulerImpl"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "181e73983ad41f287d91792136d13c59b2ea037d", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/181e73983ad41f287d91792136d13c59b2ea037d", "committedDate": "2020-09-08T16:46:58Z", "message": "[FLINK-14870][runtime] Drop the nullable assumption of slot sharing group in ScheduledUnit and remove the consequently unused methods in SchedulerImpl"}, "afterCommit": {"oid": "b49791a2ae6a03e80105f12cd6d49fd6fdbe2b64", "author": {"user": {"login": "zhuzhurk", "name": "Zhu Zhu"}}, "url": "https://github.com/apache/flink/commit/b49791a2ae6a03e80105f12cd6d49fd6fdbe2b64", "committedDate": "2020-09-09T08:14:53Z", "message": "[FLINK-14870][runtime] Drop the nullable assumption of slot sharing group in ScheduledUnit and remove the consequently unused methods in SchedulerImpl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NzEwMDc3", "url": "https://github.com/apache/flink/pull/13321#pullrequestreview-485710077", "createdAt": "2020-09-10T08:39:14Z", "commit": {"oid": "b49791a2ae6a03e80105f12cd6d49fd6fdbe2b64"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4434, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}