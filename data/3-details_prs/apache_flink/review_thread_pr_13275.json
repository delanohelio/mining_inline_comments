{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1MjQ5NDg5", "number": 13275, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNzo1NDowN1rOEhIDrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwOToyOTowNVrOEk4_Qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMTcwNDc5OnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-hbase/src/test/java/org/apache/flink/connector/hbase/HBaseTableInputFormatTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNzo1NDowN1rOHORFUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNzo1NDowN1rOHORFUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcyMjAwMA==", "bodyText": "1.HBaseTestBase will pull up a HBase cluster which is a heavy action.\nwe can move this test to HBaseConnectorITCase avoid pulling up the cluster twice.", "url": "https://github.com/apache/flink/pull/13275#discussion_r484722000", "createdAt": "2020-09-08T07:54:07Z", "author": {"login": "leonardBang"}, "path": "flink-connectors/flink-connector-hbase/src/test/java/org/apache/flink/connector/hbase/HBaseTableInputFormatTest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.connector.hbase;\n+\n+import org.apache.flink.connector.hbase.source.HBaseRowInputFormat;\n+import org.apache.flink.connector.hbase.source.TableInputSplit;\n+import org.apache.flink.connector.hbase.util.HBaseTableSchema;\n+import org.apache.flink.connector.hbase.util.HBaseTestBase;\n+import org.apache.flink.connector.hbase.util.PlannerType;\n+\n+import org.apache.hadoop.hbase.TableName;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertNull;\n+\n+/**\n+ * Test case for {@link HBaseRowInputFormat} table input format.\n+ */\n+public class HBaseTableInputFormatTest extends HBaseTestBase {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ac3764e017be069dd2eae07e893a0c8cad40e4"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMTcwNzkwOnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-hbase/src/test/java/org/apache/flink/connector/hbase/HBaseTableInputFormatTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNzo1NDo1OFrOHORHSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNzo1NDo1OFrOHORHSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcyMjUwNA==", "bodyText": "2.HBaseRowInputFormat is used by legacy connector, HBaseRowDataInputFormat is used by new connector,\nwe can cover them in HBaseConnectorITCase via parameterized parameter 'isLegacyConnector' easily", "url": "https://github.com/apache/flink/pull/13275#discussion_r484722504", "createdAt": "2020-09-08T07:54:58Z", "author": {"login": "leonardBang"}, "path": "flink-connectors/flink-connector-hbase/src/test/java/org/apache/flink/connector/hbase/HBaseTableInputFormatTest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.connector.hbase;\n+\n+import org.apache.flink.connector.hbase.source.HBaseRowInputFormat;\n+import org.apache.flink.connector.hbase.source.TableInputSplit;\n+import org.apache.flink.connector.hbase.util.HBaseTableSchema;\n+import org.apache.flink.connector.hbase.util.HBaseTestBase;\n+import org.apache.flink.connector.hbase.util.PlannerType;\n+\n+import org.apache.hadoop.hbase.TableName;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertNull;\n+\n+/**\n+ * Test case for {@link HBaseRowInputFormat} table input format.\n+ */\n+public class HBaseTableInputFormatTest extends HBaseTestBase {\n+\n+\tprotected PlannerType planner() {\n+\t\treturn PlannerType.BLINK_PLANNER;\n+\t}\n+\n+\t@Test\n+\tpublic void testOpenClose() throws IOException {\n+\t\tHBaseTableSchema tableSchema = new HBaseTableSchema();\n+\t\ttableSchema.addColumn(FAMILY1, F1COL1, byte[].class);\n+\t\tHBaseRowInputFormat inputFormat = new HBaseRowInputFormat(getConf(), TEST_TABLE_1, tableSchema);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ac3764e017be069dd2eae07e893a0c8cad40e4"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTY0NDY2OnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/TableInputSplit.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNDozMzowNVrOHO2RpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwODozOTozOVrOHTXnSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMzMTM2NQ==", "bodyText": "We don't need to declare it public.", "url": "https://github.com/apache/flink/pull/13275#discussion_r485331365", "createdAt": "2020-09-09T04:33:05Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/TableInputSplit.java", "diffHunk": "@@ -26,7 +26,7 @@\n  * references to row below refer to the key of the row.\n  */\n @Internal\n-class TableInputSplit extends LocatableInputSplit {\n+public class TableInputSplit extends LocatableInputSplit {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA3MTg4Mg==", "bodyText": "@wuchong I have already removed this declaration.", "url": "https://github.com/apache/flink/pull/13275#discussion_r490071882", "createdAt": "2020-09-17T08:39:39Z", "author": {"login": "SteNicholas"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/TableInputSplit.java", "diffHunk": "@@ -26,7 +26,7 @@\n  * references to row below refer to the key of the row.\n  */\n @Internal\n-class TableInputSplit extends LocatableInputSplit {\n+public class TableInputSplit extends LocatableInputSplit {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMzMTM2NQ=="}, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTY1MDExOnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNDozNjoxNlrOHO2Uyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwODozNTo1NlrOHTXeAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMzMjE3MQ==", "bodyText": "This is never closed ?", "url": "https://github.com/apache/flink/pull/13275#discussion_r485332171", "createdAt": "2020-09-09T04:36:16Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -186,24 +193,22 @@ public void close() throws IOException {\n \t\t\tif (resultScanner != null) {\n \t\t\t\tresultScanner.close();\n \t\t\t}\n-\t\t} finally {\n-\t\t\tresultScanner = null;\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void closeInputFormat() throws IOException {\n-\t\ttry {\n \t\t\tif (table != null) {\n \t\t\t\ttable.close();\n \t\t\t}\n+\t\t\tif (connection != null) {\n+\t\t\t\tconnection.close();\n+\t\t\t}\n \t\t} finally {\n+\t\t\tresultScanner = null;\n \t\t\ttable = null;\n+\t\t\tconnection = null;\n \t\t}\n \t}\n \n \t@Override\n \tpublic TableInputSplit[] createInputSplits(final int minNumSplits) throws IOException {\n+\t\tinitTable();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMzNzY4NA==", "bodyText": "This is never closed ?\n\n@wuchong This is closed when calling close method. I thought that in the lifecycle, createInputSplits would be called before close. Therefore, I didn't close the connection and table.", "url": "https://github.com/apache/flink/pull/13275#discussion_r485337684", "createdAt": "2020-09-09T04:55:51Z", "author": {"login": "SteNicholas"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -186,24 +193,22 @@ public void close() throws IOException {\n \t\t\tif (resultScanner != null) {\n \t\t\t\tresultScanner.close();\n \t\t\t}\n-\t\t} finally {\n-\t\t\tresultScanner = null;\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void closeInputFormat() throws IOException {\n-\t\ttry {\n \t\t\tif (table != null) {\n \t\t\t\ttable.close();\n \t\t\t}\n+\t\t\tif (connection != null) {\n+\t\t\t\tconnection.close();\n+\t\t\t}\n \t\t} finally {\n+\t\t\tresultScanner = null;\n \t\t\ttable = null;\n+\t\t\tconnection = null;\n \t\t}\n \t}\n \n \t@Override\n \tpublic TableInputSplit[] createInputSplits(final int minNumSplits) throws IOException {\n+\t\tinitTable();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMzMjE3MQ=="}, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM1MDIxNw==", "bodyText": "I think it is called on the JobMaster, so we should use a local connection and close the connection in the method.", "url": "https://github.com/apache/flink/pull/13275#discussion_r485350217", "createdAt": "2020-09-09T05:39:47Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -186,24 +193,22 @@ public void close() throws IOException {\n \t\t\tif (resultScanner != null) {\n \t\t\t\tresultScanner.close();\n \t\t\t}\n-\t\t} finally {\n-\t\t\tresultScanner = null;\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void closeInputFormat() throws IOException {\n-\t\ttry {\n \t\t\tif (table != null) {\n \t\t\t\ttable.close();\n \t\t\t}\n+\t\t\tif (connection != null) {\n+\t\t\t\tconnection.close();\n+\t\t\t}\n \t\t} finally {\n+\t\t\tresultScanner = null;\n \t\t\ttable = null;\n+\t\t\tconnection = null;\n \t\t}\n \t}\n \n \t@Override\n \tpublic TableInputSplit[] createInputSplits(final int minNumSplits) throws IOException {\n+\t\tinitTable();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMzMjE3MQ=="}, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA2OTUwNQ==", "bodyText": "@wuchong I thought that table isn't close in this method, therefore the connection should not be closed in this method.", "url": "https://github.com/apache/flink/pull/13275#discussion_r490069505", "createdAt": "2020-09-17T08:35:56Z", "author": {"login": "SteNicholas"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -186,24 +193,22 @@ public void close() throws IOException {\n \t\t\tif (resultScanner != null) {\n \t\t\t\tresultScanner.close();\n \t\t\t}\n-\t\t} finally {\n-\t\t\tresultScanner = null;\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void closeInputFormat() throws IOException {\n-\t\ttry {\n \t\t\tif (table != null) {\n \t\t\t\ttable.close();\n \t\t\t}\n+\t\t\tif (connection != null) {\n+\t\t\t\tconnection.close();\n+\t\t\t}\n \t\t} finally {\n+\t\t\tresultScanner = null;\n \t\t\ttable = null;\n+\t\t\tconnection = null;\n \t\t}\n \t}\n \n \t@Override\n \tpublic TableInputSplit[] createInputSplits(final int minNumSplits) throws IOException {\n+\t\tinitTable();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMzMjE3MQ=="}, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTg1NDI3OnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNjoxNjoyMVrOHO4LsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNjoxNjoyMVrOHO4LsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM2MjYwOQ==", "bodyText": "I believe this (and below) exception messages are not correct anymore.", "url": "https://github.com/apache/flink/pull/13275#discussion_r485362609", "createdAt": "2020-09-09T06:16:21Z", "author": {"login": "rmetzger"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -94,25 +102,24 @@ public AbstractTableInputFormat(org.apache.hadoop.conf.Configuration hConf) {\n \t */\n \tprotected abstract T mapResultToOutType(Result r);\n \n-\t/**\n-\t * Creates a {@link Scan} object and opens the {@link HTable} connection.\n-\t *\n-\t * <p>These are opened here because they are needed in the createInputSplits\n-\t * which is called before the openInputFormat method.\n-\t *\n-\t * <p>The connection is opened in this method and closed in {@link #closeInputFormat()}.\n-\t *\n-\t * @param parameters The configuration that is to be used\n-\t * @see Configuration\n-\t */\n-\tpublic abstract void configure(Configuration parameters);\n+\t@Override\n+\tpublic void configure(Configuration parameters) {\n+\t}\n \n \tprotected org.apache.hadoop.conf.Configuration getHadoopConfiguration() {\n \t\treturn HBaseConfigurationUtil.deserializeConfiguration(serializedConfig, HBaseConfigurationUtil.getHBaseConfiguration());\n \t}\n \n+\t/**\n+\t * Creates a {@link Scan} object and opens the {@link HTable} connection.\n+\t * The connection is opened in this method and closed in {@link #close()}.\n+\t *\n+\t * @param split The split to be opened.\n+\t * @throws IOException Thrown, if the spit could not be opened due to an I/O problem.\n+\t */\n \t@Override\n \tpublic void open(TableInputSplit split) throws IOException {\n+\t\tinitTable();\n \t\tif (table == null) {\n \t\t\tthrow new IOException(\"The HBase table has not been opened! \" +\n \t\t\t\t\"This needs to be done in configure().\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTg1ODM1OnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNjoxODowOFrOHO4OLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNjoxODowOFrOHO4OLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM2MzI0NA==", "bodyText": "Revisit exception message.", "url": "https://github.com/apache/flink/pull/13275#discussion_r485363244", "createdAt": "2020-09-09T06:18:08Z", "author": {"login": "rmetzger"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -186,24 +193,22 @@ public void close() throws IOException {\n \t\t\tif (resultScanner != null) {\n \t\t\t\tresultScanner.close();\n \t\t\t}\n-\t\t} finally {\n-\t\t\tresultScanner = null;\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void closeInputFormat() throws IOException {\n-\t\ttry {\n \t\t\tif (table != null) {\n \t\t\t\ttable.close();\n \t\t\t}\n+\t\t\tif (connection != null) {\n+\t\t\t\tconnection.close();\n+\t\t\t}\n \t\t} finally {\n+\t\t\tresultScanner = null;\n \t\t\ttable = null;\n+\t\t\tconnection = null;\n \t\t}\n \t}\n \n \t@Override\n \tpublic TableInputSplit[] createInputSplits(final int minNumSplits) throws IOException {\n+\t\tinitTable();\n \t\tif (table == null) {\n \t\t\tthrow new IOException(\"The HBase table has not been opened! \" +\n \t\t\t\t\"This needs to be done in configure().\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 112}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTg3OTk0OnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNjoyNTo1M1rOHO4a9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwODo0Mjo0NVrOHTXu9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM2NjUxOQ==", "bodyText": "We will leak the connection if table.close() or resultScanner.close() fails with an exception.\nI believe the proper way would be to wrap each close in a separate try block, and catch and log the error.", "url": "https://github.com/apache/flink/pull/13275#discussion_r485366519", "createdAt": "2020-09-09T06:25:53Z", "author": {"login": "rmetzger"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -186,24 +193,22 @@ public void close() throws IOException {\n \t\t\tif (resultScanner != null) {\n \t\t\t\tresultScanner.close();\n \t\t\t}\n-\t\t} finally {\n-\t\t\tresultScanner = null;\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void closeInputFormat() throws IOException {\n-\t\ttry {\n \t\t\tif (table != null) {\n \t\t\t\ttable.close();\n \t\t\t}\n+\t\t\tif (connection != null) {\n+\t\t\t\tconnection.close();\n+\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA3Mzg0NA==", "bodyText": "@rmetzger You are right, but resultScanner.close() doesn't throw exception. Therefore, I just add the close of the connection into catch block.", "url": "https://github.com/apache/flink/pull/13275#discussion_r490073844", "createdAt": "2020-09-17T08:42:45Z", "author": {"login": "SteNicholas"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -186,24 +193,22 @@ public void close() throws IOException {\n \t\t\tif (resultScanner != null) {\n \t\t\t\tresultScanner.close();\n \t\t\t}\n-\t\t} finally {\n-\t\t\tresultScanner = null;\n-\t\t}\n-\t}\n-\n-\t@Override\n-\tpublic void closeInputFormat() throws IOException {\n-\t\ttry {\n \t\t\tif (table != null) {\n \t\t\t\ttable.close();\n \t\t\t}\n+\t\t\tif (connection != null) {\n+\t\t\t\tconnection.close();\n+\t\t\t}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM2NjUxOQ=="}, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 99}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTg4OTgyOnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNjoyOToyN1rOHO4gpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwODo0MDo0OFrOHTXqWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM2Nzk3Mw==", "bodyText": "If you make this method throws IOException, you don't need to wrap the IOExceptions in HBaseRowDataInputFormat.connectToTable() into RuntimeExceptions.\nThrowing an IOException is not a problem, because initTable is called in open(); which throws an IOException as well.", "url": "https://github.com/apache/flink/pull/13275#discussion_r485367973", "createdAt": "2020-09-09T06:29:27Z", "author": {"login": "rmetzger"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -68,6 +71,11 @@ public AbstractTableInputFormat(org.apache.hadoop.conf.Configuration hConf) {\n \t\tserializedConfig = HBaseConfigurationUtil.serializeConfiguration(hConf);\n \t}\n \n+\t/**\n+\t * Creates a {@link Scan} object and opens the {@link HTable} connection to initialize the HBase table.\n+\t */\n+\tprotected abstract void initTable();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA3MjY2NQ==", "bodyText": "@rmetzger Good idea. I have followed up with your point to throws IOException for initTable().", "url": "https://github.com/apache/flink/pull/13275#discussion_r490072665", "createdAt": "2020-09-17T08:40:48Z", "author": {"login": "SteNicholas"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -68,6 +71,11 @@ public AbstractTableInputFormat(org.apache.hadoop.conf.Configuration hConf) {\n \t\tserializedConfig = HBaseConfigurationUtil.serializeConfiguration(hConf);\n \t}\n \n+\t/**\n+\t * Creates a {@link Scan} object and opens the {@link HTable} connection to initialize the HBase table.\n+\t */\n+\tprotected abstract void initTable();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM2Nzk3Mw=="}, "originalCommit": {"oid": "27d9c90c0393f1febaec84f28e850867eed6222d"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MTE1MjM2OnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwOToyMTozNlrOHUFGPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwOToyMTozNlrOHUFGPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgxNzA4NA==", "bodyText": "nit:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t}  finally {\n          \n          \n            \n            \t\t} finally {", "url": "https://github.com/apache/flink/pull/13275#discussion_r490817084", "createdAt": "2020-09-18T09:21:36Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -186,73 +188,79 @@ public void close() throws IOException {\n \t\t\tif (resultScanner != null) {\n \t\t\t\tresultScanner.close();\n \t\t\t}\n-\t\t} finally {\n+\t\t\tcloseTable();\n+\t\t}  finally {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eed5b15d8d10f1c1228e39650bb844385d7a2283"}, "originalPosition": 99}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MTE3ODkxOnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwOToyOTowNVrOHUFWUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwOToyOTowNVrOHUFWUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyMTIwMA==", "bodyText": "The duplicate close looks strange to me. I think @rmetzger gave a nice idea above. You can just catch and log the error and move each close in a separate try block. You can take org.apache.flink.connector.hbase.sink.HBaseSinkFunction#close as an example. That will be much clean.", "url": "https://github.com/apache/flink/pull/13275#discussion_r490821200", "createdAt": "2020-09-18T09:29:05Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-hbase/src/main/java/org/apache/flink/connector/hbase/source/AbstractTableInputFormat.java", "diffHunk": "@@ -186,73 +188,79 @@ public void close() throws IOException {\n \t\t\tif (resultScanner != null) {\n \t\t\t\tresultScanner.close();\n \t\t\t}\n-\t\t} finally {\n+\t\t\tcloseTable();\n+\t\t}  finally {\n \t\t\tresultScanner = null;\n \t\t}\n \t}\n \n-\t@Override\n-\tpublic void closeInputFormat() throws IOException {\n+\tpublic void closeTable() throws IOException {\n \t\ttry {\n \t\t\tif (table != null) {\n \t\t\t\ttable.close();\n \t\t\t}\n+\t\t\tif (connection != null) {\n+\t\t\t\tconnection.close();\n+\t\t\t}\n+\t\t} catch (IOException e) {\n+\t\t\tif (connection != null) {\n+\t\t\t\tconnection.close();\n+\t\t\t}\n+\t\t\tthrow e;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eed5b15d8d10f1c1228e39650bb844385d7a2283"}, "originalPosition": 118}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 358, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}