{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwNDQzOTQw", "number": 13800, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNzoxMjo1NVrOEyNYzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwNDoxNjoxNFrOFI1Fpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMDgzNTk3OnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableSource.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNzoxMjo1NVrOHot_5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNzoxMjo1NVrOHot_5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1ODcyNQ==", "bodyText": "We don't need to adapt fetch size, it is a best effort read size.", "url": "https://github.com/apache/flink/pull/13800#discussion_r512458725", "createdAt": "2020-10-27T07:12:55Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableSource.java", "diffHunk": "@@ -92,8 +99,14 @@ public ScanRuntimeProvider getScanRuntimeProvider(ScanContext runtimeProviderCon\n \t\t\t.setPassword(options.getPassword().orElse(null))\n \t\t\t.setAutoCommit(readOptions.getAutoCommit());\n \n-\t\tif (readOptions.getFetchSize() != 0) {\n-\t\t\tbuilder.setFetchSize(readOptions.getFetchSize());\n+\t\tif (readOptions.getFetchSize() != 0 || this.limit >= 0) {\n+\t\t\tint fetchsize = readOptions.getFetchSize();\n+\t\t\tif (fetchsize == 0) {\n+\t\t\t\tfetchsize = limit;\n+\t\t\t} else if (limit != -1) {\n+\t\t\t\tfetchsize = Integer.min(fetchsize, limit);\n+\t\t\t}\n+\t\t\tbuilder.setFetchSize(fetchsize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d03e417c4b828ffb3e3b8061d0a9b5dd9a38b018"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMDg0MzQ3OnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-jdbc/src/test/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableSourceITCase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNzoxNToyOFrOHouELg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNzoxNToyOFrOHouELg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1OTgyMg==", "bodyText": "This doesn't break the test?", "url": "https://github.com/apache/flink/pull/13800#discussion_r512459822", "createdAt": "2020-10-27T07:15:28Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-jdbc/src/test/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableSourceITCase.java", "diffHunk": "@@ -154,7 +155,7 @@ public void testProject() throws Exception {\n \t\t\t\t\")\"\n \t\t);\n \n-\t\tIterator<Row> collected = tEnv.executeSql(\"SELECT id,timestamp6_col,decimal_col FROM \" + INPUT_TABLE).collect();\n+\t\tIterator<Row> collected = tEnv.executeSql(\"SELECT id,timestamp6_col,decimal_col FROM \" + INPUT_TABLE + \" LIMIT 1\").collect();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d03e417c4b828ffb3e3b8061d0a9b5dd9a38b018"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMDg0NjEzOnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-jdbc/src/test/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableSourceITCase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNzoxNjoyMlrOHouFtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNzoxNjoyMlrOHouFtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ2MDIxNA==", "bodyText": "Please select all the fields.", "url": "https://github.com/apache/flink/pull/13800#discussion_r512460214", "createdAt": "2020-10-27T07:16:22Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-jdbc/src/test/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableSourceITCase.java", "diffHunk": "@@ -166,4 +167,38 @@ public void testProject() throws Exception {\n \t\t\t\t.sorted().collect(Collectors.toList());\n \t\tassertEquals(expected, result);\n \t}\n+\n+\t@Test\n+\tpublic void testLimit() throws Exception {\n+\t\tStreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+\t\tEnvironmentSettings envSettings = EnvironmentSettings.newInstance()\n+\t\t\t\t.useBlinkPlanner()\n+\t\t\t\t.inStreamingMode()\n+\t\t\t\t.build();\n+\t\tStreamTableEnvironment tEnv = StreamTableEnvironment.create(env, envSettings);\n+\n+\t\ttEnv.executeSql(\n+\t\t\t\t\"CREATE TABLE \" + INPUT_TABLE + \"(\" +\n+\t\t\t\t\t\t\"id BIGINT,\" +\n+\t\t\t\t\t\t\"timestamp6_col TIMESTAMP(6),\" +\n+\t\t\t\t\t\t\"timestamp9_col TIMESTAMP(9),\" +\n+\t\t\t\t\t\t\"time_col TIME,\" +\n+\t\t\t\t\t\t\"real_col FLOAT,\" +\n+\t\t\t\t\t\t\"double_col DOUBLE,\" +\n+\t\t\t\t\t\t\"decimal_col DECIMAL(10, 4)\" +\n+\t\t\t\t\t\t\") WITH (\" +\n+\t\t\t\t\t\t\"  'connector'='jdbc',\" +\n+\t\t\t\t\t\t\"  'url'='\" + DB_URL + \"',\" +\n+\t\t\t\t\t\t\"  'table-name'='\" + INPUT_TABLE + \"'\" +\n+\t\t\t\t\t\t\")\"\n+\t\t);\n+\n+\t\tIterator<Row> collected = tEnv.executeSql(\"SELECT id FROM \" + INPUT_TABLE + \" LIMIT 1\").collect();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d03e417c4b828ffb3e3b8061d0a9b5dd9a38b018"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMDg1MDQ4OnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableSource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNzoxODowOVrOHouITA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNzoxODowOVrOHouITA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ2MDg3Ng==", "bodyText": "We don't need to cast to int.", "url": "https://github.com/apache/flink/pull/13800#discussion_r512460876", "createdAt": "2020-10-27T07:18:09Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableSource.java", "diffHunk": "@@ -156,11 +169,25 @@ public boolean equals(Object o) {\n \t\t\tObjects.equals(readOptions, that.readOptions) &&\n \t\t\tObjects.equals(lookupOptions, that.lookupOptions) &&\n \t\t\tObjects.equals(physicalSchema, that.physicalSchema) &&\n-\t\t\tObjects.equals(dialectName, that.dialectName);\n+\t\t\tObjects.equals(dialectName, that.dialectName) &&\n+\t\t\tObjects.equals(limit, that.limit);\n \t}\n \n \t@Override\n \tpublic int hashCode() {\n \t\treturn Objects.hash(options, readOptions, lookupOptions, physicalSchema, dialectName);\n \t}\n+\n+\t/**\n+\t * {@link java.sql.Statement#setFetchSize(int)} only accepts int value.\n+\t */\n+\t@Override\n+\tpublic void applyLimit(long limit) {\n+\t\tif (limit > Integer.MAX_VALUE) {\n+\t\t\tthrow new TableException(\n+\t\t\t\t\tString.format(\"The maximum limit value is %d for jdbc connector. Get %d.\",\n+\t\t\t\t\t\t\tInteger.MAX_VALUE, limit));\n+\t\t}\n+\t\tthis.limit = Math.toIntExact(limit);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d03e417c4b828ffb3e3b8061d0a9b5dd9a38b018"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzOTgyMTMyOnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/dialect/JdbcDialect.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwNzowMTo0MlrOIJwidg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwNzowMTo0MlrOIJwidg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEwMzM1MA==", "bodyText": "how about move limit >= 0 ? \" \" + getLimit(limit) : \"\" to  getLimit(long limit) internal?", "url": "https://github.com/apache/flink/pull/13800#discussion_r547103350", "createdAt": "2020-12-22T07:01:42Z", "author": {"login": "leonardBang"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/dialect/JdbcDialect.java", "diffHunk": "@@ -148,14 +150,15 @@ default String getDeleteStatement(String tableName, String[] conditionFields) {\n \t/**\n \t * Get select fields statement by condition fields. Default use SELECT.\n \t */\n-\tdefault String getSelectFromStatement(String tableName, String[] selectFields, String[] conditionFields) {\n+\tdefault String getSelectFromStatement(String tableName, String[] selectFields, String[] conditionFields, long limit) {\n \t\tString selectExpressions = Arrays.stream(selectFields)\n \t\t\t\t.map(this::quoteIdentifier)\n \t\t\t\t.collect(Collectors.joining(\", \"));\n \t\tString fieldExpressions = Arrays.stream(conditionFields)\n \t\t\t\t.map(f -> format(\"%s = :%s\", quoteIdentifier(f), f))\n \t\t\t\t.collect(Collectors.joining(\" AND \"));\n \t\treturn \"SELECT \" + selectExpressions + \" FROM \" +\n-\t\t\t\tquoteIdentifier(tableName) + (conditionFields.length > 0 ? \" WHERE \" + fieldExpressions : \"\");\n+\t\t\t\tquoteIdentifier(tableName) + (conditionFields.length > 0 ? \" WHERE \" + fieldExpressions : \"\") +\n+\t\t\t\t(limit >= 0 ? \" \" + getLimit(limit) : \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7a4ae2ed2de185200b562bb882af275a49e972e"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzOTgyNDcxOnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableSource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwNzowMzoxMFrOIJwkaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwNzowMzoxMFrOIJwkaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEwMzg0OA==", "bodyText": "please also add missed limit", "url": "https://github.com/apache/flink/pull/13800#discussion_r547103848", "createdAt": "2020-12-22T07:03:10Z", "author": {"login": "leonardBang"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableSource.java", "diffHunk": "@@ -156,11 +163,17 @@ public boolean equals(Object o) {\n \t\t\tObjects.equals(readOptions, that.readOptions) &&\n \t\t\tObjects.equals(lookupOptions, that.lookupOptions) &&\n \t\t\tObjects.equals(physicalSchema, that.physicalSchema) &&\n-\t\t\tObjects.equals(dialectName, that.dialectName);\n+\t\t\tObjects.equals(dialectName, that.dialectName) &&\n+\t\t\tObjects.equals(limit, that.limit);\n \t}\n \n \t@Override\n \tpublic int hashCode() {\n \t\treturn Objects.hash(options, readOptions, lookupOptions, physicalSchema, dialectName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7a4ae2ed2de185200b562bb882af275a49e972e"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzOTg1NDMyOnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/rules/FlinkStreamRuleSets.scala", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwNzoxNTo1NlrOIJw1UA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxMzoxODowNVrOIJ64Iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEwODE3Ng==", "bodyText": "I think this rule should have been existed after support limit pushdown in planner, why we add it util now?", "url": "https://github.com/apache/flink/pull/13800#discussion_r547108176", "createdAt": "2020-12-22T07:15:56Z", "author": {"login": "leonardBang"}, "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/rules/FlinkStreamRuleSets.scala", "diffHunk": "@@ -244,6 +244,7 @@ object FlinkStreamRuleSets {\n     PushProjectIntoLegacyTableSourceScanRule.INSTANCE,\n     PushFilterIntoTableSourceScanRule.INSTANCE,\n     PushFilterIntoLegacyTableSourceScanRule.INSTANCE,\n+    PushLimitIntoTableSourceScanRule.INSTANCE,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7a4ae2ed2de185200b562bb882af275a49e972e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI3MjczOQ==", "bodyText": "They only add the rule into BatchRuleSet. I add a new commit to test the rule under the StreamEnvironment.", "url": "https://github.com/apache/flink/pull/13800#discussion_r547272739", "createdAt": "2020-12-22T13:18:05Z", "author": {"login": "fsk119"}, "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/rules/FlinkStreamRuleSets.scala", "diffHunk": "@@ -244,6 +244,7 @@ object FlinkStreamRuleSets {\n     PushProjectIntoLegacyTableSourceScanRule.INSTANCE,\n     PushFilterIntoTableSourceScanRule.INSTANCE,\n     PushFilterIntoLegacyTableSourceScanRule.INSTANCE,\n+    PushLimitIntoTableSourceScanRule.INSTANCE,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEwODE3Ng=="}, "originalCommit": {"oid": "e7a4ae2ed2de185200b562bb882af275a49e972e"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0MzIyNTYwOnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/stream/sql/LimitableSourceTest.scala", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwMzowOTowMlrOIKPxjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwMzowOTowMlrOIKPxjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYxNTExOQ==", "bodyText": "for what ? ^_^", "url": "https://github.com/apache/flink/pull/13800#discussion_r547615119", "createdAt": "2020-12-23T03:09:02Z", "author": {"login": "leonardBang"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/stream/sql/LimitableSourceTest.scala", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.table.planner.plan.stream.sql\n+\n+import org.junit.Before\n+\n+/**\n+ * Test for.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71a5140cb517517feb3a0dea17c4e274f3ed7fcb"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0MzIzNTUyOnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/dialect/MySQLDialect.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwMzoxNToxNVrOIKP3Sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwMzoxNToxNVrOIKP3Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYxNjU4Nw==", "bodyText": "how about rename to getLimitStatement to make the function definition more clear?", "url": "https://github.com/apache/flink/pull/13800#discussion_r547616587", "createdAt": "2020-12-23T03:15:15Z", "author": {"login": "leonardBang"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/dialect/MySQLDialect.java", "diffHunk": "@@ -55,6 +55,15 @@ public JdbcRowConverter getRowConverter(RowType rowType) {\n \t\treturn new MySQLRowConverter(rowType);\n \t}\n \n+\t@Override\n+\tpublic String getLimit(long limit) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71a5140cb517517feb3a0dea17c4e274f3ed7fcb"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0Nzk0NTk4OnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/dialect/DerbyDialect.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwMzoxNjo1MlrOIK9eNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwMzoxNjo1MlrOIK9eNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM2MzgzMQ==", "bodyText": "Could you remove the the begging space? The space should be handled by framework. It's easy to forget to add the space for new dialects.\nPlease use upper case for the SQL keywords.", "url": "https://github.com/apache/flink/pull/13800#discussion_r548363831", "createdAt": "2020-12-24T03:16:52Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/dialect/DerbyDialect.java", "diffHunk": "@@ -66,6 +66,15 @@ public String dialectName() {\n \t\treturn \"Derby\";\n \t}\n \n+\t@Override\n+\tpublic String getLimitStatement(long limit) {\n+\t\tif (limit >= 0) {\n+\t\t\treturn String.format(\" fetch first %d rows only\", limit);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f408d4cb2758fe350988e815b93b1c48d15497aa"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0Nzk0ODc2OnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/dialect/DerbyDialect.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwMzoxODozNFrOIK9fnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwMzoxODozNFrOIK9fnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM2NDE4OQ==", "bodyText": "The else branch should also handled by framework. The limit parameter should always be a valid limit.", "url": "https://github.com/apache/flink/pull/13800#discussion_r548364189", "createdAt": "2020-12-24T03:18:34Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/dialect/DerbyDialect.java", "diffHunk": "@@ -66,6 +66,15 @@ public String dialectName() {\n \t\treturn \"Derby\";\n \t}\n \n+\t@Override\n+\tpublic String getLimitStatement(long limit) {\n+\t\tif (limit >= 0) {\n+\t\t\treturn String.format(\" fetch first %d rows only\", limit);\n+\t\t} else {\n+\t\t\treturn \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f408d4cb2758fe350988e815b93b1c48d15497aa"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0Nzk0ODc4OnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/dialect/DerbyDialect.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwMzoxODozNVrOIK9foA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwMzoxODozNVrOIK9foA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM2NDE5Mg==", "bodyText": "The else branch should also handled by framework. The limit parameter should always be a valid limit.", "url": "https://github.com/apache/flink/pull/13800#discussion_r548364192", "createdAt": "2020-12-24T03:18:35Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/dialect/DerbyDialect.java", "diffHunk": "@@ -66,6 +66,15 @@ public String dialectName() {\n \t\treturn \"Derby\";\n \t}\n \n+\t@Override\n+\tpublic String getLimitStatement(long limit) {\n+\t\tif (limit >= 0) {\n+\t\t\treturn String.format(\" fetch first %d rows only\", limit);\n+\t\t} else {\n+\t\t\treturn \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f408d4cb2758fe350988e815b93b1c48d15497aa"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0Nzk1NjU5OnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableSource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwMzoyNDoxOFrOIK9jzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwMzoyNDoxOFrOIK9jzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM2NTI2Mw==", "bodyText": "Why separate the initialization into another line?", "url": "https://github.com/apache/flink/pull/13800#discussion_r548365263", "createdAt": "2020-12-24T03:24:18Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableSource.java", "diffHunk": "@@ -96,8 +102,9 @@ public ScanRuntimeProvider getScanRuntimeProvider(ScanContext runtimeProviderCon\n \t\t\tbuilder.setFetchSize(readOptions.getFetchSize());\n \t\t}\n \t\tfinal JdbcDialect dialect = options.getDialect();\n-\t\tString query = dialect.getSelectFromStatement(\n-\t\t\toptions.getTableName(), physicalSchema.getFieldNames(), new String[0]);\n+\t\tString query;\n+\t\tquery = dialect.getSelectFromStatement(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f408d4cb2758fe350988e815b93b1c48d15497aa"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0Nzk1OTg3OnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableSource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwMzoyNjoxNVrOIK9lkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwMzoyNjoxNVrOIK9lkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM2NTcxNQ==", "bodyText": "Could you add a test that the source is configured with partition columns and submit a select query with limit clause. I'm wondering currently they can't work together well.", "url": "https://github.com/apache/flink/pull/13800#discussion_r548365715", "createdAt": "2020-12-24T03:26:15Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/table/JdbcDynamicTableSource.java", "diffHunk": "@@ -96,8 +102,9 @@ public ScanRuntimeProvider getScanRuntimeProvider(ScanContext runtimeProviderCon\n \t\t\tbuilder.setFetchSize(readOptions.getFetchSize());\n \t\t}\n \t\tfinal JdbcDialect dialect = options.getDialect();\n-\t\tString query = dialect.getSelectFromStatement(\n-\t\t\toptions.getTableName(), physicalSchema.getFieldNames(), new String[0]);\n+\t\tString query;\n+\t\tquery = dialect.getSelectFromStatement(\n+\t\t\t\toptions.getTableName(), physicalSchema.getFieldNames(), new String[0], limit);\n \t\tif (readOptions.getPartitionColumnName().isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f408d4cb2758fe350988e815b93b1c48d15497aa"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0ODAyNTk1OnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/dialect/JdbcDialect.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwNDoxNToyNVrOIK-I2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwNDoxNToyNVrOIK-I2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM3NDc0NA==", "bodyText": "Personally, I don't like the current design of the new interface.\n\nit couples the limit to the select statement which makes it impossible to inject additional where clause.\ndialects need to implement/take care 2 interfaces about limit.\nmany invokers have to pass an invalid limit.\n\nIn my opinion, a better solution would be separate them, by having a new interface for limit:\nString getLimitClause(long limit);\nAnd concat the limit caluse with the select statement where needs the limit clause.", "url": "https://github.com/apache/flink/pull/13800#discussion_r548374744", "createdAt": "2020-12-24T04:15:25Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/dialect/JdbcDialect.java", "diffHunk": "@@ -148,14 +150,15 @@ default String getDeleteStatement(String tableName, String[] conditionFields) {\n \t/**\n \t * Get select fields statement by condition fields. Default use SELECT.\n \t */\n-\tdefault String getSelectFromStatement(String tableName, String[] selectFields, String[] conditionFields) {\n+\tdefault String getSelectFromStatement(String tableName, String[] selectFields, String[] conditionFields, long limit) {\n \t\tString selectExpressions = Arrays.stream(selectFields)\n \t\t\t\t.map(this::quoteIdentifier)\n \t\t\t\t.collect(Collectors.joining(\", \"));\n \t\tString fieldExpressions = Arrays.stream(conditionFields)\n \t\t\t\t.map(f -> format(\"%s = :%s\", quoteIdentifier(f), f))\n \t\t\t\t.collect(Collectors.joining(\" AND \"));\n \t\treturn \"SELECT \" + selectExpressions + \" FROM \" +\n-\t\t\t\tquoteIdentifier(tableName) + (conditionFields.length > 0 ? \" WHERE \" + fieldExpressions : \"\");\n+\t\t\t\tquoteIdentifier(tableName) + (conditionFields.length > 0 ? \" WHERE \" + fieldExpressions : \"\") +\n+\t\t\t\tgetLimitStatement(limit);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f408d4cb2758fe350988e815b93b1c48d15497aa"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0ODAyNzI3OnYy", "diffSide": "RIGHT", "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/dialect/JdbcDialect.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwNDoxNjoxNFrOIK-JhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwNDoxNjoxNFrOIK-JhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM3NDkxNg==", "bodyText": "Please add javadoc on the method, including the description for limit parameter, e.g. the value range.", "url": "https://github.com/apache/flink/pull/13800#discussion_r548374916", "createdAt": "2020-12-24T04:16:14Z", "author": {"login": "wuchong"}, "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/dialect/JdbcDialect.java", "diffHunk": "@@ -57,6 +57,8 @@\n \t */\n \tJdbcRowConverter getRowConverter(RowType rowType);\n \n+\tString getLimitStatement(long limit);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f408d4cb2758fe350988e815b93b1c48d15497aa"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4968, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}