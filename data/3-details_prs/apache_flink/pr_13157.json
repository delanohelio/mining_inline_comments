{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4MzI3MTQ2", "number": 13157, "title": "[FLINK-18900][hive] HiveCatalog should error out when listing partitions with an invalid spec", "bodyText": "What is the purpose of the change\nCurrently HiveCatalog could return all partitions of table for SHOW PARTITIONS with an invalid spec, which is wrong. HiveCatalog should error out when listing partitions with an invalid spec.\nBrief change log\n\nHiveCatalog throws PartitionNotExistException  after calling HiveReflectionUtils.getPvals with an invalid spec.\n\nVerifying this change\n\nMethod testShowPartitions of HiveDialectITCase add case for executing SHOW PARTITIONS with an invalid spec.\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-08-15T15:07:53Z", "url": "https://github.com/apache/flink/pull/13157", "merged": true, "mergeCommit": {"oid": "478c9657fe1240acdc1eb08ad32ea93e08b0cd5e"}, "closed": true, "closedAt": "2020-08-21T07:20:44Z", "author": {"login": "SteNicholas"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_KakfgH2gAyNDY4MzI3MTQ2OmI2NGEzM2EzZTU3ZTRhZjI1MjJhZWFmMjc0YzQ3MTFkZGIyYjAwZWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdA_j7jAFqTQ3MjI2MDkzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b64a33a3e57e4af2522aeaf274c4711ddb2b00ef", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/b64a33a3e57e4af2522aeaf274c4711ddb2b00ef", "committedDate": "2020-08-15T14:51:23Z", "message": "[FLINK-18900][hive] HiveCatalog should error out when listing partitions with an invalid spec"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MTg5NjAy", "url": "https://github.com/apache/flink/pull/13157#pullrequestreview-468189602", "createdAt": "2020-08-17T06:20:30Z", "commit": {"oid": "b64a33a3e57e4af2522aeaf274c4711ddb2b00ef"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjoyMDozMFrOHBbCSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjoyNDo1MlrOHBbIBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI1MzU3OQ==", "bodyText": "In case of invalid partition spec, we should throw PartitionSpecInvalidException", "url": "https://github.com/apache/flink/pull/13157#discussion_r471253579", "createdAt": "2020-08-17T06:20:30Z", "author": {"login": "lirui-apache"}, "path": "flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/table/catalog/hive/HiveCatalog.java", "diffHunk": "@@ -765,7 +765,7 @@ public void dropPartition(ObjectPath tablePath, CatalogPartitionSpec partitionSp\n \n \t@Override\n \tpublic List<CatalogPartitionSpec> listPartitions(ObjectPath tablePath, CatalogPartitionSpec partitionSpec)\n-\t\t\tthrows TableNotExistException, TableNotPartitionedException, CatalogException {\n+\t\t\tthrows TableNotExistException, TableNotPartitionedException, PartitionNotExistException, CatalogException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b64a33a3e57e4af2522aeaf274c4711ddb2b00ef"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI1Mzk3Mg==", "bodyText": "We can simply try calling getOrderedFullPartitionValues, which will check if the spec is valid", "url": "https://github.com/apache/flink/pull/13157#discussion_r471253972", "createdAt": "2020-08-17T06:21:41Z", "author": {"login": "lirui-apache"}, "path": "flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/table/catalog/hive/HiveCatalog.java", "diffHunk": "@@ -777,8 +777,15 @@ public void dropPartition(ObjectPath tablePath, CatalogPartitionSpec partitionSp\n \t\t\t// partition spec can be partial\n \t\t\tList<String> partialVals = HiveReflectionUtils.getPvals(hiveShim, hiveTable.getPartitionKeys(),\n \t\t\t\tpartitionSpec.getPartitionSpec());\n-\t\t\treturn client.listPartitionNames(tablePath.getDatabaseName(), tablePath.getObjectName(), partialVals,\n-\t\t\t\t(short) -1).stream().map(HiveCatalog::createPartitionSpec).collect(Collectors.toList());\n+\t\t\tif (partialVals.size() == 1 && StringUtils.isNullOrWhitespaceOnly(partialVals.get(0))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b64a33a3e57e4af2522aeaf274c4711ddb2b00ef"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI1NTA0NA==", "bodyText": "Why do we need a different table schema? I think you can just reuse the table in this test", "url": "https://github.com/apache/flink/pull/13157#discussion_r471255044", "createdAt": "2020-08-17T06:24:52Z", "author": {"login": "lirui-apache"}, "path": "flink-connectors/flink-connector-hive/src/test/java/org/apache/flink/connectors/hive/HiveDialectITCase.java", "diffHunk": "@@ -467,14 +468,36 @@ public void testAddDropPartitions() throws Exception {\n \n \t@Test\n \tpublic void testShowPartitions() throws Exception {\n-\t\ttableEnv.executeSql(\"create table tbl (x int,y binary) partitioned by (dt date, country string)\");\n-\t\ttableEnv.executeSql(\"alter table tbl add partition (dt='2020-04-30',country='china') partition (dt='2020-04-30',country='us')\");\n+\t\ttableEnv.executeSql(\"create table tbl (x int,y binary) partitioned by (country string)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b64a33a3e57e4af2522aeaf274c4711ddb2b00ef"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f77481fbdf9900bd2f411ef045cd91985ebb1085", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/f77481fbdf9900bd2f411ef045cd91985ebb1085", "committedDate": "2020-08-19T08:41:52Z", "message": "[FLINK-18900][hive] HiveCatalog should error out when listing partitions with an invalid spec"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNTA4NjY3", "url": "https://github.com/apache/flink/pull/13157#pullrequestreview-471508667", "createdAt": "2020-08-20T11:38:48Z", "commit": {"oid": "f77481fbdf9900bd2f411ef045cd91985ebb1085"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxMTozODo0OVrOHD83ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxMTozOTo0N1rOHD85oA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkwNTA1NA==", "bodyText": "Why do we need to catch the exception and throw another one?", "url": "https://github.com/apache/flink/pull/13157#discussion_r473905054", "createdAt": "2020-08-20T11:38:49Z", "author": {"login": "lirui-apache"}, "path": "flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/table/catalog/hive/HiveCatalog.java", "diffHunk": "@@ -777,8 +777,11 @@ public void dropPartition(ObjectPath tablePath, CatalogPartitionSpec partitionSp\n \t\t\t// partition spec can be partial\n \t\t\tList<String> partialVals = HiveReflectionUtils.getPvals(hiveShim, hiveTable.getPartitionKeys(),\n \t\t\t\tpartitionSpec.getPartitionSpec());\n+\t\t\tcheckValidPartitionSpec(partitionSpec, getFieldNames(hiveTable.getPartitionKeys()), tablePath);\n \t\t\treturn client.listPartitionNames(tablePath.getDatabaseName(), tablePath.getObjectName(), partialVals,\n \t\t\t\t(short) -1).stream().map(HiveCatalog::createPartitionSpec).collect(Collectors.toList());\n+\t\t} catch (PartitionSpecInvalidException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f77481fbdf9900bd2f411ef045cd91985ebb1085"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkwNTU2OA==", "bodyText": "This should be done before we call HiveReflectionUtils.getPvals", "url": "https://github.com/apache/flink/pull/13157#discussion_r473905568", "createdAt": "2020-08-20T11:39:47Z", "author": {"login": "lirui-apache"}, "path": "flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/table/catalog/hive/HiveCatalog.java", "diffHunk": "@@ -777,8 +777,11 @@ public void dropPartition(ObjectPath tablePath, CatalogPartitionSpec partitionSp\n \t\t\t// partition spec can be partial\n \t\t\tList<String> partialVals = HiveReflectionUtils.getPvals(hiveShim, hiveTable.getPartitionKeys(),\n \t\t\t\tpartitionSpec.getPartitionSpec());\n+\t\t\tcheckValidPartitionSpec(partitionSpec, getFieldNames(hiveTable.getPartitionKeys()), tablePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f77481fbdf9900bd2f411ef045cd91985ebb1085"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb82e904f49ed492fe36badf6a44bed3267b687c", "author": {"user": {"login": "SteNicholas", "name": "SteNicholas"}}, "url": "https://github.com/apache/flink/commit/bb82e904f49ed492fe36badf6a44bed3267b687c", "committedDate": "2020-08-21T07:06:42Z", "message": "[FLINK-18900][hive] HiveCatalog should error out when listing partitions with an invalid spec"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMjU3NDI3", "url": "https://github.com/apache/flink/pull/13157#pullrequestreview-472257427", "createdAt": "2020-08-21T07:13:53Z", "commit": {"oid": "bb82e904f49ed492fe36badf6a44bed3267b687c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMjYwOTMx", "url": "https://github.com/apache/flink/pull/13157#pullrequestreview-472260931", "createdAt": "2020-08-21T07:20:30Z", "commit": {"oid": "bb82e904f49ed492fe36badf6a44bed3267b687c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4893, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}