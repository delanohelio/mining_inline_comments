{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5NjgyNDk1", "number": 11648, "title": "[FLINK-16945][checkpointing] Execute CheckpointFailureManager.FailJob\u2026", "bodyText": "\u2026Callback directly in main thread executor\nWhat is the purpose of the change\n\nThis PR is used to resolve the race condition described in FLINK-13497\nAfter finishing FLINK-13698 , now the operation of failing execution graph should be executed directly in main thread. There will be no unexpected message handled CheckpointCoordinator before failing execution graph\n\nBrief change log\n\nInvoking ExecutionGraph#failGlobal directly in CheckpointFailureManager\n\nVerifying this change\n\nThis change added unit test case\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? not applicable", "createdAt": "2020-04-06T14:22:10Z", "url": "https://github.com/apache/flink/pull/11648", "merged": true, "mergeCommit": {"oid": "288750a76f64269de7f5eb2aee72feb92b048036"}, "closed": true, "closedAt": "2020-04-08T10:19:16Z", "author": {"login": "ifndef-SleePy"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVTdgZgFqTM4OTA5ODg1Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVd2aHABqjMyMTIyMDgwMTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MDk4ODU2", "url": "https://github.com/apache/flink/pull/11648#pullrequestreview-389098856", "createdAt": "2020-04-07T13:10:47Z", "commit": {"oid": "be41fd7ebd6cec17ef830786e89e4d12dcb9fc54"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzoxMDo0OFrOGCCxlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzoxNzoyMFrOGCDDRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc5NTc5Nw==", "bodyText": "Why did you need to bump those timeouts? Is it because otherwise the checkpoints that you create in your unit test that you introduced could timeout?", "url": "https://github.com/apache/flink/pull/11648#discussion_r404795797", "createdAt": "2020-04-07T13:10:48Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/checkpoint/ExecutionGraphCheckpointCoordinatorTest.java", "diffHunk": "@@ -144,11 +228,14 @@ private ExecutionGraph createExecutionGraphAndEnableCheckpointing(\n \t\t\t.setJobGraph(new JobGraph(jobVertex))\n \t\t\t.setRpcTimeout(timeout)\n \t\t\t.setAllocationTimeout(timeout)\n+\t\t\t.setIoExecutor(Executors.directExecutor())\n \t\t\t.build();\n \n+\t\tfinal ExecutionJobVertex executionJobVertex = executionGraph.getVerticesTopologically().iterator().next();\n+\n \t\tCheckpointCoordinatorConfiguration chkConfig = new CheckpointCoordinatorConfiguration(\n-\t\t\t100,\n-\t\t\t100,\n+\t\t\t1000000,\n+\t\t\t1000000,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be41fd7ebd6cec17ef830786e89e4d12dcb9fc54"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgwMDMyNw==", "bodyText": "Why is this checkpoint going to be declined? Maybe expand the comment with a bit of explanation?\nIf it's failing, maybe add an assertion that it has failed? Or just skip this code block if it's not necessary for the test as a whole?\nedit:\nreplace\n// trigger a normal checkpoint which would be declined then\n\nwith\n// trigger a normal checkpoint which we will fail/decline later\n\nto avoid confusion as mine above? :)", "url": "https://github.com/apache/flink/pull/11648#discussion_r404800327", "createdAt": "2020-04-07T13:17:20Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/checkpoint/ExecutionGraphCheckpointCoordinatorTest.java", "diffHunk": "@@ -131,9 +142,82 @@ public void testShutdownCheckpointCoordinatorOnFinished() throws Exception {\n \t\tassertThat(storeShutdownFuture.get(), is(JobStatus.FINISHED));\n \t}\n \n+\t/**\n+\t * The case is designed to check the race condition between {@link ExecutionGraph} and\n+\t * {@link CheckpointCoordinator}. There should be no checkpoint accepted after\n+\t * {@link CheckpointFailureManager} decides to fail the {@link ExecutionGraph}.\n+\t */\n+\t@Test\n+\tpublic void testNoCheckpointAcceptedWhileFailingExecutionGraph() throws Exception {\n+\t\tCheckpointIDCounter counter = new TestingCheckpointIDCounter(new CompletableFuture<>());\n+\n+\t\tTestingCompletedCheckpointStore store = new TestingCompletedCheckpointStore(new CompletableFuture<>());\n+\n+\t\tfinal ManuallyTriggeredScheduledExecutor mainThreadExecutor = new ManuallyTriggeredScheduledExecutor();\n+\t\tExecutionGraph graph = createExecutionGraphAndEnableCheckpointing(\n+\t\t\tcounter,\n+\t\t\tstore,\n+\t\t\tnew ComponentMainThreadExecutorServiceAdapter(mainThreadExecutor, Thread.currentThread()));\n+\n+\t\tfinal CheckpointCoordinator checkpointCoordinator = graph.getCheckpointCoordinator();\n+\n+\t\tassertThat(checkpointCoordinator, Matchers.notNullValue());\n+\t\tassertThat(checkpointCoordinator.isShutdown(), is(false));\n+\n+\t\tgraph.scheduleForExecution();\n+\t\tExecutionGraphTestUtils.switchToRunning(graph);\n+\n+\t\t// trigger a normal checkpoint which would be declined then\n+\t\tcheckpointCoordinator.triggerCheckpoint(System.currentTimeMillis(), true);\n+\t\tmainThreadExecutor.triggerAll();\n+\t\tfinal long checkpointId = checkpointCoordinator.getPendingCheckpoints().keySet().iterator().next();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be41fd7ebd6cec17ef830786e89e4d12dcb9fc54"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99b55422106d30a8d6a9e03fa4f665b683615f71", "author": {"user": {"login": "ifndef-SleePy", "name": "Biao Liu"}}, "url": "https://github.com/apache/flink/commit/99b55422106d30a8d6a9e03fa4f665b683615f71", "committedDate": "2020-04-08T01:44:39Z", "message": "[FLINK-16945][checkpointing] Execute CheckpointFailureManager.FailJobCallback directly in main thread executor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "be41fd7ebd6cec17ef830786e89e4d12dcb9fc54", "author": {"user": {"login": "ifndef-SleePy", "name": "Biao Liu"}}, "url": "https://github.com/apache/flink/commit/be41fd7ebd6cec17ef830786e89e4d12dcb9fc54", "committedDate": "2020-04-06T14:10:54Z", "message": "[FLINK-16945][checkpointing] Execute CheckpointFailureManager.FailJobCallback directly in main thread executor"}, "afterCommit": {"oid": "99b55422106d30a8d6a9e03fa4f665b683615f71", "author": {"user": {"login": "ifndef-SleePy", "name": "Biao Liu"}}, "url": "https://github.com/apache/flink/commit/99b55422106d30a8d6a9e03fa4f665b683615f71", "committedDate": "2020-04-08T01:44:39Z", "message": "[FLINK-16945][checkpointing] Execute CheckpointFailureManager.FailJobCallback directly in main thread executor"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2330, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}