{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4OTM2MDU4", "number": 10760, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwMTo1MDozNVrODV302Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwMjowMDowMVrODV330Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MjYxMzM3OnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-planner-blink/src/main/java/org/apache/flink/table/planner/plan/rules/logical/FlinkAggregateExpandDistinctAggregatesRule.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwMTo1MDozNVrOFaUAfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwMTo1MDozNVrOFaUAfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEzNTEwMA==", "bodyText": "Get and remap xx ?", "url": "https://github.com/apache/flink/pull/10760#discussion_r363135100", "createdAt": "2020-01-06T01:50:35Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/main/java/org/apache/flink/table/planner/plan/rules/logical/FlinkAggregateExpandDistinctAggregatesRule.java", "diffHunk": "@@ -471,10 +474,24 @@ private void rewriteUsingGroupingSets(RelOptRuleCall call,\n \t\t\tfinal RexNode nodeZ = nodes.remove(nodes.size() - 1);\n \t\t\tfor (Map.Entry<ImmutableBitSet, Integer> entry : filters.entrySet()) {\n \t\t\t\tfinal long v = groupValue(fullGroupSet, entry.getKey());\n-\t\t\t\tnodes.add(\n+\t\t\t\t// Remap and get the filterArg of the distinct aggregate call.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d4e987c1b33f2352f76469b73bc1c0ae39ef6b6"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MjYxODI0OnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/batch/sql/agg/DistinctAggregateTest.scala", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwMTo1NTo1M1rOFaUC_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNzoxNzo0NFrOFaW0lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEzNTc0MA==", "bodyText": "please move these cases to FlinkAggregateExpandDistinctAggregatesRuleTest", "url": "https://github.com/apache/flink/pull/10760#discussion_r363135740", "createdAt": "2020-01-06T01:55:53Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/batch/sql/agg/DistinctAggregateTest.scala", "diffHunk": "@@ -82,4 +83,39 @@ class DistinctAggregateTest extends TableTestBase {\n     util.verifyPlan(sqlQuery)\n   }\n \n+  @Test\n+  def testSingleDistinctWithFilter(): Unit = {\n+    val sqlQuery = \"SELECT d, COUNT(DISTINCT c) FILTER (WHERE a > 0) FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+\n+  @Test\n+  def testMultiDistinctOnSameColumnWithFilter(): Unit = {\n+    val sqlQuery = \"SELECT d, COUNT(DISTINCT c), COUNT(DISTINCT c) FILTER (WHERE a > 10),\\n\" +\n+      \"COUNT(DISTINCT c) FILTER (WHERE a < 10) FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+\n+  @Test\n+  def TestMultiDistinctOnDifferentColumnWithFilter(): Unit = {\n+    val sqlQuery = \"SELECT d, COUNT(DISTINCT c), COUNT(DISTINCT c) FILTER (WHERE a > 0),\\n\" +\n+      \"COUNT(DISTINCT b) FILTER (WHERE b > 1) FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+\n+  @Test\n+  def TestMultiDistinctWithFilterAndNonDistinctAgg(): Unit = {\n+    val sqlQuery = \"SELECT d, COUNT(DISTINCT c), COUNT(DISTINCT c) FILTER (WHERE a > 0),\\n\" +\n+      \"MAX(e), MIN(e) FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+\n+  @Test\n+  def testMultiDistinctAndNonDistinctAggWithFilter(): Unit = {\n+    val sqlQuery = \"SELECT d, MAX(e), MAX(e) FILTER (WHERE a < 10), COUNT(DISTINCT c),\\n\" +\n+      \"COUNT(DISTINCT c) FILTER (WHERE a > 5), COUNT(DISTINCT b) FILTER (WHERE b > 3)\\n\" +\n+      \"FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d4e987c1b33f2352f76469b73bc1c0ae39ef6b6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEzNTkwNA==", "bodyText": "please add some cases without GROUP BY", "url": "https://github.com/apache/flink/pull/10760#discussion_r363135904", "createdAt": "2020-01-06T01:57:35Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/batch/sql/agg/DistinctAggregateTest.scala", "diffHunk": "@@ -82,4 +83,39 @@ class DistinctAggregateTest extends TableTestBase {\n     util.verifyPlan(sqlQuery)\n   }\n \n+  @Test\n+  def testSingleDistinctWithFilter(): Unit = {\n+    val sqlQuery = \"SELECT d, COUNT(DISTINCT c) FILTER (WHERE a > 0) FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+\n+  @Test\n+  def testMultiDistinctOnSameColumnWithFilter(): Unit = {\n+    val sqlQuery = \"SELECT d, COUNT(DISTINCT c), COUNT(DISTINCT c) FILTER (WHERE a > 10),\\n\" +\n+      \"COUNT(DISTINCT c) FILTER (WHERE a < 10) FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+\n+  @Test\n+  def TestMultiDistinctOnDifferentColumnWithFilter(): Unit = {\n+    val sqlQuery = \"SELECT d, COUNT(DISTINCT c), COUNT(DISTINCT c) FILTER (WHERE a > 0),\\n\" +\n+      \"COUNT(DISTINCT b) FILTER (WHERE b > 1) FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+\n+  @Test\n+  def TestMultiDistinctWithFilterAndNonDistinctAgg(): Unit = {\n+    val sqlQuery = \"SELECT d, COUNT(DISTINCT c), COUNT(DISTINCT c) FILTER (WHERE a > 0),\\n\" +\n+      \"MAX(e), MIN(e) FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+\n+  @Test\n+  def testMultiDistinctAndNonDistinctAggWithFilter(): Unit = {\n+    val sqlQuery = \"SELECT d, MAX(e), MAX(e) FILTER (WHERE a < 10), COUNT(DISTINCT c),\\n\" +\n+      \"COUNT(DISTINCT c) FILTER (WHERE a > 5), COUNT(DISTINCT b) FILTER (WHERE b > 3)\\n\" +\n+      \"FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEzNTc0MA=="}, "originalCommit": {"oid": "1d4e987c1b33f2352f76469b73bc1c0ae39ef6b6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEzOTY1MQ==", "bodyText": "please move these cases to FlinkAggregateExpandDistinctAggregatesRuleTest\n\nI noticed there are common distinct tests between FlinkAggregateExpandDistinctAggregatesRuleTest and DistinctAggregateTest, it's better to reserve them here, and copy them to FlinkAggregateExpandDistinctAggregatesRuleTest as well?", "url": "https://github.com/apache/flink/pull/10760#discussion_r363139651", "createdAt": "2020-01-06T02:30:04Z", "author": {"login": "cshuo"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/batch/sql/agg/DistinctAggregateTest.scala", "diffHunk": "@@ -82,4 +83,39 @@ class DistinctAggregateTest extends TableTestBase {\n     util.verifyPlan(sqlQuery)\n   }\n \n+  @Test\n+  def testSingleDistinctWithFilter(): Unit = {\n+    val sqlQuery = \"SELECT d, COUNT(DISTINCT c) FILTER (WHERE a > 0) FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+\n+  @Test\n+  def testMultiDistinctOnSameColumnWithFilter(): Unit = {\n+    val sqlQuery = \"SELECT d, COUNT(DISTINCT c), COUNT(DISTINCT c) FILTER (WHERE a > 10),\\n\" +\n+      \"COUNT(DISTINCT c) FILTER (WHERE a < 10) FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+\n+  @Test\n+  def TestMultiDistinctOnDifferentColumnWithFilter(): Unit = {\n+    val sqlQuery = \"SELECT d, COUNT(DISTINCT c), COUNT(DISTINCT c) FILTER (WHERE a > 0),\\n\" +\n+      \"COUNT(DISTINCT b) FILTER (WHERE b > 1) FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+\n+  @Test\n+  def TestMultiDistinctWithFilterAndNonDistinctAgg(): Unit = {\n+    val sqlQuery = \"SELECT d, COUNT(DISTINCT c), COUNT(DISTINCT c) FILTER (WHERE a > 0),\\n\" +\n+      \"MAX(e), MIN(e) FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+\n+  @Test\n+  def testMultiDistinctAndNonDistinctAggWithFilter(): Unit = {\n+    val sqlQuery = \"SELECT d, MAX(e), MAX(e) FILTER (WHERE a < 10), COUNT(DISTINCT c),\\n\" +\n+      \"COUNT(DISTINCT c) FILTER (WHERE a > 5), COUNT(DISTINCT b) FILTER (WHERE b > 3)\\n\" +\n+      \"FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEzNTc0MA=="}, "originalCommit": {"oid": "1d4e987c1b33f2352f76469b73bc1c0ae39ef6b6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE4MTIwNw==", "bodyText": "actually, It's better to extract a common test case base named DistinctAggregateTestBase (like AggregateReduceGroupingTestBase)", "url": "https://github.com/apache/flink/pull/10760#discussion_r363181207", "createdAt": "2020-01-06T07:17:44Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/batch/sql/agg/DistinctAggregateTest.scala", "diffHunk": "@@ -82,4 +83,39 @@ class DistinctAggregateTest extends TableTestBase {\n     util.verifyPlan(sqlQuery)\n   }\n \n+  @Test\n+  def testSingleDistinctWithFilter(): Unit = {\n+    val sqlQuery = \"SELECT d, COUNT(DISTINCT c) FILTER (WHERE a > 0) FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+\n+  @Test\n+  def testMultiDistinctOnSameColumnWithFilter(): Unit = {\n+    val sqlQuery = \"SELECT d, COUNT(DISTINCT c), COUNT(DISTINCT c) FILTER (WHERE a > 10),\\n\" +\n+      \"COUNT(DISTINCT c) FILTER (WHERE a < 10) FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+\n+  @Test\n+  def TestMultiDistinctOnDifferentColumnWithFilter(): Unit = {\n+    val sqlQuery = \"SELECT d, COUNT(DISTINCT c), COUNT(DISTINCT c) FILTER (WHERE a > 0),\\n\" +\n+      \"COUNT(DISTINCT b) FILTER (WHERE b > 1) FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+\n+  @Test\n+  def TestMultiDistinctWithFilterAndNonDistinctAgg(): Unit = {\n+    val sqlQuery = \"SELECT d, COUNT(DISTINCT c), COUNT(DISTINCT c) FILTER (WHERE a > 0),\\n\" +\n+      \"MAX(e), MIN(e) FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+\n+  @Test\n+  def testMultiDistinctAndNonDistinctAggWithFilter(): Unit = {\n+    val sqlQuery = \"SELECT d, MAX(e), MAX(e) FILTER (WHERE a < 10), COUNT(DISTINCT c),\\n\" +\n+      \"COUNT(DISTINCT c) FILTER (WHERE a > 5), COUNT(DISTINCT b) FILTER (WHERE b > 3)\\n\" +\n+      \"FROM MyTable2 GROUP BY d\"\n+    util.verifyPlan(sqlQuery)\n+  }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEzNTc0MA=="}, "originalCommit": {"oid": "1d4e987c1b33f2352f76469b73bc1c0ae39ef6b6"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MjYyMDk3OnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-planner-blink/src/main/java/org/apache/flink/table/planner/plan/rules/logical/FlinkAggregateExpandDistinctAggregatesRule.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwMjowMDowMVrOFaUEnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwMjowMDowMVrOFaUEnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEzNjE1Nw==", "bodyText": "it's better to extract nodes.add(relBuilder.alias(project, \"$g_\" + v) as common part", "url": "https://github.com/apache/flink/pull/10760#discussion_r363136157", "createdAt": "2020-01-06T02:00:01Z", "author": {"login": "godfreyhe"}, "path": "flink-table/flink-table-planner-blink/src/main/java/org/apache/flink/table/planner/plan/rules/logical/FlinkAggregateExpandDistinctAggregatesRule.java", "diffHunk": "@@ -471,10 +474,24 @@ private void rewriteUsingGroupingSets(RelOptRuleCall call,\n \t\t\tfinal RexNode nodeZ = nodes.remove(nodes.size() - 1);\n \t\t\tfor (Map.Entry<ImmutableBitSet, Integer> entry : filters.entrySet()) {\n \t\t\t\tfinal long v = groupValue(fullGroupSet, entry.getKey());\n-\t\t\t\tnodes.add(\n+\t\t\t\t// Remap and get the filterArg of the distinct aggregate call.\n+\t\t\t\tint distinctAggCallFilterArg = remap(fullGroupSet,\n+\t\t\t\t\tgroupSetToDistinctAggCallFilterArg.getOrDefault(entry.getKey(), -1));\n+\t\t\t\tif (distinctAggCallFilterArg < 0) {\n+\t\t\t\t\tnodes.add(\n \t\t\t\t\t\trelBuilder.alias(\n-\t\t\t\t\t\t\t\trelBuilder.equals(nodeZ, relBuilder.literal(v)),\n-\t\t\t\t\t\t\t\t\"$g_\" + v));\n+\t\t\t\t\t\t\trelBuilder.equals(nodeZ, relBuilder.literal(v)),\n+\t\t\t\t\t\t\t\"$g_\" + v));\n+\t\t\t\t} else {\n+\t\t\t\t\tRexBuilder rexBuilder = aggregate.getCluster().getRexBuilder();\n+\t\t\t\t\t// merge the filter of the distinct aggregate call itself.\n+\t\t\t\t\tnodes.add(relBuilder.alias(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d4e987c1b33f2352f76469b73bc1c0ae39ef6b6"}, "originalPosition": 38}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1275, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}