{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5ODYxMDgw", "number": 10784, "title": "[FLINK-15494] Fix time field index wrong in LogicalWindowAggregateRul\u2026", "bodyText": "\u2026eBase\n\nWhat is the purpose of the change\nFix time field index error in some cases.\nBrief change log\nCalculate time field index based on new LogicalProject directly in LogicalWindowAggregateRuleBase.\nVerifying this change\nThis change added tests and can be verified as follows:\nWindowAggregateITCase. testDoubleTumbleWindow\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-01-07T07:25:57Z", "url": "https://github.com/apache/flink/pull/10784", "merged": true, "mergeCommit": {"oid": "5281212cac3d4a190f3ca2f100d5a9caa2db92e1"}, "closed": true, "closedAt": "2020-02-04T05:29:53Z", "author": {"login": "libenchao"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb36cMPgH2gAyMzU5ODYxMDgwOmQ2YjI0NzY2NTA0YmMxZjFmMWQwMDFlNmZhYTNmODVlMmY0NjY3ZTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcA6sXTAFqTM1MjczMTYzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d6b24766504bc1f1f1d001e6faa3f85e2f4667e9", "author": {"user": {"login": "libenchao", "name": "Benchao Li"}}, "url": "https://github.com/apache/flink/commit/d6b24766504bc1f1f1d001e6faa3f85e2f4667e9", "committedDate": "2020-01-07T06:06:03Z", "message": "[FLINK-15494] Fix time field index wrong in LogicalWindowAggregateRuleBase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb4e34ec77c0af9856af02b337984bf0a05fae34", "author": {"user": {"login": "libenchao", "name": "Benchao Li"}}, "url": "https://github.com/apache/flink/commit/cb4e34ec77c0af9856af02b337984bf0a05fae34", "committedDate": "2020-01-07T07:27:37Z", "message": "remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0e5cb3e0d2cc118c98cd91e0470c5123219d1ec", "author": {"user": {"login": "libenchao", "name": "Benchao Li"}}, "url": "https://github.com/apache/flink/commit/d0e5cb3e0d2cc118c98cd91e0470c5123219d1ec", "committedDate": "2020-01-07T07:28:51Z", "message": "remove blank line"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNjk1MTc2", "url": "https://github.com/apache/flink/pull/10784#pullrequestreview-341695176", "createdAt": "2020-01-13T08:48:34Z", "commit": {"oid": "d0e5cb3e0d2cc118c98cd91e0470c5123219d1ec"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwODo0ODozNFrOFcv9vQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMTo1NDoyMVrOFc0jPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY5MDMwMQ==", "bodyText": "Please rename to testCascadingTumbleWindow or testNestedTumbleWindow.", "url": "https://github.com/apache/flink/pull/10784#discussion_r365690301", "createdAt": "2020-01-13T08:48:34Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/stream/sql/WindowAggregateITCase.scala", "diffHunk": "@@ -100,6 +100,35 @@ class WindowAggregateITCase(mode: StateBackendMode)\n     assertEquals(expected.sorted, sink.getAppendResults.sorted)\n   }\n \n+  @Test\n+  def testDoubleTumbleWindow(): Unit = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0e5cb3e0d2cc118c98cd91e0470c5123219d1ec"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc1OTc1NA==", "bodyText": "Could you add a similar nested window agg test for batch?\nYou can place it in org.apache.flink.table.planner.runtime.batch.sql.agg.WindowAggregateITCase.", "url": "https://github.com/apache/flink/pull/10784#discussion_r365759754", "createdAt": "2020-01-13T11:38:50Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/stream/sql/WindowAggregateITCase.scala", "diffHunk": "@@ -100,6 +100,35 @@ class WindowAggregateITCase(mode: StateBackendMode)\n     assertEquals(expected.sorted, sink.getAppendResults.sorted)\n   }\n \n+  @Test\n+  def testDoubleTumbleWindow(): Unit = {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY5MDMwMQ=="}, "originalCommit": {"oid": "d0e5cb3e0d2cc118c98cd91e0470c5123219d1ec"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc2NDIwNQ==", "bodyText": "The fix looks good to me. However, could you add some comments or change the parameter windowExprIdx to timeAttributeIndex ? As we know, windowExprIdx is timeAttributeIndex and so the rowtime field reference is accessed by windowExprIdx.\nThe same to StreamLogicalWindowAggregateRule.", "url": "https://github.com/apache/flink/pull/10784#discussion_r365764205", "createdAt": "2020-01-13T11:51:02Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/rules/logical/BatchLogicalWindowAggregateRule.scala", "diffHunk": "@@ -62,27 +61,14 @@ class BatchLogicalWindowAggregateRule\n       throw new ValidationException(\"Window can not be defined over \"\n         + \"a proctime attribute column for batch mode\")\n     }\n-    operand match {\n-      case c: RexCall if c.getKind == SqlKind.CAST =>\n-        getTimeFieldReference(c.getOperands.get(0), windowExprIdx, rowType)\n-      // match TUMBLE_ROWTIME and TUMBLE_PROCTIME\n-      case c: RexCall if c.getOperands.size() == 1 &&\n-        FlinkTypeFactory.isTimeIndicatorType(c.getType) =>\n-        new FieldReferenceExpression(\n-          rowType.getFieldList.get(windowExprIdx).getName,\n-          fromLogicalTypeToDataType(toLogicalType(c.getType)),\n-          0, // only one input, should always be 0\n-          windowExprIdx)\n-      case ref: RexInputRef =>\n-        // resolve field name of window attribute\n-        val fieldName = rowType.getFieldList.get(ref.getIndex).getName\n-        val fieldType = rowType.getFieldList.get(ref.getIndex).getType\n-        new FieldReferenceExpression(\n-          fieldName,\n-          fromLogicalTypeToDataType(toLogicalType(fieldType)),\n-          0, // only one input, should always be 0\n-          windowExprIdx)\n-    }\n+\n+    val fieldName = rowType.getFieldList.get(windowExprIdx).getName\n+    val fieldType = rowType.getFieldList.get(windowExprIdx).getType\n+    new FieldReferenceExpression(\n+      fieldName,\n+      fromLogicalTypeToDataType(toLogicalType(fieldType)),\n+      0,\n+      windowExprIdx)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0e5cb3e0d2cc118c98cd91e0470c5123219d1ec"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc2NTQzOQ==", "bodyText": "Because translateWindow is postponed after getInAggregateGroupExpression, so if the time field is not a time attribute, the exception will be thrown from getInAggregateGroupExpression. But the exception there is not clear enought. Could you improve the exception in getInAggregateGroupExpression? For example:\ns\"Window aggregate can only be defined over a time attribute column, but ${timeAttribute.getType} encountered.\"", "url": "https://github.com/apache/flink/pull/10784#discussion_r365765439", "createdAt": "2020-01-13T11:54:21Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/rules/logical/LogicalWindowAggregateRuleBase.scala", "diffHunk": "@@ -88,6 +85,9 @@ abstract class LogicalWindowAggregateRuleBase(description: String)\n       .project(project.getChildExps.updated(windowExprIdx, inAggGroupExpression))\n       .build()\n \n+    // translate window against newProject.\n+    val window = translateWindow(windowExpr, windowExprIdx, newProject.getRowType)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0e5cb3e0d2cc118c98cd91e0470c5123219d1ec"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c58517317e7de5dda91742eaf5d0e6d23d3d14a0", "author": {"user": {"login": "libenchao", "name": "Benchao Li"}}, "url": "https://github.com/apache/flink/commit/c58517317e7de5dda91742eaf5d0e6d23d3d14a0", "committedDate": "2020-01-14T00:44:24Z", "message": "Refine naming and add tests in batch WindowAggregateITCase"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNzMxNjM5", "url": "https://github.com/apache/flink/pull/10784#pullrequestreview-352731639", "createdAt": "2020-02-04T05:29:02Z", "commit": {"oid": "c58517317e7de5dda91742eaf5d0e6d23d3d14a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4975, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}