{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4MzUzMjk1", "number": 13543, "title": "[FLINK-19509][Format-json] Fix ClassCastException of JsonRowDataDeserializationSchema and JsonRowDataSerializationSchema when type is multiset", "bodyText": "What is the purpose of the change\nFix ClassCastException of JsonRowDataDeserializationSchema and JsonRowDataSerializationSchema when type is multiset\nBrief change log\nAdd the determination of  multiset type for JsonToRowDataConverters#createMapConverter and RowDataToJsonConverters#createMapConverter\nVerifying this change\nThis change added tests and can be verified as follows:\nJsonRowDataSerDeSchemaTest#testSerDe\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (no)\nThe serializers: (no)\nThe runtime per-record code paths (performance sensitive): (no)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (no)\nThe S3 file system connector: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-10-06T08:10:37Z", "url": "https://github.com/apache/flink/pull/13543", "merged": true, "mergeCommit": {"oid": "d4f2abb278047180cd174febc45acb432f5b0735"}, "closed": true, "closedAt": "2020-10-10T07:56:02Z", "author": {"login": "wangxlong"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPzxS1AH2gAyNDk4MzUzMjk1OmRjNjdiNmRlOTg5MDE0YWZiZDY4MjU0MGQ4ODg2N2I0YTRiMDI3ZWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdRFB-lAFqTUwNjA3MjQ3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dc67b6de989014afbd682540d88867b4a4b027ed", "author": {"user": {"login": "wangxlong", "name": null}}, "url": "https://github.com/apache/flink/commit/dc67b6de989014afbd682540d88867b4a4b027ed", "committedDate": "2020-10-06T08:05:06Z", "message": "[FLINK-19509][Format-json] Fix ClassCastException of JsonRowDataDeserializationSchema and JsonRowDataSerializationSchema when type is multiset"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1Mzg2MTM5", "url": "https://github.com/apache/flink/pull/13543#pullrequestreview-505386139", "createdAt": "2020-10-09T06:11:00Z", "commit": {"oid": "dc67b6de989014afbd682540d88867b4a4b027ed"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNjoxMTowMFrOHe8XrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNjoxMjowMlrOHe8Y_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIwODQyOA==", "bodyText": "I would suggest to change the method parameters to createMapConverter(String typeSummary, LogicalType keyType, LogicalType valueType) and move the above code out of the method (i.e. move to the switch case block). This can make the method createMapConverter more generic.", "url": "https://github.com/apache/flink/pull/13543#discussion_r502208428", "createdAt": "2020-10-09T06:11:00Z", "author": {"login": "wuchong"}, "path": "flink-formats/flink-json/src/main/java/org/apache/flink/formats/json/JsonToRowDataConverters.java", "diffHunk": "@@ -298,15 +300,25 @@ private JsonToRowDataConverter createArrayConverter(ArrayType arrayType) {\n \t\t};\n \t}\n \n-\tprivate JsonToRowDataConverter createMapConverter(MapType mapType) {\n-\t\tLogicalType keyType = mapType.getKeyType();\n+\tprivate JsonToRowDataConverter createMapConverter(LogicalType type) {\n+\t\tLogicalType keyType;\n+\t\tLogicalType valueType;\n+\t\tif (type instanceof MapType) {\n+\t\t\tMapType mapType = (MapType) type;\n+\t\t\tkeyType = mapType.getKeyType();\n+\t\t\tvalueType = mapType.getValueType();\n+\t\t} else {\n+\t\t\tMultisetType multisetType = (MultisetType) type;\n+\t\t\tkeyType = multisetType.getElementType();\n+\t\t\tvalueType = new IntType();\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc67b6de989014afbd682540d88867b4a4b027ed"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIwODc2NA==", "bodyText": "The same to above.", "url": "https://github.com/apache/flink/pull/13543#discussion_r502208764", "createdAt": "2020-10-09T06:12:02Z", "author": {"login": "wuchong"}, "path": "flink-formats/flink-json/src/main/java/org/apache/flink/formats/json/RowDataToJsonConverters.java", "diffHunk": "@@ -218,14 +220,23 @@ private RowDataToJsonConverter createArrayConverter(ArrayType type) {\n \t\t};\n \t}\n \n-\tprivate RowDataToJsonConverter createMapConverter(MapType type) {\n-\t\tLogicalType keyType = type.getKeyType();\n+\tprivate RowDataToJsonConverter createMapConverter(LogicalType type) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc67b6de989014afbd682540d88867b4a4b027ed"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "943ce138bc7e39dad85260bebf628f52f12d0a04", "author": {"user": {"login": "wangxlong", "name": null}}, "url": "https://github.com/apache/flink/commit/943ce138bc7e39dad85260bebf628f52f12d0a04", "committedDate": "2020-10-09T07:02:05Z", "message": "[FLINK-19509][format-json] fix comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDU2Mzc4", "url": "https://github.com/apache/flink/pull/13543#pullrequestreview-506056378", "createdAt": "2020-10-10T02:11:02Z", "commit": {"oid": "943ce138bc7e39dad85260bebf628f52f12d0a04"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMjoxMTowMlrOHfcZXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMjoxMTo0NVrOHfcZmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjczMzE1MQ==", "bodyText": "Add one more indent for parameters if they start a new line.", "url": "https://github.com/apache/flink/pull/13543#discussion_r502733151", "createdAt": "2020-10-10T02:11:02Z", "author": {"login": "wuchong"}, "path": "flink-formats/flink-json/src/main/java/org/apache/flink/formats/json/JsonToRowDataConverters.java", "diffHunk": "@@ -300,22 +305,12 @@ private JsonToRowDataConverter createArrayConverter(ArrayType arrayType) {\n \t\t};\n \t}\n \n-\tprivate JsonToRowDataConverter createMapConverter(LogicalType type) {\n-\t\tLogicalType keyType;\n-\t\tLogicalType valueType;\n-\t\tif (type instanceof MapType) {\n-\t\t\tMapType mapType = (MapType) type;\n-\t\t\tkeyType = mapType.getKeyType();\n-\t\t\tvalueType = mapType.getValueType();\n-\t\t} else {\n-\t\t\tMultisetType multisetType = (MultisetType) type;\n-\t\t\tkeyType = multisetType.getElementType();\n-\t\t\tvalueType = new IntType();\n-\t\t}\n+\tprivate JsonToRowDataConverter createMapConverter(\n+\t\tString typeSummary, LogicalType keyType, LogicalType valueType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "943ce138bc7e39dad85260bebf628f52f12d0a04"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjczMzE2Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\t\"The map type is: \" + typeSummary);\n          \n          \n            \n            \t\t\t\t\t\"The type is: \" + typeSummary);", "url": "https://github.com/apache/flink/pull/13543#discussion_r502733162", "createdAt": "2020-10-10T02:11:15Z", "author": {"login": "wuchong"}, "path": "flink-formats/flink-json/src/main/java/org/apache/flink/formats/json/JsonToRowDataConverters.java", "diffHunk": "@@ -300,22 +305,12 @@ private JsonToRowDataConverter createArrayConverter(ArrayType arrayType) {\n \t\t};\n \t}\n \n-\tprivate JsonToRowDataConverter createMapConverter(LogicalType type) {\n-\t\tLogicalType keyType;\n-\t\tLogicalType valueType;\n-\t\tif (type instanceof MapType) {\n-\t\t\tMapType mapType = (MapType) type;\n-\t\t\tkeyType = mapType.getKeyType();\n-\t\t\tvalueType = mapType.getValueType();\n-\t\t} else {\n-\t\t\tMultisetType multisetType = (MultisetType) type;\n-\t\t\tkeyType = multisetType.getElementType();\n-\t\t\tvalueType = new IntType();\n-\t\t}\n+\tprivate JsonToRowDataConverter createMapConverter(\n+\t\tString typeSummary, LogicalType keyType, LogicalType valueType) {\n \t\tif (!LogicalTypeChecks.hasFamily(keyType, LogicalTypeFamily.CHARACTER_STRING)) {\n \t\t\tthrow new UnsupportedOperationException(\n \t\t\t\t\"JSON format doesn't support non-string as key type of map. \" +\n-\t\t\t\t\t\"The map type is: \" + type.asSummaryString());\n+\t\t\t\t\t\"The map type is: \" + typeSummary);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "943ce138bc7e39dad85260bebf628f52f12d0a04"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjczMzE5NQ==", "bodyText": "Add one more indent for parameters if they start a new line.", "url": "https://github.com/apache/flink/pull/13543#discussion_r502733195", "createdAt": "2020-10-10T02:11:36Z", "author": {"login": "wuchong"}, "path": "flink-formats/flink-json/src/main/java/org/apache/flink/formats/json/RowDataToJsonConverters.java", "diffHunk": "@@ -218,14 +225,13 @@ private RowDataToJsonConverter createArrayConverter(ArrayType type) {\n \t\t};\n \t}\n \n-\tprivate RowDataToJsonConverter createMapConverter(MapType type) {\n-\t\tLogicalType keyType = type.getKeyType();\n+\tprivate RowDataToJsonConverter createMapConverter(\n+\t\tString typeSummary, LogicalType keyType, LogicalType valueType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "943ce138bc7e39dad85260bebf628f52f12d0a04"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjczMzIxMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\t\"The map type is: \" + typeSummary);\n          \n          \n            \n            \t\t\t\t\t\"The type is: \" + typeSummary);", "url": "https://github.com/apache/flink/pull/13543#discussion_r502733210", "createdAt": "2020-10-10T02:11:45Z", "author": {"login": "wuchong"}, "path": "flink-formats/flink-json/src/main/java/org/apache/flink/formats/json/RowDataToJsonConverters.java", "diffHunk": "@@ -218,14 +225,13 @@ private RowDataToJsonConverter createArrayConverter(ArrayType type) {\n \t\t};\n \t}\n \n-\tprivate RowDataToJsonConverter createMapConverter(MapType type) {\n-\t\tLogicalType keyType = type.getKeyType();\n+\tprivate RowDataToJsonConverter createMapConverter(\n+\t\tString typeSummary, LogicalType keyType, LogicalType valueType) {\n \t\tif (!LogicalTypeChecks.hasFamily(keyType, LogicalTypeFamily.CHARACTER_STRING)) {\n \t\t\tthrow new UnsupportedOperationException(\n \t\t\t\t\"JSON format doesn't support non-string as key type of map. \" +\n-\t\t\t\t\t\"The map type is: \" + type.asSummaryString());\n+\t\t\t\t\t\"The map type is: \" + typeSummary);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "943ce138bc7e39dad85260bebf628f52f12d0a04"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1603eee07aa5af3a14571cf4301311504ac83e71", "author": {"user": {"login": "wangxlong", "name": null}}, "url": "https://github.com/apache/flink/commit/1603eee07aa5af3a14571cf4301311504ac83e71", "committedDate": "2020-10-10T02:41:45Z", "message": "[FLINK-19509][format-json] Fix comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDcyNDcz", "url": "https://github.com/apache/flink/pull/13543#pullrequestreview-506072473", "createdAt": "2020-10-10T06:45:38Z", "commit": {"oid": "1603eee07aa5af3a14571cf4301311504ac83e71"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3705, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}