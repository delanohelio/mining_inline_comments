{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2NTU3OTQy", "number": 13697, "title": "[FLINK-19357][FLINK-19357][fs-connector] Introduce createBucketWriter to BucketsBuilder & Introduce FileLifeCycleListener to Buckets", "bodyText": "What is the purpose of the change & Brief change log\n\nIntroduce createBucketWriter to BucketsBuilder: Compaction operator depends on BucketWriter to write compacted file.\nIntroduce FileLifeCycleListener to Buckets: Compaction operator depends on this to compact files in downstream operator\n\nVerifying this change\nBucketsTest.testFileLifeCycleListener\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? yes\nIf yes, how is the feature documented? JavaDocs", "createdAt": "2020-10-20T07:43:47Z", "url": "https://github.com/apache/flink/pull/13697", "merged": true, "mergeCommit": {"oid": "79bb3ab192fa8af54fbb29e4d54b3bed27028929"}, "closed": true, "closedAt": "2020-10-30T02:03:59Z", "author": {"login": "JingsongLi"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUTa5rAH2gAyNTA2NTU3OTQyOjU0ZjA2YjUwYWZkMjNhZjRjNDhjZjMwNDhmMDQxNDBhY2Y0OTc0YmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXPcaNABqjM5MzU1MTEwNTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "54f06b50afd23af4c48cf3048f04140acf4974ba", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/54f06b50afd23af4c48cf3048f04140acf4974ba", "committedDate": "2020-10-20T07:13:18Z", "message": "[FLINK-19357][fs-connector] Introduce createBucketWriter to BucketsBuilder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTA5NTUz", "url": "https://github.com/apache/flink/pull/13697#pullrequestreview-517909553", "createdAt": "2020-10-27T16:33:49Z", "commit": {"oid": "b45885955bfdee4d4288f9273171e1d52379773f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjozMzo0OVrOHpFsfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjozMzo0OVrOHpFsfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0Njk3Mw==", "bodyText": "Here we should not expose the whole Bucket as this is an internal class that can change anytime.\nWe can pass here a new interface, something like BucketInfo, which is going to be implemented by the Bucket and which only exposes the necessary information. Currently, these are the public methods in the Bucket, ie.  the BucketID getBucketId(), Path getBucketPath(), and long getPartCounter().\nActually, I would recommend to not expose the part counter because this will not be supported anymore in the new FileSink. If you need access to the in-progress file path, then simply pass that (the result of the assembleNewPartPath()) it in a field and have a method getInProgressFilePath() in the new BucketInfo interface.", "url": "https://github.com/apache/flink/pull/13697#discussion_r512846973", "createdAt": "2020-10-27T16:33:49Z", "author": {"login": "kl0u"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/filesystem/FileLifeCycleListener.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.streaming.api.functions.sink.filesystem;\n+\n+import org.apache.flink.annotation.Internal;\n+import org.apache.flink.core.fs.Path;\n+\n+/**\n+ * Listener about the status of file.\n+ */\n+@Internal\n+public interface FileLifeCycleListener<IN, BucketID> {\n+\n+\t/**\n+\t * Notifies a new file has been opened.\n+\t *\n+\t * <p>Note that this does not mean that the file has been created in the file system. It is\n+\t * only created logically and the actual file will be generated after it is committed.\n+\t *\n+\t * @param bucket The bucket of newly opened file.\n+\t * @param newPath The path of newly opened file.\n+\t */\n+\tvoid openPartFile(Bucket<IN, BucketID> bucket, Path newPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b45885955bfdee4d4288f9273171e1d52379773f"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTEwMDA2", "url": "https://github.com/apache/flink/pull/13697#pullrequestreview-517910006", "createdAt": "2020-10-27T16:34:15Z", "commit": {"oid": "b45885955bfdee4d4288f9273171e1d52379773f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjozNDoxNVrOHpFtug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjozNDoxNVrOHpFtug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0NzI5MA==", "bodyText": "Shouldn't we also have a closePathFile() for symmetry?", "url": "https://github.com/apache/flink/pull/13697#discussion_r512847290", "createdAt": "2020-10-27T16:34:15Z", "author": {"login": "kl0u"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/filesystem/FileLifeCycleListener.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.streaming.api.functions.sink.filesystem;\n+\n+import org.apache.flink.annotation.Internal;\n+import org.apache.flink.core.fs.Path;\n+\n+/**\n+ * Listener about the status of file.\n+ */\n+@Internal\n+public interface FileLifeCycleListener<IN, BucketID> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b45885955bfdee4d4288f9273171e1d52379773f"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTEzNDgz", "url": "https://github.com/apache/flink/pull/13697#pullrequestreview-517913483", "createdAt": "2020-10-27T16:37:45Z", "commit": {"oid": "b45885955bfdee4d4288f9273171e1d52379773f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjozNzo0NlrOHpF4fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjozNzo0NlrOHpF4fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg1MDA0Ng==", "bodyText": "Why not having an Optional instead of a @Nullable? I think null leads to more \"fragile\" code and more difficult to maintain.", "url": "https://github.com/apache/flink/pull/13697#discussion_r512850046", "createdAt": "2020-10-27T16:37:46Z", "author": {"login": "kl0u"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/filesystem/BucketFactory.java", "diffHunk": "@@ -37,6 +39,7 @@\n \t\t\tfinal long initialPartCounter,\n \t\t\tfinal BucketWriter<IN, BucketID> bucketWriter,\n \t\t\tfinal RollingPolicy<IN, BucketID> rollingPolicy,\n+\t\t\t@Nullable final FileLifeCycleListener<IN, BucketID> fileListener,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b45885955bfdee4d4288f9273171e1d52379773f"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTEzNjUy", "url": "https://github.com/apache/flink/pull/13697#pullrequestreview-517913652", "createdAt": "2020-10-27T16:37:55Z", "commit": {"oid": "b45885955bfdee4d4288f9273171e1d52379773f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjozNzo1NVrOHpF5BQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjozNzo1NVrOHpF5BQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg1MDE4MQ==", "bodyText": "Same as above.", "url": "https://github.com/apache/flink/pull/13697#discussion_r512850181", "createdAt": "2020-10-27T16:37:55Z", "author": {"login": "kl0u"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/filesystem/BucketFactory.java", "diffHunk": "@@ -45,5 +48,6 @@\n \t\t\tfinal BucketWriter<IN, BucketID> bucketWriter,\n \t\t\tfinal RollingPolicy<IN, BucketID> rollingPolicy,\n \t\t\tfinal BucketState<BucketID> bucketState,\n+\t\t\t@Nullable final FileLifeCycleListener<IN, BucketID> fileListener,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b45885955bfdee4d4288f9273171e1d52379773f"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTE0MzI1", "url": "https://github.com/apache/flink/pull/13697#pullrequestreview-517914325", "createdAt": "2020-10-27T16:38:41Z", "commit": {"oid": "b45885955bfdee4d4288f9273171e1d52379773f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjozODo0MVrOHpF7Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjozODo0MVrOHpF7Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg1MDY5MA==", "bodyText": "Here also, why not Optional?", "url": "https://github.com/apache/flink/pull/13697#discussion_r512850690", "createdAt": "2020-10-27T16:38:41Z", "author": {"login": "kl0u"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/filesystem/Bucket.java", "diffHunk": "@@ -83,13 +86,15 @@ private Bucket(\n \t\t\tfinal long initialPartCounter,\n \t\t\tfinal BucketWriter<IN, BucketID> bucketWriter,\n \t\t\tfinal RollingPolicy<IN, BucketID> rollingPolicy,\n+\t\t\t@Nullable final FileLifeCycleListener<IN, BucketID> fileListener,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b45885955bfdee4d4288f9273171e1d52379773f"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTE4MDc4", "url": "https://github.com/apache/flink/pull/13697#pullrequestreview-517918078", "createdAt": "2020-10-27T16:42:28Z", "commit": {"oid": "b45885955bfdee4d4288f9273171e1d52379773f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjo0MjoyOFrOHpGF8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjo0MjoyOFrOHpGF8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg1MzQ5MQ==", "bodyText": "@JingsongLi could you describe how this method is going to be used? Because in this commit, it seems that it is a private method of the builder :) Could it at least be package-private so that it is not exposed to the user?", "url": "https://github.com/apache/flink/pull/13697#discussion_r512853491", "createdAt": "2020-10-27T16:42:28Z", "author": {"login": "kl0u"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/filesystem/StreamingFileSink.java", "diffHunk": "@@ -251,14 +254,20 @@ T withBucketFactory(final BucketFactory<IN, BucketID> factory) {\n \t\t\treturn self();\n \t\t}\n \n+\t\t@Internal\n+\t\t@Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b45885955bfdee4d4288f9273171e1d52379773f"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTE4Nzkz", "url": "https://github.com/apache/flink/pull/13697#pullrequestreview-517918793", "createdAt": "2020-10-27T16:43:13Z", "commit": {"oid": "b45885955bfdee4d4288f9273171e1d52379773f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MzA3MDk5", "url": "https://github.com/apache/flink/pull/13697#pullrequestreview-519307099", "createdAt": "2020-10-29T03:33:19Z", "commit": {"oid": "bd25177243a782fad2e7f9d9ff508e6ba3758303"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwMzozMzoxOVrOHqHQHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwMzozMzoxOVrOHqHQHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzkyMTA1Mg==", "bodyText": "I think we might change the name of this method to partFileOpened or onPartFileOpened, the current name seems to open the part file actually in this method.", "url": "https://github.com/apache/flink/pull/13697#discussion_r513921052", "createdAt": "2020-10-29T03:33:19Z", "author": {"login": "gaoyunhaii"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/filesystem/FileLifeCycleListener.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.streaming.api.functions.sink.filesystem;\n+\n+import org.apache.flink.annotation.Internal;\n+import org.apache.flink.core.fs.Path;\n+\n+/**\n+ * Listener about the status of file.\n+ */\n+@Internal\n+public interface FileLifeCycleListener<BucketID> {\n+\n+\t/**\n+\t * Notifies a new file has been opened.\n+\t *\n+\t * <p>Note that this does not mean that the file has been created in the file system. It is\n+\t * only created logically and the actual file will be generated after it is committed.\n+\t *\n+\t * @param bucketID The bucketID of newly opened file.\n+\t * @param newPath The path of newly opened file.\n+\t */\n+\tvoid openPartFile(BucketID bucketID, Path newPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd25177243a782fad2e7f9d9ff508e6ba3758303"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NDExOTIw", "url": "https://github.com/apache/flink/pull/13697#pullrequestreview-519411920", "createdAt": "2020-10-29T08:03:23Z", "commit": {"oid": "48c716cf4d460cd40d7f87eed79386a09d55ed5f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c0eba240f7daacc11e0fa08cb16cb5132873e7f", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/5c0eba240f7daacc11e0fa08cb16cb5132873e7f", "committedDate": "2020-10-29T08:16:17Z", "message": "[FLINK-19357][fs-connector] Introduce FileLifeCycleListener to Buckets\n\nThis closes #13697"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "48c716cf4d460cd40d7f87eed79386a09d55ed5f", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/48c716cf4d460cd40d7f87eed79386a09d55ed5f", "committedDate": "2020-10-29T05:48:31Z", "message": "change method name to onPartFileOpened"}, "afterCommit": {"oid": "5c0eba240f7daacc11e0fa08cb16cb5132873e7f", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/flink/commit/5c0eba240f7daacc11e0fa08cb16cb5132873e7f", "committedDate": "2020-10-29T08:16:17Z", "message": "[FLINK-19357][fs-connector] Introduce FileLifeCycleListener to Buckets\n\nThis closes #13697"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2917, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}