{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2MjkyOTM3", "number": 13286, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwNzoxMToyNVrOEewv2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwNzoyMDoxN1rOEexAjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNjkxNDE2OnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwNzoxMToyNVrOHKoDeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwNzoxMToyNVrOHKoDeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDkwNDA1Nw==", "bodyText": "nit: I guess it seem not very readable for message like .....releasing asyncCheckpointRunnable, 12. Maybe change to ......releasing asyncCheckpointRunnable for checkpoint 12? (Take checkpointId = 12 as example).", "url": "https://github.com/apache/flink/pull/13286#discussion_r480904057", "createdAt": "2020-09-01T07:11:25Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -366,11 +366,10 @@ private void registerAsyncCheckpointRunnable(long checkpointId, AsyncCheckpointR\n \t\tsynchronized (lock) {\n \t\t\tif (closed) {\n \t\t\t\tLOG.debug(\"Cannot register Closeable, this subtaskCheckpointCoordinator is already closed. Closing argument.\");\n-\t\t\t\tfinal boolean running = asyncCheckpointRunnable.isRunning();\n \t\t\t\tcloseQuietly(asyncCheckpointRunnable);\n \t\t\t\tcheckState(\n-\t\t\t\t\t!running,\n-\t\t\t\t\t\"SubtaskCheckpointCoordinatorImpl was closed without closing asyncCheckpointRunnable %s\",\n+\t\t\t\t\t!checkpoints.containsKey(checkpointId),\n+\t\t\t\t\t\"SubtaskCheckpointCoordinator was closed without releasing asyncCheckpointRunnable, %s\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "358ebf0c0aaffb505bc95a97d6133183ec749d7a"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNjk1NjkyOnYy", "diffSide": "LEFT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwNzoyMDoxN1rOHKoe8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwNzowMjoxMFrOHLfTUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDkxMTA5MQ==", "bodyText": "In the past we might encounter unnecessary exception while #registerAsyncCheckpointRunnable and AsyncCheckpointRunnable#close execute concurrently. Now we only close the runnable quietly without throwing any exception for closed case.\nI agree with this fix, but do we have any existing ITCase for covering/verifying this change?", "url": "https://github.com/apache/flink/pull/13286#discussion_r480911091", "createdAt": "2020-09-01T07:20:17Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -366,11 +366,10 @@ private void registerAsyncCheckpointRunnable(long checkpointId, AsyncCheckpointR\n \t\tsynchronized (lock) {\n \t\t\tif (closed) {\n \t\t\t\tLOG.debug(\"Cannot register Closeable, this subtaskCheckpointCoordinator is already closed. Closing argument.\");\n-\t\t\t\tfinal boolean running = asyncCheckpointRunnable.isRunning();\n \t\t\t\tcloseQuietly(asyncCheckpointRunnable);\n \t\t\t\tcheckState(\n-\t\t\t\t\t!running,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "358ebf0c0aaffb505bc95a97d6133183ec749d7a"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDkyMTA4OA==", "bodyText": "I think there are no ITCases covering this, but some existing end-to-end tests indirectly cover this.", "url": "https://github.com/apache/flink/pull/13286#discussion_r480921088", "createdAt": "2020-09-01T07:32:21Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -366,11 +366,10 @@ private void registerAsyncCheckpointRunnable(long checkpointId, AsyncCheckpointR\n \t\tsynchronized (lock) {\n \t\t\tif (closed) {\n \t\t\t\tLOG.debug(\"Cannot register Closeable, this subtaskCheckpointCoordinator is already closed. Closing argument.\");\n-\t\t\t\tfinal boolean running = asyncCheckpointRunnable.isRunning();\n \t\t\t\tcloseQuietly(asyncCheckpointRunnable);\n \t\t\t\tcheckState(\n-\t\t\t\t\t!running,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDkxMTA5MQ=="}, "originalCommit": {"oid": "358ebf0c0aaffb505bc95a97d6133183ec749d7a"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTc5Mzc4MQ==", "bodyText": "I am a bit torn whether it deserves somehow UT or ITCase for the changes.\nIt seems not bad to be covered by existing E2E tests, so I am fine with you final judgement here.", "url": "https://github.com/apache/flink/pull/13286#discussion_r481793781", "createdAt": "2020-09-02T06:42:05Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -366,11 +366,10 @@ private void registerAsyncCheckpointRunnable(long checkpointId, AsyncCheckpointR\n \t\tsynchronized (lock) {\n \t\t\tif (closed) {\n \t\t\t\tLOG.debug(\"Cannot register Closeable, this subtaskCheckpointCoordinator is already closed. Closing argument.\");\n-\t\t\t\tfinal boolean running = asyncCheckpointRunnable.isRunning();\n \t\t\t\tcloseQuietly(asyncCheckpointRunnable);\n \t\t\t\tcheckState(\n-\t\t\t\t\t!running,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDkxMTA5MQ=="}, "originalCommit": {"oid": "358ebf0c0aaffb505bc95a97d6133183ec749d7a"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgwOTIzNA==", "bodyText": "Then let's leave it as-is for now.", "url": "https://github.com/apache/flink/pull/13286#discussion_r481809234", "createdAt": "2020-09-02T07:02:10Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -366,11 +366,10 @@ private void registerAsyncCheckpointRunnable(long checkpointId, AsyncCheckpointR\n \t\tsynchronized (lock) {\n \t\t\tif (closed) {\n \t\t\t\tLOG.debug(\"Cannot register Closeable, this subtaskCheckpointCoordinator is already closed. Closing argument.\");\n-\t\t\t\tfinal boolean running = asyncCheckpointRunnable.isRunning();\n \t\t\t\tcloseQuietly(asyncCheckpointRunnable);\n \t\t\t\tcheckState(\n-\t\t\t\t\t!running,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDkxMTA5MQ=="}, "originalCommit": {"oid": "358ebf0c0aaffb505bc95a97d6133183ec749d7a"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 375, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}