{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4MDYyNDQx", "number": 13741, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjozNDo1NFrOEx4VjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMzoxMDoxOVrOEx5IUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzM4NzAxOnYy", "diffSide": "LEFT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/AlternatingController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjozNDo1NFrOHoNeCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjozNDo1NFrOHoNeCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkyNTc3MA==", "bodyText": "Typo is commit msg.", "url": "https://github.com/apache/flink/pull/13741#discussion_r511925770", "createdAt": "2020-10-26T12:34:54Z", "author": {"login": "AHeise"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/AlternatingController.java", "diffHunk": "@@ -35,7 +35,6 @@\n \tprivate final AlignedController alignedController;\n \tprivate final UnalignedController unalignedController;\n \tprivate  CheckpointBarrierBehaviourController activeController;\n-\tprivate long lastSeenBarrierId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5799cc5ba94c7268fac36dfcaf10981a6b5579b"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzM4ODE4OnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/AlternatingController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjozNToxMlrOHoNexA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjozNToxMlrOHoNexA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkyNTk1Ng==", "bodyText": "Can you fix the double-spacing here as well?", "url": "https://github.com/apache/flink/pull/13741#discussion_r511925956", "createdAt": "2020-10-26T12:35:12Z", "author": {"login": "AHeise"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/AlternatingController.java", "diffHunk": "@@ -35,7 +35,6 @@\n \tprivate final AlignedController alignedController;\n \tprivate final UnalignedController unalignedController;\n \tprivate  CheckpointBarrierBehaviourController activeController;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5799cc5ba94c7268fac36dfcaf10981a6b5579b"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzM5OTQyOnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjozODoxM1rOHoNlYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjozODoxM1rOHoNlYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkyNzY1MQ==", "bodyText": "nit: double indent. Also in various other places in this commit. Ignore if intended.", "url": "https://github.com/apache/flink/pull/13741#discussion_r511927651", "createdAt": "2020-10-26T12:38:13Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java", "diffHunk": "@@ -773,11 +776,12 @@ private void snapshotTaskState(\n \t\tExecution[] executions,\n \t\tboolean advanceToEndOfTime) {\n \n-\t\tfinal CheckpointOptions checkpointOptions = new CheckpointOptions(\n-\t\t\tprops.getCheckpointType(),\n-\t\t\tcheckpointStorageLocation.getLocationReference(),\n-\t\t\tisExactlyOnceMode,\n-\t\t\tprops.getCheckpointType() == CheckpointType.CHECKPOINT && unalignedCheckpointsEnabled);\n+\t\tfinal CheckpointOptions checkpointOptions = CheckpointOptions.create(\n+\t\t\t\tprops.getCheckpointType(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e26fb076f97cb27397a1d76d26aff11790e438f"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzQxNTkyOnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointOptions.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjo0MjozOFrOHoNvPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxODoyODoxN1rOHoc9Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMDE3Mg==", "bodyText": "Could you motivate (in commit msg) why this is a property of the checkpoint vs. a config of the task?\nI don't mind this solution but I want to understand the reason. Intuitively, I'd put it into the task config, which would ultimately allow a fine-grain checkpoint configuration for each operator.\nDo you plan to adjust the alignmentTimeout when the barrier travels downstream?", "url": "https://github.com/apache/flink/pull/13741#discussion_r511930172", "createdAt": "2020-10-26T12:42:38Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointOptions.java", "diffHunk": "@@ -47,29 +50,56 @@\n \n \tprivate final boolean isUnalignedCheckpoint;\n \n+\tprivate final long alignmentTimeout;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e26fb076f97cb27397a1d76d26aff11790e438f"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3OTUxMA==", "bodyText": "No, alignmentTimeout is a global timeout, measured against the CheckpointBarrier#getTimestamp, so since the creation of the CheckpointBarrier on the CheckpointCoordinator. If CheckpointCoordinator has timed out on an upstream task, it will be timed out for any downstream operator as well.", "url": "https://github.com/apache/flink/pull/13741#discussion_r512179510", "createdAt": "2020-10-26T18:28:17Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointOptions.java", "diffHunk": "@@ -47,29 +50,56 @@\n \n \tprivate final boolean isUnalignedCheckpoint;\n \n+\tprivate final long alignmentTimeout;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMDE3Mg=="}, "originalCommit": {"oid": "1e26fb076f97cb27397a1d76d26aff11790e438f"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzQyMDA0OnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointOptions.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjo0Mzo1M1rOHoNx5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMDowMTo0NlrOHogOwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMDg1Mg==", "bodyText": "Have NO_ALIGNMENT_TIME_OUT = -1?", "url": "https://github.com/apache/flink/pull/13741#discussion_r511930852", "createdAt": "2020-10-26T12:43:53Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointOptions.java", "diffHunk": "@@ -47,29 +50,56 @@\n \n \tprivate final boolean isUnalignedCheckpoint;\n \n+\tprivate final long alignmentTimeout;\n+\n+\tpublic static CheckpointOptions create(\n+\t\t\tCheckpointType checkpointType,\n+\t\t\tCheckpointStorageLocationReference locationReference,\n+\t\t\tboolean isExactlyOnceMode,\n+\t\t\tboolean unalignedCheckpointsEnabled,\n+\t\t\tlong alignmentTimeout) {\n+\t\tboolean canBeUnaligned = checkpointType == CheckpointType.CHECKPOINT && unalignedCheckpointsEnabled;\n+\t\treturn new CheckpointOptions(\n+\t\t\t\tcheckpointType,\n+\t\t\t\tlocationReference,\n+\t\t\t\tisExactlyOnceMode,\n+\t\t\t\tcanBeUnaligned && alignmentTimeout == 0,\n+\t\t\t\tcanBeUnaligned ? alignmentTimeout : NO_ALIGNMENT_TIME_OUT);\n+\t}\n+\n \t@VisibleForTesting\n \tpublic CheckpointOptions(\n \t\t\tCheckpointType checkpointType,\n \t\t\tCheckpointStorageLocationReference targetLocation) {\n-\t\tthis(checkpointType, targetLocation, true, false);\n+\t\tthis(checkpointType, targetLocation, true, false, NO_ALIGNMENT_TIME_OUT);\n \t}\n \n \tpublic CheckpointOptions(\n \t\t\tCheckpointType checkpointType,\n \t\t\tCheckpointStorageLocationReference targetLocation,\n \t\t\tboolean isExactlyOnceMode,\n-\t\t\tboolean isUnalignedCheckpoint) {\n+\t\t\tboolean isUnalignedCheckpoint,\n+\t\t\tlong alignmentTimeout) {\n \n \t\tthis.checkpointType = checkNotNull(checkpointType);\n \t\tthis.targetLocation = checkNotNull(targetLocation);\n \t\tthis.isExactlyOnceMode = isExactlyOnceMode;\n \t\tthis.isUnalignedCheckpoint = isUnalignedCheckpoint;\n+\t\tthis.alignmentTimeout = alignmentTimeout;\n \t}\n \n \tpublic boolean needsAlignment() {\n \t\treturn isExactlyOnceMode() && (getCheckpointType().isSavepoint() || !isUnalignedCheckpoint());\n \t}\n \n+\tpublic long getAlignmentTimeout() {\n+\t\treturn alignmentTimeout;\n+\t}\n+\n+\tpublic boolean isTimeoutable() {\n+\t\treturn alignmentTimeout > 0 && alignmentTimeout != NO_ALIGNMENT_TIME_OUT;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e26fb076f97cb27397a1d76d26aff11790e438f"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIzMzE1Mw==", "bodyText": "Initially I had this, but Long.MAX_VALUE works better with getAlignmentTimeout(), as Long.MAX_VALUE is for all of the practical purposes NO_ALIGNMENT_TIME_OUT :)", "url": "https://github.com/apache/flink/pull/13741#discussion_r512233153", "createdAt": "2020-10-26T20:01:46Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointOptions.java", "diffHunk": "@@ -47,29 +50,56 @@\n \n \tprivate final boolean isUnalignedCheckpoint;\n \n+\tprivate final long alignmentTimeout;\n+\n+\tpublic static CheckpointOptions create(\n+\t\t\tCheckpointType checkpointType,\n+\t\t\tCheckpointStorageLocationReference locationReference,\n+\t\t\tboolean isExactlyOnceMode,\n+\t\t\tboolean unalignedCheckpointsEnabled,\n+\t\t\tlong alignmentTimeout) {\n+\t\tboolean canBeUnaligned = checkpointType == CheckpointType.CHECKPOINT && unalignedCheckpointsEnabled;\n+\t\treturn new CheckpointOptions(\n+\t\t\t\tcheckpointType,\n+\t\t\t\tlocationReference,\n+\t\t\t\tisExactlyOnceMode,\n+\t\t\t\tcanBeUnaligned && alignmentTimeout == 0,\n+\t\t\t\tcanBeUnaligned ? alignmentTimeout : NO_ALIGNMENT_TIME_OUT);\n+\t}\n+\n \t@VisibleForTesting\n \tpublic CheckpointOptions(\n \t\t\tCheckpointType checkpointType,\n \t\t\tCheckpointStorageLocationReference targetLocation) {\n-\t\tthis(checkpointType, targetLocation, true, false);\n+\t\tthis(checkpointType, targetLocation, true, false, NO_ALIGNMENT_TIME_OUT);\n \t}\n \n \tpublic CheckpointOptions(\n \t\t\tCheckpointType checkpointType,\n \t\t\tCheckpointStorageLocationReference targetLocation,\n \t\t\tboolean isExactlyOnceMode,\n-\t\t\tboolean isUnalignedCheckpoint) {\n+\t\t\tboolean isUnalignedCheckpoint,\n+\t\t\tlong alignmentTimeout) {\n \n \t\tthis.checkpointType = checkNotNull(checkpointType);\n \t\tthis.targetLocation = checkNotNull(targetLocation);\n \t\tthis.isExactlyOnceMode = isExactlyOnceMode;\n \t\tthis.isUnalignedCheckpoint = isUnalignedCheckpoint;\n+\t\tthis.alignmentTimeout = alignmentTimeout;\n \t}\n \n \tpublic boolean needsAlignment() {\n \t\treturn isExactlyOnceMode() && (getCheckpointType().isSavepoint() || !isUnalignedCheckpoint());\n \t}\n \n+\tpublic long getAlignmentTimeout() {\n+\t\treturn alignmentTimeout;\n+\t}\n+\n+\tpublic boolean isTimeoutable() {\n+\t\treturn alignmentTimeout > 0 && alignmentTimeout != NO_ALIGNMENT_TIME_OUT;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMDg1Mg=="}, "originalCommit": {"oid": "1e26fb076f97cb27397a1d76d26aff11790e438f"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzQyOTk2OnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/ExecutionCheckpointingOptions.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjo0Njo0MFrOHoN39w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjo0Njo0MFrOHoN39w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMjQwNw==", "bodyText": "Quite technical compared to the other descriptions (=too precise).\n\n\"If timeout is (set to) 0, checkpoints will always start unaligned.\"", "url": "https://github.com/apache/flink/pull/13741#discussion_r511932407", "createdAt": "2020-10-26T12:46:40Z", "author": {"login": "AHeise"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/ExecutionCheckpointingOptions.java", "diffHunk": "@@ -143,4 +143,20 @@\n \t\t\t\t\tTextElement.code(CheckpointingMode.EXACTLY_ONCE.toString()),\n \t\t\t\t\tTextElement.code(MAX_CONCURRENT_CHECKPOINTS.key()))\n \t\t\t\t.build());\n+\n+\tpublic static final ConfigOption<Duration> ALIGNMENT_TIMEOUT =\n+\t\tConfigOptions.key(\"execution.checkpointing.alignment-timeout\")\n+\t\t\t.durationType()\n+\t\t\t.defaultValue(Duration.ofSeconds(30))\n+\t\t\t.withDescription(Description.builder()\n+\t\t\t\t.text(\"Only relevant if %s is enabled.\", TextElement.code(ENABLE_UNALIGNED.key()))\n+\t\t\t\t.linebreak()\n+\t\t\t\t.linebreak()\n+\t\t\t\t.text(\"If timeout has value equal to 0, checkpoints will always start unaligned.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e26fb076f97cb27397a1d76d26aff11790e438f"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzQ1NjgzOnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/ExecutionCheckpointingOptions.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjo1NDowOVrOHoOIzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjo1NDowOVrOHoOIzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzNjcxNw==", "bodyText": "\"If timeout is (set to) non-zero/positive value, checkpoints will...\"", "url": "https://github.com/apache/flink/pull/13741#discussion_r511936717", "createdAt": "2020-10-26T12:54:09Z", "author": {"login": "AHeise"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/ExecutionCheckpointingOptions.java", "diffHunk": "@@ -143,4 +143,20 @@\n \t\t\t\t\tTextElement.code(CheckpointingMode.EXACTLY_ONCE.toString()),\n \t\t\t\t\tTextElement.code(MAX_CONCURRENT_CHECKPOINTS.key()))\n \t\t\t\t.build());\n+\n+\tpublic static final ConfigOption<Duration> ALIGNMENT_TIMEOUT =\n+\t\tConfigOptions.key(\"execution.checkpointing.alignment-timeout\")\n+\t\t\t.durationType()\n+\t\t\t.defaultValue(Duration.ofSeconds(30))\n+\t\t\t.withDescription(Description.builder()\n+\t\t\t\t.text(\"Only relevant if %s is enabled.\", TextElement.code(ENABLE_UNALIGNED.key()))\n+\t\t\t\t.linebreak()\n+\t\t\t\t.linebreak()\n+\t\t\t\t.text(\"If timeout has value equal to 0, checkpoints will always start unaligned.\")\n+\t\t\t\t.linebreak()\n+\t\t\t\t.linebreak()\n+\t\t\t\t.text(\"If time has value greater then 0, checkpoints will start aligned. \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e26fb076f97cb27397a1d76d26aff11790e438f"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzQ3MzMxOnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjo1ODoyN1rOHoOS2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjo1ODoyN1rOHoOS2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzOTI4OQ==", "bodyText": "Instead of checking it during deserialization on all buffers, why not simply check it in DataType enum once?\nIn particular, I don't see the need to ever announce priority events.", "url": "https://github.com/apache/flink/pull/13741#discussion_r511939289", "createdAt": "2020-10-26T12:58:27Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -471,6 +475,40 @@ public void onBuffer(Buffer buffer, int sequenceNumber, int backlog) throws IOEx\n \t\t}\n \t}\n \n+\tprivate void checkPriorityXorAnnouncement(Buffer buffer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzQ4NDMwOnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMzowMTozNFrOHoOZyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwNzo1Mjo0MVrOHpdnGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0MTA2Nw==", "bodyText": "if (dataType.hasPriority() || dataType.requiresAnnouncement()) {\n  firstPriorityEvent = addPriorityBuffer(announce(sequenceBuffer));\n}\nif (!dataType.hasPriority()) {\n  receivedBuffers.add(sequenceBuffer);\n  channelStatePersister.maybePersist(buffer);\n}", "url": "https://github.com/apache/flink/pull/13741#discussion_r511941067", "createdAt": "2020-10-26T13:01:34Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -437,19 +440,20 @@ public void onBuffer(Buffer buffer, int sequenceNumber, int backlog) throws IOEx\n \n \t\t\t\twasEmpty = receivedBuffers.isEmpty();\n \n-\t\t\t\tif (buffer.getDataType().hasPriority()) {\n-\t\t\t\t\treceivedBuffers.addPriorityElement(new SequenceBuffer(buffer, sequenceNumber));\n-\t\t\t\t\tif (channelStatePersister.checkForBarrier(buffer)) {\n-\t\t\t\t\t\t// checkpoint was not yet started by task thread,\n-\t\t\t\t\t\t// so remember the numbers of buffers to spill for the time when it will be started\n-\t\t\t\t\t\tnumBuffersOvertaken = receivedBuffers.getNumUnprioritizedElements();\n-\t\t\t\t\t}\n-\t\t\t\t\tfirstPriorityEvent = receivedBuffers.getNumPriorityElements() == 1;\n+\t\t\t\tSequenceBuffer sequenceBuffer = new SequenceBuffer(buffer, sequenceNumber);\n+\t\t\t\tDataType dataType = buffer.getDataType();\n+\t\t\t\tif (dataType.hasPriority()) {\n+\t\t\t\t\tcheckPriorityXorAnnouncement(buffer);\n+\t\t\t\t\tfirstPriorityEvent = addPriorityBuffer(sequenceBuffer);\n \t\t\t\t} else {\n-\t\t\t\t\treceivedBuffers.add(new SequenceBuffer(buffer, sequenceNumber));\n+\t\t\t\t\treceivedBuffers.add(sequenceBuffer);\n \t\t\t\t\tchannelStatePersister.maybePersist(buffer);\n-\t\t\t\t}\n \n+\t\t\t\t\tif (dataType.requiresAnnouncement()) {\n+\t\t\t\t\t\tcheckPriorityXorAnnouncement(buffer);\n+\t\t\t\t\t\tfirstPriorityEvent = addPriorityBuffer(announce(sequenceBuffer));\n+\t\t\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg1NDc3NA==", "bodyText": "This is incorrect, it would have to be:\n\t\t\t\tif (dataType.requiresAnnouncement()) {\n\t\t\t\t\tfirstPriorityEvent = addPriorityBuffer(announce(sequenceBuffer));\n\t\t\t\t}\n\t\t\t\tif (dataType.hasPriority()) {\n\t\t\t\t\tfirstPriorityEvent = addPriorityBuffer(sequenceBuffer);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treceivedBuffers.add(sequenceBuffer);\n\t\t\t\t\tchannelStatePersister.maybePersist(buffer);\n\t\t\t\t}\n\nbut that would suggest priority event can be announced, hence I moved\n\t\t\t\tif (dataType.requiresAnnouncement()) {\n\t\t\t\t\tfirstPriorityEvent = addPriorityBuffer(announce(sequenceBuffer));\n\t\t\t\t}\n\ninto the non priority branch.", "url": "https://github.com/apache/flink/pull/13741#discussion_r512854774", "createdAt": "2020-10-27T16:44:13Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -437,19 +440,20 @@ public void onBuffer(Buffer buffer, int sequenceNumber, int backlog) throws IOEx\n \n \t\t\t\twasEmpty = receivedBuffers.isEmpty();\n \n-\t\t\t\tif (buffer.getDataType().hasPriority()) {\n-\t\t\t\t\treceivedBuffers.addPriorityElement(new SequenceBuffer(buffer, sequenceNumber));\n-\t\t\t\t\tif (channelStatePersister.checkForBarrier(buffer)) {\n-\t\t\t\t\t\t// checkpoint was not yet started by task thread,\n-\t\t\t\t\t\t// so remember the numbers of buffers to spill for the time when it will be started\n-\t\t\t\t\t\tnumBuffersOvertaken = receivedBuffers.getNumUnprioritizedElements();\n-\t\t\t\t\t}\n-\t\t\t\t\tfirstPriorityEvent = receivedBuffers.getNumPriorityElements() == 1;\n+\t\t\t\tSequenceBuffer sequenceBuffer = new SequenceBuffer(buffer, sequenceNumber);\n+\t\t\t\tDataType dataType = buffer.getDataType();\n+\t\t\t\tif (dataType.hasPriority()) {\n+\t\t\t\t\tcheckPriorityXorAnnouncement(buffer);\n+\t\t\t\t\tfirstPriorityEvent = addPriorityBuffer(sequenceBuffer);\n \t\t\t\t} else {\n-\t\t\t\t\treceivedBuffers.add(new SequenceBuffer(buffer, sequenceNumber));\n+\t\t\t\t\treceivedBuffers.add(sequenceBuffer);\n \t\t\t\t\tchannelStatePersister.maybePersist(buffer);\n-\t\t\t\t}\n \n+\t\t\t\t\tif (dataType.requiresAnnouncement()) {\n+\t\t\t\t\t\tcheckPriorityXorAnnouncement(buffer);\n+\t\t\t\t\t\tfirstPriorityEvent = addPriorityBuffer(announce(sequenceBuffer));\n+\t\t\t\t\t}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0MTA2Nw=="}, "originalCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIzODgxMA==", "bodyText": "Missed the announce part.", "url": "https://github.com/apache/flink/pull/13741#discussion_r513238810", "createdAt": "2020-10-28T07:52:41Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -437,19 +440,20 @@ public void onBuffer(Buffer buffer, int sequenceNumber, int backlog) throws IOEx\n \n \t\t\t\twasEmpty = receivedBuffers.isEmpty();\n \n-\t\t\t\tif (buffer.getDataType().hasPriority()) {\n-\t\t\t\t\treceivedBuffers.addPriorityElement(new SequenceBuffer(buffer, sequenceNumber));\n-\t\t\t\t\tif (channelStatePersister.checkForBarrier(buffer)) {\n-\t\t\t\t\t\t// checkpoint was not yet started by task thread,\n-\t\t\t\t\t\t// so remember the numbers of buffers to spill for the time when it will be started\n-\t\t\t\t\t\tnumBuffersOvertaken = receivedBuffers.getNumUnprioritizedElements();\n-\t\t\t\t\t}\n-\t\t\t\t\tfirstPriorityEvent = receivedBuffers.getNumPriorityElements() == 1;\n+\t\t\t\tSequenceBuffer sequenceBuffer = new SequenceBuffer(buffer, sequenceNumber);\n+\t\t\t\tDataType dataType = buffer.getDataType();\n+\t\t\t\tif (dataType.hasPriority()) {\n+\t\t\t\t\tcheckPriorityXorAnnouncement(buffer);\n+\t\t\t\t\tfirstPriorityEvent = addPriorityBuffer(sequenceBuffer);\n \t\t\t\t} else {\n-\t\t\t\t\treceivedBuffers.add(new SequenceBuffer(buffer, sequenceNumber));\n+\t\t\t\t\treceivedBuffers.add(sequenceBuffer);\n \t\t\t\t\tchannelStatePersister.maybePersist(buffer);\n-\t\t\t\t}\n \n+\t\t\t\t\tif (dataType.requiresAnnouncement()) {\n+\t\t\t\t\t\tcheckPriorityXorAnnouncement(buffer);\n+\t\t\t\t\t\tfirstPriorityEvent = addPriorityBuffer(announce(sequenceBuffer));\n+\t\t\t\t\t}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0MTA2Nw=="}, "originalCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzQ5ODM1OnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/CheckpointBarrierAnnouncement.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMzowNTozN1rOHoOikA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMjowODozNlrOHpm7qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0MzMxMg==", "bodyText": "I was hoping that we could make the announcement mechanism a bit independent of checkpoints. I don't see how we can generalize DataType, but I could imagine having a generic AnnouncementEvent.", "url": "https://github.com/apache/flink/pull/13741#discussion_r511943312", "createdAt": "2020-10-26T13:05:37Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/CheckpointBarrierAnnouncement.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.io.network.api;\n+\n+import org.apache.flink.core.memory.DataInputView;\n+import org.apache.flink.core.memory.DataOutputView;\n+import org.apache.flink.runtime.event.RuntimeEvent;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+\n+/**\n+ * {@link CheckpointBarrierAnnouncement} is announcing presence or receiving of a {@link CheckpointBarrier}.\n+ * That {@link #announcedBarrier} is identified by it's sequence number.\n+ */\n+public class CheckpointBarrierAnnouncement extends RuntimeEvent {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIzNTUwNw==", "bodyText": "At the same time, I'm not sure if we will ever need announcement of other events and it would either:\n\nrequire checkState very early on, and still complicate the code a little bit\nadd checkState later and complicate the code even more", "url": "https://github.com/apache/flink/pull/13741#discussion_r512235507", "createdAt": "2020-10-26T20:06:15Z", "author": {"login": "pnowojski"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/CheckpointBarrierAnnouncement.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.io.network.api;\n+\n+import org.apache.flink.core.memory.DataInputView;\n+import org.apache.flink.core.memory.DataOutputView;\n+import org.apache.flink.runtime.event.RuntimeEvent;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+\n+/**\n+ * {@link CheckpointBarrierAnnouncement} is announcing presence or receiving of a {@link CheckpointBarrier}.\n+ * That {@link #announcedBarrier} is identified by it's sequence number.\n+ */\n+public class CheckpointBarrierAnnouncement extends RuntimeEvent {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0MzMxMg=="}, "originalCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM5MTUzMQ==", "bodyText": "Okay let's go with specialized and generalize when a second use case pops up.", "url": "https://github.com/apache/flink/pull/13741#discussion_r513391531", "createdAt": "2020-10-28T12:08:36Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/CheckpointBarrierAnnouncement.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.io.network.api;\n+\n+import org.apache.flink.core.memory.DataInputView;\n+import org.apache.flink.core.memory.DataOutputView;\n+import org.apache.flink.runtime.event.RuntimeEvent;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+\n+/**\n+ * {@link CheckpointBarrierAnnouncement} is announcing presence or receiving of a {@link CheckpointBarrier}.\n+ * That {@link #announcedBarrier} is identified by it's sequence number.\n+ */\n+public class CheckpointBarrierAnnouncement extends RuntimeEvent {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0MzMxMg=="}, "originalCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzUxNDY1OnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/Buffer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMzowOTo0NlrOHoOsWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMzowOTo0NlrOHoOsWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0NTgxOA==", "bodyText": "Why did you move this method?", "url": "https://github.com/apache/flink/pull/13741#discussion_r511945818", "createdAt": "2020-10-26T13:09:46Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/Buffer.java", "diffHunk": "@@ -292,21 +313,37 @@ public boolean isEvent() {\n \t\t\treturn isEvent;\n \t\t}\n \n+\t\tpublic boolean isBlockingUpstream() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzUxNDgyOnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/Buffer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMzowOTo1MFrOHoOsdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMzowOTo1MFrOHoOsdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0NTg0NA==", "bodyText": "As a set before, I'm not a huge fan of this very specific DataTypes. (Why don't we have an DataType just for EndOfPartitionEvents as well?) I also think that ALIGNED_CHECKPOINT_BARRIER is on a different level than all other types.\nOne option that I could see is to just have ANNOUNCED_EVENT_BUFFER(false, true, true, false, true).", "url": "https://github.com/apache/flink/pull/13741#discussion_r511945844", "createdAt": "2020-10-26T13:09:50Z", "author": {"login": "AHeise"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/Buffer.java", "diffHunk": "@@ -247,41 +247,62 @@\n \t\t/**\n \t\t * {@link #NONE} indicates that there is no buffer.\n \t\t */\n-\t\tNONE(false, false, false, false),\n+\t\tNONE(false, false, false, false, false),\n \n \t\t/**\n \t\t * {@link #DATA_BUFFER} indicates that this buffer represents a non-event data buffer.\n \t\t */\n-\t\tDATA_BUFFER(true, false, false, false),\n+\t\tDATA_BUFFER(true, false, false, false, false),\n \n \t\t/**\n \t\t * {@link #EVENT_BUFFER} indicates that this buffer represents serialized data of an event.\n \t\t * Note that this type can be further divided into more fine-grained event types\n \t\t * like {@link #ALIGNED_CHECKPOINT_BARRIER} and etc.\n \t\t */\n-\t\tEVENT_BUFFER(false, true, false, false),\n+\t\tEVENT_BUFFER(false, true, false, false, false),\n \n \t\t/**\n \t\t * Same as EVENT_BUFFER, but the event has been prioritized (e.g. it skipped buffers).\n \t\t */\n-\t\tPRIORITIZED_EVENT_BUFFER(false, true, false, true),\n+\t\tPRIORITIZED_EVENT_BUFFER(false, true, false, true, false),\n \n \t\t/**\n \t\t * {@link #ALIGNED_CHECKPOINT_BARRIER} indicates that this buffer represents a\n \t\t * serialized checkpoint barrier of aligned exactly-once checkpoint mode.\n \t\t */\n-\t\tALIGNED_CHECKPOINT_BARRIER(false, true, true, false);\n+\t\tALIGNED_CHECKPOINT_BARRIER(false, true, true, false, false),\n+\n+\t\t/**\n+\t\t * {@link #TIMEOUTABLE_ALIGNED_CHECKPOINT_BARRIER} indicates that this buffer represents a\n+\t\t * serialized checkpoint barrier of aligned exactly-once checkpoint mode, that can be time-out'ed\n+\t\t * to an unaligned checkpoint barrier.\n+\t\t */\n+\t\tTIMEOUTABLE_ALIGNED_CHECKPOINT_BARRIER(false, true, true, false, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzUxNjk2OnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/SingleCheckpointBarrierHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMzoxMDoxOVrOHoOtpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMzoxMDoxOVrOHoOtpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0NjE1MQ==", "bodyText": "Add TODO instead?", "url": "https://github.com/apache/flink/pull/13741#discussion_r511946151", "createdAt": "2020-10-26T13:10:19Z", "author": {"login": "AHeise"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/SingleCheckpointBarrierHandler.java", "diffHunk": "@@ -147,6 +148,13 @@ public void processBarrier(CheckpointBarrier barrier, InputChannelInfo channelIn\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic void processBarrierAnnouncement(\n+\t\t\tCheckpointBarrierAnnouncement barrierAnnouncement,\n+\t\t\tInputChannelInfo channelInfo) throws IOException {\n+\t\t// Ignore for now.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35aaad405a63bb56ff1be4aa45028b22058c0858"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 72, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}