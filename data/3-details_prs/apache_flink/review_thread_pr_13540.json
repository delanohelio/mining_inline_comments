{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3Njc3MjE1", "number": 13540, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDoxNTowNlrOEqVnkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDoyMzoyMVrOEqV2Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODI5ODQzOnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/TestingJobManagerRunner.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDoxNTowNlrOHcfCzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDoxNTowNlrOHcfCzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYzMDc5Nw==", "bodyText": "I would suggest to use a OneShotLatch.", "url": "https://github.com/apache/flink/pull/13540#discussion_r499630797", "createdAt": "2020-10-05T14:15:06Z", "author": {"login": "tillrohrmann"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/jobmaster/TestingJobManagerRunner.java", "diffHunk": "@@ -39,6 +39,8 @@\n \n \tprivate final CompletableFuture<ArchivedExecutionGraph> resultFuture;\n \n+\tprivate final CompletableFuture<Void> closeAsyncCalledFuture = new CompletableFuture<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6650579aa244c53d76237be84b861224c451b4ba"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODMzNjA3OnYy", "diffSide": "RIGHT", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherResourceCleanupTest.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDoyMzoyMVrOHcfahg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzoyODozNFrOHdGaaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYzNjg3MA==", "bodyText": "I don't fully understand why this additional synchronization step is necessary. If I am not mistaken, then testingJobManagerRunner.completeResultFutureExceptionally won't trigger Dispatcher.jobNotFinished directly but at least it will enqueue the RunAsync message which will run this task into the mailbox of the Dispatcher. dispatcherGateway.submitJob should do the same just that the submit message is enqueued after the RunAsync message.\nCould you show me an execution order in which the submitJob RPC call is executed before the handleAsync (https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java#L374)?\nCould you reproduce the problem locally?", "url": "https://github.com/apache/flink/pull/13540#discussion_r499636870", "createdAt": "2020-10-05T14:23:21Z", "author": {"login": "tillrohrmann"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherResourceCleanupTest.java", "diffHunk": "@@ -350,6 +350,10 @@ public void testJobSubmissionUnderSameJobId() throws Exception {\n \t\tfinal TestingJobManagerRunner testingJobManagerRunner = jobManagerRunnerFactory.takeCreatedJobManagerRunner();\n \t\ttestingJobManagerRunner.completeResultFutureExceptionally(new JobNotFinishedException(jobId));\n \n+\t\t// wait until termination JobManagerRunner closeAsync has been called.\n+\t\t// this is necessary to avoid race conditions with completion of the 1st job and the submission of the 2nd job (DuplicateJobSubmissionException).\n+\t\ttestingJobManagerRunner.getCloseAsyncCalledFuture().get();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6650579aa244c53d76237be84b861224c451b4ba"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY0MDYxMA==", "bodyText": "I agree that relying on the fact that the testing main thread will enqueue the handleAsync payload before the submitJob is not a safe assumption. Hence, the fix should be fine. Still I would like to understand what exactly is going wrong here.", "url": "https://github.com/apache/flink/pull/13540#discussion_r499640610", "createdAt": "2020-10-05T14:28:06Z", "author": {"login": "tillrohrmann"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherResourceCleanupTest.java", "diffHunk": "@@ -350,6 +350,10 @@ public void testJobSubmissionUnderSameJobId() throws Exception {\n \t\tfinal TestingJobManagerRunner testingJobManagerRunner = jobManagerRunnerFactory.takeCreatedJobManagerRunner();\n \t\ttestingJobManagerRunner.completeResultFutureExceptionally(new JobNotFinishedException(jobId));\n \n+\t\t// wait until termination JobManagerRunner closeAsync has been called.\n+\t\t// this is necessary to avoid race conditions with completion of the 1st job and the submission of the 2nd job (DuplicateJobSubmissionException).\n+\t\ttestingJobManagerRunner.getCloseAsyncCalledFuture().get();\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYzNjg3MA=="}, "originalCommit": {"oid": "6650579aa244c53d76237be84b861224c451b4ba"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDIwMDU5NA==", "bodyText": "Thanks a lot for your review.\nThe DuplicateJobSubmissionException exception is thrown, because the same job is already in the  runningJobs list.\nI believe there is a race condition between the main thread executing the test and the dispatcher main thread:\n(dispatcher thread) As soon as the TestingJobManagerRunner has been created, it is offered to a queue in the TestingJobManagerRunnerFactory. The (main test thread) is waiting on the queue. The next step for this thread will be updating the DispatcherJob's status, and setting up a forward of the result future from the jobManagerRunner.\n(main test thread) the TestingJobManagerRunner is available now, so the thread can continue. The thread uses the TestingJobManagerRunner to complete the result future. The result future will be forwarded in DispatcherJob. However, if (dispatcher thread) is not fast enough in registering the forward, the main thread might manage to submit the 2nd job before (dispatcher thread) forwards the completion.\nI can reproduce the problem locally by introducing a sleep for 10 milliseconds after offering the TestingJobManagerRunner in the TestingJobManagerRunnerFactory. This will guarantee that the result forward setup is always happening too late.\nIn my opinion this test instability is purely an issue of the test, not the Dispatcher implementation.", "url": "https://github.com/apache/flink/pull/13540#discussion_r500200594", "createdAt": "2020-10-06T11:28:21Z", "author": {"login": "rmetzger"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherResourceCleanupTest.java", "diffHunk": "@@ -350,6 +350,10 @@ public void testJobSubmissionUnderSameJobId() throws Exception {\n \t\tfinal TestingJobManagerRunner testingJobManagerRunner = jobManagerRunnerFactory.takeCreatedJobManagerRunner();\n \t\ttestingJobManagerRunner.completeResultFutureExceptionally(new JobNotFinishedException(jobId));\n \n+\t\t// wait until termination JobManagerRunner closeAsync has been called.\n+\t\t// this is necessary to avoid race conditions with completion of the 1st job and the submission of the 2nd job (DuplicateJobSubmissionException).\n+\t\ttestingJobManagerRunner.getCloseAsyncCalledFuture().get();\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYzNjg3MA=="}, "originalCommit": {"oid": "6650579aa244c53d76237be84b861224c451b4ba"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI3NTgxNg==", "bodyText": "Thanks for the clarification @rmetzger. I believe that your analysis is correct.", "url": "https://github.com/apache/flink/pull/13540#discussion_r500275816", "createdAt": "2020-10-06T13:28:34Z", "author": {"login": "tillrohrmann"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherResourceCleanupTest.java", "diffHunk": "@@ -350,6 +350,10 @@ public void testJobSubmissionUnderSameJobId() throws Exception {\n \t\tfinal TestingJobManagerRunner testingJobManagerRunner = jobManagerRunnerFactory.takeCreatedJobManagerRunner();\n \t\ttestingJobManagerRunner.completeResultFutureExceptionally(new JobNotFinishedException(jobId));\n \n+\t\t// wait until termination JobManagerRunner closeAsync has been called.\n+\t\t// this is necessary to avoid race conditions with completion of the 1st job and the submission of the 2nd job (DuplicateJobSubmissionException).\n+\t\ttestingJobManagerRunner.getCloseAsyncCalledFuture().get();\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYzNjg3MA=="}, "originalCommit": {"oid": "6650579aa244c53d76237be84b861224c451b4ba"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 226, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}