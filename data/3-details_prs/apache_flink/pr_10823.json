{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxMzI3MDgy", "number": 10823, "title": "[FLINK-15497][table-planner-blink] Reduce outputs when rank number is not required in Retractable topN", "bodyText": "What is the purpose of the change\nAs we described in the doc: https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/table/sql.html#top-n\nWhen rank number is not required, we can reduce some output, like unnecessary retract messages.\nHowever the optimization does not work for Retractable topN before, the pr aims to resolve the issue.\nBrief change log\n\nUpdate Retractable TopN function\nAdd UT\n\nVerifying this change\nUT\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (no)\nThe serializers: (no)\nThe runtime per-record code paths (performance sensitive): (no)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)\nThe S3 file system connector: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (no)\nIf yes, how is the feature documented? (not applicable)", "createdAt": "2020-01-10T08:13:23Z", "url": "https://github.com/apache/flink/pull/10823", "merged": true, "mergeCommit": {"oid": "bf0945769278079f0e004080b78e5dfe87f7c320"}, "closed": true, "closedAt": "2020-01-21T02:51:53Z", "author": {"login": "beyond1920"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb58d6FgFqTM0MTgzOTExOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8YB_igFqTM0NTYxMDExNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxODM5MTE4", "url": "https://github.com/apache/flink/pull/10823#pullrequestreview-341839118", "createdAt": "2020-01-13T13:24:22Z", "commit": {"oid": "98b6f5aa1f7623e1aba1d1531a0a2973dbdc5873"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMzoyNDoyMlrOFc2tCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMzozMDozN1rOFc24cA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgwMDcxNQ==", "bodyText": "Could you use testTopNWithGroupByAvgWithoutRowNumber to verify this which already have a meaningful testing data?", "url": "https://github.com/apache/flink/pull/10823#discussion_r365800715", "createdAt": "2020-01-13T13:24:22Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/stream/sql/RankITCase.scala", "diffHunk": "@@ -1311,4 +1311,49 @@ class RankITCase(mode: StateBackendMode) extends StreamingWithStateTestBase(mode\n     assertEquals(expected2.sorted, sink2.getRetractResults.sorted)\n   }\n \n+  @Test\n+  def testRetractRank(): Unit = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98b6f5aa1f7623e1aba1d1531a0a2973dbdc5873"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgwMzYzMg==", "bodyText": "We should emit delete/retract record first, then emit accumulate record. Otherwise, there might be some problems, e.g. user may see instantly incorrect results (top3 but see top4 at some point of time).", "url": "https://github.com/apache/flink/pull/10823#discussion_r365803632", "createdAt": "2020-01-13T13:30:37Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-runtime-blink/src/test/java/org/apache/flink/table/runtime/operators/rank/RetractableTopNFunctionTest.java", "diffHunk": "@@ -209,12 +301,12 @@ public void testDisableGenerateRetraction() throws Exception {\n \t\tList<Object> expectedOutput = new ArrayList<>();\n \t\texpectedOutput.add(record(\"book\", 1L, 12));\n \t\texpectedOutput.add(record(\"book\", 2L, 19));\n-\t\texpectedOutput.add(record(\"book\", 1L, 12));\n \t\texpectedOutput.add(record(\"book\", 4L, 11));\n+\t\texpectedOutput.add(deleteRecord(\"book\", 2L, 19));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98b6f5aa1f7623e1aba1d1531a0a2973dbdc5873"}, "originalPosition": 185}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTc0MTM0", "url": "https://github.com/apache/flink/pull/10823#pullrequestreview-344974134", "createdAt": "2020-01-19T03:18:14Z", "commit": {"oid": "c57927e992beddecbb3eb93d71919b08abc469a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQwMzoxODoxNVrOFfM9VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQwMzoxODoxNVrOFfM9VQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2MjQ4NQ==", "bodyText": "Could you add some comments on this? IIUC, this is for padding the last entry because we retract a entry from the top-n.\nBesides, could you improve the local field name of tmpRank? It's not easy to understand what the rank it is.", "url": "https://github.com/apache/flink/pull/10823#discussion_r368262485", "createdAt": "2020-01-19T03:18:15Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/runtime/operators/rank/RetractableTopNFunction.java", "diffHunk": "@@ -374,10 +381,10 @@ private void retractRecordWithoutRowNumber(\n \t\t\t} else if (findsSortKey) {\n \t\t\t\tlong count = entry.getValue();\n \t\t\t\tlong tmpRank = curRank + count;\n-\t\t\t\tif (isInRankEnd(tmpRank)) {\n+\t\t\t\tif (tmpRank < rankEnd) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c57927e992beddecbb3eb93d71919b08abc469a7"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b909bf785ad1163d97d8783fd784f2b294caa407", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/b909bf785ad1163d97d8783fd784f2b294caa407", "committedDate": "2020-01-20T07:32:54Z", "message": "[FLINK-15497][table-planner-blink] Reduce outputs when rank number is not required in RetractTopN"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dafd00b6650ebfe1627fa8c7d08577d93aaf885b", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/dafd00b6650ebfe1627fa8c7d08577d93aaf885b", "committedDate": "2020-01-20T07:32:54Z", "message": "Updates based on comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c57927e992beddecbb3eb93d71919b08abc469a7", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/c57927e992beddecbb3eb93d71919b08abc469a7", "committedDate": "2020-01-15T04:30:25Z", "message": "Updates based on comment"}, "afterCommit": {"oid": "5b1ff9333d79ebec7b5a99373dc7ec5994c52ed9", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/5b1ff9333d79ebec7b5a99373dc7ec5994c52ed9", "committedDate": "2020-01-20T07:32:54Z", "message": "Minor updates."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3e59d245648911d90c7c8488fc8e810e8ff6339", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/c3e59d245648911d90c7c8488fc8e810e8ff6339", "committedDate": "2020-01-20T07:37:29Z", "message": "Minor updates."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b1ff9333d79ebec7b5a99373dc7ec5994c52ed9", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/5b1ff9333d79ebec7b5a99373dc7ec5994c52ed9", "committedDate": "2020-01-20T07:32:54Z", "message": "Minor updates."}, "afterCommit": {"oid": "c3e59d245648911d90c7c8488fc8e810e8ff6339", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/c3e59d245648911d90c7c8488fc8e810e8ff6339", "committedDate": "2020-01-20T07:37:29Z", "message": "Minor updates."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NjEwMTE0", "url": "https://github.com/apache/flink/pull/10823#pullrequestreview-345610114", "createdAt": "2020-01-21T02:50:17Z", "commit": {"oid": "c3e59d245648911d90c7c8488fc8e810e8ff6339"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4643, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}