{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwOTkzMjEw", "number": 13209, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOToyNjoyM1rOEct3TQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNTozNDoyMVrOEgC-rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4NTQ3MDIxOnYy", "diffSide": "LEFT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamGraphGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOToyNjoyM1rOHHakOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxMDoxODoyNlrOHI4wng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzNzMzOA==", "bodyText": "Can you explain the reasoning behind removing this branch?\nI think we still need it, because if the user doesn't set a timeout for transformation then default job timeout should be used.", "url": "https://github.com/apache/flink/pull/13209#discussion_r477537338", "createdAt": "2020-08-26T19:26:23Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamGraphGenerator.java", "diffHunk": "@@ -285,11 +285,7 @@ public StreamGraph generate() {\n \t\t\talreadyTransformed.put(transform, transformedIds);\n \t\t}\n \n-\t\tif (transform.getBufferTimeout() >= 0) {\n-\t\t\tstreamGraph.setBufferTimeout(transform.getId(), transform.getBufferTimeout());\n-\t\t} else {\n-\t\t\tstreamGraph.setBufferTimeout(transform.getId(), defaultBufferTimeout);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454310e0df591eac9dd81940f3cf690185155c70"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTA4MDYwNg==", "bodyText": "The motivation is for setting the default timeout (100) only for streaming job by design. But in this procedure we can not determine the ResultPartitionType for properly setting the default value, so I removed that path before. And actually the default value can also be set/got in the following procedure by StreamConfig.\nBut I found another problem to do so, which will effect some other code paths. Now I adjusted to make all the preceding default values as -1 if not explicitly set. Then during job graph generation, we can determine whether to reset the default value 100 only for pipelined partition.", "url": "https://github.com/apache/flink/pull/13209#discussion_r479080606", "createdAt": "2020-08-28T10:18:26Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamGraphGenerator.java", "diffHunk": "@@ -285,11 +285,7 @@ public StreamGraph generate() {\n \t\t\talreadyTransformed.put(transform, transformedIds);\n \t\t}\n \n-\t\tif (transform.getBufferTimeout() >= 0) {\n-\t\t\tstreamGraph.setBufferTimeout(transform.getId(), transform.getBufferTimeout());\n-\t\t} else {\n-\t\t\tstreamGraph.setBufferTimeout(transform.getId(), defaultBufferTimeout);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzNzMzOA=="}, "originalCommit": {"oid": "454310e0df591eac9dd81940f3cf690185155c70"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4NTUwMDM4OnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOTozNToxOVrOHHa2gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxMDoyMDoxOVrOHI44zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0MjAxOA==", "bodyText": "I think adding the timeout value and edge.toString could help to find out misconfguration to the user.", "url": "https://github.com/apache/flink/pull/13209#discussion_r477542018", "createdAt": "2020-08-26T19:35:19Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java", "diffHunk": "@@ -591,6 +593,13 @@ private void connect(Integer headOfChain, StreamEdge edge) {\n \t\t}\n \t}\n \n+\tprivate void checkCompatible(ResultPartitionType type, long bufferTimeout) {\n+\t\tif (type.isBlocking() && bufferTimeout != -1) {\n+\t\t\tthrow new UnsupportedOperationException(\"Blocking partition does not support buffer timeout at the\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454310e0df591eac9dd81940f3cf690185155c70"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTA4MjcwMg==", "bodyText": "Agree, i will refactor the message.", "url": "https://github.com/apache/flink/pull/13209#discussion_r479082702", "createdAt": "2020-08-28T10:20:19Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java", "diffHunk": "@@ -591,6 +593,13 @@ private void connect(Integer headOfChain, StreamEdge edge) {\n \t\t}\n \t}\n \n+\tprivate void checkCompatible(ResultPartitionType type, long bufferTimeout) {\n+\t\tif (type.isBlocking() && bufferTimeout != -1) {\n+\t\t\tthrow new UnsupportedOperationException(\"Blocking partition does not support buffer timeout at the\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0MjAxOA=="}, "originalCommit": {"oid": "454310e0df591eac9dd81940f3cf690185155c70"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4NTUyODk5OnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGeneratorTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOTo0Mzo1MVrOHHbIHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxMTowOToyNlrOHI8XYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0NjUyNw==", "bodyText": "If we keep using the default timeout (discussion above),\nthen the issue also happens with StreamExecutionEnvironment.setBufferTimeout(100) or even default, right?", "url": "https://github.com/apache/flink/pull/13209#discussion_r477546527", "createdAt": "2020-08-26T19:43:51Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGeneratorTest.java", "diffHunk": "@@ -609,6 +609,33 @@ public void testShuffleModeUndefined() {\n \t\t\tsourceAndMapVertex.getProducedDataSets().get(0).getResultType());\n \t}\n \n+\t@Test(expected = UnsupportedOperationException.class)\n+\tpublic void testConflictShuffleModeWithBufferTimeout() {\n+\t\ttestCompatibleShuffleModeWithBufferTimeout(ShuffleMode.BATCH);\n+\t}\n+\n+\t@Test\n+\tpublic void testNormalShuffleModeWithBufferTimeout() {\n+\t\ttestCompatibleShuffleModeWithBufferTimeout(ShuffleMode.PIPELINED);\n+\t}\n+\n+\tprivate void testCompatibleShuffleModeWithBufferTimeout(ShuffleMode shuffleMode) {\n+\t\tStreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+\n+\t\tDataStream<Integer> sourceDataStream = env.fromElements(1, 2, 3);\n+\t\tsourceDataStream.getTransformation().setBufferTimeout(100);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454310e0df591eac9dd81940f3cf690185155c70"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTEzOTY4MA==", "bodyText": "Yes, I took the way of env.setBufferTimeout(100) in this test for better understanding.", "url": "https://github.com/apache/flink/pull/13209#discussion_r479139680", "createdAt": "2020-08-28T11:09:26Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGeneratorTest.java", "diffHunk": "@@ -609,6 +609,33 @@ public void testShuffleModeUndefined() {\n \t\t\tsourceAndMapVertex.getProducedDataSets().get(0).getResultType());\n \t}\n \n+\t@Test(expected = UnsupportedOperationException.class)\n+\tpublic void testConflictShuffleModeWithBufferTimeout() {\n+\t\ttestCompatibleShuffleModeWithBufferTimeout(ShuffleMode.BATCH);\n+\t}\n+\n+\t@Test\n+\tpublic void testNormalShuffleModeWithBufferTimeout() {\n+\t\ttestCompatibleShuffleModeWithBufferTimeout(ShuffleMode.PIPELINED);\n+\t}\n+\n+\tprivate void testCompatibleShuffleModeWithBufferTimeout(ShuffleMode shuffleMode) {\n+\t\tStreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+\n+\t\tDataStream<Integer> sourceDataStream = env.fromElements(1, 2, 3);\n+\t\tsourceDataStream.getTransformation().setBufferTimeout(100);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0NjUyNw=="}, "originalCommit": {"oid": "454310e0df591eac9dd81940f3cf690185155c70"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMDMwNDU2OnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamEdge.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNToxNjoxOVrOHMrfZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNToxNjoxOVrOHMrfZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1NzUwOQ==", "bodyText": "nit: define constant, e.g. FLUSH_ALWAYS?", "url": "https://github.com/apache/flink/pull/13209#discussion_r483057509", "createdAt": "2020-09-03T15:16:19Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamEdge.java", "diffHunk": "@@ -76,32 +76,68 @@\n \n \tprivate final ShuffleMode shuffleMode;\n \n-\tpublic StreamEdge(StreamNode sourceVertex, StreamNode targetVertex, int typeNumber,\n-\t\t\tList<String> selectedNames, StreamPartitioner<?> outputPartitioner, OutputTag outputTag) {\n-\t\tthis(sourceVertex,\n-\t\t\t\ttargetVertex,\n-\t\t\t\ttypeNumber,\n-\t\t\t\tselectedNames,\n-\t\t\t\toutputPartitioner,\n-\t\t\t\toutputTag,\n-\t\t\t\tShuffleMode.UNDEFINED);\n-\t}\n-\n-\tpublic StreamEdge(StreamNode sourceVertex, StreamNode targetVertex, int typeNumber,\n-\t\t\tList<String> selectedNames, StreamPartitioner<?> outputPartitioner, OutputTag outputTag,\n-\t\t\tShuffleMode shuffleMode) {\n+\tprivate long bufferTimeout;\n+\n+\tpublic StreamEdge(\n+\t\tStreamNode sourceVertex,\n+\t\tStreamNode targetVertex,\n+\t\tint typeNumber,\n+\t\tList<String> selectedNames,\n+\t\tStreamPartitioner<?> outputPartitioner,\n+\t\tOutputTag outputTag) {\n+\n+\t\tthis(\n+\t\t\tsourceVertex,\n+\t\t\ttargetVertex,\n+\t\t\ttypeNumber,\n+\t\t\t0,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMDMwNTY0OnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamEdge.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNToxNjozM1rOHMrgCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwMjo0NDoxMlrOHNulUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1NzY3Mg==", "bodyText": "nit: indentation (other constructors too).", "url": "https://github.com/apache/flink/pull/13209#discussion_r483057672", "createdAt": "2020-09-03T15:16:33Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamEdge.java", "diffHunk": "@@ -76,32 +76,68 @@\n \n \tprivate final ShuffleMode shuffleMode;\n \n-\tpublic StreamEdge(StreamNode sourceVertex, StreamNode targetVertex, int typeNumber,\n-\t\t\tList<String> selectedNames, StreamPartitioner<?> outputPartitioner, OutputTag outputTag) {\n-\t\tthis(sourceVertex,\n-\t\t\t\ttargetVertex,\n-\t\t\t\ttypeNumber,\n-\t\t\t\tselectedNames,\n-\t\t\t\toutputPartitioner,\n-\t\t\t\toutputTag,\n-\t\t\t\tShuffleMode.UNDEFINED);\n-\t}\n-\n-\tpublic StreamEdge(StreamNode sourceVertex, StreamNode targetVertex, int typeNumber,\n-\t\t\tList<String> selectedNames, StreamPartitioner<?> outputPartitioner, OutputTag outputTag,\n-\t\t\tShuffleMode shuffleMode) {\n+\tprivate long bufferTimeout;\n+\n+\tpublic StreamEdge(\n+\t\tStreamNode sourceVertex,\n+\t\tStreamNode targetVertex,\n+\t\tint typeNumber,\n+\t\tList<String> selectedNames,\n+\t\tStreamPartitioner<?> outputPartitioner,\n+\t\tOutputTag outputTag) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE1Njc1Mw==", "bodyText": "I guess we suggested two options here in the past.\n\n\nAdd one more indentation to distinguish with below codes, as you suggested above.\n\n\nSame indentation as this PR did, and add a separate empty line to distinguish with below codes. And we can see that many existing class constructors took this way, e.g. Task, SingleInputGate, RemoteInputChannel, etc.\n\n\nSo I will keep the current way :)", "url": "https://github.com/apache/flink/pull/13209#discussion_r484156753", "createdAt": "2020-09-07T02:44:12Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamEdge.java", "diffHunk": "@@ -76,32 +76,68 @@\n \n \tprivate final ShuffleMode shuffleMode;\n \n-\tpublic StreamEdge(StreamNode sourceVertex, StreamNode targetVertex, int typeNumber,\n-\t\t\tList<String> selectedNames, StreamPartitioner<?> outputPartitioner, OutputTag outputTag) {\n-\t\tthis(sourceVertex,\n-\t\t\t\ttargetVertex,\n-\t\t\t\ttypeNumber,\n-\t\t\t\tselectedNames,\n-\t\t\t\toutputPartitioner,\n-\t\t\t\toutputTag,\n-\t\t\t\tShuffleMode.UNDEFINED);\n-\t}\n-\n-\tpublic StreamEdge(StreamNode sourceVertex, StreamNode targetVertex, int typeNumber,\n-\t\t\tList<String> selectedNames, StreamPartitioner<?> outputPartitioner, OutputTag outputTag,\n-\t\t\tShuffleMode shuffleMode) {\n+\tprivate long bufferTimeout;\n+\n+\tpublic StreamEdge(\n+\t\tStreamNode sourceVertex,\n+\t\tStreamNode targetVertex,\n+\t\tint typeNumber,\n+\t\tList<String> selectedNames,\n+\t\tStreamPartitioner<?> outputPartitioner,\n+\t\tOutputTag outputTag) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1NzY3Mg=="}, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMDMyNzIyOnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamGraphGenerator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNToyMDo1OVrOHMrtUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNToyMDo1OVrOHMrtUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA2MTA3Mw==", "bodyText": "nit: use constant? (already defined below)", "url": "https://github.com/apache/flink/pull/13209#discussion_r483061073", "createdAt": "2020-09-03T15:20:59Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamGraphGenerator.java", "diffHunk": "@@ -127,7 +124,7 @@\n \n \tprivate TimeCharacteristic timeCharacteristic = DEFAULT_TIME_CHARACTERISTIC;\n \n-\tprivate long defaultBufferTimeout = DEFAULT_NETWORK_BUFFER_TIMEOUT;\n+\tprivate long defaultBufferTimeout = -1L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMDMzNTg1OnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNToyMjo1M1rOHMrypw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwMzoyNDo0MFrOHNvD6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA2MjQzOQ==", "bodyText": "nit: rename to UNSPECIFIED or ON_BUFFER_FULL?", "url": "https://github.com/apache/flink/pull/13209#discussion_r483062439", "createdAt": "2020-09-03T15:22:53Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java", "diffHunk": "@@ -99,6 +99,10 @@\n \n \tprivate static final int MANAGED_MEMORY_FRACTION_SCALE = 16;\n \n+\tprivate static final long DEFAULT_PIPELINED_BUFFER_TIMEOUT = 100L;\n+\n+\tprivate static final long DEFAULT_BLOCKING_BUFFER_TIMEOUT = -1L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE2NDU4Ng==", "bodyText": "I renamed DEFAULT_PIPELINED_BUFFER_TIMEOUT to DEFAULT_NETWORK_BUFFER_TIMEOUT and DEFAULT_BLOCKING_BUFFER_TIMEOUT to UNDEFINED_NETWORK_BUFFER_TIMEOUT for not involving the concept of pipelined/blocking.", "url": "https://github.com/apache/flink/pull/13209#discussion_r484164586", "createdAt": "2020-09-07T03:24:40Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java", "diffHunk": "@@ -99,6 +99,10 @@\n \n \tprivate static final int MANAGED_MEMORY_FRACTION_SCALE = 16;\n \n+\tprivate static final long DEFAULT_PIPELINED_BUFFER_TIMEOUT = 100L;\n+\n+\tprivate static final long DEFAULT_BLOCKING_BUFFER_TIMEOUT = -1L;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA2MjQzOQ=="}, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMDM3NjY2OnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamEdge.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNTozMTo1NlrOHMsMnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNzo1Njo1NlrOHN0i-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA2OTA4NQ==", "bodyText": "nit: check that current buffer timeout is not set (-1)? or alternatively move checkAndResetBufferTimeout logic into StreamEdge", "url": "https://github.com/apache/flink/pull/13209#discussion_r483069085", "createdAt": "2020-09-03T15:31:56Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamEdge.java", "diffHunk": "@@ -136,6 +172,14 @@ public void setPartitioner(StreamPartitioner<?> partitioner) {\n \t\tthis.outputPartitioner = partitioner;\n \t}\n \n+\tpublic void setBufferTimeout(long bufferTimeout) {\n+\t\tthis.bufferTimeout = bufferTimeout;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE2NDE4Nw==", "bodyText": "Move checkAndResetBufferTimeout into StreamEdge seems not possible, because we can not only rely on internal StreamEdge#outputPartitioner to generate ResultPartitionType which also relies on StreamGraph, see StreamingJobGraphGenerator#determineResultPartitionType. Also it seems not good to pass the generate ResultPartitionType as argument into StreamEdge#setBufferTimeout.\nThe initial value of StreamEdge#bufferTimeout is actually -1 from the constructor in core codes if it is not set explicitly via StreamExecutionEnvironment/Transformation, and we will set this value properly based on the partition type during graph generation. I can add the check logic for the passed argument bufferTimeout >= -1.", "url": "https://github.com/apache/flink/pull/13209#discussion_r484164187", "createdAt": "2020-09-07T03:22:39Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamEdge.java", "diffHunk": "@@ -136,6 +172,14 @@ public void setPartitioner(StreamPartitioner<?> partitioner) {\n \t\tthis.outputPartitioner = partitioner;\n \t}\n \n+\tpublic void setBufferTimeout(long bufferTimeout) {\n+\t\tthis.bufferTimeout = bufferTimeout;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA2OTA4NQ=="}, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI1NDQ1Ng==", "bodyText": "Ok, thanks for the explanation.", "url": "https://github.com/apache/flink/pull/13209#discussion_r484254456", "createdAt": "2020-09-07T07:56:56Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamEdge.java", "diffHunk": "@@ -136,6 +172,14 @@ public void setPartitioner(StreamPartitioner<?> partitioner) {\n \t\tthis.outputPartitioner = partitioner;\n \t}\n \n+\tpublic void setBufferTimeout(long bufferTimeout) {\n+\t\tthis.bufferTimeout = bufferTimeout;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA2OTA4NQ=="}, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMDM4NzAzOnYy", "diffSide": "RIGHT", "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGeneratorTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNTozNDoyMVrOHMsTFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNzo1Njo0NFrOHN0iKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA3MDc0Mg==", "bodyText": "I'd also test for 0 timeout as it is treated specially.", "url": "https://github.com/apache/flink/pull/13209#discussion_r483070742", "createdAt": "2020-09-03T15:34:21Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGeneratorTest.java", "diffHunk": "@@ -609,6 +609,32 @@ public void testShuffleModeUndefined() {\n \t\t\tsourceAndMapVertex.getProducedDataSets().get(0).getResultType());\n \t}\n \n+\t@Test(expected = UnsupportedOperationException.class)\n+\tpublic void testConflictShuffleModeWithBufferTimeout() {\n+\t\ttestCompatibleShuffleModeWithBufferTimeout(ShuffleMode.BATCH);\n+\t}\n+\n+\t@Test\n+\tpublic void testNormalShuffleModeWithBufferTimeout() {\n+\t\ttestCompatibleShuffleModeWithBufferTimeout(ShuffleMode.PIPELINED);\n+\t}\n+\n+\tprivate void testCompatibleShuffleModeWithBufferTimeout(ShuffleMode shuffleMode) {\n+\t\tStreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+\t\tenv.setBufferTimeout(100);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE2OTU0NQ==", "bodyText": "The purpose of this test is for verifying the changes of StreamingJobGraphGenerator#checkAndResetBufferTimeout logics, which only treats -1 as special and 0/100 or any positive values are regarded the same logic.", "url": "https://github.com/apache/flink/pull/13209#discussion_r484169545", "createdAt": "2020-09-07T03:51:04Z", "author": {"login": "zhijiangW"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGeneratorTest.java", "diffHunk": "@@ -609,6 +609,32 @@ public void testShuffleModeUndefined() {\n \t\t\tsourceAndMapVertex.getProducedDataSets().get(0).getResultType());\n \t}\n \n+\t@Test(expected = UnsupportedOperationException.class)\n+\tpublic void testConflictShuffleModeWithBufferTimeout() {\n+\t\ttestCompatibleShuffleModeWithBufferTimeout(ShuffleMode.BATCH);\n+\t}\n+\n+\t@Test\n+\tpublic void testNormalShuffleModeWithBufferTimeout() {\n+\t\ttestCompatibleShuffleModeWithBufferTimeout(ShuffleMode.PIPELINED);\n+\t}\n+\n+\tprivate void testCompatibleShuffleModeWithBufferTimeout(ShuffleMode shuffleMode) {\n+\t\tStreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+\t\tenv.setBufferTimeout(100);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA3MDc0Mg=="}, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI1NDI0OQ==", "bodyText": "Makes sense.", "url": "https://github.com/apache/flink/pull/13209#discussion_r484254249", "createdAt": "2020-09-07T07:56:44Z", "author": {"login": "rkhachatryan"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGeneratorTest.java", "diffHunk": "@@ -609,6 +609,32 @@ public void testShuffleModeUndefined() {\n \t\t\tsourceAndMapVertex.getProducedDataSets().get(0).getResultType());\n \t}\n \n+\t@Test(expected = UnsupportedOperationException.class)\n+\tpublic void testConflictShuffleModeWithBufferTimeout() {\n+\t\ttestCompatibleShuffleModeWithBufferTimeout(ShuffleMode.BATCH);\n+\t}\n+\n+\t@Test\n+\tpublic void testNormalShuffleModeWithBufferTimeout() {\n+\t\ttestCompatibleShuffleModeWithBufferTimeout(ShuffleMode.PIPELINED);\n+\t}\n+\n+\tprivate void testCompatibleShuffleModeWithBufferTimeout(ShuffleMode shuffleMode) {\n+\t\tStreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+\t\tenv.setBufferTimeout(100);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA3MDc0Mg=="}, "originalCommit": {"oid": "5c5e70c8a3a1831c1e4715378158eafa93bed707"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 494, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}