{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyNDIwNTU2", "number": 12303, "title": "[FLINK-17625] [table] Fix ArrayIndexOutOfBoundsException in AppendOnlyTopNFunction", "bodyText": "What is the purpose of the change\nfix the bug of ArrayIndexOutOfBoundsException in AppendOnlyTopNFunction\nBrief change log\n\nfix the bug of ArrayIndexOutOfBoundsException in AppendOnlyTopNFunction\nfix the bug of currentTopNum will always increase even remove retired element  in AppendOnlyTopNFunction#processElementWithoutRowNumber method\n\nVerifying this change\nThis change is already covered by existing tests in TopNFunctionTestBase.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (no)\nThe serializers: ( no)\nThe runtime per-record code paths (performance sensitive): (no)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (no)\nThe S3 file system connector: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (no)\nIf yes, how is the feature documented? (not documented)", "createdAt": "2020-05-24T14:24:05Z", "url": "https://github.com/apache/flink/pull/12303", "merged": true, "mergeCommit": {"oid": "926523e14e8dda8d648d56eb0992aaedf08eb8be"}, "closed": true, "closedAt": "2020-06-09T03:05:00Z", "author": {"login": "lsyldliu"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcn95fcAFqTQyNDQyODg1MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpP911AFqTQyNjE5OTQ3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NDI4ODUw", "url": "https://github.com/apache/flink/pull/12303#pullrequestreview-424428850", "createdAt": "2020-06-04T13:16:07Z", "commit": {"oid": "3f6b52073802835bc193796a41d095c5670f5d59"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxMzoxNjowOFrOGfFLqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxMzoxNjowOFrOGfFLqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI0Mzk0NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\tlastElement = lastList.get(size - 1);\n          \n          \n            \n            \t\t\t\tlastElement = lastList.remove(size - 1);", "url": "https://github.com/apache/flink/pull/12303#discussion_r435243944", "createdAt": "2020-06-04T13:16:08Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/runtime/operators/rank/AppendOnlyTopNFunction.java", "diffHunk": "@@ -210,14 +210,19 @@ private void processElementWithoutRowNumber(RowData input, Collector<RowData> ou\n \t\t\tRowData lastKey = lastEntry.getKey();\n \t\t\tList<RowData> lastList = (List<RowData>) lastEntry.getValue();\n \t\t\t// remove last one\n-\t\t\tRowData lastElement = lastList.remove(lastList.size() - 1);\n-\t\t\tif (lastList.isEmpty()) {\n+\t\t\tint size = lastList.size();\n+\t\t\tRowData lastElement = null;\n+\t\t\tif (size > 0) {\n+\t\t\t\tlastElement = lastList.get(size - 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f6b52073802835bc193796a41d095c5670f5d59"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NDI5NDMz", "url": "https://github.com/apache/flink/pull/12303#pullrequestreview-424429433", "createdAt": "2020-06-04T13:16:48Z", "commit": {"oid": "3f6b52073802835bc193796a41d095c5670f5d59"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxMzoxNjo0OFrOGfFNfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxMzoxNzoyOVrOGfFPfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI0NDQxMg==", "bodyText": "Remove on the list use index will be more efficient than buffer.remove.", "url": "https://github.com/apache/flink/pull/12303#discussion_r435244412", "createdAt": "2020-06-04T13:16:48Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/runtime/operators/rank/AppendOnlyTopNFunction.java", "diffHunk": "@@ -210,14 +210,19 @@ private void processElementWithoutRowNumber(RowData input, Collector<RowData> ou\n \t\t\tRowData lastKey = lastEntry.getKey();\n \t\t\tList<RowData> lastList = (List<RowData>) lastEntry.getValue();\n \t\t\t// remove last one\n-\t\t\tRowData lastElement = lastList.remove(lastList.size() - 1);\n-\t\t\tif (lastList.isEmpty()) {\n+\t\t\tint size = lastList.size();\n+\t\t\tRowData lastElement = null;\n+\t\t\tif (size > 0) {\n+\t\t\t\tlastElement = lastList.get(size - 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI0Mzk0NA=="}, "originalCommit": {"oid": "3f6b52073802835bc193796a41d095c5670f5d59"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI0NDkyNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\tdataState.put(lastKey, lastList);\n          \n          \n            \n            \t\t\t\tdataState.put(lastKey, new ArrayList<>(lastList));\n          \n      \n    \n    \n  \n\nWe should do a shallow copy for the lastList, see FLINK-17918.", "url": "https://github.com/apache/flink/pull/12303#discussion_r435244924", "createdAt": "2020-06-04T13:17:29Z", "author": {"login": "wuchong"}, "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/runtime/operators/rank/AppendOnlyTopNFunction.java", "diffHunk": "@@ -210,14 +210,19 @@ private void processElementWithoutRowNumber(RowData input, Collector<RowData> ou\n \t\t\tRowData lastKey = lastEntry.getKey();\n \t\t\tList<RowData> lastList = (List<RowData>) lastEntry.getValue();\n \t\t\t// remove last one\n-\t\t\tRowData lastElement = lastList.remove(lastList.size() - 1);\n-\t\t\tif (lastList.isEmpty()) {\n+\t\t\tint size = lastList.size();\n+\t\t\tRowData lastElement = null;\n+\t\t\tif (size > 0) {\n+\t\t\t\tlastElement = lastList.get(size - 1);\n+\t\t\t}\n+\t\t\tif (size <= 1) {\n \t\t\t\tbuffer.removeAll(lastKey);\n \t\t\t\tdataState.remove(lastKey);\n \t\t\t} else {\n+\t\t\t\tbuffer.remove(lastKey, lastElement);\n \t\t\t\tdataState.put(lastKey, lastList);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f6b52073802835bc193796a41d095c5670f5d59"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abdc2024e805f598b31824f1eed755bc3032d606", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/abdc2024e805f598b31824f1eed755bc3032d606", "committedDate": "2020-06-04T14:48:36Z", "message": "FLINK-17625 fix ArrayIndexOutOfBoundsException in AppendOnlyTopNFunction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c92b48de9d7b9068a646053e7dc9b4d076625ab", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/1c92b48de9d7b9068a646053e7dc9b4d076625ab", "committedDate": "2020-06-05T08:42:11Z", "message": "optimize the TopNBuffer#removeLast method"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3f6b52073802835bc193796a41d095c5670f5d59", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/3f6b52073802835bc193796a41d095c5670f5d59", "committedDate": "2020-05-24T14:07:58Z", "message": "FLINK-17625 fix ArrayIndexOutOfBoundsException in AppendOnlyTopNFunction"}, "afterCommit": {"oid": "1c92b48de9d7b9068a646053e7dc9b4d076625ab", "author": {"user": null}, "url": "https://github.com/apache/flink/commit/1c92b48de9d7b9068a646053e7dc9b4d076625ab", "committedDate": "2020-06-05T08:42:11Z", "message": "optimize the TopNBuffer#removeLast method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f09242997da0a62bc31ae611aa66c9f9e05fdf2f", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/f09242997da0a62bc31ae611aa66c9f9e05fdf2f", "committedDate": "2020-06-08T04:24:26Z", "message": "improve some code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MTk5NDcy", "url": "https://github.com/apache/flink/pull/12303#pullrequestreview-426199472", "createdAt": "2020-06-08T12:53:06Z", "commit": {"oid": "f09242997da0a62bc31ae611aa66c9f9e05fdf2f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4765, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}