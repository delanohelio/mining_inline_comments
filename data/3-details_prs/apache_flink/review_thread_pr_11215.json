{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5NTg2NDA0", "number": 11215, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxMzo0NTo0N1rODitPAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMToyMToyOVrODjCf1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3NzE5Mjk4OnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/codegen/agg/AggsHandlerCodeGenerator.scala", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxMzo0NTo0N1rOFuGlOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwODo1ODo0M1rOFui4jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg4NjY1MQ==", "bodyText": "What not introduce a method getRuntimeContext in this agg handle function?", "url": "https://github.com/apache/flink/pull/11215#discussion_r383886651", "createdAt": "2020-02-25T13:45:47Z", "author": {"login": "JingsongLi"}, "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/codegen/agg/AggsHandlerCodeGenerator.scala", "diffHunk": "@@ -333,6 +333,10 @@ class AggsHandlerCodeGenerator(\n \n     val functionName = newName(name)\n \n+    // make sure we can get the RuntimeContext properly\n+    val openCode = ctx.reuseOpenCode().replaceAll(\"\\\\(getRuntimeContext\\\\(\\\\)\\\\)\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea9722ea905907bdbb959633591186a935c168f4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM0MTU2OQ==", "bodyText": "I thought it's simpler this way, since we only need get the RuntimeContext in the open method. I'll add a getRuntimeContext method if you think that's better.", "url": "https://github.com/apache/flink/pull/11215#discussion_r384341569", "createdAt": "2020-02-26T08:41:44Z", "author": {"login": "lirui-apache"}, "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/codegen/agg/AggsHandlerCodeGenerator.scala", "diffHunk": "@@ -333,6 +333,10 @@ class AggsHandlerCodeGenerator(\n \n     val functionName = newName(name)\n \n+    // make sure we can get the RuntimeContext properly\n+    val openCode = ctx.reuseOpenCode().replaceAll(\"\\\\(getRuntimeContext\\\\(\\\\)\\\\)\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg4NjY1MQ=="}, "originalCommit": {"oid": "ea9722ea905907bdbb959633591186a935c168f4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM1MDM1MA==", "bodyText": "I think we should avoid some codes like replace string in code generation.\nIt may brings some potential bugs in future.", "url": "https://github.com/apache/flink/pull/11215#discussion_r384350350", "createdAt": "2020-02-26T08:58:43Z", "author": {"login": "JingsongLi"}, "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/codegen/agg/AggsHandlerCodeGenerator.scala", "diffHunk": "@@ -333,6 +333,10 @@ class AggsHandlerCodeGenerator(\n \n     val functionName = newName(name)\n \n+    // make sure we can get the RuntimeContext properly\n+    val openCode = ctx.reuseOpenCode().replaceAll(\"\\\\(getRuntimeContext\\\\(\\\\)\\\\)\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg4NjY1MQ=="}, "originalCommit": {"oid": "ea9722ea905907bdbb959633591186a935c168f4"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3NzE5NTY3OnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/batch/sql/CalcITCase.scala", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxMzo0NjozNFrOFuGm9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxMzo0NjozNFrOFuGm9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg4NzA5Mw==", "bodyText": "Move this test to OverWindowITCase.", "url": "https://github.com/apache/flink/pull/11215#discussion_r383887093", "createdAt": "2020-02-25T13:46:34Z", "author": {"login": "JingsongLi"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/batch/sql/CalcITCase.scala", "diffHunk": "@@ -1244,4 +1247,40 @@ class CalcITCase extends BatchTestBase {\n       Seq(row(1), row(111), row(15), row(34), row(5), row(65), row(null))\n     )\n   }\n+\n+  @Test\n+  def testRankWithCustomModule(): Unit = {\n+    try {\n+      tEnv.unloadModule(\"core\")\n+      tEnv.loadModule(\"test-module\", new TestModule)\n+      tEnv.loadModule(\"core\", CoreModule.INSTANCE)\n+      registerCollection(\"emp\",\n+        Seq(row(\"1\", \"A\", 1), row(\"1\", \"B\", 2), row(\"2\", \"C\", 3)),\n+        new RowTypeInfo(STRING_TYPE_INFO, STRING_TYPE_INFO, INT_TYPE_INFO),\n+        \"dep,name,salary\")\n+      checkResult(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea9722ea905907bdbb959633591186a935c168f4"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3NzE5OTQwOnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/batch/sql/CalcITCase.scala", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxMzo0NzozOFrOFuGpQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMDowOTowNFrOFuleCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg4NzY4MQ==", "bodyText": "Do we need do this? Every test should be a new context in JUnit?", "url": "https://github.com/apache/flink/pull/11215#discussion_r383887681", "createdAt": "2020-02-25T13:47:38Z", "author": {"login": "JingsongLi"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/batch/sql/CalcITCase.scala", "diffHunk": "@@ -1244,4 +1247,40 @@ class CalcITCase extends BatchTestBase {\n       Seq(row(1), row(111), row(15), row(34), row(5), row(65), row(null))\n     )\n   }\n+\n+  @Test\n+  def testRankWithCustomModule(): Unit = {\n+    try {\n+      tEnv.unloadModule(\"core\")\n+      tEnv.loadModule(\"test-module\", new TestModule)\n+      tEnv.loadModule(\"core\", CoreModule.INSTANCE)\n+      registerCollection(\"emp\",\n+        Seq(row(\"1\", \"A\", 1), row(\"1\", \"B\", 2), row(\"2\", \"C\", 3)),\n+        new RowTypeInfo(STRING_TYPE_INFO, STRING_TYPE_INFO, INT_TYPE_INFO),\n+        \"dep,name,salary\")\n+      checkResult(\n+        \"select dep,name,rank() over (partition by dep order by salary desc) as rnk from emp\",\n+        Seq(row(\"1\", \"A\", 2), row(\"1\", \"B\", 1), row(\"2\", \"C\", 1)))\n+    } finally {\n+      val modules = tEnv.listModules()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea9722ea905907bdbb959633591186a935c168f4"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM0NTI3Mg==", "bodyText": "I think BatchTestBase::tEnv is only initialized once and shared among test cases. I'll double check.", "url": "https://github.com/apache/flink/pull/11215#discussion_r384345272", "createdAt": "2020-02-26T08:49:05Z", "author": {"login": "lirui-apache"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/batch/sql/CalcITCase.scala", "diffHunk": "@@ -1244,4 +1247,40 @@ class CalcITCase extends BatchTestBase {\n       Seq(row(1), row(111), row(15), row(34), row(5), row(65), row(null))\n     )\n   }\n+\n+  @Test\n+  def testRankWithCustomModule(): Unit = {\n+    try {\n+      tEnv.unloadModule(\"core\")\n+      tEnv.loadModule(\"test-module\", new TestModule)\n+      tEnv.loadModule(\"core\", CoreModule.INSTANCE)\n+      registerCollection(\"emp\",\n+        Seq(row(\"1\", \"A\", 1), row(\"1\", \"B\", 2), row(\"2\", \"C\", 3)),\n+        new RowTypeInfo(STRING_TYPE_INFO, STRING_TYPE_INFO, INT_TYPE_INFO),\n+        \"dep,name,salary\")\n+      checkResult(\n+        \"select dep,name,rank() over (partition by dep order by salary desc) as rnk from emp\",\n+        Seq(row(\"1\", \"A\", 2), row(\"1\", \"B\", 1), row(\"2\", \"C\", 1)))\n+    } finally {\n+      val modules = tEnv.listModules()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg4NzY4MQ=="}, "originalCommit": {"oid": "ea9722ea905907bdbb959633591186a935c168f4"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM5MjcxMw==", "bodyText": "We indeed don't have to do this. Thanks for pointing out.", "url": "https://github.com/apache/flink/pull/11215#discussion_r384392713", "createdAt": "2020-02-26T10:09:04Z", "author": {"login": "lirui-apache"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/batch/sql/CalcITCase.scala", "diffHunk": "@@ -1244,4 +1247,40 @@ class CalcITCase extends BatchTestBase {\n       Seq(row(1), row(111), row(15), row(34), row(5), row(65), row(null))\n     )\n   }\n+\n+  @Test\n+  def testRankWithCustomModule(): Unit = {\n+    try {\n+      tEnv.unloadModule(\"core\")\n+      tEnv.loadModule(\"test-module\", new TestModule)\n+      tEnv.loadModule(\"core\", CoreModule.INSTANCE)\n+      registerCollection(\"emp\",\n+        Seq(row(\"1\", \"A\", 1), row(\"1\", \"B\", 2), row(\"2\", \"C\", 3)),\n+        new RowTypeInfo(STRING_TYPE_INFO, STRING_TYPE_INFO, INT_TYPE_INFO),\n+        \"dep,name,salary\")\n+      checkResult(\n+        \"select dep,name,rank() over (partition by dep order by salary desc) as rnk from emp\",\n+        Seq(row(\"1\", \"A\", 2), row(\"1\", \"B\", 1), row(\"2\", \"C\", 1)))\n+    } finally {\n+      val modules = tEnv.listModules()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg4NzY4MQ=="}, "originalCommit": {"oid": "ea9722ea905907bdbb959633591186a935c168f4"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MDY2NDU1OnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/utils/UserDefinedFunctionTestUtils.scala", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMToxNzo0MVrOFuns-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMzo0MTozN1rOFur4sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQyOTMwNw==", "bodyText": "maybe we could improve this name: MyIsNull ?\nlike IsNullFunction or IsNullUDF or IsNullScalarFunction ?", "url": "https://github.com/apache/flink/pull/11215#discussion_r384429307", "createdAt": "2020-02-26T11:17:41Z", "author": {"login": "libenchao"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/utils/UserDefinedFunctionTestUtils.scala", "diffHunk": "@@ -377,6 +377,13 @@ object UserDefinedFunctionTestUtils {\n     override def getResultType(signature: Array[Class[_]]): TypeInformation[_] = Types.JAVA_BIG_DEC\n   }\n \n+  @SerialVersionUID(1L)\n+  object MyIsNull extends ScalarFunction {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a397a816cf507be5810bc6ea2f94a64583fe2ed6"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ5Nzg0Mw==", "bodyText": "Hmm, IsNullUDF  sounds better to me", "url": "https://github.com/apache/flink/pull/11215#discussion_r384497843", "createdAt": "2020-02-26T13:41:37Z", "author": {"login": "lirui-apache"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/utils/UserDefinedFunctionTestUtils.scala", "diffHunk": "@@ -377,6 +377,13 @@ object UserDefinedFunctionTestUtils {\n     override def getResultType(signature: Array[Class[_]]): TypeInformation[_] = Types.JAVA_BIG_DEC\n   }\n \n+  @SerialVersionUID(1L)\n+  object MyIsNull extends ScalarFunction {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQyOTMwNw=="}, "originalCommit": {"oid": "a397a816cf507be5810bc6ea2f94a64583fe2ed6"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MDY2ODA0OnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/batch/sql/OverWindowITCase.scala", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMToxODo0MlrOFunvDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMzo0NDoxNlrOFur-cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQyOTgzOQ==", "bodyText": "isnull -> isNull ?", "url": "https://github.com/apache/flink/pull/11215#discussion_r384429839", "createdAt": "2020-02-26T11:18:42Z", "author": {"login": "libenchao"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/batch/sql/OverWindowITCase.scala", "diffHunk": "@@ -2576,3 +2594,19 @@ class CountAggFunction extends AggregateFunction[JLong, CountAccumulator] {\n \n   override def getResultType: TypeInformation[JLong] = Types.LONG\n }\n+\n+private class TestModule extends Module {\n+\n+  private val funcName = \"isnull\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a397a816cf507be5810bc6ea2f94a64583fe2ed6"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ5OTMxMw==", "bodyText": "I don't think that matters, because I'm using equalsIgnoreCase down bellow.", "url": "https://github.com/apache/flink/pull/11215#discussion_r384499313", "createdAt": "2020-02-26T13:44:16Z", "author": {"login": "lirui-apache"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/batch/sql/OverWindowITCase.scala", "diffHunk": "@@ -2576,3 +2594,19 @@ class CountAggFunction extends AggregateFunction[JLong, CountAccumulator] {\n \n   override def getResultType: TypeInformation[JLong] = Types.LONG\n }\n+\n+private class TestModule extends Module {\n+\n+  private val funcName = \"isnull\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQyOTgzOQ=="}, "originalCommit": {"oid": "a397a816cf507be5810bc6ea2f94a64583fe2ed6"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MDY3MjA5OnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/batch/sql/OverWindowITCase.scala", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMToxOTo1OFrOFunxdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMToxOTo1OFrOFunxdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQzMDQ1Mw==", "bodyText": "Collections.singleton(funcName) ?", "url": "https://github.com/apache/flink/pull/11215#discussion_r384430453", "createdAt": "2020-02-26T11:19:58Z", "author": {"login": "libenchao"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/batch/sql/OverWindowITCase.scala", "diffHunk": "@@ -2576,3 +2594,19 @@ class CountAggFunction extends AggregateFunction[JLong, CountAccumulator] {\n \n   override def getResultType: TypeInformation[JLong] = Types.LONG\n }\n+\n+private class TestModule extends Module {\n+\n+  private val funcName = \"isnull\"\n+\n+  override def listFunctions(): util.Set[String] =\n+    new util.HashSet(Collections.singletonList(funcName))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a397a816cf507be5810bc6ea2f94a64583fe2ed6"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MDY3NjY5OnYy", "diffSide": "RIGHT", "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/batch/sql/OverWindowITCase.scala", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMToyMToyOVrOFun0Qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMToyMToyOVrOFun0Qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQzMTE3MQ==", "bodyText": "java.util already contains java.util.{Collections, Optional} ?", "url": "https://github.com/apache/flink/pull/11215#discussion_r384431171", "createdAt": "2020-02-26T11:21:29Z", "author": {"login": "libenchao"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/batch/sql/OverWindowITCase.scala", "diffHunk": "@@ -23,16 +23,20 @@ import org.apache.flink.api.java.tuple.{Tuple1 => JTuple1}\n import org.apache.flink.api.java.typeutils.{RowTypeInfo, TupleTypeInfo}\n import org.apache.flink.api.scala._\n import org.apache.flink.table.api.Types\n-import org.apache.flink.table.functions.AggregateFunction\n+import org.apache.flink.table.functions.{AggregateFunction, FunctionDefinition, ScalarFunctionDefinition}\n+import org.apache.flink.table.module.{CoreModule, Module}\n import org.apache.flink.table.planner.runtime.utils.BatchTestBase\n import org.apache.flink.table.planner.runtime.utils.BatchTestBase.row\n import org.apache.flink.table.planner.runtime.utils.TestData._\n+import org.apache.flink.table.planner.runtime.utils.UserDefinedFunctionTestUtils.MyIsNull\n import org.apache.flink.table.planner.utils.DateTimeTestUtil._\n import org.apache.flink.types.Row\n \n import org.junit.{Before, Test}\n \n import java.lang.{Iterable => JIterable, Long => JLong}\n+import java.util\n+import java.util.{Collections, Optional}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a397a816cf507be5810bc6ea2f94a64583fe2ed6"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1019, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}