{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyMjgyMTky", "number": 11489, "title": "[FLINK-15640][k8s] Support to set labels for jobmanager and taskmanager pod", "bodyText": "What is the purpose of the change\nIntroduce config options to support to set labels and node-selector for JM/TM pods.\n\nThe labels are key/value pairs that will be attached to the JM/TM pod.\n\nBrief change log\n\nSupport to set labels\n\nVerifying this change\n\nUnit tests\nManually test in a real cluster\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (no)\nThe serializers: (no)\nThe runtime per-record code paths (performance sensitive): (no)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes)\nThe S3 file system connector: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes)\nIf yes, how is the feature documented? (docs)", "createdAt": "2020-03-23T10:04:19Z", "url": "https://github.com/apache/flink/pull/11489", "merged": true, "mergeCommit": {"oid": "f4b68c4440c0c0a8ab061a4eac366bbb19233455"}, "closed": true, "closedAt": "2020-03-25T06:31:23Z", "author": {"login": "wangyang0918"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQbt4GgBqjMxNTQ1Njc1OTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRBgn6AFqTM4MDg4Mzg4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d61183919b562b016fbc677221b6946864996ca5", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/d61183919b562b016fbc677221b6946864996ca5", "committedDate": "2020-03-23T08:48:22Z", "message": "[FLINK-15640][k8s] Support to set node selector for jobmanager and taskmanager pod"}, "afterCommit": {"oid": "bb02ce865fa48c9259500a8408897605534b35c2", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/bb02ce865fa48c9259500a8408897605534b35c2", "committedDate": "2020-03-23T10:25:48Z", "message": "[FLINK-15640][k8s] Support to set node selector for jobmanager and taskmanager pod"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMDAzMjAx", "url": "https://github.com/apache/flink/pull/11489#pullrequestreview-380003201", "createdAt": "2020-03-24T05:08:50Z", "commit": {"oid": "bb02ce865fa48c9259500a8408897605534b35c2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwNTowODo1MFrOF6hKHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwNToxNzo1OFrOF6hR3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNDk5MQ==", "bodyText": "According to the order, the users can override the built-in labels by customization. I think the built-in labels should prioritize the user-specified ones. WDYT?", "url": "https://github.com/apache/flink/pull/11489#discussion_r396904991", "createdAt": "2020-03-24T05:08:50Z", "author": {"login": "zhengcanbin"}, "path": "flink-kubernetes/src/main/java/org/apache/flink/kubernetes/kubeclient/parameters/KubernetesJobManagerParameters.java", "diffHunk": "@@ -52,10 +54,16 @@ public KubernetesJobManagerParameters(Configuration flinkConfig, ClusterSpecific\n \n \t@Override\n \tpublic Map<String, String> getLabels() {\n-\t\tMap<String, String> labels = getCommonLabels();\n+\t\tfinal Map<String, String> labels = new HashMap<>(getCommonLabels());\n \t\tlabels.put(Constants.LABEL_COMPONENT_KEY, Constants.LABEL_COMPONENT_JOB_MANAGER);\n+\t\tflinkConfig.getOptional(KubernetesConfigOptions.JOB_MANAGER_LABELS).ifPresent(labels::putAll);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb02ce865fa48c9259500a8408897605534b35c2"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNjM0Ng==", "bodyText": "How about changing the key from kubernetes.jobmanager.node-selector to kubernetes.jobmanager.node-selectors? We use the plural for the user-specified annotations and labels, in the meantime use the singular for the node-selector. Could we use a consistent key naming convention for these kind of config options?", "url": "https://github.com/apache/flink/pull/11489#discussion_r396906346", "createdAt": "2020-03-24T05:14:59Z", "author": {"login": "zhengcanbin"}, "path": "flink-kubernetes/src/main/java/org/apache/flink/kubernetes/configuration/KubernetesConfigOptions.java", "diffHunk": "@@ -111,6 +112,34 @@\n \t// The following config options could be overridden by KubernetesCliOptions.\n \t// ---------------------------------------------------------------------------------\n \n+\tpublic static final ConfigOption<Map<String, String>> JOB_MANAGER_LABELS =\n+\t\tkey(\"kubernetes.jobmanager.labels\")\n+\t\t.mapType()\n+\t\t.noDefaultValue()\n+\t\t.withDescription(\"The labels to be set for JobManager pod. Specified as key:value pairs separated by commas. \" +\n+\t\t\t\"For example, version:alphav1,deploy:test.\");\n+\n+\tpublic static final ConfigOption<Map<String, String>> TASK_MANAGER_LABELS =\n+\t\tkey(\"kubernetes.taskmanager.labels\")\n+\t\t.mapType()\n+\t\t.noDefaultValue()\n+\t\t.withDescription(\"The labels to be set for TaskManager pods. Specified as key:value pairs separated by commas. \" +\n+\t\t\t\"For example, version:alphav1,deploy:test.\");\n+\n+\tpublic static final ConfigOption<Map<String, String>> JOB_MANAGER_NODE_SELECTOR =\n+\t\tkey(\"kubernetes.jobmanager.node-selector\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb02ce865fa48c9259500a8408897605534b35c2"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNjk3Mw==", "bodyText": "The same precedence problem?", "url": "https://github.com/apache/flink/pull/11489#discussion_r396906973", "createdAt": "2020-03-24T05:17:58Z", "author": {"login": "zhengcanbin"}, "path": "flink-kubernetes/src/main/java/org/apache/flink/kubernetes/kubeclient/parameters/KubernetesTaskManagerParameters.java", "diffHunk": "@@ -59,7 +62,15 @@ public KubernetesTaskManagerParameters(\n \n \t@Override\n \tpublic Map<String, String> getLabels() {\n-\t\treturn KubernetesUtils.getTaskManagerLabels(getClusterId());\n+\t\tfinal Map<String, String> labels = new HashMap<>(KubernetesUtils.getTaskManagerLabels(getClusterId()));\n+\t\tflinkConfig.getOptional(KubernetesConfigOptions.TASK_MANAGER_LABELS).ifPresent(labels::putAll);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb02ce865fa48c9259500a8408897605534b35c2"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bb02ce865fa48c9259500a8408897605534b35c2", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/bb02ce865fa48c9259500a8408897605534b35c2", "committedDate": "2020-03-23T10:25:48Z", "message": "[FLINK-15640][k8s] Support to set node selector for jobmanager and taskmanager pod"}, "afterCommit": {"oid": "3e878d1bd9107c7827414b484d22bc8d8dbd3c65", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/3e878d1bd9107c7827414b484d22bc8d8dbd3c65", "committedDate": "2020-03-24T13:15:11Z", "message": "[FLINK-15640][k8s] Support to set labels for jobmanager and taskmanager pod"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e878d1bd9107c7827414b484d22bc8d8dbd3c65", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/3e878d1bd9107c7827414b484d22bc8d8dbd3c65", "committedDate": "2020-03-24T13:15:11Z", "message": "[FLINK-15640][k8s] Support to set labels for jobmanager and taskmanager pod"}, "afterCommit": {"oid": "9a71b6a999e564d76981346f79ecc625df4d1fcd", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/9a71b6a999e564d76981346f79ecc625df4d1fcd", "committedDate": "2020-03-24T13:18:53Z", "message": "[FLINK-15640][k8s] Support to set labels for jobmanager and taskmanager pod"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f00be70f392bc99fad2e2ca34a39dacb57f41a2", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/9f00be70f392bc99fad2e2ca34a39dacb57f41a2", "committedDate": "2020-03-25T01:21:13Z", "message": "[hotfix][k8s] Close kube client in tear down"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a71b6a999e564d76981346f79ecc625df4d1fcd", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/9a71b6a999e564d76981346f79ecc625df4d1fcd", "committedDate": "2020-03-24T13:18:53Z", "message": "[FLINK-15640][k8s] Support to set labels for jobmanager and taskmanager pod"}, "afterCommit": {"oid": "496e0c34c6cdc9c6a4b1bf6a72df71328c2580e8", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/496e0c34c6cdc9c6a4b1bf6a72df71328c2580e8", "committedDate": "2020-03-25T01:26:25Z", "message": "[FLINK-15640][k8s] Support to set labels for jobmanager and taskmanager pod"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fc814200599cb0f4b8042b8d264e338c94ad2d3", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/5fc814200599cb0f4b8042b8d264e338c94ad2d3", "committedDate": "2020-03-25T01:34:19Z", "message": "[FLINK-15640][k8s] Support to set labels for jobmanager and taskmanager pod"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "496e0c34c6cdc9c6a4b1bf6a72df71328c2580e8", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/496e0c34c6cdc9c6a4b1bf6a72df71328c2580e8", "committedDate": "2020-03-25T01:26:25Z", "message": "[FLINK-15640][k8s] Support to set labels for jobmanager and taskmanager pod"}, "afterCommit": {"oid": "5fc814200599cb0f4b8042b8d264e338c94ad2d3", "author": {"user": {"login": "wangyang0918", "name": "Yang Wang"}}, "url": "https://github.com/apache/flink/commit/5fc814200599cb0f4b8042b8d264e338c94ad2d3", "committedDate": "2020-03-25T01:34:19Z", "message": "[FLINK-15640][k8s] Support to set labels for jobmanager and taskmanager pod"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwODgzODgy", "url": "https://github.com/apache/flink/pull/11489#pullrequestreview-380883882", "createdAt": "2020-03-25T06:28:20Z", "commit": {"oid": "5fc814200599cb0f4b8042b8d264e338c94ad2d3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2452, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}