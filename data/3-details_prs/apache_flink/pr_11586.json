{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2Njg3NDE4", "number": 11586, "title": "[FLINK-5552][runtime] make JMXServer static per JVM", "bodyText": "What is the purpose of the change\nThis is the first step to allow JMXServer information being returned via REST API.\nAfter we have the JMXServer available in each JVM, we could poke and retrieve the JMX server URL via REST API.\nBrief change log\n\nMoved JMXServer from JMXReporter private class into flink-runtime.\nAdded new configuration option jmx.server.port to allow configuration of the jmx server.\nLaunch JMXServer at start of each JMV entry (ClusterEntrypoint & TaskManagerRunner)\n\nVerifying this change\nThis change is already covered by existing tests, such as\n\nflink-runtime/tests\nflink-metrics-reporter-jmx/tests/\n\nThis change added tests and can be verified as follows:\n\nJMXReporterTests checks that there's only one singleton JMXServer being created across multiple JMXReporter.\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): yes\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? yes\nIf yes, how is the feature documented? docs", "createdAt": "2020-04-01T00:10:27Z", "url": "https://github.com/apache/flink/pull/11586", "merged": true, "mergeCommit": {"oid": "2b699d6cb20823cd3a437b49bc96f015f4c1b72e"}, "closed": true, "closedAt": "2020-08-03T20:28:38Z", "author": {"login": "walterddr"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTcljOAFqTM4NTM2ODczOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7RKPRgH2gAyMzk2Njg3NDE4OjIwMTIwMjYzZjdlNDE2OWI3NzZmMjYxOWNlMTQ3ZDVmZDI4Mjk1MTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MzY4NzM5", "url": "https://github.com/apache/flink/pull/11586#pullrequestreview-385368739", "createdAt": "2020-04-01T08:29:37Z", "commit": {"oid": "9944e5e1d6a5029b65e6ffea15eb431ee2896874"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoyOTozN1rOF-2FaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMDoyNToxMVrOF-6W_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ0MjE1Mg==", "bodyText": "This is a bit questionable from a functionality standpoint; is it just for documentation purposes?", "url": "https://github.com/apache/flink/pull/11586#discussion_r401442152", "createdAt": "2020-04-01T08:29:37Z", "author": {"login": "zentol"}, "path": "flink-core/src/main/java/org/apache/flink/configuration/JMXServerOptions.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.configuration;\n+\n+import org.apache.flink.annotation.PublicEvolving;\n+import org.apache.flink.annotation.docs.Documentation;\n+\n+import static org.apache.flink.configuration.ConfigOptions.key;\n+\n+/**\n+ * The set of configuration options relating to heartbeat manager settings.\n+ */\n+@PublicEvolving\n+public class JMXServerOptions {\n+\n+\t/** Port configured to enable JMX server for metrics and debugging. */\n+\t@Documentation.Section(Documentation.Sections.COMMON_MISCELLANEOUS)\n+\tpublic static final ConfigOption<String>JMX_SERVER_PORT =\n+\t\tkey(\"jmx.server.port\")\n+\t\t\t.defaultValue(\"-1\")\n+\t\t\t.withDescription(\"The port range for the JMX server to start the registry. The \" +\n+\t\t\t\t\"port config can be a single port: \\\"9123\\\", a range of ports: \\\"50100-50200\\\", \" +\n+\t\t\t\t\"or a list of ranges and ports: \\\"50100-50200,50300-50400,51234\\\".\")\n+\t\t\t.withDeprecatedKeys(\"metrics.reporter.my_jmx_reporter.port\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9944e5e1d6a5029b65e6ffea15eb431ee2896874"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ0Mzg3Ng==", "bodyText": "we should find some way to inform users that we are using the JVM-wide server, since it may (unexpectedly) be running on another port.\nIn a similar vein, we shouldn't close the jmxServer if we're re-using the singleton.", "url": "https://github.com/apache/flink/pull/11586#discussion_r401443876", "createdAt": "2020-04-01T08:32:35Z", "author": {"login": "zentol"}, "path": "flink-metrics/flink-metrics-jmx/src/main/java/org/apache/flink/metrics/jmx/JMXReporter.java", "diffHunk": "@@ -96,29 +87,7 @@ public String filterCharacters(String input) {\n \t\tthis.registeredMetrics = new HashMap<>();\n \n \t\tif (portsConfig != null) {\n-\t\t\tIterator<Integer> ports = NetUtils.getPortRangeFromString(portsConfig);\n-\n-\t\t\tJMXServer successfullyStartedServer = null;\n-\t\t\twhile (ports.hasNext() && successfullyStartedServer == null) {\n-\t\t\t\tJMXServer server = new JMXServer();\n-\t\t\t\tint port = ports.next();\n-\t\t\t\ttry {\n-\t\t\t\t\tserver.start(port);\n-\t\t\t\t\tLOG.info(\"Started JMX server on port \" + port + \".\");\n-\t\t\t\t\tsuccessfullyStartedServer = server;\n-\t\t\t\t} catch (IOException ioe) { //assume port conflict\n-\t\t\t\t\tLOG.debug(\"Could not start JMX server on port \" + port + \".\", ioe);\n-\t\t\t\t\ttry {\n-\t\t\t\t\t\tserver.stop();\n-\t\t\t\t\t} catch (Exception e) {\n-\t\t\t\t\t\tLOG.debug(\"Could not stop JMX server.\", e);\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t}\n-\t\t\tif (successfullyStartedServer == null) {\n-\t\t\t\tthrow new RuntimeException(\"Could not start JMX server on any configured port. Ports: \" + portsConfig);\n-\t\t\t}\n-\t\t\tthis.jmxServer = successfullyStartedServer;\n+\t\t\tthis.jmxServer = JMXServer.getInstance(portsConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9944e5e1d6a5029b65e6ffea15eb431ee2896874"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTUxMjE4OA==", "bodyText": "I'm not quite convinced that this should be a common option; based on how long we got by without it.", "url": "https://github.com/apache/flink/pull/11586#discussion_r401512188", "createdAt": "2020-04-01T10:25:11Z", "author": {"login": "zentol"}, "path": "flink-core/src/main/java/org/apache/flink/configuration/JMXServerOptions.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.configuration;\n+\n+import org.apache.flink.annotation.PublicEvolving;\n+import org.apache.flink.annotation.docs.Documentation;\n+\n+import static org.apache.flink.configuration.ConfigOptions.key;\n+\n+/**\n+ * The set of configuration options relating to heartbeat manager settings.\n+ */\n+@PublicEvolving\n+public class JMXServerOptions {\n+\n+\t/** Port configured to enable JMX server for metrics and debugging. */\n+\t@Documentation.Section(Documentation.Sections.COMMON_MISCELLANEOUS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9944e5e1d6a5029b65e6ffea15eb431ee2896874"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9944e5e1d6a5029b65e6ffea15eb431ee2896874", "author": {"user": {"login": "walterddr", "name": "Rong Rong"}}, "url": "https://github.com/apache/flink/commit/9944e5e1d6a5029b65e6ffea15eb431ee2896874", "committedDate": "2020-03-31T23:58:56Z", "message": "improve doc as well"}, "afterCommit": {"oid": "93e2ff504bdd2caed1fe63fee05fce54b9a96f56", "author": {"user": {"login": "walterddr", "name": "Rong Rong"}}, "url": "https://github.com/apache/flink/commit/93e2ff504bdd2caed1fe63fee05fce54b9a96f56", "committedDate": "2020-04-09T14:50:46Z", "message": "make all JMXServer public API static and log JMXReporter port configuration deprecate warning."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93e2ff504bdd2caed1fe63fee05fce54b9a96f56", "author": {"user": {"login": "walterddr", "name": "Rong Rong"}}, "url": "https://github.com/apache/flink/commit/93e2ff504bdd2caed1fe63fee05fce54b9a96f56", "committedDate": "2020-04-09T14:50:46Z", "message": "make all JMXServer public API static and log JMXReporter port configuration deprecate warning."}, "afterCommit": {"oid": "613a5fd798911229926144246b94635cde46c6ed", "author": {"user": {"login": "walterddr", "name": "Rong Rong"}}, "url": "https://github.com/apache/flink/commit/613a5fd798911229926144246b94635cde46c6ed", "committedDate": "2020-05-27T20:23:33Z", "message": "adding in JMXServer test specifically validate startup/tierdown and register MBeans"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNzk2MDQz", "url": "https://github.com/apache/flink/pull/11586#pullrequestreview-420796043", "createdAt": "2020-05-29T09:30:28Z", "commit": {"oid": "613a5fd798911229926144246b94635cde46c6ed"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOTozMDoyOFrOGcVmRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOTo1MDowNVrOGcWPAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM2NzE3NQ==", "bodyText": "needs an update", "url": "https://github.com/apache/flink/pull/11586#discussion_r432367175", "createdAt": "2020-05-29T09:30:28Z", "author": {"login": "zentol"}, "path": "flink-core/src/main/java/org/apache/flink/configuration/JMXServerOptions.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.configuration;\n+\n+import org.apache.flink.annotation.PublicEvolving;\n+import org.apache.flink.annotation.docs.Documentation;\n+\n+import static org.apache.flink.configuration.ConfigOptions.key;\n+\n+/**\n+ * The set of configuration options relating to heartbeat manager settings.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "613a5fd798911229926144246b94635cde46c6ed"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM2NzYxMQ==", "bodyText": "the new section must be integrated into the documentation, by embedding the resulting .html file.", "url": "https://github.com/apache/flink/pull/11586#discussion_r432367611", "createdAt": "2020-05-29T09:31:18Z", "author": {"login": "zentol"}, "path": "flink-annotations/src/main/java/org/apache/flink/annotation/docs/Documentation.java", "diffHunk": "@@ -82,6 +82,7 @@\n \t\tpublic static final String STATE_BACKEND_ROCKSDB = \"state_backend_rocksdb\";\n \n \t\tpublic static final String EXPERT_CLASS_LOADING = \"expert_class_loading\";\n+\t\tpublic static final String EXPERT_DEBUGGING_AND_TUNING = \"expert_debugging_and_tuning\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "613a5fd798911229926144246b94635cde46c6ed"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3MDU0OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * reconstruct again. Instead a warning sign will be posted if the desired\n          \n          \n            \n            \t * reconstructed again. Instead a warning will be logged if the given", "url": "https://github.com/apache/flink/pull/11586#discussion_r432370548", "createdAt": "2020-05-29T09:36:54Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/management/JMXServer.java", "diffHunk": "@@ -0,0 +1,239 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.management;\n+\n+import org.apache.flink.configuration.JMXServerOptions;\n+import org.apache.flink.util.NetUtils;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.management.remote.JMXConnectorServer;\n+import javax.management.remote.JMXServiceURL;\n+import javax.management.remote.rmi.RMIConnectorServer;\n+import javax.management.remote.rmi.RMIJRMPServerImpl;\n+\n+import java.io.IOException;\n+import java.lang.management.ManagementFactory;\n+import java.net.MalformedURLException;\n+import java.rmi.NoSuchObjectException;\n+import java.rmi.NotBoundException;\n+import java.rmi.Remote;\n+import java.rmi.RemoteException;\n+import java.rmi.registry.Registry;\n+import java.rmi.server.UnicastRemoteObject;\n+import java.util.Iterator;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+\n+/**\n+ * JMX Server implementation that JMX clients can connect to.\n+ *\n+ * <p>Heavily based on j256 simplejmx project\n+ *\n+ * <p>https://github.com/j256/simplejmx/blob/master/src/main/java/com/j256/simplejmx/server/JmxServer.java\n+ */\n+public class JMXServer {\n+\tprivate static final Logger LOG = LoggerFactory.getLogger(JMXServer.class);\n+\n+\tprivate static JMXServer instance = null;\n+\n+\tprivate final AtomicReference<Remote> rmiServerReference = new AtomicReference<>();\n+\n+\tprivate Registry rmiRegistry;\n+\tprivate JMXConnectorServer connector;\n+\tprivate int port;\n+\n+\t/**\n+\t * Construct a new JMV-wide JMX server or acquire existing JMX server.\n+\t *\n+\t * <p>If JMXServer static instance is already constructed, it will not be\n+\t * reconstruct again. Instead a warning sign will be posted if the desired", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "613a5fd798911229926144246b94635cde46c6ed"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3MTExMg==", "bodyText": "having no default value at all would make this easier to understand imo", "url": "https://github.com/apache/flink/pull/11586#discussion_r432371112", "createdAt": "2020-05-29T09:37:55Z", "author": {"login": "zentol"}, "path": "flink-core/src/main/java/org/apache/flink/configuration/JMXServerOptions.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.configuration;\n+\n+import org.apache.flink.annotation.PublicEvolving;\n+import org.apache.flink.annotation.docs.Documentation;\n+\n+import static org.apache.flink.configuration.ConfigOptions.key;\n+\n+/**\n+ * The set of configuration options relating to heartbeat manager settings.\n+ */\n+@PublicEvolving\n+public class JMXServerOptions {\n+\n+\t/** Port configured to enable JMX server for metrics and debugging. */\n+\t@Documentation.Section(Documentation.Sections.EXPERT_DEBUGGING_AND_TUNING)\n+\tpublic static final ConfigOption<String>JMX_SERVER_PORT =\n+\t\tkey(\"jmx.server.port\")\n+\t\t\t.defaultValue(\"-1\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "613a5fd798911229926144246b94635cde46c6ed"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3MjEyMw==", "bodyText": "these methods should be made thread-safe, otherwise you can end up starting 2 servers and never shutting one of them down.", "url": "https://github.com/apache/flink/pull/11586#discussion_r432372123", "createdAt": "2020-05-29T09:39:50Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/management/JMXServer.java", "diffHunk": "@@ -0,0 +1,239 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.management;\n+\n+import org.apache.flink.configuration.JMXServerOptions;\n+import org.apache.flink.util.NetUtils;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.management.remote.JMXConnectorServer;\n+import javax.management.remote.JMXServiceURL;\n+import javax.management.remote.rmi.RMIConnectorServer;\n+import javax.management.remote.rmi.RMIJRMPServerImpl;\n+\n+import java.io.IOException;\n+import java.lang.management.ManagementFactory;\n+import java.net.MalformedURLException;\n+import java.rmi.NoSuchObjectException;\n+import java.rmi.NotBoundException;\n+import java.rmi.Remote;\n+import java.rmi.RemoteException;\n+import java.rmi.registry.Registry;\n+import java.rmi.server.UnicastRemoteObject;\n+import java.util.Iterator;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+\n+/**\n+ * JMX Server implementation that JMX clients can connect to.\n+ *\n+ * <p>Heavily based on j256 simplejmx project\n+ *\n+ * <p>https://github.com/j256/simplejmx/blob/master/src/main/java/com/j256/simplejmx/server/JmxServer.java\n+ */\n+public class JMXServer {\n+\tprivate static final Logger LOG = LoggerFactory.getLogger(JMXServer.class);\n+\n+\tprivate static JMXServer instance = null;\n+\n+\tprivate final AtomicReference<Remote> rmiServerReference = new AtomicReference<>();\n+\n+\tprivate Registry rmiRegistry;\n+\tprivate JMXConnectorServer connector;\n+\tprivate int port;\n+\n+\t/**\n+\t * Construct a new JMV-wide JMX server or acquire existing JMX server.\n+\t *\n+\t * <p>If JMXServer static instance is already constructed, it will not be\n+\t * reconstruct again. Instead a warning sign will be posted if the desired\n+\t * port configuration doesn't match the existing JMXServer static instance.\n+\t *\n+\t * @param portsConfig port configuration of the JMX server.\n+\t * @return JMXServer static instance.\n+\t */\n+\tpublic static JMXServer startInstance(String portsConfig) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "613a5fd798911229926144246b94635cde46c6ed"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3MzkxNg==", "bodyText": "I'd move this into #startInstance; if portsConfig is an empty string then the iterator is empty, allowing you to easily check for the port to not be configured.", "url": "https://github.com/apache/flink/pull/11586#discussion_r432373916", "createdAt": "2020-05-29T09:43:13Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/management/JMXServer.java", "diffHunk": "@@ -0,0 +1,239 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.management;\n+\n+import org.apache.flink.configuration.JMXServerOptions;\n+import org.apache.flink.util.NetUtils;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.management.remote.JMXConnectorServer;\n+import javax.management.remote.JMXServiceURL;\n+import javax.management.remote.rmi.RMIConnectorServer;\n+import javax.management.remote.rmi.RMIJRMPServerImpl;\n+\n+import java.io.IOException;\n+import java.lang.management.ManagementFactory;\n+import java.net.MalformedURLException;\n+import java.rmi.NoSuchObjectException;\n+import java.rmi.NotBoundException;\n+import java.rmi.Remote;\n+import java.rmi.RemoteException;\n+import java.rmi.registry.Registry;\n+import java.rmi.server.UnicastRemoteObject;\n+import java.util.Iterator;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+\n+/**\n+ * JMX Server implementation that JMX clients can connect to.\n+ *\n+ * <p>Heavily based on j256 simplejmx project\n+ *\n+ * <p>https://github.com/j256/simplejmx/blob/master/src/main/java/com/j256/simplejmx/server/JmxServer.java\n+ */\n+public class JMXServer {\n+\tprivate static final Logger LOG = LoggerFactory.getLogger(JMXServer.class);\n+\n+\tprivate static JMXServer instance = null;\n+\n+\tprivate final AtomicReference<Remote> rmiServerReference = new AtomicReference<>();\n+\n+\tprivate Registry rmiRegistry;\n+\tprivate JMXConnectorServer connector;\n+\tprivate int port;\n+\n+\t/**\n+\t * Construct a new JMV-wide JMX server or acquire existing JMX server.\n+\t *\n+\t * <p>If JMXServer static instance is already constructed, it will not be\n+\t * reconstruct again. Instead a warning sign will be posted if the desired\n+\t * port configuration doesn't match the existing JMXServer static instance.\n+\t *\n+\t * @param portsConfig port configuration of the JMX server.\n+\t * @return JMXServer static instance.\n+\t */\n+\tpublic static JMXServer startInstance(String portsConfig) {\n+\t\tif (instance == null) {\n+\t\t\tif (!portsConfig.equals(JMXServerOptions.JMX_SERVER_PORT.defaultValue())) {\n+\t\t\t\tinstance = startJMXServerWithPortRanges(portsConfig);\n+\t\t\t} else {\n+\t\t\t\tLOG.warn(\"JMX Server start failed. No explicit JMX port is configured.\");\n+\t\t\t\tinstance = null;\n+\t\t\t}\n+\t\t} else {\n+\t\t\tLOG.warn(\"JVM-wide JMXServer already started at port: \" + instance.port);\n+\t\t}\n+\t\treturn instance;\n+\t}\n+\n+\t/**\n+\t * Acquire existing JMX server. or null if not started.\n+\t *\n+\t * @return the JMXServer static instance.\n+\t */\n+\tpublic static JMXServer getInstance() {\n+\t\treturn instance;\n+\t}\n+\n+\t/**\n+\t * Stop the JMX server.\n+\t */\n+\tpublic static void stopInstance() throws IOException {\n+\t\tif (instance != null) {\n+\t\t\tinstance.stop();\n+\t\t\tinstance = null;\n+\t\t}\n+\t}\n+\n+\tpublic static int getPort() {\n+\t\tif (instance != null) {\n+\t\t\treturn instance.port;\n+\t\t} else {\n+\t\t\treturn -1;\n+\t\t}\n+\t}\n+\n+\tprivate static JMXServer startJMXServerWithPortRanges(String portsConfig) {\n+\t\tIterator<Integer> ports = NetUtils.getPortRangeFromString(portsConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "613a5fd798911229926144246b94635cde46c6ed"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NDQzMQ==", "bodyText": "return an Optional instead, then you can probably also get rid of JMXServer#getInstance", "url": "https://github.com/apache/flink/pull/11586#discussion_r432374431", "createdAt": "2020-05-29T09:44:05Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/management/JMXServer.java", "diffHunk": "@@ -0,0 +1,239 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.management;\n+\n+import org.apache.flink.configuration.JMXServerOptions;\n+import org.apache.flink.util.NetUtils;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.management.remote.JMXConnectorServer;\n+import javax.management.remote.JMXServiceURL;\n+import javax.management.remote.rmi.RMIConnectorServer;\n+import javax.management.remote.rmi.RMIJRMPServerImpl;\n+\n+import java.io.IOException;\n+import java.lang.management.ManagementFactory;\n+import java.net.MalformedURLException;\n+import java.rmi.NoSuchObjectException;\n+import java.rmi.NotBoundException;\n+import java.rmi.Remote;\n+import java.rmi.RemoteException;\n+import java.rmi.registry.Registry;\n+import java.rmi.server.UnicastRemoteObject;\n+import java.util.Iterator;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+\n+/**\n+ * JMX Server implementation that JMX clients can connect to.\n+ *\n+ * <p>Heavily based on j256 simplejmx project\n+ *\n+ * <p>https://github.com/j256/simplejmx/blob/master/src/main/java/com/j256/simplejmx/server/JmxServer.java\n+ */\n+public class JMXServer {\n+\tprivate static final Logger LOG = LoggerFactory.getLogger(JMXServer.class);\n+\n+\tprivate static JMXServer instance = null;\n+\n+\tprivate final AtomicReference<Remote> rmiServerReference = new AtomicReference<>();\n+\n+\tprivate Registry rmiRegistry;\n+\tprivate JMXConnectorServer connector;\n+\tprivate int port;\n+\n+\t/**\n+\t * Construct a new JMV-wide JMX server or acquire existing JMX server.\n+\t *\n+\t * <p>If JMXServer static instance is already constructed, it will not be\n+\t * reconstruct again. Instead a warning sign will be posted if the desired\n+\t * port configuration doesn't match the existing JMXServer static instance.\n+\t *\n+\t * @param portsConfig port configuration of the JMX server.\n+\t * @return JMXServer static instance.\n+\t */\n+\tpublic static JMXServer startInstance(String portsConfig) {\n+\t\tif (instance == null) {\n+\t\t\tif (!portsConfig.equals(JMXServerOptions.JMX_SERVER_PORT.defaultValue())) {\n+\t\t\t\tinstance = startJMXServerWithPortRanges(portsConfig);\n+\t\t\t} else {\n+\t\t\t\tLOG.warn(\"JMX Server start failed. No explicit JMX port is configured.\");\n+\t\t\t\tinstance = null;\n+\t\t\t}\n+\t\t} else {\n+\t\t\tLOG.warn(\"JVM-wide JMXServer already started at port: \" + instance.port);\n+\t\t}\n+\t\treturn instance;\n+\t}\n+\n+\t/**\n+\t * Acquire existing JMX server. or null if not started.\n+\t *\n+\t * @return the JMXServer static instance.\n+\t */\n+\tpublic static JMXServer getInstance() {\n+\t\treturn instance;\n+\t}\n+\n+\t/**\n+\t * Stop the JMX server.\n+\t */\n+\tpublic static void stopInstance() throws IOException {\n+\t\tif (instance != null) {\n+\t\t\tinstance.stop();\n+\t\t\tinstance = null;\n+\t\t}\n+\t}\n+\n+\tpublic static int getPort() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "613a5fd798911229926144246b94635cde46c6ed"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NDU3Mw==", "bodyText": "return an Optional instead", "url": "https://github.com/apache/flink/pull/11586#discussion_r432374573", "createdAt": "2020-05-29T09:44:24Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/management/JMXServer.java", "diffHunk": "@@ -0,0 +1,239 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.management;\n+\n+import org.apache.flink.configuration.JMXServerOptions;\n+import org.apache.flink.util.NetUtils;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.management.remote.JMXConnectorServer;\n+import javax.management.remote.JMXServiceURL;\n+import javax.management.remote.rmi.RMIConnectorServer;\n+import javax.management.remote.rmi.RMIJRMPServerImpl;\n+\n+import java.io.IOException;\n+import java.lang.management.ManagementFactory;\n+import java.net.MalformedURLException;\n+import java.rmi.NoSuchObjectException;\n+import java.rmi.NotBoundException;\n+import java.rmi.Remote;\n+import java.rmi.RemoteException;\n+import java.rmi.registry.Registry;\n+import java.rmi.server.UnicastRemoteObject;\n+import java.util.Iterator;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+\n+/**\n+ * JMX Server implementation that JMX clients can connect to.\n+ *\n+ * <p>Heavily based on j256 simplejmx project\n+ *\n+ * <p>https://github.com/j256/simplejmx/blob/master/src/main/java/com/j256/simplejmx/server/JmxServer.java\n+ */\n+public class JMXServer {\n+\tprivate static final Logger LOG = LoggerFactory.getLogger(JMXServer.class);\n+\n+\tprivate static JMXServer instance = null;\n+\n+\tprivate final AtomicReference<Remote> rmiServerReference = new AtomicReference<>();\n+\n+\tprivate Registry rmiRegistry;\n+\tprivate JMXConnectorServer connector;\n+\tprivate int port;\n+\n+\t/**\n+\t * Construct a new JMV-wide JMX server or acquire existing JMX server.\n+\t *\n+\t * <p>If JMXServer static instance is already constructed, it will not be\n+\t * reconstruct again. Instead a warning sign will be posted if the desired\n+\t * port configuration doesn't match the existing JMXServer static instance.\n+\t *\n+\t * @param portsConfig port configuration of the JMX server.\n+\t * @return JMXServer static instance.\n+\t */\n+\tpublic static JMXServer startInstance(String portsConfig) {\n+\t\tif (instance == null) {\n+\t\t\tif (!portsConfig.equals(JMXServerOptions.JMX_SERVER_PORT.defaultValue())) {\n+\t\t\t\tinstance = startJMXServerWithPortRanges(portsConfig);\n+\t\t\t} else {\n+\t\t\t\tLOG.warn(\"JMX Server start failed. No explicit JMX port is configured.\");\n+\t\t\t\tinstance = null;\n+\t\t\t}\n+\t\t} else {\n+\t\t\tLOG.warn(\"JVM-wide JMXServer already started at port: \" + instance.port);\n+\t\t}\n+\t\treturn instance;\n+\t}\n+\n+\t/**\n+\t * Acquire existing JMX server. or null if not started.\n+\t *\n+\t * @return the JMXServer static instance.\n+\t */\n+\tpublic static JMXServer getInstance() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "613a5fd798911229926144246b94635cde46c6ed"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NTc2MQ==", "bodyText": "this line should never be reached", "url": "https://github.com/apache/flink/pull/11586#discussion_r432375761", "createdAt": "2020-05-29T09:46:39Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/management/JMXServerTest.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.management;\n+\n+import org.junit.Test;\n+\n+import javax.management.InstanceNotFoundException;\n+import javax.management.MBeanServer;\n+import javax.management.MBeanServerConnection;\n+import javax.management.ObjectName;\n+import javax.management.remote.JMXConnector;\n+import javax.management.remote.JMXConnectorFactory;\n+import javax.management.remote.JMXServiceURL;\n+\n+import java.lang.management.ManagementFactory;\n+import java.net.ServerSocket;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * Tests for the JMXServer.\n+ */\n+public class JMXServerTest {\n+\n+\t/**\n+\t * Verifies initialize with port range.\n+\t */\n+\t@Test\n+\tpublic void testJMXServerInit() throws Exception {\n+\t\ttry {\n+\t\t\tJMXServer.startInstance(\"23456-23466\");\n+\t\t\tassertNotNull(JMXServer.getInstance());\n+\t\t} finally {\n+\t\t\tJMXServer.stopInstance();\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Verifies initialize failure with occupied port.\n+\t */\n+\t@Test\n+\tpublic void testJMXServerInitWithInvalidPorts() throws Exception {\n+\t\ttry {\n+\t\t\tServerSocket socket = new ServerSocket(23456);\n+\t\t\tassertEquals(23456, socket.getLocalPort());\n+\t\t\tJMXServer.startInstance(\"23456\");\n+\t\t\tassertNull(JMXServer.getInstance());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "613a5fd798911229926144246b94635cde46c6ed"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NjcwNg==", "bodyText": "This should have a private constructor if all instantiations are supposed to go through startInstance. If not, then an explicit constructor might clarify things a bit.", "url": "https://github.com/apache/flink/pull/11586#discussion_r432376706", "createdAt": "2020-05-29T09:48:25Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/management/JMXServer.java", "diffHunk": "@@ -0,0 +1,239 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.management;\n+\n+import org.apache.flink.configuration.JMXServerOptions;\n+import org.apache.flink.util.NetUtils;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.management.remote.JMXConnectorServer;\n+import javax.management.remote.JMXServiceURL;\n+import javax.management.remote.rmi.RMIConnectorServer;\n+import javax.management.remote.rmi.RMIJRMPServerImpl;\n+\n+import java.io.IOException;\n+import java.lang.management.ManagementFactory;\n+import java.net.MalformedURLException;\n+import java.rmi.NoSuchObjectException;\n+import java.rmi.NotBoundException;\n+import java.rmi.Remote;\n+import java.rmi.RemoteException;\n+import java.rmi.registry.Registry;\n+import java.rmi.server.UnicastRemoteObject;\n+import java.util.Iterator;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+\n+/**\n+ * JMX Server implementation that JMX clients can connect to.\n+ *\n+ * <p>Heavily based on j256 simplejmx project\n+ *\n+ * <p>https://github.com/j256/simplejmx/blob/master/src/main/java/com/j256/simplejmx/server/JmxServer.java\n+ */\n+public class JMXServer {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "613a5fd798911229926144246b94635cde46c6ed"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NzYwMA==", "bodyText": "I'd say that the JMXServer itself should not have the singleton logic, and instead have something like a SingletonHolder object for that stuff.\nThere is for example no reason why the tests should work with a singleton; this usually just leads to issues.", "url": "https://github.com/apache/flink/pull/11586#discussion_r432377600", "createdAt": "2020-05-29T09:50:05Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/management/JMXServer.java", "diffHunk": "@@ -0,0 +1,239 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.management;\n+\n+import org.apache.flink.configuration.JMXServerOptions;\n+import org.apache.flink.util.NetUtils;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.management.remote.JMXConnectorServer;\n+import javax.management.remote.JMXServiceURL;\n+import javax.management.remote.rmi.RMIConnectorServer;\n+import javax.management.remote.rmi.RMIJRMPServerImpl;\n+\n+import java.io.IOException;\n+import java.lang.management.ManagementFactory;\n+import java.net.MalformedURLException;\n+import java.rmi.NoSuchObjectException;\n+import java.rmi.NotBoundException;\n+import java.rmi.Remote;\n+import java.rmi.RemoteException;\n+import java.rmi.registry.Registry;\n+import java.rmi.server.UnicastRemoteObject;\n+import java.util.Iterator;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+\n+/**\n+ * JMX Server implementation that JMX clients can connect to.\n+ *\n+ * <p>Heavily based on j256 simplejmx project\n+ *\n+ * <p>https://github.com/j256/simplejmx/blob/master/src/main/java/com/j256/simplejmx/server/JmxServer.java\n+ */\n+public class JMXServer {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NjcwNg=="}, "originalCommit": {"oid": "613a5fd798911229926144246b94635cde46c6ed"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNTc5MTIw", "url": "https://github.com/apache/flink/pull/11586#pullrequestreview-422579120", "createdAt": "2020-06-02T11:19:58Z", "commit": {"oid": "613a5fd798911229926144246b94635cde46c6ed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMToxOTo1OFrOGdtJDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMToxOTo1OFrOGdtJDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzgwMTQ4Ng==", "bodyText": "This should not be logged as a warning (since it is completely fine to not have a JMXServer); probably only at debug.", "url": "https://github.com/apache/flink/pull/11586#discussion_r433801486", "createdAt": "2020-06-02T11:19:58Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/management/JMXServer.java", "diffHunk": "@@ -0,0 +1,239 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.management;\n+\n+import org.apache.flink.configuration.JMXServerOptions;\n+import org.apache.flink.util.NetUtils;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.management.remote.JMXConnectorServer;\n+import javax.management.remote.JMXServiceURL;\n+import javax.management.remote.rmi.RMIConnectorServer;\n+import javax.management.remote.rmi.RMIJRMPServerImpl;\n+\n+import java.io.IOException;\n+import java.lang.management.ManagementFactory;\n+import java.net.MalformedURLException;\n+import java.rmi.NoSuchObjectException;\n+import java.rmi.NotBoundException;\n+import java.rmi.Remote;\n+import java.rmi.RemoteException;\n+import java.rmi.registry.Registry;\n+import java.rmi.server.UnicastRemoteObject;\n+import java.util.Iterator;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+\n+/**\n+ * JMX Server implementation that JMX clients can connect to.\n+ *\n+ * <p>Heavily based on j256 simplejmx project\n+ *\n+ * <p>https://github.com/j256/simplejmx/blob/master/src/main/java/com/j256/simplejmx/server/JmxServer.java\n+ */\n+public class JMXServer {\n+\tprivate static final Logger LOG = LoggerFactory.getLogger(JMXServer.class);\n+\n+\tprivate static JMXServer instance = null;\n+\n+\tprivate final AtomicReference<Remote> rmiServerReference = new AtomicReference<>();\n+\n+\tprivate Registry rmiRegistry;\n+\tprivate JMXConnectorServer connector;\n+\tprivate int port;\n+\n+\t/**\n+\t * Construct a new JMV-wide JMX server or acquire existing JMX server.\n+\t *\n+\t * <p>If JMXServer static instance is already constructed, it will not be\n+\t * reconstruct again. Instead a warning sign will be posted if the desired\n+\t * port configuration doesn't match the existing JMXServer static instance.\n+\t *\n+\t * @param portsConfig port configuration of the JMX server.\n+\t * @return JMXServer static instance.\n+\t */\n+\tpublic static JMXServer startInstance(String portsConfig) {\n+\t\tif (instance == null) {\n+\t\t\tif (!portsConfig.equals(JMXServerOptions.JMX_SERVER_PORT.defaultValue())) {\n+\t\t\t\tinstance = startJMXServerWithPortRanges(portsConfig);\n+\t\t\t} else {\n+\t\t\t\tLOG.warn(\"JMX Server start failed. No explicit JMX port is configured.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "613a5fd798911229926144246b94635cde46c6ed"}, "originalPosition": 78}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "613a5fd798911229926144246b94635cde46c6ed", "author": {"user": {"login": "walterddr", "name": "Rong Rong"}}, "url": "https://github.com/apache/flink/commit/613a5fd798911229926144246b94635cde46c6ed", "committedDate": "2020-05-27T20:23:33Z", "message": "adding in JMXServer test specifically validate startup/tierdown and register MBeans"}, "afterCommit": {"oid": "0c0af972ac3f8477eba6c65cfe990a6af0105707", "author": {"user": {"login": "walterddr", "name": "Rong Rong"}}, "url": "https://github.com/apache/flink/commit/0c0af972ac3f8477eba6c65cfe990a6af0105707", "committedDate": "2020-06-05T14:36:19Z", "message": "[hotfix] regenerate doc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NjYzOTYy", "url": "https://github.com/apache/flink/pull/11586#pullrequestreview-455663962", "createdAt": "2020-07-27T10:32:16Z", "commit": {"oid": "0c0af972ac3f8477eba6c65cfe990a6af0105707"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxMDozMjoxNlrOG3c4GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxMDo0NTozN1rOG3dQfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc5Nzk3Nw==", "bodyText": "this could be shortened to Optional.ofNullable(jmxServer).map(JMXServer::getPort);", "url": "https://github.com/apache/flink/pull/11586#discussion_r460797977", "createdAt": "2020-07-27T10:32:16Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/management/JMXService.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.management;\n+\n+import org.apache.flink.util.NetUtils;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.util.Iterator;\n+import java.util.Optional;\n+\n+/**\n+ * Provide a JVM-wide singleton JMX Service.\n+ */\n+public class JMXService {\n+\tprivate static final Logger LOG = LoggerFactory.getLogger(JMXService.class);\n+\tprivate static JMXServer jmxServer = null;\n+\n+\t/**\n+\t * Acquire the global singleton JMXServer instance.\n+\t *\n+\t * @return JMXServer static instance.\n+\t */\n+\tpublic static JMXServer getInstance() {\n+\t\treturn jmxServer;\n+\t}\n+\n+\t/**\n+\t * Start the JMV-wide singleton JMX server.\n+\t *\n+\t * <p>If JMXServer static instance is already started, it will not be\n+\t * started again. Instead a warning will be logged indicating which port\n+\t * the existing JMXServer static instance is exposing.\n+\t *\n+\t * @param portsConfig port configuration of the JMX server.\n+\t */\n+\tpublic static synchronized void startInstance(String portsConfig) {\n+\t\tif (jmxServer == null) {\n+\t\t\tif (portsConfig != null) {\n+\t\t\t\tIterator<Integer> ports = NetUtils.getPortRangeFromString(portsConfig);\n+\t\t\t\tif (ports.hasNext()) {\n+\t\t\t\t\tjmxServer = startJMXServerWithPortRanges(ports);\n+\t\t\t\t}\n+\t\t\t\tif (jmxServer == null) {\n+\t\t\t\t\tLOG.error(\"Could not start JMx server on any configured port(s) in: \" + portsConfig);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\tLOG.warn(\"JVM-wide JMXServer already started at port: \" + jmxServer.getPort());\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Stop the JMX server.\n+\t */\n+\tpublic static synchronized void stopInstance() throws IOException {\n+\t\tif (jmxServer != null) {\n+\t\t\tjmxServer.stop();\n+\t\t\tjmxServer = null;\n+\t\t}\n+\t}\n+\n+\tpublic static Optional<Integer> getPort() {\n+\t\tif (jmxServer == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0af972ac3f8477eba6c65cfe990a6af0105707"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc5OTcwMw==", "bodyText": "where do these come from? O.o", "url": "https://github.com/apache/flink/pull/11586#discussion_r460799703", "createdAt": "2020-07-27T10:35:45Z", "author": {"login": "zentol"}, "path": "docs/_includes/generated/stop_configuration.html", "diffHunk": "@@ -0,0 +1,12 @@\n+<table class=\"table table-bordered\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0af972ac3f8477eba6c65cfe990a6af0105707"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgwMDE4MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\"this option overrides metrics.reporter.*.port configurations.\");\n          \n          \n            \n            \t\t\t\t\"This option overrides metrics.reporter.*.port option.\");", "url": "https://github.com/apache/flink/pull/11586#discussion_r460800181", "createdAt": "2020-07-27T10:36:50Z", "author": {"login": "zentol"}, "path": "flink-core/src/main/java/org/apache/flink/configuration/JMXServerOptions.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.configuration;\n+\n+import org.apache.flink.annotation.PublicEvolving;\n+import org.apache.flink.annotation.docs.Documentation;\n+\n+import static org.apache.flink.configuration.ConfigOptions.key;\n+\n+/**\n+ * The set of configuration options relating to JMX server.\n+ */\n+@PublicEvolving\n+public class JMXServerOptions {\n+\n+\t/** Port configured to enable JMX server for metrics and debugging. */\n+\t@Documentation.Section(Documentation.Sections.EXPERT_DEBUGGING_AND_TUNING)\n+\tpublic static final ConfigOption<String>JMX_SERVER_PORT =\n+\t\tkey(\"jmx.server.port\")\n+\t\t\t.noDefaultValue()\n+\t\t\t.withDescription(\"The port range for the JMX server to start the registry. The \" +\n+\t\t\t\t\"port config can be a single port: \\\"9123\\\", a range of ports: \\\"50100-50200\\\", \" +\n+\t\t\t\t\"or a list of ranges and ports: \\\"50100-50200,50300-50400,51234\\\". \\n\" +\n+\t\t\t\t\"this option overrides metrics.reporter.*.port configurations.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0af972ac3f8477eba6c65cfe990a6af0105707"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgwMTMzMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t.withDescription(\"The port range for the JMX server to start the registry. The \" +\n          \n          \n            \n            \t\t\t.withDescription(Description.builder()\n          \n          \n            \n            \t\t\t\t.text(...port config...)\n          \n          \n            \n            \t\t\t\t.lineBreak()\n          \n          \n            \n            \t\t\t\t.text(...overrides...)\n          \n          \n            \n            \t\t\t\t.build());", "url": "https://github.com/apache/flink/pull/11586#discussion_r460801331", "createdAt": "2020-07-27T10:39:28Z", "author": {"login": "zentol"}, "path": "flink-core/src/main/java/org/apache/flink/configuration/JMXServerOptions.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.configuration;\n+\n+import org.apache.flink.annotation.PublicEvolving;\n+import org.apache.flink.annotation.docs.Documentation;\n+\n+import static org.apache.flink.configuration.ConfigOptions.key;\n+\n+/**\n+ * The set of configuration options relating to JMX server.\n+ */\n+@PublicEvolving\n+public class JMXServerOptions {\n+\n+\t/** Port configured to enable JMX server for metrics and debugging. */\n+\t@Documentation.Section(Documentation.Sections.EXPERT_DEBUGGING_AND_TUNING)\n+\tpublic static final ConfigOption<String>JMX_SERVER_PORT =\n+\t\tkey(\"jmx.server.port\")\n+\t\t\t.noDefaultValue()\n+\t\t\t.withDescription(\"The port range for the JMX server to start the registry. The \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0af972ac3f8477eba6c65cfe990a6af0105707"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgwMjU3MA==", "bodyText": "unused?", "url": "https://github.com/apache/flink/pull/11586#discussion_r460802570", "createdAt": "2020-07-27T10:42:15Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/management/JMXServerTest.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.management;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import javax.management.InstanceNotFoundException;\n+import javax.management.MBeanServer;\n+import javax.management.MBeanServerConnection;\n+import javax.management.ObjectName;\n+import javax.management.remote.JMXConnector;\n+import javax.management.remote.JMXConnectorFactory;\n+import javax.management.remote.JMXServiceURL;\n+\n+import java.lang.management.ManagementFactory;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * Test for {@link JMXServer} functionality.\n+ */\n+public class JMXServerTest {\n+\n+\t@Before\n+\tpublic void setUp() throws Exception {\n+\t\tJMXService.startInstance(\"23456-23466\");\n+\t}\n+\n+\t@After\n+\tpublic void tierDown() throws Exception {\n+\t\tJMXService.stopInstance();\n+\t}\n+\n+\t/**\n+\t * Verifies initialize, registered mBean and retrieval via attribute.\n+\t */\n+\t@Test\n+\tpublic void testJMXServiceRegisterMBean() throws Exception {\n+\t\tTestObject testObject = new TestObject();\n+\t\tObjectName testObjectName = new ObjectName(\"org.apache.flink.management\", \"key\", \"value\");\n+\t\tMBeanServer mBeanServer = ManagementFactory.getPlatformMBeanServer();\n+\n+\t\ttry {\n+\t\t\tJMXServer server = JMXService.getInstance();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0af972ac3f8477eba6c65cfe990a6af0105707"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgwMjk1OA==", "bodyText": "Return an Optional instead.", "url": "https://github.com/apache/flink/pull/11586#discussion_r460802958", "createdAt": "2020-07-27T10:42:56Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/management/JMXService.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.management;\n+\n+import org.apache.flink.util.NetUtils;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.util.Iterator;\n+import java.util.Optional;\n+\n+/**\n+ * Provide a JVM-wide singleton JMX Service.\n+ */\n+public class JMXService {\n+\tprivate static final Logger LOG = LoggerFactory.getLogger(JMXService.class);\n+\tprivate static JMXServer jmxServer = null;\n+\n+\t/**\n+\t * Acquire the global singleton JMXServer instance.\n+\t *\n+\t * @return JMXServer static instance.\n+\t */\n+\tpublic static JMXServer getInstance() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0af972ac3f8477eba6c65cfe990a6af0105707"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgwMzA0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\tLOG.error(\"Could not start JMx server on any configured port(s) in: \" + portsConfig);\n          \n          \n            \n            \t\t\t\t\tLOG.error(\"Could not start JMX server on any configured port(s) in: \" + portsConfig);", "url": "https://github.com/apache/flink/pull/11586#discussion_r460803042", "createdAt": "2020-07-27T10:43:08Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/main/java/org/apache/flink/runtime/management/JMXService.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.management;\n+\n+import org.apache.flink.util.NetUtils;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.util.Iterator;\n+import java.util.Optional;\n+\n+/**\n+ * Provide a JVM-wide singleton JMX Service.\n+ */\n+public class JMXService {\n+\tprivate static final Logger LOG = LoggerFactory.getLogger(JMXService.class);\n+\tprivate static JMXServer jmxServer = null;\n+\n+\t/**\n+\t * Acquire the global singleton JMXServer instance.\n+\t *\n+\t * @return JMXServer static instance.\n+\t */\n+\tpublic static JMXServer getInstance() {\n+\t\treturn jmxServer;\n+\t}\n+\n+\t/**\n+\t * Start the JMV-wide singleton JMX server.\n+\t *\n+\t * <p>If JMXServer static instance is already started, it will not be\n+\t * started again. Instead a warning will be logged indicating which port\n+\t * the existing JMXServer static instance is exposing.\n+\t *\n+\t * @param portsConfig port configuration of the JMX server.\n+\t */\n+\tpublic static synchronized void startInstance(String portsConfig) {\n+\t\tif (jmxServer == null) {\n+\t\t\tif (portsConfig != null) {\n+\t\t\t\tIterator<Integer> ports = NetUtils.getPortRangeFromString(portsConfig);\n+\t\t\t\tif (ports.hasNext()) {\n+\t\t\t\t\tjmxServer = startJMXServerWithPortRanges(ports);\n+\t\t\t\t}\n+\t\t\t\tif (jmxServer == null) {\n+\t\t\t\t\tLOG.error(\"Could not start JMx server on any configured port(s) in: \" + portsConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0af972ac3f8477eba6c65cfe990a6af0105707"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgwNDIyMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tServerSocket socket = null;\n          \n          \n            \n            \t\ttry {\n          \n          \n            \n            \t\t\tsocket = new ServerSocket(23456);\n          \n          \n            \n            \t\t\tassertEquals(23456, socket.getLocalPort());\n          \n          \n            \n            \t\t\tJMXService.startInstance(\"23456\");\n          \n          \n            \n            \t\t\tassertNull(JMXService.getInstance());\n          \n          \n            \n            \t\t} finally {\n          \n          \n            \n            \t\t\tif (socket != null) {\n          \n          \n            \n            \t\t\t\tsocket.close();\n          \n          \n            \n            \t\t\t}\n          \n          \n            \n            \t\t}\n          \n          \n            \n            \t\ttry (ServerSocket socket = new ServerSocket(23456)) {\n          \n          \n            \n            \t\t\tassertEquals(23456, socket.getLocalPort());\n          \n          \n            \n            \t\t\tJMXService.startInstance(\"23456\");\n          \n          \n            \n            \t\t\tassertNull(JMXService.getInstance());\n          \n          \n            \n            \t\t}", "url": "https://github.com/apache/flink/pull/11586#discussion_r460804222", "createdAt": "2020-07-27T10:45:37Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/management/JMXServiceTest.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.management;\n+\n+import org.junit.Test;\n+\n+import java.net.ServerSocket;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * Tests for the singleton usage via {@link JMXService}.\n+ */\n+public class JMXServiceTest {\n+\n+\t/**\n+\t * Verifies initialize with port range.\n+\t */\n+\t@Test\n+\tpublic void testJMXServiceInit() throws Exception {\n+\t\ttry {\n+\t\t\tJMXService.startInstance(\"23456-23466\");\n+\t\t\tassertTrue(JMXService.getPort().isPresent());\n+\t\t} finally {\n+\t\t\tJMXService.stopInstance();\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Verifies initialize failure with occupied port.\n+\t */\n+\t@Test\n+\tpublic void testJMXServiceInitWithInvalidPorts() throws Exception {\n+\t\tServerSocket socket = null;\n+\t\ttry {\n+\t\t\tsocket = new ServerSocket(23456);\n+\t\t\tassertEquals(23456, socket.getLocalPort());\n+\t\t\tJMXService.startInstance(\"23456\");\n+\t\t\tassertNull(JMXService.getInstance());\n+\t\t} finally {\n+\t\t\tif (socket != null) {\n+\t\t\t\tsocket.close();\n+\t\t\t}\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0af972ac3f8477eba6c65cfe990a6af0105707"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "780ecf8a0edb014a6f5708a2bc6defd69dc4f4fa", "author": {"user": {"login": "walterddr", "name": "Rong Rong"}}, "url": "https://github.com/apache/flink/commit/780ecf8a0edb014a6f5708a2bc6defd69dc4f4fa", "committedDate": "2020-08-01T14:57:30Z", "message": "[FLINK-5552] make JMXServer static per JVM and start them in each JMV entry point (ClusterEntrypoint & TaskManagerRunner)\n\nimprove doc as well\n\nUpdate document according to PR comments\n\nmake all JMXServer public API static and log JMXReporter port configuration deprecate warning."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9620e0d85823fd9e292035de4b50cb0037ef406d", "author": {"user": {"login": "walterddr", "name": "Rong Rong"}}, "url": "https://github.com/apache/flink/commit/9620e0d85823fd9e292035de4b50cb0037ef406d", "committedDate": "2020-08-01T14:57:30Z", "message": "cherry-picked FLINK-16697 changes to JMXServer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90db1f10ed019ced524b27cdd0f2ab60d676a1d6", "author": {"user": {"login": "walterddr", "name": "Rong Rong"}}, "url": "https://github.com/apache/flink/commit/90db1f10ed019ced524b27cdd0f2ab60d676a1d6", "committedDate": "2020-08-01T14:57:30Z", "message": "adding in JMXServer test specifically validate startup/tierdown and register MBeans"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eff0abbbdf3c48a05a3e6c8626d19b2f95439770", "author": {"user": {"login": "walterddr", "name": "Rong Rong"}}, "url": "https://github.com/apache/flink/commit/eff0abbbdf3c48a05a3e6c8626d19b2f95439770", "committedDate": "2020-08-01T14:57:30Z", "message": "[hotfix] address diff comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08d94f69627b70972dcdebfdc47dff02a8bbd1a9", "author": {"user": {"login": "walterddr", "name": "Rong Rong"}}, "url": "https://github.com/apache/flink/commit/08d94f69627b70972dcdebfdc47dff02a8bbd1a9", "committedDate": "2020-08-01T14:57:31Z", "message": "[hotfix] regenerate doc"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0c0af972ac3f8477eba6c65cfe990a6af0105707", "author": {"user": {"login": "walterddr", "name": "Rong Rong"}}, "url": "https://github.com/apache/flink/commit/0c0af972ac3f8477eba6c65cfe990a6af0105707", "committedDate": "2020-06-05T14:36:19Z", "message": "[hotfix] regenerate doc"}, "afterCommit": {"oid": "7ccd9503c18aa3a191e6216cd4c7ea1eaed0def3", "author": {"user": {"login": "walterddr", "name": "Rong Rong"}}, "url": "https://github.com/apache/flink/commit/7ccd9503c18aa3a191e6216cd4c7ea1eaed0def3", "committedDate": "2020-08-01T16:31:33Z", "message": "address diff comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dcab37b9b395b0a31fff1d7f1cc440c2e1aab27", "author": {"user": {"login": "walterddr", "name": "Rong Rong"}}, "url": "https://github.com/apache/flink/commit/7dcab37b9b395b0a31fff1d7f1cc440c2e1aab27", "committedDate": "2020-08-02T16:51:34Z", "message": "address diff comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ccd9503c18aa3a191e6216cd4c7ea1eaed0def3", "author": {"user": {"login": "walterddr", "name": "Rong Rong"}}, "url": "https://github.com/apache/flink/commit/7ccd9503c18aa3a191e6216cd4c7ea1eaed0def3", "committedDate": "2020-08-01T16:31:33Z", "message": "address diff comments"}, "afterCommit": {"oid": "7dcab37b9b395b0a31fff1d7f1cc440c2e1aab27", "author": {"user": {"login": "walterddr", "name": "Rong Rong"}}, "url": "https://github.com/apache/flink/commit/7dcab37b9b395b0a31fff1d7f1cc440c2e1aab27", "committedDate": "2020-08-02T16:51:34Z", "message": "address diff comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77d4ef7f7de8aa619e29b0b2b55a8794e15f0ab4", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/77d4ef7f7de8aa619e29b0b2b55a8794e15f0ab4", "committedDate": "2020-08-03T09:11:19Z", "message": "Update JMXServerTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b83bfca0b3710bbd8d041f75361295a8d9dbcaf", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/9b83bfca0b3710bbd8d041f75361295a8d9dbcaf", "committedDate": "2020-08-03T09:17:50Z", "message": "Update JMXServiceTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1f95202588964bb1e9e3bb3316f99246aa530ad", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/d1f95202588964bb1e9e3bb3316f99246aa530ad", "committedDate": "2020-08-03T09:19:13Z", "message": "Update JMXServiceTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20120263f7e4169b776f2619ce147d5fd2829511", "author": {"user": {"login": "zentol", "name": "Chesnay Schepler"}}, "url": "https://github.com/apache/flink/commit/20120263f7e4169b776f2619ce147d5fd2829511", "committedDate": "2020-08-03T12:27:11Z", "message": "Update expert_debugging_and_tuning_section.html"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2199, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}