{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzNDQ2MTcy", "number": 13368, "title": "[FLINK-19000] Forward initialization timestamp from Dispatcher to ExecGraph", "bodyText": "What is the purpose of the change\nFLINK-16866 (\"Make job submission non-blocking\") introduced a new JobStatus INITIALIZING. However, the ExecutionGraph.stateTimestamps field does not contain the proper timestamp for the INITIALIZING state (it will only be non-zero while the job is INITIALIZING).\nThis change forwards the timestamp from the Dispatcher to the ExecutionGraph.\nBrief change log\n\nMove timestamp creation out of DispatcherJob into Dispatcher\nForward timestamp from Dispatcher to ExecutionGraph\nAdd a test\n\nVerifying this change\nThe change includes a new test.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\nNot necessary.", "createdAt": "2020-09-10T06:44:11Z", "url": "https://github.com/apache/flink/pull/13368", "merged": true, "mergeCommit": {"oid": "e20229c0d5ad1cc59d51270407f4d3a2a811a144"}, "closed": true, "closedAt": "2020-09-16T11:04:48Z", "author": {"login": "rmetzger"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJGI_KAFqTQ4ODU4NDc5NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJY2SHABqjM3NzIyMTc1Mzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NTg0Nzk1", "url": "https://github.com/apache/flink/pull/13368#pullrequestreview-488584795", "createdAt": "2020-09-15T11:27:18Z", "commit": {"oid": "59deb5d9ae2ddf42b40ff4391d567daa8abef8db"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMToyNzoxOFrOHR9NSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMTozMToxNFrOHR9V7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU5MDY2Nw==", "bodyText": "maybe also check that initializing <= created, to prevent the order from being messed up?", "url": "https://github.com/apache/flink/pull/13368#discussion_r488590667", "createdAt": "2020-09-15T11:27:18Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherTest.java", "diffHunk": "@@ -749,6 +750,26 @@ public void testOnRemovedJobGraphDoesNotCleanUpHAFiles() throws Exception {\n \t\t} catch (TimeoutException expected) {}\n \t}\n \n+\t@Test\n+\tpublic void testInitializationTimestampForwardedToExecutionGraph() throws Exception {\n+\t\tdispatcher = createAndStartDispatcher(heartbeatServices, haServices, new ExpectedJobIdJobManagerRunnerFactory(TEST_JOB_ID, createdJobManagerRunnerLatch));\n+\t\tjobMasterLeaderElectionService.isLeader(UUID.randomUUID());\n+\t\tDispatcherGateway dispatcherGateway = dispatcher.getSelfGateway(DispatcherGateway.class);\n+\n+\t\tdispatcherGateway.submitJob(jobGraph, TIMEOUT).get();\n+\n+\t\t// ensure job is running\n+\t\tCommonTestUtils.waitUntilCondition(() -> dispatcherGateway.requestJobStatus(jobGraph.getJobID(), TIMEOUT).get() == JobStatus.RUNNING,\n+\t\t\tDeadline.fromNow(Duration.of(10, ChronoUnit.SECONDS)), 5L);\n+\n+\t\tArchivedExecutionGraph result = dispatcher.requestJob(jobGraph.getJobID(), TIMEOUT).get();\n+\n+\t\t// ensure all statuses are set in the ExecutionGraph\n+\t\tassertThat(result.getStatusTimestamp(JobStatus.INITIALIZING), greaterThan(0L));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59deb5d9ae2ddf42b40ff4391d567daa8abef8db"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU5MjUxNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tDeadline.fromNow(Duration.of(10, ChronoUnit.SECONDS)), 5L);\n          \n          \n            \n            \t\t\tDeadline.fromNow(Duration.ofSeconds(10), 5L);", "url": "https://github.com/apache/flink/pull/13368#discussion_r488592517", "createdAt": "2020-09-15T11:30:37Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherTest.java", "diffHunk": "@@ -749,6 +750,26 @@ public void testOnRemovedJobGraphDoesNotCleanUpHAFiles() throws Exception {\n \t\t} catch (TimeoutException expected) {}\n \t}\n \n+\t@Test\n+\tpublic void testInitializationTimestampForwardedToExecutionGraph() throws Exception {\n+\t\tdispatcher = createAndStartDispatcher(heartbeatServices, haServices, new ExpectedJobIdJobManagerRunnerFactory(TEST_JOB_ID, createdJobManagerRunnerLatch));\n+\t\tjobMasterLeaderElectionService.isLeader(UUID.randomUUID());\n+\t\tDispatcherGateway dispatcherGateway = dispatcher.getSelfGateway(DispatcherGateway.class);\n+\n+\t\tdispatcherGateway.submitJob(jobGraph, TIMEOUT).get();\n+\n+\t\t// ensure job is running\n+\t\tCommonTestUtils.waitUntilCondition(() -> dispatcherGateway.requestJobStatus(jobGraph.getJobID(), TIMEOUT).get() == JobStatus.RUNNING,\n+\t\t\tDeadline.fromNow(Duration.of(10, ChronoUnit.SECONDS)), 5L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59deb5d9ae2ddf42b40ff4391d567daa8abef8db"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU5Mjg3OA==", "bodyText": "I'd move all arguments on a separate line.", "url": "https://github.com/apache/flink/pull/13368#discussion_r488592878", "createdAt": "2020-09-15T11:31:14Z", "author": {"login": "zentol"}, "path": "flink-runtime/src/test/java/org/apache/flink/runtime/dispatcher/DispatcherTest.java", "diffHunk": "@@ -749,6 +750,26 @@ public void testOnRemovedJobGraphDoesNotCleanUpHAFiles() throws Exception {\n \t\t} catch (TimeoutException expected) {}\n \t}\n \n+\t@Test\n+\tpublic void testInitializationTimestampForwardedToExecutionGraph() throws Exception {\n+\t\tdispatcher = createAndStartDispatcher(heartbeatServices, haServices, new ExpectedJobIdJobManagerRunnerFactory(TEST_JOB_ID, createdJobManagerRunnerLatch));\n+\t\tjobMasterLeaderElectionService.isLeader(UUID.randomUUID());\n+\t\tDispatcherGateway dispatcherGateway = dispatcher.getSelfGateway(DispatcherGateway.class);\n+\n+\t\tdispatcherGateway.submitJob(jobGraph, TIMEOUT).get();\n+\n+\t\t// ensure job is running\n+\t\tCommonTestUtils.waitUntilCondition(() -> dispatcherGateway.requestJobStatus(jobGraph.getJobID(), TIMEOUT).get() == JobStatus.RUNNING,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59deb5d9ae2ddf42b40ff4391d567daa8abef8db"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ff28b0ea5826238175f26c45807cabdd0a61aee", "author": {"user": {"login": "rmetzger", "name": "Robert Metzger"}}, "url": "https://github.com/apache/flink/commit/0ff28b0ea5826238175f26c45807cabdd0a61aee", "committedDate": "2020-09-15T12:29:18Z", "message": "Address PR comments"}, "afterCommit": {"oid": "2283347d77ac8220df889b20a5906f02f2b1315f", "author": {"user": {"login": "rmetzger", "name": "Robert Metzger"}}, "url": "https://github.com/apache/flink/commit/2283347d77ac8220df889b20a5906f02f2b1315f", "committedDate": "2020-09-15T12:30:35Z", "message": "Address PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5Mzc2OTM5", "url": "https://github.com/apache/flink/pull/13368#pullrequestreview-489376939", "createdAt": "2020-09-16T08:08:38Z", "commit": {"oid": "2283347d77ac8220df889b20a5906f02f2b1315f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12967c8721b5515d55eff87cfdc4b53633b6f1a8", "author": {"user": {"login": "rmetzger", "name": "Robert Metzger"}}, "url": "https://github.com/apache/flink/commit/12967c8721b5515d55eff87cfdc4b53633b6f1a8", "committedDate": "2020-09-16T09:17:55Z", "message": "[FLINK-19000] Forward initialization timestamp from Dispatcher to ExecutionGraph\n\nThis closes #13368"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e20229c0d5ad1cc59d51270407f4d3a2a811a144", "author": {"user": {"login": "rmetzger", "name": "Robert Metzger"}}, "url": "https://github.com/apache/flink/commit/e20229c0d5ad1cc59d51270407f4d3a2a811a144", "committedDate": "2020-09-16T09:18:06Z", "message": "[hotfix] Consider INITIALIZING JobState also as scheduled in CliFrontend"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2283347d77ac8220df889b20a5906f02f2b1315f", "author": {"user": {"login": "rmetzger", "name": "Robert Metzger"}}, "url": "https://github.com/apache/flink/commit/2283347d77ac8220df889b20a5906f02f2b1315f", "committedDate": "2020-09-15T12:30:35Z", "message": "Address PR comments"}, "afterCommit": {"oid": "e20229c0d5ad1cc59d51270407f4d3a2a811a144", "author": {"user": {"login": "rmetzger", "name": "Robert Metzger"}}, "url": "https://github.com/apache/flink/commit/e20229c0d5ad1cc59d51270407f4d3a2a811a144", "committedDate": "2020-09-16T09:18:06Z", "message": "[hotfix] Consider INITIALIZING JobState also as scheduled in CliFrontend"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4553, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}