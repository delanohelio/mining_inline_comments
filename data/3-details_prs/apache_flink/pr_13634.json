{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzMzIxODMx", "number": 13634, "title": "[FLINK-19629]Fix NullPointException in avro format as null value on MAP type", "bodyText": "What is the purpose of the change\nFix the NullPointException in avro format to support nullable in MAP type field. For example, we create the table with ddl\ncreate table tableA (\n...\nname MAP<STRING, STRING>\n) with (\n'connector' = 'kafka',\n'topic' = 'xxx',\n'properties.bootstrap.servers' = 'localhost:9092',\n'properties.group.id' = 'xxx',\n'scan.startup.mode' = 'earliest-offset',\n'format' = 'avro'\n);\n\nif name have an null value like this:\n{...,\"name\": {\"key1\":null}}\ncause an NullPointException:\njava.io.IOException: Failed to deserialize Avro record.\n\tat org.apache.flink.formats.avro.AvroRowDataDeserializationSchema.deserialize(AvroRowDataDeserializationSchema.java:150)\n\tat org.apache.flink.formats.avro.AvroRowDataDeserializationSchema.deserialize(AvroRowDataDeserializationSchema.java:75)\n\tat org.apache.flink.api.common.serialization.DeserializationSchema.deserialize(DeserializationSchema.java:81)\n\tat org.apache.flink.streaming.connectors.kafka.internals.KafkaDeserializationSchemaWrapper.deserialize(KafkaDeserializationSchemaWrapper.java:56)\n\tat org.apache.flink.streaming.connectors.kafka.internal.Kafka010Fetcher.runFetchLoop(Kafka010Fetcher.java:147)\n\tat org.apache.flink.streaming.connectors.kafka.FlinkKafkaConsumerBase.run(FlinkKafkaConsumerBase.java:755)\n\tat org.apache.flink.streaming.api.operators.StreamSource.run(StreamSource.java:100)\n\tat org.apache.flink.streaming.api.operators.StreamSource.run(StreamSource.java:63)\n\tat org.apache.flink.streaming.runtime.tasks.SourceStreamTask$LegacySourceFunctionThread.run(SourceStreamTask.java:201)\nCaused by: java.lang.NullPointerException: null\n\nBrief change log\n\nFix the NullPointException in avro format to support nullable in MAP type field.\n\nVerifying this change\nThis change added tests and can be verified as follows:\n\nModify AvroToRowDataConverters#createMapConverter that final AvroToRowDataConverter valueConverter = createNullableConverter(extractValueTypeToAvroMap(type))\nadd tests for AvroRowDataDeSerializationSchemaTest#testNullableMapType\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API, i.e., is any changed class annotated with @Public(Evolving): no\nThe serializers: no\nThe runtime per-record code paths (performance sensitive): no\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no\nThe S3 file system connector: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? no\nIf yes, how is the feature documented? no", "createdAt": "2020-10-14T11:59:57Z", "url": "https://github.com/apache/flink/pull/13634", "merged": true, "mergeCommit": {"oid": "3c661074b2a597db312ebaf6734c58eb66464ba4"}, "closed": true, "closedAt": "2020-10-22T02:56:11Z", "author": {"login": "shizhengchao"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSbegnAH2gAyNTAzMzIxODMxOmQ3MTlhY2JkODZkYjA4Y2I5MjBhYWM1MTFlNGVmMGU4MjcyMDQ2OWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdU44e_AFqTUxNDMyMzQxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d719acbd86db08cb920aac511e4ef0e82720469f", "author": {"user": {"login": "shizhengchao", "name": "shizhengchao"}}, "url": "https://github.com/apache/flink/commit/d719acbd86db08cb920aac511e4ef0e82720469f", "committedDate": "2020-10-14T11:28:38Z", "message": "[FLINK-19629]Fix NullPointException in avro format whith null value in map type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNjU4NTMz", "url": "https://github.com/apache/flink/pull/13634#pullrequestreview-513658533", "createdAt": "2020-10-21T13:10:39Z", "commit": {"oid": "d719acbd86db08cb920aac511e4ef0e82720469f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzoxMDozOVrOHlrBKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzoxMDozOVrOHlrBKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2NDE2OQ==", "bodyText": "We don't need to add such a big test. You can just add a null entry to the map in the testSerializeDeserialize.", "url": "https://github.com/apache/flink/pull/13634#discussion_r509264169", "createdAt": "2020-10-21T13:10:39Z", "author": {"login": "wuchong"}, "path": "flink-formats/flink-avro/src/test/java/org/apache/flink/formats/avro/AvroRowDataDeSerializationSchemaTest.java", "diffHunk": "@@ -198,4 +198,38 @@ public void testSpecificType() throws Exception {\n \t\tAssert.assertEquals(\"12:12:12\", DataFormatConverters.LocalTimeConverter.INSTANCE.toExternal(\n \t\t\t\trowData.getInt(2)).toString());\n \t}\n+\n+\t@Test\n+\tpublic void testNullableMapType() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d719acbd86db08cb920aac511e4ef0e82720469f"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16a7e73c66d66707a59d19be6ace83ba664f20fc", "author": {"user": {"login": "shizhengchao", "name": "shizhengchao"}}, "url": "https://github.com/apache/flink/commit/16a7e73c66d66707a59d19be6ace83ba664f20fc", "committedDate": "2020-10-21T14:28:30Z", "message": "[FLINK-19629][Formats] Remove testNullableMapType method and add a null entry to the map in the testSerializeDeserialize"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MzEyNjAx", "url": "https://github.com/apache/flink/pull/13634#pullrequestreview-514312601", "createdAt": "2020-10-22T02:16:52Z", "commit": {"oid": "16a7e73c66d66707a59d19be6ace83ba664f20fc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwMjoxNjo1MlrOHmOG6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwMjoxNjo1MlrOHmOG6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgzOTA4MA==", "bodyText": "key can also be null?", "url": "https://github.com/apache/flink/pull/13634#discussion_r509839080", "createdAt": "2020-10-22T02:16:52Z", "author": {"login": "libenchao"}, "path": "flink-formats/flink-avro/src/main/java/org/apache/flink/formats/avro/AvroToRowDataConverters.java", "diffHunk": "@@ -178,7 +178,7 @@ private static AvroToRowDataConverter createArrayConverter(ArrayType arrayType)\n \n \tprivate static AvroToRowDataConverter createMapConverter(LogicalType type) {\n \t\tfinal AvroToRowDataConverter keyConverter = createConverter(DataTypes.STRING().getLogicalType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16a7e73c66d66707a59d19be6ace83ba664f20fc"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MzIzNDE2", "url": "https://github.com/apache/flink/pull/13634#pullrequestreview-514323416", "createdAt": "2020-10-22T02:52:06Z", "commit": {"oid": "16a7e73c66d66707a59d19be6ace83ba664f20fc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3241, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}