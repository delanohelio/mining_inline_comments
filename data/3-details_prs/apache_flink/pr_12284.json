{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMzQ3NDMy", "number": 12284, "title": "[FLINK-17689][kafka][table] Add integration tests for changelog sourc\u2026", "bodyText": "\u2026e and formats\n\nWhat is the purpose of the change\nCurrently, we didn't add IT cases for debezium changelog formats. This PR added IT cases for Kafka source which has debezium data in it's topic.\nBrief change log\n\nAdd expectedNum option in values sink connector, because Kafka source is infinite, the job should be stopped from sink.\n\nVerifying this change\n\nadded testKafkaDebeziumChangelogSource in kafka universion version. We don't need to add it to all versions to save testing time.\nadded some more plan tests in TableScanTest to verify applying join, window on changelog source. We already have a test in batch TableScanTest to verify changelog source is not supported.\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-05-21T13:18:38Z", "url": "https://github.com/apache/flink/pull/12284", "merged": true, "mergeCommit": {"oid": "f47ffc26aa893b19cad935e6656fda199d12281d"}, "closed": true, "closedAt": "2020-05-28T06:08:53Z", "author": {"login": "wuchong"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABckv1cSAFqTQxNzY5OTU3Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABclkayHgBqjMzODA3ODkxODg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3Njk5NTc3", "url": "https://github.com/apache/flink/pull/12284#pullrequestreview-417699577", "createdAt": "2020-05-25T13:08:42Z", "commit": {"oid": "760f994e14c290dd4c31b67e15751862d6ee520f"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxMzowODo0M1rOGaAmKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxMzoxMToxMlrOGaAqkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyNTkzMQ==", "bodyText": "Should we move the check to the constructor ?", "url": "https://github.com/apache/flink/pull/12284#discussion_r429925931", "createdAt": "2020-05-25T13:08:43Z", "author": {"login": "danny0405"}, "path": "flink-table/flink-table-planner-blink/src/test/java/org/apache/flink/table/planner/factories/TestValuesTableFactory.java", "diffHunk": "@@ -633,8 +648,11 @@ public SinkRuntimeProvider getSinkRuntimeProvider(Context context) {\n \t\t\t\t\tsinkFunction = new KeyedUpsertingSinkFunction(\n \t\t\t\t\t\ttableName,\n \t\t\t\t\t\tconverter,\n-\t\t\t\t\t\tkeyIndices);\n+\t\t\t\t\t\tkeyIndices,\n+\t\t\t\t\t\texpectedNum);\n \t\t\t\t} else {\n+\t\t\t\t\tcheckArgument(expectedNum == -1,\n+\t\t\t\t\t\t\"Retracting Sink doesn't support '\" + SINK_EXPECTED_MESSAGES_NUM.key() + \"' yet.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "760f994e14c290dd4c31b67e15751862d6ee520f"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyNjQ3Mg==", "bodyText": ">= or = ?", "url": "https://github.com/apache/flink/pull/12284#discussion_r429926472", "createdAt": "2020-05-25T13:09:52Z", "author": {"login": "danny0405"}, "path": "flink-table/flink-table-planner-blink/src/test/java/org/apache/flink/table/planner/factories/TestValuesRuntimeFunctions.java", "diffHunk": "@@ -247,6 +265,12 @@ public void invoke(RowData value, Context context) throws Exception {\n \t\t\t\t\t\t\"This is probably an incorrectly implemented test.\");\n \t\t\t\t}\n \t\t\t}\n+\t\t\treceivedNum++;\n+\t\t\tif (expectedSize != -1 && receivedNum >= expectedSize) {\n+\t\t\t\t// some sources are infinite (e.g. kafka),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "760f994e14c290dd4c31b67e15751862d6ee520f"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyNzA1Nw==", "bodyText": "Can we also add a ITCase for the stream join ?", "url": "https://github.com/apache/flink/pull/12284#discussion_r429927057", "createdAt": "2020-05-25T13:11:12Z", "author": {"login": "danny0405"}, "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/stream/sql/TableScanTest.scala", "diffHunk": "@@ -186,6 +186,61 @@ class TableScanTest extends TableTestBase {\n     util.verifyPlan(\"SELECT COUNT(*) FROM src WHERE a > 1\", ExplainDetail.CHANGELOG_MODE)\n   }\n \n+  @Test\n+  def testJoinOnChangelogSource(): Unit = {\n+    util.addTable(\n+      \"\"\"\n+        |CREATE TABLE changelog_src (\n+        |  ts TIMESTAMP(3),\n+        |  a INT,\n+        |  b DOUBLE\n+        |) WITH (\n+        |  'connector' = 'values',\n+        |  'changelog-mode' = 'I,UA,UB'\n+        |)\n+      \"\"\".stripMargin)\n+    util.addTable(\n+      \"\"\"\n+        |CREATE TABLE append_src (\n+        |  ts TIMESTAMP(3),\n+        |  a INT,\n+        |  b DOUBLE\n+        |) WITH (\n+        |  'connector' = 'values',\n+        |  'changelog-mode' = 'I'\n+        |)\n+      \"\"\".stripMargin)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "760f994e14c290dd4c31b67e15751862d6ee520f"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3OTk0MDQ4", "url": "https://github.com/apache/flink/pull/12284#pullrequestreview-417994048", "createdAt": "2020-05-26T06:10:24Z", "commit": {"oid": "dac757cc5a0f392c8f0ef7b9a7796a2fc8fe9768"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d72be5f884f7f28247c8144d7b268240a2e4398", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/4d72be5f884f7f28247c8144d7b268240a2e4398", "committedDate": "2020-05-28T02:26:44Z", "message": "[FLINK-17689][kafka][table] Add integration tests for changelog source and formats\n\nThis closes #12284"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dac757cc5a0f392c8f0ef7b9a7796a2fc8fe9768", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/dac757cc5a0f392c8f0ef7b9a7796a2fc8fe9768", "committedDate": "2020-05-25T15:44:24Z", "message": "address Danny's review comment."}, "afterCommit": {"oid": "4d72be5f884f7f28247c8144d7b268240a2e4398", "author": {"user": {"login": "wuchong", "name": "Jark Wu"}}, "url": "https://github.com/apache/flink/commit/4d72be5f884f7f28247c8144d7b268240a2e4398", "committedDate": "2020-05-28T02:26:44Z", "message": "[FLINK-17689][kafka][table] Add integration tests for changelog source and formats\n\nThis closes #12284"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4705, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}