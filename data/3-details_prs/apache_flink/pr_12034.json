{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1MTU3MDc0", "number": 12034, "title": "[FLINK-17568][checkpointing] Fix the issue that task may consume input data after checkpoint barrier before checkpoint is performed for unaligned checkpoint", "bodyText": "What is the purpose of the change\nFor unaligned checkpoint, task may consume data after the checkpoint barrier before performing checkpoint which lead to consumption of duplicated data and corruption of data stream.\nMore specifically, when the Netty thread notifies the checkpoint barrier for the first time and enqueue a checkpointing task in the mailbox, the task thread may still in data consumption loop and if it reads a new checkpoint barrier from another channel it will not return to the mailbox and instead it will continue to read data until a all data consumed or we have a full record, meanwhile, the data after checkpoint barrier may be read and consumed which lead to inconsistency.\nThis PR tries to fix the problem.\nBrief change log\n\nReturn to mailbox after receiving a checkpoint barrier.\n\nVerifying this change\nThis change is already covered by existing tests.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API, i.e., is any changed class annotated with @Public(Evolving): (yes / no)\nThe serializers: (yes / no / don't know)\nThe runtime per-record code paths (performance sensitive): (yes / no / don't know)\nAnything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: (yes / no / don't know)\nThe S3 file system connector: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)", "createdAt": "2020-05-08T10:08:04Z", "url": "https://github.com/apache/flink/pull/12034", "merged": true, "mergeCommit": {"oid": "880afe8916ee8e8a18ca6d781045d91dd4e94091"}, "closed": true, "closedAt": "2020-05-09T11:09:42Z", "author": {"login": "wsry"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfPDxlABqjMzMTY0MDI2Mjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfix0FgBqjMzMTkxNjY3MTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b08bf185ae403c77a6e3ea6af14350646240fc4c", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/b08bf185ae403c77a6e3ea6af14350646240fc4c", "committedDate": "2020-05-08T10:03:35Z", "message": "[FLINK-17568][checkpointing] Fix the issue that task may process input data after checkpoint barrier before checkpoint is performed for unaligned checkpoint"}, "afterCommit": {"oid": "6f7d51f627e181949e1311f56897a393471abd06", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/6f7d51f627e181949e1311f56897a393471abd06", "committedDate": "2020-05-08T10:09:11Z", "message": "[FLINK-17568][checkpointing] Fix the issue that task may consume input data after checkpoint barrier before checkpoint is performed for unaligned checkpoint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MTc3MTQ3", "url": "https://github.com/apache/flink/pull/12034#pullrequestreview-408177147", "createdAt": "2020-05-08T11:34:12Z", "commit": {"oid": "6f7d51f627e181949e1311f56897a393471abd06"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f7d51f627e181949e1311f56897a393471abd06", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/6f7d51f627e181949e1311f56897a393471abd06", "committedDate": "2020-05-08T10:09:11Z", "message": "[FLINK-17568][checkpointing] Fix the issue that task may consume input data after checkpoint barrier before checkpoint is performed for unaligned checkpoint"}, "afterCommit": {"oid": "a29ceddd394d563fe95f166a425380f0452ccd71", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/a29ceddd394d563fe95f166a425380f0452ccd71", "committedDate": "2020-05-08T15:49:14Z", "message": "[FLINK-17568][checkpointing] Fix the issue that task may consume input data after checkpoint barrier before checkpoint is performed for unaligned checkpoint"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a29ceddd394d563fe95f166a425380f0452ccd71", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/a29ceddd394d563fe95f166a425380f0452ccd71", "committedDate": "2020-05-08T15:49:14Z", "message": "[FLINK-17568][checkpointing] Fix the issue that task may consume input data after checkpoint barrier before checkpoint is performed for unaligned checkpoint"}, "afterCommit": {"oid": "74cb677171ff729c4551463c20dd17946df4021d", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/74cb677171ff729c4551463c20dd17946df4021d", "committedDate": "2020-05-09T04:06:44Z", "message": "[hotfix][tests] Remove redundant test case CheckpointBarrierAlignerTestBase#testMultiChannelSkippingCheckpoints\n\nThis closes #12034."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "74cb677171ff729c4551463c20dd17946df4021d", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/74cb677171ff729c4551463c20dd17946df4021d", "committedDate": "2020-05-09T04:06:44Z", "message": "[hotfix][tests] Remove redundant test case CheckpointBarrierAlignerTestBase#testMultiChannelSkippingCheckpoints\n\nThis closes #12034."}, "afterCommit": {"oid": "f00114189cdddaa5a46148738e55d85854df97ab", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/f00114189cdddaa5a46148738e55d85854df97ab", "committedDate": "2020-05-09T04:25:19Z", "message": "[hotfix][tests] Remove redundant test case CheckpointBarrierAlignerTestBase#testMultiChannelSkippingCheckpoints\n\nThis closes #12034."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjI3NDIw", "url": "https://github.com/apache/flink/pull/12034#pullrequestreview-408627420", "createdAt": "2020-05-09T08:29:11Z", "commit": {"oid": "096059e3754e1d202025ea2b3f4475b75d06d34b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwODoyOToxMVrOGS5e3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwODoyOToxMVrOGS5e3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2OTM0MQ==", "bodyText": "nit: add an explanation comment:\nInputGate on CheckpointBarrier can enqueue a mailbox action to execute and StreamTaskNetworkInput must\nallow this action to execute before processing a following record.", "url": "https://github.com/apache/flink/pull/12034#discussion_r422469341", "createdAt": "2020-05-09T08:29:11Z", "author": {"login": "pnowojski"}, "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/StreamTaskNetworkInputTest.java", "diffHunk": "@@ -74,29 +77,31 @@ public void tearDown() throws Exception {\n \n \t@Test\n \tpublic void testIsAvailableWithBufferedDataInDeserializer() throws Exception {\n-\t\tBufferBuilder bufferBuilder = BufferBuilderTestUtils.createEmptyBufferBuilder(PAGE_SIZE);\n-\t\tBufferConsumer bufferConsumer = bufferBuilder.createBufferConsumer();\n-\n-\t\tserializeRecord(42L, bufferBuilder);\n-\t\tserializeRecord(44L, bufferBuilder);\n-\n-\t\tList<BufferOrEvent> buffers = Collections.singletonList(new BufferOrEvent(bufferConsumer.build(), 0, false));\n+\t\tList<BufferOrEvent> buffers = Collections.singletonList(createDataBuffer());\n \n \t\tVerifyRecordsDataOutput output = new VerifyRecordsDataOutput<>();\n-\t\tStreamTaskNetworkInput input = new StreamTaskNetworkInput<>(\n-\t\t\tnew CheckpointedInputGate(\n-\t\t\t\tnew MockInputGate(1, buffers, false),\n-\t\t\t\tnew CheckpointBarrierTracker(1, new DummyCheckpointInvokable())),\n-\t\t\tLongSerializer.INSTANCE,\n-\t\t\tioManager,\n-\t\t\tnew StatusWatermarkValve(1, output),\n-\t\t\t0);\n+\t\tStreamTaskNetworkInput input = createStreamTaskNetworkInput(buffers, output);\n \n \t\tassertHasNextElement(input, output);\n \t\tassertHasNextElement(input, output);\n \t\tassertEquals(2, output.getNumberOfEmittedRecords());\n \t}\n \n+\t@Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "096059e3754e1d202025ea2b3f4475b75d06d34b"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36549732ffe9b53fcdab28404170dd1f8c026072", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/36549732ffe9b53fcdab28404170dd1f8c026072", "committedDate": "2020-05-09T08:57:22Z", "message": "[FLINK-17568][checkpointing] Fix the issue that task may consume input data after checkpoint barrier before checkpoint is performed for unaligned checkpoint\n\nFor unaligned checkpoint, task may consume data after the checkpoint barrier before performing checkpoint which leads to consumption of duplicated data and corruption of data stream. More specifically, when the Netty thread notifies the checkpoint barrier for the first time and enqueues a checkpointing task in the mailbox, the task thread may still in data processing loop and if it reads a new checkpoint barrier from a input channel it will not return to the mailbox and instead it will continue to read data until all data is consumed or we have a full record, meanwhile, the data after checkpoint barrier may be read and consumed which lead to inconsistency.\n\nThis commit fixes the problem by returning to mailbox each time a checkpoint barrier is processed by the task thread."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ad10f85ecce3a1421b6543ea9a030dad542b011", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/4ad10f85ecce3a1421b6543ea9a030dad542b011", "committedDate": "2020-05-09T09:08:05Z", "message": "[hotfix][tests] Remove redundant test case CheckpointBarrierAlignerTestBase#testMultiChannelSkippingCheckpoints\n\nThis closes #12034."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f00114189cdddaa5a46148738e55d85854df97ab", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/f00114189cdddaa5a46148738e55d85854df97ab", "committedDate": "2020-05-09T04:25:19Z", "message": "[hotfix][tests] Remove redundant test case CheckpointBarrierAlignerTestBase#testMultiChannelSkippingCheckpoints\n\nThis closes #12034."}, "afterCommit": {"oid": "4ad10f85ecce3a1421b6543ea9a030dad542b011", "author": {"user": {"login": "wsry", "name": "caoyingjie"}}, "url": "https://github.com/apache/flink/commit/4ad10f85ecce3a1421b6543ea9a030dad542b011", "committedDate": "2020-05-09T09:08:05Z", "message": "[hotfix][tests] Remove redundant test case CheckpointBarrierAlignerTestBase#testMultiChannelSkippingCheckpoints\n\nThis closes #12034."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4184, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}