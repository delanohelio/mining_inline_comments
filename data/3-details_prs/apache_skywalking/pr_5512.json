{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4NjU1NTgz", "number": 5512, "title": "Support mongo driver 4.x version.", "bodyText": "Please answer these questions before submitting a pull request\n\n\nWhy submit this pull request?\n\n\n Bug fix\n\n\n New feature provided\n\n\n Improve performance\n\n\nRelated issues\n\n\n\nBug fix\n\n\nBug description.\n\n\nHow to fix?\n\n\n\nNew feature or improvement\n\nDescribe the details and related test reports.", "createdAt": "2020-09-17T13:07:41Z", "url": "https://github.com/apache/skywalking/pull/5512", "merged": true, "mergeCommit": {"oid": "1ff25ac4f4b67d869c1fb1b2ddb30a192b325fbb"}, "closed": true, "closedAt": "2020-09-22T09:09:25Z", "author": {"login": "harvies"}, "timelineItems": {"totalCount": 36, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJK-oigH2gAyNDg4NjU1NTgzOmNmNmRlMjBmM2Q0YmI2MjBiNDY5YTRmYmJmNWEzMGE5MDk1YzhlYjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLUS04AFqTQ5MzI2NDIxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cf6de20f3d4bb620b469a4fbbf5a30a9095c8eb6", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/cf6de20f3d4bb620b469a4fbbf5a30a9095c8eb6", "committedDate": "2020-09-15T17:10:01Z", "message": "Complete basic adaptation work."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95021843671502c96ed91d5b2a45c631d54b61d2", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/95021843671502c96ed91d5b2a45c631d54b61d2", "committedDate": "2020-09-17T11:51:37Z", "message": "Complete basic adaptation work."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "798a205151e152560e360e808bae4148ff30fc35", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/798a205151e152560e360e808bae4148ff30fc35", "committedDate": "2020-09-17T12:38:46Z", "message": "Complete basic adaptation work."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1a17559b3e23be76c2fe8e443563e2bb3d795bd", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/e1a17559b3e23be76c2fe8e443563e2bb3d795bd", "committedDate": "2020-09-17T12:51:22Z", "message": "Complete basic adaptation work."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1e9134b24f6d5d7811ffb331bfb110f942a0735", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/a1e9134b24f6d5d7811ffb331bfb110f942a0735", "committedDate": "2020-09-17T12:51:48Z", "message": "Complete basic adaptation work."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8ab1989c8a782083df3763596ecb44f184eb49a", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/b8ab1989c8a782083df3763596ecb44f184eb49a", "committedDate": "2020-09-17T13:02:21Z", "message": "Complete basic adaptation work."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb7034950bc2eec87e8b44a082ed5c41c6f492b9", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/cb7034950bc2eec87e8b44a082ed5c41c6f492b9", "committedDate": "2020-09-17T13:09:05Z", "message": "Merge branch 'master' into mongodb4.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2f06557d65d5161df215a5f65a659caaa27b8ba", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/b2f06557d65d5161df215a5f65a659caaa27b8ba", "committedDate": "2020-09-17T13:11:38Z", "message": "Complete basic adaptation work."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b9cdca3dc5a29e6ad16382d77f59d4dddfc3193", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/1b9cdca3dc5a29e6ad16382d77f59d4dddfc3193", "committedDate": "2020-09-17T13:11:59Z", "message": "Merge remote-tracking branch 'origin/mongodb4.x' into mongodb4.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c01cde6a6318b8e1eab1d4128e0d809aba33269a", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/c01cde6a6318b8e1eab1d4128e0d809aba33269a", "committedDate": "2020-09-17T13:19:27Z", "message": "Complete basic adaptation work."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "396ce3199ecad9fa9d2993bf4412321fbbdfb7bb", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/396ce3199ecad9fa9d2993bf4412321fbbdfb7bb", "committedDate": "2020-09-17T13:37:10Z", "message": "Complete basic adaptation work."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df65a8390a2b89f7b192473272c59f1b79356897", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/df65a8390a2b89f7b192473272c59f1b79356897", "committedDate": "2020-09-17T13:52:58Z", "message": "fix ci"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a0ad6be7a01190d9fa33f0740b4d23fa2637232", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/3a0ad6be7a01190d9fa33f0740b4d23fa2637232", "committedDate": "2020-09-17T13:53:07Z", "message": "fix ci"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e375c29e2879ef80f0a8dae550ca58ac938fbdb3", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/e375c29e2879ef80f0a8dae550ca58ac938fbdb3", "committedDate": "2020-09-17T13:54:04Z", "message": "fix ci"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb41408c95a843bf2dabaa1c64fc8904dc8f42ba", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/cb41408c95a843bf2dabaa1c64fc8904dc8f42ba", "committedDate": "2020-09-18T01:01:25Z", "message": "Merge branch 'master' into mongodb4.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4", "committedDate": "2020-09-18T07:19:22Z", "message": "Merge branch 'master' into mongodb4.x"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMzI0NjMw", "url": "https://github.com/apache/skywalking/pull/5512#pullrequestreview-491324630", "createdAt": "2020-09-18T10:02:09Z", "commit": {"oid": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMDowMjowOVrOHUGgzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMDoxMDoyMlrOHUGwpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MDI2OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * same whit org.apache.skywalking.apm.plugin.mongodb.v3.define.v38.MongoDBOperationExecutorInstrumentation\n          \n          \n            \n             * same with org.apache.skywalking.apm.plugin.mongodb.v3.define.v38.MongoDBOperationExecutorInstrumentation", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490840268", "createdAt": "2020-09-18T10:02:09Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/define/MongoDBOperationExecutorInstrumentation.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mongodb.v4.define;\n+\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import net.bytebuddy.matcher.ElementMatchers;\n+import org.apache.skywalking.apm.agent.core.plugin.bytebuddy.ArgumentTypeNameMatch;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.ConstructorInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.InstanceMethodsInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.ClassInstanceMethodsEnhancePluginDefine;\n+import org.apache.skywalking.apm.agent.core.plugin.match.ClassMatch;\n+import org.apache.skywalking.apm.agent.core.plugin.match.NameMatch;\n+\n+/**\n+ * same whit org.apache.skywalking.apm.plugin.mongodb.v3.define.v38.MongoDBOperationExecutorInstrumentation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MDk4MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // pass remotePeer to OperationExecutor, which will be wrapper as EnhancedInstance\n          \n          \n            \n                        // pass remotePeer to OperationExecutor, which has be enhanced as EnhancedInstance", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490840981", "createdAt": "2020-09-18T10:03:40Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/interceptor/MongoDBClientDelegateInterceptor.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mongodb.v4.interceptor;\n+\n+import com.mongodb.internal.connection.Cluster;\n+import org.apache.skywalking.apm.agent.core.logging.api.ILog;\n+import org.apache.skywalking.apm.agent.core.logging.api.LogManager;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceConstructorInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceMethodsAroundInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+import org.apache.skywalking.apm.plugin.mongodb.v4.support.MongoRemotePeerHelper;\n+\n+import java.lang.reflect.Method;\n+\n+public class MongoDBClientDelegateInterceptor implements InstanceConstructorInterceptor, InstanceMethodsAroundInterceptor {\n+\n+    private static final ILog LOGGER = LogManager.getLogger(MongoDBClientDelegateInterceptor.class);\n+\n+    @Override\n+    public void onConstruct(EnhancedInstance objInst, Object[] allArguments) {\n+        Cluster cluster = (Cluster) allArguments[0];\n+        String remotePeer = MongoRemotePeerHelper.getRemotePeer(cluster);\n+        objInst.setSkyWalkingDynamicField(remotePeer);\n+    }\n+\n+    @Override\n+    public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes,\n+        MethodInterceptResult result) {\n+        // do nothing\n+    }\n+\n+    @Override\n+    public Object afterMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes,\n+        Object ret) {\n+        if (ret instanceof EnhancedInstance) {\n+            // pass remotePeer to OperationExecutor, which will be wrapper as EnhancedInstance", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MTE4OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // @see: org.apache.skywalking.apm.plugin.mongodb.v3.define.v37.MongoDBOperationExecutorInstrumentation\n          \n          \n            \n                        // See: org.apache.skywalking.apm.plugin.mongodb.v3.define.v37.MongoDBOperationExecutorInstrumentation", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490841188", "createdAt": "2020-09-18T10:04:05Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/interceptor/MongoDBClientDelegateInterceptor.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mongodb.v4.interceptor;\n+\n+import com.mongodb.internal.connection.Cluster;\n+import org.apache.skywalking.apm.agent.core.logging.api.ILog;\n+import org.apache.skywalking.apm.agent.core.logging.api.LogManager;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceConstructorInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceMethodsAroundInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+import org.apache.skywalking.apm.plugin.mongodb.v4.support.MongoRemotePeerHelper;\n+\n+import java.lang.reflect.Method;\n+\n+public class MongoDBClientDelegateInterceptor implements InstanceConstructorInterceptor, InstanceMethodsAroundInterceptor {\n+\n+    private static final ILog LOGGER = LogManager.getLogger(MongoDBClientDelegateInterceptor.class);\n+\n+    @Override\n+    public void onConstruct(EnhancedInstance objInst, Object[] allArguments) {\n+        Cluster cluster = (Cluster) allArguments[0];\n+        String remotePeer = MongoRemotePeerHelper.getRemotePeer(cluster);\n+        objInst.setSkyWalkingDynamicField(remotePeer);\n+    }\n+\n+    @Override\n+    public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes,\n+        MethodInterceptResult result) {\n+        // do nothing\n+    }\n+\n+    @Override\n+    public Object afterMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes,\n+        Object ret) {\n+        if (ret instanceof EnhancedInstance) {\n+            // pass remotePeer to OperationExecutor, which will be wrapper as EnhancedInstance\n+            // @see: org.apache.skywalking.apm.plugin.mongodb.v3.define.v37.MongoDBOperationExecutorInstrumentation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MTU4MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // @see: MongoDBClientDelegateInterceptor.afterMethod\n          \n          \n            \n                    // See: MongoDBClientDelegateInterceptor.afterMethod", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490841580", "createdAt": "2020-09-18T10:04:52Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/interceptor/MongoDBOperationExecutorInterceptor.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mongodb.v4.interceptor;\n+\n+import org.apache.skywalking.apm.agent.core.context.ContextManager;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.apache.skywalking.apm.agent.core.logging.api.ILog;\n+import org.apache.skywalking.apm.agent.core.logging.api.LogManager;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceMethodsAroundInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+import org.apache.skywalking.apm.plugin.mongodb.v4.support.MongoSpanHelper;\n+\n+import java.lang.reflect.Method;\n+\n+@SuppressWarnings(\"Duplicates\")\n+public class MongoDBOperationExecutorInterceptor implements InstanceMethodsAroundInterceptor {\n+\n+    private static final ILog LOGGER = LogManager.getLogger(MongoDBOperationExecutorInterceptor.class);\n+\n+    @Override\n+    public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes,\n+        MethodInterceptResult result) {\n+        String executeMethod = allArguments[0].getClass().getSimpleName();\n+        // OperationExecutor has be mark it's remotePeer\n+        // @see: MongoDBClientDelegateInterceptor.afterMethod", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MTk3Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // OperationExecutor has be mark it's remotePeer\n          \n          \n            \n                    // OperationExecutor has included th remotePeer", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490841973", "createdAt": "2020-09-18T10:05:30Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/interceptor/MongoDBOperationExecutorInterceptor.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mongodb.v4.interceptor;\n+\n+import org.apache.skywalking.apm.agent.core.context.ContextManager;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.apache.skywalking.apm.agent.core.logging.api.ILog;\n+import org.apache.skywalking.apm.agent.core.logging.api.LogManager;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceMethodsAroundInterceptor;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult;\n+import org.apache.skywalking.apm.plugin.mongodb.v4.support.MongoSpanHelper;\n+\n+import java.lang.reflect.Method;\n+\n+@SuppressWarnings(\"Duplicates\")\n+public class MongoDBOperationExecutorInterceptor implements InstanceMethodsAroundInterceptor {\n+\n+    private static final ILog LOGGER = LogManager.getLogger(MongoDBOperationExecutorInterceptor.class);\n+\n+    @Override\n+    public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes,\n+        MethodInterceptResult result) {\n+        String executeMethod = allArguments[0].getClass().getSimpleName();\n+        // OperationExecutor has be mark it's remotePeer", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MjQxMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * OperationExecutor which is unified entrance of execute mongo command. we can mark OperationExecutor which connection\n          \n          \n            \n             * OperationExecutor which is unified entrance of execute mongo command. Inject the remotePeer into enhanced OperationExecutor.", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490842413", "createdAt": "2020-09-18T10:06:25Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/define/MongoDBClientDelegateInstrumentation.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mongodb.v4.define;\n+\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.ConstructorInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.InstanceMethodsInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.ClassInstanceMethodsEnhancePluginDefine;\n+import org.apache.skywalking.apm.agent.core.plugin.match.ClassMatch;\n+import org.apache.skywalking.apm.plugin.mongodb.v4.interceptor.MongoDBClientDelegateInterceptor;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static org.apache.skywalking.apm.agent.core.plugin.bytebuddy.ArgumentTypeNameMatch.takesArgumentWithType;\n+import static org.apache.skywalking.apm.agent.core.plugin.match.NameMatch.byName;\n+\n+/**\n+ * Enhance {@code com.mongodb.client.internal.MongoClientDelegate} instance, and intercept {@code\n+ * com.mongodb.client.internal.MongoClientDelegate#getOperationExecutor()}, this is the only way to get\n+ * OperationExecutor which is unified entrance of execute mongo command. we can mark OperationExecutor which connection", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MjU3NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * belongs to.", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490842575", "createdAt": "2020-09-18T10:06:43Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/define/MongoDBClientDelegateInstrumentation.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mongodb.v4.define;\n+\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.ConstructorInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.InstanceMethodsInterceptPoint;\n+import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.ClassInstanceMethodsEnhancePluginDefine;\n+import org.apache.skywalking.apm.agent.core.plugin.match.ClassMatch;\n+import org.apache.skywalking.apm.plugin.mongodb.v4.interceptor.MongoDBClientDelegateInterceptor;\n+\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static org.apache.skywalking.apm.agent.core.plugin.bytebuddy.ArgumentTypeNameMatch.takesArgumentWithType;\n+import static org.apache.skywalking.apm.agent.core.plugin.match.NameMatch.byName;\n+\n+/**\n+ * Enhance {@code com.mongodb.client.internal.MongoClientDelegate} instance, and intercept {@code\n+ * com.mongodb.client.internal.MongoClientDelegate#getOperationExecutor()}, this is the only way to get\n+ * OperationExecutor which is unified entrance of execute mongo command. we can mark OperationExecutor which connection\n+ * belongs to.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MzkwNA==", "bodyText": "Is this provided in the 3.x too? With the same config name?", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490843904", "createdAt": "2020-09-18T10:09:31Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/support/MongoPluginConfig.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.plugin.mongodb.v4.support;\n+\n+import org.apache.skywalking.apm.agent.core.boot.PluginConfig;\n+\n+public class MongoPluginConfig {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0NDMyNw==", "bodyText": "Please activate the parameter collection for testing. And the expected data should be updated too.", "url": "https://github.com/apache/skywalking/pull/5512#discussion_r490844327", "createdAt": "2020-09-18T10:10:22Z", "author": {"login": "wu-sheng"}, "path": "test/plugin/scenarios/mongodb-4.x-scenario/bin/startup.sh", "diffHunk": "@@ -0,0 +1,21 @@\n+#!/bin/bash\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+home=\"$(cd \"$(dirname $0)\"; pwd)\"\n+\n+java -jar ${agent_opts} ${home}/../libs/mongodb-4.x-scenario.jar &", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b5ffca93f7f6aa7bf6e1eeb00ebbb039ce439e4"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02784c29ef6b9a3c0c9bb972812711878910655c", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/02784c29ef6b9a3c0c9bb972812711878910655c", "committedDate": "2020-09-18T10:23:30Z", "message": "Update apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/define/MongoDBOperationExecutorInstrumentation.java\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07a4a622b1ce6249a36cb4868ea1a93e2143161a", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/07a4a622b1ce6249a36cb4868ea1a93e2143161a", "committedDate": "2020-09-18T10:25:04Z", "message": "Update apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/interceptor/MongoDBClientDelegateInterceptor.java\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4c96f088d3ae4593dad6379f1147590c8d42a37", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/a4c96f088d3ae4593dad6379f1147590c8d42a37", "committedDate": "2020-09-18T10:26:18Z", "message": "Update apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/interceptor/MongoDBOperationExecutorInterceptor.java\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dd0ab53bf95c1530b7188191151599869b9a9be", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/0dd0ab53bf95c1530b7188191151599869b9a9be", "committedDate": "2020-09-18T10:27:00Z", "message": "Update apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/interceptor/MongoDBClientDelegateInterceptor.java\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bcb45052357d148cbaf92977b14e6d3283e97e9", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/3bcb45052357d148cbaf92977b14e6d3283e97e9", "committedDate": "2020-09-18T10:28:15Z", "message": "Update apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/interceptor/MongoDBOperationExecutorInterceptor.java\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2316e687a5727002805ccb4f105d2f17c641874e", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/2316e687a5727002805ccb4f105d2f17c641874e", "committedDate": "2020-09-18T10:31:10Z", "message": "Update apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/define/MongoDBClientDelegateInstrumentation.java\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bc350999bb2d84ea339b81e34642734fc8b6c45", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/8bc350999bb2d84ea339b81e34642734fc8b6c45", "committedDate": "2020-09-18T10:37:31Z", "message": "Update apm-sniffer/apm-sdk-plugin/mongodb-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/mongodb/v4/define/MongoDBClientDelegateInstrumentation.java\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddbbbc3ba6defbfa68bb60ad5448af1cba7ac956", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/ddbbbc3ba6defbfa68bb60ad5448af1cba7ac956", "committedDate": "2020-09-18T10:45:04Z", "message": "Modified as suggested."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a33af8c4f7d4e2aba3480b49e018b5677bc9c23f", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/a33af8c4f7d4e2aba3480b49e018b5677bc9c23f", "committedDate": "2020-09-18T10:45:35Z", "message": "Merge remote-tracking branch 'origin/mongodb4.x' into mongodb4.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8babd53d410432ab7988c3c6bdf7307158049e30", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/8babd53d410432ab7988c3c6bdf7307158049e30", "committedDate": "2020-09-18T15:49:24Z", "message": "Merge branch 'master' into mongodb4.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f12fc74ffff2e65ecd6fd7d882796b337f2b165c", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/f12fc74ffff2e65ecd6fd7d882796b337f2b165c", "committedDate": "2020-09-19T07:40:08Z", "message": "add test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6b27862c1b39867c40bd8d064fc5a07de4c2553", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/f6b27862c1b39867c40bd8d064fc5a07de4c2553", "committedDate": "2020-09-19T07:40:45Z", "message": "Merge remote-tracking branch 'remotes/upstream/master' into mongodb4.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f99390df036c43dd580fa0800ea17842533d14a2", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/f99390df036c43dd580fa0800ea17842533d14a2", "committedDate": "2020-09-19T07:41:25Z", "message": "Merge branch 'mongodb4.x' of github.com:harvies/skywalking into mongodb4.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ea0c92d8f2e1f3d2cc19d01eca5000a3df9bcc7", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/6ea0c92d8f2e1f3d2cc19d01eca5000a3df9bcc7", "committedDate": "2020-09-21T10:39:27Z", "message": "Merge remote-tracking branch 'remotes/upstream/master' into mongodb4.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "717b1da696f11fa931b2fd77414d030d7680bddf", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/717b1da696f11fa931b2fd77414d030d7680bddf", "committedDate": "2020-09-21T13:09:03Z", "message": "replace DB_STATEMENT to DB_BIND_VARIABLES & remove executeMethod prefix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78e87c436414165ac7503fd0b3f8006045fc9fdc", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/78e87c436414165ac7503fd0b3f8006045fc9fdc", "committedDate": "2020-09-22T02:05:42Z", "message": "Merge remote-tracking branch 'remotes/upstream/master' into mongodb4.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc012e700ea45af8cdee6fbb5865d299c920a18a", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/fc012e700ea45af8cdee6fbb5865d299c920a18a", "committedDate": "2020-09-22T03:14:02Z", "message": "mongodb 4.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4793e282633be922f9e35d0e6c66676360a41ab2", "author": {"user": {"login": "harvies", "name": "harvies"}}, "url": "https://github.com/apache/skywalking/commit/4793e282633be922f9e35d0e6c66676360a41ab2", "committedDate": "2020-09-22T04:19:17Z", "message": "fix ci"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMjY0MjEy", "url": "https://github.com/apache/skywalking/pull/5512#pullrequestreview-493264212", "createdAt": "2020-09-22T09:09:04Z", "commit": {"oid": "4793e282633be922f9e35d0e6c66676360a41ab2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1692, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}