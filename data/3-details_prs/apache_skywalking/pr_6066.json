{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0NzkxMjc5", "number": 6066, "title": "Improvement Influxdb query performance", "bodyText": "If this pull request closes/resolves/fixes an existing issue, replace the issue number. Closes #6059.\n Update the CHANGES log.", "createdAt": "2020-12-23T13:27:12Z", "url": "https://github.com/apache/skywalking/pull/6066", "merged": true, "mergeCommit": {"oid": "6e48dca99a5910e311169c2e91354ec55ddc4300"}, "closed": true, "closedAt": "2020-12-30T11:54:34Z", "author": {"login": "dmsolr"}, "timelineItems": {"totalCount": 41, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdo_AySgH2gAyNTQ0NzkxMjc5OjMwZTNjMDdmYWE0OWRjM2U4NGI5Y2FmODFkZTVkYmY1YzdlOWM4N2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdrMP6MgFqTU1OTk3OTUxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "30e3c07faa49dc3e84b9caf81de5dbf5c7e9c87b", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/30e3c07faa49dc3e84b9caf81de5dbf5c7e9c87b", "committedDate": "2020-12-23T13:19:05Z", "message": "Improvement `MetricsDAO#get` performance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38685726120c8571a6c2327bb37e288b0d397998", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/38685726120c8571a6c2327bb37e288b0d397998", "committedDate": "2020-12-23T13:21:57Z", "message": "replace name to \"name\" in query statement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae020c06c8a695442c168555ca54b24e536b3474", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/ae020c06c8a695442c168555ca54b24e536b3474", "committedDate": "2020-12-23T14:00:36Z", "message": "fix *_traffic table don't include time_bucket"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5c205eb17afe5702607b4c87a2427395354d82e", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/b5c205eb17afe5702607b4c87a2427395354d82e", "committedDate": "2020-12-24T17:34:49Z", "message": "query optimization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b62d71fce18a5c9c2f91b47c27ce5ff69cd8f2c", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/0b62d71fce18a5c9c2f91b47c27ce5ff69cd8f2c", "committedDate": "2020-12-25T00:33:24Z", "message": "Merge branch 'master' into influxdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd12547f984dbe0d1b00a96a9cacbce74a3d31f2", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/fd12547f984dbe0d1b00a96a9cacbce74a3d31f2", "committedDate": "2020-12-25T05:20:18Z", "message": "Merge branch 'influxdb' of https://github.com/dmsolr/skywalking into influxdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39f8d7d4a4274426725e0bead0617c75f607365d", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/39f8d7d4a4274426725e0bead0617c75f607365d", "committedDate": "2020-12-25T05:20:47Z", "message": "update CHANGES.md"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4Nzc1MDc3", "url": "https://github.com/apache/skywalking/pull/6066#pullrequestreview-558775077", "createdAt": "2020-12-25T07:32:51Z", "commit": {"oid": "39f8d7d4a4274426725e0bead0617c75f607365d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQwNzozMjo1MVrOILZiNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQwNzozMjo1MVrOILZiNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODgyMzYwNQ==", "bodyText": "Are you sure about this? ES7 client needs recompiling.", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548823605", "createdAt": "2020-12-25T07:32:51Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-elasticsearch7-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch7/dao/MetricsEs7DAO.java", "diffHunk": "@@ -20,30 +20,12 @@\n \n import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n-import org.apache.skywalking.oap.server.core.storage.model.Model;\n import org.apache.skywalking.oap.server.library.client.elasticsearch.ElasticSearchClient;\n import org.apache.skywalking.oap.server.storage.plugin.elasticsearch.base.MetricsEsDAO;\n-import org.elasticsearch.action.search.SearchResponse;\n-\n-import java.io.IOException;\n-import java.util.ArrayList;\n-import java.util.List;\n \n public class MetricsEs7DAO extends MetricsEsDAO {\n \n     MetricsEs7DAO(final ElasticSearchClient client, final StorageBuilder<Metrics> storageBuilder) {\n         super(client, storageBuilder);\n     }\n-\n-    @Override\n-    public List<Metrics> multiGet(Model model, List<String> ids) throws IOException {\n-        SearchResponse response = getClient().ids(model.getName(), ids.toArray(new String[0]));\n-\n-        List<Metrics> result = new ArrayList<>(response.getHits().getHits().length);\n-        for (int i = 0; i < response.getHits().getHits().length; i++) {\n-            Metrics source = storageBuilder.map2Data(response.getHits().getAt(i).getSourceAsMap());\n-            result.add(source);\n-        }\n-        return result;\n-    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39f8d7d4a4274426725e0bead0617c75f607365d"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea0f3ef6bc198a2285303c92f78698b86843eda1", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/ea0f3ef6bc198a2285303c92f78698b86843eda1", "committedDate": "2020-12-25T08:32:34Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46a5c98e660d17e71e6bb2b1571618fcb11134a1", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/46a5c98e660d17e71e6bb2b1571618fcb11134a1", "committedDate": "2020-12-25T13:59:54Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97d8fbe4e8c817d60ffdf83d45c8b033b1fe3118", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/97d8fbe4e8c817d60ffdf83d45c8b033b1fe3118", "committedDate": "2020-12-25T15:23:29Z", "message": "revert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94281dbdee992aa39b8accdbb1f513726853937b", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/94281dbdee992aa39b8accdbb1f513726853937b", "committedDate": "2020-12-25T16:25:14Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/2d646ee98142584d6dcc50f8e3bd146b7f4be6ff", "committedDate": "2020-12-25T18:57:51Z", "message": "_name is keyword in influxdb, which means the table name."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODQyODkz", "url": "https://github.com/apache/skywalking/pull/6066#pullrequestreview-558842893", "createdAt": "2020-12-26T01:40:17Z", "commit": {"oid": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwMTo0MDoxN1rOILgDrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwMTo0MDoxN1rOILgDrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzMDQ3Nw==", "bodyText": "Don't format the unchanged codes", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548930477", "createdAt": "2020-12-26T01:40:17Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsPersistentWorker.java", "diffHunk": "@@ -91,11 +92,12 @@\n         this.dataCarrier.consume(ConsumerPoolFactory.INSTANCE.get(name), new PersistentConsumer());\n \n         MetricsCreator metricsCreator = moduleDefineHolder.find(TelemetryModule.NAME)\n-                .provider()\n-                .getService(MetricsCreator.class);\n+                                                          .provider()\n+                                                          .getService(MetricsCreator.class);\n         aggregationCounter = metricsCreator.createCounter(\n-                \"metrics_aggregation\", \"The number of rows in aggregation\",\n-                new MetricsTag.Keys(\"metricName\", \"level\", \"dimensionality\"), new MetricsTag.Values(model.getName(), \"2\", model.getDownsampling().getName())\n+            \"metrics_aggregation\", \"The number of rows in aggregation\",\n+            new MetricsTag.Keys(\"metricName\", \"level\", \"dimensionality\"),\n+            new MetricsTag.Values(model.getName(), \"2\", model.getDownsampling().getName())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODQyOTI3", "url": "https://github.com/apache/skywalking/pull/6066#pullrequestreview-558842927", "createdAt": "2020-12-26T01:41:58Z", "commit": {"oid": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwMTo0MTo1OFrOILgD-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwMTo0MTo1OFrOILgD-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzMDU1NQ==", "bodyText": "final Stream<Metrics> metricsStream = metrics.stream().filter(m -> !context.containsKey(m));\nI think this stream is better choice for metricsDAO#multiGet, WDYT?", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548930555", "createdAt": "2020-12-26T01:41:58Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsPersistentWorker.java", "diffHunk": "@@ -209,15 +211,11 @@ private void loadFromStorage(List<Metrics> metrics) throws IOException {\n             context.clear();\n         }\n \n-        List<String> notInCacheIds = new ArrayList<>();\n-        for (Metrics metric : metrics) {\n-            if (!context.containsKey(metric)) {\n-                notInCacheIds.add(metric.id());\n-            }\n-        }\n-\n-        if (notInCacheIds.size() > 0) {\n-            List<Metrics> metricsList = metricsDAO.multiGet(model, notInCacheIds);\n+        List<Metrics> notInCacheMetrics = metrics.stream()\n+                                                 .filter(m -> !context.containsKey(m))\n+                                                 .collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODQ0NDk2", "url": "https://github.com/apache/skywalking/pull/6066#pullrequestreview-558844496", "createdAt": "2020-12-26T02:52:02Z", "commit": {"oid": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwMjo1MjowMlrOILgVxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwMjo1MjowMlrOILgVxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzNTExMA==", "bodyText": "This should not be committed, the directory name (/var/run/influxdb2) is OS-dependent.", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548935110", "createdAt": "2020-12-26T02:52:02Z", "author": {"login": "kezhenxu94"}, "path": "test/e2e/e2e-test/docker/storage/docker-compose.influxdb.yml", "diffHunk": "@@ -22,6 +22,8 @@ services:\n       - 8086\n     networks:\n       - e2e\n+    volumes:\n+      - /var/run/influxdb2:/var/lib/influxdb", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODQ0NTQ2", "url": "https://github.com/apache/skywalking/pull/6066#pullrequestreview-558844546", "createdAt": "2020-12-26T02:54:33Z", "commit": {"oid": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwMjo1NDozM1rOILgWfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwMjo1NDozM1rOILgWfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzNTI5NQ==", "bodyText": "You added a Traffic interface, I thinks this part should be refactored by leveraging that interface?", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548935295", "createdAt": "2020-12-26T02:54:33Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/TableMetaInfo.java", "diffHunk": "@@ -54,7 +56,10 @@ public static void addModel(Model model) {\n             storageAndColumnMap.put(columnName.getStorageName(), columnName.getName());\n         });\n \n+        final boolean isTrafficTable;\n         if (model.getName().endsWith(\"_traffic\")) {\n+            isTrafficTable = true;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODQ1Mjkw", "url": "https://github.com/apache/skywalking/pull/6066#pullrequestreview-558845290", "createdAt": "2020-12-26T03:28:08Z", "commit": {"oid": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwMzoyODowOFrOILgfUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwMzoyODowOFrOILgfUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzNzU1NA==", "bodyText": "We have StorageData#id already.", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548937554", "createdAt": "2020-12-26T03:28:08Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/Traffic.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.analysis;\n+\n+public interface Traffic {\n+\n+    String id();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODQ1Mzgy", "url": "https://github.com/apache/skywalking/pull/6066#pullrequestreview-558845382", "createdAt": "2020-12-26T03:29:39Z", "commit": {"oid": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwMzoyOTozOVrOILgfxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwMzoyOTozOVrOILgfxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkzNzY2OA==", "bodyText": "Model has the getName. I can't see the point of Traffic interface.", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548937668", "createdAt": "2020-12-26T03:29:39Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/Traffic.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.analysis;\n+\n+public interface Traffic {\n+\n+    String id();\n+\n+    String getName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d646ee98142584d6dcc50f8e3bd146b7f4be6ff"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3057925149d1996995f41b3fb86951a481db3579", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/3057925149d1996995f41b3fb86951a481db3579", "committedDate": "2020-12-26T04:17:29Z", "message": "adjust IMetricsDAO#multiGet signature"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53cb1d981916687657f8f5781b260eab987cfb7f", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/53cb1d981916687657f8f5781b260eab987cfb7f", "committedDate": "2020-12-26T05:08:07Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28c6145f06d3e7a791bc339195052ae022f5033e", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/28c6145f06d3e7a791bc339195052ae022f5033e", "committedDate": "2020-12-26T06:36:49Z", "message": "fix following reviewers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODU0ODMy", "url": "https://github.com/apache/skywalking/pull/6066#pullrequestreview-558854832", "createdAt": "2020-12-26T09:23:02Z", "commit": {"oid": "28c6145f06d3e7a791bc339195052ae022f5033e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwOToyMzowMlrOILiDnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwOToyMzowMlrOILiDnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2MzIyOA==", "bodyText": "I have a feeling, stream#count === a whole loop. Could you confirm?", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548963228", "createdAt": "2020-12-26T09:23:02Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsPersistentWorker.java", "diffHunk": "@@ -209,18 +211,9 @@ private void loadFromStorage(List<Metrics> metrics) throws IOException {\n             context.clear();\n         }\n \n-        List<String> notInCacheIds = new ArrayList<>();\n-        for (Metrics metric : metrics) {\n-            if (!context.containsKey(metric)) {\n-                notInCacheIds.add(metric.id());\n-            }\n-        }\n-\n-        if (notInCacheIds.size() > 0) {\n-            List<Metrics> metricsList = metricsDAO.multiGet(model, notInCacheIds);\n-            for (Metrics metric : metricsList) {\n-                context.put(metric, metric);\n-            }\n+        Stream<Metrics> stream = metrics.stream().filter(m -> !context.containsKey(m));\n+        if (stream.count() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28c6145f06d3e7a791bc339195052ae022f5033e"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODU0OTMy", "url": "https://github.com/apache/skywalking/pull/6066#pullrequestreview-558854932", "createdAt": "2020-12-26T09:26:10Z", "commit": {"oid": "28c6145f06d3e7a791bc339195052ae022f5033e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwOToyNjoxMFrOILiEtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwOToyNjoxMFrOILiEtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2MzUxMA==", "bodyText": "If you says this implementing Traffic#name, the name is exactly the id(as nodeType related to name logically). What is the point of doing this?", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548963510", "createdAt": "2020-12-26T09:26:10Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/manual/endpoint/EndpointTraffic.java", "diffHunk": "@@ -39,7 +40,7 @@\n     builder = EndpointTraffic.Builder.class, processor = MetricsStreamProcessor.class)\n @MetricsExtension(supportDownSampling = false, supportUpdate = false)\n @EqualsAndHashCode\n-public class EndpointTraffic extends Metrics {\n+public class EndpointTraffic extends Metrics implements Traffic {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28c6145f06d3e7a791bc339195052ae022f5033e"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42ce9dda96d4472575946479bdb92fb91780c9fe", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/42ce9dda96d4472575946479bdb92fb91780c9fe", "committedDate": "2020-12-26T09:47:18Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODYwNTAx", "url": "https://github.com/apache/skywalking/pull/6066#pullrequestreview-558860501", "createdAt": "2020-12-26T12:10:27Z", "commit": {"oid": "42ce9dda96d4472575946479bdb92fb91780c9fe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQxMjoxMDoyN1rOILi4EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQxMjoxMDoyN1rOILi4EA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk3NjY1Ng==", "bodyText": "Look like the codes back to double loops?", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r548976656", "createdAt": "2020-12-26T12:10:27Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/worker/MetricsPersistentWorker.java", "diffHunk": "@@ -209,18 +211,11 @@ private void loadFromStorage(List<Metrics> metrics) throws IOException {\n             context.clear();\n         }\n \n-        List<String> notInCacheIds = new ArrayList<>();\n-        for (Metrics metric : metrics) {\n-            if (!context.containsKey(metric)) {\n-                notInCacheIds.add(metric.id());\n-            }\n-        }\n-\n-        if (notInCacheIds.size() > 0) {\n-            List<Metrics> metricsList = metricsDAO.multiGet(model, notInCacheIds);\n-            for (Metrics metric : metricsList) {\n-                context.put(metric, metric);\n-            }\n+        List<Metrics> noInCacheMetrics = metrics.stream()\n+                                                .filter(m -> !context.containsKey(m))\n+                                                .collect(Collectors.toList());\n+        if (!noInCacheMetrics.isEmpty()) {\n+            metricsDAO.multiGet(model, noInCacheMetrics).forEach(m -> context.put(m, m));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42ce9dda96d4472575946479bdb92fb91780c9fe"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65e1a78293a3a49b73cc8220c66a9eac7ef77943", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/65e1a78293a3a49b73cc8220c66a9eac7ef77943", "committedDate": "2020-12-28T11:56:06Z", "message": "refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MTQ3NzEw", "url": "https://github.com/apache/skywalking/pull/6066#pullrequestreview-559147710", "createdAt": "2020-12-28T13:36:48Z", "commit": {"oid": "65e1a78293a3a49b73cc8220c66a9eac7ef77943"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMzozNjo0OFrOIL5s2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMzozNjo0OFrOIL5s2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTM1MDYxOA==", "bodyText": "Don't like this, but seems don't have much better idea. Adding an interface seems not vey helpful. cc @kezhenxu94", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r549350618", "createdAt": "2020-12-28T13:36:48Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/MetricsDAO.java", "diffHunk": "@@ -57,11 +62,47 @@ public MetricsDAO(InfluxClient client, StorageBuilder<Metrics> storageBuilder) {\n     }\n \n     @Override\n-    public List<Metrics> multiGet(Model model, List<String> ids) throws IOException {\n-        final WhereQueryImpl<SelectQueryImpl> query = select()\n-            .raw(ALL_FIELDS)\n-            .from(client.getDatabase(), model.getName())\n-            .where(contains(\"id\", Joiner.on(\"|\").join(ids)));\n+    public List<Metrics> multiGet(Model model, List<Metrics> metrics) throws IOException {\n+        final TableMetaInfo metaInfo = TableMetaInfo.get(model.getName());\n+        final String queryStr;\n+        if (model.getName().endsWith(\"_traffic\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65e1a78293a3a49b73cc8220c66a9eac7ef77943"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MTQ4MDk3", "url": "https://github.com/apache/skywalking/pull/6066#pullrequestreview-559148097", "createdAt": "2020-12-28T13:37:56Z", "commit": {"oid": "65e1a78293a3a49b73cc8220c66a9eac7ef77943"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "809cbaff4674a1266e66214a492db79bbf10499d", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/809cbaff4674a1266e66214a492db79bbf10499d", "committedDate": "2020-12-28T13:38:08Z", "message": "Merge branch 'master' into influxdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78869515edfa89e11791ca80ea2335ef0bf47d15", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/78869515edfa89e11791ca80ea2335ef0bf47d15", "committedDate": "2020-12-29T02:34:52Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bba9f3463f6a26f2be3893181b2e369a903a430", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/2bba9f3463f6a26f2be3893181b2e369a903a430", "committedDate": "2020-12-29T03:10:40Z", "message": "Merge branch 'influxdb' of https://github.com/dmsolr/skywalking into influxdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1def2ad7b84e614264eaf7832dde2690b64c0e83", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/1def2ad7b84e614264eaf7832dde2690b64c0e83", "committedDate": "2020-12-29T06:16:28Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01959c30dd9722328f00e72dc8234123062f341e", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/01959c30dd9722328f00e72dc8234123062f341e", "committedDate": "2020-12-30T01:57:46Z", "message": "Merge branch 'master' into influxdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1411fd598f7f340bb41cec65dff7a570ff23f4e4", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/1411fd598f7f340bb41cec65dff7a570ff23f4e4", "committedDate": "2020-12-30T02:23:47Z", "message": "test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7547d316b85ebe243733d41a663a96ad458a49b3", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/7547d316b85ebe243733d41a663a96ad458a49b3", "committedDate": "2020-12-30T02:23:59Z", "message": "Merge branch 'influxdb' of https://github.com/dmsolr/skywalking into influxdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5e16104788908ae9a41c18c1996be4b6f99723b", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/e5e16104788908ae9a41c18c1996be4b6f99723b", "committedDate": "2020-12-30T03:20:29Z", "message": "test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a03d225910f5826cda110b73e592ecbfb6275608", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/a03d225910f5826cda110b73e592ecbfb6275608", "committedDate": "2020-12-30T06:19:55Z", "message": "test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5ODk5MjEx", "url": "https://github.com/apache/skywalking/pull/6066#pullrequestreview-559899211", "createdAt": "2020-12-30T06:25:17Z", "commit": {"oid": "a03d225910f5826cda110b73e592ecbfb6275608"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQwNjoyNToxOFrOIMeMoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQwNjoyNToxOFrOIMeMoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTk0ODU3Ng==", "bodyText": "InstanceTraffic#Name is a big data set, are you sure you need this as a tag?", "url": "https://github.com/apache/skywalking/pull/6066#discussion_r549948576", "createdAt": "2020-12-30T06:25:18Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/TableMetaInfo.java", "diffHunk": "@@ -54,15 +54,25 @@ public static void addModel(Model model) {\n             storageAndColumnMap.put(columnName.getStorageName(), columnName.getName());\n         });\n \n+        storageAndTagMap.put(InstanceTraffic.NAME, InfluxConstants.TagName.NAME);\n         if (model.getName().endsWith(\"_traffic\")) {\n-            // instance_traffic service_id, endpoint_traffic service_id\n-            if (InstanceTraffic.INDEX_NAME.equals(model.getName())\n-                || EndpointTraffic.INDEX_NAME.equals(model.getName())) {\n-                storageAndTagMap.put(EndpointTraffic.SERVICE_ID, InfluxConstants.TagName.SERVICE_ID);\n-            } else {\n+            switch (model.getName()) {\n+                // instance_traffic name, service_id\n+                case InstanceTraffic.INDEX_NAME: {\n+                    storageAndTagMap.put(InstanceTraffic.NAME, InfluxConstants.TagName.NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a03d225910f5826cda110b73e592ecbfb6275608"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce3b14967d6c3caf34ff7dbe17209ccda06e7e43", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/ce3b14967d6c3caf34ff7dbe17209ccda06e7e43", "committedDate": "2020-12-30T07:24:38Z", "message": "Merge branch 'master' into influxdb"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5OTc5NTEy", "url": "https://github.com/apache/skywalking/pull/6066#pullrequestreview-559979512", "createdAt": "2020-12-30T09:52:13Z", "commit": {"oid": "ce3b14967d6c3caf34ff7dbe17209ccda06e7e43"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1510, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}