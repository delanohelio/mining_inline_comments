{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2NTU1OTA0", "number": 4493, "title": "Support Secrets Management File in the ElasticSearch 6/7 storage", "bodyText": "Secrets Management File Of ElasticSearch Username and Password\nThe value of secretsManagementFile should point to the secrets management file absolute path.\nThe file includes username and password of ElasticSearch server in the properties format.\nuser=xxx\npassword=yyy\nThe major difference between using user/password configs in the application.yaml and this file is, this file is being watched by the OAP server.\nOnce it is changed manually or through 3rd party tool, such as Vault,\nthe storage provider will use the new username and password to establish the connection and close the old one. If the information exist in the file,\nthe user/password will be overrided.", "createdAt": "2020-03-11T08:47:34Z", "url": "https://github.com/apache/skywalking/pull/4493", "merged": true, "mergeCommit": {"oid": "e69391a207175d7c22f9b326f0f18e5cdf28bd43"}, "closed": true, "closedAt": "2020-03-13T12:50:15Z", "author": {"login": "wu-sheng"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMgiAogH2gAyMzg2NTU1OTA0OjE1NzE0OTMxNzg3MWE3M2U4NzZlYTUwNDQ1Zjc3Y2I0YjdjMzdhNTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNPIaqAFqTM3NDI0NzQ2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "157149317871a73e876ea50445f77cb4b7c37a56", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/157149317871a73e876ea50445f77cb4b7c37a56", "committedDate": "2020-03-11T05:47:17Z", "message": "Temp commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8127f8c8748d977e4a9714b537a43850190f47b", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/b8127f8c8748d977e4a9714b537a43850190f47b", "committedDate": "2020-03-11T08:43:20Z", "message": "Support secretsManagementFile file."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5ba4a6a313751ea6a3858eb2a33334e2e365709", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/e5ba4a6a313751ea6a3858eb2a33334e2e365709", "committedDate": "2020-03-11T08:49:45Z", "message": "Update doc."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2806553017a8a3607a4e35a15c75ba9b3a547596", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/2806553017a8a3607a4e35a15c75ba9b3a547596", "committedDate": "2020-03-11T09:35:43Z", "message": "Merge branch 'master' into vault-support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNjM4NzM1", "url": "https://github.com/apache/skywalking/pull/4493#pullrequestreview-372638735", "createdAt": "2020-03-11T10:33:17Z", "commit": {"oid": "2806553017a8a3607a4e35a15c75ba9b3a547596"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMDozMzoxN1rOF0xSHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMDozMzoxN1rOF0xSHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg3NzcyNw==", "bodyText": "Make elasticSearchClient volatile?", "url": "https://github.com/apache/skywalking/pull/4493#discussion_r390877727", "createdAt": "2020-03-11T10:33:17Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/StorageModuleElasticsearchProvider.java", "diffHunk": "@@ -117,6 +120,31 @@ public void prepare() throws ServiceNotProvidedException {\n         if (config.getDayStep() > 1) {\n             TimeSeriesUtils.setDAY_STEP(config.getDayStep());\n         }\n+\n+        if (!StringUtil.isEmpty(config.getSecretsManagementFile())) {\n+            MultipleFilesChangeMonitor monitor = new MultipleFilesChangeMonitor(\n+                10, readableContents -> {\n+                    final byte[] secretsFileContent = readableContents.get(0);\n+                    if (secretsFileContent == null) {\n+                        return;\n+                    }\n+                    Properties userAndPass = new Properties();\n+                    userAndPass.load(new ByteArrayInputStream(secretsFileContent));\n+                    config.setUser(userAndPass.getProperty(\"user\"));\n+                    config.setPassword(userAndPass.getProperty(\"password\"));\n+\n+                    if (elasticSearchClient == null) {\n+                        //In the startup process, we just need to change the username/password", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2806553017a8a3607a4e35a15c75ba9b3a547596"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d840b3384923907bfd145ee316e4a0e7c9191beb", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/d840b3384923907bfd145ee316e4a0e7c9191beb", "committedDate": "2020-03-11T11:25:04Z", "message": "Merge branch 'master' into vault-support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNzQyOTg3", "url": "https://github.com/apache/skywalking/pull/4493#pullrequestreview-372742987", "createdAt": "2020-03-11T13:13:00Z", "commit": {"oid": "d840b3384923907bfd145ee316e4a0e7c9191beb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMzoxMzowMFrOF02QGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMzoxMzowMFrOF02QGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk1OTEzMA==", "bodyText": "Same thread visibility problem for client, if the monitor thread failed to detect the client is initialized below(in line 129), the client is not closed and left open forever", "url": "https://github.com/apache/skywalking/pull/4493#discussion_r390959130", "createdAt": "2020-03-11T13:13:00Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-library/library-client/src/main/java/org/apache/skywalking/oap/server/library/client/elasticsearch/ElasticSearchClient.java", "diffHunk": "@@ -119,6 +119,13 @@ public ElasticSearchClient(String clusterNodes,\n     @Override\n     public void connect() throws IOException, KeyStoreException, NoSuchAlgorithmException, KeyManagementException, CertificateException {\n         List<HttpHost> hosts = parseClusterNodes(protocol, clusterNodes);\n+        if (client != null) {\n+            try {\n+                client.close();\n+            } catch (Throwable t) {\n+                log.error(\"ElasticSearch client reconnection fails based on new config\", t);\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d840b3384923907bfd145ee316e4a0e7c9191beb"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "160d845cc26c9625f6639c9616e8ed005d13495d", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/160d845cc26c9625f6639c9616e8ed005d13495d", "committedDate": "2020-03-11T13:41:33Z", "message": "1. Support JKS/pass runtime change too.\n2. Follow review."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20f756bd01ce36ef5035c98323c57d20b424eb58", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/20f756bd01ce36ef5035c98323c57d20b424eb58", "committedDate": "2020-03-11T13:47:16Z", "message": "Fix format."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66a69eadb8f9b1ebfc7913404471c304dcbd0a56", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/66a69eadb8f9b1ebfc7913404471c304dcbd0a56", "committedDate": "2020-03-12T00:49:18Z", "message": "Fix username/password/trustPass haven't been updated in the es client."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b08bf83e6002b16e6008d87b6b76ec07e0653d2e", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/b08bf83e6002b16e6008d87b6b76ec07e0653d2e", "committedDate": "2020-03-12T02:33:34Z", "message": "Merge branch 'master' into vault-support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MTE4Mjg2", "url": "https://github.com/apache/skywalking/pull/4493#pullrequestreview-374118286", "createdAt": "2020-03-13T08:26:29Z", "commit": {"oid": "b08bf83e6002b16e6008d87b6b76ec07e0653d2e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwODoyNjoyOVrOF17GPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwODoyNjoyOVrOF17GPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA4NzEwMg==", "bodyText": "typo duplicated with this file is?", "url": "https://github.com/apache/skywalking/pull/4493#discussion_r392087102", "createdAt": "2020-03-13T08:26:29Z", "author": {"login": "JaredTan95"}, "path": "docs/en/setup/backend/backend-storage.md", "diffHunk": "@@ -124,6 +126,20 @@ Such as, if dayStep == 11,\n \n NOTICE, TTL deletion would be affected by these. You should set an extra more dayStep in your TTL. Such as you want to TTL == 30 days and dayStep == 10, you actually need to set TTL = 40;\n \n+### Secrets Management File Of ElasticSearch Authentication\n+The value of `secretsManagementFile` should point to the secrets management file absolute path. \n+The file includes username, password and JKS password of ElasticSearch server in the properties format.\n+```properties\n+user=xxx\n+password=yyy\n+trustStorePass=zzz\n+```\n+\n+The major difference between using `user, password, trustStorePass` configs in the `application.yaml` and this file is, this file is being watched by the OAP server. ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b08bf83e6002b16e6008d87b6b76ec07e0653d2e"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e5b173af83d341dd72201fcff32167faf8036a1", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/1e5b173af83d341dd72201fcff32167faf8036a1", "committedDate": "2020-03-13T08:28:21Z", "message": "Merge branch 'master' into vault-support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cac4e51f7f122965c622777ffc5275b3f04ac2d", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/5cac4e51f7f122965c622777ffc5275b3f04ac2d", "committedDate": "2020-03-13T08:57:57Z", "message": "Fix doc issue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7b500a7a9caea2f7bc82503117db3714f622b97", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/f7b500a7a9caea2f7bc82503117db3714f622b97", "committedDate": "2020-03-13T12:04:41Z", "message": "Merge branch 'master' into vault-support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MjQ3NDYy", "url": "https://github.com/apache/skywalking/pull/4493#pullrequestreview-374247462", "createdAt": "2020-03-13T12:04:52Z", "commit": {"oid": "5cac4e51f7f122965c622777ffc5275b3f04ac2d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2441, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}