{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMjY5NTI2", "number": 4322, "title": "provide profiled segment list query", "bodyText": "Please answer these questions before submitting pull request\n\n\nWhy submit this pull request?\n\n\n Bug fix\n\n\n New feature provided\n\n\n Improve performance\n\n\nRelated issues\n#4104\n\n\nNew feature or improvement\n\nprovide GraphQL query: query profiled segment list\nfix dumping thread snapshot error: ProfileTaskExecutionContext#isStartProfileable\nrename snapshot record index name", "createdAt": "2020-02-05T09:34:28Z", "url": "https://github.com/apache/skywalking/pull/4322", "merged": true, "mergeCommit": {"oid": "e44bc36281cc0c79f263906464c62698bbf5959d"}, "closed": true, "closedAt": "2020-02-06T13:02:09Z", "author": {"login": "mrproliu"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBSuDaAH2gAyMzcxMjY5NTI2OmQwNTIwZmFkZTg3MTRmZmRjYzdlNzZjMTQ0ODU0ZDA3NTZiN2UwODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBqUvAAFqTM1NDQyOTEzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d0520fade8714ffdcc7e76c144854d0756b7e085", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/d0520fade8714ffdcc7e76c144854d0756b7e085", "committedDate": "2020-02-05T09:28:36Z", "message": "provide profiled segment query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0fb5b3c2977fbdf1d3790757795ec6d6649ab2a", "author": {"user": {"login": "mrproliu", "name": null}}, "url": "https://github.com/apache/skywalking/commit/d0fb5b3c2977fbdf1d3790757795ec6d6649ab2a", "committedDate": "2020-02-05T09:34:37Z", "message": "Merge branch 'master' into profile_query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f290673e72724501095e550ed004646402e3b484", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/f290673e72724501095e550ed004646402e3b484", "committedDate": "2020-02-05T12:36:44Z", "message": "Merge branch 'master' into profile_query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNjgzMjg3", "url": "https://github.com/apache/skywalking/pull/4322#pullrequestreview-353683287", "createdAt": "2020-02-05T12:38:35Z", "commit": {"oid": "f290673e72724501095e550ed004646402e3b484"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMjozODozNVrOFl2SLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMjo1OToyOVrOFl21kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzMTAyMA==", "bodyText": "As using incrementAndGet, <= should be <?", "url": "https://github.com/apache/skywalking/pull/4322#discussion_r375231020", "createdAt": "2020-02-05T12:38:35Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileTaskExecutionContext.java", "diffHunk": "@@ -150,7 +150,7 @@ public ProfileTask getTask() {\n \n     public boolean isStartProfileable() {\n         // check is out of max sampling count check\n-        return totalStartedProfilingCount.incrementAndGet() > task.getMaxSamplingCount();\n+        return totalStartedProfilingCount.incrementAndGet() <= task.getMaxSamplingCount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f290673e72724501095e550ed004646402e3b484"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzMzkzMA==", "bodyText": "Refer to the specific commit id, such as https://github.com/apache/skywalking/tree/421ba88dbfba48cdc5845547381aa4763775b4b1/docs/...\nBecause we don't know whether the doc exists in the master branch.", "url": "https://github.com/apache/skywalking/pull/4322#discussion_r375233930", "createdAt": "2020-02-05T12:45:22Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/profile/analyze/ProfileAnalyzer.java", "diffHunk": "@@ -28,7 +28,7 @@\n /**\n  * Analyze {@link ProfileStack} data to {@link ProfileAnalyzation}\n  *\n- * See: https://github.com/apache/skywalking/blob/docs/en/guides/backend-profile.md#thread-analyst\n+ * See:  https://github.com/apache/skywalking/blob/master/docs/en/guides/backend-profile.md#thread-analyst", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f290673e72724501095e550ed004646402e3b484"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzNjk3MA==", "bodyText": "I think it is better to use queryProfiledSegments(String taskId) to replace this method and IProfileThreadSnapshotQueryDAO interface. There seems meaningless to add a new interface.", "url": "https://github.com/apache/skywalking/pull/4322#discussion_r375236970", "createdAt": "2020-02-05T12:52:33Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/storage/query/ITraceQueryDAO.java", "diffHunk": "@@ -42,4 +42,12 @@ TraceBrief queryBasicTraces(long startSecondTB, long endSecondTB, long minDurati\n      * @throws IOException\n      */\n     List<Span> doFlexibleTraceQuery(String traceId) throws IOException;\n+\n+    /**\n+     * query trace basic info list from appoint segments\n+     * @param segmentIdList\n+     * @return\n+     * @throws IOException\n+     */\n+    List<BasicTrace> queryBySegmentIdList(List<String> segmentIdList) throws IOException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f290673e72724501095e550ed004646402e3b484"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI0MDA4MQ==", "bodyText": "return value should be clear, it represents the segments having profile snapshot data.", "url": "https://github.com/apache/skywalking/pull/4322#discussion_r375240081", "createdAt": "2020-02-05T12:59:29Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/storage/query/ITraceQueryDAO.java", "diffHunk": "@@ -42,4 +42,12 @@ TraceBrief queryBasicTraces(long startSecondTB, long endSecondTB, long minDurati\n      * @throws IOException\n      */\n     List<Span> doFlexibleTraceQuery(String traceId) throws IOException;\n+\n+    /**\n+     * query trace basic info list from appoint segments\n+     * @param segmentIdList\n+     * @return", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f290673e72724501095e550ed004646402e3b484"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b9cfe4cca0e6250f40dcc0ca0a789c231a3c298", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/4b9cfe4cca0e6250f40dcc0ca0a789c231a3c298", "committedDate": "2020-02-05T13:15:39Z", "message": "change doc reference"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d87571c59afaa4f0a8f32513070d84df9071f062", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/d87571c59afaa4f0a8f32513070d84df9071f062", "committedDate": "2020-02-05T13:50:36Z", "message": "combine query profiled segment to single method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "563ff6fe52f6cbbfbe875b673fb11aa016eeb338", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/563ff6fe52f6cbbfbe875b673fb11aa016eeb338", "committedDate": "2020-02-05T14:54:50Z", "message": "fix query error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db2809d2873ed24519485107bc980b6af9c67e20", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/db2809d2873ed24519485107bc980b6af9c67e20", "committedDate": "2020-02-05T15:21:45Z", "message": "remove trace dao reference"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b18fb1a36cbecaeab9340216d4dd41ee955200a7", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/b18fb1a36cbecaeab9340216d4dd41ee955200a7", "committedDate": "2020-02-06T01:29:13Z", "message": "add empty oal script to profile e2e test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MTg1NDA5", "url": "https://github.com/apache/skywalking/pull/4322#pullrequestreview-354185409", "createdAt": "2020-02-06T03:44:29Z", "commit": {"oid": "b18fb1a36cbecaeab9340216d4dd41ee955200a7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwMzo0NDoyOVrOFmOfaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwMzo0Njo0MlrOFmOhDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYyNzYyNw==", "bodyText": "What is the difference? Please remove the useless one.", "url": "https://github.com/apache/skywalking/pull/4322#discussion_r375627627", "createdAt": "2020-02-06T03:44:29Z", "author": {"login": "wu-sheng"}, "path": "test/e2e/e2e-profile/e2e-profile-test-runner/src/test/java/org/apache/skywalking/e2e/ProfileVerificationITCase.java", "diffHunk": "@@ -78,8 +75,8 @@ public void setUp() {\n         //        final String swWebappPort = System.getProperty(\"sw.webapp.port\", \"32783\");\n         final String swWebappPort = System.getProperty(\"sw.webapp.port\", \"12800\");\n         final String instrumentedServiceHost = System.getProperty(\"service.host\", \"127.0.0.1\");\n-        final String instrumentedServicePort = System.getProperty(\"service.port\", \"32782\");\n-        //        final String instrumentedServicePort = System.getProperty(\"service.port\", \"9090\");\n+//        final String instrumentedServicePort = System.getProperty(\"service.port\", \"32782\");\n+        final String instrumentedServicePort = System.getProperty(\"service.port\", \"9090\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b18fb1a36cbecaeab9340216d4dd41ee955200a7"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYyODA0NA==", "bodyText": "You should still send traffic and verify service/instance/endpoint, just no metrics of service/instance/endpoint. If no traffic, then there is no trace to be profiled.", "url": "https://github.com/apache/skywalking/pull/4322#discussion_r375628044", "createdAt": "2020-02-06T03:46:42Z", "author": {"login": "wu-sheng"}, "path": "test/e2e/e2e-profile/e2e-profile-test-runner/src/test/java/org/apache/skywalking/e2e/ProfileVerificationITCase.java", "diffHunk": "@@ -89,28 +86,6 @@ public void setUp() {\n     public void verify() throws Exception {\n         final LocalDateTime minutesAgo = LocalDateTime.now(ZoneOffset.UTC);\n \n-        while (true) {\n-            try {\n-                final ResponseEntity<String> responseEntity = sendRequest(false);\n-                LOGGER.info(\"responseEntity: {}\", responseEntity);\n-                assertThat(responseEntity.getStatusCode()).isEqualTo(HttpStatus.OK);\n-                final List<Trace> traces = profileClient.traces(\n-                        new TracesQuery()\n-                                .start(minutesAgo)\n-                                .end(LocalDateTime.now())\n-                                .orderByDuration()\n-                );\n-                if (!traces.isEmpty()) {\n-                    break;\n-                }\n-                Thread.sleep(10000L);\n-            } catch (Exception ignored) {\n-            }\n-        }\n-\n-        // verify basic info\n-        verifyServices(minutesAgo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b18fb1a36cbecaeab9340216d4dd41ee955200a7"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc617998b9352ca5c4155b9e150fdf4c51853591", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/fc617998b9352ca5c4155b9e150fdf4c51853591", "committedDate": "2020-02-06T04:32:48Z", "message": "recover verify services"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82a43fad7c7d89735db26572b9fd858b563ed08e", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/82a43fad7c7d89735db26572b9fd858b563ed08e", "committedDate": "2020-02-06T07:56:45Z", "message": "fix doc error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MjY5ODQz", "url": "https://github.com/apache/skywalking/pull/4322#pullrequestreview-354269843", "createdAt": "2020-02-06T08:30:35Z", "commit": {"oid": "82a43fad7c7d89735db26572b9fd858b563ed08e"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3f31d29a35f5f99757290702ec8ae053b633438", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/c3f31d29a35f5f99757290702ec8ae053b633438", "committedDate": "2020-02-06T09:28:53Z", "message": "Merge branch 'master' into profile_query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73eda494b13b284d8c4f6bace2661c1a03b702dd", "author": {"user": {"login": "AirTrioa", "name": null}}, "url": "https://github.com/apache/skywalking/commit/73eda494b13b284d8c4f6bace2661c1a03b702dd", "committedDate": "2020-02-06T10:07:01Z", "message": "fix missing provider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b556f8e94029c0dc15fb8c2026370f2ed4bea30a", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/b556f8e94029c0dc15fb8c2026370f2ed4bea30a", "committedDate": "2020-02-06T11:38:41Z", "message": "fix e2e test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NDI5MTM4", "url": "https://github.com/apache/skywalking/pull/4322#pullrequestreview-354429138", "createdAt": "2020-02-06T12:58:40Z", "commit": {"oid": "b556f8e94029c0dc15fb8c2026370f2ed4bea30a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2644, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}