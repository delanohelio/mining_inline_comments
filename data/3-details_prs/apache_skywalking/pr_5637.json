{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNDgwNjc5", "number": 5637, "title": "Health check for InfluxDB", "bodyText": "Please answer these questions before submitting a pull request\n\n\nWhy submit this pull request?\n\n\n Bug fix\n\n\n New feature provided\n\n\n Improve performance\n\n\nRelated issues\n\n\n\nBug fix\n\n\nBug description.\n\n\nHow to fix?\n\n\n\nNew feature or improvement\n\nDescribe the details and related test reports.\nAdd health check for influxdb , related #5633", "createdAt": "2020-10-09T09:58:42Z", "url": "https://github.com/apache/skywalking/pull/5637", "merged": true, "mergeCommit": {"oid": "d86570a88ebe5079898647b74168ab91a9be4a6a"}, "closed": true, "closedAt": "2020-10-13T08:59:43Z", "author": {"login": "xbkaishui"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQzCqAgH2gAyNTAwNDgwNjc5OmEyNGZlOGMxN2QxOWUwMjM2YzVkZGZkYzVlOTJmM2M0ZDkxOGJlNDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSEfj_AFqTUwNzIwMjE3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a24fe8c17d19e0236c5ddfdc5e92f3c4d918be45", "author": {"user": {"login": "xbkaishui", "name": null}}, "url": "https://github.com/apache/skywalking/commit/a24fe8c17d19e0236c5ddfdc5e92f3c4d918be45", "committedDate": "2020-10-09T09:48:05Z", "message": "Add InfluxDB health check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e55b75c472169938663c16055f8f93af2635476", "author": {"user": {"login": "xbkaishui", "name": null}}, "url": "https://github.com/apache/skywalking/commit/6e55b75c472169938663c16055f8f93af2635476", "committedDate": "2020-10-09T09:56:02Z", "message": "remove unusable code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dfce9d3a4e3c4bbfc0a6583fcf209805806553f", "author": {"user": {"login": "xbkaishui", "name": null}}, "url": "https://github.com/apache/skywalking/commit/7dfce9d3a4e3c4bbfc0a6583fcf209805806553f", "committedDate": "2020-10-09T10:15:52Z", "message": "Fix checkstyle issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20", "author": {"user": {"login": "xbkaishui", "name": null}}, "url": "https://github.com/apache/skywalking/commit/29502c550077ee33def24ecfaf2ad38471a1cd20", "committedDate": "2020-10-09T10:27:36Z", "message": "Merge branch 'master' into health-check-influxdb"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NzY1OTg2", "url": "https://github.com/apache/skywalking/pull/5637#pullrequestreview-505765986", "createdAt": "2020-10-09T15:12:46Z", "commit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNToxMjo0NlrOHfOIAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNToxMjo0NlrOHfOIAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ5OTMyOA==", "bodyText": "Grammar related exceptions seem unhealth to me. @hanahmily What do you think?", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502499328", "createdAt": "2020-10-09T15:12:46Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -205,4 +230,20 @@ public static TimeInterval timeIntervalTS(long timestamp) {\n     public static TimeInterval timeIntervalTB(long timeBucket) {\n         return ti(TimeBucket.getTimestamp(timeBucket), \"ms\");\n     }\n+\n+    @Override\n+    public void registerChecker(HealthChecker healthChecker) {\n+        this.healthChecker.register(healthChecker);\n+    }\n+\n+    /**\n+     * Check influx health, Ignore grammar related exception\n+     */\n+    private void checkHealth(Throwable e) {\n+        if (e instanceof InfluxDBIOException) {\n+            healthChecker.unHealth(e);\n+        } else if (!(e instanceof InfluxDBException)) {\n+            healthChecker.unHealth(e);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 166}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1Nzc1NTcx", "url": "https://github.com/apache/skywalking/pull/5637#pullrequestreview-505775571", "createdAt": "2020-10-09T15:24:15Z", "commit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNToyNDoxNVrOHfOkKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNToyNzo0NVrOHfOtIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg==", "bodyText": "The test of result.hasError is dropped. Maybe some errors are ignored. Pls double check whether it leaves out them.", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502506536", "createdAt": "2020-10-09T15:24:15Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjg0OA==", "bodyText": "Ditto", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502506848", "createdAt": "2020-10-09T15:24:47Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -161,11 +172,7 @@ public int getCounter(Query query) throws IOException {\n      */\n     public void dropSeries(String measurement, long timeBucket) throws IOException {\n         Query query = new Query(\"DROP SERIES FROM \" + measurement + \" WHERE time_bucket='\" + timeBucket + \"'\");\n-        QueryResult result = getInflux().query(query);\n-\n-        if (result.hasError()) {\n-            throw new IOException(\"Statement: \" + query.getCommand() + \", ErrorMsg: \" + result.getError());\n-        }\n+        this.query(query);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwODgzNQ==", "bodyText": "Why do you ignore grammar relevant errors? They would indicate the version mismatches between OAP and influxdb server.", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502508835", "createdAt": "2020-10-09T15:27:45Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -205,4 +230,20 @@ public static TimeInterval timeIntervalTS(long timestamp) {\n     public static TimeInterval timeIntervalTB(long timeBucket) {\n         return ti(TimeBucket.getTimestamp(timeBucket), \"ms\");\n     }\n+\n+    @Override\n+    public void registerChecker(HealthChecker healthChecker) {\n+        this.healthChecker.register(healthChecker);\n+    }\n+\n+    /**\n+     * Check influx health, Ignore grammar related exception", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 159}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b41cac5800d61e0f369a03c769ec49aa9bf50483", "author": {"user": {"login": "xbkaishui", "name": null}}, "url": "https://github.com/apache/skywalking/commit/b41cac5800d61e0f369a03c769ec49aa9bf50483", "committedDate": "2020-10-10T04:22:08Z", "message": "Remove check grammar of client exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ece3f3e414c393145583cb7abb6d36348bb84a2a", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/ece3f3e414c393145583cb7abb6d36348bb84a2a", "committedDate": "2020-10-10T08:49:06Z", "message": "Merge branch 'master' into health-check-influxdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9a0c7326703ed262492d8ea0d14beec344d777b", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/b9a0c7326703ed262492d8ea0d14beec344d777b", "committedDate": "2020-10-11T09:47:11Z", "message": "Merge branch 'master' into health-check-influxdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "964a1718acf4308683f34f8c391e5d4ad24e3708", "author": {"user": {"login": "xbkaishui", "name": null}}, "url": "https://github.com/apache/skywalking/commit/964a1718acf4308683f34f8c391e5d4ad24e3708", "committedDate": "2020-10-13T00:22:00Z", "message": "Revert change, add error check for query result"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35e35780733a6d1fe7cec26a292952151bdebcbd", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/35e35780733a6d1fe7cec26a292952151bdebcbd", "committedDate": "2020-10-13T04:03:49Z", "message": "Merge branch 'master' into health-check-influxdb"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MDkxODM2", "url": "https://github.com/apache/skywalking/pull/5637#pullrequestreview-507091836", "createdAt": "2020-10-13T06:02:57Z", "commit": {"oid": "35e35780733a6d1fe7cec26a292952151bdebcbd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MjAyMTcy", "url": "https://github.com/apache/skywalking/pull/5637#pullrequestreview-507202172", "createdAt": "2020-10-13T08:41:58Z", "commit": {"oid": "35e35780733a6d1fe7cec26a292952151bdebcbd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1809, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}