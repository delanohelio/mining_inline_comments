{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwMTYzNDkz", "number": 5109, "title": "Fix issue 4965", "bodyText": "Please answer these questions before submitting pull request\n\n\nWhy submit this pull request?\n\n\n Bug fix\n\n\n New feature provided\n\n\n Improve performance\n\n\nRelated issues\n#4965\n\n\n\nBug fix\n\nBug description.\nWhen invoking prepareCall, it will determine procedures's parameter types by execute sql. StatementEnhanceInfos is set after prepareCall, so StatementEnhanceInfos is null in PreparedStatementExecuteMethodsInterceptor.beforeMethod, the NPE was happen.\nHow to fix?\nI suggest to avoid NPE. We don't need to record sql which determine procedures's parameter.\n\n\nNew feature or improvement\n\nDescribe the details and related test reports.", "createdAt": "2020-07-16T12:39:13Z", "url": "https://github.com/apache/skywalking/pull/5109", "merged": true, "mergeCommit": {"oid": "62f76881de990917f229e5121e9094f977599da3"}, "closed": true, "closedAt": "2020-07-17T09:36:03Z", "author": {"login": "Patrick0308"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1eXljgH2gAyNDUwMTYzNDkzOjRmZDAzYjQzMTQ2OWE2MWFmMmRjNjQ3YzhmNzgyY2Q4MTI2NWVmYmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1wgTsAFqTQ1MDUxNTA1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4fd03b431469a61af2dc647c8f782cd81265efbf", "author": {"user": {"login": "Patrick0308", "name": "\u767d\u6cfd"}}, "url": "https://github.com/apache/skywalking/commit/4fd03b431469a61af2dc647c8f782cd81265efbf", "committedDate": "2020-07-16T12:26:59Z", "message": "fix issue 4986"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8647a013e2efc9e083c817bc1efa36024de9b05", "author": {"user": {"login": "Patrick0308", "name": "\u767d\u6cfd"}}, "url": "https://github.com/apache/skywalking/commit/c8647a013e2efc9e083c817bc1efa36024de9b05", "committedDate": "2020-07-16T12:49:33Z", "message": "modify mysql test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7e72d937b769f40e50ec644a210bc497f2204f9", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/e7e72d937b769f40e50ec644a210bc497f2204f9", "committedDate": "2020-07-16T13:39:09Z", "message": "Merge branch 'master' into fix-issue-4986"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMjgyMTYy", "url": "https://github.com/apache/skywalking/pull/5109#pullrequestreview-450282162", "createdAt": "2020-07-16T23:29:40Z", "commit": {"oid": "e7e72d937b769f40e50ec644a210bc497f2204f9"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQyMzoyOTo0MFrOGzAMnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQyMzozMzowNFrOGzARfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjEzMzc4OA==", "bodyText": "Don't add the issue link, unless it is a very special thing.", "url": "https://github.com/apache/skywalking/pull/5109#discussion_r456133788", "createdAt": "2020-07-16T23:29:40Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/mysql-common/src/main/java/org/apache/skywalking/apm/plugin/jdbc/mysql/PreparedStatementExecuteMethodsInterceptor.java", "diffHunk": "@@ -40,15 +40,14 @@\n     public final void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments,\n                                    Class<?>[] argumentsTypes, MethodInterceptResult result) {\n         StatementEnhanceInfos cacheObject = (StatementEnhanceInfos) objInst.getSkyWalkingDynamicField();\n-        ConnectionInfo connectInfo = cacheObject.getConnectionInfo();\n         /**\n          * For avoid NPE. In this particular case, Execute sql inside the {@link com.mysql.jdbc.ConnectionImpl} constructor,\n          * before the interceptor sets the connectionInfo.\n-         *\n+         * Fixed https://github.com/apache/skywalking/issues/4965. When invoking prepareCall, cacheObject is null. Because it will determine procedures's parameter types by querying the table of proc in mysql.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e72d937b769f40e50ec644a210bc497f2204f9"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjEzNDUxNA==", "bodyText": "About #prepareCall, why cacheObject should be null? I prefer you should fix this NPE by having the correct ConnectionInfo rather than skipping it.", "url": "https://github.com/apache/skywalking/pull/5109#discussion_r456134514", "createdAt": "2020-07-16T23:31:39Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/mysql-common/src/main/java/org/apache/skywalking/apm/plugin/jdbc/mysql/PreparedStatementExecuteMethodsInterceptor.java", "diffHunk": "@@ -40,15 +40,14 @@\n     public final void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments,\n                                    Class<?>[] argumentsTypes, MethodInterceptResult result) {\n         StatementEnhanceInfos cacheObject = (StatementEnhanceInfos) objInst.getSkyWalkingDynamicField();\n-        ConnectionInfo connectInfo = cacheObject.getConnectionInfo();\n         /**\n          * For avoid NPE. In this particular case, Execute sql inside the {@link com.mysql.jdbc.ConnectionImpl} constructor,\n          * before the interceptor sets the connectionInfo.\n-         *\n+         * Fixed https://github.com/apache/skywalking/issues/4965. When invoking prepareCall, cacheObject is null. Because it will determine procedures's parameter types by querying the table of proc in mysql.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjEzMzc4OA=="}, "originalCommit": {"oid": "e7e72d937b769f40e50ec644a210bc497f2204f9"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjEzNTAzNg==", "bodyText": "You should forward the ConnectionInfo from Connection when #prepareCall called.", "url": "https://github.com/apache/skywalking/pull/5109#discussion_r456135036", "createdAt": "2020-07-16T23:33:04Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/mysql-common/src/main/java/org/apache/skywalking/apm/plugin/jdbc/mysql/PreparedStatementExecuteMethodsInterceptor.java", "diffHunk": "@@ -40,15 +40,14 @@\n     public final void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments,\n                                    Class<?>[] argumentsTypes, MethodInterceptResult result) {\n         StatementEnhanceInfos cacheObject = (StatementEnhanceInfos) objInst.getSkyWalkingDynamicField();\n-        ConnectionInfo connectInfo = cacheObject.getConnectionInfo();\n         /**\n          * For avoid NPE. In this particular case, Execute sql inside the {@link com.mysql.jdbc.ConnectionImpl} constructor,\n          * before the interceptor sets the connectionInfo.\n-         *\n+         * Fixed https://github.com/apache/skywalking/issues/4965. When invoking prepareCall, cacheObject is null. Because it will determine procedures's parameter types by querying the table of proc in mysql.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjEzMzc4OA=="}, "originalCommit": {"oid": "e7e72d937b769f40e50ec644a210bc497f2204f9"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzMxODAx", "url": "https://github.com/apache/skywalking/pull/5109#pullrequestreview-450331801", "createdAt": "2020-07-17T02:19:27Z", "commit": {"oid": "e7e72d937b769f40e50ec644a210bc497f2204f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMjoxOToyN1rOGzDFoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMjoxOToyN1rOGzDFoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE4MTE1Mw==", "bodyText": "According to the codes here, if cacheObject.getConnectionInfo() == null), no span will be generated. My previous question is about this, why?\nAlso, on the existing codes, the check condition is different, \n  \n    \n      skywalking/apm-sniffer/apm-sdk-plugin/mysql-common/src/main/java/org/apache/skywalking/apm/plugin/jdbc/mysql/PreparedStatementExecuteMethodsInterceptor.java\n    \n    \n         Line 75\n      in\n      e7e72d9\n    \n    \n    \n    \n\n        \n          \n           if (cacheObject.getConnectionInfo() != null) { \n        \n    \n  \n\n.\nI want to make sure what is the issue of that. Because all changes in the expectedData.yml seems not related to some parts of the change.", "url": "https://github.com/apache/skywalking/pull/5109#discussion_r456181153", "createdAt": "2020-07-17T02:19:27Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/mysql-common/src/main/java/org/apache/skywalking/apm/plugin/jdbc/mysql/PreparedStatementExecuteMethodsInterceptor.java", "diffHunk": "@@ -40,15 +40,14 @@\n     public final void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments,\n                                    Class<?>[] argumentsTypes, MethodInterceptResult result) {\n         StatementEnhanceInfos cacheObject = (StatementEnhanceInfos) objInst.getSkyWalkingDynamicField();\n-        ConnectionInfo connectInfo = cacheObject.getConnectionInfo();\n         /**\n          * For avoid NPE. In this particular case, Execute sql inside the {@link com.mysql.jdbc.ConnectionImpl} constructor,\n          * before the interceptor sets the connectionInfo.\n-         *\n+         * Fixed https://github.com/apache/skywalking/issues/4965. When invoking prepareCall, cacheObject is null. Because it will determine procedures's parameter types by querying the table of proc in mysql.\n          * @see JDBCDriverInterceptor#afterMethod(EnhancedInstance, Method, Object[], Class[], Object)\n          */\n-        if (connectInfo != null) {\n-\n+        if (cacheObject != null && cacheObject.getConnectionInfo() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e72d937b769f40e50ec644a210bc497f2204f9"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a169c5dfa4192fd3910fbba3eefc736f9be68b84", "author": {"user": {"login": "Patrick0308", "name": "\u767d\u6cfd"}}, "url": "https://github.com/apache/skywalking/commit/a169c5dfa4192fd3910fbba3eefc736f9be68b84", "committedDate": "2020-07-17T03:53:28Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c4e51930f69b7b7a433ee7959d2bc91e9cf4397", "author": {"user": {"login": "Patrick0308", "name": "\u767d\u6cfd"}}, "url": "https://github.com/apache/skywalking/commit/7c4e51930f69b7b7a433ee7959d2bc91e9cf4397", "committedDate": "2020-07-17T03:53:41Z", "message": "Merge remote-tracking branch 'origin/fix-issue-4986' into fix-issue-4986"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dd23140ab227c3ff40e8ae626e9022f0c9ae47d", "author": {"user": {"login": "Patrick0308", "name": "\u767d\u6cfd"}}, "url": "https://github.com/apache/skywalking/commit/9dd23140ab227c3ff40e8ae626e9022f0c9ae47d", "committedDate": "2020-07-17T04:32:54Z", "message": "modify document"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca235c738d6587dbf186a6ae12f2e57fa2fd6b31", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/ca235c738d6587dbf186a6ae12f2e57fa2fd6b31", "committedDate": "2020-07-17T05:02:57Z", "message": "Merge branch 'master' into fix-issue-4986"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNTE1MDU3", "url": "https://github.com/apache/skywalking/pull/5109#pullrequestreview-450515057", "createdAt": "2020-07-17T09:34:48Z", "commit": {"oid": "ca235c738d6587dbf186a6ae12f2e57fa2fd6b31"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2087, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}