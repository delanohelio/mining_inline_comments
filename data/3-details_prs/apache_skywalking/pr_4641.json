{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMzc3MzA5", "number": 4641, "title": "Upgrade the InfluxDB storage-plugin to protocol V3", "bodyText": "Please answer these questions before submitting pull request\n\n\nWhy submit this pull request?\n\n\n Bug fix\n\n\n New feature provided\n\n\n Improve performance\n\n\nRelated issues\n#4599\n#4615", "createdAt": "2020-04-12T18:10:12Z", "url": "https://github.com/apache/skywalking/pull/4641", "merged": true, "mergeCommit": {"oid": "28530cd79d6d91443c0584fade1cbb79e137a8ed"}, "closed": true, "closedAt": "2020-04-19T12:11:00Z", "author": {"login": "dmsolr"}, "timelineItems": {"totalCount": 40, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXDn-RgFqTM5MTkwNzgxMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZJWsFgFqTM5NjAwOTUyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxOTA3ODEz", "url": "https://github.com/apache/skywalking/pull/4641#pullrequestreview-391907813", "createdAt": "2020-04-13T00:19:43Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0811091359e621924e2b7133a2e07579ab472e55", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/0811091359e621924e2b7133a2e07579ab472e55", "committedDate": "2020-04-14T08:49:34Z", "message": "revert @Column"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "0811091359e621924e2b7133a2e07579ab472e55", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/0811091359e621924e2b7133a2e07579ab472e55", "committedDate": "2020-04-14T08:49:34Z", "message": "revert @Column"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edc80a11139d6febfcea3a57feee8a14c57b0737", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/edc80a11139d6febfcea3a57feee8a14c57b0737", "committedDate": "2020-04-14T08:55:53Z", "message": "Merge branch 'master' into v8/influxdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "160ab950fc420dd63a57efb11356b97b5bb341b4", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/160ab950fc420dd63a57efb11356b97b5bb341b4", "committedDate": "2020-04-14T09:08:44Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNzYwNjk4", "url": "https://github.com/apache/skywalking/pull/4641#pullrequestreview-392760698", "createdAt": "2020-04-14T09:34:36Z", "commit": {"oid": "160ab950fc420dd63a57efb11356b97b5bb341b4"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f8a2318000957b797186cdb0e5bde156e01b626", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/2f8a2318000957b797186cdb0e5bde156e01b626", "committedDate": "2020-04-15T07:41:51Z", "message": "add influxdb to e2e test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "799c83c7c1b49666390fad076c2c6313a9e7fd56", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/799c83c7c1b49666390fad076c2c6313a9e7fd56", "committedDate": "2020-04-15T08:23:22Z", "message": "Merge branch 'master' into v8/influxdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dde4f2dc9be8f3ac9f8fcb2d67300cd5dcf22026", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/dde4f2dc9be8f3ac9f8fcb2d67300cd5dcf22026", "committedDate": "2020-04-15T17:34:33Z", "message": "fix traffic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "807183185c87ba109d015d19df563380912aab59", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/807183185c87ba109d015d19df563380912aab59", "committedDate": "2020-04-15T17:55:57Z", "message": "Merge branch 'v8/influxdb' of https://github.com/dmsolr/skywalking into v8/influxdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50ba299e19cccc3682085aa038404869baf37595", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/50ba299e19cccc3682085aa038404869baf37595", "committedDate": "2020-04-16T03:49:18Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85edf0013942d2756be0bac34e532f401e7a3c95", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/85edf0013942d2756be0bac34e532f401e7a3c95", "committedDate": "2020-04-16T04:15:44Z", "message": "fix e2e configuration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MzAyNDAy", "url": "https://github.com/apache/skywalking/pull/4641#pullrequestreview-394302402", "createdAt": "2020-04-16T05:10:53Z", "commit": {"oid": "85edf0013942d2756be0bac34e532f401e7a3c95"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d582213a48089105e49b8a8c57ec294778228de8", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/d582213a48089105e49b8a8c57ec294778228de8", "committedDate": "2020-04-16T05:19:20Z", "message": "Merge branch 'master' into v8/influxdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7f2f2d9f4a490c7536ad241326551dbd67da0d7", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/b7f2f2d9f4a490c7536ad241326551dbd67da0d7", "committedDate": "2020-04-16T07:46:14Z", "message": "fix e2e configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61f813f81b193641cf31e96c8022120067b17cfe", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/61f813f81b193641cf31e96c8022120067b17cfe", "committedDate": "2020-04-17T07:52:20Z", "message": "fix query issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4b3b5185b20aabeeef9bacaa405a370aafcf3a9", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/f4b3b5185b20aabeeef9bacaa405a370aafcf3a9", "committedDate": "2020-04-17T08:28:58Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef1ce7d737a69dce5fce102202aa658add5dbd7a", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/ef1ce7d737a69dce5fce102202aa658add5dbd7a", "committedDate": "2020-04-17T08:47:12Z", "message": "checkstyleg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "580327243345785bc28c82c505f06a7b79f0d431", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/580327243345785bc28c82c505f06a7b79f0d431", "committedDate": "2020-04-17T10:33:23Z", "message": "polish"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8765d92bfe151ec3b45f60a55635ee5bc159b467", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/8765d92bfe151ec3b45f60a55635ee5bc159b467", "committedDate": "2020-04-17T11:16:11Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b9976979f9b8e915b34eb7237de8a397bb16026", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/5b9976979f9b8e915b34eb7237de8a397bb16026", "committedDate": "2020-04-17T15:29:34Z", "message": "remove TAG_SERVER_ID"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3f50b1699c86698343520262747011a754d4be4", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/f3f50b1699c86698343520262747011a754d4be4", "committedDate": "2020-04-17T15:54:25Z", "message": "remove TAG_SERVER_ID"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NTk2NjE5", "url": "https://github.com/apache/skywalking/pull/4641#pullrequestreview-395596619", "createdAt": "2020-04-17T16:23:08Z", "commit": {"oid": "f3f50b1699c86698343520262747011a754d4be4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNjoyMzowOFrOGHUp7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNjoyMzowOFrOGHUp7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMzMTYzMA==", "bodyText": "I think we need to use InstanceTraffic#INDEX_NAME and EndpointTraffic#INDEX_NAME in there.", "url": "https://github.com/apache/skywalking/pull/4641#discussion_r410331630", "createdAt": "2020-04-17T16:23:08Z", "author": {"login": "mrproliu"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/TableMetaInfo.java", "diffHunk": "@@ -18,18 +18,80 @@\n \n package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n \n+import com.google.common.collect.Maps;\n import java.util.HashMap;\n+import java.util.List;\n import java.util.Map;\n+import lombok.AllArgsConstructor;\n+import lombok.Builder;\n+import lombok.Getter;\n+import org.apache.skywalking.oap.server.core.analysis.manual.endpoint.EndpointTraffic;\n+import org.apache.skywalking.oap.server.core.analysis.manual.instance.InstanceTraffic;\n+import org.apache.skywalking.oap.server.core.analysis.manual.segment.SegmentRecord;\n+import org.apache.skywalking.oap.server.core.analysis.manual.service.ServiceTraffic;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.analysis.record.Record;\n+import org.apache.skywalking.oap.server.core.storage.model.ColumnName;\n import org.apache.skywalking.oap.server.core.storage.model.Model;\n+import org.apache.skywalking.oap.server.core.storage.model.ModelColumn;\n \n+@Getter\n+@Builder\n+@AllArgsConstructor\n public class TableMetaInfo {\n-    private static Map<String, Model> TABLES = new HashMap<>();\n+    private static final Map<String, TableMetaInfo> TABLES = new HashMap<>();\n+\n+    private Map<String, String> storageAndColumnMap;\n+    private Map<String, String> storageAndTagMap;\n+    private Model model;\n \n     public static void addModel(Model model) {\n-        TABLES.put(model.getName(), model);\n+        final List<ModelColumn> columns = model.getColumns();\n+        final Map<String, String> storageAndTagMap = Maps.newHashMap();\n+        final Map<String, String> storageAndColumnMap = Maps.newHashMap();\n+        columns.forEach(column -> {\n+            ColumnName columnName = column.getColumnName();\n+            storageAndColumnMap.put(columnName.getStorageName(), columnName.getName());\n+        });\n+\n+        if (model.getName().endsWith(\"_traffic\")) {\n+            // instance_traffic name, service_id\n+            // endpoint_traffic name, service_id\n+            storageAndTagMap.put(InstanceTraffic.NAME, InfluxConstants.TagName.NAME);\n+            if (\"instance_traffic\".equals(model.getName())\n+                || \"endpoint_traffic\".equals(model.getName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3f50b1699c86698343520262747011a754d4be4"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17dff41463f2efb3e7625ab534331a9b16262dfc", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/17dff41463f2efb3e7625ab534331a9b16262dfc", "committedDate": "2020-04-18T04:29:16Z", "message": "Revert unnecessary changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1ODgwODE2", "url": "https://github.com/apache/skywalking/pull/4641#pullrequestreview-395880816", "createdAt": "2020-04-18T04:36:51Z", "commit": {"oid": "17dff41463f2efb3e7625ab534331a9b16262dfc"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1ODgxNDU3", "url": "https://github.com/apache/skywalking/pull/4641#pullrequestreview-395881457", "createdAt": "2020-04-18T04:49:18Z", "commit": {"oid": "17dff41463f2efb3e7625ab534331a9b16262dfc"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "060ab3de09bb5e732608c14b49f0ee4eb58422eb", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/060ab3de09bb5e732608c14b49f0ee4eb58422eb", "committedDate": "2020-04-18T10:34:58Z", "message": "remove image on Test finished"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "316fcbcfb9faf94da99f8fbc50dcbdc1cf195e44", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/316fcbcfb9faf94da99f8fbc50dcbdc1cf195e44", "committedDate": "2020-04-18T10:36:20Z", "message": "polish"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c77f8e52e6e4e03dfa10f3a401935718ff04ee7c", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/c77f8e52e6e4e03dfa10f3a401935718ff04ee7c", "committedDate": "2020-04-18T13:46:19Z", "message": "remove workspace of testscase"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTIwNTI5", "url": "https://github.com/apache/skywalking/pull/4641#pullrequestreview-395920529", "createdAt": "2020-04-18T14:52:35Z", "commit": {"oid": "c77f8e52e6e4e03dfa10f3a401935718ff04ee7c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "813cfde137772235bc20ea78ed6a49948458ff38", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/813cfde137772235bc20ea78ed6a49948458ff38", "committedDate": "2020-04-18T15:45:12Z", "message": "update logs when failed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e85466fafc6f03cceb410c38ded042fd7a7cef3", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/0e85466fafc6f03cceb410c38ded042fd7a7cef3", "committedDate": "2020-04-18T17:02:19Z", "message": "move mysql to test.3.yaml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ee0f4c28ec05bb2a5d060549f108840229f80b1", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/6ee0f4c28ec05bb2a5d060549f108840229f80b1", "committedDate": "2020-04-18T17:52:45Z", "message": "test mysql-scenario"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88e245bf35f917c3d3e2732eebae9c3b18b00978", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/88e245bf35f917c3d3e2732eebae9c3b18b00978", "committedDate": "2020-04-18T18:05:39Z", "message": "revert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2ea5245ec924401e6b0f57ad43006c06265771e", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/a2ea5245ec924401e6b0f57ad43006c06265771e", "committedDate": "2020-04-18T18:44:54Z", "message": "delete some versions of mysql temporarily"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b2342f8f5d22bea721670c0ee1a479743c43b3e", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/4b2342f8f5d22bea721670c0ee1a479743c43b3e", "committedDate": "2020-04-19T08:54:40Z", "message": "Merge branch 'master' into v8/influxdb"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTk2MzQw", "url": "https://github.com/apache/skywalking/pull/4641#pullrequestreview-395996340", "createdAt": "2020-04-19T09:33:14Z", "commit": {"oid": "4b2342f8f5d22bea721670c0ee1a479743c43b3e"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2MDAxMDg2", "url": "https://github.com/apache/skywalking/pull/4641#pullrequestreview-396001086", "createdAt": "2020-04-19T10:27:47Z", "commit": {"oid": "4b2342f8f5d22bea721670c0ee1a479743c43b3e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "365b7bb401afd21cb184f95fc371ed619e573e7b", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/365b7bb401afd21cb184f95fc371ed619e573e7b", "committedDate": "2020-04-19T11:15:02Z", "message": "fix encode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2MDA5NTIx", "url": "https://github.com/apache/skywalking/pull/4641#pullrequestreview-396009521", "createdAt": "2020-04-19T12:08:07Z", "commit": {"oid": "365b7bb401afd21cb184f95fc371ed619e573e7b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2293, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}