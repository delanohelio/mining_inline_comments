{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNDg0NjAw", "number": 4546, "reviewThreads": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMzoyODoyOFrODp3hRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzozNjozM1rODqIDWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MjI3ODQ0OnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/AbstractTracerContext.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMzoyODoyOFrOF5Tpcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMzoyODoyOFrOF5Tpcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYzNTA1OA==", "bodyText": "We should not open this heavy object for this. Right now, only true/false should be opened.", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r395635058", "createdAt": "2020-03-20T13:28:28Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/AbstractTracerContext.java", "diffHunk": "@@ -115,4 +116,10 @@\n      */\n     void asyncStop(AsyncSpan span);\n \n+    /**\n+     * Get current context profiler\n+     * @return null if not profiling\n+     */\n+    ThreadProfiler profiler();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ef76fa6f9bfbd83be3f319d2a63ec08d329d725"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MjI4MzEyOnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/ContextManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMzoyOTo0OVrOF5TsiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMzoyOTo0OVrOF5TsiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYzNTg0OQ==", "bodyText": "This will cost unexpected resource. We should use span to delegate. Such as span#isProfiling.", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r395635849", "createdAt": "2020-03-20T13:29:49Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/ContextManager.java", "diffHunk": "@@ -224,4 +226,17 @@ public static RuntimeContext getRuntimeContext() {\n \n         return runtimeContext;\n     }\n+\n+    /**\n+     * Get current context profiling status\n+     * @return\n+     */\n+    public static ProfilingStatus getProfilingStatus() {\n+        final AbstractTracerContext context = get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ef76fa6f9bfbd83be3f319d2a63ec08d329d725"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MjI4NTIwOnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/TracingContext.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMzozMDoyMlrOF5Tt1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDo1NjoxOFrOF5XIgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYzNjE4Mg==", "bodyText": "I don't think we should open this.", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r395636182", "createdAt": "2020-03-20T13:30:22Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/TracingContext.java", "diffHunk": "@@ -106,9 +107,9 @@\n     private final long createTime;\n \n     /**\n-     * profiling status\n+     * profiling data\n      */\n-    private volatile boolean profiling;\n+    private volatile ThreadProfiler profiler;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ef76fa6f9bfbd83be3f319d2a63ec08d329d725"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY0MjkyMQ==", "bodyText": "Maybe I need to change it to ProfilingStatus because we need the status to check the current context is profiling or ready.", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r395642921", "createdAt": "2020-03-20T13:41:27Z", "author": {"login": "mrproliu"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/TracingContext.java", "diffHunk": "@@ -106,9 +107,9 @@\n     private final long createTime;\n \n     /**\n-     * profiling status\n+     * profiling data\n      */\n-    private volatile boolean profiling;\n+    private volatile ThreadProfiler profiler;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYzNjE4Mg=="}, "originalCommit": {"oid": "3ef76fa6f9bfbd83be3f319d2a63ec08d329d725"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2ODMwNw==", "bodyText": "What do you mean ready? The parameter collection only happens after the profile activated.", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r395668307", "createdAt": "2020-03-20T14:21:20Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/TracingContext.java", "diffHunk": "@@ -106,9 +107,9 @@\n     private final long createTime;\n \n     /**\n-     * profiling status\n+     * profiling data\n      */\n-    private volatile boolean profiling;\n+    private volatile ThreadProfiler profiler;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYzNjE4Mg=="}, "originalCommit": {"oid": "3ef76fa6f9bfbd83be3f319d2a63ec08d329d725"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3MzU5MQ==", "bodyText": "The profile has minDurationThreshold to explain only start profiling when bigger this parameter, before this time, it was ready status. I think on the ready status, we don't need to start the HTTP parameter happens.", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r395673591", "createdAt": "2020-03-20T14:28:53Z", "author": {"login": "mrproliu"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/TracingContext.java", "diffHunk": "@@ -106,9 +107,9 @@\n     private final long createTime;\n \n     /**\n-     * profiling status\n+     * profiling data\n      */\n-    private volatile boolean profiling;\n+    private volatile ThreadProfiler profiler;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYzNjE4Mg=="}, "originalCommit": {"oid": "3ef76fa6f9bfbd83be3f319d2a63ec08d329d725"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY5MDI3Mw==", "bodyText": "I think we have a naming issue here. The current profiling should rename to pendingProfile, and we need a real profiling to indicate the thread dump started status.", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r395690273", "createdAt": "2020-03-20T14:53:42Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/TracingContext.java", "diffHunk": "@@ -106,9 +107,9 @@\n     private final long createTime;\n \n     /**\n-     * profiling status\n+     * profiling data\n      */\n-    private volatile boolean profiling;\n+    private volatile ThreadProfiler profiler;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYzNjE4Mg=="}, "originalCommit": {"oid": "3ef76fa6f9bfbd83be3f319d2a63ec08d329d725"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY5MjE2Mg==", "bodyText": "Or you should refactor this as an enum, having value, NONE, PENDING and PROFILING. Also, this enum should have a method called isBeingWatched. PENDING and PROFILING should return yes.", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r395692162", "createdAt": "2020-03-20T14:56:18Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/TracingContext.java", "diffHunk": "@@ -106,9 +107,9 @@\n     private final long createTime;\n \n     /**\n-     * profiling status\n+     * profiling data\n      */\n-    private volatile boolean profiling;\n+    private volatile ThreadProfiler profiler;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYzNjE4Mg=="}, "originalCommit": {"oid": "3ef76fa6f9bfbd83be3f319d2a63ec08d329d725"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDUzMDkwOnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/trace/AbstractSpan.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxMzoxNDo1MVrOF5paxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxMzoxNDo1MVrOF5paxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5MTc0OQ==", "bodyText": "either remove this or add descriptive comments", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r395991749", "createdAt": "2020-03-21T13:14:51Z", "author": {"login": "kezhenxu94"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/trace/AbstractSpan.java", "diffHunk": "@@ -126,4 +126,11 @@\n     AbstractSpan start(long startTime);\n \n     AbstractSpan setPeer(String remotePeer);\n+\n+    /**\n+     * Check current context has profiling\n+     *\n+     * @return\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7428114c4ee326c536cfc2d6c0841e3b852f241"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDUzMTY1OnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatus.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxMzoxNjoxMlrOF5pbJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxMzoxNjoxMlrOF5pbJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5MTg0Ng==", "bodyText": "PADDING? do you mean PENDING?", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r395991846", "createdAt": "2020-03-21T13:16:12Z", "author": {"login": "kezhenxu94"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatus.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+/**\n+ * Profile status, include entire profile cycle\n+ */\n+public enum ProfileStatus {\n+    /**\n+     * Profile not required\n+     */\n+    NONE,\n+\n+    /**\n+     * Prepare to profile, when {@link ProfileTask#getMinDurationThreshold()} is reached,\n+     * the status will be changed to profiling, and the thread snapshot will be started\n+     */\n+    PADDING,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7428114c4ee326c536cfc2d6c0841e3b852f241"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDUzMjMzOnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatusReference.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxMzoxNzoxNFrOF5pbdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxMzoxNzoxNFrOF5pbdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5MTkyNg==", "bodyText": "either remove this or add descriptive comments", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r395991926", "createdAt": "2020-03-21T13:17:14Z", "author": {"login": "kezhenxu94"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatusReference.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+/**\n+ * Wrapper {@link ProfileStatus}, make sure {@link org.apache.skywalking.apm.agent.core.context.TracingContext} with {@link ThreadProfiler} have same reference with {@link ProfileStatus},\n+ * And only the profile module could change the status\n+ */\n+public class ProfileStatusReference {\n+\n+    private volatile ProfileStatus status;\n+\n+    private ProfileStatusReference(ProfileStatus status) {\n+        this.status = status;\n+    }\n+\n+    /**\n+     * Create with not watching\n+     * @return", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7428114c4ee326c536cfc2d6c0841e3b852f241"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDUzMjY1OnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatusReference.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxMzoxNzo0MVrOF5pboQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxMzoxNzo0MVrOF5pboQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5MTk2OQ==", "bodyText": "ditto", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r395991969", "createdAt": "2020-03-21T13:17:41Z", "author": {"login": "kezhenxu94"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatusReference.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+/**\n+ * Wrapper {@link ProfileStatus}, make sure {@link org.apache.skywalking.apm.agent.core.context.TracingContext} with {@link ThreadProfiler} have same reference with {@link ProfileStatus},\n+ * And only the profile module could change the status\n+ */\n+public class ProfileStatusReference {\n+\n+    private volatile ProfileStatus status;\n+\n+    private ProfileStatusReference(ProfileStatus status) {\n+        this.status = status;\n+    }\n+\n+    /**\n+     * Create with not watching\n+     * @return\n+     */\n+    public static ProfileStatusReference createWithNone() {\n+        return new ProfileStatusReference(ProfileStatus.NONE);\n+    }\n+\n+    /**\n+     * Create with padding to profile\n+     * @return", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7428114c4ee326c536cfc2d6c0841e3b852f241"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDU0MDE1OnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-sdk-plugin/spring-plugins/mvc-annotation-commons/src/main/java/org/apache/skywalking/apm/plugin/spring/mvc/commons/interceptor/AbstractMethodInterceptor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxMzozMToxOFrOF5pfbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxMzozMToxOFrOF5pfbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5Mjk0Mw==", "bodyText": "Config.Plugin.SpringMVC.COLLECT_HTTP_PARAMS", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r395992943", "createdAt": "2020-03-21T13:31:18Z", "author": {"login": "kezhenxu94"}, "path": "apm-sniffer/apm-sdk-plugin/spring-plugins/mvc-annotation-commons/src/main/java/org/apache/skywalking/apm/plugin/spring/mvc/commons/interceptor/AbstractMethodInterceptor.java", "diffHunk": "@@ -185,6 +180,12 @@ public Object afterMethod(EnhancedInstance objInst, Method method, Object[] allA\n                 ContextManager.getRuntimeContext().remove(CONTROLLER_METHOD_STACK_DEPTH);\n             }\n \n+            // Active HTTP parameter collection automatically in the profiling context.\n+            // https://github.com/apache/skywalking/issues/4542\n+            if (!Config.Plugin.Tomcat.COLLECT_HTTP_PARAMS && span.isProfiling()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7428114c4ee326c536cfc2d6c0841e3b852f241"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDk3OTg0OnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatus.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzoxNTo0OVrOF5s-Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzoxNTo0OVrOF5s-Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0OTk3MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Prepare to profile, when {@link ProfileTask#getMinDurationThreshold()} is reached,\n          \n          \n            \n                 * Prepare to profile, until {@link ProfileTask#getMinDurationThreshold()} reached,", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r396049971", "createdAt": "2020-03-22T03:15:49Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatus.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+/**\n+ * Profile status, include entire profile cycle\n+ */\n+public enum ProfileStatus {\n+    /**\n+     * Profile not required\n+     */\n+    NONE,\n+\n+    /**\n+     * Prepare to profile, when {@link ProfileTask#getMinDurationThreshold()} is reached,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97460fb8630f8eb997f0e0958f6f499e7ddd1b76"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDk4MDMwOnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatus.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzoxNzoyMlrOF5s-ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzoxNzoyMlrOF5s-ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MDAyNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * the status will be changed to profiling, and the thread snapshot will be started\n          \n          \n            \n                 * Once the status changed to profiling, the thread snapshot is officially started", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r396050026", "createdAt": "2020-03-22T03:17:22Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatus.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+/**\n+ * Profile status, include entire profile cycle\n+ */\n+public enum ProfileStatus {\n+    /**\n+     * Profile not required\n+     */\n+    NONE,\n+\n+    /**\n+     * Prepare to profile, when {@link ProfileTask#getMinDurationThreshold()} is reached,\n+     * the status will be changed to profiling, and the thread snapshot will be started", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97460fb8630f8eb997f0e0958f6f499e7ddd1b76"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDk4MTAyOnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatus.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzoxOTowMlrOF5s-uA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzoxOTowMlrOF5s-uA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MDEwNA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * or the current thread cannot take a thread snapshot operation again\n          \n          \n            \n                 * or the current thread isn't available.", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r396050104", "createdAt": "2020-03-22T03:19:02Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatus.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+/**\n+ * Profile status, include entire profile cycle\n+ */\n+public enum ProfileStatus {\n+    /**\n+     * Profile not required\n+     */\n+    NONE,\n+\n+    /**\n+     * Prepare to profile, when {@link ProfileTask#getMinDurationThreshold()} is reached,\n+     * the status will be changed to profiling, and the thread snapshot will be started\n+     */\n+    PENDING,\n+\n+    /**\n+     * Profile operation has been started, and dump thread snapshot will continue\n+     */\n+    PROFILING,\n+\n+    /**\n+     * The current {@link org.apache.skywalking.apm.agent.core.context.TracingContext} has finished executing,\n+     * or the current thread cannot take a thread snapshot operation again", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97460fb8630f8eb997f0e0958f6f499e7ddd1b76"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDk4MTA4OnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatus.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzoxOToxOFrOF5s-vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzoxOToxOFrOF5s-vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MDExMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * The current {@link org.apache.skywalking.apm.agent.core.context.TracingContext} has finished executing,\n          \n          \n            \n                 * The current {@link org.apache.skywalking.apm.agent.core.context.TracingContext} has finished,", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r396050111", "createdAt": "2020-03-22T03:19:18Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatus.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+/**\n+ * Profile status, include entire profile cycle\n+ */\n+public enum ProfileStatus {\n+    /**\n+     * Profile not required\n+     */\n+    NONE,\n+\n+    /**\n+     * Prepare to profile, when {@link ProfileTask#getMinDurationThreshold()} is reached,\n+     * the status will be changed to profiling, and the thread snapshot will be started\n+     */\n+    PENDING,\n+\n+    /**\n+     * Profile operation has been started, and dump thread snapshot will continue\n+     */\n+    PROFILING,\n+\n+    /**\n+     * The current {@link org.apache.skywalking.apm.agent.core.context.TracingContext} has finished executing,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97460fb8630f8eb997f0e0958f6f499e7ddd1b76"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDk4MTU1OnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatusReference.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzoyMDo0N1rOF5s--Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzoyMDo0N1rOF5s--Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MDE2OQ==", "bodyText": "I think there is another typo, pending", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r396050169", "createdAt": "2020-03-22T03:20:47Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatusReference.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+/**\n+ * Wrapper {@link ProfileStatus}, make sure {@link org.apache.skywalking.apm.agent.core.context.TracingContext} with {@link ThreadProfiler} have same reference with {@link ProfileStatus},\n+ * And only the profile module could change the status\n+ */\n+public class ProfileStatusReference {\n+\n+    private volatile ProfileStatus status;\n+\n+    private ProfileStatusReference(ProfileStatus status) {\n+        this.status = status;\n+    }\n+\n+    /**\n+     * Create with not watching\n+     */\n+    public static ProfileStatusReference createWithNone() {\n+        return new ProfileStatusReference(ProfileStatus.NONE);\n+    }\n+\n+    /**\n+     * Create with padding to profile\n+     */\n+    public static ProfileStatusReference createWithPadding() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97460fb8630f8eb997f0e0958f6f499e7ddd1b76"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDk4MjI4OnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-sdk-plugin/spring-plugins/mvc-annotation-commons/src/main/java/org/apache/skywalking/apm/plugin/spring/mvc/commons/interceptor/AbstractMethodInterceptor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzoyMjo1N1rOF5s_UA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzoyMjo1N1rOF5s_UA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MDI1Ng==", "bodyText": "Why refer an issue here? Anything special?", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r396050256", "createdAt": "2020-03-22T03:22:57Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/spring-plugins/mvc-annotation-commons/src/main/java/org/apache/skywalking/apm/plugin/spring/mvc/commons/interceptor/AbstractMethodInterceptor.java", "diffHunk": "@@ -185,6 +180,12 @@ public Object afterMethod(EnhancedInstance objInst, Method method, Object[] allA\n                 ContextManager.getRuntimeContext().remove(CONTROLLER_METHOD_STACK_DEPTH);\n             }\n \n+            // Active HTTP parameter collection automatically in the profiling context.\n+            // https://github.com/apache/skywalking/issues/4542", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97460fb8630f8eb997f0e0958f6f499e7ddd1b76"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDk4NDgwOnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-sdk-plugin/tomcat-7.x-8.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/tomcat78x/TomcatInvokeInterceptor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzozMDoyNVrOF5tAjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzozMDoyNVrOF5tAjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MDU3Mg==", "bodyText": "Don't refer to issue, unless there is something special, because if don't follow this, we will have thousands of issue links in the codes.", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r396050572", "createdAt": "2020-03-22T03:30:25Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/tomcat-7.x-8.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/tomcat78x/TomcatInvokeInterceptor.java", "diffHunk": "@@ -83,32 +83,26 @@ public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allAr\n         SpanLayer.asHttp(span);\n \n         if (Config.Plugin.Tomcat.COLLECT_HTTP_PARAMS) {\n-            final Map<String, String[]> parameterMap = new HashMap<>();\n-            final org.apache.coyote.Request coyoteRequest = request.getCoyoteRequest();\n-            final Parameters parameters = coyoteRequest.getParameters();\n-            for (final Enumeration<String> names = parameters.getParameterNames(); names.hasMoreElements(); ) {\n-                final String name = names.nextElement();\n-                parameterMap.put(name, parameters.getParameterValues(name));\n-            }\n-\n-            if (!parameterMap.isEmpty()) {\n-                String tagValue = CollectionUtil.toString(parameterMap);\n-                tagValue = Config.Plugin.Http.HTTP_PARAMS_LENGTH_THRESHOLD > 0 ? StringUtil.cut(tagValue, Config.Plugin.Http.HTTP_PARAMS_LENGTH_THRESHOLD) : tagValue;\n-                Tags.HTTP.PARAMS.set(span, tagValue);\n-            }\n+            collectHttpParam(request, span);\n         }\n     }\n \n     @Override\n     public Object afterMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes,\n         Object ret) throws Throwable {\n+        Request request = (Request) allArguments[0];\n         HttpServletResponse response = (HttpServletResponse) allArguments[1];\n \n         AbstractSpan span = ContextManager.activeSpan();\n         if (IS_SERVLET_GET_STATUS_METHOD_EXIST && response.getStatus() >= 400) {\n             span.errorOccurred();\n             Tags.STATUS_CODE.set(span, Integer.toString(response.getStatus()));\n         }\n+        // Active HTTP parameter collection automatically in the profiling context.\n+        // https://github.com/apache/skywalking/issues/4542", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97460fb8630f8eb997f0e0958f6f499e7ddd1b76"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDk4NjA4OnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatus.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzozMzowN1rOF5tBHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzozMzowN1rOF5tBHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MDcxNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Profile not required\n          \n          \n            \n                 * No profile", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r396050716", "createdAt": "2020-03-22T03:33:07Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatus.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+/**\n+ * Profile status, include entire profile cycle\n+ */\n+public enum ProfileStatus {\n+    /**\n+     * Profile not required", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97460fb8630f8eb997f0e0958f6f499e7ddd1b76"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDk4NjI0OnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatus.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzozMzoyOFrOF5tBMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzozMzoyOFrOF5tBMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MDczNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Profile operation has been started, and dump thread snapshot will continue\n          \n          \n            \n                 * Profile operation has been started.", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r396050736", "createdAt": "2020-03-22T03:33:28Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatus.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+/**\n+ * Profile status, include entire profile cycle\n+ */\n+public enum ProfileStatus {\n+    /**\n+     * Profile not required\n+     */\n+    NONE,\n+\n+    /**\n+     * Prepare to profile, when {@link ProfileTask#getMinDurationThreshold()} is reached,\n+     * the status will be changed to profiling, and the thread snapshot will be started\n+     */\n+    PENDING,\n+\n+    /**\n+     * Profile operation has been started, and dump thread snapshot will continue", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97460fb8630f8eb997f0e0958f6f499e7ddd1b76"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDk4NjUyOnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatusReference.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzozNDoyOVrOF5tBUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzozNDoyOVrOF5tBUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MDc2OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public boolean isBeingWatched() {\n          \n          \n            \n                /**\n          \n          \n            \n                 * The profile monitoring is watching, wait for some profile conditions.\n          \n          \n            \n                 */\n          \n          \n            \n                public boolean isBeingWatched() {", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r396050769", "createdAt": "2020-03-22T03:34:29Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/profile/ProfileStatusReference.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.profile;\n+\n+/**\n+ * Wrapper {@link ProfileStatus}, make sure {@link org.apache.skywalking.apm.agent.core.context.TracingContext} with {@link ThreadProfiler} have same reference with {@link ProfileStatus},\n+ * And only the profile module could change the status\n+ */\n+public class ProfileStatusReference {\n+\n+    private volatile ProfileStatus status;\n+\n+    private ProfileStatusReference(ProfileStatus status) {\n+        this.status = status;\n+    }\n+\n+    /**\n+     * Create with not watching\n+     */\n+    public static ProfileStatusReference createWithNone() {\n+        return new ProfileStatusReference(ProfileStatus.NONE);\n+    }\n+\n+    /**\n+     * Create with padding to profile\n+     */\n+    public static ProfileStatusReference createWithPadding() {\n+        return new ProfileStatusReference(ProfileStatus.PENDING);\n+    }\n+\n+    public ProfileStatus get() {\n+        return this.status;\n+    }\n+\n+    public boolean isBeingWatched() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97460fb8630f8eb997f0e0958f6f499e7ddd1b76"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDk4NzEyOnYy", "diffSide": "RIGHT", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/trace/AbstractSpan.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzozNjozM1rOF5tBow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwMzozNjozM1rOF5tBow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MDg1MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Check current context has profiling\n          \n          \n            \n                 * @return true if the span's owner(tracing context main thread) is been profiled.", "url": "https://github.com/apache/skywalking/pull/4546#discussion_r396050851", "createdAt": "2020-03-22T03:36:33Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/trace/AbstractSpan.java", "diffHunk": "@@ -126,4 +126,9 @@\n     AbstractSpan start(long startTime);\n \n     AbstractSpan setPeer(String remotePeer);\n+\n+    /**\n+     * Check current context has profiling", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97460fb8630f8eb997f0e0958f6f499e7ddd1b76"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4448, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}