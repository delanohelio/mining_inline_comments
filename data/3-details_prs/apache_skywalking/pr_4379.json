{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2MjIyOTYw", "number": 4379, "title": "Fix ehcache:\u00a0 missing interceptor of private constructor and setName method", "bodyText": "Please answer these questions before submitting pull request\n\nWhy submit this pull request?\n Bug fix\n New feature provided\n Improve performance\n\n\nBug fix\n\n\nBug description.\nWhen the instance of Cache  is created by the clone method,  all the codes EnhancedInstance # getSkyWalkingDynamicField ()  will return null in the ehcache interceptor .\nThis will cause a NullPointerException.\nBeacase the code EnhancedInstance # setSkyWalkingDynamicField() is only called in the constructor's interceptor. But the private constructor and setName  method can not intercepted by the interceptor.\n\n\nHow to fix?\nAdd interceptors of  private constructor and setName method", "createdAt": "2020-02-17T16:23:33Z", "url": "https://github.com/apache/skywalking/pull/4379", "merged": true, "mergeCommit": {"oid": "8ff8cd056575614f55e910230f9e2a7e07342842"}, "closed": true, "closedAt": "2020-02-19T12:05:55Z", "author": {"login": "lsyf"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFPGlIAH2gAyMzc2MjIyOTYwOjU0YzFjZDVjYjA0ZjAxMmZmNDhjOGI4N2MxMWRmMTEwNDFlM2Y0OTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFz0yNgH2gAyMzc2MjIyOTYwOjBkNDcxNDU2NGY3ZjY4MGE5ZDIwZDVjYzEwNzcwNDQ5NzIwNjkzMTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "54c1cd5cb04f012ff48c8b87c11df11041e3f499", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/54c1cd5cb04f012ff48c8b87c11df11041e3f499", "committedDate": "2020-02-17T15:31:28Z", "message": "Fix ehcache:\u00a0 missing interceptor of private constructor called by clone method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a7ff1661ec2182991afa8303a5a82c6ec36479b", "author": {"user": {"login": "lsyf", "name": "\u6f0f\u6c34\u4ea6\u51e1"}}, "url": "https://github.com/apache/skywalking/commit/9a7ff1661ec2182991afa8303a5a82c6ec36479b", "committedDate": "2020-02-17T16:27:38Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74c1f7ef73d6fafa24107ae8f9433f8e4c53c6ac", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/74c1f7ef73d6fafa24107ae8f9433f8e4c53c6ac", "committedDate": "2020-02-18T05:07:16Z", "message": "ehcache-2.x-scenario add EhcacheCloneInterceptor case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff76951d01caebfe3c32864e526d4f82df60ca96", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/ff76951d01caebfe3c32864e526d4f82df60ca96", "committedDate": "2020-02-18T05:08:36Z", "message": "Merge branch 'master' of https://github.com/lsyf/skywalking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e57176d05e00fa8893be15a206b0508f24cc56c1", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/e57176d05e00fa8893be15a206b0508f24cc56c1", "committedDate": "2020-02-18T14:33:33Z", "message": "Fix ehcache:\u00a0 add interceptor for Cache's private constructor and setName method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNzY5MTk0", "url": "https://github.com/apache/skywalking/pull/4379#pullrequestreview-360769194", "createdAt": "2020-02-19T00:28:17Z", "commit": {"oid": "e57176d05e00fa8893be15a206b0508f24cc56c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMDoyODoxOFrOFrXRgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMDoyODoxOFrOFrXRgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAxNDQwMA==", "bodyText": "You don't need to use this try/catch. getConstructorsInterceptPoints returns an array, you should set up the interceptors separately. This one you didi has a performance issue.", "url": "https://github.com/apache/skywalking/pull/4379#discussion_r381014400", "createdAt": "2020-02-19T00:28:18Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/ehcache-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/ehcache/v2/EhcacheConstructorInterceptor.java", "diffHunk": "@@ -18,18 +18,28 @@\n \n package org.apache.skywalking.apm.plugin.ehcache.v2;\n \n+import net.sf.ehcache.Cache;\n import net.sf.ehcache.config.CacheConfiguration;\n import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance;\n import org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceConstructorInterceptor;\n \n public class EhcacheConstructorInterceptor implements InstanceConstructorInterceptor {\n     @Override\n     public void onConstruct(EnhancedInstance objInst, Object[] allArguments) {\n-        CacheConfiguration cacheConfiguration = (CacheConfiguration) allArguments[0];\n+        try {\n+            CacheConfiguration cacheConfiguration = (CacheConfiguration) allArguments[0];\n \n-        // get cache name\n-        if (cacheConfiguration != null) {\n-            objInst.setSkyWalkingDynamicField(new EhcacheEnhanceInfo(cacheConfiguration.getName()));\n+            // get cache name\n+            if (cacheConfiguration != null) {\n+                objInst.setSkyWalkingDynamicField(new EhcacheEnhanceInfo(cacheConfiguration.getName()));\n+            }\n+        } catch (ClassCastException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e57176d05e00fa8893be15a206b0508f24cc56c1"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2ad63430bf9851e92e4d6bfcbcb7d96a6dcc6d7", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/b2ad63430bf9851e92e4d6bfcbcb7d96a6dcc6d7", "committedDate": "2020-02-19T04:10:00Z", "message": "Fix ehcache:\u00a0performance issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwODU2ODQ3", "url": "https://github.com/apache/skywalking/pull/4379#pullrequestreview-360856847", "createdAt": "2020-02-19T05:52:55Z", "commit": {"oid": "b2ad63430bf9851e92e4d6bfcbcb7d96a6dcc6d7"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwODk1MjI3", "url": "https://github.com/apache/skywalking/pull/4379#pullrequestreview-360895227", "createdAt": "2020-02-19T07:43:34Z", "commit": {"oid": "b2ad63430bf9851e92e4d6bfcbcb7d96a6dcc6d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwNzo0MzozNFrOFrdyaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwNzo0MzozNFrOFrdyaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEyMTEyOQ==", "bodyText": "Is this a code format error?", "url": "https://github.com/apache/skywalking/pull/4379#discussion_r381121129", "createdAt": "2020-02-19T07:43:34Z", "author": {"login": "mrproliu"}, "path": "apm-sniffer/apm-sdk-plugin/ehcache-2.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/ehcache/v2/define/EhcachePluginInstrumentation.java", "diffHunk": "@@ -82,13 +88,41 @@\n                 public String getConstructorInterceptor() {\n                     return CONSTRUCTOR_CLASS_INTERCEPT_CLASS;\n                 }\n+            },\n+            new ConstructorInterceptPoint() {\n+                @Override\n+                public ElementMatcher<MethodDescription> getConstructorMatcher() {\n+                    return isPrivate().and(takesArgument(0, named(\"net.sf.ehcache.Cache\")));\n+                }\n+\n+                @Override\n+                public String getConstructorInterceptor() {\n+                    return PRIVATE_CONSTRUCTOR_CLASS_INTERCEPT_CLASS;\n+                }\n             }\n         };\n     }\n \n     @Override\n     public InstanceMethodsInterceptPoint[] getInstanceMethodsInterceptPoints() {\n         return new InstanceMethodsInterceptPoint[] {\n+            new InstanceMethodsInterceptPoint() {\n+                @Override\n+                public ElementMatcher<MethodDescription> getMethodsMatcher() {\n+                    return named(CACHE_NAME_ENHANCE_METHOD).and(takesArgument(0, String.class));\n+                }\n+\n+                @Override\n+                public String getMethodsInterceptor() {\n+                    return CACHE_NAME_INTERCEPTOR_CLASS;\n+                }\n+\n+                @Override\n+                public boolean isOverrideArgs() {\n+                        return false;\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2ad63430bf9851e92e4d6bfcbcb7d96a6dcc6d7"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "102c90dc59d5ce3cc20d26eb36124a17c9aeedf8", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/102c90dc59d5ce3cc20d26eb36124a17c9aeedf8", "committedDate": "2020-02-19T09:23:33Z", "message": "Fix ehcache:\u00a0format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwOTY5NzUw", "url": "https://github.com/apache/skywalking/pull/4379#pullrequestreview-360969750", "createdAt": "2020-02-19T09:48:08Z", "commit": {"oid": "102c90dc59d5ce3cc20d26eb36124a17c9aeedf8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d4714564f7f680a9d20d5cc1077044972069313", "author": {"user": {"login": "mrproliu", "name": null}}, "url": "https://github.com/apache/skywalking/commit/0d4714564f7f680a9d20d5cc1077044972069313", "committedDate": "2020-02-19T10:18:31Z", "message": "Merge branch 'master' into master"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2682, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}