{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyODE3MzY1", "number": 4335, "title": "Provide profile analyze query", "bodyText": "Please answer these questions before submitting pull request\n\n\nWhy submit this pull request?\n\n\n Bug fix\n\n\n New feature provided\n\n\n Improve performance\n\n\nRelated issues\n#4104\n\n\n\nNew feature or improvement\n\nImplement profile anayzation query, complete related e2e test.", "createdAt": "2020-02-09T11:17:46Z", "url": "https://github.com/apache/skywalking/pull/4335", "merged": true, "mergeCommit": {"oid": "fa526e52279d553152a1c8ca8dbeb9158fad6296"}, "closed": true, "closedAt": "2020-02-11T02:11:09Z", "author": {"login": "mrproliu"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCmpBmAH2gAyMzcyODE3MzY1OmFlYWE2YWI5YjUxMmFiNzM3MjQxZWQwNDIwMzM2NzYyY2U3ZGZkZDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDHLg5AFqTM1NjM3Mjg3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "aeaa6ab9b512ab737241ed0420336762ce7dfdd5", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/aeaa6ab9b512ab737241ed0420336762ce7dfdd5", "committedDate": "2020-02-09T11:15:08Z", "message": "provide profile analyze query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dca31eea7a3e292f5041967c8eee20140ad3698b", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/dca31eea7a3e292f5041967c8eee20140ad3698b", "committedDate": "2020-02-09T11:33:12Z", "message": "adding profile analyzation data query log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dbabfacc6075d00e58497de3db1ca7d19515a4e", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/9dbabfacc6075d00e58497de3db1ca7d19515a4e", "committedDate": "2020-02-09T11:58:05Z", "message": "replace some java code line number to not null, adapt multiple java version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NjA0NTE4", "url": "https://github.com/apache/skywalking/pull/4335#pullrequestreview-355604518", "createdAt": "2020-02-09T12:42:40Z", "commit": {"oid": "9dbabfacc6075d00e58497de3db1ca7d19515a4e"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQxMjo0Mjo0MFrOFnU3qQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQxMjo0Mzo0M1rOFnU38A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4MDcxMw==", "bodyText": "From your codes, count is pageSize.", "url": "https://github.com/apache/skywalking/pull/4335#discussion_r376780713", "createdAt": "2020-02-09T12:42:40Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/storage/profile/IProfileThreadSnapshotQueryDAO.java", "diffHunk": "@@ -38,4 +38,17 @@\n      */\n     List<BasicTrace> queryProfiledSegments(String taskId) throws IOException;\n \n+    /**\n+     * search snapshots with paging\n+     * sort by sequence\n+     * @param segmentId profiled segment id\n+     * @param start start dump time\n+     * @param end end dump time\n+     * @param minSequence search sequence start number\n+     * @param count page count\n+     * @return snapshots\n+     * @throws IOException\n+     */\n+    List<ProfileThreadSnapshotRecord> queryRecordsWithPaging(String segmentId, long start, long end, int minSequence, int count) throws IOException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9dbabfacc6075d00e58497de3db1ca7d19515a4e"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4MDc1Mw==", "bodyText": "This should be open in the core configuration.", "url": "https://github.com/apache/skywalking/pull/4335#discussion_r376780753", "createdAt": "2020-02-09T12:43:13Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/profile/analyze/ProfileAnalyzer.java", "diffHunk": "@@ -34,12 +39,45 @@\n \n     private static final ProfileAnalyzeCollector ANALYZE_COLLECTOR = new ProfileAnalyzeCollector();\n \n+    private static final int THREAD_SNAPSHOT_ANALYZE_BATCH_SIZE = 100;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9dbabfacc6075d00e58497de3db1ca7d19515a4e"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4MDc4NA==", "bodyText": "200 or 6200?", "url": "https://github.com/apache/skywalking/pull/4335#discussion_r376780784", "createdAt": "2020-02-09T12:43:43Z", "author": {"login": "wu-sheng"}, "path": "test/e2e/e2e-profile/e2e-profile-service/src/main/java/org/apache/skywalking/e2e/profile/TestController.java", "diffHunk": "@@ -45,8 +45,8 @@ public User createAuthor(@RequestBody final CreateUser createUser) throws Interr\n         if (!createUser.getEnableProfiling()) {\n             return user;\n         } else {\n-            // sleep 10 second\n-            TimeUnit.SECONDS.sleep(10);\n+            // sleep 200 milliseconds\n+            TimeUnit.MILLISECONDS.sleep(6200);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9dbabfacc6075d00e58497de3db1ca7d19515a4e"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "232832a1252e55003998ddf6d934d9e55b2a7723", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/232832a1252e55003998ddf6d934d9e55b2a7723", "committedDate": "2020-02-09T12:57:50Z", "message": "change naming"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6ae85dcf7beaf45ffa03c2892d11a1a7ba48964", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/d6ae85dcf7beaf45ffa03c2892d11a1a7ba48964", "committedDate": "2020-02-09T13:02:19Z", "message": "make analyze profile snapshot paging size configurable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8741807e915071757dbad3e2a5ea99049a873e1", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/d8741807e915071757dbad3e2a5ea99049a873e1", "committedDate": "2020-02-09T13:09:46Z", "message": "fix Compilation failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "564c1c5b0aada963dc790c9221e84035af9fc7a4", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/564c1c5b0aada963dc790c9221e84035af9fc7a4", "committedDate": "2020-02-09T13:18:51Z", "message": "change mysql download url"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01b02586ed52c1ed6d3fe2180a721591dd587c58", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/01b02586ed52c1ed6d3fe2180a721591dd587c58", "committedDate": "2020-02-09T13:37:31Z", "message": "fix mysql error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d66a0cc659773a4347865ca86a65484db2428506", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/d66a0cc659773a4347865ca86a65484db2428506", "committedDate": "2020-02-09T14:17:38Z", "message": "change mysql url"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52e701564686a4dea1dd7376ecc49655345e1b4b", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/52e701564686a4dea1dd7376ecc49655345e1b4b", "committedDate": "2020-02-09T14:31:24Z", "message": "change download mysql driver url"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ae5a5a79c6cc640e5c58b1db7ca186786d6d205", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/5ae5a5a79c6cc640e5c58b1db7ca186786d6d205", "committedDate": "2020-02-09T16:02:29Z", "message": "Update rc0-prepare.sh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c377ede766839e41ee580a674a683c29640e54de", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/c377ede766839e41ee580a674a683c29640e54de", "committedDate": "2020-02-10T01:07:12Z", "message": "adding logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3413acaf8506a058d5502f14a4dfd5d69dac43ef", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/3413acaf8506a058d5502f14a4dfd5d69dac43ef", "committedDate": "2020-02-10T01:08:27Z", "message": "adding sleep on query service failed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31f4b6ee963bdd42a29e79ae97f610721bb57679", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/31f4b6ee963bdd42a29e79ae97f610721bb57679", "committedDate": "2020-02-10T01:57:17Z", "message": "change service verify type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b30c8476b4498feba0a3cee7d9238fab073ebf42", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/b30c8476b4498feba0a3cee7d9238fab073ebf42", "committedDate": "2020-02-10T02:25:53Z", "message": "fix es searching index error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "886a07afe20920172812a441bd35991145c41d79", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/886a07afe20920172812a441bd35991145c41d79", "committedDate": "2020-02-10T02:55:11Z", "message": "1. resole es query error\n2. change mysql e2e test download driver url"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NjgxNjA1", "url": "https://github.com/apache/skywalking/pull/4335#pullrequestreview-355681605", "createdAt": "2020-02-10T04:00:28Z", "commit": {"oid": "886a07afe20920172812a441bd35991145c41d79"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e02fa57b6ecb9715062574547d8cef1419a85daa", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/e02fa57b6ecb9715062574547d8cef1419a85daa", "committedDate": "2020-02-10T13:03:43Z", "message": "using parallel stream to query snapshots"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0594ec1846c3cbe8edb75c04b6eaeda8d881db45", "author": {"user": {"login": "mrproliu", "name": null}}, "url": "https://github.com/apache/skywalking/commit/0594ec1846c3cbe8edb75c04b6eaeda8d881db45", "committedDate": "2020-02-10T13:05:34Z", "message": "Merge branch 'master' into profile_analyze_query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1OTIxMDgw", "url": "https://github.com/apache/skywalking/pull/4335#pullrequestreview-355921080", "createdAt": "2020-02-10T13:08:44Z", "commit": {"oid": "0594ec1846c3cbe8edb75c04b6eaeda8d881db45"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzowODo0NVrOFnlYbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzoxMjoyMlrOFnlfCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA1MTI0Nw==", "bodyText": "Out of snapshot analyze limit,  xxx snapshots found, but analysis first yyy snapshots only.", "url": "https://github.com/apache/skywalking/pull/4335#discussion_r377051247", "createdAt": "2020-02-10T13:08:45Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/profile/analyze/ProfileAnalyzer.java", "diffHunk": "@@ -32,14 +39,90 @@\n  */\n public class ProfileAnalyzer {\n \n+    private static final Logger LOGGER = LoggerFactory.getLogger(ProfileAnalyzer.class);\n+\n     private static final ProfileAnalyzeCollector ANALYZE_COLLECTOR = new ProfileAnalyzeCollector();\n \n+    private final int threadSnapshotAnalyzeBatchSize;\n+    private final int analyzeSnapshotMaxSize;\n+\n+    private final ModuleManager moduleManager;\n+    private IProfileThreadSnapshotQueryDAO profileThreadSnapshotQueryDAO;\n+\n+    public ProfileAnalyzer(ModuleManager moduleManager, int snapshotAnalyzeBatchSize, int analyzeSnapshotMaxSize) {\n+        this.moduleManager = moduleManager;\n+        this.threadSnapshotAnalyzeBatchSize = snapshotAnalyzeBatchSize;\n+        this.analyzeSnapshotMaxSize = analyzeSnapshotMaxSize;\n+    }\n+\n+    /**\n+     * search snapshots and analyze\n+     * @param segmentId\n+     * @param start\n+     * @param end\n+     * @return\n+     */\n+    public ProfileAnalyzation analyze(String segmentId, long start, long end) throws IOException {\n+        ProfileAnalyzation analyzation = new ProfileAnalyzation();\n+\n+        // query sequence range list\n+        SequenceSearch sequenceSearch = getAllSequenceRange(segmentId, start, end);\n+        if (sequenceSearch == null) {\n+            analyzation.setTip(\"Data not found\");\n+            return analyzation;\n+        }\n+        if (sequenceSearch.totalSequenceCount > analyzeSnapshotMaxSize) {\n+            analyzation.setTip(\"Out of snapshot analyze limit, current size:\" + sequenceSearch.totalSequenceCount + \", only analyze snapshot count: \" + analyzeSnapshotMaxSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0594ec1846c3cbe8edb75c04b6eaeda8d881db45"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA1MjkzNw==", "bodyText": "Even for an inner class, please use set/get, rather than accessing fields directly.", "url": "https://github.com/apache/skywalking/pull/4335#discussion_r377052937", "createdAt": "2020-02-10T13:12:22Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/profile/analyze/ProfileAnalyzer.java", "diffHunk": "@@ -50,9 +133,28 @@ public static ProfileAnalyzation analyze(List<ProfileStack> stacks) {\n                 .filter(s -> CollectionUtils.isNotEmpty(s.getStack()))\n                 .collect(Collectors.groupingBy(s -> s.getStack().get(0), ANALYZE_COLLECTOR));\n \n-        ProfileAnalyzation analyzer = new ProfileAnalyzation();\n-        analyzer.setTrees(new ArrayList<>(stackTrees.values()));\n-        return analyzer;\n+        return new ArrayList<>(stackTrees.values());\n     }\n \n+    private IProfileThreadSnapshotQueryDAO getProfileThreadSnapshotQueryDAO() {\n+        if (profileThreadSnapshotQueryDAO == null) {\n+            profileThreadSnapshotQueryDAO = moduleManager.find(StorageModule.NAME).provider().getService(IProfileThreadSnapshotQueryDAO.class);\n+        }\n+        return profileThreadSnapshotQueryDAO;\n+    }\n+\n+    private static class SequenceSearch {\n+        LinkedList<SequenceRange> ranges = new LinkedList<>();\n+        int totalSequenceCount;\n+    }\n+\n+    private static class SequenceRange {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0594ec1846c3cbe8edb75c04b6eaeda8d881db45"}, "originalPosition": 132}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c911c3be7c6de31d37d1bb72526fc28d04cc36f", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/9c911c3be7c6de31d37d1bb72526fc28d04cc36f", "committedDate": "2020-02-10T13:25:13Z", "message": "1. using set/get on inner class\n2. fix tip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa5b2395922ab4bc87bed5bd5dfcd915bc307e9e", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/aa5b2395922ab4bc87bed5bd5dfcd915bc307e9e", "committedDate": "2020-02-10T14:21:14Z", "message": "fix doc error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MDA4NTE1", "url": "https://github.com/apache/skywalking/pull/4335#pullrequestreview-356008515", "createdAt": "2020-02-10T15:05:17Z", "commit": {"oid": "aa5b2395922ab4bc87bed5bd5dfcd915bc307e9e"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "307004c562066ca2fc114213e3b417e68deac1ba", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/307004c562066ca2fc114213e3b417e68deac1ba", "committedDate": "2020-02-10T22:47:39Z", "message": "fix difference api of es7"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d75d970607df6ffb172535d9784902773dbeb518", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/d75d970607df6ffb172535d9784902773dbeb518", "committedDate": "2020-02-11T01:05:15Z", "message": "add es7 doc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzcyODcy", "url": "https://github.com/apache/skywalking/pull/4335#pullrequestreview-356372872", "createdAt": "2020-02-11T01:09:46Z", "commit": {"oid": "d75d970607df6ffb172535d9784902773dbeb518"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2661, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}