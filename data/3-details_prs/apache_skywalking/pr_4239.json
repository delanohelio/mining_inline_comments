{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzMjIyNDA1", "number": 4239, "title": "Provide influxdb as a new storage plugin", "bodyText": "Please answer these questions before submitting pull request\n\nWhy submit this pull request?\n Bug fix\n New feature provided\n Improve performance\n\n\nNew feature or improvement\n\nDescribe the details and related test reports.\n\nThis PR provides a new storage plugin for OAP which uses two-level storage.\nThe first level is a relationship database stored something likes inventory, which has transactions and updates. Stored in MySQL.(Now, I make H2 as relationship database. Because it is easy for test.)\nThe second level is a time-series database, stored metrics, logs, and traces. Those data have strong time-lined and no-transaction, no-updated, no-deleted. Stored in InfluxDB.\nInfluxDB is a very powerful time-series database. It is good at manipulating time-series data. So, it is suitable for our trace records that have strong time-lined, no-updated, and no-deleted.\nNow, it is an experimental feature. We need to continuously improve it with you. And it is a meaningful experience for others NoSQL/TSDB likes Apache Druid, OpenTSDB.\n\nTODO list\n\n feature\n e2e with standone\n e2e with cluster\n document (backend-storage.md)\n e2e-ttl\n update license\n comments (provided without interface implemented)\n docker/docker-entrypoint.sh\n refactor e2e-ttl and e2e-influxdb", "createdAt": "2020-01-15T16:20:35Z", "url": "https://github.com/apache/skywalking/pull/4239", "merged": true, "mergeCommit": {"oid": "29da5738bcea2a55e5d88f4eda9ea9056be38867"}, "closed": true, "closedAt": "2020-02-19T10:00:58Z", "author": {"login": "dmsolr"}, "timelineItems": {"totalCount": 115, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFOSyrAH2gAyMzYzMjIyNDA1OjkxNThjOTllZGE1MDFjMTQ4OTBkY2Y2ZDM5MmVlNTc4NzU3NTkxNWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFyiAXAFqTM2MDkyODU0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9158c99eda501c14890dcf6d392ee5787575915f", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/9158c99eda501c14890dcf6d392ee5787575915f", "committedDate": "2020-02-17T14:34:54Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "170b15da25668c02b5c18f3a0379dff4d7d2ad0e", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/170b15da25668c02b5c18f3a0379dff4d7d2ad0e", "committedDate": "2020-02-17T14:52:18Z", "message": "Merge branch 'influx-storage' of https://github.com/dmsolr/skywalking into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41143031fe46cb49cc7bf88b3a6d14b70e062f41", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/41143031fe46cb49cc7bf88b3a6d14b70e062f41", "committedDate": "2020-02-18T04:24:05Z", "message": "remove profile_task from metabase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ef910d9e690e6a2b8ba9ee2202d1bc3ebb35b48", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/4ef910d9e690e6a2b8ba9ee2202d1bc3ebb35b48", "committedDate": "2020-02-18T05:51:44Z", "message": "Update MetaTableDefine.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5609a5d5578a65758540d5ad9be53a2ee214907b", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/5609a5d5578a65758540d5ad9be53a2ee214907b", "committedDate": "2020-02-18T07:45:16Z", "message": "fix issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMTMxNjk4", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-360131698", "createdAt": "2020-02-18T08:04:13Z", "commit": {"oid": "5609a5d5578a65758540d5ad9be53a2ee214907b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwODowNDoxM1rOFq4c8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwODowNDoxM1rOFq4c8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUwOTQyNw==", "bodyText": "Check ModelInstaller#overrideColumnName, you could replace the name in the storage implementation. That is a more elegant way.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r380509427", "createdAt": "2020-02-18T08:04:13Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/query/ProfileTaskQuery.java", "diffHunk": "@@ -95,7 +96,7 @@ public ProfileTask getById(final String id) throws IOException {\n         WhereQueryImpl query = select(\"ID\", ProfileTaskRecord.SERVICE_ID,\n                                       ProfileTaskRecord.ENDPOINT_NAME, ProfileTaskRecord.START_TIME,\n                                       ProfileTaskRecord.CREATE_TIME,\n-                                      ProfileTaskRecord.DURATION,\n+                                      \"\\\"\" + ProfileTaskRecord.DURATION + \"\\\"\", // scape, the 'duration' is identifier", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5609a5d5578a65758540d5ad9be53a2ee214907b"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bef73af92d8743dd47288fa253c278429ac84bf", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/3bef73af92d8743dd47288fa253c278429ac84bf", "committedDate": "2020-02-18T08:17:32Z", "message": "NoneStreamDAO, influxdb implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2a97f9ca7ca001ab05df1fd29b5733a9e4a7988", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/a2a97f9ca7ca001ab05df1fd29b5733a9e4a7988", "committedDate": "2020-02-18T11:35:11Z", "message": "fixg"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMzAxODUx", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-360301851", "createdAt": "2020-02-18T12:35:32Z", "commit": {"oid": "a2a97f9ca7ca001ab05df1fd29b5733a9e4a7988"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9121be6a56988bb3d606b4239268e953b16f19c6", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/9121be6a56988bb3d606b4239268e953b16f19c6", "committedDate": "2020-02-18T16:26:31Z", "message": "override column name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNzU2NzU2", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-360756756", "createdAt": "2020-02-18T23:51:34Z", "commit": {"oid": "9121be6a56988bb3d606b4239268e953b16f19c6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwODQ0Mzc4", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-360844378", "createdAt": "2020-02-19T05:05:00Z", "commit": {"oid": "9121be6a56988bb3d606b4239268e953b16f19c6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwNTowNTowMFrOFrbNoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwNTowNTowMFrOFrbNoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA3ODk0NA==", "bodyText": "recommend add a null value to judge here\uff0csubsequence queries are based on the available influx", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r381078944", "createdAt": "2020-02-19T05:05:00Z", "author": null, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,191 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import lombok.extern.slf4j.Slf4j;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.apache.skywalking.oap.server.library.util.CollectionUtils;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+/**\n+ * InfluxDB connection maintainer, provides base data write/query API.\n+ */\n+@Slf4j\n+public class InfluxClient implements Client {\n+    private InfluxStorageConfig config;\n+    private InfluxDB influx;\n+\n+    /**\n+     * A constant, the name of time field in Time-series database.\n+     */\n+    public static final String TIME = \"time\";\n+    /**\n+     * A constant, the name of tag of time_bucket.\n+     */\n+    public static final String TAG_TIME_BUCKET = \"_time_bucket\";\n+\n+    private final String database;\n+\n+    public InfluxClient(InfluxStorageConfig config) {\n+        this.config = config;\n+        this.database = config.getDatabase();\n+    }\n+\n+    public final String getDatabase() {\n+        return database;\n+    }\n+\n+    @Override\n+    public void connect() {\n+        influx = InfluxDBFactory.connect(config.getUrl(), config.getUser(), config.getPassword(),\n+                                         new OkHttpClient.Builder().readTimeout(3, TimeUnit.MINUTES)\n+                                                                   .writeTimeout(3, TimeUnit.MINUTES),\n+                                         InfluxDB.ResponseFormat.MSGPACK\n+        );\n+        influx.query(new Query(\"CREATE DATABASE \" + database));\n+\n+        influx.enableBatch(config.getActions(), config.getDuration(), TimeUnit.MILLISECONDS);\n+        influx.setDatabase(database);\n+    }\n+\n+    /**\n+     * To get a connection of InfluxDB.\n+     *\n+     * @return InfluxDB's connection\n+     */\n+    private InfluxDB getInflux() {\n+        return influx;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9121be6a56988bb3d606b4239268e953b16f19c6"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwODQ1ODUx", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-360845851", "createdAt": "2020-02-19T05:11:08Z", "commit": {"oid": "9121be6a56988bb3d606b4239268e953b16f19c6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwNToxMTowOFrOFrbSaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwNToxMTowOFrOFrbSaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA4MDE2OQ==", "bodyText": "change method name deleteBefore or else better\uff1f", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r381080169", "createdAt": "2020-02-19T05:11:08Z", "author": null, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,191 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import lombok.extern.slf4j.Slf4j;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.apache.skywalking.oap.server.library.util.CollectionUtils;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+/**\n+ * InfluxDB connection maintainer, provides base data write/query API.\n+ */\n+@Slf4j\n+public class InfluxClient implements Client {\n+    private InfluxStorageConfig config;\n+    private InfluxDB influx;\n+\n+    /**\n+     * A constant, the name of time field in Time-series database.\n+     */\n+    public static final String TIME = \"time\";\n+    /**\n+     * A constant, the name of tag of time_bucket.\n+     */\n+    public static final String TAG_TIME_BUCKET = \"_time_bucket\";\n+\n+    private final String database;\n+\n+    public InfluxClient(InfluxStorageConfig config) {\n+        this.config = config;\n+        this.database = config.getDatabase();\n+    }\n+\n+    public final String getDatabase() {\n+        return database;\n+    }\n+\n+    @Override\n+    public void connect() {\n+        influx = InfluxDBFactory.connect(config.getUrl(), config.getUser(), config.getPassword(),\n+                                         new OkHttpClient.Builder().readTimeout(3, TimeUnit.MINUTES)\n+                                                                   .writeTimeout(3, TimeUnit.MINUTES),\n+                                         InfluxDB.ResponseFormat.MSGPACK\n+        );\n+        influx.query(new Query(\"CREATE DATABASE \" + database));\n+\n+        influx.enableBatch(config.getActions(), config.getDuration(), TimeUnit.MILLISECONDS);\n+        influx.setDatabase(database);\n+    }\n+\n+    /**\n+     * To get a connection of InfluxDB.\n+     *\n+     * @return InfluxDB's connection\n+     */\n+    private InfluxDB getInflux() {\n+        return influx;\n+    }\n+\n+    /**\n+     * Execute a query against InfluxDB and return a set of {@link QueryResult.Result}s. Normally, InfluxDB supports\n+     * combining multiple statements into one query, so that we do get multi-results.\n+     *\n+     * @throws IOException if there is an error on the InfluxDB server or communication error.\n+     */\n+    public List<QueryResult.Result> query(Query query) throws IOException {\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"SQL Statement: {}\", query.getCommand());\n+        }\n+\n+        try {\n+            QueryResult result = getInflux().query(query);\n+            if (result.hasError()) {\n+                throw new IOException(result.getError());\n+            }\n+            return result.getResults();\n+        } catch (Exception e) {\n+            throw new IOException(e.getMessage() + System.lineSeparator() + \"SQL Statement: \" + query.getCommand(), e);\n+        }\n+    }\n+\n+    /**\n+     * Execute a query against InfluxDB with a single statement.\n+     *\n+     * @throws IOException if there is an error on the InfluxDB server or communication error\n+     */\n+    public List<QueryResult.Series> queryForSeries(Query query) throws IOException {\n+        List<QueryResult.Result> results = query(query);\n+\n+        if (CollectionUtils.isEmpty(results)) {\n+            return null;\n+        }\n+        return results.get(0).getSeries();\n+    }\n+\n+    /**\n+     * Execute a query against InfluxDB with a single statement but return a single {@link QueryResult.Series}.\n+     *\n+     * @throws IOException if there is an error on the InfluxDB server or communication error\n+     */\n+    public QueryResult.Series queryForSingleSeries(Query query) throws IOException {\n+        List<QueryResult.Series> series = queryForSeries(query);\n+        if (CollectionUtils.isEmpty(series)) {\n+            return null;\n+        }\n+        return series.get(0);\n+    }\n+\n+    /**\n+     * Data management, to drop a time-series by measurement and time-series name specified. If an exception isn't\n+     * thrown, it means execution success. Notice, drop series don't support to drop series by range\n+     *\n+     * @throws IOException if there is an error on the InfluxDB server or communication error\n+     */\n+    public void dropSeries(String measurement, long timeBucket) throws IOException {\n+        Query query = new Query(\"DROP SERIES FROM \" + measurement + \" WHERE time_bucket='\" + timeBucket + \"'\");\n+        QueryResult result = getInflux().query(query);\n+\n+        if (result.hasError()) {\n+            throw new IOException(\"Statement: \" + query.getCommand() + \", ErrorMsg: \" + result.getError());\n+        }\n+    }\n+\n+    public void deleteByQuery(String measurement, long timestamp) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9121be6a56988bb3d606b4239268e953b16f19c6"}, "originalPosition": 154}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwODQ5NzQx", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-360849741", "createdAt": "2020-02-19T05:25:55Z", "commit": {"oid": "9121be6a56988bb3d606b4239268e953b16f19c6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwNToyNTo1NVrOFrbf_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwNToyNTo1NVrOFrbf_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA4MzY0NQ==", "bodyText": "+1 can be deleted\uff1f delete is <", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r381083645", "createdAt": "2020-02-19T05:25:55Z", "author": null, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/HistoryDeleteDAO.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import java.io.IOException;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.CoreModule;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.core.config.ConfigService;\n+import org.apache.skywalking.oap.server.core.storage.IHistoryDeleteDAO;\n+import org.apache.skywalking.oap.server.core.storage.model.Model;\n+import org.apache.skywalking.oap.server.core.storage.ttl.StorageTTL;\n+import org.apache.skywalking.oap.server.core.storage.ttl.TTLCalculator;\n+import org.apache.skywalking.oap.server.library.module.ModuleDefineHolder;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.joda.time.DateTime;\n+\n+@Slf4j\n+public class HistoryDeleteDAO implements IHistoryDeleteDAO {\n+    private final ModuleDefineHolder moduleDefineHolder;\n+    private final InfluxClient client;\n+    private final StorageTTL storageTTL;\n+\n+    public HistoryDeleteDAO(ModuleDefineHolder moduleDefineHolder, InfluxClient client, StorageTTL storageTTL) {\n+        this.moduleDefineHolder = moduleDefineHolder;\n+        this.storageTTL = storageTTL;\n+        this.client = client;\n+    }\n+\n+    @Override\n+    public void deleteHistory(Model model, String timeBucketColumnName) throws IOException {\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"TTL execution log, model: {}\", model.getName());\n+        }\n+        try {\n+            ConfigService configService = moduleDefineHolder.find(CoreModule.NAME)\n+                                                            .provider()\n+                                                            .getService(ConfigService.class);\n+\n+            TTLCalculator ttlCalculator;\n+            if (model.isRecord()) {\n+                ttlCalculator = storageTTL.recordCalculator();\n+            } else {\n+                ttlCalculator = storageTTL.metricsCalculator(model.getDownsampling());\n+            }\n+\n+            client.deleteByQuery(\n+                model.getName(),\n+                TimeBucket.getTimestamp(ttlCalculator.timeBefore(DateTime.now(), configService.getDataTTLConfig()) + 1)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9121be6a56988bb3d606b4239268e953b16f19c6"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwOTI4NTQz", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-360928543", "createdAt": "2020-02-19T08:48:05Z", "commit": {"oid": "9121be6a56988bb3d606b4239268e953b16f19c6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwODo0ODowNlrOFrfcUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwODo0ODowNlrOFrfcUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE0ODI0Mw==", "bodyText": "why this have Nanosecond? or millisecond?", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r381148243", "createdAt": "2020-02-19T08:48:06Z", "author": null, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/NoneStreamDAO.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import java.io.IOException;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.skywalking.apm.commons.datacarrier.common.AtomicRangeInteger;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.core.analysis.config.NoneStream;\n+import org.apache.skywalking.oap.server.core.profile.ProfileTaskRecord;\n+import org.apache.skywalking.oap.server.core.storage.INoneStreamDAO;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.model.Model;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.Point;\n+\n+public class NoneStreamDAO implements INoneStreamDAO {\n+    public static final String TAG_SERVICE_ID = \"_service_id\";\n+    private static final int PADDING_SIZE = 1_000_000;\n+    private static final AtomicRangeInteger SUFFIX = new AtomicRangeInteger(0, PADDING_SIZE);\n+\n+    private InfluxClient client;\n+    private StorageBuilder<NoneStream> storageBuilder;\n+\n+    public NoneStreamDAO(InfluxClient client, StorageBuilder<NoneStream> storageBuilder) {\n+        this.client = client;\n+        this.storageBuilder = storageBuilder;\n+    }\n+\n+    @Override\n+    public void insert(final Model model, final NoneStream noneStream) throws IOException {\n+        final long timestamp = TimeBucket.getTimestamp(\n+            noneStream.getTimeBucket(), model.getDownsampling()) * PADDING_SIZE + SUFFIX.getAndIncrement();\n+\n+        Point point = new InfluxInsertRequest(model, noneStream, storageBuilder)\n+            .time(timestamp, TimeUnit.NANOSECONDS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9121be6a56988bb3d606b4239268e953b16f19c6"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "484e078399f90e2b11d9bc16a83c76bbc1d4921b", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/484e078399f90e2b11d9bc16a83c76bbc1d4921b", "committedDate": "2020-01-15T16:09:13Z", "message": "provide influxdb as a new storage plugin"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNjEyODM0", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-343612834", "createdAt": "2020-01-16T00:39:38Z", "commit": {"oid": "484e078399f90e2b11d9bc16a83c76bbc1d4921b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMDozOTozOFrOFeK2vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMDo0MDoyNlrOFeK3mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE3OTQ1NA==", "bodyText": "This should not be changed in PR.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r367179454", "createdAt": "2020-01-16T00:39:38Z", "author": {"login": "wu-sheng"}, "path": "dist-material/application.yml", "diffHunk": "@@ -120,11 +120,11 @@ storage:\n #    metadataQueryMaxSize: ${SW_STORAGE_ES_QUERY_MAX_SIZE:5000}\n #    segmentQueryMaxSize: ${SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200}\n #    profileTaskQueryMaxSize: ${SW_STORAGE_ES_QUERY_PROFILE_TASK_SIZE:200}\n-  h2:\n-    driver: ${SW_STORAGE_H2_DRIVER:org.h2.jdbcx.JdbcDataSource}\n-    url: ${SW_STORAGE_H2_URL:jdbc:h2:mem:skywalking-oap-db}\n-    user: ${SW_STORAGE_H2_USER:sa}\n-    metadataQueryMaxSize: ${SW_STORAGE_H2_QUERY_MAX_SIZE:5000}\n+#  h2:\n+#    driver: ${SW_STORAGE_H2_DRIVER:org.h2.jdbcx.JdbcDataSource}\n+#    url: ${SW_STORAGE_H2_URL:jdbc:h2:mem:skywalking-oap-db}\n+#    user: ${SW_STORAGE_H2_USER:sa}\n+#    metadataQueryMaxSize: ${SW_STORAGE_H2_QUERY_MAX_SIZE:5000}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "484e078399f90e2b11d9bc16a83c76bbc1d4921b"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE3OTY3NQ==", "bodyText": "You should support to set metadata DB type. Otherwise, you have to link to single one DB implementation.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r367179675", "createdAt": "2020-01-16T00:40:26Z", "author": {"login": "wu-sheng"}, "path": "dist-material/application.yml", "diffHunk": "@@ -135,6 +135,16 @@ storage:\n #      dataSource.prepStmtCacheSqlLimit: ${SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_LIMIT:2048}\n #      dataSource.useServerPrepStmts: ${SW_DATA_SOURCE_USE_SERVER_PREP_STMTS:true}\n #    metadataQueryMaxSize: ${SW_STORAGE_MYSQL_QUERY_MAX_SIZE:5000}\n+  influx:\n+    myDriver: ${SW_STORAGE_MY_DRIVER:org.h2.jdbcx.JdbcDataSource}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "484e078399f90e2b11d9bc16a83c76bbc1d4921b"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MzUzMjkz", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-344353293", "createdAt": "2020-01-17T04:00:48Z", "commit": {"oid": "484e078399f90e2b11d9bc16a83c76bbc1d4921b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwNDowMDo0OFrOFeuTBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwNDowMDo0OFrOFeuTBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc2MDEzNQ==", "bodyText": "myUrl: ${SW_STORAGE_MY_URL:org.h2.jdbcx.JdbcDataSource}\n    myDriver: ${SW_STORAGE_MY_DRIVER:jdbc:h2:mem:skywalking-oap-db}\n\n--->\n    myUrl: ${SW_STORAGE_MY_URL:jdbc:h2:mem:skywalking-oap-db}\n    myDriver: ${SW_STORAGE_MY_DRIVER:org.h2.jdbcx.JdbcDataSource}", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r367760135", "createdAt": "2020-01-17T04:00:48Z", "author": {"login": "JaredTan95"}, "path": "oap-server/server-bootstrap/src/main/resources/application.yml", "diffHunk": "@@ -98,28 +98,37 @@ storage:\n #    segmentQueryMaxSize: ${SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200}\n #    profileTaskQueryMaxSize: ${SW_STORAGE_ES_QUERY_PROFILE_TASK_SIZE:200}\n #    advanced: ${SW_STORAGE_ES_ADVANCED:\"\"}\n-  elasticsearch7:\n-    nameSpace: ${SW_NAMESPACE:\"\"}\n-    clusterNodes: ${SW_STORAGE_ES_CLUSTER_NODES:localhost:9200}\n-    protocol: ${SW_STORAGE_ES_HTTP_PROTOCOL:\"http\"}\n-    #trustStorePath: ${SW_SW_STORAGE_ES_SSL_JKS_PATH:\"../es_keystore.jks\"}\n-    #trustStorePass: ${SW_SW_STORAGE_ES_SSL_JKS_PASS:\"\"}\n-    user: ${SW_ES_USER:\"\"}\n-    password: ${SW_ES_PASSWORD:\"\"}\n-    indexShardsNumber: ${SW_STORAGE_ES_INDEX_SHARDS_NUMBER:2}\n-    indexReplicasNumber: ${SW_STORAGE_ES_INDEX_REPLICAS_NUMBER:0}\n-    # Those data TTL settings will override the same settings in core module.\n-    recordDataTTL: ${SW_STORAGE_ES_RECORD_DATA_TTL:7} # Unit is day\n-    otherMetricsDataTTL: ${SW_STORAGE_ES_OTHER_METRIC_DATA_TTL:45} # Unit is day\n-    monthMetricsDataTTL: ${SW_STORAGE_ES_MONTH_METRIC_DATA_TTL:18} # Unit is month\n-    # Batch process setting, refer to https://www.elastic.co/guide/en/elasticsearch/client/java-api/5.5/java-docs-bulk-processor.html\n-    bulkActions: ${SW_STORAGE_ES_BULK_ACTIONS:1000} # Execute the bulk every 1000 requests\n-    flushInterval: ${SW_STORAGE_ES_FLUSH_INTERVAL:10} # flush the bulk every 10 seconds whatever the number of requests\n-    concurrentRequests: ${SW_STORAGE_ES_CONCURRENT_REQUESTS:2} # the number of concurrent requests\n-    resultWindowMaxSize: ${SW_STORAGE_ES_QUERY_MAX_WINDOW_SIZE:10000}\n-    metadataQueryMaxSize: ${SW_STORAGE_ES_QUERY_MAX_SIZE:5000}\n-    segmentQueryMaxSize: ${SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200}\n-    advanced: ${SW_STORAGE_ES_ADVANCED:\"\"}\n+  influx:\n+    myUrl: ${SW_STORAGE_MY_URL:org.h2.jdbcx.JdbcDataSource}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "484e078399f90e2b11d9bc16a83c76bbc1d4921b"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01338907e2bcab62264a1050311bc7edf18bde0c", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/01338907e2bcab62264a1050311bc7edf18bde0c", "committedDate": "2020-01-18T13:48:18Z", "message": "Introduct MySQL as an optional to store Metadata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17261eac4f9589a5f8b496e9ad71f968dc517a6e", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/17261eac4f9589a5f8b496e9ad71f968dc517a6e", "committedDate": "2020-01-18T14:13:27Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e654eda3d9e30e5af385e0bf320f3865e0f89626", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/e654eda3d9e30e5af385e0bf320f3865e0f89626", "committedDate": "2020-01-18T19:12:28Z", "message": "Implement DAO of ProfileTask"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTY5NTI3", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-344969527", "createdAt": "2020-01-19T00:46:07Z", "commit": {"oid": "e654eda3d9e30e5af385e0bf320f3865e0f89626"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQwMDo0NjowOFrOFfMogQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQwMDo0NjowOFrOFfMogQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI1NzE1Mw==", "bodyText": "INoneStreamDAO is used for web interactive job, such as @mrproliu 's profiling task. Basically, this should have little data. Is the influxDB suitable for this?", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r368257153", "createdAt": "2020-01-19T00:46:08Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/InfluxStorageDAO.java", "diffHunk": "@@ -53,6 +53,6 @@ public IRecordDAO newRecordDao(StorageBuilder<Record> storageBuilder) {\n \n     @Override\n     public INoneStreamDAO newNoneStreamDao(StorageBuilder<NoneStream> storageBuilder) {\n-        return new NoneStreamDAO();\n+        return new NoneStreamDAO(influxClient, storageBuilder);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e654eda3d9e30e5af385e0bf320f3865e0f89626"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a879e22e007d608d44fa9b3ee9d7fbc86a07032e", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/a879e22e007d608d44fa9b3ee9d7fbc86a07032e", "committedDate": "2020-01-19T03:39:47Z", "message": "Store NoneStream in RMDB"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd5f94cbef14b6b585867106c225c0c3d34af12e", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/fd5f94cbef14b6b585867106c225c0c3d34af12e", "committedDate": "2020-01-29T19:39:50Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ae4263f3fd6a40ad9d356ea6adfe905dcb83c41", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/3ae4263f3fd6a40ad9d356ea6adfe905dcb83c41", "committedDate": "2020-02-01T14:43:27Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16de42f8a311d046cf44e174c69bea7d0c150887", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/16de42f8a311d046cf44e174c69bea7d0c150887", "committedDate": "2020-02-01T15:40:09Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08e7859dcae6393a6f8695a68c785d299a23598b", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/08e7859dcae6393a6f8695a68c785d299a23598b", "committedDate": "2020-02-01T15:47:38Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63aafad4e2ca3707a2660b54683d35c6389309c9", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/63aafad4e2ca3707a2660b54683d35c6389309c9", "committedDate": "2020-02-01T16:40:31Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11e829e4516041f2386872abdde8582c80ee5efd", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/11e829e4516041f2386872abdde8582c80ee5efd", "committedDate": "2020-02-02T10:05:24Z", "message": "update Licenes/Dependencies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d36fccc74f4ea46b1e61ef0821da595b289084e", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/8d36fccc74f4ea46b1e61ef0821da595b289084e", "committedDate": "2020-02-02T18:03:14Z", "message": "TTL instead of RetentionPolicy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "296bbaf5663b8ef5eec839a48dd6f778d065de72", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/296bbaf5663b8ef5eec839a48dd6f778d065de72", "committedDate": "2020-02-02T18:08:06Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b0267919de78aac31e8ffd8e15a638a3e3a3c6e", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/4b0267919de78aac31e8ffd8e15a638a3e3a3c6e", "committedDate": "2020-02-02T18:44:18Z", "message": "polish"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTg4NTQw", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-351988540", "createdAt": "2020-02-03T01:39:55Z", "commit": {"oid": "8d36fccc74f4ea46b1e61ef0821da595b289084e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwMTozOTo1NVrOFkkxTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwMTozOTo1NVrOFkkxTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzg5NTUwMA==", "bodyText": "As MIT license you don't need to update NOTICE. NOTICE is for Apache 2.0 only. Please remove this part.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r373895500", "createdAt": "2020-02-03T01:39:55Z", "author": {"login": "wu-sheng"}, "path": "dist-material/release-docs/NOTICE", "diffHunk": "@@ -905,4 +905,31 @@ be obtained at:\n   * HOMEPAGE:\n     * https://github.com/catapult-project/catapult\n \n+------\n+\n+===========================================================================", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d36fccc74f4ea46b1e61ef0821da595b289084e"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ce9dbe0d384ede33ebacd0b3b075a39da71f641", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/0ce9dbe0d384ede33ebacd0b3b075a39da71f641", "committedDate": "2020-02-03T06:13:19Z", "message": "fix bug and fix License"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e09bd70bb138ad77ef47389df60ab62f950fbd79", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/e09bd70bb138ad77ef47389df60ab62f950fbd79", "committedDate": "2020-02-03T06:24:04Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a014dfce71d86d77f6abf48fd1581526278c7e80", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/a014dfce71d86d77f6abf48fd1581526278c7e80", "committedDate": "2020-02-03T06:24:58Z", "message": "merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bdc09dbf541fbeb7a4366d42baeb0624657e98d", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/6bdc09dbf541fbeb7a4366d42baeb0624657e98d", "committedDate": "2020-02-03T06:27:29Z", "message": "revert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9128aec8aff64b68c151a710f36728fa6a1dccbf", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/9128aec8aff64b68c151a710f36728fa6a1dccbf", "committedDate": "2020-02-03T06:52:37Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMDY2NDAx", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-352066401", "createdAt": "2020-02-03T07:50:41Z", "commit": {"oid": "9128aec8aff64b68c151a710f36728fa6a1dccbf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNzo1MDo0MlrOFkoonw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNzo1MDo0MlrOFkoonw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk1ODgxNQ==", "bodyText": "If these are using the as same unit as the core module, you shouldn't add them. You could use the core's.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r373958815", "createdAt": "2020-02-03T07:50:42Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-bootstrap/src/main/resources/application.yml", "diffHunk": "@@ -146,6 +146,11 @@ storage:\n #    password: ${SW_STORAGE_PASSWORD:}\n #    database: ${SW_STORAGE_DATABASE:skywalking}\n #    metadataQueryMaxSize: ${SW_STORAGE_H2_QUERY_MAX_SIZE:5000}\n+#    recordDataTTL: ${SW_STORAGE_RECORD_DATA_TTL:7} # keeps 7 days\n+#    minuteMetricsDataTTL: ${SW_STORAGE_MINUTE_METRICS_DATA_TTL:64800} # Unit is minute, keeps 45 days\n+#    hourMetricsDataTTL: ${SW_STORAGE_HOUR_METRICS_DATA_TTL:1080} # Unit is hour, keeps 45 days\n+#    dayMetricsDataTTL: ${SW_STORAGE_DAY_METRICS_DATA_TTL:45} # Unit is day, keeps 45 days\n+#    monthMetricsDataTTL: ${SW_STORAGE_MONTH_METRICS_DATA_TTL:18} # Unit is month, keeps 18 months", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9128aec8aff64b68c151a710f36728fa6a1dccbf"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74d6e4d685e3107516fb2092c1ca6fe536e1a8fc", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/74d6e4d685e3107516fb2092c1ca6fe536e1a8fc", "committedDate": "2020-02-03T16:14:13Z", "message": "remove TTL configuration from yaml & select fields only"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffd4b9f8ce8cd7dd6c8b423871797e3f993cc1f7", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/ffd4b9f8ce8cd7dd6c8b423871797e3f993cc1f7", "committedDate": "2020-02-03T16:15:56Z", "message": "add e2e test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b374a246780aa8f3b274a20ae36fb5e3c831adea", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/b374a246780aa8f3b274a20ae36fb5e3c831adea", "committedDate": "2020-02-03T16:50:27Z", "message": "enable e2e-influxdb action"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6e28343f2e1a09a941618eb91bfdb0f4d7ab7f1", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/f6e28343f2e1a09a941618eb91bfdb0f4d7ab7f1", "committedDate": "2020-02-03T17:12:14Z", "message": "revert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fdc886985a49f579dd6ede647533cca2f6c8d2d", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/9fdc886985a49f579dd6ede647533cca2f6c8d2d", "committedDate": "2020-02-03T18:59:57Z", "message": "confuse"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/f06435eb514cf47cc90741c475502b28b31aab03", "committedDate": "2020-02-04T09:49:56Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyODc5MDAz", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-352879003", "createdAt": "2020-02-04T10:44:28Z", "commit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxMDo0NDoyOFrOFlPmOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxMTo0NTowMFrOFlRMsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU5NzE3OQ==", "bodyText": "I don't really recommend to use this kind of codes to get the current class just for logging, java.lang.invoke.MethodHandles#lookup creates new object for every call, which I don't think is necessary, and if you are trying to avoid \"copy-and-paste\" mistakes, why not just use the @Slf4j annotation of Lombok, WDYT @wu-sheng", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374597179", "createdAt": "2020-02-04T10:44:28Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.util.List;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+public class InfluxClient implements Client {\n+    private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU5ODk2Nw==", "bodyText": "why does influx plugin depend on ElasticSearch plugin", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374598967", "createdAt": "2020-02-04T10:48:04Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/pom.xml", "diffHunk": "@@ -0,0 +1,50 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Licensed to the Apache Software Foundation (ASF) under one or more\n+  ~ contributor license agreements.  See the NOTICE file distributed with\n+  ~ this work for additional information regarding copyright ownership.\n+  ~ The ASF licenses this file to You under the Apache License, Version 2.0\n+  ~ (the \"License\"); you may not use this file except in compliance with\n+  ~ the License.  You may obtain a copy of the License at\n+  ~\n+  ~     http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  ~ See the License for the specrm ific language governing permissions and\n+  ~ limitations under the License.\n+  ~\n+  -->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>server-storage-plugin</artifactId>\n+        <groupId>org.apache.skywalking</groupId>\n+        <version>7.0.0-SNAPSHOT</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>storage-influxdb-plugin</artifactId>\n+    <packaging>jar</packaging>\n+\n+    <dependencies>\n+        <dependency>\n+            <groupId>org.apache.skywalking</groupId>\n+            <artifactId>storage-elasticsearch-plugin</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYwMTg5MA==", "bodyText": "As private methods cannot be meaningfully overridden, declaring them final is redundant.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374601890", "createdAt": "2020-02-04T10:54:10Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/query/AggregationQuery.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.query;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.query.entity.Order;\n+import org.apache.skywalking.oap.server.core.query.entity.TopNEntity;\n+import org.apache.skywalking.oap.server.core.register.EndpointInventory;\n+import org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory;\n+import org.apache.skywalking.oap.server.core.storage.model.ModelName;\n+import org.apache.skywalking.oap.server.core.storage.query.IAggregationQueryDAO;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.SelectQueryImpl;\n+import org.influxdb.querybuilder.SelectSubQueryImpl;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.List;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.*;\n+\n+public class AggregationQuery implements IAggregationQueryDAO {\n+    private static final Logger LOG = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+    private final InfluxClient client;\n+\n+    public AggregationQuery(InfluxClient client) {\n+        this.client = client;\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getServiceTopN(String indName, String valueCName, int topN, Downsampling downsampling,\n+                                           long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(downsampling, indName, subQuery(indName, valueCName, startTB, endTB), order, topN);\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getAllServiceInstanceTopN(String indName, String valueCName, int topN, Downsampling downsampling,\n+                                                      long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(downsampling, indName, subQuery(indName, valueCName, startTB, endTB), order, topN);\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getServiceInstanceTopN(int serviceId, String indName, String valueCName, int topN, Downsampling downsampling,\n+                                                   long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(downsampling, indName, subQuery(ServiceInstanceInventory.SERVICE_ID, serviceId, indName, valueCName, startTB, endTB), order, topN);\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getAllEndpointTopN(String indName, String valueCName, int topN, Downsampling downsampling,\n+                                               long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(downsampling, indName, subQuery(indName, valueCName, startTB, endTB), order, topN);\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getEndpointTopN(int serviceId, String indName, String valueCName, int topN, Downsampling downsampling,\n+                                            long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(downsampling, indName, subQuery(EndpointInventory.SERVICE_ID, serviceId, indName, valueCName, startTB, endTB), order, topN);\n+    }\n+\n+    private final List<TopNEntity> getTopNEntity(Downsampling downsampling, String name, SelectSubQueryImpl<SelectQueryImpl> subQuery, Order order, int topN) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYxMTA2OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # Modify application.yml to set MySQL as storage provider.\n          \n          \n            \n            # Modify application.yml to set InfluxDB as storage provider.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374611069", "createdAt": "2020-02-04T11:14:34Z", "author": {"login": "kezhenxu94"}, "path": "test/e2e/e2e-influxdb/src/docker/rc.d/rc0-prepare.sh", "diffHunk": "@@ -0,0 +1,21 @@\n+#!/usr/bin/env bash\n+# Licensed to the SkyAPM under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+echo \"InfluxDB with H2 database is storage provider...\"\n+\n+# Modify application.yml to set MySQL as storage provider.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYxMTI5Ng==", "bodyText": "remove the @authors please", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374611296", "createdAt": "2020-02-04T11:15:07Z", "author": {"login": "kezhenxu94"}, "path": "test/e2e/e2e-influxdb/src/main/java/org/apache/skywalking/e2e/sample/client/SampleClientApplication.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.e2e.sample.client;\n+\n+import org.springframework.boot.SpringApplication;\n+import org.springframework.boot.autoconfigure.SpringBootApplication;\n+import org.springframework.data.jpa.repository.config.EnableJpaRepositories;\n+\n+/**\n+ * @author kezhenxu94\n+ */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYxMjU3MQ==", "bodyText": "why add unused method", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374612571", "createdAt": "2020-02-04T11:18:06Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/storage/model/Model.java", "diffHunk": "@@ -44,5 +48,11 @@ public Model(String name, List<ModelColumn> columns, boolean capableOfTimeSeries\n         this.scopeId = scopeId;\n         this.name = ModelName.build(downsampling, name);\n         this.record = record;\n+        this.storageColumns = Maps.newTreeMap();\n+        columns.forEach(column -> { storageColumns.put(column.getColumnName().getStorageName(), column); });\n+    }\n+\n+    public ModelColumn getColumnByStorageCName(String storageCName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYxOTAwMw==", "bodyText": "make it a property", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374619003", "createdAt": "2020-02-04T11:33:57Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/pom.xml", "diffHunk": "@@ -0,0 +1,50 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Licensed to the Apache Software Foundation (ASF) under one or more\n+  ~ contributor license agreements.  See the NOTICE file distributed with\n+  ~ this work for additional information regarding copyright ownership.\n+  ~ The ASF licenses this file to You under the Apache License, Version 2.0\n+  ~ (the \"License\"); you may not use this file except in compliance with\n+  ~ the License.  You may obtain a copy of the License at\n+  ~\n+  ~     http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  ~ See the License for the specrm ific language governing permissions and\n+  ~ limitations under the License.\n+  ~\n+  -->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>server-storage-plugin</artifactId>\n+        <groupId>org.apache.skywalking</groupId>\n+        <version>7.0.0-SNAPSHOT</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>storage-influxdb-plugin</artifactId>\n+    <packaging>jar</packaging>\n+\n+    <dependencies>\n+        <dependency>\n+            <groupId>org.apache.skywalking</groupId>\n+            <artifactId>storage-elasticsearch-plugin</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+\n+        <dependency>\n+            <groupId>org.apache.skywalking</groupId>\n+            <artifactId>storage-jdbc-hikaricp-plugin</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+\n+        <dependency>\n+            <groupId>org.influxdb</groupId>\n+            <artifactId>influxdb-java</artifactId>\n+            <version>2.15</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYxOTY1Nw==", "bodyText": "use System.lineSeparator() instead of hardcoded \\r\\n", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374619657", "createdAt": "2020-02-04T11:35:39Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.util.List;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+public class InfluxClient implements Client {\n+    private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+    private InfluxStorageConfig config;\n+    private InfluxDB influx;\n+\n+    public static final String TIME = \"time\";\n+    public static final String TAG_ENTITY_ID = \"entity_id\";\n+    private final String database;\n+\n+    public InfluxClient(InfluxStorageConfig config) {\n+        this.config = config;\n+        this.database = config.getDatabase();\n+    }\n+\n+    public final String getDatabase() {\n+        return database;\n+    }\n+\n+    @Override\n+    public void connect() {\n+        influx = InfluxDBFactory.connect(config.getUrl(), config.getUser(), config.getPassword(),\n+            new OkHttpClient.Builder(), InfluxDB.ResponseFormat.MSGPACK);\n+        influx.query(new Query(\"CREATE DATABASE \" + database));\n+\n+        influx.setDatabase(database);\n+        influx.enableBatch();\n+    }\n+\n+    public InfluxDB getInflux() {\n+        return influx;\n+    }\n+\n+    public List<QueryResult.Result> query(Query query) throws IOException {\n+        if (logger.isDebugEnabled()) {\n+            logger.debug(\"SQL Statement: {}\", query.getCommand());\n+        }\n+\n+        try {\n+            QueryResult result = getInflux().query(query);\n+            if (result.hasError()) {\n+                throw new IOException(result.getError());\n+            }\n+            return result.getResults();\n+        } catch (Exception e) {\n+            throw new IOException(e.getMessage() + \"\\r\\nSQL Statement: \" + query.getCommand(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYyMzQxMA==", "bodyText": "Raw use of parameterized class WhereQueryImpl", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374623410", "createdAt": "2020-02-04T11:45:00Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/MetricsDAO.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Maps;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.storage.IMetricsDAO;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.model.Model;\n+import org.apache.skywalking.oap.server.core.storage.model.ModelColumn;\n+import org.apache.skywalking.oap.server.core.storage.type.StorageDataType;\n+import org.apache.skywalking.oap.server.library.client.request.InsertRequest;\n+import org.apache.skywalking.oap.server.library.client.request.UpdateRequest;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.WhereQueryImpl;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.contains;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.select;\n+\n+public class MetricsDAO implements IMetricsDAO {\n+    private final StorageBuilder<Metrics> storageBuilder;\n+    private final InfluxClient client;\n+\n+    public MetricsDAO(InfluxClient client, StorageBuilder<Metrics> storageBuilder) {\n+        this.client = client;\n+        this.storageBuilder = storageBuilder;\n+    }\n+\n+    @Override\n+    public List<Metrics> multiGet(Model model, List<String> ids) throws IOException {\n+        WhereQueryImpl query = select(\"*::field\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyOTM2Nzg2", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-352936786", "createdAt": "2020-02-04T12:27:33Z", "commit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxMjoyNzozM1rOFlSRwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxMzowNzo1NlrOFlTX1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0MTA4OQ==", "bodyText": "All these dependencies licenses should be checked and LICENSE file should be updated(NOTICE should be update if the license is Apache 2.0 and there is a NOTICE existing).", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374641089", "createdAt": "2020-02-04T12:27:33Z", "author": {"login": "wu-sheng"}, "path": "tools/dependencies/known-oap-backend-dependencies-es7.txt", "diffHunk": "@@ -159,3 +159,8 @@ sundr-core-0.9.2.jar\n swagger-annotations-1.5.12.jar\n t-digest-3.2.jar\n zookeeper-3.4.10.jar\n+converter-moshi-2.5.0.jar\n+influxdb-java-2.15.jar\n+logging-interceptor-3.13.1.jar\n+moshi-1.5.0.jar\n+msgpack-core-0.8.16.jar", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0MjEyOA==", "bodyText": "There is GeneralStorageTTL existing, the influxdb implementation should be as same as that one, since it also uses the core configuration.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374642128", "createdAt": "2020-02-04T12:29:59Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxTTLCalculatorProvider.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import org.apache.skywalking.oap.server.core.DataTTLConfig;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.library.module.ModuleDefineHolder;\n+import org.joda.time.DateTime;\n+\n+public class InfluxTTLCalculatorProvider {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY1MzY2NA==", "bodyText": "This class should not change and not relate to this PR, please revert.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374653664", "createdAt": "2020-02-04T12:55:31Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/metrics/Metrics.java", "diffHunk": "@@ -32,8 +35,13 @@\n     public static final String TIME_BUCKET = \"time_bucket\";\n     public static final String ENTITY_ID = \"entity_id\";\n \n-    @Getter @Setter @Column(columnName = TIME_BUCKET) private long timeBucket;\n-    @Getter @Setter private long survivalTime = 0L;\n+    @Getter\n+    @Setter\n+    @Column(columnName = TIME_BUCKET)\n+    private long timeBucket;\n+    @Getter\n+    @Setter\n+    private long survivalTime = 0L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY1NDMwNQ==", "bodyText": "Including all following changes of this class.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374654305", "createdAt": "2020-02-04T12:56:57Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/metrics/Metrics.java", "diffHunk": "@@ -32,8 +35,13 @@\n     public static final String TIME_BUCKET = \"time_bucket\";\n     public static final String ENTITY_ID = \"entity_id\";\n \n-    @Getter @Setter @Column(columnName = TIME_BUCKET) private long timeBucket;\n-    @Getter @Setter private long survivalTime = 0L;\n+    @Getter\n+    @Setter\n+    @Column(columnName = TIME_BUCKET)\n+    private long timeBucket;\n+    @Getter\n+    @Setter\n+    private long survivalTime = 0L;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY1MzY2NA=="}, "originalCommit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY1NDYyMA==", "bodyText": "This should not be added.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374654620", "createdAt": "2020-02-04T12:57:41Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/storage/model/Model.java", "diffHunk": "@@ -35,6 +38,7 @@\n     private final List<ModelColumn> columns;\n     private final int scopeId;\n     private final boolean record;\n+    private final TreeMap<String, ModelColumn> storageColumns;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY1NDg2OQ==", "bodyText": "This file format seems not right.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374654869", "createdAt": "2020-02-04T12:58:14Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/BatchDAO.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import org.apache.skywalking.apm.commons.datacarrier.DataCarrier;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.BulkConsumePool;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.ConsumerPoolFactory;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.IConsumer;\n+import org.apache.skywalking.oap.server.core.UnexpectedException;\n+import org.apache.skywalking.oap.server.core.storage.IBatchDAO;\n+import org.apache.skywalking.oap.server.library.client.request.InsertRequest;\n+import org.apache.skywalking.oap.server.library.client.request.PrepareRequest;\n+import org.apache.skywalking.oap.server.library.util.CollectionUtils;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.BatchPoints;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.List;\n+\n+public class  BatchDAO implements IBatchDAO {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY1OTAyOA==", "bodyText": "This shouldn't be changed. If start in IDE, we keep in ES", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r374659028", "createdAt": "2020-02-04T13:07:56Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-bootstrap/src/main/resources/application.yml", "diffHunk": "@@ -98,33 +98,33 @@ storage:\n #    segmentQueryMaxSize: ${SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200}\n #    profileTaskQueryMaxSize: ${SW_STORAGE_ES_QUERY_PROFILE_TASK_SIZE:200}\n #    advanced: ${SW_STORAGE_ES_ADVANCED:\"\"}\n-  elasticsearch7:\n-    nameSpace: ${SW_NAMESPACE:\"\"}\n-    clusterNodes: ${SW_STORAGE_ES_CLUSTER_NODES:localhost:9200}\n-    protocol: ${SW_STORAGE_ES_HTTP_PROTOCOL:\"http\"}\n-    #trustStorePath: ${SW_SW_STORAGE_ES_SSL_JKS_PATH:\"../es_keystore.jks\"}\n-    #trustStorePass: ${SW_SW_STORAGE_ES_SSL_JKS_PASS:\"\"}\n-    user: ${SW_ES_USER:\"\"}\n-    password: ${SW_ES_PASSWORD:\"\"}\n-    indexShardsNumber: ${SW_STORAGE_ES_INDEX_SHARDS_NUMBER:2}\n-    indexReplicasNumber: ${SW_STORAGE_ES_INDEX_REPLICAS_NUMBER:0}\n-    # Those data TTL settings will override the same settings in core module.\n-    recordDataTTL: ${SW_STORAGE_ES_RECORD_DATA_TTL:7} # Unit is day\n-    otherMetricsDataTTL: ${SW_STORAGE_ES_OTHER_METRIC_DATA_TTL:45} # Unit is day\n-    monthMetricsDataTTL: ${SW_STORAGE_ES_MONTH_METRIC_DATA_TTL:18} # Unit is month\n-    # Batch process setting, refer to https://www.elastic.co/guide/en/elasticsearch/client/java-api/5.5/java-docs-bulk-processor.html\n-    bulkActions: ${SW_STORAGE_ES_BULK_ACTIONS:1000} # Execute the bulk every 1000 requests\n-    flushInterval: ${SW_STORAGE_ES_FLUSH_INTERVAL:10} # flush the bulk every 10 seconds whatever the number of requests\n-    concurrentRequests: ${SW_STORAGE_ES_CONCURRENT_REQUESTS:2} # the number of concurrent requests\n-    resultWindowMaxSize: ${SW_STORAGE_ES_QUERY_MAX_WINDOW_SIZE:10000}\n-    metadataQueryMaxSize: ${SW_STORAGE_ES_QUERY_MAX_SIZE:5000}\n-    segmentQueryMaxSize: ${SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200}\n-    advanced: ${SW_STORAGE_ES_ADVANCED:\"\"}\n-#  h2:\n-#    driver: ${SW_STORAGE_H2_DRIVER:org.h2.jdbcx.JdbcDataSource}\n-#    url: ${SW_STORAGE_H2_URL:jdbc:h2:mem:skywalking-oap-db}\n-#    user: ${SW_STORAGE_H2_USER:sa}\n-#    metadataQueryMaxSize: ${SW_STORAGE_H2_QUERY_MAX_SIZE:5000}\n+#  elasticsearch7:\n+#    nameSpace: ${SW_NAMESPACE:\"\"}\n+#    clusterNodes: ${SW_STORAGE_ES_CLUSTER_NODES:localhost:9200}\n+#    protocol: ${SW_STORAGE_ES_HTTP_PROTOCOL:\"http\"}\n+#    #trustStorePath: ${SW_SW_STORAGE_ES_SSL_JKS_PATH:\"../es_keystore.jks\"}\n+#    #trustStorePass: ${SW_SW_STORAGE_ES_SSL_JKS_PASS:\"\"}\n+#    user: ${SW_ES_USER:\"\"}\n+#    password: ${SW_ES_PASSWORD:\"\"}\n+#    indexShardsNumber: ${SW_STORAGE_ES_INDEX_SHARDS_NUMBER:2}\n+#    indexReplicasNumber: ${SW_STORAGE_ES_INDEX_REPLICAS_NUMBER:0}\n+#    # Those data TTL settings will override the same settings in core module.\n+#    recordDataTTL: ${SW_STORAGE_ES_RECORD_DATA_TTL:7} # Unit is day\n+#    otherMetricsDataTTL: ${SW_STORAGE_ES_OTHER_METRIC_DATA_TTL:45} # Unit is day\n+#    monthMetricsDataTTL: ${SW_STORAGE_ES_MONTH_METRIC_DATA_TTL:18} # Unit is month\n+#    # Batch process setting, refer to https://www.elastic.co/guide/en/elasticsearch/client/java-api/5.5/java-docs-bulk-processor.html\n+#    bulkActions: ${SW_STORAGE_ES_BULK_ACTIONS:1000} # Execute the bulk every 1000 requests\n+#    flushInterval: ${SW_STORAGE_ES_FLUSH_INTERVAL:10} # flush the bulk every 10 seconds whatever the number of requests\n+#    concurrentRequests: ${SW_STORAGE_ES_CONCURRENT_REQUESTS:2} # the number of concurrent requests\n+#    resultWindowMaxSize: ${SW_STORAGE_ES_QUERY_MAX_WINDOW_SIZE:10000}\n+#    metadataQueryMaxSize: ${SW_STORAGE_ES_QUERY_MAX_SIZE:5000}\n+#    segmentQueryMaxSize: ${SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200}\n+#    advanced: ${SW_STORAGE_ES_ADVANCED:\"\"}\n+  h2:\n+    driver: ${SW_STORAGE_H2_DRIVER:org.h2.jdbcx.JdbcDataSource}\n+    url: ${SW_STORAGE_H2_URL:jdbc:h2:mem:skywalking-oap-db}\n+    user: ${SW_STORAGE_H2_USER:sa}\n+    metadataQueryMaxSize: ${SW_STORAGE_H2_QUERY_MAX_SIZE:5000}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06435eb514cf47cc90741c475502b28b31aab03"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ec7039d5ae450b2c9291a2646f607fff6357c37", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/9ec7039d5ae450b2c9291a2646f607fff6357c37", "committedDate": "2020-02-04T14:33:08Z", "message": "Update test/e2e/e2e-influxdb/src/docker/rc.d/rc0-prepare.sh\n\nCo-Authored-By: kezhenxu94 <kezhenxu94@163.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58587c88ce1e34be64ff2b418afda02bc1cfa5ca", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/58587c88ce1e34be64ff2b418afda02bc1cfa5ca", "committedDate": "2020-02-04T14:37:07Z", "message": "fix things as reviewer's comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55f57e51d9c204c2f4dabb70a93bf73cb21a68a8", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/55f57e51d9c204c2f4dabb70a93bf73cb21a68a8", "committedDate": "2020-02-05T04:21:31Z", "message": "update license"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNDgxNjcy", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-353481672", "createdAt": "2020-02-05T05:59:33Z", "commit": {"oid": "58587c88ce1e34be64ff2b418afda02bc1cfa5ca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwNTo1OTozNFrOFlslaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwNTo1OTozNFrOFlslaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA3MjEwNQ==", "bodyText": "These formats are still changed.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375072105", "createdAt": "2020-02-05T05:59:34Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-bootstrap/src/main/resources/application.yml", "diffHunk": "@@ -75,29 +75,29 @@ core:\n     enableDatabaseSession: ${SW_CORE_ENABLE_DATABASE_SESSION:true}\n     topNReportPeriod: ${SW_CORE_TOPN_REPORT_PERIOD:10} # top_n record worker report cycle, unit is minute\n storage:\n-#  elasticsearch:\n-#    nameSpace: ${SW_NAMESPACE:\"\"}\n-#    clusterNodes: ${SW_STORAGE_ES_CLUSTER_NODES:localhost:9200}\n-#    protocol: ${SW_STORAGE_ES_HTTP_PROTOCOL:\"http\"}\n-#    #trustStorePath: ${SW_SW_STORAGE_ES_SSL_JKS_PATH:\"../es_keystore.jks\"}\n-#    #trustStorePass: ${SW_SW_STORAGE_ES_SSL_JKS_PASS:\"\"}\n-#    user: ${SW_ES_USER:\"\"}\n-#    password: ${SW_ES_PASSWORD:\"\"}\n-#    indexShardsNumber: ${SW_STORAGE_ES_INDEX_SHARDS_NUMBER:2}\n-#    indexReplicasNumber: ${SW_STORAGE_ES_INDEX_REPLICAS_NUMBER:0}\n-#    # Those data TTL settings will override the same settings in core module.\n-#    recordDataTTL: ${SW_STORAGE_ES_RECORD_DATA_TTL:7} # Unit is day\n-#    otherMetricsDataTTL: ${SW_STORAGE_ES_OTHER_METRIC_DATA_TTL:45} # Unit is day\n-#    monthMetricsDataTTL: ${SW_STORAGE_ES_MONTH_METRIC_DATA_TTL:18} # Unit is month\n-#    # Batch process setting, refer to https://www.elastic.co/guide/en/elasticsearch/client/java-api/5.5/java-docs-bulk-processor.html\n-#    bulkActions: ${SW_STORAGE_ES_BULK_ACTIONS:1000} # Execute the bulk every 1000 requests\n-#    flushInterval: ${SW_STORAGE_ES_FLUSH_INTERVAL:10} # flush the bulk every 10 seconds whatever the number of requests\n-#    concurrentRequests: ${SW_STORAGE_ES_CONCURRENT_REQUESTS:2} # the number of concurrent requests\n-#    resultWindowMaxSize: ${SW_STORAGE_ES_QUERY_MAX_WINDOW_SIZE:10000}\n-#    metadataQueryMaxSize: ${SW_STORAGE_ES_QUERY_MAX_SIZE:5000}\n-#    segmentQueryMaxSize: ${SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200}\n-#    profileTaskQueryMaxSize: ${SW_STORAGE_ES_QUERY_PROFILE_TASK_SIZE:200}\n-#    advanced: ${SW_STORAGE_ES_ADVANCED:\"\"}\n+  #  elasticsearch:\n+  #    nameSpace: ${SW_NAMESPACE:\"\"}\n+  #    clusterNodes: ${SW_STORAGE_ES_CLUSTER_NODES:localhost:9200}\n+  #    protocol: ${SW_STORAGE_ES_HTTP_PROTOCOL:\"http\"}\n+  #    #trustStorePath: ${SW_SW_STORAGE_ES_SSL_JKS_PATH:\"../es_keystore.jks\"}\n+  #    #trustStorePass: ${SW_SW_STORAGE_ES_SSL_JKS_PASS:\"\"}\n+  #    user: ${SW_ES_USER:\"\"}\n+  #    password: ${SW_ES_PASSWORD:\"\"}\n+  #    indexShardsNumber: ${SW_STORAGE_ES_INDEX_SHARDS_NUMBER:2}\n+  #    indexReplicasNumber: ${SW_STORAGE_ES_INDEX_REPLICAS_NUMBER:0}\n+  #    # Those data TTL settings will override the same settings in core module.\n+  #    recordDataTTL: ${SW_STORAGE_ES_RECORD_DATA_TTL:7} # Unit is day\n+  #    otherMetricsDataTTL: ${SW_STORAGE_ES_OTHER_METRIC_DATA_TTL:45} # Unit is day\n+  #    monthMetricsDataTTL: ${SW_STORAGE_ES_MONTH_METRIC_DATA_TTL:18} # Unit is month\n+  #    # Batch process setting, refer to https://www.elastic.co/guide/en/elasticsearch/client/java-api/5.5/java-docs-bulk-processor.html\n+  #    bulkActions: ${SW_STORAGE_ES_BULK_ACTIONS:1000} # Execute the bulk every 1000 requests\n+  #    flushInterval: ${SW_STORAGE_ES_FLUSH_INTERVAL:10} # flush the bulk every 10 seconds whatever the number of requests\n+  #    concurrentRequests: ${SW_STORAGE_ES_CONCURRENT_REQUESTS:2} # the number of concurrent requests\n+  #    resultWindowMaxSize: ${SW_STORAGE_ES_QUERY_MAX_WINDOW_SIZE:10000}\n+  #    metadataQueryMaxSize: ${SW_STORAGE_ES_QUERY_MAX_SIZE:5000}\n+  #    segmentQueryMaxSize: ${SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200}\n+  #    profileTaskQueryMaxSize: ${SW_STORAGE_ES_QUERY_PROFILE_TASK_SIZE:200}\n+  #    advanced: ${SW_STORAGE_ES_ADVANCED:\"\"}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58587c88ce1e34be64ff2b418afda02bc1cfa5ca"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edea319291658a911b12e18764302ede55c97a43", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/edea319291658a911b12e18764302ede55c97a43", "committedDate": "2020-02-05T07:51:13Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf641a814c65ff2daa7067c2526d480bfd51c83d", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/bf641a814c65ff2daa7067c2526d480bfd51c83d", "committedDate": "2020-02-05T07:53:09Z", "message": "fix things as review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "748dce814b1567ec1d1d5878de91b2891e7a75b7", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/748dce814b1567ec1d1d5878de91b2891e7a75b7", "committedDate": "2020-02-05T07:54:10Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1b2860ea6168656f4ac2a4dc03fa03a862a5d6c", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/d1b2860ea6168656f4ac2a4dc03fa03a862a5d6c", "committedDate": "2020-02-05T08:24:13Z", "message": "add document for configure && update configuration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNTM4MDU4", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-353538058", "createdAt": "2020-02-05T08:34:41Z", "commit": {"oid": "748dce814b1567ec1d1d5878de91b2891e7a75b7"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwODozNDo0MVrOFlvYJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwODo0NjoyNVrOFlvrzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTExNzg2MQ==", "bodyText": "Empty comment?", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375117861", "createdAt": "2020-02-05T08:34:41Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,194 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.util.List;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+/**\n+ *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "748dce814b1567ec1d1d5878de91b2891e7a75b7"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTExODY0OA==", "bodyText": "What does this #get(0) represent?", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375118648", "createdAt": "2020-02-05T08:36:35Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,194 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.util.List;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+/**\n+ *\n+ */\n+public class InfluxClient implements Client {\n+    private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+    private InfluxStorageConfig config;\n+    private InfluxDB influx;\n+\n+    /**\n+     * A constant, the name of time field in Time-series database.\n+     */\n+    public static final String TIME = \"time\";\n+    /**\n+     * A constant, the name of tag.\n+     */\n+    public static final String TAG_ENTITY_ID = \"entity_id\";\n+\n+    private final String database;\n+\n+    public InfluxClient(InfluxStorageConfig config) {\n+        this.config = config;\n+        this.database = config.getDatabase();\n+    }\n+\n+    public final String getDatabase() {\n+        return database;\n+    }\n+\n+    @Override\n+    public void connect() {\n+        influx = InfluxDBFactory.connect(config.getUrl(), config.getUser(), config.getPassword(),\n+            new OkHttpClient.Builder(), InfluxDB.ResponseFormat.MSGPACK);\n+        influx.query(new Query(\"CREATE DATABASE \" + database));\n+\n+        influx.setDatabase(database);\n+        influx.enableBatch();\n+    }\n+\n+    /**\n+     * To get a connection of InfluxDB\n+     *\n+     * @return InfluxDB's connection\n+     */\n+    public InfluxDB getInflux() {\n+        return influx;\n+    }\n+\n+    /**\n+     * Request with a {@link Query} to InfluxDB and return a set of {@link QueryResult.Result}s.\n+     *\n+     * @param query\n+     * @return a set of Result.\n+     * @throws IOException\n+     */\n+    public List<QueryResult.Result> query(Query query) throws IOException {\n+        if (logger.isDebugEnabled()) {\n+            logger.debug(\"SQL Statement: {}\", query.getCommand());\n+        }\n+\n+        try {\n+            QueryResult result = getInflux().query(query);\n+            if (result.hasError()) {\n+                throw new IOException(result.getError());\n+            }\n+            return result.getResults();\n+        } catch (Exception e) {\n+            throw new IOException(e.getMessage() + System.lineSeparator() + \"SQL Statement: \" + query.getCommand(), e);\n+        }\n+    }\n+\n+    /**\n+     * Request with one statement to InfluxDB and return a set of {@link QueryResult.Series}s.\n+     *\n+     * @param query\n+     * @return a set of Series\n+     * @throws IOException\n+     */\n+    public List<QueryResult.Series> queryForSeries(Query query) throws IOException {\n+        return query(query).get(0).getSeries();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "748dce814b1567ec1d1d5878de91b2891e7a75b7"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTExOTg3Mg==", "bodyText": "Don't see anyone uses this. Please confirm. And queryForDelete is not a good idea. For time-series data, it is better to delete by time bucket only.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375119872", "createdAt": "2020-02-05T08:39:27Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,194 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.util.List;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+/**\n+ *\n+ */\n+public class InfluxClient implements Client {\n+    private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+    private InfluxStorageConfig config;\n+    private InfluxDB influx;\n+\n+    /**\n+     * A constant, the name of time field in Time-series database.\n+     */\n+    public static final String TIME = \"time\";\n+    /**\n+     * A constant, the name of tag.\n+     */\n+    public static final String TAG_ENTITY_ID = \"entity_id\";\n+\n+    private final String database;\n+\n+    public InfluxClient(InfluxStorageConfig config) {\n+        this.config = config;\n+        this.database = config.getDatabase();\n+    }\n+\n+    public final String getDatabase() {\n+        return database;\n+    }\n+\n+    @Override\n+    public void connect() {\n+        influx = InfluxDBFactory.connect(config.getUrl(), config.getUser(), config.getPassword(),\n+            new OkHttpClient.Builder(), InfluxDB.ResponseFormat.MSGPACK);\n+        influx.query(new Query(\"CREATE DATABASE \" + database));\n+\n+        influx.setDatabase(database);\n+        influx.enableBatch();\n+    }\n+\n+    /**\n+     * To get a connection of InfluxDB\n+     *\n+     * @return InfluxDB's connection\n+     */\n+    public InfluxDB getInflux() {\n+        return influx;\n+    }\n+\n+    /**\n+     * Request with a {@link Query} to InfluxDB and return a set of {@link QueryResult.Result}s.\n+     *\n+     * @param query\n+     * @return a set of Result.\n+     * @throws IOException\n+     */\n+    public List<QueryResult.Result> query(Query query) throws IOException {\n+        if (logger.isDebugEnabled()) {\n+            logger.debug(\"SQL Statement: {}\", query.getCommand());\n+        }\n+\n+        try {\n+            QueryResult result = getInflux().query(query);\n+            if (result.hasError()) {\n+                throw new IOException(result.getError());\n+            }\n+            return result.getResults();\n+        } catch (Exception e) {\n+            throw new IOException(e.getMessage() + System.lineSeparator() + \"SQL Statement: \" + query.getCommand(), e);\n+        }\n+    }\n+\n+    /**\n+     * Request with one statement to InfluxDB and return a set of {@link QueryResult.Series}s.\n+     *\n+     * @param query\n+     * @return a set of Series\n+     * @throws IOException\n+     */\n+    public List<QueryResult.Series> queryForSeries(Query query) throws IOException {\n+        return query(query).get(0).getSeries();\n+    }\n+\n+    /**\n+     * Data management, to drop a time-series by measurement and time-series name specified. If an exception isn't\n+     * thrown, it means execution success.\n+     *\n+     * @param measurement\n+     * @param timeBucket\n+     * @throws IOException\n+     */\n+    public void dropSeries(String measurement, long timeBucket) throws IOException {\n+        Query query = new Query(\"DROP SERIES FROM \" + measurement + \" WHERE time_bucket='\" + timeBucket + \"'\");\n+        QueryResult result = getInflux().query(query);\n+\n+        if (result.hasError()) {\n+            throw new IOException(\"Statement: \" + query.getCommand() + \", ErrorMsg: \" + result.getError());\n+        }\n+    }\n+\n+    /**\n+     * Data management, to delete data by a statement. If an exception isn't thrown, it means execution success.\n+     *\n+     * @param statement\n+     * @throws IOException\n+     */\n+    public void queryForDelete(String statement) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "748dce814b1567ec1d1d5878de91b2891e7a75b7"}, "originalPosition": 144}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyMDIxNg==", "bodyText": "Comments are required.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375120216", "createdAt": "2020-02-05T08:40:16Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxStorageConfig.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import lombok.Getter;\n+import lombok.Setter;\n+import org.apache.skywalking.oap.server.library.module.ModuleConfig;\n+\n+@Setter\n+@Getter\n+public class InfluxStorageConfig extends ModuleConfig {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "748dce814b1567ec1d1d5878de91b2891e7a75b7"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyMTMwOA==", "bodyText": "Is this a blocking write? Meaning, the data is queryable when this method finished.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375121308", "createdAt": "2020-02-05T08:42:52Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/BatchDAO.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import java.util.List;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.apm.commons.datacarrier.DataCarrier;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.BulkConsumePool;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.ConsumerPoolFactory;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.IConsumer;\n+import org.apache.skywalking.oap.server.core.UnexpectedException;\n+import org.apache.skywalking.oap.server.core.storage.IBatchDAO;\n+import org.apache.skywalking.oap.server.library.client.request.InsertRequest;\n+import org.apache.skywalking.oap.server.library.client.request.PrepareRequest;\n+import org.apache.skywalking.oap.server.library.util.CollectionUtils;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.BatchPoints;\n+\n+@Slf4j\n+public class BatchDAO implements IBatchDAO {\n+    private final DataCarrier<PrepareRequest> dataCarrier;\n+    private final InfluxClient client;\n+\n+    public BatchDAO(InfluxClient client) {\n+        this.client = client;\n+\n+        String name = \"INFLUX_ASYNC_BATCH_PERSISTENT\";\n+        BulkConsumePool.Creator creator = new BulkConsumePool.Creator(name, 1, 20L);\n+\n+        try {\n+            ConsumerPoolFactory.INSTANCE.createIfAbsent(name, creator);\n+        } catch (Exception e) {\n+            throw new UnexpectedException(e.getMessage(), e);\n+        }\n+\n+        this.dataCarrier = new DataCarrier(1, 10000);\n+        this.dataCarrier.consume(ConsumerPoolFactory.INSTANCE.get(name), new InfluxBatchConsumer(this));\n+    }\n+\n+    @Override\n+    public void asynchronous(InsertRequest insertRequest) {\n+        dataCarrier.produce(insertRequest);\n+    }\n+\n+    @Override\n+    public void synchronous(List<PrepareRequest> prepareRequests) {\n+        if (CollectionUtils.isEmpty(prepareRequests)) {\n+            return;\n+        }\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"batch sql statements execute, data size: {}\", prepareRequests.size());\n+        }\n+\n+        final BatchPoints.Builder builder = BatchPoints.builder();\n+        prepareRequests.forEach(e -> {\n+            builder.point(((InfluxInsertRequest)e).getPoint());\n+        });\n+\n+        client.write(builder.build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "748dce814b1567ec1d1d5878de91b2891e7a75b7"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyMjAyNQ==", "bodyText": "Doesn't InfluxDB have an async write mode? I remember time serious DB is good at writing.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375122025", "createdAt": "2020-02-05T08:44:31Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/BatchDAO.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import java.util.List;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.apm.commons.datacarrier.DataCarrier;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.BulkConsumePool;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.ConsumerPoolFactory;\n+import org.apache.skywalking.apm.commons.datacarrier.consumer.IConsumer;\n+import org.apache.skywalking.oap.server.core.UnexpectedException;\n+import org.apache.skywalking.oap.server.core.storage.IBatchDAO;\n+import org.apache.skywalking.oap.server.library.client.request.InsertRequest;\n+import org.apache.skywalking.oap.server.library.client.request.PrepareRequest;\n+import org.apache.skywalking.oap.server.library.util.CollectionUtils;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.BatchPoints;\n+\n+@Slf4j\n+public class BatchDAO implements IBatchDAO {\n+    private final DataCarrier<PrepareRequest> dataCarrier;\n+    private final InfluxClient client;\n+\n+    public BatchDAO(InfluxClient client) {\n+        this.client = client;\n+\n+        String name = \"INFLUX_ASYNC_BATCH_PERSISTENT\";\n+        BulkConsumePool.Creator creator = new BulkConsumePool.Creator(name, 1, 20L);\n+\n+        try {\n+            ConsumerPoolFactory.INSTANCE.createIfAbsent(name, creator);\n+        } catch (Exception e) {\n+            throw new UnexpectedException(e.getMessage(), e);\n+        }\n+\n+        this.dataCarrier = new DataCarrier(1, 10000);\n+        this.dataCarrier.consume(ConsumerPoolFactory.INSTANCE.get(name), new InfluxBatchConsumer(this));\n+    }\n+\n+    @Override\n+    public void asynchronous(InsertRequest insertRequest) {\n+        dataCarrier.produce(insertRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "748dce814b1567ec1d1d5878de91b2891e7a75b7"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyMjQ2Mw==", "bodyText": "=?", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375122463", "createdAt": "2020-02-05T08:45:26Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,194 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.util.List;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+/**\n+ *\n+ */\n+public class InfluxClient implements Client {\n+    private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+    private InfluxStorageConfig config;\n+    private InfluxDB influx;\n+\n+    /**\n+     * A constant, the name of time field in Time-series database.\n+     */\n+    public static final String TIME = \"time\";\n+    /**\n+     * A constant, the name of tag.\n+     */\n+    public static final String TAG_ENTITY_ID = \"entity_id\";\n+\n+    private final String database;\n+\n+    public InfluxClient(InfluxStorageConfig config) {\n+        this.config = config;\n+        this.database = config.getDatabase();\n+    }\n+\n+    public final String getDatabase() {\n+        return database;\n+    }\n+\n+    @Override\n+    public void connect() {\n+        influx = InfluxDBFactory.connect(config.getUrl(), config.getUser(), config.getPassword(),\n+            new OkHttpClient.Builder(), InfluxDB.ResponseFormat.MSGPACK);\n+        influx.query(new Query(\"CREATE DATABASE \" + database));\n+\n+        influx.setDatabase(database);\n+        influx.enableBatch();\n+    }\n+\n+    /**\n+     * To get a connection of InfluxDB\n+     *\n+     * @return InfluxDB's connection\n+     */\n+    public InfluxDB getInflux() {\n+        return influx;\n+    }\n+\n+    /**\n+     * Request with a {@link Query} to InfluxDB and return a set of {@link QueryResult.Result}s.\n+     *\n+     * @param query\n+     * @return a set of Result.\n+     * @throws IOException\n+     */\n+    public List<QueryResult.Result> query(Query query) throws IOException {\n+        if (logger.isDebugEnabled()) {\n+            logger.debug(\"SQL Statement: {}\", query.getCommand());\n+        }\n+\n+        try {\n+            QueryResult result = getInflux().query(query);\n+            if (result.hasError()) {\n+                throw new IOException(result.getError());\n+            }\n+            return result.getResults();\n+        } catch (Exception e) {\n+            throw new IOException(e.getMessage() + System.lineSeparator() + \"SQL Statement: \" + query.getCommand(), e);\n+        }\n+    }\n+\n+    /**\n+     * Request with one statement to InfluxDB and return a set of {@link QueryResult.Series}s.\n+     *\n+     * @param query\n+     * @return a set of Series\n+     * @throws IOException\n+     */\n+    public List<QueryResult.Series> queryForSeries(Query query) throws IOException {\n+        return query(query).get(0).getSeries();\n+    }\n+\n+    /**\n+     * Data management, to drop a time-series by measurement and time-series name specified. If an exception isn't\n+     * thrown, it means execution success.\n+     *\n+     * @param measurement\n+     * @param timeBucket\n+     * @throws IOException\n+     */\n+    public void dropSeries(String measurement, long timeBucket) throws IOException {\n+        Query query = new Query(\"DROP SERIES FROM \" + measurement + \" WHERE time_bucket='\" + timeBucket + \"'\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "748dce814b1567ec1d1d5878de91b2891e7a75b7"}, "originalPosition": 130}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyMjg5NA==", "bodyText": "Another #get(0). What does this mean?", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r375122894", "createdAt": "2020-02-05T08:46:25Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/MetricsDAO.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Maps;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.storage.IMetricsDAO;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.model.Model;\n+import org.apache.skywalking.oap.server.core.storage.model.ModelColumn;\n+import org.apache.skywalking.oap.server.core.storage.type.StorageDataType;\n+import org.apache.skywalking.oap.server.library.client.request.InsertRequest;\n+import org.apache.skywalking.oap.server.library.client.request.UpdateRequest;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.SelectQueryImpl;\n+import org.influxdb.querybuilder.WhereQueryImpl;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.contains;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.select;\n+\n+public class MetricsDAO implements IMetricsDAO {\n+    private final StorageBuilder<Metrics> storageBuilder;\n+    private final InfluxClient client;\n+\n+    public MetricsDAO(InfluxClient client, StorageBuilder<Metrics> storageBuilder) {\n+        this.client = client;\n+        this.storageBuilder = storageBuilder;\n+    }\n+\n+    @Override\n+    public List<Metrics> multiGet(Model model, List<String> ids) throws IOException {\n+        WhereQueryImpl<SelectQueryImpl> query = select(\"*::field\")\n+            .from(client.getDatabase(), model.getName())\n+            .where(contains(\"id\", Joiner.on(\"|\").join(ids)));\n+        List<QueryResult.Series> series = client.queryForSeries(query);\n+        if (series == null || series.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+\n+        final List<Metrics> metrics = Lists.newArrayList();\n+        List<String> columns = series.get(0).getColumns();\n+        Map<String, String> storageAndColumnNames = Maps.newHashMap();\n+        for (ModelColumn column : model.getColumns()) {\n+            storageAndColumnNames.put(column.getColumnName().getName(), column.getColumnName().getStorageName());\n+        }\n+\n+        series.get(0).getValues().forEach(values -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "748dce814b1567ec1d1d5878de91b2891e7a75b7"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6981abf03c5808f8f0054311679fcd0327c449a", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/e6981abf03c5808f8f0054311679fcd0327c449a", "committedDate": "2020-02-07T19:26:00Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6baae3e4e52941cfcdd9154cbfa6574878f03c62", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/6baae3e4e52941cfcdd9154cbfa6574878f03c62", "committedDate": "2020-02-07T20:32:05Z", "message": "support configure batch options"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "800f4de7e56338d29dc0725df34ba201cb644bd8", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/800f4de7e56338d29dc0725df34ba201cb644bd8", "committedDate": "2020-02-07T20:34:43Z", "message": "support to configure batchOptions && polish && implement ProfileThreadSnapshotQuery"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbbcf22e7cdcfdf2af6d065466248c1139dcf91f", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/cbbcf22e7cdcfdf2af6d065466248c1139dcf91f", "committedDate": "2020-02-07T20:36:38Z", "message": "add e2e-ttl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb1b87538d949f3a2b87e2e14836f931312ee1b7", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/fb1b87538d949f3a2b87e2e14836f931312ee1b7", "committedDate": "2020-02-07T20:46:58Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTMyMDkz", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-355532093", "createdAt": "2020-02-08T05:47:37Z", "commit": {"oid": "fb1b87538d949f3a2b87e2e14836f931312ee1b7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwNTo0NzozN1rOFnPVHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwNTo0ODoyNFrOFnPVRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY4OTk1MQ==", "bodyText": "likes -> like.\nwe need to configure InfluxDB's properties and H2/MySQL -> `We need to configure properties of InfluxDB and Metabase.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r376689951", "createdAt": "2020-02-08T05:47:37Z", "author": {"login": "wu-sheng"}, "path": "docs/en/setup/backend/backend-storage.md", "diffHunk": "@@ -226,6 +227,27 @@ storage:\n All connection related settings including link url, username and password are in `application.yml`. \n These settings can refer to the configuration of *MySQL* above.\n \n+## InfluxDB\n+InfluxDB as storage since SkyWalking 7.0. It depends on `H2/MySQL` storage-plugin to store `metadata` likes `Inventory` and `ProfileTask`. So, when we set `InfluxDB` as storage provider, we need to configure `InfluxDB`'s properties and `H2/MySQL`.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb1b87538d949f3a2b87e2e14836f931312ee1b7"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY4OTk4OQ==", "bodyText": "Please provide type options.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r376689989", "createdAt": "2020-02-08T05:48:24Z", "author": {"login": "wu-sheng"}, "path": "docs/en/setup/backend/backend-storage.md", "diffHunk": "@@ -226,6 +227,27 @@ storage:\n All connection related settings including link url, username and password are in `application.yml`. \n These settings can refer to the configuration of *MySQL* above.\n \n+## InfluxDB\n+InfluxDB as storage since SkyWalking 7.0. It depends on `H2/MySQL` storage-plugin to store `metadata` likes `Inventory` and `ProfileTask`. So, when we set `InfluxDB` as storage provider, we need to configure `InfluxDB`'s properties and `H2/MySQL`.\n+\n+```yaml\n+storage\n+  influx:\n+    # Metadata storage provider configuration\n+    metabaseType: ${SW_STORAGE_METABASE_TYPE:H2}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb1b87538d949f3a2b87e2e14836f931312ee1b7"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47a6028c86ab31be83866cae43cdf0481083c96b", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/47a6028c86ab31be83866cae43cdf0481083c96b", "committedDate": "2020-02-08T06:50:32Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6df13a1ea91fe07c2acef9669cf956cc434c3277", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/6df13a1ea91fe07c2acef9669cf956cc434c3277", "committedDate": "2020-02-08T08:47:18Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c148bfb6bd5ed585e39a1e1bdc2dfe061fd511f8", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/c148bfb6bd5ed585e39a1e1bdc2dfe061fd511f8", "committedDate": "2020-02-08T08:55:39Z", "message": "merge"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTQ0MTEy", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-355544112", "createdAt": "2020-02-08T11:41:49Z", "commit": {"oid": "c148bfb6bd5ed585e39a1e1bdc2dfe061fd511f8"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bd17170a147a1c53822eb11057d667937826392", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/2bd17170a147a1c53822eb11057d667937826392", "committedDate": "2020-02-08T13:56:51Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTQ5MTA2", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-355549106", "createdAt": "2020-02-08T14:00:14Z", "commit": {"oid": "2bd17170a147a1c53822eb11057d667937826392"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQxNDowMDoxNVrOFnQp4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQxNDowMDoxNVrOFnQp4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjcxMTY0OQ==", "bodyText": "All these protos should be removed, please follow this, #4329 (comment)", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r376711649", "createdAt": "2020-02-08T14:00:15Z", "author": {"login": "wu-sheng"}, "path": "test/e2e/e2e-ttl/e2e-ttl-influxdb/src/main/proto/common/CLR.proto", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+syntax = \"proto3\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bd17170a147a1c53822eb11057d667937826392"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8caa64da9968347afe31654b89764b9f83e05389", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/8caa64da9968347afe31654b89764b9f83e05389", "committedDate": "2020-02-08T17:47:22Z", "message": "remove proto from e2e-ttl-influxbd && enable e2e-profile action"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3b2563433deb525691eef534a5989c76c5cb583", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/f3b2563433deb525691eef534a5989c76c5cb583", "committedDate": "2020-02-08T19:21:01Z", "message": "add influxdb to e2e-profile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cd472eb7adae926776fe0a4c97ecd3fc35278be", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/4cd472eb7adae926776fe0a4c97ecd3fc35278be", "committedDate": "2020-02-08T19:30:02Z", "message": "fix missing ProfileTask in PointBuilder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30408ed101f5b246229141766e22f541e8b64c1d", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/30408ed101f5b246229141766e22f541e8b64c1d", "committedDate": "2020-02-08T20:33:57Z", "message": "Simplify InfluxClient API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12414c80e1819ccdd6d774bede6d9d33fe6af457", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/12414c80e1819ccdd6d774bede6d9d33fe6af457", "committedDate": "2020-02-08T20:34:45Z", "message": "update docker/docket-entrypoint.sh"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTc3MzQz", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-355577343", "createdAt": "2020-02-09T01:02:43Z", "commit": {"oid": "12414c80e1819ccdd6d774bede6d9d33fe6af457"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQwMTowMjo0M1rOFnSwvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQwMTowMjo0M1rOFnSwvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0NjE3NQ==", "bodyText": "I think this should be private to avoid misuse", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r376746175", "createdAt": "2020-02-09T01:02:43Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,203 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import lombok.extern.slf4j.Slf4j;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.apache.skywalking.oap.server.library.util.CollectionUtils;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+/**\n+ * InfluxDB connection maintainer, provides base data write/query API.\n+ */\n+@Slf4j\n+public class InfluxClient implements Client {\n+    private InfluxStorageConfig config;\n+    private InfluxDB influx;\n+\n+    /**\n+     * A constant, the name of time field in Time-series database.\n+     */\n+    public static final String TIME = \"time\";\n+    /**\n+     * A constant, the name of tag.\n+     */\n+    public static final String TAG_ENTITY_ID = \"entity_id\";\n+\n+    private final String database;\n+\n+    public InfluxClient(InfluxStorageConfig config) {\n+        this.config = config;\n+        this.database = config.getDatabase();\n+    }\n+\n+    public final String getDatabase() {\n+        return database;\n+    }\n+\n+    @Override\n+    public void connect() {\n+        influx = InfluxDBFactory.connect(config.getUrl(), config.getUser(), config.getPassword(),\n+            new OkHttpClient.Builder(), InfluxDB.ResponseFormat.MSGPACK);\n+        influx.query(new Query(\"CREATE DATABASE \" + database));\n+\n+        influx.enableBatch(config.getActions(), config.getDuration(), TimeUnit.MILLISECONDS);\n+        influx.setDatabase(database);\n+    }\n+\n+    /**\n+     * To get a connection of InfluxDB.\n+     *\n+     * @return InfluxDB's connection\n+     */\n+    public InfluxDB getInflux() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12414c80e1819ccdd6d774bede6d9d33fe6af457"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edddb52ef2d76922b008a28b2c1746dc504cbe81", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/edddb52ef2d76922b008a28b2c1746dc504cbe81", "committedDate": "2020-02-09T06:28:20Z", "message": "fix missing record"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab75c86a570cf949e6ec6be1f27d3b45b1917278", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/ab75c86a570cf949e6ec6be1f27d3b45b1917278", "committedDate": "2020-02-09T08:38:29Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a1420e8a308496cabfc10019f3270045c27ac7a", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/0a1420e8a308496cabfc10019f3270045c27ac7a", "committedDate": "2020-02-10T14:33:36Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62bd2acfcc1c44e41af7fc096f671ffb250fe148", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/62bd2acfcc1c44e41af7fc096f671ffb250fe148", "committedDate": "2020-02-10T15:00:50Z", "message": "refactor PointBuilder: Record conver to Point"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40787a28bcd021f8f56758114eae2bf0247bbc47", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/40787a28bcd021f8f56758114eae2bf0247bbc47", "committedDate": "2020-02-10T16:46:10Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8545f2489a0dfefbb15a302830323361cfef164", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/f8545f2489a0dfefbb15a302830323361cfef164", "committedDate": "2020-02-11T06:43:41Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9efd063e08e2915588fef97143e3584aa1507ecf", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/9efd063e08e2915588fef97143e3584aa1507ecf", "committedDate": "2020-02-11T09:34:27Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fda55d30f5fc52400eb7c976fb92304d42d2ad4", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/4fda55d30f5fc52400eb7c976fb92304d42d2ad4", "committedDate": "2020-02-11T10:40:06Z", "message": "reformat and new methods implemented"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3661485c8c5af09001be9eda2206fb41829ad616", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/3661485c8c5af09001be9eda2206fb41829ad616", "committedDate": "2020-02-11T12:38:10Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c5867f24b32ed2731126c51db0a18c0ffec8d7a", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/0c5867f24b32ed2731126c51db0a18c0ffec8d7a", "committedDate": "2020-02-11T14:57:00Z", "message": "enable e2e-cluster action with influxdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69a2b579ff69cf6e06b603c678bc3b31ae930d8f", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/69a2b579ff69cf6e06b603c678bc3b31ae930d8f", "committedDate": "2020-02-11T15:18:27Z", "message": "polish"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13719f30d07339316b707993d38b2de3e136e17b", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/13719f30d07339316b707993d38b2de3e136e17b", "committedDate": "2020-02-11T15:40:08Z", "message": "update e2e-container to 1.4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c06a1dca76b9cd931cb41f3e0183b53e264e174", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/4c06a1dca76b9cd931cb41f3e0183b53e264e174", "committedDate": "2020-02-11T15:45:33Z", "message": "update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MTQ1NjI4", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-357145628", "createdAt": "2020-02-12T02:03:31Z", "commit": {"oid": "4c06a1dca76b9cd931cb41f3e0183b53e264e174"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjowMzozMVrOFofjag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjowMzozMVrOFofjag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAwNDMzMA==", "bodyText": "What do you mean N_TTL?", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r378004330", "createdAt": "2020-02-12T02:03:31Z", "author": {"login": "wu-sheng"}, "path": ".github/workflows/e2e.yaml", "diffHunk": "@@ -39,19 +39,21 @@ jobs:\n           ./mvnw --batch-mode -Dcheckstyle.skip -Drat.skip -T2 -Dmaven.compile.fork -Dmaven.compiler.maxmem=3072 -DskipTests clean install\n           ./mvnw --batch-mode -f test/e2e/pom.xml -pl e2e-base clean install\n       - name: Single Node Tests(JDK8)\n-        run: export E2E_VERSION=jdk8-1.3 && bash -x test/e2e/run.sh e2e-single-service\n+        run: export E2E_VERSION=jdk8-1.4 && bash -x test/e2e/run.sh e2e-single-service\n+      - name: Single Node Tests(InfluxDB/JDK8)\n+        run: export E2E_VERSION=jdk8-1.4 && bash -x test/e2e/run.sh e2e-influxdb\n       - name: Single Node Tests(MySQL/JDK8)\n-        run: export E2E_VERSION=jdk8-1.3 && bash -x test/e2e/run.sh e2e-mysql\n+        run: export E2E_VERSION=jdk8-1.4 && bash -x test/e2e/run.sh e2e-mysql\n       - name: Single Node Tests(JDK9)\n-        run: export E2E_VERSION=jdk9-1.3 && bash -x test/e2e/run.sh e2e-single-service\n+        run: export E2E_VERSION=jdk9-1.4 && bash -x test/e2e/run.sh e2e-single-service\n       - name: Single Node Tests(JDK11)\n-        run: export E2E_VERSION=jdk11-1.3 && bash -x test/e2e/run.sh e2e-single-service\n+        run: export E2E_VERSION=jdk11-1.4 && bash -x test/e2e/run.sh e2e-single-service\n       - name: Single Node Tests(JDK12)\n-        run: export E2E_VERSION=jdk12-1.3 && bash -x test/e2e/run.sh e2e-single-service\n+        run: export E2E_VERSION=jdk12-1.4 && bash -x test/e2e/run.sh e2e-single-service\n       - name: Agent Reboot Tests(JDK8)\n-        run: export E2E_VERSION=jdk8-1.3 && bash -x test/e2e/run.sh e2e-agent-reboot\n+        run: export E2E_VERSION=jdk8-1.4 && bash -x test/e2e/run.sh e2e-agent-reboot\n \n-  Cluster:\n+  Cluster_N_TTL:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c06a1dca76b9cd931cb41f3e0183b53e264e174"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MTU1NjUy", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-357155652", "createdAt": "2020-02-12T02:39:34Z", "commit": {"oid": "4c06a1dca76b9cd931cb41f3e0183b53e264e174"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjozOTozNFrOFogDoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjozOTozNFrOFogDoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAxMjU3Nw==", "bodyText": "Upgrade to 1.5 please, based on, #4343 (comment)", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r378012577", "createdAt": "2020-02-12T02:39:34Z", "author": {"login": "wu-sheng"}, "path": ".github/workflows/e2e.yaml", "diffHunk": "@@ -39,19 +39,21 @@ jobs:\n           ./mvnw --batch-mode -Dcheckstyle.skip -Drat.skip -T2 -Dmaven.compile.fork -Dmaven.compiler.maxmem=3072 -DskipTests clean install\n           ./mvnw --batch-mode -f test/e2e/pom.xml -pl e2e-base clean install\n       - name: Single Node Tests(JDK8)\n-        run: export E2E_VERSION=jdk8-1.3 && bash -x test/e2e/run.sh e2e-single-service\n+        run: export E2E_VERSION=jdk8-1.4 && bash -x test/e2e/run.sh e2e-single-service", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c06a1dca76b9cd931cb41f3e0183b53e264e174"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "918673d7bec7906c4fef7f304cc86eca1534df99", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/918673d7bec7906c4fef7f304cc86eca1534df99", "committedDate": "2020-02-12T04:20:45Z", "message": "fix e2e-profile-influxdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "767c85af65dc656e770853f1337111d08c58e586", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/767c85af65dc656e770853f1337111d08c58e586", "committedDate": "2020-02-12T07:35:56Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c4100657696a7a04c16ff367b23afd24477a42f", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/5c4100657696a7a04c16ff367b23afd24477a42f", "committedDate": "2020-02-12T11:07:53Z", "message": "fix e2e issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c79dc599042b49b735f09cacf6d5a113511e3dd3", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/c79dc599042b49b735f09cacf6d5a113511e3dd3", "committedDate": "2020-02-12T11:08:59Z", "message": "Merge branch 'influx-storage' of https://github.com/dmsolr/skywalking into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d21d1fc7609bd946bb9117042dfca3eee8eef302", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/d21d1fc7609bd946bb9117042dfca3eee8eef302", "committedDate": "2020-02-13T00:57:22Z", "message": "fix e2e issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56f360e9aa91e1f04074d642f007ce142c68af91", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/56f360e9aa91e1f04074d642f007ce142c68af91", "committedDate": "2020-02-13T07:20:21Z", "message": "fix metabase configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58c5674a7be0efa5c67e98c97e314f4f35cdf88d", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/58c5674a7be0efa5c67e98c97e314f4f35cdf88d", "committedDate": "2020-02-13T07:27:21Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2896232f45b5f0feafb04b948e8f0144739d1a5c", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/2896232f45b5f0feafb04b948e8f0144739d1a5c", "committedDate": "2020-02-13T08:10:49Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0580a4ae05a121bb1e70588f01c05dfdc6d58d2d", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/0580a4ae05a121bb1e70588f01c05dfdc6d58d2d", "committedDate": "2020-02-13T08:58:32Z", "message": "rename metabase's configuration name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d45e9d35f6f5d2bd19545064beb757d5eed4874", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/3d45e9d35f6f5d2bd19545064beb757d5eed4874", "committedDate": "2020-02-13T09:57:18Z", "message": "upset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3838428d5feb0027fc6d06bcc2b178ca347b5bf", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/c3838428d5feb0027fc6d06bcc2b178ca347b5bf", "committedDate": "2020-02-13T11:30:29Z", "message": "fix e2e-issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MTk4ODQw", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-358198840", "createdAt": "2020-02-13T13:05:32Z", "commit": {"oid": "c3838428d5feb0027fc6d06bcc2b178ca347b5bf"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMzowNTozMlrOFpS-4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMzoxMjo0OFrOFpTMYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg0Njk0Nw==", "bodyText": "From here, all comments about @param and @return are either empty and meaningless. Could you fix this?", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r378846947", "createdAt": "2020-02-13T13:05:32Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -0,0 +1,210 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import lombok.extern.slf4j.Slf4j;\n+import okhttp3.OkHttpClient;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.library.client.Client;\n+import org.apache.skywalking.oap.server.library.util.CollectionUtils;\n+import org.influxdb.InfluxDB;\n+import org.influxdb.InfluxDBFactory;\n+import org.influxdb.dto.BatchPoints;\n+import org.influxdb.dto.Point;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.time.TimeInterval;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.ti;\n+\n+/**\n+ * InfluxDB connection maintainer, provides base data write/query API.\n+ */\n+@Slf4j\n+public class InfluxClient implements Client {\n+    private InfluxStorageConfig config;\n+    private InfluxDB influx;\n+\n+    /**\n+     * A constant, the name of time field in Time-series database.\n+     */\n+    public static final String TIME = \"time\";\n+    /**\n+     * A constant, the name of tag.\n+     */\n+    public static final String TAG_ENTITY_ID = \"entity_id\";\n+\n+    private final String database;\n+\n+    public InfluxClient(InfluxStorageConfig config) {\n+        this.config = config;\n+        this.database = config.getDatabase();\n+    }\n+\n+    public final String getDatabase() {\n+        return database;\n+    }\n+\n+    @Override\n+    public void connect() {\n+        influx = InfluxDBFactory.connect(config.getUrl(), config.getUser(), config.getPassword(),\n+                                         new OkHttpClient.Builder().readTimeout(3, TimeUnit.MINUTES)\n+                                                                   .writeTimeout(3, TimeUnit.MINUTES),\n+                                         InfluxDB.ResponseFormat.MSGPACK\n+        );\n+        influx.query(new Query(\"CREATE DATABASE \" + database));\n+\n+        influx.enableBatch(config.getActions(), config.getDuration(), TimeUnit.MILLISECONDS);\n+        influx.setDatabase(database);\n+    }\n+\n+    /**\n+     * To get a connection of InfluxDB.\n+     *\n+     * @return InfluxDB's connection\n+     */\n+    private InfluxDB getInflux() {\n+        return influx;\n+    }\n+\n+    /**\n+     * Execute a query against InfluxDB and return a set of {@link QueryResult.Result}s. Normally, InfluxDB supports\n+     * combining multiple statements into one query, so that we do get multi-results.\n+     *\n+     * @param query Query\n+     * @return a set of {@link QueryResult.Result}s.\n+     * @throws IOException if there is an error on the InfluxDB server or communication error.\n+     */\n+    public List<QueryResult.Result> query(Query query) throws IOException {\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"SQL Statement: {}\", query.getCommand());\n+        }\n+\n+        try {\n+            QueryResult result = getInflux().query(query);\n+            if (result.hasError()) {\n+                throw new IOException(result.getError());\n+            }\n+            return result.getResults();\n+        } catch (Exception e) {\n+            throw new IOException(e.getMessage() + System.lineSeparator() + \"SQL Statement: \" + query.getCommand(), e);\n+        }\n+    }\n+\n+    /**\n+     * Execute a query against InfluxDB with a single statement.\n+     *\n+     * @param query Query\n+     * @return a set of {@link QueryResult.Series}s\n+     * @throws IOException if there is an error on the InfluxDB server or communication error\n+     */\n+    public List<QueryResult.Series> queryForSeries(Query query) throws IOException {\n+        List<QueryResult.Result> results = query(query);\n+\n+        if (CollectionUtils.isEmpty(results)) {\n+            return null;\n+        }\n+        return results.get(0).getSeries();\n+    }\n+\n+    /**\n+     * Execute a query against InfluxDB with a single statement but return a single {@link QueryResult.Series}.\n+     *\n+     * @param query Query\n+     * @return {@link QueryResult.Series}\n+     * @throws IOException if there is an error on the InfluxDB server or communication error\n+     */\n+    public QueryResult.Series queryForSingleSeries(Query query) throws IOException {\n+        List<QueryResult.Series> series = queryForSeries(query);\n+        if (CollectionUtils.isEmpty(series)) {\n+            return null;\n+        }\n+        return series.get(0);\n+    }\n+\n+    /**\n+     * Data management, to drop a time-series by measurement and time-series name specified. If an exception isn't\n+     * thrown, it means execution success. Notice, drop series don't support to drop series by range\n+     *\n+     * @param measurement String\n+     * @param timeBucket  long\n+     * @throws IOException if there is an error on the InfluxDB server or communication error\n+     */\n+    public void dropSeries(String measurement, long timeBucket) throws IOException {\n+        Query query = new Query(\"DROP SERIES FROM \" + measurement + \" WHERE time_bucket='\" + timeBucket + \"'\");\n+        QueryResult result = getInflux().query(query);\n+\n+        if (result.hasError()) {\n+            throw new IOException(\"Statement: \" + query.getCommand() + \", ErrorMsg: \" + result.getError());\n+        }\n+    }\n+\n+    public void deleteByQuery(String measurement, long timestamp) throws IOException {\n+        this.query(new Query(\"delete from \" + measurement + \" where time < \" + timestamp + \"ms\"));\n+    }\n+\n+    /**\n+     * Write a {@link Point} into InfluxDB. Note that, the {@link Point} is written into buffer of InfluxDB Client and\n+     * wait for buffer flushing.\n+     *\n+     * @param point Point", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3838428d5feb0027fc6d06bcc2b178ca347b5bf"}, "originalPosition": 170}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg1MDQwMA==", "bodyText": "Could you explain this class a little more? I am a little confused. All existing entities have the shared prepareBatchInsert and prepareBatchUpdate logic without explicit entity name required. Using the literal string name here is highly unstable. These names could be changed in any PR, and new entity could be added.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r378850400", "createdAt": "2020-02-13T13:12:48Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/PointBuilder.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import com.google.common.collect.Maps;\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.skywalking.apm.commons.datacarrier.common.AtomicRangeInteger;\n+import org.apache.skywalking.oap.server.core.alarm.AlarmRecord;\n+import org.apache.skywalking.oap.server.core.analysis.manual.segment.SegmentRecord;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.analysis.record.Record;\n+import org.apache.skywalking.oap.server.core.analysis.topn.TopN;\n+import org.apache.skywalking.oap.server.core.profile.ProfileTaskLogRecord;\n+import org.apache.skywalking.oap.server.core.profile.ProfileThreadSnapshotRecord;\n+import org.apache.skywalking.oap.server.core.storage.StorageData;\n+import org.apache.skywalking.oap.server.core.storage.model.ColumnName;\n+import org.apache.skywalking.oap.server.core.storage.model.Model;\n+import org.apache.skywalking.oap.server.core.storage.model.ModelColumn;\n+import org.apache.skywalking.oap.server.core.storage.type.StorageDataType;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.Point;\n+\n+import static org.apache.skywalking.oap.server.core.analysis.TimeBucket.getTimestamp;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.ALARM;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.DATABASE_SLOW_STATEMENT;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.HTTP_ACCESS_LOG;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.PROFILE_TASK_LOG;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.PROFILE_TASK_SEGMENT_SNAPSHOT;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.SEGMENT;\n+\n+/**\n+ * A helper help to build a InfluxDB Point from StorageData.\n+ */\n+public class PointBuilder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3838428d5feb0027fc6d06bcc2b178ca347b5bf"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6105b7f01c414b97618106f21e52b760b0e828d", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/e6105b7f01c414b97618106f21e52b760b0e828d", "committedDate": "2020-02-15T09:26:55Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e4375d038cd56498cd7f09365d6002136a3fd44", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/6e4375d038cd56498cd7f09365d6002136a3fd44", "committedDate": "2020-02-15T12:23:58Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MzQyNzIx", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-359342721", "createdAt": "2020-02-15T12:17:13Z", "commit": {"oid": "e6105b7f01c414b97618106f21e52b760b0e828d"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQxMjoxNzoxM1rOFqO3_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQxNDowNjo0NFrOFqPMvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgyODIyMQ==", "bodyText": "Should escape the $ character", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379828221", "createdAt": "2020-02-15T12:17:13Z", "author": {"login": "kezhenxu94"}, "path": "docker/oap-es7/docker-entrypoint.sh", "diffHunk": "@@ -149,6 +149,37 @@ storage:\n EOT\n }\n \n+generateStorageInfluxDB() {\n+    cat <<EOT >> ${var_application_file}\n+storage:\n+  influx:\n+    # Metadata storage provider configuration\n+    metabaseType: ${SW_STORAGE_METABASE_TYPE:H2} # There are 2 options as Metabase provider, H2 or MySQL.\n+    h2Props:\n+      dataSourceClassName: ${SW_STORAGE_METABASE_DRIVER:org.h2.jdbcx.JdbcDataSource}\n+      dataSource.url: ${SW_STORAGE_METABASE_URL:jdbc:h2:mem:skywalking-oap-db}\n+      dataSource.user: ${SW_STORAGE_METABASE_USER:sa}\n+      dataSource.password: ${SW_STORAGE_METABASE_PASSWORD:}\n+    mysqlProps:\n+      jdbcUrl: ${SW_STORAGE_METABASE_URL:\"jdbc:mysql://localhost:3306/swtest\"}\n+      dataSource.user: ${SW_STORAGE_METABASE_USER:root}\n+      dataSource.password: ${SW_STORAGE_METABASE_PASSWORD:root@1234}\n+      dataSource.cachePrepStmts: ${SW_STORAGE_METABASE_CACHE_PREP_STMTS:true}\n+      dataSource.prepStmtCacheSize: ${SW_STORAGE_METABASE_PREP_STMT_CACHE_SQL_SIZE:250}\n+      dataSource.prepStmtCacheSqlLimit: ${SW_STORAGE_METABASE_PREP_STMT_CACHE_SQL_LIMIT:2048}\n+      dataSource.useServerPrepStmts: ${SW_STORAGE_METABASE_USE_SERVER_PREP_STMTS:true}\n+    metadataQueryMaxSize: ${SW_STORAGE_METABASE_QUERY_MAX_SIZE:5000}\n+    # InfluxDB configuration\n+    url: ${SW_STORAGE_INFLUXDB_URL:http://localhost:8086}\n+    user: ${SW_STORAGE_INFLUXDB_USER:root}\n+    password: ${SW_STORAGE_INFLUXDB_PASSWORD:}\n+    database: ${SW_STORAGE_INFLUXDB_DATABASE:skywalking}\n+    actions: ${SW_STORAGE_INFLUXDB_ACTIONS:1000} # the number of actions to collect\n+    duration: ${SW_STORAGE_INFLUXDB_DURATION:1000} # the time to wait at most (milliseconds)\n+    fetchTaskLogMaxSize: ${SW_STORAGE_INFLUXDB_FETCH_TASK_LOG_MAX_SIZE:5000} # the max number of fetch task log in a request", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6105b7f01c414b97618106f21e52b760b0e828d"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgyODI4NA==", "bodyText": "Should escape the $ character", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379828284", "createdAt": "2020-02-15T12:18:19Z", "author": {"login": "kezhenxu94"}, "path": "docker/oap/docker-entrypoint.sh", "diffHunk": "@@ -150,6 +150,37 @@ storage:\n EOT\n }\n \n+generateStorageInfluxDB() {\n+    cat <<EOT >> ${var_application_file}\n+storage:\n+  influx:\n+    # Metadata storage provider configuration\n+    metabaseType: ${SW_STORAGE_METABASE_TYPE:H2} # There are 2 options as Metabase provider, H2 or MySQL.\n+    h2Props:\n+      dataSourceClassName: ${SW_STORAGE_METABASE_DRIVER:org.h2.jdbcx.JdbcDataSource}\n+      dataSource.url: ${SW_STORAGE_METABASE_URL:jdbc:h2:mem:skywalking-oap-db}\n+      dataSource.user: ${SW_STORAGE_METABASE_USER:sa}\n+      dataSource.password: ${SW_STORAGE_METABASE_PASSWORD:}\n+    mysqlProps:\n+      jdbcUrl: ${SW_STORAGE_METABASE_URL:\"jdbc:mysql://localhost:3306/swtest\"}\n+      dataSource.user: ${SW_STORAGE_METABASE_USER:root}\n+      dataSource.password: ${SW_STORAGE_METABASE_PASSWORD:root@1234}\n+      dataSource.cachePrepStmts: ${SW_STORAGE_METABASE_CACHE_PREP_STMTS:true}\n+      dataSource.prepStmtCacheSize: ${SW_STORAGE_METABASE_PREP_STMT_CACHE_SQL_SIZE:250}\n+      dataSource.prepStmtCacheSqlLimit: ${SW_STORAGE_METABASE_PREP_STMT_CACHE_SQL_LIMIT:2048}\n+      dataSource.useServerPrepStmts: ${SW_STORAGE_METABASE_USE_SERVER_PREP_STMTS:true}\n+    metadataQueryMaxSize: ${SW_STORAGE_METABASE_QUERY_MAX_SIZE:5000}\n+    # InfluxDB configuration\n+    url: ${SW_STORAGE_INFLUXDB_URL:http://localhost:8086}\n+    user: ${SW_STORAGE_INFLUXDB_USER:root}\n+    password: ${SW_STORAGE_INFLUXDB_PASSWORD:}\n+    database: ${SW_STORAGE_INFLUXDB_DATABASE:skywalking}\n+    actions: ${SW_STORAGE_INFLUXDB_ACTIONS:1000} # the number of actions to collect\n+    duration: ${SW_STORAGE_INFLUXDB_DURATION:1000} # the time to wait at most (milliseconds)\n+    fetchTaskLogMaxSize: ${SW_STORAGE_INFLUXDB_FETCH_TASK_LOG_MAX_SIZE:5000} # the max number of fetch task log in a request", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6105b7f01c414b97618106f21e52b760b0e828d"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgyODc1Mg==", "bodyText": "mush -> must be", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379828752", "createdAt": "2020-02-15T12:28:22Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/TimeBucket.java", "diffHunk": "@@ -32,10 +32,119 @@ public static long getRecordTimeBucket(long time) {\n         return getTimeBucket(time, Downsampling.Second);\n     }\n \n+    /**\n+     * Record time bucket format in Minute Unit.\n+     *\n+     * @param time Timestamp\n+     * @return time in minute format.\n+     */\n     public static long getMinuteTimeBucket(long time) {\n         return getTimeBucket(time, Downsampling.Minute);\n     }\n \n+    /**\n+     * Convert TimeBucket to Timestamp in millisecond.\n+     *\n+     * @param timeBucket long\n+     * @return timestamp in millisecond unit\n+     */\n+    public static long getTimestamp(long timeBucket) {\n+        if (isSecondBucket(timeBucket)) {\n+            return getTimestamp(timeBucket, Downsampling.Second);\n+        } else if (isMinuteBucket(timeBucket)) {\n+            return getTimestamp(timeBucket, Downsampling.Minute);\n+        } else if (isHourBucket(timeBucket)) {\n+            return getTimestamp(timeBucket, Downsampling.Hour);\n+        } else if (isDayBucket(timeBucket)) {\n+            return getTimestamp(timeBucket, Downsampling.Day);\n+        } else if (isMonthBucket(timeBucket)) {\n+            return getTimestamp(timeBucket, Downsampling.Month);\n+        } else {\n+            throw new UnexpectedException(\"Unknown downsampling value.\");\n+        }\n+    }\n+\n+    /**\n+     * The format of timeBucket in minute Unit is \"yyyyMMddHHmmss\", so which means the TimeBucket mush between", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e4375d038cd56498cd7f09365d6002136a3fd44"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMjI0Ng==", "bodyText": "better to use org.apache.skywalking.apm.agent.core.base64.Base64 for consistence, and the default charset here is different from other places", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379832246", "createdAt": "2020-02-15T13:43:20Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/query/ProfileThreadSnapshotQuery.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.query;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.Lists;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Base64;\n+import java.util.Collections;\n+import java.util.LinkedList;\n+import java.util.List;\n+import org.apache.skywalking.apm.util.StringUtil;\n+import org.apache.skywalking.oap.server.core.analysis.manual.segment.SegmentRecord;\n+import org.apache.skywalking.oap.server.core.profile.ProfileThreadSnapshotRecord;\n+import org.apache.skywalking.oap.server.core.query.entity.BasicTrace;\n+import org.apache.skywalking.oap.server.core.storage.profile.IProfileThreadSnapshotQueryDAO;\n+import org.apache.skywalking.oap.server.library.util.BooleanUtils;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.WhereQueryImpl;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.contains;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.eq;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.gte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.lte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.select;\n+\n+public class ProfileThreadSnapshotQuery implements IProfileThreadSnapshotQueryDAO {\n+    private final InfluxClient client;\n+\n+    public ProfileThreadSnapshotQuery(InfluxClient client) {\n+        this.client = client;\n+    }\n+\n+    @Override\n+    public List<BasicTrace> queryProfiledSegments(String taskId) throws IOException {\n+        WhereQueryImpl query = select(ProfileThreadSnapshotRecord.SEGMENT_ID)\n+            .from(client.getDatabase(), ProfileThreadSnapshotRecord.INDEX_NAME)\n+            .where()\n+            .and(eq(ProfileThreadSnapshotRecord.TASK_ID, taskId))\n+            .and(eq(ProfileThreadSnapshotRecord.SEQUENCE, 0));\n+\n+        final LinkedList<String> segments = new LinkedList<>();\n+        QueryResult.Series series = client.queryForSingleSeries(query);\n+        if (series == null) {\n+            return Collections.emptyList();\n+        }\n+        series.getValues().forEach(values -> {\n+            segments.add((String) values.get(1));\n+        });\n+\n+        if (segments.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+\n+        query = select()\n+            .function(\"bottom\", SegmentRecord.START_TIME, segments.size())\n+            .column(SegmentRecord.SEGMENT_ID)\n+            .column(SegmentRecord.START_TIME)\n+            .column(SegmentRecord.ENDPOINT_NAME)\n+            .column(SegmentRecord.LATENCY)\n+            .column(SegmentRecord.IS_ERROR)\n+            .column(SegmentRecord.TRACE_ID)\n+            .from(client.getDatabase(), SegmentRecord.INDEX_NAME)\n+            .where()\n+            .and(contains(SegmentRecord.SEGMENT_ID, Joiner.on(\"|\").join(segments)));\n+\n+        ArrayList<BasicTrace> result = Lists.newArrayListWithCapacity(segments.size());\n+        client.queryForSingleSeries(query)\n+              .getValues()\n+              .stream()\n+              .sorted((a, b) -> Long.compare(((Number) b.get(1)).longValue(), ((Number) a.get(1)).longValue()))\n+              .forEach(values -> {\n+                  BasicTrace basicTrace = new BasicTrace();\n+\n+                  basicTrace.setSegmentId((String) values.get(2));\n+                  basicTrace.setStart(String.valueOf(values.get(3)));\n+                  basicTrace.getEndpointNames().add((String) values.get(4));\n+                  basicTrace.setDuration((int) values.get(5));\n+                  basicTrace.setError(BooleanUtils.valueToBoolean((int) values.get(6)));\n+                  String traceIds = (String) values.get(7);\n+                  basicTrace.getTraceIds().add(traceIds);\n+\n+                  result.add(basicTrace);\n+              });\n+\n+        return result;\n+    }\n+\n+    @Override\n+    public int queryMinSequence(String segmentId, long start, long end) throws IOException {\n+        return querySequenceWithAgg(\"min\", segmentId, start, end);\n+    }\n+\n+    @Override\n+    public int queryMaxSequence(String segmentId, long start, long end) throws IOException {\n+        return querySequenceWithAgg(\"max\", segmentId, start, end);\n+    }\n+\n+    @Override\n+    public List<ProfileThreadSnapshotRecord> queryRecords(String segmentId, int minSequence,\n+                                                          int maxSequence) throws IOException {\n+        WhereQueryImpl query = select(\n+            ProfileThreadSnapshotRecord.TASK_ID,\n+            ProfileThreadSnapshotRecord.SEGMENT_ID,\n+            ProfileThreadSnapshotRecord.DUMP_TIME,\n+            ProfileThreadSnapshotRecord.SEQUENCE,\n+            ProfileThreadSnapshotRecord.STACK_BINARY\n+        )\n+            .from(client.getDatabase(), ProfileThreadSnapshotRecord.INDEX_NAME)\n+            .where(eq(ProfileThreadSnapshotRecord.SEGMENT_ID, segmentId))\n+            .and(gte(ProfileThreadSnapshotRecord.SEQUENCE, minSequence))\n+            .and(lte(ProfileThreadSnapshotRecord.SEQUENCE, maxSequence));\n+\n+        ArrayList<ProfileThreadSnapshotRecord> result = new ArrayList<>(maxSequence - minSequence);\n+        client.queryForSingleSeries(query).getValues().forEach(values -> {\n+            ProfileThreadSnapshotRecord record = new ProfileThreadSnapshotRecord();\n+\n+            record.setTaskId((String) values.get(1));\n+            record.setSegmentId((String) values.get(2));\n+            record.setDumpTime(((Number) values.get(3)).longValue());\n+            record.setSequence((int) values.get(4));\n+            String dataBinaryBase64 = String.valueOf(values.get(5));\n+            if (StringUtil.isNotEmpty(dataBinaryBase64)) {\n+                record.setStackBinary(Base64.getDecoder().decode(dataBinaryBase64));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e4375d038cd56498cd7f09365d6002136a3fd44"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMjcyNQ==", "bodyText": "is there any particular reason why you paginate here instead of paginating in InfluxDB server side (using the .limit)?\nwhy do you sort them again in a different order (SEGMENT_ID?) when you already have top by QueryOrder in line 74 - 80\n\nhope I did not miss any context", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379832725", "createdAt": "2020-02-15T13:52:29Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/query/TraceQuery.java", "diffHunk": "@@ -0,0 +1,217 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.query;\n+\n+import com.google.common.collect.Lists;\n+import java.io.IOException;\n+import java.util.Base64;\n+import java.util.Collections;\n+import java.util.List;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.analysis.manual.segment.SegmentRecord;\n+import org.apache.skywalking.oap.server.core.query.entity.BasicTrace;\n+import org.apache.skywalking.oap.server.core.query.entity.QueryOrder;\n+import org.apache.skywalking.oap.server.core.query.entity.Span;\n+import org.apache.skywalking.oap.server.core.query.entity.TraceBrief;\n+import org.apache.skywalking.oap.server.core.query.entity.TraceState;\n+import org.apache.skywalking.oap.server.core.storage.query.ITraceQueryDAO;\n+import org.apache.skywalking.oap.server.library.util.BooleanUtils;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.base.RecordDAO;\n+import org.elasticsearch.common.Strings;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.SelectQueryImpl;\n+import org.influxdb.querybuilder.WhereQueryImpl;\n+import org.influxdb.querybuilder.clauses.Clause;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.eq;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.gte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.lte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.regex;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.select;\n+\n+@Slf4j\n+public class TraceQuery implements ITraceQueryDAO {\n+    private final InfluxClient client;\n+\n+    public TraceQuery(InfluxClient client) {\n+        this.client = client;\n+    }\n+\n+    @Override\n+    public TraceBrief queryBasicTraces(long startSecondTB,\n+                                       long endSecondTB,\n+                                       long minDuration,\n+                                       long maxDuration,\n+                                       String endpointName,\n+                                       int serviceId,\n+                                       int serviceInstanceId,\n+                                       int endpointId,\n+                                       String traceId,\n+                                       int limit,\n+                                       int from,\n+                                       TraceState traceState,\n+                                       QueryOrder queryOrder)\n+        throws IOException {\n+\n+        String orderBy = SegmentRecord.START_TIME;\n+        if (queryOrder == QueryOrder.BY_DURATION) {\n+            orderBy = SegmentRecord.LATENCY;\n+        }\n+\n+        WhereQueryImpl<SelectQueryImpl> recallQuery = select()\n+            .function(\"top\", orderBy, limit + from)\n+            .column(SegmentRecord.SEGMENT_ID)\n+            .column(SegmentRecord.START_TIME)\n+            .column(SegmentRecord.ENDPOINT_NAME)\n+            .column(SegmentRecord.LATENCY)\n+            .column(SegmentRecord.IS_ERROR)\n+            .column(SegmentRecord.TRACE_ID)\n+            .from(client.getDatabase(), SegmentRecord.INDEX_NAME)\n+            .where();\n+\n+        if (startSecondTB != 0 && endSecondTB != 0) {\n+            recallQuery.and(gte(SegmentRecord.TIME_BUCKET, startSecondTB))\n+                       .and(lte(SegmentRecord.TIME_BUCKET, endSecondTB));\n+        }\n+        if (minDuration != 0) {\n+            recallQuery.and(gte(SegmentRecord.LATENCY, minDuration));\n+        }\n+        if (maxDuration != 0) {\n+            recallQuery.and(lte(SegmentRecord.LATENCY, maxDuration));\n+        }\n+        if (!Strings.isNullOrEmpty(endpointName)) {\n+            recallQuery.and(regex(SegmentRecord.ENDPOINT_NAME, \"/\" + endpointName.replaceAll(\"/\", \"\\\\\\\\/\") + \"/\"));\n+        }\n+        if (serviceId != 0) {\n+            recallQuery.and(eq(RecordDAO.TAG_SERVICE_ID, String.valueOf(serviceId)));\n+        }\n+        if (serviceInstanceId != 0) {\n+            recallQuery.and(eq(SegmentRecord.SERVICE_INSTANCE_ID, serviceInstanceId));\n+        }\n+        if (endpointId != 0) {\n+            recallQuery.and(eq(SegmentRecord.ENDPOINT_ID, endpointId));\n+        }\n+        if (!Strings.isNullOrEmpty(traceId)) {\n+            recallQuery.and(eq(SegmentRecord.TRACE_ID, traceId));\n+        }\n+        switch (traceState) {\n+            case ERROR:\n+                recallQuery.and(eq(SegmentRecord.IS_ERROR, BooleanUtils.TRUE));\n+                break;\n+            case SUCCESS:\n+                recallQuery.and(eq(SegmentRecord.IS_ERROR, BooleanUtils.FALSE));\n+                break;\n+        }\n+\n+        WhereQueryImpl<SelectQueryImpl> countQuery = select()\n+            .count(SegmentRecord.ENDPOINT_ID)\n+            .from(client.getDatabase(), SegmentRecord.INDEX_NAME)\n+            .where();\n+        for (Clause clause : recallQuery.getClauses()) {\n+            countQuery.where(clause);\n+        }\n+        Query query = new Query(countQuery.getCommand() + recallQuery.getCommand());\n+\n+        List<QueryResult.Result> results = client.query(query);\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"SQL: {} result set: {}\", query.getCommand(), results);\n+        }\n+        if (results.size() != 2) {\n+            throw new IOException(\"Expecting to get 2 Results, but it is \" + results.size());\n+        }\n+        List<QueryResult.Series> counter = results.get(0).getSeries();\n+        List<QueryResult.Series> result = results.get(1).getSeries();\n+        if (result == null || result.isEmpty()) {\n+            return new TraceBrief();\n+        }\n+\n+        TraceBrief traceBrief = new TraceBrief();\n+        traceBrief.setTotal(((Number) counter.get(0).getValues().get(0).get(1)).intValue());\n+\n+        result.get(0).getValues().stream().sorted((a, b) -> {\n+            return Long.compare(((Number) b.get(1)).longValue(), ((Number) a.get(1)).longValue());\n+        }).skip(from).forEach(values -> {\n+            BasicTrace basicTrace = new BasicTrace();\n+\n+            basicTrace.setSegmentId((String) values.get(2));\n+            basicTrace.setStart(String.valueOf((long) values.get(3)));\n+            basicTrace.getEndpointNames().add((String) values.get(4));\n+            basicTrace.setDuration((int) values.get(5));\n+            basicTrace.setError(BooleanUtils.valueToBoolean((int) values.get(6)));\n+            basicTrace.getTraceIds().add((String) values.get(7));\n+\n+            traceBrief.getTraces().add(basicTrace);\n+        });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e4375d038cd56498cd7f09365d6002136a3fd44"}, "originalPosition": 162}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMjg3MQ==", "bodyText": "All the WhereQueryImpl may be replaced by  org.influxdb.dto.Query?", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379832871", "createdAt": "2020-02-15T13:54:54Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/query/TraceQuery.java", "diffHunk": "@@ -0,0 +1,217 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.query;\n+\n+import com.google.common.collect.Lists;\n+import java.io.IOException;\n+import java.util.Base64;\n+import java.util.Collections;\n+import java.util.List;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.analysis.manual.segment.SegmentRecord;\n+import org.apache.skywalking.oap.server.core.query.entity.BasicTrace;\n+import org.apache.skywalking.oap.server.core.query.entity.QueryOrder;\n+import org.apache.skywalking.oap.server.core.query.entity.Span;\n+import org.apache.skywalking.oap.server.core.query.entity.TraceBrief;\n+import org.apache.skywalking.oap.server.core.query.entity.TraceState;\n+import org.apache.skywalking.oap.server.core.storage.query.ITraceQueryDAO;\n+import org.apache.skywalking.oap.server.library.util.BooleanUtils;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.base.RecordDAO;\n+import org.elasticsearch.common.Strings;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.SelectQueryImpl;\n+import org.influxdb.querybuilder.WhereQueryImpl;\n+import org.influxdb.querybuilder.clauses.Clause;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.eq;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.gte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.lte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.regex;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.select;\n+\n+@Slf4j\n+public class TraceQuery implements ITraceQueryDAO {\n+    private final InfluxClient client;\n+\n+    public TraceQuery(InfluxClient client) {\n+        this.client = client;\n+    }\n+\n+    @Override\n+    public TraceBrief queryBasicTraces(long startSecondTB,\n+                                       long endSecondTB,\n+                                       long minDuration,\n+                                       long maxDuration,\n+                                       String endpointName,\n+                                       int serviceId,\n+                                       int serviceInstanceId,\n+                                       int endpointId,\n+                                       String traceId,\n+                                       int limit,\n+                                       int from,\n+                                       TraceState traceState,\n+                                       QueryOrder queryOrder)\n+        throws IOException {\n+\n+        String orderBy = SegmentRecord.START_TIME;\n+        if (queryOrder == QueryOrder.BY_DURATION) {\n+            orderBy = SegmentRecord.LATENCY;\n+        }\n+\n+        WhereQueryImpl<SelectQueryImpl> recallQuery = select()\n+            .function(\"top\", orderBy, limit + from)\n+            .column(SegmentRecord.SEGMENT_ID)\n+            .column(SegmentRecord.START_TIME)\n+            .column(SegmentRecord.ENDPOINT_NAME)\n+            .column(SegmentRecord.LATENCY)\n+            .column(SegmentRecord.IS_ERROR)\n+            .column(SegmentRecord.TRACE_ID)\n+            .from(client.getDatabase(), SegmentRecord.INDEX_NAME)\n+            .where();\n+\n+        if (startSecondTB != 0 && endSecondTB != 0) {\n+            recallQuery.and(gte(SegmentRecord.TIME_BUCKET, startSecondTB))\n+                       .and(lte(SegmentRecord.TIME_BUCKET, endSecondTB));\n+        }\n+        if (minDuration != 0) {\n+            recallQuery.and(gte(SegmentRecord.LATENCY, minDuration));\n+        }\n+        if (maxDuration != 0) {\n+            recallQuery.and(lte(SegmentRecord.LATENCY, maxDuration));\n+        }\n+        if (!Strings.isNullOrEmpty(endpointName)) {\n+            recallQuery.and(regex(SegmentRecord.ENDPOINT_NAME, \"/\" + endpointName.replaceAll(\"/\", \"\\\\\\\\/\") + \"/\"));\n+        }\n+        if (serviceId != 0) {\n+            recallQuery.and(eq(RecordDAO.TAG_SERVICE_ID, String.valueOf(serviceId)));\n+        }\n+        if (serviceInstanceId != 0) {\n+            recallQuery.and(eq(SegmentRecord.SERVICE_INSTANCE_ID, serviceInstanceId));\n+        }\n+        if (endpointId != 0) {\n+            recallQuery.and(eq(SegmentRecord.ENDPOINT_ID, endpointId));\n+        }\n+        if (!Strings.isNullOrEmpty(traceId)) {\n+            recallQuery.and(eq(SegmentRecord.TRACE_ID, traceId));\n+        }\n+        switch (traceState) {\n+            case ERROR:\n+                recallQuery.and(eq(SegmentRecord.IS_ERROR, BooleanUtils.TRUE));\n+                break;\n+            case SUCCESS:\n+                recallQuery.and(eq(SegmentRecord.IS_ERROR, BooleanUtils.FALSE));\n+                break;\n+        }\n+\n+        WhereQueryImpl<SelectQueryImpl> countQuery = select()\n+            .count(SegmentRecord.ENDPOINT_ID)\n+            .from(client.getDatabase(), SegmentRecord.INDEX_NAME)\n+            .where();\n+        for (Clause clause : recallQuery.getClauses()) {\n+            countQuery.where(clause);\n+        }\n+        Query query = new Query(countQuery.getCommand() + recallQuery.getCommand());\n+\n+        List<QueryResult.Result> results = client.query(query);\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"SQL: {} result set: {}\", query.getCommand(), results);\n+        }\n+        if (results.size() != 2) {\n+            throw new IOException(\"Expecting to get 2 Results, but it is \" + results.size());\n+        }\n+        List<QueryResult.Series> counter = results.get(0).getSeries();\n+        List<QueryResult.Series> result = results.get(1).getSeries();\n+        if (result == null || result.isEmpty()) {\n+            return new TraceBrief();\n+        }\n+\n+        TraceBrief traceBrief = new TraceBrief();\n+        traceBrief.setTotal(((Number) counter.get(0).getValues().get(0).get(1)).intValue());\n+\n+        result.get(0).getValues().stream().sorted((a, b) -> {\n+            return Long.compare(((Number) b.get(1)).longValue(), ((Number) a.get(1)).longValue());\n+        }).skip(from).forEach(values -> {\n+            BasicTrace basicTrace = new BasicTrace();\n+\n+            basicTrace.setSegmentId((String) values.get(2));\n+            basicTrace.setStart(String.valueOf((long) values.get(3)));\n+            basicTrace.getEndpointNames().add((String) values.get(4));\n+            basicTrace.setDuration((int) values.get(5));\n+            basicTrace.setError(BooleanUtils.valueToBoolean((int) values.get(6)));\n+            basicTrace.getTraceIds().add((String) values.get(7));\n+\n+            traceBrief.getTraces().add(basicTrace);\n+        });\n+        return traceBrief;\n+    }\n+\n+    @Override\n+    public List<SegmentRecord> queryByTraceId(String traceId) throws IOException {\n+        WhereQueryImpl query = select().column(SegmentRecord.SEGMENT_ID)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e4375d038cd56498cd7f09365d6002136a3fd44"}, "originalPosition": 168}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMzExMQ==", "bodyText": "did not find related documentation, but will .raw(\"*::field\") be more efficient?", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379833111", "createdAt": "2020-02-15T13:59:16Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/MetricsDAO.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.base;\n+\n+import com.google.common.base.Joiner;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Maps;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.storage.IMetricsDAO;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.model.Model;\n+import org.apache.skywalking.oap.server.core.storage.model.ModelColumn;\n+import org.apache.skywalking.oap.server.core.storage.type.StorageDataType;\n+import org.apache.skywalking.oap.server.library.client.request.InsertRequest;\n+import org.apache.skywalking.oap.server.library.client.request.UpdateRequest;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.SelectQueryImpl;\n+import org.influxdb.querybuilder.WhereQueryImpl;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.contains;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.select;\n+\n+public class MetricsDAO implements IMetricsDAO {\n+    public static final String TAG_ENTITY_ID = \"_entity_id\";\n+\n+    private final StorageBuilder<Metrics> storageBuilder;\n+    private final InfluxClient client;\n+\n+    public MetricsDAO(InfluxClient client, StorageBuilder<Metrics> storageBuilder) {\n+        this.client = client;\n+        this.storageBuilder = storageBuilder;\n+    }\n+\n+    @Override\n+    public List<Metrics> multiGet(Model model, List<String> ids) throws IOException {\n+        WhereQueryImpl<SelectQueryImpl> query = select()\n+            .regex(\"*::field\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e4375d038cd56498cd7f09365d6002136a3fd44"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMzUzNA==", "bodyText": "why do you need this? seems the limit doesn't include the offset", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379833534", "createdAt": "2020-02-15T14:06:44Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/query/LogQuery.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.query;\n+\n+import com.google.common.collect.Maps;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord;\n+import org.apache.skywalking.oap.server.core.query.entity.ContentType;\n+import org.apache.skywalking.oap.server.core.query.entity.Log;\n+import org.apache.skywalking.oap.server.core.query.entity.LogState;\n+import org.apache.skywalking.oap.server.core.query.entity.Logs;\n+import org.apache.skywalking.oap.server.core.query.entity.Pagination;\n+import org.apache.skywalking.oap.server.core.storage.query.ILogQueryDAO;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.base.RecordDAO;\n+import org.elasticsearch.common.Strings;\n+import org.influxdb.dto.Query;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.SelectQueryImpl;\n+import org.influxdb.querybuilder.WhereQueryImpl;\n+import org.influxdb.querybuilder.clauses.ConjunctionClause;\n+\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.CONTENT;\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.CONTENT_TYPE;\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.ENDPOINT_ID;\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.IS_ERROR;\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.SERVICE_ID;\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.SERVICE_INSTANCE_ID;\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.STATUS_CODE;\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.TIMESTAMP;\n+import static org.apache.skywalking.oap.server.core.analysis.manual.log.AbstractLogRecord.TRACE_ID;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.eq;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.gte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.lte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.select;\n+\n+@Slf4j\n+public class LogQuery implements ILogQueryDAO {\n+    private final InfluxClient client;\n+\n+    public LogQuery(InfluxClient client) {\n+        this.client = client;\n+    }\n+\n+    @Override\n+    public Logs queryLogs(String metricName, int serviceId, int serviceInstanceId, int endpointId, String traceId,\n+                          LogState state, String stateCode, Pagination paging, int from, int limit,\n+                          long startTB, long endTB) throws IOException {\n+        WhereQueryImpl<SelectQueryImpl> recallQuery = select().regex(\"*::field\")\n+            .from(client.getDatabase(), metricName)\n+            .where();\n+        if (serviceId != Const.NONE) {\n+            recallQuery.and(eq(RecordDAO.TAG_SERVICE_ID, String.valueOf(serviceId)));\n+        }\n+        if (serviceInstanceId != Const.NONE) {\n+            recallQuery.and(eq(SERVICE_INSTANCE_ID, serviceInstanceId));\n+        }\n+        if (endpointId != Const.NONE) {\n+            recallQuery.and(eq(ENDPOINT_ID, endpointId));\n+        }\n+        if (!Strings.isNullOrEmpty(traceId)) {\n+            recallQuery.and(eq(TRACE_ID, traceId));\n+        }\n+        switch (state) {\n+            case ERROR: {\n+                recallQuery.and(eq(IS_ERROR, true));\n+                break;\n+            }\n+            case SUCCESS: {\n+                recallQuery.and(eq(IS_ERROR, false));\n+                break;\n+            }\n+        }\n+        if (!Strings.isNullOrEmpty(stateCode)) {\n+            recallQuery.and(eq(STATUS_CODE, stateCode));\n+        }\n+        recallQuery.and(gte(AbstractLogRecord.TIME_BUCKET, startTB))\n+                   .and(lte(AbstractLogRecord.TIME_BUCKET, endTB));\n+\n+        if (from > Const.NONE) {\n+            limit += from;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e4375d038cd56498cd7f09365d6002136a3fd44"}, "originalPosition": 101}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c89569139575f2433d9ca765831c9883ea4d84c6", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/c89569139575f2433d9ca765831c9883ea4d84c6", "committedDate": "2020-02-16T01:04:02Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7997153876604bd96aee55506e6d942cce01a98a", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/7997153876604bd96aee55506e6d942cce01a98a", "committedDate": "2020-02-16T07:26:12Z", "message": "fix typo and scape $"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13698b55ed1e501475fa4069d0fcadd133b581c5", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/13698b55ed1e501475fa4069d0fcadd133b581c5", "committedDate": "2020-02-16T07:32:37Z", "message": "fix limit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NDAwODY1", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-359400865", "createdAt": "2020-02-16T12:40:02Z", "commit": {"oid": "13698b55ed1e501475fa4069d0fcadd133b581c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxMjo0MDowMlrOFqTRgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxMjo0MDowMlrOFqTRgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkwMDI5MA==", "bodyText": "Why this doesn't have --storage=elasticsearch? What is the default? Or what happens if no --storage=?\nI expect a fail when missing this parameter.", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r379900290", "createdAt": "2020-02-16T12:40:02Z", "author": {"login": "wu-sheng"}, "path": ".github/workflows/e2e.yaml", "diffHunk": "@@ -71,15 +73,19 @@ jobs:\n           ./mvnw --batch-mode -Dcheckstyle.skip -Drat.skip -T2 -Dmaven.compile.fork -Dmaven.compiler.maxmem=3072 -DskipTests clean install\n           ./mvnw --batch-mode -f test/e2e/pom.xml -pl e2e-base clean install\n       - name: Cluster Tests (ES6/ZK/JDK8)\n-        run: export E2E_VERSION=jdk8-1.3 && bash -x test/e2e/run.sh e2e-cluster/e2e-cluster-test-runner\n+        run: export E2E_VERSION=jdk8-1.5 && bash -x test/e2e/run.sh e2e-cluster/e2e-cluster-test-runner --storage=elasticsearch\n+      - name: Cluster Tests (InfluxDB/ZK/JDK8)\n+        run: export E2E_VERSION=jdk8-1.5 && bash -x test/e2e/run.sh e2e-cluster/e2e-cluster-test-runner --storage=influxdb\n       - name: Cluster With Gateway Tests (ES6/ZK/JDK8)\n-        run: export E2E_VERSION=jdk8-1.3 && bash -x test/e2e/run.sh e2e-cluster-with-gateway/e2e-cluster-with-gateway-test-runner\n+        run: export E2E_VERSION=jdk8-1.5 && bash -x test/e2e/run.sh e2e-cluster-with-gateway/e2e-cluster-with-gateway-test-runner", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13698b55ed1e501475fa4069d0fcadd133b581c5"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4e13a6f18019cb17f0092a696dcfc3631a15565", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/a4e13a6f18019cb17f0092a696dcfc3631a15565", "committedDate": "2020-02-16T14:17:40Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NTU3OTMz", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-359557933", "createdAt": "2020-02-17T08:32:44Z", "commit": {"oid": "a4e13a6f18019cb17f0092a696dcfc3631a15565"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwODozMjo0NVrOFqb2sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwODozMjo0NVrOFqb2sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0MDg4Mw==", "bodyText": "There is another missing here, PROFILE_TASK_LOG. Could you check why this is missed but still tests passed? Does InfluxDB have the profile e2e?", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r380040883", "createdAt": "2020-02-17T08:32:45Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/installer/MetaTableDefine.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.installer;\n+\n+import org.apache.skywalking.oap.server.core.storage.model.Model;\n+import org.apache.skywalking.oap.server.storage.plugin.jdbc.TableMetaInfo;\n+\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.ENDPOINT_INVENTORY;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.NETWORK_ADDRESS;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.PROFILE_TASK;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.PROFILE_TASK_SEGMENT_SNAPSHOT;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.SERVICE_INSTANCE_INVENTORY;\n+import static org.apache.skywalking.oap.server.core.source.DefaultScopeDefine.SERVICE_INVENTORY;\n+\n+/**\n+ * Here defines which table is stored in metadata database(H2/MySQL).\n+ */\n+public class MetaTableDefine {\n+\n+    /**\n+     * Test a {@link Model} is stored in H2/MySQL or not.\n+     *\n+     * @param model Model\n+     * @return true if the {@link Model} is stored in H2/MySQL\n+     */\n+    public static boolean contains(Model model) {\n+        switch (model.getScopeId()) {\n+            case SERVICE_INVENTORY:\n+            case SERVICE_INSTANCE_INVENTORY:\n+            case NETWORK_ADDRESS:\n+            case ENDPOINT_INVENTORY:\n+            case PROFILE_TASK:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4e13a6f18019cb17f0092a696dcfc3631a15565"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NTYyMjUx", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-359562251", "createdAt": "2020-02-17T08:40:56Z", "commit": {"oid": "a4e13a6f18019cb17f0092a696dcfc3631a15565"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwODo0MDo1NlrOFqcENQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwODo0MDo1NlrOFqcENQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0NDM0MQ==", "bodyText": "As you mentioned last time, the result is unordered. Could you add the comments some places to ease the readers?", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r380044341", "createdAt": "2020-02-17T08:40:56Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/query/AggregationQuery.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.storage.plugin.influxdb.query;\n+\n+import com.google.common.collect.Lists;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.List;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.analysis.Downsampling;\n+import org.apache.skywalking.oap.server.core.query.entity.Order;\n+import org.apache.skywalking.oap.server.core.query.entity.TopNEntity;\n+import org.apache.skywalking.oap.server.core.register.EndpointInventory;\n+import org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory;\n+import org.apache.skywalking.oap.server.core.storage.model.ModelName;\n+import org.apache.skywalking.oap.server.core.storage.query.IAggregationQueryDAO;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.InfluxClient;\n+import org.apache.skywalking.oap.server.storage.plugin.influxdb.base.MetricsDAO;\n+import org.influxdb.dto.QueryResult;\n+import org.influxdb.querybuilder.SelectQueryImpl;\n+import org.influxdb.querybuilder.SelectSubQueryImpl;\n+\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.eq;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.gte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.lte;\n+import static org.influxdb.querybuilder.BuiltQuery.QueryBuilder.select;\n+\n+@Slf4j\n+public class AggregationQuery implements IAggregationQueryDAO {\n+    private InfluxClient client;\n+\n+    public AggregationQuery(InfluxClient client) {\n+        this.client = client;\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getServiceTopN(String indName, String valueCName, int topN, Downsampling downsampling,\n+                                           long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(downsampling, indName, subQuery(indName, valueCName, startTB, endTB), order, topN);\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getAllServiceInstanceTopN(String indName, String valueCName, int topN,\n+                                                      Downsampling downsampling,\n+                                                      long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(downsampling, indName, subQuery(indName, valueCName, startTB, endTB), order, topN);\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getServiceInstanceTopN(int serviceId, String indName, String valueCName, int topN,\n+                                                   Downsampling downsampling,\n+                                                   long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(\n+            downsampling, indName,\n+            subQuery(ServiceInstanceInventory.SERVICE_ID, serviceId, indName, valueCName, startTB, endTB), order, topN\n+        );\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getAllEndpointTopN(String indName, String valueCName, int topN, Downsampling downsampling,\n+                                               long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(downsampling, indName, subQuery(indName, valueCName, startTB, endTB), order, topN);\n+    }\n+\n+    @Override\n+    public List<TopNEntity> getEndpointTopN(int serviceId, String indName, String valueCName, int topN,\n+                                            Downsampling downsampling,\n+                                            long startTB, long endTB, Order order) throws IOException {\n+        return getTopNEntity(\n+            downsampling, indName,\n+            subQuery(EndpointInventory.SERVICE_ID, serviceId, indName, valueCName, startTB, endTB), order, topN\n+        );\n+    }\n+\n+    private List<TopNEntity> getTopNEntity(Downsampling downsampling,\n+                                           String name,\n+                                           SelectSubQueryImpl<SelectQueryImpl> subQuery,\n+                                           Order order,\n+                                           int topN) throws IOException {\n+        String measurement = ModelName.build(downsampling, name);\n+        Comparator<TopNEntity> comparator = DESCENDING;\n+        String functionName = \"top\";\n+        if (order == Order.ASC) {\n+            functionName = \"bottom\";\n+            comparator = ASCENDING;\n+        }\n+\n+        SelectQueryImpl query = select().function(functionName, \"mean\", topN).as(\"value\")\n+                                        .column(MetricsDAO.TAG_ENTITY_ID)\n+                                        .from(client.getDatabase(), measurement);\n+        query.setSubQuery(subQuery);\n+\n+        List<QueryResult.Series> series = client.queryForSeries(query);\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"SQL: {} result set: {}\", query.getCommand(), series);\n+        }\n+        if (series == null || series.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+\n+        List<List<Object>> dataset = series.get(0).getValues();\n+        List<TopNEntity> entities = Lists.newArrayListWithCapacity(dataset.size());\n+        dataset.forEach(values -> {\n+            final TopNEntity entity = new TopNEntity();\n+            entity.setId((String) values.get(2));\n+            entity.setValue(((Double) values.get(1)).longValue());\n+            entities.add(entity);\n+        });\n+        Collections.sort(entities, comparator);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4e13a6f18019cb17f0092a696dcfc3631a15565"}, "originalPosition": 126}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NTYzNTI1", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-359563525", "createdAt": "2020-02-17T08:43:19Z", "commit": {"oid": "a4e13a6f18019cb17f0092a696dcfc3631a15565"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwODo0MzoyMFrOFqcIJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwODo0MzoyMFrOFqcIJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0NTM0OQ==", "bodyText": "remove this, and those in other files", "url": "https://github.com/apache/skywalking/pull/4239#discussion_r380045349", "createdAt": "2020-02-17T08:43:20Z", "author": {"login": "kezhenxu94"}, "path": "test/e2e/e2e-ttl/e2e-ttl-influxdb/src/test/java/org/apache/skywalking/e2e/StorageTTLITCase.java", "diffHunk": "@@ -0,0 +1,285 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.skywalking.e2e;\n+\n+import io.grpc.ManagedChannel;\n+import io.grpc.ManagedChannelBuilder;\n+import io.grpc.internal.DnsNameResolverProvider;\n+import io.grpc.netty.NettyChannelBuilder;\n+import io.grpc.stub.StreamObserver;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.apm.network.common.DetectPoint;\n+import org.apache.skywalking.apm.network.servicemesh.MeshProbeDownstream;\n+import org.apache.skywalking.apm.network.servicemesh.Protocol;\n+import org.apache.skywalking.apm.network.servicemesh.ServiceMeshMetric;\n+import org.apache.skywalking.apm.network.servicemesh.ServiceMeshMetricServiceGrpc;\n+import org.apache.skywalking.e2e.metrics.AllOfMetricsMatcher;\n+import org.apache.skywalking.e2e.metrics.AtLeastOneOfMetricsMatcher;\n+import org.apache.skywalking.e2e.metrics.Metrics;\n+import org.apache.skywalking.e2e.metrics.MetricsQuery;\n+import org.apache.skywalking.e2e.metrics.MetricsValueMatcher;\n+import org.apache.skywalking.e2e.service.Service;\n+import org.apache.skywalking.e2e.service.ServicesQuery;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.time.LocalDateTime;\n+import java.time.ZoneOffset;\n+import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n+\n+import static org.apache.skywalking.e2e.metrics.MetricsQuery.SERVICE_RESP_TIME;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+/**\n+ * @author kezhenxu94\n+ */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4e13a6f18019cb17f0092a696dcfc3631a15565"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc127d72ae89c24acbb54abc10a81c09adca99c0", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/bc127d72ae89c24acbb54abc10a81c09adca99c0", "committedDate": "2020-02-17T09:12:18Z", "message": "Merge branch 'master' into influx-storage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NTg3ODM3", "url": "https://github.com/apache/skywalking/pull/4239#pullrequestreview-359587837", "createdAt": "2020-02-17T09:23:31Z", "commit": {"oid": "a4e13a6f18019cb17f0092a696dcfc3631a15565"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f32679868000c5e810cf4bdcc0ca2a80f5756e79", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/f32679868000c5e810cf4bdcc0ca2a80f5756e79", "committedDate": "2020-02-17T13:38:05Z", "message": "polish"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2579, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}