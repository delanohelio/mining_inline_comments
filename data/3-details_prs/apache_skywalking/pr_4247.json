{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNTIxNzU0", "number": 4247, "title": "fix thread unsafe problem in server-alarm-plugin (#4230)", "bodyText": "Please answer these questions before submitting pull request\n\n\nWhy submit this pull request?\n\n\n Bug fix\n\n\n New feature provided\n\n\n Improve performance\n\n\nRelated issues\n#4230\n\n\n\nBug fix\n\n\nBug description.\nfix thread-unsafe operation\n\n\nHow to fix?\n\n\n\nNew feature or improvement\n\nDescribe the details and related test reports.", "createdAt": "2020-01-16T08:39:02Z", "url": "https://github.com/apache/skywalking/pull/4247", "merged": true, "mergeCommit": {"oid": "72e6888ae3ff4df5d6c36084cdce44ad7d8423a2"}, "closed": true, "closedAt": "2020-01-20T01:57:36Z", "author": {"login": "liuhaoXD"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb61-V8AH2gAyMzYzNTIxNzU0OjgyYzdiY2NkMGQ4NDE2Y2E4OGE1NWIxMzU1OTExODFmZjllODE4MzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8CrK-gFqTM0NTA1MDA2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "82c7bccd0d8416ca88a55b135591181ff9e81834", "author": {"user": {"login": "liuhaoXD", "name": "Liu Hao"}}, "url": "https://github.com/apache/skywalking/commit/82c7bccd0d8416ca88a55b135591181ff9e81834", "committedDate": "2020-01-16T08:35:36Z", "message": "fix thread unsafe problem in server-alarm-plugin (#4230)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c7fd0c1e34fc4056083f44378325b1354911c30", "author": {"user": {"login": "liuhaoXD", "name": "Liu Hao"}}, "url": "https://github.com/apache/skywalking/commit/1c7fd0c1e34fc4056083f44378325b1354911c30", "committedDate": "2020-01-16T08:39:38Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "765162dbd0a205800d187914ffa0ca4f25069bb2", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/765162dbd0a205800d187914ffa0ca4f25069bb2", "committedDate": "2020-01-16T13:15:16Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85b1107ae29652b3a4df2cd3b11ded78d41171eb", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/85b1107ae29652b3a4df2cd3b11ded78d41171eb", "committedDate": "2020-01-18T15:19:48Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTc4NTUz", "url": "https://github.com/apache/skywalking/pull/4247#pullrequestreview-344978553", "createdAt": "2020-01-19T05:48:45Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQwNTo0ODo0NVrOFfNSEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQwNTo0OTo0OFrOFfNSLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2Nzc5NA==", "bodyText": "Why change this name?", "url": "https://github.com/apache/skywalking/pull/4247#discussion_r368267794", "createdAt": "2020-01-19T05:48:45Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/RunningRule.java", "diffHunk": "@@ -187,7 +182,7 @@ public void moveTo(LocalDateTime targetTime) {\n         private int silenceCountdown;\n \n         private LinkedList<Metrics> values;\n-        private ReentrantLock lock = new ReentrantLock();\n+        private ReentrantLock reentrantLock = new ReentrantLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2NzgxMA==", "bodyText": "Why change this?", "url": "https://github.com/apache/skywalking/pull/4247#discussion_r368267810", "createdAt": "2020-01-19T05:49:18Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/RunningRule.java", "diffHunk": "@@ -86,7 +83,7 @@ public RunningRule(AlarmRule alarmRule) {\n      * Receive metrics result from persistence, after it is saved into storage. In alarm, only minute dimensionality\n      * metrics are expected to process.\n      *\n-     * @param meta of input metrics\n+     * @param meta    of input metrics", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2NzgyMw==", "bodyText": "What change the format of all these cases?", "url": "https://github.com/apache/skywalking/pull/4247#discussion_r368267823", "createdAt": "2020-01-19T05:49:48Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/RunningRule.java", "diffHunk": "@@ -290,28 +278,28 @@ private boolean isMatch() {\n \n                 switch (valueType) {\n                     case LONG:\n-                        long lvalue = ((LongValueHolder)metrics).getValue();\n+                        long lvalue = ((LongValueHolder) metrics).getValue();\n                         long lexpected = RunningRule.this.threshold.getLongThreshold();\n                         if (op.test(lexpected, lvalue)) {\n                             matchCount++;\n                         }\n                         break;\n                     case INT:\n-                        int ivalue = ((IntValueHolder)metrics).getValue();\n+                        int ivalue = ((IntValueHolder) metrics).getValue();\n                         int iexpected = RunningRule.this.threshold.getIntThreshold();\n                         if (op.test(iexpected, ivalue)) {\n                             matchCount++;\n                         }\n                         break;\n                     case DOUBLE:\n-                        double dvalue = ((DoubleValueHolder)metrics).getValue();\n+                        double dvalue = ((DoubleValueHolder) metrics).getValue();\n                         double dexpected = RunningRule.this.threshold.getDoubleThreshold();\n                         if (op.test(dexpected, dvalue)) {\n                             matchCount++;\n                         }\n                         break;\n                     case MULTI_INTS:\n-                        int[] ivalueArray = ((MultiIntValuesHolder)metrics).getValues();\n+                        int[] ivalueArray = ((MultiIntValuesHolder) metrics).getValues();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 143}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "85b1107ae29652b3a4df2cd3b11ded78d41171eb", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/85b1107ae29652b3a4df2cd3b11ded78d41171eb", "committedDate": "2020-01-18T15:19:48Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd761fcc79879c3197dff7cccb6c6d3290f9a2e6", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/dd761fcc79879c3197dff7cccb6c6d3290f9a2e6", "committedDate": "2020-01-19T09:51:13Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0d3f758dba8835be85278ba361a3ceccfbf8933", "author": {"user": {"login": "liuhaoXD", "name": "Liu Hao"}}, "url": "https://github.com/apache/skywalking/commit/e0d3f758dba8835be85278ba361a3ceccfbf8933", "committedDate": "2020-01-19T10:04:34Z", "message": "remove redundant #moveTo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9855bba559ecf855a54fea9627806c69e02c272", "author": {"user": {"login": "liuhaoXD", "name": "Liu Hao"}}, "url": "https://github.com/apache/skywalking/commit/a9855bba559ecf855a54fea9627806c69e02c272", "committedDate": "2020-01-19T10:16:12Z", "message": "Merge branch 'develop'"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTkzMTgz", "url": "https://github.com/apache/skywalking/pull/4247#pullrequestreview-344993183", "createdAt": "2020-01-19T10:47:09Z", "commit": {"oid": "a9855bba559ecf855a54fea9627806c69e02c272"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQxMDo0NzowOVrOFfOSRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQxMDo0NzowOVrOFfOSRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4NDIzMA==", "bodyText": "Why add this? End time has been initialized in the constructor. End time should never be null. Right?", "url": "https://github.com/apache/skywalking/pull/4247#discussion_r368284230", "createdAt": "2020-01-19T10:47:09Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-alarm-plugin/src/main/java/org/apache/skywalking/oap/server/core/alarm/provider/RunningRule.java", "diffHunk": "@@ -227,18 +221,17 @@ public void moveTo(LocalDateTime current) {\n         public void add(Metrics metrics) {\n             long bucket = metrics.getTimeBucket();\n \n-            LocalDateTime timebucket = TIME_BUCKET_FORMATTER.parseLocalDateTime(bucket + \"\");\n-\n-            int minutes = Minutes.minutesBetween(timebucket, endTime).getMinutes();\n-            if (minutes == -1) {\n-                this.moveTo(timebucket);\n-\n-            }\n+            LocalDateTime timeBucket = TIME_BUCKET_FORMATTER.parseLocalDateTime(bucket + \"\");\n \n-            lock.lock();\n+            this.lock.lock();\n             try {\n+                if (this.endTime == null) {\n+                    init();\n+                    this.endTime = timeBucket;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9855bba559ecf855a54fea9627806c69e02c272"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MDA0NTY1", "url": "https://github.com/apache/skywalking/pull/4247#pullrequestreview-345004565", "createdAt": "2020-01-19T14:11:22Z", "commit": {"oid": "a9855bba559ecf855a54fea9627806c69e02c272"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MDUwMDY2", "url": "https://github.com/apache/skywalking/pull/4247#pullrequestreview-345050066", "createdAt": "2020-01-20T01:57:21Z", "commit": {"oid": "a9855bba559ecf855a54fea9627806c69e02c272"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2596, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}