{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NzE2MDkz", "number": 4364, "title": "Support Downsampling Data Packing feature in ES storage implementation", "bodyText": "Downsampling Data Packing\nDownsampling data packing(storage/elasticsearch/enablePackedDownsampling, default activated) is a new feature since 7.0.0.\nMetrics data has 4 different precisions, based on core/default/downsampling configurations.\nIn previous(6.x), every precision of each metrics had one separated\nindex. After this is activated, metrics of day and hour precisions are merged into minute precision. The number of indexes\ndecreased, and cause less payload to the ElasticSearch server.\nThe new data format preview\n\nAfter enabling this feature, 3 precisions of metrics data are all existing in one index(minute precision).\nWhy query could keep in the same.\nFrom my understanding, once query could use the right name(merged index name), as they are using different timestamp format(because of precision, length is different), they will exclude other precision data automatically. So no change is required.\n\nTo all @apache/skywalking-committers\nThis PR has a small(18 files only) change set, but influenced scope is large. And this doesn't have the side-effect, so I active it by default. Please review and give me some feedback.", "createdAt": "2020-02-15T13:35:04Z", "url": "https://github.com/apache/skywalking/pull/4364", "merged": true, "mergeCommit": {"oid": "329f7e150b9cb25624d627497a7a8c620cf92f68"}, "closed": true, "closedAt": "2020-02-16T01:03:31Z", "author": {"login": "wu-sheng"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEjiDTgH2gAyMzc1NzE2MDkzOjZkZWU0ZmFiNjY2OGExZTE4YTQzZGViYzU0M2JhZmMyZDBhMmQ4N2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFEGT4gFqTM1OTQ2MzQ1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6dee4fab6668a1e18a43debc543bafc2d0a2d87b", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/6dee4fab6668a1e18a43debc543bafc2d0a2d87b", "committedDate": "2020-02-15T12:45:39Z", "message": "Support day/hour/minute metrics merging into one index. Reduce the number of index 50%."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dab8a2f72b59c89d624c8352968874b1da84e446", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/dab8a2f72b59c89d624c8352968874b1da84e446", "committedDate": "2020-02-15T12:53:45Z", "message": "Fix style."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10bcc8797d9a66122d376fc1e449b91a2ab2cedc", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/10bcc8797d9a66122d376fc1e449b91a2ab2cedc", "committedDate": "2020-02-15T13:27:31Z", "message": "Fill doc about this new feature."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MzQ4MDMy", "url": "https://github.com/apache/skywalking/pull/4364#pullrequestreview-359348032", "createdAt": "2020-02-15T14:30:35Z", "commit": {"oid": "10bcc8797d9a66122d376fc1e449b91a2ab2cedc"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQxNDozMDozNVrOFqPRHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQxNDozMDozNVrOFqPRHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzNDY1Mg==", "bodyText": "nit: enablePackedDownsampling is always true, and it's never used in class PackedDownsamplingConverter", "url": "https://github.com/apache/skywalking/pull/4364#discussion_r379834652", "createdAt": "2020-02-15T14:30:35Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/StorageModuleElasticsearchProvider.java", "diffHunk": "@@ -174,4 +197,63 @@ private void overrideCoreModuleTTLConfig() {\n         configService.getDataTTLConfig().setDayMetricsDataTTL(config.getDayMetricsDataTTL());\n         configService.getDataTTLConfig().setMonthMetricsDataTTL(config.getMonthMetricsDataTTL());\n     }\n+\n+    public static List<IndexNameConverter> indexNameConverters(String namespace, boolean enablePackedDownsampling) {\n+        List<IndexNameConverter> converters = new ArrayList<>();\n+\n+        if (enablePackedDownsampling) {\n+            // Packed downsampling converter.\n+            converters.add(new PackedDownsamplingConverter(enablePackedDownsampling));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10bcc8797d9a66122d376fc1e449b91a2ab2cedc"}, "originalPosition": 108}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dcfd974f2eccf3fe278cf0a1bcc8e4fec232e50", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/9dcfd974f2eccf3fe278cf0a1bcc8e4fec232e50", "committedDate": "2020-02-15T14:46:08Z", "message": "FIx the converter initialization issue."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MzUwNDkx", "url": "https://github.com/apache/skywalking/pull/4364#pullrequestreview-359350491", "createdAt": "2020-02-15T15:22:03Z", "commit": {"oid": "9dcfd974f2eccf3fe278cf0a1bcc8e4fec232e50"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NDYzNDU2", "url": "https://github.com/apache/skywalking/pull/4364#pullrequestreview-359463456", "createdAt": "2020-02-17T02:42:12Z", "commit": {"oid": "9dcfd974f2eccf3fe278cf0a1bcc8e4fec232e50"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwMjo0MjoxM1rOFqXOtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwMjo0MjoxM1rOFqXOtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk2NTExMQ==", "bodyText": "Do we need to increase it when packed downsampling enabled?", "url": "https://github.com/apache/skywalking/pull/4364#discussion_r379965111", "createdAt": "2020-02-17T02:42:13Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-bootstrap/src/main/resources/application.yml", "diffHunk": "@@ -104,6 +105,7 @@ storage:\n     protocol: ${SW_STORAGE_ES_HTTP_PROTOCOL:\"http\"}\n     #trustStorePath: ${SW_SW_STORAGE_ES_SSL_JKS_PATH:\"../es_keystore.jks\"}\n     #trustStorePass: ${SW_SW_STORAGE_ES_SSL_JKS_PASS:\"\"}\n+    enablePackedDownsampling: ${SW_STORAGE_ENABLE_PACKED_DOWNSAMPLING:true} # Hour and Day metrics will be merged into minute index.\n     user: ${SW_ES_USER:\"\"}\n     password: ${SW_ES_PASSWORD:\"\"}\n     indexShardsNumber: ${SW_STORAGE_ES_INDEX_SHARDS_NUMBER:2}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9dcfd974f2eccf3fe278cf0a1bcc8e4fec232e50"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2678, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}