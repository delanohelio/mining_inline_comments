{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyODY2NjIy", "number": 5376, "title": "Hot reload gRPC certs of OAP.", "bodyText": "intends to fix #5110", "createdAt": "2020-08-25T01:17:58Z", "url": "https://github.com/apache/skywalking/pull/5376", "merged": true, "mergeCommit": {"oid": "30ce1959a7109cce22b4dee8064099789c37da0d"}, "closed": true, "closedAt": "2020-08-31T15:11:03Z", "author": {"login": "hanahmily"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCMvy6gH2gAyNDcyODY2NjIyOmNkYWRlYTU1ZTEyMDI0ZWJlNmU4ZDVhZjU1N2NjODJiZWE0Y2Y5N2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEURn6gFqTQ3ODcwMDY2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cdadea55e12024ebe6e8d5af557cc82bea4cf97d", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/cdadea55e12024ebe6e8d5af557cc82bea4cf97d", "committedDate": "2020-08-25T01:16:09Z", "message": "Hot reload gRPC certs of OAP.\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfcec7b86d3f873b9ccccccfa9dd3131da086843", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/dfcec7b86d3f873b9ccccccfa9dd3131da086843", "committedDate": "2020-08-31T00:51:14Z", "message": "Support PKCS#1, update relevant documents.\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e1076e875d97b1e0e3bc3a5ed0cd17e2f9cd5bd", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/2e1076e875d97b1e0e3bc3a5ed0cd17e2f9cd5bd", "committedDate": "2020-08-31T01:02:05Z", "message": "Merge branch 'master' into grpc-reload-crt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8e1e7c525f4e1c244db2acbc2dd8d8ee9c4003a", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/c8e1e7c525f4e1c244db2acbc2dd8d8ee9c4003a", "committedDate": "2020-08-31T02:16:18Z", "message": "Merge branch 'master' into grpc-reload-crt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e5c08603665a8d941e819f21326ebd49d3bc606", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/9e5c08603665a8d941e819f21326ebd49d3bc606", "committedDate": "2020-08-31T05:02:44Z", "message": "Start ssl context\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c63e1bc163417a55f3e98c5fb46c98be1ec085d", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/7c63e1bc163417a55f3e98c5fb46c98be1ec085d", "committedDate": "2020-08-31T05:22:59Z", "message": "Merge branch 'grpc-reload-crt' of github.com:apache/skywalking into grpc-reload-crt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "7c63e1bc163417a55f3e98c5fb46c98be1ec085d", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/7c63e1bc163417a55f3e98c5fb46c98be1ec085d", "committedDate": "2020-08-31T05:22:59Z", "message": "Merge branch 'grpc-reload-crt' of github.com:apache/skywalking into grpc-reload-crt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cca477e575382476d4d0e85ecde41b81876f94ad", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/cca477e575382476d4d0e85ecde41b81876f94ad", "committedDate": "2020-08-31T05:39:17Z", "message": "Update sslcontext\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NDMxOTgy", "url": "https://github.com/apache/skywalking/pull/5376#pullrequestreview-478431982", "createdAt": "2020-08-31T08:50:05Z", "commit": {"oid": "cca477e575382476d4d0e85ecde41b81876f94ad"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4357c58a608be359fc1bff5a7bc3fe736c3d82c1", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/4357c58a608be359fc1bff5a7bc3fe736c3d82c1", "committedDate": "2020-08-31T08:50:17Z", "message": "Merge branch 'master' into grpc-reload-crt"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NDU4ODky", "url": "https://github.com/apache/skywalking/pull/5376#pullrequestreview-478458892", "createdAt": "2020-08-31T09:31:59Z", "commit": {"oid": "4357c58a608be359fc1bff5a7bc3fe736c3d82c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwOTozMTo1OVrOHJxcnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwOTozMTo1OVrOHJxcnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDAwOTM3NQ==", "bodyText": "The returned value is just ignored? If that's intentionally, do we need a null check in the following uses of ctx?", "url": "https://github.com/apache/skywalking/pull/5376#discussion_r480009375", "createdAt": "2020-08-31T09:31:59Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-library/library-server/src/main/java/org/apache/skywalking/oap/server/library/server/grpc/ssl/DynamicSslContext.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.library.server.grpc.ssl;\n+\n+import io.grpc.netty.GrpcSslContexts;\n+import io.netty.buffer.ByteBufAllocator;\n+import io.netty.handler.ssl.ApplicationProtocolNegotiator;\n+import io.netty.handler.ssl.SslContext;\n+import io.netty.handler.ssl.SslContextBuilder;\n+import io.netty.handler.ssl.SslProvider;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.security.GeneralSecurityException;\n+import java.util.List;\n+import javax.net.ssl.SSLEngine;\n+import javax.net.ssl.SSLException;\n+import javax.net.ssl.SSLSessionContext;\n+import org.apache.skywalking.oap.server.library.util.MultipleFilesChangeMonitor;\n+\n+/**\n+ * Load SslContext dynamically.\n+ */\n+public class DynamicSslContext extends SslContext {\n+    private final MultipleFilesChangeMonitor monitor;\n+    private volatile SslContext ctx;\n+\n+    public static DynamicSslContext forServer(final String privateKeyFile, final String certChainFile) {\n+        return new DynamicSslContext(privateKeyFile, certChainFile);\n+    }\n+\n+    public static DynamicSslContext forClient(final String caFile) {\n+        return new DynamicSslContext(caFile);\n+    }\n+\n+    private DynamicSslContext(final String privateKeyFile, final String certChainFile) {\n+        updateContext(privateKeyFile, certChainFile);\n+        monitor = new MultipleFilesChangeMonitor(\n+            10,\n+            readableContents -> updateContext(privateKeyFile, certChainFile),\n+            certChainFile,\n+            privateKeyFile);\n+    }\n+\n+    private DynamicSslContext(final String caFile) {\n+        updateContext(caFile);\n+        monitor = new MultipleFilesChangeMonitor(\n+            10,\n+            readableContents -> updateContext(caFile),\n+            caFile);\n+    }\n+\n+    private void updateContext(String caFile) {\n+        try {\n+            GrpcSslContexts.forClient().trustManager(Paths.get(caFile).toFile()).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4357c58a608be359fc1bff5a7bc3fe736c3d82c1"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NTY1NTI4", "url": "https://github.com/apache/skywalking/pull/5376#pullrequestreview-478565528", "createdAt": "2020-08-31T12:20:41Z", "commit": {"oid": "4357c58a608be359fc1bff5a7bc3fe736c3d82c1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMjoyMDo0MlrOHJ2gHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMjoyMDo0MlrOHJ2gHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA5MjE4OA==", "bodyText": "Got it, you mean this\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        GrpcSslContexts.forClient().trustManager(Paths.get(caFile).toFile()).build();\n          \n          \n            \n                        ctx = GrpcSslContexts.forClient().trustManager(Paths.get(caFile).toFile()).build();\n          \n      \n    \n    \n  \n\n@hanahmily Please take a look.", "url": "https://github.com/apache/skywalking/pull/5376#discussion_r480092188", "createdAt": "2020-08-31T12:20:42Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-library/library-server/src/main/java/org/apache/skywalking/oap/server/library/server/grpc/ssl/DynamicSslContext.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.library.server.grpc.ssl;\n+\n+import io.grpc.netty.GrpcSslContexts;\n+import io.netty.buffer.ByteBufAllocator;\n+import io.netty.handler.ssl.ApplicationProtocolNegotiator;\n+import io.netty.handler.ssl.SslContext;\n+import io.netty.handler.ssl.SslContextBuilder;\n+import io.netty.handler.ssl.SslProvider;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.security.GeneralSecurityException;\n+import java.util.List;\n+import javax.net.ssl.SSLEngine;\n+import javax.net.ssl.SSLException;\n+import javax.net.ssl.SSLSessionContext;\n+import org.apache.skywalking.oap.server.library.util.MultipleFilesChangeMonitor;\n+\n+/**\n+ * Load SslContext dynamically.\n+ */\n+public class DynamicSslContext extends SslContext {\n+    private final MultipleFilesChangeMonitor monitor;\n+    private volatile SslContext ctx;\n+\n+    public static DynamicSslContext forServer(final String privateKeyFile, final String certChainFile) {\n+        return new DynamicSslContext(privateKeyFile, certChainFile);\n+    }\n+\n+    public static DynamicSslContext forClient(final String caFile) {\n+        return new DynamicSslContext(caFile);\n+    }\n+\n+    private DynamicSslContext(final String privateKeyFile, final String certChainFile) {\n+        updateContext(privateKeyFile, certChainFile);\n+        monitor = new MultipleFilesChangeMonitor(\n+            10,\n+            readableContents -> updateContext(privateKeyFile, certChainFile),\n+            certChainFile,\n+            privateKeyFile);\n+    }\n+\n+    private DynamicSslContext(final String caFile) {\n+        updateContext(caFile);\n+        monitor = new MultipleFilesChangeMonitor(\n+            10,\n+            readableContents -> updateContext(caFile),\n+            caFile);\n+    }\n+\n+    private void updateContext(String caFile) {\n+        try {\n+            GrpcSslContexts.forClient().trustManager(Paths.get(caFile).toFile()).build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDAwOTM3NQ=="}, "originalCommit": {"oid": "4357c58a608be359fc1bff5a7bc3fe736c3d82c1"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bbe1c9ab529c89522ca336de81810ae8e5a9ec7", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/8bbe1c9ab529c89522ca336de81810ae8e5a9ec7", "committedDate": "2020-08-31T12:40:35Z", "message": "Update oap-server/server-library/library-server/src/main/java/org/apache/skywalking/oap/server/library/server/grpc/ssl/DynamicSslContext.java\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NjkxMzYy", "url": "https://github.com/apache/skywalking/pull/5376#pullrequestreview-478691362", "createdAt": "2020-08-31T14:59:04Z", "commit": {"oid": "8bbe1c9ab529c89522ca336de81810ae8e5a9ec7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NzAwNjYw", "url": "https://github.com/apache/skywalking/pull/5376#pullrequestreview-478700660", "createdAt": "2020-08-31T15:10:17Z", "commit": {"oid": "8bbe1c9ab529c89522ca336de81810ae8e5a9ec7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1936, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}