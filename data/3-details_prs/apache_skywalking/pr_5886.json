{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2MTMzOTQ4", "number": 5886, "title": "fix gateway plugin async finish repeatedly when fallback configured", "bodyText": "Fix gateway plugin async finish repeatedly when fallback configured #5814\n\n Add a unit test to verify that the fix works.\n Explain briefly about why the bug exists and how to fix it.\nif fallback url is configured in springcloud gateway,\n\n\nwhen a request is timeout or other exceptions are thrown, hystrix will trigger another request like /fallback/default, this invokes webflux DispatcherHandler#handle() again, and the ServerWebExchange here is the same nested one with the previous request.\nA new span will be put in ServerWebExchange attribute, then doFinally will work twice, both asyn finish the later fallback span, thus lead to the bug. The span for actual request will never be asyn finished.\nMove the get span code out of mono fix this bug easily.\n\n\n\n\n If this pull request closes/resolves/fixes an existing issue, replace the issue number. Closes #5814\n Update the CHANGES log.", "createdAt": "2020-11-24T02:44:18Z", "url": "https://github.com/apache/skywalking/pull/5886", "merged": true, "mergeCommit": {"oid": "aa4ee27d4a4b6bc45c476570afea6490d4359a2f"}, "closed": true, "closedAt": "2021-07-17T12:50:57Z", "author": {"login": "yujiaxinlong"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfgC5kgH2gAyNTI2MTMzOTQ4OjdmY2U3NWY2ZmM2MjMzYmRiZmJiNGZkMWI4OGE3ZWE1ODExYTljZTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABerR0jNgFqTcwODkzODQwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7fce75f6fc6233bdbfbb4fd1b88a7ea5811a9ce7", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/7fce75f6fc6233bdbfbb4fd1b88a7ea5811a9ce7", "committedDate": "2020-11-24T02:09:01Z", "message": "fix async finish repeatedly when fallback configured"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b3a25a08c548c563fb2397aa90749e07ee40f02", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/4b3a25a08c548c563fb2397aa90749e07ee40f02", "committedDate": "2020-11-24T02:53:23Z", "message": "update changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fee321b23482664a3e6628cad444f439a428a2e2", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/fee321b23482664a3e6628cad444f439a428a2e2", "committedDate": "2021-07-13T09:54:40Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzA0OTg0NjAw", "url": "https://github.com/apache/skywalking/pull/5886#pullrequestreview-704984600", "createdAt": "2021-07-13T09:55:19Z", "commit": {"oid": "fee321b23482664a3e6628cad444f439a428a2e2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzA1MDM1NDc4", "url": "https://github.com/apache/skywalking/pull/5886#pullrequestreview-705035478", "createdAt": "2021-07-13T10:51:11Z", "commit": {"oid": "fee321b23482664a3e6628cad444f439a428a2e2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51fa373036c1aee4278d43ffbad50abe9a1c690c", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/51fa373036c1aee4278d43ffbad50abe9a1c690c", "committedDate": "2021-07-16T04:09:01Z", "message": "fix operationName for PathParam"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f752cd973b618f1aa19590370766e9f178bf284d", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/f752cd973b618f1aa19590370766e9f178bf284d", "committedDate": "2021-07-16T04:11:10Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f9a65a5e3d41cf4d54d13739c004748806220bc", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/7f9a65a5e3d41cf4d54d13739c004748806220bc", "committedDate": "2021-07-16T05:49:18Z", "message": "fix misuse of mono.then()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39a253145e5e9830d7fe7084aefbe8fa41dc4bab", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/39a253145e5e9830d7fe7084aefbe8fa41dc4bab", "committedDate": "2021-07-16T05:49:47Z", "message": "Merge branch 'master' of https://github.com/yujiaxinlong/skywalking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fac51ccf23ffcd981bb2ac3d8a83a9671fa51f2", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/9fac51ccf23ffcd981bb2ac3d8a83a9671fa51f2", "committedDate": "2021-07-16T10:37:08Z", "message": "avoid opertionName overWrite during fallback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff66ed0a7f87a51c37044ef24d08a197225721c7", "author": {"user": {"login": "yujiaxinlong", "name": null}}, "url": "https://github.com/apache/skywalking/commit/ff66ed0a7f87a51c37044ef24d08a197225721c7", "committedDate": "2021-07-16T10:40:37Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzA4MzcyOTU0", "url": "https://github.com/apache/skywalking/pull/5886#pullrequestreview-708372954", "createdAt": "2021-07-16T13:09:10Z", "commit": {"oid": "9fac51ccf23ffcd981bb2ac3d8a83a9671fa51f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0xNlQxMzowOToxMFrOKAJTwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0xNlQxMzowOToxMFrOKAJTwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MTI0MTE1Mw==", "bodyText": "What does pathPattern.matches(exchange.getRequest().getPath().pathWithinApplication()) mean? Could you add comments about this?", "url": "https://github.com/apache/skywalking/pull/5886#discussion_r671241153", "createdAt": "2021-07-16T13:09:10Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/optional-plugins/optional-spring-plugins/spring-webflux-5.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/spring/webflux/v5/DispatcherHandlerHandleMethodInterceptor.java", "diffHunk": "@@ -77,13 +77,14 @@ public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allAr\n         exchange.getAttributes().put(\"SKYWALING_SPAN\", span);\n     }\n     \n-    private void setPattern(AbstractSpan span, ServerWebExchange exchange) {\n+    private void maybeSetPattern(AbstractSpan span, ServerWebExchange exchange) {\n         if (span != null) {\n-            Object pathPattern = exchange.getAttribute(HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE);\n-            if (pathPattern != null) {\n-                span.setOperationName(((PathPattern) pathPattern).getPatternString());\n+            PathPattern pathPattern = exchange.getAttribute(HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE);\n+            if (pathPattern != null && pathPattern.matches(exchange.getRequest().getPath().pathWithinApplication())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fac51ccf23ffcd981bb2ac3d8a83a9671fa51f2"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzA4MzczNTU4", "url": "https://github.com/apache/skywalking/pull/5886#pullrequestreview-708373558", "createdAt": "2021-07-16T13:09:52Z", "commit": {"oid": "9fac51ccf23ffcd981bb2ac3d8a83a9671fa51f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0xNlQxMzowOTo1M1rOKAJVZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0xNlQxMzowOTo1M1rOKAJVZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MTI0MTU3NA==", "bodyText": "Is this the right format? I am feeling not. Could you confirm? Rather than waste CI resources.", "url": "https://github.com/apache/skywalking/pull/5886#discussion_r671241574", "createdAt": "2021-07-16T13:09:53Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/optional-plugins/optional-spring-plugins/spring-webflux-5.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/spring/webflux/v5/DispatcherHandlerHandleMethodInterceptor.java", "diffHunk": "@@ -93,14 +94,11 @@ public Object afterMethod(EnhancedInstance objInst, Method method, Object[] allA\n \n         AbstractSpan span = (AbstractSpan) exchange.getAttributes().get(\"SKYWALING_SPAN\");\n         \n-        return ((Mono) ret).flatMap(s -> {\n-                    setPattern(span, exchange);\n-                    return s;\n-                 })\n-                .doOnError(s -> setPattern(span, exchange))\n+                return ((Mono) ret)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fac51ccf23ffcd981bb2ac3d8a83a9671fa51f2"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f470e32ccc3007b82cff1a23fc95aaf8596d7819", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/f470e32ccc3007b82cff1a23fc95aaf8596d7819", "committedDate": "2021-07-17T08:18:34Z", "message": "add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bc8c949ead10dcc4b2cea060f1cfd15cc9b59d9", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/4bc8c949ead10dcc4b2cea060f1cfd15cc9b59d9", "committedDate": "2021-07-17T08:18:54Z", "message": "Merge branch 'master' of https://github.com/yujiaxinlong/skywalking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fe6a1468f397893828cd755cefcd9ae48b37f18", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/3fe6a1468f397893828cd755cefcd9ae48b37f18", "committedDate": "2021-07-17T08:33:55Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5915108ce889bc056a1eccc381e3d3a00a93ada", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/a5915108ce889bc056a1eccc381e3d3a00a93ada", "committedDate": "2021-07-17T09:14:43Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzA4OTM4NDA4", "url": "https://github.com/apache/skywalking/pull/5886#pullrequestreview-708938408", "createdAt": "2021-07-17T12:32:55Z", "commit": {"oid": "a5915108ce889bc056a1eccc381e3d3a00a93ada"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1382, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}