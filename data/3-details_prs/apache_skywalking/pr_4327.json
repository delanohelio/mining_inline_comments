{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNzA3ODMz", "number": 4327, "title": "Tag annotation supports returned expression", "bodyText": "Please answer these questions before submitting pull request\n\n\nWhy submit this pull request?\n\n\n Bug fix\n\n\n New feature provided\n\n\n Improve performance\n\n\nRelated issues\n\n\n@Tag annotation supports method returned value, resolves #4255", "createdAt": "2020-02-08T11:52:38Z", "url": "https://github.com/apache/skywalking/pull/4327", "merged": true, "mergeCommit": {"oid": "e5366c0921f0ec0052db33aa87ca72257cd3c7f1"}, "closed": true, "closedAt": "2020-02-12T06:03:03Z", "author": {"login": "lxliuxuankb"}, "timelineItems": {"totalCount": 37, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCSTjpgH2gAyMzcyNzA3ODMzOmI1Y2Q2OWQ0MTI5MDQ0NjhhZmJjZTZmMzM1YTljNTA5MDljZGU1ZDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDe7UeAFqTM1NzE4NzQ3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b5cd69d412904468afbce6f335a9c50909cde5d1", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/b5cd69d412904468afbce6f335a9c50909cde5d1", "committedDate": "2020-02-08T11:33:35Z", "message": "tag annotation support return expression"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2847eaee37359650774752475383723788d8daa5", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/2847eaee37359650774752475383723788d8daa5", "committedDate": "2020-02-08T12:30:10Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e171e37fa5d09a2a1b1fe576c1e0ea847051e04", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/8e171e37fa5d09a2a1b1fe576c1e0ea847051e04", "committedDate": "2020-02-08T12:34:44Z", "message": "tag annotation support return expression"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1342cfa58011e46b9d2938b0f04fad1521b657af", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/1342cfa58011e46b9d2938b0f04fad1521b657af", "committedDate": "2020-02-08T12:35:18Z", "message": "Merge branch 'master' of https://github.com/lxliuxuankb/skywalking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTQ2MDIw", "url": "https://github.com/apache/skywalking/pull/4327#pullrequestreview-355546020", "createdAt": "2020-02-08T12:35:42Z", "commit": {"oid": "2847eaee37359650774752475383723788d8daa5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQxMjozNTo0MlrOFnQacA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQxMjozNTo0MlrOFnQacA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjcwNzY5Ng==", "bodyText": "Remove author, please.", "url": "https://github.com/apache/skywalking/pull/4327#discussion_r376707696", "createdAt": "2020-02-08T12:35:42Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/util/TagUtil.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.context.util;\n+\n+import java.util.Map;\n+\n+import org.apache.skywalking.apm.agent.core.context.tag.StringTag;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.apache.skywalking.apm.agent.core.util.CustomizeExpression;\n+\n+/**\n+ * @author: lxliuxuan Date: 2020/02/08", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2847eaee37359650774752475383723788d8daa5"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTQ2MDQy", "url": "https://github.com/apache/skywalking/pull/4327#pullrequestreview-355546042", "createdAt": "2020-02-08T12:36:35Z", "commit": {"oid": "2847eaee37359650774752475383723788d8daa5"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a99ccb1e0eeb5fc0db52723e1b6b44fdb4a778ea", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/a99ccb1e0eeb5fc0db52723e1b6b44fdb4a778ea", "committedDate": "2020-02-08T12:47:45Z", "message": "rm tagUtil author"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTQ3Njk0", "url": "https://github.com/apache/skywalking/pull/4327#pullrequestreview-355547694", "createdAt": "2020-02-08T13:23:01Z", "commit": {"oid": "a99ccb1e0eeb5fc0db52723e1b6b44fdb4a778ea"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQxMzoyMzowMVrOFnQi6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQxMzoyNTozNVrOFnQjTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjcwOTg2Ng==", "bodyText": "Why length==2 is required?", "url": "https://github.com/apache/skywalking/pull/4327#discussion_r376709866", "createdAt": "2020-02-08T13:23:01Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/util/TagUtil.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.context.util;\n+\n+import java.util.Map;\n+\n+import org.apache.skywalking.apm.agent.core.context.tag.StringTag;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.apache.skywalking.apm.agent.core.util.CustomizeExpression;\n+\n+public class TagUtil {\n+    public static void tagParamsSpan(final AbstractSpan span, final Map<String, Object> context,\n+                                     String key, String value) {\n+        new StringTag(key).set(span, CustomizeExpression.parseExpression(value, context));\n+    }\n+\n+    public static void tagReturnSpanSpan(final AbstractSpan span, final Map<String, Object> context,\n+                                         String key, String value) {\n+        new StringTag(key).set(span, CustomizeExpression.parseReturnExpression(value, context));\n+    }\n+\n+    public static Boolean isReturnTag(String expression) {\n+        String[] es = expression.split(\"\\\\.\");\n+        return es.length == 2 && \"returnedObj\".equals(es[0]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a99ccb1e0eeb5fc0db52723e1b6b44fdb4a778ea"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjcwOTg5MA==", "bodyText": "Why do we need a Util at this core level?", "url": "https://github.com/apache/skywalking/pull/4327#discussion_r376709890", "createdAt": "2020-02-08T13:23:23Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/util/TagUtil.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.context.util;\n+\n+import java.util.Map;\n+\n+import org.apache.skywalking.apm.agent.core.context.tag.StringTag;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.apache.skywalking.apm.agent.core.util.CustomizeExpression;\n+\n+public class TagUtil {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a99ccb1e0eeb5fc0db52723e1b6b44fdb4a778ea"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjcwOTkyOA==", "bodyText": "You are just changing a single plugin, don't change anything in the core level, unless it is really necessary. For this case, it doesn't seem so.", "url": "https://github.com/apache/skywalking/pull/4327#discussion_r376709928", "createdAt": "2020-02-08T13:24:23Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/util/TagUtil.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.agent.core.context.util;\n+\n+import java.util.Map;\n+\n+import org.apache.skywalking.apm.agent.core.context.tag.StringTag;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.apache.skywalking.apm.agent.core.util.CustomizeExpression;\n+\n+public class TagUtil {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjcwOTg5MA=="}, "originalCommit": {"oid": "a99ccb1e0eeb5fc0db52723e1b6b44fdb4a778ea"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjcwOTk2Ng==", "bodyText": "Why remove this method out of here?", "url": "https://github.com/apache/skywalking/pull/4327#discussion_r376709966", "createdAt": "2020-02-08T13:25:35Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-toolkit-activation/apm-toolkit-trace-activation/src/main/java/org/apache/skywalking/apm/toolkit/activation/trace/TagAnnotationMethodInterceptor.java", "diffHunk": "@@ -54,19 +54,18 @@ public void beforeMethod(\n         final Tags tags = method.getAnnotation(Tags.class);\n         if (tags != null && tags.value().length > 0) {\n             for (final Tag tag : tags.value()) {\n-                tagSpan(activeSpan, tag, context);\n+                if (!TagUtil.isReturnTag(tag.value())) {\n+                    TagUtil.tagParamsSpan(activeSpan, context, tag.key(), tag.value());\n+                }\n             }\n         }\n \n         final Tag tag = method.getAnnotation(Tag.class);\n-        if (tag != null) {\n-            tagSpan(activeSpan, tag, context);\n+        if (tag != null && !TagUtil.isReturnTag(tag.value())) {\n+            TagUtil.tagParamsSpan(activeSpan, context, tag.key(), tag.value());\n         }\n     }\n \n-    private void tagSpan(final AbstractSpan span, final Tag tag, final Map<String, Object> context) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a99ccb1e0eeb5fc0db52723e1b6b44fdb4a778ea"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb680cb3cc1e5962d9553cbc13e62af64fe878b8", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/eb680cb3cc1e5962d9553cbc13e62af64fe878b8", "committedDate": "2020-02-09T11:47:20Z", "message": "mv TagUtil into toolkit activation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e5b8ba06f3e14c305bbf4b98c0181560cf54a9b", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/8e5b8ba06f3e14c305bbf4b98c0181560cf54a9b", "committedDate": "2020-02-09T12:32:55Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa470d53bef1f2d85226ad5fca4a1424a79b7505", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/fa470d53bef1f2d85226ad5fca4a1424a79b7505", "committedDate": "2020-02-10T12:07:07Z", "message": "update test plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50e71c2dd491c7d9d2fac8fc18f253e6b648f6f1", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/50e71c2dd491c7d9d2fac8fc18f253e6b648f6f1", "committedDate": "2020-02-10T12:07:39Z", "message": "Merge branch 'master' of https://github.com/lxliuxuankb/skywalking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbf912c0c52b491e51bc94f6d04af53db654df20", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/fbf912c0c52b491e51bc94f6d04af53db654df20", "committedDate": "2020-02-10T12:27:16Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe9c78df25c422769062ce53289fcf51c1a83af4", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/fe9c78df25c422769062ce53289fcf51c1a83af4", "committedDate": "2020-02-10T12:33:20Z", "message": "update test plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a120cf338e364878e62dcea0ed61b14ce7db3a2c", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/a120cf338e364878e62dcea0ed61b14ce7db3a2c", "committedDate": "2020-02-10T12:33:37Z", "message": "Merge branch 'master' of https://github.com/lxliuxuankb/skywalking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86163a34f2ba6022d211eff83f48e84b5cd841d6", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/86163a34f2ba6022d211eff83f48e84b5cd841d6", "committedDate": "2020-02-10T12:34:20Z", "message": "update test plugin"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1OTAyMDU1", "url": "https://github.com/apache/skywalking/pull/4327#pullrequestreview-355902055", "createdAt": "2020-02-10T12:35:42Z", "commit": {"oid": "86163a34f2ba6022d211eff83f48e84b5cd841d6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bff646b763361d288c7b34172b7877093cb8269e", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/bff646b763361d288c7b34172b7877093cb8269e", "committedDate": "2020-02-10T12:44:05Z", "message": "Revert \"update test plugin\"\n\nThis reverts commit 86163a34f2ba6022d211eff83f48e84b5cd841d6."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a021d7c2f07ec69bfd1305dd1d512d514bedd1fe", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/a021d7c2f07ec69bfd1305dd1d512d514bedd1fe", "committedDate": "2020-02-10T12:44:39Z", "message": "Revert \"update test plugin\"\n\nThis reverts commit fe9c78df25c422769062ce53289fcf51c1a83af4."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45e163262be72d65f00da022d4384f54b752dce9", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/45e163262be72d65f00da022d4384f54b752dce9", "committedDate": "2020-02-10T12:46:53Z", "message": "update test plugin for tag Annotation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2df8036aef961baf01635e4c178e849ad305351", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/a2df8036aef961baf01635e4c178e849ad305351", "committedDate": "2020-02-11T01:21:51Z", "message": "add license into User"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f709daeac49a6b2d940d1661bf54c8b464e416e5", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/f709daeac49a6b2d940d1661bf54c8b464e416e5", "committedDate": "2020-02-11T02:12:01Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2Mzk3NDE5", "url": "https://github.com/apache/skywalking/pull/4327#pullrequestreview-356397419", "createdAt": "2020-02-11T03:01:54Z", "commit": {"oid": "f709daeac49a6b2d940d1661bf54c8b464e416e5"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NDAyNDky", "url": "https://github.com/apache/skywalking/pull/4327#pullrequestreview-356402492", "createdAt": "2020-02-11T03:28:27Z", "commit": {"oid": "f709daeac49a6b2d940d1661bf54c8b464e416e5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMzoyODoyN1rOFn8sKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMzoyOTo0OFrOFn8s8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzMzEyOA==", "bodyText": "Move these two lines into the final block.", "url": "https://github.com/apache/skywalking/pull/4327#discussion_r377433128", "createdAt": "2020-02-11T03:28:27Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-toolkit-activation/apm-toolkit-trace-activation/src/main/java/org/apache/skywalking/apm/toolkit/activation/trace/TagAnnotationMethodInterceptor.java", "diffHunk": "@@ -75,6 +74,25 @@ public Object afterMethod(\n         final Object[] allArguments,\n         final Class<?>[] argumentsTypes,\n         final Object ret) {\n+        if (ret == null || !ContextManager.isActive()) {\n+            ContextManager.stopSpan();\n+            return ret;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f709daeac49a6b2d940d1661bf54c8b464e416e5"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzMzMzMQ==", "bodyText": "returnedObj has a specific meaning, should be adding into the document. https://github.com/apache/skywalking/blob/master/docs/en/setup/service-agent/java-agent/Application-toolkit-trace.md", "url": "https://github.com/apache/skywalking/pull/4327#discussion_r377433331", "createdAt": "2020-02-11T03:29:48Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-toolkit-activation/apm-toolkit-trace-activation/src/main/java/org/apache/skywalking/apm/toolkit/activation/util/TagUtil.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.apm.toolkit.activation.util;\n+\n+import java.util.Map;\n+\n+import org.apache.skywalking.apm.agent.core.context.tag.StringTag;\n+import org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan;\n+import org.apache.skywalking.apm.agent.core.util.CustomizeExpression;\n+import org.apache.skywalking.apm.toolkit.trace.Tag;\n+\n+public class TagUtil {\n+    public static void tagParamsSpan(final AbstractSpan span, final Map<String, Object> context,\n+                                     final Tag tag) {\n+        new StringTag(tag.key()).set(span, CustomizeExpression.parseExpression(tag.value(), context));\n+    }\n+\n+    public static void tagReturnSpanSpan(final AbstractSpan span, final Map<String, Object> context,\n+                                         final Tag tag) {\n+        new StringTag(tag.key()).set(span, CustomizeExpression.parseReturnExpression(tag.value(), context));\n+    }\n+\n+    public static Boolean isReturnTag(String expression) {\n+        String[] es = expression.split(\"\\\\.\");\n+        return es.length == 2 && \"returnedObj\".equals(es[0]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f709daeac49a6b2d940d1661bf54c8b464e416e5"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88bb90bbac16fd0aaaa8d3493e68fba7fc36cd55", "author": {"user": {"login": "lxliuxuankb", "name": null}}, "url": "https://github.com/apache/skywalking/commit/88bb90bbac16fd0aaaa8d3493e68fba7fc36cd55", "committedDate": "2020-02-11T11:51:18Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8ec8e46c4186da0e611e6d0dfd924d1f31be627", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/c8ec8e46c4186da0e611e6d0dfd924d1f31be627", "committedDate": "2020-02-11T12:31:10Z", "message": "mv  ContextManager.stopSpan() into finally block and add tag Annotation doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee6364e592d2a9d4c5a70551eb22a7710ddd2c79", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/ee6364e592d2a9d4c5a70551eb22a7710ddd2c79", "committedDate": "2020-02-11T12:47:39Z", "message": "merge master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NjMzODI2", "url": "https://github.com/apache/skywalking/pull/4327#pullrequestreview-356633826", "createdAt": "2020-02-11T12:57:27Z", "commit": {"oid": "ee6364e592d2a9d4c5a70551eb22a7710ddd2c79"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f711954954d9637350f6ab5b59edec536489a6cc", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/f711954954d9637350f6ab5b59edec536489a6cc", "committedDate": "2020-02-11T12:59:19Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be62c8edb38c5855f0623c86a9f933ff37145092", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/be62c8edb38c5855f0623c86a9f933ff37145092", "committedDate": "2020-02-11T14:09:28Z", "message": "Revert submodule updates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NzA0MTE3", "url": "https://github.com/apache/skywalking/pull/4327#pullrequestreview-356704117", "createdAt": "2020-02-11T14:33:53Z", "commit": {"oid": "be62c8edb38c5855f0623c86a9f933ff37145092"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NzA1NDM4", "url": "https://github.com/apache/skywalking/pull/4327#pullrequestreview-356705438", "createdAt": "2020-02-11T14:35:30Z", "commit": {"oid": "be62c8edb38c5855f0623c86a9f933ff37145092"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNDozNTozMFrOFoLQ2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNDozNTo0MFrOFoLRMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY3MTg5Ng==", "bodyText": "Sorry, this is not right. This could be NPE, if ContextManager.isActive() == false, right? In #beforeMethod,  there is\nif (!ContextManager.isActive()) {\n            return;\n        }", "url": "https://github.com/apache/skywalking/pull/4327#discussion_r377671896", "createdAt": "2020-02-11T14:35:30Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-toolkit-activation/apm-toolkit-trace-activation/src/main/java/org/apache/skywalking/apm/toolkit/activation/trace/TagAnnotationMethodInterceptor.java", "diffHunk": "@@ -46,23 +46,47 @@ public void beforeMethod(final EnhancedInstance objInst, final Method method, fi\n         final Tags tags = method.getAnnotation(Tags.class);\n         if (tags != null && tags.value().length > 0) {\n             for (final Tag tag : tags.value()) {\n-                tagSpan(activeSpan, tag, context);\n+                if (!TagUtil.isReturnTag(tag.value())) {\n+                    TagUtil.tagParamsSpan(activeSpan, context, tag);\n+                }\n             }\n         }\n \n         final Tag tag = method.getAnnotation(Tag.class);\n-        if (tag != null) {\n-            tagSpan(activeSpan, tag, context);\n+        if (tag != null && !TagUtil.isReturnTag(tag.value())) {\n+            TagUtil.tagParamsSpan(activeSpan, context, tag);\n         }\n     }\n \n-    private void tagSpan(final AbstractSpan span, final Tag tag, final Map<String, Object> context) {\n-        new StringTag(tag.key()).set(span, CustomizeExpression.parseExpression(tag.value(), context));\n-    }\n \n     @Override\n-    public Object afterMethod(final EnhancedInstance objInst, final Method method, final Object[] allArguments,\n-        final Class<?>[] argumentsTypes, final Object ret) {\n+    public Object afterMethod(\n+        final EnhancedInstance objInst,\n+        final Method method,\n+        final Object[] allArguments,\n+        final Class<?>[] argumentsTypes,\n+        final Object ret) {\n+        try {\n+            if (ret == null || !ContextManager.isActive()) {\n+                return ret;\n+            }\n+            final AbstractSpan localSpan = ContextManager.activeSpan();\n+            final Map<String, Object> context = CustomizeExpression.evaluationReturnContext(ret);\n+            final Tags tags = method.getAnnotation(Tags.class);\n+            if (tags != null && tags.value().length > 0) {\n+                for (final Tag tag : tags.value()) {\n+                    if (TagUtil.isReturnTag(tag.value())) {\n+                        TagUtil.tagReturnSpanSpan(localSpan, context, tag);\n+                    }\n+                }\n+            }\n+            final Tag tag = method.getAnnotation(Tag.class);\n+            if (tag != null && TagUtil.isReturnTag(tag.value())) {\n+                TagUtil.tagReturnSpanSpan(localSpan, context, tag);\n+            }\n+        } finally {\n+            ContextManager.stopSpan();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be62c8edb38c5855f0623c86a9f933ff37145092"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY3MTk4Ng==", "bodyText": "Same here.", "url": "https://github.com/apache/skywalking/pull/4327#discussion_r377671986", "createdAt": "2020-02-11T14:35:40Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-toolkit-activation/apm-toolkit-trace-activation/src/main/java/org/apache/skywalking/apm/toolkit/activation/trace/TraceAnnotationMethodInterceptor.java", "diffHunk": "@@ -56,24 +56,41 @@ public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allAr\n         final Tags tags = method.getAnnotation(Tags.class);\n         if (tags != null && tags.value().length > 0) {\n             for (final Tag tag : tags.value()) {\n-                tagSpan(localSpan, tag, context);\n+                if (!TagUtil.isReturnTag(tag.value())) {\n+                    TagUtil.tagParamsSpan(localSpan, context, tag);\n+                }\n             }\n         }\n-\n         final Tag tag = method.getAnnotation(Tag.class);\n-        if (tag != null) {\n-            tagSpan(localSpan, tag, context);\n+        if (tag != null && !TagUtil.isReturnTag(tag.value())) {\n+            TagUtil.tagParamsSpan(localSpan, context, tag);\n         }\n     }\n \n-    private void tagSpan(final AbstractSpan span, final Tag tag, final Map<String, Object> context) {\n-        new StringTag(tag.key()).set(span, CustomizeExpression.parseExpression(tag.value(), context));\n-    }\n-\n     @Override\n     public Object afterMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes,\n         Object ret) throws Throwable {\n-        ContextManager.stopSpan();\n+        try {\n+            if (ret == null) {\n+                return ret;\n+            }\n+            final AbstractSpan localSpan = ContextManager.activeSpan();\n+            final Map<String, Object> context = CustomizeExpression.evaluationReturnContext(ret);\n+            final Tags tags = method.getAnnotation(Tags.class);\n+            if (tags != null && tags.value().length > 0) {\n+                for (final Tag tag : tags.value()) {\n+                    if (TagUtil.isReturnTag(tag.value())) {\n+                        TagUtil.tagReturnSpanSpan(localSpan, context, tag);\n+                    }\n+                }\n+            }\n+            final Tag tag = method.getAnnotation(Tag.class);\n+            if (tag != null && TagUtil.isReturnTag(tag.value())) {\n+                TagUtil.tagReturnSpanSpan(localSpan, context, tag);\n+            }\n+        } finally {\n+            ContextManager.stopSpan();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be62c8edb38c5855f0623c86a9f933ff37145092"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f34c03f8c3797f5bb50acb0996c47a5a54313c88", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/f34c03f8c3797f5bb50acb0996c47a5a54313c88", "committedDate": "2020-02-12T02:02:56Z", "message": "remove ContextManager.stop() in TagAnnotationMethodInterceptor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MTUwMDg3", "url": "https://github.com/apache/skywalking/pull/4327#pullrequestreview-357150087", "createdAt": "2020-02-12T02:19:25Z", "commit": {"oid": "f34c03f8c3797f5bb50acb0996c47a5a54313c88"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ad49e76b638f57a2458dbcd3aee58144c3bb8c7", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/3ad49e76b638f57a2458dbcd3aee58144c3bb8c7", "committedDate": "2020-02-12T02:56:11Z", "message": "fix code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ae89220c2820c3a70f1cb784f4fcfad55ea595f", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/6ae89220c2820c3a70f1cb784f4fcfad55ea595f", "committedDate": "2020-02-12T03:57:44Z", "message": "fix TagAnnotationTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MTg3NDcw", "url": "https://github.com/apache/skywalking/pull/4327#pullrequestreview-357187470", "createdAt": "2020-02-12T04:49:48Z", "commit": {"oid": "6ae89220c2820c3a70f1cb784f4fcfad55ea595f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2651, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}