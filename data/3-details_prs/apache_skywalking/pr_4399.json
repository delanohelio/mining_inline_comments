{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NjU2MjQ5", "number": 4399, "title": "support http api for upstream trace.", "bodyText": "Please answer these questions before submitting pull request\n\n\nWhy submit this pull request?\n\n\n Bug fix\n\n\n New feature provided\n\n\n Improve performance\n\n\nRelated issues\n\n\nTODO:\n\n docs\n e2e tests\n\nResolves #4252", "createdAt": "2020-02-23T02:59:45Z", "url": "https://github.com/apache/skywalking/pull/4399", "merged": true, "mergeCommit": {"oid": "aa2176562842aba0966524fbc6c2b444e69c285d"}, "closed": true, "closedAt": "2020-03-06T13:07:40Z", "author": {"login": "JaredTan95"}, "timelineItems": {"totalCount": 77, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcG_7KUAH2gAyMzc4NjU2MjQ5OjQ3YmIwYzAyNDcyOTBlNDI5MjM0OTZiMmIxNjRlYjc1ZWM3Y2RmZTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcK_qWUAFqTM3MDMwMDY3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "47bb0c0247290e42923496b2b164eb75ec7cdfe6", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/47bb0c0247290e42923496b2b164eb75ec7cdfe6", "committedDate": "2020-02-23T02:58:16Z", "message": "support http api."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef86e724ffb8787dddfb294a2c16570d872bfd2b", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/ef86e724ffb8787dddfb294a2c16570d872bfd2b", "committedDate": "2020-02-23T03:01:26Z", "message": "Merge branch 'master' into rest_api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDYzMDEx", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-363063011", "createdAt": "2020-02-23T03:13:06Z", "commit": {"oid": "ef86e724ffb8787dddfb294a2c16570d872bfd2b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwMzoxMzowN1rOFtOBRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwMzoxMzowN1rOFtOBRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1OTk0MA==", "bodyText": "Why use service_id rather than serviceId? I thought we keep the same name as gRPC?", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r382959940", "createdAt": "2020-02-23T03:13:07Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-receiver-plugin/skywalking-register-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/register/provider/handler/v6/rest/ServiceInstanceRegisterServletHandler.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.register.provider.handler.v6.rest;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.servlet.http.HttpServletRequest;\n+import org.apache.skywalking.oap.server.core.CoreModule;\n+import org.apache.skywalking.oap.server.core.cache.ServiceInventoryCache;\n+import org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory;\n+import org.apache.skywalking.oap.server.core.register.ServiceInventory;\n+import org.apache.skywalking.oap.server.core.register.service.IServiceInstanceInventoryRegister;\n+import org.apache.skywalking.oap.server.library.module.ModuleManager;\n+import org.apache.skywalking.oap.server.library.server.jetty.ArgumentsParseException;\n+import org.apache.skywalking.oap.server.library.server.jetty.JettyJsonHandler;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory.PropertyUtil.HOST_NAME;\n+import static org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory.PropertyUtil.PROCESS_NO;\n+\n+public class ServiceInstanceRegisterServletHandler extends JettyJsonHandler {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(ServiceInstanceRegisterServletHandler.class);\n+\n+    private final IServiceInstanceInventoryRegister serviceInstanceInventoryRegister;\n+    private final ServiceInventoryCache serviceInventoryCache;\n+    private final Gson gson = new Gson();\n+\n+    private static final String SERVICE_ID = \"service_id\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef86e724ffb8787dddfb294a2c16570d872bfd2b"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDYzMDIz", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-363063023", "createdAt": "2020-02-23T03:13:57Z", "commit": {"oid": "ef86e724ffb8787dddfb294a2c16570d872bfd2b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwMzoxMzo1N1rOFtOBVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwMzoxMzo1N1rOFtOBVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1OTk1OQ==", "bodyText": "OS_INFO could be null, we don't require for that, right? And where is the language?", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r382959959", "createdAt": "2020-02-23T03:13:57Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-receiver-plugin/skywalking-register-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/register/provider/handler/v6/rest/ServiceInstanceRegisterServletHandler.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.register.provider.handler.v6.rest;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.servlet.http.HttpServletRequest;\n+import org.apache.skywalking.oap.server.core.CoreModule;\n+import org.apache.skywalking.oap.server.core.cache.ServiceInventoryCache;\n+import org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory;\n+import org.apache.skywalking.oap.server.core.register.ServiceInventory;\n+import org.apache.skywalking.oap.server.core.register.service.IServiceInstanceInventoryRegister;\n+import org.apache.skywalking.oap.server.library.module.ModuleManager;\n+import org.apache.skywalking.oap.server.library.server.jetty.ArgumentsParseException;\n+import org.apache.skywalking.oap.server.library.server.jetty.JettyJsonHandler;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory.PropertyUtil.HOST_NAME;\n+import static org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory.PropertyUtil.PROCESS_NO;\n+\n+public class ServiceInstanceRegisterServletHandler extends JettyJsonHandler {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(ServiceInstanceRegisterServletHandler.class);\n+\n+    private final IServiceInstanceInventoryRegister serviceInstanceInventoryRegister;\n+    private final ServiceInventoryCache serviceInventoryCache;\n+    private final Gson gson = new Gson();\n+\n+    private static final String SERVICE_ID = \"service_id\";\n+    private static final String AGENT_UUID = \"agent_uuid\";\n+    private static final String REGISTER_TIME = \"register_time\";\n+    private static final String INSTANCE_ID = \"instance_id\";\n+    private static final String OS_INFO = \"os_info\";\n+\n+    public ServiceInstanceRegisterServletHandler(ModuleManager moduleManager) {\n+        this.serviceInventoryCache = moduleManager.find(CoreModule.NAME)\n+                                                  .provider()\n+                                                  .getService(ServiceInventoryCache.class);\n+        this.serviceInstanceInventoryRegister = moduleManager.find(CoreModule.NAME).provider().getService(\n+            IServiceInstanceInventoryRegister.class);\n+    }\n+\n+    @Override\n+    public String pathSpec() {\n+        return \"/v2/instance/register\";\n+    }\n+\n+    @Override\n+    protected JsonElement doGet(HttpServletRequest req) throws ArgumentsParseException {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    protected JsonElement doPost(HttpServletRequest req) throws ArgumentsParseException {\n+        JsonObject responseJson = new JsonObject();\n+        try {\n+            JsonObject instance = gson.fromJson(req.getReader(), JsonObject.class);\n+            int serviceId = instance.get(SERVICE_ID).getAsInt();\n+            String agentUUID = instance.get(AGENT_UUID).getAsString();\n+            long registerTime = instance.get(REGISTER_TIME).getAsLong();\n+            JsonObject osInfoJson = instance.get(OS_INFO).getAsJsonObject();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef86e724ffb8787dddfb294a2c16570d872bfd2b"}, "originalPosition": 83}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDYzMDU1", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-363063055", "createdAt": "2020-02-23T03:15:31Z", "commit": {"oid": "ef86e724ffb8787dddfb294a2c16570d872bfd2b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDY0MTky", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-363064192", "createdAt": "2020-02-23T04:01:31Z", "commit": {"oid": "ef86e724ffb8787dddfb294a2c16570d872bfd2b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwNDowMTozMVrOFtOI6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwNDowMTozMVrOFtOI6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk2MTg5Nw==", "bodyText": "I have begun to adopt your path definitions, please don't change them :)", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r382961897", "createdAt": "2020-02-23T04:01:31Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-receiver-plugin/skywalking-register-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/register/provider/handler/v6/rest/ServiceInstanceRegisterServletHandler.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.register.provider.handler.v6.rest;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.servlet.http.HttpServletRequest;\n+import org.apache.skywalking.oap.server.core.CoreModule;\n+import org.apache.skywalking.oap.server.core.cache.ServiceInventoryCache;\n+import org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory;\n+import org.apache.skywalking.oap.server.core.register.ServiceInventory;\n+import org.apache.skywalking.oap.server.core.register.service.IServiceInstanceInventoryRegister;\n+import org.apache.skywalking.oap.server.library.module.ModuleManager;\n+import org.apache.skywalking.oap.server.library.server.jetty.ArgumentsParseException;\n+import org.apache.skywalking.oap.server.library.server.jetty.JettyJsonHandler;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory.PropertyUtil.HOST_NAME;\n+import static org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory.PropertyUtil.PROCESS_NO;\n+\n+public class ServiceInstanceRegisterServletHandler extends JettyJsonHandler {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(ServiceInstanceRegisterServletHandler.class);\n+\n+    private final IServiceInstanceInventoryRegister serviceInstanceInventoryRegister;\n+    private final ServiceInventoryCache serviceInventoryCache;\n+    private final Gson gson = new Gson();\n+\n+    private static final String SERVICE_ID = \"service_id\";\n+    private static final String AGENT_UUID = \"agent_uuid\";\n+    private static final String REGISTER_TIME = \"register_time\";\n+    private static final String INSTANCE_ID = \"instance_id\";\n+    private static final String OS_INFO = \"os_info\";\n+\n+    public ServiceInstanceRegisterServletHandler(ModuleManager moduleManager) {\n+        this.serviceInventoryCache = moduleManager.find(CoreModule.NAME)\n+                                                  .provider()\n+                                                  .getService(ServiceInventoryCache.class);\n+        this.serviceInstanceInventoryRegister = moduleManager.find(CoreModule.NAME).provider().getService(\n+            IServiceInstanceInventoryRegister.class);\n+    }\n+\n+    @Override\n+    public String pathSpec() {\n+        return \"/v2/instance/register\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef86e724ffb8787dddfb294a2c16570d872bfd2b"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDY4MzEy", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-363068312", "createdAt": "2020-02-23T06:22:34Z", "commit": {"oid": "ef86e724ffb8787dddfb294a2c16570d872bfd2b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwNjoyMjozNFrOFtOiKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwNjoyMjozNFrOFtOiKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk2ODM2Mg==", "bodyText": "Segment should be JSON format directly. There is no way to parse this in proto format. The reason of using HTTP, is there is no protobuf and grpc libs there. Such as Nginx lua. We can't built it.", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r382968362", "createdAt": "2020-02-23T06:22:34Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-receiver-plugin/skywalking-trace-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/trace/provider/handler/v6/rest/TraceSegmentCollectServletHandler.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.trace.provider.handler.v6.rest;\n+\n+import com.google.gson.JsonElement;\n+import com.google.gson.stream.JsonReader;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import javax.servlet.http.HttpServletRequest;\n+import org.apache.skywalking.oap.server.library.server.jetty.JettyJsonHandler;\n+import org.apache.skywalking.oap.server.receiver.trace.provider.handler.v6.rest.reader.TraceSegment;\n+import org.apache.skywalking.oap.server.receiver.trace.provider.handler.v6.rest.reader.UpstreamSegmentJsonReader;\n+import org.apache.skywalking.oap.server.receiver.trace.provider.parser.SegmentParseV2;\n+import org.apache.skywalking.oap.server.receiver.trace.provider.parser.SegmentSource;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class TraceSegmentCollectServletHandler extends JettyJsonHandler {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(TraceSegmentCollectServletHandler.class);\n+\n+    private final SegmentParseV2.Producer segmentProducer;\n+\n+    public TraceSegmentCollectServletHandler(SegmentParseV2.Producer segmentProducer) {\n+        this.segmentProducer = segmentProducer;\n+    }\n+\n+    @Override\n+    public String pathSpec() {\n+        return \"/v2/segments\";\n+    }\n+\n+    @Override\n+    protected JsonElement doGet(HttpServletRequest req) {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    protected JsonElement doPost(HttpServletRequest req) {\n+        if (logger.isDebugEnabled()) {\n+            logger.debug(\"receive stream segment\");\n+        }\n+\n+        try {\n+            BufferedReader bufferedReader = req.getReader();\n+            read(bufferedReader);\n+        } catch (IOException e) {\n+            logger.error(e.getMessage(), e);\n+        }\n+\n+        return null;\n+    }\n+\n+    private UpstreamSegmentJsonReader jsonReader = new UpstreamSegmentJsonReader();\n+\n+    private void read(BufferedReader bufferedReader) throws IOException {\n+        JsonReader reader = new JsonReader(bufferedReader);\n+\n+        reader.beginArray();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef86e724ffb8787dddfb294a2c16570d872bfd2b"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTcyOTQ5", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-363172949", "createdAt": "2020-02-24T05:17:56Z", "commit": {"oid": "ef86e724ffb8787dddfb294a2c16570d872bfd2b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNToxNzo1NlrOFtV4pQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNToxNzo1NlrOFtV4pQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4ODgwNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            //", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r383088805", "createdAt": "2020-02-24T05:17:56Z", "author": null, "path": "oap-server/server-receiver-plugin/skywalking-register-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/register/provider/handler/v6/rest/ServiceRegisterServletHandler.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.register.provider.handler.v6.rest;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import java.io.IOException;\n+import javax.servlet.http.HttpServletRequest;\n+import org.apache.skywalking.oap.server.core.CoreModule;\n+import org.apache.skywalking.oap.server.core.register.service.IServiceInventoryRegister;\n+import org.apache.skywalking.oap.server.library.module.ModuleManager;\n+import org.apache.skywalking.oap.server.library.server.jetty.ArgumentsParseException;\n+import org.apache.skywalking.oap.server.library.server.jetty.JettyJsonHandler;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ServiceRegisterServletHandler extends JettyJsonHandler {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(ServiceRegisterServletHandler.class);\n+\n+    private final IServiceInventoryRegister serviceInventoryRegister;\n+    private final Gson gson = new Gson();\n+    private static final String SERVICE_NAME = \"service_name\";\n+    private static final String SERVICE_ID = \"service_id\";\n+\n+    public ServiceRegisterServletHandler(ModuleManager moduleManager) {\n+        serviceInventoryRegister = moduleManager.find(CoreModule.NAME)\n+                                                .provider()\n+                                                .getService(IServiceInventoryRegister.class);\n+    }\n+\n+    @Override\n+    public String pathSpec() {\n+        return \"/v2/service/register\";\n+    }\n+\n+    @Override\n+    protected JsonElement doGet(HttpServletRequest req) throws ArgumentsParseException {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    protected JsonElement doPost(HttpServletRequest req) throws ArgumentsParseException {\n+        JsonArray responseArray = new JsonArray();\n+        try {\n+            JsonArray serviceCodes = gson.fromJson(req.getReader(), JsonArray.class);\n+            for (int i = 0; i < serviceCodes.size(); i++) {\n+                JsonObject service = serviceCodes.get(i).getAsJsonObject();\n+                String serviceCode = service.get(SERVICE_NAME).getAsString();\n+                int serviceId = serviceInventoryRegister.getOrCreate(serviceCode, null);\n+                JsonObject mapping = new JsonObject();\n+                mapping.addProperty(SERVICE_NAME, serviceCode);\n+                mapping.addProperty(SERVICE_ID, serviceId);\n+                responseArray.add(mapping);\n+                //", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef86e724ffb8787dddfb294a2c16570d872bfd2b"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTczOTk0", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-363173994", "createdAt": "2020-02-24T05:25:08Z", "commit": {"oid": "ef86e724ffb8787dddfb294a2c16570d872bfd2b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNToyNTowOVrOFtV8RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNToyNTowOVrOFtV8RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4OTczMg==", "bodyText": "Suggested change", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r383089732", "createdAt": "2020-02-24T05:25:09Z", "author": null, "path": "oap-server/server-receiver-plugin/skywalking-trace-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/trace/provider/handler/v6/rest/reader/UpstreamSegmentJsonReader.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.trace.provider.handler.v6.rest.reader;\n+\n+import com.google.gson.stream.JsonReader;\n+import java.io.IOException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class UpstreamSegmentJsonReader implements StreamJsonReader<TraceSegment> {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(UpstreamSegmentJsonReader.class);\n+\n+    private UniqueIdJsonReader uniqueIdJsonReader = new UniqueIdJsonReader();\n+    private SegmentJsonReader segmentJsonReader = new SegmentJsonReader();\n+\n+    private static final String GLOBAL_TRACE_IDS = \"global_trace_ids\";\n+    private static final String SEGMENT = \"segment\";\n+\n+    @Override\n+    public TraceSegment read(JsonReader reader) throws IOException {\n+        TraceSegment traceSegment = new TraceSegment();\n+\n+        reader.beginObject();\n+        while (reader.hasNext()) {\n+            switch (reader.nextName()) {\n+                case GLOBAL_TRACE_IDS:\n+                    reader.beginArray();\n+                    while (reader.hasNext()) {\n+                        traceSegment.addGlobalTraceId(uniqueIdJsonReader.read(reader));\n+                    }\n+                    reader.endArray();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef86e724ffb8787dddfb294a2c16570d872bfd2b"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce46725871eaee74c83fa4501ec38790714c33f0", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/ce46725871eaee74c83fa4501ec38790714c33f0", "committedDate": "2020-02-24T06:31:32Z", "message": "update logical."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1fd3aa61089dff912309cfa392498243ac55b32", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/c1fd3aa61089dff912309cfa392498243ac55b32", "committedDate": "2020-02-24T06:33:02Z", "message": "Merge branch 'master' into rest_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1730d5fe0218874c2126c66f05203ce742cf1d10", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/1730d5fe0218874c2126c66f05203ce742cf1d10", "committedDate": "2020-02-24T06:42:27Z", "message": "add license."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e0286fe92ac9787e7c98ed9c388a05f69a524d2", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/8e0286fe92ac9787e7c98ed9c388a05f69a524d2", "committedDate": "2020-02-24T06:44:39Z", "message": "Merge remote-tracking branch 'origin/rest_api' into rest_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa74d0d3e39b23d8564593efe573d8f2388dd82a", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/fa74d0d3e39b23d8564593efe573d8f2388dd82a", "committedDate": "2020-02-24T06:51:14Z", "message": "update test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b922fe3dbf8989738ebc38273a9cbe94fe224732", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/b922fe3dbf8989738ebc38273a9cbe94fe224732", "committedDate": "2020-02-24T08:13:47Z", "message": "update register logical."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2a6ca58b51e119123e9b93129fad60124010a71", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/c2a6ca58b51e119123e9b93129fad60124010a71", "committedDate": "2020-02-24T13:23:02Z", "message": "add protobuf java utils license."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzODI4NzQw", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-363828740", "createdAt": "2020-02-25T02:10:54Z", "commit": {"oid": "c2a6ca58b51e119123e9b93129fad60124010a71"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMjoxMDo1NFrOFt2bhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMjoxMDo1NFrOFt2bhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyMjAyMA==", "bodyText": "From this, you are not requiring the maven exclusion, could you recheck why?", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r383622020", "createdAt": "2020-02-25T02:10:54Z", "author": {"login": "wu-sheng"}, "path": "tools/dependencies/known-oap-backend-dependencies-es7.txt", "diffHunk": "@@ -143,6 +143,7 @@ parent-join-client-7.0.0.jar\n perfmark-api-0.19.0.jar\n proto-google-common-protos-1.12.0.jar\n protobuf-java-3.4.0.jar\n+protobuf-java-util-3.9.2.jar", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2a6ca58b51e119123e9b93129fad60124010a71"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e13faa7e57f86a9cfbd1fdab4259db371b3a6f4", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/5e13faa7e57f86a9cfbd1fdab4259db371b3a6f4", "committedDate": "2020-02-25T06:25:20Z", "message": "Merge branch 'master' into rest_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f81c6a74bb503e18985ce13d881af022c5185ec", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/1f81c6a74bb503e18985ce13d881af022c5185ec", "committedDate": "2020-02-26T12:48:08Z", "message": "fix maven."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4faf8cbb567b039734297541c48f56623457730", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/b4faf8cbb567b039734297541c48f56623457730", "committedDate": "2020-02-26T12:50:58Z", "message": "Merge branch 'master' into rest_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11f2d3028b20a9bb0444343c1925f595a4445bfd", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/11f2d3028b20a9bb0444343c1925f595a4445bfd", "committedDate": "2020-02-26T13:57:48Z", "message": "Merge branch 'master' into rest_api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDYzNjY5", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-363063669", "createdAt": "2020-02-23T03:41:05Z", "commit": {"oid": "ef86e724ffb8787dddfb294a2c16570d872bfd2b"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwMzo0MTowNVrOFtOFjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMzo1NzoxNFrOFusbmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk2MTAzNg==", "bodyText": "add some error message to response?", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r382961036", "createdAt": "2020-02-23T03:41:05Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-receiver-plugin/skywalking-register-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/register/provider/handler/v6/rest/ServiceInstancePingServletHandler.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.register.provider.handler.v6.rest;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import java.io.IOException;\n+import java.util.Objects;\n+import javax.servlet.http.HttpServletRequest;\n+import org.apache.skywalking.apm.network.common.Command;\n+import org.apache.skywalking.apm.network.common.Commands;\n+import org.apache.skywalking.apm.network.trace.component.command.ServiceResetCommand;\n+import org.apache.skywalking.oap.server.core.CoreModule;\n+import org.apache.skywalking.oap.server.core.cache.ServiceInstanceInventoryCache;\n+import org.apache.skywalking.oap.server.core.command.CommandService;\n+import org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory;\n+import org.apache.skywalking.oap.server.core.register.service.IServiceInstanceInventoryRegister;\n+import org.apache.skywalking.oap.server.core.register.service.IServiceInventoryRegister;\n+import org.apache.skywalking.oap.server.library.module.ModuleManager;\n+import org.apache.skywalking.oap.server.library.server.jetty.ArgumentsParseException;\n+import org.apache.skywalking.oap.server.library.server.jetty.JettyJsonHandler;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ServiceInstancePingServletHandler extends JettyJsonHandler {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(ServiceInstancePingServletHandler.class);\n+\n+    private final IServiceInstanceInventoryRegister serviceInstanceInventoryRegister;\n+    private final ServiceInstanceInventoryCache serviceInstanceInventoryCache;\n+    private final IServiceInventoryRegister serviceInventoryRegister;\n+    private final CommandService commandService;\n+    private final Gson gson = new Gson();\n+\n+    private static final String INSTANCE_ID = \"instance_id\";\n+    private static final String TIME = \"time\";\n+    private static final String SERVICE_INSTANCE_UUID = \"service_instance_UUID\";\n+    private static final String COMMANDS = \"commands\";\n+\n+    public ServiceInstancePingServletHandler(ModuleManager moduleManager) {\n+        this.serviceInstanceInventoryRegister = moduleManager.find(CoreModule.NAME).provider().getService(\n+            IServiceInstanceInventoryRegister.class);\n+        this.serviceInstanceInventoryCache = moduleManager.find(CoreModule.NAME).provider().getService(\n+            ServiceInstanceInventoryCache.class);\n+        this.serviceInventoryRegister = moduleManager.find(CoreModule.NAME).provider().getService(\n+            IServiceInventoryRegister.class);\n+        this.commandService = moduleManager.find(CoreModule.NAME).provider().getService(CommandService.class);\n+    }\n+\n+    @Override\n+    public String pathSpec() {\n+        return \"/v2/instance/heartbeat\";\n+    }\n+\n+    @Override\n+    protected JsonElement doGet(HttpServletRequest req) throws ArgumentsParseException {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    protected JsonElement doPost(HttpServletRequest req) throws ArgumentsParseException, IOException {\n+        JsonObject responseJson = new JsonObject();\n+        try {\n+            JsonObject heartBeat = gson.fromJson(req.getReader(), JsonObject.class);\n+            int instanceId = heartBeat.get(INSTANCE_ID).getAsInt();\n+            long heartBeatTime = heartBeat.get(TIME).getAsLong();\n+            String serviceInstanceUUID = heartBeat.get(SERVICE_INSTANCE_UUID).getAsString();\n+\n+            serviceInstanceInventoryRegister.heartbeat(instanceId, heartBeatTime);\n+            ServiceInstanceInventory serviceInstanceInventory = serviceInstanceInventoryCache.get(instanceId);\n+            if (Objects.nonNull(serviceInstanceInventory)) {\n+                serviceInventoryRegister.heartbeat(serviceInstanceInventory.getServiceId(), heartBeatTime);\n+            } else {\n+                logger.warn(\n+                    \"Can't found service by service instance id from cache, service instance id is: {}\", instanceId);\n+\n+                final ServiceResetCommand resetCommand = commandService.newResetCommand(\n+                    instanceId, heartBeatTime, serviceInstanceUUID);\n+                final Command command = resetCommand.serialize().build();\n+                final Commands nextCommands = Commands.newBuilder().addCommands(command).build();\n+                responseJson.add(COMMANDS, gson.toJsonTree(nextCommands, Commands.class));\n+            }\n+            responseJson.addProperty(INSTANCE_ID, instanceId);\n+            responseJson.addProperty(TIME, heartBeatTime);\n+        } catch (IOException e) {\n+            logger.error(e.getMessage(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef86e724ffb8787dddfb294a2c16570d872bfd2b"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk2MTEzNg==", "bodyText": "use org.apache.skywalking.oap.server.library.util.ProtoBufJsonUtils#toJSON", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r382961136", "createdAt": "2020-02-23T03:43:37Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-receiver-plugin/skywalking-register-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/register/provider/handler/v6/rest/ServiceInstancePingServletHandler.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.register.provider.handler.v6.rest;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import java.io.IOException;\n+import java.util.Objects;\n+import javax.servlet.http.HttpServletRequest;\n+import org.apache.skywalking.apm.network.common.Command;\n+import org.apache.skywalking.apm.network.common.Commands;\n+import org.apache.skywalking.apm.network.trace.component.command.ServiceResetCommand;\n+import org.apache.skywalking.oap.server.core.CoreModule;\n+import org.apache.skywalking.oap.server.core.cache.ServiceInstanceInventoryCache;\n+import org.apache.skywalking.oap.server.core.command.CommandService;\n+import org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory;\n+import org.apache.skywalking.oap.server.core.register.service.IServiceInstanceInventoryRegister;\n+import org.apache.skywalking.oap.server.core.register.service.IServiceInventoryRegister;\n+import org.apache.skywalking.oap.server.library.module.ModuleManager;\n+import org.apache.skywalking.oap.server.library.server.jetty.ArgumentsParseException;\n+import org.apache.skywalking.oap.server.library.server.jetty.JettyJsonHandler;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ServiceInstancePingServletHandler extends JettyJsonHandler {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(ServiceInstancePingServletHandler.class);\n+\n+    private final IServiceInstanceInventoryRegister serviceInstanceInventoryRegister;\n+    private final ServiceInstanceInventoryCache serviceInstanceInventoryCache;\n+    private final IServiceInventoryRegister serviceInventoryRegister;\n+    private final CommandService commandService;\n+    private final Gson gson = new Gson();\n+\n+    private static final String INSTANCE_ID = \"instance_id\";\n+    private static final String TIME = \"time\";\n+    private static final String SERVICE_INSTANCE_UUID = \"service_instance_UUID\";\n+    private static final String COMMANDS = \"commands\";\n+\n+    public ServiceInstancePingServletHandler(ModuleManager moduleManager) {\n+        this.serviceInstanceInventoryRegister = moduleManager.find(CoreModule.NAME).provider().getService(\n+            IServiceInstanceInventoryRegister.class);\n+        this.serviceInstanceInventoryCache = moduleManager.find(CoreModule.NAME).provider().getService(\n+            ServiceInstanceInventoryCache.class);\n+        this.serviceInventoryRegister = moduleManager.find(CoreModule.NAME).provider().getService(\n+            IServiceInventoryRegister.class);\n+        this.commandService = moduleManager.find(CoreModule.NAME).provider().getService(CommandService.class);\n+    }\n+\n+    @Override\n+    public String pathSpec() {\n+        return \"/v2/instance/heartbeat\";\n+    }\n+\n+    @Override\n+    protected JsonElement doGet(HttpServletRequest req) throws ArgumentsParseException {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    protected JsonElement doPost(HttpServletRequest req) throws ArgumentsParseException, IOException {\n+        JsonObject responseJson = new JsonObject();\n+        try {\n+            JsonObject heartBeat = gson.fromJson(req.getReader(), JsonObject.class);\n+            int instanceId = heartBeat.get(INSTANCE_ID).getAsInt();\n+            long heartBeatTime = heartBeat.get(TIME).getAsLong();\n+            String serviceInstanceUUID = heartBeat.get(SERVICE_INSTANCE_UUID).getAsString();\n+\n+            serviceInstanceInventoryRegister.heartbeat(instanceId, heartBeatTime);\n+            ServiceInstanceInventory serviceInstanceInventory = serviceInstanceInventoryCache.get(instanceId);\n+            if (Objects.nonNull(serviceInstanceInventory)) {\n+                serviceInventoryRegister.heartbeat(serviceInstanceInventory.getServiceId(), heartBeatTime);\n+            } else {\n+                logger.warn(\n+                    \"Can't found service by service instance id from cache, service instance id is: {}\", instanceId);\n+\n+                final ServiceResetCommand resetCommand = commandService.newResetCommand(\n+                    instanceId, heartBeatTime, serviceInstanceUUID);\n+                final Command command = resetCommand.serialize().build();\n+                final Commands nextCommands = Commands.newBuilder().addCommands(command).build();\n+                responseJson.add(COMMANDS, gson.toJsonTree(nextCommands, Commands.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef86e724ffb8787dddfb294a2c16570d872bfd2b"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUwMTI0NQ==", "bodyText": "Why not put this test into the library-util module? If I remember correctly, coverage of unit tests locate in another module won't be counted", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r384501245", "createdAt": "2020-02-26T13:47:44Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-receiver-plugin/skywalking-trace-receiver-plugin/src/test/java/org/apache/skywalking/oap/server/receiver/trace/provider/parser/listener/segment/ProtoBufJsonUtilsTest.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.trace.provider.parser.listener.segment;\n+\n+import java.io.IOException;\n+import org.apache.skywalking.apm.network.language.agent.UpstreamSegment;\n+import org.apache.skywalking.apm.network.language.agent.v2.SegmentObject;\n+import org.apache.skywalking.oap.server.library.util.ProtoBufJsonUtils;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+public class ProtoBufJsonUtilsTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4faf8cbb567b039734297541c48f56623457730"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUwNDk5Ng==", "bodyText": "Seems the returned value is never used, thus .build() is unnecessary", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r384504996", "createdAt": "2020-02-26T13:54:08Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-library/library-util/src/main/java/org/apache/skywalking/oap/server/library/util/ProtoBufJsonUtils.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.library.util;\n+\n+import com.google.protobuf.Message;\n+import com.google.protobuf.util.JsonFormat;\n+import java.io.IOException;\n+\n+public class ProtoBufJsonUtils {\n+\n+    public static String toJSON(Message sourceMessage) throws IOException {\n+        return JsonFormat.printer().print(sourceMessage);\n+    }\n+\n+    /**\n+     * Extract data from a JSON String and use them to construct a Protocol Buffers Message.\n+     *\n+     * @param json          A JSON data string to parse\n+     * @param targetBuilder A Message builder to use to construct the resulting Message\n+     * @return the constructed Message\n+     * @throws com.google.protobuf.InvalidProtocolBufferException Thrown in case of invalid Message data\n+     */\n+    public static Message fromJSON(String json, Message.Builder targetBuilder) throws IOException {\n+        JsonFormat.parser()\n+                  .usingTypeRegistry(JsonFormat.TypeRegistry.newBuilder()\n+                                                            .add(targetBuilder.getDescriptorForType())\n+                                                            .build())\n+                  .ignoringUnknownFields()\n+                  .merge(json, targetBuilder);\n+        return targetBuilder.build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4faf8cbb567b039734297541c48f56623457730"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUwNjc3OA==", "bodyText": "'StringBuffer stringBuffer' may be declared as 'StringBuilder'", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r384506778", "createdAt": "2020-02-26T13:57:14Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-receiver-plugin/skywalking-trace-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/trace/provider/handler/v6/rest/TraceSegmentCollectServletHandler.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.trace.provider.handler.v6.rest;\n+\n+import com.google.gson.JsonElement;\n+import java.io.BufferedReader;\n+import javax.servlet.http.HttpServletRequest;\n+import org.apache.skywalking.apm.network.language.agent.UpstreamSegment;\n+import org.apache.skywalking.oap.server.library.server.jetty.JettyJsonHandler;\n+import org.apache.skywalking.oap.server.receiver.trace.provider.handler.v6.rest.reader.UpstreamSegmentJsonReader;\n+import org.apache.skywalking.oap.server.receiver.trace.provider.parser.SegmentParseV2;\n+import org.apache.skywalking.oap.server.receiver.trace.provider.parser.SegmentSource;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class TraceSegmentCollectServletHandler extends JettyJsonHandler {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(TraceSegmentCollectServletHandler.class);\n+\n+    private final SegmentParseV2.Producer segmentProducer;\n+\n+    private UpstreamSegmentJsonReader upstreamSegmentJsonReader = new UpstreamSegmentJsonReader();\n+\n+    public TraceSegmentCollectServletHandler(SegmentParseV2.Producer segmentProducer) {\n+        this.segmentProducer = segmentProducer;\n+    }\n+\n+    @Override\n+    public String pathSpec() {\n+        return \"/v2/segments\";\n+    }\n+\n+    @Override\n+    protected JsonElement doGet(HttpServletRequest req) {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    protected JsonElement doPost(HttpServletRequest req) {\n+        if (logger.isDebugEnabled()) {\n+            logger.debug(\"receive stream segment\");\n+        }\n+\n+        StringBuffer stringBuffer = new StringBuffer();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4faf8cbb567b039734297541c48f56623457730"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "244740e32e48be4d1c8801c098919594baeb5e96", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/244740e32e48be4d1c8801c098919594baeb5e96", "committedDate": "2020-02-29T03:31:47Z", "message": "fix maven and finish docs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0d075b7e1e51a33ac2108c03a065448bac9f944", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/a0d075b7e1e51a33ac2108c03a065448bac9f944", "committedDate": "2020-02-29T03:32:33Z", "message": "Merge remote-tracking branch 'origin/rest_api' into rest_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "446840c039ccfaeb1af305f481d63dd0654ada79", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/446840c039ccfaeb1af305f481d63dd0654ada79", "committedDate": "2020-02-29T03:37:54Z", "message": "remove"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3178f7e5e23d64aaa6be1539f2446e7e14f47164", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/3178f7e5e23d64aaa6be1539f2446e7e14f47164", "committedDate": "2020-02-29T03:38:44Z", "message": "Merge branch 'master' into rest_api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NzkwODc2", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-366790876", "createdAt": "2020-02-29T10:33:11Z", "commit": {"oid": "3178f7e5e23d64aaa6be1539f2446e7e14f47164"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQxMDozMzoxMVrOFwIuHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQxMDozMzoxMVrOFwIuHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxODg0NA==", "bodyText": "It should be an array, right\uff1f", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r386018844", "createdAt": "2020-02-29T10:33:11Z", "author": {"login": "arugal"}, "path": "docs/en/protocols/HTTP-API-Protocol.md", "diffHunk": "@@ -0,0 +1,198 @@\n+# HTTP API Protocol\n+\n+HTTP API Protocol define the API data format, including api request and response data format.\n+\n+### Do register\n+\n+For more information about data format can be found in [Register service](https://github.com/apache/skywalking-data-collect-protocol/tree/master/register/Register.proto).\n+And register steps followings [SkyWalking Trace Data Protocol v2](Trace-Data-Protocol-v2.md).\n+\n+- Service Register\n+\n+> POST http://localhost:12800/v2/service/register\n+\n+Input:\n+\n+```json\n+{\n+  \"services\": [\n+    {\n+      \"type\": \"normal\",\n+      \"serviceName\": \"Service Name\"\n+    }\n+  ]\n+}\n+```\n+\n+Output JSON Array:\n+\n+```json\n+[\n+    {\n+        \"key\": \"Service Name\",\n+        \"value\": 2\n+    }\n+]\n+```\n+\n+- Service instance Register\n+\n+> POST http://localhost:12800/v2/instance/register\n+\n+Input:\n+\n+```json\n+{\n+  \"instances\": [\n+    {\n+      \"time\": 1582428603392,\n+      \"instanceUUID\": \"NAME:Service Instance Name\",\n+      \"properties\": [\n+        {\n+          \"key\": \"language\",\n+          \"value\": \"Lua\"\n+        }\n+      ],\n+      \"serviceId\": 2\n+    }\n+  ]\n+}\n+```\n+\n+OutPut:\n+\n+```json\n+{\n+    \"key\": \"NAME:Service Instance Name\",\n+    \"value\": 2\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3178f7e5e23d64aaa6be1539f2446e7e14f47164"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2Nzk1Mjk5", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-366795299", "createdAt": "2020-02-29T12:19:18Z", "commit": {"oid": "a0d075b7e1e51a33ac2108c03a065448bac9f944"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQxMjoxOToxOFrOFwJENw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQxMjo0MTo1NVrOFwJJbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAyNDUwMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            HTTP API Protocol define the API data format, including api request and response data format.\n          \n          \n            \n            HTTP API Protocol defines the API data format, including api request and response data format.", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r386024503", "createdAt": "2020-02-29T12:19:18Z", "author": {"login": "kezhenxu94"}, "path": "docs/en/protocols/HTTP-API-Protocol.md", "diffHunk": "@@ -0,0 +1,198 @@\n+# HTTP API Protocol\n+\n+HTTP API Protocol define the API data format, including api request and response data format.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0d075b7e1e51a33ac2108c03a065448bac9f944"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAyNDY0MA==", "bodyText": "Seems to be a grammar error\nFor more information about the data format, please refer to .....\nOR\nDetail information about data format can be found in ......", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r386024640", "createdAt": "2020-02-29T12:22:00Z", "author": {"login": "kezhenxu94"}, "path": "docs/en/protocols/HTTP-API-Protocol.md", "diffHunk": "@@ -0,0 +1,198 @@\n+# HTTP API Protocol\n+\n+HTTP API Protocol define the API data format, including api request and response data format.\n+\n+### Do register\n+\n+For more information about data format can be found in [Register service](https://github.com/apache/skywalking-data-collect-protocol/tree/master/register/Register.proto).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0d075b7e1e51a33ac2108c03a065448bac9f944"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAyNDc1Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            If your instance does not exists, and then, you need to clean your local service instance metadata in your application and re-do register:\n          \n          \n            \n            If your instance does not exist, you need to clean your local service instance metadata in your application and re-register:", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r386024756", "createdAt": "2020-02-29T12:24:04Z", "author": {"login": "kezhenxu94"}, "path": "docs/en/protocols/HTTP-API-Protocol.md", "diffHunk": "@@ -0,0 +1,198 @@\n+# HTTP API Protocol\n+\n+HTTP API Protocol define the API data format, including api request and response data format.\n+\n+### Do register\n+\n+For more information about data format can be found in [Register service](https://github.com/apache/skywalking-data-collect-protocol/tree/master/register/Register.proto).\n+And register steps followings [SkyWalking Trace Data Protocol v2](Trace-Data-Protocol-v2.md).\n+\n+- Service Register\n+\n+> POST http://localhost:12800/v2/service/register\n+\n+Input:\n+\n+```json\n+{\n+  \"services\": [\n+    {\n+      \"type\": \"normal\",\n+      \"serviceName\": \"Service Name\"\n+    }\n+  ]\n+}\n+```\n+\n+Output JSON Array:\n+\n+```json\n+[\n+    {\n+        \"key\": \"Service Name\",\n+        \"value\": 2\n+    }\n+]\n+```\n+\n+- Service instance Register\n+\n+> POST http://localhost:12800/v2/instance/register\n+\n+Input:\n+\n+```json\n+{\n+  \"instances\": [\n+    {\n+      \"time\": 1582428603392,\n+      \"instanceUUID\": \"NAME:Service Instance Name\",\n+      \"properties\": [\n+        {\n+          \"key\": \"language\",\n+          \"value\": \"Lua\"\n+        }\n+      ],\n+      \"serviceId\": 2\n+    }\n+  ]\n+}\n+```\n+\n+OutPut:\n+\n+```json\n+{\n+    \"key\": \"NAME:Service Instance Name\",\n+    \"value\": 2\n+}\n+```\n+\n+- Service instance heartbeat\n+\n+> POST http://localhost:12800/v2/instance/heartbeat\n+\n+Input:\n+\n+```json\n+{\n+  \"serviceInstanceId\":20,\n+  \"time\": 1582428603392,\n+  \"serviceInstanceUUID\":\"NAME:Service Instance Name\"\n+}\n+```\n+\n+OutPut:\n+\n+```json\n+{}\n+```\n+If your instance does not exists, and then, you need to clean your local service instance metadata in your application and re-do register:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0d075b7e1e51a33ac2108c03a065448bac9f944"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAyNDg4MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            [HTTP API Protocol](HTTP-API-Protocol.md) define the API data format.\n          \n          \n            \n            [HTTP API Protocol](HTTP-API-Protocol.md) defines the API data format.", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r386024880", "createdAt": "2020-02-29T12:25:37Z", "author": {"login": "kezhenxu94"}, "path": "docs/en/protocols/Trace-Data-Protocol-v2.md", "diffHunk": "@@ -7,6 +7,9 @@ Trace data protocol is defined and provided in [gRPC format](https://github.com/\n For each agent/SDK, it needs to register service id and service instance id before reporting any kind of trace \n or metrics data.\n \n+Since SkyWalking v7.x, SkyWalking provided register and uplink trace data through HTTP API way.\n+[HTTP API Protocol](HTTP-API-Protocol.md) define the API data format.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0d075b7e1e51a33ac2108c03a065448bac9f944"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAyNTYwOQ==", "bodyText": "Two versions of protobuf-java?  Please check whether the older version is still in use or not, if not, remove it here and update the file below, otherwise consider making the versions consistent\n\n  \n    \n      skywalking/dist-material/release-docs/LICENSE\n    \n    \n        Lines 367 to 368\n      in\n      29da573\n    \n    \n    \n    \n\n        \n          \n           Google: protobuf-java 3.4.0: https://github.com/google/protobuf/blob/master/java/pom.xml , BSD-3-Clause \n        \n\n        \n          \n           Google: protobuf-java-util 3.4.0: https://github.com/google/protobuf/blob/master/java/pom.xml , BSD-3-Clause", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r386025609", "createdAt": "2020-02-29T12:38:12Z", "author": {"login": "kezhenxu94"}, "path": "tools/dependencies/known-oap-backend-dependencies-es7.txt", "diffHunk": "@@ -143,6 +143,7 @@ parent-join-client-7.0.0.jar\n perfmark-api-0.19.0.jar\n proto-google-common-protos-1.12.0.jar\n protobuf-java-3.4.0.jar\n+protobuf-java-3.11.4.jar", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0d075b7e1e51a33ac2108c03a065448bac9f944"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAyNTc4OQ==", "bodyText": "Dangling Javadoc comment", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r386025789", "createdAt": "2020-02-29T12:41:13Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-receiver-plugin/skywalking-register-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/register/provider/handler/v6/rest/ServiceInstanceRegisterServletHandler.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.register.provider.handler.v6.rest;\n+\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import javax.servlet.http.HttpServletRequest;\n+import org.apache.skywalking.apm.network.common.KeyStringValuePair;\n+import org.apache.skywalking.apm.network.register.v2.ServiceInstance;\n+import org.apache.skywalking.apm.network.register.v2.ServiceInstances;\n+import org.apache.skywalking.oap.server.core.CoreModule;\n+import org.apache.skywalking.oap.server.core.cache.ServiceInventoryCache;\n+import org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory;\n+import org.apache.skywalking.oap.server.core.register.ServiceInventory;\n+import org.apache.skywalking.oap.server.core.register.service.IServiceInstanceInventoryRegister;\n+import org.apache.skywalking.oap.server.library.module.ModuleManager;\n+import org.apache.skywalking.oap.server.library.server.jetty.ArgumentsParseException;\n+import org.apache.skywalking.oap.server.library.server.jetty.JettyJsonHandler;\n+import org.apache.skywalking.oap.server.library.util.ProtoBufJsonUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory.PropertyUtil.HOST_NAME;\n+import static org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory.PropertyUtil.IPV4S;\n+import static org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory.PropertyUtil.LANGUAGE;\n+import static org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory.PropertyUtil.OS_NAME;\n+import static org.apache.skywalking.oap.server.core.register.ServiceInstanceInventory.PropertyUtil.PROCESS_NO;\n+\n+public class ServiceInstanceRegisterServletHandler extends JettyJsonHandler {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(ServiceInstanceRegisterServletHandler.class);\n+    private static final String INSTANCE_CUSTOMIZED_NAME_PREFIX = \"NAME:\";\n+\n+    private final IServiceInstanceInventoryRegister serviceInstanceInventoryRegister;\n+    private final ServiceInventoryCache serviceInventoryCache;\n+\n+    private static final String KEY = \"key\";\n+    private static final String VALUE = \"value\";\n+\n+    public ServiceInstanceRegisterServletHandler(ModuleManager moduleManager) {\n+        this.serviceInventoryCache = moduleManager.find(CoreModule.NAME)\n+                                                  .provider()\n+                                                  .getService(ServiceInventoryCache.class);\n+        this.serviceInstanceInventoryRegister = moduleManager.find(CoreModule.NAME).provider().getService(\n+            IServiceInstanceInventoryRegister.class);\n+    }\n+\n+    @Override\n+    public String pathSpec() {\n+        return \"/v2/instance/register\";\n+    }\n+\n+    @Override\n+    protected JsonElement doGet(HttpServletRequest req) throws ArgumentsParseException {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    protected JsonElement doPost(HttpServletRequest req) throws ArgumentsParseException {\n+\n+        JsonObject responseJson = new JsonObject();\n+\n+        try {\n+            ServiceInstances.Builder builder = ServiceInstances.newBuilder();\n+            ProtoBufJsonUtils.fromJSON(getJsonBody(req), builder);\n+            List<ServiceInstance> serviceInstances = builder.build().getInstancesList();\n+\n+            serviceInstances.forEach(instance -> {\n+                long time = instance.getTime();\n+                int serviceId = instance.getServiceId();\n+                String instanceUUID = instance.getInstanceUUID();\n+\n+                JsonObject instanceProperties = new JsonObject();\n+                List<String> ipv4s = new ArrayList<>();\n+\n+                for (KeyStringValuePair property : instance.getPropertiesList()) {\n+                    String key = property.getKey();\n+                    switch (key) {\n+                        case HOST_NAME:\n+                            instanceProperties.addProperty(HOST_NAME, property.getValue());\n+                            break;\n+                        case OS_NAME:\n+                            instanceProperties.addProperty(OS_NAME, property.getValue());\n+                            break;\n+                        case LANGUAGE:\n+                            instanceProperties.addProperty(LANGUAGE, property.getValue());\n+                            break;\n+                        case \"ipv4\":\n+                            ipv4s.add(property.getValue());\n+                            break;\n+                        case PROCESS_NO:\n+                            instanceProperties.addProperty(PROCESS_NO, property.getValue());\n+                            break;\n+                        default:\n+                            instanceProperties.addProperty(key, property.getValue());\n+                    }\n+                }\n+                instanceProperties.addProperty(IPV4S, ServiceInstanceInventory.PropertyUtil.ipv4sSerialize(ipv4s));\n+\n+                String instanceName = null;\n+                if (instanceUUID.startsWith(INSTANCE_CUSTOMIZED_NAME_PREFIX)) {\n+                    instanceName = instanceUUID.substring(INSTANCE_CUSTOMIZED_NAME_PREFIX.length());\n+                }\n+\n+                ServiceInventory serviceInventory = serviceInventoryCache.get(serviceId);\n+\n+                if (instanceName == null) {\n+                    /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3178f7e5e23d64aaa6be1539f2446e7e14f47164"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAyNTgzOQ==", "bodyText": "no return now", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r386025839", "createdAt": "2020-02-29T12:41:55Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-library/library-util/src/main/java/org/apache/skywalking/oap/server/library/util/ProtoBufJsonUtils.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.library.util;\n+\n+import com.google.protobuf.Message;\n+import com.google.protobuf.util.JsonFormat;\n+import java.io.IOException;\n+\n+public class ProtoBufJsonUtils {\n+\n+    public static String toJSON(Message sourceMessage) throws IOException {\n+        return JsonFormat.printer().print(sourceMessage);\n+    }\n+\n+    /**\n+     * Extract data from a JSON String and use them to construct a Protocol Buffers Message.\n+     *\n+     * @param json          A JSON data string to parse\n+     * @param targetBuilder A Message builder to use to construct the resulting Message\n+     * @return the constructed Message", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3178f7e5e23d64aaa6be1539f2446e7e14f47164"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "649f430041b4b7cf9fb0bf39d9f9d4d48f578eeb", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/649f430041b4b7cf9fb0bf39d9f9d4d48f578eeb", "committedDate": "2020-02-29T14:51:30Z", "message": "add e2e."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5031fa7f3bbb9bff04cf255fcac5ac45b358cbe", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/f5031fa7f3bbb9bff04cf255fcac5ac45b358cbe", "committedDate": "2020-02-29T14:51:40Z", "message": "e2e"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cab97c67bb6b735c5d0105f9ce1b2faeba993ddf", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/cab97c67bb6b735c5d0105f9ce1b2faeba993ddf", "committedDate": "2020-02-29T14:51:40Z", "message": "revert application.yml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e05e4e924ecfe8c4dc012588424482fc591ff45e", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/e05e4e924ecfe8c4dc012588424482fc591ff45e", "committedDate": "2020-02-29T14:51:40Z", "message": "init e2e"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d714955f705072688ee98df8ff77d2c371cd9a2d", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/d714955f705072688ee98df8ff77d2c371cd9a2d", "committedDate": "2020-02-29T15:06:03Z", "message": "revert application.yml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "599c4fd238dd491f5d996a2cfced6e902fa9ab22", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/599c4fd238dd491f5d996a2cfced6e902fa9ab22", "committedDate": "2020-02-29T15:12:41Z", "message": "Merge branch 'master' into rest_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e94b7fe587174c74431081cbdca60e2567881968", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/e94b7fe587174c74431081cbdca60e2567881968", "committedDate": "2020-02-29T15:18:33Z", "message": "active http e2e"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "214671ab3c55214a38cd580ece56ef12115542e4", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/214671ab3c55214a38cd580ece56ef12115542e4", "committedDate": "2020-02-29T15:19:52Z", "message": "Merge branch 'rest_api' of github.com:apache/skywalking into rest_api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2ODI4MTM1", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-366828135", "createdAt": "2020-03-01T00:55:23Z", "commit": {"oid": "214671ab3c55214a38cd580ece56ef12115542e4"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMVQwMDo1NToyNFrOFwLqSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMVQwMDo1OTo1NFrOFwLrAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA2NzAxOQ==", "bodyText": "What is this for?", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r386067019", "createdAt": "2020-03-01T00:55:24Z", "author": {"login": "wu-sheng"}, "path": ".gitignore", "diffHunk": "@@ -20,3 +20,4 @@ OALLexer.tokens\n .externalToolBuilders\n /test/plugin/dist\n /test/plugin/workspace\n+e2e-*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "214671ab3c55214a38cd580ece56ef12115542e4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA2NzEzOQ==", "bodyText": "Could we set this parameter as a more clear place? Such as in the pom.xml?", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r386067139", "createdAt": "2020-03-01T00:57:35Z", "author": {"login": "wu-sheng"}, "path": "test/e2e/e2e-http-api-with-nginx-lua/src/docker/rc.d/rc0-prepare.sh", "diffHunk": "@@ -0,0 +1,27 @@\n+#!/usr/bin/env bash\n+# Licensed to the SkyAPM under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+apt-get update && apt-get -y install git\n+\n+echo 'git clone skyalking-nginx-lua lib from https://github.com/apache/skywalking-nginx-lua.git'\n+\n+git clone https://github.com/apache/skywalking-nginx-lua.git /usr/share/skywalking-nginx-lua \\\n+  && cd /usr/share/skywalking-nginx-lua \\\n+  && git checkout 95684f3dcccab36f6592bf91944cdd5424e0d7a4 \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "214671ab3c55214a38cd580ece56ef12115542e4"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA2NzE5Mg==", "bodyText": "This scm section seems not right. SCM in pom means the source code of this module is here.", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r386067192", "createdAt": "2020-03-01T00:59:25Z", "author": {"login": "wu-sheng"}, "path": "test/e2e/e2e-http-api-with-nginx-lua/pom.xml", "diffHunk": "@@ -0,0 +1,213 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Licensed to the Apache Software Foundation (ASF) under one or more\n+  ~ contributor license agreements.  See the NOTICE file distributed with\n+  ~ this work for additional information regarding copyright ownership.\n+  ~ The ASF licenses this file to You under the Apache License, Version 2.0\n+  ~ (the \"License\"); you may not use this file except in compliance with\n+  ~ the License.  You may obtain a copy of the License at\n+  ~\n+  ~     http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  ~ See the License for the specific language governing permissions and\n+  ~ limitations under the License.\n+  ~\n+  -->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>apache-skywalking-e2e</artifactId>\n+        <groupId>org.apache.skywalking</groupId>\n+        <version>1.0.0</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>e2e-http-api-with-nginx-lua</artifactId>\n+\n+    <properties>\n+        <e2e.container.version>1.1</e2e.container.version>\n+        <e2e.container.name.prefix>skywalking-e2e-container-${build.id}-http-api-with-nginx-lua</e2e.container.name.prefix>\n+        <e2e.nginx.version></e2e.nginx.version>\n+    </properties>\n+\n+    <scm>\n+        <connection>scm:git:https://github.com/apache/skywalking-nginx-lua.git</connection>\n+        <developerConnection>scm:git:https://github.com/apache/skywalking-nginx-lua.git</developerConnection>\n+        <url>https://github.com/apache/skywalking-nginx-lua.git</url>\n+    </scm>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "214671ab3c55214a38cd580ece56ef12115542e4"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA2NzIwMw==", "bodyText": "You could add some of these as properties for your startup script.", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r386067203", "createdAt": "2020-03-01T00:59:54Z", "author": {"login": "wu-sheng"}, "path": "test/e2e/e2e-http-api-with-nginx-lua/pom.xml", "diffHunk": "@@ -0,0 +1,213 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Licensed to the Apache Software Foundation (ASF) under one or more\n+  ~ contributor license agreements.  See the NOTICE file distributed with\n+  ~ this work for additional information regarding copyright ownership.\n+  ~ The ASF licenses this file to You under the Apache License, Version 2.0\n+  ~ (the \"License\"); you may not use this file except in compliance with\n+  ~ the License.  You may obtain a copy of the License at\n+  ~\n+  ~     http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  ~ See the License for the specific language governing permissions and\n+  ~ limitations under the License.\n+  ~\n+  -->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>apache-skywalking-e2e</artifactId>\n+        <groupId>org.apache.skywalking</groupId>\n+        <version>1.0.0</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>e2e-http-api-with-nginx-lua</artifactId>\n+\n+    <properties>\n+        <e2e.container.version>1.1</e2e.container.version>\n+        <e2e.container.name.prefix>skywalking-e2e-container-${build.id}-http-api-with-nginx-lua</e2e.container.name.prefix>\n+        <e2e.nginx.version></e2e.nginx.version>\n+    </properties>\n+\n+    <scm>\n+        <connection>scm:git:https://github.com/apache/skywalking-nginx-lua.git</connection>\n+        <developerConnection>scm:git:https://github.com/apache/skywalking-nginx-lua.git</developerConnection>\n+        <url>https://github.com/apache/skywalking-nginx-lua.git</url>\n+    </scm>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA2NzE5Mg=="}, "originalCommit": {"oid": "214671ab3c55214a38cd580ece56ef12115542e4"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b4a9b83ebeee7ddef104456867cd62c347f1b72", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/9b4a9b83ebeee7ddef104456867cd62c347f1b72", "committedDate": "2020-03-01T04:24:07Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "630786d5a244fe482536bfc69101ecab0e9b6976", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/630786d5a244fe482536bfc69101ecab0e9b6976", "committedDate": "2020-03-01T05:00:52Z", "message": "fix json array."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "455857d85b788575a9e24f4fb254e017ed2ba555", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/455857d85b788575a9e24f4fb254e017ed2ba555", "committedDate": "2020-03-01T08:01:28Z", "message": "update e2e."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c7b71bd74dfe006292898bb1187a4f7a0093d22", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/4c7b71bd74dfe006292898bb1187a4f7a0093d22", "committedDate": "2020-03-01T08:02:20Z", "message": "fix env in shell."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f030d4a61d9cdc27a452b5581e457baf1215725", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/0f030d4a61d9cdc27a452b5581e457baf1215725", "committedDate": "2020-03-01T12:07:58Z", "message": "fix nginx port."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1fd779223da02d85dbb14ec53244695d1a8862c", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/a1fd779223da02d85dbb14ec53244695d1a8862c", "committedDate": "2020-03-01T12:32:55Z", "message": "fix container network."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "045a1eb271672c88382021f4b6ac16ac67d05c6c", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/045a1eb271672c88382021f4b6ac16ac67d05c6c", "committedDate": "2020-03-01T12:52:46Z", "message": "fix container network."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1aae8b93cd680898eaa94455f27818b68890558", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/c1aae8b93cd680898eaa94455f27818b68890558", "committedDate": "2020-03-01T13:44:11Z", "message": "fix license."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49d148483b8e9c5562bdfb15a355c81060feeeb4", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/49d148483b8e9c5562bdfb15a355c81060feeeb4", "committedDate": "2020-03-02T02:50:44Z", "message": "e2e:fix lua agent register ip port."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfc6a5b3639ffec3250a66720916aaf2a1ee5b10", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/dfc6a5b3639ffec3250a66720916aaf2a1ee5b10", "committedDate": "2020-03-02T02:54:08Z", "message": "e2e:fix lua agent register ip port."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2OTMxNzE5", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-366931719", "createdAt": "2020-03-02T03:19:12Z", "commit": {"oid": "49d148483b8e9c5562bdfb15a355c81060feeeb4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQwMzoxOToxM1rOFwSqaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQwMzoxOToxM1rOFwSqaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE4MTczNg==", "bodyText": "Move this to Compatibilities section. This is HTTP + LUA compatible test. And we could run test faster there.", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r386181736", "createdAt": "2020-03-02T03:19:13Z", "author": {"login": "wu-sheng"}, "path": ".github/workflows/e2e.yaml", "diffHunk": "@@ -44,6 +44,8 @@ jobs:\n           ./mvnw --batch-mode -f test/e2e/pom.xml -pl e2e-base clean install\n       - name: Single Node Tests(JDK8)\n         run: export E2E_VERSION=jdk8-1.5 && bash -x test/e2e/run.sh e2e-single-service\n+      - name: Single Http API with Ningx Lua Tests(JDK8)\n+        run: export E2E_VERSION=jdk8-1.5 && bash -x test/e2e/run.sh e2e-http-api-with-nginx-lua", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d148483b8e9c5562bdfb15a355c81060feeeb4"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2OTMyNjg0", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-366932684", "createdAt": "2020-03-02T03:23:48Z", "commit": {"oid": "49d148483b8e9c5562bdfb15a355c81060feeeb4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQwMzoyMzo0OFrOFwStnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQwMzoyMzo0OFrOFwStnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE4MjU1Ng==", "bodyText": "And Single is not clear in the expression. Please rename this to a more clear name.", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r386182556", "createdAt": "2020-03-02T03:23:48Z", "author": {"login": "wu-sheng"}, "path": ".github/workflows/e2e.yaml", "diffHunk": "@@ -44,6 +44,8 @@ jobs:\n           ./mvnw --batch-mode -f test/e2e/pom.xml -pl e2e-base clean install\n       - name: Single Node Tests(JDK8)\n         run: export E2E_VERSION=jdk8-1.5 && bash -x test/e2e/run.sh e2e-single-service\n+      - name: Single Http API with Ningx Lua Tests(JDK8)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d148483b8e9c5562bdfb15a355c81060feeeb4"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be624839042dd9256d2c75e3966c075147bf8ebf", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/be624839042dd9256d2c75e3966c075147bf8ebf", "committedDate": "2020-03-02T05:23:28Z", "message": "rename e2e name."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "effc253b8b58fe829984424623972a77fe9c85f0", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/effc253b8b58fe829984424623972a77fe9c85f0", "committedDate": "2020-03-02T05:25:12Z", "message": "rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd5301ab0f87621759a08c762b3a207542ba0d3b", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/bd5301ab0f87621759a08c762b3a207542ba0d3b", "committedDate": "2020-03-02T06:07:44Z", "message": "fix no file."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e3e1ee41c35dd78bbc02cdcc4c905211818d42c", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/1e3e1ee41c35dd78bbc02cdcc4c905211818d42c", "committedDate": "2020-03-03T06:23:27Z", "message": "update e2e"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e04508bcce776ab801501cbdb2da2de3cee920d", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/7e04508bcce776ab801501cbdb2da2de3cee920d", "committedDate": "2020-03-03T06:39:06Z", "message": "fix logical"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3ODI0NzQ1", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-367824745", "createdAt": "2020-03-03T09:36:31Z", "commit": {"oid": "7e04508bcce776ab801501cbdb2da2de3cee920d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwOTozNjozMVrOFw-WwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwOTozNjozMVrOFw-WwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg5NzYwMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  - name: Http API with Ningx Lua Tests In Single Node Mode(JDK8)\n          \n          \n            \n                  - name: Http API with Nginx Lua Tests In Single Node Mode(JDK8)", "url": "https://github.com/apache/skywalking/pull/4399#discussion_r386897600", "createdAt": "2020-03-03T09:36:31Z", "author": {"login": "kezhenxu94"}, "path": ".github/workflows/e2e.yaml", "diffHunk": "@@ -116,6 +116,8 @@ jobs:\n           ./mvnw --batch-mode -f test/e2e/pom.xml -pl e2e-base clean install\n       - name: 6.x Agents & 7.x Backend\n         run: export E2E_VERSION=jdk8-1.5 && bash -x test/e2e/run.sh e2e-6.x-agent-7.x-oap-compatibility\n+      - name: Http API with Ningx Lua Tests In Single Node Mode(JDK8)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e04508bcce776ab801501cbdb2da2de3cee920d"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb7cf03b4f8b27b6c3a54b25ed1881d52b8558e2", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/eb7cf03b4f8b27b6c3a54b25ed1881d52b8558e2", "committedDate": "2020-03-03T09:49:05Z", "message": "Update .github/workflows/e2e.yaml\n\nCo-Authored-By: kezhenxu94 <kezhenxu94@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e87fa2290dca0adaf0b50affa3b2aef553f527e", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/8e87fa2290dca0adaf0b50affa3b2aef553f527e", "committedDate": "2020-03-04T03:51:55Z", "message": "fix docker upstream ip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7ab489f6a477f61e41c86178405d12472a98750", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/e7ab489f6a477f61e41c86178405d12472a98750", "committedDate": "2020-03-04T07:36:45Z", "message": "Merge branch 'master' into rest_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "203d8f0f52ca7c49c1c2fd1c653ca3473170b1e6", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/203d8f0f52ca7c49c1c2fd1c653ca3473170b1e6", "committedDate": "2020-03-04T08:35:07Z", "message": "update expected data."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cf45fde7f7719125099160e8266145c70f59a91", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/1cf45fde7f7719125099160e8266145c70f59a91", "committedDate": "2020-03-04T12:50:37Z", "message": "update expected data."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93b95ee75bb65a4f47d5f6fce7b98e5fe6f6cb66", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/93b95ee75bb65a4f47d5f6fce7b98e5fe6f6cb66", "committedDate": "2020-03-05T08:57:25Z", "message": "update expected data."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NDAzNzky", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-369403792", "createdAt": "2020-03-05T09:18:28Z", "commit": {"oid": "93b95ee75bb65a4f47d5f6fce7b98e5fe6f6cb66"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ca5beb7fc571791e541e27e3cb968ea09d647a6", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/0ca5beb7fc571791e541e27e3cb968ea09d647a6", "committedDate": "2020-03-05T09:49:36Z", "message": "fix yaml."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "458980b83ea696330a582b973eeab6dd4711f6d2", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/458980b83ea696330a582b973eeab6dd4711f6d2", "committedDate": "2020-03-05T13:04:19Z", "message": "update expected data."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f3b9df420b2220d86138aedc2d1dfee4ea03a55", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/6f3b9df420b2220d86138aedc2d1dfee4ea03a55", "committedDate": "2020-03-06T02:58:30Z", "message": "update e2e."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f155d06d787e4757b39c2584bfdef0f5c01a3ac1", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/f155d06d787e4757b39c2584bfdef0f5c01a3ac1", "committedDate": "2020-03-06T02:59:07Z", "message": "update e2e."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adacfb6fe1e1dd1b5d2398d0b6e6ba64916331d3", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/adacfb6fe1e1dd1b5d2398d0b6e6ba64916331d3", "committedDate": "2020-03-06T03:26:27Z", "message": "Merge branch 'master' into rest_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6777c477a294d65ea1d66c8ab7ea2acd29aa8afa", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/6777c477a294d65ea1d66c8ab7ea2acd29aa8afa", "committedDate": "2020-03-06T03:38:24Z", "message": "fix dep"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bc056299d7cbfbe1463cd94ce4421c250f1aa20", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/1bc056299d7cbfbe1463cd94ce4421c250f1aa20", "committedDate": "2020-03-06T04:37:57Z", "message": "fix request url"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cbde2bf68fc6a285a3bc8453b4d14a89a7916b7", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/6cbde2bf68fc6a285a3bc8453b4d14a89a7916b7", "committedDate": "2020-03-06T05:01:55Z", "message": "fix request url"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "873f573f78e4c07c882c6ca674b2d125b60cbad1", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/873f573f78e4c07c882c6ca674b2d125b60cbad1", "committedDate": "2020-03-06T05:35:03Z", "message": "fix traces."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d196bbafa1f664d2e84fdba2d62c544d5a5fa5a4", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/d196bbafa1f664d2e84fdba2d62c544d5a5fa5a4", "committedDate": "2020-03-06T07:03:21Z", "message": "fix endpoint verify."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da18a3febd5bf4e841d024eee6b80f143299474c", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/da18a3febd5bf4e841d024eee6b80f143299474c", "committedDate": "2020-03-06T10:21:22Z", "message": "fix expected data."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87baa2a2f338aa47cac661650a7447551fdc593f", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/87baa2a2f338aa47cac661650a7447551fdc593f", "committedDate": "2020-03-06T10:27:53Z", "message": "rollback data."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1c4ceca4dbe310509c0f494efe498975db03bc8", "author": {"user": {"login": "JaredTan95", "name": "Jared Tan"}}, "url": "https://github.com/apache/skywalking/commit/c1c4ceca4dbe310509c0f494efe498975db03bc8", "committedDate": "2020-03-06T12:13:27Z", "message": "update api name."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMjgyODI5", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-370282829", "createdAt": "2020-03-06T12:21:38Z", "commit": {"oid": "c1c4ceca4dbe310509c0f494efe498975db03bc8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMzAwNjcx", "url": "https://github.com/apache/skywalking/pull/4399#pullrequestreview-370300671", "createdAt": "2020-03-06T12:55:36Z", "commit": {"oid": "c1c4ceca4dbe310509c0f494efe498975db03bc8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2694, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}