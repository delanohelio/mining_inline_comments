{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5OTg3OTY4", "number": 4307, "title": "Clean up legacy v1 header logic, use built-in Base64 since JDK8", "bodyText": "Motivation:\nCodes clean up\nModifications:\n\n\nRemove v1 header, follow up #4244\n\n\nUse built-in Base64 class (since JDK8)\n\n\nResult:\n\n\nNo more legacy v1 headers\n\n\nNo unnecessary codes concerns by using built-in ability", "createdAt": "2020-02-02T08:45:14Z", "url": "https://github.com/apache/skywalking/pull/4307", "merged": true, "mergeCommit": {"oid": "bf38e43d3aadeec93a0b30f9b92e2226ff9e953c"}, "closed": true, "closedAt": "2020-02-02T09:45:06Z", "author": {"login": "kezhenxu94"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcAUUrPAFqTM1MTkyNzQ0OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcAUoPMAFqTM1MTkyODYwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTI3NDQ5", "url": "https://github.com/apache/skywalking/pull/4307#pullrequestreview-351927449", "createdAt": "2020-02-02T08:46:46Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMlQwODo0Njo0NlrOFkgvqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMlQwODo0Njo0NlrOFkgvqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyOTU0Ng==", "bodyText": "Quick return to reduce nested levels", "url": "https://github.com/apache/skywalking/pull/4307#discussion_r373829546", "createdAt": "2020-02-02T08:46:46Z", "author": {"login": "kezhenxu94"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/ContextCarrier.java", "diffHunk": "@@ -108,53 +103,36 @@ String serialize(HeaderVersion version) {\n      * @param text carries {@link #traceSegmentId} and {@link #spanId}, with '|' split.\n      */\n     ContextCarrier deserialize(String text, HeaderVersion version) {\n-        if (text != null) {\n-            // if this carrier is initialized by v1 or v2, don't do deserialize again for performance.\n-            if (this.isValid(HeaderVersion.v1) || this.isValid(HeaderVersion.v2)) {\n-                return this;\n-            }\n-            if (HeaderVersion.v1.equals(version)) {\n-                String[] parts = text.split(\"\\\\|\", 8);\n-                if (parts.length == 8) {\n-                    try {\n-                        this.traceSegmentId = new ID(parts[0]);\n-                        this.spanId = Integer.parseInt(parts[1]);\n-                        this.parentServiceInstanceId = Integer.parseInt(parts[2]);\n-                        this.entryServiceInstanceId = Integer.parseInt(parts[3]);\n-                        this.peerHost = parts[4];\n-                        this.entryEndpointName = parts[5];\n-                        this.parentEndpointName = parts[6];\n-                        this.primaryDistributedTraceId = new PropagatedTraceId(parts[7]);\n-                    } catch (NumberFormatException e) {\n-\n-                    }\n-                }\n-            } else if (HeaderVersion.v2.equals(version)) {\n-                String[] parts = text.split(\"\\\\-\", 9);\n-                if (parts.length == 9) {\n-                    try {\n-                        // parts[0] is sample flag, always trace if header exists.\n-                        this.primaryDistributedTraceId = new PropagatedTraceId(Base64.decode2UTFString(parts[1]));\n-                        this.traceSegmentId = new ID(Base64.decode2UTFString(parts[2]));\n-                        this.spanId = Integer.parseInt(parts[3]);\n-                        this.parentServiceInstanceId = Integer.parseInt(parts[4]);\n-                        this.entryServiceInstanceId = Integer.parseInt(parts[5]);\n-                        this.peerHost = Base64.decode2UTFString(parts[6]);\n-                        this.entryEndpointName = Base64.decode2UTFString(parts[7]);\n-                        this.parentEndpointName = Base64.decode2UTFString(parts[8]);\n-                    } catch (NumberFormatException e) {\n-\n-                    }\n+        if (text == null) {\n+            return this;\n+        }\n+        // if this carrier is initialized by v2, don't do deserialize again for performance.\n+        if (this.isValid(HeaderVersion.v2)) {\n+            return this;\n+        }\n+        if (HeaderVersion.v2 == version) {\n+            String[] parts = text.split(\"-\", 9);\n+            if (parts.length == 9) {\n+                try {\n+                    // parts[0] is sample flag, always trace if header exists.\n+                    this.primaryDistributedTraceId = new PropagatedTraceId(Base64.decode2UTFString(parts[1]));\n+                    this.traceSegmentId = new ID(Base64.decode2UTFString(parts[2]));\n+                    this.spanId = Integer.parseInt(parts[3]);\n+                    this.parentServiceInstanceId = Integer.parseInt(parts[4]);\n+                    this.entryServiceInstanceId = Integer.parseInt(parts[5]);\n+                    this.peerHost = Base64.decode2UTFString(parts[6]);\n+                    this.entryEndpointName = Base64.decode2UTFString(parts[7]);\n+                    this.parentEndpointName = Base64.decode2UTFString(parts[8]);\n+                } catch (NumberFormatException ignored) {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTI3NTcy", "url": "https://github.com/apache/skywalking/pull/4307#pullrequestreview-351927572", "createdAt": "2020-02-02T08:49:11Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMlQwODo0OToxMVrOFkgwKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMlQwODo0OToxOFrOFkgwLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyOTY3Mw==", "bodyText": "Don't throw an exception in agent core API. Output a warning log.", "url": "https://github.com/apache/skywalking/pull/4307#discussion_r373829673", "createdAt": "2020-02-02T08:49:11Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/ContextCarrier.java", "diffHunk": "@@ -108,53 +103,36 @@ String serialize(HeaderVersion version) {\n      * @param text carries {@link #traceSegmentId} and {@link #spanId}, with '|' split.\n      */\n     ContextCarrier deserialize(String text, HeaderVersion version) {\n-        if (text != null) {\n-            // if this carrier is initialized by v1 or v2, don't do deserialize again for performance.\n-            if (this.isValid(HeaderVersion.v1) || this.isValid(HeaderVersion.v2)) {\n-                return this;\n-            }\n-            if (HeaderVersion.v1.equals(version)) {\n-                String[] parts = text.split(\"\\\\|\", 8);\n-                if (parts.length == 8) {\n-                    try {\n-                        this.traceSegmentId = new ID(parts[0]);\n-                        this.spanId = Integer.parseInt(parts[1]);\n-                        this.parentServiceInstanceId = Integer.parseInt(parts[2]);\n-                        this.entryServiceInstanceId = Integer.parseInt(parts[3]);\n-                        this.peerHost = parts[4];\n-                        this.entryEndpointName = parts[5];\n-                        this.parentEndpointName = parts[6];\n-                        this.primaryDistributedTraceId = new PropagatedTraceId(parts[7]);\n-                    } catch (NumberFormatException e) {\n-\n-                    }\n-                }\n-            } else if (HeaderVersion.v2.equals(version)) {\n-                String[] parts = text.split(\"\\\\-\", 9);\n-                if (parts.length == 9) {\n-                    try {\n-                        // parts[0] is sample flag, always trace if header exists.\n-                        this.primaryDistributedTraceId = new PropagatedTraceId(Base64.decode2UTFString(parts[1]));\n-                        this.traceSegmentId = new ID(Base64.decode2UTFString(parts[2]));\n-                        this.spanId = Integer.parseInt(parts[3]);\n-                        this.parentServiceInstanceId = Integer.parseInt(parts[4]);\n-                        this.entryServiceInstanceId = Integer.parseInt(parts[5]);\n-                        this.peerHost = Base64.decode2UTFString(parts[6]);\n-                        this.entryEndpointName = Base64.decode2UTFString(parts[7]);\n-                        this.parentEndpointName = Base64.decode2UTFString(parts[8]);\n-                    } catch (NumberFormatException e) {\n-\n-                    }\n+        if (text == null) {\n+            return this;\n+        }\n+        // if this carrier is initialized by v2, don't do deserialize again for performance.\n+        if (this.isValid(HeaderVersion.v2)) {\n+            return this;\n+        }\n+        if (HeaderVersion.v2 == version) {\n+            String[] parts = text.split(\"-\", 9);\n+            if (parts.length == 9) {\n+                try {\n+                    // parts[0] is sample flag, always trace if header exists.\n+                    this.primaryDistributedTraceId = new PropagatedTraceId(Base64.decode2UTFString(parts[1]));\n+                    this.traceSegmentId = new ID(Base64.decode2UTFString(parts[2]));\n+                    this.spanId = Integer.parseInt(parts[3]);\n+                    this.parentServiceInstanceId = Integer.parseInt(parts[4]);\n+                    this.entryServiceInstanceId = Integer.parseInt(parts[5]);\n+                    this.peerHost = Base64.decode2UTFString(parts[6]);\n+                    this.entryEndpointName = Base64.decode2UTFString(parts[7]);\n+                    this.parentEndpointName = Base64.decode2UTFString(parts[8]);\n+                } catch (NumberFormatException ignored) {\n+\n                 }\n-            } else {\n-                throw new IllegalArgumentException(\"Unimplemented header version.\" + version);\n             }\n         }\n-        return this;\n+        throw new IllegalArgumentException(\"Unimplemented header version.\" + version);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyOTY3OA==", "bodyText": "Same here.", "url": "https://github.com/apache/skywalking/pull/4307#discussion_r373829678", "createdAt": "2020-02-02T08:49:18Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/ContextCarrier.java", "diffHunk": "@@ -163,27 +141,16 @@ public boolean isValid() {\n      * @return true for unbroken {@link ContextCarrier} or no-initialized. Otherwise, false;\n      */\n     boolean isValid(HeaderVersion version) {\n-        if (HeaderVersion.v1.equals(version)) {\n-            return traceSegmentId != null\n-                && traceSegmentId.isValid()\n-                && getSpanId() > -1\n-                && parentServiceInstanceId != DictionaryUtil.nullValue()\n-                && entryServiceInstanceId != DictionaryUtil.nullValue()\n-                && !StringUtil.isEmpty(peerHost)\n-                && !StringUtil.isEmpty(entryEndpointName)\n-                && !StringUtil.isEmpty(parentEndpointName)\n-                && primaryDistributedTraceId != null;\n-        } else if (HeaderVersion.v2.equals(version)) {\n+        if (HeaderVersion.v2 == version) {\n             return traceSegmentId != null\n                 && traceSegmentId.isValid()\n                 && getSpanId() > -1\n                 && parentServiceInstanceId != DictionaryUtil.nullValue()\n                 && entryServiceInstanceId != DictionaryUtil.nullValue()\n                 && !StringUtil.isEmpty(peerHost)\n                 && primaryDistributedTraceId != null;\n-        } else {\n-            throw new IllegalArgumentException(\"Unimplemented header version.\" + version);\n         }\n+        throw new IllegalArgumentException(\"Unimplemented header version.\" + version);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 133}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "062d260837b0aa6e6c2afbe82251a937ebb55fc0", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/062d260837b0aa6e6c2afbe82251a937ebb55fc0", "committedDate": "2020-02-02T09:05:32Z", "message": "Clean up legacy v1 header logic, use built-in Base64 since JDK8\n\n### Motivation:\n\nCodes clean up\n\n### Modifications:\n\n- Remove v1 header, follow up #4244\n\n- Use built-in Base64 class (since JDK8)\n\n### Result:\n\n- No more legacy v1 headers\n\n- No unnecessary codes concerns by using built-in ability"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTI4NjA4", "url": "https://github.com/apache/skywalking/pull/4307#pullrequestreview-351928608", "createdAt": "2020-02-02T09:08:08Z", "commit": {"oid": "062d260837b0aa6e6c2afbe82251a937ebb55fc0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2628, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}