{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzNTkyNTY0", "number": 4745, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNTo0NDoxM1rOD5dnig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNjo0MzoxNlrOD5sCFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNTgwNjgyOnYy", "diffSide": "RIGHT", "path": "oap-server/server-receiver-plugin/skywalking-trace-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/trace/provider/handler/v8/rest/TraceSegmentReportListJsonServletHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNTo0NDoxM1rOGQvnqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNTo0NDoxM1rOGQvnqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDIxMDYwMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return \"/v3/segmentList\";\n          \n          \n            \n                    return \"/v3/segments.json\";", "url": "https://github.com/apache/skywalking/pull/4745#discussion_r420210602", "createdAt": "2020-05-05T15:44:13Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-receiver-plugin/skywalking-trace-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/trace/provider/handler/v8/rest/TraceSegmentReportListJsonServletHandler.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.trace.provider.handler.v8.rest;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import org.apache.skywalking.apm.network.language.agent.v3.SegmentObject;\n+import org.apache.skywalking.oap.server.library.module.ModuleManager;\n+import org.apache.skywalking.oap.server.library.util.ProtoBufJsonUtils;\n+import org.apache.skywalking.oap.server.receiver.trace.provider.TraceServiceModuleConfig;\n+import org.apache.skywalking.oap.server.receiver.trace.provider.parser.SegmentParserListenerManager;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Parsing segments from list json\n+ */\n+public class TraceSegmentReportListJsonServletHandler extends TraceSegmentReportBaseServletHandler {\n+\n+    private final Gson gson = new Gson();\n+\n+    public TraceSegmentReportListJsonServletHandler(ModuleManager moduleManager, SegmentParserListenerManager listenerManager, TraceServiceModuleConfig config) {\n+        super(moduleManager, listenerManager, config);\n+    }\n+\n+    @Override\n+    protected List<SegmentObject> parseSegments(HttpServletRequest request) throws IOException {\n+        BufferedReader reader = request.getReader();\n+        String line;\n+        StringBuilder stringBuilder = new StringBuilder();\n+        while ((line = reader.readLine()) != null) {\n+            stringBuilder.append(line);\n+        }\n+\n+        final JsonArray array = gson.fromJson(stringBuilder.toString(), JsonArray.class);\n+        if (array.size() == 0) {\n+            return Collections.emptyList();\n+        }\n+\n+        final ArrayList<SegmentObject> segments = new ArrayList<>(array.size());\n+        for (JsonElement element : array) {\n+            SegmentObject.Builder upstreamSegmentBuilder = SegmentObject.newBuilder();\n+            ProtoBufJsonUtils.fromJSON(element.toString(), upstreamSegmentBuilder);\n+            segments.add(upstreamSegmentBuilder.build());\n+        }\n+        return segments;\n+    }\n+\n+    @Override\n+    public String pathSpec() {\n+        return \"/v3/segmentList\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cae6b57b7505bc68b893af8930d4e8bf696e7d4"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNTgwODEwOnYy", "diffSide": "RIGHT", "path": "oap-server/server-receiver-plugin/skywalking-trace-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/trace/provider/handler/v8/rest/TraceSegmentReportMultipleLineServletHandler.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNTo0NDozMFrOGQvocw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwMDowNTozMFrOGQ_9sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDIxMDgwMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return \"/v3/segments\";\n          \n          \n            \n                    return \"/v3/segments.jsonl\";", "url": "https://github.com/apache/skywalking/pull/4745#discussion_r420210803", "createdAt": "2020-05-05T15:44:30Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-receiver-plugin/skywalking-trace-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/trace/provider/handler/v8/rest/TraceSegmentReportMultipleLineServletHandler.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.trace.provider.handler.v8.rest;\n+\n+import org.apache.skywalking.apm.network.language.agent.v3.SegmentObject;\n+import org.apache.skywalking.oap.server.library.module.ModuleManager;\n+import org.apache.skywalking.oap.server.library.util.ProtoBufJsonUtils;\n+import org.apache.skywalking.oap.server.receiver.trace.provider.TraceServiceModuleConfig;\n+import org.apache.skywalking.oap.server.receiver.trace.provider.parser.SegmentParserListenerManager;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Parsing segments from multiple lines\n+ */\n+public class TraceSegmentReportMultipleLineServletHandler extends TraceSegmentReportBaseServletHandler {\n+\n+    public TraceSegmentReportMultipleLineServletHandler(ModuleManager moduleManager, SegmentParserListenerManager listenerManager, TraceServiceModuleConfig config) {\n+        super(moduleManager, listenerManager, config);\n+    }\n+\n+    @Override\n+    protected List<SegmentObject> parseSegments(HttpServletRequest req) throws IOException {\n+        final List<SegmentObject> segments = new ArrayList<>();\n+        BufferedReader reader = req.getReader();\n+        String line;\n+        while ((line = reader.readLine()) != null) {\n+            SegmentObject.Builder upstreamSegmentBuilder = SegmentObject.newBuilder();\n+            ProtoBufJsonUtils.fromJSON(line, upstreamSegmentBuilder);\n+            segments.add(upstreamSegmentBuilder.build());\n+        }\n+\n+        return segments;\n+    }\n+\n+    @Override\n+    public String pathSpec() {\n+        return \"/v3/segments\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cae6b57b7505bc68b893af8930d4e8bf696e7d4"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3NzI0Ng==", "bodyText": "@kezhenxu94 This will break the e2e, LUA agent, and test tool.", "url": "https://github.com/apache/skywalking/pull/4745#discussion_r420477246", "createdAt": "2020-05-06T00:01:36Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-receiver-plugin/skywalking-trace-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/trace/provider/handler/v8/rest/TraceSegmentReportMultipleLineServletHandler.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.trace.provider.handler.v8.rest;\n+\n+import org.apache.skywalking.apm.network.language.agent.v3.SegmentObject;\n+import org.apache.skywalking.oap.server.library.module.ModuleManager;\n+import org.apache.skywalking.oap.server.library.util.ProtoBufJsonUtils;\n+import org.apache.skywalking.oap.server.receiver.trace.provider.TraceServiceModuleConfig;\n+import org.apache.skywalking.oap.server.receiver.trace.provider.parser.SegmentParserListenerManager;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Parsing segments from multiple lines\n+ */\n+public class TraceSegmentReportMultipleLineServletHandler extends TraceSegmentReportBaseServletHandler {\n+\n+    public TraceSegmentReportMultipleLineServletHandler(ModuleManager moduleManager, SegmentParserListenerManager listenerManager, TraceServiceModuleConfig config) {\n+        super(moduleManager, listenerManager, config);\n+    }\n+\n+    @Override\n+    protected List<SegmentObject> parseSegments(HttpServletRequest req) throws IOException {\n+        final List<SegmentObject> segments = new ArrayList<>();\n+        BufferedReader reader = req.getReader();\n+        String line;\n+        while ((line = reader.readLine()) != null) {\n+            SegmentObject.Builder upstreamSegmentBuilder = SegmentObject.newBuilder();\n+            ProtoBufJsonUtils.fromJSON(line, upstreamSegmentBuilder);\n+            segments.add(upstreamSegmentBuilder.build());\n+        }\n+\n+        return segments;\n+    }\n+\n+    @Override\n+    public String pathSpec() {\n+        return \"/v3/segments\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDIxMDgwMw=="}, "originalCommit": {"oid": "6cae6b57b7505bc68b893af8930d4e8bf696e7d4"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3ODM4Nw==", "bodyText": "If we really hope to break the endpoint, consider using /segment and /segments, which could represent better. But before the change, need to update the test tool and LUA agent, then back to this PR.", "url": "https://github.com/apache/skywalking/pull/4745#discussion_r420478387", "createdAt": "2020-05-06T00:05:30Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-receiver-plugin/skywalking-trace-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/trace/provider/handler/v8/rest/TraceSegmentReportMultipleLineServletHandler.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.trace.provider.handler.v8.rest;\n+\n+import org.apache.skywalking.apm.network.language.agent.v3.SegmentObject;\n+import org.apache.skywalking.oap.server.library.module.ModuleManager;\n+import org.apache.skywalking.oap.server.library.util.ProtoBufJsonUtils;\n+import org.apache.skywalking.oap.server.receiver.trace.provider.TraceServiceModuleConfig;\n+import org.apache.skywalking.oap.server.receiver.trace.provider.parser.SegmentParserListenerManager;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Parsing segments from multiple lines\n+ */\n+public class TraceSegmentReportMultipleLineServletHandler extends TraceSegmentReportBaseServletHandler {\n+\n+    public TraceSegmentReportMultipleLineServletHandler(ModuleManager moduleManager, SegmentParserListenerManager listenerManager, TraceServiceModuleConfig config) {\n+        super(moduleManager, listenerManager, config);\n+    }\n+\n+    @Override\n+    protected List<SegmentObject> parseSegments(HttpServletRequest req) throws IOException {\n+        final List<SegmentObject> segments = new ArrayList<>();\n+        BufferedReader reader = req.getReader();\n+        String line;\n+        while ((line = reader.readLine()) != null) {\n+            SegmentObject.Builder upstreamSegmentBuilder = SegmentObject.newBuilder();\n+            ProtoBufJsonUtils.fromJSON(line, upstreamSegmentBuilder);\n+            segments.add(upstreamSegmentBuilder.build());\n+        }\n+\n+        return segments;\n+    }\n+\n+    @Override\n+    public String pathSpec() {\n+        return \"/v3/segments\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDIxMDgwMw=="}, "originalCommit": {"oid": "6cae6b57b7505bc68b893af8930d4e8bf696e7d4"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNzQ5NjQzOnYy", "diffSide": "RIGHT", "path": "oap-server/server-receiver-plugin/skywalking-trace-receiver-plugin/src/test/java/org/apache/skywalking/oap/server/receiver/trace/provider/handler/v8/rest/TraceSegmentReportServletHandlerTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwMDowMzowMFrOGQ_6wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwMTo0NzoyNFrOGRBiGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3NzYzMw==", "bodyText": "I don't think this is a good example. This is not an official format in JSON.", "url": "https://github.com/apache/skywalking/pull/4745#discussion_r420477633", "createdAt": "2020-05-06T00:03:00Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-receiver-plugin/skywalking-trace-receiver-plugin/src/test/java/org/apache/skywalking/oap/server/receiver/trace/provider/handler/v8/rest/TraceSegmentReportServletHandlerTest.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.trace.provider.handler.v8.rest;\n+\n+import org.apache.skywalking.apm.network.language.agent.v3.SegmentObject;\n+import org.apache.skywalking.oap.server.library.module.ModuleManager;\n+import org.apache.skywalking.oap.server.telemetry.TelemetryModule;\n+import org.apache.skywalking.oap.server.telemetry.api.MetricsCreator;\n+import org.apache.skywalking.oap.server.telemetry.none.MetricsCreatorNoop;\n+import org.apache.skywalking.oap.server.telemetry.none.NoneTelemetryProvider;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.internal.util.reflection.Whitebox;\n+import org.powermock.core.classloader.annotations.PowerMockIgnore;\n+import org.powermock.modules.junit4.PowerMockRunner;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.StringReader;\n+import java.util.List;\n+\n+import static org.mockito.Mockito.when;\n+\n+@RunWith(PowerMockRunner.class)\n+@PowerMockIgnore({\"javax.management.*\"})\n+public class TraceSegmentReportServletHandlerTest {\n+\n+    @Mock\n+    private HttpServletRequest request;\n+    @Mock\n+    private ModuleManager moduleManager;\n+    @Mock\n+    private NoneTelemetryProvider telemetryProvider;\n+\n+    @Before\n+    public void init() throws IOException {\n+        TelemetryModule telemetryModule = Mockito.spy(TelemetryModule.class);\n+        Whitebox.setInternalState(telemetryModule, \"loadedProvider\", telemetryProvider);\n+        Mockito.when(moduleManager.find(TelemetryModule.NAME)).thenReturn(telemetryModule);\n+\n+        Mockito.when(telemetryProvider.getService(MetricsCreator.class))\n+            .thenReturn(new MetricsCreatorNoop());\n+    }\n+\n+    @Test\n+    public void testSingle() throws IOException {\n+        String singleJson = \"{\" +\n+            \"   \\\"traceId\\\":\\\"c480c738-b628-490d-ace7-69f7030d77cb\\\",\" +\n+            \"   \\\"spans\\\":[\" +\n+            \"       {\\\"operationName\\\":\\\"\\\\/ingress\\\"}\" +\n+            \"   ]\" +\n+            \"}\";\n+\n+        final TraceSegmentReportSingleServletHandler singleServletHandler =\n+            new TraceSegmentReportSingleServletHandler(moduleManager, null, null);\n+\n+        when(request.getReader()).thenReturn(new BufferedReader(new StringReader(singleJson)));\n+        final List<SegmentObject> segmentObjects = singleServletHandler.parseSegments(request);\n+        Assert.assertEquals(segmentObjects.size(), 1);\n+    }\n+\n+    @Test\n+    public void testMultipleLine() throws IOException {\n+        String multipleLineJson = \"{\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cae6b57b7505bc68b893af8930d4e8bf696e7d4"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3NzcyOA==", "bodyText": "And isn't better than the official JSON list way.", "url": "https://github.com/apache/skywalking/pull/4745#discussion_r420477728", "createdAt": "2020-05-06T00:03:23Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-receiver-plugin/skywalking-trace-receiver-plugin/src/test/java/org/apache/skywalking/oap/server/receiver/trace/provider/handler/v8/rest/TraceSegmentReportServletHandlerTest.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.trace.provider.handler.v8.rest;\n+\n+import org.apache.skywalking.apm.network.language.agent.v3.SegmentObject;\n+import org.apache.skywalking.oap.server.library.module.ModuleManager;\n+import org.apache.skywalking.oap.server.telemetry.TelemetryModule;\n+import org.apache.skywalking.oap.server.telemetry.api.MetricsCreator;\n+import org.apache.skywalking.oap.server.telemetry.none.MetricsCreatorNoop;\n+import org.apache.skywalking.oap.server.telemetry.none.NoneTelemetryProvider;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.internal.util.reflection.Whitebox;\n+import org.powermock.core.classloader.annotations.PowerMockIgnore;\n+import org.powermock.modules.junit4.PowerMockRunner;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.StringReader;\n+import java.util.List;\n+\n+import static org.mockito.Mockito.when;\n+\n+@RunWith(PowerMockRunner.class)\n+@PowerMockIgnore({\"javax.management.*\"})\n+public class TraceSegmentReportServletHandlerTest {\n+\n+    @Mock\n+    private HttpServletRequest request;\n+    @Mock\n+    private ModuleManager moduleManager;\n+    @Mock\n+    private NoneTelemetryProvider telemetryProvider;\n+\n+    @Before\n+    public void init() throws IOException {\n+        TelemetryModule telemetryModule = Mockito.spy(TelemetryModule.class);\n+        Whitebox.setInternalState(telemetryModule, \"loadedProvider\", telemetryProvider);\n+        Mockito.when(moduleManager.find(TelemetryModule.NAME)).thenReturn(telemetryModule);\n+\n+        Mockito.when(telemetryProvider.getService(MetricsCreator.class))\n+            .thenReturn(new MetricsCreatorNoop());\n+    }\n+\n+    @Test\n+    public void testSingle() throws IOException {\n+        String singleJson = \"{\" +\n+            \"   \\\"traceId\\\":\\\"c480c738-b628-490d-ace7-69f7030d77cb\\\",\" +\n+            \"   \\\"spans\\\":[\" +\n+            \"       {\\\"operationName\\\":\\\"\\\\/ingress\\\"}\" +\n+            \"   ]\" +\n+            \"}\";\n+\n+        final TraceSegmentReportSingleServletHandler singleServletHandler =\n+            new TraceSegmentReportSingleServletHandler(moduleManager, null, null);\n+\n+        when(request.getReader()).thenReturn(new BufferedReader(new StringReader(singleJson)));\n+        final List<SegmentObject> segmentObjects = singleServletHandler.parseSegments(request);\n+        Assert.assertEquals(segmentObjects.size(), 1);\n+    }\n+\n+    @Test\n+    public void testMultipleLine() throws IOException {\n+        String multipleLineJson = \"{\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3NzYzMw=="}, "originalCommit": {"oid": "6cae6b57b7505bc68b893af8930d4e8bf696e7d4"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDA5MA==", "bodyText": "It adapts to the current LUA agent. Should I need to fix the LUA first? let the LUA agent using the JSON object or JSON list.", "url": "https://github.com/apache/skywalking/pull/4745#discussion_r420504090", "createdAt": "2020-05-06T01:47:24Z", "author": {"login": "mrproliu"}, "path": "oap-server/server-receiver-plugin/skywalking-trace-receiver-plugin/src/test/java/org/apache/skywalking/oap/server/receiver/trace/provider/handler/v8/rest/TraceSegmentReportServletHandlerTest.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.trace.provider.handler.v8.rest;\n+\n+import org.apache.skywalking.apm.network.language.agent.v3.SegmentObject;\n+import org.apache.skywalking.oap.server.library.module.ModuleManager;\n+import org.apache.skywalking.oap.server.telemetry.TelemetryModule;\n+import org.apache.skywalking.oap.server.telemetry.api.MetricsCreator;\n+import org.apache.skywalking.oap.server.telemetry.none.MetricsCreatorNoop;\n+import org.apache.skywalking.oap.server.telemetry.none.NoneTelemetryProvider;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.internal.util.reflection.Whitebox;\n+import org.powermock.core.classloader.annotations.PowerMockIgnore;\n+import org.powermock.modules.junit4.PowerMockRunner;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.StringReader;\n+import java.util.List;\n+\n+import static org.mockito.Mockito.when;\n+\n+@RunWith(PowerMockRunner.class)\n+@PowerMockIgnore({\"javax.management.*\"})\n+public class TraceSegmentReportServletHandlerTest {\n+\n+    @Mock\n+    private HttpServletRequest request;\n+    @Mock\n+    private ModuleManager moduleManager;\n+    @Mock\n+    private NoneTelemetryProvider telemetryProvider;\n+\n+    @Before\n+    public void init() throws IOException {\n+        TelemetryModule telemetryModule = Mockito.spy(TelemetryModule.class);\n+        Whitebox.setInternalState(telemetryModule, \"loadedProvider\", telemetryProvider);\n+        Mockito.when(moduleManager.find(TelemetryModule.NAME)).thenReturn(telemetryModule);\n+\n+        Mockito.when(telemetryProvider.getService(MetricsCreator.class))\n+            .thenReturn(new MetricsCreatorNoop());\n+    }\n+\n+    @Test\n+    public void testSingle() throws IOException {\n+        String singleJson = \"{\" +\n+            \"   \\\"traceId\\\":\\\"c480c738-b628-490d-ace7-69f7030d77cb\\\",\" +\n+            \"   \\\"spans\\\":[\" +\n+            \"       {\\\"operationName\\\":\\\"\\\\/ingress\\\"}\" +\n+            \"   ]\" +\n+            \"}\";\n+\n+        final TraceSegmentReportSingleServletHandler singleServletHandler =\n+            new TraceSegmentReportSingleServletHandler(moduleManager, null, null);\n+\n+        when(request.getReader()).thenReturn(new BufferedReader(new StringReader(singleJson)));\n+        final List<SegmentObject> segmentObjects = singleServletHandler.parseSegments(request);\n+        Assert.assertEquals(segmentObjects.size(), 1);\n+    }\n+\n+    @Test\n+    public void testMultipleLine() throws IOException {\n+        String multipleLineJson = \"{\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3NzYzMw=="}, "originalCommit": {"oid": "6cae6b57b7505bc68b893af8930d4e8bf696e7d4"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxODE2NTkyOnYy", "diffSide": "RIGHT", "path": "docs/en/protocols/HTTP-API-Protocol.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNjo0MjowNlrOGRF09w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNjo0MjowNlrOGRF09w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU3NDQ1NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            - Report service instance\n          \n          \n            \n            - Report service instance properties", "url": "https://github.com/apache/skywalking/pull/4745#discussion_r420574455", "createdAt": "2020-05-06T06:42:06Z", "author": {"login": "wu-sheng"}, "path": "docs/en/protocols/HTTP-API-Protocol.md", "diffHunk": "@@ -1,6 +1,186 @@\n # HTTP API Protocol\n \n HTTP API Protocol defines the API data format, including api request and response data format.\n+They use the HTTP1.1 wrapper of the official [SkyWalking Trace Data Protocol v3](Trace-Data-Protocol-v3.md). Read it for more details.\n \n-HTTP APIs are the HTTP1.1 wrapper of the official [SkyWalking Trace Data Protocol v3](Trace-Data-Protocol-v3.md). Read it for more details.\n+## Instance Management\n \n+Detail information about data format can be found in [Instance Management](https://github.com/apache/skywalking-data-collect-protocol/blob/master/management/Management.proto).\n+\n+- Report service instance", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "807361f55357e2edc5d4e8dff912dd8e18cd6e49"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxODE2ODU1OnYy", "diffSide": "RIGHT", "path": "docs/en/protocols/HTTP-API-Protocol.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNjo0MzoxNlrOGRF2pA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNjo0MzoxNlrOGRF2pA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU3NDg4NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            There has two way to report segment data.\n          \n          \n            \n            There are two ways to report segment data, one segment per request or segment array in the bulk mode.", "url": "https://github.com/apache/skywalking/pull/4745#discussion_r420574884", "createdAt": "2020-05-06T06:43:16Z", "author": {"login": "wu-sheng"}, "path": "docs/en/protocols/HTTP-API-Protocol.md", "diffHunk": "@@ -1,6 +1,186 @@\n # HTTP API Protocol\n \n HTTP API Protocol defines the API data format, including api request and response data format.\n+They use the HTTP1.1 wrapper of the official [SkyWalking Trace Data Protocol v3](Trace-Data-Protocol-v3.md). Read it for more details.\n \n-HTTP APIs are the HTTP1.1 wrapper of the official [SkyWalking Trace Data Protocol v3](Trace-Data-Protocol-v3.md). Read it for more details.\n+## Instance Management\n \n+Detail information about data format can be found in [Instance Management](https://github.com/apache/skywalking-data-collect-protocol/blob/master/management/Management.proto).\n+\n+- Report service instance\n+\n+> POST http://localhost:12800/v3/management/reportProperties\n+\n+Input:\n+\n+```json\n+{\n+\t\"service\": \"User Service Name\",\n+\t\"serviceInstance\": \"User Service Instance Name\",\n+\t\"properties\": [{\n+\t\t\"language\": \"Lua\"\n+\t}]\n+}\n+```\n+\n+Output JSON Array:\n+\n+```json\n+{}\n+```\n+\n+- Service instance ping\n+\n+> POST http://localhost:12800/v3/management/keepAlive\n+\n+Input:\n+\n+```json\n+{\n+\t\"service\": \"User Service Name\",\n+\t\"serviceInstance\": \"User Service Instance Name\"\n+}\n+```\n+\n+OutPut:\n+\n+```json\n+{}\n+```\n+\n+## Trace Report\n+\n+Detail information about data format can be found in [Instance Management](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Tracing.proto).\n+There has two way to report segment data.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "807361f55357e2edc5d4e8dff912dd8e18cd6e49"}, "originalPosition": 55}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 293, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}