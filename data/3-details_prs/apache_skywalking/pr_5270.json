{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MDM2NDI1", "number": 5270, "title": "[IMPORTANT] Query traces with tags as condition", "bodyText": "Since the beginning of SkyWalking, we have concerns of using tags as trace query conditions, but this requirement keeps showing up. In this pull request, I implement this feature in ElasticSearch 6/7 and H2/MySQL/TiDB storages. InfluxDB will be implemented by @dmsolr later.\nThe latest trace query GraphQL, https://github.com/apache/skywalking-query-protocol/blob/master/trace.graphqls#L50\nUI and CLI could use multiple tags(key=value) to filter the traces with all other conditions. The example of new query looks like this\n{\n  queryBasicTraces(condition : {\n    traceState: ALL,\n    queryOrder: BY_START_TIME,\n    queryDuration : {\n      step:MINUTE, start: \"2020-08-08 2200\", end: \"2020-08-08 2300\"\n    },\n    paging: {\n      pageNum: 0,\n      pageSize: 50,\n      needTotal: false\n    },\n    # Duplicate keys are allowed, because one segment includes multiple spans, those spans could have different tag values\n    tags: [{\n      key: \"status_code\"\n      value: \"404\"\n    },{\n      key: \"status_code\"\n      value: \"200\"\n    }]\n  }\n  ) {\n    total,\n    traces {\n      segmentId,\n      endpointNames,\n      duration,\n      traceIds\n    }\n  }\n}", "createdAt": "2020-08-08T14:20:21Z", "url": "https://github.com/apache/skywalking/pull/5270", "merged": true, "mergeCommit": {"oid": "7f7e96b088d3cb0a19f8ddeafe5ede9764ec2eda"}, "closed": true, "closedAt": "2020-08-10T23:24:41Z", "author": {"login": "wu-sheng"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8hgVBgH2gAyNDY1MDM2NDI1OmQ5ZDc4MWNlMjY3Y2YzZjYyY2Y1NTUxN2ZmZmJiOWYxNzRiMGI3MGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9kKHxAFqTQ2NDM1MTgzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d9d781ce267cf3f62cf55517fffbb9f174b0b70e", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/d9d781ce267cf3f62cf55517fffbb9f174b0b70e", "committedDate": "2020-08-07T10:03:43Z", "message": "Support tag-based query in ES 6/7"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2e3961ab987fdaeb4c272aeb14a5e3d117c153e", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/f2e3961ab987fdaeb4c272aeb14a5e3d117c153e", "committedDate": "2020-08-07T16:06:44Z", "message": "Try to support H2/MySQL case for tags."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20e27ee90d4e3a7bdeeb37c9ccda22bef17da877", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/20e27ee90d4e3a7bdeeb37c9ccda22bef17da877", "committedDate": "2020-08-08T14:14:22Z", "message": "Support trace query by using tag as conditions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f24e6a0ef9ac38591ea2470bf72e48660ed3f876", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/f24e6a0ef9ac38591ea2470bf72e48660ed3f876", "committedDate": "2020-08-08T14:14:53Z", "message": "Merge commit '9b6a4ed28ce957238851cb0a504ff8ad3c74e59b' into tag-query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06c2620dbc0bb50ce4fabbe658ef194a6c520281", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/06c2620dbc0bb50ce4fabbe658ef194a6c520281", "committedDate": "2020-08-08T14:20:43Z", "message": "Fix format."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bfe9dbff1989953e76f33744c5fba90998db150", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/3bfe9dbff1989953e76f33744c5fba90998db150", "committedDate": "2020-08-08T15:13:07Z", "message": "Add checks for the new configurations, and make some extra available slots for new tags, but still will fail if the user doesn't notice the document, and reach the boundary."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "633150b3833ca116acc131f6c7caeb46c5b56d63", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/633150b3833ca116acc131f6c7caeb46c5b56d63", "committedDate": "2020-08-08T15:43:55Z", "message": "Merge branch 'master' into tag-query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1c91c7764ac98ae3c55caf1677b84d2a517895f", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/e1c91c7764ac98ae3c55caf1677b84d2a517895f", "committedDate": "2020-08-09T08:45:23Z", "message": "Merge branch 'master' into tag-query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzODY2MzMw", "url": "https://github.com/apache/skywalking/pull/5270#pullrequestreview-463866330", "createdAt": "2020-08-09T11:31:55Z", "commit": {"oid": "e1c91c7764ac98ae3c55caf1677b84d2a517895f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d41801b56e7daaee00416c67166fb2947d865391", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/d41801b56e7daaee00416c67166fb2947d865391", "committedDate": "2020-08-09T18:26:00Z", "message": "influxdb implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f1f68daa40076e6f6e4025d01da33803aef4531", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/6f1f68daa40076e6f6e4025d01da33803aef4531", "committedDate": "2020-08-09T23:36:37Z", "message": "Merge branch 'master' into tag-query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzOTE3MDQ4", "url": "https://github.com/apache/skywalking/pull/5270#pullrequestreview-463917048", "createdAt": "2020-08-10T00:13:23Z", "commit": {"oid": "d41801b56e7daaee00416c67166fb2947d865391"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwMDoxMzoyNFrOG9-47A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwMDoxMzoyNFrOG9-47A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY0NjcwMA==", "bodyText": "Tag keys could be duplicated as it is in the different spans, what will happen here?", "url": "https://github.com/apache/skywalking/pull/5270#discussion_r467646700", "createdAt": "2020-08-10T00:13:24Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/InfluxInsertRequest.java", "diffHunk": "@@ -68,6 +71,15 @@ public InfluxInsertRequest addFieldAsTag(String fieldName, String tagName) {\n         return this;\n     }\n \n+    public InfluxInsertRequest tags(List<SpanTag> tags) {\n+        if (!Objects.isNull(tags) && !tags.isEmpty()) {\n+            for (final SpanTag tag : tags) {\n+                builder.addField(tag.getKey(), tag.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d41801b56e7daaee00416c67166fb2947d865391"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9297ad3bbb71d12e13a02b1c98be05e3938ea6e5", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/9297ad3bbb71d12e13a02b1c98be05e3938ea6e5", "committedDate": "2020-08-10T03:52:35Z", "message": "support multi-value"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35ee7bcce977ee08af72fdbac4e390dd68074496", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/35ee7bcce977ee08af72fdbac4e390dd68074496", "committedDate": "2020-08-10T04:15:28Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "527ce68a27f9dcee3e225c45b4b7b37d6e2b78c1", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/527ce68a27f9dcee3e225c45b4b7b37d6e2b78c1", "committedDate": "2020-08-10T06:53:49Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6c7c18a9b34f890495e5d2b7264ff28cd2840fe", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/d6c7c18a9b34f890495e5d2b7264ff28cd2840fe", "committedDate": "2020-08-10T07:20:45Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b44bc4fa1bf55400579b5209c2308a8c05c06f8", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/4b44bc4fa1bf55400579b5209c2308a8c05c06f8", "committedDate": "2020-08-10T07:59:17Z", "message": "fixg"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MDQ0OTY4", "url": "https://github.com/apache/skywalking/pull/5270#pullrequestreview-464044968", "createdAt": "2020-08-10T08:36:06Z", "commit": {"oid": "4b44bc4fa1bf55400579b5209c2308a8c05c06f8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODozNjowN1rOG-Fylg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODozNjo0MFrOG-FzgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1OTc2Ng==", "bodyText": "This should be replaced by CollectionUtil#isNotEmpty.", "url": "https://github.com/apache/skywalking/pull/5270#discussion_r467759766", "createdAt": "2020-08-10T08:36:07Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/query/TraceQuery.java", "diffHunk": "@@ -121,6 +125,13 @@ public TraceBrief queryBasicTraces(long startSecondTB,\n                 recallQuery.and(eq(SegmentRecord.IS_ERROR, BooleanUtils.FALSE));\n                 break;\n         }\n+        if (Objects.nonNull(tags) && !tags.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b44bc4fa1bf55400579b5209c2308a8c05c06f8"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1OTkwMQ==", "bodyText": "This should be and. All tags in the conditions should be matched.", "url": "https://github.com/apache/skywalking/pull/5270#discussion_r467759901", "createdAt": "2020-08-10T08:36:26Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/query/TraceQuery.java", "diffHunk": "@@ -121,6 +125,13 @@ public TraceBrief queryBasicTraces(long startSecondTB,\n                 recallQuery.and(eq(SegmentRecord.IS_ERROR, BooleanUtils.FALSE));\n                 break;\n         }\n+        if (Objects.nonNull(tags) && !tags.isEmpty()) {\n+            WhereNested<WhereQueryImpl<SelectQueryImpl>> nested = recallQuery.andNested();\n+            for (final SpanTag tag : tags) {\n+                nested.or(contains(tag.getKey(), tag.getValue()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b44bc4fa1bf55400579b5209c2308a8c05c06f8"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc2MDAwMA==", "bodyText": "Where is the regex match you mentioned?", "url": "https://github.com/apache/skywalking/pull/5270#discussion_r467760000", "createdAt": "2020-08-10T08:36:40Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/query/TraceQuery.java", "diffHunk": "@@ -121,6 +125,13 @@ public TraceBrief queryBasicTraces(long startSecondTB,\n                 recallQuery.and(eq(SegmentRecord.IS_ERROR, BooleanUtils.FALSE));\n                 break;\n         }\n+        if (Objects.nonNull(tags) && !tags.isEmpty()) {\n+            WhereNested<WhereQueryImpl<SelectQueryImpl>> nested = recallQuery.andNested();\n+            for (final SpanTag tag : tags) {\n+                nested.or(contains(tag.getKey(), tag.getValue()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1OTkwMQ=="}, "originalCommit": {"oid": "4b44bc4fa1bf55400579b5209c2308a8c05c06f8"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MDQ1ODU4", "url": "https://github.com/apache/skywalking/pull/5270#pullrequestreview-464045858", "createdAt": "2020-08-10T08:37:45Z", "commit": {"oid": "4b44bc4fa1bf55400579b5209c2308a8c05c06f8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODozNzo0NVrOG-F1Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODozNzo0NVrOG-F1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc2MDQzNQ==", "bodyText": "Local IDE shows, this method is useless.", "url": "https://github.com/apache/skywalking/pull/5270#discussion_r467760435", "createdAt": "2020-08-10T08:37:45Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/base/InfluxInsertRequest.java", "diffHunk": "@@ -68,6 +71,20 @@ public InfluxInsertRequest addFieldAsTag(String fieldName, String tagName) {\n         return this;\n     }\n \n+    public InfluxInsertRequest tags(List<SpanTag> tags) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b44bc4fa1bf55400579b5209c2308a8c05c06f8"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f12e2f83d8d11ac8465331e40b6bf40c6ac8db7", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/5f12e2f83d8d11ac8465331e40b6bf40c6ac8db7", "committedDate": "2020-08-10T10:28:13Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ebcdd38169c24a974d2c66028284a1d102c75e0", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/8ebcdd38169c24a974d2c66028284a1d102c75e0", "committedDate": "2020-08-10T13:07:49Z", "message": "Merge branch 'master' into tag-query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d45ea29c2de43d4d4d25abfa993e7e28e707da4", "author": {"user": {"login": "dmsolr", "name": "Daming"}}, "url": "https://github.com/apache/skywalking/commit/8d45ea29c2de43d4d4d25abfa993e7e28e707da4", "committedDate": "2020-08-10T15:18:03Z", "message": "following review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MzUxMDY2", "url": "https://github.com/apache/skywalking/pull/5270#pullrequestreview-464351066", "createdAt": "2020-08-10T15:42:12Z", "commit": {"oid": "8d45ea29c2de43d4d4d25abfa993e7e28e707da4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MzUxODMy", "url": "https://github.com/apache/skywalking/pull/5270#pullrequestreview-464351832", "createdAt": "2020-08-10T15:43:06Z", "commit": {"oid": "8d45ea29c2de43d4d4d25abfa993e7e28e707da4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1875, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}