{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM3NjQ5MjAw", "number": 5995, "title": "Fix potential gRPC connection leak(not closed) for the channels among OAP instances. ", "bodyText": "If this pull request closes/resolves/fixes an existing issue, replace the issue number. Closes #5993.\n Update the CHANGES log.\n\nFix potential gRPC connection leak(not closed) for the channels among OAP instances. The self client should not close due to this in SelfRemoteClient. I add a filter to avoid this call.\n    @Override\n    public void close() {\n        throw new UnexpectedException(\"Self remote client invoked to close.\");\n    }", "createdAt": "2020-12-12T01:51:28Z", "url": "https://github.com/apache/skywalking/pull/5995", "merged": true, "mergeCommit": {"oid": "f513726fead7543e2b90acea079e6c7b50523c01"}, "closed": true, "closedAt": "2020-12-12T04:35:04Z", "author": {"login": "wu-sheng"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlSiGLAH2gAyNTM3NjQ5MjAwOmM3MDdlNGE0Y2FiYjExYmIwMjJlYTdmNGRlZGZmMzFlYzYxY2M4YWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlT8D_AFqTU1MDY4NTE5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c707e4a4cabb11bb022ea7f4dedff31ec61cc8ac", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/c707e4a4cabb11bb022ea7f4dedff31ec61cc8ac", "committedDate": "2020-12-12T01:47:58Z", "message": "Fix potential gRPC connection leak(not closed) for the channels among OAP instances."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjc3ODYz", "url": "https://github.com/apache/skywalking/pull/5995#pullrequestreview-550677863", "createdAt": "2020-12-12T02:00:38Z", "commit": {"oid": "c707e4a4cabb11bb022ea7f4dedff31ec61cc8ac"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjc5NTU4", "url": "https://github.com/apache/skywalking/pull/5995#pullrequestreview-550679558", "createdAt": "2020-12-12T02:16:00Z", "commit": {"oid": "c707e4a4cabb11bb022ea7f4dedff31ec61cc8ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMjoxNjowMFrOIEZKsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMjoxNjowMFrOIEZKsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ3NzU1Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                          && !remoteClientAction.getRemoteClient().getAddress().isSelf()\n          \n          \n            \n                                                          && \n          \n          \n            \n            remoteClientAction.getRemoteClient() != null\n          \n          \n            \n                                                          &&                                           !remoteClientAction.getRemoteClient().getAddress().isSelf()", "url": "https://github.com/apache/skywalking/pull/5995#discussion_r541477553", "createdAt": "2020-12-12T02:16:00Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/remote/client/RemoteClientManager.java", "diffHunk": "@@ -230,7 +246,10 @@ private void reBuildRemoteClients(List<RemoteInstance> remoteInstances) {\n \n         remoteClientCollection.values()\n                               .stream()\n-                              .filter(remoteClientAction -> remoteClientAction.getAction().equals(Action.Close))\n+                              .filter(remoteClientAction ->\n+                                          remoteClientAction.getAction().equals(Action.Close)\n+                                              && !remoteClientAction.getRemoteClient().getAddress().isSelf()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c707e4a4cabb11bb022ea7f4dedff31ec61cc8ac"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34870014eb3facb09954da00490b1ff3291867d7", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/34870014eb3facb09954da00490b1ff3291867d7", "committedDate": "2020-12-12T02:36:01Z", "message": "Filter OAP instances(unassigned in booting stage) of the empty IP in KubernetesCoordinator."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjgxNTAw", "url": "https://github.com/apache/skywalking/pull/5995#pullrequestreview-550681500", "createdAt": "2020-12-12T02:37:21Z", "commit": {"oid": "34870014eb3facb09954da00490b1ff3291867d7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjg1MTk1", "url": "https://github.com/apache/skywalking/pull/5995#pullrequestreview-550685195", "createdAt": "2020-12-12T03:26:12Z", "commit": {"oid": "34870014eb3facb09954da00490b1ff3291867d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMzoyNjoxMlrOIEZ2zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMzoyNjoxMlrOIEZ2zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ4ODg0NQ==", "bodyText": "NULL_DEREFERENCE:  object returned by pod.getStatus() could be null and is dereferenced at line 78.", "url": "https://github.com/apache/skywalking/pull/5995#discussion_r541488845", "createdAt": "2020-12-12T03:26:12Z", "author": {"login": "sonatype-lift"}, "path": "oap-server/server-cluster-plugin/cluster-kubernetes-plugin/src/main/java/org/apache/skywalking/oap/server/cluster/plugin/kubernetes/KubernetesCoordinator.java", "diffHunk": "@@ -66,23 +65,25 @@ public KubernetesCoordinator(final ModuleDefineHolder manager,\n             List<V1Pod> pods = NamespacedPodListInformer.INFORMER.listPods().orElseGet(this::selfPod);\n             if (log.isDebugEnabled()) {\n                 List<String> uidList = pods\n-                        .stream()\n-                        .map(item -> item.getMetadata().getUid())\n-                        .collect(Collectors.toList());\n+                    .stream()\n+                    .map(item -> item.getMetadata().getUid())\n+                    .collect(Collectors.toList());\n                 log.debug(\"[kubernetes cluster pods uid list]:{}\", uidList.toString());\n             }\n             if (port == -1) {\n                 port = manager.find(CoreModule.NAME).provider().getService(ConfigService.class).getGRPCPort();\n             }\n-            List<RemoteInstance> remoteInstances =  pods.stream()\n+            List<RemoteInstance> remoteInstances =\n+                pods.stream()\n+                    .filter(pod -> StringUtil.isNotBlank(pod.getStatus().getPodIP()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34870014eb3facb09954da00490b1ff3291867d7"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjg1MTk2", "url": "https://github.com/apache/skywalking/pull/5995#pullrequestreview-550685196", "createdAt": "2020-12-12T03:26:13Z", "commit": {"oid": "34870014eb3facb09954da00490b1ff3291867d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMzoyNjoxM1rOIEZ20A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMzoyNjoxM1rOIEZ20A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ4ODg0OA==", "bodyText": "NULL_DEREFERENCE:  object returned by pod.getStatus() could be null and is dereferenced at line 80.", "url": "https://github.com/apache/skywalking/pull/5995#discussion_r541488848", "createdAt": "2020-12-12T03:26:13Z", "author": {"login": "sonatype-lift"}, "path": "oap-server/server-cluster-plugin/cluster-kubernetes-plugin/src/main/java/org/apache/skywalking/oap/server/cluster/plugin/kubernetes/KubernetesCoordinator.java", "diffHunk": "@@ -66,23 +65,25 @@ public KubernetesCoordinator(final ModuleDefineHolder manager,\n             List<V1Pod> pods = NamespacedPodListInformer.INFORMER.listPods().orElseGet(this::selfPod);\n             if (log.isDebugEnabled()) {\n                 List<String> uidList = pods\n-                        .stream()\n-                        .map(item -> item.getMetadata().getUid())\n-                        .collect(Collectors.toList());\n+                    .stream()\n+                    .map(item -> item.getMetadata().getUid())\n+                    .collect(Collectors.toList());\n                 log.debug(\"[kubernetes cluster pods uid list]:{}\", uidList.toString());\n             }\n             if (port == -1) {\n                 port = manager.find(CoreModule.NAME).provider().getService(ConfigService.class).getGRPCPort();\n             }\n-            List<RemoteInstance> remoteInstances =  pods.stream()\n+            List<RemoteInstance> remoteInstances =\n+                pods.stream()\n+                    .filter(pod -> StringUtil.isNotBlank(pod.getStatus().getPodIP()))\n                     .map(pod -> new RemoteInstance(\n-                            new Address(pod.getStatus().getPodIP(), port, pod.getMetadata().getUid().equals(uid))))\n+                        new Address(pod.getStatus().getPodIP(), port, pod.getMetadata().getUid().equals(uid))))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34870014eb3facb09954da00490b1ff3291867d7"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1465, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}