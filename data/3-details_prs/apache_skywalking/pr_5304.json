{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2NjY3ODk4", "number": 5304, "title": "Support @KafkaPollAndInvoke annotation to replace @Trace when just using the Kafka scenario agent plugin", "bodyText": "Please answer these questions before submitting a pull request\n\n\nWhy submit this pull request?\n\n\n Bug fix\n\n\n New feature provided\n\n\n Improve performance\n\n\nRelated issues\n\n\n\nBug fix\n\n\nBug description.\n\n\nHow to fix?\n\n\nFixed #5302", "createdAt": "2020-08-12T10:16:19Z", "url": "https://github.com/apache/skywalking/pull/5304", "merged": true, "mergeCommit": {"oid": "ab5555fe2758eeec6d496df9efb6cf984a6fa09b"}, "closed": true, "closedAt": "2020-08-13T13:18:06Z", "author": {"login": "zhaoyuguang"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-Hu9igH2gAyNDY2NjY3ODk4OjI1ZjgyMWMzOGM0YTYyZTQzYTI5YzI3OWRiNTA4NTFiYjkwZjQ3YzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-f4S6AFqTQ2Njc1MTQ1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "25f821c38c4a62e43a29c279db50851bb90f47c0", "author": {"user": {"login": "zhaoyuguang", "name": "\u4e8e\u7389\u6854"}}, "url": "https://github.com/apache/skywalking/commit/25f821c38c4a62e43a29c279db50851bb90f47c0", "committedDate": "2020-08-12T09:10:01Z", "message": "1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a0a67d8544ece01dab196d156e2bef6d0807b5d", "author": {"user": {"login": "zhaoyuguang", "name": "\u4e8e\u7389\u6854"}}, "url": "https://github.com/apache/skywalking/commit/9a0a67d8544ece01dab196d156e2bef6d0807b5d", "committedDate": "2020-08-12T10:12:47Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fff6e95bf1ad3040e60023940f48165770b1fc1", "author": {"user": {"login": "zhaoyuguang", "name": "\u4e8e\u7389\u6854"}}, "url": "https://github.com/apache/skywalking/commit/5fff6e95bf1ad3040e60023940f48165770b1fc1", "committedDate": "2020-08-12T10:26:29Z", "message": "Merge branch 'master' into zhaoyuguang_0111"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1ODE4MDc3", "url": "https://github.com/apache/skywalking/pull/5304#pullrequestreview-465818077", "createdAt": "2020-08-12T11:20:23Z", "commit": {"oid": "5fff6e95bf1ad3040e60023940f48165770b1fc1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMToyMDoyM1rOG_c3FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMToyMDoyM1rOG_c3FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE4NjMyNA==", "bodyText": "No Context Carrier?", "url": "https://github.com/apache/skywalking/pull/5304#discussion_r469186324", "createdAt": "2020-08-12T11:20:23Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/kafka-plugin/src/main/java/org/apache/skywalking/apm/plugin/kafka/KafkaConsumerInterceptor.java", "diffHunk": "@@ -66,9 +66,10 @@ public Object afterMethod(EnhancedInstance objInst, Method method, Object[] allA\n         //\n         if (records.size() > 0) {\n             ConsumerEnhanceRequiredInfo requiredInfo = (ConsumerEnhanceRequiredInfo) objInst.getSkyWalkingDynamicField();\n-            if (ContextManager.getRuntimeContext().get(Constants.SPRING_KAFKA_FLAG) != null) {\n-                ContextManager.createEntrySpan(Constants.SPRING_KAFKA_POLL_AND_INVOKE_OPERATION_NAME, null);\n-                ((SpringKafkaContext) ContextManager.getRuntimeContext().get(Constants.SPRING_KAFKA_FLAG)).setNeedStop(true);\n+            KafkaContext context = (KafkaContext) ContextManager.getRuntimeContext().get(Constants.KAFKA_FLAG);\n+            if (context != null) {\n+                ContextManager.createEntrySpan(context.getOperationName(), null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fff6e95bf1ad3040e60023940f48165770b1fc1"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1ODI0MTUw", "url": "https://github.com/apache/skywalking/pull/5304#pullrequestreview-465824150", "createdAt": "2020-08-12T11:30:38Z", "commit": {"oid": "5fff6e95bf1ad3040e60023940f48165770b1fc1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMTozMDozOFrOG_dJ_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMTozMDozOFrOG_dJ_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE5MTE2NA==", "bodyText": "I rechecked the codes, this seems not necessary. You always needStop=false. Could we consider to remove it?", "url": "https://github.com/apache/skywalking/pull/5304#discussion_r469191164", "createdAt": "2020-08-12T11:30:38Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/kafka-commons/src/main/java/org/apache/skywalking/apm/plugin/kafka/define/KafkaContext.java", "diffHunk": "@@ -19,19 +19,30 @@\n \n package org.apache.skywalking.apm.plugin.kafka.define;\n \n-public class SpringKafkaContext {\n+public class KafkaContext {\n \n-    public SpringKafkaContext() {\n+    public KafkaContext(String operationName) {\n         needStop = false;\n+        this.operationName = operationName;\n     }\n \n     private boolean needStop;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fff6e95bf1ad3040e60023940f48165770b1fc1"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1ODQ3MzQy", "url": "https://github.com/apache/skywalking/pull/5304#pullrequestreview-465847342", "createdAt": "2020-08-12T12:08:44Z", "commit": {"oid": "5fff6e95bf1ad3040e60023940f48165770b1fc1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMjowODo0NFrOG_eQ_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMjowODo0NFrOG_eQ_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIwOTM0Mw==", "bodyText": "Are you forcing to create 2 consumer methods?", "url": "https://github.com/apache/skywalking/pull/5304#discussion_r469209343", "createdAt": "2020-08-12T12:08:44Z", "author": {"login": "wu-sheng"}, "path": "test/plugin/scenarios/kafka-scenario/src/main/java/test/org/apache/skywalking/apm/testcase/kafka/controller/CaseController.java", "diffHunk": "@@ -223,29 +235,33 @@ public void run() {\n             consumerProperties.put(\"value.deserializer\", \"org.apache.kafka.common.serialization.StringDeserializer\");\n             KafkaConsumer<String, String> consumer = new KafkaConsumer<>(consumerProperties);\n             consumer.subscribe(topicPattern, new NoOpConsumerRebalanceListener());\n-            int i = 0;\n-            while (i++ <= 10) {\n-                try {\n-                    Thread.sleep(1 * 1000);\n-                } catch (InterruptedException e) {\n-                }\n+            while (true) {\n+                if (pollAndInvoke(consumer)) break;\n+            }\n+            consumer.close();\n+        }\n \n-                ConsumerRecords<String, String> records = consumer.poll(100);\n+        @KafkaPollAndInvoke\n+        private boolean pollAndInvoke(KafkaConsumer<String, String> consumer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fff6e95bf1ad3040e60023940f48165770b1fc1"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25879b08ffd731e0978f8e2fc5086c2ba2fcf807", "author": {"user": {"login": "zhaoyuguang", "name": "\u4e8e\u7389\u6854"}}, "url": "https://github.com/apache/skywalking/commit/25879b08ffd731e0978f8e2fc5086c2ba2fcf807", "committedDate": "2020-08-13T01:39:00Z", "message": "fixed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05839c6b10826e79b7279e7a3870162fe5fe0b31", "author": {"user": {"login": "zhaoyuguang", "name": "\u4e8e\u7389\u6854"}}, "url": "https://github.com/apache/skywalking/commit/05839c6b10826e79b7279e7a3870162fe5fe0b31", "committedDate": "2020-08-13T01:39:11Z", "message": "Merge branch 'zhaoyuguang_0111' of https://github.com/zhaoyuguang/incubator-skywalking into zhaoyuguang_0111"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4327b47569ccad52cb649514003f66443bba226a", "author": {"user": {"login": "zhaoyuguang", "name": "\u4e8e\u7389\u6854"}}, "url": "https://github.com/apache/skywalking/commit/4327b47569ccad52cb649514003f66443bba226a", "committedDate": "2020-08-13T03:48:50Z", "message": "Merge branch 'master' into zhaoyuguang_0111"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NTEyODQ3", "url": "https://github.com/apache/skywalking/pull/5304#pullrequestreview-466512847", "createdAt": "2020-08-13T07:35:03Z", "commit": {"oid": "4327b47569ccad52cb649514003f66443bba226a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNzozNTowM1rOG__iaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNzozNTowM1rOG__iaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc1NDQ3Mg==", "bodyText": "This pom seems not formated right. :)", "url": "https://github.com/apache/skywalking/pull/5304#discussion_r469754472", "createdAt": "2020-08-13T07:35:03Z", "author": {"login": "wu-sheng"}, "path": "apm-application-toolkit/apm-toolkit-kafka/pom.xml", "diffHunk": "@@ -0,0 +1,32 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+~ Licensed to the Apache Software Foundation (ASF) under one or more\n+~ contributor license agreements.  See the NOTICE file distributed with\n+~ this work for additional information regarding copyright ownership.\n+~ The ASF licenses this file to You under the Apache License, Version 2.0\n+~ (the \"License\"); you may not use this file except in compliance with\n+~ the License.  You may obtain a copy of the License at\n+~\n+~     http://www.apache.org/licenses/LICENSE-2.0\n+~\n+~ Unless required by applicable law or agreed to in writing, software\n+~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+~ See the License for the specific language governing permissions and\n+~ limitations under the License.\n+~\n+-->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+<parent>\n+    <artifactId>apm-application-toolkit</artifactId>\n+    <groupId>org.apache.skywalking</groupId>\n+    <version>8.2.0-SNAPSHOT</version>\n+</parent>\n+<modelVersion>4.0.0</modelVersion>\n+\n+<artifactId>apm-toolkit-kafka</artifactId>\n+<packaging>jar</packaging>\n+\n+<url>http://maven.apache.org</url>\n+</project>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4327b47569ccad52cb649514003f66443bba226a"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NTEyOTgx", "url": "https://github.com/apache/skywalking/pull/5304#pullrequestreview-466512981", "createdAt": "2020-08-13T07:35:15Z", "commit": {"oid": "4327b47569ccad52cb649514003f66443bba226a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNzozNToxNVrOG__i4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNzozNToxNVrOG__i4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc1NDU5NQ==", "bodyText": "Put in the last one.", "url": "https://github.com/apache/skywalking/pull/5304#discussion_r469754595", "createdAt": "2020-08-13T07:35:15Z", "author": {"login": "wu-sheng"}, "path": "apm-application-toolkit/pom.xml", "diffHunk": "@@ -31,6 +31,7 @@\n     </properties>\n \n     <modules>\n+        <module>apm-toolkit-kafka</module>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4327b47569ccad52cb649514003f66443bba226a"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7978950f55ff1c77069f2554c435e6ea6373eba1", "author": {"user": {"login": "zhaoyuguang", "name": "\u4e8e\u7389\u6854"}}, "url": "https://github.com/apache/skywalking/commit/7978950f55ff1c77069f2554c435e6ea6373eba1", "committedDate": "2020-08-13T08:24:35Z", "message": "fixed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93c8d2fbef33806f86c901675c097d2ee04b90e7", "author": {"user": {"login": "zhaoyuguang", "name": "\u4e8e\u7389\u6854"}}, "url": "https://github.com/apache/skywalking/commit/93c8d2fbef33806f86c901675c097d2ee04b90e7", "committedDate": "2020-08-13T08:25:10Z", "message": "Merge branch 'master' into zhaoyuguang_0111"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NzUxNDU2", "url": "https://github.com/apache/skywalking/pull/5304#pullrequestreview-466751456", "createdAt": "2020-08-13T13:17:56Z", "commit": {"oid": "93c8d2fbef33806f86c901675c097d2ee04b90e7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1894, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}