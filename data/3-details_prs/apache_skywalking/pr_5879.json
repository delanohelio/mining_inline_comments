{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1NDc0NTAx", "number": 5879, "title": "Spring-Kafka 1.x support", "bodyText": "Add an agent plugin to support Spring-Kafka 1.3.x\n\n\n Add a test case for the new plugin\n\n\n Add a component id in the component-libraries.yml. Shared with kafka.\n\n\n Add a logo in the UI repo. Shared with kafka.\n\n\n As a continuation of #5244\n\n\n Update the CHANGES log\n\n\nThe current design of Spring-Kafka plugin\nThe current Spring-Kafka plugin in skywalking is aimed at Spring-Kafka 2.x+ in the sense that there is a pollAndInvoke method which is responsible for poll messages from Kafka and invoke the listeners defined by developers. And this method is provided from version 2.2.1 in order to improve the smell of the codes spring-projects/spring-kafka#873\nSo the current plugin takes advantage of this refactor and enhances directly this pollAndInvoke method. But we still have to maintain many services which depend on Spring-Boot 1.5.x and thus Spring-Kafka 1.3.x according to the official compatibility matrix.\nThe approach to versions below 2.2.x\nBelow that specific version, we do not have pollAndInvoke method and this whole function is inlined into the while-loop of the main run method, thus seems not possible to make this enhancement. My approach is to enhance the processSeeks in the same inner class ListenerConsumer. The reason why we choose this aspect is,\n\nthis method is called at the very beginning of the loop (or equivalently the end of the loop), then we can inject(remove) our Context after(before) the method is executed.\nthis method is called and only called there, it is not used in other places, which represents precisely the beginning of the run loop.\n\nFor completeness and safe reasons, we also enhance the whole run() method in order to remove the context after the loop finishes.\nThe last thing is to distinguish the versions of Spring-Kafka. I use org.springframework.kafka.listener.config.ContainerProperties as the witness class for versions below 2.2.x. This class is renamed as org.springframework.kafka.listener.ContainerProperties after 2.2.x. So this plugin will not be applied for Spring-Kafka 2.2.x+. I have checked all versions up to 2.6.x.\nSo with this plugin, we can enhance the following Spring-Kafka versions, which are missing so far,\n\n1.3.x\n2.0.x\n2.1.x\n\nTheoretically, it can also work with 1.2.x, but that version is not recommended by the official Spring-Kafka team. Also with Spring-Kafka 1.2.x, you have to manually set Kafka version to those higher than 0.10. Otherwise, the header API is missing.", "createdAt": "2020-11-23T06:02:38Z", "url": "https://github.com/apache/skywalking/pull/5879", "merged": true, "mergeCommit": {"oid": "d9623ec48738b8b479c8e0bc68177b66fefbe985"}, "closed": true, "closedAt": "2020-11-24T11:32:37Z", "author": {"login": "lujiajing1126"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfM4w6gH2gAyNTI1NDc0NTAxOjcwNmY2YTc3MjFlOGMzNDc2MDkyNWFlMmIwMDdkYmMxNjdjOGM0ODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfkqrQgFqTUzNzE0MjE3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "706f6a7721e8c34760925ae2b007dbc167c8c486", "author": {"user": {"login": "lujiajing1126", "name": "Jiajing LU"}}, "url": "https://github.com/apache/skywalking/commit/706f6a7721e8c34760925ae2b007dbc167c8c486", "committedDate": "2020-11-23T03:49:45Z", "message": "support spring-kafka 1.3.x and add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f178e384cb301dd060d0d6370f4126d283e0cbd", "author": {"user": {"login": "lujiajing1126", "name": "Jiajing LU"}}, "url": "https://github.com/apache/skywalking/commit/0f178e384cb301dd060d0d6370f4126d283e0cbd", "committedDate": "2020-11-23T04:26:30Z", "message": "fix spring-boot 1.5 context-path configuration and fix expectedData"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1097ee557295f16bcba2e9c17f1b3f0548f0dbb", "author": {"user": {"login": "lujiajing1126", "name": "Jiajing LU"}}, "url": "https://github.com/apache/skywalking/commit/c1097ee557295f16bcba2e9c17f1b3f0548f0dbb", "committedDate": "2020-11-23T04:30:44Z", "message": "add spring-kafka-1.3.x-scenario to github workflow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44c0679fa94051b81598b769b2fb062505c11ec6", "author": {"user": {"login": "lujiajing1126", "name": "Jiajing LU"}}, "url": "https://github.com/apache/skywalking/commit/44c0679fa94051b81598b769b2fb062505c11ec6", "committedDate": "2020-11-23T06:41:26Z", "message": "add spring-kafka-1.x to Plugin list"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MzM5MTIx", "url": "https://github.com/apache/skywalking/pull/5879#pullrequestreview-536339121", "createdAt": "2020-11-23T10:26:17Z", "commit": {"oid": "44c0679fa94051b81598b769b2fb062505c11ec6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMDoyNjoxN1rOH4HQSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMDoyNjoxN1rOH4HQSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYwMTE2Mg==", "bodyText": "please add some little other version to prove support 1.3.x", "url": "https://github.com/apache/skywalking/pull/5879#discussion_r528601162", "createdAt": "2020-11-23T10:26:17Z", "author": {"login": "zhaoyuguang"}, "path": "test/plugin/scenarios/spring-kafka-1.3.x-scenario/support-version.list", "diffHunk": "@@ -0,0 +1,17 @@\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+1.3.11.RELEASE", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44c0679fa94051b81598b769b2fb062505c11ec6"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NDE1NjUy", "url": "https://github.com/apache/skywalking/pull/5879#pullrequestreview-536415652", "createdAt": "2020-11-23T12:12:22Z", "commit": {"oid": "44c0679fa94051b81598b769b2fb062505c11ec6"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78f64fad1091ebd596c682320094925b1e189883", "author": {"user": {"login": "lujiajing1126", "name": "Jiajing LU"}}, "url": "https://github.com/apache/skywalking/commit/78f64fad1091ebd596c682320094925b1e189883", "committedDate": "2020-11-23T13:26:16Z", "message": "add supported versions for spring-kafka"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6664d8ea8aa5b78e55ead168d57befa318256f87", "author": {"user": {"login": "lujiajing1126", "name": "Jiajing LU"}}, "url": "https://github.com/apache/skywalking/commit/6664d8ea8aa5b78e55ead168d57befa318256f87", "committedDate": "2020-11-23T13:28:36Z", "message": "change kafka-plugin FAQ"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e037dc3e6dd5357a5df332cc3563fc6347f52a05", "author": {"user": {"login": "lujiajing1126", "name": "Jiajing LU"}}, "url": "https://github.com/apache/skywalking/commit/e037dc3e6dd5357a5df332cc3563fc6347f52a05", "committedDate": "2020-11-23T13:43:37Z", "message": "reorganize kafka-plugin FAQ"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01fa96204ffa198833a729165b1d2e42cec9aab4", "author": {"user": {"login": "lujiajing1126", "name": "Jiajing LU"}}, "url": "https://github.com/apache/skywalking/commit/01fa96204ffa198833a729165b1d2e42cec9aab4", "committedDate": "2020-11-23T13:56:52Z", "message": "add supported versions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MDMzMTE1", "url": "https://github.com/apache/skywalking/pull/5879#pullrequestreview-537033115", "createdAt": "2020-11-24T02:37:49Z", "commit": {"oid": "01fa96204ffa198833a729165b1d2e42cec9aab4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MTI5MDQx", "url": "https://github.com/apache/skywalking/pull/5879#pullrequestreview-537129041", "createdAt": "2020-11-24T07:09:27Z", "commit": {"oid": "01fa96204ffa198833a729165b1d2e42cec9aab4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe2965c0395c617c26e0e7a9ebc23f40370963dd", "author": {"user": {"login": "lujiajing1126", "name": "Jiajing LU"}}, "url": "https://github.com/apache/skywalking/commit/fe2965c0395c617c26e0e7a9ebc23f40370963dd", "committedDate": "2020-11-24T07:21:10Z", "message": "update CHANGES.md"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MTM3MzA0", "url": "https://github.com/apache/skywalking/pull/5879#pullrequestreview-537137304", "createdAt": "2020-11-24T07:23:44Z", "commit": {"oid": "fe2965c0395c617c26e0e7a9ebc23f40370963dd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwNzoyMzo0NFrOH4u_KA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwNzoyMzo0NFrOH4u_KA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI1MjEzNg==", "bodyText": "I think you indicate 1.3.x only? At least tested? Do I miss anything?", "url": "https://github.com/apache/skywalking/pull/5879#discussion_r529252136", "createdAt": "2020-11-24T07:23:44Z", "author": {"login": "wu-sheng"}, "path": "CHANGES.md", "diffHunk": "@@ -21,6 +21,7 @@ Release Notes.\n * Add the plugin for mssql-jtds 1.x.\n * Add the plugin for mssql-jdbc 6.x -> 9.x.\n * Fix the default ignore mechanism isn't accurate enough bug.\n+* Add the plugin for spring-kafka 1.x.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe2965c0395c617c26e0e7a9ebc23f40370963dd"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0d869fe15042a2da7b481edca8a50836a1a607a", "author": {"user": {"login": "lujiajing1126", "name": "Jiajing LU"}}, "url": "https://github.com/apache/skywalking/commit/f0d869fe15042a2da7b481edca8a50836a1a607a", "committedDate": "2020-11-24T07:25:58Z", "message": "precisely refer to the tested 1.3.x versions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MTQyMTc5", "url": "https://github.com/apache/skywalking/pull/5879#pullrequestreview-537142179", "createdAt": "2020-11-24T07:32:05Z", "commit": {"oid": "f0d869fe15042a2da7b481edca8a50836a1a607a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1378, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}