{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MTQ1Nzc2", "number": 5099, "title": "Storage elasticsearch health check", "bodyText": "These changes intend to add health checks to elasticsearch storage plugin.\n\nUpdate elasticsearch client 6.x and 7.x to the latest version, which tries to fix some underlying connection issues.\n\n\nUpgrading client is hard, let's leave them alone.\n\n\nAdd HealthChecker to combinate between provider and storage service client. The HealthChecker opts to \"sync\" strategy which means it doesn't set up an async scheduler to check backend server periodically. That is because our persistence timer will touch the storage server every 3 seconds(the default value), so we can leverage it as a health checking trigger.\nSome users report issues like elastic/elasticsearch#39946, in this PR, I fix this issue by recreating a new RestClient once catching the IllegalStateExecption indicate the collection pool is closed under the hood.\n\nI only update the elasticsearch 6 in the current commit. After getting enough feedbacks to polish the implementation, I will update elasticsearch 7 accordingly.", "createdAt": "2020-07-14T22:31:27Z", "url": "https://github.com/apache/skywalking/pull/5099", "merged": true, "mergeCommit": {"oid": "3fdfdf3b83a1d6d80066c321eb3f05568657aba7"}, "closed": true, "closedAt": "2020-07-19T15:37:14Z", "author": {"login": "hanahmily"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0s5rZAH2gAyNDQ5MTQ1Nzc2OmY0NWExMjc2NTg0YTJhNTM5ZTVlMmZlZGMwMGFmMmQ4YTE1MDIyY2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc2d9RhAFqTQ1MTEzNzE5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f45a1276584a2a539e5e2fedc00af2d8a15022cb", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/f45a1276584a2a539e5e2fedc00af2d8a15022cb", "committedDate": "2020-07-14T02:48:58Z", "message": "Update Elasticsearch client version to latest\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e16d6178c385d4dc123332c9d977336e7869994", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/8e16d6178c385d4dc123332c9d977336e7869994", "committedDate": "2020-07-14T22:15:15Z", "message": "Add HealthChecker helper\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d3e2453d38af67fdbaf492832f4ed56d5ecfc39", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/2d3e2453d38af67fdbaf492832f4ed56d5ecfc39", "committedDate": "2020-07-14T22:32:26Z", "message": "Merge branch 'master' into storage-elasticsearch-health"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NjY0OTYw", "url": "https://github.com/apache/skywalking/pull/5099#pullrequestreview-448664960", "createdAt": "2020-07-15T06:33:57Z", "commit": {"oid": "2d3e2453d38af67fdbaf492832f4ed56d5ecfc39"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwNjozMzo1N1rOGxwLVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwNjozMzo1N1rOGxwLVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDgyMjc0MA==", "bodyText": "Could we don't do this? Once you did, I remember, you can't access 6.3-6.7 server any more.", "url": "https://github.com/apache/skywalking/pull/5099#discussion_r454822740", "createdAt": "2020-07-15T06:33:57Z", "author": {"login": "wu-sheng"}, "path": "oap-server/pom.xml", "diffHunk": "@@ -64,7 +64,7 @@\n         <h2.version>1.4.196</h2.version>\n         <commons-dbcp.version>1.4</commons-dbcp.version>\n         <commons-io.version>2.6</commons-io.version>\n-        <elasticsearch.version>6.3.2</elasticsearch.version>\n+        <elasticsearch.version>6.8.10</elasticsearch.version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d3e2453d38af67fdbaf492832f4ed56d5ecfc39"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40ef1007310166a953632c77fc5e1b7f0e655d7e", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/40ef1007310166a953632c77fc5e1b7f0e655d7e", "committedDate": "2020-07-15T06:53:08Z", "message": "Revert \"Update Elasticsearch client version to latest\"\n\nThis reverts commit f45a1276"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "587961db9a5a44b2d1f75f000fa1b3d589f65a9f", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/587961db9a5a44b2d1f75f000fa1b3d589f65a9f", "committedDate": "2020-07-15T06:58:29Z", "message": "Merge branch 'storage-elasticsearch-health' of github.com:apache/skywalking into storage-elasticsearch-health"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17a2b93fa12f83436a2c190b4ce9c3587c554a4d", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/17a2b93fa12f83436a2c190b4ce9c3587c554a4d", "committedDate": "2020-07-15T06:59:08Z", "message": "Merge branch 'master' into storage-elasticsearch-health"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ea856b0874ff677ea36e2ca947fab97dcd09656", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/0ea856b0874ff677ea36e2ca947fab97dcd09656", "committedDate": "2020-07-15T14:40:46Z", "message": "Merge branch 'master' into storage-elasticsearch-health"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5e840a8a7bcb681dbb360b42e60bb901666799c", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/d5e840a8a7bcb681dbb360b42e60bb901666799c", "committedDate": "2020-07-15T15:33:23Z", "message": "Add health check to elasticsearch7\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f50fa847cb68a71eff3bf8ee9c283d2dab054ad", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/9f50fa847cb68a71eff3bf8ee9c283d2dab054ad", "committedDate": "2020-07-15T22:00:03Z", "message": "nits\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NDYxNzcx", "url": "https://github.com/apache/skywalking/pull/5099#pullrequestreview-449461771", "createdAt": "2020-07-16T02:17:27Z", "commit": {"oid": "9f50fa847cb68a71eff3bf8ee9c283d2dab054ad"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwMjoxNzoyN1rOGyXp5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwMjoyODozNVrOGyX1RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ2OTU0Mw==", "bodyText": "CoreModule has depended on TelemetryModule, I think.", "url": "https://github.com/apache/skywalking/pull/5099#discussion_r455469543", "createdAt": "2020-07-16T02:17:27Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/StorageModuleElasticsearchProvider.java", "diffHunk": "@@ -197,7 +208,7 @@ public void notifyAfterCompleted() {\n \n     @Override\n     public String[] requiredModules() {\n-        return new String[]{CoreModule.NAME};\n+        return new String[]{CoreModule.NAME, TelemetryModule.NAME};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f50fa847cb68a71eff3bf8ee9c283d2dab054ad"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ3MjA0OA==", "bodyText": "Why need HealthChecker as a kind of util? And keep in static final(DEFAULT_CHECKER)?\nAccording to #5046, Health check is a module/provider. So, the thing about the checker should be a service, which you could get a reference from ServiceManager in any module.", "url": "https://github.com/apache/skywalking/pull/5099#discussion_r455472048", "createdAt": "2020-07-16T02:27:01Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-library/library-client/src/main/java/org/apache/skywalking/oap/server/library/client/healthcheck/HealthChecker.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.library.client.healthcheck;\n+\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * HealthChecker could provide health status to the listener.\n+ */\n+@Slf4j\n+@RequiredArgsConstructor\n+public class HealthChecker {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f50fa847cb68a71eff3bf8ee9c283d2dab054ad"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ3MjQ1Mw==", "bodyText": "Also, based on the way you use this, it is likely, you should have this module up and running always.\nI think we need a little more discussion about health checker model behavior.", "url": "https://github.com/apache/skywalking/pull/5099#discussion_r455472453", "createdAt": "2020-07-16T02:28:35Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-library/library-client/src/main/java/org/apache/skywalking/oap/server/library/client/healthcheck/HealthChecker.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.library.client.healthcheck;\n+\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * HealthChecker could provide health status to the listener.\n+ */\n+@Slf4j\n+@RequiredArgsConstructor\n+public class HealthChecker {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ3MjA0OA=="}, "originalCommit": {"oid": "9f50fa847cb68a71eff3bf8ee9c283d2dab054ad"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5527de21d865786247ebfe0fa1806726cf1cfed", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/a5527de21d865786247ebfe0fa1806726cf1cfed", "committedDate": "2020-07-18T14:31:50Z", "message": "Merge branch 'master' into storage-elasticsearch-health"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cf9633f50506d7b178a1974d1b976996244fab7", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/0cf9633f50506d7b178a1974d1b976996244fab7", "committedDate": "2020-07-19T13:50:40Z", "message": "Polish codes\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0525a4ec76602b337958397dfeeb05a85a6290d7", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/0525a4ec76602b337958397dfeeb05a85a6290d7", "committedDate": "2020-07-19T13:51:10Z", "message": "Merge branch 'master' into storage-elasticsearch-health"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48478d2831c926ab5818dcf9176bc4a6ec0450d4", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/48478d2831c926ab5818dcf9176bc4a6ec0450d4", "committedDate": "2020-07-19T13:52:44Z", "message": "Polish codes\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6843b0d85ea35f415174efb35ec037dcf9d52f3", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/a6843b0d85ea35f415174efb35ec037dcf9d52f3", "committedDate": "2020-07-19T13:53:02Z", "message": "Merge branch 'storage-elasticsearch-health' of github.com:apache/skywalking into storage-elasticsearch-health"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMTM1ODU1", "url": "https://github.com/apache/skywalking/pull/5099#pullrequestreview-451135855", "createdAt": "2020-07-19T14:18:16Z", "commit": {"oid": "a6843b0d85ea35f415174efb35ec037dcf9d52f3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQxNDoxODoxNlrOGzv1vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQxNDoxODoxNlrOGzv1vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkxNDM2Nw==", "bodyText": "This seems a format issue.", "url": "https://github.com/apache/skywalking/pull/5099#discussion_r456914367", "createdAt": "2020-07-19T14:18:16Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-elasticsearch7-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch7/client/ElasticSearch7Client.java", "diffHunk": "@@ -256,9 +292,9 @@ public void synchronousBulk(BulkRequest request) {\n             int size = request.requests().size();\n             BulkResponse responses = client.bulk(request, RequestOptions.DEFAULT);\n             log.info(\"Synchronous bulk took time: {} millis, size: {}\", responses.getTook().getMillis(), size);\n-        } catch (IOException e) {\n-            log.error(e.getMessage(), e);\n-        }\n+            healthChecker.health();\n+        } catch (Throwable t) {\n+            healthChecker.unHealth(t);        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6843b0d85ea35f415174efb35ec037dcf9d52f3"}, "originalPosition": 139}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMTM1OTM3", "url": "https://github.com/apache/skywalking/pull/5099#pullrequestreview-451135937", "createdAt": "2020-07-19T14:19:26Z", "commit": {"oid": "a6843b0d85ea35f415174efb35ec037dcf9d52f3"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "929f455c2f9090b66b7892cdac722d834363e387", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/929f455c2f9090b66b7892cdac722d834363e387", "committedDate": "2020-07-19T14:23:41Z", "message": "Fix some nits\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMTM3MTk2", "url": "https://github.com/apache/skywalking/pull/5099#pullrequestreview-451137196", "createdAt": "2020-07-19T14:32:10Z", "commit": {"oid": "929f455c2f9090b66b7892cdac722d834363e387"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2081, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}