{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2NTU1OTA0", "number": 4493, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMDozMzoxN1rODnBNgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwODoyNjoyOVrODnv7kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMjQwODk3OnYy", "diffSide": "RIGHT", "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/StorageModuleElasticsearchProvider.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMDozMzoxN1rOF0xSHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMzo0MjoyNFrOF03ZIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg3NzcyNw==", "bodyText": "Make elasticSearchClient volatile?", "url": "https://github.com/apache/skywalking/pull/4493#discussion_r390877727", "createdAt": "2020-03-11T10:33:17Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/StorageModuleElasticsearchProvider.java", "diffHunk": "@@ -117,6 +120,31 @@ public void prepare() throws ServiceNotProvidedException {\n         if (config.getDayStep() > 1) {\n             TimeSeriesUtils.setDAY_STEP(config.getDayStep());\n         }\n+\n+        if (!StringUtil.isEmpty(config.getSecretsManagementFile())) {\n+            MultipleFilesChangeMonitor monitor = new MultipleFilesChangeMonitor(\n+                10, readableContents -> {\n+                    final byte[] secretsFileContent = readableContents.get(0);\n+                    if (secretsFileContent == null) {\n+                        return;\n+                    }\n+                    Properties userAndPass = new Properties();\n+                    userAndPass.load(new ByteArrayInputStream(secretsFileContent));\n+                    config.setUser(userAndPass.getProperty(\"user\"));\n+                    config.setPassword(userAndPass.getProperty(\"password\"));\n+\n+                    if (elasticSearchClient == null) {\n+                        //In the startup process, we just need to change the username/password", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2806553017a8a3607a4e35a15c75ba9b3a547596"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg4MDQyOQ==", "bodyText": "Was thinking about this. But not sure. Does across Thread cache will keep forever? Because we are not sensitive this changed immediately, several seconds later is fine.\nWhat do you think about this?", "url": "https://github.com/apache/skywalking/pull/4493#discussion_r390880429", "createdAt": "2020-03-11T10:38:05Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/StorageModuleElasticsearchProvider.java", "diffHunk": "@@ -117,6 +120,31 @@ public void prepare() throws ServiceNotProvidedException {\n         if (config.getDayStep() > 1) {\n             TimeSeriesUtils.setDAY_STEP(config.getDayStep());\n         }\n+\n+        if (!StringUtil.isEmpty(config.getSecretsManagementFile())) {\n+            MultipleFilesChangeMonitor monitor = new MultipleFilesChangeMonitor(\n+                10, readableContents -> {\n+                    final byte[] secretsFileContent = readableContents.get(0);\n+                    if (secretsFileContent == null) {\n+                        return;\n+                    }\n+                    Properties userAndPass = new Properties();\n+                    userAndPass.load(new ByteArrayInputStream(secretsFileContent));\n+                    config.setUser(userAndPass.getProperty(\"user\"));\n+                    config.setPassword(userAndPass.getProperty(\"password\"));\n+\n+                    if (elasticSearchClient == null) {\n+                        //In the startup process, we just need to change the username/password", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg3NzcyNw=="}, "originalCommit": {"oid": "2806553017a8a3607a4e35a15c75ba9b3a547596"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk3NzgyNw==", "bodyText": "Added.", "url": "https://github.com/apache/skywalking/pull/4493#discussion_r390977827", "createdAt": "2020-03-11T13:42:24Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/StorageModuleElasticsearchProvider.java", "diffHunk": "@@ -117,6 +120,31 @@ public void prepare() throws ServiceNotProvidedException {\n         if (config.getDayStep() > 1) {\n             TimeSeriesUtils.setDAY_STEP(config.getDayStep());\n         }\n+\n+        if (!StringUtil.isEmpty(config.getSecretsManagementFile())) {\n+            MultipleFilesChangeMonitor monitor = new MultipleFilesChangeMonitor(\n+                10, readableContents -> {\n+                    final byte[] secretsFileContent = readableContents.get(0);\n+                    if (secretsFileContent == null) {\n+                        return;\n+                    }\n+                    Properties userAndPass = new Properties();\n+                    userAndPass.load(new ByteArrayInputStream(secretsFileContent));\n+                    config.setUser(userAndPass.getProperty(\"user\"));\n+                    config.setPassword(userAndPass.getProperty(\"password\"));\n+\n+                    if (elasticSearchClient == null) {\n+                        //In the startup process, we just need to change the username/password", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg3NzcyNw=="}, "originalCommit": {"oid": "2806553017a8a3607a4e35a15c75ba9b3a547596"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMjkyODEwOnYy", "diffSide": "RIGHT", "path": "oap-server/server-library/library-client/src/main/java/org/apache/skywalking/oap/server/library/client/elasticsearch/ElasticSearchClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMzoxMzowMFrOF02QGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMzoyMjoxN1rOF02mgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk1OTEzMA==", "bodyText": "Same thread visibility problem for client, if the monitor thread failed to detect the client is initialized below(in line 129), the client is not closed and left open forever", "url": "https://github.com/apache/skywalking/pull/4493#discussion_r390959130", "createdAt": "2020-03-11T13:13:00Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-library/library-client/src/main/java/org/apache/skywalking/oap/server/library/client/elasticsearch/ElasticSearchClient.java", "diffHunk": "@@ -119,6 +119,13 @@ public ElasticSearchClient(String clusterNodes,\n     @Override\n     public void connect() throws IOException, KeyStoreException, NoSuchAlgorithmException, KeyManagementException, CertificateException {\n         List<HttpHost> hosts = parseClusterNodes(protocol, clusterNodes);\n+        if (client != null) {\n+            try {\n+                client.close();\n+            } catch (Throwable t) {\n+                log.error(\"ElasticSearch client reconnection fails based on new config\", t);\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d840b3384923907bfd145ee316e4a0e7c9191beb"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk2NDg2NQ==", "bodyText": "Good point.", "url": "https://github.com/apache/skywalking/pull/4493#discussion_r390964865", "createdAt": "2020-03-11T13:22:17Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-library/library-client/src/main/java/org/apache/skywalking/oap/server/library/client/elasticsearch/ElasticSearchClient.java", "diffHunk": "@@ -119,6 +119,13 @@ public ElasticSearchClient(String clusterNodes,\n     @Override\n     public void connect() throws IOException, KeyStoreException, NoSuchAlgorithmException, KeyManagementException, CertificateException {\n         List<HttpHost> hosts = parseClusterNodes(protocol, clusterNodes);\n+        if (client != null) {\n+            try {\n+                client.close();\n+            } catch (Throwable t) {\n+                log.error(\"ElasticSearch client reconnection fails based on new config\", t);\n+            }\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk1OTEzMA=="}, "originalCommit": {"oid": "d840b3384923907bfd145ee316e4a0e7c9191beb"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMDA2MzU0OnYy", "diffSide": "RIGHT", "path": "docs/en/setup/backend/backend-storage.md", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwODoyNjoyOVrOF17GPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwODo1ODoxOFrOF179Gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA4NzEwMg==", "bodyText": "typo duplicated with this file is?", "url": "https://github.com/apache/skywalking/pull/4493#discussion_r392087102", "createdAt": "2020-03-13T08:26:29Z", "author": {"login": "JaredTan95"}, "path": "docs/en/setup/backend/backend-storage.md", "diffHunk": "@@ -124,6 +126,20 @@ Such as, if dayStep == 11,\n \n NOTICE, TTL deletion would be affected by these. You should set an extra more dayStep in your TTL. Such as you want to TTL == 30 days and dayStep == 10, you actually need to set TTL = 40;\n \n+### Secrets Management File Of ElasticSearch Authentication\n+The value of `secretsManagementFile` should point to the secrets management file absolute path. \n+The file includes username, password and JKS password of ElasticSearch server in the properties format.\n+```properties\n+user=xxx\n+password=yyy\n+trustStorePass=zzz\n+```\n+\n+The major difference between using `user, password, trustStorePass` configs in the `application.yaml` and this file is, this file is being watched by the OAP server. ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b08bf83e6002b16e6008d87b6b76ec07e0653d2e"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwMTE0Nw==", "bodyText": "Yes. And fixed.", "url": "https://github.com/apache/skywalking/pull/4493#discussion_r392101147", "createdAt": "2020-03-13T08:58:18Z", "author": {"login": "wu-sheng"}, "path": "docs/en/setup/backend/backend-storage.md", "diffHunk": "@@ -124,6 +126,20 @@ Such as, if dayStep == 11,\n \n NOTICE, TTL deletion would be affected by these. You should set an extra more dayStep in your TTL. Such as you want to TTL == 30 days and dayStep == 10, you actually need to set TTL = 40;\n \n+### Secrets Management File Of ElasticSearch Authentication\n+The value of `secretsManagementFile` should point to the secrets management file absolute path. \n+The file includes username, password and JKS password of ElasticSearch server in the properties format.\n+```properties\n+user=xxx\n+password=yyy\n+trustStorePass=zzz\n+```\n+\n+The major difference between using `user, password, trustStorePass` configs in the `application.yaml` and this file is, this file is being watched by the OAP server. ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA4NzEwMg=="}, "originalCommit": {"oid": "b08bf83e6002b16e6008d87b6b76ec07e0653d2e"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4413, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}