{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4ODcwMTIx", "number": 4712, "title": "Fix npe in afterMethod/handleMethodException of kafka/finagle plugins", "bodyText": "Please answer these questions before submitting pull request\n\n\nWhy submit this pull request?\n\n\n Bug fix\n\n\n New feature provided\n\n\n Improve performance\n\n\nRelated issues\n\n\n\nBug fix\n\nBug description.\n\nERROR 2020-04-24 15:35:36:776 canalMessageListenerContainer-C-1 InstMethodsInter : class[class org.apache.kafka.clients.consumer.KafkaConsumer] handle method[pollOnce] exception failure\njava.lang.NullPointerException\n        at org.apache.skywalking.apm.agent.core.context.ContextManager.activeSpan(ContextManager.java:171)\n        at org.apache.skywalking.apm.plugin.kafka.KafkaConsumerInterceptor.handleMethodException(KafkaConsumerInterceptor.java:91)\n        at org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstMethodsInter.intercept(InstMethodsInter.java:90)\n        at org.apache.kafka.clients.consumer.KafkaConsumer.pollOnce(KafkaConsumer.java)\n        at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1043)\n        at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.run(KafkaMessageListenerContainer.java:568)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:266)\n        at java.lang.Thread.run(Thread.java:748)\n\nERROR 2020-04-24 15:35:36:778 canalMessageListenerContainer-C-1 InstMethodsInter : class[class org.apache.kafka.clients.consumer.KafkaConsumer] after method[pollOnce] intercept failure\njava.lang.NullPointerException\n        at org.apache.skywalking.apm.plugin.kafka.KafkaConsumerInterceptor.afterMethod(KafkaConsumerInterceptor.java:58)\n        at org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstMethodsInter.intercept(InstMethodsInter.java:97)\n        at org.apache.kafka.clients.consumer.KafkaConsumer.pollOnce(KafkaConsumer.java)\n        at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1043)\n        at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.run(KafkaMessageListenerContainer.java:568)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:266)\n        at java.lang.Thread.run(Thread.java:748)\n\n\nHow to fix?\n\n\ninvoke ContextManager.isActive() before  ContextManager.activeSpan()\ntest if ret is null in afterMethod implementation\n\n\nNew feature or improvement\n\nDescribe the details and related test reports.", "createdAt": "2020-04-25T08:14:11Z", "url": "https://github.com/apache/skywalking/pull/4712", "merged": true, "mergeCommit": {"oid": "b6cc9a59d88ce2f893ef8fdf385f5a10dee8ed86"}, "closed": true, "closedAt": "2020-04-25T14:27:46Z", "author": {"login": "huangyoje"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbBeyLAH2gAyNDA4ODcwMTIxOmNkMzFiNTBkYjMyOTc4ZmQyZDk1MmU3OGQ2ZTRjM2M2NjdlMTlkNjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbG8XOAFqTQwMDM5ODUzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cd31b50db32978fd2d952e78d6e4c3c667e19d62", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/cd31b50db32978fd2d952e78d6e4c3c667e19d62", "committedDate": "2020-04-25T08:05:34Z", "message": "Fix npe in afterMethod/handleMethodException of kafka/finagle plugins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51f283f9a5e79861bc73091365562f3ea22cd1c5", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/51f283f9a5e79861bc73091365562f3ea22cd1c5", "committedDate": "2020-04-25T08:13:39Z", "message": "Merge branch 'master' into fix-KafkaConsumerInterceptor-npe"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMzcyNzk5", "url": "https://github.com/apache/skywalking/pull/4712#pullrequestreview-400372799", "createdAt": "2020-04-25T08:33:22Z", "commit": {"oid": "51f283f9a5e79861bc73091365562f3ea22cd1c5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwODozMzoyMlrOGLye7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwODozMzozNVrOGLyfBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTAxNDYzOA==", "bodyText": "When ret == null?", "url": "https://github.com/apache/skywalking/pull/4712#discussion_r415014638", "createdAt": "2020-04-25T08:33:22Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/kafka-plugin/src/main/java/org/apache/skywalking/apm/plugin/kafka/KafkaConsumerInterceptor.java", "diffHunk": "@@ -51,6 +51,9 @@ public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allAr\n     @Override\n     public Object afterMethod(EnhancedInstance objInst, Method method, Object[] allArguments, Class<?>[] argumentsTypes,\n         Object ret) throws Throwable {\n+        if (ret == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f283f9a5e79861bc73091365562f3ea22cd1c5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTAxNDY2MA==", "bodyText": "Why we have inactive cases?", "url": "https://github.com/apache/skywalking/pull/4712#discussion_r415014660", "createdAt": "2020-04-25T08:33:35Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/kafka-plugin/src/main/java/org/apache/skywalking/apm/plugin/kafka/KafkaConsumerInterceptor.java", "diffHunk": "@@ -88,6 +91,8 @@ public Object afterMethod(EnhancedInstance objInst, Method method, Object[] allA\n     @Override\n     public void handleMethodException(EnhancedInstance objInst, Method method, Object[] allArguments,\n         Class<?>[] argumentsTypes, Throwable t) {\n-        ContextManager.activeSpan().errorOccurred().log(t);\n+        if (ContextManager.isActive()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f283f9a5e79861bc73091365562f3ea22cd1c5"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1136bf47f2d21315d23148ea6e2a9aef59720352", "author": {"user": {"login": "huangyoje", "name": "yoje"}}, "url": "https://github.com/apache/skywalking/commit/1136bf47f2d21315d23148ea6e2a9aef59720352", "committedDate": "2020-04-25T10:02:33Z", "message": "Merge branch 'master' into fix-afterMethod-npe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a491e3004b57edc0cb2372d50c99f47d96e21dbd", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/a491e3004b57edc0cb2372d50c99f47d96e21dbd", "committedDate": "2020-04-25T12:46:39Z", "message": "Add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dc210c2ba2e5724077eaa506d52711c40f3967c", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/5dc210c2ba2e5724077eaa506d52711c40f3967c", "committedDate": "2020-04-25T13:15:07Z", "message": "Add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0bbc6788f26021daae0e4c5067f655e45a9933d", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/d0bbc6788f26021daae0e4c5067f655e45a9933d", "committedDate": "2020-04-25T13:25:36Z", "message": "Merge branch 'master' into fix-afterMethod-npe"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMzk4NTMx", "url": "https://github.com/apache/skywalking/pull/4712#pullrequestreview-400398531", "createdAt": "2020-04-25T14:27:24Z", "commit": {"oid": "d0bbc6788f26021daae0e4c5067f655e45a9933d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2349, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}