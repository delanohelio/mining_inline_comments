{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1OTczMjY2", "number": 6091, "title": "Enhance Envoy metrics service analyzer by MAL", "bodyText": "If this pull request closes/resolves/fixes an existing issue, replace the issue number. Closes #5988.\n Update the CHANGES log.", "createdAt": "2020-12-28T07:34:36Z", "url": "https://github.com/apache/skywalking/pull/6091", "merged": true, "mergeCommit": {"oid": "f54f639c4d9207c20490519121eeabe6acf37374"}, "closed": true, "closedAt": "2021-01-02T06:34:55Z", "author": {"login": "kezhenxu94"}, "timelineItems": {"totalCount": 40, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdqhF0wgH2gAyNTQ1OTczMjY2OjkxNmUyMGExMzhhMjNhMTAzYmE2YzQ5OGJkNDA5Zjc3ODlkODI5NWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdsHKvNAFqTU2MDYyMzI5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "916e20a138a23a103ba6c498bd409f7789d8295b", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/916e20a138a23a103ba6c498bd409f7789d8295b", "committedDate": "2020-12-28T07:35:17Z", "message": "Enhance Envoy metrics service analyzer by MAL"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "916e20a138a23a103ba6c498bd409f7789d8295b", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/916e20a138a23a103ba6c498bd409f7789d8295b", "committedDate": "2020-12-28T07:35:17Z", "message": "Enhance Envoy metrics service analyzer by MAL"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MDI4Mzc3", "url": "https://github.com/apache/skywalking/pull/6091#pullrequestreview-559028377", "createdAt": "2020-12-28T07:39:18Z", "commit": {"oid": "916e20a138a23a103ba6c498bd409f7789d8295b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQwNzozOToxOVrOILzVhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQwNzo0MjoxNlrOILzYGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI0NjM0Mg==", "bodyText": "Envoy now doesn't have a latest tag, and pinning the image version is a good practice IMO.", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r549246342", "createdAt": "2020-12-28T07:39:19Z", "author": {"login": "kezhenxu94"}, "path": "docs/en/setup/envoy/examples/metrics/docker-compose.yaml", "diffHunk": "@@ -17,7 +17,7 @@\n version: \"3\"\n services:\n   envoy:\n-    image: envoyproxy/envoy-alpine:latest\n+    image: envoyproxy/envoy-alpine:v1.16.2", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "916e20a138a23a103ba6c498bd409f7789d8295b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI0NjQ5NQ==", "bodyText": "Metrics names in Envoy contain ., hence this is necessary", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r549246495", "createdAt": "2020-12-28T07:40:06Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/analyzer/meter-analyzer/src/main/java/org/apache/skywalking/oap/meter/analyzer/prometheus/PrometheusMetricConverter.java", "diffHunk": "@@ -141,6 +141,11 @@ public void toMeter(Stream<Metric> metricStream) {\n         if (ss.length < 1) {\n             return Optional.empty();\n         }\n-        return Optional.of(Tuple.of(metric.getName(), SampleFamilyBuilder.newBuilder(ss).build()));\n+        return Optional.of(Tuple.of(escapedName(metric.getName()), SampleFamilyBuilder.newBuilder(ss).build()));\n+    }\n+\n+    // Returns the escaped name of the given one, with \".\" replaced by \"_\"\n+    protected String escapedName(final String name) {\n+        return name.replaceAll(\"\\\\.\", \"_\");\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "916e20a138a23a103ba6c498bd409f7789d8295b"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI0NzAwMw==", "bodyText": "Does this make sense @hanahmily ? Seems both control plane and data plane all share the same \"serviceGroup\" in \"oap-server/server-bootstrap/src/main/resources/ui-initialized-templates/istio.yml\"", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r549247003", "createdAt": "2020-12-28T07:42:16Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-bootstrap/src/main/resources/otel-oc-rules/istio-controlplane.yaml", "diffHunk": "@@ -28,7 +28,7 @@\n #    \"-P6H3M\"    -- parses as \"-6 hours and -3 minutes\"\n #    \"-P-6H+3M\"  -- parses as \"+6 hours and -3 minutes\"\n # </pre>\n-expSuffix: tag({tags -> tags.cluster = 'istio-ctrl::' + tags.cluster}).service(['cluster', 'app'])", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "916e20a138a23a103ba6c498bd409f7789d8295b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d44af04794a03d38f69d95a814cfd7447d7e57b9", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/d44af04794a03d38f69d95a814cfd7447d7e57b9", "committedDate": "2020-12-28T08:29:08Z", "message": "Make the original tests pass first"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MDY4Mjgy", "url": "https://github.com/apache/skywalking/pull/6091#pullrequestreview-559068282", "createdAt": "2020-12-28T09:40:05Z", "commit": {"oid": "d44af04794a03d38f69d95a814cfd7447d7e57b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQwOTo0MDowNlrOIL1fQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQwOTo0MDowNlrOIL1fQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI4MTYwMQ==", "bodyText": "Why need this? Could we disable through SW_ENVOY_METRIC=-?", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r549281601", "createdAt": "2020-12-28T09:40:06Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-bootstrap/src/main/resources/application.yml", "diffHunk": "@@ -266,6 +266,7 @@ envoy-metric:\n     # to append the version number to the service name.\n     # Be careful, when using environment variables to pass this configuration, use single quotes(`''`) to avoid it being evaluated by the shell.\n     k8sServiceNameRule: ${K8S_SERVICE_NAME_RULE:\"${service.metadata.name}\"}\n+    enabledMALRules: ${SW_ENVOY_METRIC_MAL_RULES:\"envoy\"}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d44af04794a03d38f69d95a814cfd7447d7e57b9"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "434c476b1b9cd7d26eea74adabcca5430d687ff0", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/434c476b1b9cd7d26eea74adabcca5430d687ff0", "committedDate": "2020-12-29T15:43:29Z", "message": "Set up the E2E skeleton first"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7659c5a8eef367306757283cc42bd2816690e013", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/7659c5a8eef367306757283cc42bd2816690e013", "committedDate": "2020-12-29T16:08:22Z", "message": "Merge branch 'master' into envoy/mal"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "7659c5a8eef367306757283cc42bd2816690e013", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/7659c5a8eef367306757283cc42bd2816690e013", "committedDate": "2020-12-29T16:08:22Z", "message": "Merge branch 'master' into envoy/mal"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NjE3OTUz", "url": "https://github.com/apache/skywalking/pull/6091#pullrequestreview-559617953", "createdAt": "2020-12-29T16:55:51Z", "commit": {"oid": "7659c5a8eef367306757283cc42bd2816690e013"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNjo1NTo1MVrOIMTrPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNjo1NTo1MVrOIMTrPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3NjE5MA==", "bodyText": "NULL_DEREFERENCE:  object returned by ProtoMetricFamily2MetricsAdapter.metricFamily.getType() could be null and is dereferenced at line 36.", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r549776190", "createdAt": "2020-12-29T16:55:51Z", "author": {"login": "sonatype-lift"}, "path": "oap-server/server-receiver-plugin/envoy-metrics-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/envoy/metrics/adapters/ProtoMetricFamily2MetricsAdapter.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.envoy.metrics.adapters;\n+\n+import io.prometheus.client.Metrics;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+import lombok.RequiredArgsConstructor;\n+import org.apache.skywalking.oap.server.library.util.prometheus.metrics.Gauge;\n+import org.apache.skywalking.oap.server.library.util.prometheus.metrics.Metric;\n+\n+import static java.util.stream.Collectors.toMap;\n+\n+@RequiredArgsConstructor\n+public class ProtoMetricFamily2MetricsAdapter {\n+    protected final Metrics.MetricFamily metricFamily;\n+\n+    public Stream<Metric> adapt() {\n+        // TODO: should adapt more types\n+        switch (metricFamily.getType()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7659c5a8eef367306757283cc42bd2816690e013"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e40d6d5f9ab71346baa6a0875a84814f06037c6", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/8e40d6d5f9ab71346baa6a0875a84814f06037c6", "committedDate": "2020-12-30T04:14:30Z", "message": "Ignore `parent_connections_used` since it's not involved in this case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e0a5a783e441cd25cab3a59ae71739b675b614b", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/6e0a5a783e441cd25cab3a59ae71739b675b614b", "committedDate": "2020-12-30T05:09:01Z", "message": "Add more metrics to data plane"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfac6c1a3ce0815cc23e3a173804197fd24acbe8", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/bfac6c1a3ce0815cc23e3a173804197fd24acbe8", "committedDate": "2020-12-30T05:12:54Z", "message": "Remove unnecessary config rule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9605d0977b8b6213b3f35846445a02b293350fb5", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/9605d0977b8b6213b3f35846445a02b293350fb5", "committedDate": "2020-12-30T07:10:28Z", "message": "Update EnvoyMetricReceiverConfig.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd1310158994b7f154bae40b46c3fe6498e1964a", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/fd1310158994b7f154bae40b46c3fe6498e1964a", "committedDate": "2020-12-30T07:25:29Z", "message": "Merge branch 'master' into envoy/mal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02b5eb0cb680288dde15efef9cdb041739879732", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/02b5eb0cb680288dde15efef9cdb041739879732", "committedDate": "2020-12-30T10:26:45Z", "message": "Fix E2E"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14c8eafee7ec4e8661f565b96b34ea5d0e1f9b50", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/14c8eafee7ec4e8661f565b96b34ea5d0e1f9b50", "committedDate": "2020-12-30T11:11:28Z", "message": "Update instances-istio::reviews.default.yml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aff25f59861b44ec42376b66d5549891eb342054", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/aff25f59861b44ec42376b66d5549891eb342054", "committedDate": "2020-12-31T03:30:49Z", "message": "Lift data plane to level 1 of dashboard"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "763c807840383583c025697d07d8ab8451e513ef", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/763c807840383583c025697d07d8ab8451e513ef", "committedDate": "2020-12-31T03:32:20Z", "message": "Merge remote-tracking branch 'origin/master' into envoy/mal\n\n# Conflicts:\n#\tCHANGES.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ba7244a8520d06cffed469bb115e96f637c909d", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/4ba7244a8520d06cffed469bb115e96f637c909d", "committedDate": "2020-12-31T03:41:52Z", "message": "Revert istio ctrl plane svc group name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fab4e40637a21a5476c59f4e11cb4050785f2ae", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/0fab4e40637a21a5476c59f4e11cb4050785f2ae", "committedDate": "2020-12-31T05:02:48Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6754a3d6d2a68bc509efb516f3482b1438c00edb", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/6754a3d6d2a68bc509efb516f3482b1438c00edb", "committedDate": "2020-12-31T09:34:06Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfbf5b3a62ad7f8395d998ba49564f9939c977d4", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/cfbf5b3a62ad7f8395d998ba49564f9939c977d4", "committedDate": "2020-12-31T11:21:17Z", "message": "Fix invalid file name in Windows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4aeb7b53627cbf62310b856e9713407f10873ad", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/f4aeb7b53627cbf62310b856e9713407f10873ad", "committedDate": "2020-12-31T13:07:18Z", "message": "Merge remote-tracking branch 'origin/master' into envoy/mal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75e552dd685005ed5d2f9f3af65b8d3afdb39daa", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/75e552dd685005ed5d2f9f3af65b8d3afdb39daa", "committedDate": "2020-12-31T13:07:35Z", "message": "Fix test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "75e552dd685005ed5d2f9f3af65b8d3afdb39daa", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/75e552dd685005ed5d2f9f3af65b8d3afdb39daa", "committedDate": "2020-12-31T13:07:35Z", "message": "Fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNDcxMTUx", "url": "https://github.com/apache/skywalking/pull/6091#pullrequestreview-560471151", "createdAt": "2020-12-31T15:32:28Z", "commit": {"oid": "75e552dd685005ed5d2f9f3af65b8d3afdb39daa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQxNTozMjoyOFrOINAM0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQxNTozMjoyOFrOINAM0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDUwNTY4Mw==", "bodyText": "I am good with this name. @hanahmily Please review from tech perspective, especially MAL integration.", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r550505683", "createdAt": "2020-12-31T15:32:28Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-bootstrap/src/main/resources/ui-initialized-templates/istio-dp.yml", "diffHunk": "@@ -0,0 +1,82 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+templates:\n+  - name: \"Istio Data Plane\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75e552dd685005ed5d2f9f3af65b8d3afdb39daa"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNTc3MDU1", "url": "https://github.com/apache/skywalking/pull/6091#pullrequestreview-560577055", "createdAt": "2021-01-01T08:33:25Z", "commit": {"oid": "75e552dd685005ed5d2f9f3af65b8d3afdb39daa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNTc3NjQ5", "url": "https://github.com/apache/skywalking/pull/6091#pullrequestreview-560577649", "createdAt": "2021-01-01T08:52:44Z", "commit": {"oid": "75e552dd685005ed5d2f9f3af65b8d3afdb39daa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNTc3NzM5", "url": "https://github.com/apache/skywalking/pull/6091#pullrequestreview-560577739", "createdAt": "2021-01-01T08:55:41Z", "commit": {"oid": "75e552dd685005ed5d2f9f3af65b8d3afdb39daa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMVQwODo1NTo0MVrOINO-8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMVQwODo1NTo0MVrOINO-8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc0Nzg4OQ==", "bodyText": "Such as this one should be same as ALS did. \n  \n    \n      skywalking/test/e2e/e2e-test/src/test/resources/expected/als/services.yml\n    \n    \n        Lines 16 to 26\n      in\n      1b1f085\n    \n    \n    \n    \n\n        \n          \n           services: \n        \n\n        \n          \n             - key: not null \n        \n\n        \n          \n               label: re(ratings.*) \n        \n\n        \n          \n             - key: not null \n        \n\n        \n          \n               label: re(reviews.*) \n        \n\n        \n          \n             - key: not null \n        \n\n        \n          \n               label: re(productpage.*) \n        \n\n        \n          \n             - key: not null \n        \n\n        \n          \n               label: re(details.*) \n        \n\n        \n          \n             - key: not null \n        \n\n        \n          \n               label: re(istio-ingressgateway.*) \n        \n    \n  \n\n\nMore importantly, the instance name should be pod's name.", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r550747889", "createdAt": "2021-01-01T08:55:41Z", "author": {"login": "wu-sheng"}, "path": "test/e2e/e2e-test/src/test/resources/expected/metricsservice/services.yml", "diffHunk": "@@ -0,0 +1,28 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+services:\n+  - key: not null\n+    label: istio-dp::ratings.default\n+  - key: not null\n+    label: istio-dp::reviews.default\n+  - key: not null\n+    label: istio-dp::productpage.default\n+  - key: not null\n+    label: istio-dp::details.default\n+  - key: not null\n+    label: istio-dp::istio-ingressgateway", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75e552dd685005ed5d2f9f3af65b8d3afdb39daa"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNTc3ODYx", "url": "https://github.com/apache/skywalking/pull/6091#pullrequestreview-560577861", "createdAt": "2021-01-01T08:59:16Z", "commit": {"oid": "75e552dd685005ed5d2f9f3af65b8d3afdb39daa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMVQwODo1OToxNlrOINPAVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMVQwODo1OToxNlrOINPAVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc0ODI0NQ==", "bodyText": "This is the logic we used to do, but I think we should share the ALS logic. Then in future integration, the entity names of sidecar metrics will be as same as the traffic related metrics.", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r550748245", "createdAt": "2021-01-01T08:59:16Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-receiver-plugin/envoy-metrics-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/envoy/MetricServiceGRPCHandler.java", "diffHunk": "@@ -79,17 +93,15 @@ public void onNext(StreamMetricsMessage message) {\n                     isFirst = false;\n                     StreamMetricsMessage.Identifier identifier = message.getIdentifier();\n                     Node node = identifier.getNode();\n-                    if (node != null) {\n-                        String nodeId = node.getId();\n-                        if (!StringUtil.isEmpty(nodeId)) {\n-                            serviceInstanceName = nodeId;\n-                        }\n-                        String cluster = node.getCluster();\n-                        if (!StringUtil.isEmpty(cluster)) {\n-                            serviceName = cluster;\n-                            if (serviceInstanceName == null) {\n-                                serviceInstanceName = serviceName;\n-                            }\n+                    String nodeId = node.getId();\n+                    if (!StringUtil.isEmpty(nodeId)) {\n+                        serviceInstanceName = nodeId;\n+                    }\n+                    String cluster = node.getCluster();\n+                    if (!StringUtil.isEmpty(cluster)) {\n+                        serviceName = cluster;\n+                        if (serviceInstanceName == null) {\n+                            serviceInstanceName = serviceName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75e552dd685005ed5d2f9f3af65b8d3afdb39daa"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9b1f2fbc83d99f0c7b8354546f45fa7e1b0b56a", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/d9b1f2fbc83d99f0c7b8354546f45fa7e1b0b56a", "committedDate": "2021-01-01T14:23:23Z", "message": "Merge branch 'master' into envoy/mal\n\n# Conflicts:\n#\tCHANGES.md\n#\toap-server/server-receiver-plugin/envoy-metrics-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/envoy/EnvoyMetricReceiverProvider.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54efea65c22e316a8679a0f864063501f39e3279", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/54efea65c22e316a8679a0f864063501f39e3279", "committedDate": "2021-01-01T15:18:55Z", "message": "Unify the Service & ServiceInstance names with ALS"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNTkzMDcx", "url": "https://github.com/apache/skywalking/pull/6091#pullrequestreview-560593071", "createdAt": "2021-01-01T15:57:08Z", "commit": {"oid": "54efea65c22e316a8679a0f864063501f39e3279"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMVQxNTo1NzowOFrOINQ_Yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMVQxNTo1NzowOFrOINQ_Yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc4MDc3MQ==", "bodyText": "ServiceMetaInfoAdapter is for meta exchange only, right? Where is the ip-mapping mechanism?", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r550780771", "createdAt": "2021-01-01T15:57:08Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-receiver-plugin/envoy-metrics-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/envoy/MetricServiceGRPCHandler.java", "diffHunk": "@@ -60,111 +69,65 @@ public MetricServiceGRPCHandler(ModuleManager moduleManager) {\n             \"envoy_metric_in_latency\", \"The process latency of service metrics receiver\", MetricsTag.EMPTY_KEY,\n             MetricsTag.EMPTY_VALUE\n         );\n+\n+        final MeterSystem meterSystem = moduleManager.find(CoreModule.NAME).provider().getService(MeterSystem.class);\n+\n+        converters = config.rules()\n+                           .stream()\n+                           .map(rule -> new PrometheusMetricConverter(rule, meterSystem))\n+                           .collect(Collectors.toList());\n     }\n \n     @Override\n     public StreamObserver<StreamMetricsMessage> streamMetrics(StreamObserver<StreamMetricsResponse> responseObserver) {\n         return new StreamObserver<StreamMetricsMessage>() {\n             private volatile boolean isFirst = true;\n-            private String serviceName = null;\n-            private String serviceInstanceName = null;\n+            private ServiceMetaInfo service;\n \n             @Override\n+            @SneakyThrows\n             public void onNext(StreamMetricsMessage message) {\n                 if (log.isDebugEnabled()) {\n                     log.debug(\"Received msg {}\", message);\n                 }\n \n                 if (isFirst) {\n                     isFirst = false;\n-                    StreamMetricsMessage.Identifier identifier = message.getIdentifier();\n-                    Node node = identifier.getNode();\n-                    if (node != null) {\n-                        String nodeId = node.getId();\n-                        if (!StringUtil.isEmpty(nodeId)) {\n-                            serviceInstanceName = nodeId;\n-                        }\n-                        String cluster = node.getCluster();\n-                        if (!StringUtil.isEmpty(cluster)) {\n-                            serviceName = cluster;\n-                            if (serviceInstanceName == null) {\n-                                serviceInstanceName = serviceName;\n-                            }\n-                        }\n-                    }\n-\n-                    if (serviceName == null) {\n-                        serviceName = serviceInstanceName;\n-                    }\n+                    service = new ServiceMetaInfoAdapter(message.getIdentifier().getNode().getMetadata());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54efea65c22e316a8679a0f864063501f39e3279"}, "originalPosition": 99}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNTkzMTk2", "url": "https://github.com/apache/skywalking/pull/6091#pullrequestreview-560593196", "createdAt": "2021-01-01T16:00:33Z", "commit": {"oid": "54efea65c22e316a8679a0f864063501f39e3279"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMVQxNjowMDozNFrOINRAVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMVQxNjowMDozNFrOINRAVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc4MTAxNQ==", "bodyText": "I assume meta-exchange is default ON by today's Istio, right? I think we need to disable it manually?", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r550781015", "createdAt": "2021-01-01T16:00:34Z", "author": {"login": "wu-sheng"}, "path": ".github/workflows/e2e.istio.yaml", "diffHunk": "@@ -129,3 +129,93 @@ jobs:\n       - name: Clean up\n         if: ${{ always() }}\n         run: minikube delete\n+\n+  metrics-service:\n+    runs-on: ubuntu-16.04\n+    timeout-minutes: 60\n+    name: MetricsService\n+    steps:\n+      - uses: actions/checkout@v2\n+        with:\n+          submodules: true\n+\n+      - uses: actions/cache@v2\n+        with:\n+          path: ~/.m2/repository\n+          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}\n+          restore-keys: ${{ runner.os }}-maven-\n+\n+      - name: Build Docker Image\n+        run: make docker\n+\n+      - name: Prepare envrionment\n+        run: bash ${SCRIPTS_DIR}/pre.sh\n+\n+      - name: Install Minikube\n+        run: bash ${SCRIPTS_DIR}/minikube.sh start\n+\n+      - name: Install Istio\n+        run: bash ${SCRIPTS_DIR}/istio.sh --set profile=demo --set meshConfig.defaultConfig.envoyMetricsService.address=skywalking-oap.istio-system:11800", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54efea65c22e316a8679a0f864063501f39e3279"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNjExMTQw", "url": "https://github.com/apache/skywalking/pull/6091#pullrequestreview-560611140", "createdAt": "2021-01-01T23:28:29Z", "commit": {"oid": "54efea65c22e316a8679a0f864063501f39e3279"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMVQyMzoyODozMFrOINTW_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMVQyMzoyODozMFrOINTW_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgxOTU4MA==", "bodyText": "Pls add more unit tests to cover these functions", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r550819580", "createdAt": "2021-01-01T23:28:30Z", "author": {"login": "hanahmily"}, "path": "oap-server/analyzer/meter-analyzer/src/main/java/org/apache/skywalking/oap/meter/analyzer/dsl/SampleFamily.java", "diffHunk": "@@ -161,12 +162,32 @@ public SampleFamily div(SampleFamily another) {\n \n     /* Aggregation operators */\n     public SampleFamily sum(List<String> by) {\n+        return aggregate(by, Double::sum);\n+    }\n+\n+    public SampleFamily max(List<String> by) {\n+        return aggregate(by, Double::max);\n+    }\n+\n+    public SampleFamily min(List<String> by) {\n+        return aggregate(by, Double::min);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54efea65c22e316a8679a0f864063501f39e3279"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71b9ddd8704a0bf4eb1d9549a80f88a7a73f0fbc", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/71b9ddd8704a0bf4eb1d9549a80f88a7a73f0fbc", "committedDate": "2021-01-02T03:11:24Z", "message": "Address review comments, add tests, fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20aae2649a054f4bf14b137edc997a79e418ca44", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/20aae2649a054f4bf14b137edc997a79e418ca44", "committedDate": "2021-01-02T03:57:17Z", "message": "Adjust expected data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f3224e61c8c8acec6a6e992a9b7356149cd8ca0", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/9f3224e61c8c8acec6a6e992a9b7356149cd8ca0", "committedDate": "2021-01-02T04:30:51Z", "message": "Add doc, fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNjIzMjk2", "url": "https://github.com/apache/skywalking/pull/6091#pullrequestreview-560623296", "createdAt": "2021-01-02T06:30:50Z", "commit": {"oid": "9f3224e61c8c8acec6a6e992a9b7356149cd8ca0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMlQwNjozMDo1MFrOINVPIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMlQwNjozMDo1MFrOINVPIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDg1MDMzNw==", "bodyText": "cc @hanahmily Due to share the same node id mechanism, even we don't require header exchange in the metrics service analysis. We will still depend on Istio control. We fetch the name based on that.", "url": "https://github.com/apache/skywalking/pull/6091#discussion_r550850337", "createdAt": "2021-01-02T06:30:50Z", "author": {"login": "wu-sheng"}, "path": "docs/en/setup/envoy/metrics_service_setting.md", "diffHunk": "@@ -39,6 +39,17 @@ A more complete static configuration, can be observed [here](config.yaml).\n \n Note that Envoy can also be configured dynamically through [xDS Protocol](https://github.com/envoyproxy/data-plane-api/blob/master/XDS_PROTOCOL.md).\n \n+**Attention**: Only use this when Envoy is under Istio's control, because SkyWalking needs to parse the service name and service instance name from the metadata that is injected by Istio. However, if you want to use this without Istio, you need to inject the metadata yourself like this:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f3224e61c8c8acec6a6e992a9b7356149cd8ca0"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNjIzMjk5", "url": "https://github.com/apache/skywalking/pull/6091#pullrequestreview-560623299", "createdAt": "2021-01-02T06:30:58Z", "commit": {"oid": "9f3224e61c8c8acec6a6e992a9b7356149cd8ca0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1514, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}