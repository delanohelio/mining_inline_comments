{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1MTI4NjM4", "number": 5046, "title": "Add health checker module", "bodyText": "OAP backend health checker module provides features described in #5034", "createdAt": "2020-07-07T03:43:47Z", "url": "https://github.com/apache/skywalking/pull/5046", "merged": true, "mergeCommit": {"oid": "b6661b5164fac59e754009fa6ef646aaed8929a7"}, "closed": true, "closedAt": "2020-07-09T16:30:44Z", "author": {"login": "hanahmily"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcydbXbAH2gAyNDQ1MTI4NjM4OjQ3ZThiNDA4NTZjYWY4MDI2YTlhYTE4YjlmNDUwOTk0ZDZlNWY1YzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczQ1a5gH2gAyNDQ1MTI4NjM4OjhkZjc3NDZkZDEzMGIwMjRkNDk1MzIyYTIzOGQ4MWNmN2NhNzM1MjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "47e8b40856caf8026a9aa18b9f450994d6e5f5c0", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/47e8b40856caf8026a9aa18b9f450994d6e5f5c0", "committedDate": "2020-07-07T03:39:26Z", "message": "Add health checker module\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62e94109b049554585ceec499d44e7450cdf6708", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/62e94109b049554585ceec499d44e7450cdf6708", "committedDate": "2020-07-07T03:44:01Z", "message": "Merge branch 'master' into health-checker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNjg2MTk0", "url": "https://github.com/apache/skywalking/pull/5046#pullrequestreview-443686194", "createdAt": "2020-07-07T08:45:27Z", "commit": {"oid": "62e94109b049554585ceec499d44e7450cdf6708"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwODo0NToyN1rOGt05kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwODo1Njo0NFrOGt1UBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcwNTgxMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class HealthQuery  implements GraphQLQueryResolver {\n          \n          \n            \n            public class HealthQuery implements GraphQLQueryResolver {", "url": "https://github.com/apache/skywalking/pull/5046#discussion_r450705811", "createdAt": "2020-07-07T08:45:27Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-query-plugin/query-graphql-plugin/src/main/java/org/apache/skywalking/oap/query/graphql/resolver/HealthQuery.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.query.graphql.resolver;\n+\n+import com.coxautodev.graphql.tools.GraphQLQueryResolver;\n+import java.util.Optional;\n+import lombok.RequiredArgsConstructor;\n+import org.apache.skywalking.oap.server.core.query.type.HealthStatus;\n+import org.apache.skywalking.oap.server.health.checker.module.HealthCheckerModule;\n+import org.apache.skywalking.oap.server.health.checker.provider.HealthQueryService;\n+import org.apache.skywalking.oap.server.library.module.ModuleManager;\n+\n+@RequiredArgsConstructor\n+public class HealthQuery  implements GraphQLQueryResolver {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62e94109b049554585ceec499d44e7450cdf6708"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcwNjcxNA==", "bodyText": "score rule should be added as comments.", "url": "https://github.com/apache/skywalking/pull/5046#discussion_r450706714", "createdAt": "2020-07-07T08:46:59Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/query/type/HealthStatus.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.query.type;\n+\n+import lombok.Getter;\n+import lombok.Setter;\n+\n+@Getter\n+@Setter\n+public class HealthStatus {\n+    private int score;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62e94109b049554585ceec499d44e7450cdf6708"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcxMDYzNw==", "bodyText": "I think this is a design issue. Any module should not depend on another module's implementation. Otherwise, you are breaking the design principle.\nFrom the codes level, I think you should say, the user needs to activate the telemetry module, meaning, the provider should not be none or -.", "url": "https://github.com/apache/skywalking/pull/5046#discussion_r450710637", "createdAt": "2020-07-07T08:53:33Z", "author": {"login": "wu-sheng"}, "path": "docs/en/setup/backend/backend-health-check.md", "diffHunk": "@@ -0,0 +1,62 @@\n+# Health Check\n+\n+Health check intends to provide a unique approach to check the healthy status of OAP server. It includes the health status\n+of modules, GraphQL and gRPC services readiness.\n+\n+## Health Checker Module.\n+\n+Health Checker module could solute how to observe the health status of modules. We can active it by below:\n+```yaml\n+health-checker:\n+  selector: ${SW_HEALTH_CHECKER:default}\n+  default:\n+    checkIntervalSeconds: ${SW_HEALTH_CHECKER_INTERVAL_SECONDS:5}\n+```\n+Notice, we should enable `prometheus` telemetry at the same time.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62e94109b049554585ceec499d44e7450cdf6708"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcxMTIyNQ==", "bodyText": "Why always 1? According to your doc, 1 should mean unhealthy? I think you missed some codes.", "url": "https://github.com/apache/skywalking/pull/5046#discussion_r450711225", "createdAt": "2020-07-07T08:54:31Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-jdbc-hikaricp-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/jdbc/h2/H2StorageProvider.java", "diffHunk": "@@ -131,6 +135,9 @@ public void prepare() throws ServiceNotProvidedException, ModuleStartException {\n \n     @Override\n     public void start() throws ServiceNotProvidedException, ModuleStartException {\n+        MetricsCreator metricCreator = getManager().find(TelemetryModule.NAME).provider().getService(MetricsCreator.class);\n+        GaugeMetrics healthChecker = metricCreator.createHealthCheckerGauge(\"storage_h2\", MetricsTag.EMPTY_KEY, MetricsTag.EMPTY_VALUE);\n+        healthChecker.setValue(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62e94109b049554585ceec499d44e7450cdf6708"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcxMjU4Mg==", "bodyText": "I don't think health guage requires the tag/value(s).", "url": "https://github.com/apache/skywalking/pull/5046#discussion_r450712582", "createdAt": "2020-07-07T08:56:44Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-telemetry/telemetry-api/src/main/java/org/apache/skywalking/oap/server/telemetry/api/MetricsCreator.java", "diffHunk": "@@ -42,4 +46,30 @@\n      */\n     HistogramMetrics createHistogramMetric(String name, String tips, MetricsTag.Keys tagKeys,\n         MetricsTag.Values tagValues, double... buckets);\n+\n+    /**\n+     * Create a Health Check gauge.\n+     */\n+    default GaugeMetrics createHealthCheckerGauge(String name, MetricsTag.Keys tagKeys, MetricsTag.Values tagValues) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62e94109b049554585ceec499d44e7450cdf6708"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f97e24a2057282b9fd16cce65ae758ad953ec90", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/5f97e24a2057282b9fd16cce65ae758ad953ec90", "committedDate": "2020-07-07T14:11:44Z", "message": "Merge branch 'master' into health-checker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MzYyMzAx", "url": "https://github.com/apache/skywalking/pull/5046#pullrequestreview-444362301", "createdAt": "2020-07-08T02:00:28Z", "commit": {"oid": "5f97e24a2057282b9fd16cce65ae758ad953ec90"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMjowMDoyOFrOGuVc9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMjoxMjoxM1rOGuVo0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIzOTE1Ng==", "bodyText": "+1 \"Any module should not depend on another module's implementation. \"", "url": "https://github.com/apache/skywalking/pull/5046#discussion_r451239156", "createdAt": "2020-07-08T02:00:28Z", "author": {"login": "kezhenxu94"}, "path": "docs/en/setup/backend/backend-health-check.md", "diffHunk": "@@ -0,0 +1,62 @@\n+# Health Check\n+\n+Health check intends to provide a unique approach to check the healthy status of OAP server. It includes the health status\n+of modules, GraphQL and gRPC services readiness.\n+\n+## Health Checker Module.\n+\n+Health Checker module could solute how to observe the health status of modules. We can active it by below:\n+```yaml\n+health-checker:\n+  selector: ${SW_HEALTH_CHECKER:default}\n+  default:\n+    checkIntervalSeconds: ${SW_HEALTH_CHECKER_INTERVAL_SECONDS:5}\n+```\n+Notice, we should enable `prometheus` telemetry at the same time.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcxMDYzNw=="}, "originalCommit": {"oid": "62e94109b049554585ceec499d44e7450cdf6708"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI0MjEyNg==", "bodyText": "Why always 1? According to your doc, 1 should mean unhealthy? I think you missed some codes.\n\nThis may be the initial status \"unhealthy\", and after the connection is established (line 142-145), the value should be set to 0, so I reckon the line at 149 should be healthChecker.setValue(0);? @hanahmily", "url": "https://github.com/apache/skywalking/pull/5046#discussion_r451242126", "createdAt": "2020-07-08T02:11:58Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-storage-plugin/storage-jdbc-hikaricp-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/jdbc/h2/H2StorageProvider.java", "diffHunk": "@@ -131,6 +135,9 @@ public void prepare() throws ServiceNotProvidedException, ModuleStartException {\n \n     @Override\n     public void start() throws ServiceNotProvidedException, ModuleStartException {\n+        MetricsCreator metricCreator = getManager().find(TelemetryModule.NAME).provider().getService(MetricsCreator.class);\n+        GaugeMetrics healthChecker = metricCreator.createHealthCheckerGauge(\"storage_h2\", MetricsTag.EMPTY_KEY, MetricsTag.EMPTY_VALUE);\n+        healthChecker.setValue(1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcxMTIyNQ=="}, "originalCommit": {"oid": "62e94109b049554585ceec499d44e7450cdf6708"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI0MjE5NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    healthChecker.setValue(1);\n          \n          \n            \n                    healthChecker.setValue(0);", "url": "https://github.com/apache/skywalking/pull/5046#discussion_r451242194", "createdAt": "2020-07-08T02:12:13Z", "author": {"login": "kezhenxu94"}, "path": "oap-server/server-storage-plugin/storage-jdbc-hikaricp-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/jdbc/h2/H2StorageProvider.java", "diffHunk": "@@ -139,6 +146,7 @@ public void start() throws ServiceNotProvidedException, ModuleStartException {\n         } catch (StorageException e) {\n             throw new ModuleStartException(e.getMessage(), e);\n         }\n+        healthChecker.setValue(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f97e24a2057282b9fd16cce65ae758ad953ec90"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d394cfb828f406f2a743e2cb62a507e2e790876", "author": {"user": {"login": "kezhenxu94", "name": "kezhenxu94"}}, "url": "https://github.com/apache/skywalking/commit/8d394cfb828f406f2a743e2cb62a507e2e790876", "committedDate": "2020-07-08T02:23:56Z", "message": "Merge branch 'master' into health-checker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14a22df447b0a9630c8aa353b52cc36887306467", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/14a22df447b0a9630c8aa353b52cc36887306467", "committedDate": "2020-07-09T04:31:06Z", "message": "Update JDBC health check\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "988c3fe6c40625b7f5161599ee161e59bb9a2258", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/988c3fe6c40625b7f5161599ee161e59bb9a2258", "committedDate": "2020-07-09T04:36:29Z", "message": "Merge branch 'master' into health-checker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f591fe45644c668dc2303dfd0aaa16989001ac5a", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/f591fe45644c668dc2303dfd0aaa16989001ac5a", "committedDate": "2020-07-09T04:41:12Z", "message": "Update docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "139b1615270d507c37bc602c49cf4c3fd6335634", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/139b1615270d507c37bc602c49cf4c3fd6335634", "committedDate": "2020-07-09T04:45:55Z", "message": "Merge branch 'health-checker' of github.com:apache/skywalking into health-checker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e90190f99c7a7f2f5c8838908b5f2f082a94648e", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/e90190f99c7a7f2f5c8838908b5f2f082a94648e", "committedDate": "2020-07-09T04:46:03Z", "message": "Some nits\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eed2fa76c15db87be7f1d54c3f116c2e76040b66", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/eed2fa76c15db87be7f1d54c3f116c2e76040b66", "committedDate": "2020-07-09T04:48:24Z", "message": "Remove changs of UI\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa94eb902692978da84a7f6bf75062b70931d02a", "author": {"user": {"login": "hanahmily", "name": "Gao Hongtao"}}, "url": "https://github.com/apache/skywalking/commit/aa94eb902692978da84a7f6bf75062b70931d02a", "committedDate": "2020-07-09T14:54:40Z", "message": "fix CI issues\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NzEwNDU2", "url": "https://github.com/apache/skywalking/pull/5046#pullrequestreview-445710456", "createdAt": "2020-07-09T15:08:13Z", "commit": {"oid": "aa94eb902692978da84a7f6bf75062b70931d02a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8df7746dd130b024d495322a238d81cf7ca73526", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/8df7746dd130b024d495322a238d81cf7ca73526", "committedDate": "2020-07-09T15:33:03Z", "message": "Merge branch 'master' into health-checker"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2055, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}