{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNDgwNjc5", "number": 5637, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNToxMjo0NlrOEsF5bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNToyNzo0NVrOEsGRXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NjY5NDIzOnYy", "diffSide": "RIGHT", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNToxMjo0NlrOHfOIAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwNDoyMjo0MlrOHfdD7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ5OTMyOA==", "bodyText": "Grammar related exceptions seem unhealth to me. @hanahmily What do you think?", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502499328", "createdAt": "2020-10-09T15:12:46Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -205,4 +230,20 @@ public static TimeInterval timeIntervalTS(long timestamp) {\n     public static TimeInterval timeIntervalTB(long timeBucket) {\n         return ti(TimeBucket.getTimestamp(timeBucket), \"ms\");\n     }\n+\n+    @Override\n+    public void registerChecker(HealthChecker healthChecker) {\n+        this.healthChecker.register(healthChecker);\n+    }\n+\n+    /**\n+     * Check influx health, Ignore grammar related exception\n+     */\n+    private void checkHealth(Throwable e) {\n+        if (e instanceof InfluxDBIOException) {\n+            healthChecker.unHealth(e);\n+        } else if (!(e instanceof InfluxDBException)) {\n+            healthChecker.unHealth(e);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 166}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0NDA0NA==", "bodyText": "done", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502744044", "createdAt": "2020-10-10T04:22:42Z", "author": {"login": "xbkaishui"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -205,4 +230,20 @@ public static TimeInterval timeIntervalTS(long timestamp) {\n     public static TimeInterval timeIntervalTB(long timeBucket) {\n         return ti(TimeBucket.getTimestamp(timeBucket), \"ms\");\n     }\n+\n+    @Override\n+    public void registerChecker(HealthChecker healthChecker) {\n+        this.healthChecker.register(healthChecker);\n+    }\n+\n+    /**\n+     * Check influx health, Ignore grammar related exception\n+     */\n+    private void checkHealth(Throwable e) {\n+        if (e instanceof InfluxDBIOException) {\n+            healthChecker.unHealth(e);\n+        } else if (!(e instanceof InfluxDBException)) {\n+            healthChecker.unHealth(e);\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ5OTMyOA=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 166}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0Njc0MDIzOnYy", "diffSide": "RIGHT", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "isResolved": false, "comments": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNToyNDoxNVrOHfOkKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwMjozNjo0NVrOHgTUjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg==", "bodyText": "The test of result.hasError is dropped. Maybe some errors are ignored. Pls double check whether it leaves out them.", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502506536", "createdAt": "2020-10-09T15:24:15Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0Mzc4Ng==", "bodyText": "I have checked the source code of influx client,\nwhen some errors happens it will throw an exception, no need to check the hasError method", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502743786", "createdAt": "2020-10-10T04:19:25Z", "author": {"login": "xbkaishui"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg4ODg1MQ==", "bodyText": "@dmsolr Could you confirm the status? Is there some case there could be some errors w/o exception?", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502888851", "createdAt": "2020-10-11T09:15:05Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE5ODU0MQ==", "bodyText": "hi @xbkaishui\nI had test some cases. The result show following\n\nsyntax error/parse error, connection, etc will throw an exception.\naggregate function error maybe doesn't throw.\n\nFor example:\n\ncase 1\n\nQuery: SELECT mean(\"square\"),\"round\" FROM \"peg\"\nResponse: QueryResult [results=[Result [series=null, error=mixing aggregate and non-aggregate queries is not supported]], error=null]\n\n\ncase 2\n\nQuery: SELECT sum(\"square\", 2),\"round\" FROM \"peg\"\n\nResponse: [results=[Result [series=null, error=invalid number of arguments for mean, expected 1, got 2]], error=null]\n\nThese two examples put error messages in clauses only. :(", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503198541", "createdAt": "2020-10-12T10:29:02Z", "author": {"login": "dmsolr"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzIwMTU4NQ==", "bodyText": "I am not sure that is wrong what I did before. But we need to consider this scenario, right?", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503201585", "createdAt": "2020-10-12T10:34:54Z", "author": {"login": "dmsolr"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI3MjUxMQ==", "bodyText": "Nop, for below sql , in the java client it will throws an exception.  did you use the java client to test ?", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503272511", "createdAt": "2020-10-12T12:48:44Z", "author": {"login": "xbkaishui"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI3NjA4NA==", "bodyText": "please check me test code gist", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503276084", "createdAt": "2020-10-12T12:54:55Z", "author": {"login": "xbkaishui"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI3NjY3NA==", "bodyText": "@xbkaishui I am curious if all things go through exception, why InfluxDB Java client designs that API? In case the exception has been caught?", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503276674", "createdAt": "2020-10-12T12:55:51Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI4MDgxOA==", "bodyText": "from what I test, the error msg is wrapper as an exception in java client", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503280818", "createdAt": "2020-10-12T13:02:37Z", "author": {"login": "xbkaishui"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI4MTAxMw==", "bodyText": "Maybe other client has different implement.", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503281013", "createdAt": "2020-10-12T13:03:00Z", "author": {"login": "xbkaishui"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI4MjA4MQ==", "bodyText": "from what I test, the error msg is wrapper as an exception in java client\n\nOK, if so, that we may be able to remove the codes. But in another hand, to do the check seems harmless :)", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503282081", "createdAt": "2020-10-12T13:04:50Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQxNzI0MQ==", "bodyText": "I've read your code. I think have some issue.\npublic static void main(String[] args) {\n    final InfluxDB influxDB = InfluxDBFactory.connect(\"http://127.0.0.1:8086\");\n    String databaseName = \"NOAA_water_database\";\n    try {\n        QueryResult result = influxDB.query(new Query(\"SELECT sum(\\\"square\\\", 2),\\\"round\\\" FROM \\\"peg\\\"\\n\" +\n                                                          \";\" + databaseName)); // There is syntax issue, so InfluxDB Client throws an exception. You don't need to append `+ \";\" + databaseName`.\n        String error = result.getError();\n        System.out.println(error);\n        influxDB.setDatabase(databaseName);\n    } catch (Throwable e) {\n        e.printStackTrace();\n    }\n}\nYou could try the following code.\ntry {\n    influxDB.setDatabase(databaseName);\n    QueryResult result = influxDB.query(new Query(\"SELECT sum(\\\"square\\\", 2),\\\"round\\\" FROM \\\"peg\\\"\\n\"));\n    result.hasError(); // it is false.\n    result.getError(); // null\n\n    result.getResults().forEach(series -> {\n        series.hasError(); // it is true\n        series.getError(); // error message\n    });\n} catch (Throwable e) {\n    e.printStackTrace();\n}", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503417241", "createdAt": "2020-10-12T16:49:23Z", "author": {"login": "dmsolr"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMTkyMg==", "bodyText": "Syntax errors can be detected by the client, so the exception is thrown directly.\nSome errors, like aggregate function wrong, do not throw the exception.", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503421922", "createdAt": "2020-10-12T16:58:04Z", "author": {"login": "dmsolr"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU5ODQ0NQ==", "bodyText": "Syntax errors can be detected by the client, so the exception is thrown directly.\nSome errors, like aggregate function wrong, do not throw the exception.\n\nbut for the aggregate function, the hasError return false, it will not throws an exception using the orginal code, so the check error logic is take no effect  right ?", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503598445", "createdAt": "2020-10-13T00:12:48Z", "author": {"login": "xbkaishui"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU5OTI1MQ==", "bodyText": "I will revert my changes. thanks", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503599251", "createdAt": "2020-10-13T00:15:56Z", "author": {"login": "xbkaishui"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYwMTEyOA==", "bodyText": "done", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503601128", "createdAt": "2020-10-13T00:23:28Z", "author": {"login": "xbkaishui"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYyNDE0Mw==", "bodyText": "but for the aggregate function, the hasError return false, it will not throws an exception using the orginal code, so the check error logic is take no effect right ?\n\nIt is basically right. Would you like to fix it in this PR?", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503624143", "createdAt": "2020-10-13T02:00:10Z", "author": {"login": "dmsolr"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYzMzAzOA==", "bodyText": "Do you mean also check the child resuts error ?", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503633038", "createdAt": "2020-10-13T02:36:45Z", "author": {"login": "xbkaishui"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0Njc0MjI1OnYy", "diffSide": "RIGHT", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNToyNDo0N1rOHfOlYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwMDoyNDoxMFrOHgRYpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjg0OA==", "bodyText": "Ditto", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502506848", "createdAt": "2020-10-09T15:24:47Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -161,11 +172,7 @@ public int getCounter(Query query) throws IOException {\n      */\n     public void dropSeries(String measurement, long timeBucket) throws IOException {\n         Query query = new Query(\"DROP SERIES FROM \" + measurement + \" WHERE time_bucket='\" + timeBucket + \"'\");\n-        QueryResult result = getInflux().query(query);\n-\n-        if (result.hasError()) {\n-            throw new IOException(\"Statement: \" + query.getCommand() + \", ErrorMsg: \" + result.getError());\n-        }\n+        this.query(query);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0NDA2OQ==", "bodyText": "Same comment as above", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502744069", "createdAt": "2020-10-10T04:23:06Z", "author": {"login": "xbkaishui"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -161,11 +172,7 @@ public int getCounter(Query query) throws IOException {\n      */\n     public void dropSeries(String measurement, long timeBucket) throws IOException {\n         Query query = new Query(\"DROP SERIES FROM \" + measurement + \" WHERE time_bucket='\" + timeBucket + \"'\");\n-        QueryResult result = getInflux().query(query);\n-\n-        if (result.hasError()) {\n-            throw new IOException(\"Statement: \" + query.getCommand() + \", ErrorMsg: \" + result.getError());\n-        }\n+        this.query(query);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjg0OA=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYwMTMxOQ==", "bodyText": "Done, this.query already checked the hasError logic, no need to check again", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503601319", "createdAt": "2020-10-13T00:24:10Z", "author": {"login": "xbkaishui"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -161,11 +172,7 @@ public int getCounter(Query query) throws IOException {\n      */\n     public void dropSeries(String measurement, long timeBucket) throws IOException {\n         Query query = new Query(\"DROP SERIES FROM \" + measurement + \" WHERE time_bucket='\" + timeBucket + \"'\");\n-        QueryResult result = getInflux().query(query);\n-\n-        if (result.hasError()) {\n-            throw new IOException(\"Statement: \" + query.getCommand() + \", ErrorMsg: \" + result.getError());\n-        }\n+        this.query(query);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjg0OA=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0Njc1NTQ4OnYy", "diffSide": "RIGHT", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNToyNzo0NVrOHfOtIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwNDoxOTo1MVrOHfdDDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwODgzNQ==", "bodyText": "Why do you ignore grammar relevant errors? They would indicate the version mismatches between OAP and influxdb server.", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502508835", "createdAt": "2020-10-09T15:27:45Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -205,4 +230,20 @@ public static TimeInterval timeIntervalTS(long timestamp) {\n     public static TimeInterval timeIntervalTB(long timeBucket) {\n         return ti(TimeBucket.getTimestamp(timeBucket), \"ms\");\n     }\n+\n+    @Override\n+    public void registerChecker(HealthChecker healthChecker) {\n+        this.healthChecker.register(healthChecker);\n+    }\n+\n+    /**\n+     * Check influx health, Ignore grammar related exception", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0MzgyMA==", "bodyText": "ok will change", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502743820", "createdAt": "2020-10-10T04:19:51Z", "author": {"login": "xbkaishui"}, "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -205,4 +230,20 @@ public static TimeInterval timeIntervalTS(long timestamp) {\n     public static TimeInterval timeIntervalTB(long timeBucket) {\n         return ti(TimeBucket.getTimestamp(timeBucket), \"ms\");\n     }\n+\n+    @Override\n+    public void registerChecker(HealthChecker healthChecker) {\n+        this.healthChecker.register(healthChecker);\n+    }\n+\n+    /**\n+     * Check influx health, Ignore grammar related exception", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwODgzNQ=="}, "originalCommit": {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20"}, "originalPosition": 159}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4885, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}