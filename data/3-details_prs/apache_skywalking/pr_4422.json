{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNjAyMzIz", "number": 4422, "title": "Support ref endpoint name register", "bodyText": "The ref exchange is changing since we apply the change in 6.6.0\n\nSince 6.6.0 The endpoint in the ref should be server endpoint only. The agent will/should use -1, when it can't find the endpoint of entry span in the current tracing context when build the ref.\nSince 5.0 Endpoint in ref could be local or exit span's operation name. Especially if it is local span operation name, * exchange may not happen at agent, such as Java agent, then put literal endpoint string in the header, Need to try * to get the id by assuming the endpoint name is detected at server, local or client. If agent does the exchange, then always use endpoint id.", "createdAt": "2020-02-27T02:21:35Z", "url": "https://github.com/apache/skywalking/pull/4422", "merged": true, "mergeCommit": {"oid": "58a787f9e1ca4dba37446754c08852e42e632ab0"}, "closed": true, "closedAt": "2020-02-27T03:06:14Z", "author": {"login": "wu-sheng"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIRwmmgH2gAyMzgwNjAyMzIzOjU2YWUyNmEwYjFmZTMyYzhkZmU4ZWM1YzhlYTcxNmJiMWE3Yzg5MWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcISIf5gFqTM2NTM4MjU2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "56ae26a0b1fe32c8dfe8ec5c8ea716bb1a7c891b", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/56ae26a0b1fe32c8dfe8ec5c8ea716bb1a7c891b", "committedDate": "2020-02-27T02:18:57Z", "message": "Support ref endpoint name register"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1Mzc3MTY1", "url": "https://github.com/apache/skywalking/pull/4422#pullrequestreview-365377165", "createdAt": "2020-02-27T02:26:05Z", "commit": {"oid": "56ae26a0b1fe32c8dfe8ec5c8ea716bb1a7c891b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMjoyNjowNVrOFvDQ4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMjoyNjowNVrOFvDQ4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg4MDg2Ng==", "bodyText": "It should be Client in Ref, right?", "url": "https://github.com/apache/skywalking/pull/4422#discussion_r384880866", "createdAt": "2020-02-27T02:26:05Z", "author": {"login": "arugal"}, "path": "oap-server/server-receiver-plugin/skywalking-trace-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/trace/provider/parser/standardization/ReferenceIdExchanger.java", "diffHunk": "@@ -139,29 +139,19 @@ public boolean exchange(ReferenceDecorator standardBuilder, int serviceId) {\n                 standardBuilder.setNetworkAddressId(networkAddressId);\n                 standardBuilder.setNetworkAddress(Const.EMPTY_STRING);\n             }\n-        } else {\n-            /**\n-             * Since 6.6.0, endpoint id could be -1, as it is not an endpoint. Such as local span and exist span.\n-             */\n         }\n         return exchanged;\n     }\n \n     /**\n-     * Endpoint in ref could be local or exit span's operation name. Especially if it is local span operation name,\n-     * exchange may not happen at agent, such as Java agent, then put literal endpoint string in the header, Need to try\n-     * to get the id by assuming the endpoint name is detected at server, local or client.\n-     * <p>\n-     * If agent does the exchange, then always use endpoint id.\n+     * @since 6.6.0 The endpoint in the ref should be server endpoint only. The agent will/should use `-1`, when it can't\n+     * find the endpoint of entry span in the current tracing context when build the ref.\n+     * @since 5.0 Endpoint in ref could be local or exit span's operation name. Especially if it is local span operation\n+     * name, * exchange may not happen at agent, such as Java agent, then put literal endpoint string in the header,\n+     * Need to try * to get the id by assuming the endpoint name is detected at server, local or client. * <p> * If\n+     * agent does the exchange, then always use endpoint id.\n      */\n     private int getEndpointId(int serviceId, String endpointName) {\n-        int endpointId = endpointInventoryRegister.get(serviceId, endpointName, DetectPoint.SERVER.ordinal());\n-        if (endpointId == Const.NONE) {\n-            endpointId = endpointInventoryRegister.get(serviceId, endpointName, DetectPoint.CLIENT.ordinal());\n-            if (endpointId == Const.NONE) {\n-                endpointId = endpointInventoryRegister.get(serviceId, endpointName, DetectPoint.UNRECOGNIZED.ordinal());\n-            }\n-        }\n-        return endpointId;\n+        return endpointInventoryRegister.getOrCreate(serviceId, endpointName, DetectPoint.SERVER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56ae26a0b1fe32c8dfe8ec5c8ea716bb1a7c891b"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MzgyNTY4", "url": "https://github.com/apache/skywalking/pull/4422#pullrequestreview-365382568", "createdAt": "2020-02-27T02:45:03Z", "commit": {"oid": "56ae26a0b1fe32c8dfe8ec5c8ea716bb1a7c891b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2394, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}