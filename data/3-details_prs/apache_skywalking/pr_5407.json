{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1MjAxMTIy", "number": 5407, "title": "Save error trace segment even that segment will abandoned by sampling mechanism", "bodyText": "\u2026 side trace sampling mechanism.\nPlease answer these questions before submitting a pull request\n\n\nWhy submit this pull request?\n\n\n Bug fix\n\n\n New feature provided\n\n\n Improve performance\n\n\nRelated issues\n\n\n\nBug fix\n\n\nBug description.\n\n\nHow to fix?\nWhen open server side trace sampling mechanism, the actual sampleRate will above sampleRate. Because we want some error segment will be saved, even that segment will abandoned by server side trace sampling mechanism. may be miss some other trace segments, but we can analyze this error segment to solve problem.\n\n\n\nNew feature or improvement\n\nDescribe the details and related test reports.", "createdAt": "2020-08-28T06:50:00Z", "url": "https://github.com/apache/skywalking/pull/5407", "merged": true, "mergeCommit": {"oid": "6227db19cd057512e3a97312cdfd0ebf688b74d5"}, "closed": true, "closedAt": "2020-08-28T12:37:20Z", "author": {"login": "zifeihan"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDPPXXAH2gAyNDc1MjAxMTIyOjM4Mzc0MjVmYWUzNDJmY2NlY2ViYmNjYzY3MDQxOGM4M2NlMmY0NjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDUSNeAFqTQ3NzY5MTU4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3837425fae342fccecebbccc670418c83ce2f461", "author": {"user": {"login": "zifeihan", "name": "zifeihan"}}, "url": "https://github.com/apache/skywalking/commit/3837425fae342fccecebbccc670418c83ce2f461", "committedDate": "2020-08-28T06:44:22Z", "message": "Save some error trace segment, event this segment abandoned by server side trace sampling mechanism."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ee67b39083369c1d1795c2f171820f45ab53c18", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/1ee67b39083369c1d1795c2f171820f45ab53c18", "committedDate": "2020-08-28T06:53:17Z", "message": "Merge branch 'master' into hanfei"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MzE4MzY4", "url": "https://github.com/apache/skywalking/pull/5407#pullrequestreview-477318368", "createdAt": "2020-08-28T06:59:18Z", "commit": {"oid": "3837425fae342fccecebbccc670418c83ce2f461"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwNjo1OToxOVrOHIr3VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwNjo1OTo0NlrOHIr35w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg2OTMzMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            When you open sampling, the actual sampleRate will above sampleRate. Because we want some error segment will be saved, even that segment will abandoned by server side trace sampling mechanism. may be miss some other trace segments, but we can analyze this error segment to solve problem.\n          \n          \n            \n            When you open sampling, the actual sample rate could be over sampleRate. Because currently, all error segments will be saved, meanwhile, the upstream and downstream may not be sampled. This feature is going to make sure you could have the error stacks and segments, but don't guarantee you would have the whole trace.\n          \n          \n            \n            \n          \n          \n            \n            Also, the side effect would be, if most of the accesses are fail, the sampling rate would be closing to 100%, which could crash the backend or storage clusters.", "url": "https://github.com/apache/skywalking/pull/5407#discussion_r478869333", "createdAt": "2020-08-28T06:59:19Z", "author": {"login": "wu-sheng"}, "path": "docs/en/setup/backend/trace-sampling.md", "diffHunk": "@@ -30,4 +30,8 @@ When you set the rate different, let's say\n And we assume the agents reported all trace segments to backend,\n Then the 35% traces in the global will be collected and saved in storage consistent/complete, with all spans.\n 20% trace segments, which reported to Backend-Instance**B**, will saved in storage, maybe miss some trace segments,\n-because they are reported to Backend-Instance**A** and ignored.\n\\ No newline at end of file\n+because they are reported to Backend-Instance**A** and ignored.\n+\n+# Note\n+When you open sampling, the actual sampleRate will above sampleRate. Because we want some error segment will be saved, even that segment will abandoned by server side trace sampling mechanism. may be miss some other trace segments, but we can analyze this error segment to solve problem.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3837425fae342fccecebbccc670418c83ce2f461"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg2OTQ3OQ==", "bodyText": "Try to provide a configuration to disable this feature, this could be default open as the harm is limited.", "url": "https://github.com/apache/skywalking/pull/5407#discussion_r478869479", "createdAt": "2020-08-28T06:59:46Z", "author": {"login": "wu-sheng"}, "path": "docs/en/setup/backend/trace-sampling.md", "diffHunk": "@@ -30,4 +30,8 @@ When you set the rate different, let's say\n And we assume the agents reported all trace segments to backend,\n Then the 35% traces in the global will be collected and saved in storage consistent/complete, with all spans.\n 20% trace segments, which reported to Backend-Instance**B**, will saved in storage, maybe miss some trace segments,\n-because they are reported to Backend-Instance**A** and ignored.\n\\ No newline at end of file\n+because they are reported to Backend-Instance**A** and ignored.\n+\n+# Note\n+When you open sampling, the actual sampleRate will above sampleRate. Because we want some error segment will be saved, even that segment will abandoned by server side trace sampling mechanism. may be miss some other trace segments, but we can analyze this error segment to solve problem.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg2OTMzMw=="}, "originalCommit": {"oid": "3837425fae342fccecebbccc670418c83ce2f461"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "333590edf01fc4f32623a1f04efdd7752c180d89", "author": {"user": {"login": "zifeihan", "name": "zifeihan"}}, "url": "https://github.com/apache/skywalking/commit/333590edf01fc4f32623a1f04efdd7752c180d89", "committedDate": "2020-08-28T07:56:36Z", "message": "Support forceSaveErrorSegment config to control force save some error segment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24656c4d15823c929181124f02646d61dfeeff31", "author": {"user": {"login": "zifeihan", "name": "zifeihan"}}, "url": "https://github.com/apache/skywalking/commit/24656c4d15823c929181124f02646d61dfeeff31", "committedDate": "2020-08-28T07:58:26Z", "message": "Merge remote-tracking branch 'origin/hanfei' into hanfei"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NDk1Nzcz", "url": "https://github.com/apache/skywalking/pull/5407#pullrequestreview-477495773", "createdAt": "2020-08-28T08:22:06Z", "commit": {"oid": "24656c4d15823c929181124f02646d61dfeeff31"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwODoyMjowNlrOHIvwIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwODoyNzo1MlrOHIwGOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODkzMzAyNQ==", "bodyText": "This document change should be accepted.", "url": "https://github.com/apache/skywalking/pull/5407#discussion_r478933025", "createdAt": "2020-08-28T08:22:06Z", "author": {"login": "wu-sheng"}, "path": "docs/en/setup/backend/trace-sampling.md", "diffHunk": "@@ -30,4 +30,8 @@ When you set the rate different, let's say\n And we assume the agents reported all trace segments to backend,\n Then the 35% traces in the global will be collected and saved in storage consistent/complete, with all spans.\n 20% trace segments, which reported to Backend-Instance**B**, will saved in storage, maybe miss some trace segments,\n-because they are reported to Backend-Instance**A** and ignored.\n\\ No newline at end of file\n+because they are reported to Backend-Instance**A** and ignored.\n+\n+# Note\n+When you open sampling, the actual sampleRate will above sampleRate. Because we want some error segment will be saved, even that segment will abandoned by server side trace sampling mechanism. may be miss some other trace segments, but we can analyze this error segment to solve problem.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg2OTMzMw=="}, "originalCommit": {"oid": "3837425fae342fccecebbccc670418c83ce2f461"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODkzMzI4Mg==", "bodyText": "forceSaveErrorSegment -> forceSampleErrorSegment", "url": "https://github.com/apache/skywalking/pull/5407#discussion_r478933282", "createdAt": "2020-08-28T08:22:24Z", "author": {"login": "wu-sheng"}, "path": "oap-server/analyzer/agent-analyzer/src/main/java/org/apache/skywalking/oap/server/analyzer/provider/AnalyzerModuleConfig.java", "diffHunk": "@@ -78,4 +78,12 @@\n \n     @Getter\n     private final String configPath = \"meter-receive-config\";\n+\n+    /**\n+     * When open sampling, true means some error segment will be saved, even that segment will abandoned by server side trace sampling mechanism.\n+     * false means all segment saved condition by server side trace sampling mechanism.\n+     */\n+    @Setter\n+    @Getter\n+    private boolean forceSaveErrorSegment = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24656c4d15823c929181124f02646d61dfeeff31"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODkzODAxOQ==", "bodyText": "This will be always true in default, as forceSaveErrorSegment == true. I think you mischanged this?", "url": "https://github.com/apache/skywalking/pull/5407#discussion_r478938019", "createdAt": "2020-08-28T08:27:16Z", "author": {"login": "wu-sheng"}, "path": "oap-server/analyzer/agent-analyzer/src/main/java/org/apache/skywalking/oap/server/analyzer/provider/trace/parser/listener/SegmentAnalysisListener.java", "diffHunk": "@@ -153,6 +142,14 @@ public void parseSegment(SegmentObject segmentObject) {\n         });\n         final long accurateDuration = endTimestamp - startTimestamp;\n         duration = accurateDuration > Integer.MAX_VALUE ? Integer.MAX_VALUE : (int) accurateDuration;\n+\n+        if (sampleStatus.equals(SAMPLE_STATUS.UNKNOWN) || sampleStatus.equals(SAMPLE_STATUS.IGNORE)) {\n+            if (sampler.shouldSample(segmentObject.getTraceId()) || forceSaveErrorSegment) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24656c4d15823c929181124f02646d61dfeeff31"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODkzODY4MA==", "bodyText": "You should isError && forceSaveErrorSegment from my understanding, isn't it?", "url": "https://github.com/apache/skywalking/pull/5407#discussion_r478938680", "createdAt": "2020-08-28T08:27:52Z", "author": {"login": "wu-sheng"}, "path": "oap-server/analyzer/agent-analyzer/src/main/java/org/apache/skywalking/oap/server/analyzer/provider/trace/parser/listener/SegmentAnalysisListener.java", "diffHunk": "@@ -153,6 +142,14 @@ public void parseSegment(SegmentObject segmentObject) {\n         });\n         final long accurateDuration = endTimestamp - startTimestamp;\n         duration = accurateDuration > Integer.MAX_VALUE ? Integer.MAX_VALUE : (int) accurateDuration;\n+\n+        if (sampleStatus.equals(SAMPLE_STATUS.UNKNOWN) || sampleStatus.equals(SAMPLE_STATUS.IGNORE)) {\n+            if (sampler.shouldSample(segmentObject.getTraceId()) || forceSaveErrorSegment) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODkzODAxOQ=="}, "originalCommit": {"oid": "24656c4d15823c929181124f02646d61dfeeff31"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72c8735c63c06e8da257bec6f5b4ea2061f0a41a", "author": {"user": {"login": "zifeihan", "name": "zifeihan"}}, "url": "https://github.com/apache/skywalking/commit/72c8735c63c06e8da257bec6f5b4ea2061f0a41a", "committedDate": "2020-08-28T08:47:08Z", "message": "Polishing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NTk2NTk0", "url": "https://github.com/apache/skywalking/pull/5407#pullrequestreview-477596594", "createdAt": "2020-08-28T09:49:42Z", "commit": {"oid": "72c8735c63c06e8da257bec6f5b4ea2061f0a41a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwOTo0OTo0MlrOHI2lzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwOTo0OTo0MlrOHI2lzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTA0NTA3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * When open sampling, true means some error segment will be saved, even that segment will abandoned by server side trace sampling mechanism.\n          \n          \n            \n                 * false means all segment saved condition by server side trace sampling mechanism.\n          \n          \n            \n                 * Sample the trace segment if the segment has span(s) tagged as error status, and ignore the sampleRate configuration.", "url": "https://github.com/apache/skywalking/pull/5407#discussion_r479045071", "createdAt": "2020-08-28T09:49:42Z", "author": {"login": "wu-sheng"}, "path": "oap-server/analyzer/agent-analyzer/src/main/java/org/apache/skywalking/oap/server/analyzer/provider/AnalyzerModuleConfig.java", "diffHunk": "@@ -78,4 +78,12 @@\n \n     @Getter\n     private final String configPath = \"meter-receive-config\";\n+\n+    /**\n+     * When open sampling, true means some error segment will be saved, even that segment will abandoned by server side trace sampling mechanism.\n+     * false means all segment saved condition by server side trace sampling mechanism.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72c8735c63c06e8da257bec6f5b4ea2061f0a41a"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ac90103f982067c23c0a1a201b510afa770fd83", "author": {"user": {"login": "zifeihan", "name": "zifeihan"}}, "url": "https://github.com/apache/skywalking/commit/8ac90103f982067c23c0a1a201b510afa770fd83", "committedDate": "2020-08-28T10:00:28Z", "message": "Polishing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NjkxNTg2", "url": "https://github.com/apache/skywalking/pull/5407#pullrequestreview-477691586", "createdAt": "2020-08-28T12:37:00Z", "commit": {"oid": "8ac90103f982067c23c0a1a201b510afa770fd83"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1956, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}