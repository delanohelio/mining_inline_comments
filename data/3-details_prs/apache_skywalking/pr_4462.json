{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MjM0NTAz", "number": 4462, "title": "[Agent Core] Support lazy ContextCarrier injection and lazy peer id setting ", "bodyText": "This PR's idea was beginning when I am reviewing @huangyoje 's PR #4441. He did hijacking the ContextCarrier, which is not supposed to happen. After the discussion, I think that plugin has to do lazy injection due to the framework limitation.\nHere is the proposal, right now, we officially support\n\nCreate exit span with null as peer, if the user wouldn't do injection.\nExit span could do span#inject directly, by leverage the span's internal tracing context ref.\n\nFYI @apache/skywalking-committers This would be the first API change(adding) after the async span feature. Please review.\n@huangyoje Please cross check this PR change, and give me the feedback whether this PR could remove your hijacking requirements.", "createdAt": "2020-03-08T07:02:57Z", "url": "https://github.com/apache/skywalking/pull/4462", "merged": true, "mergeCommit": {"oid": "74b0af9d85aa66e2666e98719b0a8c255c8cd934"}, "closed": true, "closedAt": "2020-03-08T10:34:54Z", "author": {"login": "wu-sheng"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcLjljugH2gAyMzg1MjM0NTAzOjE0MTRjZTdjZGIxNmNjYzA1MTY0NmYyMzhlMTA0MDI3OWJiNGEzY2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcLlBQ3gFqTM3MDgxMjg5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1414ce7cdb16ccc051646f238e1040279bb4a3ce", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/1414ce7cdb16ccc051646f238e1040279bb4a3ce", "committedDate": "2020-03-08T06:46:57Z", "message": "Support lazy ContextCarrier injection and lazy peer id setting for exit span"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05a4e684dd30454894b4c2e10c9785ba63141d62", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/05a4e684dd30454894b4c2e10c9785ba63141d62", "committedDate": "2020-03-08T06:58:58Z", "message": "Close the set component id for exit and local spans"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3be61959cb4906954820194c0683ddbe5c4f69a0", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/3be61959cb4906954820194c0683ddbe5c4f69a0", "committedDate": "2020-03-08T07:03:25Z", "message": "Merge branch 'master' into exist-span-inject"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwODA5NDU4", "url": "https://github.com/apache/skywalking/pull/4462#pullrequestreview-370809458", "createdAt": "2020-03-08T07:18:25Z", "commit": {"oid": "3be61959cb4906954820194c0683ddbe5c4f69a0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQwNzoxODoyNVrOFzTlZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQwNzozMToxMFrOFzToVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MjU2NA==", "bodyText": "why add the leading _", "url": "https://github.com/apache/skywalking/pull/4462#discussion_r389342564", "createdAt": "2020-03-08T07:18:25Z", "author": {"login": "kezhenxu94"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/AbstractTracerContext.java", "diffHunk": "@@ -31,6 +31,15 @@\n      */\n     void inject(ContextCarrier carrier);\n \n+    /**\n+     * Prepare for the cross-process propagation based on the given exit span. The given exit span should belong to the\n+     * current context. How to initialize the carrier, depends on the implementation.\n+     *\n+     * @param carrier  to carry the context for crossing process.\n+     * @param exitSpan to represent the scope of current injection.\n+     */\n+    void _inject(AbstractSpan exitSpan, ContextCarrier carrier);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3be61959cb4906954820194c0683ddbe5c4f69a0"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MzMxOQ==", "bodyText": "Consider returning this for chaining", "url": "https://github.com/apache/skywalking/pull/4462#discussion_r389343319", "createdAt": "2020-03-08T07:31:10Z", "author": {"login": "kezhenxu94"}, "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/trace/ExitTypeSpan.java", "diffHunk": "@@ -18,8 +18,15 @@\n \n package org.apache.skywalking.apm.agent.core.context.trace;\n \n-public interface WithPeerInfo {\n+import org.apache.skywalking.apm.agent.core.context.ContextCarrier;\n+\n+/**\n+ * The exit span has some additional behaviours\n+ */\n+public interface ExitTypeSpan {\n     int getPeerId();\n \n     String getPeer();\n+\n+    void inject(ContextCarrier carrier);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3be61959cb4906954820194c0683ddbe5c4f69a0"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9795dbc986f3f63cf38bd62ad8b56ffce47e31e0", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/9795dbc986f3f63cf38bd62ad8b56ffce47e31e0", "committedDate": "2020-03-08T07:54:03Z", "message": "Follow the review."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bdafded9278ae001bc5c4e5cba7441d4227d2f2", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/0bdafded9278ae001bc5c4e5cba7441d4227d2f2", "committedDate": "2020-03-08T08:22:38Z", "message": "Remove `void inject(AbstractSpan exitSpan, ContextCarrier carrier)` from AbstractTracerContext"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwODEyODky", "url": "https://github.com/apache/skywalking/pull/4462#pullrequestreview-370812892", "createdAt": "2020-03-08T08:27:07Z", "commit": {"oid": "0bdafded9278ae001bc5c4e5cba7441d4227d2f2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2416, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}