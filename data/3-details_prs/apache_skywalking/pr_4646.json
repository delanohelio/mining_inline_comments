{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyNjkzNDQz", "number": 4646, "title": "Nginx correlation e2e test", "bodyText": "New feature or improvement\n\nAfter Nginx correlation implement, this PR is adding the Nginx correlation e2e test.\nIf we got an illegal correlation section, then we should abandon that.", "createdAt": "2020-04-13T15:20:45Z", "url": "https://github.com/apache/skywalking/pull/4646", "merged": true, "mergeCommit": {"oid": "171620bfa8e74bfc84e7d322c260f319943b7191"}, "closed": true, "closedAt": "2020-04-14T01:32:55Z", "author": {"login": "mrproliu"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcW9gkeAH2gAyNDAyNjkzNDQzOmJjMTEzODU0NGNkZmEyZTE4ZjVlMzBmOTY0YThhOTljN2Q1NDE1NmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXZRHsAFqTM5MjU0NTAyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bc1138544cdfa2e18f5e30f964a8a99c7d54156f", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/bc1138544cdfa2e18f5e30f964a8a99c7d54156f", "committedDate": "2020-04-12T17:12:12Z", "message": "adding lua agent correlation test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f41d8609dfa7542fc9edb289f98d48ca1da3eba", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/1f41d8609dfa7542fc9edb289f98d48ca1da3eba", "committedDate": "2020-04-13T05:39:42Z", "message": "if we got illegal, then we should abandon this whole section"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f62d95a3666488e03ce40df9f74ef45a6397adc", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/0f62d95a3666488e03ce40df9f74ef45a6397adc", "committedDate": "2020-04-13T15:13:39Z", "message": "using new commit id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33d9dfb148af3fabf3cb82792174f85cddff49ae", "author": {"user": {"login": "mrproliu", "name": null}}, "url": "https://github.com/apache/skywalking/commit/33d9dfb148af3fabf3cb82792174f85cddff49ae", "committedDate": "2020-04-13T15:21:00Z", "message": "Merge branch 'master' into nginx_with_correlation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMjIyMTAw", "url": "https://github.com/apache/skywalking/pull/4646#pullrequestreview-392222100", "createdAt": "2020-04-13T15:33:48Z", "commit": {"oid": "33d9dfb148af3fabf3cb82792174f85cddff49ae"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNTozMzo0OVrOGEqWuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNTo0OToxOVrOGEq2wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU0MTQzNQ==", "bodyText": "correlation can't be tested in the e2e from my perspective.\n\n@wu-sheng maybe here is how @mrproliu he made it possible to test correlation in the E2E, get the correlation context in a service and expose them in an endpoint that can be verified in the test codes?", "url": "https://github.com/apache/skywalking/pull/4646#discussion_r407541435", "createdAt": "2020-04-13T15:33:49Z", "author": {"login": "kezhenxu94"}, "path": "test/e2e/e2e-service-provider/src/main/java/org/apache/skywalking/e2e/lua/LuaController.java", "diffHunk": "@@ -36,8 +37,15 @@\n     @PostMapping(\"/nginx/entry/info\")\n     private String nginxEntry(String backend) throws MalformedURLException, URISyntaxException {\n         final URL url = new URL(\"http://nginx:8080/nginx/info\");\n+        TraceContext.putCorrelation(\"entry\", \"entry_value\");\n         final ResponseEntity<String> response = restTemplate.postForEntity(url.toURI(), null, String.class);\n         return response.getBody();\n     }\n \n+    @PostMapping(\"/nginx/end/info\")\n+    private String nginxEnd() throws MalformedURLException, URISyntaxException {\n+        return TraceContext.getCorrelation(\"entry\").orElse(\"\")\n+            + \"_\" + TraceContext.getCorrelation(\"nginx\").orElse(\"\");\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33d9dfb148af3fabf3cb82792174f85cddff49ae"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU0MTcwMQ==", "bodyText": "Let's remove the public modifier, Junit 5 doesn't require this", "url": "https://github.com/apache/skywalking/pull/4646#discussion_r407541701", "createdAt": "2020-04-13T15:34:15Z", "author": {"login": "kezhenxu94"}, "path": "test/e2e/e2e-test/src/test/java/org/apache/skywalking/e2e/LuaE2E.java", "diffHunk": "@@ -92,14 +95,21 @@\n     public void setUp() throws Exception {\n         queryClient(swWebappHostPort);\n \n-        trafficController(entryProvider, \"/nginx/entry/info?backend=\" + nginxHostPort.host() + \":\" + nginxHostPort.port());\n+        trafficController(entryProvider, \"/nginx/entry/info\");\n     }\n \n     @AfterAll\n     public void tearDown() {\n         trafficController.stop();\n     }\n \n+    @RetryableTest\n+    public void correlation() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33d9dfb148af3fabf3cb82792174f85cddff49ae"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU0NjU3MA==", "bodyText": "This will be hard to maintain, though I didn't figure out a better way", "url": "https://github.com/apache/skywalking/pull/4646#discussion_r407546570", "createdAt": "2020-04-13T15:43:39Z", "author": {"login": "kezhenxu94"}, "path": "test/e2e/e2e-service-provider/pom.xml", "diffHunk": "@@ -44,6 +44,11 @@\n             <artifactId>h2</artifactId>\n             <version>${h2.version}</version>\n         </dependency>\n+        <dependency>\n+            <groupId>org.apache.skywalking</groupId>\n+            <artifactId>apm-toolkit-trace</artifactId>\n+            <version>8.0.0-SNAPSHOT</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33d9dfb148af3fabf3cb82792174f85cddff49ae"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU0OTYzNA==", "bodyText": "Remove the declaration of nginxHostPort (line#89) if you don't need it anymore", "url": "https://github.com/apache/skywalking/pull/4646#discussion_r407549634", "createdAt": "2020-04-13T15:49:19Z", "author": {"login": "kezhenxu94"}, "path": "test/e2e/e2e-test/src/test/java/org/apache/skywalking/e2e/LuaE2E.java", "diffHunk": "@@ -92,14 +95,21 @@\n     public void setUp() throws Exception {\n         queryClient(swWebappHostPort);\n \n-        trafficController(entryProvider, \"/nginx/entry/info?backend=\" + nginxHostPort.host() + \":\" + nginxHostPort.port());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33d9dfb148af3fabf3cb82792174f85cddff49ae"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMjQxNzU3", "url": "https://github.com/apache/skywalking/pull/4646#pullrequestreview-392241757", "createdAt": "2020-04-13T16:03:35Z", "commit": {"oid": "33d9dfb148af3fabf3cb82792174f85cddff49ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNjowMzozNVrOGErVaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNjowMzozNVrOGErVaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU1NzQ4Mw==", "bodyText": "@mrproliu Do you mean this check?", "url": "https://github.com/apache/skywalking/pull/4646#discussion_r407557483", "createdAt": "2020-04-13T16:03:35Z", "author": {"login": "wu-sheng"}, "path": "test/e2e/e2e-test/src/test/java/org/apache/skywalking/e2e/LuaE2E.java", "diffHunk": "@@ -92,14 +95,21 @@\n     public void setUp() throws Exception {\n         queryClient(swWebappHostPort);\n \n-        trafficController(entryProvider, \"/nginx/entry/info?backend=\" + nginxHostPort.host() + \":\" + nginxHostPort.port());\n+        trafficController(entryProvider, \"/nginx/entry/info\");\n     }\n \n     @AfterAll\n     public void tearDown() {\n         trafficController.stop();\n     }\n \n+    @RetryableTest\n+    public void correlation() throws Exception {\n+        final URL url = new URL(\"http\", entryProvider.host(), entryProvider.port(), \"/nginx/entry/info\");\n+        final ResponseEntity<String> response = restTemplate.postForEntity(url.toURI(), trafficData, String.class);\n+        Assert.assertEquals(response.getBody(), \"entry_value_nginx_value\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33d9dfb148af3fabf3cb82792174f85cddff49ae"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6264612e939b2754c125b2be54ac5fc3f8e6cf08", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/6264612e939b2754c125b2be54ac5fc3f8e6cf08", "committedDate": "2020-04-13T16:24:10Z", "message": "resolve issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNTMwMjc5", "url": "https://github.com/apache/skywalking/pull/4646#pullrequestreview-392530279", "createdAt": "2020-04-14T00:43:40Z", "commit": {"oid": "6264612e939b2754c125b2be54ac5fc3f8e6cf08"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNTQ1MDIz", "url": "https://github.com/apache/skywalking/pull/4646#pullrequestreview-392545023", "createdAt": "2020-04-14T01:32:40Z", "commit": {"oid": "6264612e939b2754c125b2be54ac5fc3f8e6cf08"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2297, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}