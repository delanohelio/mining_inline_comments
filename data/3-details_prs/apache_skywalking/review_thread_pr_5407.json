{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1MjAxMTIy", "number": 5407, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwNjo1OToxOVrOEdf9cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwOTo0OTo0MlrOEdmpRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5MzY3Nzk1OnYy", "diffSide": "RIGHT", "path": "docs/en/setup/backend/trace-sampling.md", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwNjo1OToxOVrOHIr3VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwODoyMjowNlrOHIvwIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg2OTMzMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            When you open sampling, the actual sampleRate will above sampleRate. Because we want some error segment will be saved, even that segment will abandoned by server side trace sampling mechanism. may be miss some other trace segments, but we can analyze this error segment to solve problem.\n          \n          \n            \n            When you open sampling, the actual sample rate could be over sampleRate. Because currently, all error segments will be saved, meanwhile, the upstream and downstream may not be sampled. This feature is going to make sure you could have the error stacks and segments, but don't guarantee you would have the whole trace.\n          \n          \n            \n            \n          \n          \n            \n            Also, the side effect would be, if most of the accesses are fail, the sampling rate would be closing to 100%, which could crash the backend or storage clusters.", "url": "https://github.com/apache/skywalking/pull/5407#discussion_r478869333", "createdAt": "2020-08-28T06:59:19Z", "author": {"login": "wu-sheng"}, "path": "docs/en/setup/backend/trace-sampling.md", "diffHunk": "@@ -30,4 +30,8 @@ When you set the rate different, let's say\n And we assume the agents reported all trace segments to backend,\n Then the 35% traces in the global will be collected and saved in storage consistent/complete, with all spans.\n 20% trace segments, which reported to Backend-Instance**B**, will saved in storage, maybe miss some trace segments,\n-because they are reported to Backend-Instance**A** and ignored.\n\\ No newline at end of file\n+because they are reported to Backend-Instance**A** and ignored.\n+\n+# Note\n+When you open sampling, the actual sampleRate will above sampleRate. Because we want some error segment will be saved, even that segment will abandoned by server side trace sampling mechanism. may be miss some other trace segments, but we can analyze this error segment to solve problem.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3837425fae342fccecebbccc670418c83ce2f461"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg2OTQ3OQ==", "bodyText": "Try to provide a configuration to disable this feature, this could be default open as the harm is limited.", "url": "https://github.com/apache/skywalking/pull/5407#discussion_r478869479", "createdAt": "2020-08-28T06:59:46Z", "author": {"login": "wu-sheng"}, "path": "docs/en/setup/backend/trace-sampling.md", "diffHunk": "@@ -30,4 +30,8 @@ When you set the rate different, let's say\n And we assume the agents reported all trace segments to backend,\n Then the 35% traces in the global will be collected and saved in storage consistent/complete, with all spans.\n 20% trace segments, which reported to Backend-Instance**B**, will saved in storage, maybe miss some trace segments,\n-because they are reported to Backend-Instance**A** and ignored.\n\\ No newline at end of file\n+because they are reported to Backend-Instance**A** and ignored.\n+\n+# Note\n+When you open sampling, the actual sampleRate will above sampleRate. Because we want some error segment will be saved, even that segment will abandoned by server side trace sampling mechanism. may be miss some other trace segments, but we can analyze this error segment to solve problem.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg2OTMzMw=="}, "originalCommit": {"oid": "3837425fae342fccecebbccc670418c83ce2f461"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODkxMTQxOA==", "bodyText": "done.", "url": "https://github.com/apache/skywalking/pull/5407#discussion_r478911418", "createdAt": "2020-08-28T08:00:26Z", "author": {"login": "zifeihan"}, "path": "docs/en/setup/backend/trace-sampling.md", "diffHunk": "@@ -30,4 +30,8 @@ When you set the rate different, let's say\n And we assume the agents reported all trace segments to backend,\n Then the 35% traces in the global will be collected and saved in storage consistent/complete, with all spans.\n 20% trace segments, which reported to Backend-Instance**B**, will saved in storage, maybe miss some trace segments,\n-because they are reported to Backend-Instance**A** and ignored.\n\\ No newline at end of file\n+because they are reported to Backend-Instance**A** and ignored.\n+\n+# Note\n+When you open sampling, the actual sampleRate will above sampleRate. Because we want some error segment will be saved, even that segment will abandoned by server side trace sampling mechanism. may be miss some other trace segments, but we can analyze this error segment to solve problem.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg2OTMzMw=="}, "originalCommit": {"oid": "3837425fae342fccecebbccc670418c83ce2f461"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODkzMzAyNQ==", "bodyText": "This document change should be accepted.", "url": "https://github.com/apache/skywalking/pull/5407#discussion_r478933025", "createdAt": "2020-08-28T08:22:06Z", "author": {"login": "wu-sheng"}, "path": "docs/en/setup/backend/trace-sampling.md", "diffHunk": "@@ -30,4 +30,8 @@ When you set the rate different, let's say\n And we assume the agents reported all trace segments to backend,\n Then the 35% traces in the global will be collected and saved in storage consistent/complete, with all spans.\n 20% trace segments, which reported to Backend-Instance**B**, will saved in storage, maybe miss some trace segments,\n-because they are reported to Backend-Instance**A** and ignored.\n\\ No newline at end of file\n+because they are reported to Backend-Instance**A** and ignored.\n+\n+# Note\n+When you open sampling, the actual sampleRate will above sampleRate. Because we want some error segment will be saved, even that segment will abandoned by server side trace sampling mechanism. may be miss some other trace segments, but we can analyze this error segment to solve problem.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg2OTMzMw=="}, "originalCommit": {"oid": "3837425fae342fccecebbccc670418c83ce2f461"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5NDA4NjQwOnYy", "diffSide": "RIGHT", "path": "oap-server/analyzer/agent-analyzer/src/main/java/org/apache/skywalking/oap/server/analyzer/provider/AnalyzerModuleConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwODoyMjoyNFrOHIvxIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwODoyMjoyNFrOHIvxIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODkzMzI4Mg==", "bodyText": "forceSaveErrorSegment -> forceSampleErrorSegment", "url": "https://github.com/apache/skywalking/pull/5407#discussion_r478933282", "createdAt": "2020-08-28T08:22:24Z", "author": {"login": "wu-sheng"}, "path": "oap-server/analyzer/agent-analyzer/src/main/java/org/apache/skywalking/oap/server/analyzer/provider/AnalyzerModuleConfig.java", "diffHunk": "@@ -78,4 +78,12 @@\n \n     @Getter\n     private final String configPath = \"meter-receive-config\";\n+\n+    /**\n+     * When open sampling, true means some error segment will be saved, even that segment will abandoned by server side trace sampling mechanism.\n+     * false means all segment saved condition by server side trace sampling mechanism.\n+     */\n+    @Setter\n+    @Getter\n+    private boolean forceSaveErrorSegment = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24656c4d15823c929181124f02646d61dfeeff31"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5NDExNzUyOnYy", "diffSide": "RIGHT", "path": "oap-server/analyzer/agent-analyzer/src/main/java/org/apache/skywalking/oap/server/analyzer/provider/trace/parser/listener/SegmentAnalysisListener.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwODoyNzoxNlrOHIwDow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwODo1MjozOVrOHIxkZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODkzODAxOQ==", "bodyText": "This will be always true in default, as forceSaveErrorSegment == true. I think you mischanged this?", "url": "https://github.com/apache/skywalking/pull/5407#discussion_r478938019", "createdAt": "2020-08-28T08:27:16Z", "author": {"login": "wu-sheng"}, "path": "oap-server/analyzer/agent-analyzer/src/main/java/org/apache/skywalking/oap/server/analyzer/provider/trace/parser/listener/SegmentAnalysisListener.java", "diffHunk": "@@ -153,6 +142,14 @@ public void parseSegment(SegmentObject segmentObject) {\n         });\n         final long accurateDuration = endTimestamp - startTimestamp;\n         duration = accurateDuration > Integer.MAX_VALUE ? Integer.MAX_VALUE : (int) accurateDuration;\n+\n+        if (sampleStatus.equals(SAMPLE_STATUS.UNKNOWN) || sampleStatus.equals(SAMPLE_STATUS.IGNORE)) {\n+            if (sampler.shouldSample(segmentObject.getTraceId()) || forceSaveErrorSegment) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24656c4d15823c929181124f02646d61dfeeff31"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODkzODY4MA==", "bodyText": "You should isError && forceSaveErrorSegment from my understanding, isn't it?", "url": "https://github.com/apache/skywalking/pull/5407#discussion_r478938680", "createdAt": "2020-08-28T08:27:52Z", "author": {"login": "wu-sheng"}, "path": "oap-server/analyzer/agent-analyzer/src/main/java/org/apache/skywalking/oap/server/analyzer/provider/trace/parser/listener/SegmentAnalysisListener.java", "diffHunk": "@@ -153,6 +142,14 @@ public void parseSegment(SegmentObject segmentObject) {\n         });\n         final long accurateDuration = endTimestamp - startTimestamp;\n         duration = accurateDuration > Integer.MAX_VALUE ? Integer.MAX_VALUE : (int) accurateDuration;\n+\n+        if (sampleStatus.equals(SAMPLE_STATUS.UNKNOWN) || sampleStatus.equals(SAMPLE_STATUS.IGNORE)) {\n+            if (sampler.shouldSample(segmentObject.getTraceId()) || forceSaveErrorSegment) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODkzODAxOQ=="}, "originalCommit": {"oid": "24656c4d15823c929181124f02646d61dfeeff31"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk2Mjc4OQ==", "bodyText": "my bad, changed.", "url": "https://github.com/apache/skywalking/pull/5407#discussion_r478962789", "createdAt": "2020-08-28T08:52:39Z", "author": {"login": "zifeihan"}, "path": "oap-server/analyzer/agent-analyzer/src/main/java/org/apache/skywalking/oap/server/analyzer/provider/trace/parser/listener/SegmentAnalysisListener.java", "diffHunk": "@@ -153,6 +142,14 @@ public void parseSegment(SegmentObject segmentObject) {\n         });\n         final long accurateDuration = endTimestamp - startTimestamp;\n         duration = accurateDuration > Integer.MAX_VALUE ? Integer.MAX_VALUE : (int) accurateDuration;\n+\n+        if (sampleStatus.equals(SAMPLE_STATUS.UNKNOWN) || sampleStatus.equals(SAMPLE_STATUS.IGNORE)) {\n+            if (sampler.shouldSample(segmentObject.getTraceId()) || forceSaveErrorSegment) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODkzODAxOQ=="}, "originalCommit": {"oid": "24656c4d15823c929181124f02646d61dfeeff31"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5NDc3MzE3OnYy", "diffSide": "RIGHT", "path": "oap-server/analyzer/agent-analyzer/src/main/java/org/apache/skywalking/oap/server/analyzer/provider/AnalyzerModuleConfig.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwOTo0OTo0MlrOHI2lzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxMDowMjoyN1rOHI3kJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTA0NTA3MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * When open sampling, true means some error segment will be saved, even that segment will abandoned by server side trace sampling mechanism.\n          \n          \n            \n                 * false means all segment saved condition by server side trace sampling mechanism.\n          \n          \n            \n                 * Sample the trace segment if the segment has span(s) tagged as error status, and ignore the sampleRate configuration.", "url": "https://github.com/apache/skywalking/pull/5407#discussion_r479045071", "createdAt": "2020-08-28T09:49:42Z", "author": {"login": "wu-sheng"}, "path": "oap-server/analyzer/agent-analyzer/src/main/java/org/apache/skywalking/oap/server/analyzer/provider/AnalyzerModuleConfig.java", "diffHunk": "@@ -78,4 +78,12 @@\n \n     @Getter\n     private final String configPath = \"meter-receive-config\";\n+\n+    /**\n+     * When open sampling, true means some error segment will be saved, even that segment will abandoned by server side trace sampling mechanism.\n+     * false means all segment saved condition by server side trace sampling mechanism.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72c8735c63c06e8da257bec6f5b4ea2061f0a41a"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTA2MTAzMA==", "bodyText": "ok.", "url": "https://github.com/apache/skywalking/pull/5407#discussion_r479061030", "createdAt": "2020-08-28T10:02:27Z", "author": {"login": "zifeihan"}, "path": "oap-server/analyzer/agent-analyzer/src/main/java/org/apache/skywalking/oap/server/analyzer/provider/AnalyzerModuleConfig.java", "diffHunk": "@@ -78,4 +78,12 @@\n \n     @Getter\n     private final String configPath = \"meter-receive-config\";\n+\n+    /**\n+     * When open sampling, true means some error segment will be saved, even that segment will abandoned by server side trace sampling mechanism.\n+     * false means all segment saved condition by server side trace sampling mechanism.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTA0NTA3MQ=="}, "originalCommit": {"oid": "72c8735c63c06e8da257bec6f5b4ea2061f0a41a"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4986, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}