{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1ODc3MTI2", "number": 5989, "title": "Fix thrift trace broken and wrong arg collected.", "bodyText": "fix thrift\nbug1:\nFor methods without parameters, the collected ARGS are not correct,\nFor example, hi() will become hi\uff09\nbug2:\nIf services A, B and C communicate via RPC\nlike A -> B -> C\nA, C mounts agent, B does not mount agent\nThe phenomenon is that A has trace, B and C don't\nFix broken link, Now C can also trace", "createdAt": "2020-12-10T11:45:05Z", "url": "https://github.com/apache/skywalking/pull/5989", "merged": true, "mergeCommit": {"oid": "542691011cc69ce45730ca6bb094d59b82c5f76e"}, "closed": true, "closedAt": "2020-12-21T13:50:52Z", "author": {"login": "ZS-Oliver"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkyTsCAFqTU0OTEzNTMzMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdoU46KAFqTU1NjMzNjM2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MTM1MzMw", "url": "https://github.com/apache/skywalking/pull/5989#pullrequestreview-549135330", "createdAt": "2020-12-10T12:12:52Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMjoxMjo1M1rOIDGRrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMjoxNToxMlrOIDGXGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDExOTQ3MQ==", "bodyText": "The variable is visible in the if statement block. So we don't need to move it out of the if statement block.", "url": "https://github.com/apache/skywalking/pull/5989#discussion_r540119471", "createdAt": "2020-12-10T12:12:53Z", "author": {"login": "dmsolr"}, "path": "apm-sniffer/apm-sdk-plugin/thrift-plugin/src/main/java/org/apache/skywalking/apm/plugin/thrift/wrapper/ServerInProtocolWrapper.java", "diffHunk": "@@ -57,10 +64,11 @@ public void initial(AbstractContext context) {\n     @Override\n     public TField readFieldBegin() throws TException {\n         final TField field = super.readFieldBegin();\n+        Map<String, String> header = new HashMap<>(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDEyMDMwNg==", "bodyText": "Would you try to do it without ThreadLocal?", "url": "https://github.com/apache/skywalking/pull/5989#discussion_r540120306", "createdAt": "2020-12-10T12:14:24Z", "author": {"login": "dmsolr"}, "path": "apm-sniffer/apm-sdk-plugin/thrift-plugin/src/main/java/org/apache/skywalking/apm/plugin/thrift/wrapper/ServerInProtocolWrapper.java", "diffHunk": "@@ -81,6 +90,20 @@ public TField readFieldBegin() throws TException {\n             }\n             return readFieldBegin();\n         }\n+        if (field.type == TType.STOP && !HAVE_CREATED.get()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDEyMDg1OQ==", "bodyText": "I don't recommend to use ThreadLocal here.", "url": "https://github.com/apache/skywalking/pull/5989#discussion_r540120859", "createdAt": "2020-12-10T12:15:12Z", "author": {"login": "dmsolr"}, "path": "apm-sniffer/apm-sdk-plugin/thrift-plugin/src/main/java/org/apache/skywalking/apm/plugin/thrift/wrapper/ServerInProtocolWrapper.java", "diffHunk": "@@ -81,6 +90,20 @@ public TField readFieldBegin() throws TException {\n             }\n             return readFieldBegin();\n         }\n+        if (field.type == TType.STOP && !HAVE_CREATED.get()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDEyMDMwNg=="}, "originalCommit": null, "originalPosition": 39}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMTc2MzUw", "url": "https://github.com/apache/skywalking/pull/5989#pullrequestreview-551176350", "createdAt": "2020-12-14T09:19:06Z", "commit": null, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxNDI1OTY5", "url": "https://github.com/apache/skywalking/pull/5989#pullrequestreview-551425969", "createdAt": "2020-12-14T14:34:50Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxNDozNDo1MFrOIFTYOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxNDozNDo1MFrOIFTYOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQzMTI5MQ==", "bodyText": "TracingContext has native running context for this case, could you consider to use that? It could be auto cleared when the tracing context finished.", "url": "https://github.com/apache/skywalking/pull/5989#discussion_r542431291", "createdAt": "2020-12-14T14:34:50Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/thrift-plugin/src/main/java/org/apache/skywalking/apm/plugin/thrift/wrapper/ServerInProtocolWrapper.java", "diffHunk": "@@ -45,6 +45,7 @@\n     private static final ILog LOGGER = LogManager.getLogger(ServerInProtocolWrapper.class);\n     private static final StringTag TAG_ARGS = new StringTag(\"args\");\n     private AbstractContext context;\n+    private static ThreadLocal<Boolean> HAVE_CREATED = ThreadLocal.withInitial(() -> Boolean.FALSE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxNDI4MjY5", "url": "https://github.com/apache/skywalking/pull/5989#pullrequestreview-551428269", "createdAt": "2020-12-14T14:36:56Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxNDozNjo1NlrOIFTeSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxNDozNjo1NlrOIFTeSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQzMjg0MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            * Fix thrift plugin trace link broken when intermediate service does not mount agent, and collect wrong args when method without parameters.\n          \n          \n            \n            * Fix thrift plugin trace link broken when intermediate service does not mount agent\n          \n          \n            \n            * Fix thrift plugin collects wrong args when the method without parameter.", "url": "https://github.com/apache/skywalking/pull/5989#discussion_r542432841", "createdAt": "2020-12-14T14:36:56Z", "author": {"login": "wu-sheng"}, "path": "CHANGES.md", "diffHunk": "@@ -12,6 +12,7 @@ Release Notes.\n * The operation name of quartz-scheduler plugin, has been changed as the `quartz-scheduler/${className}` format.\n * Fix jdk-http and okhttp-3.x plugin did not overwrite the old trace header.\n * Support collecting logs of log4j, log4j2, and logback in the tracing context with a new `logger-plugin`.\n+* Fix thrift plugin trace link broken when intermediate service does not mount agent, and collect wrong args when method without parameters.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MjAwNjM1", "url": "https://github.com/apache/skywalking/pull/5989#pullrequestreview-556200635", "createdAt": "2020-12-21T08:20:22Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQwODoyMDoyMlrOIJP1NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQwODoyMDoyMlrOIJP1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU2NzQ3Ng==", "bodyText": "I think there is an NPE risk.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        boolean haveCreatedSpan =\n          \n          \n            \n                                (boolean) ContextManager.getRuntimeContext().get(HAVE_CREATED_SPAN);\n          \n          \n            \n                        Boolean haveCreatedSpan =\n          \n          \n            \n                                ContextManager.getRuntimeContext().get(HAVE_CREATED_SPAN);\n          \n      \n    \n    \n  \n\nAnd you should check haveCreatedSpan != null && !haveCreatedSpan, agree?", "url": "https://github.com/apache/skywalking/pull/5989#discussion_r546567476", "createdAt": "2020-12-21T08:20:22Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/thrift-plugin/src/main/java/org/apache/skywalking/apm/plugin/thrift/wrapper/ServerInProtocolWrapper.java", "diffHunk": "@@ -81,6 +84,24 @@ public TField readFieldBegin() throws TException {\n             }\n             return readFieldBegin();\n         }\n+        if (field.type == TType.STOP) {\n+            boolean haveCreatedSpan =\n+                    (boolean) ContextManager.getRuntimeContext().get(HAVE_CREATED_SPAN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "05d239fe4842ae79012c188d2ffb155f41036df5", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/05d239fe4842ae79012c188d2ffb155f41036df5", "committedDate": "2020-12-21T08:38:48Z", "message": "Fix thrift trace broken and wrong arg collected."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "05d239fe4842ae79012c188d2ffb155f41036df5", "author": {"user": null}, "url": "https://github.com/apache/skywalking/commit/05d239fe4842ae79012c188d2ffb155f41036df5", "committedDate": "2020-12-21T08:38:48Z", "message": "Fix thrift trace broken and wrong arg collected."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MjMyMjE1", "url": "https://github.com/apache/skywalking/pull/5989#pullrequestreview-556232215", "createdAt": "2020-12-21T09:14:20Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQwOToxNDoyMFrOIJRS9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQwOToxNDoyMFrOIJRS9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU5MTQ3Ng==", "bodyText": "This is still an NPE risk. Take a look at my previous comment. If you are using Boolean, you need to haveCreatedSpan != null && first.\nIf you are not familiar with auto-unboxing in Java, take a look at this, https://stackoverflow.com/questions/55100449/unexpected-nullpointerexception-while-autoboxing-unboxing-java-long-type-as-re", "url": "https://github.com/apache/skywalking/pull/5989#discussion_r546591476", "createdAt": "2020-12-21T09:14:20Z", "author": {"login": "wu-sheng"}, "path": "apm-sniffer/apm-sdk-plugin/thrift-plugin/src/main/java/org/apache/skywalking/apm/plugin/thrift/wrapper/ServerInProtocolWrapper.java", "diffHunk": "@@ -81,6 +85,24 @@ public TField readFieldBegin() throws TException {\n             }\n             return readFieldBegin();\n         }\n+        if (field.type == TType.STOP) {\n+            Boolean haveCreatedSpan =\n+                    (Boolean) ContextManager.getRuntimeContext().get(HAVE_CREATED_SPAN);\n+            if (!haveCreatedSpan) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d734d05f7c920667fa1bd3addccbadc00ce91a0", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/4d734d05f7c920667fa1bd3addccbadc00ce91a0", "committedDate": "2020-12-21T10:16:40Z", "message": "Merge branch 'master' into fix_thrift"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "4d734d05f7c920667fa1bd3addccbadc00ce91a0", "author": {"user": {"login": "wu-sheng", "name": "\u5434\u665f Wu Sheng"}}, "url": "https://github.com/apache/skywalking/commit/4d734d05f7c920667fa1bd3addccbadc00ce91a0", "committedDate": "2020-12-21T10:16:40Z", "message": "Merge branch 'master' into fix_thrift"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MzM2MzYw", "url": "https://github.com/apache/skywalking/pull/5989#pullrequestreview-556336360", "createdAt": "2020-12-21T12:14:28Z", "commit": {"oid": "4d734d05f7c920667fa1bd3addccbadc00ce91a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1461, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}