{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NTA1Mjg5", "number": 4783, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwMDozNzoxN1rOD_PKgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMzoyNjozNlrOEC9Hgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NjM1MzMwOnYy", "diffSide": "RIGHT", "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwMDozNzoxN1rOGZyVog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzoxNzozOVrOGdBABg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY5MjMyMg==", "bodyText": "Let's copy part of the Duration#parse comments here to explain the PTxx.\n     * The leading plus/minus sign, and negative values for other units are\n     * not part of the ISO-8601 standard.\n     * <p>\n     * Examples:\n     * <pre>\n     *    \"PT20.345S\" -- parses as \"20.345 seconds\"\n     *    \"PT15M\"     -- parses as \"15 minutes\" (where a minute is 60 seconds)\n     *    \"PT10H\"     -- parses as \"10 hours\" (where an hour is 3600 seconds)\n     *    \"P2D\"       -- parses as \"2 days\" (where a day is 24 hours or 86400 seconds)\n     *    \"P2DT3H4M\"  -- parses as \"2 days, 3 hours and 4 minutes\"\n     *    \"P-6H3M\"    -- parses as \"-6 hours and +3 minutes\"\n     *    \"-P6H3M\"    -- parses as \"-6 hours and -3 minutes\"\n     *    \"-P-6H+3M\"  -- parses as \"+6 hours and -3 minutes\"\n     * </pre>", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r429692322", "createdAt": "2020-05-25T00:37:17Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "diffHunk": "@@ -0,0 +1,66 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# Only for test.\n+fetcherInterval: PT15S\n+fetcherTimeout: PT10S\n+metricsPath: /metrics\n+staticConfig:\n+  # targets will be labeled as \"instance\"\n+  targets:\n+    - localhost:1234\n+  labels:\n+    app: test-oap\n+metricsRules:\n+  - name: instance_cpu_percentage\n+    scope: SERVICE_INSTANCE\n+    downSampling: doubleAvg\n+    sources:\n+      process_cpu_seconds_total:\n+        counterFunction: RATE\n+        range: PT1M", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0202791d1e03dba496293071d07f3fdf347f421d"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA3ODI3OA==", "bodyText": "done", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433078278", "createdAt": "2020-06-01T07:17:39Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "diffHunk": "@@ -0,0 +1,66 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# Only for test.\n+fetcherInterval: PT15S\n+fetcherTimeout: PT10S\n+metricsPath: /metrics\n+staticConfig:\n+  # targets will be labeled as \"instance\"\n+  targets:\n+    - localhost:1234\n+  labels:\n+    app: test-oap\n+metricsRules:\n+  - name: instance_cpu_percentage\n+    scope: SERVICE_INSTANCE\n+    downSampling: doubleAvg\n+    sources:\n+      process_cpu_seconds_total:\n+        counterFunction: RATE\n+        range: PT1M", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY5MjMyMg=="}, "originalCommit": {"oid": "0202791d1e03dba496293071d07f3fdf347f421d"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NjM1NDQ0OnYy", "diffSide": "RIGHT", "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwMDozODo0OVrOGZyWRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzoxOTozOFrOGdBC3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY5MjQ4Nw==", "bodyText": "Will this file be deleted eventually?", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r429692487", "createdAt": "2020-05-25T00:38:49Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "diffHunk": "@@ -0,0 +1,66 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# Only for test.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0202791d1e03dba496293071d07f3fdf347f421d"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA3OTAwNQ==", "bodyText": "done", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433079005", "createdAt": "2020-06-01T07:19:38Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "diffHunk": "@@ -0,0 +1,66 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# Only for test.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY5MjQ4Nw=="}, "originalCommit": {"oid": "0202791d1e03dba496293071d07f3fdf347f421d"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NjQyMDg3OnYy", "diffSide": "RIGHT", "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwMTo1MToyOFrOGZy8mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzoxOTo1NVrOGdBDQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTcwMjI5OQ==", "bodyText": "How about we change downSampling to aggregationFunc? Downsampling has a special meaning in the skywalking.", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r429702299", "createdAt": "2020-05-25T01:51:28Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "diffHunk": "@@ -0,0 +1,66 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# Only for test.\n+fetcherInterval: PT15S\n+fetcherTimeout: PT10S\n+metricsPath: /metrics\n+staticConfig:\n+  # targets will be labeled as \"instance\"\n+  targets:\n+    - localhost:1234\n+  labels:\n+    app: test-oap\n+metricsRules:\n+  - name: instance_cpu_percentage\n+    scope: SERVICE_INSTANCE\n+    downSampling: doubleAvg\n+    sources:\n+      process_cpu_seconds_total:\n+        counterFunction: RATE\n+        range: PT1M\n+        relabel:\n+          service:\n+            - app\n+          instance:\n+            - instance\n+  - name: service_cpu_percentage\n+    scope: SERVICE\n+    downSampling: doubleAvg", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0202791d1e03dba496293071d07f3fdf347f421d"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA3OTEwNg==", "bodyText": "naming it to operation", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433079106", "createdAt": "2020-06-01T07:19:55Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "diffHunk": "@@ -0,0 +1,66 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# Only for test.\n+fetcherInterval: PT15S\n+fetcherTimeout: PT10S\n+metricsPath: /metrics\n+staticConfig:\n+  # targets will be labeled as \"instance\"\n+  targets:\n+    - localhost:1234\n+  labels:\n+    app: test-oap\n+metricsRules:\n+  - name: instance_cpu_percentage\n+    scope: SERVICE_INSTANCE\n+    downSampling: doubleAvg\n+    sources:\n+      process_cpu_seconds_total:\n+        counterFunction: RATE\n+        range: PT1M\n+        relabel:\n+          service:\n+            - app\n+          instance:\n+            - instance\n+  - name: service_cpu_percentage\n+    scope: SERVICE\n+    downSampling: doubleAvg", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTcwMjI5OQ=="}, "originalCommit": {"oid": "0202791d1e03dba496293071d07f3fdf347f421d"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NzY2NDA1OnYy", "diffSide": "RIGHT", "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzoyMzoyNFrOGdBIEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNTo1NjowOFrOGdQWWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4MDMzNw==", "bodyText": "I think this app name is not correct.", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433080337", "createdAt": "2020-06-01T07:23:24Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "diffHunk": "@@ -0,0 +1,170 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# This will parse a textual representation of a duration. The formats\n+# accepted are based on the ISO-8601 duration format {@code PnDTnHnMn.nS}\n+# with days considered to be exactly 24 hours.\n+# <p>\n+# Examples:\n+# <pre>\n+#    \"PT20.345S\" -- parses as \"20.345 seconds\"\n+#    \"PT15M\"     -- parses as \"15 minutes\" (where a minute is 60 seconds)\n+#    \"PT10H\"     -- parses as \"10 hours\" (where an hour is 3600 seconds)\n+#    \"P2D\"       -- parses as \"2 days\" (where a day is 24 hours or 86400 seconds)\n+#    \"P2DT3H4M\"  -- parses as \"2 days, 3 hours and 4 minutes\"\n+#    \"P-6H3M\"    -- parses as \"-6 hours and +3 minutes\"\n+#    \"-P6H3M\"    -- parses as \"-6 hours and -3 minutes\"\n+#    \"-P-6H+3M\"  -- parses as \"+6 hours and -3 minutes\"\n+# </pre>\n+fetcherInterval: PT15S\n+fetcherTimeout: PT10S\n+metricsPath: /metrics\n+staticConfig:\n+  # targets will be labeled as \"instance\"\n+  targets:\n+    - localhost:1234\n+  labels:\n+    app: test-oap", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzMyOTc1Mg==", "bodyText": "done", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433329752", "createdAt": "2020-06-01T15:56:08Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "diffHunk": "@@ -0,0 +1,170 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# This will parse a textual representation of a duration. The formats\n+# accepted are based on the ISO-8601 duration format {@code PnDTnHnMn.nS}\n+# with days considered to be exactly 24 hours.\n+# <p>\n+# Examples:\n+# <pre>\n+#    \"PT20.345S\" -- parses as \"20.345 seconds\"\n+#    \"PT15M\"     -- parses as \"15 minutes\" (where a minute is 60 seconds)\n+#    \"PT10H\"     -- parses as \"10 hours\" (where an hour is 3600 seconds)\n+#    \"P2D\"       -- parses as \"2 days\" (where a day is 24 hours or 86400 seconds)\n+#    \"P2DT3H4M\"  -- parses as \"2 days, 3 hours and 4 minutes\"\n+#    \"P-6H3M\"    -- parses as \"-6 hours and +3 minutes\"\n+#    \"-P6H3M\"    -- parses as \"-6 hours and -3 minutes\"\n+#    \"-P-6H+3M\"  -- parses as \"+6 hours and -3 minutes\"\n+# </pre>\n+fetcherInterval: PT15S\n+fetcherTimeout: PT10S\n+metricsPath: /metrics\n+staticConfig:\n+  # targets will be labeled as \"instance\"\n+  targets:\n+    - localhost:1234\n+  labels:\n+    app: test-oap", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4MDMzNw=="}, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NzY4NzA5OnYy", "diffSide": "RIGHT", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/meter/function/AvgPercentileFunction.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzozMjo1NVrOGdBVsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNTo1NjoyMVrOGdQXJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4MzgyNQ==", "bodyText": "I want to discuss whether should we remote the PercentileMetrics and HistogramMetrics? Are they still required?\nUpdated below.", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433083825", "createdAt": "2020-06-01T07:32:55Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/meter/function/AvgPercentileFunction.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.analysis.meter.function;\n+\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.IntStream;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.UnexpectedException;\n+import org.apache.skywalking.oap.server.core.analysis.meter.MeterEntity;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.DataTable;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.IntList;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.MultiIntValuesHolder;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.PercentileMetrics;\n+import org.apache.skywalking.oap.server.core.remote.grpc.proto.RemoteData;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.annotation.Column;\n+\n+/**\n+ * PercentileFunction is the implementation of {@link PercentileMetrics} in the meter system. The major difference is\n+ * the PercentileFunction accepts the {@link AvgPercentileArgument} as input rather than every single request.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4NDIyMQ==", "bodyText": "Ping @mrproliu WDYT?", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433084221", "createdAt": "2020-06-01T07:34:04Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/meter/function/AvgPercentileFunction.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.analysis.meter.function;\n+\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.IntStream;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.UnexpectedException;\n+import org.apache.skywalking.oap.server.core.analysis.meter.MeterEntity;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.DataTable;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.IntList;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.MultiIntValuesHolder;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.PercentileMetrics;\n+import org.apache.skywalking.oap.server.core.remote.grpc.proto.RemoteData;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.annotation.Column;\n+\n+/**\n+ * PercentileFunction is the implementation of {@link PercentileMetrics} in the meter system. The major difference is\n+ * the PercentileFunction accepts the {@link AvgPercentileArgument} as input rather than every single request.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4MzgyNQ=="}, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEwMDAyNw==", "bodyText": "I read the codes again, and this comment, including AvgHistogram, the key differences should be Calculating the avg value of all given values in the time bucket, not you are mentioned about the difference of the parameter type. The parameter type is quite similar, but the logic has a very big difference.\nPlease consider giving an example in the comment.", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433100027", "createdAt": "2020-06-01T08:14:03Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/meter/function/AvgPercentileFunction.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.analysis.meter.function;\n+\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.IntStream;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.UnexpectedException;\n+import org.apache.skywalking.oap.server.core.analysis.meter.MeterEntity;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.DataTable;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.IntList;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.MultiIntValuesHolder;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.PercentileMetrics;\n+import org.apache.skywalking.oap.server.core.remote.grpc.proto.RemoteData;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.annotation.Column;\n+\n+/**\n+ * PercentileFunction is the implementation of {@link PercentileMetrics} in the meter system. The major difference is\n+ * the PercentileFunction accepts the {@link AvgPercentileArgument} as input rather than every single request.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4MzgyNQ=="}, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEwNTE2NQ==", "bodyText": "This comment was copied from the old PercentileFunction, please fix.", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433105165", "createdAt": "2020-06-01T08:25:57Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/meter/function/AvgPercentileFunction.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.analysis.meter.function;\n+\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.IntStream;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.UnexpectedException;\n+import org.apache.skywalking.oap.server.core.analysis.meter.MeterEntity;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.DataTable;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.IntList;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.MultiIntValuesHolder;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.PercentileMetrics;\n+import org.apache.skywalking.oap.server.core.remote.grpc.proto.RemoteData;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.annotation.Column;\n+\n+/**\n+ * PercentileFunction is the implementation of {@link PercentileMetrics} in the meter system. The major difference is\n+ * the PercentileFunction accepts the {@link AvgPercentileArgument} as input rather than every single request.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4MzgyNQ=="}, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzMyOTk1Nw==", "bodyText": "Updated", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433329957", "createdAt": "2020-06-01T15:56:21Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/meter/function/AvgPercentileFunction.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.analysis.meter.function;\n+\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.IntStream;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.UnexpectedException;\n+import org.apache.skywalking.oap.server.core.analysis.meter.MeterEntity;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.DataTable;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.IntList;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.MultiIntValuesHolder;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.PercentileMetrics;\n+import org.apache.skywalking.oap.server.core.remote.grpc.proto.RemoteData;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.annotation.Column;\n+\n+/**\n+ * PercentileFunction is the implementation of {@link PercentileMetrics} in the meter system. The major difference is\n+ * the PercentileFunction accepts the {@link AvgPercentileArgument} as input rather than every single request.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4MzgyNQ=="}, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NzY4ODY2OnYy", "diffSide": "RIGHT", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/metrics/Metrics.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzozMzozNFrOGdBWkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNTo1ODowOFrOGdQbtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4NDA0OQ==", "bodyText": "We have getter, why need `protected?", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433084049", "createdAt": "2020-06-01T07:33:34Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/metrics/Metrics.java", "diffHunk": "@@ -40,7 +40,7 @@\n     @Getter\n     @Setter\n     @Column(columnName = TIME_BUCKET)\n-    private long timeBucket;\n+    protected long timeBucket;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzMzMTEyNQ==", "bodyText": "leverage getter now.", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433331125", "createdAt": "2020-06-01T15:58:08Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/metrics/Metrics.java", "diffHunk": "@@ -40,7 +40,7 @@\n     @Getter\n     @Setter\n     @Column(columnName = TIME_BUCKET)\n-    private long timeBucket;\n+    protected long timeBucket;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4NDA0OQ=="}, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NzY4ODkxOnYy", "diffSide": "RIGHT", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/metrics/DoubleAvgMetrics.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzozMzo0MFrOGdBWsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNTo1Njo0MVrOGdQYJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4NDA4Mg==", "bodyText": "We have getter, why need `protected?", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433084082", "createdAt": "2020-06-01T07:33:40Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/metrics/DoubleAvgMetrics.java", "diffHunk": "@@ -37,11 +37,11 @@\n     @Getter\n     @Setter\n     @Column(columnName = SUMMATION, storageOnly = true)\n-    private double summation;\n+    protected double summation;\n     @Getter\n     @Setter\n     @Column(columnName = COUNT, storageOnly = true)\n-    private long count;\n+    protected long count;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzMzMDIxMg==", "bodyText": "pick up getter now", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433330212", "createdAt": "2020-06-01T15:56:41Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/metrics/DoubleAvgMetrics.java", "diffHunk": "@@ -37,11 +37,11 @@\n     @Getter\n     @Setter\n     @Column(columnName = SUMMATION, storageOnly = true)\n-    private double summation;\n+    protected double summation;\n     @Getter\n     @Setter\n     @Column(columnName = COUNT, storageOnly = true)\n-    private long count;\n+    protected long count;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4NDA4Mg=="}, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NzY5MTQ1OnYy", "diffSide": "RIGHT", "path": "oap-server/server-fetcher-plugin/prometheus-fetcher-plugin/src/main/java/org/apache/skywalking/oap/server/fetcher/prometheus/provider/counter/Window.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzozNDo0MFrOGdBYOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNTo1MjoxOVrOGdQIlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4NDQ3NA==", "bodyText": "Please add comments", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433084474", "createdAt": "2020-06-01T07:34:40Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-fetcher-plugin/prometheus-fetcher-plugin/src/main/java/org/apache/skywalking/oap/server/fetcher/prometheus/provider/counter/Window.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.fetcher.prometheus.provider.counter;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.Maps;\n+import io.vavr.Function2;\n+import io.vavr.Tuple;\n+import io.vavr.Tuple2;\n+import java.time.Duration;\n+import java.util.Collections;\n+import java.util.LinkedList;\n+import java.util.Map;\n+import java.util.Queue;\n+import lombok.EqualsAndHashCode;\n+import lombok.RequiredArgsConstructor;\n+import lombok.ToString;\n+import org.apache.skywalking.oap.server.fetcher.prometheus.provider.operation.Source;\n+\n+@RequiredArgsConstructor\n+@ToString\n+@EqualsAndHashCode\n+public class Window {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzMyNjIzMQ==", "bodyText": "done", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433326231", "createdAt": "2020-06-01T15:52:19Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-fetcher-plugin/prometheus-fetcher-plugin/src/main/java/org/apache/skywalking/oap/server/fetcher/prometheus/provider/counter/Window.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.fetcher.prometheus.provider.counter;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.Maps;\n+import io.vavr.Function2;\n+import io.vavr.Tuple;\n+import io.vavr.Tuple2;\n+import java.time.Duration;\n+import java.util.Collections;\n+import java.util.LinkedList;\n+import java.util.Map;\n+import java.util.Queue;\n+import lombok.EqualsAndHashCode;\n+import lombok.RequiredArgsConstructor;\n+import lombok.ToString;\n+import org.apache.skywalking.oap.server.fetcher.prometheus.provider.operation.Source;\n+\n+@RequiredArgsConstructor\n+@ToString\n+@EqualsAndHashCode\n+public class Window {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4NDQ3NA=="}, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NzY5Mjg3OnYy", "diffSide": "RIGHT", "path": "oap-server/server-fetcher-plugin/prometheus-fetcher-plugin/src/main/java/org/apache/skywalking/oap/server/fetcher/prometheus/provider/operation/Source.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzozNToxOVrOGdBZJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNTo1NzowMVrOGdQY8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4NDcwOQ==", "bodyText": "There is an org.apache.skywalking.oap.server.core.source.Source in the core. Do we have a better name?", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433084709", "createdAt": "2020-06-01T07:35:19Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-fetcher-plugin/prometheus-fetcher-plugin/src/main/java/org/apache/skywalking/oap/server/fetcher/prometheus/provider/operation/Source.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.fetcher.prometheus.provider.operation;\n+\n+import com.google.common.collect.ImmutableMap;\n+import lombok.Builder;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.ToString;\n+import org.apache.skywalking.oap.server.core.analysis.meter.MeterEntity;\n+import org.apache.skywalking.oap.server.fetcher.prometheus.provider.rule.CounterFunction;\n+\n+@EqualsAndHashCode\n+@ToString\n+@Getter\n+@Builder\n+public class Source {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzMzMDQxNw==", "bodyText": "Naming it MetricSource", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433330417", "createdAt": "2020-06-01T15:57:01Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-fetcher-plugin/prometheus-fetcher-plugin/src/main/java/org/apache/skywalking/oap/server/fetcher/prometheus/provider/operation/Source.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.fetcher.prometheus.provider.operation;\n+\n+import com.google.common.collect.ImmutableMap;\n+import lombok.Builder;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.ToString;\n+import org.apache.skywalking.oap.server.core.analysis.meter.MeterEntity;\n+import org.apache.skywalking.oap.server.fetcher.prometheus.provider.rule.CounterFunction;\n+\n+@EqualsAndHashCode\n+@ToString\n+@Getter\n+@Builder\n+public class Source {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4NDcwOQ=="}, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NzY5NDg2OnYy", "diffSide": "RIGHT", "path": "self-modules.txt", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzozNjowOFrOGdBacg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNTo1NzoxN1rOGdQZqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4NTA0Mg==", "bodyText": "What is this? Submit by mistake?", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433085042", "createdAt": "2020-06-01T07:36:08Z", "author": {"login": "wu-sheng"}, "path": "self-modules.txt", "diffHunk": "@@ -0,0 +1,17 @@\n+apm-8.0.0-SNAPSHOT.jar\n+apm-commons-8.0.0-SNAPSHOT.jar\n+apm-util-8.0.0-SNAPSHOT.jar\n+apm-datacarrier-8.0.0-SNAPSHOT.jar\n+apm-protocol-8.0.0-SNAPSHOT.jar\n+apm-network-8.0.0-SNAPSHOT.jar\n+oap-server-8.0.0-SNAPSHOT.jar\n+[ERROR] Failed to execute goal on project server-library: Could not resolve dependencies for project org.apache.skywalking:server-library:pom:8.0.0-SNAPSHOT: Failure to find org.apache.skywalking:apm-util:jar:8.0.0-SNAPSHOT in https://repository.apache.org/snapshots was cached in the local repository, resolution will not be reattempted until the update interval of apache.snapshots has elapsed or updates are forced -> [Help 1]\n+[ERROR] \n+[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.\n+[ERROR] Re-run Maven using the -X switch to enable full debug logging.\n+[ERROR] \n+[ERROR] For more information about the errors and possible solutions, please read the following articles:\n+[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/DependencyResolutionException\n+[ERROR] \n+[ERROR] After correcting the problems, you can resume the build with the command\n+[ERROR]   mvn <goals> -rf :server-library", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzMzMDYwMw==", "bodyText": "yep, dropped it.", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433330603", "createdAt": "2020-06-01T15:57:17Z", "author": {"login": "hanahmily"}, "path": "self-modules.txt", "diffHunk": "@@ -0,0 +1,17 @@\n+apm-8.0.0-SNAPSHOT.jar\n+apm-commons-8.0.0-SNAPSHOT.jar\n+apm-util-8.0.0-SNAPSHOT.jar\n+apm-datacarrier-8.0.0-SNAPSHOT.jar\n+apm-protocol-8.0.0-SNAPSHOT.jar\n+apm-network-8.0.0-SNAPSHOT.jar\n+oap-server-8.0.0-SNAPSHOT.jar\n+[ERROR] Failed to execute goal on project server-library: Could not resolve dependencies for project org.apache.skywalking:server-library:pom:8.0.0-SNAPSHOT: Failure to find org.apache.skywalking:apm-util:jar:8.0.0-SNAPSHOT in https://repository.apache.org/snapshots was cached in the local repository, resolution will not be reattempted until the update interval of apache.snapshots has elapsed or updates are forced -> [Help 1]\n+[ERROR] \n+[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.\n+[ERROR] Re-run Maven using the -X switch to enable full debug logging.\n+[ERROR] \n+[ERROR] For more information about the errors and possible solutions, please read the following articles:\n+[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/DependencyResolutionException\n+[ERROR] \n+[ERROR] After correcting the problems, you can resume the build with the command\n+[ERROR]   mvn <goals> -rf :server-library", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4NTA0Mg=="}, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NzY5NjI2OnYy", "diffSide": "RIGHT", "path": "third-party-dependencies.txt", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzozNjo0N1rOGdBbUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNTo1NzoyOVrOGdQaIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4NTI2NQ==", "bodyText": "What is this?", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433085265", "createdAt": "2020-06-01T07:36:47Z", "author": {"login": "wu-sheng"}, "path": "third-party-dependencies.txt", "diffHunk": "@@ -0,0 +1,297 @@\n+HdrHistogram-2.1.9.jar", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzMzMDcyMw==", "bodyText": "by mistake", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433330723", "createdAt": "2020-06-01T15:57:29Z", "author": {"login": "hanahmily"}, "path": "third-party-dependencies.txt", "diffHunk": "@@ -0,0 +1,297 @@\n+HdrHistogram-2.1.9.jar", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4NTI2NQ=="}, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5Nzc4NTE0OnYy", "diffSide": "RIGHT", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/meter/function/AvgPercentileFunction.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwODoxMTowOFrOGdCQgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNTo1NTozNVrOGdQUYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA5ODg4Mw==", "bodyText": "According to this method, you are calculating the avg value of all given values in the time bucket, including the downsampling. I think you should add very clear comments about what is different.", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433098883", "createdAt": "2020-06-01T08:11:08Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/meter/function/AvgPercentileFunction.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.analysis.meter.function;\n+\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.IntStream;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.UnexpectedException;\n+import org.apache.skywalking.oap.server.core.analysis.meter.MeterEntity;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.DataTable;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.IntList;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.MultiIntValuesHolder;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.PercentileMetrics;\n+import org.apache.skywalking.oap.server.core.remote.grpc.proto.RemoteData;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.annotation.Column;\n+\n+/**\n+ * PercentileFunction is the implementation of {@link PercentileMetrics} in the meter system. The major difference is\n+ * the PercentileFunction accepts the {@link AvgPercentileArgument} as input rather than every single request.\n+ */\n+@MeterFunction(functionName = \"avgPercentile\")\n+@Slf4j\n+public abstract class AvgPercentileFunction extends Metrics implements AcceptableValue<AvgPercentileFunction.AvgPercentileArgument>, MultiIntValuesHolder {\n+    public static final String DATASET = \"dataset\";\n+    public static final String RANKS = \"ranks\";\n+    public static final String VALUE = \"value\";\n+    protected static final String SUMMATION = \"summation\";\n+    protected static final String COUNT = \"count\";\n+\n+    @Setter\n+    @Getter\n+    @Column(columnName = ENTITY_ID)\n+    private String entityId;\n+    @Getter\n+    @Setter\n+    @Column(columnName = VALUE, dataType = Column.ValueDataType.LABELED_VALUE, storageOnly = true)\n+    private DataTable percentileValues = new DataTable(10);\n+    @Getter\n+    @Setter\n+    @Column(columnName = SUMMATION, storageOnly = true)\n+    protected DataTable summation = new DataTable(30);\n+    @Getter\n+    @Setter\n+    @Column(columnName = COUNT, storageOnly = true)\n+    protected DataTable count = new DataTable(30);\n+    @Getter\n+    @Setter\n+    @Column(columnName = DATASET, storageOnly = true)\n+    private DataTable dataset = new DataTable(30);\n+    /**\n+     * Rank\n+     */\n+    @Getter\n+    @Setter\n+    @Column(columnName = RANKS, storageOnly = true)\n+    private IntList ranks = new IntList(10);\n+\n+    private boolean isCalculated = false;\n+\n+    @Override\n+    public void accept(final MeterEntity entity, final AvgPercentileArgument value) {\n+        if (dataset.size() > 0) {\n+            if (!value.getBucketedValues().isCompatible(dataset)) {\n+                throw new IllegalArgumentException(\n+                    \"Incompatible BucketedValues [\" + value + \"] for current PercentileFunction[\" + dataset + \"]\");\n+            }\n+        }\n+\n+        for (final int rank : value.getRanks()) {\n+            if (rank <= 0) {\n+                throw new IllegalArgumentException(\"Illegal rank value \" + rank + \", must be positive\");\n+            }\n+        }\n+\n+        if (ranks.size() > 0) {\n+            if (ranks.size() != value.getRanks().length) {\n+                throw new IllegalArgumentException(\n+                    \"Incompatible ranks size = [\" + value.getRanks().length + \"] for current PercentileFunction[\" + ranks\n+                        .size() + \"]\");\n+            } else {\n+                for (final int rank : value.getRanks()) {\n+                    if (!ranks.include(rank)) {\n+                        throw new IllegalArgumentException(\n+                            \"Rank \" + rank + \" doesn't exist in the previous ranks \" + ranks);\n+                    }\n+                }\n+            }\n+        } else {\n+            for (final int rank : value.getRanks()) {\n+                ranks.add(rank);\n+            }\n+        }\n+\n+        this.entityId = entity.id();\n+\n+        final long[] values = value.getBucketedValues().getValues();\n+        for (int i = 0; i < values.length; i++) {\n+            String bucketName = String.valueOf(value.getBucketedValues().getBuckets()[i]);\n+            summation.valueAccumulation(bucketName, values[i]);\n+            count.valueAccumulation(bucketName, 1L);\n+        }\n+\n+        this.isCalculated = false;\n+    }\n+\n+    @Override\n+    public void combine(final Metrics metrics) {\n+        AvgPercentileFunction percentile = (AvgPercentileFunction) metrics;\n+\n+        if (!summation.keysEqual(percentile.getSummation())) {\n+            log.warn(\"Incompatible input [{}}] for current PercentileFunction[{}], entity {}\",\n+                     percentile, this, entityId\n+            );\n+            return;\n+        }\n+        if (ranks.size() > 0) {\n+            if (this.ranks.size() != ranks.size()) {\n+                log.warn(\"Incompatible ranks size = [{}}] for current PercentileFunction[{}]\",\n+                         ranks.size(), this.ranks.size()\n+                );\n+                return;\n+            } else {\n+                if (!this.ranks.equals(percentile.getRanks())) {\n+                    log.warn(\"Rank {} doesn't exist in the previous ranks {}\", percentile.getRanks(), ranks);\n+                    return;\n+                }\n+            }\n+        }\n+\n+        this.summation.append(percentile.summation);\n+        this.count.append(percentile.count);\n+\n+        this.isCalculated = false;\n+    }\n+\n+    @Override\n+    public void calculate() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzMyOTI0OQ==", "bodyText": "Comment on this class.", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433329249", "createdAt": "2020-06-01T15:55:35Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/meter/function/AvgPercentileFunction.java", "diffHunk": "@@ -0,0 +1,328 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.analysis.meter.function;\n+\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.IntStream;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.UnexpectedException;\n+import org.apache.skywalking.oap.server.core.analysis.meter.MeterEntity;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.DataTable;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.IntList;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.MultiIntValuesHolder;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.PercentileMetrics;\n+import org.apache.skywalking.oap.server.core.remote.grpc.proto.RemoteData;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.annotation.Column;\n+\n+/**\n+ * PercentileFunction is the implementation of {@link PercentileMetrics} in the meter system. The major difference is\n+ * the PercentileFunction accepts the {@link AvgPercentileArgument} as input rather than every single request.\n+ */\n+@MeterFunction(functionName = \"avgPercentile\")\n+@Slf4j\n+public abstract class AvgPercentileFunction extends Metrics implements AcceptableValue<AvgPercentileFunction.AvgPercentileArgument>, MultiIntValuesHolder {\n+    public static final String DATASET = \"dataset\";\n+    public static final String RANKS = \"ranks\";\n+    public static final String VALUE = \"value\";\n+    protected static final String SUMMATION = \"summation\";\n+    protected static final String COUNT = \"count\";\n+\n+    @Setter\n+    @Getter\n+    @Column(columnName = ENTITY_ID)\n+    private String entityId;\n+    @Getter\n+    @Setter\n+    @Column(columnName = VALUE, dataType = Column.ValueDataType.LABELED_VALUE, storageOnly = true)\n+    private DataTable percentileValues = new DataTable(10);\n+    @Getter\n+    @Setter\n+    @Column(columnName = SUMMATION, storageOnly = true)\n+    protected DataTable summation = new DataTable(30);\n+    @Getter\n+    @Setter\n+    @Column(columnName = COUNT, storageOnly = true)\n+    protected DataTable count = new DataTable(30);\n+    @Getter\n+    @Setter\n+    @Column(columnName = DATASET, storageOnly = true)\n+    private DataTable dataset = new DataTable(30);\n+    /**\n+     * Rank\n+     */\n+    @Getter\n+    @Setter\n+    @Column(columnName = RANKS, storageOnly = true)\n+    private IntList ranks = new IntList(10);\n+\n+    private boolean isCalculated = false;\n+\n+    @Override\n+    public void accept(final MeterEntity entity, final AvgPercentileArgument value) {\n+        if (dataset.size() > 0) {\n+            if (!value.getBucketedValues().isCompatible(dataset)) {\n+                throw new IllegalArgumentException(\n+                    \"Incompatible BucketedValues [\" + value + \"] for current PercentileFunction[\" + dataset + \"]\");\n+            }\n+        }\n+\n+        for (final int rank : value.getRanks()) {\n+            if (rank <= 0) {\n+                throw new IllegalArgumentException(\"Illegal rank value \" + rank + \", must be positive\");\n+            }\n+        }\n+\n+        if (ranks.size() > 0) {\n+            if (ranks.size() != value.getRanks().length) {\n+                throw new IllegalArgumentException(\n+                    \"Incompatible ranks size = [\" + value.getRanks().length + \"] for current PercentileFunction[\" + ranks\n+                        .size() + \"]\");\n+            } else {\n+                for (final int rank : value.getRanks()) {\n+                    if (!ranks.include(rank)) {\n+                        throw new IllegalArgumentException(\n+                            \"Rank \" + rank + \" doesn't exist in the previous ranks \" + ranks);\n+                    }\n+                }\n+            }\n+        } else {\n+            for (final int rank : value.getRanks()) {\n+                ranks.add(rank);\n+            }\n+        }\n+\n+        this.entityId = entity.id();\n+\n+        final long[] values = value.getBucketedValues().getValues();\n+        for (int i = 0; i < values.length; i++) {\n+            String bucketName = String.valueOf(value.getBucketedValues().getBuckets()[i]);\n+            summation.valueAccumulation(bucketName, values[i]);\n+            count.valueAccumulation(bucketName, 1L);\n+        }\n+\n+        this.isCalculated = false;\n+    }\n+\n+    @Override\n+    public void combine(final Metrics metrics) {\n+        AvgPercentileFunction percentile = (AvgPercentileFunction) metrics;\n+\n+        if (!summation.keysEqual(percentile.getSummation())) {\n+            log.warn(\"Incompatible input [{}}] for current PercentileFunction[{}], entity {}\",\n+                     percentile, this, entityId\n+            );\n+            return;\n+        }\n+        if (ranks.size() > 0) {\n+            if (this.ranks.size() != ranks.size()) {\n+                log.warn(\"Incompatible ranks size = [{}}] for current PercentileFunction[{}]\",\n+                         ranks.size(), this.ranks.size()\n+                );\n+                return;\n+            } else {\n+                if (!this.ranks.equals(percentile.getRanks())) {\n+                    log.warn(\"Rank {} doesn't exist in the previous ranks {}\", percentile.getRanks(), ranks);\n+                    return;\n+                }\n+            }\n+        }\n+\n+        this.summation.append(percentile.summation);\n+        this.count.append(percentile.count);\n+\n+        this.isCalculated = false;\n+    }\n+\n+    @Override\n+    public void calculate() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA5ODg4Mw=="}, "originalCommit": {"oid": "969b4ca36deac3dec625f6f884087c2c79a83b78"}, "originalPosition": 163}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMDYzODcwOnYy", "diffSide": "RIGHT", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/meter/function/AvgHistogramFunction.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMDoxNToyMVrOGdeC3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzoxNjo1OFrOGfjBNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU1NDE0MA==", "bodyText": "I think this function, including AvgPercentile, is a quite Prometheus style. Should we consider to move this into the Prometheus fetcher only? Seems more reasonable to me.", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433554140", "createdAt": "2020-06-02T00:15:21Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/meter/function/AvgHistogramFunction.java", "diffHunk": "@@ -0,0 +1,219 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.analysis.meter.function;\n+\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import lombok.Getter;\n+import lombok.Setter;\n+import lombok.ToString;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.UnexpectedException;\n+import org.apache.skywalking.oap.server.core.analysis.meter.MeterEntity;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.DataTable;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.remote.grpc.proto.RemoteData;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.annotation.Column;\n+\n+/**\n+ * AvgHistogram intends to aggregate raw values over the interval (minute, hour or day). When users query a value\n+ * from such a interval, an average over it will be sent back.\n+ *\n+ * The acceptable bucket value should be a result from one of \"increase\", \"rate\" and \"irate\" query functions.\n+ * That means the value is the increase or per-second instant rate of increase in a specific range.\n+ *\n+ * Example:\n+ * \"persistence_timer_bulk_execute_latency\" is histogram, the possible PromQL format of acceptable bucket value should be:\n+ * \"increase(persistence_timer_bulk_execute_latency{service=\"oap-server\", instance=\"localhost:1234\"}[5m])\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "351ee221fb4f71944055cb21f2262e942dfe57c6"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI5NDU0NQ==", "bodyText": "They're about how to handle the downsampling/rollup aggregation of a histogram based on the counter, which is more generic than Prometheus. except for openmetrics(which is from Prometheus), the micrometer also exports a similar histogram.\nAnd in the future, we should implements other functions more than avg, for instance, sum, count, max, min, first and last.", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r434294545", "createdAt": "2020-06-03T03:59:27Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/meter/function/AvgHistogramFunction.java", "diffHunk": "@@ -0,0 +1,219 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.analysis.meter.function;\n+\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import lombok.Getter;\n+import lombok.Setter;\n+import lombok.ToString;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.UnexpectedException;\n+import org.apache.skywalking.oap.server.core.analysis.meter.MeterEntity;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.DataTable;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.remote.grpc.proto.RemoteData;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.annotation.Column;\n+\n+/**\n+ * AvgHistogram intends to aggregate raw values over the interval (minute, hour or day). When users query a value\n+ * from such a interval, an average over it will be sent back.\n+ *\n+ * The acceptable bucket value should be a result from one of \"increase\", \"rate\" and \"irate\" query functions.\n+ * That means the value is the increase or per-second instant rate of increase in a specific range.\n+ *\n+ * Example:\n+ * \"persistence_timer_bulk_execute_latency\" is histogram, the possible PromQL format of acceptable bucket value should be:\n+ * \"increase(persistence_timer_bulk_execute_latency{service=\"oap-server\", instance=\"localhost:1234\"}[5m])\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU1NDE0MA=="}, "originalCommit": {"oid": "351ee221fb4f71944055cb21f2262e942dfe57c6"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI5NjE1NQ==", "bodyText": "OK, then you need to think about how to reuse codes.", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r434296155", "createdAt": "2020-06-03T04:07:04Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/meter/function/AvgHistogramFunction.java", "diffHunk": "@@ -0,0 +1,219 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.analysis.meter.function;\n+\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import lombok.Getter;\n+import lombok.Setter;\n+import lombok.ToString;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.UnexpectedException;\n+import org.apache.skywalking.oap.server.core.analysis.meter.MeterEntity;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.DataTable;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.remote.grpc.proto.RemoteData;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.annotation.Column;\n+\n+/**\n+ * AvgHistogram intends to aggregate raw values over the interval (minute, hour or day). When users query a value\n+ * from such a interval, an average over it will be sent back.\n+ *\n+ * The acceptable bucket value should be a result from one of \"increase\", \"rate\" and \"irate\" query functions.\n+ * That means the value is the increase or per-second instant rate of increase in a specific range.\n+ *\n+ * Example:\n+ * \"persistence_timer_bulk_execute_latency\" is histogram, the possible PromQL format of acceptable bucket value should be:\n+ * \"increase(persistence_timer_bulk_execute_latency{service=\"oap-server\", instance=\"localhost:1234\"}[5m])\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU1NDE0MA=="}, "originalCommit": {"oid": "351ee221fb4f71944055cb21f2262e942dfe57c6"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTczMjc5MQ==", "bodyText": "may we split current functions into small pieces based on their roles.", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r435732791", "createdAt": "2020-06-05T07:16:58Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/meter/function/AvgHistogramFunction.java", "diffHunk": "@@ -0,0 +1,219 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.core.analysis.meter.function;\n+\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import lombok.Getter;\n+import lombok.Setter;\n+import lombok.ToString;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.oap.server.core.Const;\n+import org.apache.skywalking.oap.server.core.UnexpectedException;\n+import org.apache.skywalking.oap.server.core.analysis.meter.MeterEntity;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.DataTable;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.remote.grpc.proto.RemoteData;\n+import org.apache.skywalking.oap.server.core.storage.StorageBuilder;\n+import org.apache.skywalking.oap.server.core.storage.annotation.Column;\n+\n+/**\n+ * AvgHistogram intends to aggregate raw values over the interval (minute, hour or day). When users query a value\n+ * from such a interval, an average over it will be sent back.\n+ *\n+ * The acceptable bucket value should be a result from one of \"increase\", \"rate\" and \"irate\" query functions.\n+ * That means the value is the increase or per-second instant rate of increase in a specific range.\n+ *\n+ * Example:\n+ * \"persistence_timer_bulk_execute_latency\" is histogram, the possible PromQL format of acceptable bucket value should be:\n+ * \"increase(persistence_timer_bulk_execute_latency{service=\"oap-server\", instance=\"localhost:1234\"}[5m])\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU1NDE0MA=="}, "originalCommit": {"oid": "351ee221fb4f71944055cb21f2262e942dfe57c6"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMDY1Mjk3OnYy", "diffSide": "RIGHT", "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMDoyNDoyMFrOGdeLyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzoxNzo0OVrOGfjCrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU1NjQyNg==", "bodyText": "What is the app label used in the codes? Do we have a filterable name?(In the UI perspective) If not, I think we should consider to rename it.", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r433556426", "createdAt": "2020-06-02T00:24:20Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "diffHunk": "@@ -0,0 +1,170 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# This will parse a textual representation of a duration. The formats\n+# accepted are based on the ISO-8601 duration format {@code PnDTnHnMn.nS}\n+# with days considered to be exactly 24 hours.\n+# <p>\n+# Examples:\n+# <pre>\n+#    \"PT20.345S\" -- parses as \"20.345 seconds\"\n+#    \"PT15M\"     -- parses as \"15 minutes\" (where a minute is 60 seconds)\n+#    \"PT10H\"     -- parses as \"10 hours\" (where an hour is 3600 seconds)\n+#    \"P2D\"       -- parses as \"2 days\" (where a day is 24 hours or 86400 seconds)\n+#    \"P2DT3H4M\"  -- parses as \"2 days, 3 hours and 4 minutes\"\n+#    \"P-6H3M\"    -- parses as \"-6 hours and +3 minutes\"\n+#    \"-P6H3M\"    -- parses as \"-6 hours and -3 minutes\"\n+#    \"-P-6H+3M\"  -- parses as \"+6 hours and -3 minutes\"\n+# </pre>\n+fetcherInterval: PT15S\n+fetcherTimeout: PT10S\n+metricsPath: /metrics\n+staticConfig:\n+  # targets will be labeled as \"instance\"\n+  targets:\n+    - localhost:1234\n+  labels:\n+    app: oap-server\n+metricsRules:\n+  - name: instance_cpu_percentage\n+    scope: SERVICE_INSTANCE\n+    operation: avg\n+    sources:\n+      process_cpu_seconds_total:\n+        counterFunction: RATE\n+        range: PT1M\n+        scale: 2\n+        relabel:\n+          service:\n+            - app", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "351ee221fb4f71944055cb21f2262e942dfe57c6"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI5NTE5Mw==", "bodyText": "It's from staticConfig.labels. Yes, I can rename it to service", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r434295193", "createdAt": "2020-06-03T04:02:33Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "diffHunk": "@@ -0,0 +1,170 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# This will parse a textual representation of a duration. The formats\n+# accepted are based on the ISO-8601 duration format {@code PnDTnHnMn.nS}\n+# with days considered to be exactly 24 hours.\n+# <p>\n+# Examples:\n+# <pre>\n+#    \"PT20.345S\" -- parses as \"20.345 seconds\"\n+#    \"PT15M\"     -- parses as \"15 minutes\" (where a minute is 60 seconds)\n+#    \"PT10H\"     -- parses as \"10 hours\" (where an hour is 3600 seconds)\n+#    \"P2D\"       -- parses as \"2 days\" (where a day is 24 hours or 86400 seconds)\n+#    \"P2DT3H4M\"  -- parses as \"2 days, 3 hours and 4 minutes\"\n+#    \"P-6H3M\"    -- parses as \"-6 hours and +3 minutes\"\n+#    \"-P6H3M\"    -- parses as \"-6 hours and -3 minutes\"\n+#    \"-P-6H+3M\"  -- parses as \"+6 hours and -3 minutes\"\n+# </pre>\n+fetcherInterval: PT15S\n+fetcherTimeout: PT10S\n+metricsPath: /metrics\n+staticConfig:\n+  # targets will be labeled as \"instance\"\n+  targets:\n+    - localhost:1234\n+  labels:\n+    app: oap-server\n+metricsRules:\n+  - name: instance_cpu_percentage\n+    scope: SERVICE_INSTANCE\n+    operation: avg\n+    sources:\n+      process_cpu_seconds_total:\n+        counterFunction: RATE\n+        range: PT1M\n+        scale: 2\n+        relabel:\n+          service:\n+            - app", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU1NjQyNg=="}, "originalCommit": {"oid": "351ee221fb4f71944055cb21f2262e942dfe57c6"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI5Njg4Mg==", "bodyText": "Please do.", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r434296882", "createdAt": "2020-06-03T04:10:21Z", "author": {"login": "wu-sheng"}, "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "diffHunk": "@@ -0,0 +1,170 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# This will parse a textual representation of a duration. The formats\n+# accepted are based on the ISO-8601 duration format {@code PnDTnHnMn.nS}\n+# with days considered to be exactly 24 hours.\n+# <p>\n+# Examples:\n+# <pre>\n+#    \"PT20.345S\" -- parses as \"20.345 seconds\"\n+#    \"PT15M\"     -- parses as \"15 minutes\" (where a minute is 60 seconds)\n+#    \"PT10H\"     -- parses as \"10 hours\" (where an hour is 3600 seconds)\n+#    \"P2D\"       -- parses as \"2 days\" (where a day is 24 hours or 86400 seconds)\n+#    \"P2DT3H4M\"  -- parses as \"2 days, 3 hours and 4 minutes\"\n+#    \"P-6H3M\"    -- parses as \"-6 hours and +3 minutes\"\n+#    \"-P6H3M\"    -- parses as \"-6 hours and -3 minutes\"\n+#    \"-P-6H+3M\"  -- parses as \"+6 hours and -3 minutes\"\n+# </pre>\n+fetcherInterval: PT15S\n+fetcherTimeout: PT10S\n+metricsPath: /metrics\n+staticConfig:\n+  # targets will be labeled as \"instance\"\n+  targets:\n+    - localhost:1234\n+  labels:\n+    app: oap-server\n+metricsRules:\n+  - name: instance_cpu_percentage\n+    scope: SERVICE_INSTANCE\n+    operation: avg\n+    sources:\n+      process_cpu_seconds_total:\n+        counterFunction: RATE\n+        range: PT1M\n+        scale: 2\n+        relabel:\n+          service:\n+            - app", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU1NjQyNg=="}, "originalCommit": {"oid": "351ee221fb4f71944055cb21f2262e942dfe57c6"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTczMzE2NA==", "bodyText": "done", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r435733164", "createdAt": "2020-06-05T07:17:49Z", "author": {"login": "hanahmily"}, "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "diffHunk": "@@ -0,0 +1,170 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# This will parse a textual representation of a duration. The formats\n+# accepted are based on the ISO-8601 duration format {@code PnDTnHnMn.nS}\n+# with days considered to be exactly 24 hours.\n+# <p>\n+# Examples:\n+# <pre>\n+#    \"PT20.345S\" -- parses as \"20.345 seconds\"\n+#    \"PT15M\"     -- parses as \"15 minutes\" (where a minute is 60 seconds)\n+#    \"PT10H\"     -- parses as \"10 hours\" (where an hour is 3600 seconds)\n+#    \"P2D\"       -- parses as \"2 days\" (where a day is 24 hours or 86400 seconds)\n+#    \"P2DT3H4M\"  -- parses as \"2 days, 3 hours and 4 minutes\"\n+#    \"P-6H3M\"    -- parses as \"-6 hours and +3 minutes\"\n+#    \"-P6H3M\"    -- parses as \"-6 hours and -3 minutes\"\n+#    \"-P-6H+3M\"  -- parses as \"+6 hours and -3 minutes\"\n+# </pre>\n+fetcherInterval: PT15S\n+fetcherTimeout: PT10S\n+metricsPath: /metrics\n+staticConfig:\n+  # targets will be labeled as \"instance\"\n+  targets:\n+    - localhost:1234\n+  labels:\n+    app: oap-server\n+metricsRules:\n+  - name: instance_cpu_percentage\n+    scope: SERVICE_INSTANCE\n+    operation: avg\n+    sources:\n+      process_cpu_seconds_total:\n+        counterFunction: RATE\n+        range: PT1M\n+        scale: 2\n+        relabel:\n+          service:\n+            - app", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU1NjQyNg=="}, "originalCommit": {"oid": "351ee221fb4f71944055cb21f2262e942dfe57c6"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTMyOTc5OnYy", "diffSide": "RIGHT", "path": "dist-material/release-docs/NOTICE", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMzoyMzo1MlrOGfuTMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNDoyNjoyOFrOGfwyyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkxNzYxOQ==", "bodyText": "This is standard Notice of ASF. As we are both belong to the foundation. We don't need this", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r435917619", "createdAt": "2020-06-05T13:23:52Z", "author": {"login": "wu-sheng"}, "path": "dist-material/release-docs/NOTICE", "diffHunk": "@@ -914,4 +914,15 @@ MessagePackage Notice\n This product includes the software developed by third-party:\n \n  * Google Guava https://code.google.com/p/guava-libraries/  (APL2)\n- * sbt-extras: https://github.com/paulp/sbt-extras  (BSD)  (LICENSE.sbt-extras.txt)\n\\ No newline at end of file\n+ * sbt-extras: https://github.com/paulp/sbt-extras  (BSD)  (LICENSE.sbt-extras.txt)\n+\n+========================================================================", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed701c15ce02767501caf342c2ca03bfd0a2a20b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk1ODQ3NQ==", "bodyText": "dropped", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r435958475", "createdAt": "2020-06-05T14:26:28Z", "author": {"login": "hanahmily"}, "path": "dist-material/release-docs/NOTICE", "diffHunk": "@@ -914,4 +914,15 @@ MessagePackage Notice\n This product includes the software developed by third-party:\n \n  * Google Guava https://code.google.com/p/guava-libraries/  (APL2)\n- * sbt-extras: https://github.com/paulp/sbt-extras  (BSD)  (LICENSE.sbt-extras.txt)\n\\ No newline at end of file\n+ * sbt-extras: https://github.com/paulp/sbt-extras  (BSD)  (LICENSE.sbt-extras.txt)\n+\n+========================================================================", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkxNzYxOQ=="}, "originalCommit": {"oid": "ed701c15ce02767501caf342c2ca03bfd0a2a20b"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTMzOTU0OnYy", "diffSide": "RIGHT", "path": "pom.xml", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMzoyNjozNlrOGfuZoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQwNTo0NDo0M1rOGgCC2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkxOTI2NA==", "bodyText": "Why need this? Seem strange", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r435919264", "createdAt": "2020-06-05T13:26:36Z", "author": {"login": "wu-sheng"}, "path": "pom.xml", "diffHunk": "@@ -492,6 +492,7 @@\n                         <exclude>**/*.pem</exclude>\n \n                         <exclude>.m2/**</exclude>\n+                        <exclude>~/.m2/**</exclude>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed701c15ce02767501caf342c2ca03bfd0a2a20b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk1NDE5OA==", "bodyText": "When issuing ./mvnw verify, I get rat errors as below\nFiles with unapproved licenses:\n\n  ~/.m2/repository/commons-codec/commons-codec/1.9/commons-codec-1.9.jar.sha1\n  ~/.m2/repository/commons-codec/commons-codec/1.9/_remote.repositories\n  ~/.m2/repository/commons-codec/commons-codec/1.9/commons-codec-1.9.pom.sha1\n  ~/.m2/repository/commons-codec/commons-codec/1.6/commons-codec-1.6.pom.sha1\n  ~/.m2/repository/commons-codec/commons-codec/1.6/commons-codec-1.6.jar.sha1\n  ~/.m2/repository/commons-codec/commons-codec/1.6/_remote.repositories\n....\n\nAny other suggestions more than this line?", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r435954198", "createdAt": "2020-06-05T14:19:44Z", "author": {"login": "hanahmily"}, "path": "pom.xml", "diffHunk": "@@ -492,6 +492,7 @@\n                         <exclude>**/*.pem</exclude>\n \n                         <exclude>.m2/**</exclude>\n+                        <exclude>~/.m2/**</exclude>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkxOTI2NA=="}, "originalCommit": {"oid": "ed701c15ce02767501caf342c2ca03bfd0a2a20b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk3ODUwNQ==", "bodyText": "Strange, never have jar in this folder", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r435978505", "createdAt": "2020-06-05T14:57:59Z", "author": {"login": "wu-sheng"}, "path": "pom.xml", "diffHunk": "@@ -492,6 +492,7 @@\n                         <exclude>**/*.pem</exclude>\n \n                         <exclude>.m2/**</exclude>\n+                        <exclude>~/.m2/**</exclude>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkxOTI2NA=="}, "originalCommit": {"oid": "ed701c15ce02767501caf342c2ca03bfd0a2a20b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0MTExMw==", "bodyText": "The ~/.m2 is not in the scope of the project and must not be analyzed by ./mvnw verify, unless your local maven settings is wrong that makes it generate a real folder named ~ under the project, if that's the case, git status will also show they're untracked, just a hint", "url": "https://github.com/apache/skywalking/pull/4783#discussion_r436241113", "createdAt": "2020-06-06T05:44:43Z", "author": {"login": "kezhenxu94"}, "path": "pom.xml", "diffHunk": "@@ -492,6 +492,7 @@\n                         <exclude>**/*.pem</exclude>\n \n                         <exclude>.m2/**</exclude>\n+                        <exclude>~/.m2/**</exclude>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkxOTI2NA=="}, "originalCommit": {"oid": "ed701c15ce02767501caf342c2ca03bfd0a2a20b"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 153, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}