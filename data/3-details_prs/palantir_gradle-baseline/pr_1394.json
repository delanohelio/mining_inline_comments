{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMwNTk4NTEw", "number": 1394, "title": "Added support for logsafe Arg arrays in Slf4jLogsafeArgs.", "bodyText": "Before this PR\nSlf4jLogsafeArgs complains that an Arg<?>[] isn't a logsafe argument.\nAfter this PR\n==COMMIT_MSG==\nSlf4jLogsafeArgs now allows Arg<?>[] to be passed as vararg argument to logging methods.\n==COMMIT_MSG==\nPossible downsides?\nNone.\nContext\nOnly allowing Arg<?>[] gets us half way. Compiler would still give the the following diagnostic warning:\n... non-varargs call of varargs method with inexact argument type for last parameter;\n        cast to java.lang.Object for a varargs call\n        cast to java.lang.Object[] for a non-varargs call and to suppress this warning \n\nBy following the above suggestion and casting to Object[] the expression is no longer of Arg<?>[] type, hence we add support also for Arg<?>[] cast into an Object[].\nFor // BUG: Diagnostic contains: varargs method with inexact argument to work, we can't only pick up Slf4jLogsafeArgs diagnostics, so we add .matchAllDiagnostics().\nWith .matchAllDiagnostics() we need to add @SuppressWarnings(\"deprecation\") in order to avoid diagnostics about hasChildren being deprecated.", "createdAt": "2020-06-08T02:16:06Z", "url": "https://github.com/palantir/gradle-baseline/pull/1394", "merged": true, "mergeCommit": {"oid": "d1daefb535b65c1a6da51169a29b1d0008249e97"}, "closed": true, "closedAt": "2020-06-17T20:17:42Z", "author": {"login": "aioobe"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpGrLPAH2gAyNDMwNTk4NTEwOjkyZmQ1MjA2M2ZjNzQxNGM2YWJjYWI3MzBiM2VlNGIwMjI1NjY3Mjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsNPkJgH2gAyNDMwNTk4NTEwOjUyOTk4Y2E3MDhiMTIxMjQ5MTFmNWUxYjhhYTc0M2VmYzk5Zjg0NTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "92fd52063fc7414c6abcab730b3ee4b022566728", "author": {"user": {"login": "aioobe", "name": "Andreas Lundblad"}}, "url": "https://github.com/palantir/gradle-baseline/commit/92fd52063fc7414c6abcab730b3ee4b022566728", "committedDate": "2020-06-08T02:03:34Z", "message": "Added support for logsafe Arg arrays in Slf4jLogsafeArgs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bad8278c2530f254d4f781730b73fbadffe4886", "author": {"user": {"login": "aioobe", "name": "Andreas Lundblad"}}, "url": "https://github.com/palantir/gradle-baseline/commit/1bad8278c2530f254d4f781730b73fbadffe4886", "committedDate": "2020-06-08T06:25:37Z", "message": "Reduced cyclomatic complexity."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9eb188b96d85a54891429c5eb724bb96f3ec8eb", "author": {"user": {"login": "aioobe", "name": "Andreas Lundblad"}}, "url": "https://github.com/palantir/gradle-baseline/commit/d9eb188b96d85a54891429c5eb724bb96f3ec8eb", "committedDate": "2020-06-11T05:16:10Z", "message": "Simplified logic. Vararg array argument now goes through regardless of type."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MTYwMzQ3", "url": "https://github.com/palantir/gradle-baseline/pull/1394#pullrequestreview-429160347", "createdAt": "2020-06-11T17:59:42Z", "commit": {"oid": "d9eb188b96d85a54891429c5eb724bb96f3ec8eb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNzo1OTo0MlrOGioyug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNzo1OTo0MlrOGioyug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MzExNA==", "bodyText": "Any chance we can avoid the stream here? This code is super hot because we log a lot of things, one large internal project in particular benefits from any compile speedup we can provide!", "url": "https://github.com/palantir/gradle-baseline/pull/1394#discussion_r438973114", "createdAt": "2020-06-11T17:59:42Z", "author": {"login": "carterkozak"}, "path": "baseline-error-prone/src/main/java/com/palantir/baseline/errorprone/Slf4jLogsafeArgs.java", "diffHunk": "@@ -68,24 +73,27 @@ public Description matchMethodInvocation(MethodInvocationTree tree, VisitorState\n         }\n \n         List<? extends ExpressionTree> allArgs = tree.getArguments();\n-        int lastIndex = allArgs.size() - 1;\n-        int startArg = MARKER.matches(allArgs.get(0), state) ? 2 : 1;\n-        ExpressionTree lastArg = allArgs.get(lastIndex);\n-        boolean lastArgIsThrowable = THROWABLE.matches(lastArg, state);\n-        int endArg = lastArgIsThrowable ? lastIndex - 1 : lastIndex;\n+        int startArgIndex = MARKER.matches(allArgs.get(0), state) ? 2 : 1;\n+        int lastArgIndex = allArgs.size() - 1;\n+        ExpressionTree lastArg = allArgs.get(lastArgIndex);\n \n-        ImmutableList.Builder<Integer> badArgsBuilder = ImmutableList.builder();\n-        for (int i = startArg; i <= endArg; i++) {\n-            if (!ARG.matches(allArgs.get(i), state)) {\n-                badArgsBuilder.add(i);\n-            }\n+        if (startArgIndex == lastArgIndex && OBJECT_ARRAY.matches(lastArg, state)) {\n+            return Description.NO_MATCH;\n         }\n-        List<Integer> badArgs = badArgsBuilder.build();\n-        if (badArgs.isEmpty() || TestCheckUtils.isTestCode(state)) {\n+\n+        boolean lastArgIsThrowable = THROWABLE.matches(lastArg, state);\n+        int lastNonThrowableArgIndex = lastArgIsThrowable ? lastArgIndex - 1 : lastArgIndex;\n+\n+        List<Integer> badArgIndices = IntStream.rangeClosed(startArgIndex, lastNonThrowableArgIndex)\n+                .filter(i -> !ARG.matches(allArgs.get(i), state))\n+                .boxed()\n+                .collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9eb188b96d85a54891429c5eb724bb96f3ec8eb"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MTYwNjAx", "url": "https://github.com/palantir/gradle-baseline/pull/1394#pullrequestreview-429160601", "createdAt": "2020-06-11T18:00:03Z", "commit": {"oid": "d9eb188b96d85a54891429c5eb724bb96f3ec8eb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxODowMDowM1rOGiozfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxODowMDowM1rOGiozfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MzMwOQ==", "bodyText": "nice", "url": "https://github.com/palantir/gradle-baseline/pull/1394#discussion_r438973309", "createdAt": "2020-06-11T18:00:03Z", "author": {"login": "carterkozak"}, "path": "baseline-error-prone/src/test/java/com/palantir/baseline/errorprone/Slf4jLogsafeArgsTest.java", "diffHunk": "@@ -47,6 +47,7 @@ private void test(String logArgs, String failingArgs) throws Exception {\n                         \"    public String getName() { return null; }\",\n                         \"    public void add(Marker reference) {}\",\n                         \"    public boolean remove(Marker reference) { return true; }\",\n+                        \"    @SuppressWarnings(\\\"deprecation\\\")\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9eb188b96d85a54891429c5eb724bb96f3ec8eb"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2de50062a96ed5d1fb2e012e7bc4337acab5fa8f", "author": {"user": {"login": "aioobe", "name": "Andreas Lundblad"}}, "url": "https://github.com/palantir/gradle-baseline/commit/2de50062a96ed5d1fb2e012e7bc4337acab5fa8f", "committedDate": "2020-06-12T19:31:43Z", "message": "Reverted from Stream to for loop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79c2523037ea3f73abcd512225a9957a2aa45f44", "author": {"user": {"login": "aioobe", "name": "Andreas Lundblad"}}, "url": "https://github.com/palantir/gradle-baseline/commit/79c2523037ea3f73abcd512225a9957a2aa45f44", "committedDate": "2020-06-17T16:19:04Z", "message": "Added changelog entry."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bd2a1e0bafa7199bf2220c44e6b5dae06992519", "author": {"user": {"login": "aldexis", "name": null}}, "url": "https://github.com/palantir/gradle-baseline/commit/3bd2a1e0bafa7199bf2220c44e6b5dae06992519", "committedDate": "2020-06-17T16:36:20Z", "message": "Improve gradle-baseline-java integration with IntelliJ import (#1411)\n\nAdds the proper configuration files upon IntelliJ import of a gradle project for checkstyle and copyright.\r\n\r\nThis generates the following additional files:\r\n- .idea/copyright/profiles_settings.xml\r\n- an xml file under .idea/copyright/ per copyright file under .baseline/copyright\r\n- .idea/checkstyle-idea.xml (and adds Checkstyle-IDEA to the external dependencies) if baseline-checkstyle is applied\r\n- Either .idea/codeStyleSettings.xml or a .idea/codeStyles/ folder with the contents being copied from .baseline/idea\r\n  - If .baseline/idea/codeStyles is present, it will copy its contents, otherwise, it will fall back to .baseline/idea/intellij-java-palantir-style.xml as currently\r\n  - The fallback is using a legacy IntelliJ format and requires closing and reopening the project to be taken into account"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1c1f638c0831a727ff656501ba3b9ab1a62cf69", "author": {"user": {"login": "svc-autorelease", "name": null}}, "url": "https://github.com/palantir/gradle-baseline/commit/f1c1f638c0831a727ff656501ba3b9ab1a62cf69", "committedDate": "2020-06-17T16:36:21Z", "message": "Autorelease 3.28.0"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNTgxMDcy", "url": "https://github.com/palantir/gradle-baseline/pull/1394#pullrequestreview-432581072", "createdAt": "2020-06-17T16:39:58Z", "commit": {"oid": "79c2523037ea3f73abcd512225a9957a2aa45f44"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "792859bb7cb9a47e70ea83874554d18d81e41da2", "author": {"user": {"login": "aioobe", "name": "Andreas Lundblad"}}, "url": "https://github.com/palantir/gradle-baseline/commit/792859bb7cb9a47e70ea83874554d18d81e41da2", "committedDate": "2020-06-17T17:23:26Z", "message": "Added support for logsafe Arg arrays in Slf4jLogsafeArgs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b925b5d299737fb4e7b9af3dd1aea745832685e", "author": {"user": {"login": "aioobe", "name": "Andreas Lundblad"}}, "url": "https://github.com/palantir/gradle-baseline/commit/2b925b5d299737fb4e7b9af3dd1aea745832685e", "committedDate": "2020-06-17T17:23:26Z", "message": "Reduced cyclomatic complexity."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c93356b0c52b153511cc81b212362da00e2f5e99", "author": {"user": {"login": "aioobe", "name": "Andreas Lundblad"}}, "url": "https://github.com/palantir/gradle-baseline/commit/c93356b0c52b153511cc81b212362da00e2f5e99", "committedDate": "2020-06-17T17:23:26Z", "message": "Simplified logic. Vararg array argument now goes through regardless of type."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e80f07a43055be3260058d558a1d027b815eed3b", "author": {"user": {"login": "aioobe", "name": "Andreas Lundblad"}}, "url": "https://github.com/palantir/gradle-baseline/commit/e80f07a43055be3260058d558a1d027b815eed3b", "committedDate": "2020-06-17T17:23:26Z", "message": "Reverted from Stream to for loop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e45c87434e93332e1fb775240add76d10aa18d90", "author": {"user": {"login": "aioobe", "name": "Andreas Lundblad"}}, "url": "https://github.com/palantir/gradle-baseline/commit/e45c87434e93332e1fb775240add76d10aa18d90", "committedDate": "2020-06-17T17:23:26Z", "message": "Added changelog entry."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52998ca708b12124911f5e1b8aa743efc99f8456", "author": {"user": {"login": "aioobe", "name": "Andreas Lundblad"}}, "url": "https://github.com/palantir/gradle-baseline/commit/52998ca708b12124911f5e1b8aa743efc99f8456", "committedDate": "2020-06-17T17:24:31Z", "message": "Merge branch 'fix-safe-args-warning' of github.com:aioobe/gradle-baseline into fix-safe-args-warning"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2138, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}