{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzMDY5MzI3", "number": 1283, "title": "Fix class uniqueness non-deterministic ordering", "bodyText": "Before this PR\nThere isn't a deterministic ordering on various parts of the baseline-class-uniqueness.lock file that's produced. This can cause failures as the generated file is different from the one on disk, despite having the same information.\nAfter this PR\n==COMMIT_MSG==\nThe checkClassUniqueness will no longer spuriously fail due to inconsistent ordering in the baseline-class-uniqueness.lock file.\n==COMMIT_MSG==", "createdAt": "2020-03-03T17:04:20Z", "url": "https://github.com/palantir/gradle-baseline/pull/1283", "merged": true, "mergeCommit": {"oid": "ab4bfae5caf1d26b9ae4597bdbb5d2c866796618"}, "closed": true, "closedAt": "2020-03-04T13:22:51Z", "author": {"login": "CRogers"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKFWdfgH2gAyMzgzMDY5MzI3OjAyMThhYjI2ZjAyMzEzOTIzODEwMTY3MTRiMjM3ZDc2N2Y0ZDI1ZDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKWxqigFqTM2ODc2NzQ3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0218ab26f0231392381016714b237d767f4d25d9", "author": {"user": {"login": "CRogers", "name": "Callum Rogers"}}, "url": "https://github.com/palantir/gradle-baseline/commit/0218ab26f0231392381016714b237d767f4d25d9", "committedDate": "2020-03-03T16:59:23Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d7d46e3b8d5e7a66d461e16e281c1d80cec571e", "author": {"user": {"login": "CRogers", "name": "Callum Rogers"}}, "url": "https://github.com/palantir/gradle-baseline/commit/4d7d46e3b8d5e7a66d461e16e281c1d80cec571e", "committedDate": "2020-03-03T16:59:23Z", "message": "Fix class uniqueness non-deterministic ordering"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a618c7a1d6760f767cda7e8b3e39044c697b5f5", "author": {"user": {"login": "CRogers", "name": "Callum Rogers"}}, "url": "https://github.com/palantir/gradle-baseline/commit/5a618c7a1d6760f767cda7e8b3e39044c697b5f5", "committedDate": "2020-03-03T16:59:23Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "316168e559c54afb47a4ca5a983f55a77207af39", "author": {"user": {"login": "CRogers", "name": "Callum Rogers"}}, "url": "https://github.com/palantir/gradle-baseline/commit/316168e559c54afb47a4ca5a983f55a77207af39", "committedDate": "2020-03-03T18:13:56Z", "message": "Fix imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bde6e134c05257ba1732f96e5f7c088a4bf9d905", "author": {"user": {"login": "CRogers", "name": "Callum Rogers"}}, "url": "https://github.com/palantir/gradle-baseline/commit/bde6e134c05257ba1732f96e5f7c088a4bf9d905", "committedDate": "2020-03-03T18:14:00Z", "message": "Merge branch 'callumr/fix-class-uniqueness-non-unique-order' of github.com:palantir/gradle-baseline into callumr/fix-class-uniqueness-non-unique-order"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MjI1NDYz", "url": "https://github.com/palantir/gradle-baseline/pull/1283#pullrequestreview-368225463", "createdAt": "2020-03-03T18:36:54Z", "commit": {"oid": "bde6e134c05257ba1732f96e5f7c088a4bf9d905"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxODozNjo1NFrOFxRvMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxODozNjo1NFrOFxRvMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIxNTE1NQ==", "bodyText": "why not just put them in a sorted map?", "url": "https://github.com/palantir/gradle-baseline/pull/1283#discussion_r387215155", "createdAt": "2020-03-03T18:36:54Z", "author": {"login": "dansanduleac"}, "path": "gradle-baseline-java/src/main/groovy/com/palantir/baseline/tasks/CheckClassUniquenessLockTask.java", "diffHunk": "@@ -92,25 +94,18 @@ public final void doIt() {\n                         return Optional.empty();\n                     }\n \n-                    StringBuilder stringBuilder = new StringBuilder();\n-                    // TODO(dfox): ensure we iterate through problemJars in a stable order\n-                    for (Set<ModuleVersionIdentifier> clashingJars : problemJars) {\n-                        stringBuilder\n-                                .append(clashingJars.stream()\n-                                        .map(mvi -> mvi.getGroup() + \":\" + mvi.getName())\n-                                        .sorted()\n-                                        .collect(Collectors.joining(\", \", \"[\", \"]\")))\n-                                .append('\\n');\n-\n-                        analyzer.getDifferingSharedClassesInProblemJars(clashingJars).stream()\n-                                .sorted()\n-                                .forEach(className -> {\n-                                    stringBuilder.append(\"  - \");\n-                                    stringBuilder.append(className);\n-                                    stringBuilder.append('\\n');\n-                                });\n-                    }\n-                    return Optional.of(stringBuilder.toString());\n+                    Map<String, String> clashingHeadersToClasses = problemJars.stream()\n+                            .collect(Collectors.toMap(\n+                                    this::clashingJarHeader, clashingJars -> clashingClasses(analyzer, clashingJars)));\n+\n+                    return Optional.of(clashingHeadersToClasses.entrySet().stream()\n+                            .sorted(Comparator.comparing(Map.Entry::getKey))\n+                            .flatMap(entry -> {\n+                                String clashingJarHeader = entry.getKey();\n+                                String clashingClasses = entry.getValue();\n+                                return Stream.of(clashingJarHeader, clashingClasses);\n+                            })\n+                            .collect(Collectors.joining(\"\\n\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bde6e134c05257ba1732f96e5f7c088a4bf9d905"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a143e2d9aa159bee19958f205674ebc19b098fd", "author": {"user": {"login": "dansanduleac", "name": "Dan S\u0103nduleac"}}, "url": "https://github.com/palantir/gradle-baseline/commit/8a143e2d9aa159bee19958f205674ebc19b098fd", "committedDate": "2020-03-04T12:29:48Z", "message": "sort directly via ImmutableSortedMap"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87c5747a183261415dfbf56253515f49152c6043", "author": {"user": {"login": "dansanduleac", "name": "Dan S\u0103nduleac"}}, "url": "https://github.com/palantir/gradle-baseline/commit/87c5747a183261415dfbf56253515f49152c6043", "committedDate": "2020-03-04T12:32:38Z", "message": "use more sorted maps"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzQ5NDEz", "url": "https://github.com/palantir/gradle-baseline/pull/1283#pullrequestreview-368749413", "createdAt": "2020-03-04T12:49:58Z", "commit": {"oid": "87c5747a183261415dfbf56253515f49152c6043"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzY3NDcx", "url": "https://github.com/palantir/gradle-baseline/pull/1283#pullrequestreview-368767471", "createdAt": "2020-03-04T13:17:29Z", "commit": {"oid": "87c5747a183261415dfbf56253515f49152c6043"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2174, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}