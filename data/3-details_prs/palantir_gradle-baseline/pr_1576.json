{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5NTY3NTM5", "number": 1576, "title": "Saner test event logging default for CI", "bodyText": "Before this PR\nWe've seen numerous times that when projects have long running integration test tasks that take longer than 10 mins they get killed by circle (\"context deadline exceeded\"). If there are no failing tests we won't print anything in the gradle output, so it's possible to hit this deadline.\nAfter this PR\n\n==COMMIT_MSG==\nPrint more test logging output to avoid builds with long running tests getting terminated by circle (\"context deadline exceeded\").\n==COMMIT_MSG==\nPossible downsides?\nPerhaps more noisy, but the failed tests already have junit xml produced in circle, so this should be strictly better.", "createdAt": "2020-11-30T13:57:40Z", "url": "https://github.com/palantir/gradle-baseline/pull/1576", "merged": true, "mergeCommit": {"oid": "6970038a6def3e8d562d06707b1afc6a00e7e92d"}, "closed": true, "closedAt": "2020-11-30T19:32:52Z", "author": {"login": "CRogers"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhlrNOgH2gAyNTI5NTY3NTM5OmYzM2I2NGE1YTE2NDU5M2RlMjIzMjUyODE4YWY3ZTYxM2IzNTQ1MjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhqkl3gFqTU0MTIyNzM0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f33b64a5a164593de223252818af7e613b354526", "author": {"user": {"login": "CRogers", "name": "Callum Rogers"}}, "url": "https://github.com/palantir/gradle-baseline/commit/f33b64a5a164593de223252818af7e613b354526", "committedDate": "2020-11-30T13:50:25Z", "message": "Saner test event logging default for CI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d702a859a0e8a6254a280f372ec24bb22eb05dda", "author": {"user": {"login": "CRogers", "name": "Callum Rogers"}}, "url": "https://github.com/palantir/gradle-baseline/commit/d702a859a0e8a6254a280f372ec24bb22eb05dda", "committedDate": "2020-11-30T13:50:25Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTMzNzA2", "url": "https://github.com/palantir/gradle-baseline/pull/1576#pullrequestreview-540933706", "createdAt": "2020-11-30T14:01:21Z", "commit": {"oid": "d702a859a0e8a6254a280f372ec24bb22eb05dda"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTE4MjA0", "url": "https://github.com/palantir/gradle-baseline/pull/1576#pullrequestreview-541118204", "createdAt": "2020-11-30T17:11:04Z", "commit": {"oid": "d702a859a0e8a6254a280f372ec24bb22eb05dda"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTY4ODY2", "url": "https://github.com/palantir/gradle-baseline/pull/1576#pullrequestreview-541168866", "createdAt": "2020-11-30T18:13:06Z", "commit": {"oid": "d702a859a0e8a6254a280f372ec24bb22eb05dda"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODoxMzowNlrOH8Hi0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODoxMzowNlrOH8Hi0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgwMDIwOQ==", "bodyText": "@CRogers can we try to not apply this to the ./gradlew test tasks which are normally just unit-tests??", "url": "https://github.com/palantir/gradle-baseline/pull/1576#discussion_r532800209", "createdAt": "2020-11-30T18:13:06Z", "author": {"login": "iamdanfox"}, "path": "gradle-baseline-java/src/main/groovy/com/palantir/baseline/plugins/BaselineTesting.java", "diffHunk": "@@ -140,8 +142,17 @@ private static void enableJunit5ForTestTask(Test task) {\n         // Computes the desired parallelism based on the number of available processors/cores\n         task.systemProperty(\"junit.jupiter.execution.parallel.config.strategy\", \"dynamic\");\n \n-        // provide some stdout feedback when tests fail\n-        task.testLogging(testLogging -> testLogging.events(\"failed\"));\n+        // provide some stdout feedback when tests fail when running on CI and locally\n+        task.getTestLogging().getEvents().add(TestLogEvent.FAILED);\n+\n+        // Only on CI, print out more detailed test information to avoid hitting the circleci 10 min deadline if\n+        // there are lots of tests. Don't do this locally to avoid spamming massive amount of info for people running\n+        // unit tests through the command line\n+        if (\"true\".equals(System.getenv(\"CI\"))) {\n+            task.getTestLogging()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d702a859a0e8a6254a280f372ec24bb22eb05dda"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9924c33b2904c0cd0924341d4ef4030081adedb", "author": {"user": {"login": "CRogers", "name": "Callum Rogers"}}, "url": "https://github.com/palantir/gradle-baseline/commit/e9924c33b2904c0cd0924341d4ef4030081adedb", "committedDate": "2020-11-30T18:23:58Z", "message": "Only when not the test task"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "249c449c2a3d7e5833500d974c788f3c18f33351", "author": {"user": {"login": "CRogers", "name": "Callum Rogers"}}, "url": "https://github.com/palantir/gradle-baseline/commit/249c449c2a3d7e5833500d974c788f3c18f33351", "committedDate": "2020-11-30T18:26:04Z", "message": "Merge branch 'callumr/saner-test-logging-defaults' of github.com:palantir/gradle-baseline into callumr/saner-test-logging-defaults"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMjI3MzQ5", "url": "https://github.com/palantir/gradle-baseline/pull/1576#pullrequestreview-541227349", "createdAt": "2020-11-30T19:32:43Z", "commit": {"oid": "249c449c2a3d7e5833500d974c788f3c18f33351"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2022, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}