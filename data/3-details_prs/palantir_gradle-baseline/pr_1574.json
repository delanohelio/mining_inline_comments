{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4Njk5ODkx", "number": 1574, "title": "baseline-reproducibility validates that sourceCompatibility is set explicitly", "bodyText": "Before this PR\nTo get a new JVM rolled out fleet wide, we blast out excavators which just dial up the JVM used at CI time.  This has been pretty much fine so far as most projects set sourceCompatibility explicitly, but nothing actually validates this right now.\nOccasionally, this manifests as a question in #dev-foundry-infra about the product-dependencies.lock file differing locally on CI (because on CI it's inferring java 15) and locally it's inferring whatever JVM the dev is using, often 11.\nAfter this PR\n==COMMIT_MSG==\nbaseline-reproducibility validates that sourceCompatibility is set explicitly using a new checkExplicitSourceCompatibility task.\n==COMMIT_MSG==\nPossible downsides?\n\nit's one more task that will get registered on every project, also can't see any reasonable way of caching this badboy", "createdAt": "2020-11-27T16:27:08Z", "url": "https://github.com/palantir/gradle-baseline/pull/1574", "merged": true, "mergeCommit": {"oid": "6aeb8478174a968b2087fc08dbf9a55fa3b86325"}, "closed": true, "closedAt": "2020-11-30T13:12:04Z", "author": {"login": "iamdanfox"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgppMjgH2gAyNTI4Njk5ODkxOmQwNmQzYzVjZjZiYjA2MDQ3YjljMzBlZDhlZTI3NDYxMDljMjczZDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhlBoGAH2gAyNTI4Njk5ODkxOjBkZGJkZWMyYmEyYTQzY2QwYWUwMDFiOGY4MGIzMmUwMjBiZDliNjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d06d3c5cf6bb06047b9c30ed8ee2746109c273d2", "author": {"user": {"login": "iamdanfox", "name": null}}, "url": "https://github.com/palantir/gradle-baseline/commit/d06d3c5cf6bb06047b9c30ed8ee2746109c273d2", "committedDate": "2020-11-27T15:53:55Z", "message": "New 'checkExplicitSourceCompatibility' task"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8f3f28e8b3b1426ec8443a9e7a5289dbdfe6667", "author": {"user": {"login": "iamdanfox", "name": null}}, "url": "https://github.com/palantir/gradle-baseline/commit/d8f3f28e8b3b1426ec8443a9e7a5289dbdfe6667", "committedDate": "2020-11-27T16:07:06Z", "message": "Clearer error message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b2373f023f83ac84e3b8b474e2a142c862a8815", "author": {"user": {"login": "iamdanfox", "name": null}}, "url": "https://github.com/palantir/gradle-baseline/commit/8b2373f023f83ac84e3b8b474e2a142c862a8815", "committedDate": "2020-11-27T16:10:32Z", "message": "Fail harder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d810d549ab3127bfaa747e02e8f9c6fa110a5ff9", "author": {"user": {"login": "iamdanfox", "name": null}}, "url": "https://github.com/palantir/gradle-baseline/commit/d810d549ab3127bfaa747e02e8f9c6fa110a5ff9", "committedDate": "2020-11-27T16:22:24Z", "message": "Integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fade5c8f8630e08872a2f85312540901584f4b0", "author": {"user": {"login": "iamdanfox", "name": null}}, "url": "https://github.com/palantir/gradle-baseline/commit/3fade5c8f8630e08872a2f85312540901584f4b0", "committedDate": "2020-11-27T16:22:24Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMDkwNTY5", "url": "https://github.com/palantir/gradle-baseline/pull/1574#pullrequestreview-540090569", "createdAt": "2020-11-27T16:31:05Z", "commit": {"oid": "3fade5c8f8630e08872a2f85312540901584f4b0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxNjozMTowNVrOH7DwKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxNjozMTowNVrOH7DwKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY4OTUxMw==", "bodyText": "I broke tracing-java and tried it out, error message looks like this:\n1: Task failed with an exception.\n-----------\n* What went wrong:\nExecution failed for task ':tracing-jaxrs:checkExplicitSourceCompatibility'.\n> project ':tracing-jaxrs' must set sourceCompatibility explicitly in 'tracing-jaxrs/build.gradle', otherwise compilation will not be reproducible but instead depends on the Java version that Gradle is currently running with (11). To auto-fix, run\n\n       ./gradlew :tracing-jaxrs:checkExplicitSourceCompatibility --fix\n\n  This will automatically add a suggested line (you may need to adjust the number, e.g. to '1.8' for maximum compatibility).", "url": "https://github.com/palantir/gradle-baseline/pull/1574#discussion_r531689513", "createdAt": "2020-11-27T16:31:05Z", "author": {"login": "iamdanfox"}, "path": "gradle-baseline-java/src/main/groovy/com/palantir/baseline/tasks/CheckExplicitSourceCompatibilityTask.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.baseline.tasks;\n+\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.StandardOpenOption;\n+import java.util.Collections;\n+import javax.inject.Inject;\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.JavaVersion;\n+import org.gradle.api.Task;\n+import org.gradle.api.model.ObjectFactory;\n+import org.gradle.api.plugins.JavaPluginConvention;\n+import org.gradle.api.provider.Property;\n+import org.gradle.api.publish.PublishingExtension;\n+import org.gradle.api.specs.Spec;\n+import org.gradle.api.tasks.TaskAction;\n+import org.gradle.api.tasks.options.Option;\n+\n+/**\n+ * By default, Gradle will infer sourceCompat based on whatever JVM is currently being used to evaluate the\n+ * build.gradle files. This is bad for reproducibility because if we make an automated PR to upgrade the Java major\n+ * version (e.g. 11 -> 15) then a library might unintentionally start publishing jars containing Java15 bytecode!\n+ *\n+ * Better to just require everyone to specify sourceCompatibility explicitly!\n+ */\n+public class CheckExplicitSourceCompatibilityTask extends DefaultTask {\n+\n+    private final Property<Boolean> shouldFix;\n+\n+    @Inject\n+    public CheckExplicitSourceCompatibilityTask(ObjectFactory objectFactory) {\n+        setGroup(\"Verification\");\n+        setDescription(\"Ensures build.gradle specifies sourceCompatibility explicitly, otherwise it is inferred based\"\n+                + \" on $JAVA_HOME which is fragile.\");\n+        this.shouldFix = objectFactory.property(Boolean.class);\n+        this.shouldFix.set(false);\n+\n+        onlyIf(new Spec<Task>() {\n+            @Override\n+            public boolean isSatisfiedBy(Task element) {\n+                // sometimes people apply the 'java' plugin to projects that doesn't actually have any java code in it\n+                // (e.g. the root project), so if they're not publishing anything, then we don't bother enforcing the\n+                // sourceCompat thing\n+                PublishingExtension publishing = getProject().getExtensions().findByType(PublishingExtension.class);\n+                return publishing != null;\n+            }\n+        });\n+    }\n+\n+    @Option(option = \"fix\", description = \"Whether to apply the suggested fix to build.gradle\")\n+    public final void setShouldFix(boolean value) {\n+        shouldFix.set(value);\n+    }\n+\n+    @TaskAction\n+    public final void taskAction() throws IOException {\n+        // We're doing this naughty casting because we need access to the `getRawSourceCompatibility` method.\n+        org.gradle.api.plugins.internal.DefaultJavaPluginConvention convention =\n+                (org.gradle.api.plugins.internal.DefaultJavaPluginConvention)\n+                        getProject().getConvention().getPlugin(JavaPluginConvention.class);\n+\n+        if (convention.getRawSourceCompatibility() != null) {\n+            // In theory, users could configure the fancy new 'java toolchain' as an alternative to explicit\n+            // sourceCompatibility, but there's no method to access this yet (as of Gradle 6.8).\n+            return;\n+        }\n+\n+        if (shouldFix.get()) {\n+            Files.write(\n+                    getProject().getBuildFile().toPath(),\n+                    Collections.singletonList(String.format(\"%nsourceCompatibility = %s\", JavaVersion.current())),\n+                    StandardCharsets.UTF_8,\n+                    StandardOpenOption.APPEND,\n+                    StandardOpenOption.CREATE);\n+            return;\n+        }\n+\n+        throw new GradleException(String.format(\n+                \"%s must set sourceCompatibility explicitly in '%s', \"\n+                        + \"otherwise compilation will not be reproducible but instead depends on the Java version \"\n+                        + \"that Gradle is currently running with (%s). To auto-fix, run%n\"\n+                        + \"%n\"\n+                        + \"     ./gradlew %s --fix%n\"\n+                        + \"%n\"\n+                        + \"This will automatically add a suggested line \"\n+                        + \"(you may need to adjust the number, e.g. to '1.8' for maximum compatibility).\",\n+                getProject(),\n+                getProject().getRootProject().relativePath(getProject().getBuildFile()),\n+                JavaVersion.current(),\n+                getPath()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fade5c8f8630e08872a2f85312540901584f4b0"}, "originalPosition": 108}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNDQ2NDY3", "url": "https://github.com/palantir/gradle-baseline/pull/1574#pullrequestreview-540446467", "createdAt": "2020-11-29T04:27:58Z", "commit": {"oid": "3fade5c8f8630e08872a2f85312540901584f4b0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQwNDoyNzo1OVrOH7gE6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQwNDoyNzo1OVrOH7gE6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjE1MzU3OA==", "bodyText": "Should this also add a trailing newline at the end of the file?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Collections.singletonList(String.format(\"%nsourceCompatibility = %s\", JavaVersion.current())),\n          \n          \n            \n                                Collections.singletonList(String.format(\"%nsourceCompatibility = %s%n\", JavaVersion.current())),", "url": "https://github.com/palantir/gradle-baseline/pull/1574#discussion_r532153578", "createdAt": "2020-11-29T04:27:59Z", "author": {"login": "schlosna"}, "path": "gradle-baseline-java/src/main/groovy/com/palantir/baseline/tasks/CheckExplicitSourceCompatibilityTask.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.baseline.tasks;\n+\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.StandardOpenOption;\n+import java.util.Collections;\n+import javax.inject.Inject;\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.JavaVersion;\n+import org.gradle.api.Task;\n+import org.gradle.api.model.ObjectFactory;\n+import org.gradle.api.plugins.JavaPluginConvention;\n+import org.gradle.api.provider.Property;\n+import org.gradle.api.publish.PublishingExtension;\n+import org.gradle.api.specs.Spec;\n+import org.gradle.api.tasks.TaskAction;\n+import org.gradle.api.tasks.options.Option;\n+\n+/**\n+ * By default, Gradle will infer sourceCompat based on whatever JVM is currently being used to evaluate the\n+ * build.gradle files. This is bad for reproducibility because if we make an automated PR to upgrade the Java major\n+ * version (e.g. 11 -> 15) then a library might unintentionally start publishing jars containing Java15 bytecode!\n+ *\n+ * Better to just require everyone to specify sourceCompatibility explicitly!\n+ */\n+public class CheckExplicitSourceCompatibilityTask extends DefaultTask {\n+\n+    private final Property<Boolean> shouldFix;\n+\n+    @Inject\n+    public CheckExplicitSourceCompatibilityTask(ObjectFactory objectFactory) {\n+        setGroup(\"Verification\");\n+        setDescription(\"Ensures build.gradle specifies sourceCompatibility explicitly, otherwise it is inferred based\"\n+                + \" on $JAVA_HOME which is fragile.\");\n+        this.shouldFix = objectFactory.property(Boolean.class);\n+        this.shouldFix.set(false);\n+\n+        onlyIf(new Spec<Task>() {\n+            @Override\n+            public boolean isSatisfiedBy(Task element) {\n+                // sometimes people apply the 'java' plugin to projects that doesn't actually have any java code in it\n+                // (e.g. the root project), so if they're not publishing anything, then we don't bother enforcing the\n+                // sourceCompat thing\n+                PublishingExtension publishing = getProject().getExtensions().findByType(PublishingExtension.class);\n+                return publishing != null;\n+            }\n+        });\n+    }\n+\n+    @Option(option = \"fix\", description = \"Whether to apply the suggested fix to build.gradle\")\n+    public final void setShouldFix(boolean value) {\n+        shouldFix.set(value);\n+    }\n+\n+    @TaskAction\n+    public final void taskAction() throws IOException {\n+        // We're doing this naughty casting because we need access to the `getRawSourceCompatibility` method.\n+        org.gradle.api.plugins.internal.DefaultJavaPluginConvention convention =\n+                (org.gradle.api.plugins.internal.DefaultJavaPluginConvention)\n+                        getProject().getConvention().getPlugin(JavaPluginConvention.class);\n+\n+        if (convention.getRawSourceCompatibility() != null) {\n+            // In theory, users could configure the fancy new 'java toolchain' as an alternative to explicit\n+            // sourceCompatibility, but there's no method to access this yet (as of Gradle 6.8).\n+            return;\n+        }\n+\n+        if (shouldFix.get()) {\n+            Files.write(\n+                    getProject().getBuildFile().toPath(),\n+                    Collections.singletonList(String.format(\"%nsourceCompatibility = %s\", JavaVersion.current())),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fade5c8f8630e08872a2f85312540901584f4b0"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNzM4OTE5", "url": "https://github.com/palantir/gradle-baseline/pull/1574#pullrequestreview-540738919", "createdAt": "2020-11-30T09:41:18Z", "commit": {"oid": "3fade5c8f8630e08872a2f85312540901584f4b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ddbdec2ba2a43cd0ae001b8f80b32e020bd9b66", "author": {"user": {"login": "iamdanfox", "name": null}}, "url": "https://github.com/palantir/gradle-baseline/commit/0ddbdec2ba2a43cd0ae001b8f80b32e020bd9b66", "committedDate": "2020-11-30T13:05:00Z", "message": "Update gradle-baseline-java/src/main/groovy/com/palantir/baseline/tasks/CheckExplicitSourceCompatibilityTask.java\n\nCo-authored-by: David Schlosnagle <schlosna@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2016, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}