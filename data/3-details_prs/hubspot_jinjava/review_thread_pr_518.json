{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxNjg3MzU0", "number": 518, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNDoyNjozMVrOEtEUaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNzoxNjozMFrOEwW21w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1NjkyMTM2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNDoyNjozMVrOHgpkag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNjoxNToxNFrOHl0lUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk5NzU0Ng==", "bodyText": "Shouldn't this check all the way up the stack (excluding global) instead of just one level?", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r503997546", "createdAt": "2020-10-13T14:26:31Z", "author": {"login": "boulter"}, "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "diffHunk": "@@ -290,6 +291,21 @@ public void handleDeferredNode(Node node) {\n     return ImmutableSet.copyOf(deferredNodes);\n   }\n \n+  public void handlePreservedRawTag() {\n+    hasPreservedRawTags = true;\n+    if (getParent() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAyODk5MA==", "bodyText": "Not too sure what you mean. I am doing a recursive call, which I believe checks up the stack, excluding global: getParent().handlePreservedRawTag();", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r504028990", "createdAt": "2020-10-13T15:05:56Z", "author": {"login": "jasmith-hs"}, "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "diffHunk": "@@ -290,6 +291,21 @@ public void handleDeferredNode(Node node) {\n     return ImmutableSet.copyOf(deferredNodes);\n   }\n \n+  public void handlePreservedRawTag() {\n+    hasPreservedRawTags = true;\n+    if (getParent() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk5NzU0Ng=="}, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzMTM3Mw==", "bodyText": "Thanks, I was looking for a while and I missed the recursion.", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r504031373", "createdAt": "2020-10-13T15:09:02Z", "author": {"login": "boulter"}, "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "diffHunk": "@@ -290,6 +291,21 @@ public void handleDeferredNode(Node node) {\n     return ImmutableSet.copyOf(deferredNodes);\n   }\n \n+  public void handlePreservedRawTag() {\n+    hasPreservedRawTags = true;\n+    if (getParent() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk5NzU0Ng=="}, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM0NjE4Mg==", "bodyText": "I guess if (parent.getParent() != null) { will execute the handlePreservedRawTag() for Global as well. Can you verify whether we need to have parent.getParent().getParent() != null to exclude the global one?", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509346182", "createdAt": "2020-10-21T14:39:51Z", "author": {"login": "gobimcp"}, "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "diffHunk": "@@ -290,6 +291,21 @@ public void handleDeferredNode(Node node) {\n     return ImmutableSet.copyOf(deferredNodes);\n   }\n \n+  public void handlePreservedRawTag() {\n+    hasPreservedRawTags = true;\n+    if (getParent() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk5NzU0Ng=="}, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM1ODYyMw==", "bodyText": "Like in #449, we don't want the shared global context to be altered here as it can be shared across threads. My goal with marking a context as hasPreservedTags is so that we know that a second pass must always be done if raw tags get preserved.\nIn the instance that we preserve all the raw tags, but nothing gets deferred, a second pass can be done when pre-rendering. If something is deferred, that second pass will happen at serve-time. I want to exclude it for global because I just want it to mark for one run of renderForResult as mentioned here: #447.\nDoes that answer what you were wondering?", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509358623", "createdAt": "2020-10-21T14:54:27Z", "author": {"login": "jasmith-hs"}, "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "diffHunk": "@@ -290,6 +291,21 @@ public void handleDeferredNode(Node node) {\n     return ImmutableSet.copyOf(deferredNodes);\n   }\n \n+  public void handlePreservedRawTag() {\n+    hasPreservedRawTags = true;\n+    if (getParent() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk5NzU0Ng=="}, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQyMDg4MA==", "bodyText": "Sorry, I misread that question. We only need to check if the parent of what we are calling handlePreservedTag() on is not null. I think maybe line 300: getParent().handlePreservedRawTag() is confusing, as it would make more sense for it to be parent.handlePreservedRawTag().\nThe if statement is checking to make sure that parent's parent is not null, if so then handle the preserved raw tag for parent\nWith a context tree shape like G-a-b, here's some sudo-sequence-code that uses questionable syntax:\nthis == b\nparent == getParent() == a\nparent.getParent() == G != null\nparent.handlePreservedRawTag():\n-this == a\n-parent == getParent() == G\n-parent.getParent() == null\n-return\nreturn", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509420880", "createdAt": "2020-10-21T16:15:14Z", "author": {"login": "jasmith-hs"}, "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "diffHunk": "@@ -290,6 +291,21 @@ public void handleDeferredNode(Node node) {\n     return ImmutableSet.copyOf(deferredNodes);\n   }\n \n+  public void handlePreservedRawTag() {\n+    hasPreservedRawTags = true;\n+    if (getParent() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk5NzU0Ng=="}, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1NjkzODc4OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/hubspot/jinjava/lib/tag/RawTagTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNDozMDoxNFrOHgpvww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNDozMDoxNFrOHgpvww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAwMDQ1MQ==", "bodyText": "You can use assertThatThrownBy() here.", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r504000451", "createdAt": "2020-10-13T14:30:14Z", "author": {"login": "boulter"}, "path": "src/test/java/com/hubspot/jinjava/lib/tag/RawTagTest.java", "diffHunk": "@@ -91,6 +96,31 @@ public void itDoesntProcessJinjaCommentsWithinARawBlock() {\n       .contains(\"{{#each people}}\");\n   }\n \n+  @Test\n+  public void itPreservesRawTags() {\n+    TagNode tagNode = fixture(\"hubl\");\n+    JinjavaInterpreter preserveInterpreter = new JinjavaInterpreter(\n+      jinjava,\n+      jinjava.getGlobalContextCopy(),\n+      JinjavaConfig.newBuilder().withPreserveRawTags(true).build()\n+    );\n+    Throwable throwable = catchThrowable(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NzMxNjcxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/hubspot/jinjava/lib/tag/RawTag.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDozNDowMFrOHlP_TA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzoxOTo1OVrOHlrdAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyMTMyNA==", "bodyText": "Why throw exception here instead of\nreturn result.toString();\n\n?", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r508821324", "createdAt": "2020-10-20T20:34:00Z", "author": {"login": "hs-lsong"}, "path": "src/main/java/com/hubspot/jinjava/lib/tag/RawTag.java", "diffHunk": "@@ -33,6 +34,14 @@ public String interpret(TagNode tagNode, JinjavaInterpreter interpreter) {\n     LengthLimitingStringBuilder result = new LengthLimitingStringBuilder(\n       interpreter.getConfig().getMaxOutputSize()\n     );\n+    if (interpreter.getConfig().isPreserveRawTags()) {\n+      result.append(renderNodeRaw(tagNode));\n+      throw new PreservedRawTagException(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI3MTI5Ng==", "bodyText": "After working with the code base a bit more, I agree that it is simpler to return rather than throw an exception, and call interpreter.getContext().handlePreservedRawTag(); from here instead of in the TagNode", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509271296", "createdAt": "2020-10-21T13:19:59Z", "author": {"login": "jasmith-hs"}, "path": "src/main/java/com/hubspot/jinjava/lib/tag/RawTag.java", "diffHunk": "@@ -33,6 +34,14 @@ public String interpret(TagNode tagNode, JinjavaInterpreter interpreter) {\n     LengthLimitingStringBuilder result = new LengthLimitingStringBuilder(\n       interpreter.getConfig().getMaxOutputSize()\n     );\n+    if (interpreter.getConfig().isPreserveRawTags()) {\n+      result.append(renderNodeRaw(tagNode));\n+      throw new PreservedRawTagException(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyMTMyNA=="}, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NzM1NTM0OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/hubspot/jinjava/interpret/JinjavaInterpreterTest.java", "isResolved": false, "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDo0NDozNlrOHlQWlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNjowOToyMFrOHl0VdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyNzI4NA==", "bodyText": "Can you also add a test for deferred values? I thought deferred values will not get evaluated normally. Do they get evaluated inside raw tags?", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r508827284", "createdAt": "2020-10-20T20:44:36Z", "author": {"login": "hs-lsong"}, "path": "src/test/java/com/hubspot/jinjava/interpret/JinjavaInterpreterTest.java", "diffHunk": "@@ -220,4 +220,24 @@ public void itLimitsOutputSizeWhenSumOfNodeSizesExceedsMax() {\n     assertThat(renderResult.getErrors().get(0).getMessage())\n       .contains(\"OutputTooBigException\");\n   }\n+\n+  @Test\n+  public void itCanPreserveRawTags() {\n+    JinjavaConfig preserveRawTagsConfig = JinjavaConfig\n+      .newBuilder()\n+      .withPreserveRawTags(true)\n+      .build();\n+    String input = \"1{% raw %}2{% endraw %}3\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgzMzUyMQ==", "bodyText": "My testing shows that deferred inside raw does not get evaluated either. https://github.com/HubSpot/jinjava/compare/test-deferred?expand=1", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r508833521", "createdAt": "2020-10-20T20:55:41Z", "author": {"login": "hs-lsong"}, "path": "src/test/java/com/hubspot/jinjava/interpret/JinjavaInterpreterTest.java", "diffHunk": "@@ -220,4 +220,24 @@ public void itLimitsOutputSizeWhenSumOfNodeSizesExceedsMax() {\n     assertThat(renderResult.getErrors().get(0).getMessage())\n       .contains(\"OutputTooBigException\");\n   }\n+\n+  @Test\n+  public void itCanPreserveRawTags() {\n+    JinjavaConfig preserveRawTagsConfig = JinjavaConfig\n+      .newBuilder()\n+      .withPreserveRawTags(true)\n+      .build();\n+    String input = \"1{% raw %}2{% endraw %}3\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyNzI4NA=="}, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2NTIwOQ==", "bodyText": "Nothing, including deferred tags, will get evaluated inside raw tags. However without the preserveRawTags flag, on the second pass, the deferred values will get evaluated once the real value is put in the context.", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509265209", "createdAt": "2020-10-21T13:12:08Z", "author": {"login": "jasmith-hs"}, "path": "src/test/java/com/hubspot/jinjava/interpret/JinjavaInterpreterTest.java", "diffHunk": "@@ -220,4 +220,24 @@ public void itLimitsOutputSizeWhenSumOfNodeSizesExceedsMax() {\n     assertThat(renderResult.getErrors().get(0).getMessage())\n       .contains(\"OutputTooBigException\");\n   }\n+\n+  @Test\n+  public void itCanPreserveRawTags() {\n+    JinjavaConfig preserveRawTagsConfig = JinjavaConfig\n+      .newBuilder()\n+      .withPreserveRawTags(true)\n+      .build();\n+    String input = \"1{% raw %}2{% endraw %}3\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyNzI4NA=="}, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMwOTQwMw==", "bodyText": "In my test above, the deferred values do not get evaluated in the second rendering (there is no preserveRawTags) . Maybe we are not talking about the same case?", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509309403", "createdAt": "2020-10-21T13:56:46Z", "author": {"login": "hs-lsong"}, "path": "src/test/java/com/hubspot/jinjava/interpret/JinjavaInterpreterTest.java", "diffHunk": "@@ -220,4 +220,24 @@ public void itLimitsOutputSizeWhenSumOfNodeSizesExceedsMax() {\n     assertThat(renderResult.getErrors().get(0).getMessage())\n       .contains(\"OutputTooBigException\");\n   }\n+\n+  @Test\n+  public void itCanPreserveRawTags() {\n+    JinjavaConfig preserveRawTagsConfig = JinjavaConfig\n+      .newBuilder()\n+      .withPreserveRawTags(true)\n+      .build();\n+    String input = \"1{% raw %}2{% endraw %}3\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyNzI4NA=="}, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM0OTY5OQ==", "bodyText": "After line 83:\ninterpreter.getContext().put(\"deferred\", \"resolved value\");\n\nIn the second pass, deferred values will no longer be deferred (such as a contact, which have the actual contact value in the second pass, rather than being a deferred value). If you run the test after putting that line in, I believe that it will get resolved, which is not what is desired.", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509349699", "createdAt": "2020-10-21T14:43:54Z", "author": {"login": "jasmith-hs"}, "path": "src/test/java/com/hubspot/jinjava/interpret/JinjavaInterpreterTest.java", "diffHunk": "@@ -220,4 +220,24 @@ public void itLimitsOutputSizeWhenSumOfNodeSizesExceedsMax() {\n     assertThat(renderResult.getErrors().get(0).getMessage())\n       .contains(\"OutputTooBigException\");\n   }\n+\n+  @Test\n+  public void itCanPreserveRawTags() {\n+    JinjavaConfig preserveRawTagsConfig = JinjavaConfig\n+      .newBuilder()\n+      .withPreserveRawTags(true)\n+      .build();\n+    String input = \"1{% raw %}2{% endraw %}3\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyNzI4NA=="}, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM1MTQxNQ==", "bodyText": "I think what Jack meant by second pass is another renderer pass without having DeferredValue.instance() in the context. But in your test case, the test setUp has localContext.put(\"deferred\", DeferredValue.instance()); so it gets deferred in the second pass as well. Yo need to remove that from the context to actually resolve them in the second pass.", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509351415", "createdAt": "2020-10-21T14:45:57Z", "author": {"login": "gobimcp"}, "path": "src/test/java/com/hubspot/jinjava/interpret/JinjavaInterpreterTest.java", "diffHunk": "@@ -220,4 +220,24 @@ public void itLimitsOutputSizeWhenSumOfNodeSizesExceedsMax() {\n     assertThat(renderResult.getErrors().get(0).getMessage())\n       .contains(\"OutputTooBigException\");\n   }\n+\n+  @Test\n+  public void itCanPreserveRawTags() {\n+    JinjavaConfig preserveRawTagsConfig = JinjavaConfig\n+      .newBuilder()\n+      .withPreserveRawTags(true)\n+      .build();\n+    String input = \"1{% raw %}2{% endraw %}3\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyNzI4NA=="}, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQwNDk3MA==", "bodyText": "Hmm, what is the use case for those? First round rendering makes it deferred, then second round makes it not deferred, but still don't want to render it.", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509404970", "createdAt": "2020-10-21T15:53:03Z", "author": {"login": "hs-lsong"}, "path": "src/test/java/com/hubspot/jinjava/interpret/JinjavaInterpreterTest.java", "diffHunk": "@@ -220,4 +220,24 @@ public void itLimitsOutputSizeWhenSumOfNodeSizesExceedsMax() {\n     assertThat(renderResult.getErrors().get(0).getMessage())\n       .contains(\"OutputTooBigException\");\n   }\n+\n+  @Test\n+  public void itCanPreserveRawTags() {\n+    JinjavaConfig preserveRawTagsConfig = JinjavaConfig\n+      .newBuilder()\n+      .withPreserveRawTags(true)\n+      .build();\n+    String input = \"1{% raw %}2{% endraw %}3\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyNzI4NA=="}, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQwNzgxMw==", "bodyText": "<div>\nHi {{ contact.firstname }}!\nI personalized this with Jinjava:\n{% raw %}Hi {{ contact.firstname }}!{% endraw %}\n</div>\n\nThis should display for someone like:\n<div>\nHi Jack!\nI personalized this with Jinjava:\nHi {{ contact.firstname }}!\n</div>", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509407813", "createdAt": "2020-10-21T15:56:49Z", "author": {"login": "jasmith-hs"}, "path": "src/test/java/com/hubspot/jinjava/interpret/JinjavaInterpreterTest.java", "diffHunk": "@@ -220,4 +220,24 @@ public void itLimitsOutputSizeWhenSumOfNodeSizesExceedsMax() {\n     assertThat(renderResult.getErrors().get(0).getMessage())\n       .contains(\"OutputTooBigException\");\n   }\n+\n+  @Test\n+  public void itCanPreserveRawTags() {\n+    JinjavaConfig preserveRawTagsConfig = JinjavaConfig\n+      .newBuilder()\n+      .withPreserveRawTags(true)\n+      .build();\n+    String input = \"1{% raw %}2{% endraw %}3\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyNzI4NA=="}, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQwODg2Mg==", "bodyText": "We wouldn't want it to render like:\n<div>\nHi Jack!\nI personalized this with Jinjava:\nHi Jack!\n</div>", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509408862", "createdAt": "2020-10-21T15:58:11Z", "author": {"login": "jasmith-hs"}, "path": "src/test/java/com/hubspot/jinjava/interpret/JinjavaInterpreterTest.java", "diffHunk": "@@ -220,4 +220,24 @@ public void itLimitsOutputSizeWhenSumOfNodeSizesExceedsMax() {\n     assertThat(renderResult.getErrors().get(0).getMessage())\n       .contains(\"OutputTooBigException\");\n   }\n+\n+  @Test\n+  public void itCanPreserveRawTags() {\n+    JinjavaConfig preserveRawTagsConfig = JinjavaConfig\n+      .newBuilder()\n+      .withPreserveRawTags(true)\n+      .build();\n+    String input = \"1{% raw %}2{% endraw %}3\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyNzI4NA=="}, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQxNjgyMQ==", "bodyText": "Got it. Thanks.", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509416821", "createdAt": "2020-10-21T16:09:20Z", "author": {"login": "hs-lsong"}, "path": "src/test/java/com/hubspot/jinjava/interpret/JinjavaInterpreterTest.java", "diffHunk": "@@ -220,4 +220,24 @@ public void itLimitsOutputSizeWhenSumOfNodeSizesExceedsMax() {\n     assertThat(renderResult.getErrors().get(0).getMessage())\n       .contains(\"OutputTooBigException\");\n   }\n+\n+  @Test\n+  public void itCanPreserveRawTags() {\n+    JinjavaConfig preserveRawTagsConfig = JinjavaConfig\n+      .newBuilder()\n+      .withPreserveRawTags(true)\n+      .build();\n+    String input = \"1{% raw %}2{% endraw %}3\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyNzI4NA=="}, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MTQxNTkxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "isResolved": false, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNzoxNjozMFrOHl3OHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxOTo0NjozMlrOHmA5gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2NDA5NA==", "bodyText": "I don't see this function is used. Is this needed?", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509464094", "createdAt": "2020-10-21T17:16:30Z", "author": {"login": "hs-lsong"}, "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "diffHunk": "@@ -290,6 +291,21 @@ public void handleDeferredNode(Node node) {\n     return ImmutableSet.copyOf(deferredNodes);\n   }\n \n+  public void handlePreservedRawTag() {\n+    hasPreservedRawTags = true;\n+    if (getParent() != null) {\n+      Context parent = getParent();\n+      //Ignore global context\n+      if (parent.getParent() != null) {\n+        getParent().handlePreservedRawTag();\n+      }\n+    }\n+  }\n+\n+  public boolean getHasPreservedRawTags() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17c5a1cf0ebea4a1142dde68dcf74fa806016212"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ3MzQzNg==", "bodyText": "It's for rendering implementations such as with HubSpot's internal pre-renderer", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509473436", "createdAt": "2020-10-21T17:26:04Z", "author": {"login": "jasmith-hs"}, "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "diffHunk": "@@ -290,6 +291,21 @@ public void handleDeferredNode(Node node) {\n     return ImmutableSet.copyOf(deferredNodes);\n   }\n \n+  public void handlePreservedRawTag() {\n+    hasPreservedRawTags = true;\n+    if (getParent() != null) {\n+      Context parent = getParent();\n+      //Ignore global context\n+      if (parent.getParent() != null) {\n+        getParent().handlePreservedRawTag();\n+      }\n+    }\n+  }\n+\n+  public boolean getHasPreservedRawTags() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2NDA5NA=="}, "originalCommit": {"oid": "17c5a1cf0ebea4a1142dde68dcf74fa806016212"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ4MDI4OQ==", "bodyText": "I think I am missing the whole picture. Is this the case,  the caller set the config to preserve raw tags, later it wants to confirm it did render with the flag set?", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509480289", "createdAt": "2020-10-21T17:31:33Z", "author": {"login": "hs-lsong"}, "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "diffHunk": "@@ -290,6 +291,21 @@ public void handleDeferredNode(Node node) {\n     return ImmutableSet.copyOf(deferredNodes);\n   }\n \n+  public void handlePreservedRawTag() {\n+    hasPreservedRawTags = true;\n+    if (getParent() != null) {\n+      Context parent = getParent();\n+      //Ignore global context\n+      if (parent.getParent() != null) {\n+        getParent().handlePreservedRawTag();\n+      }\n+    }\n+  }\n+\n+  public boolean getHasPreservedRawTags() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2NDA5NA=="}, "originalCommit": {"oid": "17c5a1cf0ebea4a1142dde68dcf74fa806016212"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ5MjMxMA==", "bodyText": "So if the caller sets to preserve raw tags, but there are no raw tags to preserve and no deferred values, the pre-rendered template can be served as-is.\nIf however, there are any deferred values, then the second render will also get deferred until later.\nFinally, if there are no deferred values, but raw tags are preserved, then the second-pass should happen immediately with the flag off to remove the raw tags and the result can be served as-is.\nThis is because there isn't a way of knowing if there are going to be deferred values down the line so it must always preserve raw tags if the flag is set. 3 examples assuming deferred is deferred:\nExample 1, no deferred values, but a raw tag is preserved:\n{% raw %}{{ foo.bar }}{% endraw %}\n{{ resolved.variable }}\n\nWith preserveRawTags=true the output of the first render is:\n{% raw %}{{ foo.bar }}{% endraw %}\nI am resolved.\n\nSince there are no deferred values, it should be rendered again with preserveRawTags=false. The output of the second render is:\n{{ foo.bar }}\nI am resolved.\n\nExample 2, there are no deferred values or raw tags preserved:\nHello\n{{ resolved.variable }}\n\nWith preserveRawTags=true the output of the first render is:\nHello\nI am resolved.\n\nSince there are no deferred values or preserved tags, the output of the first render can be served as-is.\nExample 3, there is a deferred value and preserved raw tag:\n{% raw %}{{ foo.bar }}{% endraw %}\n{{ deferred.variable }}\n\nWith preserveRawTags=true the output of the first render is:\n{% raw %}{{ foo.bar }}{% endraw %}\n{{ deferred.variable }}\n\nSince there is a deferred variable, it should be rendered again at serve-time with preserveRawTags=false. The output of the second render is:\n{{ foo.bar }}\nI was deferred, but am resolved at serve-time.", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509492310", "createdAt": "2020-10-21T17:43:01Z", "author": {"login": "jasmith-hs"}, "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "diffHunk": "@@ -290,6 +291,21 @@ public void handleDeferredNode(Node node) {\n     return ImmutableSet.copyOf(deferredNodes);\n   }\n \n+  public void handlePreservedRawTag() {\n+    hasPreservedRawTags = true;\n+    if (getParent() != null) {\n+      Context parent = getParent();\n+      //Ignore global context\n+      if (parent.getParent() != null) {\n+        getParent().handlePreservedRawTag();\n+      }\n+    }\n+  }\n+\n+  public boolean getHasPreservedRawTags() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2NDA5NA=="}, "originalCommit": {"oid": "17c5a1cf0ebea4a1142dde68dcf74fa806016212"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUxMjE2NA==", "bodyText": "Thanks for the detailed examples. It helps a lot. But I still don't see where it needs to call getHasPreservedRawTags(). If the caller set it right before then calling the rendering, it should know it (local variable, etc).", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509512164", "createdAt": "2020-10-21T17:53:56Z", "author": {"login": "hs-lsong"}, "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "diffHunk": "@@ -290,6 +291,21 @@ public void handleDeferredNode(Node node) {\n     return ImmutableSet.copyOf(deferredNodes);\n   }\n \n+  public void handlePreservedRawTag() {\n+    hasPreservedRawTags = true;\n+    if (getParent() != null) {\n+      Context parent = getParent();\n+      //Ignore global context\n+      if (parent.getParent() != null) {\n+        getParent().handlePreservedRawTag();\n+      }\n+    }\n+  }\n+\n+  public boolean getHasPreservedRawTags() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2NDA5NA=="}, "originalCommit": {"oid": "17c5a1cf0ebea4a1142dde68dcf74fa806016212"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYwNzM3Ng==", "bodyText": "I think you're mistaking the config option for this. The config option tells the interpreter to preserve the raw tags. getHasPreservedRawTags() is only true if a raw tag was encountered and preserved. If there were no raw tags, then getHasPreservedRawTags() will be false.\nEssentially, the method lets the caller know if any raw tags were preserved. It prevents an unnecessary second pass from happening. If this method didn't exist, it wouldn't break anything, but Example 2 would have an extra rendering call that would yield the same result, which can be avoided by using this method.\nThere isn't a method to set private boolean hasPreservedRawTags, it is only set in the context when handlePreservedRawTag() gets called.", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509607376", "createdAt": "2020-10-21T19:25:45Z", "author": {"login": "jasmith-hs"}, "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "diffHunk": "@@ -290,6 +291,21 @@ public void handleDeferredNode(Node node) {\n     return ImmutableSet.copyOf(deferredNodes);\n   }\n \n+  public void handlePreservedRawTag() {\n+    hasPreservedRawTags = true;\n+    if (getParent() != null) {\n+      Context parent = getParent();\n+      //Ignore global context\n+      if (parent.getParent() != null) {\n+        getParent().handlePreservedRawTag();\n+      }\n+    }\n+  }\n+\n+  public boolean getHasPreservedRawTags() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2NDA5NA=="}, "originalCommit": {"oid": "17c5a1cf0ebea4a1142dde68dcf74fa806016212"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYxNjAwNQ==", "bodyText": "Oh, my bad. I mis-read it. I am OK with this. However, if we do not have this, as you said, in example 2, we would have an extra rendering call -- it should be fast because there is nothing to render.", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509616005", "createdAt": "2020-10-21T19:38:16Z", "author": {"login": "hs-lsong"}, "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "diffHunk": "@@ -290,6 +291,21 @@ public void handleDeferredNode(Node node) {\n     return ImmutableSet.copyOf(deferredNodes);\n   }\n \n+  public void handlePreservedRawTag() {\n+    hasPreservedRawTags = true;\n+    if (getParent() != null) {\n+      Context parent = getParent();\n+      //Ignore global context\n+      if (parent.getParent() != null) {\n+        getParent().handlePreservedRawTag();\n+      }\n+    }\n+  }\n+\n+  public boolean getHasPreservedRawTags() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2NDA5NA=="}, "originalCommit": {"oid": "17c5a1cf0ebea4a1142dde68dcf74fa806016212"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyMjY1Nw==", "bodyText": "That is true. I think it would be a minimal tradeoff of speed for more simplicity, so I'll just take this out.\nThis has shown me that it is too confusing to be worth the minimal performance gain", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509622657", "createdAt": "2020-10-21T19:46:32Z", "author": {"login": "jasmith-hs"}, "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "diffHunk": "@@ -290,6 +291,21 @@ public void handleDeferredNode(Node node) {\n     return ImmutableSet.copyOf(deferredNodes);\n   }\n \n+  public void handlePreservedRawTag() {\n+    hasPreservedRawTags = true;\n+    if (getParent() != null) {\n+      Context parent = getParent();\n+      //Ignore global context\n+      if (parent.getParent() != null) {\n+        getParent().handlePreservedRawTag();\n+      }\n+    }\n+  }\n+\n+  public boolean getHasPreservedRawTags() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2NDA5NA=="}, "originalCommit": {"oid": "17c5a1cf0ebea4a1142dde68dcf74fa806016212"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1728, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}