{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxMDA0Mzc4", "number": 385, "title": "Implement safe filter as SafeString and handle SafeString in filters, functions and expressions", "bodyText": "Safe filter:\nDocumentation\n\nMarks the value as safe which means that in an environment with automatic escaping enabled the variable will not be escaped.\n\nJinja docs: http://jinja.palletsprojects.com/en/2.10.x/templates/#working-with-automatic-escaping\nApproach:\nWrap String with new class SafeString when the |safe filter is applied to the value. This way we can check the type in ExpressionNode and not escape it. I overwrote toString to make it work as expected here: \n  \n    \n      jinjava/src/main/java/com/hubspot/jinjava/tree/ExpressionNode.java\n    \n    \n         Line 52\n      in\n      1667977\n    \n    \n    \n    \n\n        \n          \n           String result = Objects.toString(var, \"\"); \n        \n    \n  \n\n\nConsiderations:\nSince I introduce a new type here we might need to add some implementation for this in ExpressionResolver or JinjavaInterpreterResolver. The implementation is currently only tested with |safe being used at the end of an expression.", "createdAt": "2020-01-09T15:03:20Z", "url": "https://github.com/HubSpot/jinjava/pull/385", "merged": true, "mergeCommit": {"oid": "a6bea47f670558a8bcdab9282343fea1fb7f8016"}, "closed": true, "closedAt": "2020-01-29T15:51:08Z", "author": {"login": "jkollmann"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4qWAKAH2gAyMzYxMDA0Mzc4OjE2Njc5NzcxYmY5YjgxYTI0MzVkOTE0MGE1NzRhYjBkMTVhMDU2MDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-xyUygH2gAyMzYxMDA0Mzc4OjRmYzgyODQ5YmQ1NzJiZGUxMWE2NzBmYmNiMGJjMmI5MGUwYTgzZGE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "16679771bf9b81a2435d9140a574ab0d15a05603", "author": {"user": {"login": "jkollmann", "name": "Jannik"}}, "url": "https://github.com/HubSpot/jinjava/commit/16679771bf9b81a2435d9140a574ab0d15a05603", "committedDate": "2020-01-09T13:54:44Z", "message": "Start implementing safe filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fe49fcb907fa2aa0689b4baf6e37b78924039d9", "author": {"user": {"login": "jkollmann", "name": "Jannik"}}, "url": "https://github.com/HubSpot/jinjava/commit/7fe49fcb907fa2aa0689b4baf6e37b78924039d9", "committedDate": "2020-01-09T14:56:53Z", "message": "Remove comment about pass-through implementation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNzEyMzI1", "url": "https://github.com/HubSpot/jinjava/pull/385#pullrequestreview-340712325", "createdAt": "2020-01-09T18:05:50Z", "commit": {"oid": "7fe49fcb907fa2aa0689b4baf6e37b78924039d9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxODowNTo1MFrOFb-wgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxODowNTo1MFrOFb-wgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg4NDA5OA==", "bodyText": "perhaps the friendlier thing to do here is just to return the passed in object", "url": "https://github.com/HubSpot/jinjava/pull/385#discussion_r364884098", "createdAt": "2020-01-09T18:05:50Z", "author": {"login": "jboulter"}, "path": "src/main/java/com/hubspot/jinjava/lib/filter/SafeFilter.java", "diffHunk": "@@ -25,9 +25,15 @@ public String getName() {\n   }\n \n   @Override\n-  public Object filter(Object var, JinjavaInterpreter interpreter,\n-      String... args) {\n-    return var;\n-  }\n+  public Object filter(Object var, JinjavaInterpreter interpreter, String... args) {\n+    if (var == null) {\n+      return null;\n+    }\n+\n+    if (!(var instanceof String)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fe49fcb907fa2aa0689b4baf6e37b78924039d9"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f8a0768bd413a7cd4580c76715632201496271d", "author": {"user": {"login": "jkollmann", "name": "Jannik"}}, "url": "https://github.com/HubSpot/jinjava/commit/9f8a0768bd413a7cd4580c76715632201496271d", "committedDate": "2020-01-10T11:03:12Z", "message": "Return var if it's not instance of string instead of throwing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e8bcdda0ca6dac88bcfb68fc2de75478603ecab", "author": {"user": {"login": "jkollmann", "name": "Jannik"}}, "url": "https://github.com/HubSpot/jinjava/commit/2e8bcdda0ca6dac88bcfb68fc2de75478603ecab", "committedDate": "2020-01-10T11:06:35Z", "message": "Add test for pass-through"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb11ed46a2bc90846faca8e1d01dd57d6954159f", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/cb11ed46a2bc90846faca8e1d01dd57d6954159f", "committedDate": "2020-01-20T15:17:21Z", "message": "Add support for SafeString to all filters which handle Strings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b637aac90ef674d0b48503dacd9b1d7db643fdb2", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/b637aac90ef674d0b48503dacd9b1d7db643fdb2", "committedDate": "2020-01-20T15:28:50Z", "message": "Remove utils for string reverse filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93bb78e255416eddbc0bb6ae06d7cb76cc8c9f99", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/93bb78e255416eddbc0bb6ae06d7cb76cc8c9f99", "committedDate": "2020-01-20T16:20:27Z", "message": "Handle SafeString in truncate function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f074525dbe21723589cb3b8927c6e17c3446b27", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/2f074525dbe21723589cb3b8927c6e17c3446b27", "committedDate": "2020-01-20T16:23:13Z", "message": "Formatting fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1OTY4NDQz", "url": "https://github.com/HubSpot/jinjava/pull/385#pullrequestreview-345968443", "createdAt": "2020-01-21T15:31:32Z", "commit": {"oid": "2f074525dbe21723589cb3b8927c6e17c3446b27"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNTozMTozMlrOFf-SoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNTozMTozMlrOFf-SoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA3MDc1Mg==", "bodyText": "Perhaps you could use a Delegate pattern here and implement SafeStringFilter which takes care of this rather than manually checking for SafeStrings in every filter?\nYou could have the default interface implement filter, then delegate to a safeFilter method in each of these classes, unwrapping and wrapping the SafeString around it.", "url": "https://github.com/HubSpot/jinjava/pull/385#discussion_r369070752", "createdAt": "2020-01-21T15:31:32Z", "author": {"login": "boulter"}, "path": "src/main/java/com/hubspot/jinjava/lib/filter/DivideFilter.java", "diffHunk": "@@ -87,6 +88,9 @@ public Object filter(Object object, JinjavaInterpreter interpreter, String... ar\n         throw new InvalidInputException(interpreter, this, InvalidReason.NUMBER_FORMAT, object.toString());\n       }\n     }\n+    if (object instanceof SafeString) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f074525dbe21723589cb3b8927c6e17c3446b27"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b75330f11d995872e596a661b77c9e802e861acc", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/b75330f11d995872e596a661b77c9e802e861acc", "committedDate": "2020-01-23T16:51:59Z", "message": "Add SafeStringFilter interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b4d844d7617200ca597ec0d99726f70511365c4", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/9b4d844d7617200ca597ec0d99726f70511365c4", "committedDate": "2020-01-23T16:52:13Z", "message": "Handle safe strings in filters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "882a1dfec539c9eb06d22604e617e4406e53c852", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/882a1dfec539c9eb06d22604e617e4406e53c852", "committedDate": "2020-01-23T16:56:13Z", "message": "rm trailing space"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2204dbda804c640a9aea4a14e7b188590b7b643f", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/2204dbda804c640a9aea4a14e7b188590b7b643f", "committedDate": "2020-01-23T16:59:18Z", "message": "Formatting fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e55ee852b81b4e64f98c0a346e92c5229978e377", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/e55ee852b81b4e64f98c0a346e92c5229978e377", "committedDate": "2020-01-23T17:11:08Z", "message": "Move safeFilter method to Filter IF and remove SafeFilter IF"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b624b91b891f26ba88e8305b5c8c6025a705195", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/6b624b91b891f26ba88e8305b5c8c6025a705195", "committedDate": "2020-01-23T17:23:10Z", "message": "rm space"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NDgwMDMx", "url": "https://github.com/HubSpot/jinjava/pull/385#pullrequestreview-347480031", "createdAt": "2020-01-23T17:31:33Z", "commit": {"oid": "6b624b91b891f26ba88e8305b5c8c6025a705195"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNzozMTozM1rOFhGqyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNzozMTozM1rOFhGqyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI1NjU4Nw==", "bodyText": "Should this be return StringUtils.trim(Objects.toString(var)); instead?", "url": "https://github.com/HubSpot/jinjava/pull/385#discussion_r370256587", "createdAt": "2020-01-23T17:31:33Z", "author": {"login": "jkollmann"}, "path": "src/main/java/com/hubspot/jinjava/lib/filter/TrimFilter.java", "diffHunk": "@@ -28,7 +26,9 @@ public String getName() {\n \n   @Override\n   public Object filter(Object var, JinjavaInterpreter interpreter, String... args) {\n-    return StringUtils.trim(Objects.toString(var));\n+    if (var instanceof String) {\n+      return safeFilter(StringUtils.trim(var.toString()), interpreter, args);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b624b91b891f26ba88e8305b5c8c6025a705195"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NTM3NzQw", "url": "https://github.com/HubSpot/jinjava/pull/385#pullrequestreview-347537740", "createdAt": "2020-01-23T19:06:15Z", "commit": {"oid": "6b624b91b891f26ba88e8305b5c8c6025a705195"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxOTowNjoxNVrOFhJXfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxOToxMzoxNVrOFhJkXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwMDc5Nw==", "bodyText": "nit: unnecessary variable", "url": "https://github.com/HubSpot/jinjava/pull/385#discussion_r370300797", "createdAt": "2020-01-23T19:06:15Z", "author": {"login": "boulter"}, "path": "src/main/java/com/hubspot/jinjava/lib/filter/EscapeJsFilter.java", "diffHunk": "@@ -36,11 +36,18 @@\n \n   @Override\n   public Object filter(Object objectToFilter, JinjavaInterpreter jinjavaInterpreter, String... strings) {\n-    String input = Objects.toString(objectToFilter, \"\");\n-    LengthLimitingStringBuilder builder = new LengthLimitingStringBuilder(jinjavaInterpreter.getConfig().getMaxOutputSize());\n+    if (objectToFilter instanceof String) {\n+      String input = Objects.toString(objectToFilter, \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b624b91b891f26ba88e8305b5c8c6025a705195"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwMTk0NQ==", "bodyText": "in general, it's nice to separate formatting changes like this out into a separate PR so make your PRs clean and easy to understand.", "url": "https://github.com/HubSpot/jinjava/pull/385#discussion_r370301945", "createdAt": "2020-01-23T19:08:47Z", "author": {"login": "boulter"}, "path": "src/main/java/com/hubspot/jinjava/lib/filter/LowerFilter.java", "diffHunk": "@@ -1,17 +1,17 @@\n /**********************************************************************\n-Copyright (c) 2014 HubSpot Inc.\n+ Copyright (c) 2014 HubSpot Inc.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b624b91b891f26ba88e8305b5c8c6025a705195"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwMzEwNw==", "bodyText": "could you have this extend String? That might simplify all your instanceof checks.", "url": "https://github.com/HubSpot/jinjava/pull/385#discussion_r370303107", "createdAt": "2020-01-23T19:11:14Z", "author": {"login": "boulter"}, "path": "src/main/java/com/hubspot/jinjava/objects/SafeString.java", "diffHunk": "@@ -0,0 +1,19 @@\n+package com.hubspot.jinjava.objects;\n+\n+public class SafeString {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b624b91b891f26ba88e8305b5c8c6025a705195"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwMzY4NQ==", "bodyText": "nit: extra space after object", "url": "https://github.com/HubSpot/jinjava/pull/385#discussion_r370303685", "createdAt": "2020-01-23T19:12:22Z", "author": {"login": "boulter"}, "path": "src/main/java/com/hubspot/jinjava/lib/filter/RootFilter.java", "diffHunk": "@@ -64,9 +65,9 @@ public Object filter(Object object, JinjavaInterpreter interpreter, String... ar\n     if (object instanceof BigInteger) {\n       return calculateBigRoot(interpreter, new BigDecimal((BigInteger) object), root);\n     }\n-    if (object instanceof String) {\n+    if (object instanceof String || object  instanceof SafeString) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b624b91b891f26ba88e8305b5c8c6025a705195"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwNDA5Mg==", "bodyText": "is this method needed?", "url": "https://github.com/HubSpot/jinjava/pull/385#discussion_r370304092", "createdAt": "2020-01-23T19:13:15Z", "author": {"login": "boulter"}, "path": "src/main/java/com/hubspot/jinjava/objects/SafeString.java", "diffHunk": "@@ -0,0 +1,19 @@\n+package com.hubspot.jinjava.objects;\n+\n+public class SafeString {\n+\n+  private final String value;\n+\n+  public SafeString(String value) {\n+    this.value = value;\n+  }\n+\n+  public String getValue() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b624b91b891f26ba88e8305b5c8c6025a705195"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ef1752e45fe5c33f90d7d9feb7bb147dd0fa653", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/8ef1752e45fe5c33f90d7d9feb7bb147dd0fa653", "committedDate": "2020-01-24T13:39:28Z", "message": "Change behaviour of Urlize filter to not always return a SafeString"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6d398fc34ae17e9ad6041090fa90caf1f364862", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/b6d398fc34ae17e9ad6041090fa90caf1f364862", "committedDate": "2020-01-24T13:39:44Z", "message": "Code style changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ceb66ea30065ed408b36e96809f58bd57ca4881", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/7ceb66ea30065ed408b36e96809f58bd57ca4881", "committedDate": "2020-01-24T13:47:33Z", "message": "Remove unnecessary call to safeString"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b981e722d68a01b54abe9bb7de96cb5228d1afc", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/2b981e722d68a01b54abe9bb7de96cb5228d1afc", "committedDate": "2020-01-24T13:54:40Z", "message": "Style fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e265bb586c9c9546e920d0c063091555b2ec1b72", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/e265bb586c9c9546e920d0c063091555b2ec1b72", "committedDate": "2020-01-24T15:47:29Z", "message": "Add tests to handle Urlize string being escaped and made safe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b4f61543e5aa223bac3425c89589fb8af4ee222", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/1b4f61543e5aa223bac3425c89589fb8af4ee222", "committedDate": "2020-01-24T15:49:12Z", "message": "rm hardcoded string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fee9566c5b6eea0caa079babc17ff2fdbf9e6b32", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/fee9566c5b6eea0caa079babc17ff2fdbf9e6b32", "committedDate": "2020-01-28T11:40:01Z", "message": "rm uneeded getValue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaeeb975fa2a9cb6e74bd2fcff46a84e2c731ea8", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/aaeeb975fa2a9cb6e74bd2fcff46a84e2c731ea8", "committedDate": "2020-01-28T11:40:58Z", "message": "Add SafeString type as str"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fc82849bd572bde11a670fbcb0bc2b90e0a83da", "author": {"user": {"login": "Joeoh", "name": "Joe"}}, "url": "https://github.com/HubSpot/jinjava/commit/4fc82849bd572bde11a670fbcb0bc2b90e0a83da", "committedDate": "2020-01-28T13:58:33Z", "message": "Handle SafeString in expressions"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1558, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}