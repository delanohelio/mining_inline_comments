{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyODg0MDky", "number": 446, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMDoyMjo1N1rOD_dwEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMzo0MTozMlrOEC9dgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODc0MzIyOnYy", "diffSide": "LEFT", "path": "src/main/java/com/hubspot/jinjava/el/ext/CollectionMembershipOperator.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMDoyMjo1N1rOGaJJpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODoyNDowNFrOGjNrdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2NjA4NA==", "bodyText": "What we had before was that we would cast the value to the type of the first element of the collection, and then return on that result. So 2 is in ['one', 2] would fail because 2 gets casted to '2'.", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r430066084", "createdAt": "2020-05-25T20:22:57Z", "author": {"login": "tectonic8"}, "path": "src/main/java/com/hubspot/jinjava/el/ext/CollectionMembershipOperator.java", "diffHunk": "@@ -7,39 +7,43 @@\n import de.odysseus.el.tree.impl.ast.AstBinary;\n import de.odysseus.el.tree.impl.ast.AstBinary.SimpleOperator;\n import de.odysseus.el.tree.impl.ast.AstNode;\n-import java.util.Collection;\n import java.util.Objects;\n import javax.el.ELException;\n import org.apache.commons.lang3.StringUtils;\n \n public class CollectionMembershipOperator extends SimpleOperator {\n \n   @Override\n-  public Object apply(TypeConverter converter, Object o1, Object o2) {\n-    if (o2 == null) {\n+  public Object apply(TypeConverter converter, Object value, Object maybeIterable) {\n+    if (maybeIterable == null) {\n       return Boolean.FALSE;\n     }\n \n-    if (CharSequence.class.isAssignableFrom(o2.getClass())) {\n-      return StringUtils.contains((CharSequence) o2, Objects.toString(o1, \"\"));\n+    if (CharSequence.class.isAssignableFrom(maybeIterable.getClass())) {\n+      return StringUtils.contains(\n+        (CharSequence) maybeIterable,\n+        Objects.toString(value, \"\")\n+      );\n     }\n \n-    if (Collection.class.isAssignableFrom(o2.getClass())) {\n-      Collection<?> collection = (Collection<?>) o2;\n-\n-      for (Object value : collection) {\n-        if (value == null) {\n-          if (o1 == null) {\n-            return Boolean.TRUE;\n+    if (maybeIterable instanceof Iterable) {\n+      for (Object element : (Iterable) maybeIterable) {\n+        if (element == null) {\n+          if (value == null) {\n+            return true;\n           }\n         } else {\n           try {\n-            return collection.contains(converter.convert(o1, value.getClass()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a4e36bb944158b19b046c104ab58e648dd2457a"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkyNDg3Nw==", "bodyText": "Can you check the performance of this? I believe I did this back in https://github.com/HubSpot/jinjava/pull/314/files for performance reasons but would be good to double check. We could also split this into a separate PR to be safe.", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r435924877", "createdAt": "2020-06-05T13:35:36Z", "author": {"login": "mattcoley"}, "path": "src/main/java/com/hubspot/jinjava/el/ext/CollectionMembershipOperator.java", "diffHunk": "@@ -7,39 +7,43 @@\n import de.odysseus.el.tree.impl.ast.AstBinary;\n import de.odysseus.el.tree.impl.ast.AstBinary.SimpleOperator;\n import de.odysseus.el.tree.impl.ast.AstNode;\n-import java.util.Collection;\n import java.util.Objects;\n import javax.el.ELException;\n import org.apache.commons.lang3.StringUtils;\n \n public class CollectionMembershipOperator extends SimpleOperator {\n \n   @Override\n-  public Object apply(TypeConverter converter, Object o1, Object o2) {\n-    if (o2 == null) {\n+  public Object apply(TypeConverter converter, Object value, Object maybeIterable) {\n+    if (maybeIterable == null) {\n       return Boolean.FALSE;\n     }\n \n-    if (CharSequence.class.isAssignableFrom(o2.getClass())) {\n-      return StringUtils.contains((CharSequence) o2, Objects.toString(o1, \"\"));\n+    if (CharSequence.class.isAssignableFrom(maybeIterable.getClass())) {\n+      return StringUtils.contains(\n+        (CharSequence) maybeIterable,\n+        Objects.toString(value, \"\")\n+      );\n     }\n \n-    if (Collection.class.isAssignableFrom(o2.getClass())) {\n-      Collection<?> collection = (Collection<?>) o2;\n-\n-      for (Object value : collection) {\n-        if (value == null) {\n-          if (o1 == null) {\n-            return Boolean.TRUE;\n+    if (maybeIterable instanceof Iterable) {\n+      for (Object element : (Iterable) maybeIterable) {\n+        if (element == null) {\n+          if (value == null) {\n+            return true;\n           }\n         } else {\n           try {\n-            return collection.contains(converter.convert(o1, value.getClass()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2NjA4NA=="}, "originalCommit": {"oid": "8a4e36bb944158b19b046c104ab58e648dd2457a"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU3NzQ2MA==", "bodyText": "There is a slight performance hit. For checking the existence of a float in a list of 1,000,0000 strings, it takes 2-6 seconds with the current code and 1-2 seconds in the master branch. This code can be slightly optimized by storing the converted values in a type->object map. With that we see closer to the 2 second range. For a list of 100,000 strings, the difference is about 400 ms vs 300 ms. It seems to me that there isn't a huge difference until we reach very large scales. What do you think we should do?", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r439577460", "createdAt": "2020-06-12T18:24:04Z", "author": {"login": "tectonic8"}, "path": "src/main/java/com/hubspot/jinjava/el/ext/CollectionMembershipOperator.java", "diffHunk": "@@ -7,39 +7,43 @@\n import de.odysseus.el.tree.impl.ast.AstBinary;\n import de.odysseus.el.tree.impl.ast.AstBinary.SimpleOperator;\n import de.odysseus.el.tree.impl.ast.AstNode;\n-import java.util.Collection;\n import java.util.Objects;\n import javax.el.ELException;\n import org.apache.commons.lang3.StringUtils;\n \n public class CollectionMembershipOperator extends SimpleOperator {\n \n   @Override\n-  public Object apply(TypeConverter converter, Object o1, Object o2) {\n-    if (o2 == null) {\n+  public Object apply(TypeConverter converter, Object value, Object maybeIterable) {\n+    if (maybeIterable == null) {\n       return Boolean.FALSE;\n     }\n \n-    if (CharSequence.class.isAssignableFrom(o2.getClass())) {\n-      return StringUtils.contains((CharSequence) o2, Objects.toString(o1, \"\"));\n+    if (CharSequence.class.isAssignableFrom(maybeIterable.getClass())) {\n+      return StringUtils.contains(\n+        (CharSequence) maybeIterable,\n+        Objects.toString(value, \"\")\n+      );\n     }\n \n-    if (Collection.class.isAssignableFrom(o2.getClass())) {\n-      Collection<?> collection = (Collection<?>) o2;\n-\n-      for (Object value : collection) {\n-        if (value == null) {\n-          if (o1 == null) {\n-            return Boolean.TRUE;\n+    if (maybeIterable instanceof Iterable) {\n+      for (Object element : (Iterable) maybeIterable) {\n+        if (element == null) {\n+          if (value == null) {\n+            return true;\n           }\n         } else {\n           try {\n-            return collection.contains(converter.convert(o1, value.getClass()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2NjA4NA=="}, "originalCommit": {"oid": "8a4e36bb944158b19b046c104ab58e648dd2457a"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODc0NjkyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/hubspot/jinjava/el/ext/ExtendedParser.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMDoyNTo0MVrOGaJLtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMDoyNTo0MVrOGaJLtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2NjYxNA==", "bodyText": "CollectionMembershipOperator.TOKEN.getSymbol() is just EXTENSION which is non-ideal because we really just want to add IN to this set, but we can't add symbols.", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r430066614", "createdAt": "2020-05-25T20:25:41Z", "author": {"login": "tectonic8"}, "path": "src/main/java/com/hubspot/jinjava/el/ext/ExtendedParser.java", "diffHunk": "@@ -53,6 +64,19 @@\n   static final Scanner.ExtensionToken TRUNC_DIV = TruncDivOperator.TOKEN;\n   static final Scanner.ExtensionToken POWER_OF = PowerOfOperator.TOKEN;\n \n+  static final Set<Symbol> VALID_SYMBOLS_FOR_EXP_TEST = Sets.newHashSet(\n+    IDENTIFIER,\n+    EQ,\n+    NE,\n+    LT,\n+    LE,\n+    GT,\n+    GE,\n+    TRUE,\n+    FALSE,\n+    CollectionMembershipOperator.TOKEN.getSymbol()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a4e36bb944158b19b046c104ab58e648dd2457a"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODc1NzM3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/hubspot/jinjava/lib/exptest/IsSequenceExpTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMDozMzo1NlrOGaJRtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMDozMzo1NlrOGaJRtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2ODE0OA==", "bodyText": "It is questionable to define iterables and sequences as the same thing, but this follows the Jinja spec.", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r430068148", "createdAt": "2020-05-25T20:33:56Z", "author": {"login": "tectonic8"}, "path": "src/main/java/com/hubspot/jinjava/lib/exptest/IsSequenceExpTest.java", "diffHunk": "@@ -25,9 +27,6 @@ public String getName() {\n \n   @Override\n   public boolean evaluate(Object var, JinjavaInterpreter interpreter, Object... args) {\n-    return (\n-      var != null &&\n-      (var.getClass().isArray() || Iterable.class.isAssignableFrom(var.getClass()))\n-    );\n+    return isIterable(var);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a4e36bb944158b19b046c104ab58e648dd2457a"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODc2MjA5OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/hubspot/jinjava/lib/exptest/IsContainingExpTestTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMDozNzowNlrOGaJUXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMDozNzowNlrOGaJUXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2ODgyOA==", "bodyText": "This is a breaking change. I don't see why this should fail before, and it does not fail in Jinja.", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r430068828", "createdAt": "2020-05-25T20:37:06Z", "author": {"login": "tectonic8"}, "path": "src/test/java/com/hubspot/jinjava/lib/exptest/IsContainingExpTestTest.java", "diffHunk": "@@ -30,14 +30,14 @@ public void itPassesOnContainedValue() {\n   }\n \n   @Test\n-  public void itFailsOnNullContainedValue() {\n+  public void itPassesOnNullContainedValue() {\n     assertThat(\n         jinjava.render(\n           String.format(CONTAINING_TEMPLATE, \"[1, 2, null]\", \"null\"),\n           new HashMap<>()\n         )\n       )\n-      .isEqualTo(\"fail\");\n+      .isEqualTo(\"pass\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a4e36bb944158b19b046c104ab58e648dd2457a"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODc2NDE3OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/hubspot/jinjava/lib/exptest/IsInExpTestTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMDozODoyMVrOGaJVdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMDozODoyMVrOGaJVdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2OTEwOQ==", "bodyText": "Should passing in an object that is not an iterable simply return false or throw an exception?", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r430069109", "createdAt": "2020-05-25T20:38:21Z", "author": {"login": "tectonic8"}, "path": "src/test/java/com/hubspot/jinjava/lib/exptest/IsInExpTestTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.hubspot.jinjava.lib.exptest;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import com.hubspot.jinjava.Jinjava;\n+import java.util.HashMap;\n+import org.assertj.core.api.Assertions;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class IsInExpTestTest {\n+  private Jinjava jinjava;\n+\n+  @Before\n+  public void setup() {\n+    jinjava = new Jinjava();\n+  }\n+\n+  @Test\n+  public void testIsInList() {\n+    assertThat(jinjava.render(\"{{ 2 is in [1, 2] }}\", new HashMap<>())).isEqualTo(\"true\");\n+    assertThat(jinjava.render(\"{{ 2 is in ['one', 2] }}\", new HashMap<>()))\n+      .isEqualTo(\"true\");\n+    assertThat(jinjava.render(\"{{ 2 is in [1] }}\", new HashMap<>())).isEqualTo(\"false\");\n+  }\n+\n+  @Test\n+  public void testIsInString() {\n+    assertThat(jinjava.render(\"{{ 'b' is in 'ab' }}\", new HashMap<>())).isEqualTo(\"true\");\n+    assertThat(jinjava.render(\"{{ 'b' is in 'a' }}\", new HashMap<>())).isEqualTo(\"false\");\n+  }\n+\n+  @Test\n+  public void testIsInDict() {\n+    assertThat(jinjava.render(\"{{ 'k2' is in {'k1':'v1', 'k2':'v2'} }}\", new HashMap<>()))\n+      .isEqualTo(\"true\");\n+    assertThat(jinjava.render(\"{{ 'k2' is in {'k1':'v1'} }}\", new HashMap<>()))\n+      .isEqualTo(\"false\");\n+  }\n+\n+  @Test\n+  public void testNull() {\n+    assertThat(jinjava.render(\"{{ null is in [null] }}\", new HashMap<>()))\n+      .isEqualTo(\"true\");\n+    assertThat(jinjava.render(\"{{ null is in [2] }}\", new HashMap<>()))\n+      .isEqualTo(\"false\");\n+    assertThat(jinjava.render(\"{{ 2 is in [null] }}\", new HashMap<>()))\n+      .isEqualTo(\"false\");\n+    assertThatThrownBy(() -> jinjava.render(\"{{ 2 is in null }}\", new HashMap<>()))\n+      .hasMessageContaining(\"1st argument with value 'null' must be iterable\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a4e36bb944158b19b046c104ab58e648dd2457a"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODc2NzU3OnYy", "diffSide": "LEFT", "path": "src/test/java/com/hubspot/jinjava/lib/exptest/IsWithinExpTestTest.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMDo0MDo0N1rOGaJXWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODoxNzoxMVrOGjNfjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2OTU5Mg==", "bodyText": "This is related to whether we should return false or throw an exception. In Python, 2 in None would throw an exception.", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r430069592", "createdAt": "2020-05-25T20:40:47Z", "author": {"login": "tectonic8"}, "path": "src/test/java/com/hubspot/jinjava/lib/exptest/IsWithinExpTestTest.java", "diffHunk": "@@ -53,12 +53,6 @@ public void itFailsOnNullValueNotInSequence() {\n       .isEqualTo(\"fail\");\n   }\n \n-  @Test\n-  public void itFailsOnNullSequence() {\n-    assertThat(jinjava.render(String.format(IN_TEMPLATE, \"2\", \"null\"), new HashMap<>()))\n-      .isEqualTo(\"fail\");\n-  }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a4e36bb944158b19b046c104ab58e648dd2457a"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkyOTk1Nw==", "bodyText": "Escaping is tricky. I would leave out the changes to the escape filter and the addition of the escaped expression test in a separate PR to be safe.", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r435929957", "createdAt": "2020-06-05T13:43:44Z", "author": {"login": "mattcoley"}, "path": "src/test/java/com/hubspot/jinjava/lib/exptest/IsWithinExpTestTest.java", "diffHunk": "@@ -53,12 +53,6 @@ public void itFailsOnNullValueNotInSequence() {\n       .isEqualTo(\"fail\");\n   }\n \n-  @Test\n-  public void itFailsOnNullSequence() {\n-    assertThat(jinjava.render(String.format(IN_TEMPLATE, \"2\", \"null\"), new HashMap<>()))\n-      .isEqualTo(\"fail\");\n-  }\n-", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2OTU5Mg=="}, "originalCommit": {"oid": "8a4e36bb944158b19b046c104ab58e648dd2457a"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk1NjA5Ng==", "bodyText": "That makes sense.", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r435956096", "createdAt": "2020-06-05T14:22:44Z", "author": {"login": "tectonic8"}, "path": "src/test/java/com/hubspot/jinjava/lib/exptest/IsWithinExpTestTest.java", "diffHunk": "@@ -53,12 +53,6 @@ public void itFailsOnNullValueNotInSequence() {\n       .isEqualTo(\"fail\");\n   }\n \n-  @Test\n-  public void itFailsOnNullSequence() {\n-    assertThat(jinjava.render(String.format(IN_TEMPLATE, \"2\", \"null\"), new HashMap<>()))\n-      .isEqualTo(\"fail\");\n-  }\n-", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2OTU5Mg=="}, "originalCommit": {"oid": "8a4e36bb944158b19b046c104ab58e648dd2457a"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU3NDQxMw==", "bodyText": "I removed the escaping, but also this code snippet here is related to the whether searching something that isn't an iterable should return false as it does currently or throw an exception. Can you comment on that?", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r439574413", "createdAt": "2020-06-12T18:17:11Z", "author": {"login": "tectonic8"}, "path": "src/test/java/com/hubspot/jinjava/lib/exptest/IsWithinExpTestTest.java", "diffHunk": "@@ -53,12 +53,6 @@ public void itFailsOnNullValueNotInSequence() {\n       .isEqualTo(\"fail\");\n   }\n \n-  @Test\n-  public void itFailsOnNullSequence() {\n-    assertThat(jinjava.render(String.format(IN_TEMPLATE, \"2\", \"null\"), new HashMap<>()))\n-      .isEqualTo(\"fail\");\n-  }\n-", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2OTU5Mg=="}, "originalCommit": {"oid": "8a4e36bb944158b19b046c104ab58e648dd2457a"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODc2ODI0OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/hubspot/jinjava/lib/filter/EscapeFilterTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMDo0MToyN1rOGaJXyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMDo0MToyN1rOGaJXyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA2OTcwNw==", "bodyText": "This is because the escape filter now returns a SafeString. Is this fine?", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r430069707", "createdAt": "2020-05-25T20:41:27Z", "author": {"login": "tectonic8"}, "path": "src/test/java/com/hubspot/jinjava/lib/filter/EscapeFilterTest.java", "diffHunk": "@@ -20,11 +20,11 @@ public void setup() {\n \n   @Test\n   public void testEscape() {\n-    assertThat(f.filter(\"\", interpreter)).isEqualTo(\"\");\n-    assertThat(f.filter(\"me & you\", interpreter)).isEqualTo(\"me &amp; you\");\n-    assertThat(f.filter(\"jared's & ted's bogus journey\", interpreter))\n+    assertThat(f.filter(\"\", interpreter).toString()).isEqualTo(\"\");\n+    assertThat(f.filter(\"me & you\", interpreter).toString()).isEqualTo(\"me &amp; you\");\n+    assertThat(f.filter(\"jared's & ted's bogus journey\", interpreter).toString())\n       .isEqualTo(\"jared&#39;s &amp; ted&#39;s bogus journey\");\n-    assertThat(f.filter(1, interpreter)).isEqualTo(\"1\");\n+    assertThat(f.filter(1, interpreter).toString()).isEqualTo(\"1\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a4e36bb944158b19b046c104ab58e648dd2457a"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MDA5NDUyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/hubspot/jinjava/lib/exptest/IsEscapedExpTest.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwOToyNToxOFrOGaV_9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNTo0MTozOFrOGakdXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI3NjU5OA==", "bodyText": "SafeString is kind of confusing, a string being \"safe\" means that you trust the contents and that it won't be escaped.\nI'm wondering if we should also check the context for interpreter.getContext().isAutoEscape .\nSomething like !(var instanceof SafeString) && interpreter.getContext().isAutoEscape()", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r430276598", "createdAt": "2020-05-26T09:25:18Z", "author": {"login": "Joeoh"}, "path": "src/main/java/com/hubspot/jinjava/lib/exptest/IsEscapedExpTest.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.hubspot.jinjava.lib.exptest;\n+\n+import com.hubspot.jinjava.doc.annotations.JinjavaDoc;\n+import com.hubspot.jinjava.doc.annotations.JinjavaParam;\n+import com.hubspot.jinjava.doc.annotations.JinjavaSnippet;\n+import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n+import com.hubspot.jinjava.objects.SafeString;\n+\n+@JinjavaDoc(\n+  value = \"Return true if the object is marked as escaped.\",\n+  input = @JinjavaParam(value = \"object\", type = \"object\", required = true),\n+  snippets = {\n+    @JinjavaSnippet(\n+      code = \"{% if 'test' is escaped %}\\n\" +\n+      \"      <!--this code will not render-->\\n\" +\n+      \"{% endif %}\"\n+    ),\n+    @JinjavaSnippet(\n+      code = \"{% if ('test'|escape) is escaped %}\\n\" +\n+      \"      <!--this code will render-->\\n\" +\n+      \"{% endif %}\"\n+    ),\n+    @JinjavaSnippet(\n+      code = \"{% if ('test'|safe) is escaped %}\\n\" +\n+      \"      <!--this code will render-->\\n\" +\n+      \"{% endif %}\"\n+    )\n+  }\n+)\n+public class IsEscapedExpTest implements ExpTest {\n+\n+  @Override\n+  public String getName() {\n+    return \"escaped\";\n+  }\n+\n+  @Override\n+  public boolean evaluate(Object var, JinjavaInterpreter interpreter, Object... args) {\n+    return var instanceof SafeString;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7b76f485c9fdf171d79a9b2ce6d2ce3183dcd84"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ5MzIzMg==", "bodyText": "Hi, thanks for reviewing!\nI have it this way because the Jinja implementation just checks for whether the value in the variable is marked safe rather than whether it actually is safe, so whether or not the output enters that if statement you linked might not actually be relevant. Also, the expression test is evaluated before that condition evaluates, so I think it makes sense that the test returns whether the value is marked safe rather than whether its value would get escaped.", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r430493232", "createdAt": "2020-05-26T15:18:21Z", "author": {"login": "tectonic8"}, "path": "src/main/java/com/hubspot/jinjava/lib/exptest/IsEscapedExpTest.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.hubspot.jinjava.lib.exptest;\n+\n+import com.hubspot.jinjava.doc.annotations.JinjavaDoc;\n+import com.hubspot.jinjava.doc.annotations.JinjavaParam;\n+import com.hubspot.jinjava.doc.annotations.JinjavaSnippet;\n+import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n+import com.hubspot.jinjava.objects.SafeString;\n+\n+@JinjavaDoc(\n+  value = \"Return true if the object is marked as escaped.\",\n+  input = @JinjavaParam(value = \"object\", type = \"object\", required = true),\n+  snippets = {\n+    @JinjavaSnippet(\n+      code = \"{% if 'test' is escaped %}\\n\" +\n+      \"      <!--this code will not render-->\\n\" +\n+      \"{% endif %}\"\n+    ),\n+    @JinjavaSnippet(\n+      code = \"{% if ('test'|escape) is escaped %}\\n\" +\n+      \"      <!--this code will render-->\\n\" +\n+      \"{% endif %}\"\n+    ),\n+    @JinjavaSnippet(\n+      code = \"{% if ('test'|safe) is escaped %}\\n\" +\n+      \"      <!--this code will render-->\\n\" +\n+      \"{% endif %}\"\n+    )\n+  }\n+)\n+public class IsEscapedExpTest implements ExpTest {\n+\n+  @Override\n+  public String getName() {\n+    return \"escaped\";\n+  }\n+\n+  @Override\n+  public boolean evaluate(Object var, JinjavaInterpreter interpreter, Object... args) {\n+    return var instanceof SafeString;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI3NjU5OA=="}, "originalCommit": {"oid": "d7b76f485c9fdf171d79a9b2ce6d2ce3183dcd84"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ5MzgzNw==", "bodyText": "Here's the Jinja behavior that I modeled this off of.", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r430493837", "createdAt": "2020-05-26T15:19:12Z", "author": {"login": "tectonic8"}, "path": "src/main/java/com/hubspot/jinjava/lib/exptest/IsEscapedExpTest.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.hubspot.jinjava.lib.exptest;\n+\n+import com.hubspot.jinjava.doc.annotations.JinjavaDoc;\n+import com.hubspot.jinjava.doc.annotations.JinjavaParam;\n+import com.hubspot.jinjava.doc.annotations.JinjavaSnippet;\n+import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n+import com.hubspot.jinjava.objects.SafeString;\n+\n+@JinjavaDoc(\n+  value = \"Return true if the object is marked as escaped.\",\n+  input = @JinjavaParam(value = \"object\", type = \"object\", required = true),\n+  snippets = {\n+    @JinjavaSnippet(\n+      code = \"{% if 'test' is escaped %}\\n\" +\n+      \"      <!--this code will not render-->\\n\" +\n+      \"{% endif %}\"\n+    ),\n+    @JinjavaSnippet(\n+      code = \"{% if ('test'|escape) is escaped %}\\n\" +\n+      \"      <!--this code will render-->\\n\" +\n+      \"{% endif %}\"\n+    ),\n+    @JinjavaSnippet(\n+      code = \"{% if ('test'|safe) is escaped %}\\n\" +\n+      \"      <!--this code will render-->\\n\" +\n+      \"{% endif %}\"\n+    )\n+  }\n+)\n+public class IsEscapedExpTest implements ExpTest {\n+\n+  @Override\n+  public String getName() {\n+    return \"escaped\";\n+  }\n+\n+  @Override\n+  public boolean evaluate(Object var, JinjavaInterpreter interpreter, Object... args) {\n+    return var instanceof SafeString;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI3NjU5OA=="}, "originalCommit": {"oid": "d7b76f485c9fdf171d79a9b2ce6d2ce3183dcd84"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDUxMzUwMw==", "bodyText": "Ok thanks for explaining. I guess it makes sense otherwise we would end up with double escaped strings.", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r430513503", "createdAt": "2020-05-26T15:41:38Z", "author": {"login": "Joeoh"}, "path": "src/main/java/com/hubspot/jinjava/lib/exptest/IsEscapedExpTest.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.hubspot.jinjava.lib.exptest;\n+\n+import com.hubspot.jinjava.doc.annotations.JinjavaDoc;\n+import com.hubspot.jinjava.doc.annotations.JinjavaParam;\n+import com.hubspot.jinjava.doc.annotations.JinjavaSnippet;\n+import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n+import com.hubspot.jinjava.objects.SafeString;\n+\n+@JinjavaDoc(\n+  value = \"Return true if the object is marked as escaped.\",\n+  input = @JinjavaParam(value = \"object\", type = \"object\", required = true),\n+  snippets = {\n+    @JinjavaSnippet(\n+      code = \"{% if 'test' is escaped %}\\n\" +\n+      \"      <!--this code will not render-->\\n\" +\n+      \"{% endif %}\"\n+    ),\n+    @JinjavaSnippet(\n+      code = \"{% if ('test'|escape) is escaped %}\\n\" +\n+      \"      <!--this code will render-->\\n\" +\n+      \"{% endif %}\"\n+    ),\n+    @JinjavaSnippet(\n+      code = \"{% if ('test'|safe) is escaped %}\\n\" +\n+      \"      <!--this code will render-->\\n\" +\n+      \"{% endif %}\"\n+    )\n+  }\n+)\n+public class IsEscapedExpTest implements ExpTest {\n+\n+  @Override\n+  public String getName() {\n+    return \"escaped\";\n+  }\n+\n+  @Override\n+  public boolean evaluate(Object var, JinjavaInterpreter interpreter, Object... args) {\n+    return var instanceof SafeString;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI3NjU5OA=="}, "originalCommit": {"oid": "d7b76f485c9fdf171d79a9b2ce6d2ce3183dcd84"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTM5MTQ3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/hubspot/jinjava/lib/exptest/IsFloatExpTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMzo0MDoxOVrOGfu7Pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMzo0MDoxOVrOGfu7Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkyNzg3MQ==", "bodyText": "I think we need to check BigDecimal as well (see the AddFilter). BigDecimal support was added in the math filters since python supports arbitrary precision and we had to come up with a workaround for Java.", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r435927871", "createdAt": "2020-06-05T13:40:19Z", "author": {"login": "mattcoley"}, "path": "src/main/java/com/hubspot/jinjava/lib/exptest/IsFloatExpTest.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package com.hubspot.jinjava.lib.exptest;\n+\n+import com.hubspot.jinjava.doc.annotations.JinjavaDoc;\n+import com.hubspot.jinjava.doc.annotations.JinjavaParam;\n+import com.hubspot.jinjava.doc.annotations.JinjavaSnippet;\n+import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n+\n+@JinjavaDoc(\n+  value = \"Return true if object is a float\",\n+  input = @JinjavaParam(value = \"value\", type = \"object\", required = true),\n+  snippets = {\n+    @JinjavaSnippet(\n+      code = \"{% if num is float %}\\n\" +\n+      \"      <!--code to render if num contains an floating point value-->\\n\" +\n+      \"{% endif %}\"\n+    )\n+  }\n+)\n+public class IsFloatExpTest implements ExpTest {\n+\n+  @Override\n+  public String getName() {\n+    return \"float\";\n+  }\n+\n+  @Override\n+  public boolean evaluate(Object var, JinjavaInterpreter interpreter, Object... args) {\n+    return var instanceof Double || var instanceof Float;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7b76f485c9fdf171d79a9b2ce6d2ce3183dcd84"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTM5NTg2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/hubspot/jinjava/lib/exptest/IsIntegerExpTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMzo0MTozMlrOGfu-Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMzo0MTozMlrOGfu-Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkyODYyMg==", "bodyText": "Same here, we will have to handle arbitrarily long numbers.", "url": "https://github.com/HubSpot/jinjava/pull/446#discussion_r435928622", "createdAt": "2020-06-05T13:41:32Z", "author": {"login": "mattcoley"}, "path": "src/main/java/com/hubspot/jinjava/lib/exptest/IsIntegerExpTest.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package com.hubspot.jinjava.lib.exptest;\n+\n+import com.hubspot.jinjava.doc.annotations.JinjavaDoc;\n+import com.hubspot.jinjava.doc.annotations.JinjavaParam;\n+import com.hubspot.jinjava.doc.annotations.JinjavaSnippet;\n+import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n+\n+@JinjavaDoc(\n+  value = \"Return true if object is an integer or long\",\n+  input = @JinjavaParam(value = \"value\", type = \"object\", required = true),\n+  snippets = {\n+    @JinjavaSnippet(\n+      code = \"{% if num is integer %}\\n\" +\n+      \"      <!--code to render if num contains an integral value-->\\n\" +\n+      \"{% endif %}\"\n+    )\n+  }\n+)\n+public class IsIntegerExpTest implements ExpTest {\n+\n+  @Override\n+  public String getName() {\n+    return \"integer\";\n+  }\n+\n+  @Override\n+  public boolean evaluate(Object var, JinjavaInterpreter interpreter, Object... args) {\n+    return var instanceof Integer || var instanceof Long;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7b76f485c9fdf171d79a9b2ce6d2ce3183dcd84"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1689, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}