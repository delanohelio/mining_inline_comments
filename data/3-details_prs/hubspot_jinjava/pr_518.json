{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxNjg3MzU0", "number": 518, "title": "Preserve Raw Tags config", "bodyText": "Adds an option to the JinjavaConfig to preserve raw tags. This option can be set while performing a pre-render with the possibility that there will be deferred values. If a value like contact is deferred, and there is a raw tag like: {% raw %}Hello {{contact.firstname}}!{% endraw %}, the raw tags must be preserved during the first rendering pass, otherwise, on the second pass, Hello {{contact.firstname}}! will get resolved like Hello Jack! instead of remaining, verbatim.\nWhen no values are being deferred, (ie the final render), preserveRawTags should be set to false, and then raw tags will be removed from the rendered output, and leave their children as they were written.", "createdAt": "2020-10-12T16:37:14Z", "url": "https://github.com/HubSpot/jinjava/pull/518", "merged": true, "mergeCommit": {"oid": "cc5905f861d8f898aaed14a9030010dd9e4397f7"}, "closed": true, "closedAt": "2020-10-26T14:22:12Z", "author": {"login": "jasmith-hs"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQ9ApEAH2gAyNTAxNjg3MzU0OmY2MzI0ODlhZjg5Y2EwZDE2NmVkYjJjODViNjU3Y2ZiMTVkY2VkYmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVbcUmgH2gAyNTAxNjg3MzU0OjA1YjViOWNhNTk0MWM3MjJlODUxNDhjOGQzNjc1NTgxOTQxYTQ4M2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f632489af89ca0d166edb2c85b657cfb15dcedba", "author": {"user": {"login": "jasmith-hs", "name": "Jack Smith"}}, "url": "https://github.com/HubSpot/jinjava/commit/f632489af89ca0d166edb2c85b657cfb15dcedba", "committedDate": "2020-10-09T21:24:56Z", "message": "Add preserving raw tags for double-renderings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f120e5afd4da6255c4a0bb55b83198bf4732019", "author": {"user": {"login": "jasmith-hs", "name": "Jack Smith"}}, "url": "https://github.com/HubSpot/jinjava/commit/4f120e5afd4da6255c4a0bb55b83198bf4732019", "committedDate": "2020-10-12T14:12:53Z", "message": "Include image in exception, allow length limiting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "279806671bd15351aa3314803cbdc0c4c799d814", "author": {"user": {"login": "jasmith-hs", "name": "Jack Smith"}}, "url": "https://github.com/HubSpot/jinjava/commit/279806671bd15351aa3314803cbdc0c4c799d814", "committedDate": "2020-10-12T15:35:48Z", "message": "Handle preserved raw tag exception in TagNode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09f47a2e2bbb8f1b30f609c0b7e1f66a13104d27", "author": {"user": {"login": "jasmith-hs", "name": "Jack Smith"}}, "url": "https://github.com/HubSpot/jinjava/commit/09f47a2e2bbb8f1b30f609c0b7e1f66a13104d27", "committedDate": "2020-10-12T15:46:55Z", "message": "Test preserving raw tags"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd642d0dba03031d85fd9b17b2dce2d5c8776aeb", "author": {"user": {"login": "jasmith-hs", "name": "Jack Smith"}}, "url": "https://github.com/HubSpot/jinjava/commit/dd642d0dba03031d85fd9b17b2dce2d5c8776aeb", "committedDate": "2020-10-12T15:47:07Z", "message": "Exception isn't thrown here"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a", "author": {"user": {"login": "jasmith-hs", "name": "Jack Smith"}}, "url": "https://github.com/HubSpot/jinjava/commit/cc431d4f523d3f34014086e72af61ba77c62173a", "committedDate": "2020-10-12T16:36:01Z", "message": "Add license"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDk1NTM2", "url": "https://github.com/HubSpot/jinjava/pull/518#pullrequestreview-507495536", "createdAt": "2020-10-13T14:26:31Z", "commit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNDoyNjozMVrOHgpkag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNDozMDoxNFrOHgpvww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk5NzU0Ng==", "bodyText": "Shouldn't this check all the way up the stack (excluding global) instead of just one level?", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r503997546", "createdAt": "2020-10-13T14:26:31Z", "author": {"login": "boulter"}, "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "diffHunk": "@@ -290,6 +291,21 @@ public void handleDeferredNode(Node node) {\n     return ImmutableSet.copyOf(deferredNodes);\n   }\n \n+  public void handlePreservedRawTag() {\n+    hasPreservedRawTags = true;\n+    if (getParent() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAwMDQ1MQ==", "bodyText": "You can use assertThatThrownBy() here.", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r504000451", "createdAt": "2020-10-13T14:30:14Z", "author": {"login": "boulter"}, "path": "src/test/java/com/hubspot/jinjava/lib/tag/RawTagTest.java", "diffHunk": "@@ -91,6 +96,31 @@ public void itDoesntProcessJinjaCommentsWithinARawBlock() {\n       .contains(\"{{#each people}}\");\n   }\n \n+  @Test\n+  public void itPreservesRawTags() {\n+    TagNode tagNode = fixture(\"hubl\");\n+    JinjavaInterpreter preserveInterpreter = new JinjavaInterpreter(\n+      jinjava,\n+      jinjava.getGlobalContextCopy(),\n+      JinjavaConfig.newBuilder().withPreserveRawTags(true).build()\n+    );\n+    Throwable throwable = catchThrowable(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMTEwNzI1", "url": "https://github.com/HubSpot/jinjava/pull/518#pullrequestreview-513110725", "createdAt": "2020-10-20T20:34:00Z", "commit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDozNDowMFrOHlP_TA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDozNDowMFrOHlP_TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyMTMyNA==", "bodyText": "Why throw exception here instead of\nreturn result.toString();\n\n?", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r508821324", "createdAt": "2020-10-20T20:34:00Z", "author": {"login": "hs-lsong"}, "path": "src/main/java/com/hubspot/jinjava/lib/tag/RawTag.java", "diffHunk": "@@ -33,6 +34,14 @@ public String interpret(TagNode tagNode, JinjavaInterpreter interpreter) {\n     LengthLimitingStringBuilder result = new LengthLimitingStringBuilder(\n       interpreter.getConfig().getMaxOutputSize()\n     );\n+    if (interpreter.getConfig().isPreserveRawTags()) {\n+      result.append(renderNodeRaw(tagNode));\n+      throw new PreservedRawTagException(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMTE4MjMw", "url": "https://github.com/HubSpot/jinjava/pull/518#pullrequestreview-513118230", "createdAt": "2020-10-20T20:44:36Z", "commit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDo0NDozNlrOHlQWlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDo0NDozNlrOHlQWlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyNzI4NA==", "bodyText": "Can you also add a test for deferred values? I thought deferred values will not get evaluated normally. Do they get evaluated inside raw tags?", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r508827284", "createdAt": "2020-10-20T20:44:36Z", "author": {"login": "hs-lsong"}, "path": "src/test/java/com/hubspot/jinjava/interpret/JinjavaInterpreterTest.java", "diffHunk": "@@ -220,4 +220,24 @@ public void itLimitsOutputSizeWhenSumOfNodeSizesExceedsMax() {\n     assertThat(renderResult.getErrors().get(0).getMessage())\n       .contains(\"OutputTooBigException\");\n   }\n+\n+  @Test\n+  public void itCanPreserveRawTags() {\n+    JinjavaConfig preserveRawTagsConfig = JinjavaConfig\n+      .newBuilder()\n+      .withPreserveRawTags(true)\n+      .build();\n+    String input = \"1{% raw %}2{% endraw %}3\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc431d4f523d3f34014086e72af61ba77c62173a"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "229b277c0df8b9099f1885cba9bd555e5977cf3f", "author": {"user": {"login": "jasmith-hs", "name": "Jack Smith"}}, "url": "https://github.com/HubSpot/jinjava/commit/229b277c0df8b9099f1885cba9bd555e5977cf3f", "committedDate": "2020-10-21T13:20:25Z", "message": "Refactor to remove PreservedRawTagException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17c5a1cf0ebea4a1142dde68dcf74fa806016212", "author": {"user": {"login": "jasmith-hs", "name": "Jack Smith"}}, "url": "https://github.com/HubSpot/jinjava/commit/17c5a1cf0ebea4a1142dde68dcf74fa806016212", "committedDate": "2020-10-21T13:30:59Z", "message": "Add deferred preserving test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzOTkwNDYx", "url": "https://github.com/HubSpot/jinjava/pull/518#pullrequestreview-513990461", "createdAt": "2020-10-21T17:16:30Z", "commit": {"oid": "17c5a1cf0ebea4a1142dde68dcf74fa806016212"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNzoxNjozMFrOHl3OHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNzoxNjozMFrOHl3OHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2NDA5NA==", "bodyText": "I don't see this function is used. Is this needed?", "url": "https://github.com/HubSpot/jinjava/pull/518#discussion_r509464094", "createdAt": "2020-10-21T17:16:30Z", "author": {"login": "hs-lsong"}, "path": "src/main/java/com/hubspot/jinjava/interpret/Context.java", "diffHunk": "@@ -290,6 +291,21 @@ public void handleDeferredNode(Node node) {\n     return ImmutableSet.copyOf(deferredNodes);\n   }\n \n+  public void handlePreservedRawTag() {\n+    hasPreservedRawTags = true;\n+    if (getParent() != null) {\n+      Context parent = getParent();\n+      //Ignore global context\n+      if (parent.getParent() != null) {\n+        getParent().handlePreservedRawTag();\n+      }\n+    }\n+  }\n+\n+  public boolean getHasPreservedRawTags() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17c5a1cf0ebea4a1142dde68dcf74fa806016212"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bccbc982f797494ef5e9a9d80c4f5bc544bc8091", "author": {"user": {"login": "jasmith-hs", "name": "Jack Smith"}}, "url": "https://github.com/HubSpot/jinjava/commit/bccbc982f797494ef5e9a9d80c4f5bc544bc8091", "committedDate": "2020-10-23T15:21:49Z", "message": "Removed hasPreservedRawTags"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "277cc64356f344e112974e441366101474d11cc5", "author": {"user": {"login": "jasmith-hs", "name": "Jack Smith"}}, "url": "https://github.com/HubSpot/jinjava/commit/277cc64356f344e112974e441366101474d11cc5", "committedDate": "2020-10-23T15:25:54Z", "message": "Use more generic config flag name: \"preserveForSecondPass\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e041b1871fa8f24b675e9aa7d7c991f607ece91", "author": {"user": {"login": "jasmith-hs", "name": "Jack Smith"}}, "url": "https://github.com/HubSpot/jinjava/commit/1e041b1871fa8f24b675e9aa7d7c991f607ece91", "committedDate": "2020-10-23T15:27:23Z", "message": "Add trailing newline to test jinja resource"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1Nzg1MTU1", "url": "https://github.com/HubSpot/jinjava/pull/518#pullrequestreview-515785155", "createdAt": "2020-10-23T15:36:13Z", "commit": {"oid": "1e041b1871fa8f24b675e9aa7d7c991f607ece91"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05b5b9ca5941c722e85148c8d3675581941a483b", "author": {"user": {"login": "jasmith-hs", "name": "Jack Smith"}}, "url": "https://github.com/HubSpot/jinjava/commit/05b5b9ca5941c722e85148c8d3675581941a483b", "committedDate": "2020-10-23T19:08:01Z", "message": "Trim before comparing in raw test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1544, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}