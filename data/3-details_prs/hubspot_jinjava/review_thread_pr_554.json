{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5ODYxMTgz", "number": 554, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwOToxOTo1N1rOE_B7XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNToxNzozNVrOE_qxuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0NTI3MzI1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerForTag.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwOToxOTo1N1rOH8gHsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNDowNzo0OFrOH8uKmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzIwMjg2NA==", "bodyText": "Maybe join this string just once", "url": "https://github.com/HubSpot/jinjava/pull/554#discussion_r533202864", "createdAt": "2020-12-01T09:19:57Z", "author": {"login": "Joeoh"}, "path": "src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerForTag.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.hubspot.jinjava.lib.tag.eager;\n+\n+import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n+import com.hubspot.jinjava.interpret.TemplateSyntaxException;\n+import com.hubspot.jinjava.lib.tag.ForTag;\n+import com.hubspot.jinjava.tree.parse.TagToken;\n+import com.hubspot.jinjava.util.ChunkResolver;\n+import com.hubspot.jinjava.util.HelperStringTokenizer;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.StringJoiner;\n+\n+public class EagerForTag extends EagerTagDecorator<ForTag> {\n+\n+  public EagerForTag() {\n+    super(new ForTag());\n+  }\n+\n+  public EagerForTag(ForTag forTag) {\n+    super(forTag);\n+  }\n+\n+  @Override\n+  public String getEagerTagImage(TagToken tagToken, JinjavaInterpreter interpreter) {\n+    List<String> helperTokens = new HelperStringTokenizer(\n+      ForTag.getWhitespaceAdjustedHelpers(tagToken.getHelpers())\n+    )\n+      .splitComma(true)\n+      .allTokens();\n+    List<String> loopVars = getTag().getLoopVars(helperTokens);\n+    if (loopVars.size() >= helperTokens.size()) {\n+      throw new TemplateSyntaxException(\n+        tagToken.getHelpers().trim(),\n+        \"Tag 'for' expects valid 'in' clause, got: \" + tagToken.getHelpers(),\n+        tagToken.getLineNumber(),\n+        tagToken.getStartPosition()\n+      );\n+    }\n+\n+    String loopExpression = getTag().getLoopExpression(helperTokens, loopVars);\n+    ChunkResolver chunkResolver = new ChunkResolver(\n+      loopExpression,\n+      tagToken,\n+      interpreter\n+    );\n+\n+    StringJoiner joiner = new StringJoiner(\" \");\n+    joiner\n+      .add(tagToken.getSymbols().getExpressionStartWithTag())\n+      .add(tagToken.getTagName())\n+      .add(String.join(\", \", loopVars))\n+      .add(\"in\")\n+      .add(chunkResolver.resolveChunks())\n+      .add(tagToken.getSymbols().getExpressionEndWithTag());\n+    String newlyDeferredFunctionImages = reconstructFromContextBeforeDeferring(\n+      chunkResolver.getDeferredWords(),\n+      interpreter\n+    );\n+\n+    interpreter\n+      .getContext()\n+      .handleEagerToken(\n+        new EagerToken(\n+          new TagToken(\n+            joiner.toString(),\n+            tagToken.getLineNumber(),\n+            tagToken.getStartPosition(),\n+            tagToken.getSymbols()\n+          ),\n+          chunkResolver.getDeferredWords(),\n+          new HashSet<>(loopVars)\n+        )\n+      );\n+    return (newlyDeferredFunctionImages + joiner.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "597dbe74b7196a15955446d38247ebb9dc9e7f63"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzIxNzI3Ng==", "bodyText": "Also, should we be using the LengthLimitingStringBuilder here too? I'm thinking of something like {% for i in range(0,MAX_INT) %} with a large body where the output could become huge", "url": "https://github.com/HubSpot/jinjava/pull/554#discussion_r533217276", "createdAt": "2020-12-01T09:29:26Z", "author": {"login": "Joeoh"}, "path": "src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerForTag.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.hubspot.jinjava.lib.tag.eager;\n+\n+import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n+import com.hubspot.jinjava.interpret.TemplateSyntaxException;\n+import com.hubspot.jinjava.lib.tag.ForTag;\n+import com.hubspot.jinjava.tree.parse.TagToken;\n+import com.hubspot.jinjava.util.ChunkResolver;\n+import com.hubspot.jinjava.util.HelperStringTokenizer;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.StringJoiner;\n+\n+public class EagerForTag extends EagerTagDecorator<ForTag> {\n+\n+  public EagerForTag() {\n+    super(new ForTag());\n+  }\n+\n+  public EagerForTag(ForTag forTag) {\n+    super(forTag);\n+  }\n+\n+  @Override\n+  public String getEagerTagImage(TagToken tagToken, JinjavaInterpreter interpreter) {\n+    List<String> helperTokens = new HelperStringTokenizer(\n+      ForTag.getWhitespaceAdjustedHelpers(tagToken.getHelpers())\n+    )\n+      .splitComma(true)\n+      .allTokens();\n+    List<String> loopVars = getTag().getLoopVars(helperTokens);\n+    if (loopVars.size() >= helperTokens.size()) {\n+      throw new TemplateSyntaxException(\n+        tagToken.getHelpers().trim(),\n+        \"Tag 'for' expects valid 'in' clause, got: \" + tagToken.getHelpers(),\n+        tagToken.getLineNumber(),\n+        tagToken.getStartPosition()\n+      );\n+    }\n+\n+    String loopExpression = getTag().getLoopExpression(helperTokens, loopVars);\n+    ChunkResolver chunkResolver = new ChunkResolver(\n+      loopExpression,\n+      tagToken,\n+      interpreter\n+    );\n+\n+    StringJoiner joiner = new StringJoiner(\" \");\n+    joiner\n+      .add(tagToken.getSymbols().getExpressionStartWithTag())\n+      .add(tagToken.getTagName())\n+      .add(String.join(\", \", loopVars))\n+      .add(\"in\")\n+      .add(chunkResolver.resolveChunks())\n+      .add(tagToken.getSymbols().getExpressionEndWithTag());\n+    String newlyDeferredFunctionImages = reconstructFromContextBeforeDeferring(\n+      chunkResolver.getDeferredWords(),\n+      interpreter\n+    );\n+\n+    interpreter\n+      .getContext()\n+      .handleEagerToken(\n+        new EagerToken(\n+          new TagToken(\n+            joiner.toString(),\n+            tagToken.getLineNumber(),\n+            tagToken.getStartPosition(),\n+            tagToken.getSymbols()\n+          ),\n+          chunkResolver.getDeferredWords(),\n+          new HashSet<>(loopVars)\n+        )\n+      );\n+    return (newlyDeferredFunctionImages + joiner.toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzIwMjg2NA=="}, "originalCommit": {"oid": "597dbe74b7196a15955446d38247ebb9dc9e7f63"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQzMjk4NQ==", "bodyText": "That's a good call", "url": "https://github.com/HubSpot/jinjava/pull/554#discussion_r533432985", "createdAt": "2020-12-01T14:07:48Z", "author": {"login": "jasmith-hs"}, "path": "src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerForTag.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.hubspot.jinjava.lib.tag.eager;\n+\n+import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n+import com.hubspot.jinjava.interpret.TemplateSyntaxException;\n+import com.hubspot.jinjava.lib.tag.ForTag;\n+import com.hubspot.jinjava.tree.parse.TagToken;\n+import com.hubspot.jinjava.util.ChunkResolver;\n+import com.hubspot.jinjava.util.HelperStringTokenizer;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.StringJoiner;\n+\n+public class EagerForTag extends EagerTagDecorator<ForTag> {\n+\n+  public EagerForTag() {\n+    super(new ForTag());\n+  }\n+\n+  public EagerForTag(ForTag forTag) {\n+    super(forTag);\n+  }\n+\n+  @Override\n+  public String getEagerTagImage(TagToken tagToken, JinjavaInterpreter interpreter) {\n+    List<String> helperTokens = new HelperStringTokenizer(\n+      ForTag.getWhitespaceAdjustedHelpers(tagToken.getHelpers())\n+    )\n+      .splitComma(true)\n+      .allTokens();\n+    List<String> loopVars = getTag().getLoopVars(helperTokens);\n+    if (loopVars.size() >= helperTokens.size()) {\n+      throw new TemplateSyntaxException(\n+        tagToken.getHelpers().trim(),\n+        \"Tag 'for' expects valid 'in' clause, got: \" + tagToken.getHelpers(),\n+        tagToken.getLineNumber(),\n+        tagToken.getStartPosition()\n+      );\n+    }\n+\n+    String loopExpression = getTag().getLoopExpression(helperTokens, loopVars);\n+    ChunkResolver chunkResolver = new ChunkResolver(\n+      loopExpression,\n+      tagToken,\n+      interpreter\n+    );\n+\n+    StringJoiner joiner = new StringJoiner(\" \");\n+    joiner\n+      .add(tagToken.getSymbols().getExpressionStartWithTag())\n+      .add(tagToken.getTagName())\n+      .add(String.join(\", \", loopVars))\n+      .add(\"in\")\n+      .add(chunkResolver.resolveChunks())\n+      .add(tagToken.getSymbols().getExpressionEndWithTag());\n+    String newlyDeferredFunctionImages = reconstructFromContextBeforeDeferring(\n+      chunkResolver.getDeferredWords(),\n+      interpreter\n+    );\n+\n+    interpreter\n+      .getContext()\n+      .handleEagerToken(\n+        new EagerToken(\n+          new TagToken(\n+            joiner.toString(),\n+            tagToken.getLineNumber(),\n+            tagToken.getStartPosition(),\n+            tagToken.getSymbols()\n+          ),\n+          chunkResolver.getDeferredWords(),\n+          new HashSet<>(loopVars)\n+        )\n+      );\n+    return (newlyDeferredFunctionImages + joiner.toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzIwMjg2NA=="}, "originalCommit": {"oid": "597dbe74b7196a15955446d38247ebb9dc9e7f63"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MTk2NjAwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerForTag.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNToxNzozNVrOH9f6cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODoyNTo0MVrOH9oavg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI0ODA0OQ==", "bodyText": "There's a guava joiner which I see used more commonly. One advantage is that you can declare it statically. I'm not sure if it's worth changing to that one.", "url": "https://github.com/HubSpot/jinjava/pull/554#discussion_r534248049", "createdAt": "2020-12-02T15:17:35Z", "author": {"login": "boulter"}, "path": "src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerForTag.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.hubspot.jinjava.lib.tag.eager;\n+\n+import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n+import com.hubspot.jinjava.interpret.TemplateSyntaxException;\n+import com.hubspot.jinjava.lib.tag.ForTag;\n+import com.hubspot.jinjava.tree.parse.TagToken;\n+import com.hubspot.jinjava.util.ChunkResolver;\n+import com.hubspot.jinjava.util.HelperStringTokenizer;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.StringJoiner;\n+\n+public class EagerForTag extends EagerTagDecorator<ForTag> {\n+\n+  public EagerForTag() {\n+    super(new ForTag());\n+  }\n+\n+  public EagerForTag(ForTag forTag) {\n+    super(forTag);\n+  }\n+\n+  @Override\n+  public String getEagerTagImage(TagToken tagToken, JinjavaInterpreter interpreter) {\n+    List<String> helperTokens = new HelperStringTokenizer(\n+      ForTag.getWhitespaceAdjustedHelpers(tagToken.getHelpers())\n+    )\n+      .splitComma(true)\n+      .allTokens();\n+    List<String> loopVars = getTag().getLoopVars(helperTokens);\n+    if (loopVars.size() >= helperTokens.size()) {\n+      throw new TemplateSyntaxException(\n+        tagToken.getHelpers().trim(),\n+        \"Tag 'for' expects valid 'in' clause, got: \" + tagToken.getHelpers(),\n+        tagToken.getLineNumber(),\n+        tagToken.getStartPosition()\n+      );\n+    }\n+\n+    String loopExpression = getTag().getLoopExpression(helperTokens, loopVars);\n+    ChunkResolver chunkResolver = new ChunkResolver(\n+      loopExpression,\n+      tagToken,\n+      interpreter\n+    );\n+\n+    StringJoiner joiner = new StringJoiner(\" \");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "597dbe74b7196a15955446d38247ebb9dc9e7f63"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDMzMTE4Mg==", "bodyText": "I'll be swapping these usages out with the length limiting joiner that I'm adding so I will see which makes more sense to use in that class.\nMaybe I'll run a simple performance test to see which is faster", "url": "https://github.com/HubSpot/jinjava/pull/554#discussion_r534331182", "createdAt": "2020-12-02T17:02:10Z", "author": {"login": "jasmith-hs"}, "path": "src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerForTag.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.hubspot.jinjava.lib.tag.eager;\n+\n+import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n+import com.hubspot.jinjava.interpret.TemplateSyntaxException;\n+import com.hubspot.jinjava.lib.tag.ForTag;\n+import com.hubspot.jinjava.tree.parse.TagToken;\n+import com.hubspot.jinjava.util.ChunkResolver;\n+import com.hubspot.jinjava.util.HelperStringTokenizer;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.StringJoiner;\n+\n+public class EagerForTag extends EagerTagDecorator<ForTag> {\n+\n+  public EagerForTag() {\n+    super(new ForTag());\n+  }\n+\n+  public EagerForTag(ForTag forTag) {\n+    super(forTag);\n+  }\n+\n+  @Override\n+  public String getEagerTagImage(TagToken tagToken, JinjavaInterpreter interpreter) {\n+    List<String> helperTokens = new HelperStringTokenizer(\n+      ForTag.getWhitespaceAdjustedHelpers(tagToken.getHelpers())\n+    )\n+      .splitComma(true)\n+      .allTokens();\n+    List<String> loopVars = getTag().getLoopVars(helperTokens);\n+    if (loopVars.size() >= helperTokens.size()) {\n+      throw new TemplateSyntaxException(\n+        tagToken.getHelpers().trim(),\n+        \"Tag 'for' expects valid 'in' clause, got: \" + tagToken.getHelpers(),\n+        tagToken.getLineNumber(),\n+        tagToken.getStartPosition()\n+      );\n+    }\n+\n+    String loopExpression = getTag().getLoopExpression(helperTokens, loopVars);\n+    ChunkResolver chunkResolver = new ChunkResolver(\n+      loopExpression,\n+      tagToken,\n+      interpreter\n+    );\n+\n+    StringJoiner joiner = new StringJoiner(\" \");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI0ODA0OQ=="}, "originalCommit": {"oid": "597dbe74b7196a15955446d38247ebb9dc9e7f63"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM3NDU4Mg==", "bodyText": "Looks like the java.util.StringJoiner is 2-3x faster than the guava joiner so I'll stick with it.\nTime to join 10k and 1 million a characters with a , character:\n\n\n\nNumber of elements\nStringJoiner\nGuava Joiner\n\n\n\n\n10000\n1 ms\n8 ms\n\n\n1000000\n17 ms\n51 ms", "url": "https://github.com/HubSpot/jinjava/pull/554#discussion_r534374582", "createdAt": "2020-12-02T18:05:21Z", "author": {"login": "jasmith-hs"}, "path": "src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerForTag.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.hubspot.jinjava.lib.tag.eager;\n+\n+import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n+import com.hubspot.jinjava.interpret.TemplateSyntaxException;\n+import com.hubspot.jinjava.lib.tag.ForTag;\n+import com.hubspot.jinjava.tree.parse.TagToken;\n+import com.hubspot.jinjava.util.ChunkResolver;\n+import com.hubspot.jinjava.util.HelperStringTokenizer;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.StringJoiner;\n+\n+public class EagerForTag extends EagerTagDecorator<ForTag> {\n+\n+  public EagerForTag() {\n+    super(new ForTag());\n+  }\n+\n+  public EagerForTag(ForTag forTag) {\n+    super(forTag);\n+  }\n+\n+  @Override\n+  public String getEagerTagImage(TagToken tagToken, JinjavaInterpreter interpreter) {\n+    List<String> helperTokens = new HelperStringTokenizer(\n+      ForTag.getWhitespaceAdjustedHelpers(tagToken.getHelpers())\n+    )\n+      .splitComma(true)\n+      .allTokens();\n+    List<String> loopVars = getTag().getLoopVars(helperTokens);\n+    if (loopVars.size() >= helperTokens.size()) {\n+      throw new TemplateSyntaxException(\n+        tagToken.getHelpers().trim(),\n+        \"Tag 'for' expects valid 'in' clause, got: \" + tagToken.getHelpers(),\n+        tagToken.getLineNumber(),\n+        tagToken.getStartPosition()\n+      );\n+    }\n+\n+    String loopExpression = getTag().getLoopExpression(helperTokens, loopVars);\n+    ChunkResolver chunkResolver = new ChunkResolver(\n+      loopExpression,\n+      tagToken,\n+      interpreter\n+    );\n+\n+    StringJoiner joiner = new StringJoiner(\" \");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI0ODA0OQ=="}, "originalCommit": {"oid": "597dbe74b7196a15955446d38247ebb9dc9e7f63"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM4NzM5MA==", "bodyText": "Interesting. Thanks for verifying. The JDK StringJoiner was introduced in Java 8, so maybe it's just historical that we use it. That said, the guava version has some nice features like skipNulls", "url": "https://github.com/HubSpot/jinjava/pull/554#discussion_r534387390", "createdAt": "2020-12-02T18:25:41Z", "author": {"login": "boulter"}, "path": "src/main/java/com/hubspot/jinjava/lib/tag/eager/EagerForTag.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.hubspot.jinjava.lib.tag.eager;\n+\n+import com.hubspot.jinjava.interpret.JinjavaInterpreter;\n+import com.hubspot.jinjava.interpret.TemplateSyntaxException;\n+import com.hubspot.jinjava.lib.tag.ForTag;\n+import com.hubspot.jinjava.tree.parse.TagToken;\n+import com.hubspot.jinjava.util.ChunkResolver;\n+import com.hubspot.jinjava.util.HelperStringTokenizer;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.StringJoiner;\n+\n+public class EagerForTag extends EagerTagDecorator<ForTag> {\n+\n+  public EagerForTag() {\n+    super(new ForTag());\n+  }\n+\n+  public EagerForTag(ForTag forTag) {\n+    super(forTag);\n+  }\n+\n+  @Override\n+  public String getEagerTagImage(TagToken tagToken, JinjavaInterpreter interpreter) {\n+    List<String> helperTokens = new HelperStringTokenizer(\n+      ForTag.getWhitespaceAdjustedHelpers(tagToken.getHelpers())\n+    )\n+      .splitComma(true)\n+      .allTokens();\n+    List<String> loopVars = getTag().getLoopVars(helperTokens);\n+    if (loopVars.size() >= helperTokens.size()) {\n+      throw new TemplateSyntaxException(\n+        tagToken.getHelpers().trim(),\n+        \"Tag 'for' expects valid 'in' clause, got: \" + tagToken.getHelpers(),\n+        tagToken.getLineNumber(),\n+        tagToken.getStartPosition()\n+      );\n+    }\n+\n+    String loopExpression = getTag().getLoopExpression(helperTokens, loopVars);\n+    ChunkResolver chunkResolver = new ChunkResolver(\n+      loopExpression,\n+      tagToken,\n+      interpreter\n+    );\n+\n+    StringJoiner joiner = new StringJoiner(\" \");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI0ODA0OQ=="}, "originalCommit": {"oid": "597dbe74b7196a15955446d38247ebb9dc9e7f63"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1660, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}