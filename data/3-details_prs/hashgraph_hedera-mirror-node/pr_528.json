{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNjMyMjUz", "number": 528, "title": "Monitor script/service to bounce hedera-mirror-grpc when it gets stuck.", "bodyText": "Adds hedera-mirror-grpc-monitor systemd service installed via same deploy.sh script as hedera-mirror-grpc.\nService periodically (5 secs) polls DB for \"stuck\" or long running (default 15 seconds) selects locking the topic_message table, and pg_terminate_backends them as well as restarting the hedera-mirror-grpc systemd service when these possibly-stuck queries are detected.\nNew service is configured via environment variables set in /usr/etc/hedera-mirror-grpc-monitor/config\n\nPGPASSWORD=mirror_grpc-users-password\nDBHOST=dbhost\nPERIOD_SECONDS=5 polling inverval in seconds for querying DB for stuck select queries\nMAX_QUERY_AGE_SECONDS=15 when querying for stuck queries, kill select statements that have the topic_message table locked and have been running longer than 15 seconds", "createdAt": "2020-02-07T22:42:21Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/528", "merged": true, "mergeCommit": {"oid": "90bf9753a11253972fde32872b9762eb43c80dc8"}, "closed": true, "closedAt": "2020-02-10T20:05:50Z", "author": {"login": "mike-burrage-hedera"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCWa_BgH2gAyMzcyNjMyMjUzOjg5NjU0MTA3NDM0ZGVkMjY5MTJkOThiYjRhMmVkMWNkYmUzNWU0ZjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDC0lVAFqTM1NjIyNTQ1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "89654107434ded26912d98bb4a2ed1cdbe35e4f4", "author": {"user": {"login": "mike-burrage-hedera", "name": "Mike Burrage (Hedera)"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/89654107434ded26912d98bb4a2ed1cdbe35e4f4", "committedDate": "2020-02-08T16:21:19Z", "message": "Monitor script/service to bounce hedera-mirror-grpc when it gets stuck.\n\nSigned-off-by: Mike Burrage <mike.burrage@hedera.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f193f99225bc40f35e091d17d8fb0538798e6795", "author": {"user": {"login": "mike-burrage-hedera", "name": "Mike Burrage (Hedera)"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f193f99225bc40f35e091d17d8fb0538798e6795", "committedDate": "2020-02-07T22:41:00Z", "message": "Monitor script/service to bounce hedera-mirror-grpc when it gets stuck.\n\nSigned-off-by: Mike Burrage <mike.burrage@hedera.com>"}, "afterCommit": {"oid": "89654107434ded26912d98bb4a2ed1cdbe35e4f4", "author": {"user": {"login": "mike-burrage-hedera", "name": "Mike Burrage (Hedera)"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/89654107434ded26912d98bb4a2ed1cdbe35e4f4", "committedDate": "2020-02-08T16:21:19Z", "message": "Monitor script/service to bounce hedera-mirror-grpc when it gets stuck.\n\nSigned-off-by: Mike Burrage <mike.burrage@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NjM0Nzk0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/528#pullrequestreview-355634794", "createdAt": "2020-02-09T21:27:00Z", "commit": {"oid": "89654107434ded26912d98bb4a2ed1cdbe35e4f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQyMToyNzowMFrOFnXE-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQyMToyNzowMFrOFnXE-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxNjg4OA==", "bodyText": "Is it possible to log in an external time framed log file every time this happens.\nThat way we can look back and say it happened x number of times a day etc.\nIf the log also had the topic message num/full query and how many locked up active processed there were it might be useful for debugging.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/528#discussion_r376816888", "createdAt": "2020-02-09T21:27:00Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-grpc/scripts/monitor.sh", "diffHunk": "@@ -0,0 +1,30 @@\n+#!/bin/bash\n+\n+PERIOD_SECONDS=${PERIOD_SECONDS:-5}\n+MAX_QUERY_AGE_SECONDS=${MAX_AGE_SECONDS:-15}\n+echo \"INFO Started. polling period ${PERIOD_SECONDS}s. queries locking topic_message older than ${MAX_QUERY_AGE_SECONDS}s will be killed.\"\n+\n+while true\n+do\n+  bounce_service=false\n+  for pid in `psql -h \"${DBHOST:-dbhost}\" -d \"${DBNAME:-mirror_node}\" -U \"${DBUSER:-mirror_grpc}\" -tc \"select pl.pid from pg_locks pl join pg_stat_activity pa on pa.pid = pl.pid join pg_class pc on pl.relation = pc.OID where pa.query like 'SELECT%' and pc.relname = 'topic_message' and now() - query_start > '${MAX_QUERY_AGE_SECONDS} seconds';\"`\n+  do\n+    case $pid in\n+      ''|*[!0-9]*) echo \"ERROR SQL query results did not appear to return PIDs.\" ;;\n+      *) res=$(psql -h \"${DBHOST:-dbhost}\" -d \"${DBNAME:-mirror_node}\" -U \"${DBUSER:-mirror_grpc}\" -tc \"select pg_terminate_backend($pid);\" | head -1)\n+        rc=$?\n+        if [ $rc -ne 0 ] || [ \"$res\" != \" t\" ] ; then\n+          echo \"ERROR SQL query failed attempting to kill pid $pid.\"\n+        else\n+          echo \"INFO Terminated postgres pid $pid.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89654107434ded26912d98bb4a2ed1cdbe35e4f4"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NzAwMDE3", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/528#pullrequestreview-355700017", "createdAt": "2020-02-10T05:40:27Z", "commit": {"oid": "89654107434ded26912d98bb4a2ed1cdbe35e4f4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MjI1NDU0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/528#pullrequestreview-356225454", "createdAt": "2020-02-10T20:05:06Z", "commit": {"oid": "89654107434ded26912d98bb4a2ed1cdbe35e4f4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3239, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}