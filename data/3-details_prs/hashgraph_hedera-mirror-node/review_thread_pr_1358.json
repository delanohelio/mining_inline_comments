{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5NzMzNzky", "number": 1358, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOToxMzozN1rOFFKLRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNzo0MToyOFrOFGUOwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQwOTUzOTI2OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/transactions.js", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOToxMzozN1rOIFhrKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOToxMzozN1rOIFhrKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY2NTUxMw==", "bodyText": "the comment no longer applies, will remove in the next commit", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r542665513", "createdAt": "2020-12-14T19:13:37Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -223,7 +270,10 @@ const reqToSql = function (req) {\n   const resultTypeQuery = utils.parseResultParams(req, 't.result');\n   const transactionTypeQuery = utils.getTransactionTypeQuery(parsedQueryParams);\n   const {query, params, order, limit} = utils.parseLimitAndOrderParams(req);\n-  const sqlParams = accountParams.concat(tsParams).concat(tsParams).concat(params);\n+\n+  // accountQuery and tsQuery will appear twice in the inner query, one for transaction table and one for\n+  // crypto_transfer table. So concat their params twice here to match the query.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75caa76ac6bc898b294b89ec0c7d36ed4e733e82"}, "originalPosition": 123}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMTIzNzI3OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/transactions.js", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwMDowMTo1NVrOIFyPDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwMDowMTo1NVrOIFyPDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkzNjg0Nw==", "bodyText": "nit:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * @param {String} query - they mysql query\n          \n          \n            \n             * @param {String} query - the mysql query", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r542936847", "createdAt": "2020-12-15T00:01:55Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -169,6 +171,22 @@ const buildWhereClause = function (...conditions) {\n   return clause === '' ? '' : `WHERE ${clause}`;\n };\n \n+/**\n+ * Convert parameters to the named format.\n+ *\n+ * @param {String} query - they mysql query", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMTMwNDU2OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/transactions.js", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwMDoxNTo1MVrOIFy40w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwMDoxNTo1MVrOIFy40w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk0NzUzOQ==", "bodyText": "I think this needs to be slightly reworded since it explicitly mentions Cryptotransfer, which no longer always applies.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r542947539", "createdAt": "2020-12-15T00:15:51Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -169,6 +171,22 @@ const buildWhereClause = function (...conditions) {\n   return clause === '' ? '' : `WHERE ${clause}`;\n };\n \n+/**\n+ * Convert parameters to the named format.\n+ *\n+ * @param {String} query - they mysql query\n+ * @param {String} prefix - the prefix for the named parameters\n+ * @return {String} - The converted query\n+ */\n+const convertToNamedQuery = function (query, prefix) {\n+  let index = 0;\n+  return query.replace(/\\?/g, () => {\n+    const namedParam = `?${prefix}${index}`;\n+    index += 1;\n+    return namedParam;\n+  });\n+};\n+\n /**\n  * Cryptotransfer transactions queries are organized as follows: First there's an inner query that selects the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMTMzMTA0OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/transactions.js", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwMDoyNTo1NlrOIFzHhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjoxMTo1M1rOIGTbtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk1MTMwMA==", "bodyText": "I'm sure this is a much bigger effort and out of the scope of this, but could this replace some of the logic in the individual parseQueryParam methods in utils.js and directly generate the needed format instead of converting, or is there a need for the mySql format somewhere?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r542951300", "createdAt": "2020-12-15T00:25:56Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -169,6 +171,22 @@ const buildWhereClause = function (...conditions) {\n   return clause === '' ? '' : `WHERE ${clause}`;\n };\n \n+/**\n+ * Convert parameters to the named format.\n+ *\n+ * @param {String} query - they mysql query\n+ * @param {String} prefix - the prefix for the named parameters\n+ * @return {String} - The converted query\n+ */\n+const convertToNamedQuery = function (query, prefix) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk1MjI1Nw==", "bodyText": "I'm also not 100% on the name, unless I'm misunderstanding \"named query\" makes me think of a JPA named query, which this is not really emulating.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r542952257", "createdAt": "2020-12-15T00:28:20Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -169,6 +171,22 @@ const buildWhereClause = function (...conditions) {\n   return clause === '' ? '' : `WHERE ${clause}`;\n };\n \n+/**\n+ * Convert parameters to the named format.\n+ *\n+ * @param {String} query - they mysql query\n+ * @param {String} prefix - the prefix for the named parameters\n+ * @return {String} - The converted query\n+ */\n+const convertToNamedQuery = function (query, prefix) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk1MTMwMA=="}, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ3MDc3OA==", "bodyText": "AFAIK, the mysql style query was written at the beginning when the choice of db was mysql. that's why for account/balance/transaction, the query needs to be translated to pg style.\nI intend to limit the scope of \"converting mysql style ? placeholder to named parameter\" to where it's indeed needed, for instance, the transactions inner query since the same REST query param is used in multiple places so in the previous PR tsParams were concat twice.\nEventually, we should remove the translation layer and directly compose pg style query as in topicmessages and tokens.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543470778", "createdAt": "2020-12-15T15:59:36Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -169,6 +171,22 @@ const buildWhereClause = function (...conditions) {\n   return clause === '' ? '' : `WHERE ${clause}`;\n };\n \n+/**\n+ * Convert parameters to the named format.\n+ *\n+ * @param {String} query - they mysql query\n+ * @param {String} prefix - the prefix for the named parameters\n+ * @return {String} - The converted query\n+ */\n+const convertToNamedQuery = function (query, prefix) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk1MTMwMA=="}, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ4MDc1Nw==", "bodyText": "That makes sense, thanks for the details.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543480757", "createdAt": "2020-12-15T16:11:53Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -169,6 +171,22 @@ const buildWhereClause = function (...conditions) {\n   return clause === '' ? '' : `WHERE ${clause}`;\n };\n \n+/**\n+ * Convert parameters to the named format.\n+ *\n+ * @param {String} query - they mysql query\n+ * @param {String} prefix - the prefix for the named parameters\n+ * @return {String} - The converted query\n+ */\n+const convertToNamedQuery = function (query, prefix) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk1MTMwMA=="}, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMTM2NjcwOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/transactions.js", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwMDozOToyMFrOIFzbPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwMDozOToyMFrOIFzbPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk1NjM0OA==", "bodyText": "nit based on the other comments in this file.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // limit the query to transactions with crypto transfer list\n          \n          \n            \n                // limit the query to transactions with cryptotransfer list", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r542956348", "createdAt": "2020-12-15T00:39:20Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -195,23 +213,62 @@ const getTransactionsInnerQuery = function (\n   transactionTypeQuery,\n   order\n ) {\n-  const whereClause = buildWhereClause(tsQuery, resultTypeQuery, transactionTypeQuery);\n-  const ctlTsQuery = tsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n-  const ctlWhereClause = buildWhereClause(accountQuery, ctlTsQuery, creditDebitQuery);\n+  const namedAccountQuery = convertToNamedQuery(accountQuery, 'acct');\n+  const namedTsQuery = convertToNamedQuery(tsQuery, 'ts');\n+  const namedLimitQuery = convertToNamedQuery(limitQuery, 'limit');\n+  const ctlTsQuery = namedTsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n+  let ctlWhereClause;\n+\n+  if (creditDebitQuery) {\n+    // limit the query to transactions with crypto transfer list", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMjIwNjM1OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/transactions.js", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjowODowMVrOIF6eEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjowODowMVrOIF6eEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3MTc2MQ==", "bodyText": "Interesting, did not know about this way of using logical operators", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543071761", "createdAt": "2020-12-15T06:08:01Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -195,23 +213,62 @@ const getTransactionsInnerQuery = function (\n   transactionTypeQuery,\n   order\n ) {\n-  const whereClause = buildWhereClause(tsQuery, resultTypeQuery, transactionTypeQuery);\n-  const ctlTsQuery = tsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n-  const ctlWhereClause = buildWhereClause(accountQuery, ctlTsQuery, creditDebitQuery);\n+  const namedAccountQuery = convertToNamedQuery(accountQuery, 'acct');\n+  const namedTsQuery = convertToNamedQuery(tsQuery, 'ts');\n+  const namedLimitQuery = convertToNamedQuery(limitQuery, 'limit');\n+  const ctlTsQuery = namedTsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n+  let ctlWhereClause;\n+\n+  if (creditDebitQuery) {\n+    // limit the query to transactions with crypto transfer list\n+    ctlWhereClause = buildWhereClause(namedAccountQuery, ctlTsQuery, creditDebitQuery);\n+    const whereClause = buildWhereClause(namedTsQuery, resultTypeQuery, transactionTypeQuery);\n+    return `\n+      SELECT t.consensus_ns AS consensus_timestamp\n+      FROM transaction t\n+      JOIN (\n+        SELECT DISTINCT consensus_timestamp\n+        FROM crypto_transfer AS ctl\n+        ${ctlWhereClause}\n+        ORDER BY consensus_timestamp ${order}\n+      ) AS ctl\n+      ON t.consensus_ns = ctl.consensus_timestamp\n+      ${whereClause}\n+      ORDER BY t.consensus_ns ${order}\n+      ${namedLimitQuery}`;\n+  }\n+\n+  const transactionAccountQuery = namedAccountQuery.replace(/ctl\\.entity_id/g, 't.payer_account_id');\n+  const transactionWhereClause = buildWhereClause(\n+    transactionAccountQuery,\n+    namedTsQuery,\n+    resultTypeQuery,\n+    transactionTypeQuery\n+  );\n+  const ctlJoinClause =\n+    (resultTypeQuery || transactionTypeQuery) && 'JOIN transaction AS t ON ctl.consensus_timestamp = t.consensus_ns';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMjI3OTA4OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/transactions.js", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjozMzowNFrOIF7FFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxODozNjowOVrOIGaDrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4MTc0OQ==", "bodyText": "I'm a little confused on the logic of this part, the way I'm reading this the FULL OUTER JOIN here would allow for cryptotransfers without a transaction row.  If that is a possibility, is it also possible to have a token transfer without a transaction row, etc?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543081749", "createdAt": "2020-12-15T06:33:04Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -195,23 +213,62 @@ const getTransactionsInnerQuery = function (\n   transactionTypeQuery,\n   order\n ) {\n-  const whereClause = buildWhereClause(tsQuery, resultTypeQuery, transactionTypeQuery);\n-  const ctlTsQuery = tsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n-  const ctlWhereClause = buildWhereClause(accountQuery, ctlTsQuery, creditDebitQuery);\n+  const namedAccountQuery = convertToNamedQuery(accountQuery, 'acct');\n+  const namedTsQuery = convertToNamedQuery(tsQuery, 'ts');\n+  const namedLimitQuery = convertToNamedQuery(limitQuery, 'limit');\n+  const ctlTsQuery = namedTsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n+  let ctlWhereClause;\n+\n+  if (creditDebitQuery) {\n+    // limit the query to transactions with crypto transfer list\n+    ctlWhereClause = buildWhereClause(namedAccountQuery, ctlTsQuery, creditDebitQuery);\n+    const whereClause = buildWhereClause(namedTsQuery, resultTypeQuery, transactionTypeQuery);\n+    return `\n+      SELECT t.consensus_ns AS consensus_timestamp\n+      FROM transaction t\n+      JOIN (\n+        SELECT DISTINCT consensus_timestamp\n+        FROM crypto_transfer AS ctl\n+        ${ctlWhereClause}\n+        ORDER BY consensus_timestamp ${order}\n+      ) AS ctl\n+      ON t.consensus_ns = ctl.consensus_timestamp\n+      ${whereClause}\n+      ORDER BY t.consensus_ns ${order}\n+      ${namedLimitQuery}`;\n+  }\n+\n+  const transactionAccountQuery = namedAccountQuery.replace(/ctl\\.entity_id/g, 't.payer_account_id');\n+  const transactionWhereClause = buildWhereClause(\n+    transactionAccountQuery,\n+    namedTsQuery,\n+    resultTypeQuery,\n+    transactionTypeQuery\n+  );\n+  const ctlJoinClause =\n+    (resultTypeQuery || transactionTypeQuery) && 'JOIN transaction AS t ON ctl.consensus_timestamp = t.consensus_ns';\n+  ctlWhereClause = buildWhereClause(namedAccountQuery, ctlTsQuery, resultTypeQuery, transactionTypeQuery);\n \n   return `\n-    SELECT t.consensus_ns AS consensus_timestamp\n-    FROM transaction t\n-    JOIN (\n-            SELECT DISTINCT consensus_timestamp\n-            FROM crypto_transfer AS ctl\n-            ${ctlWhereClause}\n-            ORDER BY consensus_timestamp ${order}\n-         ) AS ctl\n+    SELECT coalesce(t.consensus_ns,ctl.consensus_timestamp) AS consensus_timestamp\n+    FROM (\n+        SELECT consensus_ns\n+        FROM transaction AS t\n+        ${transactionWhereClause}\n+        ORDER BY consensus_ns ${order}\n+        ${namedLimitQuery}\n+    ) AS t\n+    FULL OUTER JOIN (\n+        SELECT DISTINCT ctl.consensus_timestamp AS consensus_timestamp", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ3NDM1OA==", "bodyText": "a crypto transfer always has an associated transaction. previously, the reverse is also true that a transaction always has a crypto transfer list.\nsimilarly, a token transfer must belong to a transaction.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543474358", "createdAt": "2020-12-15T16:03:59Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -195,23 +213,62 @@ const getTransactionsInnerQuery = function (\n   transactionTypeQuery,\n   order\n ) {\n-  const whereClause = buildWhereClause(tsQuery, resultTypeQuery, transactionTypeQuery);\n-  const ctlTsQuery = tsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n-  const ctlWhereClause = buildWhereClause(accountQuery, ctlTsQuery, creditDebitQuery);\n+  const namedAccountQuery = convertToNamedQuery(accountQuery, 'acct');\n+  const namedTsQuery = convertToNamedQuery(tsQuery, 'ts');\n+  const namedLimitQuery = convertToNamedQuery(limitQuery, 'limit');\n+  const ctlTsQuery = namedTsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n+  let ctlWhereClause;\n+\n+  if (creditDebitQuery) {\n+    // limit the query to transactions with crypto transfer list\n+    ctlWhereClause = buildWhereClause(namedAccountQuery, ctlTsQuery, creditDebitQuery);\n+    const whereClause = buildWhereClause(namedTsQuery, resultTypeQuery, transactionTypeQuery);\n+    return `\n+      SELECT t.consensus_ns AS consensus_timestamp\n+      FROM transaction t\n+      JOIN (\n+        SELECT DISTINCT consensus_timestamp\n+        FROM crypto_transfer AS ctl\n+        ${ctlWhereClause}\n+        ORDER BY consensus_timestamp ${order}\n+      ) AS ctl\n+      ON t.consensus_ns = ctl.consensus_timestamp\n+      ${whereClause}\n+      ORDER BY t.consensus_ns ${order}\n+      ${namedLimitQuery}`;\n+  }\n+\n+  const transactionAccountQuery = namedAccountQuery.replace(/ctl\\.entity_id/g, 't.payer_account_id');\n+  const transactionWhereClause = buildWhereClause(\n+    transactionAccountQuery,\n+    namedTsQuery,\n+    resultTypeQuery,\n+    transactionTypeQuery\n+  );\n+  const ctlJoinClause =\n+    (resultTypeQuery || transactionTypeQuery) && 'JOIN transaction AS t ON ctl.consensus_timestamp = t.consensus_ns';\n+  ctlWhereClause = buildWhereClause(namedAccountQuery, ctlTsQuery, resultTypeQuery, transactionTypeQuery);\n \n   return `\n-    SELECT t.consensus_ns AS consensus_timestamp\n-    FROM transaction t\n-    JOIN (\n-            SELECT DISTINCT consensus_timestamp\n-            FROM crypto_transfer AS ctl\n-            ${ctlWhereClause}\n-            ORDER BY consensus_timestamp ${order}\n-         ) AS ctl\n+    SELECT coalesce(t.consensus_ns,ctl.consensus_timestamp) AS consensus_timestamp\n+    FROM (\n+        SELECT consensus_ns\n+        FROM transaction AS t\n+        ${transactionWhereClause}\n+        ORDER BY consensus_ns ${order}\n+        ${namedLimitQuery}\n+    ) AS t\n+    FULL OUTER JOIN (\n+        SELECT DISTINCT ctl.consensus_timestamp AS consensus_timestamp", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4MTc0OQ=="}, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ3OTczOQ==", "bodyText": "That makes sense, but then I'm not understanding why a FULL OUTER JOIN is needed, as opposed to a LEFT OUTER JOIN.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543479739", "createdAt": "2020-12-15T16:10:37Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -195,23 +213,62 @@ const getTransactionsInnerQuery = function (\n   transactionTypeQuery,\n   order\n ) {\n-  const whereClause = buildWhereClause(tsQuery, resultTypeQuery, transactionTypeQuery);\n-  const ctlTsQuery = tsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n-  const ctlWhereClause = buildWhereClause(accountQuery, ctlTsQuery, creditDebitQuery);\n+  const namedAccountQuery = convertToNamedQuery(accountQuery, 'acct');\n+  const namedTsQuery = convertToNamedQuery(tsQuery, 'ts');\n+  const namedLimitQuery = convertToNamedQuery(limitQuery, 'limit');\n+  const ctlTsQuery = namedTsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n+  let ctlWhereClause;\n+\n+  if (creditDebitQuery) {\n+    // limit the query to transactions with crypto transfer list\n+    ctlWhereClause = buildWhereClause(namedAccountQuery, ctlTsQuery, creditDebitQuery);\n+    const whereClause = buildWhereClause(namedTsQuery, resultTypeQuery, transactionTypeQuery);\n+    return `\n+      SELECT t.consensus_ns AS consensus_timestamp\n+      FROM transaction t\n+      JOIN (\n+        SELECT DISTINCT consensus_timestamp\n+        FROM crypto_transfer AS ctl\n+        ${ctlWhereClause}\n+        ORDER BY consensus_timestamp ${order}\n+      ) AS ctl\n+      ON t.consensus_ns = ctl.consensus_timestamp\n+      ${whereClause}\n+      ORDER BY t.consensus_ns ${order}\n+      ${namedLimitQuery}`;\n+  }\n+\n+  const transactionAccountQuery = namedAccountQuery.replace(/ctl\\.entity_id/g, 't.payer_account_id');\n+  const transactionWhereClause = buildWhereClause(\n+    transactionAccountQuery,\n+    namedTsQuery,\n+    resultTypeQuery,\n+    transactionTypeQuery\n+  );\n+  const ctlJoinClause =\n+    (resultTypeQuery || transactionTypeQuery) && 'JOIN transaction AS t ON ctl.consensus_timestamp = t.consensus_ns';\n+  ctlWhereClause = buildWhereClause(namedAccountQuery, ctlTsQuery, resultTypeQuery, transactionTypeQuery);\n \n   return `\n-    SELECT t.consensus_ns AS consensus_timestamp\n-    FROM transaction t\n-    JOIN (\n-            SELECT DISTINCT consensus_timestamp\n-            FROM crypto_transfer AS ctl\n-            ${ctlWhereClause}\n-            ORDER BY consensus_timestamp ${order}\n-         ) AS ctl\n+    SELECT coalesce(t.consensus_ns,ctl.consensus_timestamp) AS consensus_timestamp\n+    FROM (\n+        SELECT consensus_ns\n+        FROM transaction AS t\n+        ${transactionWhereClause}\n+        ORDER BY consensus_ns ${order}\n+        ${namedLimitQuery}\n+    ) AS t\n+    FULL OUTER JOIN (\n+        SELECT DISTINCT ctl.consensus_timestamp AS consensus_timestamp", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4MTc0OQ=="}, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ4ODAwMQ==", "bodyText": "oh, it's partially because I made it generic for all REST query params.\nTo be concise, it's because of the account.id filter. with the change, it can be either transaction.payer_account_id or crypto_transfer.entity_id. It's possible that for account.id A, the transactions of which A paid fee for and the transactions with A in the crypto transfer have entries not in the other. So we need a full outer join.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543488001", "createdAt": "2020-12-15T16:20:55Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -195,23 +213,62 @@ const getTransactionsInnerQuery = function (\n   transactionTypeQuery,\n   order\n ) {\n-  const whereClause = buildWhereClause(tsQuery, resultTypeQuery, transactionTypeQuery);\n-  const ctlTsQuery = tsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n-  const ctlWhereClause = buildWhereClause(accountQuery, ctlTsQuery, creditDebitQuery);\n+  const namedAccountQuery = convertToNamedQuery(accountQuery, 'acct');\n+  const namedTsQuery = convertToNamedQuery(tsQuery, 'ts');\n+  const namedLimitQuery = convertToNamedQuery(limitQuery, 'limit');\n+  const ctlTsQuery = namedTsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n+  let ctlWhereClause;\n+\n+  if (creditDebitQuery) {\n+    // limit the query to transactions with crypto transfer list\n+    ctlWhereClause = buildWhereClause(namedAccountQuery, ctlTsQuery, creditDebitQuery);\n+    const whereClause = buildWhereClause(namedTsQuery, resultTypeQuery, transactionTypeQuery);\n+    return `\n+      SELECT t.consensus_ns AS consensus_timestamp\n+      FROM transaction t\n+      JOIN (\n+        SELECT DISTINCT consensus_timestamp\n+        FROM crypto_transfer AS ctl\n+        ${ctlWhereClause}\n+        ORDER BY consensus_timestamp ${order}\n+      ) AS ctl\n+      ON t.consensus_ns = ctl.consensus_timestamp\n+      ${whereClause}\n+      ORDER BY t.consensus_ns ${order}\n+      ${namedLimitQuery}`;\n+  }\n+\n+  const transactionAccountQuery = namedAccountQuery.replace(/ctl\\.entity_id/g, 't.payer_account_id');\n+  const transactionWhereClause = buildWhereClause(\n+    transactionAccountQuery,\n+    namedTsQuery,\n+    resultTypeQuery,\n+    transactionTypeQuery\n+  );\n+  const ctlJoinClause =\n+    (resultTypeQuery || transactionTypeQuery) && 'JOIN transaction AS t ON ctl.consensus_timestamp = t.consensus_ns';\n+  ctlWhereClause = buildWhereClause(namedAccountQuery, ctlTsQuery, resultTypeQuery, transactionTypeQuery);\n \n   return `\n-    SELECT t.consensus_ns AS consensus_timestamp\n-    FROM transaction t\n-    JOIN (\n-            SELECT DISTINCT consensus_timestamp\n-            FROM crypto_transfer AS ctl\n-            ${ctlWhereClause}\n-            ORDER BY consensus_timestamp ${order}\n-         ) AS ctl\n+    SELECT coalesce(t.consensus_ns,ctl.consensus_timestamp) AS consensus_timestamp\n+    FROM (\n+        SELECT consensus_ns\n+        FROM transaction AS t\n+        ${transactionWhereClause}\n+        ORDER BY consensus_ns ${order}\n+        ${namedLimitQuery}\n+    ) AS t\n+    FULL OUTER JOIN (\n+        SELECT DISTINCT ctl.consensus_timestamp AS consensus_timestamp", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4MTc0OQ=="}, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ5MzUxNQ==", "bodyText": "Ah, got it.  Interesting that that one param causes so much havoc, that makes sense though.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543493515", "createdAt": "2020-12-15T16:27:36Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -195,23 +213,62 @@ const getTransactionsInnerQuery = function (\n   transactionTypeQuery,\n   order\n ) {\n-  const whereClause = buildWhereClause(tsQuery, resultTypeQuery, transactionTypeQuery);\n-  const ctlTsQuery = tsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n-  const ctlWhereClause = buildWhereClause(accountQuery, ctlTsQuery, creditDebitQuery);\n+  const namedAccountQuery = convertToNamedQuery(accountQuery, 'acct');\n+  const namedTsQuery = convertToNamedQuery(tsQuery, 'ts');\n+  const namedLimitQuery = convertToNamedQuery(limitQuery, 'limit');\n+  const ctlTsQuery = namedTsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n+  let ctlWhereClause;\n+\n+  if (creditDebitQuery) {\n+    // limit the query to transactions with crypto transfer list\n+    ctlWhereClause = buildWhereClause(namedAccountQuery, ctlTsQuery, creditDebitQuery);\n+    const whereClause = buildWhereClause(namedTsQuery, resultTypeQuery, transactionTypeQuery);\n+    return `\n+      SELECT t.consensus_ns AS consensus_timestamp\n+      FROM transaction t\n+      JOIN (\n+        SELECT DISTINCT consensus_timestamp\n+        FROM crypto_transfer AS ctl\n+        ${ctlWhereClause}\n+        ORDER BY consensus_timestamp ${order}\n+      ) AS ctl\n+      ON t.consensus_ns = ctl.consensus_timestamp\n+      ${whereClause}\n+      ORDER BY t.consensus_ns ${order}\n+      ${namedLimitQuery}`;\n+  }\n+\n+  const transactionAccountQuery = namedAccountQuery.replace(/ctl\\.entity_id/g, 't.payer_account_id');\n+  const transactionWhereClause = buildWhereClause(\n+    transactionAccountQuery,\n+    namedTsQuery,\n+    resultTypeQuery,\n+    transactionTypeQuery\n+  );\n+  const ctlJoinClause =\n+    (resultTypeQuery || transactionTypeQuery) && 'JOIN transaction AS t ON ctl.consensus_timestamp = t.consensus_ns';\n+  ctlWhereClause = buildWhereClause(namedAccountQuery, ctlTsQuery, resultTypeQuery, transactionTypeQuery);\n \n   return `\n-    SELECT t.consensus_ns AS consensus_timestamp\n-    FROM transaction t\n-    JOIN (\n-            SELECT DISTINCT consensus_timestamp\n-            FROM crypto_transfer AS ctl\n-            ${ctlWhereClause}\n-            ORDER BY consensus_timestamp ${order}\n-         ) AS ctl\n+    SELECT coalesce(t.consensus_ns,ctl.consensus_timestamp) AS consensus_timestamp\n+    FROM (\n+        SELECT consensus_ns\n+        FROM transaction AS t\n+        ${transactionWhereClause}\n+        ORDER BY consensus_ns ${order}\n+        ${namedLimitQuery}\n+    ) AS t\n+    FULL OUTER JOIN (\n+        SELECT DISTINCT ctl.consensus_timestamp AS consensus_timestamp", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4MTc0OQ=="}, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU4OTI5Mw==", "bodyText": "made some changes to the query to split the generic query into two cases, with and without account query. also added comments based on your feedback", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543589293", "createdAt": "2020-12-15T18:36:09Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -195,23 +213,62 @@ const getTransactionsInnerQuery = function (\n   transactionTypeQuery,\n   order\n ) {\n-  const whereClause = buildWhereClause(tsQuery, resultTypeQuery, transactionTypeQuery);\n-  const ctlTsQuery = tsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n-  const ctlWhereClause = buildWhereClause(accountQuery, ctlTsQuery, creditDebitQuery);\n+  const namedAccountQuery = convertToNamedQuery(accountQuery, 'acct');\n+  const namedTsQuery = convertToNamedQuery(tsQuery, 'ts');\n+  const namedLimitQuery = convertToNamedQuery(limitQuery, 'limit');\n+  const ctlTsQuery = namedTsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n+  let ctlWhereClause;\n+\n+  if (creditDebitQuery) {\n+    // limit the query to transactions with crypto transfer list\n+    ctlWhereClause = buildWhereClause(namedAccountQuery, ctlTsQuery, creditDebitQuery);\n+    const whereClause = buildWhereClause(namedTsQuery, resultTypeQuery, transactionTypeQuery);\n+    return `\n+      SELECT t.consensus_ns AS consensus_timestamp\n+      FROM transaction t\n+      JOIN (\n+        SELECT DISTINCT consensus_timestamp\n+        FROM crypto_transfer AS ctl\n+        ${ctlWhereClause}\n+        ORDER BY consensus_timestamp ${order}\n+      ) AS ctl\n+      ON t.consensus_ns = ctl.consensus_timestamp\n+      ${whereClause}\n+      ORDER BY t.consensus_ns ${order}\n+      ${namedLimitQuery}`;\n+  }\n+\n+  const transactionAccountQuery = namedAccountQuery.replace(/ctl\\.entity_id/g, 't.payer_account_id');\n+  const transactionWhereClause = buildWhereClause(\n+    transactionAccountQuery,\n+    namedTsQuery,\n+    resultTypeQuery,\n+    transactionTypeQuery\n+  );\n+  const ctlJoinClause =\n+    (resultTypeQuery || transactionTypeQuery) && 'JOIN transaction AS t ON ctl.consensus_timestamp = t.consensus_ns';\n+  ctlWhereClause = buildWhereClause(namedAccountQuery, ctlTsQuery, resultTypeQuery, transactionTypeQuery);\n \n   return `\n-    SELECT t.consensus_ns AS consensus_timestamp\n-    FROM transaction t\n-    JOIN (\n-            SELECT DISTINCT consensus_timestamp\n-            FROM crypto_transfer AS ctl\n-            ${ctlWhereClause}\n-            ORDER BY consensus_timestamp ${order}\n-         ) AS ctl\n+    SELECT coalesce(t.consensus_ns,ctl.consensus_timestamp) AS consensus_timestamp\n+    FROM (\n+        SELECT consensus_ns\n+        FROM transaction AS t\n+        ${transactionWhereClause}\n+        ORDER BY consensus_ns ${order}\n+        ${namedLimitQuery}\n+    ) AS t\n+    FULL OUTER JOIN (\n+        SELECT DISTINCT ctl.consensus_timestamp AS consensus_timestamp", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4MTc0OQ=="}, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 110}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMjMwNTMxOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/utils.js", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjo0MjowM1rOIF7TQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjowNDo1MVrOIGTF2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4NTM3Nw==", "bodyText": "What is the gain to this change, or is it just a style preference?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543085377", "createdAt": "2020-12-15T06:42:03Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -255,14 +254,14 @@ const parseOperatorAndValueFromQueryParam = (paramValue) => {\n   if (splitItem.length === 1) {\n     // No operator specified. Just use \"eq:\"\n     return {op: opsMap.eq, value: splitItem[0]};\n-  } else if (splitItem.length === 2) {\n+  }\n+  if (splitItem.length === 2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ3NTE2Mg==", "bodyText": "this is auto adjusted by IDEA eslint plugin based on some rule.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543475162", "createdAt": "2020-12-15T16:04:51Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -255,14 +254,14 @@ const parseOperatorAndValueFromQueryParam = (paramValue) => {\n   if (splitItem.length === 1) {\n     // No operator specified. Just use \"eq:\"\n     return {op: opsMap.eq, value: splitItem[0]};\n-  } else if (splitItem.length === 2) {\n+  }\n+  if (splitItem.length === 2) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4NTM3Nw=="}, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMjMwNzQ2OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/utils.js", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjo0Mjo0MVrOIF7UWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjowNTowM1rOIGTGbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4NTY1Ng==", "bodyText": "Same here, is this style or for a particular benefit?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543085656", "createdAt": "2020-12-15T06:42:41Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -355,7 +354,8 @@ const parseCreditDebitParams = (parsedQueryParams, columnName) => {\n   return parseParams(parsedQueryParams[constants.filterKeys.CREDIT_TYPE], (op, value) => {\n     if (value === 'credit') {\n       return [`${columnName} > 0`, []];\n-    } else if (value === 'debit') {\n+    }\n+    if (value === 'debit') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ3NTMxMQ==", "bodyText": "this is auto adjusted by IDEA eslint plugin based on some rule.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543475311", "createdAt": "2020-12-15T16:05:03Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -355,7 +354,8 @@ const parseCreditDebitParams = (parsedQueryParams, columnName) => {\n   return parseParams(parsedQueryParams[constants.filterKeys.CREDIT_TYPE], (op, value) => {\n     if (value === 'credit') {\n       return [`${columnName} > 0`, []];\n-    } else if (value === 'debit') {\n+    }\n+    if (value === 'debit') {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4NTY1Ng=="}, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMjM0ODM5OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/balances.js", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjo1NToxOFrOIF7qXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjoxMjoyOFrOIGTdqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5MTI5Mw==", "bodyText": "There are two other places in this file that need to be updated as well.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543091293", "createdAt": "2020-12-15T06:55:18Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/balances.js", "diffHunk": "@@ -91,7 +91,7 @@ const getBalances = async (req, res) => {\n       ${query}`;\n \n   const sqlParams = tsParams.concat(accountParams).concat(pubKeyParams).concat(balanceParams).concat(params);\n-  const pgSqlQuery = utils.convertMySqlStyleQueryToPostgres(sqlQuery, sqlParams);\n+  const pgSqlQuery = utils.convertMySqlStyleQueryToPostgres(sqlQuery);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ4MTI1Nw==", "bodyText": "good catch", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543481257", "createdAt": "2020-12-15T16:12:28Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/balances.js", "diffHunk": "@@ -91,7 +91,7 @@ const getBalances = async (req, res) => {\n       ${query}`;\n \n   const sqlParams = tsParams.concat(accountParams).concat(pubKeyParams).concat(balanceParams).concat(params);\n-  const pgSqlQuery = utils.convertMySqlStyleQueryToPostgres(sqlQuery, sqlParams);\n+  const pgSqlQuery = utils.convertMySqlStyleQueryToPostgres(sqlQuery);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5MTI5Mw=="}, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxNTcyNzYzOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/__tests__/specs/transactions-19-timestamp-no-transfers.spec.json", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxODo0Njo1OFrOIGaiEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxODo0Njo1OFrOIGaiEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU5NzA3NA==", "bodyText": "Update description", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543597074", "createdAt": "2020-12-15T18:46:58Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-rest/__tests__/specs/transactions-19-timestamp-no-transfers.spec.json", "diffHunk": "@@ -0,0 +1,74 @@\n+{\n+  \"description\": \"Transaction api calls for transactions at timestamp\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5819eec25edad0fcf85a59c52afea25db0a78cc6"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxNjU4MzAxOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/transactions.js", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMjoxMTowMFrOIGiRNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMzo1NjowMVrOIGlVSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcyMzgzMQ==", "bodyText": "I get the logic but this section is a little hard to follow and I worry that its complexity might contribute to challenges in managing it.\nDo you think there's a way to simplify or split it up into clearer functions.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543723831", "createdAt": "2020-12-15T22:11:00Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -195,23 +213,72 @@ const getTransactionsInnerQuery = function (\n   transactionTypeQuery,\n   order\n ) {\n-  const whereClause = buildWhereClause(tsQuery, resultTypeQuery, transactionTypeQuery);\n-  const ctlTsQuery = tsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n-  const ctlWhereClause = buildWhereClause(accountQuery, ctlTsQuery, creditDebitQuery);\n+  // convert the mysql style '?' placeholder to the named parameter format, later the same named parameter is converted\n+  // to the same positional index, thus the caller only has to pass the value once for the same column\n+  const namedAccountQuery = convertToNamedQuery(accountQuery, 'acct');\n+  const namedTsQuery = convertToNamedQuery(tsQuery, 'ts');\n+  const namedLimitQuery = convertToNamedQuery(limitQuery, 'limit');\n \n-  return `\n-    SELECT t.consensus_ns AS consensus_timestamp\n-    FROM transaction t\n-    JOIN (\n-            SELECT DISTINCT consensus_timestamp\n-            FROM crypto_transfer AS ctl\n-            ${ctlWhereClause}\n-            ORDER BY consensus_timestamp ${order}\n-         ) AS ctl\n-    ON t.consensus_ns = ctl.consensus_timestamp\n-    ${whereClause}\n-    ORDER BY t.consensus_ns ${order}\n-    ${limitQuery}`;\n+  const ctlTsQuery = namedTsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n+  let ctlWhereClause;\n+\n+  if (creditDebitQuery) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5819eec25edad0fcf85a59c52afea25db0a78cc6"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc3NDAyNg==", "bodyText": "made an attempt, let me know if it's more maintainable", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543774026", "createdAt": "2020-12-15T23:56:01Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -195,23 +213,72 @@ const getTransactionsInnerQuery = function (\n   transactionTypeQuery,\n   order\n ) {\n-  const whereClause = buildWhereClause(tsQuery, resultTypeQuery, transactionTypeQuery);\n-  const ctlTsQuery = tsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n-  const ctlWhereClause = buildWhereClause(accountQuery, ctlTsQuery, creditDebitQuery);\n+  // convert the mysql style '?' placeholder to the named parameter format, later the same named parameter is converted\n+  // to the same positional index, thus the caller only has to pass the value once for the same column\n+  const namedAccountQuery = convertToNamedQuery(accountQuery, 'acct');\n+  const namedTsQuery = convertToNamedQuery(tsQuery, 'ts');\n+  const namedLimitQuery = convertToNamedQuery(limitQuery, 'limit');\n \n-  return `\n-    SELECT t.consensus_ns AS consensus_timestamp\n-    FROM transaction t\n-    JOIN (\n-            SELECT DISTINCT consensus_timestamp\n-            FROM crypto_transfer AS ctl\n-            ${ctlWhereClause}\n-            ORDER BY consensus_timestamp ${order}\n-         ) AS ctl\n-    ON t.consensus_ns = ctl.consensus_timestamp\n-    ${whereClause}\n-    ORDER BY t.consensus_ns ${order}\n-    ${limitQuery}`;\n+  const ctlTsQuery = namedTsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n+  let ctlWhereClause;\n+\n+  if (creditDebitQuery) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcyMzgzMQ=="}, "originalCommit": {"oid": "5819eec25edad0fcf85a59c52afea25db0a78cc6"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyMTY3MjM0OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/__tests__/specs/accounts-10-account-transactions.spec.json", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNzo0MToyOFrOIHRV5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNzo0MToyOFrOIHRV5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5NTA3Nw==", "bodyText": "Can you add another spec for account transaction with no transfers to make sure that's picked up.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r544495077", "createdAt": "2020-12-16T17:41:28Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-rest/__tests__/specs/accounts-10-account-transactions.spec.json", "diffHunk": "@@ -83,6 +92,20 @@\n   \"responseStatus\": 200,\n   \"responseJson\": {\n     \"transactions\": [\n+      {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf2602b3ad55b54a6323a97eabddd7bf3431f2b4"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1335, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}