{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4OTA3NjA2", "number": 966, "title": "Import latest property", "bodyText": "Detailed description:\n\nAdd startDate, the date the downloader starts pulling data from (inclusive), default is now if not set\nAdd endDate, the end date the downloader stops pulling data at(inclusive) and the parser stops parsing data records at\nReplace findify s3mock with S3Proxy. The latter supports list-objects with marker\n\nWhich issue(s) this PR fixes:\nFixes #801\nSpecial notes for your reviewer:\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-08-17T15:35:22Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966", "merged": true, "mergeCommit": {"oid": "6f0719e98140aeeb313b8d1c5fce7c0910ec4ca7"}, "closed": true, "closedAt": "2020-08-26T20:30:12Z", "author": {"login": "xin-hedera"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-mPFFgH2gAyNDY4OTA3NjA2OjBhZTcxNjI2ODM3ODhiZjNkODFiNzJkZjYxMTExYTY1NDdiNWU1YzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCxr4rAFqTQ3NTgyNzY4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0ae7162683788bf3d81b72df61111a6547b5e5c2", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0ae7162683788bf3d81b72df61111a6547b5e5c2", "committedDate": "2020-08-13T20:42:15Z", "message": "add support of startDate and endDate to limit the amount of data to import\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcc61717207e1608dcd309c2d3f8bbdc17b86ab3", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/dcc61717207e1608dcd309c2d3f8bbdc17b86ab3", "committedDate": "2020-08-13T20:42:56Z", "message": "Merge branch 'master' into import-latest-property"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NjE0MzQ3", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#pullrequestreview-468614347", "createdAt": "2020-08-17T16:26:10Z", "commit": {"oid": "e81c6061668b2727fa2b561c382cf717d0a703e0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNjoyNjoxMFrOHBv4WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNjo1NTo1NVrOHBw6jA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU5NTA5Ng==", "bodyText": "nit: to be consistent with above method\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String getStreamFilenameForInstant(StreamType streamType, Instant instant) {\n          \n          \n            \n                public static final String getStreamFilenameFromInstant(StreamType streamType, Instant instant) {", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r471595096", "createdAt": "2020-08-17T16:26:10Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/util/Utility.java", "diffHunk": "@@ -416,10 +416,19 @@ public static final long getTimestampFromFilename(String filename) {\n         }\n \n         date = date.replace('_', ':');\n-        Instant instant = Instant.parse(date);\n+        return Instant.parse(date);\n+    }\n+\n+    public static final long getTimestampFromFilename(String filename) {\n+        Instant instant = getInstantFromFilename(filename);\n         return Utility.convertToNanosMax(instant.getEpochSecond(), instant.getNano());\n     }\n \n+    public static final String getStreamFilenameForInstant(StreamType streamType, Instant instant) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e81c6061668b2727fa2b561c382cf717d0a703e0"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU5Nzk4Mg==", "bodyText": "nit: This method will call StringUtils.isBlank(lastValidFilename) at least once so you might as well pull it out before the first if after the lastValidFileName retrieval and share it\nboolean isLastValidFileNameBlank = StringUtils.isBlank(lastValidFilename);", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r471597982", "createdAt": "2020-08-17T16:31:19Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -420,6 +433,60 @@ private File downloadSignedDataFile(File sigFile, String nodeAccountId) {\n         return null;\n     }\n \n+    /**\n+     * Sets the start date of the data based on property startDate and current application status if it's not\n+     * updated yet.\n+     * <ul>\n+     *  <li>If the property startDate is set and application status is empty or less than startDate, set application\n+     *  status and verifyHashAfter to startDate.</li>\n+     *  <li>If the property startDate is not set and application status is empty, set application status and\n+     *  verifyHashAfter to now.</li>\n+     *  </ul>\n+     */\n+    private void updateDataStartDate() {\n+        if (dataStartDateUpdated) {\n+            return;\n+        }\n+\n+        boolean shouldUpdate = false;\n+        Instant startDate = mirrorProperties.getStartDate();\n+        String lastValidFilename = applicationStatusRepository.findByStatusCode(getLastValidDownloadedFileKey());\n+        if (startDate != null) {\n+            Instant lastValidFileInstant = Utility.getInstantFromFilename(lastValidFilename);\n+            if (StringUtils.isBlank(lastValidFilename) || lastValidFileInstant.isBefore(startDate)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e81c6061668b2727fa2b561c382cf717d0a703e0"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwMjU0Mw==", "bodyText": "Q: Are we sure we want to set the start if the lastValidFileInstant.isBefore(startDate)?\nWon't this result in the breaking of the hash chain for record file meaning missing transactions in the mirror node.\nIs this a flow we want to support just yet, as there could be unknown implications?\nI thought we'd only want to support, 1) Start from EPOCH 2) Start from some point in the past 3) Start now\nIn all cases don't we want the mirror node to flow sequentially with no time jumps?\nThis scenario is a subset of having a start and end date. Once you're done you could set another star toad end date in the future. I just want to make sure this is an intentional option we're opening up", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r471602543", "createdAt": "2020-08-17T16:39:20Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -420,6 +433,60 @@ private File downloadSignedDataFile(File sigFile, String nodeAccountId) {\n         return null;\n     }\n \n+    /**\n+     * Sets the start date of the data based on property startDate and current application status if it's not\n+     * updated yet.\n+     * <ul>\n+     *  <li>If the property startDate is set and application status is empty or less than startDate, set application\n+     *  status and verifyHashAfter to startDate.</li>\n+     *  <li>If the property startDate is not set and application status is empty, set application status and\n+     *  verifyHashAfter to now.</li>\n+     *  </ul>\n+     */\n+    private void updateDataStartDate() {\n+        if (dataStartDateUpdated) {\n+            return;\n+        }\n+\n+        boolean shouldUpdate = false;\n+        Instant startDate = mirrorProperties.getStartDate();\n+        String lastValidFilename = applicationStatusRepository.findByStatusCode(getLastValidDownloadedFileKey());\n+        if (startDate != null) {\n+            Instant lastValidFileInstant = Utility.getInstantFromFilename(lastValidFilename);\n+            if (StringUtils.isBlank(lastValidFilename) || lastValidFileInstant.isBefore(startDate)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e81c6061668b2727fa2b561c382cf717d0a703e0"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYxMjA0NA==", "bodyText": "Probably want to add a case for when the user sets endDate < startDate accidentally.\nAlso add a unit test that makes sure the expected behavior is carried out.\nPreferably we'd make this a constraint so that it fails at startUp.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r471612044", "createdAt": "2020-08-17T16:55:55Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -420,6 +433,60 @@ private File downloadSignedDataFile(File sigFile, String nodeAccountId) {\n         return null;\n     }\n \n+    /**\n+     * Sets the start date of the data based on property startDate and current application status if it's not\n+     * updated yet.\n+     * <ul>\n+     *  <li>If the property startDate is set and application status is empty or less than startDate, set application\n+     *  status and verifyHashAfter to startDate.</li>\n+     *  <li>If the property startDate is not set and application status is empty, set application status and\n+     *  verifyHashAfter to now.</li>\n+     *  </ul>\n+     */\n+    private void updateDataStartDate() {\n+        if (dataStartDateUpdated) {\n+            return;\n+        }\n+\n+        boolean shouldUpdate = false;\n+        Instant startDate = mirrorProperties.getStartDate();\n+        String lastValidFilename = applicationStatusRepository.findByStatusCode(getLastValidDownloadedFileKey());\n+        if (startDate != null) {\n+            Instant lastValidFileInstant = Utility.getInstantFromFilename(lastValidFilename);\n+            if (StringUtils.isBlank(lastValidFilename) || lastValidFileInstant.isBefore(startDate)) {\n+                shouldUpdate = true;\n+            }\n+        } else if (StringUtils.isBlank(lastValidFilename)) {\n+            startDate = MirrorProperties.getStartDateNow();\n+            shouldUpdate = true;\n+        }\n+\n+        if (shouldUpdate) {\n+            StreamType streamType = downloaderProperties.getStreamType();\n+            applicationStatusRepository.updateStatusValue(getLastValidDownloadedFileKey(),\n+                    Utility.getStreamFilenameForInstant(streamType, startDate));\n+            mirrorProperties.setVerifyHashAfter(startDate);\n+            log.info(\"Set downloader to start polling from {} for {}\", startDate, streamType.getPath());\n+        }\n+\n+        dataStartDateUpdated = true;\n+    }\n+\n+    private boolean isEndDateReached() {\n+        Instant endDate = mirrorProperties.getEndDate();\n+        if (endDate != null) {\n+            try {\n+                String filename = applicationStatusRepository.findByStatusCode(getLastValidDownloadedFileKey());\n+                if (!StringUtils.isBlank(filename)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e81c6061668b2727fa2b561c382cf717d0a703e0"}, "originalPosition": 111}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4ODQzNjM4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#pullrequestreview-468843638", "createdAt": "2020-08-17T21:25:30Z", "commit": {"oid": "e81c6061668b2727fa2b561c382cf717d0a703e0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QyMToyNTozMVrOHB7Zdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNzowMTozNlrOHCdupA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc4Mzc5OQ==", "bodyText": "Instead of no file is downloaded, would prefer the database is empty. With read only mirror nodes coming up, we may or may not be downloading. Should mention format like verifyHashAfter.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r471783799", "createdAt": "2020-08-17T21:25:31Z", "author": {"login": "steven-sheehy"}, "path": "docs/configuration.md", "diffHunk": "@@ -82,6 +83,7 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.importer.parser.record.pubsub.maxSendAttempts`               | 5                       | Number of attempts when sending messages to PubSub (only for retryable errors)                 |\n | `hedera.mirror.importer.topicRunningHashV2AddedTimestamp`            | Network-based  | Unix timestamp (in nanos) of first topic message with v2 as running hash version. Use this config to override the default network based value |\n | `hedera.mirror.importer.shard`                                       | 0                       | The default shard number that the component participates in                                    |\n+| `hedera.mirror.importer.startDate`                                   |                         | The start date (inclusive) of the data to import. It takes effect 1) if it's set and the date is after the last downloaded file or no file is downloaded; 2) if it's not set and no file is downloaded, it defaults to now |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e81c6061668b2727fa2b561c382cf717d0a703e0"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc4NzcwMA==", "bodyText": "Description should be clearer. Should mention inclusive or exclusive. Should mention transactions after this date will be ignored. Should mention format like verifyHashAfter.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r471787700", "createdAt": "2020-08-17T21:34:25Z", "author": {"login": "steven-sheehy"}, "path": "docs/configuration.md", "diffHunk": "@@ -53,6 +53,7 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.importer.downloader.record.threads`                   | 13                      | The number of threads to search for new files to download                                      |\n | `hedera.mirror.importer.downloader.region`                           | us-east-1               | The region associated with the bucket                                                          |\n | `hedera.mirror.importer.downloader.secretKey`                        | \"\"                      | The cloud storage secret key                                                                   |\n+| `hedera.mirror.importer.endDate`                                     |                         | The end date of the data to import                                                             |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e81c6061668b2727fa2b561c382cf717d0a703e0"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgwMzY4Mw==", "bodyText": "This isn't quite the right spot for this logic. verifySigsAndDownloadDataFiles can potentially verify multiple stream files and this just checks if the last one is past. That means files with timestamps after the end date can sneak through.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r471803683", "createdAt": "2020-08-17T22:13:14Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -144,6 +151,12 @@ protected void downloadNextBatch() {\n             log.warn(e.getMessage());\n         } catch (Exception e) {\n             log.error(\"Error downloading files\", e);\n+        } finally {\n+            if (isEndDateReached()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e81c6061668b2727fa2b561c382cf717d0a703e0"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgwNzYyOQ==", "bodyText": "This only gives us resolution at the file level. We should probably have a transaction level check in the parser as well so we don't import transactions in the last file we accept that are past the end date.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r471807629", "createdAt": "2020-08-17T22:24:09Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -420,6 +433,60 @@ private File downloadSignedDataFile(File sigFile, String nodeAccountId) {\n         return null;\n     }\n \n+    /**\n+     * Sets the start date of the data based on property startDate and current application status if it's not\n+     * updated yet.\n+     * <ul>\n+     *  <li>If the property startDate is set and application status is empty or less than startDate, set application\n+     *  status and verifyHashAfter to startDate.</li>\n+     *  <li>If the property startDate is not set and application status is empty, set application status and\n+     *  verifyHashAfter to now.</li>\n+     *  </ul>\n+     */\n+    private void updateDataStartDate() {\n+        if (dataStartDateUpdated) {\n+            return;\n+        }\n+\n+        boolean shouldUpdate = false;\n+        Instant startDate = mirrorProperties.getStartDate();\n+        String lastValidFilename = applicationStatusRepository.findByStatusCode(getLastValidDownloadedFileKey());\n+        if (startDate != null) {\n+            Instant lastValidFileInstant = Utility.getInstantFromFilename(lastValidFilename);\n+            if (StringUtils.isBlank(lastValidFilename) || lastValidFileInstant.isBefore(startDate)) {\n+                shouldUpdate = true;\n+            }\n+        } else if (StringUtils.isBlank(lastValidFilename)) {\n+            startDate = MirrorProperties.getStartDateNow();\n+            shouldUpdate = true;\n+        }\n+\n+        if (shouldUpdate) {\n+            StreamType streamType = downloaderProperties.getStreamType();\n+            applicationStatusRepository.updateStatusValue(getLastValidDownloadedFileKey(),\n+                    Utility.getStreamFilenameForInstant(streamType, startDate));\n+            mirrorProperties.setVerifyHashAfter(startDate);\n+            log.info(\"Set downloader to start polling from {} for {}\", startDate, streamType.getPath());\n+        }\n+\n+        dataStartDateUpdated = true;\n+    }\n+\n+    private boolean isEndDateReached() {\n+        Instant endDate = mirrorProperties.getEndDate();\n+        if (endDate != null) {\n+            try {\n+                String filename = applicationStatusRepository.findByStatusCode(getLastValidDownloadedFileKey());\n+                if (!StringUtils.isBlank(filename)) {\n+                    return !Utility.getInstantFromFilename(filename).isBefore(endDate);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e81c6061668b2727fa2b561c382cf717d0a703e0"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI3NDg3OQ==", "bodyText": "At minimum, can just do the simpler check without db calls:\nif (endDate != null && startDate != null) {\n  return startDate.compareTo(endDate) <= 0;\n}\nOr you can just do the validation here as this only runs once.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r472274879", "createdAt": "2020-08-18T15:14:54Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -420,6 +433,60 @@ private File downloadSignedDataFile(File sigFile, String nodeAccountId) {\n         return null;\n     }\n \n+    /**\n+     * Sets the start date of the data based on property startDate and current application status if it's not\n+     * updated yet.\n+     * <ul>\n+     *  <li>If the property startDate is set and application status is empty or less than startDate, set application\n+     *  status and verifyHashAfter to startDate.</li>\n+     *  <li>If the property startDate is not set and application status is empty, set application status and\n+     *  verifyHashAfter to now.</li>\n+     *  </ul>\n+     */\n+    private void updateDataStartDate() {\n+        if (dataStartDateUpdated) {\n+            return;\n+        }\n+\n+        boolean shouldUpdate = false;\n+        Instant startDate = mirrorProperties.getStartDate();\n+        String lastValidFilename = applicationStatusRepository.findByStatusCode(getLastValidDownloadedFileKey());\n+        if (startDate != null) {\n+            Instant lastValidFileInstant = Utility.getInstantFromFilename(lastValidFilename);\n+            if (StringUtils.isBlank(lastValidFilename) || lastValidFileInstant.isBefore(startDate)) {\n+                shouldUpdate = true;\n+            }\n+        } else if (StringUtils.isBlank(lastValidFilename)) {\n+            startDate = MirrorProperties.getStartDateNow();\n+            shouldUpdate = true;\n+        }\n+\n+        if (shouldUpdate) {\n+            StreamType streamType = downloaderProperties.getStreamType();\n+            applicationStatusRepository.updateStatusValue(getLastValidDownloadedFileKey(),\n+                    Utility.getStreamFilenameForInstant(streamType, startDate));\n+            mirrorProperties.setVerifyHashAfter(startDate);\n+            log.info(\"Set downloader to start polling from {} for {}\", startDate, streamType.getPath());\n+        }\n+\n+        dataStartDateUpdated = true;\n+    }\n+\n+    private boolean isEndDateReached() {\n+        Instant endDate = mirrorProperties.getEndDate();\n+        if (endDate != null) {\n+            try {\n+                String filename = applicationStatusRepository.findByStatusCode(getLastValidDownloadedFileKey());\n+                if (!StringUtils.isBlank(filename)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYxMjA0NA=="}, "originalCommit": {"oid": "e81c6061668b2727fa2b561c382cf717d0a703e0"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI4NzExNA==", "bodyText": "This method would be more appropriate and encapsulated in MirrorProperties. Would recommend using a framework to ensure only invoked once on startup instead of dataStartDateUpdated.\nclass MirrorProperties {\n  @Async\n  @EventListener(ApplicationReadyEvent.class)\n  public void init() {}", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r472287114", "createdAt": "2020-08-18T15:31:24Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -420,6 +433,60 @@ private File downloadSignedDataFile(File sigFile, String nodeAccountId) {\n         return null;\n     }\n \n+    /**\n+     * Sets the start date of the data based on property startDate and current application status if it's not\n+     * updated yet.\n+     * <ul>\n+     *  <li>If the property startDate is set and application status is empty or less than startDate, set application\n+     *  status and verifyHashAfter to startDate.</li>\n+     *  <li>If the property startDate is not set and application status is empty, set application status and\n+     *  verifyHashAfter to now.</li>\n+     *  </ul>\n+     */\n+    private void updateDataStartDate() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e81c6061668b2727fa2b561c382cf717d0a703e0"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI5NTIyMw==", "bodyText": "nit: Can just log StreamType itself instead of getPath() here and in other places. Path is used for the filesystem path and the enum name would be more appropriate.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r472295223", "createdAt": "2020-08-18T15:42:55Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -420,6 +433,60 @@ private File downloadSignedDataFile(File sigFile, String nodeAccountId) {\n         return null;\n     }\n \n+    /**\n+     * Sets the start date of the data based on property startDate and current application status if it's not\n+     * updated yet.\n+     * <ul>\n+     *  <li>If the property startDate is set and application status is empty or less than startDate, set application\n+     *  status and verifyHashAfter to startDate.</li>\n+     *  <li>If the property startDate is not set and application status is empty, set application status and\n+     *  verifyHashAfter to now.</li>\n+     *  </ul>\n+     */\n+    private void updateDataStartDate() {\n+        if (dataStartDateUpdated) {\n+            return;\n+        }\n+\n+        boolean shouldUpdate = false;\n+        Instant startDate = mirrorProperties.getStartDate();\n+        String lastValidFilename = applicationStatusRepository.findByStatusCode(getLastValidDownloadedFileKey());\n+        if (startDate != null) {\n+            Instant lastValidFileInstant = Utility.getInstantFromFilename(lastValidFilename);\n+            if (StringUtils.isBlank(lastValidFilename) || lastValidFileInstant.isBefore(startDate)) {\n+                shouldUpdate = true;\n+            }\n+        } else if (StringUtils.isBlank(lastValidFilename)) {\n+            startDate = MirrorProperties.getStartDateNow();\n+            shouldUpdate = true;\n+        }\n+\n+        if (shouldUpdate) {\n+            StreamType streamType = downloaderProperties.getStreamType();\n+            applicationStatusRepository.updateStatusValue(getLastValidDownloadedFileKey(),\n+                    Utility.getStreamFilenameForInstant(streamType, startDate));\n+            mirrorProperties.setVerifyHashAfter(startDate);\n+            log.info(\"Set downloader to start polling from {} for {}\", startDate, streamType.getPath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e81c6061668b2727fa2b561c382cf717d0a703e0"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMzNDI3Mw==", "bodyText": "Since this is a transient update but the database is permanent, we should probably always set verifyHashAfter equal to startDate if the user supplied an explicit startDate.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r472334273", "createdAt": "2020-08-18T16:42:04Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -420,6 +433,60 @@ private File downloadSignedDataFile(File sigFile, String nodeAccountId) {\n         return null;\n     }\n \n+    /**\n+     * Sets the start date of the data based on property startDate and current application status if it's not\n+     * updated yet.\n+     * <ul>\n+     *  <li>If the property startDate is set and application status is empty or less than startDate, set application\n+     *  status and verifyHashAfter to startDate.</li>\n+     *  <li>If the property startDate is not set and application status is empty, set application status and\n+     *  verifyHashAfter to now.</li>\n+     *  </ul>\n+     */\n+    private void updateDataStartDate() {\n+        if (dataStartDateUpdated) {\n+            return;\n+        }\n+\n+        boolean shouldUpdate = false;\n+        Instant startDate = mirrorProperties.getStartDate();\n+        String lastValidFilename = applicationStatusRepository.findByStatusCode(getLastValidDownloadedFileKey());\n+        if (startDate != null) {\n+            Instant lastValidFileInstant = Utility.getInstantFromFilename(lastValidFilename);\n+            if (StringUtils.isBlank(lastValidFilename) || lastValidFileInstant.isBefore(startDate)) {\n+                shouldUpdate = true;\n+            }\n+        } else if (StringUtils.isBlank(lastValidFilename)) {\n+            startDate = MirrorProperties.getStartDateNow();\n+            shouldUpdate = true;\n+        }\n+\n+        if (shouldUpdate) {\n+            StreamType streamType = downloaderProperties.getStreamType();\n+            applicationStatusRepository.updateStatusValue(getLastValidDownloadedFileKey(),\n+                    Utility.getStreamFilenameForInstant(streamType, startDate));\n+            mirrorProperties.setVerifyHashAfter(startDate);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e81c6061668b2727fa2b561c382cf717d0a703e0"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMzNDUwOQ==", "bodyText": "We should not override verifyHashAfter if it's not null and it's after startDate.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r472334509", "createdAt": "2020-08-18T16:42:30Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -420,6 +433,60 @@ private File downloadSignedDataFile(File sigFile, String nodeAccountId) {\n         return null;\n     }\n \n+    /**\n+     * Sets the start date of the data based on property startDate and current application status if it's not\n+     * updated yet.\n+     * <ul>\n+     *  <li>If the property startDate is set and application status is empty or less than startDate, set application\n+     *  status and verifyHashAfter to startDate.</li>\n+     *  <li>If the property startDate is not set and application status is empty, set application status and\n+     *  verifyHashAfter to now.</li>\n+     *  </ul>\n+     */\n+    private void updateDataStartDate() {\n+        if (dataStartDateUpdated) {\n+            return;\n+        }\n+\n+        boolean shouldUpdate = false;\n+        Instant startDate = mirrorProperties.getStartDate();\n+        String lastValidFilename = applicationStatusRepository.findByStatusCode(getLastValidDownloadedFileKey());\n+        if (startDate != null) {\n+            Instant lastValidFileInstant = Utility.getInstantFromFilename(lastValidFilename);\n+            if (StringUtils.isBlank(lastValidFilename) || lastValidFileInstant.isBefore(startDate)) {\n+                shouldUpdate = true;\n+            }\n+        } else if (StringUtils.isBlank(lastValidFilename)) {\n+            startDate = MirrorProperties.getStartDateNow();\n+            shouldUpdate = true;\n+        }\n+\n+        if (shouldUpdate) {\n+            StreamType streamType = downloaderProperties.getStreamType();\n+            applicationStatusRepository.updateStatusValue(getLastValidDownloadedFileKey(),\n+                    Utility.getStreamFilenameForInstant(streamType, startDate));\n+            mirrorProperties.setVerifyHashAfter(startDate);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e81c6061668b2727fa2b561c382cf717d0a703e0"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM0NjI3Ng==", "bodyText": "Can just remove StringUtils.isBlank(lastValidFilename) since Utility.getInstantFromFilename already does that check and returns epoch. Then can pull lastValidFileInstant up like Nana mentioned and flatten this if statement.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r472346276", "createdAt": "2020-08-18T17:01:36Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -420,6 +433,60 @@ private File downloadSignedDataFile(File sigFile, String nodeAccountId) {\n         return null;\n     }\n \n+    /**\n+     * Sets the start date of the data based on property startDate and current application status if it's not\n+     * updated yet.\n+     * <ul>\n+     *  <li>If the property startDate is set and application status is empty or less than startDate, set application\n+     *  status and verifyHashAfter to startDate.</li>\n+     *  <li>If the property startDate is not set and application status is empty, set application status and\n+     *  verifyHashAfter to now.</li>\n+     *  </ul>\n+     */\n+    private void updateDataStartDate() {\n+        if (dataStartDateUpdated) {\n+            return;\n+        }\n+\n+        boolean shouldUpdate = false;\n+        Instant startDate = mirrorProperties.getStartDate();\n+        String lastValidFilename = applicationStatusRepository.findByStatusCode(getLastValidDownloadedFileKey());\n+        if (startDate != null) {\n+            Instant lastValidFileInstant = Utility.getInstantFromFilename(lastValidFilename);\n+            if (StringUtils.isBlank(lastValidFilename) || lastValidFileInstant.isBefore(startDate)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e81c6061668b2727fa2b561c382cf717d0a703e0"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0168a088fec2812fb43943071c6926751a395474", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0168a088fec2812fb43943071c6926751a395474", "committedDate": "2020-08-20T17:50:25Z", "message": "placeholder\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2670bd029e50745b9ae600e8b03dde230014fc6d", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2670bd029e50745b9ae600e8b03dde230014fc6d", "committedDate": "2020-08-20T23:41:09Z", "message": "switch from PostConstruct to async eventlistener, emit MirrorDateRangePropertiesProcessedEvent to trigger downloaders\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e0849b46b80cb06e0ce62d31ea38c67aafc6a06", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9e0849b46b80cb06e0ce62d31ea38c67aafc6a06", "committedDate": "2020-08-21T00:18:07Z", "message": "revert the changes that make Downloader an interface and rename Downloader to AbstractDownloader. Move application status code getters into DownloaderProperties\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb2b5ce9de437589673f63701cbb472b167787cf", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/eb2b5ce9de437589673f63701cbb472b167787cf", "committedDate": "2020-08-21T15:00:31Z", "message": "processRecordItem returns false if the recordItem is skipped because it's after endDate\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe98d223c4b2656867e7a0282902f95144c91288", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/fe98d223c4b2656867e7a0282902f95144c91288", "committedDate": "2020-08-21T15:43:24Z", "message": "replace s3mock with s3proxy with list-objects marker support\nSigned-off-by: Xin Li <xin.li@swirlds.com>\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14275c8ebec139cf5807a12c9bad33fb423e34c3", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/14275c8ebec139cf5807a12c9bad33fb423e34c3", "committedDate": "2020-08-21T18:39:26Z", "message": "refactor unit test cases for startDate and endDate\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad118451cdc7fe1b88be1ffc6dcbf4ed0aa779d1", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ad118451cdc7fe1b88be1ffc6dcbf4ed0aa779d1", "committedDate": "2020-08-21T22:10:52Z", "message": "more tests and bug fix\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa3f2651bd0bac995b1f99a61f958330280084c4", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/aa3f2651bd0bac995b1f99a61f958330280084c4", "committedDate": "2020-08-21T22:20:33Z", "message": "update doc\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e81c6061668b2727fa2b561c382cf717d0a703e0", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e81c6061668b2727fa2b561c382cf717d0a703e0", "committedDate": "2020-08-17T15:30:58Z", "message": "fix test failure\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}, "afterCommit": {"oid": "aa3f2651bd0bac995b1f99a61f958330280084c4", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/aa3f2651bd0bac995b1f99a61f958330280084c4", "committedDate": "2020-08-21T22:20:33Z", "message": "update doc\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c213b85105d61b4f90c231d845f0a5329b5dffb", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9c213b85105d61b4f90c231d845f0a5329b5dffb", "committedDate": "2020-08-24T02:54:43Z", "message": "move signature file endDate check to verifySigsAndDownloadDataFiles, clean up test cases\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMDY1Njgz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#pullrequestreview-473065683", "createdAt": "2020-08-24T00:57:44Z", "commit": {"oid": "aa3f2651bd0bac995b1f99a61f958330280084c4"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwMDo1Nzo0NFrOHFRjqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwMzowMTo0OVrOHFTDmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI5MjU4NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean mirrorDateRagePropertiesProcessed = false;\n          \n          \n            \n                private boolean mirrorDateRangePropertiesProcessed = false;", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r475292584", "createdAt": "2020-08-24T00:57:44Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -86,6 +95,11 @@\n     protected final Timer downloadLatencyMetric;\n     protected final Timer streamCloseMetric;\n \n+    private boolean mirrorDateRagePropertiesProcessed = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa3f2651bd0bac995b1f99a61f958330280084c4"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI5MjcyMA==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param downloaderProperties The properties of the downloader to validate the (startDate, endDate] range for\n          \n          \n            \n                 * @param downloaderProperties The properties of the downloader to validate the (startDate, endDate) range for\n          \n      \n    \n    \n  \n\nor\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param downloaderProperties The properties of the downloader to validate the (startDate, endDate] range for\n          \n          \n            \n                 * @param downloaderProperties The properties of the downloader to validate the [startDate, endDate] range for", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r475292720", "createdAt": "2020-08-24T00:58:35Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/config/MirrorDateRangePropertiesProcessor.java", "diffHunk": "@@ -0,0 +1,130 @@\n+package com.hedera.mirror.importer.config;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.time.Instant;\n+import java.util.List;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.springframework.boot.context.event.ApplicationReadyEvent;\n+import org.springframework.context.ApplicationEventPublisher;\n+import org.springframework.context.event.EventListener;\n+import org.springframework.scheduling.annotation.Async;\n+\n+import com.hedera.mirror.importer.MirrorProperties;\n+import com.hedera.mirror.importer.config.event.MirrorDateRangePropertiesProcessedEvent;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.downloader.DownloaderProperties;\n+import com.hedera.mirror.importer.exception.InvalidConfigurationException;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class MirrorDateRangePropertiesProcessor {\n+\n+    private final ApplicationEventPublisher applicationEventPublisher;\n+    private final MirrorProperties mirrorProperties;\n+    private final ApplicationStatusRepository applicationStatusRepository;\n+    private final List<DownloaderProperties> downloaderPropertiesList;\n+\n+    @Async\n+    @EventListener(ApplicationReadyEvent.class)\n+    public void process() {\n+        for (DownloaderProperties downloaderProperties : downloaderPropertiesList) {\n+            validateDateRange(downloaderProperties);\n+        }\n+\n+        for (DownloaderProperties downloaderProperties : downloaderPropertiesList) {\n+            updateApplicationStatus(downloaderProperties);\n+        }\n+\n+        applicationEventPublisher.publishEvent(new MirrorDateRangePropertiesProcessedEvent(this));\n+        log.info(\"Mirror date range properties processed successfully, MirrorDateRangePropertiesProcessedEvent fired\");\n+    }\n+\n+    /**\n+     * Validates the configured (startDate, endDate] range for downloader.\n+     * @param downloaderProperties The properties of the downloader to validate the (startDate, endDate] range for", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa3f2651bd0bac995b1f99a61f958330280084c4"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI5MjgyMA==", "bodyText": "nit: name this something like startUpInstant so it's not confused with startDate.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r475292820", "createdAt": "2020-08-24T00:59:06Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/MirrorProperties.java", "diffHunk": "@@ -38,6 +38,8 @@\n @ConfigurationProperties(\"hedera.mirror.importer\")\n public class MirrorProperties {\n \n+    private static final Instant startDateNow = Instant.now();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa3f2651bd0bac995b1f99a61f958330280084c4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI5NTIxNg==", "bodyText": "This could also be moved to Utility as Utility. isFileAfterInstant() below\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean isFileAfterEndDate(String filename) {\n          \n          \n            \n                private boolean isFileAfterInstant(String filename, Instant instant) {\n          \n          \n            \n                    return instant != null && Utility.getInstantFromFilename(filename).isAfter(instant);\n          \n          \n            \n                }\n          \n      \n    \n    \n  \n\nThen call  Utility.isFileAfterInstant(filename, mirrorProperties.getEndDate()) on line 244", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r475295216", "createdAt": "2020-08-24T01:13:49Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -420,9 +475,10 @@ private File downloadSignedDataFile(File sigFile, String nodeAccountId) {\n         return null;\n     }\n \n-    protected abstract ApplicationStatusCode getLastValidDownloadedFileKey();\n-\n-    protected abstract ApplicationStatusCode getLastValidDownloadedFileHashKey();\n+    private boolean isFileAfterEndDate(String filename) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa3f2651bd0bac995b1f99a61f958330280084c4"}, "originalPosition": 208}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTMxNTU0MQ==", "bodyText": "Maybe add a log message here. If it returns a couple of times and the parser isn't downloading it'd be good to know why", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r475315541", "createdAt": "2020-08-24T02:54:07Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -96,40 +110,56 @@ public Downloader(S3AsyncClient s3Client, ApplicationStatusRepository applicatio\n         this.meterRegistry = meterRegistry;\n         signatureDownloadThreadPool = Executors.newFixedThreadPool(downloaderProperties.getThreads());\n         Runtime.getRuntime().addShutdownHook(new Thread(signatureDownloadThreadPool::shutdown));\n-        commonDownloaderProperties = downloaderProperties.getCommon();\n         mirrorProperties = downloaderProperties.getMirrorProperties();\n+        commonDownloaderProperties = downloaderProperties.getCommon();\n+\n+        lastValidDownloadedFileKey = downloaderProperties.getLastValidDownloadedFileKey();\n+        lastValidDownloadedFileHashKey = downloaderProperties.getLastValidDownloadedFileHashKey();\n+\n+        StreamType streamType = downloaderProperties.getStreamType();\n+        defaultSigFilename = DEFAULT_FILE_BASENAME + streamType.getSuffix() + \".\" + streamType.getSignatureExtension();\n \n         // Metrics\n         signatureVerificationMetric = Counter.builder(\"hedera.mirror.download.signature.verification\")\n                 .description(\"The number of signatures verified from a particular node\")\n-                .tag(\"type\", downloaderProperties.getStreamType().toString());\n+                .tag(\"type\", streamType.toString());\n \n         streamVerificationMetric = Timer.builder(\"hedera.mirror.download.stream.verification\")\n                 .description(\"The duration in seconds it took to verify consensus and hash chain of a stream file\")\n-                .tag(\"type\", downloaderProperties.getStreamType().toString());\n+                .tag(\"type\", streamType.toString());\n \n         downloadLatencyMetric = Timer.builder(\"hedera.mirror.download.latency\")\n                 .description(\"The difference in ms between the consensus time of the last transaction in the file \" +\n                         \"and the time at which the file was downloaded and verified\")\n-                .tag(\"type\", downloaderProperties.getStreamType().toString())\n+                .tag(\"type\", streamType.toString())\n                 .register(meterRegistry);\n \n         streamCloseMetric = Timer.builder(\"hedera.mirror.stream.close.latency\")\n                 .description(\"The difference between the consensus time of the last and first transaction in the \" +\n                         \"stream file\")\n-                .tag(\"type\", downloaderProperties.getStreamType().toString())\n+                .tag(\"type\", streamType.toString())\n                 .register(meterRegistry);\n     }\n \n+\n+    @EventListener(MirrorDateRangePropertiesProcessedEvent.class)\n+    public void onMirrorDateRangePropertiesProcessedEvent() {\n+        mirrorDateRagePropertiesProcessed = true;\n+    }\n+\n     protected void downloadNextBatch() {\n-        try {\n-            if (!downloaderProperties.isEnabled()) {\n-                return;\n-            }\n-            if (ShutdownHelper.isStopping()) {\n-                return;\n-            }\n+        if (!mirrorDateRagePropertiesProcessed) {\n+            return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa3f2651bd0bac995b1f99a61f958330280084c4"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTMxNzE0NA==", "bodyText": "q: should this check be done much earlier? Maybe at the beginning of process()?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r475317144", "createdAt": "2020-08-24T03:01:49Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/config/MirrorDateRangePropertiesProcessor.java", "diffHunk": "@@ -0,0 +1,130 @@\n+package com.hedera.mirror.importer.config;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.time.Instant;\n+import java.util.List;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.springframework.boot.context.event.ApplicationReadyEvent;\n+import org.springframework.context.ApplicationEventPublisher;\n+import org.springframework.context.event.EventListener;\n+import org.springframework.scheduling.annotation.Async;\n+\n+import com.hedera.mirror.importer.MirrorProperties;\n+import com.hedera.mirror.importer.config.event.MirrorDateRangePropertiesProcessedEvent;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.downloader.DownloaderProperties;\n+import com.hedera.mirror.importer.exception.InvalidConfigurationException;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class MirrorDateRangePropertiesProcessor {\n+\n+    private final ApplicationEventPublisher applicationEventPublisher;\n+    private final MirrorProperties mirrorProperties;\n+    private final ApplicationStatusRepository applicationStatusRepository;\n+    private final List<DownloaderProperties> downloaderPropertiesList;\n+\n+    @Async\n+    @EventListener(ApplicationReadyEvent.class)\n+    public void process() {\n+        for (DownloaderProperties downloaderProperties : downloaderPropertiesList) {\n+            validateDateRange(downloaderProperties);\n+        }\n+\n+        for (DownloaderProperties downloaderProperties : downloaderPropertiesList) {\n+            updateApplicationStatus(downloaderProperties);\n+        }\n+\n+        applicationEventPublisher.publishEvent(new MirrorDateRangePropertiesProcessedEvent(this));\n+        log.info(\"Mirror date range properties processed successfully, MirrorDateRangePropertiesProcessedEvent fired\");\n+    }\n+\n+    /**\n+     * Validates the configured (startDate, endDate] range for downloader.\n+     * @param downloaderProperties The properties of the downloader to validate the (startDate, endDate] range for\n+     * @throws InvalidConfigurationException if the constraint effective startDate < endDate is violated\n+     */\n+    private void validateDateRange(DownloaderProperties downloaderProperties) {\n+        Instant effectiveStartDate = getEffectiveStartDate(downloaderProperties);\n+        Instant endDate = mirrorProperties.getEndDate();\n+        if (effectiveStartDate != null && endDate != null && !endDate.isAfter(effectiveStartDate)) {\n+            throw new InvalidConfigurationException(String.format(\"Date range constraint violation for %s downloader: \" +\n+                            \"startDate (%s) >= endDate (%s)\", downloaderProperties.getStreamType(),\n+                    effectiveStartDate, endDate));\n+        }\n+    }\n+\n+    /**\n+     * Updates the application status for downloader based on the validated (startDate, endDate] range.\n+     * If effective startDate is not null, the application status is set so the downloader will pull data from files\n+     * after the effective startDate. In addition, verifyHashAfter is set to effective startDate if not set or before\n+     * effective startDate.\n+     * @param downloaderProperties The properties of the downloader to update application status for\n+     */\n+    private void updateApplicationStatus(DownloaderProperties downloaderProperties) {\n+        Instant effectiveStartDate = getEffectiveStartDate(downloaderProperties);\n+        Instant lastFileInstant = getLastValidDownloadedFileInstant(downloaderProperties);\n+        if (effectiveStartDate != null && !effectiveStartDate.equals(lastFileInstant)) {\n+            StreamType streamType = downloaderProperties.getStreamType();\n+            String filename = Utility.getStreamFilenameFromInstant(streamType, effectiveStartDate);\n+            applicationStatusRepository.updateStatusValue(downloaderProperties.getLastValidDownloadedFileKey(), filename);\n+            log.debug(\"Set last valid downloaded file to {} for {} downloader\", filename, streamType);\n+\n+            Instant verifyHashAfter = mirrorProperties.getVerifyHashAfter();\n+            if (verifyHashAfter == null || verifyHashAfter.isBefore(effectiveStartDate)) {\n+                mirrorProperties.setVerifyHashAfter(effectiveStartDate);\n+                log.debug(\"Set verifyHashAfter to {}\", effectiveStartDate);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Gets the effective startDate for downloader based on startDate in MirrorProperties and last valid downloaded file.\n+     * @param downloaderProperties The downloader's properties\n+     * @return The effective startDate: null if downloader is disabled; if startDate is set, the effective startDate is\n+     * startDate if the database is empty or max(startDate, timestamp of last valid downloaded file); if startDate is\n+     * not set, the effective startDate is now if the database is empty, or the timestamp of last valid downloaded file\n+     */\n+    private Instant getEffectiveStartDate(DownloaderProperties downloaderProperties) {\n+        if (!downloaderProperties.isEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c213b85105d61b4f90c231d845f0a5329b5dffb"}, "originalPosition": 113}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNzMwOTEz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#pullrequestreview-473730913", "createdAt": "2020-08-24T17:57:00Z", "commit": {"oid": "9c213b85105d61b4f90c231d845f0a5329b5dffb"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjIwNDQ1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#pullrequestreview-473620445", "createdAt": "2020-08-24T15:37:24Z", "commit": {"oid": "9c213b85105d61b4f90c231d845f0a5329b5dffb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNTozNzoyNFrOHFq1Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxOTowMjozNlrOHFybUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcwNjYyNg==", "bodyText": "When I said \"Should mention format like verifyHashAfter\", I meant that it should explicitly specify the Format: YYYY-MM-ddTHH:mm:ss.nnnnnnnnnZ instead of saying it's the same as verifyHashAfter. Same for endDate", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r475706626", "createdAt": "2020-08-24T15:37:24Z", "author": {"login": "steven-sheehy"}, "path": "docs/configuration.md", "diffHunk": "@@ -82,6 +83,7 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.importer.parser.record.pubsub.maxSendAttempts`               | 5                       | Number of attempts when sending messages to PubSub (only for retryable errors)                 |\n | `hedera.mirror.importer.topicRunningHashV2AddedTimestamp`            | Network-based  | Unix timestamp (in nanos) of first topic message with v2 as running hash version. Use this config to override the default network based value |\n | `hedera.mirror.importer.shard`                                       | 0                       | The default shard number that the component participates in                                    |\n+| `hedera.mirror.importer.startDate`                                   |                         | The start date (exclusive) of the data to import. It takes effect 1) if it's set and the date is after the last downloaded file or the database is empty; 2) if it's not set and the database is empty, it defaults to now. The format is the same as `verifyHashAfter` |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c213b85105d61b4f90c231d845f0a5329b5dffb"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcwNzY4Ng==", "bodyText": "Why exclusive? I think if the customer has a specific transaction in mind they want it to start at they might populate that here expecting it to show up in the database. I think it should be inclusive.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r475707686", "createdAt": "2020-08-24T15:39:04Z", "author": {"login": "steven-sheehy"}, "path": "docs/configuration.md", "diffHunk": "@@ -82,6 +83,7 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.importer.parser.record.pubsub.maxSendAttempts`               | 5                       | Number of attempts when sending messages to PubSub (only for retryable errors)                 |\n | `hedera.mirror.importer.topicRunningHashV2AddedTimestamp`            | Network-based  | Unix timestamp (in nanos) of first topic message with v2 as running hash version. Use this config to override the default network based value |\n | `hedera.mirror.importer.shard`                                       | 0                       | The default shard number that the component participates in                                    |\n+| `hedera.mirror.importer.startDate`                                   |                         | The start date (exclusive) of the data to import. It takes effect 1) if it's set and the date is after the last downloaded file or the database is empty; 2) if it's not set and the database is empty, it defaults to now. The format is the same as `verifyHashAfter` |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c213b85105d61b4f90c231d845f0a5329b5dffb"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcxMjYyNw==", "bodyText": "mirrorProperties.getEndDate() uses reflection and is slow to put in a tight loop like this. As this change is only used to update a log statement, it's not important and recommend it be reverted. Changing order of counter.incrementAndGet() to be after processRecordItem should be sufficient.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r475712627", "createdAt": "2020-08-24T15:46:42Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/RecordFileParser.java", "diffHunk": "@@ -174,14 +182,20 @@ public void loadRecordFile(StreamFileData streamFileData) {\n         }\n     }\n \n-    private void processRecordItem(RecordItem recordItem) {\n+    private boolean processRecordItem(RecordItem recordItem) {\n         if (log.isTraceEnabled()) {\n             log.trace(\"Transaction = {}, Record = {}\",\n                     Utility.printProtoMessage(recordItem.getTransaction()),\n                     Utility.printProtoMessage(recordItem.getRecord()));\n         } else if (log.isDebugEnabled()) {\n             log.debug(\"Storing transaction with consensus timestamp {}\", recordItem.getConsensusTimestamp());\n         }\n+\n+        Instant endDate = mirrorProperties.getEndDate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c213b85105d61b4f90c231d845f0a5329b5dffb"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcyMzE1MA==", "bodyText": "Seems inefficient to loop over downloaderPropertiesList twice and retrieve effective start date twice. Recommend it be refactored to push validateDateRange into updateApplicationStatus to avoid the duplication.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r475723150", "createdAt": "2020-08-24T16:02:40Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/config/MirrorDateRangePropertiesProcessor.java", "diffHunk": "@@ -0,0 +1,130 @@\n+package com.hedera.mirror.importer.config;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.time.Instant;\n+import java.util.List;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.springframework.boot.context.event.ApplicationReadyEvent;\n+import org.springframework.context.ApplicationEventPublisher;\n+import org.springframework.context.event.EventListener;\n+import org.springframework.scheduling.annotation.Async;\n+\n+import com.hedera.mirror.importer.MirrorProperties;\n+import com.hedera.mirror.importer.config.event.MirrorDateRangePropertiesProcessedEvent;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.downloader.DownloaderProperties;\n+import com.hedera.mirror.importer.exception.InvalidConfigurationException;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class MirrorDateRangePropertiesProcessor {\n+\n+    private final ApplicationEventPublisher applicationEventPublisher;\n+    private final MirrorProperties mirrorProperties;\n+    private final ApplicationStatusRepository applicationStatusRepository;\n+    private final List<DownloaderProperties> downloaderPropertiesList;\n+\n+    @Async\n+    @EventListener(ApplicationReadyEvent.class)\n+    public void process() {\n+        for (DownloaderProperties downloaderProperties : downloaderPropertiesList) {\n+            validateDateRange(downloaderProperties);\n+        }\n+\n+        for (DownloaderProperties downloaderProperties : downloaderPropertiesList) {\n+            updateApplicationStatus(downloaderProperties);\n+        }\n+\n+        applicationEventPublisher.publishEvent(new MirrorDateRangePropertiesProcessedEvent(this));\n+        log.info(\"Mirror date range properties processed successfully, MirrorDateRangePropertiesProcessedEvent fired\");\n+    }\n+\n+    /**\n+     * Validates the configured (startDate, endDate] range for downloader.\n+     * @param downloaderProperties The properties of the downloader to validate the (startDate, endDate] range for\n+     * @throws InvalidConfigurationException if the constraint effective startDate < endDate is violated\n+     */\n+    private void validateDateRange(DownloaderProperties downloaderProperties) {\n+        Instant effectiveStartDate = getEffectiveStartDate(downloaderProperties);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c213b85105d61b4f90c231d845f0a5329b5dffb"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgxOTgwNw==", "bodyText": "getLastValidDownloadedFileInstant actually gets called 4 times per stream type. Since it's a cached method it's maybe not a big deal but still.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r475819807", "createdAt": "2020-08-24T18:41:35Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/config/MirrorDateRangePropertiesProcessor.java", "diffHunk": "@@ -0,0 +1,130 @@\n+package com.hedera.mirror.importer.config;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.time.Instant;\n+import java.util.List;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.springframework.boot.context.event.ApplicationReadyEvent;\n+import org.springframework.context.ApplicationEventPublisher;\n+import org.springframework.context.event.EventListener;\n+import org.springframework.scheduling.annotation.Async;\n+\n+import com.hedera.mirror.importer.MirrorProperties;\n+import com.hedera.mirror.importer.config.event.MirrorDateRangePropertiesProcessedEvent;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.downloader.DownloaderProperties;\n+import com.hedera.mirror.importer.exception.InvalidConfigurationException;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class MirrorDateRangePropertiesProcessor {\n+\n+    private final ApplicationEventPublisher applicationEventPublisher;\n+    private final MirrorProperties mirrorProperties;\n+    private final ApplicationStatusRepository applicationStatusRepository;\n+    private final List<DownloaderProperties> downloaderPropertiesList;\n+\n+    @Async\n+    @EventListener(ApplicationReadyEvent.class)\n+    public void process() {\n+        for (DownloaderProperties downloaderProperties : downloaderPropertiesList) {\n+            validateDateRange(downloaderProperties);\n+        }\n+\n+        for (DownloaderProperties downloaderProperties : downloaderPropertiesList) {\n+            updateApplicationStatus(downloaderProperties);\n+        }\n+\n+        applicationEventPublisher.publishEvent(new MirrorDateRangePropertiesProcessedEvent(this));\n+        log.info(\"Mirror date range properties processed successfully, MirrorDateRangePropertiesProcessedEvent fired\");\n+    }\n+\n+    /**\n+     * Validates the configured (startDate, endDate] range for downloader.\n+     * @param downloaderProperties The properties of the downloader to validate the (startDate, endDate] range for\n+     * @throws InvalidConfigurationException if the constraint effective startDate < endDate is violated\n+     */\n+    private void validateDateRange(DownloaderProperties downloaderProperties) {\n+        Instant effectiveStartDate = getEffectiveStartDate(downloaderProperties);\n+        Instant endDate = mirrorProperties.getEndDate();\n+        if (effectiveStartDate != null && endDate != null && !endDate.isAfter(effectiveStartDate)) {\n+            throw new InvalidConfigurationException(String.format(\"Date range constraint violation for %s downloader: \" +\n+                            \"startDate (%s) >= endDate (%s)\", downloaderProperties.getStreamType(),\n+                    effectiveStartDate, endDate));\n+        }\n+    }\n+\n+    /**\n+     * Updates the application status for downloader based on the validated (startDate, endDate] range.\n+     * If effective startDate is not null, the application status is set so the downloader will pull data from files\n+     * after the effective startDate. In addition, verifyHashAfter is set to effective startDate if not set or before\n+     * effective startDate.\n+     * @param downloaderProperties The properties of the downloader to update application status for\n+     */\n+    private void updateApplicationStatus(DownloaderProperties downloaderProperties) {\n+        Instant effectiveStartDate = getEffectiveStartDate(downloaderProperties);\n+        Instant lastFileInstant = getLastValidDownloadedFileInstant(downloaderProperties);\n+        if (effectiveStartDate != null && !effectiveStartDate.equals(lastFileInstant)) {\n+            StreamType streamType = downloaderProperties.getStreamType();\n+            String filename = Utility.getStreamFilenameFromInstant(streamType, effectiveStartDate);\n+            applicationStatusRepository.updateStatusValue(downloaderProperties.getLastValidDownloadedFileKey(), filename);\n+            log.debug(\"Set last valid downloaded file to {} for {} downloader\", filename, streamType);\n+\n+            Instant verifyHashAfter = mirrorProperties.getVerifyHashAfter();\n+            if (verifyHashAfter == null || verifyHashAfter.isBefore(effectiveStartDate)) {\n+                mirrorProperties.setVerifyHashAfter(effectiveStartDate);\n+                log.debug(\"Set verifyHashAfter to {}\", effectiveStartDate);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Gets the effective startDate for downloader based on startDate in MirrorProperties and last valid downloaded file.\n+     * @param downloaderProperties The downloader's properties\n+     * @return The effective startDate: null if downloader is disabled; if startDate is set, the effective startDate is\n+     * startDate if the database is empty or max(startDate, timestamp of last valid downloaded file); if startDate is\n+     * not set, the effective startDate is now if the database is empty, or the timestamp of last valid downloaded file\n+     */\n+    private Instant getEffectiveStartDate(DownloaderProperties downloaderProperties) {\n+        if (!downloaderProperties.isEnabled()) {\n+            return null;\n+        }\n+\n+        Instant startDate = mirrorProperties.getStartDate();\n+        Instant lastFileInstant = getLastValidDownloadedFileInstant(downloaderProperties);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c213b85105d61b4f90c231d845f0a5329b5dffb"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgyODk5NA==", "bodyText": "Again, I don't feel this logic should be here. I also don't like making this class stateful by storing lastSigFilenameToVerify. Recommend removing lastSigFilenameToVerify and pushing this logic into if (isFileAfterEndDate(sigFilename)) check inside verifySigsAndDownloadDataFiles. There you can just directly return from the method after disabling polling if it's after and avoid the multiple break statements. It makes the logic cleaner and is more encapsulated.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r475828994", "createdAt": "2020-08-24T18:58:33Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -144,6 +174,17 @@ protected void downloadNextBatch() {\n             log.warn(e.getMessage());\n         } catch (Exception e) {\n             log.error(\"Error downloading files\", e);\n+        } finally {\n+            if (!StringUtils.isEmpty(lastSigFilenameToVerify)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c213b85105d61b4f90c231d845f0a5329b5dffb"}, "originalPosition": 131}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgyOTk5Ng==", "bodyText": "Can just downloaderProperties.setEnabled(false); here or call a method that does so.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r475829996", "createdAt": "2020-08-24T19:00:27Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -389,13 +439,23 @@ private void verifySigsAndDownloadDataFiles(Multimap<String, FileStreamSignature\n                 }\n             }\n \n-            if (!valid) {\n-                log.error(\"None of the data files could be verified, signatures: {}\", signatures);\n-            }\n-\n             streamVerificationMetric.tag(\"success\", String.valueOf(valid))\n                     .register(meterRegistry)\n                     .record(Duration.between(startTime, Instant.now()));\n+\n+            if (isEndDateReached) {\n+                // stop processing here since the file is after the configured endDate\n+                lastSigFilenameToVerify = lastValidSigFilename;\n+                break;\n+            } else if (!valid) {\n+                log.error(\"None of the data files could be verified, signatures: {}\", signatures);\n+            }\n+        }\n+\n+        if (!sigFilesMap.isEmpty() && lastSigFilenameToVerify != null && lastSigFilenameToVerify.isEmpty()) {\n+            // when all files in the bucket are after endDate and there is no last downloaded file in db,\n+            // use defaultSigFilename as sentinel to disable the downloader\n+            lastSigFilenameToVerify = defaultSigFilename;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c213b85105d61b4f90c231d845f0a5329b5dffb"}, "originalPosition": 239}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgzMTEyMg==", "bodyText": "This still doesn't seem to support transaction level granularity.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r475831122", "createdAt": "2020-08-24T19:02:36Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -365,16 +408,23 @@ private void verifySigsAndDownloadDataFiles(Multimap<String, FileStreamSignature\n                     if (signedDataFile == null) {\n                         continue;\n                     }\n+\n                     if (verifyDataFile(signedDataFile, signature.getHash())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c213b85105d61b4f90c231d845f0a5329b5dffb"}, "originalPosition": 193}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczODE2OTgz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#pullrequestreview-473816983", "createdAt": "2020-08-24T20:04:23Z", "commit": {"oid": "9c213b85105d61b4f90c231d845f0a5329b5dffb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQyMDowNDoyM1rOHF0ViA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQyMDowNDoyM1rOHF0ViA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg2MjQwOA==", "bodyText": "This should probably still disable the parser poller otherwise the files in valid folder will be repeatedly parsed indefinitely.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r475862408", "createdAt": "2020-08-24T20:04:23Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/RecordFileParser.java", "diffHunk": "@@ -153,8 +160,9 @@ public void loadRecordFile(StreamFileData streamFileData) {\n                     streamFileData.getFilename(), expectedPrevFileHash,\n                     parserProperties.getMirrorProperties().getVerifyHashAfter(),\n                     recordItem -> {\n-                        counter.incrementAndGet();\n-                        processRecordItem(recordItem);\n+                        if (processRecordItem(recordItem)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c213b85105d61b4f90c231d845f0a5329b5dffb"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczODE3MTU1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#pullrequestreview-473817155", "createdAt": "2020-08-24T20:04:39Z", "commit": {"oid": "9c213b85105d61b4f90c231d845f0a5329b5dffb"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a85555b92bad1a1c39f9ad370d76b38144a01641", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a85555b92bad1a1c39f9ad370d76b38144a01641", "committedDate": "2020-08-25T14:57:51Z", "message": "Merge branch 'master' into import-latest-property\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "546e76ab83654af0704df68a5172066231d124f7", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/546e76ab83654af0704df68a5172066231d124f7", "committedDate": "2020-08-25T20:52:27Z", "message": "make startDate at transaction level\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b97cab13ea9f5550f3f7ca415ba175dcda9f5db7", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b97cab13ea9f5550f3f7ca415ba175dcda9f5db7", "committedDate": "2020-08-25T20:53:29Z", "message": "Merge branch 'master' into import-latest-property"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3487c0f1f39982e626fdecc72e245e598cec3500", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3487c0f1f39982e626fdecc72e245e598cec3500", "committedDate": "2020-08-26T16:02:47Z", "message": "move method to Utility.java and rename variables\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NjczMDM4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#pullrequestreview-475673038", "createdAt": "2020-08-26T16:45:45Z", "commit": {"oid": "3487c0f1f39982e626fdecc72e245e598cec3500"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NjUwODYy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#pullrequestreview-475650862", "createdAt": "2020-08-26T16:18:26Z", "commit": {"oid": "3487c0f1f39982e626fdecc72e245e598cec3500"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNjoxODoyNlrOHHTtRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNjozODozMVrOHHUfNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQyNDk2NA==", "bodyText": "nit: Use @Value for immutable classes.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r477424964", "createdAt": "2020-08-26T16:18:26Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/config/MirrorDateRangePropertiesProcessor.java", "diffHunk": "@@ -0,0 +1,187 @@\n+package com.hedera.mirror.importer.config;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.apache.commons.lang3.ObjectUtils.max;\n+\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import javax.inject.Named;\n+import javax.transaction.Transactional;\n+import lombok.Data;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.springframework.boot.context.event.ApplicationReadyEvent;\n+import org.springframework.context.ApplicationEventPublisher;\n+import org.springframework.context.event.EventListener;\n+import org.springframework.scheduling.annotation.Async;\n+\n+import com.hedera.mirror.importer.MirrorProperties;\n+import com.hedera.mirror.importer.config.event.MirrorDateRangePropertiesProcessedEvent;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.downloader.DownloaderProperties;\n+import com.hedera.mirror.importer.exception.InvalidConfigurationException;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class MirrorDateRangePropertiesProcessor {\n+\n+    private final ApplicationEventPublisher applicationEventPublisher;\n+    private final MirrorProperties mirrorProperties;\n+    private final ApplicationStatusRepository applicationStatusRepository;\n+    private final List<DownloaderProperties> downloaderPropertiesList;\n+\n+    private Map<StreamType, DateRangeFilter> filters = new HashMap<>();\n+\n+    @Transactional\n+    @Async\n+    @EventListener(ApplicationReadyEvent.class)\n+    public void process() {\n+        Instant startDate = mirrorProperties.getStartDate();\n+        Instant endDate = mirrorProperties.getEndDate();\n+        if (startDate != null && endDate != null && startDate.compareTo(endDate) > 0) {\n+            throw new InvalidConfigurationException(String.format(\"Date range constraint violation: \" +\n+                    \"startDate (%s) > endDate (%s)\", startDate, endDate));\n+        }\n+\n+        for (DownloaderProperties downloaderProperties : downloaderPropertiesList) {\n+            processDateRange(downloaderProperties);\n+        }\n+\n+        applicationEventPublisher.publishEvent(new MirrorDateRangePropertiesProcessedEvent(this));\n+        log.info(\"Mirror date range properties processed successfully, MirrorDateRangePropertiesProcessedEvent fired\");\n+    }\n+\n+    /**\n+     * Gets the DateRangeFilter for the downloader (record, balance, event).\n+     * @param type - downloader type\n+     * @return the DateRangeFilter\n+     */\n+    public DateRangeFilter getDateRangeFilter(StreamType type) {\n+        return filters.get(type);\n+    }\n+\n+    /**\n+     * Validates the configured [startDate, endDate] range for downloader and updates its application status if needed.\n+     * @param downloaderProperties the properties of the downloader to validate the [startDate, endDate] range for\n+     * @throws InvalidConfigurationException if the constraint effective startDate < endDate is violated\n+     */\n+    private void processDateRange(DownloaderProperties downloaderProperties) {\n+        // validate date range\n+        Instant effectiveStartDate = getEffectiveStartDate(downloaderProperties);\n+        Instant endDate = mirrorProperties.getEndDate();\n+        if (effectiveStartDate != null && endDate != null && effectiveStartDate.compareTo(endDate) > 0) {\n+            throw new InvalidConfigurationException(String.format(\"Date range constraint violation for %s downloader: \" +\n+                            \"effective startDate (%s) > endDate (%s)\", downloaderProperties.getStreamType(),\n+                    effectiveStartDate, endDate));\n+        }\n+\n+        // update application status\n+        Instant lastFileInstant = getLastValidDownloadedFileInstant(downloaderProperties);\n+        if (effectiveStartDate != null && !effectiveStartDate.equals(lastFileInstant)) {\n+            StreamType streamType = downloaderProperties.getStreamType();\n+            String filename = Utility.getStreamFilenameFromInstant(streamType, effectiveStartDate);\n+            applicationStatusRepository.updateStatusValue(downloaderProperties.getLastValidDownloadedFileKey(), filename);\n+            log.debug(\"Set last valid downloaded file to {} for {} downloader\", filename, streamType);\n+\n+            Instant verifyHashAfter = mirrorProperties.getVerifyHashAfter();\n+            if (verifyHashAfter == null || verifyHashAfter.isBefore(effectiveStartDate)) {\n+                mirrorProperties.setVerifyHashAfter(effectiveStartDate);\n+                log.debug(\"Set verifyHashAfter to {}\", effectiveStartDate);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Gets the effective startDate for downloader based on startDate in MirrorProperties, the startDateAdjustment\n+     * and last valid downloaded file. Also sets the effective inclusive start date of the items to accept.\n+     * @param downloaderProperties The downloader's properties\n+     * @return The effective startDate: null if downloader is disabled; if startDate is set, the effective startDate is\n+     * startDate if the database is empty or max(startDate, timestamp of last valid downloaded file); if startDate is\n+     * not set, the effective startDate is now if the database is empty, or the timestamp of last valid downloaded file\n+     */\n+    private Instant getEffectiveStartDate(DownloaderProperties downloaderProperties) {\n+        if (!downloaderProperties.isEnabled()) {\n+            filters.put(downloaderProperties.getStreamType(), DateRangeFilter.empty());\n+            return null;\n+        }\n+\n+        Instant startDate = mirrorProperties.getStartDate();\n+        Instant startUpInstant = MirrorProperties.getStartUpInstant();\n+        Instant endDate = mirrorProperties.getEndDate();\n+        Instant lastFileInstant = getLastValidDownloadedFileInstant(downloaderProperties);\n+        Duration adjustment = downloaderProperties.getStartDateAdjustment();\n+        if (startDate != null) {\n+            if (startDate.isAfter(lastFileInstant) || endDate != null) {\n+                filters.put(downloaderProperties.getStreamType(), new DateRangeFilter(startDate, endDate));\n+            }\n+            return max(startDate.minus(adjustment), lastFileInstant);\n+        } else {\n+            if (lastFileInstant.equals(Instant.EPOCH)) {\n+                filters.put(downloaderProperties.getStreamType(), new DateRangeFilter(startUpInstant, endDate));\n+                return startUpInstant.minus(adjustment);\n+            } else {\n+                if (endDate != null) {\n+                    filters.put(downloaderProperties.getStreamType(), new DateRangeFilter(lastFileInstant, endDate));\n+                }\n+                return lastFileInstant;\n+            }\n+        }\n+    }\n+\n+    private Instant getLastValidDownloadedFileInstant(DownloaderProperties downloaderProperties) {\n+        String filename = applicationStatusRepository.findByStatusCode(downloaderProperties.getLastValidDownloadedFileKey());\n+        return Utility.getInstantFromFilename(filename);\n+    }\n+\n+    @Data", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3487c0f1f39982e626fdecc72e245e598cec3500"}, "originalPosition": 161}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQyNzQyMQ==", "bodyText": "I'm not a fan of using this helper processor class to store state and this state used by other classes. Logically this should belong in a properties class, but we can get this in and revisit it later.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r477427421", "createdAt": "2020-08-26T16:22:19Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/config/MirrorDateRangePropertiesProcessor.java", "diffHunk": "@@ -0,0 +1,187 @@\n+package com.hedera.mirror.importer.config;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.apache.commons.lang3.ObjectUtils.max;\n+\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import javax.inject.Named;\n+import javax.transaction.Transactional;\n+import lombok.Data;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.springframework.boot.context.event.ApplicationReadyEvent;\n+import org.springframework.context.ApplicationEventPublisher;\n+import org.springframework.context.event.EventListener;\n+import org.springframework.scheduling.annotation.Async;\n+\n+import com.hedera.mirror.importer.MirrorProperties;\n+import com.hedera.mirror.importer.config.event.MirrorDateRangePropertiesProcessedEvent;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.downloader.DownloaderProperties;\n+import com.hedera.mirror.importer.exception.InvalidConfigurationException;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class MirrorDateRangePropertiesProcessor {\n+\n+    private final ApplicationEventPublisher applicationEventPublisher;\n+    private final MirrorProperties mirrorProperties;\n+    private final ApplicationStatusRepository applicationStatusRepository;\n+    private final List<DownloaderProperties> downloaderPropertiesList;\n+\n+    private Map<StreamType, DateRangeFilter> filters = new HashMap<>();\n+\n+    @Transactional\n+    @Async\n+    @EventListener(ApplicationReadyEvent.class)\n+    public void process() {\n+        Instant startDate = mirrorProperties.getStartDate();\n+        Instant endDate = mirrorProperties.getEndDate();\n+        if (startDate != null && endDate != null && startDate.compareTo(endDate) > 0) {\n+            throw new InvalidConfigurationException(String.format(\"Date range constraint violation: \" +\n+                    \"startDate (%s) > endDate (%s)\", startDate, endDate));\n+        }\n+\n+        for (DownloaderProperties downloaderProperties : downloaderPropertiesList) {\n+            processDateRange(downloaderProperties);\n+        }\n+\n+        applicationEventPublisher.publishEvent(new MirrorDateRangePropertiesProcessedEvent(this));\n+        log.info(\"Mirror date range properties processed successfully, MirrorDateRangePropertiesProcessedEvent fired\");\n+    }\n+\n+    /**\n+     * Gets the DateRangeFilter for the downloader (record, balance, event).\n+     * @param type - downloader type\n+     * @return the DateRangeFilter\n+     */\n+    public DateRangeFilter getDateRangeFilter(StreamType type) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3487c0f1f39982e626fdecc72e245e598cec3500"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQyODkwNQ==", "bodyText": "Would it help cleanup this logic here and in other places if we defaulted startDate=Instant.EPOCH and endDate=Instant.MAX then made the two fields @NotNull validated? It would also make effectiveStartDate never null.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r477428905", "createdAt": "2020-08-26T16:24:36Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/config/MirrorDateRangePropertiesProcessor.java", "diffHunk": "@@ -0,0 +1,187 @@\n+package com.hedera.mirror.importer.config;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.apache.commons.lang3.ObjectUtils.max;\n+\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import javax.inject.Named;\n+import javax.transaction.Transactional;\n+import lombok.Data;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.springframework.boot.context.event.ApplicationReadyEvent;\n+import org.springframework.context.ApplicationEventPublisher;\n+import org.springframework.context.event.EventListener;\n+import org.springframework.scheduling.annotation.Async;\n+\n+import com.hedera.mirror.importer.MirrorProperties;\n+import com.hedera.mirror.importer.config.event.MirrorDateRangePropertiesProcessedEvent;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.downloader.DownloaderProperties;\n+import com.hedera.mirror.importer.exception.InvalidConfigurationException;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class MirrorDateRangePropertiesProcessor {\n+\n+    private final ApplicationEventPublisher applicationEventPublisher;\n+    private final MirrorProperties mirrorProperties;\n+    private final ApplicationStatusRepository applicationStatusRepository;\n+    private final List<DownloaderProperties> downloaderPropertiesList;\n+\n+    private Map<StreamType, DateRangeFilter> filters = new HashMap<>();\n+\n+    @Transactional\n+    @Async\n+    @EventListener(ApplicationReadyEvent.class)\n+    public void process() {\n+        Instant startDate = mirrorProperties.getStartDate();\n+        Instant endDate = mirrorProperties.getEndDate();\n+        if (startDate != null && endDate != null && startDate.compareTo(endDate) > 0) {\n+            throw new InvalidConfigurationException(String.format(\"Date range constraint violation: \" +\n+                    \"startDate (%s) > endDate (%s)\", startDate, endDate));\n+        }\n+\n+        for (DownloaderProperties downloaderProperties : downloaderPropertiesList) {\n+            processDateRange(downloaderProperties);\n+        }\n+\n+        applicationEventPublisher.publishEvent(new MirrorDateRangePropertiesProcessedEvent(this));\n+        log.info(\"Mirror date range properties processed successfully, MirrorDateRangePropertiesProcessedEvent fired\");\n+    }\n+\n+    /**\n+     * Gets the DateRangeFilter for the downloader (record, balance, event).\n+     * @param type - downloader type\n+     * @return the DateRangeFilter\n+     */\n+    public DateRangeFilter getDateRangeFilter(StreamType type) {\n+        return filters.get(type);\n+    }\n+\n+    /**\n+     * Validates the configured [startDate, endDate] range for downloader and updates its application status if needed.\n+     * @param downloaderProperties the properties of the downloader to validate the [startDate, endDate] range for\n+     * @throws InvalidConfigurationException if the constraint effective startDate < endDate is violated\n+     */\n+    private void processDateRange(DownloaderProperties downloaderProperties) {\n+        // validate date range\n+        Instant effectiveStartDate = getEffectiveStartDate(downloaderProperties);\n+        Instant endDate = mirrorProperties.getEndDate();\n+        if (effectiveStartDate != null && endDate != null && effectiveStartDate.compareTo(endDate) > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3487c0f1f39982e626fdecc72e245e598cec3500"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQzNDk3NQ==", "bodyText": "I think this log is less important and should be debug. Instead, I think an info log that states that it is only downloading files between x and y should be present.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r477434975", "createdAt": "2020-08-26T16:34:35Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/config/MirrorDateRangePropertiesProcessor.java", "diffHunk": "@@ -0,0 +1,187 @@\n+package com.hedera.mirror.importer.config;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.apache.commons.lang3.ObjectUtils.max;\n+\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import javax.inject.Named;\n+import javax.transaction.Transactional;\n+import lombok.Data;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.springframework.boot.context.event.ApplicationReadyEvent;\n+import org.springframework.context.ApplicationEventPublisher;\n+import org.springframework.context.event.EventListener;\n+import org.springframework.scheduling.annotation.Async;\n+\n+import com.hedera.mirror.importer.MirrorProperties;\n+import com.hedera.mirror.importer.config.event.MirrorDateRangePropertiesProcessedEvent;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.downloader.DownloaderProperties;\n+import com.hedera.mirror.importer.exception.InvalidConfigurationException;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class MirrorDateRangePropertiesProcessor {\n+\n+    private final ApplicationEventPublisher applicationEventPublisher;\n+    private final MirrorProperties mirrorProperties;\n+    private final ApplicationStatusRepository applicationStatusRepository;\n+    private final List<DownloaderProperties> downloaderPropertiesList;\n+\n+    private Map<StreamType, DateRangeFilter> filters = new HashMap<>();\n+\n+    @Transactional\n+    @Async\n+    @EventListener(ApplicationReadyEvent.class)\n+    public void process() {\n+        Instant startDate = mirrorProperties.getStartDate();\n+        Instant endDate = mirrorProperties.getEndDate();\n+        if (startDate != null && endDate != null && startDate.compareTo(endDate) > 0) {\n+            throw new InvalidConfigurationException(String.format(\"Date range constraint violation: \" +\n+                    \"startDate (%s) > endDate (%s)\", startDate, endDate));\n+        }\n+\n+        for (DownloaderProperties downloaderProperties : downloaderPropertiesList) {\n+            processDateRange(downloaderProperties);\n+        }\n+\n+        applicationEventPublisher.publishEvent(new MirrorDateRangePropertiesProcessedEvent(this));\n+        log.info(\"Mirror date range properties processed successfully, MirrorDateRangePropertiesProcessedEvent fired\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3487c0f1f39982e626fdecc72e245e598cec3500"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQzNjQyMw==", "bodyText": "I don't think transactionality is important here as it's read only and the system doesn't change until this event publishes.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r477436423", "createdAt": "2020-08-26T16:37:04Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/config/MirrorDateRangePropertiesProcessor.java", "diffHunk": "@@ -0,0 +1,187 @@\n+package com.hedera.mirror.importer.config;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.apache.commons.lang3.ObjectUtils.max;\n+\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import javax.inject.Named;\n+import javax.transaction.Transactional;\n+import lombok.Data;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.springframework.boot.context.event.ApplicationReadyEvent;\n+import org.springframework.context.ApplicationEventPublisher;\n+import org.springframework.context.event.EventListener;\n+import org.springframework.scheduling.annotation.Async;\n+\n+import com.hedera.mirror.importer.MirrorProperties;\n+import com.hedera.mirror.importer.config.event.MirrorDateRangePropertiesProcessedEvent;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.downloader.DownloaderProperties;\n+import com.hedera.mirror.importer.exception.InvalidConfigurationException;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class MirrorDateRangePropertiesProcessor {\n+\n+    private final ApplicationEventPublisher applicationEventPublisher;\n+    private final MirrorProperties mirrorProperties;\n+    private final ApplicationStatusRepository applicationStatusRepository;\n+    private final List<DownloaderProperties> downloaderPropertiesList;\n+\n+    private Map<StreamType, DateRangeFilter> filters = new HashMap<>();\n+\n+    @Transactional", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3487c0f1f39982e626fdecc72e245e598cec3500"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQzNzc1MQ==", "bodyText": "Pull mirrorProperties.getEndDate() out of loops and into a variable as it is slow. Also, no need to log stream type as Logger itself will show concrete type like RecordFileDownloader", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#discussion_r477437751", "createdAt": "2020-08-26T16:38:31Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -365,16 +388,25 @@ private void verifySigsAndDownloadDataFiles(Multimap<String, FileStreamSignature\n                     if (signedDataFile == null) {\n                         continue;\n                     }\n+\n                     if (verifyDataFile(signedDataFile, signature.getHash())) {\n+                        if (Utility.isStreamFileAfterInstant(sigFilename, mirrorProperties.getEndDate())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3487c0f1f39982e626fdecc72e245e598cec3500"}, "originalPosition": 151}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e8a5cb6358ff5679ea3e139b7ff9efcfe817266", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2e8a5cb6358ff5679ea3e139b7ff9efcfe817266", "committedDate": "2020-08-26T19:59:10Z", "message": "address review feedback\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1ODI3Njg5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/966#pullrequestreview-475827689", "createdAt": "2020-08-26T20:18:22Z", "commit": {"oid": "2e8a5cb6358ff5679ea3e139b7ff9efcfe817266"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3048, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}