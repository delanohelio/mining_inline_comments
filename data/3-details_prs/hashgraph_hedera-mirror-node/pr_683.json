{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyODQ4NjA4", "number": 683, "title": "Push docker images on master and cleanup old images", "bodyText": "Detailed description:\nTo support continuous deployment of docker images for helm chart it's necessary to push docker images on master builds.\nTo facilitate that this change\n\nUpdates circle CI to push docker image on master branches.\nUpdated circle ci with cleanup_images job that would loop through tags and delete tags after certain threshold e.g. older than 7 days\nUpdates pom files to default use project version and latest as docker tag.\nUpdates circle ci config to set docker tag of master-SHA if in master branch\nUpdates poms to check if circle.docker.tag is set. If so use this instead of project version tag\n\nWhich issue(s) this PR fixes:\nPartially addresses #625\nSpecial notes for your reviewer:\nStill testing out filtering in grc. Seeing minor inconsistencies between what service account sees and what my tests in gcloud console see.\nIn some tests when filtering on images older than a few hours ago the console would return an expected subset, upon running the delete all images with that tag were removed.\nSeems to not occur when accuracy of timing is in days and not hours.\nLeaving actual delete as echo and we can observe till we have more than 7 days worth of image tags\nDelete resolve will be handled by #689\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-04-13T21:23:15Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683", "merged": true, "mergeCommit": {"oid": "7f92bae15cb96b951cbf8e8cd8cd6559f80e57a3"}, "closed": true, "closedAt": "2020-04-17T21:28:11Z", "author": {"login": "Nana-EC"}, "timelineItems": {"totalCount": 67, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXVo9SgH2gAyNDAyODQ4NjA4OjU3NjRiMmI3OWE2YWE4ZmZjZDUyYjYxNjRhNTJlMWE4OWNlMTdhZmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYoKDhgFqTM5NTc4Mjk0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5764b2b79a6aa8ffcd52b6164a52e1a89ce17aff", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5764b2b79a6aa8ffcd52b6164a52e1a89ce17aff", "committedDate": "2020-04-13T21:19:05Z", "message": "Push docker images on master and cleanup\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8df482811345961abf62da7ef2732916702e277", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d8df482811345961abf62da7ef2732916702e277", "committedDate": "2020-04-13T21:53:01Z", "message": "Used circle.docker.tag in deploy\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4588349382cce708e51f48bc2353e4667b9f76b8", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4588349382cce708e51f48bc2353e4667b9f76b8", "committedDate": "2020-04-13T23:04:36Z", "message": "Use creationTime instead of useCurrentTimestamp\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13325ec032c443c70bb5da9b7c99f3b47477d3f7", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/13325ec032c443c70bb5da9b7c99f3b47477d3f7", "committedDate": "2020-04-13T23:16:33Z", "message": "Fixed bad substitution and updated prettyignore\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52a75d054d2b3650ac5411b127884a42bb540a37", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/52a75d054d2b3650ac5411b127884a42bb540a37", "committedDate": "2020-04-14T00:25:46Z", "message": "Added lastest tag config updated delete_before logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f6b57e157ff4b3c8bb6187da8180714fba5c4dc", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2f6b57e157ff4b3c8bb6187da8180714fba5c4dc", "committedDate": "2020-04-14T00:49:25Z", "message": "echoed image tag lists\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bcc501c9dc5c2b5ca436ba3ddbfa7cf8ca07f9b", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9bcc501c9dc5c2b5ca436ba3ddbfa7cf8ca07f9b", "committedDate": "2020-04-14T01:04:45Z", "message": "Added loop logic for multiple tags\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23672bf49917d88c26e810af2fef22de97e79f6f", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/23672bf49917d88c26e810af2fef22de97e79f6f", "committedDate": "2020-04-14T02:36:48Z", "message": "Try delete old images logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "527e9112e27cecc2bb78e0b34314c6a3a3401642", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/527e9112e27cecc2bb78e0b34314c6a3a3401642", "committedDate": "2020-04-14T02:51:45Z", "message": "Added echo for each image\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "284ae27b188b22ad01666977c39136439e8e1d3b", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/284ae27b188b22ad01666977c39136439e8e1d3b", "committedDate": "2020-04-14T03:40:39Z", "message": "Update  multiline comment\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d00eb4bda2f7bff82115c1b68c267b909feef417", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d00eb4bda2f7bff82115c1b68c267b909feef417", "committedDate": "2020-04-14T04:03:31Z", "message": "Remove gcloud delete\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a409b8194df17f105297d3e29b44fee3b2bec861", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a409b8194df17f105297d3e29b44fee3b2bec861", "committedDate": "2020-04-14T04:16:30Z", "message": "Remove digest echo for delete command\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d6dd52bc198e03da1e859b5ead71ed4d370aa81", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6d6dd52bc198e03da1e859b5ead71ed4d370aa81", "committedDate": "2020-04-14T15:26:20Z", "message": "Update for loop formatting\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f2533644c5bbcf251baf976a9d1a462e88c122b", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9f2533644c5bbcf251baf976a9d1a462e88c122b", "committedDate": "2020-04-14T16:17:01Z", "message": "Update reference logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e86f14f8164a410611639e01292a2b208bea029", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6e86f14f8164a410611639e01292a2b208bea029", "committedDate": "2020-04-14T16:53:37Z", "message": "Use circleci v2.1 reuseable commands\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6376920538217ef93aebf1926e1ab01f543f5b44", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6376920538217ef93aebf1926e1ab01f543f5b44", "committedDate": "2020-04-14T18:00:44Z", "message": "Hold off on commands and references. Verify split loop and list\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5fd1ed50c58222ea73ea6ed3c65da860a180bac", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c5fd1ed50c58222ea73ea6ed3c65da860a180bac", "committedDate": "2020-04-14T18:17:30Z", "message": "Single line tags list and fix commands indentation\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf699d1ece7e8ad0000721487f4550076008acd9", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/cf699d1ece7e8ad0000721487f4550076008acd9", "committedDate": "2020-04-14T18:31:46Z", "message": "Comment out non cleanup jobs\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e52d102f5043c9cff505e62049d7b4507dc9576", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9e52d102f5043c9cff505e62049d7b4507dc9576", "committedDate": "2020-04-14T18:43:07Z", "message": "Fix image path variable references\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb92568c8341c9d8d4ed9e16ec1c8f0387552444", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/cb92568c8341c9d8d4ed9e16ec1c8f0387552444", "committedDate": "2020-04-14T19:15:45Z", "message": "Add config list print\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7392ba4a3c053645d31cbc5e64c052a7587dd7f1", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/7392ba4a3c053645d31cbc5e64c052a7587dd7f1", "committedDate": "2020-04-14T19:30:41Z", "message": "Remove untagged old test master images\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d2e01f3ba90860eeb970e3991f3048978b7e966", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1d2e01f3ba90860eeb970e3991f3048978b7e966", "committedDate": "2020-04-14T19:34:34Z", "message": "Restore service account and project set\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "049cf59fe21ca9fecbf77e78a18ab9dd508295af", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/049cf59fe21ca9fecbf77e78a18ab9dd508295af", "committedDate": "2020-04-14T19:44:45Z", "message": "Verify image tag filtering list\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df762048fd775426c13bbf21d343d0953742dc18", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/df762048fd775426c13bbf21d343d0953742dc18", "committedDate": "2020-04-14T19:56:22Z", "message": "echo final filter command to verify time param\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1e7bf2c8e791221fa56ba8e395971891d3f1e4d", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c1e7bf2c8e791221fa56ba8e395971891d3f1e4d", "committedDate": "2020-04-14T20:20:55Z", "message": "Fixed filter string format issue\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32095720ee2860e7b8db23a2239fc57f5182aa18", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/32095720ee2860e7b8db23a2239fc57f5182aa18", "committedDate": "2020-04-14T20:35:32Z", "message": "Add echo for delete command\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f5d0501a403dd2a8d92054e96082e555712fc50", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0f5d0501a403dd2a8d92054e96082e555712fc50", "committedDate": "2020-04-14T20:39:53Z", "message": "dry run of 19 hours\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "267c256e0ee0b0a0c4ed9ff8ed1d60bedf6932d5", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/267c256e0ee0b0a0c4ed9ff8ed1d60bedf6932d5", "committedDate": "2020-04-14T20:48:06Z", "message": "Cleanup layout Leave delete commented out\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d70c881b54e53323618e14bfa69a173b54ab5922", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d70c881b54e53323618e14bfa69a173b54ab5922", "committedDate": "2020-04-14T21:09:30Z", "message": "Force new image push 1\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e48e06adfd1b071f37fa5cd986ee6458a35362b2", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e48e06adfd1b071f37fa5cd986ee6458a35362b2", "committedDate": "2020-04-14T21:42:39Z", "message": "Dry run for 7 days\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4c1d45d165956f0f3cc4a38a970781741678fb3", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d4c1d45d165956f0f3cc4a38a970781741678fb3", "committedDate": "2020-04-14T21:59:37Z", "message": "Fixed array loop and test 1 hour ago cleanup\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f0b2da8a705c072bdd028018ebb5a376231041a", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0f0b2da8a705c072bdd028018ebb5a376231041a", "committedDate": "2020-04-14T23:08:06Z", "message": "Test 2 hour ago cleanup\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMzgzNTg0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#pullrequestreview-393383584", "createdAt": "2020-04-15T00:33:50Z", "commit": {"oid": "0f0b2da8a705c072bdd028018ebb5a376231041a"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwMDozMzo1MVrOGFls_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwMDozNTo1MlrOGFlu8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxMzc5MQ==", "bodyText": "to-do: Set to \"-7 days\"", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r408513791", "createdAt": "2020-04-15T00:33:51Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,40 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Cleans up old master images\"\n+          command: |\n+            DELETE_BEFORE=$(date --utc -d \"-2 hours\" '+%FT%TZ')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f0b2da8a705c072bdd028018ebb5a376231041a"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxMzkxNA==", "bodyText": "remove echo of command", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r408513914", "createdAt": "2020-04-15T00:34:14Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,40 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Cleans up old master images\"\n+          command: |\n+            DELETE_BEFORE=$(date --utc -d \"-2 hours\" '+%FT%TZ')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            echo List tags command: gcloud container images list-tags ${IMAGE_PATH} \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f0b2da8a705c072bdd028018ebb5a376231041a"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxNDA4MA==", "bodyText": "remove \"echo Command: \" once filter logic is confirmed to do deletes", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r408514080", "createdAt": "2020-04-15T00:34:56Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,40 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Cleans up old master images\"\n+          command: |\n+            DELETE_BEFORE=$(date --utc -d \"-2 hours\" '+%FT%TZ')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            echo List tags command: gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"'tags:image* AND timestamp.datetime < ${DELETE_BEFORE}'\" \\\n+              --format=\"'get(digest)'\"\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:image* AND timestamp.datetime < ${DELETE_BEFORE}\" \\\n+              --format=\"get(digest)\")\n+            for digest in ${OLD_IMAGES[*]}; do\n+            (\n+              echo Delete image: \"${IMAGE_PATH}@${digest}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f0b2da8a705c072bdd028018ebb5a376231041a"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxNDE2Mw==", "bodyText": "remove image-deploy-cleanup and leave only master", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r408514163", "createdAt": "2020-04-15T00:35:18Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -66,7 +98,10 @@ workflows:\n             - build_rest\n           filters:\n             branches:\n-              ignore: /.*/\n+              only:\n+                - master\n+                # image-deploy-cleanup branch present for testing to be removed\n+                - image-deploy-cleanup", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f0b2da8a705c072bdd028018ebb5a376231041a"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxNDI5MQ==", "bodyText": "set tag filter to be \"master-\" instead of current \"image\"", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r408514291", "createdAt": "2020-04-15T00:35:52Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,40 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Cleans up old master images\"\n+          command: |\n+            DELETE_BEFORE=$(date --utc -d \"-2 hours\" '+%FT%TZ')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            echo List tags command: gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"'tags:image* AND timestamp.datetime < ${DELETE_BEFORE}'\" \\\n+              --format=\"'get(digest)'\"\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:image* AND timestamp.datetime < ${DELETE_BEFORE}\" \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f0b2da8a705c072bdd028018ebb5a376231041a"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2601f68013d33373c5465ef9b412635e9511e2f9", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2601f68013d33373c5465ef9b412635e9511e2f9", "committedDate": "2020-04-15T01:59:57Z", "message": "4 hours ago test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "528db9c12a7fa760a16a695c3dc0d6d7c8328022", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/528db9c12a7fa760a16a695c3dc0d6d7c8328022", "committedDate": "2020-04-15T04:15:06Z", "message": "6 hours test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77b5a9a1bfd1e68d5106f6d35e06d08c50321f01", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/77b5a9a1bfd1e68d5106f6d35e06d08c50321f01", "committedDate": "2020-04-15T04:34:05Z", "message": "6 hours test 2\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8c881984fc71d7f4097d5cfa044639b73d2abf5", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e8c881984fc71d7f4097d5cfa044639b73d2abf5", "committedDate": "2020-04-15T13:36:34Z", "message": "14 hours test 1\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f8cb5433d9c96eb1cc760ab8cda936867bdee70", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6f8cb5433d9c96eb1cc760ab8cda936867bdee70", "committedDate": "2020-04-15T13:38:37Z", "message": "14 hours test 2\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7935c729ccf3172a280c80cd2b24d9ad82ca85f9", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/7935c729ccf3172a280c80cd2b24d9ad82ca85f9", "committedDate": "2020-04-15T13:49:12Z", "message": "14 hours test 3\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12b112d5c78b2d145955d48e15daead8ba68c7b6", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/12b112d5c78b2d145955d48e15daead8ba68c7b6", "committedDate": "2020-04-15T15:01:51Z", "message": "Use csv formatting to get digest and timestamp\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ccda0c65616da534440e0a1686a742fa4eebeed", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5ccda0c65616da534440e0a1686a742fa4eebeed", "committedDate": "2020-04-15T15:20:38Z", "message": "Escape cahrs for v2.1\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60598c66cd023e8d6af4e5adbae01e5b0b7e6e93", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/60598c66cd023e8d6af4e5adbae01e5b0b7e6e93", "committedDate": "2020-04-15T15:35:01Z", "message": "removed braces\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98f7d46f1976c514225e2d347cf13b599a4a7243", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/98f7d46f1976c514225e2d347cf13b599a4a7243", "committedDate": "2020-04-15T15:50:17Z", "message": "Modify date format\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b22efa885c02b5a9e639985263ad72b10f344775", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b22efa885c02b5a9e639985263ad72b10f344775", "committedDate": "2020-04-15T16:01:48Z", "message": "Removed UTC config\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bb0cccd5e82eca14940f9297e3ebb2ae920e29c", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5bb0cccd5e82eca14940f9297e3ebb2ae920e29c", "committedDate": "2020-04-15T16:59:52Z", "message": "Add echo for bash env check\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3ac941d92ea2066093e24815a957294cad9ec82", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f3ac941d92ea2066093e24815a957294cad9ec82", "committedDate": "2020-04-15T17:30:10Z", "message": "Test filter timestamp formats\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c7e56cccd6c017c36a96f6aa7876ea1c3197407", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9c7e56cccd6c017c36a96f6aa7876ea1c3197407", "committedDate": "2020-04-15T17:43:30Z", "message": "Test filter timestamp formats 2\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25ed5923367e40c7ea1ec7a446273a38c13d1768", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/25ed5923367e40c7ea1ec7a446273a38c13d1768", "committedDate": "2020-04-15T17:57:41Z", "message": "7 days ago test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a2fcab53856d11f539bc2c291c815d164ab699e", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2a2fcab53856d11f539bc2c291c815d164ab699e", "committedDate": "2020-04-15T18:07:57Z", "message": "2 days ago test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f9d5281ca52f36879882d5ac664b86d67c1c1d76", "committedDate": "2020-04-15T18:27:50Z", "message": "Removed test branch logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MDgwMjk4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#pullrequestreview-394080298", "createdAt": "2020-04-15T19:42:07Z", "commit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTo0MjowN1rOGGI2qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMDoyNjozMFrOGGKRlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA4OTcwNw==", "bodyText": "just docker.version.tag and docker.latest.tag since tag's and push are orthogonal concepts. You can have tags without needing to push.\nRemove 'push' from the name.\nLet's rename to docker.tag.version and docker.tag.latest", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409089707", "createdAt": "2020-04-15T19:42:07Z", "author": {"login": "apeksharma"}, "path": "pom.xml", "diffHunk": "@@ -55,6 +55,8 @@\n     <properties>\n         <disruptor.version>3.4.2</disruptor.version> <!-- Used for asynchronous logging -->\n         <docker.push.repository>gcr.io/mirrornode</docker.push.repository>\n+        <docker.push.version.tag>${project.version}</docker.push.version.tag>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5MTYwMA==", "bodyText": "no need for profile. Directly override docker.tag.version property from command line.\nhttps://stackoverflow.com/a/13709976/895111", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409091600", "createdAt": "2020-04-15T19:45:53Z", "author": {"login": "apeksharma"}, "path": "pom.xml", "diffHunk": "@@ -84,6 +86,21 @@\n         </dependencies>\n     </dependencyManagement>\n \n+    <profiles>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5NTUzNg==", "bodyText": "Am okay with cleanup on every master commit.\nAlternate suggestion would be to cleanup once every 2 week when version is tagged.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409095536", "createdAt": "2020-04-15T19:53:33Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -75,6 +106,15 @@ workflows:\n               only: /.*/\n             tags:\n               only: /.*/\n+      - cleanup_images:\n+          requires:\n+            - publish_images\n+          filters:\n+            branches:\n+              only:\n+                - master", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5NjM5NQ==", "bodyText": "should be 2\nhttps://circleci.com/docs/2.0/configuration-reference/#version-1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409096395", "createdAt": "2020-04-15T19:55:03Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:master-* AND timestamp.datetime < '${DELETE_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,timestamp)\")\n+            echo OLD_IMAGES: ${OLD_IMAGES}\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest timestamp \\<<< ${image}\n+              echo Delete image: \"${IMAGE_PATH}@${digest} created on ${timestamp}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"\n+            )\n+            done\n+\n workflows:\n-  version: 2\n+  version: 2.1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5NzUxNw==", "bodyText": "line not needed.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409097517", "createdAt": "2020-04-15T19:57:09Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -235,5 +275,26 @@ jobs:\n       - *restore_maven_cache\n       - run:\n           name: Running maven deploy\n-          command: ./mvnw ${MAVEN_CLI_OPTS} deploy -DskipTests\n+          command: |\n+            DOCKERPUSHTAG=", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5OTEyNQ==", "bodyText": "After the pom profile is removed, we should override docker.tag.version here only if DOCKERPUSHTAG is set.\nnit: Rename the variable to DOCKER_TAG_VERSION_OVERRIDE", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409099125", "createdAt": "2020-04-15T20:00:08Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -235,5 +275,26 @@ jobs:\n       - *restore_maven_cache\n       - run:\n           name: Running maven deploy\n-          command: ./mvnw ${MAVEN_CLI_OPTS} deploy -DskipTests\n+          command: |\n+            DOCKERPUSHTAG=\n+            if [ \"$CIRCLE_BRANCH\" = \"master\" ]; then\n+                DOCKERPUSHTAG=${CIRCLE_BRANCH}-${CIRCLE_SHA1}\n+            fi\n+            echo DOCKERPUSHTAG: ${DOCKERPUSHTAG}\n+            ./mvnw ${MAVEN_CLI_OPTS} deploy -DskipTests -Dcircle.docker.tag=${DOCKERPUSHTAG}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwMzQ4Nw==", "bodyText": "what does this output?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409103487", "createdAt": "2020-04-15T20:08:10Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwNTE5NQ==", "bodyText": "you can add set -x at the top, very helpful in debugging. Then no need to echo each variable.\nWe can leave it there, no need to remove before committing since the output will be tiny and useful.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409105195", "createdAt": "2020-04-15T20:11:34Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwNzIzOA==", "bodyText": "there is no need for a limit here in our case, so we should not put one.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409107238", "createdAt": "2020-04-15T20:15:19Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwOTkwNg==", "bodyText": "When we tag a version, it'll create image with same sha, and tag an existing image (pushed as master-<sha>) with vX.Y.Z). Wouldn't --force-delete-tags` remove that image too? We want to keep around images for released versions.\nIrrespective, --force-delete-tags is dangerous in first iteration, let's remove it.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409109906", "createdAt": "2020-04-15T20:20:38Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:master-* AND timestamp.datetime < '${DELETE_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,timestamp)\")\n+            echo OLD_IMAGES: ${OLD_IMAGES}\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest timestamp \\<<< ${image}\n+              echo Delete image: \"${IMAGE_PATH}@${digest} created on ${timestamp}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTExMjk4Mw==", "bodyText": "A better way would be:\n\nuntag all master-<sha> older than 7 days.\nDelete all untagged images", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409112983", "createdAt": "2020-04-15T20:26:30Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:master-* AND timestamp.datetime < '${DELETE_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,timestamp)\")\n+            echo OLD_IMAGES: ${OLD_IMAGES}\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest timestamp \\<<< ${image}\n+              echo Delete image: \"${IMAGE_PATH}@${digest} created on ${timestamp}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwOTkwNg=="}, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56e0d77d708f5e81cc9ab22351455d9e98fb34ac", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/56e0d77d708f5e81cc9ab22351455d9e98fb34ac", "committedDate": "2020-04-16T01:29:38Z", "message": "Addressed feedback and added publsih test logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03763b1cf1b0bd693e6718e28e10e3c6b6e2930f", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/03763b1cf1b0bd693e6718e28e10e3c6b6e2930f", "committedDate": "2020-04-16T01:37:36Z", "message": "Removed branch publish test logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19091e1de2451c284b2e83937beb6a69553c76b6", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/19091e1de2451c284b2e83937beb6a69553c76b6", "committedDate": "2020-04-16T16:00:42Z", "message": "Add untag logic and modify delete to delete untagged\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "face7169a04da01326ff2d82340092dd46a38090", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/face7169a04da01326ff2d82340092dd46a38090", "committedDate": "2020-04-16T16:50:05Z", "message": "24 hours untag test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9aa2091b5c9b033b6a198a28c1efba5924f44108", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9aa2091b5c9b033b6a198a28c1efba5924f44108", "committedDate": "2020-04-16T17:26:50Z", "message": "24 hours untag test 2\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0585ba0c44abf7701f0c3cce31e065c1a6e17c1e", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0585ba0c44abf7701f0c3cce31e065c1a6e17c1e", "committedDate": "2020-04-16T17:50:36Z", "message": "Fix tag filter\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5942c819449ac90f867cbd0ae952d6db4bf3953", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b5942c819449ac90f867cbd0ae952d6db4bf3953", "committedDate": "2020-04-16T18:10:21Z", "message": "Real untag clean up 24 hours\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bcda62f8ba20604f34786105250fb818bbb133b", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2bcda62f8ba20604f34786105250fb818bbb133b", "committedDate": "2020-04-16T18:43:16Z", "message": "Add quiet option to untag\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0861861389d62064a330e1f8fd1cdf279a81d14b", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0861861389d62064a330e1f8fd1cdf279a81d14b", "committedDate": "2020-04-16T20:44:04Z", "message": "Pull sha format for delete, no need for timestamp\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5152f1ba7ed6bd718e84f0734ecab59bb76a4b33", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5152f1ba7ed6bd718e84f0734ecab59bb76a4b33", "committedDate": "2020-04-16T21:00:07Z", "message": "3 hours ago test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0OTkxOTE0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#pullrequestreview-394991914", "createdAt": "2020-04-16T20:55:03Z", "commit": {"oid": "0861861389d62064a330e1f8fd1cdf279a81d14b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMDo1NTowM1rOGG2zJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMTozMDo1NVrOGG34jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg0MjQ2OA==", "bodyText": "We should add *.yaml as well", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409842468", "createdAt": "2020-04-16T20:55:03Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/.prettierignore", "diffHunk": "@@ -3,4 +3,5 @@ charts/**\n hedera-mirror-importer/**\n hedera-mirror-grpc/**\n hedera-mirror-datagenerator/**\n+*.yml", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0861861389d62064a330e1f8fd1cdf279a81d14b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1Mzc1Mw==", "bodyText": "Should be set -ex to fail fast", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409853753", "createdAt": "2020-04-16T21:17:27Z", "author": {"login": "steven-sheehy"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,6 +35,55 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_untag:\n+    description: \"Untags old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Untags old master images\"\n+          command: |\n+            set -x\n+            UNTAG_BEFORE=$(date -d \"-3 hours\" '+%FT%T')\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:image-* AND timestamp.datetime < '${UNTAG_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,tags,timestamp)\")\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest tag timestamp \\<<< ${image}\n+              gcloud container images untag -q \"${IMAGE_PATH}:${tag}\"\n+            )\n+            done\n+  gcloud_image_delete:\n+    description: \"Deletes old untagged images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Deletes old untagged images\"\n+          command: |\n+            set -x", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5152f1ba7ed6bd718e84f0734ecab59bb76a4b33"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1Mzc5NA==", "bodyText": "Should be set -ex to fail fast", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409853794", "createdAt": "2020-04-16T21:17:32Z", "author": {"login": "steven-sheehy"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,6 +35,55 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_untag:\n+    description: \"Untags old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Untags old master images\"\n+          command: |\n+            set -x", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5152f1ba7ed6bd718e84f0734ecab59bb76a4b33"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2MDIzOA==", "bodyText": "Technically we can just untag and then directly delete, right? Then we shouldn't really need gcloud_image_delete as all images should be tagged going forward. Would prefer to combine the two functions somehow.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409860238", "createdAt": "2020-04-16T21:30:55Z", "author": {"login": "steven-sheehy"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,6 +35,55 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_untag:\n+    description: \"Untags old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Untags old master images\"\n+          command: |\n+            set -x\n+            UNTAG_BEFORE=$(date -d \"-3 hours\" '+%FT%T')\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:image-* AND timestamp.datetime < '${UNTAG_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,tags,timestamp)\")\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest tag timestamp \\<<< ${image}\n+              gcloud container images untag -q \"${IMAGE_PATH}:${tag}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5152f1ba7ed6bd718e84f0734ecab59bb76a4b33"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc2f662230aae819bc88e7a39fa6b6fb6605427c", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/dc2f662230aae819bc88e7a39fa6b6fb6605427c", "committedDate": "2020-04-16T22:56:09Z", "message": " Address fedback and remove brnach logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NjgxOTcw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#pullrequestreview-395681970", "createdAt": "2020-04-17T18:29:20Z", "commit": {"oid": "dc2f662230aae819bc88e7a39fa6b6fb6605427c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxODoyOToyMFrOGHYwNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxODoyOToyMFrOGHYwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM5ODc3NA==", "bodyText": "We probably don't need to cleanup images on tags, just master commits, right?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r410398774", "createdAt": "2020-04-17T18:29:20Z", "author": {"login": "steven-sheehy"}, "path": ".circleci/config.yml", "diffHunk": "@@ -75,6 +125,15 @@ workflows:\n               only: /.*/\n             tags:\n               only: /.*/\n+      - cleanup_images:\n+          requires:\n+            - publish_images\n+          filters:\n+            branches:\n+              only:\n+                - master\n+            tags:\n+              only: /^.*/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc2f662230aae819bc88e7a39fa6b6fb6605427c"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NjgyODgx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#pullrequestreview-395682881", "createdAt": "2020-04-17T18:30:43Z", "commit": {"oid": "dc2f662230aae819bc88e7a39fa6b6fb6605427c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58a9f14357fe26cb99e5d0fb12e6ad051fe9b35a", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/58a9f14357fe26cb99e5d0fb12e6ad051fe9b35a", "committedDate": "2020-04-17T21:24:17Z", "message": "Removed tag filter for cleanup_images\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NzgyOTQ4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#pullrequestreview-395782948", "createdAt": "2020-04-17T21:27:27Z", "commit": {"oid": "58a9f14357fe26cb99e5d0fb12e6ad051fe9b35a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3070, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}