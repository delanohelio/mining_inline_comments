{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0NTU0MTk1", "number": 1334, "title": "Fix slow transactions query", "bodyText": "Detailed description:\nThis PR addresses the slow query issue exposed on testing dataset.\n\nAdd timestamp conditions to the transaction table in the transactions inner query\n\nWhich issue(s) this PR fixes:\nFixes #\nSpecial notes for your reviewer:\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-12-08T16:06:20Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1334", "merged": true, "mergeCommit": {"oid": "c8f56f9cf24770eb8d833ececd748678b30bd79c"}, "closed": true, "closedAt": "2020-12-08T22:54:44Z", "author": {"login": "xin-hedera"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkMWUigH2gAyNTM0NTU0MTk1OjVhZmEyZDNkOTJlMjQ5ZWM3NmE1MDgxOTRkZDc4NTAzY2Y1NDUxM2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkQ2MXgFqTU0NzYzODUyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5afa2d3d92e249ec76a508194dd78503cf54513e", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5afa2d3d92e249ec76a508194dd78503cf54513e", "committedDate": "2020-12-08T16:01:45Z", "message": "add timestamp conditions to the where condition for the transaction table in transactions inner query\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NDE1Nzc5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1334#pullrequestreview-547415779", "createdAt": "2020-12-08T16:38:51Z", "commit": {"oid": "5afa2d3d92e249ec76a508194dd78503cf54513e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNjozODo1MVrOIBoQdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNjo0NjoyMlrOIBoxVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU3OTA2MQ==", "bodyText": "q: why use a string replace on an existing query vs calling utils.parseTimestampQueryParam()?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1334#discussion_r538579061", "createdAt": "2020-12-08T16:38:51Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -195,8 +195,9 @@ const getTransactionsInnerQuery = function (\n   transactionTypeQuery,\n   order\n ) {\n-  const whereClause = buildWhereClause(resultTypeQuery, transactionTypeQuery);\n-  const ctlWhereClause = buildWhereClause(accountQuery, tsQuery, creditDebitQuery);\n+  const whereClause = buildWhereClause(tsQuery, resultTypeQuery, transactionTypeQuery);\n+  const ctlTsQuery = tsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5afa2d3d92e249ec76a508194dd78503cf54513e"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU4NzQ3Ng==", "bodyText": "nit: doesn't have to be in this PR but should we have a utils method that takes in an array of params and combines them using the above concat logic.\nThat way this line and the line 218 in accounts and other places could just call that and code doesn't grow longer for each new set of params.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1334#discussion_r538587476", "createdAt": "2020-12-08T16:46:22Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -218,11 +219,11 @@ const reqToSql = function (req) {\n   const parsedQueryParams = req.query;\n   const [creditDebitQuery] = utils.parseCreditDebitParams(parsedQueryParams, 'ctl.amount');\n   const [accountQuery, accountParams] = utils.parseAccountIdQueryParam(parsedQueryParams, 'ctl.entity_id');\n-  const [tsQuery, tsParams] = utils.parseTimestampQueryParam(parsedQueryParams, 'ctl.consensus_timestamp');\n+  const [tsQuery, tsParams] = utils.parseTimestampQueryParam(parsedQueryParams, 't.consensus_ns');\n   const resultTypeQuery = utils.parseResultParams(req, 't.result');\n   const transactionTypeQuery = utils.getTransactionTypeQuery(parsedQueryParams);\n   const {query, params, order, limit} = utils.parseLimitAndOrderParams(req);\n-  const sqlParams = accountParams.concat(tsParams).concat(params);\n+  const sqlParams = accountParams.concat(tsParams).concat(tsParams).concat(params);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5afa2d3d92e249ec76a508194dd78503cf54513e"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NTIwNjY4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1334#pullrequestreview-547520668", "createdAt": "2020-12-08T18:40:14Z", "commit": {"oid": "5afa2d3d92e249ec76a508194dd78503cf54513e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NjAzMjIx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1334#pullrequestreview-547603221", "createdAt": "2020-12-08T20:28:12Z", "commit": {"oid": "5afa2d3d92e249ec76a508194dd78503cf54513e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NjM4NTI0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1334#pullrequestreview-547638524", "createdAt": "2020-12-08T21:16:11Z", "commit": {"oid": "5afa2d3d92e249ec76a508194dd78503cf54513e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3400, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}