{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM3MTU3MzM1", "number": 1347, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDowMTo0NlrOFEKReA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDowODoxNVrOFEKgGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5OTA2OTM2OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-monitor/src/main/java/com/hedera/mirror/monitor/publish/PublishMetrics.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDowMTo0NlrOIEJ5DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDo1Mjo0NlrOIEM8ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIyNzI3Ng==", "bodyText": "q: we use nanos (TimeGauge) and milliseconds (Timers).\nDoes this mean the graphs have differing precisions or is this to comply with the metrics calculation defaults?\nWondering why differing precisions are interpreted and whether we consider standardizing it?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1347#discussion_r541227276", "createdAt": "2020-12-11T20:01:46Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-monitor/src/main/java/com/hedera/mirror/monitor/publish/PublishMetrics.java", "diffHunk": "@@ -86,22 +91,49 @@ public PublishResponse record(PublishRequest publishRequest,\n             log.debug(\"{} submitting {} transaction: {}\", status, type, e.getMessage());\n             throw new PublishException(e);\n         } finally {\n-            long endTime = System.currentTimeMillis();\n-            Tags tags = new Tags(status, type);\n-            Timer timer = timers.computeIfAbsent(tags, this::newTimer);\n-            timer.record(endTime - startTime, TimeUnit.MILLISECONDS);\n+            long endTime = response != null ? response.getTimestamp().toEpochMilli() : System.currentTimeMillis();\n+            String scenarioName = publishRequest.getScenarioName();\n+            Tags tags = new Tags(scenarioName, status, type);\n+            Timer submitTimer = submitTimers.computeIfAbsent(tags, this::newSubmitMetric);\n+            submitTimer.record(endTime - startTime, TimeUnit.MILLISECONDS);\n+            durationGauges.computeIfAbsent(tags, this::newDurationMetric);\n+\n+            if (response != null && response.getReceipt() != null) {\n+                long elapsed = System.currentTimeMillis() - startTime;\n+                Timer handleTimer = handleTimers.computeIfAbsent(tags, this::newHandleMetric);\n+                handleTimer.record(elapsed, TimeUnit.MILLISECONDS);\n+            }\n \n             if (!SUCCESS.equals(status)) {\n                 errors.add(status);\n             }\n         }\n     }\n \n-    private Timer newTimer(Tags tags) {\n-        return Timer.builder(\"hedera.mirror.monitor.publish\")\n-                .description(\"The time it takes to publish a transaction\")\n-                .tag(\"status\", tags.getStatus())\n-                .tag(\"type\", tags.getType().toString())\n+    private TimeGauge newDurationMetric(Tags tags) {\n+        TimeUnit unit = TimeUnit.NANOSECONDS;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0fdb793d37d99f300e8294181fd99e9287cc89c"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI1NjgzNA==", "bodyText": "You can record times in any unit. The datastore specific MeterRegistry will normalize it to what is supported for that datastore. You can see this in the different implementations of MeterRegistry.getBaseTimeUnit(). Prometheus supports second resolution while Elastic supports milliseconds.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1347#discussion_r541256834", "createdAt": "2020-12-11T20:30:39Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-monitor/src/main/java/com/hedera/mirror/monitor/publish/PublishMetrics.java", "diffHunk": "@@ -86,22 +91,49 @@ public PublishResponse record(PublishRequest publishRequest,\n             log.debug(\"{} submitting {} transaction: {}\", status, type, e.getMessage());\n             throw new PublishException(e);\n         } finally {\n-            long endTime = System.currentTimeMillis();\n-            Tags tags = new Tags(status, type);\n-            Timer timer = timers.computeIfAbsent(tags, this::newTimer);\n-            timer.record(endTime - startTime, TimeUnit.MILLISECONDS);\n+            long endTime = response != null ? response.getTimestamp().toEpochMilli() : System.currentTimeMillis();\n+            String scenarioName = publishRequest.getScenarioName();\n+            Tags tags = new Tags(scenarioName, status, type);\n+            Timer submitTimer = submitTimers.computeIfAbsent(tags, this::newSubmitMetric);\n+            submitTimer.record(endTime - startTime, TimeUnit.MILLISECONDS);\n+            durationGauges.computeIfAbsent(tags, this::newDurationMetric);\n+\n+            if (response != null && response.getReceipt() != null) {\n+                long elapsed = System.currentTimeMillis() - startTime;\n+                Timer handleTimer = handleTimers.computeIfAbsent(tags, this::newHandleMetric);\n+                handleTimer.record(elapsed, TimeUnit.MILLISECONDS);\n+            }\n \n             if (!SUCCESS.equals(status)) {\n                 errors.add(status);\n             }\n         }\n     }\n \n-    private Timer newTimer(Tags tags) {\n-        return Timer.builder(\"hedera.mirror.monitor.publish\")\n-                .description(\"The time it takes to publish a transaction\")\n-                .tag(\"status\", tags.getStatus())\n-                .tag(\"type\", tags.getType().toString())\n+    private TimeGauge newDurationMetric(Tags tags) {\n+        TimeUnit unit = TimeUnit.NANOSECONDS;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIyNzI3Ng=="}, "originalCommit": {"oid": "d0fdb793d37d99f300e8294181fd99e9287cc89c"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI1ODk0NA==", "bodyText": "I should note that it's still a double value for Timers. So a double value measured in seconds can still give you lower than second granularity.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1347#discussion_r541258944", "createdAt": "2020-12-11T20:32:58Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-monitor/src/main/java/com/hedera/mirror/monitor/publish/PublishMetrics.java", "diffHunk": "@@ -86,22 +91,49 @@ public PublishResponse record(PublishRequest publishRequest,\n             log.debug(\"{} submitting {} transaction: {}\", status, type, e.getMessage());\n             throw new PublishException(e);\n         } finally {\n-            long endTime = System.currentTimeMillis();\n-            Tags tags = new Tags(status, type);\n-            Timer timer = timers.computeIfAbsent(tags, this::newTimer);\n-            timer.record(endTime - startTime, TimeUnit.MILLISECONDS);\n+            long endTime = response != null ? response.getTimestamp().toEpochMilli() : System.currentTimeMillis();\n+            String scenarioName = publishRequest.getScenarioName();\n+            Tags tags = new Tags(scenarioName, status, type);\n+            Timer submitTimer = submitTimers.computeIfAbsent(tags, this::newSubmitMetric);\n+            submitTimer.record(endTime - startTime, TimeUnit.MILLISECONDS);\n+            durationGauges.computeIfAbsent(tags, this::newDurationMetric);\n+\n+            if (response != null && response.getReceipt() != null) {\n+                long elapsed = System.currentTimeMillis() - startTime;\n+                Timer handleTimer = handleTimers.computeIfAbsent(tags, this::newHandleMetric);\n+                handleTimer.record(elapsed, TimeUnit.MILLISECONDS);\n+            }\n \n             if (!SUCCESS.equals(status)) {\n                 errors.add(status);\n             }\n         }\n     }\n \n-    private Timer newTimer(Tags tags) {\n-        return Timer.builder(\"hedera.mirror.monitor.publish\")\n-                .description(\"The time it takes to publish a transaction\")\n-                .tag(\"status\", tags.getStatus())\n-                .tag(\"type\", tags.getType().toString())\n+    private TimeGauge newDurationMetric(Tags tags) {\n+        TimeUnit unit = TimeUnit.NANOSECONDS;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIyNzI3Ng=="}, "originalCommit": {"oid": "d0fdb793d37d99f300e8294181fd99e9287cc89c"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI3NzM3MA==", "bodyText": "Sounds good", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1347#discussion_r541277370", "createdAt": "2020-12-11T20:52:46Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-monitor/src/main/java/com/hedera/mirror/monitor/publish/PublishMetrics.java", "diffHunk": "@@ -86,22 +91,49 @@ public PublishResponse record(PublishRequest publishRequest,\n             log.debug(\"{} submitting {} transaction: {}\", status, type, e.getMessage());\n             throw new PublishException(e);\n         } finally {\n-            long endTime = System.currentTimeMillis();\n-            Tags tags = new Tags(status, type);\n-            Timer timer = timers.computeIfAbsent(tags, this::newTimer);\n-            timer.record(endTime - startTime, TimeUnit.MILLISECONDS);\n+            long endTime = response != null ? response.getTimestamp().toEpochMilli() : System.currentTimeMillis();\n+            String scenarioName = publishRequest.getScenarioName();\n+            Tags tags = new Tags(scenarioName, status, type);\n+            Timer submitTimer = submitTimers.computeIfAbsent(tags, this::newSubmitMetric);\n+            submitTimer.record(endTime - startTime, TimeUnit.MILLISECONDS);\n+            durationGauges.computeIfAbsent(tags, this::newDurationMetric);\n+\n+            if (response != null && response.getReceipt() != null) {\n+                long elapsed = System.currentTimeMillis() - startTime;\n+                Timer handleTimer = handleTimers.computeIfAbsent(tags, this::newHandleMetric);\n+                handleTimer.record(elapsed, TimeUnit.MILLISECONDS);\n+            }\n \n             if (!SUCCESS.equals(status)) {\n                 errors.add(status);\n             }\n         }\n     }\n \n-    private Timer newTimer(Tags tags) {\n-        return Timer.builder(\"hedera.mirror.monitor.publish\")\n-                .description(\"The time it takes to publish a transaction\")\n-                .tag(\"status\", tags.getStatus())\n-                .tag(\"type\", tags.getType().toString())\n+    private TimeGauge newDurationMetric(Tags tags) {\n+        TimeUnit unit = TimeUnit.NANOSECONDS;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIyNzI3Ng=="}, "originalCommit": {"oid": "d0fdb793d37d99f300e8294181fd99e9287cc89c"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5OTEwNjgwOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-monitor/src/main/java/com/hedera/mirror/monitor/publish/PublishMetrics.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDowODoxNVrOIEKQnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDo1NDozNlrOIEND_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIzMzMxMQ==", "bodyText": "nit: Would it be worth adding a method in this class to give the metric names here?\ne.g.\n...\nString METRIC_NAME_PREFIX = \"hedera.mirror.monitor.publish.\";\n...\npublic static String getMetricName(String postfix) {\n return METRIC_NAME_PREFIX + postfix\n}", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1347#discussion_r541233311", "createdAt": "2020-12-11T20:08:15Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-monitor/src/main/java/com/hedera/mirror/monitor/publish/PublishMetrics.java", "diffHunk": "@@ -86,22 +91,49 @@ public PublishResponse record(PublishRequest publishRequest,\n             log.debug(\"{} submitting {} transaction: {}\", status, type, e.getMessage());\n             throw new PublishException(e);\n         } finally {\n-            long endTime = System.currentTimeMillis();\n-            Tags tags = new Tags(status, type);\n-            Timer timer = timers.computeIfAbsent(tags, this::newTimer);\n-            timer.record(endTime - startTime, TimeUnit.MILLISECONDS);\n+            long endTime = response != null ? response.getTimestamp().toEpochMilli() : System.currentTimeMillis();\n+            String scenarioName = publishRequest.getScenarioName();\n+            Tags tags = new Tags(scenarioName, status, type);\n+            Timer submitTimer = submitTimers.computeIfAbsent(tags, this::newSubmitMetric);\n+            submitTimer.record(endTime - startTime, TimeUnit.MILLISECONDS);\n+            durationGauges.computeIfAbsent(tags, this::newDurationMetric);\n+\n+            if (response != null && response.getReceipt() != null) {\n+                long elapsed = System.currentTimeMillis() - startTime;\n+                Timer handleTimer = handleTimers.computeIfAbsent(tags, this::newHandleMetric);\n+                handleTimer.record(elapsed, TimeUnit.MILLISECONDS);\n+            }\n \n             if (!SUCCESS.equals(status)) {\n                 errors.add(status);\n             }\n         }\n     }\n \n-    private Timer newTimer(Tags tags) {\n-        return Timer.builder(\"hedera.mirror.monitor.publish\")\n-                .description(\"The time it takes to publish a transaction\")\n-                .tag(\"status\", tags.getStatus())\n-                .tag(\"type\", tags.getType().toString())\n+    private TimeGauge newDurationMetric(Tags tags) {\n+        TimeUnit unit = TimeUnit.NANOSECONDS;\n+        return TimeGauge.builder(\"hedera.mirror.monitor.publish.duration\", stopwatch, unit, s -> s.elapsed(unit))\n+                .description(\"The amount of time this scenario has been publishing transactions\")\n+                .tag(Tags.TAG_SCENARIO, tags.getScenarioName())\n+                .tag(Tags.TAG_TYPE, tags.getType().toString())\n+                .register(meterRegistry);\n+    }\n+\n+    private Timer newHandleMetric(Tags tags) {\n+        return Timer.builder(\"hedera.mirror.monitor.publish.handle\")\n+                .description(\"The time it takes from submit to being handled by the main nodes\")\n+                .tag(Tags.TAG_SCENARIO, tags.getScenarioName())\n+                .tag(Tags.TAG_STATUS, tags.getStatus())\n+                .tag(Tags.TAG_TYPE, tags.getType().toString())\n+                .register(meterRegistry);\n+    }\n+\n+    private Timer newSubmitMetric(Tags tags) {\n+        return Timer.builder(\"hedera.mirror.monitor.publish.submit\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0fdb793d37d99f300e8294181fd99e9287cc89c"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI3OTIzMA==", "bodyText": "I think that makes it less readable", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1347#discussion_r541279230", "createdAt": "2020-12-11T20:54:36Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-monitor/src/main/java/com/hedera/mirror/monitor/publish/PublishMetrics.java", "diffHunk": "@@ -86,22 +91,49 @@ public PublishResponse record(PublishRequest publishRequest,\n             log.debug(\"{} submitting {} transaction: {}\", status, type, e.getMessage());\n             throw new PublishException(e);\n         } finally {\n-            long endTime = System.currentTimeMillis();\n-            Tags tags = new Tags(status, type);\n-            Timer timer = timers.computeIfAbsent(tags, this::newTimer);\n-            timer.record(endTime - startTime, TimeUnit.MILLISECONDS);\n+            long endTime = response != null ? response.getTimestamp().toEpochMilli() : System.currentTimeMillis();\n+            String scenarioName = publishRequest.getScenarioName();\n+            Tags tags = new Tags(scenarioName, status, type);\n+            Timer submitTimer = submitTimers.computeIfAbsent(tags, this::newSubmitMetric);\n+            submitTimer.record(endTime - startTime, TimeUnit.MILLISECONDS);\n+            durationGauges.computeIfAbsent(tags, this::newDurationMetric);\n+\n+            if (response != null && response.getReceipt() != null) {\n+                long elapsed = System.currentTimeMillis() - startTime;\n+                Timer handleTimer = handleTimers.computeIfAbsent(tags, this::newHandleMetric);\n+                handleTimer.record(elapsed, TimeUnit.MILLISECONDS);\n+            }\n \n             if (!SUCCESS.equals(status)) {\n                 errors.add(status);\n             }\n         }\n     }\n \n-    private Timer newTimer(Tags tags) {\n-        return Timer.builder(\"hedera.mirror.monitor.publish\")\n-                .description(\"The time it takes to publish a transaction\")\n-                .tag(\"status\", tags.getStatus())\n-                .tag(\"type\", tags.getType().toString())\n+    private TimeGauge newDurationMetric(Tags tags) {\n+        TimeUnit unit = TimeUnit.NANOSECONDS;\n+        return TimeGauge.builder(\"hedera.mirror.monitor.publish.duration\", stopwatch, unit, s -> s.elapsed(unit))\n+                .description(\"The amount of time this scenario has been publishing transactions\")\n+                .tag(Tags.TAG_SCENARIO, tags.getScenarioName())\n+                .tag(Tags.TAG_TYPE, tags.getType().toString())\n+                .register(meterRegistry);\n+    }\n+\n+    private Timer newHandleMetric(Tags tags) {\n+        return Timer.builder(\"hedera.mirror.monitor.publish.handle\")\n+                .description(\"The time it takes from submit to being handled by the main nodes\")\n+                .tag(Tags.TAG_SCENARIO, tags.getScenarioName())\n+                .tag(Tags.TAG_STATUS, tags.getStatus())\n+                .tag(Tags.TAG_TYPE, tags.getType().toString())\n+                .register(meterRegistry);\n+    }\n+\n+    private Timer newSubmitMetric(Tags tags) {\n+        return Timer.builder(\"hedera.mirror.monitor.publish.submit\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIzMzMxMQ=="}, "originalCommit": {"oid": "d0fdb793d37d99f300e8294181fd99e9287cc89c"}, "originalPosition": 84}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1327, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}