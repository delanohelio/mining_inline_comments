{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4MjgxODQw", "number": 1014, "title": "Splitting health check into liveness and readiness checks", "bodyText": "Detailed description:\n\nAdded Spring Boot Actuator readiness and liveness endpoints to Importer and GRPC\nAdded readiness and liveness checks to REST via Terminus\nAdded graceful shutdown config to Importer, GRPC, and REST\nAltered Helm charts to make use of the new readiness and liveness checks.\n\nWhich issue(s) this PR fixes:\nFixes #777\nSpecial notes for your reviewer:\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-09-03T01:26:37Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1014", "merged": true, "mergeCommit": {"oid": "cc5f10bcb75ec9abb0cd66bd46f536d1f6d7bf07"}, "closed": true, "closedAt": "2020-09-11T00:26:29Z", "author": {"login": "ijungmann"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFGRZEgH2gAyNDc4MjgxODQwOjJhNGZmOWYzZTQwMWFhZDAyMmNmYmNkY2M1YmY0MGU0YzEwNGFiZTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHo3hQgFqTQ4NjM2Mzc5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2a4ff9f3e401aad022cfbcdcc5bf40e4c104abe3", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2a4ff9f3e401aad022cfbcdcc5bf40e4c104abe3", "committedDate": "2020-09-03T01:25:17Z", "message": "Splitting health check into liveness and readiness checks\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d1230cbab7eb6c9034ad5402a5346db503195e1", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5d1230cbab7eb6c9034ad5402a5346db503195e1", "committedDate": "2020-09-08T01:24:27Z", "message": "Config for Importer readiness, liveness checks and graceful shutdown\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "870ca2c38c5b53391848eb12642bd32ba7c8cc77", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/870ca2c38c5b53391848eb12642bd32ba7c8cc77", "committedDate": "2020-09-08T01:27:02Z", "message": "GRPC readiness, liveness checks and graceful shutdown\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df37620721d9593da6126e6eedfa21d3b32a1e62", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/df37620721d9593da6126e6eedfa21d3b32a1e62", "committedDate": "2020-09-08T01:45:00Z", "message": "REST liveness, readiness checks, and graceful shutdown\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b176d0699805550558acd51ff1b623edde0acf5a", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b176d0699805550558acd51ff1b623edde0acf5a", "committedDate": "2020-09-08T01:48:40Z", "message": "Charts to support new health checks on the different modules\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "656236e8a5926ef31a4da011d68cefffd8ee52f6", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/656236e8a5926ef31a4da011d68cefffd8ee52f6", "committedDate": "2020-09-08T01:50:15Z", "message": "Setting grpc health check timeouts back to default until a better baseline is established\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64c6a7da448f6ffe8adad2b6d3c1079a82b89156", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/64c6a7da448f6ffe8adad2b6d3c1079a82b89156", "committedDate": "2020-09-08T16:27:48Z", "message": "Adding ping check to importer health checks\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "734d5d89fa0193d917a99e4946ab1a6f4f81f21d", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/734d5d89fa0193d917a99e4946ab1a6f4f81f21d", "committedDate": "2020-09-08T16:40:03Z", "message": "Adding ping to grpc health endpoints\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NDIwNTA2", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1014#pullrequestreview-484420506", "createdAt": "2020-09-08T19:10:20Z", "commit": {"oid": "734d5d89fa0193d917a99e4946ab1a6f4f81f21d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxOToxMDoyMFrOHOqeqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxOTo0NTozN1rOHOrlJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEzODA4OA==", "bodyText": "The problem here is the probes don't start until Flway migrations complete. So if a migration takes longer than a minute or so the importer will repeatedly crash and never startup. Have to revert this unless you can figure out how to make probes start earlier than Flyway.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1014#discussion_r485138088", "createdAt": "2020-09-08T19:10:20Z", "author": {"login": "steven-sheehy"}, "path": "charts/hedera-mirror-importer/values.yaml", "diffHunk": "@@ -31,13 +31,13 @@ imagePullSecrets: []\n \n labels: {}\n \n-livenessProbe: null\n-#  httpGet:\n-#    path: /actuator/health\n-#    port: http\n-#  initialDelaySeconds: 60\n-#  periodSeconds: 30\n-#  timeoutSeconds: 2\n+livenessProbe:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "734d5d89fa0193d917a99e4946ab1a6f4f81f21d"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE0MjY0Ng==", "bodyText": "We can probably lower the initialDelaySeconds now that it doesn't have to wait for the db to start. Try starting it locally and seeing how long it takes for that endpoint to return 200.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1014#discussion_r485142646", "createdAt": "2020-09-08T19:19:22Z", "author": {"login": "steven-sheehy"}, "path": "charts/hedera-mirror-grpc/values.yaml", "diffHunk": "@@ -60,7 +60,7 @@ labels: {}\n \n livenessProbe:\n   httpGet:\n-    path: /actuator/health\n+    path: /actuator/health/liveness\n     port: http\n   initialDelaySeconds: 45", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "734d5d89fa0193d917a99e4946ab1a6f4f81f21d"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE0MzMyMA==", "bodyText": "We can probably lower the periodSeconds now that we are less likely to crash repeatedly on startup if db is down. Maybe 10s or so", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1014#discussion_r485143320", "createdAt": "2020-09-08T19:20:35Z", "author": {"login": "steven-sheehy"}, "path": "charts/hedera-mirror-grpc/values.yaml", "diffHunk": "@@ -60,7 +60,7 @@ labels: {}\n \n livenessProbe:\n   httpGet:\n-    path: /actuator/health\n+    path: /actuator/health/liveness\n     port: http\n   initialDelaySeconds: 45\n   periodSeconds: 30", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "734d5d89fa0193d917a99e4946ab1a6f4f81f21d"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE0MzczOA==", "bodyText": "Should probably be a little higher like 30-45s", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1014#discussion_r485143738", "createdAt": "2020-09-08T19:21:21Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-grpc/src/main/resources/application.yml", "diffHunk": "@@ -64,6 +72,8 @@ spring:\n       hibernate.criteria.literal_handling_mode: BIND # Ensure Criteria API queries use bind parameters and not literals\n       hibernate.generate_statistics: true\n       hibernate.hbm2ddl.auto: none\n+  lifecycle:\n+    timeout-per-shutdown-phase: 20s", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "734d5d89fa0193d917a99e4946ab1a6f4f81f21d"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE1Mjc3NA==", "bodyText": "This should be configurable", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1014#discussion_r485152774", "createdAt": "2020-09-08T19:39:08Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/health.js", "diffHunk": "@@ -0,0 +1,59 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const transactions = require('./transactions.js');\n+\n+/**\n+ * Function to determine readiness of application.\n+ * @return {} None.\n+ */\n+const readinessCheck = async () => {\n+  return transactions.getOneTransactionForHealthCheck();\n+};\n+\n+/**\n+ * Function to determine liveness of application.\n+ * @return {} None.\n+ */\n+const livenessCheck = async () => {\n+  return;\n+};\n+\n+/**\n+ * Allows for a graceful shutdown.\n+ * @return {} None.\n+ */\n+\n+function beforeDown() {\n+  // given your readiness probes run every 5 second\n+  // may be worth using a bigger number so you won't\n+  // run into any race conditions\n+  console.log('Test of system');\n+  return new Promise((resolve) => {\n+    setTimeout(resolve, 20000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "734d5d89fa0193d917a99e4946ab1a6f4f81f21d"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE1NjEzMw==", "bodyText": "I don't think we need to join from 3 tables for a health check or hit a larger table like transaction. Also, would be better to encapsulate the health check query in health.js. Recommend doing a select true from t_entity_types limit 1; inside health.js and verify return value is 1.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1014#discussion_r485156133", "createdAt": "2020-09-08T19:45:37Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -254,11 +254,40 @@ const getOneTransaction = async (req, res) => {\n     });\n };\n \n+/**\n+ * Function to support readiness check for Terminus, finds one transaction.\n+ * @return {} None.\n+ */\n+const getOneTransactionForHealthCheck = function () {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "734d5d89fa0193d917a99e4946ab1a6f4f81f21d"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d346225f4480e817b07d233615a8fa49ac00682", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6d346225f4480e817b07d233615a8fa49ac00682", "committedDate": "2020-09-09T15:54:55Z", "message": "PR changes for REST\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87696b5686cc51b94332559cea829f1798966477", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/87696b5686cc51b94332559cea829f1798966477", "committedDate": "2020-09-09T17:41:35Z", "message": "Fine tuning health check for GRPC\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32ffacdcf645da686a1074f9ff60ae9f3a730edf", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/32ffacdcf645da686a1074f9ff60ae9f3a730edf", "committedDate": "2020-09-09T17:57:24Z", "message": "Fine tuning REST config for health checks\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MjU0NzMx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1014#pullrequestreview-485254731", "createdAt": "2020-09-09T17:40:54Z", "commit": {"oid": "6d346225f4480e817b07d233615a8fa49ac00682"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzo0MDo1NFrOHPS-Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzo0MDo1NFrOHPS-Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgwMTU3MA==", "bodyText": "Add to docs", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1014#discussion_r485801570", "createdAt": "2020-09-09T17:40:54Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/config/application.yml", "diffHunk": "@@ -32,3 +32,5 @@ hedera:\n           accessKey:\n           secretKey:\n           bucketName:\n+      shutdown:\n+        timeout: 20000", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d346225f4480e817b07d233615a8fa49ac00682"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbb8aaff6641a31debeae2cfa7a29d425512bfba", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/fbb8aaff6641a31debeae2cfa7a29d425512bfba", "committedDate": "2020-09-10T16:53:57Z", "message": "Adding new REST shutdown timeout to config docs\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc01b9b488a31e01ba43e24caf43e8364cdfbd12", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/fc01b9b488a31e01ba43e24caf43e8364cdfbd12", "committedDate": "2020-09-10T16:57:07Z", "message": "Adding new REST shutdown timeout to config docs\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0a7c4ed52631d5002b27532e217b4fbecef355b", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f0a7c4ed52631d5002b27532e217b4fbecef355b", "committedDate": "2020-09-10T16:58:45Z", "message": "Merge branch 'master' into liveness_and_readiness_check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c57a74134cb142fd2d8fa00ea78765c2516ecc4b", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c57a74134cb142fd2d8fa00ea78765c2516ecc4b", "committedDate": "2020-09-10T17:02:14Z", "message": "Cleaning up merge conflict in config docs\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76f7668b09f52caabc4979d28955de279f383d11", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/76f7668b09f52caabc4979d28955de279f383d11", "committedDate": "2020-09-10T17:05:40Z", "message": "Removing liveness check from Importer Helm chart due to actuator and flyway issue\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d5b7958a6de75d521082767d04e862e6ca06950", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1d5b7958a6de75d521082767d04e862e6ca06950", "committedDate": "2020-09-10T17:34:14Z", "message": "Fixing helm chart dependencies to notice the prerelease versions\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7c8e33ab9b81b88fbea927572a0bd2c1cb9c493", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f7c8e33ab9b81b88fbea927572a0bd2c1cb9c493", "committedDate": "2020-09-10T21:15:58Z", "message": "Maven will now set the specific helm chart dependency version for the mirror-node chart\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d0e94500185f0b06b8dcdbaebbebd2fa5b3234b", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2d0e94500185f0b06b8dcdbaebbebd2fa5b3234b", "committedDate": "2020-09-10T21:39:04Z", "message": "Reverting maven regex for chart version update and updating dependencies with quotes\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e8d1ef851f30545a52953548fcb2430834884c5", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3e8d1ef851f30545a52953548fcb2430834884c5", "committedDate": "2020-09-10T21:43:54Z", "message": "Putting postgres chart version back\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MzYzNzk1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1014#pullrequestreview-486363795", "createdAt": "2020-09-10T22:51:33Z", "commit": {"oid": "3e8d1ef851f30545a52953548fcb2430834884c5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3662, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}