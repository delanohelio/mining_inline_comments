{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyNzg1MzU4", "number": 1279, "title": "Enable log alerts and normalize log statements", "bodyText": "Detailed description:\n\nAdd log alerts using Loki 2.0's PrometheusRule compatible alerting\nAdd log alerts that match our equivalent alerts in Google Cloud\nChange Java stacktraces to log as a single line for better compatibility with Loki and Grafana\nChange log statements to log at non-error level when possible\nChange log layout to remove variable spacing and square brackets to make it easier for Loki to parse\nChange gRPC and REST APIs to log client errors at warning level and to not print stacktraces for those\nChange Loki volume size to 100GiB since it ran out of space in the cluster\nFix Downloader repeatedly logging a NoSuchKeyException stacktrace for scenarios where signature consensus is reached before .rcd is uploaded\nFix ImporterBalanceParseLatency alert triggering too often\nFix kubelet alerts triggering since we can't monitor kubelet in GKE\nFix GCP Marketplace install failing due to Redis health check\nFix migration test failing occasionally due to lock issue\nFix monitor container not starting due to liveness probe\nBump all chart dependencies\n\nWhich issue(s) this PR fixes:\nFixes #1218\nSpecial notes for your reviewer:\n\nNote that the log alerts can probably be cleaned up quite a bit but I chose to keep them mostly the same with what we have for now\nfile-verification-errors alerts was not converted to Loki alerts since it is already covered by an existing alert ImporterFileVerificationErrors\n\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-11-18T00:09:01Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1279", "merged": true, "mergeCommit": {"oid": "a7d4932eb9ea4621d184f40c095857f456e7a496"}, "closed": true, "closedAt": "2020-11-19T23:35:22Z", "author": {"login": "steven-sheehy"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddiumvgH2gAyNTIyNzg1MzU4OjQzYzUxODg3MDcyNDE4MTZkOGM4OGE2ZGVhMGI5NmMyODU4YjJhMzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeLam_gFqTUzNDk0MjY3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "43c5188707241816d8c88a6dea0b96c2858b2a36", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/43c5188707241816d8c88a6dea0b96c2858b2a36", "committedDate": "2020-11-18T00:08:43Z", "message": "Enable log alerts and normalize log statements\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef11a6ccf6800cf42858d43e3bee0306f495d943", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ef11a6ccf6800cf42858d43e3bee0306f495d943", "committedDate": "2020-11-18T20:20:51Z", "message": "Minor tweaks\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNzg4NTI4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1279#pullrequestreview-533788528", "createdAt": "2020-11-18T19:10:09Z", "commit": {"oid": "43c5188707241816d8c88a6dea0b96c2858b2a36"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxOToxMDowOVrOH197Pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxOToxOToyM1rOH1-RFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM1MTE2Nw==", "bodyText": "should this port be configureable on it's own and easy to reference by others sections of the code or is okay to have it hard coded here?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1279#discussion_r526351167", "createdAt": "2020-11-18T19:10:09Z", "author": {"login": "Nana-EC"}, "path": "charts/hedera-mirror-common/values.yaml", "diffHunk": "@@ -9,13 +9,111 @@ loki:\n   enabled: true\n   loki:\n     config:\n+      ruler:\n+        alertmanager_url: http://{{ .Release.Name }}-prometheus-alertmanager:9093", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43c5188707241816d8c88a6dea0b96c2858b2a36"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM1Njc1OA==", "bodyText": "String matching on logs seems brittle, as it can change between versions and there's no check to ensure this would be updated.\nIs it possible to apply an exception type filter here instead or in addition to some of these?\nWe might need to update some of the code in that case.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1279#discussion_r526356758", "createdAt": "2020-11-18T19:19:23Z", "author": {"login": "Nana-EC"}, "path": "charts/hedera-mirror-common/values.yaml", "diffHunk": "@@ -9,13 +9,111 @@ loki:\n   enabled: true\n   loki:\n     config:\n+      ruler:\n+        alertmanager_url: http://{{ .Release.Name }}-prometheus-alertmanager:9093\n+        enable_alertmanager_v2: true\n+        enable_api: true\n+        ring:\n+          kvstore:\n+            store: inmemory\n+        rule_path: /tmp/loki\n+        storage:\n+          type: local\n+          local:\n+            directory: /loki/rules\n       table_manager:\n         retention_deletes_enabled: true\n         retention_period: 2184h\n+    extraVolumeMounts:\n+      - name: rules\n+        mountPath: /loki/rules/fake\n+      - name: tmp\n+        mountPath: /tmp/loki\n+    extraVolumes:\n+      - name: rules\n+        configMap:\n+          defaultMode: 420\n+          name: loki-rules\n+      - name: tmp\n+        emptyDir: {}\n     networkPolicy:\n       enabled: true\n     persistence:\n       enabled: true\n+      size: 100Gi\n+    prometheusRules:\n+      # TODO: Enhance Loki to support watching for PrometheusRules via the Kubernetes API so we can declare these within their chart\n+      GrpcLogErrors:\n+        annotations:\n+          description: \"Logs for {{ $labels.namespace }}/{{ $labels.pod }} have reached {{ $value }} error messages/s in a 3m period\"\n+          summary: High rate of errors in logs\n+        enabled: true\n+        expr: >\n+          sum(rate({app_kubernetes_io_component=\"grpc\"}\n+            | regexp `(?P<timestamp>\\S+) (?P<level>\\S+) (?P<thread>\\S+) (?P<class>\\S+) (?P<message>.+)`\n+            | level = \"ERROR\"\n+            != \"reactor.core.publisher\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43c5188707241816d8c88a6dea0b96c2858b2a36"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MDU1Njcz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1279#pullrequestreview-534055673", "createdAt": "2020-11-19T03:27:35Z", "commit": {"oid": "ef11a6ccf6800cf42858d43e3bee0306f495d943"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NjA2NTE3", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1279#pullrequestreview-534606517", "createdAt": "2020-11-19T16:09:16Z", "commit": {"oid": "ef11a6ccf6800cf42858d43e3bee0306f495d943"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d29c78a59de7936a5af86c2574a5f8add88e54a8", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d29c78a59de7936a5af86c2574a5f8add88e54a8", "committedDate": "2020-11-19T21:53:37Z", "message": "Merge remote-tracking branch 'origin/master' into log-alerts\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTQyNjc0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1279#pullrequestreview-534942674", "createdAt": "2020-11-19T23:32:59Z", "commit": {"oid": "d29c78a59de7936a5af86c2574a5f8add88e54a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3523, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}