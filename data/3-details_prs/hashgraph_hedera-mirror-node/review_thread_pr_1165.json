{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3NjYyODUz", "number": 1165, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMToxMToxMVrOEwfMxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNjozMzo0OVrOEw2dbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5Mjc4Mjc5OnYy", "diffSide": "LEFT", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/migration/V1_28_1__Address_BookTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMToxMToxMVrOHmFpHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNjoxODowNlrOHmpt7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcwMDM4Mw==", "bodyText": "This test fails in my local env but not in CircleCI runs. What happened is if the Sql annotations here do not match exactly those in IntegrationTest, springboot test will list all 3 sql scripts and cleanup.sql will run in AFTER_TEST_METHOD phase and errors out since it tries to truncate tables after V1.28.1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1165#discussion_r509700383", "createdAt": "2020-10-21T21:11:11Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/migration/V1_28_1__Address_BookTest.java", "diffHunk": "@@ -48,7 +48,6 @@\n import com.hedera.mirror.importer.repository.FileDataRepository;\n \n @TestPropertySource(properties = \"spring.flyway.target=1.28.0\")\n-@Sql(executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD, scripts = \"classpath:db/scripts/cleanup_V1.28.1.sql\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e7fe84d8a36afcb1217a00ae2177b7966f53cb0"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI5MTQzOA==", "bodyText": "There is an open ticket regarding this confusing behavior:\nhttps://bugs.openjdk.java.net/browse/JDK-8188040\nfor annotations which are both repeatable and inherited", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1165#discussion_r510291438", "createdAt": "2020-10-22T16:18:06Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/migration/V1_28_1__Address_BookTest.java", "diffHunk": "@@ -48,7 +48,6 @@\n import com.hedera.mirror.importer.repository.FileDataRepository;\n \n @TestPropertySource(properties = \"spring.flyway.target=1.28.0\")\n-@Sql(executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD, scripts = \"classpath:db/scripts/cleanup_V1.28.1.sql\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcwMDM4Mw=="}, "originalCommit": {"oid": "4e7fe84d8a36afcb1217a00ae2177b7966f53cb0"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5NjU5MzcyOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/resources/db/scripts/cleanup.sql", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNjozMzo0OVrOHmqXTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNjozMzo0OVrOHmqXTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMwMjAzMA==", "bodyText": "ends up also explicitly acquire the highest level table lock on t_application_status since AddressBookServiceImplTest assumes empty address_book and address_book_entry tables. It's better and easier to maintain a single all-in-one cleanup script instead of creating test class specific cleanup scripts.\nThe lock should have the effect to serialize the t_applications_status update in both this script and the transaction in MirrorDateRangePropertiesProcessor", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1165#discussion_r510302030", "createdAt": "2020-10-22T16:33:49Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/resources/db/scripts/cleanup.sql", "diffHunk": "@@ -9,8 +9,8 @@ TRUNCATE TABLE t_entities RESTART IDENTITY CASCADE;\n TRUNCATE TABLE transaction RESTART IDENTITY CASCADE;\n TRUNCATE TABLE topic_message RESTART IDENTITY CASCADE;\n TRUNCATE TABLE non_fee_transfer;\n-UPDATE t_application_status\n-SET status_value = NULL;\n+LOCK TABLE t_application_status IN ACCESS EXCLUSIVE MODE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d928a26de342c80f7e0efb37ad0f43acd7f350bb"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1578, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}