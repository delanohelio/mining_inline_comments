{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NjAwNjM4", "number": 1091, "title": "Add Redis support to Helm", "bodyText": "Detailed description:\n\nAdd a 3 node Redis cluster with Sentinel sidecar to the chart\nAdd an importer dashboard\nAdd a Redis dashboard\nChange Marketplace to disable Redis and continue to use pgnotify\nChange Pgpool authentication config from a script to a customUsersSecret\nChange to notify via Redis by default\nFix demo network not working by setting startDate to epoch for that network\nFix use of deprecated CircleCI machine image\nFix use of deprecated Helm chart repositories\nUpdate all dependent chart versions to the latest\n\nWhich issue(s) this PR fixes:\nSpecial notes for your reviewer:\nHelm lint check failing due to an issue with the upstream loki-stack chart.\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-10-01T23:30:27Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1091", "merged": true, "mergeCommit": {"oid": "4c9a52260db4391929953445d09ab0f65ffcf3bf"}, "closed": true, "closedAt": "2020-10-05T18:57:03Z", "author": {"login": "steven-sheehy"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOZ5cqgH2gAyNDk2NjAwNjM4OmQ4ZGFkYmI2ODU0YmJiZDNhODg2OGU0NjA2MzVhMzg0MjA2YmQ5YjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPnu6JAFqTUwMjI5NTY4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d8dadbb6854bbbd3a8868e460635a384206bd9b4", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d8dadbb6854bbbd3a8868e460635a384206bd9b4", "committedDate": "2020-10-01T23:22:33Z", "message": "Add redis support to the Helm charts\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwODI5MTIz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1091#pullrequestreview-500829123", "createdAt": "2020-10-02T02:30:41Z", "commit": {"oid": "d8dadbb6854bbbd3a8868e460635a384206bd9b4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwMjozMDo0MVrOHbf2Iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwMjozMDo0MVrOHbf2Iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU5NTM2Mw==", "bodyText": "nit: add a comment to highlight why this is necessary. I'm guessing cause the timestamps are always in the past.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1091#discussion_r498595363", "createdAt": "2020-10-02T02:30:41Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/config/MirrorDateRangePropertiesProcessor.java", "diffHunk": "@@ -196,13 +204,16 @@ private Instant getEffectiveStartDate(DownloaderProperties downloaderProperties)\n \n         if (startDate != null) {\n             return max(startDate.minus(adjustment), lastFileInstant);\n+        } else if (mirrorProperties.getNetwork() == MirrorProperties.HederaNetwork.DEMO) {\n+            return Instant.EPOCH;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8dadbb6854bbbd3a8868e460635a384206bd9b4"}, "originalPosition": 108}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da4c75fcb0009d23a81bd51a22cbbf3ed83ec0dd", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/da4c75fcb0009d23a81bd51a22cbbf3ed83ec0dd", "committedDate": "2020-10-02T03:59:57Z", "message": "Fix tests and review feedback\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "106d1af9fa3486f104ea93c3863fd396b2b08cef", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/106d1af9fa3486f104ea93c3863fd396b2b08cef", "committedDate": "2020-10-02T14:50:58Z", "message": "Fix helm lint\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNDcxMjM1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1091#pullrequestreview-501471235", "createdAt": "2020-10-02T22:03:48Z", "commit": {"oid": "106d1af9fa3486f104ea93c3863fd396b2b08cef"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMjowMzo0OVrOHb8vTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMjowMzo0OVrOHb8vTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA2ODc1MQ==", "bodyText": "prefer not setting the filter if filterStartDate == null, so the filter will be null and later in record parser we hit the fast path instead of checking against the all pass filter.\nif (dateRangeFilter != null && !dateRangeFilter.filter(recordItem.getConsensusTimestamp())) {\n    return false;\n}", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1091#discussion_r499068751", "createdAt": "2020-10-02T22:03:49Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/config/MirrorDateRangePropertiesProcessor.java", "diffHunk": "@@ -131,38 +139,38 @@ private void setDateRangeFilter(DownloaderProperties downloaderProperties) {\n \n         Instant filterStartDate = null;\n         if (startDate != null) {\n-            if (startDate.isAfter(lastFileInstant)) {\n+            if (lastFileInstant != null && startDate.isAfter(lastFileInstant)) {\n                 filterStartDate = startDate;\n             } else if (endDate.isBefore(Utility.MAX_INSTANT_LONG)) {\n                 filterStartDate = lastFileInstant;\n             }\n         } else {\n-            if (lastFileInstant.equals(Instant.EPOCH)) {\n-                filterStartDate = MirrorProperties.getStartUpInstant();;\n+            if (mirrorProperties.getNetwork() != MirrorProperties.HederaNetwork.DEMO && lastFileInstant == null) {\n+                filterStartDate = STARTUP_TIME;\n             } else if (endDate.isBefore(Utility.MAX_INSTANT_LONG)) {\n                 filterStartDate = lastFileInstant;\n             }\n         }\n \n-        if (filterStartDate != null) {\n-            filters.put(downloaderProperties.getStreamType(), new DateRangeFilter(filterStartDate, endDate));\n-        }\n+        filters.put(downloaderProperties.getStreamType(), new DateRangeFilter(filterStartDate, endDate));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "106d1af9fa3486f104ea93c3863fd396b2b08cef"}, "originalPosition": 93}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNTEwMjA5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1091#pullrequestreview-501510209", "createdAt": "2020-10-03T01:29:05Z", "commit": {"oid": "106d1af9fa3486f104ea93c3863fd396b2b08cef"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwMToyOTowNlrOHb-2iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwMTozMzowOVrOHb-35g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwMzM2OQ==", "bodyText": "nit: since lastFileInstant can be null, startDate after adjustment may be before EPOCH and it becomes the effective start date, previous logic would cap effective startdate to >= EPOCH", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1091#discussion_r499103369", "createdAt": "2020-10-03T01:29:06Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/config/MirrorDateRangePropertiesProcessor.java", "diffHunk": "@@ -181,28 +189,39 @@ private void updateApplicationStatus(DownloaderProperties downloaderProperties,\n     }\n \n     /**\n-     * Gets the effective startDate for downloader based on startDate in MirrorProperties, the startDateAdjustment\n-     * and last valid downloaded file.\n+     * Gets the effective startDate for downloader based on startDate in MirrorProperties, the startDateAdjustment and\n+     * last valid downloaded file.\n+     *\n      * @param downloaderProperties The downloader's properties\n      * @return The effective startDate: null if downloader is disabled; if startDate is set, the effective startDate is\n      * startDate if the database is empty or max(startDate, timestamp of last valid downloaded file); if startDate is\n      * not set, the effective startDate is now if the database is empty, or the timestamp of last valid downloaded file\n      */\n     private Instant getEffectiveStartDate(DownloaderProperties downloaderProperties) {\n         Instant startDate = mirrorProperties.getStartDate();\n-        Instant startUpInstant = MirrorProperties.getStartUpInstant();\n+        Instant startUpInstant = STARTUP_TIME;\n         Instant lastFileInstant = getLastValidDownloadedFileInstant(downloaderProperties);\n         Duration adjustment = downloaderProperties.getStartDateAdjustment();\n \n         if (startDate != null) {\n             return max(startDate.minus(adjustment), lastFileInstant);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "106d1af9fa3486f104ea93c3863fd396b2b08cef"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwMzcxOA==", "bodyText": "this will always set application status file name to EPOCH even there is a previous run which has downloaded some files. In that case, when startDate is not set, we should honor the timestamped file name in application status repository", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1091#discussion_r499103718", "createdAt": "2020-10-03T01:33:09Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/config/MirrorDateRangePropertiesProcessor.java", "diffHunk": "@@ -181,28 +189,39 @@ private void updateApplicationStatus(DownloaderProperties downloaderProperties,\n     }\n \n     /**\n-     * Gets the effective startDate for downloader based on startDate in MirrorProperties, the startDateAdjustment\n-     * and last valid downloaded file.\n+     * Gets the effective startDate for downloader based on startDate in MirrorProperties, the startDateAdjustment and\n+     * last valid downloaded file.\n+     *\n      * @param downloaderProperties The downloader's properties\n      * @return The effective startDate: null if downloader is disabled; if startDate is set, the effective startDate is\n      * startDate if the database is empty or max(startDate, timestamp of last valid downloaded file); if startDate is\n      * not set, the effective startDate is now if the database is empty, or the timestamp of last valid downloaded file\n      */\n     private Instant getEffectiveStartDate(DownloaderProperties downloaderProperties) {\n         Instant startDate = mirrorProperties.getStartDate();\n-        Instant startUpInstant = MirrorProperties.getStartUpInstant();\n+        Instant startUpInstant = STARTUP_TIME;\n         Instant lastFileInstant = getLastValidDownloadedFileInstant(downloaderProperties);\n         Duration adjustment = downloaderProperties.getStartDateAdjustment();\n \n         if (startDate != null) {\n             return max(startDate.minus(adjustment), lastFileInstant);\n+        } else if (mirrorProperties.getNetwork() == MirrorProperties.HederaNetwork.DEMO) {\n+            return Instant.EPOCH; // Demo network contains only data in the past, so don't default to now", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "106d1af9fa3486f104ea93c3863fd396b2b08cef"}, "originalPosition": 145}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c28d7a45d7f76c57ee851e653578c804b95c9ca7", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c28d7a45d7f76c57ee851e653578c804b95c9ca7", "committedDate": "2020-10-05T16:25:42Z", "message": "Address review feedback\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMjk1Njgx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1091#pullrequestreview-502295681", "createdAt": "2020-10-05T18:03:38Z", "commit": {"oid": "c28d7a45d7f76c57ee851e653578c804b95c9ca7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3575, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}