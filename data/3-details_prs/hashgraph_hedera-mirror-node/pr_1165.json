{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3NjYyODUz", "number": 1165, "title": "Fix postgresql deadlock in integration tests", "bodyText": "Detailed description:\nIn cleanup.sql, lock t_application_status table in ACCESS EXCLUSIVE mode to prevent the updates in the script and MirrorDateRangePropertiesProcessor interleaving then running into deadlock.\nWhich issue(s) this PR fixes:\nFixes #1164\nSpecial notes for your reviewer:\nOutdated: The BEFORE_TEST_METHOD sql script seems unnecessary. The other option is explicitly acquire a table lock in cleanup.sql so the updates to t_application_status are serialized.\nChanged to add explicit lock in cleanup.sql.\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-10-21T15:53:14Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1165", "merged": true, "mergeCommit": {"oid": "3306e3816c28f151c87c3e142fdc010c2bd89892"}, "closed": true, "closedAt": "2020-10-22T17:30:25Z", "author": {"login": "xin-hedera"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUuw5rAH2gAyNTA3NjYyODUzOmU5ZDRjY2U1ZThiYTQwNzIxYjI1Mzk3MTJlODdjMzNkNDA2NTFlNjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVFWJxAFqTUxNDk1NzA4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e9d4cce5e8ba40721b2539712e87c33d40651e68", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e9d4cce5e8ba40721b2539712e87c33d40651e68", "committedDate": "2020-10-21T15:04:46Z", "message": "do not run cleanup.sql BEFORE_TEST_METHOD to avoid postgresql deadlock with async post date range processing\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MDkzMDI4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1165#pullrequestreview-514093028", "createdAt": "2020-10-21T19:04:05Z", "commit": {"oid": "e9d4cce5e8ba40721b2539712e87c33d40651e68"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e7fe84d8a36afcb1217a00ae2177b7966f53cb0", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4e7fe84d8a36afcb1217a00ae2177b7966f53cb0", "committedDate": "2020-10-21T21:06:27Z", "message": "fix test case failure\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MTg5MDU4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1165#pullrequestreview-514189058", "createdAt": "2020-10-21T21:11:11Z", "commit": {"oid": "4e7fe84d8a36afcb1217a00ae2177b7966f53cb0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMToxMToxMVrOHmFpHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMToxMToxMVrOHmFpHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcwMDM4Mw==", "bodyText": "This test fails in my local env but not in CircleCI runs. What happened is if the Sql annotations here do not match exactly those in IntegrationTest, springboot test will list all 3 sql scripts and cleanup.sql will run in AFTER_TEST_METHOD phase and errors out since it tries to truncate tables after V1.28.1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1165#discussion_r509700383", "createdAt": "2020-10-21T21:11:11Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/migration/V1_28_1__Address_BookTest.java", "diffHunk": "@@ -48,7 +48,6 @@\n import com.hedera.mirror.importer.repository.FileDataRepository;\n \n @TestPropertySource(properties = \"spring.flyway.target=1.28.0\")\n-@Sql(executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD, scripts = \"classpath:db/scripts/cleanup_V1.28.1.sql\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e7fe84d8a36afcb1217a00ae2177b7966f53cb0"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MTkyNTM0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1165#pullrequestreview-514192534", "createdAt": "2020-10-21T21:16:40Z", "commit": {"oid": "4e7fe84d8a36afcb1217a00ae2177b7966f53cb0"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0Mjg0MDE3", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1165#pullrequestreview-514284017", "createdAt": "2020-10-22T00:39:54Z", "commit": {"oid": "4e7fe84d8a36afcb1217a00ae2177b7966f53cb0"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0Nzk0NjIx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1165#pullrequestreview-514794621", "createdAt": "2020-10-22T14:31:57Z", "commit": {"oid": "4e7fe84d8a36afcb1217a00ae2177b7966f53cb0"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e8bed1c9294ef002f333d72e101224efc211275", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3e8bed1c9294ef002f333d72e101224efc211275", "committedDate": "2020-10-22T16:22:23Z", "message": "Merge remote-tracking branch 'origin/master' into fix-postgresql-deadlock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d928a26de342c80f7e0efb37ad0f43acd7f350bb", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d928a26de342c80f7e0efb37ad0f43acd7f350bb", "committedDate": "2020-10-22T16:31:14Z", "message": "make AddressBookServiceImplTest extends IntegrationTest\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0OTE2NzIy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1165#pullrequestreview-514916722", "createdAt": "2020-10-22T16:33:49Z", "commit": {"oid": "d928a26de342c80f7e0efb37ad0f43acd7f350bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNjozMzo0OVrOHmqXTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNjozMzo0OVrOHmqXTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMwMjAzMA==", "bodyText": "ends up also explicitly acquire the highest level table lock on t_application_status since AddressBookServiceImplTest assumes empty address_book and address_book_entry tables. It's better and easier to maintain a single all-in-one cleanup script instead of creating test class specific cleanup scripts.\nThe lock should have the effect to serialize the t_applications_status update in both this script and the transaction in MirrorDateRangePropertiesProcessor", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1165#discussion_r510302030", "createdAt": "2020-10-22T16:33:49Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/resources/db/scripts/cleanup.sql", "diffHunk": "@@ -9,8 +9,8 @@ TRUNCATE TABLE t_entities RESTART IDENTITY CASCADE;\n TRUNCATE TABLE transaction RESTART IDENTITY CASCADE;\n TRUNCATE TABLE topic_message RESTART IDENTITY CASCADE;\n TRUNCATE TABLE non_fee_transfer;\n-UPDATE t_application_status\n-SET status_value = NULL;\n+LOCK TABLE t_application_status IN ACCESS EXCLUSIVE MODE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d928a26de342c80f7e0efb37ad0f43acd7f350bb"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8049f4222dc67a1e42ff46e3152822b0ec30be06", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8049f4222dc67a1e42ff46e3152822b0ec30be06", "committedDate": "2020-10-22T16:49:03Z", "message": "change all @Sql in integration tests to BEFORE_TEST_METHOD phase\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95123d0fe6b83498b398c0337045fbadc8048b9b", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/95123d0fe6b83498b398c0337045fbadc8048b9b", "committedDate": "2020-10-22T17:17:10Z", "message": "revert changes to IntegrationTest since now cleanup.sql locks t_application_status table to serializes writes to it\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0OTU3MDg5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1165#pullrequestreview-514957089", "createdAt": "2020-10-22T17:23:22Z", "commit": {"oid": "95123d0fe6b83498b398c0337045fbadc8048b9b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3622, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}