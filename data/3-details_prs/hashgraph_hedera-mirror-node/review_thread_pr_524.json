{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMDk0Nzk2", "number": 524, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMzoxNzowOVrODdKXpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMToxMjo1NVrODde9SA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxOTA1MTkwOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/repository/TopicMessageRepositoryCustomImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMzoxNzoxMFrOFlm5Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwMDoxODoxM1rOFloBvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk3ODg1OA==", "bodyText": "nit: Why not just do the max of (int) filter.getLimit() and grpcProperties.getMaxPageSize().\nI think based on the logic, Integer.MAX_VALUE will never be the limit, and  grpcProperties.getMaxPageSize() will always have a value.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/524#discussion_r374978858", "createdAt": "2020-02-04T23:17:10Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/repository/TopicMessageRepositoryCustomImpl.java", "diffHunk": "@@ -54,15 +58,22 @@\n                     .lessThan(instantToLongConverter.convert(filter.getEndTime()));\n         }\n \n+        int limit = filter.hasLimit() ? (int) filter.getLimit() : Integer.MAX_VALUE;\n+        int pageSize = Math.min(limit, grpcProperties.getMaxPageSize());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0ecb0bd297529ea1517cb1422c888b4965a756c"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk5NzQzOQ==", "bodyText": "Because if limit is 5 million we don't want to pick that as max. Unless you mean min, in which case limit can be zero for unlimited and don't want to choose that as min either", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/524#discussion_r374997439", "createdAt": "2020-02-05T00:18:13Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/repository/TopicMessageRepositoryCustomImpl.java", "diffHunk": "@@ -54,15 +58,22 @@\n                     .lessThan(instantToLongConverter.convert(filter.getEndTime()));\n         }\n \n+        int limit = filter.hasLimit() ? (int) filter.getLimit() : Integer.MAX_VALUE;\n+        int pageSize = Math.min(limit, grpcProperties.getMaxPageSize());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk3ODg1OA=="}, "originalCommit": {"oid": "f0ecb0bd297529ea1517cb1422c888b4965a756c"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxOTA2MzUwOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/repository/TopicMessageRepositoryCustomImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMzoyMjoyOVrOFlnAIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNzo1NjoyNlrOFmBcKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk4MDY0Mw==", "bodyText": "Wish there was an easy way to utilize the onNext logic to test that x number of pages were traversed on a call to the db. Just logs for now is okay I guess", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/524#discussion_r374980643", "createdAt": "2020-02-04T23:22:29Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/repository/TopicMessageRepositoryCustomImpl.java", "diffHunk": "@@ -54,15 +58,22 @@\n                     .lessThan(instantToLongConverter.convert(filter.getEndTime()));\n         }\n \n+        int limit = filter.hasLimit() ? (int) filter.getLimit() : Integer.MAX_VALUE;\n+        int pageSize = Math.min(limit, grpcProperties.getMaxPageSize());\n+        Pageable pageable = PageRequest.of(0, pageSize);\n+\n         return databaseClient.select()\n                 .from(TopicMessage.class)\n                 .matching(whereClause)\n                 .orderBy(Sort.by(\"consensus_timestamp\"))\n+                .page(pageable)\n                 .fetch()\n                 .all()\n-                .as(t -> filter.hasLimit() ? t.limitRequest(filter.getLimit()) : t)\n                 .name(\"findByFilter\")\n                 .metrics()\n-                .doOnSubscribe(s -> log.debug(\"Executing query: {}\", filter));\n+                .doOnSubscribe(s -> log.debug(\"Executing query: {}\", filter))\n+                .doOnCancel(() -> log.debug(\"[{}] Cancelled query\", filter.getSubscriberId()))\n+                .doOnComplete(() -> log.debug(\"[{}] Completed query\", filter.getSubscriberId()))\n+                .doOnNext(t -> log.trace(\"[{}] Next message: {}\", filter.getSubscriberId(), t));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0ecb0bd297529ea1517cb1422c888b4965a756c"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQxMzgwMw==", "bodyText": "And our performance tests", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/524#discussion_r375413803", "createdAt": "2020-02-05T17:56:26Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/repository/TopicMessageRepositoryCustomImpl.java", "diffHunk": "@@ -54,15 +58,22 @@\n                     .lessThan(instantToLongConverter.convert(filter.getEndTime()));\n         }\n \n+        int limit = filter.hasLimit() ? (int) filter.getLimit() : Integer.MAX_VALUE;\n+        int pageSize = Math.min(limit, grpcProperties.getMaxPageSize());\n+        Pageable pageable = PageRequest.of(0, pageSize);\n+\n         return databaseClient.select()\n                 .from(TopicMessage.class)\n                 .matching(whereClause)\n                 .orderBy(Sort.by(\"consensus_timestamp\"))\n+                .page(pageable)\n                 .fetch()\n                 .all()\n-                .as(t -> filter.hasLimit() ? t.limitRequest(filter.getLimit()) : t)\n                 .name(\"findByFilter\")\n                 .metrics()\n-                .doOnSubscribe(s -> log.debug(\"Executing query: {}\", filter));\n+                .doOnSubscribe(s -> log.debug(\"Executing query: {}\", filter))\n+                .doOnCancel(() -> log.debug(\"[{}] Cancelled query\", filter.getSubscriberId()))\n+                .doOnComplete(() -> log.debug(\"[{}] Completed query\", filter.getSubscriberId()))\n+                .doOnNext(t -> log.trace(\"[{}] Next message: {}\", filter.getSubscriberId(), t));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk4MDY0Mw=="}, "originalCommit": {"oid": "f0ecb0bd297529ea1517cb1422c888b4965a756c"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxOTA2ODU0OnYy", "diffSide": "LEFT", "path": "hedera-mirror-grpc/pom.xml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMzoyNTowOVrOFlnDOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNzo0Njo0NFrOFmBI2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk4MTQzNQ==", "bodyText": "Is r2dbc stable enough now that we trust taking new version automatically? If not maybe we should peg to a version we know works and manually increase it till we're comfortable.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/524#discussion_r374981435", "createdAt": "2020-02-04T23:25:09Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-grpc/pom.xml", "diffHunk": "@@ -37,10 +37,13 @@\n             <groupId>io.micrometer</groupId>\n             <artifactId>micrometer-registry-elastic</artifactId>\n         </dependency>\n+        <dependency>\n+            <groupId>io.r2dbc</groupId>\n+            <artifactId>r2dbc-pool</artifactId>\n+        </dependency>\n         <dependency>\n             <groupId>io.r2dbc</groupId>\n             <artifactId>r2dbc-postgresql</artifactId>\n-            <version>0.8.1.BUILD-SNAPSHOT</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0ecb0bd297529ea1517cb1422c888b4965a756c"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk5NzkyMA==", "bodyText": "This is exactly what's done here. The version is controlled via the hardcoded version of the spring r2dbc BOM import in the same file. There's transitive dependencies as well like r2dbc-spi so just hardcoding r2dbc-postgresql wouldn't be enough. Better to use the BOM version.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/524#discussion_r374997920", "createdAt": "2020-02-05T00:20:01Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-grpc/pom.xml", "diffHunk": "@@ -37,10 +37,13 @@\n             <groupId>io.micrometer</groupId>\n             <artifactId>micrometer-registry-elastic</artifactId>\n         </dependency>\n+        <dependency>\n+            <groupId>io.r2dbc</groupId>\n+            <artifactId>r2dbc-pool</artifactId>\n+        </dependency>\n         <dependency>\n             <groupId>io.r2dbc</groupId>\n             <artifactId>r2dbc-postgresql</artifactId>\n-            <version>0.8.1.BUILD-SNAPSHOT</version>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk4MTQzNQ=="}, "originalCommit": {"oid": "f0ecb0bd297529ea1517cb1422c888b4965a756c"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQwODg1OA==", "bodyText": "Gotcha", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/524#discussion_r375408858", "createdAt": "2020-02-05T17:46:44Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-grpc/pom.xml", "diffHunk": "@@ -37,10 +37,13 @@\n             <groupId>io.micrometer</groupId>\n             <artifactId>micrometer-registry-elastic</artifactId>\n         </dependency>\n+        <dependency>\n+            <groupId>io.r2dbc</groupId>\n+            <artifactId>r2dbc-pool</artifactId>\n+        </dependency>\n         <dependency>\n             <groupId>io.r2dbc</groupId>\n             <artifactId>r2dbc-postgresql</artifactId>\n-            <version>0.8.1.BUILD-SNAPSHOT</version>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk4MTQzNQ=="}, "originalCommit": {"oid": "f0ecb0bd297529ea1517cb1422c888b4965a756c"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMjQyNTA0OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/service/TopicMessageServiceImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMToxMjo1NVrOFmHV9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMToxNzowMlrOFmHc8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUxMDUxNw==", "bodyText": "possible divide by zero", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/524#discussion_r375510517", "createdAt": "2020-02-05T21:12:55Z", "author": {"login": "mike-burrage-hedera"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/service/TopicMessageServiceImpl.java", "diffHunk": "@@ -157,8 +158,9 @@ boolean isNext(TopicMessage topicMessage) {\n         }\n \n         void onComplete() {\n-            log.info(\"[{}] Topic {} {} complete with {} messages in {}\", filter\n-                    .getSubscriberId(), topicId, mode, count, stopwatch);\n+            var rate = (int) (1_000_000.0 * count.get() / stopwatch.elapsed(TimeUnit.MICROSECONDS));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bedd0714849a0e695f3eed423e8d35b863d4944"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUxMjMwNA==", "bodyText": "It's the same code in Downloader. I think the intent is that microseconds is low enough it can't be zero. But can do a check", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/524#discussion_r375512304", "createdAt": "2020-02-05T21:17:02Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/service/TopicMessageServiceImpl.java", "diffHunk": "@@ -157,8 +158,9 @@ boolean isNext(TopicMessage topicMessage) {\n         }\n \n         void onComplete() {\n-            log.info(\"[{}] Topic {} {} complete with {} messages in {}\", filter\n-                    .getSubscriberId(), topicId, mode, count, stopwatch);\n+            var rate = (int) (1_000_000.0 * count.get() / stopwatch.elapsed(TimeUnit.MICROSECONDS));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUxMDUxNw=="}, "originalCommit": {"oid": "9bedd0714849a0e695f3eed423e8d35b863d4944"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1134, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}