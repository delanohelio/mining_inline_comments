{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0MzcwNDg2", "number": 1031, "title": "Clear topic notifications on error", "bodyText": "Detailed description:\n\nAdd hedera.mirror.importer.publish.duration metric to track pg notifications\nFix NotifyingEntityListener not being notified of rollbacks and cleaning up its list of topic messages\nFix NotifyingEntityListener.onSave(..) still attempting to notify when disabled\n\nWhich issue(s) this PR fixes:\nFixes #1028\nSpecial notes for your reviewer:\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-09-10T21:56:24Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1031", "merged": true, "mergeCommit": {"oid": "08b2329d4fa53f953cba40c9529ec1e0bcb47399"}, "closed": true, "closedAt": "2020-09-11T14:57:03Z", "author": {"login": "steven-sheehy"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHoE4DAH2gAyNDg0MzcwNDg2OmJkZTFmMGUzMjFjZGM2OTc1Y2QzOWJhZTU1YjkyNGMwZjYwNDM3ZDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH2OVRAFqTQ4Njg1NDM3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bde1f0e321cdc6975cd39bae55b924c0f60437d9", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bde1f0e321cdc6975cd39bae55b924c0f60437d9", "committedDate": "2020-09-10T21:56:14Z", "message": "Clear topic notifications on error\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NDAzNjkw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1031#pullrequestreview-486403690", "createdAt": "2020-09-11T00:52:44Z", "commit": {"oid": "bde1f0e321cdc6975cd39bae55b924c0f60437d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMDo1Mjo0NFrOHQKf9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMDo1Mjo0NFrOHQKf9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxMTI4NQ==", "bodyText": "nit: have you considered adding try... finally.. and move topicMessage.clear to the finally block? that way, we don't need the onCleanup listener", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1031#discussion_r486711285", "createdAt": "2020-09-11T00:52:44Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/notify/NotifyingEntityListener.java", "diffHunk": "@@ -66,9 +83,17 @@ public void onTopicMessage(TopicMessage topicMessage) throws ImporterException {\n     }\n \n     @EventListener\n-    public void onBatch(EntityBatchEvent event) {\n-        jdbcTemplate.execute(SQL, callback(topicMessages));\n-        log.info(\"Finished notifying {} messages\", topicMessages.size());\n+    public void onSave(EntityBatchSaveEvent event) {\n+        if (isEnabled()) {\n+            Stopwatch stopwatch = Stopwatch.createStarted();\n+            timer.record(() -> jdbcTemplate.execute(SQL, callback(topicMessages)));\n+            log.info(\"Finished notifying {} messages in {}\", topicMessages.size(), stopwatch);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bde1f0e321cdc6975cd39bae55b924c0f60437d9"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2ODU0Mzc0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1031#pullrequestreview-486854374", "createdAt": "2020-09-11T14:25:14Z", "commit": {"oid": "bde1f0e321cdc6975cd39bae55b924c0f60437d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3673, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}