{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0MDEzNDQ5", "number": 585, "title": "Move file handling logic from RecordItemParser to RecordFileParser", "bodyText": "Detailed description:\n\nMove connection ownership to PostgresWritingRecordParsedItemHandler\n\nRecordItemParser.start()+ RecordItemParser.initFile --> onStart()\nRecordItemParser.finish + RecordItemParser.completeFile --> onEnd()\n\n\nRecordItemParser is agnostic of 'file' and database now (except entity repo, to be fixed later)\nRecordFileParser is agnostic of database now (except for application state - applicationStatusRepository)\nChange RecordFileParserTest to use mocks rather than transactionRepository or recordFileRepository.\nAdds two interfaces: StreamFileListener and RecordStreamFileListener\nDependencies:\n\nRecordFileParser ---depends on --> RecordStreamFileListener and RecordItemListener\nRecordItemParser --depends on--> RecordParsedItemHandler\n\n\nDeprecated file id column in t_record_files. To be removed soon.\nRemove checks for recordFileRepository from RecordItemParser tests\n\nSigned-off-by: Apekshit Sharma apekshit.sharma@hedera.com\nWhich issue(s) this PR fixes:\nPartially addresses #566\nSpecial notes for your reviewer:\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-03-05T01:11:16Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585", "merged": true, "mergeCommit": {"oid": "c92c525ec01dcd01356aab42972d74284cae8eff"}, "closed": true, "closedAt": "2020-03-07T17:28:47Z", "author": {"login": "apeksharma"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKg-CfgH2gAyMzg0MDEzNDQ5OjY4MDNiNTQwYjkyNGNkMjlkNTdkODM5N2I3MmE3MTI2ZWM5NzE1MWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcLMkXjAFqTM3MDcyMDM1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6803b540b924cd29d57d8397b72a7126ec97151b", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6803b540b924cd29d57d8397b72a7126ec97151b", "committedDate": "2020-03-05T01:10:03Z", "message": "Move file handling logic from RecordItemParser to RecordFileParser\n\n- Move connection ownership to RecordFileParser\n  - initConnection: earlier RecordItemParser.start()\n  - closeConnection: earlier RecordItemParser.finish()\n- Move db file handling to RecordFileParser\n  - initFile\n  - closeFileAndCommit: eariler RecordItemParser.completeFile()\n  - Move file testing from RecordItemParserTest to RecordFileParserTest\n- RecordItemParser is completely agnostic of 'file' concept now.\n- Remove checks for recordFileRepository from RecordItemParser tests\n\nFollowup: Remove fileId in t_transactions.\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTMyODMx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#pullrequestreview-369932831", "createdAt": "2020-03-05T21:37:00Z", "commit": {"oid": "6803b540b924cd29d57d8397b72a7126ec97151b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMTozNzowMFrOFylEEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjowNDoyMlrOFyl6OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4MDM2OA==", "bodyText": "I don't agree with this change, which is apparently the entire purpose of this PR. The connection should be internal state managed by the PostgresWritingRecordParsedItemHandler. With connection pools, opening and closing it for every file doesn't mean a new connection is actually opened or closed, negating any performance benefits.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#discussion_r388580368", "createdAt": "2020-03-05T21:37:00Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/RecordFileParser.java", "diffHunk": "@@ -64,6 +71,8 @@\n     private final RecordParserProperties parserProperties;\n     private final MeterRegistry meterRegistry;\n     private final RecordItemParser recordItemParser;\n+    private final PostgresWritingRecordParsedItemHandler postgresWriter;\n+    private Connection connect;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6803b540b924cd29d57d8397b72a7126ec97151b"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4MDgwOQ==", "bodyText": "The RecordFileParser should not be tightly coupled to a concrete implementation of ParsedItemHandler", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#discussion_r388580809", "createdAt": "2020-03-05T21:37:54Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/RecordFileParser.java", "diffHunk": "@@ -64,6 +71,8 @@\n     private final RecordParserProperties parserProperties;\n     private final MeterRegistry meterRegistry;\n     private final RecordItemParser recordItemParser;\n+    private final PostgresWritingRecordParsedItemHandler postgresWriter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6803b540b924cd29d57d8397b72a7126ec97151b"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4MTY5OA==", "bodyText": "This method should be moved to a repository to separate db logic from application logic. This method can be used as is or better yet, the f_file_create be deleted and repositories used directly. There can be an argument to using copymanager for performance reasons in itemhandlers, but record files only occur once per file and can definitely use repository. Stored procedures can't participate in an existing transaction anyway so have it using the same connection and rolling back, etc is pointless.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#discussion_r388581698", "createdAt": "2020-03-05T21:39:55Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/RecordFileParser.java", "diffHunk": "@@ -127,16 +138,85 @@ public static String readPrevFileHash(String fileName) {\n         return null;\n     }\n \n-    private RecordItemParser.INIT_RESULT initFile(String filename) {\n-        return recordItemParser.initFile(filename);\n+    /**\n+     * @return 0 if row with given filename already exists, otherwise id of newly added row.\n+     *         In case of failure, returns -1;\n+     */\n+    public long initFile(String fileName) {\n+        try {\n+            long fileId;\n+\n+            try (CallableStatement fileCreate = connect.prepareCall(\"{? = call f_file_create( ? ) }\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6803b540b924cd29d57d8397b72a7126ec97151b"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4MTg5Ng==", "bodyText": "Should be private", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#discussion_r388581896", "createdAt": "2020-03-05T21:40:23Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/RecordFileParser.java", "diffHunk": "@@ -127,16 +138,85 @@ public static String readPrevFileHash(String fileName) {\n         return null;\n     }\n \n-    private RecordItemParser.INIT_RESULT initFile(String filename) {\n-        return recordItemParser.initFile(filename);\n+    /**\n+     * @return 0 if row with given filename already exists, otherwise id of newly added row.\n+     *         In case of failure, returns -1;\n+     */\n+    public long initFile(String fileName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6803b540b924cd29d57d8397b72a7126ec97151b"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4MjAyOA==", "bodyText": "private", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#discussion_r388582028", "createdAt": "2020-03-05T21:40:43Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/RecordFileParser.java", "diffHunk": "@@ -127,16 +138,85 @@ public static String readPrevFileHash(String fileName) {\n         return null;\n     }\n \n-    private RecordItemParser.INIT_RESULT initFile(String filename) {\n-        return recordItemParser.initFile(filename);\n+    /**\n+     * @return 0 if row with given filename already exists, otherwise id of newly added row.\n+     *         In case of failure, returns -1;\n+     */\n+    public long initFile(String fileName) {\n+        try {\n+            long fileId;\n+\n+            try (CallableStatement fileCreate = connect.prepareCall(\"{? = call f_file_create( ? ) }\")) {\n+                fileCreate.registerOutParameter(1, Types.BIGINT);\n+                fileCreate.setString(2, fileName);\n+                fileCreate.execute();\n+                fileId = fileCreate.getLong(1);\n+            }\n+\n+            if (fileId == 0) {\n+                log.trace(\"File {} already exists in the database.\", fileName);\n+            } else {\n+                log.trace(\"Added file {} to the database.\", fileName);\n+            }\n+            return fileId;\n+        } catch (SQLException e) {\n+            log.error(\"Error saving file in database: {}\",  fileName, e);\n+            return -1L;\n+        }\n+    }\n+\n+    public void closeFileAndCommit(long fileId, String fileHash, String previousHash) throws SQLException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6803b540b924cd29d57d8397b72a7126ec97151b"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4MzAyMg==", "bodyText": "Same statement above about repository", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#discussion_r388583022", "createdAt": "2020-03-05T21:42:49Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/RecordFileParser.java", "diffHunk": "@@ -127,16 +138,85 @@ public static String readPrevFileHash(String fileName) {\n         return null;\n     }\n \n-    private RecordItemParser.INIT_RESULT initFile(String filename) {\n-        return recordItemParser.initFile(filename);\n+    /**\n+     * @return 0 if row with given filename already exists, otherwise id of newly added row.\n+     *         In case of failure, returns -1;\n+     */\n+    public long initFile(String fileName) {\n+        try {\n+            long fileId;\n+\n+            try (CallableStatement fileCreate = connect.prepareCall(\"{? = call f_file_create( ? ) }\")) {\n+                fileCreate.registerOutParameter(1, Types.BIGINT);\n+                fileCreate.setString(2, fileName);\n+                fileCreate.execute();\n+                fileId = fileCreate.getLong(1);\n+            }\n+\n+            if (fileId == 0) {\n+                log.trace(\"File {} already exists in the database.\", fileName);\n+            } else {\n+                log.trace(\"Added file {} to the database.\", fileName);\n+            }\n+            return fileId;\n+        } catch (SQLException e) {\n+            log.error(\"Error saving file in database: {}\",  fileName, e);\n+            return -1L;\n+        }\n+    }\n+\n+    public void closeFileAndCommit(long fileId, String fileHash, String previousHash) throws SQLException {\n+        try (CallableStatement fileClose = connect.prepareCall(\"{call f_file_complete( ?, ?, ? ) }\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6803b540b924cd29d57d8397b72a7126ec97151b"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4NTUxMg==", "bodyText": "Should not increase visibility of methods just for testing. Just test the parse method", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#discussion_r388585512", "createdAt": "2020-03-05T21:48:01Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/RecordFileParser.java", "diffHunk": "@@ -149,12 +229,12 @@ private void rollback() {\n      * @return return boolean indicating method success\n      * @throws Exception\n      */\n-    private boolean loadRecordFile(String fileName, InputStream inputStream, String expectedPrevFileHash,\n+    public boolean loadRecordFile(String fileName, InputStream inputStream, String expectedPrevFileHash,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6803b540b924cd29d57d8397b72a7126ec97151b"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4Njk2Mw==", "bodyText": "This logic is unnecessarily complex (before and after change). It would be a lot clearer for initFile to return a Optional<RecordFile>.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#discussion_r388586963", "createdAt": "2020-03-05T21:50:09Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/RecordFileParser.java", "diffHunk": "@@ -149,12 +229,12 @@ private void rollback() {\n      * @return return boolean indicating method success\n      * @throws Exception\n      */\n-    private boolean loadRecordFile(String fileName, InputStream inputStream, String expectedPrevFileHash,\n+    public boolean loadRecordFile(String fileName, InputStream inputStream, String expectedPrevFileHash,\n                                    String thisFileHash) {\n-        var result = initFile(fileName);\n-        if (result == RecordItemParser.INIT_RESULT.SKIP) {\n+        var fileId = initFile(fileName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6803b540b924cd29d57d8397b72a7126ec97151b"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4NzgwOQ==", "bodyText": "RecordItemParser should not know about a concrete implementation of ParsedItemHandler. This negates the whole purpose of this parser refactoring: to easily swap out implementations or support multiple different implementations concurrently (e.g. send to postgres and bigquery).", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#discussion_r388587809", "createdAt": "2020-03-05T21:52:01Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/RecordItemParser.java", "diffHunk": "@@ -84,10 +78,6 @@\n     private final Predicate<com.hedera.mirror.importer.domain.Transaction> transactionFilter;\n     private final PostgresWritingRecordParsedItemHandler postgresWriter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6803b540b924cd29d57d8397b72a7126ec97151b"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU5MzgyNg==", "bodyText": "If you're removing t_transactions.fk_rec_file_id in the future, it makes t_record_files pretty pointless. Have we checked with BRD if they're not using it so we can remove the table entirely? Or if we need to keep it do we need to add start and end transaction consensus timestamp to it so the associated transactions can be calculated that way?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#discussion_r388593826", "createdAt": "2020-03-05T22:03:25Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/Transaction.java", "diffHunk": "@@ -64,7 +64,9 @@\n     @ManyToOne(cascade = CascadeType.PERSIST)\n     private Entities entity;\n \n+    // Deprecated, value set to 0 until removed.\n     @Column(name = \"fk_rec_file_id\")\n+    @Deprecated(forRemoval = true, since = \"v0.7.0\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6803b540b924cd29d57d8397b72a7126ec97151b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU5NDIzMg==", "bodyText": "This should be private and not leaked to upper layers", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#discussion_r388594232", "createdAt": "2020-03-05T22:04:22Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/PostgresWritingRecordParsedItemHandler.java", "diffHunk": "@@ -90,16 +90,12 @@ void initSqlStatements(Connection connection) throws ParserSQLException {\n         }\n     }\n \n-    public void finish() {\n-        closeStatements();\n-    }\n-\n     @Override\n     public void onFileComplete() {\n         executeBatches();\n     }\n \n-    private void closeStatements() {\n+    public void closeStatements() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6803b540b924cd29d57d8397b72a7126ec97151b"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44baf34f4535439c52d2787105db64476b3bce20", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/44baf34f4535439c52d2787105db64476b3bce20", "committedDate": "2020-03-06T18:59:05Z", "message": "address review comments. working of fixing tests. early preview of changes for now\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "075404b0bfb8a1856d87a6c219f7874f3c2488ed", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/075404b0bfb8a1856d87a6c219f7874f3c2488ed", "committedDate": "2020-03-06T23:02:42Z", "message": "fix tests\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNjgxNzAy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#pullrequestreview-370681702", "createdAt": "2020-03-06T23:14:37Z", "commit": {"oid": "075404b0bfb8a1856d87a6c219f7874f3c2488ed"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMzoxNDozN1rOFzKMHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMzoxOTowNlrOFzKQmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE4ODYzNg==", "bodyText": "any improvements suggestions here?\nwould like to make this neater in next PR ('fileId removal')", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#discussion_r389188636", "createdAt": "2020-03-06T23:14:37Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/RecordFileParser.java", "diffHunk": "@@ -127,43 +136,33 @@ public static String readPrevFileHash(String fileName) {\n         return null;\n     }\n \n-    private RecordItemParser.INIT_RESULT initFile(String filename) {\n-        return recordItemParser.initFile(filename);\n-    }\n-\n-    private void closeFileAndCommit(String fileHash, String previousHash) throws SQLException {\n-        recordItemParser.completeFile(fileHash, previousHash);\n-    }\n-\n-    private void rollback() {\n-        recordItemParser.rollback();\n-    }\n-\n     /**\n      * Given a service record name, read and parse and return as a list of service record pair\n      *\n-     * @param fileName             the name of record file to read\n-     * @param inputStream          input stream of bytes in the record file\n-     * @param expectedPrevFileHash the hash of the previous record file in the series\n-     * @param thisFileHash         the hash of this file\n+     * @param streamFileData containing information about file to be processed\n      * @return return boolean indicating method success\n      * @throws Exception\n      */\n-    private boolean loadRecordFile(String fileName, InputStream inputStream, String expectedPrevFileHash,\n-                                   String thisFileHash) {\n-        var result = initFile(fileName);\n-        if (result == RecordItemParser.INIT_RESULT.SKIP) {\n-            return true; // skip this fle\n-        } else if (result == RecordItemParser.INIT_RESULT.FAIL) {\n-            rollback();\n+    public boolean loadRecordFile(StreamFileData streamFileData, String thisFileHash, String expectedPrevFileHash) {\n+        String fileName = streamFileData.getFilename();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "075404b0bfb8a1856d87a6c219f7874f3c2488ed"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE4OTc4Nw==", "bodyText": "mocked in test.\nIf there's a better way, let's revisit this when moving to repository.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#discussion_r389189787", "createdAt": "2020-03-06T23:19:06Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/PostgresWritingRecordParsedItemHandler.java", "diffHunk": "@@ -52,8 +60,88 @@\n     private PreparedStatement sqlInsertLiveHashes;\n     private PreparedStatement sqlInsertTopicMessage;\n     private final PostgresWriterProperties properties;\n+    private final DataSource dataSource;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "075404b0bfb8a1856d87a6c219f7874f3c2488ed"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d80f4ec826688c6f5fbf927f1f82acb287cdbbf9", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d80f4ec826688c6f5fbf927f1f82acb287cdbbf9", "committedDate": "2020-03-06T23:47:41Z", "message": "Add more tests.\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNjk4NTM5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#pullrequestreview-370698539", "createdAt": "2020-03-07T00:21:39Z", "commit": {"oid": "44baf34f4535439c52d2787105db64476b3bce20"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDoyMTozOVrOFzLFHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDozODo1MFrOFzLRQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMzIyOQ==", "bodyText": "given when then is the typical bdd expression used.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#discussion_r389203229", "createdAt": "2020-03-07T00:21:39Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/RecordFileParserTest.java", "diffHunk": "@@ -73,88 +94,177 @@ void before() {\n                 .from(streamType.getPath(), \"v2\", \"record0.0.3\")\n                 .filterFiles(\"*.rcd\")\n                 .to(streamType.getPath(), streamType.getValid());\n+        file1 = parserProperties.getValidPath().resolve(\"2019-08-30T18_10_00.419072Z.rcd\").toFile();\n+        file2 = parserProperties.getValidPath().resolve(\"2019-08-30T18_10_05.249678Z.rcd\").toFile();\n+        recordFile1 = new RecordFile(0L, file1.getPath(), 0L, 0L,\n+                \"591558e059bd1629ee386c4e35a6875b4c67a096718f5d225772a651042715189414df7db5588495efb2a85dc4a0ffda\",\n+                \"\");\n+        recordFile2 = new RecordFile(0L, file2.getPath(), 0L, 0L,\n+                \"5ed51baeff204eb6a2a68b76bbaadcb9b6e7074676c1746b99681d075bef009e8d57699baaa6342feec4e83726582d36\",\n+                recordFile1.getFileHash());\n     }\n \n-    @Test\n-    void parse() throws Exception {\n-        fileCopier.copy();\n-        recordFileParser.parse();\n+    // Asserts that recordStreamFileListener.onStart is called exactly with given fileNames.\n+    private void assertOnStart(String... fileNames) {\n+        ArgumentCaptor<StreamFileData> captor = ArgumentCaptor.forClass(StreamFileData.class);\n+        verify(recordStreamFileListener, times(fileNames.length)).onStart(captor.capture());\n+        List<StreamFileData> actualArgs = captor.getAllValues();\n+        assertThat(actualArgs)\n+                .extracting(StreamFileData::getFilename)\n+                .contains(fileNames);\n+    }\n \n+    // Asserts that recordStreamFileListener.onEnd is called exactly with given params, in given order\n+    private void assertOnEnd(RecordFile... recordFiles) {\n+        ArgumentCaptor<RecordFile> captor = ArgumentCaptor.forClass(RecordFile.class);\n+        verify(recordStreamFileListener, times(recordFiles.length)).onEnd(captor.capture());\n+        List<RecordFile> actualArgs = captor.getAllValues();\n+        for (int i = 0; i < recordFiles.length; i++) {\n+            RecordFile actual = actualArgs.get(i);\n+            RecordFile expected = recordFiles[i];\n+            assertEquals(expected.getId(), actual.getId());\n+            assertEquals(expected.getName(), actual.getName());\n+            assertEquals(expected.getFileHash(), actual.getFileHash());\n+            assertEquals(expected.getPreviousHash(), actual.getPreviousHash());\n+        }\n+    }\n+\n+    // Asserts that parsed directory contains exactly the files with given fileNames\n+    private void assertParsedFiles(String... fileNames) throws Exception {\n         assertThat(Files.walk(parserProperties.getParsedPath()))\n                 .filteredOn(p -> !p.toFile().isDirectory())\n-                .hasSize(2)\n+                .hasSize(fileNames.length)\n                 .extracting(Path::getFileName)\n-                .contains(Paths.get(\"2019-08-30T18_10_05.249678Z.rcd\"))\n-                .contains(Paths.get(\"2019-08-30T18_10_00.419072Z.rcd\"));\n+                .extracting(Path::toString)\n+                .contains(fileNames);\n+    }\n \n-        Assertions.assertThat(transactionRepository.findAll())\n-                .hasSize(19 + 15)\n-                .extracting(Transaction::getType)\n-                .containsOnlyElementsOf(Sets.newHashSet(11, 12, 14));\n+    @Test\n+    void parse() throws Exception {\n+        // setup\n+        fileCopier.copy();\n+        when(recordStreamFileListener.onStart(any())).thenAnswer(invocation -> {\n+            StreamFileData streamFileData = invocation.getArgument(0, StreamFileData.class);\n+            RecordFile recordFile = new RecordFile();\n+            recordFile.setId(0L);\n+            recordFile.setName(streamFileData.getFilename());\n+            return Optional.of(recordFile);\n+        });\n+\n+        // when\n+        recordFileParser.parse();\n+\n+        // expect\n+        assertParsedFiles(file1.getName(), file2.getName());\n+        verify(recordItemListener, times(NUM_TXNS_FILE_1 + NUM_TXNS_FILE_2)).onItem(any());\n+        assertOnStart(file1.getPath(), file2.getPath());\n+        assertOnEnd(recordFile1, recordFile2);\n     }\n \n     @Test\n     void disabled() throws Exception {\n+        // setup\n         parserProperties.setEnabled(false);\n         fileCopier.copy();\n+\n+        // when\n         recordFileParser.parse();\n-        assertThat(Files.walk(parserProperties.getParsedPath())).filteredOn(p -> !p.toFile().isDirectory()).hasSize(0);\n-        assertThat(transactionRepository.count()).isEqualTo(0L);\n+\n+        // expect\n+        assertParsedFiles();\n+        verifyNoInteractions(recordItemListener);\n+        verifyNoInteractions(recordStreamFileListener);\n     }\n \n     @Test\n     void noFiles() throws Exception {\n+        // when\n         recordFileParser.parse();\n-        assertThat(Files.walk(parserProperties.getParsedPath())).filteredOn(p -> !p.toFile().isDirectory()).hasSize(0);\n-        assertThat(transactionRepository.count()).isEqualTo(0L);\n+\n+        // expect\n+        assertParsedFiles();\n+        verifyNoInteractions(recordItemListener);\n+        verifyNoInteractions(recordStreamFileListener);\n     }\n \n     @Test\n     void invalidFile() throws Exception {\n-        File recordFile = dataPath.resolve(streamType.getPath()).resolve(streamType.getValid())\n-                .resolve(\"2019-08-30T18_10_05.249678Z.rcd\").toFile();\n-        FileUtils.writeStringToFile(recordFile, \"corrupt\", \"UTF-8\");\n+        // setup", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44baf34f4535439c52d2787105db64476b3bce20"}, "originalPosition": 191}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMzM2MA==", "bodyText": "helpers should be at the bottom of the class so that tests are more visible", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#discussion_r389203360", "createdAt": "2020-03-07T00:22:26Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/RecordFileParserTest.java", "diffHunk": "@@ -73,88 +94,177 @@ void before() {\n                 .from(streamType.getPath(), \"v2\", \"record0.0.3\")\n                 .filterFiles(\"*.rcd\")\n                 .to(streamType.getPath(), streamType.getValid());\n+        file1 = parserProperties.getValidPath().resolve(\"2019-08-30T18_10_00.419072Z.rcd\").toFile();\n+        file2 = parserProperties.getValidPath().resolve(\"2019-08-30T18_10_05.249678Z.rcd\").toFile();\n+        recordFile1 = new RecordFile(0L, file1.getPath(), 0L, 0L,\n+                \"591558e059bd1629ee386c4e35a6875b4c67a096718f5d225772a651042715189414df7db5588495efb2a85dc4a0ffda\",\n+                \"\");\n+        recordFile2 = new RecordFile(0L, file2.getPath(), 0L, 0L,\n+                \"5ed51baeff204eb6a2a68b76bbaadcb9b6e7074676c1746b99681d075bef009e8d57699baaa6342feec4e83726582d36\",\n+                recordFile1.getFileHash());\n     }\n \n-    @Test\n-    void parse() throws Exception {\n-        fileCopier.copy();\n-        recordFileParser.parse();\n+    // Asserts that recordStreamFileListener.onStart is called exactly with given fileNames.\n+    private void assertOnStart(String... fileNames) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44baf34f4535439c52d2787105db64476b3bce20"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwNTQwOA==", "bodyText": "This should return Optional.empty() to match the previous behavior of skipping if already exists", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#discussion_r389205408", "createdAt": "2020-03-07T00:33:43Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/PostgresWritingRecordParsedItemHandler.java", "diffHunk": "@@ -52,8 +60,88 @@\n     private PreparedStatement sqlInsertLiveHashes;\n     private PreparedStatement sqlInsertTopicMessage;\n     private final PostgresWriterProperties properties;\n+    private final DataSource dataSource;\n+    private Connection connection;\n \n-    void initSqlStatements(Connection connection) throws ParserSQLException {\n+    @Override\n+    public Optional<RecordFile> onStart(StreamFileData streamFileData) {\n+        String fileName = streamFileData.getFilename();\n+        try {\n+            initConnectionAndStatements();\n+            long fileId;\n+\n+            try (CallableStatement fileCreate = connection.prepareCall(\"{? = call f_file_create( ? ) }\")) {\n+                fileCreate.registerOutParameter(1, Types.BIGINT);\n+                fileCreate.setString(2, fileName);\n+                fileCreate.execute();\n+                fileId = fileCreate.getLong(1);\n+            }\n+\n+            if (fileId == 0) {\n+                log.trace(\"File {} already exists in the database.\", fileName);\n+                closeConnectionAndStatements();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44baf34f4535439c52d2787105db64476b3bce20"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwNjMzOQ==", "bodyText": "None of these methods need to be overridden in the sub-interface. Please remove", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#discussion_r389206339", "createdAt": "2020-03-07T00:38:50Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/RecordStreamFileListener.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package com.hedera.mirror.importer.parser;\n+\n+import java.util.Optional;\n+\n+import com.hedera.mirror.importer.domain.RecordFile;\n+import com.hedera.mirror.importer.exception.ImporterException;\n+import com.hedera.mirror.importer.parser.domain.StreamFileData;\n+\n+public interface RecordStreamFileListener extends StreamFileListener<RecordFile> {\n+    @Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44baf34f4535439c52d2787105db64476b3bce20"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57da8b30b228e339654b930dec83efc1152c6c19", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/57da8b30b228e339654b930dec83efc1152c6c19", "committedDate": "2020-03-07T01:40:54Z", "message": "address review comments\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNzIwMzU0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/585#pullrequestreview-370720354", "createdAt": "2020-03-07T03:57:50Z", "commit": {"oid": "57da8b30b228e339654b930dec83efc1152c6c19"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3307, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}