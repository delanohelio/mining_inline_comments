{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5NzMzNzky", "number": 1358, "title": "Handle transactions without crypto transfers in transaction REST API", "bodyText": "Detailed description:\n\naccount.id can be either the payer account id of a transaction or the entity id in the crypto transfer, if the query does not use credit/debit type filter\nrefactor mysql style query to postgre style query conversion so duplicate query param value concat is not needed\nadd new transaction table index\n\nWhich issue(s) this PR fixes:\nFixes #1295\nSpecial notes for your reviewer:\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-12-14T19:02:07Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358", "merged": true, "mergeCommit": {"oid": "9a4121a03077747d0426aef1265dd42ee5ec54c2"}, "closed": true, "closedAt": "2020-12-16T22:56:11Z", "author": {"login": "xin-hedera"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmJFpKAH2gAyNTM5NzMzNzkyOjJhNDhkZjhiZmUzYjQ5OTQ0NTI3M2QzNTE1YjgyOWVkNzBmMDMxNDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdm2h4HAFqTU1NDEzMDE2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2a48df8bfe3b499445273d3515b829ed70f03144", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2a48df8bfe3b499445273d3515b829ed70f03144", "committedDate": "2020-12-14T17:21:40Z", "message": "query transactions without crypto transfer list\naccount.id now can be either the payer account id or the entity_id in crypto transfer list\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2116aca8fa2d149539080058b8a430d68c24b627", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2116aca8fa2d149539080058b8a430d68c24b627", "committedDate": "2020-12-14T17:22:41Z", "message": "Merge branch 'master' into handle-transactions-without-crypto-transfer\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75caa76ac6bc898b294b89ec0c7d36ed4e733e82", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/75caa76ac6bc898b294b89ec0c7d36ed4e733e82", "committedDate": "2020-12-14T18:49:41Z", "message": "- add flyway migration for new transaction index\n- add / update integration tests\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxODEyMDY2", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#pullrequestreview-551812066", "createdAt": "2020-12-14T19:13:37Z", "commit": {"oid": "75caa76ac6bc898b294b89ec0c7d36ed4e733e82"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOToxMzozN1rOIFhrKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOToxMzozN1rOIFhrKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY2NTUxMw==", "bodyText": "the comment no longer applies, will remove in the next commit", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r542665513", "createdAt": "2020-12-14T19:13:37Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -223,7 +270,10 @@ const reqToSql = function (req) {\n   const resultTypeQuery = utils.parseResultParams(req, 't.result');\n   const transactionTypeQuery = utils.getTransactionTypeQuery(parsedQueryParams);\n   const {query, params, order, limit} = utils.parseLimitAndOrderParams(req);\n-  const sqlParams = accountParams.concat(tsParams).concat(tsParams).concat(params);\n+\n+  // accountQuery and tsQuery will appear twice in the inner query, one for transaction table and one for\n+  // crypto_transfer table. So concat their params twice here to match the query.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75caa76ac6bc898b294b89ec0c7d36ed4e733e82"}, "originalPosition": 123}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0c23bd974bd11bef8cad7b72fdf2e992b1d12ee", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e0c23bd974bd11bef8cad7b72fdf2e992b1d12ee", "committedDate": "2020-12-14T19:46:29Z", "message": "address sonar code smells\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a790341c5903d2ce97a0c02204366ce2ece595d9", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a790341c5903d2ce97a0c02204366ce2ece595d9", "committedDate": "2020-12-14T19:51:35Z", "message": "Merge branch 'master' into handle-transactions-without-crypto-transfer\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/461a8ddea625d868ab56e190899b89476f6c3290", "committedDate": "2020-12-14T19:52:28Z", "message": "move V1.32.1 flyway migration script to v1 folder\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "620593580b07190ce194e5a2f2660b160ece6c62", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/620593580b07190ce194e5a2f2660b160ece6c62", "committedDate": "2020-12-14T20:26:37Z", "message": "code smell\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMDAyOTY2", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#pullrequestreview-552002966", "createdAt": "2020-12-15T00:01:55Z", "commit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwMDowMTo1NVrOIFyPDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwMDozOToyMFrOIFzbPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkzNjg0Nw==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * @param {String} query - they mysql query\n          \n          \n            \n             * @param {String} query - the mysql query", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r542936847", "createdAt": "2020-12-15T00:01:55Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -169,6 +171,22 @@ const buildWhereClause = function (...conditions) {\n   return clause === '' ? '' : `WHERE ${clause}`;\n };\n \n+/**\n+ * Convert parameters to the named format.\n+ *\n+ * @param {String} query - they mysql query", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk0NzUzOQ==", "bodyText": "I think this needs to be slightly reworded since it explicitly mentions Cryptotransfer, which no longer always applies.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r542947539", "createdAt": "2020-12-15T00:15:51Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -169,6 +171,22 @@ const buildWhereClause = function (...conditions) {\n   return clause === '' ? '' : `WHERE ${clause}`;\n };\n \n+/**\n+ * Convert parameters to the named format.\n+ *\n+ * @param {String} query - they mysql query\n+ * @param {String} prefix - the prefix for the named parameters\n+ * @return {String} - The converted query\n+ */\n+const convertToNamedQuery = function (query, prefix) {\n+  let index = 0;\n+  return query.replace(/\\?/g, () => {\n+    const namedParam = `?${prefix}${index}`;\n+    index += 1;\n+    return namedParam;\n+  });\n+};\n+\n /**\n  * Cryptotransfer transactions queries are organized as follows: First there's an inner query that selects the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk1MTMwMA==", "bodyText": "I'm sure this is a much bigger effort and out of the scope of this, but could this replace some of the logic in the individual parseQueryParam methods in utils.js and directly generate the needed format instead of converting, or is there a need for the mySql format somewhere?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r542951300", "createdAt": "2020-12-15T00:25:56Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -169,6 +171,22 @@ const buildWhereClause = function (...conditions) {\n   return clause === '' ? '' : `WHERE ${clause}`;\n };\n \n+/**\n+ * Convert parameters to the named format.\n+ *\n+ * @param {String} query - they mysql query\n+ * @param {String} prefix - the prefix for the named parameters\n+ * @return {String} - The converted query\n+ */\n+const convertToNamedQuery = function (query, prefix) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk1MjI1Nw==", "bodyText": "I'm also not 100% on the name, unless I'm misunderstanding \"named query\" makes me think of a JPA named query, which this is not really emulating.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r542952257", "createdAt": "2020-12-15T00:28:20Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -169,6 +171,22 @@ const buildWhereClause = function (...conditions) {\n   return clause === '' ? '' : `WHERE ${clause}`;\n };\n \n+/**\n+ * Convert parameters to the named format.\n+ *\n+ * @param {String} query - they mysql query\n+ * @param {String} prefix - the prefix for the named parameters\n+ * @return {String} - The converted query\n+ */\n+const convertToNamedQuery = function (query, prefix) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk1MTMwMA=="}, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk1NjM0OA==", "bodyText": "nit based on the other comments in this file.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // limit the query to transactions with crypto transfer list\n          \n          \n            \n                // limit the query to transactions with cryptotransfer list", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r542956348", "createdAt": "2020-12-15T00:39:20Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -195,23 +213,62 @@ const getTransactionsInnerQuery = function (\n   transactionTypeQuery,\n   order\n ) {\n-  const whereClause = buildWhereClause(tsQuery, resultTypeQuery, transactionTypeQuery);\n-  const ctlTsQuery = tsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n-  const ctlWhereClause = buildWhereClause(accountQuery, ctlTsQuery, creditDebitQuery);\n+  const namedAccountQuery = convertToNamedQuery(accountQuery, 'acct');\n+  const namedTsQuery = convertToNamedQuery(tsQuery, 'ts');\n+  const namedLimitQuery = convertToNamedQuery(limitQuery, 'limit');\n+  const ctlTsQuery = namedTsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n+  let ctlWhereClause;\n+\n+  if (creditDebitQuery) {\n+    // limit the query to transactions with crypto transfer list", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMTMxNDM5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#pullrequestreview-552131439", "createdAt": "2020-12-15T06:08:01Z", "commit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjowODowMVrOIF6eEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjowODowMVrOIF6eEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3MTc2MQ==", "bodyText": "Interesting, did not know about this way of using logical operators", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543071761", "createdAt": "2020-12-15T06:08:01Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -195,23 +213,62 @@ const getTransactionsInnerQuery = function (\n   transactionTypeQuery,\n   order\n ) {\n-  const whereClause = buildWhereClause(tsQuery, resultTypeQuery, transactionTypeQuery);\n-  const ctlTsQuery = tsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n-  const ctlWhereClause = buildWhereClause(accountQuery, ctlTsQuery, creditDebitQuery);\n+  const namedAccountQuery = convertToNamedQuery(accountQuery, 'acct');\n+  const namedTsQuery = convertToNamedQuery(tsQuery, 'ts');\n+  const namedLimitQuery = convertToNamedQuery(limitQuery, 'limit');\n+  const ctlTsQuery = namedTsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n+  let ctlWhereClause;\n+\n+  if (creditDebitQuery) {\n+    // limit the query to transactions with crypto transfer list\n+    ctlWhereClause = buildWhereClause(namedAccountQuery, ctlTsQuery, creditDebitQuery);\n+    const whereClause = buildWhereClause(namedTsQuery, resultTypeQuery, transactionTypeQuery);\n+    return `\n+      SELECT t.consensus_ns AS consensus_timestamp\n+      FROM transaction t\n+      JOIN (\n+        SELECT DISTINCT consensus_timestamp\n+        FROM crypto_transfer AS ctl\n+        ${ctlWhereClause}\n+        ORDER BY consensus_timestamp ${order}\n+      ) AS ctl\n+      ON t.consensus_ns = ctl.consensus_timestamp\n+      ${whereClause}\n+      ORDER BY t.consensus_ns ${order}\n+      ${namedLimitQuery}`;\n+  }\n+\n+  const transactionAccountQuery = namedAccountQuery.replace(/ctl\\.entity_id/g, 't.payer_account_id');\n+  const transactionWhereClause = buildWhereClause(\n+    transactionAccountQuery,\n+    namedTsQuery,\n+    resultTypeQuery,\n+    transactionTypeQuery\n+  );\n+  const ctlJoinClause =\n+    (resultTypeQuery || transactionTypeQuery) && 'JOIN transaction AS t ON ctl.consensus_timestamp = t.consensus_ns';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMTQxNzU3", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#pullrequestreview-552141757", "createdAt": "2020-12-15T06:33:03Z", "commit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjozMzowNFrOIF7FFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjo1NToxOFrOIF7qXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4MTc0OQ==", "bodyText": "I'm a little confused on the logic of this part, the way I'm reading this the FULL OUTER JOIN here would allow for cryptotransfers without a transaction row.  If that is a possibility, is it also possible to have a token transfer without a transaction row, etc?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543081749", "createdAt": "2020-12-15T06:33:04Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -195,23 +213,62 @@ const getTransactionsInnerQuery = function (\n   transactionTypeQuery,\n   order\n ) {\n-  const whereClause = buildWhereClause(tsQuery, resultTypeQuery, transactionTypeQuery);\n-  const ctlTsQuery = tsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n-  const ctlWhereClause = buildWhereClause(accountQuery, ctlTsQuery, creditDebitQuery);\n+  const namedAccountQuery = convertToNamedQuery(accountQuery, 'acct');\n+  const namedTsQuery = convertToNamedQuery(tsQuery, 'ts');\n+  const namedLimitQuery = convertToNamedQuery(limitQuery, 'limit');\n+  const ctlTsQuery = namedTsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n+  let ctlWhereClause;\n+\n+  if (creditDebitQuery) {\n+    // limit the query to transactions with crypto transfer list\n+    ctlWhereClause = buildWhereClause(namedAccountQuery, ctlTsQuery, creditDebitQuery);\n+    const whereClause = buildWhereClause(namedTsQuery, resultTypeQuery, transactionTypeQuery);\n+    return `\n+      SELECT t.consensus_ns AS consensus_timestamp\n+      FROM transaction t\n+      JOIN (\n+        SELECT DISTINCT consensus_timestamp\n+        FROM crypto_transfer AS ctl\n+        ${ctlWhereClause}\n+        ORDER BY consensus_timestamp ${order}\n+      ) AS ctl\n+      ON t.consensus_ns = ctl.consensus_timestamp\n+      ${whereClause}\n+      ORDER BY t.consensus_ns ${order}\n+      ${namedLimitQuery}`;\n+  }\n+\n+  const transactionAccountQuery = namedAccountQuery.replace(/ctl\\.entity_id/g, 't.payer_account_id');\n+  const transactionWhereClause = buildWhereClause(\n+    transactionAccountQuery,\n+    namedTsQuery,\n+    resultTypeQuery,\n+    transactionTypeQuery\n+  );\n+  const ctlJoinClause =\n+    (resultTypeQuery || transactionTypeQuery) && 'JOIN transaction AS t ON ctl.consensus_timestamp = t.consensus_ns';\n+  ctlWhereClause = buildWhereClause(namedAccountQuery, ctlTsQuery, resultTypeQuery, transactionTypeQuery);\n \n   return `\n-    SELECT t.consensus_ns AS consensus_timestamp\n-    FROM transaction t\n-    JOIN (\n-            SELECT DISTINCT consensus_timestamp\n-            FROM crypto_transfer AS ctl\n-            ${ctlWhereClause}\n-            ORDER BY consensus_timestamp ${order}\n-         ) AS ctl\n+    SELECT coalesce(t.consensus_ns,ctl.consensus_timestamp) AS consensus_timestamp\n+    FROM (\n+        SELECT consensus_ns\n+        FROM transaction AS t\n+        ${transactionWhereClause}\n+        ORDER BY consensus_ns ${order}\n+        ${namedLimitQuery}\n+    ) AS t\n+    FULL OUTER JOIN (\n+        SELECT DISTINCT ctl.consensus_timestamp AS consensus_timestamp", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4NTM3Nw==", "bodyText": "What is the gain to this change, or is it just a style preference?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543085377", "createdAt": "2020-12-15T06:42:03Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -255,14 +254,14 @@ const parseOperatorAndValueFromQueryParam = (paramValue) => {\n   if (splitItem.length === 1) {\n     // No operator specified. Just use \"eq:\"\n     return {op: opsMap.eq, value: splitItem[0]};\n-  } else if (splitItem.length === 2) {\n+  }\n+  if (splitItem.length === 2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4NTY1Ng==", "bodyText": "Same here, is this style or for a particular benefit?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543085656", "createdAt": "2020-12-15T06:42:41Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -355,7 +354,8 @@ const parseCreditDebitParams = (parsedQueryParams, columnName) => {\n   return parseParams(parsedQueryParams[constants.filterKeys.CREDIT_TYPE], (op, value) => {\n     if (value === 'credit') {\n       return [`${columnName} > 0`, []];\n-    } else if (value === 'debit') {\n+    }\n+    if (value === 'debit') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5MTI5Mw==", "bodyText": "There are two other places in this file that need to be updated as well.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543091293", "createdAt": "2020-12-15T06:55:18Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-rest/balances.js", "diffHunk": "@@ -91,7 +91,7 @@ const getBalances = async (req, res) => {\n       ${query}`;\n \n   const sqlParams = tsParams.concat(accountParams).concat(pubKeyParams).concat(balanceParams).concat(params);\n-  const pgSqlQuery = utils.convertMySqlStyleQueryToPostgres(sqlQuery, sqlParams);\n+  const pgSqlQuery = utils.convertMySqlStyleQueryToPostgres(sqlQuery);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "461a8ddea625d868ab56e190899b89476f6c3290"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11bcccb2ed10e2685033c542b17845e6afad8dc9", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/11bcccb2ed10e2685033c542b17845e6afad8dc9", "committedDate": "2020-12-15T16:33:07Z", "message": "address feedback\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5819eec25edad0fcf85a59c52afea25db0a78cc6", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5819eec25edad0fcf85a59c52afea25db0a78cc6", "committedDate": "2020-12-15T18:34:15Z", "message": "add comment for getTransactionsInnerQuery, small query optimization\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf90d9a5b4c67fbeae9a1f9a01ad3effc73b83a8", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bf90d9a5b4c67fbeae9a1f9a01ad3effc73b83a8", "committedDate": "2020-12-15T21:40:46Z", "message": "add config params for pg pool connectionTimeoutMillis, max, and statement_timeout\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db50e45f7b65f2fc34ba88ad8653ca61783acf8a", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/db50e45f7b65f2fc34ba88ad8653ca61783acf8a", "committedDate": "2020-12-15T21:44:32Z", "message": "revert accidental change\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fe3a7de2febdd5aeb1c761656c7ec01209ab7ff", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8fe3a7de2febdd5aeb1c761656c7ec01209ab7ff", "committedDate": "2020-12-15T22:02:30Z", "message": "fix the logic that customizing config file name causes skipping default configuration file\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNzYzODkz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#pullrequestreview-552763893", "createdAt": "2020-12-15T18:46:58Z", "commit": {"oid": "5819eec25edad0fcf85a59c52afea25db0a78cc6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxODo0Njo1OFrOIGaiEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMjoxMTowMFrOIGiRNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU5NzA3NA==", "bodyText": "Update description", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543597074", "createdAt": "2020-12-15T18:46:58Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-rest/__tests__/specs/transactions-19-timestamp-no-transfers.spec.json", "diffHunk": "@@ -0,0 +1,74 @@\n+{\n+  \"description\": \"Transaction api calls for transactions at timestamp\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5819eec25edad0fcf85a59c52afea25db0a78cc6"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcyMzgzMQ==", "bodyText": "I get the logic but this section is a little hard to follow and I worry that its complexity might contribute to challenges in managing it.\nDo you think there's a way to simplify or split it up into clearer functions.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r543723831", "createdAt": "2020-12-15T22:11:00Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -195,23 +213,72 @@ const getTransactionsInnerQuery = function (\n   transactionTypeQuery,\n   order\n ) {\n-  const whereClause = buildWhereClause(tsQuery, resultTypeQuery, transactionTypeQuery);\n-  const ctlTsQuery = tsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n-  const ctlWhereClause = buildWhereClause(accountQuery, ctlTsQuery, creditDebitQuery);\n+  // convert the mysql style '?' placeholder to the named parameter format, later the same named parameter is converted\n+  // to the same positional index, thus the caller only has to pass the value once for the same column\n+  const namedAccountQuery = convertToNamedQuery(accountQuery, 'acct');\n+  const namedTsQuery = convertToNamedQuery(tsQuery, 'ts');\n+  const namedLimitQuery = convertToNamedQuery(limitQuery, 'limit');\n \n-  return `\n-    SELECT t.consensus_ns AS consensus_timestamp\n-    FROM transaction t\n-    JOIN (\n-            SELECT DISTINCT consensus_timestamp\n-            FROM crypto_transfer AS ctl\n-            ${ctlWhereClause}\n-            ORDER BY consensus_timestamp ${order}\n-         ) AS ctl\n-    ON t.consensus_ns = ctl.consensus_timestamp\n-    ${whereClause}\n-    ORDER BY t.consensus_ns ${order}\n-    ${limitQuery}`;\n+  const ctlTsQuery = namedTsQuery.replace(/t\\.consensus_ns/g, 'ctl.consensus_timestamp');\n+  let ctlWhereClause;\n+\n+  if (creditDebitQuery) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5819eec25edad0fcf85a59c52afea25db0a78cc6"}, "originalPosition": 89}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2339180d4f15eb773df57cb72516d234912ad4e", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d2339180d4f15eb773df57cb72516d234912ad4e", "committedDate": "2020-12-15T22:27:16Z", "message": "address sonar reported code smell\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dff8b2f6e580c08e207105183e7efeed3d89f3c2", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/dff8b2f6e580c08e207105183e7efeed3d89f3c2", "committedDate": "2020-12-15T23:48:25Z", "message": "adress feedback, attempt to make the changes to getTransactionsInnerQuery more maintainable\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb2d009a31e1e56a59c8c1b52468ae4d14994c93", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/eb2d009a31e1e56a59c8c1b52468ae4d14994c93", "committedDate": "2020-12-15T23:52:12Z", "message": "update default for db.pool.connectionTimeout and db.pool.statementTimeout\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffcf69b80514db4a54fc54581e171db034cd2cbc", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ffcf69b80514db4a54fc54581e171db034cd2cbc", "committedDate": "2020-12-16T02:57:25Z", "message": "oops, forgot to update the document\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "967683b8d5919c7a9964159baa8fb7c41951c047", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/967683b8d5919c7a9964159baa8fb7c41951c047", "committedDate": "2020-12-16T02:58:02Z", "message": "Merge branch 'rest-db-pool-config-params' into handle-transactions-without-crypto-transfer\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae64660f6500dc5cd12fb13a6dfcd8e64471fe22", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ae64660f6500dc5cd12fb13a6dfcd8e64471fe22", "committedDate": "2020-12-16T16:13:46Z", "message": "Merge branch 'master' into handle-transactions-without-crypto-transfer\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf2602b3ad55b54a6323a97eabddd7bf3431f2b4", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bf2602b3ad55b54a6323a97eabddd7bf3431f2b4", "committedDate": "2020-12-16T16:43:01Z", "message": "address code smell\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzOTMxMDA1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#pullrequestreview-553931005", "createdAt": "2020-12-16T17:41:28Z", "commit": {"oid": "bf2602b3ad55b54a6323a97eabddd7bf3431f2b4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNzo0MToyOFrOIHRV5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNzo0MToyOFrOIHRV5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5NTA3Nw==", "bodyText": "Can you add another spec for account transaction with no transfers to make sure that's picked up.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#discussion_r544495077", "createdAt": "2020-12-16T17:41:28Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-rest/__tests__/specs/accounts-10-account-transactions.spec.json", "diffHunk": "@@ -83,6 +92,20 @@\n   \"responseStatus\": 200,\n   \"responseJson\": {\n     \"transactions\": [\n+      {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf2602b3ad55b54a6323a97eabddd7bf3431f2b4"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzOTYwMDM4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#pullrequestreview-553960038", "createdAt": "2020-12-16T18:16:58Z", "commit": {"oid": "bf2602b3ad55b54a6323a97eabddd7bf3431f2b4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb5d6c2c4b7538be434912db1cc731ee52f1fd50", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bb5d6c2c4b7538be434912db1cc731ee52f1fd50", "committedDate": "2020-12-16T20:22:37Z", "message": "add a cryptotransfer transaction with no tx fee and no hbar transfer from/to payer account to accounts-14-account-transactions-transactiontype.spec.json\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MDY4NTc2", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#pullrequestreview-554068576", "createdAt": "2020-12-16T20:44:11Z", "commit": {"oid": "bb5d6c2c4b7538be434912db1cc731ee52f1fd50"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MTI5MjY1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#pullrequestreview-554129265", "createdAt": "2020-12-16T22:16:46Z", "commit": {"oid": "bb5d6c2c4b7538be434912db1cc731ee52f1fd50"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MTMwMTY0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1358#pullrequestreview-554130164", "createdAt": "2020-12-16T22:18:14Z", "commit": {"oid": "bb5d6c2c4b7538be434912db1cc731ee52f1fd50"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3428, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}