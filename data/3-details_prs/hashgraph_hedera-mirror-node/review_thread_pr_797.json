{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1MzgxMDA3", "number": 797, "reviewThreads": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMToxNDozMlrOEB7Cgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNToyNDozM1rOED8B3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNDUxMzMxOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/pom.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMToxNDozMlrOGeEMug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzo0MjoxN1rOGgz_gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3OTI1OA==", "bodyText": "Already included, can be removed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r434179258", "createdAt": "2020-06-02T21:14:32Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/pom.xml", "diffHunk": "@@ -214,6 +216,18 @@\n             <version>${testcontainers.version}</version>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>org.testcontainers</groupId>\n+            <artifactId>testcontainers</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1OTQ1OA==", "bodyText": "Removed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437059458", "createdAt": "2020-06-08T23:42:17Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/pom.xml", "diffHunk": "@@ -214,6 +216,18 @@\n             <version>${testcontainers.version}</version>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>org.testcontainers</groupId>\n+            <artifactId>testcontainers</artifactId>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3OTI1OA=="}, "originalCommit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNDUyNDIzOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/db/DBProperties.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMToxNzo1N1rOGeETXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzo0MjozN1rOGgz_7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE4MDk1OQ==", "bodyText": "Strings should all be @NotBlank.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r434180959", "createdAt": "2020-06-02T21:17:57Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/db/DBProperties.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.hedera.mirror.importer.db;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import javax.validation.constraints.NotNull;\n+import lombok.Builder;\n+import lombok.Data;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.boot.context.properties.ConstructorBinding;\n+import org.springframework.validation.annotation.Validated;\n+\n+@Data\n+@Validated\n+@Builder(toBuilder = true)\n+@ConfigurationProperties(\"hedera.mirror.importer.db\")\n+@ConstructorBinding\n+public class DBProperties {\n+    @NotNull", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1OTU2NA==", "bodyText": "Updated. Left restUser and password since not necessary if you're not using REST api but the rest are needed for importer to get data flowing", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437059564", "createdAt": "2020-06-08T23:42:37Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/db/DBProperties.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.hedera.mirror.importer.db;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import javax.validation.constraints.NotNull;\n+import lombok.Builder;\n+import lombok.Data;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.boot.context.properties.ConstructorBinding;\n+import org.springframework.validation.annotation.Validated;\n+\n+@Data\n+@Validated\n+@Builder(toBuilder = true)\n+@ConfigurationProperties(\"hedera.mirror.importer.db\")\n+@ConstructorBinding\n+public class DBProperties {\n+    @NotNull", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE4MDk1OQ=="}, "originalCommit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNDUyNjI1OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/db/DBProperties.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMToxODozNFrOGeEUow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzo0MzowMFrOGg0AZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE4MTI4Mw==", "bodyText": "Primitives can't be null. Min(0) would be appropriate though", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r434181283", "createdAt": "2020-06-02T21:18:34Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/db/DBProperties.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.hedera.mirror.importer.db;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import javax.validation.constraints.NotNull;\n+import lombok.Builder;\n+import lombok.Data;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.boot.context.properties.ConstructorBinding;\n+import org.springframework.validation.annotation.Validated;\n+\n+@Data\n+@Validated\n+@Builder(toBuilder = true)\n+@ConfigurationProperties(\"hedera.mirror.importer.db\")\n+@ConstructorBinding\n+public class DBProperties {\n+    @NotNull\n+    private String host = \"\";\n+\n+    @NotNull\n+    private String name = \"\";\n+\n+    @NotNull\n+    private String password = \"\";\n+\n+    @NotNull", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1OTY4NA==", "bodyText": "Fixed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437059684", "createdAt": "2020-06-08T23:43:00Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/db/DBProperties.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.hedera.mirror.importer.db;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import javax.validation.constraints.NotNull;\n+import lombok.Builder;\n+import lombok.Data;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.boot.context.properties.ConstructorBinding;\n+import org.springframework.validation.annotation.Validated;\n+\n+@Data\n+@Validated\n+@Builder(toBuilder = true)\n+@ConfigurationProperties(\"hedera.mirror.importer.db\")\n+@ConstructorBinding\n+public class DBProperties {\n+    @NotNull\n+    private String host = \"\";\n+\n+    @NotNull\n+    private String name = \"\";\n+\n+    @NotNull\n+    private String password = \"\";\n+\n+    @NotNull", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE4MTI4Mw=="}, "originalCommit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNDYyNTEwOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMTo1NDo1NVrOGeFS8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzo0MzoxMFrOGg0Alw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5NzIzMg==", "bodyText": "Shouldn't mix and match base images. Just use alpine for both if you can as it's smaller.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r434197232", "createdAt": "2020-06-02T21:54:55Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile", "diffHunk": "@@ -0,0 +1,33 @@\n+# docker build -f hedera-mirror-importer/src/test/resources/data/restore-client//Dockerfile \\\n+#   ./hedera-mirror-importer/src/test/resources/data/  \\\n+#   --build-arg dumpfile=<pgdump.gz>  --build-arg jsonkeyfile=bucket-download-key.json\n+#   -t hedera-mirror-node/postgres-restore-client\n+FROM debian:stretch AS build\n+\n+# get dump file\n+ARG dumpfile\n+ARG jsonkeyfile\n+\n+RUN apt-get -qqy update && apt-get install -qqy curl python-dev\n+RUN curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz\n+RUN tar -C /usr/local/ -xvf /tmp/google-cloud-sdk.tar.gz\n+RUN /usr/local/google-cloud-sdk/install.sh\n+\n+COPY ./$jsonkeyfile /tmp/config.json\n+RUN /usr/local/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file /tmp/config.json\n+\n+\n+RUN /usr/local/google-cloud-sdk/bin/gsutil cp gs://hedera-mirror-dev/database/$dumpfile /tmp/pgdump.gz\n+RUN rm /tmp/config.json\n+\n+FROM alpine:latest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1OTczNQ==", "bodyText": "Switched to using alpine and keeping it small", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437059735", "createdAt": "2020-06-08T23:43:10Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile", "diffHunk": "@@ -0,0 +1,33 @@\n+# docker build -f hedera-mirror-importer/src/test/resources/data/restore-client//Dockerfile \\\n+#   ./hedera-mirror-importer/src/test/resources/data/  \\\n+#   --build-arg dumpfile=<pgdump.gz>  --build-arg jsonkeyfile=bucket-download-key.json\n+#   -t hedera-mirror-node/postgres-restore-client\n+FROM debian:stretch AS build\n+\n+# get dump file\n+ARG dumpfile\n+ARG jsonkeyfile\n+\n+RUN apt-get -qqy update && apt-get install -qqy curl python-dev\n+RUN curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz\n+RUN tar -C /usr/local/ -xvf /tmp/google-cloud-sdk.tar.gz\n+RUN /usr/local/google-cloud-sdk/install.sh\n+\n+COPY ./$jsonkeyfile /tmp/config.json\n+RUN /usr/local/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file /tmp/config.json\n+\n+\n+RUN /usr/local/google-cloud-sdk/bin/gsutil cp gs://hedera-mirror-dev/database/$dumpfile /tmp/pgdump.gz\n+RUN rm /tmp/config.json\n+\n+FROM alpine:latest", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5NzIzMg=="}, "originalCommit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNDY2MzUyOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/CustomPostgresContainer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMjoxMDo1N1rOGeFrNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzo0Mzo1MVrOGg0Bbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIwMzQ0NQ==", "bodyText": "You don't need to provide build args if you just want to run the image. Those args are only for build stage which happens manually via mvn.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r434203445", "createdAt": "2020-06-02T22:10:57Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/CustomPostgresContainer.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.images.builder.ImageFromDockerfile;\n+\n+public class CustomPostgresContainer {\n+    public static ImageFromDockerfile createSeededDockerImage(String dockerFilePath, String pgDumpFile) {\n+        return new ImageFromDockerfile()\n+                .withFileFromClasspath(\"Dockerfile\", dockerFilePath)\n+                .withFileFromClasspath(\"bucket-download-key.json\", \"data/bucket-download-key.json\")\n+                .withFileFromClasspath(\"postgresql.conf\", \"data/postgresql.conf\")\n+                .withBuildArg(\"dumpfile\", pgDumpFile)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1OTk1MA==", "bodyText": "Removed as image build logic was removed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437059950", "createdAt": "2020-06-08T23:43:51Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/CustomPostgresContainer.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.images.builder.ImageFromDockerfile;\n+\n+public class CustomPostgresContainer {\n+    public static ImageFromDockerfile createSeededDockerImage(String dockerFilePath, String pgDumpFile) {\n+        return new ImageFromDockerfile()\n+                .withFileFromClasspath(\"Dockerfile\", dockerFilePath)\n+                .withFileFromClasspath(\"bucket-download-key.json\", \"data/bucket-download-key.json\")\n+                .withFileFromClasspath(\"postgresql.conf\", \"data/postgresql.conf\")\n+                .withBuildArg(\"dumpfile\", pgDumpFile)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIwMzQ0NQ=="}, "originalCommit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTc0NDY0OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/pom.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNToxMDoxMVrOGfydjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzo0NDowOFrOGg0B4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4NTgwNQ==", "bodyText": "nit: testcontainers.version", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r435985805", "createdAt": "2020-06-05T15:10:11Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/pom.xml", "diffHunk": "@@ -20,6 +20,7 @@\n         <commons-io.version>2.6</commons-io.version>\n         <guava.version>29.0-jre</guava.version>\n         <s3mock.version>0.2.5</s3mock.version>\n+        <testcontainer.version>1.14.3</testcontainer.version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA2MDA2NA==", "bodyText": "Updated", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437060064", "createdAt": "2020-06-08T23:44:08Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/pom.xml", "diffHunk": "@@ -20,6 +20,7 @@\n         <commons-io.version>2.6</commons-io.version>\n         <guava.version>29.0-jre</guava.version>\n         <s3mock.version>0.2.5</s3mock.version>\n+        <testcontainer.version>1.14.3</testcontainer.version>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4NTgwNQ=="}, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTc1MDI4OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/resources/data/postgresql.conf", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNToxMTo1MlrOGfyhSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzo0NDoxNVrOGg0B9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4Njc2Mg==", "bodyText": "This file can be removed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r435986762", "createdAt": "2020-06-05T15:11:52Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/resources/data/postgresql.conf", "diffHunk": "@@ -0,0 +1,3 @@\n+listen_addresses = '*'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA2MDA4Nw==", "bodyText": "Removed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437060087", "createdAt": "2020-06-08T23:44:15Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/resources/data/postgresql.conf", "diffHunk": "@@ -0,0 +1,3 @@\n+listen_addresses = '*'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4Njc2Mg=="}, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTc1MTQ1OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/resources/data/base-image/Dockerfile", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNToxMjowN1rOGfyiBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzo0NDoyMlrOGg0CDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4Njk0OA==", "bodyText": "This file and folder can be removed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r435986948", "createdAt": "2020-06-05T15:12:07Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/resources/data/base-image/Dockerfile", "diffHunk": "@@ -0,0 +1,26 @@\n+# Empty postgres db image with mirror node users and empty database created\n+# Build using command from repo root:\n+# docker build -f hedera-mirror-importer/src/test/resources/data/base-image/Dockerfile \\\n+#   ./hedera-mirror-importer/ \\\n+#   -t gcr.io/mirrornode/hedera-mirror-node/postgres:latest\n+FROM postgres:9.6", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA2MDEwOQ==", "bodyText": "Removed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437060109", "createdAt": "2020-06-08T23:44:22Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/resources/data/base-image/Dockerfile", "diffHunk": "@@ -0,0 +1,26 @@\n+# Empty postgres db image with mirror node users and empty database created\n+# Build using command from repo root:\n+# docker build -f hedera-mirror-importer/src/test/resources/data/base-image/Dockerfile \\\n+#   ./hedera-mirror-importer/ \\\n+#   -t gcr.io/mirrornode/hedera-mirror-node/postgres:latest\n+FROM postgres:9.6", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4Njk0OA=="}, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTc4MjkwOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/resources/data/restore.sh", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNToxOTo1NFrOGfy1ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNTozMTowN1rOGhQT9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk5MTkxNA==", "bodyText": "We should not be creating users in a restore client docker image. This would fail if ran against Cloud SQL. Recommend removing restore.sh and just making entrypoint pg_restore", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r435991914", "createdAt": "2020-06-05T15:19:54Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/resources/data/restore.sh", "diffHunk": "@@ -0,0 +1,16 @@\n+#!/bin/sh\n+set -e\n+\n+echo \"Setting user and role for Mirror Node\"\n+PGPASSWORD=$DB_PASS psql -v ON_ERROR_STOP=1 --username \"$DB_USER\" --dbname \"$DB_NAME\" -p \"$DB_PORT\" -h localhost <<-EOSQL\n+    \\set db_user 'mirror_node'\n+    \\set db_password 'mirror_node_pass'\n+\n+    create user :db_user with login createrole password :'db_password';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA2MDM2Mw==", "bodyText": "Without this pg_restore fails since it expects the mirror_node role role present.\nCurrent dumps require this role.\nWill look into if there's pg_restore option around it", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437060363", "createdAt": "2020-06-08T23:45:17Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/resources/data/restore.sh", "diffHunk": "@@ -0,0 +1,16 @@\n+#!/bin/sh\n+set -e\n+\n+echo \"Setting user and role for Mirror Node\"\n+PGPASSWORD=$DB_PASS psql -v ON_ERROR_STOP=1 --username \"$DB_USER\" --dbname \"$DB_NAME\" -p \"$DB_PORT\" -h localhost <<-EOSQL\n+    \\set db_user 'mirror_node'\n+    \\set db_password 'mirror_node_pass'\n+\n+    create user :db_user with login createrole password :'db_password';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk5MTkxNA=="}, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA2MTc3OQ==", "bodyText": "Should've probably used pg_dumpall to get all databases", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437061779", "createdAt": "2020-06-08T23:50:20Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/resources/data/restore.sh", "diffHunk": "@@ -0,0 +1,16 @@\n+#!/bin/sh\n+set -e\n+\n+echo \"Setting user and role for Mirror Node\"\n+PGPASSWORD=$DB_PASS psql -v ON_ERROR_STOP=1 --username \"$DB_USER\" --dbname \"$DB_NAME\" -p \"$DB_PORT\" -h localhost <<-EOSQL\n+    \\set db_user 'mirror_node'\n+    \\set db_password 'mirror_node_pass'\n+\n+    create user :db_user with login createrole password :'db_password';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk5MTkxNA=="}, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUyMzQ0Ng==", "bodyText": "Alternatively, maybe we should've not used --clean and added --data-only with pg_dump so it just contained data. This would keep the roles and schema and make the tests responsible for cleaning up data and running migrations. We can maybe manually modify the dump files to remove those statements.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437523446", "createdAt": "2020-06-09T15:31:07Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/resources/data/restore.sh", "diffHunk": "@@ -0,0 +1,16 @@\n+#!/bin/sh\n+set -e\n+\n+echo \"Setting user and role for Mirror Node\"\n+PGPASSWORD=$DB_PASS psql -v ON_ERROR_STOP=1 --username \"$DB_USER\" --dbname \"$DB_NAME\" -p \"$DB_PORT\" -h localhost <<-EOSQL\n+    \\set db_user 'mirror_node'\n+    \\set db_password 'mirror_node_pass'\n+\n+    create user :db_user with login createrole password :'db_password';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk5MTkxNA=="}, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTgxMTA2OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNToyNzoyM1rOGfzHRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzo0NjowMFrOGg0D0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk5NjQ4Ng==", "bodyText": "Not necessary to remove as this build image is not pushed anywhere.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r435996486", "createdAt": "2020-06-05T15:27:23Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile", "diffHunk": "@@ -0,0 +1,42 @@\n+# Creates image to be used as an executable container that performs a pg_restore against an already existing database\n+# docker build -f hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile \\\n+#   ./hedera-mirror-importer/src/test/resources/data/  \\\n+#   --build-arg dumpfile=<pgdump.gz>  --build-arg jsonkeyfile=bucket-download-key.json\n+#   -t gcr.io/mirrornode/hedera-mirror-node/postgres-restore-client:latest\n+FROM debian:stretch AS build\n+\n+ARG dumpfile\n+ARG jsonkeyfile\n+\n+# install gcloud tools\n+RUN apt-get -qqy update && apt-get install -qqy curl python-dev\n+RUN curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz\n+RUN tar -C /usr/local/ -xvf /tmp/google-cloud-sdk.tar.gz\n+RUN /usr/local/google-cloud-sdk/install.sh\n+\n+# pull in key file and set up account\n+COPY ./$jsonkeyfile /tmp/config.json\n+RUN /usr/local/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file /tmp/config.json\n+\n+# download file from remote bucket and remove key file\n+RUN /usr/local/google-cloud-sdk/bin/gsutil cp gs://hedera-mirror-dev/database/$dumpfile /tmp/pgdump.gz\n+RUN rm /tmp/config.json", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA2MDU2MQ==", "bodyText": "Leftover logic before I had a build image Removed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437060561", "createdAt": "2020-06-08T23:46:00Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile", "diffHunk": "@@ -0,0 +1,42 @@\n+# Creates image to be used as an executable container that performs a pg_restore against an already existing database\n+# docker build -f hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile \\\n+#   ./hedera-mirror-importer/src/test/resources/data/  \\\n+#   --build-arg dumpfile=<pgdump.gz>  --build-arg jsonkeyfile=bucket-download-key.json\n+#   -t gcr.io/mirrornode/hedera-mirror-node/postgres-restore-client:latest\n+FROM debian:stretch AS build\n+\n+ARG dumpfile\n+ARG jsonkeyfile\n+\n+# install gcloud tools\n+RUN apt-get -qqy update && apt-get install -qqy curl python-dev\n+RUN curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz\n+RUN tar -C /usr/local/ -xvf /tmp/google-cloud-sdk.tar.gz\n+RUN /usr/local/google-cloud-sdk/install.sh\n+\n+# pull in key file and set up account\n+COPY ./$jsonkeyfile /tmp/config.json\n+RUN /usr/local/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file /tmp/config.json\n+\n+# download file from remote bucket and remove key file\n+RUN /usr/local/google-cloud-sdk/bin/gsutil cp gs://hedera-mirror-dev/database/$dumpfile /tmp/pgdump.gz\n+RUN rm /tmp/config.json", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk5NjQ4Ng=="}, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTgxMTYxOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNToyNzozMlrOGfzHqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzo0NjoyNFrOGg0ERg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk5NjU4NQ==", "bodyText": "This file and associated files should not live in src/test/resources/data as they are not data. Would recommend src/test/resources/scripts/restore-client/", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r435996585", "createdAt": "2020-06-05T15:27:32Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile", "diffHunk": "@@ -0,0 +1,42 @@\n+# Creates image to be used as an executable container that performs a pg_restore against an already existing database\n+# docker build -f hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA2MDY3OA==", "bodyText": "Moved to /scripts", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437060678", "createdAt": "2020-06-08T23:46:24Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile", "diffHunk": "@@ -0,0 +1,42 @@\n+# Creates image to be used as an executable container that performs a pg_restore against an already existing database\n+# docker build -f hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile \\", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk5NjU4NQ=="}, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTgzMTQxOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/PerformanceIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNTozMzowMFrOGfzUjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzo0NzoxMlrOGg0FFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk5OTg4Nw==", "bodyText": "Why are we duplicating and performance testing REST queries in the importer module? If the queries change in REST API we now have to change it here. We already have performance tests for the REST API in the REST API module. We should later figure out how to use the restore client to populate the data for the tests there. Recommend these be removed.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r435999887", "createdAt": "2020-06-05T15:33:00Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/PerformanceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.nio.file.Path;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Resource;\n+import javax.sql.DataSource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.test.context.SpringBootTest;\n+\n+import com.hedera.mirror.importer.FileCopier;\n+import com.hedera.mirror.importer.domain.ApplicationStatusCode;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.parser.record.RecordFileParser;\n+import com.hedera.mirror.importer.parser.record.RecordParserProperties;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+\n+@Log4j2\n+@SpringBootTest\n+public abstract class PerformanceIntegrationTest {\n+    @Resource\n+    DataSource dataSource;\n+\n+    Connection connection;\n+\n+    @Resource\n+    private ApplicationStatusRepository applicationStatusRepository;\n+\n+    @TempDir\n+    static Path dataPath;\n+\n+    @Value(\"classpath:data\")\n+    Path testPath;\n+\n+    @Resource\n+    private RecordFileParser recordFileParser;\n+\n+    private FileCopier fileCopier;\n+\n+    private StreamType streamType;\n+\n+    @Resource\n+    private RecordParserProperties parserProperties;\n+\n+    void parse(String filePath) {\n+        streamType = parserProperties.getStreamType();\n+        parserProperties.getMirrorProperties().setDataPath(dataPath);\n+        parserProperties.init();\n+\n+        fileCopier = FileCopier.create(testPath, dataPath)\n+                .from(streamType.getPath(), \"performance\")\n+                .filterFiles(filePath)\n+                .to(streamType.getPath(), streamType.getValid());\n+        fileCopier.copy();\n+\n+        recordFileParser.parse();\n+    }\n+\n+    void checkSeededTablesArePresent() {\n+        String[] tables = new String[] {\"account_balance_sets\", \"account_balances\", \"flyway_schema_history\",\n+                \"non_fee_transfers\", \"t_application_status\", \"t_contract_result\", \"t_cryptotransferlists\",\n+                \"t_entities\", \"t_entity_types\", \"t_file_data\", \"t_livehashes\", \"t_record_files\",\n+                \"t_transaction_results\",\n+                \"t_transaction_types\", \"t_transactions\", \"topic_message\"\n+        };\n+        List<String> discoveredTables = new ArrayList<>();\n+\n+        try (Connection connection = dataSource.getConnection();\n+             ResultSet rs = connection.getMetaData().getTables(null, null, null, new String[] {\"TABLE\"})) {\n+\n+            while (rs.next()) {\n+                discoveredTables.add(rs.getString(\"TABLE_NAME\"));\n+            }\n+        } catch (Exception e) {\n+            log.error(\"Unable to retrieve details from database\", e);\n+        }\n+\n+        assertThat(discoveredTables.size()).isGreaterThan(0);\n+        Collections.sort(discoveredTables);\n+        log.info(\"Encountered tables: {}\", discoveredTables);\n+        assertThat(discoveredTables).isEqualTo(Arrays.asList(tables));\n+    }\n+\n+    long getTableSize(String table) throws SQLException {\n+        PreparedStatement statement = connection.prepareStatement(\"select count (*) from \" + table);\n+        ResultSet rs = statement.executeQuery();\n+        rs.next();\n+        return rs.getLong(\"count\");\n+    }\n+\n+    void getAccounts(long pageSize) throws SQLException {\n+        String sqlQuery = \"select ab.balance as account_balance\\n\" +\n+                \"    , ab.consensus_timestamp as consensus_timestamp\\n\" +\n+                \"    , 0 as entity_shard\\n\" +\n+                \"    , coalesce(ab.account_realm_num, e.entity_realm) as entity_realm\\n\" +\n+                \"    , coalesce(ab.account_num, e.entity_num) as entity_num\\n\" +\n+                \"    , e.exp_time_ns\\n\" +\n+                \"    , e.auto_renew_period\\n\" +\n+                \"    , e.key\\n\" +\n+                \"    , e.deleted\\n\" +\n+                \"from account_balances ab\\n\" +\n+                \"full outer join t_entities e\\n\" +\n+                \"    on (0 = e.entity_shard\\n\" +\n+                \"        and ab.account_realm_num = e.entity_realm\\n\" +\n+                \"        and ab.account_num =  e.entity_num\\n\" +\n+                \"        and e.fk_entity_type_id < 3)\\n\" +\n+                \"where ab.consensus_timestamp = (select max(consensus_timestamp) from account_balances)\\n\" +\n+                \"    and \\n\" +\n+                \"1=1 and 1=1 and 1=1 order by coalesce(ab.account_num, e.entity_num) desc\\n\" +\n+                \"limit ?\";\n+        runSelectStatementWithPageSize(sqlQuery, pageSize);\n+    }\n+\n+    void getBalances(long pageSize) throws SQLException {\n+        String sqlQuery = \"select ab.consensus_timestamp,\\n\" +\n+                \"ab.account_realm_num as realm_num, ab.account_num as entity_num, ab.balance\\n\" +\n+                \" from account_balances ab\\n\" +\n+                \" where  consensus_timestamp = (select consensus_timestamp from account_balances ab\\n\" +\n+                \" where\\n\" +\n+                \"((ab.consensus_timestamp  >=  0) )\\n\" +\n+                \"order by consensus_timestamp desc limit 1)\\n\" +\n+                \" and\\n\" +\n+                \"1=1 and 1=1 and 1=1 order by consensus_timestamp desc, account_realm_num desc,account_num desc limit\" +\n+                \" ?\";\n+        runSelectStatementWithPageSize(sqlQuery, pageSize);\n+    }\n+\n+    void getTopicMessages(long pageSize) throws SQLException {\n+        String sqlQuery = \"select consensus_timestamp, realm_num, topic_num, message, running_hash, sequence_number\\n\" +\n+                \"from topic_message limit ?;\";\n+\n+        runSelectStatementWithPageSize(sqlQuery, pageSize);\n+    }\n+\n+    void getTransactions(long pageSize) throws SQLException {\n+        String sqlQuery = \"select etrans.entity_shard,  etrans.entity_realm, etrans.entity_num\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 166}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA2MDg4Nw==", "bodyText": "This was a suggestive test method for use so we could answer questions like \"If we changed a in the db how are customer REST API calls affected\"\nRemoving though as I agree with the respecting module boundaries and the extra maintenance concern", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437060887", "createdAt": "2020-06-08T23:47:12Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/PerformanceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.nio.file.Path;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Resource;\n+import javax.sql.DataSource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.test.context.SpringBootTest;\n+\n+import com.hedera.mirror.importer.FileCopier;\n+import com.hedera.mirror.importer.domain.ApplicationStatusCode;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.parser.record.RecordFileParser;\n+import com.hedera.mirror.importer.parser.record.RecordParserProperties;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+\n+@Log4j2\n+@SpringBootTest\n+public abstract class PerformanceIntegrationTest {\n+    @Resource\n+    DataSource dataSource;\n+\n+    Connection connection;\n+\n+    @Resource\n+    private ApplicationStatusRepository applicationStatusRepository;\n+\n+    @TempDir\n+    static Path dataPath;\n+\n+    @Value(\"classpath:data\")\n+    Path testPath;\n+\n+    @Resource\n+    private RecordFileParser recordFileParser;\n+\n+    private FileCopier fileCopier;\n+\n+    private StreamType streamType;\n+\n+    @Resource\n+    private RecordParserProperties parserProperties;\n+\n+    void parse(String filePath) {\n+        streamType = parserProperties.getStreamType();\n+        parserProperties.getMirrorProperties().setDataPath(dataPath);\n+        parserProperties.init();\n+\n+        fileCopier = FileCopier.create(testPath, dataPath)\n+                .from(streamType.getPath(), \"performance\")\n+                .filterFiles(filePath)\n+                .to(streamType.getPath(), streamType.getValid());\n+        fileCopier.copy();\n+\n+        recordFileParser.parse();\n+    }\n+\n+    void checkSeededTablesArePresent() {\n+        String[] tables = new String[] {\"account_balance_sets\", \"account_balances\", \"flyway_schema_history\",\n+                \"non_fee_transfers\", \"t_application_status\", \"t_contract_result\", \"t_cryptotransferlists\",\n+                \"t_entities\", \"t_entity_types\", \"t_file_data\", \"t_livehashes\", \"t_record_files\",\n+                \"t_transaction_results\",\n+                \"t_transaction_types\", \"t_transactions\", \"topic_message\"\n+        };\n+        List<String> discoveredTables = new ArrayList<>();\n+\n+        try (Connection connection = dataSource.getConnection();\n+             ResultSet rs = connection.getMetaData().getTables(null, null, null, new String[] {\"TABLE\"})) {\n+\n+            while (rs.next()) {\n+                discoveredTables.add(rs.getString(\"TABLE_NAME\"));\n+            }\n+        } catch (Exception e) {\n+            log.error(\"Unable to retrieve details from database\", e);\n+        }\n+\n+        assertThat(discoveredTables.size()).isGreaterThan(0);\n+        Collections.sort(discoveredTables);\n+        log.info(\"Encountered tables: {}\", discoveredTables);\n+        assertThat(discoveredTables).isEqualTo(Arrays.asList(tables));\n+    }\n+\n+    long getTableSize(String table) throws SQLException {\n+        PreparedStatement statement = connection.prepareStatement(\"select count (*) from \" + table);\n+        ResultSet rs = statement.executeQuery();\n+        rs.next();\n+        return rs.getLong(\"count\");\n+    }\n+\n+    void getAccounts(long pageSize) throws SQLException {\n+        String sqlQuery = \"select ab.balance as account_balance\\n\" +\n+                \"    , ab.consensus_timestamp as consensus_timestamp\\n\" +\n+                \"    , 0 as entity_shard\\n\" +\n+                \"    , coalesce(ab.account_realm_num, e.entity_realm) as entity_realm\\n\" +\n+                \"    , coalesce(ab.account_num, e.entity_num) as entity_num\\n\" +\n+                \"    , e.exp_time_ns\\n\" +\n+                \"    , e.auto_renew_period\\n\" +\n+                \"    , e.key\\n\" +\n+                \"    , e.deleted\\n\" +\n+                \"from account_balances ab\\n\" +\n+                \"full outer join t_entities e\\n\" +\n+                \"    on (0 = e.entity_shard\\n\" +\n+                \"        and ab.account_realm_num = e.entity_realm\\n\" +\n+                \"        and ab.account_num =  e.entity_num\\n\" +\n+                \"        and e.fk_entity_type_id < 3)\\n\" +\n+                \"where ab.consensus_timestamp = (select max(consensus_timestamp) from account_balances)\\n\" +\n+                \"    and \\n\" +\n+                \"1=1 and 1=1 and 1=1 order by coalesce(ab.account_num, e.entity_num) desc\\n\" +\n+                \"limit ?\";\n+        runSelectStatementWithPageSize(sqlQuery, pageSize);\n+    }\n+\n+    void getBalances(long pageSize) throws SQLException {\n+        String sqlQuery = \"select ab.consensus_timestamp,\\n\" +\n+                \"ab.account_realm_num as realm_num, ab.account_num as entity_num, ab.balance\\n\" +\n+                \" from account_balances ab\\n\" +\n+                \" where  consensus_timestamp = (select consensus_timestamp from account_balances ab\\n\" +\n+                \" where\\n\" +\n+                \"((ab.consensus_timestamp  >=  0) )\\n\" +\n+                \"order by consensus_timestamp desc limit 1)\\n\" +\n+                \" and\\n\" +\n+                \"1=1 and 1=1 and 1=1 order by consensus_timestamp desc, account_realm_num desc,account_num desc limit\" +\n+                \" ?\";\n+        runSelectStatementWithPageSize(sqlQuery, pageSize);\n+    }\n+\n+    void getTopicMessages(long pageSize) throws SQLException {\n+        String sqlQuery = \"select consensus_timestamp, realm_num, topic_num, message, running_hash, sequence_number\\n\" +\n+                \"from topic_message limit ?;\";\n+\n+        runSelectStatementWithPageSize(sqlQuery, pageSize);\n+    }\n+\n+    void getTransactions(long pageSize) throws SQLException {\n+        String sqlQuery = \"select etrans.entity_shard,  etrans.entity_realm, etrans.entity_num\\n\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk5OTg4Nw=="}, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 166}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTkzNjMwOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/PerformanceIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNjowMTo0OFrOGf0X_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNDo1MzoyOFrOGhOEmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAxNzE0OQ==", "bodyText": "We should not be using lower level JDBC anywhere unless it truly demands it if there's no JPA equivalent. Here you can simply:\n@Resource\nprivate Collection<CrudRepository<?,?>> repositories;\n\n@Test\nvoid tablesExist() {\n  repositores.forEach(r -> assertThat(r.count()).isGreaterThan(0));\n}", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r436017149", "createdAt": "2020-06-05T16:01:48Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/PerformanceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.nio.file.Path;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Resource;\n+import javax.sql.DataSource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.test.context.SpringBootTest;\n+\n+import com.hedera.mirror.importer.FileCopier;\n+import com.hedera.mirror.importer.domain.ApplicationStatusCode;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.parser.record.RecordFileParser;\n+import com.hedera.mirror.importer.parser.record.RecordParserProperties;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+\n+@Log4j2\n+@SpringBootTest\n+public abstract class PerformanceIntegrationTest {\n+    @Resource\n+    DataSource dataSource;\n+\n+    Connection connection;\n+\n+    @Resource\n+    private ApplicationStatusRepository applicationStatusRepository;\n+\n+    @TempDir\n+    static Path dataPath;\n+\n+    @Value(\"classpath:data\")\n+    Path testPath;\n+\n+    @Resource\n+    private RecordFileParser recordFileParser;\n+\n+    private FileCopier fileCopier;\n+\n+    private StreamType streamType;\n+\n+    @Resource\n+    private RecordParserProperties parserProperties;\n+\n+    void parse(String filePath) {\n+        streamType = parserProperties.getStreamType();\n+        parserProperties.getMirrorProperties().setDataPath(dataPath);\n+        parserProperties.init();\n+\n+        fileCopier = FileCopier.create(testPath, dataPath)\n+                .from(streamType.getPath(), \"performance\")\n+                .filterFiles(filePath)\n+                .to(streamType.getPath(), streamType.getValid());\n+        fileCopier.copy();\n+\n+        recordFileParser.parse();\n+    }\n+\n+    void checkSeededTablesArePresent() {\n+        String[] tables = new String[] {\"account_balance_sets\", \"account_balances\", \"flyway_schema_history\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA2MTAxNw==", "bodyText": "Gotcha. Will apply the suggestion to the table size checks as the above checks that every table has rows. Not every table at restore will have rows. Also the original intent was just to check all expected tables were created.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437061017", "createdAt": "2020-06-08T23:47:30Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/PerformanceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.nio.file.Path;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Resource;\n+import javax.sql.DataSource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.test.context.SpringBootTest;\n+\n+import com.hedera.mirror.importer.FileCopier;\n+import com.hedera.mirror.importer.domain.ApplicationStatusCode;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.parser.record.RecordFileParser;\n+import com.hedera.mirror.importer.parser.record.RecordParserProperties;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+\n+@Log4j2\n+@SpringBootTest\n+public abstract class PerformanceIntegrationTest {\n+    @Resource\n+    DataSource dataSource;\n+\n+    Connection connection;\n+\n+    @Resource\n+    private ApplicationStatusRepository applicationStatusRepository;\n+\n+    @TempDir\n+    static Path dataPath;\n+\n+    @Value(\"classpath:data\")\n+    Path testPath;\n+\n+    @Resource\n+    private RecordFileParser recordFileParser;\n+\n+    private FileCopier fileCopier;\n+\n+    private StreamType streamType;\n+\n+    @Resource\n+    private RecordParserProperties parserProperties;\n+\n+    void parse(String filePath) {\n+        streamType = parserProperties.getStreamType();\n+        parserProperties.getMirrorProperties().setDataPath(dataPath);\n+        parserProperties.init();\n+\n+        fileCopier = FileCopier.create(testPath, dataPath)\n+                .from(streamType.getPath(), \"performance\")\n+                .filterFiles(filePath)\n+                .to(streamType.getPath(), streamType.getValid());\n+        fileCopier.copy();\n+\n+        recordFileParser.parse();\n+    }\n+\n+    void checkSeededTablesArePresent() {\n+        String[] tables = new String[] {\"account_balance_sets\", \"account_balances\", \"flyway_schema_history\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAxNzE0OQ=="}, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ4Njc0Ng==", "bodyText": "It's still using JDBC, which was my main complaint. I don't think you need to check if all these tables exist. Just check that one table exists and has data via count() along with the container exit code check should be sufficient.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437486746", "createdAt": "2020-06-09T14:53:28Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/PerformanceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.nio.file.Path;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Resource;\n+import javax.sql.DataSource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.test.context.SpringBootTest;\n+\n+import com.hedera.mirror.importer.FileCopier;\n+import com.hedera.mirror.importer.domain.ApplicationStatusCode;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.parser.record.RecordFileParser;\n+import com.hedera.mirror.importer.parser.record.RecordParserProperties;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+\n+@Log4j2\n+@SpringBootTest\n+public abstract class PerformanceIntegrationTest {\n+    @Resource\n+    DataSource dataSource;\n+\n+    Connection connection;\n+\n+    @Resource\n+    private ApplicationStatusRepository applicationStatusRepository;\n+\n+    @TempDir\n+    static Path dataPath;\n+\n+    @Value(\"classpath:data\")\n+    Path testPath;\n+\n+    @Resource\n+    private RecordFileParser recordFileParser;\n+\n+    private FileCopier fileCopier;\n+\n+    private StreamType streamType;\n+\n+    @Resource\n+    private RecordParserProperties parserProperties;\n+\n+    void parse(String filePath) {\n+        streamType = parserProperties.getStreamType();\n+        parserProperties.getMirrorProperties().setDataPath(dataPath);\n+        parserProperties.init();\n+\n+        fileCopier = FileCopier.create(testPath, dataPath)\n+                .from(streamType.getPath(), \"performance\")\n+                .filterFiles(filePath)\n+                .to(streamType.getPath(), streamType.getValid());\n+        fileCopier.copy();\n+\n+        recordFileParser.parse();\n+    }\n+\n+    void checkSeededTablesArePresent() {\n+        String[] tables = new String[] {\"account_balance_sets\", \"account_balances\", \"flyway_schema_history\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAxNzE0OQ=="}, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNjg0MjQ4OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/RestoreClientIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQyMTowNzoyMVrOGf9YWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzo0Nzo0MVrOGg0FzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2NDY5OQ==", "bodyText": "This test can't work in CircleCI as it doesn't support Docker in Docker. In fact, in CircleCI it looks like it runs but finds no tests to execute:\n 2020-06-04 20:42:33,184 INFO  [main ] c.h.m.i.p.p.RestoreClientIntegrationTest Started RestoreClientIntegrationTest in 11.512 seconds (JVM running for 14.805)\n 2020-06-04 20:42:33,228 INFO  [task-1] c.h.m.i.p.b.BalanceFileParser Skip watching directory: ./data/accountBalances/valid\n 2020-06-04 20:42:33,282 INFO  [task-2] c.h.m.i.p.r.EntityIdCacheLoader Cached 0 entity id mappings in 60.23 ms\n 2020-06-04 20:42:33,289 INFO  [main ] c.h.m.i.p.p.RestoreClientIntegrationTest Stop container null\n [INFO] Tests run: 0, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 12.939 s - in com.hedera.mirror.importer.parser.****ormance.RestoreClientIntegrationTest", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r436164699", "createdAt": "2020-06-05T21:07:21Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/RestoreClientIntegrationTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+import javax.annotation.Resource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.Rule;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Disabled;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.junit.jupiter.api.Timeout;\n+import org.testcontainers.containers.GenericContainer;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+@Tag(\"performance\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA2MTA2OQ==", "bodyText": "Changing the Tag so it's not run as part of tests", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437061069", "createdAt": "2020-06-08T23:47:41Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/RestoreClientIntegrationTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+import javax.annotation.Resource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.Rule;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Disabled;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.junit.jupiter.api.Timeout;\n+import org.testcontainers.containers.GenericContainer;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+@Tag(\"performance\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2NDY5OQ=="}, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNjg2MTEwOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/RestoreClientIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQyMToxNToyNlrOGf9jtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwMDozNTo1OFrOGg027Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2NzYwNw==", "bodyText": "I don't think we need to verify table size separately from checkSeededTablesArePresent(). Can combine", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r436167607", "createdAt": "2020-06-05T21:15:26Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/RestoreClientIntegrationTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+import javax.annotation.Resource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.Rule;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Disabled;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.junit.jupiter.api.Timeout;\n+import org.testcontainers.containers.GenericContainer;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+@Tag(\"performance\")\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+public class RestoreClientIntegrationTest extends PerformanceIntegrationTest {\n+    @Resource\n+    private DBProperties dbProperties;\n+\n+    @Rule\n+    GenericContainer customContainer;\n+\n+    private final long maxPageSize = 1000;\n+\n+    @BeforeAll\n+    void warmUp() throws SQLException {\n+        customContainer = CustomPostgresContainer.createRestoreContainer(\n+                \"data/restore-client/Dockerfile\",\n+                \"testnet_100k_pgdump.gz\",\n+                dbProperties);\n+\n+        log.info(\"Start container {}\", customContainer);\n+        customContainer.start();\n+        log.info(\"Database restore complete to {}\", dbProperties);\n+\n+        connection = dataSource.getConnection();\n+        checkSeededTablesArePresent();\n+    }\n+\n+    @AfterAll\n+    void coolOff() {\n+        log.info(\"Stop container {}\", customContainer);\n+        customContainer.stop();\n+    }\n+\n+    @Test\n+    public void parseAndIngestTransactions() throws Exception {\n+        clearLastProcessedRecordHash();\n+        parse(\"*.rcd\");\n+    }\n+\n+    @Timeout(1)\n+    @Test\n+    public void checkEntitiesTablesIsPopulated() throws Exception {\n+        verifyTableSize(\"t_entities\", \"entities\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3MzY0NQ==", "bodyText": "Combined", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437073645", "createdAt": "2020-06-09T00:35:58Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/RestoreClientIntegrationTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+import javax.annotation.Resource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.Rule;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Disabled;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.junit.jupiter.api.Timeout;\n+import org.testcontainers.containers.GenericContainer;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+@Tag(\"performance\")\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+public class RestoreClientIntegrationTest extends PerformanceIntegrationTest {\n+    @Resource\n+    private DBProperties dbProperties;\n+\n+    @Rule\n+    GenericContainer customContainer;\n+\n+    private final long maxPageSize = 1000;\n+\n+    @BeforeAll\n+    void warmUp() throws SQLException {\n+        customContainer = CustomPostgresContainer.createRestoreContainer(\n+                \"data/restore-client/Dockerfile\",\n+                \"testnet_100k_pgdump.gz\",\n+                dbProperties);\n+\n+        log.info(\"Start container {}\", customContainer);\n+        customContainer.start();\n+        log.info(\"Database restore complete to {}\", dbProperties);\n+\n+        connection = dataSource.getConnection();\n+        checkSeededTablesArePresent();\n+    }\n+\n+    @AfterAll\n+    void coolOff() {\n+        log.info(\"Stop container {}\", customContainer);\n+        customContainer.stop();\n+    }\n+\n+    @Test\n+    public void parseAndIngestTransactions() throws Exception {\n+        clearLastProcessedRecordHash();\n+        parse(\"*.rcd\");\n+    }\n+\n+    @Timeout(1)\n+    @Test\n+    public void checkEntitiesTablesIsPopulated() throws Exception {\n+        verifyTableSize(\"t_entities\", \"entities\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2NzYwNw=="}, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNjg2NjM2OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/RestoreClientIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQyMToxNzo0NVrOGf9nJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwMDozNjoyNFrOGg03Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2ODQ4Nw==", "bodyText": "Should not use JUnit 4.x features. I doubt this is even working as you are manually creating object and starting and stopping. JUnit 5.x recommended approach is to use @TestContainers + @Container.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r436168487", "createdAt": "2020-06-05T21:17:45Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/RestoreClientIntegrationTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+import javax.annotation.Resource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.Rule;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Disabled;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.junit.jupiter.api.Timeout;\n+import org.testcontainers.containers.GenericContainer;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+@Tag(\"performance\")\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+public class RestoreClientIntegrationTest extends PerformanceIntegrationTest {\n+    @Resource\n+    private DBProperties dbProperties;\n+\n+    @Rule", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3Mzc2Mg==", "bodyText": "It works, I looked at your recommended approach earlier but went the Manual Lifecycle Control way since I needed to pull in the DbPorperties which is non static.\nThe shared container approach requires a static container declaration.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437073762", "createdAt": "2020-06-09T00:36:24Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/RestoreClientIntegrationTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+import javax.annotation.Resource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.Rule;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Disabled;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.junit.jupiter.api.Timeout;\n+import org.testcontainers.containers.GenericContainer;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+@Tag(\"performance\")\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+public class RestoreClientIntegrationTest extends PerformanceIntegrationTest {\n+    @Resource\n+    private DBProperties dbProperties;\n+\n+    @Rule", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2ODQ4Nw=="}, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNjg3NDgyOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/CustomPostgresContainer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQyMToyMjowMlrOGf9s2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwMDozNjozMlrOGg03dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2OTk0NQ==", "bodyText": "I don't see the need for this class.\na) It's no longer creating a postgres container, so it's named wrong.\nb) Has 3 public methods but only one actually used publically\nc) There is a PerformanceIntegrationTest where this logic makes more sense\nd) The static strings make it harder to read, not easier. They're not needed for performance or reuse reasons so better to inline.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r436169945", "createdAt": "2020-06-05T21:22:02Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/CustomPostgresContainer.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import lombok.extern.log4j.Log4j2;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.startupcheck.IndefiniteWaitOneShotStartupCheckStrategy;\n+import org.testcontainers.images.builder.ImageFromDockerfile;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+public class CustomPostgresContainer {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3Mzc4MQ==", "bodyText": "Sounds good will merge into PerformanceIntegrationTest", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437073781", "createdAt": "2020-06-09T00:36:32Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/CustomPostgresContainer.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import lombok.extern.log4j.Log4j2;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.startupcheck.IndefiniteWaitOneShotStartupCheckStrategy;\n+import org.testcontainers.images.builder.ImageFromDockerfile;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+public class CustomPostgresContainer {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2OTk0NQ=="}, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNjkzNTI3OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/CustomPostgresContainer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQyMTo1MTowNVrOGf-Tgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwMDozNjo1NFrOGg03xQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE3OTg0Mw==", "bodyText": "We can't create images in CircleCI currently. It would be better if we just pushed some golden images (100k, 1M, 10M) for use in these tests manually instead of building each time.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r436179843", "createdAt": "2020-06-05T21:51:05Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/CustomPostgresContainer.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import lombok.extern.log4j.Log4j2;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.startupcheck.IndefiniteWaitOneShotStartupCheckStrategy;\n+import org.testcontainers.images.builder.ImageFromDockerfile;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+public class CustomPostgresContainer {\n+\n+    private static final String dbNameEnvVar = \"DB_NAME\";\n+    private static final String dbUserEnvVar = \"DB_USER\";\n+    private static final String dbPasswordEnvVar = \"DB_PASS\";\n+    private static final String dbPortEnvVar = \"DB_PORT\";\n+    private static final String dockerFileName = \"Dockerfile\";\n+    private static final String dumpFileArgName = \"dumpfile\";\n+    private static final String jsonKeyFileArgName = \"jsonkeyfile\";\n+    private static final String jsonKeyFileName = \"bucket-download-key.json\";\n+    private static final String jsonKeyFilePath = \"data/bucket-download-key.json\";\n+    private static final String restoreScriptFileName = \"restore.sh\";\n+    private static final String restoreScriptFilePath = \"data/restore.sh\";\n+\n+    public static ImageFromDockerfile createBaseDockerImage(String dockerFilePath) {\n+        return new ImageFromDockerfile()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3Mzg2MQ==", "bodyText": "Done, see gcr.io/mirrornode/hedera-mirror-node/postgres-restore-client images", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437073861", "createdAt": "2020-06-09T00:36:54Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/CustomPostgresContainer.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import lombok.extern.log4j.Log4j2;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.startupcheck.IndefiniteWaitOneShotStartupCheckStrategy;\n+import org.testcontainers.images.builder.ImageFromDockerfile;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+public class CustomPostgresContainer {\n+\n+    private static final String dbNameEnvVar = \"DB_NAME\";\n+    private static final String dbUserEnvVar = \"DB_USER\";\n+    private static final String dbPasswordEnvVar = \"DB_PASS\";\n+    private static final String dbPortEnvVar = \"DB_PORT\";\n+    private static final String dockerFileName = \"Dockerfile\";\n+    private static final String dumpFileArgName = \"dumpfile\";\n+    private static final String jsonKeyFileArgName = \"jsonkeyfile\";\n+    private static final String jsonKeyFileName = \"bucket-download-key.json\";\n+    private static final String jsonKeyFilePath = \"data/bucket-download-key.json\";\n+    private static final String restoreScriptFileName = \"restore.sh\";\n+    private static final String restoreScriptFilePath = \"data/restore.sh\";\n+\n+    public static ImageFromDockerfile createBaseDockerImage(String dockerFilePath) {\n+        return new ImageFromDockerfile()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE3OTg0Mw=="}, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNTQ3MTA5OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/db/DBProperties.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNDo1ODoyMVrOGhOTOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxODowNTo1NVrOGhWQxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ5MDQ4OQ==", "bodyText": "These are absolutely necessary to be not blank even if you're not using the REST API. This is because they run as part of Flyway migration and will fail if empty.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437490489", "createdAt": "2020-06-09T14:58:21Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/db/DBProperties.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.hedera.mirror.importer.db;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import javax.validation.constraints.Min;\n+import javax.validation.constraints.NotBlank;\n+import lombok.Builder;\n+import lombok.Data;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.boot.context.properties.ConstructorBinding;\n+import org.springframework.validation.annotation.Validated;\n+\n+@Data\n+@Validated\n+@Builder(toBuilder = true)\n+@ConfigurationProperties(\"hedera.mirror.importer.db\")\n+@ConstructorBinding\n+public class DBProperties {\n+    @NotBlank\n+    private String host = \"\";\n+\n+    @NotBlank\n+    private String name = \"\";\n+\n+    @NotBlank\n+    private String password = \"\";\n+\n+    @Min(0)\n+    private int port = 5432;\n+\n+    private String restPassword = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efd38ff1e986903045a87e8c8d49eaa74e1c6b20"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU4ODU3Mg==", "bodyText": "Gotcha. Will make change in next PR", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437588572", "createdAt": "2020-06-09T17:10:39Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/db/DBProperties.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.hedera.mirror.importer.db;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import javax.validation.constraints.Min;\n+import javax.validation.constraints.NotBlank;\n+import lombok.Builder;\n+import lombok.Data;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.boot.context.properties.ConstructorBinding;\n+import org.springframework.validation.annotation.Validated;\n+\n+@Data\n+@Validated\n+@Builder(toBuilder = true)\n+@ConfigurationProperties(\"hedera.mirror.importer.db\")\n+@ConstructorBinding\n+public class DBProperties {\n+    @NotBlank\n+    private String host = \"\";\n+\n+    @NotBlank\n+    private String name = \"\";\n+\n+    @NotBlank\n+    private String password = \"\";\n+\n+    @Min(0)\n+    private int port = 5432;\n+\n+    private String restPassword = \"\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ5MDQ4OQ=="}, "originalCommit": {"oid": "efd38ff1e986903045a87e8c8d49eaa74e1c6b20"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYyMDkzMw==", "bodyText": "Addressed in #818", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437620933", "createdAt": "2020-06-09T18:05:55Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/db/DBProperties.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.hedera.mirror.importer.db;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import javax.validation.constraints.Min;\n+import javax.validation.constraints.NotBlank;\n+import lombok.Builder;\n+import lombok.Data;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.boot.context.properties.ConstructorBinding;\n+import org.springframework.validation.annotation.Validated;\n+\n+@Data\n+@Validated\n+@Builder(toBuilder = true)\n+@ConfigurationProperties(\"hedera.mirror.importer.db\")\n+@ConstructorBinding\n+public class DBProperties {\n+    @NotBlank\n+    private String host = \"\";\n+\n+    @NotBlank\n+    private String name = \"\";\n+\n+    @NotBlank\n+    private String password = \"\";\n+\n+    @Min(0)\n+    private int port = 5432;\n+\n+    private String restPassword = \"\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ5MDQ4OQ=="}, "originalCommit": {"oid": "efd38ff1e986903045a87e8c8d49eaa74e1c6b20"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNTQ4NjgyOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/PerformanceIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNTowMTo0OFrOGhOdoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxODowNTo0NVrOGhWQYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ5MzE1Mw==", "bodyText": "Should be protected and non-static. Can just inject DBProperties into this class and use it without having to pass it via parameter.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437493153", "createdAt": "2020-06-09T15:01:48Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/PerformanceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,166 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.nio.file.Path;\n+import java.sql.Connection;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Resource;\n+import javax.sql.DataSource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.test.context.SpringBootTest;\n+import org.springframework.data.repository.CrudRepository;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.startupcheck.IndefiniteWaitOneShotStartupCheckStrategy;\n+\n+import com.hedera.mirror.importer.FileCopier;\n+import com.hedera.mirror.importer.db.DBProperties;\n+import com.hedera.mirror.importer.domain.ApplicationStatusCode;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.parser.record.RecordFileParser;\n+import com.hedera.mirror.importer.parser.record.RecordParserProperties;\n+import com.hedera.mirror.importer.repository.AccountBalanceRepository;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+import com.hedera.mirror.importer.repository.EntityRepository;\n+import com.hedera.mirror.importer.repository.TopicMessageRepository;\n+import com.hedera.mirror.importer.repository.TransactionRepository;\n+\n+@Log4j2\n+@SpringBootTest\n+public abstract class PerformanceIntegrationTest {\n+\n+    @TempDir\n+    static Path dataPath;\n+\n+    @Value(\"classpath:data\")\n+    Path testPath;\n+\n+    @Resource\n+    private RecordFileParser recordFileParser;\n+\n+    private FileCopier fileCopier;\n+\n+    private StreamType streamType;\n+\n+    @Resource\n+    private RecordParserProperties parserProperties;\n+\n+    @Resource\n+    DataSource dataSource;\n+\n+    Connection connection;\n+\n+    @Resource\n+    private ApplicationStatusRepository applicationStatusRepository;\n+\n+    @Resource\n+    private EntityRepository entityRepository;\n+\n+    @Resource\n+    private AccountBalanceRepository accountBalanceRepository;\n+\n+    @Resource\n+    private TopicMessageRepository topicMessageRepository;\n+\n+    @Resource\n+    private TransactionRepository transactionRepository;\n+\n+    private static final String restoreClientImagePrefix = \"gcr.io/mirrornode/hedera-mirror-node/postgres-restore\" +\n+            \"-client:\";\n+\n+    public static GenericContainer createRestoreContainer(String dockerImageTag, DBProperties db) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efd38ff1e986903045a87e8c8d49eaa74e1c6b20"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU4ODY3NA==", "bodyText": "Will do in next PR", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437588674", "createdAt": "2020-06-09T17:10:50Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/PerformanceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,166 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.nio.file.Path;\n+import java.sql.Connection;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Resource;\n+import javax.sql.DataSource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.test.context.SpringBootTest;\n+import org.springframework.data.repository.CrudRepository;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.startupcheck.IndefiniteWaitOneShotStartupCheckStrategy;\n+\n+import com.hedera.mirror.importer.FileCopier;\n+import com.hedera.mirror.importer.db.DBProperties;\n+import com.hedera.mirror.importer.domain.ApplicationStatusCode;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.parser.record.RecordFileParser;\n+import com.hedera.mirror.importer.parser.record.RecordParserProperties;\n+import com.hedera.mirror.importer.repository.AccountBalanceRepository;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+import com.hedera.mirror.importer.repository.EntityRepository;\n+import com.hedera.mirror.importer.repository.TopicMessageRepository;\n+import com.hedera.mirror.importer.repository.TransactionRepository;\n+\n+@Log4j2\n+@SpringBootTest\n+public abstract class PerformanceIntegrationTest {\n+\n+    @TempDir\n+    static Path dataPath;\n+\n+    @Value(\"classpath:data\")\n+    Path testPath;\n+\n+    @Resource\n+    private RecordFileParser recordFileParser;\n+\n+    private FileCopier fileCopier;\n+\n+    private StreamType streamType;\n+\n+    @Resource\n+    private RecordParserProperties parserProperties;\n+\n+    @Resource\n+    DataSource dataSource;\n+\n+    Connection connection;\n+\n+    @Resource\n+    private ApplicationStatusRepository applicationStatusRepository;\n+\n+    @Resource\n+    private EntityRepository entityRepository;\n+\n+    @Resource\n+    private AccountBalanceRepository accountBalanceRepository;\n+\n+    @Resource\n+    private TopicMessageRepository topicMessageRepository;\n+\n+    @Resource\n+    private TransactionRepository transactionRepository;\n+\n+    private static final String restoreClientImagePrefix = \"gcr.io/mirrornode/hedera-mirror-node/postgres-restore\" +\n+            \"-client:\";\n+\n+    public static GenericContainer createRestoreContainer(String dockerImageTag, DBProperties db) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ5MzE1Mw=="}, "originalCommit": {"oid": "efd38ff1e986903045a87e8c8d49eaa74e1c6b20"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYyMDgzMg==", "bodyText": "Addressed in #818", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437620832", "createdAt": "2020-06-09T18:05:45Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/PerformanceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,166 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.nio.file.Path;\n+import java.sql.Connection;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Resource;\n+import javax.sql.DataSource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.test.context.SpringBootTest;\n+import org.springframework.data.repository.CrudRepository;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.startupcheck.IndefiniteWaitOneShotStartupCheckStrategy;\n+\n+import com.hedera.mirror.importer.FileCopier;\n+import com.hedera.mirror.importer.db.DBProperties;\n+import com.hedera.mirror.importer.domain.ApplicationStatusCode;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.parser.record.RecordFileParser;\n+import com.hedera.mirror.importer.parser.record.RecordParserProperties;\n+import com.hedera.mirror.importer.repository.AccountBalanceRepository;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+import com.hedera.mirror.importer.repository.EntityRepository;\n+import com.hedera.mirror.importer.repository.TopicMessageRepository;\n+import com.hedera.mirror.importer.repository.TransactionRepository;\n+\n+@Log4j2\n+@SpringBootTest\n+public abstract class PerformanceIntegrationTest {\n+\n+    @TempDir\n+    static Path dataPath;\n+\n+    @Value(\"classpath:data\")\n+    Path testPath;\n+\n+    @Resource\n+    private RecordFileParser recordFileParser;\n+\n+    private FileCopier fileCopier;\n+\n+    private StreamType streamType;\n+\n+    @Resource\n+    private RecordParserProperties parserProperties;\n+\n+    @Resource\n+    DataSource dataSource;\n+\n+    Connection connection;\n+\n+    @Resource\n+    private ApplicationStatusRepository applicationStatusRepository;\n+\n+    @Resource\n+    private EntityRepository entityRepository;\n+\n+    @Resource\n+    private AccountBalanceRepository accountBalanceRepository;\n+\n+    @Resource\n+    private TopicMessageRepository topicMessageRepository;\n+\n+    @Resource\n+    private TransactionRepository transactionRepository;\n+\n+    private static final String restoreClientImagePrefix = \"gcr.io/mirrornode/hedera-mirror-node/postgres-restore\" +\n+            \"-client:\";\n+\n+    public static GenericContainer createRestoreContainer(String dockerImageTag, DBProperties db) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ5MzE1Mw=="}, "originalCommit": {"oid": "efd38ff1e986903045a87e8c8d49eaa74e1c6b20"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNTY0NzAzOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/RestoreClientIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNToyNDozM1rOGhP__Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNzo1NDo0MVrOGhV3Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUxODMzMw==", "bodyText": "Do we need to assertThat(customContainer.getContainerInfo().getState().getExitCodeLong()).isEqualTo(0L);? Or does TestContainers automatically do that?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437518333", "createdAt": "2020-06-09T15:24:33Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/RestoreClientIntegrationTest.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.sql.SQLException;\n+import javax.annotation.Resource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.junit.jupiter.Container;\n+import org.testcontainers.junit.jupiter.Testcontainers;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+@Tag(\"largedbperf\")\n+@Testcontainers\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+public class RestoreClientIntegrationTest extends PerformanceIntegrationTest {\n+    @Resource\n+    private DBProperties dbProperties;\n+\n+    @Container\n+    GenericContainer customContainer;\n+\n+    @BeforeAll\n+    void warmUp() throws SQLException {\n+        customContainer = createRestoreContainer(\"100k\",\n+                dbProperties);\n+\n+        log.info(\"Start container {}\", customContainer);\n+        customContainer.start();\n+        log.info(\"Database restore complete to {}\", dbProperties);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efd38ff1e986903045a87e8c8d49eaa74e1c6b20"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU4ODQ0NA==", "bodyText": "In combination with the Wait logic I believe this is covered but I can verify.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437588444", "createdAt": "2020-06-09T17:10:25Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/RestoreClientIntegrationTest.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.sql.SQLException;\n+import javax.annotation.Resource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.junit.jupiter.Container;\n+import org.testcontainers.junit.jupiter.Testcontainers;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+@Tag(\"largedbperf\")\n+@Testcontainers\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+public class RestoreClientIntegrationTest extends PerformanceIntegrationTest {\n+    @Resource\n+    private DBProperties dbProperties;\n+\n+    @Container\n+    GenericContainer customContainer;\n+\n+    @BeforeAll\n+    void warmUp() throws SQLException {\n+        customContainer = createRestoreContainer(\"100k\",\n+                dbProperties);\n+\n+        log.info(\"Start container {}\", customContainer);\n+        customContainer.start();\n+        log.info(\"Database restore complete to {}\", dbProperties);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUxODMzMw=="}, "originalCommit": {"oid": "efd38ff1e986903045a87e8c8d49eaa74e1c6b20"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYxNDQyMw==", "bodyText": "It checks for us as expected using the One Shot. startup strategy.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437614423", "createdAt": "2020-06-09T17:54:41Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/RestoreClientIntegrationTest.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.sql.SQLException;\n+import javax.annotation.Resource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.junit.jupiter.Container;\n+import org.testcontainers.junit.jupiter.Testcontainers;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+@Tag(\"largedbperf\")\n+@Testcontainers\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+public class RestoreClientIntegrationTest extends PerformanceIntegrationTest {\n+    @Resource\n+    private DBProperties dbProperties;\n+\n+    @Container\n+    GenericContainer customContainer;\n+\n+    @BeforeAll\n+    void warmUp() throws SQLException {\n+        customContainer = createRestoreContainer(\"100k\",\n+                dbProperties);\n+\n+        log.info(\"Start container {}\", customContainer);\n+        customContainer.start();\n+        log.info(\"Database restore complete to {}\", dbProperties);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUxODMzMw=="}, "originalCommit": {"oid": "efd38ff1e986903045a87e8c8d49eaa74e1c6b20"}, "originalPosition": 55}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1071, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}