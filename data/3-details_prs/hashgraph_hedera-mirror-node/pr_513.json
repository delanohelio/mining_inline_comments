{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4ODE5NTQz", "number": 513, "title": "Publish official Docker images to GCR", "bodyText": "Detailed description:\nAutomatically push mirrornode images (importer, grpc, rest) to grc.io when a release is finalized and tagged with vX.Y.Z.\nWhich issue(s) this PR fixes:\nFixes #335\nSpecial notes for your reviewer:\nDue to fabric8io/docker-maven-plugin#1033, maven-docker-plugin doesn't work with -u _json_key (https://cloud.google.com/container-registry/docs/advanced-authentication?hl=en_US#json-key).\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-01-29T23:36:24Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/513", "merged": true, "mergeCommit": {"oid": "cb5f04019f9b2879c3a0a899e35800e26d794680"}, "closed": true, "closedAt": "2020-01-31T20:56:38Z", "author": {"login": "apeksharma"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_OqGmgH2gAyMzY4ODE5NTQzOjQ5NWFlMGI4MjM5ZTE3MzM4Mzg0ZTcyM2IzNWFiMTFlZDNmYmI0ZWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_1fSXAH2gAyMzY4ODE5NTQzOmJmOTVkMTczZDMyMjQxYWE4NjZiYWM0MWM2Y2FjNzgwMWM2ZTdjYTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "495ae0b8239e17338384e723b35ab11ed3fbb4ea", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/495ae0b8239e17338384e723b35ab11ed3fbb4ea", "committedDate": "2020-01-29T23:36:49Z", "message": "Publish official Docker images to GCR\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4ce50efbefaf031e127137b2e7b5f546d2b490f4", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4ce50efbefaf031e127137b2e7b5f546d2b490f4", "committedDate": "2020-01-29T23:28:12Z", "message": "Publish official Docker images to GCR"}, "afterCommit": {"oid": "495ae0b8239e17338384e723b35ab11ed3fbb4ea", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/495ae0b8239e17338384e723b35ab11ed3fbb4ea", "committedDate": "2020-01-29T23:36:49Z", "message": "Publish official Docker images to GCR\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwOTcxMzgx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/513#pullrequestreview-350971381", "createdAt": "2020-01-30T16:39:57Z", "commit": {"oid": "495ae0b8239e17338384e723b35ab11ed3fbb4ea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNjozOTo1OFrOFjx3Wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNjozOTo1OFrOFjx3Wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA2MTQ2Ng==", "bodyText": "Q: Will this make images publicly available? Or will users still be limited in their ability to pull down images?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/513#discussion_r373061466", "createdAt": "2020-01-30T16:39:58Z", "author": {"login": "Nana-EC"}, "path": "pom.xml", "diffHunk": "@@ -54,7 +54,7 @@\n \n     <properties>\n         <disruptor.version>3.4.2</disruptor.version> <!-- Used for asynchronous logging -->\n-        <docker.repository>docker.pkg.github.com/hashgraph/hedera-mirror-node</docker.repository>\n+        <docker.push.repository>gcr.io/mirrornode</docker.push.repository>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "495ae0b8239e17338384e723b35ab11ed3fbb4ea"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0972f50f9fb6ecb262aacbbef3270e01e5da22bf", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0972f50f9fb6ecb262aacbbef3270e01e5da22bf", "committedDate": "2020-01-30T18:36:36Z", "message": "Setup creds\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ce846b6453abe73c976ee7fe7da153fa3ad57c6", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2ce846b6453abe73c976ee7fe7da153fa3ad57c6", "committedDate": "2020-01-30T19:10:21Z", "message": "minor fix\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "844cd0d11cdefdbc88bd9e887b73fd511677ae7c", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/844cd0d11cdefdbc88bd9e887b73fd511677ae7c", "committedDate": "2020-01-30T19:43:21Z", "message": "update documentation\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwOTY3MDAy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/513#pullrequestreview-350967002", "createdAt": "2020-01-30T16:34:18Z", "commit": {"oid": "495ae0b8239e17338384e723b35ab11ed3fbb4ea"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNjozNDoxOVrOFjxq2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMDozMDowN1rOFj48eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA1ODI2NA==", "bodyText": "We do want images for pre-release tags. I think any format of tag is fine /.*/", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/513#discussion_r373058264", "createdAt": "2020-01-30T16:34:19Z", "author": {"login": "steven-sheehy"}, "path": ".circleci/config.yml", "diffHunk": "@@ -31,6 +51,15 @@ workflows:\n               ignore: /.*/\n             tags:\n               only: /^v.*/\n+      - release_docker_images:\n+          requires:\n+            - build_maven\n+            - build_rest\n+          filters:\n+            branches:\n+              ignore: /.*/\n+            tags:\n+              only: /^v.\\d*.\\d*.\\d*/ # Do not push docker images to registry for rc, alpha, beta, etc.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "495ae0b8239e17338384e723b35ab11ed3fbb4ea"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA1ODk1Mg==", "bodyText": "We also want images pushed on every commit to master, but only the latest docker tag should be updated. Released versions should not be overwritten on commits to master.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/513#discussion_r373058952", "createdAt": "2020-01-30T16:35:35Z", "author": {"login": "steven-sheehy"}, "path": ".circleci/config.yml", "diffHunk": "@@ -31,6 +51,15 @@ workflows:\n               ignore: /.*/\n             tags:\n               only: /^v.*/\n+      - release_docker_images:\n+          requires:\n+            - build_maven\n+            - build_rest\n+          filters:\n+            branches:\n+              ignore: /.*/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "495ae0b8239e17338384e723b35ab11ed3fbb4ea"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA4NDMwMw==", "bodyText": "Prefer just publish_images as docker is not the only image format (OCI) or the only container runtime (containerd, CRI-O, etc). Publish since we want it to run on master as well not just releases", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/513#discussion_r373084303", "createdAt": "2020-01-30T17:20:31Z", "author": {"login": "steven-sheehy"}, "path": ".circleci/config.yml", "diffHunk": "@@ -154,3 +168,24 @@ jobs:\n       - *attach_workspace\n       - store_artifacts:\n           path: /tmp/workspace/artifacts\n+\n+  release_docker_images:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "495ae0b8239e17338384e723b35ab11ed3fbb4ea"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzExMDk4NQ==", "bodyText": "Why are we adding arch? Maven artifacts are not architecture/OS specific.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/513#discussion_r373110985", "createdAt": "2020-01-30T18:14:59Z", "author": {"login": "steven-sheehy"}, "path": ".circleci/config.yml", "diffHunk": "@@ -5,6 +5,26 @@ references:\n   attach_workspace: &attach_workspace\n     attach_workspace:\n       at: *workspace_root\n+  persist_artifacts: &persist_artifacts\n+    persist_to_workspace:\n+      root: *workspace_root\n+      paths:\n+        - artifacts\n+  pom_checksum: &pom_checksum\n+    run:\n+      name: Calculate checksum of all pom.xml\n+      command: find . -type f -name \"pom.xml\" | sort -u | xargs sha512sum > pom.xml.checksum\n+  restore_maven_cache: &restore_maven_cache\n+    restore_cache:\n+      keys:\n+        - maven-v2-{{ arch }}-{{ .Branch }}-{{ checksum \"pom.xml.checksum\" }}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "495ae0b8239e17338384e723b35ab11ed3fbb4ea"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3MDg3MA==", "bodyText": "Did you try docker type with setup_remote_docker to see if docker-in-docker works? Would avoid having to spin up VM and install java on it and can use docker caching with docker_layer_caching option.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/513#discussion_r373170870", "createdAt": "2020-01-30T20:15:13Z", "author": {"login": "steven-sheehy"}, "path": ".circleci/config.yml", "diffHunk": "@@ -154,3 +168,24 @@ jobs:\n       - *attach_workspace\n       - store_artifacts:\n           path: /tmp/workspace/artifacts\n+\n+  release_docker_images:\n+    machine:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "495ae0b8239e17338384e723b35ab11ed3fbb4ea"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3MjU2OQ==", "bodyText": "How are these credentials generated? Are they your own so that if you leave the company the CI will break? We should have Ops create a service account with push and pull privileges for use here, if so.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/513#discussion_r373172569", "createdAt": "2020-01-30T20:19:05Z", "author": {"login": "steven-sheehy"}, "path": ".circleci/config.yml", "diffHunk": "@@ -154,3 +168,24 @@ jobs:\n       - *attach_workspace\n       - store_artifacts:\n           path: /tmp/workspace/artifacts\n+\n+  release_docker_images:\n+    machine:\n+      image: ubuntu-1604:201903-01\n+    environment:\n+      MAVEN_CLI_OPTS: --batch-mode --no-transfer-progress --show-version -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn\n+      JAVA_HOME: /usr/lib/jvm/java-11-openjdk-amd64\n+    steps:\n+      - checkout\n+      - run:\n+          name: Install OpenJDK 11\n+          command: |\n+            sudo add-apt-repository ppa:openjdk-r/ppa \\\n+            && sudo apt-get update -q \\\n+            && sudo apt install -y openjdk-11-jdk\n+      - *pom_checksum\n+      - *restore_maven_cache\n+      - run:\n+          name: Running maven deploy\n+          command: ./mvnw ${MAVEN_CLI_OPTS} deploy -Ddocker.push.username=_json_key -Ddocker.push.password=\"${GCR_JSON_KEY_FILE}\" -DskipTests", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ce846b6453abe73c976ee7fe7da153fa3ad57c6"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3Njc2OA==", "bodyText": "This looks to be triggering for your PR branch and not just tags, causing the github checks to fail", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/513#discussion_r373176768", "createdAt": "2020-01-30T20:28:38Z", "author": {"login": "steven-sheehy"}, "path": ".circleci/config.yml", "diffHunk": "@@ -31,6 +51,15 @@ workflows:\n               ignore: /.*/\n             tags:\n               only: /^v.*/\n+      - release_docker_images:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ce846b6453abe73c976ee7fe7da153fa3ad57c6"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3NzQ2NA==", "bodyText": "I think both the name and the password should be stored in circleci environment in case they need to change in the future. The name should also be more generic and not GCR specific in case we change registries. Recommend ${REGISTRY_USERNAME} and ${REGISTRY_PASSWORD}", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/513#discussion_r373177464", "createdAt": "2020-01-30T20:30:07Z", "author": {"login": "steven-sheehy"}, "path": ".circleci/config.yml", "diffHunk": "@@ -154,3 +168,24 @@ jobs:\n       - *attach_workspace\n       - store_artifacts:\n           path: /tmp/workspace/artifacts\n+\n+  release_docker_images:\n+    machine:\n+      image: ubuntu-1604:201903-01\n+    environment:\n+      MAVEN_CLI_OPTS: --batch-mode --no-transfer-progress --show-version -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn\n+      JAVA_HOME: /usr/lib/jvm/java-11-openjdk-amd64\n+    steps:\n+      - checkout\n+      - run:\n+          name: Install OpenJDK 11\n+          command: |\n+            sudo add-apt-repository ppa:openjdk-r/ppa \\\n+            && sudo apt-get update -q \\\n+            && sudo apt install -y openjdk-11-jdk\n+      - *pom_checksum\n+      - *restore_maven_cache\n+      - run:\n+          name: Running maven deploy\n+          command: ./mvnw ${MAVEN_CLI_OPTS} deploy -Ddocker.push.username=_json_key -Ddocker.push.password=\"${GCR_JSON_KEY_FILE}\" -DskipTests", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ce846b6453abe73c976ee7fe7da153fa3ad57c6"}, "originalPosition": 116}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d97d77937ecf4ebb3a38b42c43ef8433c8c6de6c", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d97d77937ecf4ebb3a38b42c43ef8433c8c6de6c", "committedDate": "2020-01-30T20:49:00Z", "message": "Change auth method\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fe06f05a05776f7d7171363dddb8f85ce7a0696", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4fe06f05a05776f7d7171363dddb8f85ce7a0696", "committedDate": "2020-01-30T20:56:07Z", "message": "fix\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5ecae5db648b5b65d252596408a999a76bb30b7", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c5ecae5db648b5b65d252596408a999a76bb30b7", "committedDate": "2020-01-30T21:34:02Z", "message": "fix\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "637c7bcd4b3697d29e3346087817dd59b304c581", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/637c7bcd4b3697d29e3346087817dd59b304c581", "committedDate": "2020-01-30T21:55:16Z", "message": "fix\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "879fad9d26b04e638ce2ce002ac88bee61fb0205", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/879fad9d26b04e638ce2ce002ac88bee61fb0205", "committedDate": "2020-01-31T20:15:27Z", "message": "address review comments\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9912d5331ed8342e0da63212cd7bad4f71b3bdc1", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9912d5331ed8342e0da63212cd7bad4f71b3bdc1", "committedDate": "2020-01-31T20:45:04Z", "message": "address review comments\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNzY5NDMx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/513#pullrequestreview-351769431", "createdAt": "2020-01-31T20:50:36Z", "commit": {"oid": "9912d5331ed8342e0da63212cd7bad4f71b3bdc1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf95d173d32241aa866bac41c6cac7801c6e7ca8", "author": {"user": {"login": "apeksharma", "name": "Apekshit Sharma"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bf95d173d32241aa866bac41c6cac7801c6e7ca8", "committedDate": "2020-01-31T20:51:18Z", "message": "Merge branch 'master' into docker_images"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3225, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}