{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1NTYxNTA5", "number": 1090, "title": "HTS: Support new balance file version", "bodyText": "Detailed description:\nAdd support for new balance file which contains token balances as part of HTS.\nWhich issue(s) this PR fixes:\nFixes #1049\nSpecial notes for your reviewer:\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-09-30T14:40:39Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090", "merged": true, "mergeCommit": {"oid": "06b6d6a5b25f43bcc53a15e57a254276a99cc000"}, "closed": true, "closedAt": "2020-10-06T16:02:02Z", "author": {"login": "ijungmann"}, "timelineItems": {"totalCount": 55, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNrqT5gH2gAyNDk1NTYxNTA5OmRlNzI3YjE2NzFlNjgwZWY3YmM2YTkzZDhiMWJmNzYyYzZiODBiZjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdP6kUoAFqTUwMzEyNDA2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "de727b1671e680ef7bc6a93d8b1bf762c6b80bf8", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/de727b1671e680ef7bc6a93d8b1bf762c6b80bf8", "committedDate": "2020-09-29T17:30:23Z", "message": "Importer: Add support for new balance file version\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e42b9f9084d6655bf7772b61964b9cd995e8a9e", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2e42b9f9084d6655bf7772b61964b9cd995e8a9e", "committedDate": "2020-09-30T14:38:37Z", "message": "Add V2 classes to handle new files\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a65106c67174a54c8e47b457ebef65805771ad81", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a65106c67174a54c8e47b457ebef65805771ad81", "committedDate": "2020-10-01T03:38:18Z", "message": "Merge branch 'master' into support_new_balance_file_version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3654fd5e6a8a35d87e792ce9975f8dedb483442", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f3654fd5e6a8a35d87e792ce9975f8dedb483442", "committedDate": "2020-10-01T03:52:16Z", "message": "Add tests for new balance file\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0f30c68ef7a89277176fb8751e6528dfab9db59", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b0f30c68ef7a89277176fb8751e6528dfab9db59", "committedDate": "2020-10-01T03:57:41Z", "message": "Fix FileLoader test\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "552801f4b2a63d039ae1fd0958f0907b0869874c", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/552801f4b2a63d039ae1fd0958f0907b0869874c", "committedDate": "2020-10-01T08:28:35Z", "message": "Refactor and add tests\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMTIwMjIz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#pullrequestreview-500120223", "createdAt": "2020-10-01T08:30:31Z", "commit": {"oid": "552801f4b2a63d039ae1fd0958f0907b0869874c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODozMDozMVrOHa_8OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODozMDozMVrOHa_8OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3MjYzMw==", "bodyText": "The FileLoader test seems to show these aren't actually being picked up by the repository, despite them being in the DB.  Need to investigate", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498072633", "createdAt": "2020-10-01T08:30:31Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/AccountBalance.java", "diffHunk": "@@ -43,6 +49,13 @@\n \n     private long balance;\n \n+    @OneToMany(cascade = {CascadeType.ALL}, orphanRemoval = true, fetch = FetchType.EAGER)\n+    @JoinColumns({\n+            @JoinColumn(name = \"consensusTimestamp\"),\n+            @JoinColumn(name = \"accountId\")\n+    })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "552801f4b2a63d039ae1fd0958f0907b0869874c"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMTIwNjcw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#pullrequestreview-500120670", "createdAt": "2020-10-01T08:31:05Z", "commit": {"oid": "552801f4b2a63d039ae1fd0958f0907b0869874c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODozMTowNVrOHa_9mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODozMTowNVrOHa_9mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3Mjk4NQ==", "bodyText": "Add a test for this class", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498072985", "createdAt": "2020-10-01T08:31:05Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_010_HEADER_PREFIX = \"# 0.1.0\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "552801f4b2a63d039ae1fd0958f0907b0869874c"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47363c0779322d56febd4778de6d404046ce6598", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/47363c0779322d56febd4778de6d404046ce6598", "committedDate": "2020-10-01T08:32:45Z", "message": "Removed unused test resource\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNTQ4Nzc3", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#pullrequestreview-500548777", "createdAt": "2020-10-01T17:02:42Z", "commit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNzowMjo0MlrOHbTb4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODoyNTozMlrOHbWJwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM5MjAzMw==", "bodyText": "nit: can remove\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            //import com.hedera.mirror.importer.converter.TokenIdConverter;", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498392033", "createdAt": "2020-10-01T17:02:42Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/TokenBalance.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package com.hedera.mirror.importer.domain;\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ *\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.fasterxml.jackson.annotation.JsonUnwrapped;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import java.io.Serializable;\n+import javax.persistence.Convert;\n+import javax.persistence.Embeddable;\n+import javax.persistence.EmbeddedId;\n+import javax.persistence.Entity;\n+import lombok.AllArgsConstructor;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n+import org.springframework.data.domain.Persistable;\n+\n+import com.hedera.mirror.importer.converter.AccountIdConverter;\n+import com.hedera.mirror.importer.converter.EntityIdSerializer;\n+import com.hedera.mirror.importer.converter.TokenIdConverter;\n+//import com.hedera.mirror.importer.converter.TokenIdConverter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM5MjY0Nw==", "bodyText": "nit: empty line between members for readability", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498392647", "createdAt": "2020-10-01T17:03:46Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/TokenBalance.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package com.hedera.mirror.importer.domain;\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ *\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.fasterxml.jackson.annotation.JsonUnwrapped;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import java.io.Serializable;\n+import javax.persistence.Convert;\n+import javax.persistence.Embeddable;\n+import javax.persistence.EmbeddedId;\n+import javax.persistence.Entity;\n+import lombok.AllArgsConstructor;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n+import org.springframework.data.domain.Persistable;\n+\n+import com.hedera.mirror.importer.converter.AccountIdConverter;\n+import com.hedera.mirror.importer.converter.EntityIdSerializer;\n+import com.hedera.mirror.importer.converter.TokenIdConverter;\n+//import com.hedera.mirror.importer.converter.TokenIdConverter;\n+\n+@Data\n+@AllArgsConstructor\n+@NoArgsConstructor\n+@Entity\n+public class TokenBalance implements Persistable<TokenBalance.Id> {\n+    private long balance;\n+    @EmbeddedId\n+    @JsonUnwrapped\n+    private TokenBalance.Id id;\n+\n+    @Override\n+    public boolean isNew() {\n+        return true; // Since we never update balances and use a natural ID, avoid Hibernate querying before insert\n+    }\n+\n+    @Data\n+    @AllArgsConstructor\n+    @NoArgsConstructor\n+    @Embeddable\n+    public static class Id implements Serializable {\n+        private static final long serialVersionUID = -8547332015249955424L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM5MzgwMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    tryExecuteBatchStatement(insertBalanceStatement, \"Some account balance insert statement in the \" +\n          \n          \n            \n                    tryExecuteBatchStatement(insertBalanceStatement, \"Some account balance insert statements in the \" +", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498393803", "createdAt": "2020-10-01T17:06:04Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoader.java", "diffHunk": "@@ -175,31 +189,63 @@ private void insertAccountBalanceSet(PreparedStatement insertSetStatement, long\n         insertSetStatement.execute();\n     }\n \n-    private void tryInsertBatchAccountBalance(PreparedStatement insertBalanceStatement,\n-                                              List<AccountBalance> accountBalanceList, int threshold) throws SQLException {\n+    private void tryInsertBatchAccountBalanceAndTokenBalance(PreparedStatement insertBalanceStatement,\n+                                                             PreparedStatement insertBatchTokenBalanceStatement,\n+                                                             List<AccountBalance> accountBalanceList, int threshold) throws SQLException {\n         if (accountBalanceList.size() < threshold) {\n             return;\n         }\n-\n         for (var accountBalance : accountBalanceList) {\n-            AccountBalance.Id id = accountBalance.getId();\n-            insertBalanceStatement.setLong(F_INSERT_BALANCE.CONSENSUS_TIMESTAMP.ordinal(), id.getConsensusTimestamp());\n-            insertBalanceStatement.setLong(F_INSERT_BALANCE.ACCOUNT_ID.ordinal(), id.getAccountId().getId());\n-            insertBalanceStatement.setLong(F_INSERT_BALANCE.BALANCE.ordinal(), accountBalance.getBalance());\n-            insertBalanceStatement.addBatch();\n+            buildBatchAccountBalanceStatement(insertBalanceStatement, accountBalance);\n+            buildBatchAccountTokenBalanceStatement(insertBatchTokenBalanceStatement, accountBalance.getTokenBalances());\n         }\n-\n+        tryExecuteBatchStatement(insertBalanceStatement, \"Some account balance insert statement in the \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM5NDAxMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    tryExecuteBatchStatement(insertBatchTokenBalanceStatement, \"Some account token balance insert statement in \" +\n          \n          \n            \n                    tryExecuteBatchStatement(insertBatchTokenBalanceStatement, \"Some account token balance insert statements in \" +", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498394011", "createdAt": "2020-10-01T17:06:31Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoader.java", "diffHunk": "@@ -175,31 +189,63 @@ private void insertAccountBalanceSet(PreparedStatement insertSetStatement, long\n         insertSetStatement.execute();\n     }\n \n-    private void tryInsertBatchAccountBalance(PreparedStatement insertBalanceStatement,\n-                                              List<AccountBalance> accountBalanceList, int threshold) throws SQLException {\n+    private void tryInsertBatchAccountBalanceAndTokenBalance(PreparedStatement insertBalanceStatement,\n+                                                             PreparedStatement insertBatchTokenBalanceStatement,\n+                                                             List<AccountBalance> accountBalanceList, int threshold) throws SQLException {\n         if (accountBalanceList.size() < threshold) {\n             return;\n         }\n-\n         for (var accountBalance : accountBalanceList) {\n-            AccountBalance.Id id = accountBalance.getId();\n-            insertBalanceStatement.setLong(F_INSERT_BALANCE.CONSENSUS_TIMESTAMP.ordinal(), id.getConsensusTimestamp());\n-            insertBalanceStatement.setLong(F_INSERT_BALANCE.ACCOUNT_ID.ordinal(), id.getAccountId().getId());\n-            insertBalanceStatement.setLong(F_INSERT_BALANCE.BALANCE.ordinal(), accountBalance.getBalance());\n-            insertBalanceStatement.addBatch();\n+            buildBatchAccountBalanceStatement(insertBalanceStatement, accountBalance);\n+            buildBatchAccountTokenBalanceStatement(insertBatchTokenBalanceStatement, accountBalance.getTokenBalances());\n         }\n-\n+        tryExecuteBatchStatement(insertBalanceStatement, \"Some account balance insert statement in the \" +\n+                \"batch failed to execute\");\n+        tryExecuteBatchStatement(insertBatchTokenBalanceStatement, \"Some account token balance insert statement in \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM5NTU3NQ==", "bodyText": "This should be v2, service should have made that fix but you can verify\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final String VERSION_010_HEADER_PREFIX = \"# 0.1.0\";\n          \n          \n            \n                private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498395575", "createdAt": "2020-10-01T17:09:30Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_010_HEADER_PREFIX = \"# 0.1.0\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQzNjU0NQ==", "bodyText": "Not needed. I think we had discussed being strict on this version of the file, so we expect line 1 to have the version", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498436545", "createdAt": "2020-10-01T18:25:32Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final int MAX_HEADER_ROWS = 10;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNjI2NDYx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#pullrequestreview-500626461", "createdAt": "2020-10-01T18:48:47Z", "commit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODo0ODo0N1rOHbW4iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODo0ODo0N1rOHbW4iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ0ODUyMQ==", "bodyText": "The source file TokenBalanceRepository.java is missing", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498448521", "createdAt": "2020-10-01T18:48:47Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoaderTest.java", "diffHunk": "@@ -47,9 +47,11 @@\n import com.hedera.mirror.importer.domain.AccountBalanceFile;\n import com.hedera.mirror.importer.domain.EntityId;\n import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n import com.hedera.mirror.importer.repository.AccountBalanceFileRepository;\n import com.hedera.mirror.importer.repository.AccountBalanceRepository;\n import com.hedera.mirror.importer.repository.AccountBalanceSetRepository;\n+import com.hedera.mirror.importer.repository.TokenBalanceRepository;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNzAyMDEz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#pullrequestreview-500702013", "createdAt": "2020-10-01T20:40:51Z", "commit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMDo0MDo1MVrOHbaG9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMTowOToyOFrOHba6ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUwMTM2Nw==", "bodyText": "the number of token balances overall and the number of account balances will differ most likely, batching them together actually honor the batchSize for account balances but not for token balances. this will have an impact on performance", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498501367", "createdAt": "2020-10-01T20:40:51Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoader.java", "diffHunk": "@@ -175,31 +189,63 @@ private void insertAccountBalanceSet(PreparedStatement insertSetStatement, long\n         insertSetStatement.execute();\n     }\n \n-    private void tryInsertBatchAccountBalance(PreparedStatement insertBalanceStatement,\n-                                              List<AccountBalance> accountBalanceList, int threshold) throws SQLException {\n+    private void tryInsertBatchAccountBalanceAndTokenBalance(PreparedStatement insertBalanceStatement,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxMDY5Nw==", "bodyText": "should test both v1 and v2 balance files", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498510697", "createdAt": "2020-10-01T21:00:34Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoaderTest.java", "diffHunk": "@@ -65,37 +67,40 @@\n     @Resource\n     private AccountBalanceRepository accountBalanceRepository;\n \n+    @Resource\n+    private TokenBalanceRepository tokenBalanceRepository;\n+\n     @Resource\n     private AccountBalanceSetRepository accountBalanceSetRepository;\n \n     @Resource\n     private AccountBalanceFileRepository accountBalanceFileRepository;\n \n     @Resource\n-    private BalanceFileReaderImpl balanceFileReader;\n+    private BalanceFileReaderImplV2 balanceFileReader;\n \n     private FileCopier fileCopier;\n     private BalanceFile balanceFile;\n     private File testFile;\n \n     @BeforeEach\n     void setup() {\n-        balanceFile = new BalanceFile(1567188900016002001L, 25391, \"2019-08-30T18_15_00.016002001Z_Balances.csv\");\n+        balanceFile = new BalanceFile(1600748700083212003L, 106, \"2020-09-22T04_25_00.083212003Z_Balances.csv\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxNDU5MA==", "bodyText": "the expected token balance list should be something like \",\" separated tokenid=balance string, not the base64 encoded protobuf", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498514590", "createdAt": "2020-10-01T21:09:28Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2Test.java", "diffHunk": "@@ -0,0 +1,100 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import org.apache.commons.codec.binary.Base64;\n+import org.apache.commons.lang3.StringUtils;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.CsvSource;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+class AccountBalanceLineParserV2Test {\n+\n+    private static final long timestamp = 1596340377922333444L;\n+    private static final long systemShardNum = 0;\n+\n+    @DisplayName(\"Parse account balance line\")\n+    @ParameterizedTest(name = \"from \\\"{0}\\\"\")\n+    @CsvSource(value = {\n+            \"'0,0,123,700,CggKAxjsBxCEBwoHCgMY7QcQGQoKCgMY7gcQwKilBAoICgMY8gcQhAcKBwoDGPMHEBkKCgoDGPQHEMCopQQ';false;\" +\n+                    \"0;123;700;CggKAxjsBxCEBwoHCgMY7QcQGQoKCgMY7gcQwKilBAoICgMY8gcQhAcKBwoDGPMHEBkKCgoDGPQHEMCopQQ\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e320209d69a9ae6b2eabbe5949d3835e4919f444", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e320209d69a9ae6b2eabbe5949d3835e4919f444", "committedDate": "2020-10-02T05:04:21Z", "message": "Address PR comments\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e2c668358b16977fb2a3d82ea0f95d4bad1f11e2", "committedDate": "2020-10-02T05:23:59Z", "message": "Address PR comments\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjU1ODcy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#pullrequestreview-501255872", "createdAt": "2020-10-02T15:55:08Z", "commit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo1NTowOVrOHby7ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjozMToxNVrOHb0ELw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwODA5MA==", "bodyText": "tryInsertBatchAccountBalance  is called twice\ntryInsertBatchTokenBalance does nothing because accountBalanceList is cleared by tryInsertBatchAccountBalance this leads to loss of all token balances", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498908090", "createdAt": "2020-10-02T15:55:09Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoader.java", "diffHunk": "@@ -148,11 +159,14 @@ public void loadAccountBalances(@NonNull File balanceFile, DateRangeFilter dateR\n                 if (!skip) {\n                     accountBalanceList.add(accountBalance);\n                     tryInsertBatchAccountBalance(insertBalanceStatement, accountBalanceList, insertBatchSize);\n+                    tryInsertBatchAccountBalance(insertBalanceStatement, accountBalanceList, insertBatchSize);\n+                    tryInsertBatchTokenBalance(insertTokenBalanceStatement, accountBalanceList, insertBatchSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxMzY5Nw==", "bodyText": "should handle NPE", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498913697", "createdAt": "2020-10-02T16:05:51Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.version1Reader = balanceFileReaderImplV1;\n+        this.version2Reader = balanceFileReaderImplV2;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            String line = Optional.of(reader.readLine()).get().trim();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyMDQzNw==", "bodyText": "accountId created twice", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498920437", "createdAt": "2020-10-02T16:19:04Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 {\n+\n+    /**\n+     * Parses an account balance line to extract shard, realm, account, and balance. If the shard matches\n+     * systemShardNum, creates and returns an {@code AccountBalance} entity object. The account balance line should be\n+     * in the format of \"shard,realm,account,balance\"\n+     *\n+     * @param line               The account balance line\n+     * @param consensusTimestamp The consensus timestamp of the account balance line\n+     * @param systemShardNum     The system shard number\n+     * @return {@code AccountBalance} entity object\n+     * @throws InvalidDatasetException if the line is malformed or the shard does not match {@code systemShardNum}\n+     */\n+    public AccountBalance parse(String line, long consensusTimestamp, long systemShardNum) {\n+        try {\n+            String[] parts = line.split(\",\");\n+            boolean hasTokenBalance;\n+            if (parts.length == 5) {\n+                hasTokenBalance = true;\n+            } else if (parts.length == 4) {\n+                hasTokenBalance = false;\n+            } else {\n+                throw new InvalidDatasetException(\"Invalid account balance line: \" + line);\n+            }\n+\n+            long shardNum = Long.parseLong(parts[0]);\n+            int realmNum = Integer.parseInt(parts[1]);\n+            int accountNum = Integer.parseInt(parts[2]);\n+            long balance = Long.parseLong(parts[3]);\n+\n+            if (shardNum < 0 || realmNum < 0 || accountNum < 0 || balance < 0) {\n+                throw new InvalidDatasetException(\"Invalid account balance line: \" + line);\n+            }\n+\n+            if (shardNum != systemShardNum) {\n+                throw new InvalidDatasetException(String.format(\"Invalid account balance line: %s. Expect \" +\n+                        \"shard (%d), got shard (%d)\", line, systemShardNum, shardNum));\n+            }\n+\n+            EntityId accountId = EntityId\n+                    .of(shardNum, realmNum, accountNum, EntityTypeEnum.ACCOUNT);\n+\n+            List<TokenBalance> tokenBalances = hasTokenBalance ? parseTokenBalanceList(parts[4], consensusTimestamp,\n+                    accountId) : Collections\n+                    .emptyList();\n+\n+            return new AccountBalance(balance, tokenBalances, new AccountBalance.Id(consensusTimestamp, EntityId", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyMjk5Nw==", "bodyText": "the first line does not match CompositeBalanceFileReader.VERSION_2_HEADER_PREFIX", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498922997", "createdAt": "2020-10-02T16:24:07Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/test/resources/data/accountBalances/v2/2020-09-22T04_25_00.083212003Z_Balances.csv", "diffHunk": "@@ -0,0 +1,109 @@\n+# 0.1.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyNTU4NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new InvalidDatasetException(\"Timestamp / column header not found in account balance file\");\n          \n          \n            \n                            throw new InvalidDatasetException(\"Timestamp header not found in account balance file\");", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498925584", "createdAt": "2020-10-02T16:29:14Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# timestamp:\";\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+\n+    private final int fileBufferSize;\n+    private final long systemShardNum;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    public BalanceFileReaderImplV2(BalanceParserProperties balanceParserProperties, AccountBalanceLineParserV2\n+            parser) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.systemShardNum = balanceParserProperties.getMirrorProperties().getShard();\n+        this.parser = parser;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, systemShardNum);\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            //Discard the first line/version number\n+            reader.readLine();\n+            line = Optional.of(reader.readLine()).get().trim();\n+            String lineLowered = line.toLowerCase();\n+            if (lineLowered.startsWith(TIMESTAMP_HEADER_PREFIX)) {\n+                return convertTimestampLine(line);\n+            } else {\n+                throw new InvalidDatasetException(\"Timestamp / column header not found in account balance file\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyNjYzOQ==", "bodyText": "should read the column header after the timestamp line. otherwise the column header line is fed to the parser although the reader would just swallow the InvalidDataSetException and return a null which is then filtered in the streams pipeline.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498926639", "createdAt": "2020-10-02T16:31:15Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# timestamp:\";\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+\n+    private final int fileBufferSize;\n+    private final long systemShardNum;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    public BalanceFileReaderImplV2(BalanceParserProperties balanceParserProperties, AccountBalanceLineParserV2\n+            parser) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.systemShardNum = balanceParserProperties.getMirrorProperties().getShard();\n+        this.parser = parser;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, systemShardNum);\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            //Discard the first line/version number\n+            reader.readLine();\n+            line = Optional.of(reader.readLine()).get().trim();\n+            String lineLowered = line.toLowerCase();\n+            if (lineLowered.startsWith(TIMESTAMP_HEADER_PREFIX)) {\n+                return convertTimestampLine(line);\n+            } else {\n+                throw new InvalidDatasetException(\"Timestamp / column header not found in account balance file\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyNTU4NA=="}, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 97}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a8664ac75ae037a9df193da1c4a73373fcc5d62", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0a8664ac75ae037a9df193da1c4a73373fcc5d62", "committedDate": "2020-10-02T16:34:50Z", "message": "Correct token balance insert to use correct size for batching\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d378cbc01eec7592992b02aaf208b6a6eeb212a9", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d378cbc01eec7592992b02aaf208b6a6eeb212a9", "committedDate": "2020-10-02T16:37:16Z", "message": "Correct bad logic in loader\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/31b80795d0a0591f2de99cd3290080b28453deee", "committedDate": "2020-10-02T16:47:52Z", "message": "Separate account balance list from token balance list\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNDEzNjU2", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#pullrequestreview-501413656", "createdAt": "2020-10-02T20:02:43Z", "commit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMDowMjo0M1rOHb6FPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMDowMjo0M1rOHb6FPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyNTIxNA==", "bodyText": "The test failure is caused by actual tokenBalances not equal to expected tokenBalances\nIn addition, since AccountBalance has oneToMany field List<TokenBalance>, we should test with token balance data instead of empty", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499025214", "createdAt": "2020-10-02T20:02:43Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/repository/AccountBalanceRepositoryTest.java", "diffHunk": "@@ -39,7 +40,7 @@ void findByConsensusTimestamp() {\n         AccountBalance accountBalance1 = create(1L, 1, 100);\n         AccountBalance accountBalance2 = create(1L, 2, 200);\n         create(2L, 1, 50);\n-\n+        \n         assertThat(accountBalanceRepository.findByIdConsensusTimestamp(1L))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e77159598afe0581227fcf06e9b85f0e316e8e2e", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e77159598afe0581227fcf06e9b85f0e316e8e2e", "committedDate": "2020-10-02T20:08:22Z", "message": "Add Composite Balance File Reader test and PR comments\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMzM2OTky", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#pullrequestreview-501336992", "createdAt": "2020-10-02T17:57:00Z", "commit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNzo1NzowMFrOHb2k6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMToyNDo1MFrOHb8AzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk2Nzc4Nw==", "bodyText": "Reader not being closed on unhappy path. Use try with resources", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498967787", "createdAt": "2020-10-02T17:57:00Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.version1Reader = balanceFileReaderImplV1;\n+        this.version2Reader = balanceFileReaderImplV2;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk2ODQ4NQ==", "bodyText": "The reader classes should go in com.hedera.mirror.importer.reader.balance so they can be later shared with downloader.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498968485", "createdAt": "2020-10-02T17:58:31Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4MDE4Mw==", "bodyText": "You don't need this. The composite only reads a single line so it's inefficient to tell the reader to load 200K characters. Can switch to @RequiredArgsConstructor once removed.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498980183", "createdAt": "2020-10-02T18:19:51Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4MDYzOQ==", "bodyText": "We don't need as much buffer as fileBufferSize property and even the default in BufferedReader might be too much. Please considering passing a reasonable value to read one line.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498980639", "createdAt": "2020-10-02T18:20:49Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.version1Reader = balanceFileReaderImplV1;\n+        this.version2Reader = balanceFileReaderImplV2;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4Mjk3Mw==", "bodyText": "I'm not sure we should be so lenient with case or spaces. Maybe trailing spaces but not leading spaces. Recommend avoiding optional, trim, toLowerCase and just using StringUtils.startsWith(line, VERSION_2_HEADER_PREFIX).", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498982973", "createdAt": "2020-10-02T18:25:37Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.version1Reader = balanceFileReaderImplV1;\n+        this.version2Reader = balanceFileReaderImplV2;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            String line = Optional.of(reader.readLine()).get().trim();\n+            String lineLowered = line.toLowerCase();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4NTMzOQ==", "bodyText": "Duplicates call to read. Would be better to have a private BalanceFileReader getReader(file) method that encapsulates the reader selection.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498985339", "createdAt": "2020-10-02T18:30:18Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.version1Reader = balanceFileReaderImplV1;\n+        this.version2Reader = balanceFileReaderImplV2;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            String line = Optional.of(reader.readLine()).get().trim();\n+            String lineLowered = line.toLowerCase();\n+            reader.close();\n+            if (lineLowered.startsWith(VERSION_2_HEADER_PREFIX)) {\n+                return version2Reader.read(file);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4NjU3Mg==", "bodyText": "Please create an interface that these both implement.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498986572", "createdAt": "2020-10-02T18:32:53Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAwNDYxMg==", "bodyText": "Comment out of date", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499004612", "createdAt": "2020-10-02T19:13:28Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 {\n+\n+    /**\n+     * Parses an account balance line to extract shard, realm, account, and balance. If the shard matches", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAwNjAzNw==", "bodyText": "Would be more robust to use Splitter.on(',').trimResults().omitEmptyStrings().splitToList(line).", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499006037", "createdAt": "2020-10-02T19:16:52Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 {\n+\n+    /**\n+     * Parses an account balance line to extract shard, realm, account, and balance. If the shard matches\n+     * systemShardNum, creates and returns an {@code AccountBalance} entity object. The account balance line should be\n+     * in the format of \"shard,realm,account,balance\"\n+     *\n+     * @param line               The account balance line\n+     * @param consensusTimestamp The consensus timestamp of the account balance line\n+     * @param systemShardNum     The system shard number\n+     * @return {@code AccountBalance} entity object\n+     * @throws InvalidDatasetException if the line is malformed or the shard does not match {@code systemShardNum}\n+     */\n+    public AccountBalance parse(String line, long consensusTimestamp, long systemShardNum) {\n+        try {\n+            String[] parts = line.split(\",\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAwODEzOA==", "bodyText": "We don't need to store these properties separately. Just store the BalanceParserProperties as a field. This allows these values to change without requiring a restart. We should probably change the other reader.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499008138", "createdAt": "2020-10-02T19:21:36Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# timestamp:\";\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+\n+    private final int fileBufferSize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAxMTM1OA==", "bodyText": "The existing CSVs should be moved to a v1 folder.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499011358", "createdAt": "2020-10-02T19:29:12Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/resources/data/accountBalances/v2/2020-09-22T04_25_00.083212003Z_Balances.csv", "diffHunk": "@@ -0,0 +1,109 @@\n+# 0.1.0\n+# TimeStamp:2020-09-22T04:25:00.083212003Z\n+shardNum,realmNum,accountNum,balance,tokenBalances", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAxMzI5Nw==", "bodyText": "This test doesn't need to copy any files and it doesn't need a temp path. Can remove fileCopier, sampleFile, testFile, mirrorProperties and dataPath. Just inject the example file and directly balanceFileReader.read(balanceFile). Inject like so:\n@Value(\"classpath:data/accountBalances/v2/2020-09-22T04_25_00.083212003Z_Balances.csv\")\nprivate File balanceFile;", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499013297", "createdAt": "2020-10-02T19:33:48Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2Test.java", "diffHunk": "@@ -0,0 +1,216 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.file.Path;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.stream.Stream;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.springframework.core.io.ClassPathResource;\n+\n+import com.hedera.mirror.importer.FileCopier;\n+import com.hedera.mirror.importer.MirrorProperties;\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+class BalanceFileReaderImplV2Test {\n+    private static final String sampleBalanceFileName = \"2020-09-22T04_25_00.083212003Z_Balances.csv\";\n+\n+    @TempDir\n+    Path dataPath;\n+\n+    private MirrorProperties mirrorProperties;\n+    private BalanceFileReaderImplV2 balanceFileReader;\n+    private AccountBalanceLineParserV2 parser;\n+\n+    private long sampleConsensusTimestamp;\n+    private FileCopier fileCopier;\n+    private File sampleFile;\n+    private File testFile;\n+\n+    @BeforeEach\n+    void setup() throws IOException {\n+        mirrorProperties = new MirrorProperties();\n+        parser = new AccountBalanceLineParserV2();\n+        balanceFileReader = new BalanceFileReaderImplV2(new BalanceParserProperties(mirrorProperties), parser);\n+        var resource = new ClassPathResource(\"data\");\n+        StreamType streamType = StreamType.BALANCE;\n+        fileCopier = FileCopier", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1MjcyMg==", "bodyText": "Missing copyright. Please scan the other new files for the same.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499052722", "createdAt": "2020-10-02T21:12:50Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/repository/TokenBalanceRepository.java", "diffHunk": "@@ -0,0 +1,8 @@\n+package com.hedera.mirror.importer.repository;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1NTM0Ng==", "bodyText": "NPE. There's no point in using Optional here. StringUtils.defaultString(reader.readLine()) might be appropriate if you don't want to have to check for null.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499055346", "createdAt": "2020-10-02T21:20:30Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# timestamp:\";\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+\n+    private final int fileBufferSize;\n+    private final long systemShardNum;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    public BalanceFileReaderImplV2(BalanceParserProperties balanceParserProperties, AccountBalanceLineParserV2\n+            parser) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.systemShardNum = balanceParserProperties.getMirrorProperties().getShard();\n+        this.parser = parser;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, systemShardNum);\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            //Discard the first line/version number\n+            reader.readLine();\n+            line = Optional.of(reader.readLine()).get().trim();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1NTk2NQ==", "bodyText": "This constant belongs in BalanceFileReaderImplV2. BalanceFileReaderImplV2 should also probably be verifying this line so it can be encapsulated.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499055965", "createdAt": "2020-10-02T21:22:10Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1NjI2Ng==", "bodyText": "Unused?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499056266", "createdAt": "2020-10-02T21:23:08Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# timestamp:\";\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1Njg0NQ==", "bodyText": "What he said.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499056845", "createdAt": "2020-10-02T21:24:50Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# timestamp:\";\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+\n+    private final int fileBufferSize;\n+    private final long systemShardNum;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    public BalanceFileReaderImplV2(BalanceParserProperties balanceParserProperties, AccountBalanceLineParserV2\n+            parser) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.systemShardNum = balanceParserProperties.getMirrorProperties().getShard();\n+        this.parser = parser;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, systemShardNum);\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            //Discard the first line/version number\n+            reader.readLine();\n+            line = Optional.of(reader.readLine()).get().trim();\n+            String lineLowered = line.toLowerCase();\n+            if (lineLowered.startsWith(TIMESTAMP_HEADER_PREFIX)) {\n+                return convertTimestampLine(line);\n+            } else {\n+                throw new InvalidDatasetException(\"Timestamp / column header not found in account balance file\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyNTU4NA=="}, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 97}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2327b82f8cb742caa04117ad6942f175c9f87e96", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2327b82f8cb742caa04117ad6942f175c9f87e96", "committedDate": "2020-10-02T21:54:40Z", "message": "Change parser v2 token balances from base64 proto to list of values\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7efba2a3a96b9dec6a4e1bd898d9fd7883fd6cb", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c7efba2a3a96b9dec6a4e1bd898d9fd7883fd6cb", "committedDate": "2020-10-02T22:03:11Z", "message": "PR comments\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74acc9c7995dc0d42d6b336b0fd23d18b24bf062", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/74acc9c7995dc0d42d6b336b0fd23d18b24bf062", "committedDate": "2020-10-02T22:30:52Z", "message": "Check column header line in File Reader v2 and correct tests\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed48cde4446d4fff0e347da4392fb7b77520f640", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ed48cde4446d4fff0e347da4392fb7b77520f640", "committedDate": "2020-10-03T03:12:31Z", "message": "PR Comments for file readers and tests\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56e4399dd7b3a71dc27ec286bbac41fbb6ec33da", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/56e4399dd7b3a71dc27ec286bbac41fbb6ec33da", "committedDate": "2020-10-03T03:50:38Z", "message": "Reduce composite file reader buffer size\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43ed8ccbbcc3f28c7d298ccde5a3ac1cbaaec99b", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/43ed8ccbbcc3f28c7d298ccde5a3ac1cbaaec99b", "committedDate": "2020-10-03T04:22:54Z", "message": "PR Comments\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e01b1a9c486ef14f7e58083f3ad39c159b343be", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0e01b1a9c486ef14f7e58083f3ad39c159b343be", "committedDate": "2020-10-03T05:49:27Z", "message": "Add copyright to new files\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b274434717102f19529d798650b80db340e51170", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b274434717102f19529d798650b80db340e51170", "committedDate": "2020-10-03T05:50:53Z", "message": "Add copyright to new files\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72a675b470c635e3a8a41baa1cbd40d5eb86bd20", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/72a675b470c635e3a8a41baa1cbd40d5eb86bd20", "committedDate": "2020-10-03T05:52:45Z", "message": "Add copyright to new files\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "921ffe8b9c2f64f70c77ad597db7a5c379f7000d", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/921ffe8b9c2f64f70c77ad597db7a5c379f7000d", "committedDate": "2020-10-03T05:56:22Z", "message": "Refactor order of file reading\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed0db2d38582810e06cc2835dae8907404560a58", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ed0db2d38582810e06cc2835dae8907404560a58", "committedDate": "2020-10-03T06:02:27Z", "message": "PR Comments\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "983809cade2830f9c5a813d43f6a882630887014", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/983809cade2830f9c5a813d43f6a882630887014", "committedDate": "2020-10-03T06:22:59Z", "message": "PR comments\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61e6fa9d48d69c25ef98c31a5b26d92470537cfa", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/61e6fa9d48d69c25ef98c31a5b26d92470537cfa", "committedDate": "2020-10-03T06:28:41Z", "message": "PR Comments\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83ad9a3a67b8299e49d227bbad3faed2717c01bb", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/83ad9a3a67b8299e49d227bbad3faed2717c01bb", "committedDate": "2020-10-05T15:28:05Z", "message": "Cleanup unused vars\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29de6e5ab780e293384811ea4e2d2f07f28a5115", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/29de6e5ab780e293384811ea4e2d2f07f28a5115", "committedDate": "2020-10-05T16:02:46Z", "message": "Refactor loader test\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61c0297538487d7d960b69313d0de408cd7ee662", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/61c0297538487d7d960b69313d0de408cd7ee662", "committedDate": "2020-10-05T16:15:59Z", "message": "Add back test for File Loader v1\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c6b8f8cdbd71f8ab7c6d6da2570d30ceb64dd81", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3c6b8f8cdbd71f8ab7c6d6da2570d30ceb64dd81", "committedDate": "2020-10-05T16:59:08Z", "message": "Add token balance data to repository test\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80bac807ad166aa393fc319c853d69ba900a8f0d", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/80bac807ad166aa393fc319c853d69ba900a8f0d", "committedDate": "2020-10-05T17:39:01Z", "message": "Refactor and move test files to v1\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd0da3fc7cef6ce8510ffa59875fabb832f3a8bc", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/fd0da3fc7cef6ce8510ffa59875fabb832f3a8bc", "committedDate": "2020-10-05T17:50:35Z", "message": "Fix test failure\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6674b30f62ab66a9b018a7ac49399569517de3fc", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6674b30f62ab66a9b018a7ac49399569517de3fc", "committedDate": "2020-10-05T20:15:13Z", "message": "Reverse Account Balance Join Columns to fix join bug\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33c90abe9b043ea33c6c237a489992ddfeccece0", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/33c90abe9b043ea33c6c237a489992ddfeccece0", "committedDate": "2020-10-05T20:23:55Z", "message": "Add token balance repository test\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7ca1fb11f36879e03a66021b19da3b253088915", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d7ca1fb11f36879e03a66021b19da3b253088915", "committedDate": "2020-10-05T20:35:30Z", "message": "Document Account Balance file change in readme\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNDUyNTg0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#pullrequestreview-502452584", "createdAt": "2020-10-05T22:02:52Z", "commit": {"oid": "d7ca1fb11f36879e03a66021b19da3b253088915"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMjI4MTgx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#pullrequestreview-502228181", "createdAt": "2020-10-05T16:31:35Z", "commit": {"oid": "61c0297538487d7d960b69313d0de408cd7ee662"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjozMTozNVrOHck5Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMjoxODozOVrOHcvqng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcyNjYzOA==", "bodyText": "Catching NPE is an anti-pattern, in my opinion. The code should be fixed to handle all the null scenarios. Here, version2Reader.isFirstLineFromFileVersion(line) should be fixed to either check if line is not null before comparison or use a library like StringUtils.startsWith().", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499726638", "createdAt": "2020-10-05T16:31:35Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import org.apache.commons.io.input.BoundedInputStream;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+@RequiredArgsConstructor\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+\n+    static final int BUFFER_SIZE = 16;\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        return getReader(file).read(file);\n+    }\n+\n+    private BalanceFileReader getReader(File file) {\n+        try (BufferedReader reader =\n+                     new BufferedReader(new InputStreamReader(new BoundedInputStream(new FileInputStream(file),\n+                             BUFFER_SIZE)), BUFFER_SIZE)) {\n+            String line = reader.readLine();\n+            if (version2Reader.isFirstLineFromFileVersion(line)) {\n+                return version2Reader;\n+            } else {\n+                return version1Reader;\n+            }\n+        } catch (IOException | NullPointerException ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c0297538487d7d960b69313d0de408cd7ee662"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcyNzM3Mw==", "bodyText": "See previous comment about anti-pattern. Also because a null check is orders of magnitude faster than generating an exception. Please check if readLine() calls return null.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499727373", "createdAt": "2020-10-05T16:32:57Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.parser.balance.line.AccountBalanceLineParserV2;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# TimeStamp:\";\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final BalanceParserProperties balanceParserProperties;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    balanceParserProperties.getFileBufferSize());\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, balanceParserProperties.getMirrorProperties()\n+                                    .getShard());\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    public boolean isFirstLineFromFileVersion(String firstLine) {\n+        return firstLine.startsWith(VERSION_2_HEADER_PREFIX);\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            //Discard the first line/version number\n+            reader.readLine();\n+            line = reader.readLine();\n+            if (line.startsWith(TIMESTAMP_HEADER_PREFIX)) {\n+                long consensusTimestamp = convertTimestampLine(line);\n+                line = reader.readLine();\n+                if (line.startsWith(COLUMN_HEADER_PREFIX)) {\n+                    return consensusTimestamp;\n+                } else {\n+                    throw new InvalidDatasetException(\"Column header not found in account balance file\");\n+                }\n+            } else {\n+                throw new InvalidDatasetException(\"Timestamp not found in account balance file\");\n+            }\n+        } catch (NullPointerException ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c0297538487d7d960b69313d0de408cd7ee662"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczMDk2Ng==", "bodyText": "Since the line parsers are only used by the readers, they should probably be moved to the same package as the readers (or a sub-package).", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499730966", "createdAt": "2020-10-05T16:39:11Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.parser.balance.line.AccountBalanceLineParserV2;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c0297538487d7d960b69313d0de408cd7ee662"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczMjY2NQ==", "bodyText": "Splitter is an immutable, stateless object so its construction can be moved to a class static constant. e.g.\nprivate static final Splitter SPLITTER = Splitter.on(',').trimResults().omitEmptyStrings();", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499732665", "createdAt": "2020-10-05T16:42:05Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/line/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package com.hedera.mirror.importer.parser.balance.line;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.google.common.base.Splitter;\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 implements AccountBalanceLineParser {\n+\n+    /**\n+     * Parses an account balance line to extract shard, realm, account, balance, and token balances. If the shard\n+     * matches systemShardNum, creates and returns an {@code AccountBalance} entity object. The account balance line\n+     * should be in the format of \"shard,realm,account,balance\"\n+     *\n+     * @param line               The account balance line\n+     * @param consensusTimestamp The consensus timestamp of the account balance line\n+     * @param systemShardNum     The system shard number\n+     * @return {@code AccountBalance} entity object\n+     * @throws InvalidDatasetException if the line is malformed or the shard does not match {@code systemShardNum}\n+     */\n+    @Override\n+    public AccountBalance parse(String line, long consensusTimestamp, long systemShardNum) {\n+        try {\n+            List<String> parts = Splitter.on(',').trimResults().omitEmptyStrings().splitToList(line);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c0297538487d7d960b69313d0de408cd7ee662"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczMzI0OQ==", "bodyText": "nit: Both Files should be private.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499733249", "createdAt": "2020-10-05T16:43:05Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2Test.java", "diffHunk": "@@ -0,0 +1,249 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.file.Files;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.stream.Stream;\n+import javax.annotation.Resource;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Value;\n+\n+import com.hedera.mirror.importer.IntegrationTest;\n+import com.hedera.mirror.importer.MirrorProperties;\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.line.AccountBalanceLineParserV2;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+class BalanceFileReaderImplV2Test extends IntegrationTest {\n+\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+    private static final String VERSION_1_TIMESTAMP_HEADER_PREFIX = \"timestamp:\";\n+\n+    @Resource\n+    private MirrorProperties mirrorProperties;\n+    @Resource\n+    private BalanceFileReaderImplV2 balanceFileReader;\n+    @Resource\n+    private AccountBalanceLineParserV2 parser;\n+\n+    private long sampleConsensusTimestamp;\n+\n+    @Value(\"classpath:data/accountBalances/v2/2020-09-22T04_25_00.083212003Z_Balances.csv\")\n+    File balanceFile;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c0297538487d7d960b69313d0de408cd7ee662"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMjU2Ng==", "bodyText": "Again, NPE should be avoided. Can simply wrap for loop in check for StringUtils.isNotBlank(line) and return empty tokenBalances.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499902566", "createdAt": "2020-10-05T22:16:59Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/line/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package com.hedera.mirror.importer.parser.balance.line;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.google.common.base.Splitter;\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 implements AccountBalanceLineParser {\n+\n+    /**\n+     * Parses an account balance line to extract shard, realm, account, balance, and token balances. If the shard\n+     * matches systemShardNum, creates and returns an {@code AccountBalance} entity object. The account balance line\n+     * should be in the format of \"shard,realm,account,balance\"\n+     *\n+     * @param line               The account balance line\n+     * @param consensusTimestamp The consensus timestamp of the account balance line\n+     * @param systemShardNum     The system shard number\n+     * @return {@code AccountBalance} entity object\n+     * @throws InvalidDatasetException if the line is malformed or the shard does not match {@code systemShardNum}\n+     */\n+    @Override\n+    public AccountBalance parse(String line, long consensusTimestamp, long systemShardNum) {\n+        try {\n+            List<String> parts = Splitter.on(',').trimResults().omitEmptyStrings().splitToList(line);\n+            boolean hasTokenBalance;\n+            if (parts.size() == 5) {\n+                hasTokenBalance = true;\n+            } else if (parts.size() == 4) {\n+                hasTokenBalance = false;\n+            } else {\n+                throw new InvalidDatasetException(\"Invalid account balance line: \" + line);\n+            }\n+\n+            long shardNum = Long.parseLong(parts.get(0));\n+            int realmNum = Integer.parseInt(parts.get(1));\n+            int accountNum = Integer.parseInt(parts.get(2));\n+            long balance = Long.parseLong(parts.get(3));\n+\n+            if (shardNum < 0 || realmNum < 0 || accountNum < 0 || balance < 0) {\n+                throw new InvalidDatasetException(\"Invalid account balance line: \" + line);\n+            }\n+\n+            if (shardNum != systemShardNum) {\n+                throw new InvalidDatasetException(String.format(\"Invalid account balance line: %s. Expect \" +\n+                        \"shard (%d), got shard (%d)\", line, systemShardNum, shardNum));\n+            }\n+\n+            EntityId accountId = EntityId\n+                    .of(shardNum, realmNum, accountNum, EntityTypeEnum.ACCOUNT);\n+\n+            List<TokenBalance> tokenBalances = hasTokenBalance ? parseTokenBalanceList(parts.get(4), consensusTimestamp,\n+                    accountId) : Collections\n+                    .emptyList();\n+\n+            return new AccountBalance(balance, tokenBalances, new AccountBalance.Id(consensusTimestamp, accountId));\n+        } catch (NullPointerException | NumberFormatException | InvalidProtocolBufferException ex) {\n+            throw new InvalidDatasetException(\"Invalid account balance line: \" + line, ex);\n+        }\n+    }\n+\n+    private List<TokenBalance> parseTokenBalanceList(String tokenBalancesProtoString, long consensusTimestamp,\n+                                                     EntityId accountId) throws InvalidProtocolBufferException {\n+        List<com.hederahashgraph.api.proto.java.TokenBalance> tokenBalanceProtoList =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7ca1fb11f36879e03a66021b19da3b253088915"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMzEzNA==", "bodyText": "Would prefer version check is repeated here for encapsulation in case this class is ever used outside the composite in the future.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499903134", "createdAt": "2020-10-05T22:18:39Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.parser.balance.line.AccountBalanceLineParserV2;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# TimeStamp:\";\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final BalanceParserProperties balanceParserProperties;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    balanceParserProperties.getFileBufferSize());\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, balanceParserProperties.getMirrorProperties()\n+                                    .getShard());\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    public boolean isFirstLineFromFileVersion(String firstLine) {\n+        return firstLine.startsWith(VERSION_2_HEADER_PREFIX);\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            //Discard the first line/version number\n+            reader.readLine();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7ca1fb11f36879e03a66021b19da3b253088915"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b879f04e0659620ca5a0cb11dc89ae6fbcc46052", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b879f04e0659620ca5a0cb11dc89ae6fbcc46052", "committedDate": "2020-10-05T23:41:18Z", "message": "PR Comments\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fd7fd187f5dddbbf0f554afcb1cce792996a9c8", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9fd7fd187f5dddbbf0f554afcb1cce792996a9c8", "committedDate": "2020-10-06T00:23:25Z", "message": "Remove NPE checks\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a7f7197c2b139c8e5a2d29094977c7bafa3364f", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4a7f7197c2b139c8e5a2d29094977c7bafa3364f", "committedDate": "2020-10-06T00:38:49Z", "message": "NPE fix\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70bd15d8d5f6872f35f3b7de31ee7663a09c1219", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/70bd15d8d5f6872f35f3b7de31ee7663a09c1219", "committedDate": "2020-10-06T00:58:21Z", "message": "NPE check in line parsers\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMDU0NDU0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#pullrequestreview-503054454", "createdAt": "2020-10-06T14:53:35Z", "commit": {"oid": "70bd15d8d5f6872f35f3b7de31ee7663a09c1219"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNDo1MzozNVrOHdLY5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNDo1MzozNVrOHdLY5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM1NzM1MQ==", "bodyText": "nit: For future reference, prefer fail fast exception throwing where the negative path is first. This leads to less nested code and is easier to understand and maintain. e.g.\nif (!correct) {\n throw ...\n}\nif (stillNotCorrect) {\n  throw ...\n}\nreturn someValue;", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r500357351", "createdAt": "2020-10-06T14:53:35Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.apache.commons.lang3.StringUtils;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.reader.balance.line.AccountBalanceLineParserV2;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# TimeStamp:\";\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final BalanceParserProperties balanceParserProperties;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        if (file == null) {\n+            throw new InvalidDatasetException(\"Null file provided to balance file reader\");\n+        }\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    balanceParserProperties.getFileBufferSize());\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, balanceParserProperties.getMirrorProperties()\n+                                    .getShard());\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    public boolean isFirstLineFromFileVersion(String firstLine) {\n+        return StringUtils.startsWith(firstLine, VERSION_2_HEADER_PREFIX);\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            line = reader.readLine();\n+            if (isFirstLineFromFileVersion(line)) {\n+                line = reader.readLine();\n+                if (StringUtils.startsWith(line, TIMESTAMP_HEADER_PREFIX)) {\n+                    long consensusTimestamp = convertTimestampLine(line);\n+                    line = reader.readLine();\n+                    if (StringUtils.startsWith(line, COLUMN_HEADER_PREFIX)) {\n+                        return consensusTimestamp;\n+                    } else {\n+                        throw new InvalidDatasetException(\"Column header not found in account balance file\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70bd15d8d5f6872f35f3b7de31ee7663a09c1219"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMDcwNDcz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#pullrequestreview-503070473", "createdAt": "2020-10-06T15:08:07Z", "commit": {"oid": "70bd15d8d5f6872f35f3b7de31ee7663a09c1219"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTowODowOFrOHdMPAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNToxMTo1M1rOHdMdgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3MTIwMw==", "bodyText": "balanceParserProperties.getMirrorProperties().getShard() is called per account balance line, there can be considerable performance hit. Please move it out of the streams pipeline.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r500371203", "createdAt": "2020-10-06T15:08:08Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV1.java", "diffHunk": "@@ -28,43 +28,45 @@\n import java.time.Instant;\n import java.time.format.DateTimeParseException;\n import java.util.Objects;\n-import java.util.Optional;\n import java.util.stream.Stream;\n import javax.inject.Named;\n+import lombok.AllArgsConstructor;\n import lombok.extern.log4j.Log4j2;\n+import org.apache.commons.lang3.StringUtils;\n \n import com.hedera.mirror.importer.domain.AccountBalance;\n import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.reader.balance.line.AccountBalanceLineParserV1;\n import com.hedera.mirror.importer.util.Utility;\n \n+@AllArgsConstructor\n @Log4j2\n @Named\n-public class BalanceFileReaderImpl implements BalanceFileReader {\n+public class BalanceFileReaderImplV1 implements BalanceFileReader {\n     private static final int MAX_HEADER_ROWS = 10;\n     private static final String TIMESTAMP_HEADER_PREFIX = \"timestamp:\";\n     private static final String COLUMN_HEADER_PREFIX = \"shard\";\n \n-    private final int fileBufferSize;\n-    private final long systemShardNum;\n-    private final AccountBalanceLineParser parser;\n-\n-    public BalanceFileReaderImpl(BalanceParserProperties balanceParserProperties, AccountBalanceLineParser parser) {\n-        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n-        this.systemShardNum = balanceParserProperties.getMirrorProperties().getShard();\n-        this.parser = parser;\n-    }\n+    private final BalanceParserProperties balanceParserProperties;\n+    private final AccountBalanceLineParserV1 parser;\n \n     @Override\n     public Stream<AccountBalance> read(File file) {\n+        if (file == null) {\n+            throw new InvalidDatasetException(\"Null file provided to balance file reader\");\n+        }\n         try {\n-            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)), fileBufferSize);\n-            final long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    balanceParserProperties.getFileBufferSize());\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n \n             return reader.lines()\n                     .map(line -> {\n                         try {\n-                            return parser.parse(line, consensusTimestamp, systemShardNum);\n-                        } catch(InvalidDatasetException ex) {\n+                            return parser.parse(line, consensusTimestamp, balanceParserProperties.getMirrorProperties()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70bd15d8d5f6872f35f3b7de31ee7663a09c1219"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3NDkxNA==", "bodyText": "same as above", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r500374914", "createdAt": "2020-10-06T15:11:53Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.apache.commons.lang3.StringUtils;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.reader.balance.line.AccountBalanceLineParserV2;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# TimeStamp:\";\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final BalanceParserProperties balanceParserProperties;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        if (file == null) {\n+            throw new InvalidDatasetException(\"Null file provided to balance file reader\");\n+        }\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    balanceParserProperties.getFileBufferSize());\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, balanceParserProperties.getMirrorProperties()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70bd15d8d5f6872f35f3b7de31ee7663a09c1219"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5b61ac1b19f0f26a31cfa147a9dd08e12b0f275", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a5b61ac1b19f0f26a31cfa147a9dd08e12b0f275", "committedDate": "2020-10-06T15:38:36Z", "message": "Refactor PR\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTA3NzY0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#pullrequestreview-503107764", "createdAt": "2020-10-06T15:43:55Z", "commit": {"oid": "a5b61ac1b19f0f26a31cfa147a9dd08e12b0f275"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTA4ODAy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#pullrequestreview-503108802", "createdAt": "2020-10-06T15:44:52Z", "commit": {"oid": "a5b61ac1b19f0f26a31cfa147a9dd08e12b0f275"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTI0MDYy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#pullrequestreview-503124062", "createdAt": "2020-10-06T16:00:16Z", "commit": {"oid": "a5b61ac1b19f0f26a31cfa147a9dd08e12b0f275"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3572, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}