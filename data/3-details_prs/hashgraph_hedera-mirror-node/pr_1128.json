{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzMTcyMDE5", "number": 1128, "title": "Rosetta: Cache operation types & statuses", "bodyText": "Detailed description:\n\nTypes and Statuses can be retrieved once because their tables are only updated in flyway migrations\nMemory cached on the first related query\n\nWhich issue(s) this PR fixes:\nFixes #None\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-10-14T07:27:41Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1128", "merged": true, "mergeCommit": {"oid": "85e1568f33e446c402fd91e532420a38468c7d68"}, "closed": true, "closedAt": "2020-10-15T15:16:13Z", "author": {"login": "failfmi"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSXwIwAH2gAyNTAzMTcyMDE5OjI1YjRjNmMyNGNmZDNlMDQ1Y2UzMTg5Yzc0Yjk3NzdlN2IxZGU5NWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSzGB6gFqTUwOTQ3NjgwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "25b4c6c24cfd3e045ce3189c74b9777e7b1de95c", "author": {"user": {"login": "failfmi", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/25b4c6c24cfd3e045ce3189c74b9777e7b1de95c", "committedDate": "2020-10-14T07:08:16Z", "message": "feat(hedera-mirror-rosetta): cache operation types & statuses\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NTA2Njcx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1128#pullrequestreview-508506671", "createdAt": "2020-10-14T16:06:35Z", "commit": {"oid": "25b4c6c24cfd3e045ce3189c74b9777e7b1de95c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNjowNjozNlrOHhagPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNjowNzo1NFrOHhaj0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5OTI5NA==", "bodyText": "map isn't thread safe. This should probably have some double checked locking pattern to ensure the map doesn't get corrupted if multiple threads write to it during initialization.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1128#discussion_r504799294", "createdAt": "2020-10-14T16:06:36Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rosetta/app/persistence/transaction/transaction.go", "diffHunk": "@@ -98,29 +100,49 @@ func NewTransactionRepository(dbClient *gorm.DB) *TransactionRepository {\n }\n \n // Types returns map of all Transaction Types\n-// TODO implement cache instead of retrieving this everytime form DB\n-func (tr *TransactionRepository) Types() map[int]string {\n+func (tr *TransactionRepository) Types() (map[int]string, *rTypes.Error) {\n+\tif tr.types != nil {\n+\t\treturn tr.types, nil\n+\t}\n+\n \ttypesArray := tr.retrieveTransactionTypes()\n-\ttMap := make(map[int]string)\n+\tif len(typesArray) == 0 {\n+\t\tlog.Println(\"No Transaction Types were found in the database.\")\n+\t\treturn nil, errors.Errors[errors.OperationTypesNotFound]\n+\t}\n+\n+\ttr.types = make(map[int]string)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25b4c6c24cfd3e045ce3189c74b9777e7b1de95c"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDgwMDIxMA==", "bodyText": "Same comment about thread safety", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1128#discussion_r504800210", "createdAt": "2020-10-14T16:07:54Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rosetta/app/persistence/transaction/transaction.go", "diffHunk": "@@ -98,29 +100,49 @@ func NewTransactionRepository(dbClient *gorm.DB) *TransactionRepository {\n }\n \n // Types returns map of all Transaction Types\n-// TODO implement cache instead of retrieving this everytime form DB\n-func (tr *TransactionRepository) Types() map[int]string {\n+func (tr *TransactionRepository) Types() (map[int]string, *rTypes.Error) {\n+\tif tr.types != nil {\n+\t\treturn tr.types, nil\n+\t}\n+\n \ttypesArray := tr.retrieveTransactionTypes()\n-\ttMap := make(map[int]string)\n+\tif len(typesArray) == 0 {\n+\t\tlog.Println(\"No Transaction Types were found in the database.\")\n+\t\treturn nil, errors.Errors[errors.OperationTypesNotFound]\n+\t}\n+\n+\ttr.types = make(map[int]string)\n \tfor _, t := range typesArray {\n-\t\ttMap[t.ProtoID] = t.Name\n+\t\ttr.types[t.ProtoID] = t.Name\n \t}\n-\treturn tMap\n+\treturn tr.types, nil\n }\n \n // Statuses returns map of all Transaction Results\n-// TODO implement cache instead of retrieving this everytime form DB\n-func (tr *TransactionRepository) Statuses() map[int]string {\n+func (tr *TransactionRepository) Statuses() (map[int]string, *rTypes.Error) {\n+\tif tr.statuses != nil {\n+\t\treturn tr.statuses, nil\n+\t}\n+\n \trArray := tr.retrieveTransactionResults()\n-\trMap := make(map[int]string)\n+\tif len(rArray) == 0 {\n+\t\tlog.Println(\"No Transaction Results were found in the database.\")\n+\t\treturn nil, errors.Errors[errors.OperationStatusesNotFound]\n+\t}\n+\n+\ttr.statuses = make(map[int]string)\n \tfor _, s := range rArray {\n-\t\trMap[s.ProtoID] = s.Result\n+\t\ttr.statuses[s.ProtoID] = s.Result", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25b4c6c24cfd3e045ce3189c74b9777e7b1de95c"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c57506f49a7df67d24e1679c08b0136f6e846f08", "author": {"user": {"login": "failfmi", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c57506f49a7df67d24e1679c08b0136f6e846f08", "committedDate": "2020-10-14T17:58:11Z", "message": "fix(hedera-mirror-rosetta): map -> sync.Map\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88c5e4ea67b1a0cf62ac97cee3ba540d950c06ac", "author": {"user": {"login": "failfmi", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/88c5e4ea67b1a0cf62ac97cee3ba540d950c06ac", "committedDate": "2020-10-14T18:25:38Z", "message": "fix(hedera-mirror-rosetta): initialize once, update if fetched\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjYwODc4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1128#pullrequestreview-508660878", "createdAt": "2020-10-14T19:27:37Z", "commit": {"oid": "88c5e4ea67b1a0cf62ac97cee3ba540d950c06ac"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjgxMTk2", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1128#pullrequestreview-508681196", "createdAt": "2020-10-14T19:56:04Z", "commit": {"oid": "88c5e4ea67b1a0cf62ac97cee3ba540d950c06ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxOTo1NjowNFrOHhi0wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxOTo1NjowNFrOHhi0wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkzNTYxNw==", "bodyText": "suggestion: it's better to use sync.Once to guarantee statues /  types is only retrieved once when the first time it's needed, then can just return a normal map since it's all read operations", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1128#discussion_r504935617", "createdAt": "2020-10-14T19:56:04Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rosetta/app/persistence/transaction/transaction.go", "diffHunk": "@@ -98,29 +103,51 @@ func NewTransactionRepository(dbClient *gorm.DB) *TransactionRepository {\n }\n \n // Types returns map of all Transaction Types\n-// TODO implement cache instead of retrieving this everytime form DB\n-func (tr *TransactionRepository) Types() map[int]string {\n+func (tr *TransactionRepository) Types() (*sync.Map, *rTypes.Error) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88c5e4ea67b1a0cf62ac97cee3ba540d950c06ac"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6a0b29395d3778de439b3e57e2368ad04af985e", "author": {"user": {"login": "failfmi", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d6a0b29395d3778de439b3e57e2368ad04af985e", "committedDate": "2020-10-15T06:53:22Z", "message": "fix(hedera-mirror-rosetta): sync.Map -> sync.Once with regular map\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "270b4d13d18f84d2911b023132848619fd5fde96", "author": {"user": {"login": "failfmi", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/270b4d13d18f84d2911b023132848619fd5fde96", "committedDate": "2020-10-15T07:30:47Z", "message": "refactor(hedera-mirror-rosetta): fetch -> retrieve\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6896fecbd09753ac9aa6d1c5d6abc4b5a76eba37", "author": {"user": {"login": "failfmi", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6896fecbd09753ac9aa6d1c5d6abc4b5a76eba37", "committedDate": "2020-10-15T07:39:48Z", "message": "fix(hedera-mirror-rosetta): wrong function call\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a2bcf34e8754efd6718b1b50469171fb0db3a1f", "author": {"user": {"login": "failfmi", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1a2bcf34e8754efd6718b1b50469171fb0db3a1f", "committedDate": "2020-10-15T07:42:50Z", "message": "fix(hedera-mirror-rosetta): panic message\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "695813ed88dba53449063bc723e046af2df48ee8", "author": {"user": {"login": "failfmi", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/695813ed88dba53449063bc723e046af2df48ee8", "committedDate": "2020-10-15T08:06:41Z", "message": "fix(hedera-mirror-rosetta): do only map init\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NDc2ODAz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1128#pullrequestreview-509476803", "createdAt": "2020-10-15T14:59:37Z", "commit": {"oid": "695813ed88dba53449063bc723e046af2df48ee8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3594, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}