{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5NjY1MjE3", "number": 969, "title": "State proof js demo", "bodyText": "Detailed description:\nTo facilitate the usage of state proof mirror node logic we want to provide standalone code for validating the state proof in Javascript.\nThis change\n\nAdds a node based CLI for state proof under the /state-proof-demo folder.\nAdds a startUp.js file that displays a welcome screen and retrieves user input of the desired transaction Id to validate\nAdds a stateProofHandler.js file that orchestrates the validation logic and performs the parsing of files\nAdds a recordFile.js responsible for parsing record file buffer content. From this it calculates the file hash and a map of transactionIds present\nAdds an addresBook.js responsible for parsing file buffer content. It pull out the nodes and public key info\nAdds a signatureFile.js  responsible for parsing file buffer content. It pulls out the signature and hash details from the files.\nAdds a transactionsValidator.js that performs the validation logic for public keys and signatures, consensus of hashes and matching of hashes.\nAdds support for sample API response to test.\nAdds supports for multiple environments including local\nAdds simple jest unit tests\n\nWhich issue(s) this PR fixes:\nFixes #866\nSpecial notes for your reviewer:\n-Need to verify case of multiple address books\n\nJS SDK doesn't have support for reading HCS transactions from raw bytes currently. Opened a ticket (hashgraph/hedera-sdk-js#276) against them but right now this will only work on non HCS transactions\n\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-08-18T18:27:49Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969", "merged": true, "mergeCommit": {"oid": "2fe0a2708170b50032b479ee52d67bdd7b3d9c7a"}, "closed": true, "closedAt": "2020-08-24T18:37:02Z", "author": {"login": "Nana-EC"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-ubcqAH2gAyNDY5NjY1MjE3OjZiOGYwNWExYmFkYWE4ZThkODRmZjc1YTlhYjJlOTQ1YjAxYWU4OTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCG34UgFqTQ3Mzc1MjM0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6b8f05a1badaa8e8d84ff75a9ab2e945b01ae897", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6b8f05a1badaa8e8d84ff75a9ab2e945b01ae897", "committedDate": "2020-08-14T06:15:00Z", "message": "Initial scaffolding for StateProof CLI\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75f32ec62e5cfb7a361d0b6e4056d606b82a177a", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/75f32ec62e5cfb7a361d0b6e4056d606b82a177a", "committedDate": "2020-08-15T02:23:01Z", "message": "Added node-rsa for signature verification\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd0e93791fece764bd756570b1d23b27b9496256", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bd0e93791fece764bd756570b1d23b27b9496256", "committedDate": "2020-08-17T22:42:53Z", "message": "Added test framework, added record_file read logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e879e331b5968eaa1e964df96e14b0e390e4244", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2e879e331b5968eaa1e964df96e14b0e390e4244", "committedDate": "2020-08-18T18:19:01Z", "message": "Verified api call and record file parsing logic with some reorganization\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5a91993585b62f1203ec4fbdc6859d4fde116c8e", "committedDate": "2020-08-18T23:26:55Z", "message": "Cleaned up and fixed record hash digest logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMDgxMTcw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#pullrequestreview-470081170", "createdAt": "2020-08-19T02:25:17Z", "commit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMjoyNToxN1rOHCtQnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNDozMjoyNVrOHDKQzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYwMDczMg==", "bodyText": "for record file version 1, the hash is calculated on the whole file. The logic here will only hash format version + version + prev_hash marker + 48 byte prev hash for version 1.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r472600732", "createdAt": "2020-08-19T02:25:17Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/recordFile.js", "diffHunk": "@@ -0,0 +1,153 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+'uses strict';\n+\n+// recordFile object. Read buffer, parse file, potentially stores all transactionConsensusNs as keys, hash\n+// file_hash, consensus_start, consensus_end\n+// parse rcd file looking for transaction with matching consensus time stamp from transaction id\n+\n+// external libraries\n+const _ = require('lodash');\n+var crypto = require('crypto');\n+const {Transaction} = require('@hashgraph/sdk/lib/Transaction');\n+const {replaceSpecialCharsWithUnderScores} = require('./utils');\n+\n+class recordFile {\n+  constructor(recordFileBuffer, transactionId) {\n+    this.readRecordFile(recordFileBuffer, transactionId);\n+  }\n+\n+  readRecordFile(recordFileBuffer) {\n+    let recordFileHash = crypto.createHash('sha384');\n+    let recordFileContentsHash = crypto.createHash('sha384');\n+\n+    // read record file format version\n+    const recordFormatVersion = this.readIntFromBufferAndUpdateHash(recordFileBuffer, 0, recordFileHash);\n+    if (recordFormatVersion < 0 || recordFormatVersion > 3) {\n+      throw new Error(`Unexpected record file format version '${recordFormatVersion}'`);\n+    }\n+\n+    // version\n+    this.readIntFromBufferAndUpdateHash(recordFileBuffer, 4, recordFileHash);\n+\n+    const fileHashSize = 48; // number of bytes\n+    let index = 8;\n+\n+    this.transactionIdMap = {};\n+    while (index < recordFileBuffer.length - 1) {\n+      if (index < 0) {\n+        // reached end\n+        break;\n+      }\n+\n+      const typeDelimiter = recordFileBuffer[index++];\n+\n+      switch (typeDelimiter) {\n+        case 1:\n+          // RECORD_TYPE_PREV_HASH\n+          recordFileHash.update(Buffer.from([typeDelimiter]));\n+          this.prevHash = this.readBytesFromBufferAndUpdateHash(\n+            recordFileBuffer,\n+            index,\n+            index + fileHashSize,\n+            recordFileHash\n+          );\n+          index = index + fileHashSize;\n+          break;\n+        case 2:\n+          // RECORD_TYPE_RECORD\n+          recordFileContentsHash.update(Buffer.from([typeDelimiter]));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYwMTM3NA==", "bodyText": "Q: do we have record file version 3?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r472601374", "createdAt": "2020-08-19T02:26:18Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/recordFile.js", "diffHunk": "@@ -0,0 +1,153 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+'uses strict';\n+\n+// recordFile object. Read buffer, parse file, potentially stores all transactionConsensusNs as keys, hash\n+// file_hash, consensus_start, consensus_end\n+// parse rcd file looking for transaction with matching consensus time stamp from transaction id\n+\n+// external libraries\n+const _ = require('lodash');\n+var crypto = require('crypto');\n+const {Transaction} = require('@hashgraph/sdk/lib/Transaction');\n+const {replaceSpecialCharsWithUnderScores} = require('./utils');\n+\n+class recordFile {\n+  constructor(recordFileBuffer, transactionId) {\n+    this.readRecordFile(recordFileBuffer, transactionId);\n+  }\n+\n+  readRecordFile(recordFileBuffer) {\n+    let recordFileHash = crypto.createHash('sha384');\n+    let recordFileContentsHash = crypto.createHash('sha384');\n+\n+    // read record file format version\n+    const recordFormatVersion = this.readIntFromBufferAndUpdateHash(recordFileBuffer, 0, recordFileHash);\n+    if (recordFormatVersion < 0 || recordFormatVersion > 3) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYwMTc0NQ==", "bodyText": "nit: comment should be removed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r472601745", "createdAt": "2020-08-19T02:26:52Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/recordFile.js", "diffHunk": "@@ -0,0 +1,153 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+'uses strict';\n+\n+// recordFile object. Read buffer, parse file, potentially stores all transactionConsensusNs as keys, hash\n+// file_hash, consensus_start, consensus_end\n+// parse rcd file looking for transaction with matching consensus time stamp from transaction id\n+\n+// external libraries\n+const _ = require('lodash');\n+var crypto = require('crypto');\n+const {Transaction} = require('@hashgraph/sdk/lib/Transaction');\n+const {replaceSpecialCharsWithUnderScores} = require('./utils');\n+\n+class recordFile {\n+  constructor(recordFileBuffer, transactionId) {\n+    this.readRecordFile(recordFileBuffer, transactionId);\n+  }\n+\n+  readRecordFile(recordFileBuffer) {\n+    let recordFileHash = crypto.createHash('sha384');\n+    let recordFileContentsHash = crypto.createHash('sha384');\n+\n+    // read record file format version\n+    const recordFormatVersion = this.readIntFromBufferAndUpdateHash(recordFileBuffer, 0, recordFileHash);\n+    if (recordFormatVersion < 0 || recordFormatVersion > 3) {\n+      throw new Error(`Unexpected record file format version '${recordFormatVersion}'`);\n+    }\n+\n+    // version\n+    this.readIntFromBufferAndUpdateHash(recordFileBuffer, 4, recordFileHash);\n+\n+    const fileHashSize = 48; // number of bytes\n+    let index = 8;\n+\n+    this.transactionIdMap = {};\n+    while (index < recordFileBuffer.length - 1) {\n+      if (index < 0) {\n+        // reached end\n+        break;\n+      }\n+\n+      const typeDelimiter = recordFileBuffer[index++];\n+\n+      switch (typeDelimiter) {\n+        case 1:\n+          // RECORD_TYPE_PREV_HASH\n+          recordFileHash.update(Buffer.from([typeDelimiter]));\n+          this.prevHash = this.readBytesFromBufferAndUpdateHash(\n+            recordFileBuffer,\n+            index,\n+            index + fileHashSize,\n+            recordFileHash\n+          );\n+          index = index + fileHashSize;\n+          break;\n+        case 2:\n+          // RECORD_TYPE_RECORD\n+          recordFileContentsHash.update(Buffer.from([typeDelimiter]));\n+\n+          // transaction raw bytes\n+          let buf = recordFileBuffer.subarray(index, index + 4);\n+          recordFileContentsHash.update(buf);\n+          const transactionRawBytesLength = buf.readInt32BE(0);\n+          index = index + 4;\n+\n+          const transactionRawBuffer = this.readBytesFromBufferAndUpdateHash(\n+            recordFileBuffer,\n+            index,\n+            index + transactionRawBytesLength,\n+            recordFileContentsHash\n+          );\n+          index = index + transactionRawBytesLength;\n+\n+          // record raw bytes\n+          buf = recordFileBuffer.subarray(index, index + 4);\n+          recordFileContentsHash.update(buf);\n+          const recordRawBytesLength = buf.readInt32BE(0);\n+          index = index + 4;\n+\n+          // recordRawBuffer\n+          this.readBytesFromBufferAndUpdateHash(\n+            recordFileBuffer,\n+            index,\n+            index + recordRawBytesLength,\n+            recordFileContentsHash\n+          );\n+          index = index + recordRawBytesLength;\n+\n+          const transaction = Transaction.fromBytes(transactionRawBuffer);\n+          const transactionIdBody = transaction.id;\n+\n+          this.transactionIdMap[replaceSpecialCharsWithUnderScores(transactionIdBody.toString())] = transactionIdBody;\n+\n+          break;\n+        default:\n+          throw new Error(`Unexpected type delimiter '${typeDelimiter}' in record file at index '${index - 1}'`);\n+      }\n+    }\n+\n+    if (recordFormatVersion === 2) {\n+      recordFileHash.update(recordFileContentsHash.digest());\n+    }\n+\n+    // set recordFile hash\n+    // recordFileHash.digest(\"hex\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYxMjg4NA==", "bodyText": "while (index < recordFileBuffer.length) {\n\nAlso index won't < 0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r472612884", "createdAt": "2020-08-19T02:44:16Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/recordFile.js", "diffHunk": "@@ -0,0 +1,153 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+'uses strict';\n+\n+// recordFile object. Read buffer, parse file, potentially stores all transactionConsensusNs as keys, hash\n+// file_hash, consensus_start, consensus_end\n+// parse rcd file looking for transaction with matching consensus time stamp from transaction id\n+\n+// external libraries\n+const _ = require('lodash');\n+var crypto = require('crypto');\n+const {Transaction} = require('@hashgraph/sdk/lib/Transaction');\n+const {replaceSpecialCharsWithUnderScores} = require('./utils');\n+\n+class recordFile {\n+  constructor(recordFileBuffer, transactionId) {\n+    this.readRecordFile(recordFileBuffer, transactionId);\n+  }\n+\n+  readRecordFile(recordFileBuffer) {\n+    let recordFileHash = crypto.createHash('sha384');\n+    let recordFileContentsHash = crypto.createHash('sha384');\n+\n+    // read record file format version\n+    const recordFormatVersion = this.readIntFromBufferAndUpdateHash(recordFileBuffer, 0, recordFileHash);\n+    if (recordFormatVersion < 0 || recordFormatVersion > 3) {\n+      throw new Error(`Unexpected record file format version '${recordFormatVersion}'`);\n+    }\n+\n+    // version\n+    this.readIntFromBufferAndUpdateHash(recordFileBuffer, 4, recordFileHash);\n+\n+    const fileHashSize = 48; // number of bytes\n+    let index = 8;\n+\n+    this.transactionIdMap = {};\n+    while (index < recordFileBuffer.length - 1) {\n+      if (index < 0) {\n+        // reached end\n+        break;\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYxMzYzNg==", "bodyText": "readIntFromBufferAndUpdateHash", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r472613636", "createdAt": "2020-08-19T02:45:20Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/recordFile.js", "diffHunk": "@@ -0,0 +1,153 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+'uses strict';\n+\n+// recordFile object. Read buffer, parse file, potentially stores all transactionConsensusNs as keys, hash\n+// file_hash, consensus_start, consensus_end\n+// parse rcd file looking for transaction with matching consensus time stamp from transaction id\n+\n+// external libraries\n+const _ = require('lodash');\n+var crypto = require('crypto');\n+const {Transaction} = require('@hashgraph/sdk/lib/Transaction');\n+const {replaceSpecialCharsWithUnderScores} = require('./utils');\n+\n+class recordFile {\n+  constructor(recordFileBuffer, transactionId) {\n+    this.readRecordFile(recordFileBuffer, transactionId);\n+  }\n+\n+  readRecordFile(recordFileBuffer) {\n+    let recordFileHash = crypto.createHash('sha384');\n+    let recordFileContentsHash = crypto.createHash('sha384');\n+\n+    // read record file format version\n+    const recordFormatVersion = this.readIntFromBufferAndUpdateHash(recordFileBuffer, 0, recordFileHash);\n+    if (recordFormatVersion < 0 || recordFormatVersion > 3) {\n+      throw new Error(`Unexpected record file format version '${recordFormatVersion}'`);\n+    }\n+\n+    // version\n+    this.readIntFromBufferAndUpdateHash(recordFileBuffer, 4, recordFileHash);\n+\n+    const fileHashSize = 48; // number of bytes\n+    let index = 8;\n+\n+    this.transactionIdMap = {};\n+    while (index < recordFileBuffer.length - 1) {\n+      if (index < 0) {\n+        // reached end\n+        break;\n+      }\n+\n+      const typeDelimiter = recordFileBuffer[index++];\n+\n+      switch (typeDelimiter) {\n+        case 1:\n+          // RECORD_TYPE_PREV_HASH\n+          recordFileHash.update(Buffer.from([typeDelimiter]));\n+          this.prevHash = this.readBytesFromBufferAndUpdateHash(\n+            recordFileBuffer,\n+            index,\n+            index + fileHashSize,\n+            recordFileHash\n+          );\n+          index = index + fileHashSize;\n+          break;\n+        case 2:\n+          // RECORD_TYPE_RECORD\n+          recordFileContentsHash.update(Buffer.from([typeDelimiter]));\n+\n+          // transaction raw bytes\n+          let buf = recordFileBuffer.subarray(index, index + 4);\n+          recordFileContentsHash.update(buf);\n+          const transactionRawBytesLength = buf.readInt32BE(0);\n+          index = index + 4;\n+\n+          const transactionRawBuffer = this.readBytesFromBufferAndUpdateHash(\n+            recordFileBuffer,\n+            index,\n+            index + transactionRawBytesLength,\n+            recordFileContentsHash\n+          );\n+          index = index + transactionRawBytesLength;\n+\n+          // record raw bytes\n+          buf = recordFileBuffer.subarray(index, index + 4);\n+          recordFileContentsHash.update(buf);\n+          const recordRawBytesLength = buf.readInt32BE(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYxNzUwMw==", "bodyText": "same as recordFile.js", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r472617503", "createdAt": "2020-08-19T02:51:29Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/signatureFile.js", "diffHunk": "@@ -0,0 +1,65 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'uses strict';\n+\n+// parse signature file, retrieve hash and node id\n+\n+// external libraries\n+class signatureFile {\n+  constructor(signatureFileString, nodeid) {\n+    this.setHashAndSignature(signatureFileString);\n+    this.nodeId = nodeid;\n+  }\n+\n+  // Extract the Hash and signature from the file.\n+  setHashAndSignature(signatureFileBuffer) {\n+    const fileHashSize = 48; // number of bytes\n+    let index = 0;\n+    while (index < signatureFileBuffer.length - 1) {\n+      if (index < 0) {\n+        // reached end\n+        break;\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYxOTk5Ng==", "bodyText": "nit: better rename signatureFileString to signatureFileBuffer", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r472619996", "createdAt": "2020-08-19T02:55:14Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/signatureFile.js", "diffHunk": "@@ -0,0 +1,65 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'uses strict';\n+\n+// parse signature file, retrieve hash and node id\n+\n+// external libraries\n+class signatureFile {\n+  constructor(signatureFileString, nodeid) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYyODQzNA==", "bodyText": "readIntFromBufferAndUpdateHash", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r472628434", "createdAt": "2020-08-19T03:08:43Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/recordFile.js", "diffHunk": "@@ -0,0 +1,153 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+'uses strict';\n+\n+// recordFile object. Read buffer, parse file, potentially stores all transactionConsensusNs as keys, hash\n+// file_hash, consensus_start, consensus_end\n+// parse rcd file looking for transaction with matching consensus time stamp from transaction id\n+\n+// external libraries\n+const _ = require('lodash');\n+var crypto = require('crypto');\n+const {Transaction} = require('@hashgraph/sdk/lib/Transaction');\n+const {replaceSpecialCharsWithUnderScores} = require('./utils');\n+\n+class recordFile {\n+  constructor(recordFileBuffer, transactionId) {\n+    this.readRecordFile(recordFileBuffer, transactionId);\n+  }\n+\n+  readRecordFile(recordFileBuffer) {\n+    let recordFileHash = crypto.createHash('sha384');\n+    let recordFileContentsHash = crypto.createHash('sha384');\n+\n+    // read record file format version\n+    const recordFormatVersion = this.readIntFromBufferAndUpdateHash(recordFileBuffer, 0, recordFileHash);\n+    if (recordFormatVersion < 0 || recordFormatVersion > 3) {\n+      throw new Error(`Unexpected record file format version '${recordFormatVersion}'`);\n+    }\n+\n+    // version\n+    this.readIntFromBufferAndUpdateHash(recordFileBuffer, 4, recordFileHash);\n+\n+    const fileHashSize = 48; // number of bytes\n+    let index = 8;\n+\n+    this.transactionIdMap = {};\n+    while (index < recordFileBuffer.length - 1) {\n+      if (index < 0) {\n+        // reached end\n+        break;\n+      }\n+\n+      const typeDelimiter = recordFileBuffer[index++];\n+\n+      switch (typeDelimiter) {\n+        case 1:\n+          // RECORD_TYPE_PREV_HASH\n+          recordFileHash.update(Buffer.from([typeDelimiter]));\n+          this.prevHash = this.readBytesFromBufferAndUpdateHash(\n+            recordFileBuffer,\n+            index,\n+            index + fileHashSize,\n+            recordFileHash\n+          );\n+          index = index + fileHashSize;\n+          break;\n+        case 2:\n+          // RECORD_TYPE_RECORD\n+          recordFileContentsHash.update(Buffer.from([typeDelimiter]));\n+\n+          // transaction raw bytes\n+          let buf = recordFileBuffer.subarray(index, index + 4);\n+          recordFileContentsHash.update(buf);\n+          const transactionRawBytesLength = buf.readInt32BE(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYzMjQ1Mg==", "bodyText": "we should also parse the the TransactionRecord and store the transaction + transaction record pair. The status in the receipt in transaction record tells whether the corresponding transaction is successful or not.\nThe stateproof alpha rest API only provides proof  for successfully transactions. My understanding is it's possible in the same record file, we have one successful transaction and 0-N duplicate transactions, all with the same transaction id.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r472632452", "createdAt": "2020-08-19T03:15:08Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/recordFile.js", "diffHunk": "@@ -0,0 +1,153 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+'uses strict';\n+\n+// recordFile object. Read buffer, parse file, potentially stores all transactionConsensusNs as keys, hash\n+// file_hash, consensus_start, consensus_end\n+// parse rcd file looking for transaction with matching consensus time stamp from transaction id\n+\n+// external libraries\n+const _ = require('lodash');\n+var crypto = require('crypto');\n+const {Transaction} = require('@hashgraph/sdk/lib/Transaction');\n+const {replaceSpecialCharsWithUnderScores} = require('./utils');\n+\n+class recordFile {\n+  constructor(recordFileBuffer, transactionId) {\n+    this.readRecordFile(recordFileBuffer, transactionId);\n+  }\n+\n+  readRecordFile(recordFileBuffer) {\n+    let recordFileHash = crypto.createHash('sha384');\n+    let recordFileContentsHash = crypto.createHash('sha384');\n+\n+    // read record file format version\n+    const recordFormatVersion = this.readIntFromBufferAndUpdateHash(recordFileBuffer, 0, recordFileHash);\n+    if (recordFormatVersion < 0 || recordFormatVersion > 3) {\n+      throw new Error(`Unexpected record file format version '${recordFormatVersion}'`);\n+    }\n+\n+    // version\n+    this.readIntFromBufferAndUpdateHash(recordFileBuffer, 4, recordFileHash);\n+\n+    const fileHashSize = 48; // number of bytes\n+    let index = 8;\n+\n+    this.transactionIdMap = {};\n+    while (index < recordFileBuffer.length - 1) {\n+      if (index < 0) {\n+        // reached end\n+        break;\n+      }\n+\n+      const typeDelimiter = recordFileBuffer[index++];\n+\n+      switch (typeDelimiter) {\n+        case 1:\n+          // RECORD_TYPE_PREV_HASH\n+          recordFileHash.update(Buffer.from([typeDelimiter]));\n+          this.prevHash = this.readBytesFromBufferAndUpdateHash(\n+            recordFileBuffer,\n+            index,\n+            index + fileHashSize,\n+            recordFileHash\n+          );\n+          index = index + fileHashSize;\n+          break;\n+        case 2:\n+          // RECORD_TYPE_RECORD\n+          recordFileContentsHash.update(Buffer.from([typeDelimiter]));\n+\n+          // transaction raw bytes\n+          let buf = recordFileBuffer.subarray(index, index + 4);\n+          recordFileContentsHash.update(buf);\n+          const transactionRawBytesLength = buf.readInt32BE(0);\n+          index = index + 4;\n+\n+          const transactionRawBuffer = this.readBytesFromBufferAndUpdateHash(\n+            recordFileBuffer,\n+            index,\n+            index + transactionRawBytesLength,\n+            recordFileContentsHash\n+          );\n+          index = index + transactionRawBytesLength;\n+\n+          // record raw bytes\n+          buf = recordFileBuffer.subarray(index, index + 4);\n+          recordFileContentsHash.update(buf);\n+          const recordRawBytesLength = buf.readInt32BE(0);\n+          index = index + 4;\n+\n+          // recordRawBuffer\n+          this.readBytesFromBufferAndUpdateHash(\n+            recordFileBuffer,\n+            index,\n+            index + recordRawBytesLength,\n+            recordFileContentsHash\n+          );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY1NDU1NQ==", "bodyText": "verifyRSASignature is not used, so the dependency node-rsa should also be removed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r472654555", "createdAt": "2020-08-19T03:51:25Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/transactionValidator.js", "diffHunk": "@@ -0,0 +1,128 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'uses strict';\n+\n+// responsible for validating files. Call object methods for certain operations\n+\n+// external libraries\n+const _ = require('lodash');\n+const NodeRSA = require('node-rsa');\n+const crypto = require('crypto');\n+\n+/**\n+ * For signature files with the same file name:\n+ * (1) verify that the signature files are signed by corresponding node's PublicKey provided by addressBook\n+ * (2) For valid signature files, we compare their Hashes to see if at least 1/3 of hashes match.\n+ * (3) We compare the hash of data file with Hash which has been agreed on by valid signatures,\n+ * if match return true otherwise false for stateProof\n+ */\n+\n+const performStateProof = (nodePublicKeyMap, signatureFilesMap, recordFileHash) => {\n+  let validated = false;\n+  const consensusValidatedHash = verifySignatures(nodePublicKeyMap, signatureFilesMap);\n+  if (_.isNull(consensusValidatedHash)) {\n+    console.error(`Unable to validate signature files!`);\n+    return validated;\n+  }\n+\n+  return validateRecordFileHash(recordFileHash, consensusValidatedHash);\n+};\n+\n+// given map of addressBook node -> public Key & map of signatureFiles node -> Signature can do verifySignature()\n+// for every signature from a file verify the signature against the appropriate public key form address book\n+// ensure # of validations match node count or at least is consensus by 1/3\n+const verifySignatures = (nodePublicKeyMap, signatureFilesMap) => {\n+  let validatedSignatureFilesMap = {};\n+  let consensusHashMap = {hash: null, count: 0};\n+  let maxHashCount = 0;\n+\n+  // create a map of hash -> nodeId to show alignment\n+  _.forEach(signatureFilesMap, (sigMapItem) => {\n+    console.info(`Verify signatures passed for node ${sigMapItem.nodeId}`);\n+    const publicKeyBuffer = nodePublicKeyMap[sigMapItem.nodeId].publicKey;\n+    const sigMapItemHashHex = sigMapItem.hash.toString('hex');\n+    if (verifySignature(publicKeyBuffer, sigMapItem.hash, sigMapItem.signature)) {\n+      if (_.isEmpty(validatedSignatureFilesMap[sigMapItemHashHex])) {\n+        validatedSignatureFilesMap[sigMapItemHashHex] = [sigMapItem.nodeId];\n+      } else {\n+        validatedSignatureFilesMap[sigMapItemHashHex].push(sigMapItem.nodeId);\n+        let nodeCount = validatedSignatureFilesMap[sigMapItemHashHex].length;\n+\n+        // determine max. Sufficient to do here as you'd never want the max to occur in the if where the count would be 1\n+        if (nodeCount > maxHashCount) {\n+          maxHashCount = nodeCount;\n+          consensusHashMap.hash = sigMapItemHashHex;\n+          consensusHashMap.count = maxHashCount;\n+        }\n+      }\n+    } else {\n+      console.error(`Failed to verify signatures for node ${sigMapItem.nodeId}!`);\n+    }\n+  });\n+\n+  // return hash if it was observed by a super majority\n+  return maxHashCount >= Math.ceil(signatureFilesMap.length / 3.0) ? consensusHashMap.hash : null;\n+};\n+\n+//compare the hash of data file with Hash which has been agreed on by valid signatures\n+const validateRecordFileHash = (recordFileHash, consensusValidatedHash) => {\n+  let valid = true;\n+\n+  if (recordFileHash !== consensusValidatedHash) {\n+    valid = false;\n+    console.error(\n+      `Hash mismatch between recordFileHash: ${recordFileHash} and consensus validated signature files hash: ${consensusValidatedHash}!`\n+    );\n+  }\n+\n+  return valid;\n+};\n+\n+const verifyRSASignature = (hexEncodedPublicKey, hash, signature) => {\n+  let key = new NodeRSA();\n+  key.importKey(\n+    {\n+      n: Buffer.from(hexEncodedPublicKey, 'hex'),\n+      e: 65537, // public exponent. 65537 by default.\n+    },\n+    'components-public'\n+  );\n+\n+  return key.verify(hash, signature, 'buffer', 'buffer');\n+};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY1ODMxMg==", "bodyText": "nit: return stringToFormat.replace(/[.@\\-]/g, '_');", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r472658312", "createdAt": "2020-08-19T03:57:30Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/utils.js", "diffHunk": "@@ -0,0 +1,100 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'uses strict';\n+\n+// external libraries\n+const fs = require('fs');\n+const fetch = require('node-fetch');\n+const AbortController = require('abort-controller');\n+\n+const base64StringToBuffer = (base64String) => {\n+  return Buffer.from(base64String, 'base64');\n+};\n+\n+const replaceSpecialCharsWithUnderScores = (stringToFormat) => {\n+  return stringToFormat.replace(/\\./g, '_').replace(/\\@/g, '_').replace(/\\-/g, '_');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2NjYyNg==", "bodyText": "nit: validated is always false, can eliminate the variable and just return false", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r472666626", "createdAt": "2020-08-19T04:11:07Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/transactionValidator.js", "diffHunk": "@@ -0,0 +1,128 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'uses strict';\n+\n+// responsible for validating files. Call object methods for certain operations\n+\n+// external libraries\n+const _ = require('lodash');\n+const NodeRSA = require('node-rsa');\n+const crypto = require('crypto');\n+\n+/**\n+ * For signature files with the same file name:\n+ * (1) verify that the signature files are signed by corresponding node's PublicKey provided by addressBook\n+ * (2) For valid signature files, we compare their Hashes to see if at least 1/3 of hashes match.\n+ * (3) We compare the hash of data file with Hash which has been agreed on by valid signatures,\n+ * if match return true otherwise false for stateProof\n+ */\n+\n+const performStateProof = (nodePublicKeyMap, signatureFilesMap, recordFileHash) => {\n+  let validated = false;\n+  const consensusValidatedHash = verifySignatures(nodePublicKeyMap, signatureFilesMap);\n+  if (_.isNull(consensusValidatedHash)) {\n+    console.error(`Unable to validate signature files!`);\n+    return validated;\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2ODM2Ng==", "bodyText": "unrelated comment", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r472668366", "createdAt": "2020-08-19T04:14:00Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/tests/record.test.js", "diffHunk": "@@ -0,0 +1,32 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const {recordFile} = require('../recordFile');\n+const {base64StringToBuffer, readJSONFile} = require('../utils');\n+\n+const stateProofJson = readJSONFile('stateProofSample.json');\n+\n+test('signatureFile test', () => {\n+  // const signatureBase64 = \"BEldxQ1jI9TVJj002+/nwgoGV6L6X+DYwBGgH0ondXolmYfa0hD7lZa8WozH+9u6MwMAAAGAW368fmoJsZme3vwzERrctK60l4EJscbU2Z06DjEaSaE1kkngE9PQdMs0roNfE/eniwVNzRbASlEfqZM/SccYiZSBkIzFOarfWDV5aP2F8+xwdJ0Idklw+ezH/Zyz6GEZsDxViQ6pMqVj1r40lcbVCyKbxUK2gKX/OsDOkyobTHtICRbiMKgcUESrfuG5EK1fskVOqLB27dHJX5AmjxGp9CAJfQD85heMxVNkHe73F2xwVSTA33NHw8YU59svk952Q1QyGb7iCGLjJSQDvdChZC/5Ikl7RLYwnCKYJHhVyRWeQ8aH+miKnnPGqkTjpKJNW+WXU6UI6r0r55VlwScqPLonjzgRy0x7b8fhBPPa9M+fq8aCOwacuAymD29uTY6/6NVwSFt8zhc53HPUZmt5vTpUtwOJhFaWk2KJ3buWQDmr7+sCSV7Lj5qCl2sQ3QmuIfDhRpNDsd3Xuvjk9K4f9SAKwAkyFhhbp79cRKC8g4ZIwejiGMTXW3dOnv0CcKTv\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2ODU3Mg==", "bodyText": "test name mismatch", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r472668572", "createdAt": "2020-08-19T04:14:21Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/tests/record.test.js", "diffHunk": "@@ -0,0 +1,32 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const {recordFile} = require('../recordFile');\n+const {base64StringToBuffer, readJSONFile} = require('../utils');\n+\n+const stateProofJson = readJSONFile('stateProofSample.json');\n+\n+test('signatureFile test', () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY3MDMzOA==", "bodyText": "recordFile should not have a transactionId param", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r472670338", "createdAt": "2020-08-19T04:17:04Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/recordFile.js", "diffHunk": "@@ -0,0 +1,153 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+'uses strict';\n+\n+// recordFile object. Read buffer, parse file, potentially stores all transactionConsensusNs as keys, hash\n+// file_hash, consensus_start, consensus_end\n+// parse rcd file looking for transaction with matching consensus time stamp from transaction id\n+\n+// external libraries\n+const _ = require('lodash');\n+var crypto = require('crypto');\n+const {Transaction} = require('@hashgraph/sdk/lib/Transaction');\n+const {replaceSpecialCharsWithUnderScores} = require('./utils');\n+\n+class recordFile {\n+  constructor(recordFileBuffer, transactionId) {\n+    this.readRecordFile(recordFileBuffer, transactionId);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY3MTA1MQ==", "bodyText": "rename to recordFile.test.js to match source file?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r472671051", "createdAt": "2020-08-19T04:18:12Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/tests/record.test.js", "diffHunk": "@@ -0,0 +1,32 @@\n+/*-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY3MTMzMQ==", "bodyText": "better remove the comment", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r472671331", "createdAt": "2020-08-19T04:18:40Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/tests/signatureFile.test.js", "diffHunk": "@@ -0,0 +1,33 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const {signatureFile} = require('../signatureFile');\n+const {base64StringToBuffer, readJSONFile} = require('../utils');\n+\n+const stateProofJson = readJSONFile('stateProofSample.json');\n+\n+test('signatureFile test', () => {\n+  // const signatureBase64 = \"BEldxQ1jI9TVJj002+/nwgoGV6L6X+DYwBGgH0ondXolmYfa0hD7lZa8WozH+9u6MwMAAAGAW368fmoJsZme3vwzERrctK60l4EJscbU2Z06DjEaSaE1kkngE9PQdMs0roNfE/eniwVNzRbASlEfqZM/SccYiZSBkIzFOarfWDV5aP2F8+xwdJ0Idklw+ezH/Zyz6GEZsDxViQ6pMqVj1r40lcbVCyKbxUK2gKX/OsDOkyobTHtICRbiMKgcUESrfuG5EK1fskVOqLB27dHJX5AmjxGp9CAJfQD85heMxVNkHe73F2xwVSTA33NHw8YU59svk952Q1QyGb7iCGLjJSQDvdChZC/5Ikl7RLYwnCKYJHhVyRWeQ8aH+miKnnPGqkTjpKJNW+WXU6UI6r0r55VlwScqPLonjzgRy0x7b8fhBPPa9M+fq8aCOwacuAymD29uTY6/6NVwSFt8zhc53HPUZmt5vTpUtwOJhFaWk2KJ3buWQDmr7+sCSV7Lj5qCl2sQ3QmuIfDhRpNDsd3Xuvjk9K4f9SAKwAkyFhhbp79cRKC8g4ZIwejiGMTXW3dOnv0CcKTv\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA3NTY5NQ==", "bodyText": "prefer to capitalize constructors", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r473075695", "createdAt": "2020-08-19T14:32:07Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/addressBook.js", "diffHunk": "@@ -0,0 +1,54 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+'uses strict';\n+\n+// addressBook object. Parse string to object, provide methods to pull info\n+\n+// external libraries\n+const _ = require('lodash');\n+const {NodeAddressBook} = require('@hashgraph/sdk/lib/generated/BasicTypes_pb');\n+\n+class addressBook {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA3NTkxOQ==", "bodyText": "nodeAddress.getNodeid() === 0\nsuggestion, you can configure idea to apply the eslint configuration I added in the hedera-mirror-rest folder,\nPreferences -> Languages & Frameworks -> Javascript -> Code Quality Tools -> Eslint, set to Automatic Eslint configuration. Then idea will highlight common lint issues.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r473075919", "createdAt": "2020-08-19T14:32:25Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/addressBook.js", "diffHunk": "@@ -0,0 +1,54 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+'uses strict';\n+\n+// addressBook object. Parse string to object, provide methods to pull info\n+\n+// external libraries\n+const _ = require('lodash');\n+const {NodeAddressBook} = require('@hashgraph/sdk/lib/generated/BasicTypes_pb');\n+\n+class addressBook {\n+  constructor(buffer) {\n+    let addressBook = NodeAddressBook.deserializeBinary(buffer);\n+    console.log(`${addressBook.getNodeaddressList().length} node(s) found in address book`);\n+    this.nodeList = addressBook.getNodeaddressList();\n+    this.nodeIdPublicKeyPairs = {};\n+    this.setNodeIdPublicKeyPairs();\n+  }\n+\n+  setNodeIdPublicKeyPairs() {\n+    _.forEach(this.nodeList, (nodeAddress) => {\n+      let node;\n+      if (_.isUndefined(nodeAddress.getNodeid()) || nodeAddress.getNodeid() == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a91993585b62f1203ec4fbdc6859d4fde116c8e"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1563413d22e2ccb8c0edd364d46baa9443ac128e", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1563413d22e2ccb8c0edd364d46baa9443ac128e", "committedDate": "2020-08-19T21:43:50Z", "message": "Cleaned up and fixed transactions bytes reading\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84967f34c08fa16d300eaa961f8ad8dc9d155363", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/84967f34c08fa16d300eaa961f8ad8dc9d155363", "committedDate": "2020-08-19T22:47:20Z", "message": "Adeed logic to only map successful transactions\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17c30c04288c431fcdcb27398d5d1dac98878029", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/17c30c04288c431fcdcb27398d5d1dac98878029", "committedDate": "2020-08-21T16:01:16Z", "message": "Fixed up recordFileVersion logic and cleaned up a bit\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyODQ4NTY5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#pullrequestreview-472848569", "createdAt": "2020-08-21T22:24:13Z", "commit": {"oid": "17c30c04288c431fcdcb27398d5d1dac98878029"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQyMjoyNDoxM1rOHE_YLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQyMjo0OTozNlrOHE_w5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk5NDczMw==", "bodyText": "min number of signature files shouldn't be 3, right? it depends on how many nodes in the network.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r474994733", "createdAt": "2020-08-21T22:24:13Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/StateProof.md", "diffHunk": "@@ -0,0 +1,49 @@\n+# Hedera Mirror State Proof\n+\n+## State Proof Logic\n+The CLI takes the following steps to prove legitimacy of provided transaction ID\n+\n+Step 1: Obtains user input of transactionId and other params\n+\n+Step 2: Makes a REST API call to the mirror node to retrieve stateproof supporting files - addressBook(s), signature files and a record file.\n+\n+Step 3 : Store files locally and verifies at least 1 addressBook, 3 signatures, 1 rcd file were retrieved.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17c30c04288c431fcdcb27398d5d1dac98878029"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAwMTA2MQ==", "bodyText": "the sample command line has the wrong transaction ID, thus verification result is false. should use 0.0.94139-1570800748-313194300", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#discussion_r475001061", "createdAt": "2020-08-21T22:49:36Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/state-proof-demo/StateProof.md", "diffHunk": "@@ -0,0 +1,49 @@\n+# Hedera Mirror State Proof\n+\n+## State Proof Logic\n+The CLI takes the following steps to prove legitimacy of provided transaction ID\n+\n+Step 1: Obtains user input of transactionId and other params\n+\n+Step 2: Makes a REST API call to the mirror node to retrieve stateproof supporting files - addressBook(s), signature files and a record file.\n+\n+Step 3 : Store files locally and verifies at least 1 addressBook, 3 signatures, 1 rcd file were retrieved.\n+\n+Step 4: Parses AddressBook(s) pulling out and creating a map of nodeIds to public keys\n+\n+Step 5: Parses signature file buffer pulling out signature and hash from each file\n+\n+Step 6: Parses record file pulling out file hash and a map of transactionsIds\n+\n+Step 7: Verified the record file contains the requested transactionId\n+\n+Step 8: Verifies the public keys of each node were used to sign the hashes noted in the signature files and produced the provided signatures.\n+\n+Step 9: Verifies there is a hash from the signatures files that is matched by at least 1/3 of the nodes.\n+\n+Step 10: Verified the record file hash matches the hash that reached 1/3 consensus from nodes.\n+\n+Step 11: Returns true if all  verifications pass\n+\n+## Installation\n+From `state-proof-demo/` run\n+\n+`npm install -g .`\n+\n+## Run\n+From command line run\n+\n+`state-proof -t <transactionId> -e <env> -sample <true|false>`\n+\n+### Sample Case\n+To verify the sample case run teh following command\n+\n+`state-proof -t 0.0.94139-11965562-313194 -e dev -sample true`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17c30c04288c431fcdcb27398d5d1dac98878029"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjE4NTk5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#pullrequestreview-473618599", "createdAt": "2020-08-24T15:35:05Z", "commit": {"oid": "17c30c04288c431fcdcb27398d5d1dac98878029"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b5514d0b105d1b5a8bf2219804187849389ad1f", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5b5514d0b105d1b5a8bf2219804187849389ad1f", "committedDate": "2020-08-24T17:55:18Z", "message": "Update number of file check logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae29fe7fe5cc7a40678fb7f7caf1d424f5442fb1", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ae29fe7fe5cc7a40678fb7f7caf1d424f5442fb1", "committedDate": "2020-08-24T18:19:51Z", "message": " Updated sample command in documentation\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNzUyMzQy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/969#pullrequestreview-473752342", "createdAt": "2020-08-24T18:25:33Z", "commit": {"oid": "ae29fe7fe5cc7a40678fb7f7caf1d424f5442fb1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3051, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}