{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1MzgxMDA3", "number": 797, "title": "Add Container Support for large db perf tests", "bodyText": "Detailed description:\nContinuous questions around db performance have mandated that the ability to spin up db's with large valid data sets be added.\nThis change seeks to add some underlying files that will assist eventually automating large db integration tests\nThis includes\n\n/restore-client Dockerfile for Postgres client that will download pgdump from a gcp bucket and issues a pg_restore to an already running docker container with a postgres mirror node database running\n/baseimage Dockerfile for an empty database for the mirror node with users to serve as a base image but also a clean start\n/seededimage Dockerfile for a populated database scenario that can take in the desired pgdump file name in a gcp bucket and the necessary service token file to authenticate. This container can be used to spin up the start of a large db test\nCustomPostgresContainer.java class that uses test container framework to build and run Dockerfiles noted above for use in tests\nSeededDbIntegrationTest.java class example tests to showcase how integration tests might connect to the large db instead of the default fresh container spun up\n\nWhich issue(s) this PR fixes:\nFixes #591\nSpecial notes for your reviewer:\n\n\npgdumps and streams for the 100k, 500k, 1M, 3M, 5M, 10M, 20M and 40M files were archived and can be utilized for the containers.\n\n\nExploring integration the restore client into the integration tests\n\n\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-05-30T00:04:36Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797", "merged": true, "mergeCommit": {"oid": "3244ac63c7d6f7c5f9510a08b774644f40318668"}, "closed": true, "closedAt": "2020-06-09T17:11:55Z", "author": {"login": "Nana-EC"}, "timelineItems": {"totalCount": 63, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnYBRDAH2gAyNDI1MzgxMDA3OjA4OWY4ZmJmNzI2ZTM5M2ViM2UwNWFkODgzODg1ZDI0MDJmODAwMDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpm2uwgFqTQyNzI4NjI5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "089f8fbf726e393eb3e05ad883885d2402f80003", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/089f8fbf726e393eb3e05ad883885d2402f80003", "committedDate": "2020-06-02T17:08:14Z", "message": "Added bucket file download and pg restore logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "895d1a52190d9d584ba3f28d87b7f7cee8129e30", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/895d1a52190d9d584ba3f28d87b7f7cee8129e30", "committedDate": "2020-06-02T17:08:14Z", "message": "Using ubuntu machine\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a493d2ba6853ab9894c754d1158d53af664e44cb", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a493d2ba6853ab9894c754d1158d53af664e44cb", "committedDate": "2020-06-02T17:08:14Z", "message": "use orb to allow gsutil\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4e8a84ac6c271f5a4eb0c49defe43a9b2e7d288", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c4e8a84ac6c271f5a4eb0c49defe43a9b2e7d288", "committedDate": "2020-06-02T17:08:14Z", "message": "removed orb\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae8af5bb2a5af4e47eb31580af0f11bba87e97c9", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ae8af5bb2a5af4e47eb31580af0f11bba87e97c9", "committedDate": "2020-06-02T17:08:14Z", "message": "remove docker images\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "caffd253778da8986177f1284f1f18b028a553d5", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/caffd253778da8986177f1284f1f18b028a553d5", "committedDate": "2020-06-02T17:08:14Z", "message": "Add Boto bug workaround\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "066a0d51c55e63ceeabea2421aa05c158d0d0cbb", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/066a0d51c55e63ceeabea2421aa05c158d0d0cbb", "committedDate": "2020-06-02T17:08:14Z", "message": "Add gcloud auth\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a31e882a7f9ddc6894e0e4977703cc634f0daa72", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a31e882a7f9ddc6894e0e4977703cc634f0daa72", "committedDate": "2020-06-02T17:08:14Z", "message": "CEntralized open jdk install\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e44da4d00c6dc595c1289f22cc22c01bbc4a14d", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1e44da4d00c6dc595c1289f22cc22c01bbc4a14d", "committedDate": "2020-06-02T17:08:14Z", "message": "Add postgres binaries\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9550cb6e4d537773bc149261da342ada477569f", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c9550cb6e4d537773bc149261da342ada477569f", "committedDate": "2020-06-02T17:08:14Z", "message": "Add crcmod download efficiency\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d1e39f4cf66d5d8d078cf29e9baf7f3339af60b", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4d1e39f4cf66d5d8d078cf29e9baf7f3339af60b", "committedDate": "2020-06-02T17:08:14Z", "message": "Fix crcmod install\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a012e6776e12083fccad22e41eea6987a99d8ea5", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a012e6776e12083fccad22e41eea6987a99d8ea5", "committedDate": "2020-06-02T17:08:14Z", "message": "See lib path\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d625a34bb146217c9248edb006d73248bea944cc", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d625a34bb146217c9248edb006d73248bea944cc", "committedDate": "2020-06-02T17:08:14Z", "message": "Install postgres\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91ac131432fe981680022f6c3fb735aedaa1f201", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/91ac131432fe981680022f6c3fb735aedaa1f201", "committedDate": "2020-06-02T17:08:14Z", "message": "Raw psql restore\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c01411e70350c118048bb12de6b3e1ba129bcf16", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c01411e70350c118048bb12de6b3e1ba129bcf16", "committedDate": "2020-06-02T17:08:14Z", "message": "Centralized gsutil and pg logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ec669ea441b12cf12b855b76d41223d20354bda", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0ec669ea441b12cf12b855b76d41223d20354bda", "committedDate": "2020-06-02T17:08:14Z", "message": "Reverted to docker images\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c27334fd09ea7f9787aeeca267f486353b93e7e", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8c27334fd09ea7f9787aeeca267f486353b93e7e", "committedDate": "2020-06-02T17:08:14Z", "message": "add gcloud install and auth\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "137939cfce66ac49d0fb17f0e99e88641fb92e8c", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/137939cfce66ac49d0fb17f0e99e88641fb92e8c", "committedDate": "2020-06-02T17:08:16Z", "message": "Added dbperf section to house docker images and scripts that can be utilized for various perf scenarios locally and in automation\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d47675574f6fbc6dd2df5c0dd3e2c1d536396684", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d47675574f6fbc6dd2df5c0dd3e2c1d536396684", "committedDate": "2020-06-02T17:08:16Z", "message": "Cleaned up circleciconfig\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4239e0041a318a038ccbfe1bd8a0ec3d3b66a824", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4239e0041a318a038ccbfe1bd8a0ec3d3b66a824", "committedDate": "2020-06-02T17:08:16Z", "message": "Cleaned restore client dockerfile\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2439b4b9f11f54f1e87f1e59862f53d345ea3abb", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2439b4b9f11f54f1e87f1e59862f53d345ea3abb", "committedDate": "2020-06-02T17:08:19Z", "message": "Use local docker file to create custom container for tests\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28e1e3cd076d16b87b177b2bfd8584c10923df98", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/28e1e3cd076d16b87b177b2bfd8584c10923df98", "committedDate": "2020-06-02T17:08:19Z", "message": "Cleaned up example tests\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6784992e67e0e2f8bcda5a8470750bf4dda2e8ba", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6784992e67e0e2f8bcda5a8470750bf4dda2e8ba", "committedDate": "2020-06-02T17:08:19Z", "message": "Disabled checkSeededTablesArePopulated\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "880b68e093c4b71f7b1332394ea244d7a4e881f4", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/880b68e093c4b71f7b1332394ea244d7a4e881f4", "committedDate": "2020-06-02T17:08:19Z", "message": "Added back restore client\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f002373c2653741ba83931d0c813f84c352670a9", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f002373c2653741ba83931d0c813f84c352670a9", "committedDate": "2020-06-02T17:08:19Z", "message": "Added restore client test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31d1e00269880ead10ac603777083faeae000e6f", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/31d1e00269880ead10ac603777083faeae000e6f", "committedDate": "2020-06-02T17:08:19Z", "message": "Fixed breaking build\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0c4a2c0c5dc6d248767ed37cc22f47e28c172b4", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a0c4a2c0c5dc6d248767ed37cc22f47e28c172b4", "committedDate": "2020-06-02T17:08:19Z", "message": "Add docker build for restore-client\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "138b026500f89ca1e194d7a10be126e2aa230e43", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/138b026500f89ca1e194d7a10be126e2aa230e43", "committedDate": "2020-06-02T17:08:19Z", "message": "Added bucket file download and pg restore logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "816bf0d249442636244c4fa29a132db9b37e4441", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/816bf0d249442636244c4fa29a132db9b37e4441", "committedDate": "2020-06-02T17:08:19Z", "message": "Using ubuntu machine\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9932bd1511c31a465d0ed776d97f0d0787075c6", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c9932bd1511c31a465d0ed776d97f0d0787075c6", "committedDate": "2020-06-02T17:08:19Z", "message": "use orb to allow gsutil\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6eac4edbf488bfe8aea9ea2a6f289424796a8bcb", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6eac4edbf488bfe8aea9ea2a6f289424796a8bcb", "committedDate": "2020-06-02T17:08:19Z", "message": "removed orb\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5d2c18191dc4f6b8c11759dc6ed7a0bb5208e2d", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d5d2c18191dc4f6b8c11759dc6ed7a0bb5208e2d", "committedDate": "2020-06-02T17:08:19Z", "message": "remove docker images\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d83fca439a358ade0be61d2a3e47698d428d694", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6d83fca439a358ade0be61d2a3e47698d428d694", "committedDate": "2020-06-02T17:08:19Z", "message": "Add Boto bug workaround\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "234dd5be8c5604fba138f7ddd4f3b840d8f18907", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/234dd5be8c5604fba138f7ddd4f3b840d8f18907", "committedDate": "2020-06-02T17:08:19Z", "message": "Add gcloud auth\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46799c69e88d8bf5a29a719a82c5a963be4b2563", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/46799c69e88d8bf5a29a719a82c5a963be4b2563", "committedDate": "2020-06-02T17:08:20Z", "message": "CEntralized open jdk install\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f48dc840a7b51b90f6ea57f54e4b1e815ab263d", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2f48dc840a7b51b90f6ea57f54e4b1e815ab263d", "committedDate": "2020-06-02T17:08:20Z", "message": "Add postgres binaries\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57cf020629a2f4d936ea9449b2df4b46e11e1be7", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/57cf020629a2f4d936ea9449b2df4b46e11e1be7", "committedDate": "2020-06-02T17:08:20Z", "message": "Add crcmod download efficiency\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61adf3561a4da1d1ef6e2bd5afcb150eb69ba28f", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/61adf3561a4da1d1ef6e2bd5afcb150eb69ba28f", "committedDate": "2020-06-02T17:08:20Z", "message": "Fix crcmod install\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb62b60a1c7488d5167f1ca6a3326284eabd5ea8", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/fb62b60a1c7488d5167f1ca6a3326284eabd5ea8", "committedDate": "2020-06-02T17:08:20Z", "message": "See lib path\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2e45a9e13bb75c7a88a07c255f99ad78b7b3147", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c2e45a9e13bb75c7a88a07c255f99ad78b7b3147", "committedDate": "2020-06-02T17:08:20Z", "message": "Install postgres\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef22d5812f2d77acfaea9c16e3aa0d52ff2f2bc7", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ef22d5812f2d77acfaea9c16e3aa0d52ff2f2bc7", "committedDate": "2020-06-02T17:08:20Z", "message": "Raw psql restore\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3429b935339144ebbc2e738740e7512aee05381c", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3429b935339144ebbc2e738740e7512aee05381c", "committedDate": "2020-06-02T17:08:20Z", "message": "Centralized gsutil and pg logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e9464128f16cf55e357929fb0d6f12e8d3aa8fe", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3e9464128f16cf55e357929fb0d6f12e8d3aa8fe", "committedDate": "2020-06-02T17:08:20Z", "message": "Reverted to docker images\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ccbf65cdd576c4abe98a3000ffb5152fc7da75b", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2ccbf65cdd576c4abe98a3000ffb5152fc7da75b", "committedDate": "2020-06-02T17:08:20Z", "message": "add gcloud install and auth\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df3e3c2e8a82639e5ba2ab5d5b1b1d30e02c3781", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/df3e3c2e8a82639e5ba2ab5d5b1b1d30e02c3781", "committedDate": "2020-06-02T17:08:22Z", "message": "Added dbperf section to house docker images and scripts that can be utilized for various perf scenarios locally and in automation\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a859a9839180867e8f692ccd14858c4d37590da", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1a859a9839180867e8f692ccd14858c4d37590da", "committedDate": "2020-06-02T17:08:22Z", "message": "Cleaned up circleciconfig\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfcd5a67b94774cabcb6e1e597cc7254f035020b", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bfcd5a67b94774cabcb6e1e597cc7254f035020b", "committedDate": "2020-06-02T17:08:22Z", "message": "Cleaned restore client dockerfile\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f10d83a6e0c1a5ade77218f65eb09653b3340fcf", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f10d83a6e0c1a5ade77218f65eb09653b3340fcf", "committedDate": "2020-06-02T17:12:09Z", "message": "Use local docker file to create custom container for tests\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4c0245f81b20475d738aa6b080ad5e8fadbf9614", "committedDate": "2020-06-02T17:13:44Z", "message": "Cleaned up example tests\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9b7482e96de3b9379a262cf398a3dcef2e080dbd", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9b7482e96de3b9379a262cf398a3dcef2e080dbd", "committedDate": "2020-06-01T21:43:09Z", "message": "Merge branch 'perf-large-db' of https://github.com/hashgraph/hedera-mirror-node into perf-large-db\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}, "afterCommit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4c0245f81b20475d738aa6b080ad5e8fadbf9614", "committedDate": "2020-06-02T17:13:44Z", "message": "Cleaned up example tests\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a0e0bed72154052fa6f0ba530029b6ca10f70ed", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6a0e0bed72154052fa6f0ba530029b6ca10f70ed", "committedDate": "2020-06-02T22:22:27Z", "message": "Cleaned up and shared some logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5f975ca4cdf65f5ec60b0226cb3ad09142432fe", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f5f975ca4cdf65f5ec60b0226cb3ad09142432fe", "committedDate": "2020-06-03T03:13:28Z", "message": "Fix restore client test by using script\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5879953f961456d10395576ea7f094152d85b32", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c5879953f961456d10395576ea7f094152d85b32", "committedDate": "2020-06-03T19:28:26Z", "message": "Switched to IndefiniteWaitOneShotStartupCheckStrategy and shared test logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2914fec2a72ec36c923fb8bb8d41a3d4b4efccf5", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2914fec2a72ec36c923fb8bb8d41a3d4b4efccf5", "committedDate": "2020-06-03T19:29:59Z", "message": "Merge branch 'master' into perf-large-db\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6929e704cbc067d4d30bad7cf8dff55794d2fce4", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6929e704cbc067d4d30bad7cf8dff55794d2fce4", "committedDate": "2020-06-04T00:11:50Z", "message": "Fixed db restore in seeded scenario\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2edd77249c55bb16ecb03b437a8e586b61bbac0a", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2edd77249c55bb16ecb03b437a8e586b61bbac0a", "committedDate": "2020-06-04T16:02:41Z", "message": "Cleanup a bit more\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/31d7146feb56ebf9c01909b5128adac0c16e1689", "committedDate": "2020-06-04T20:41:09Z", "message": "Removed seeded flow and add enndpoint select tests\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMDYyNDU1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#pullrequestreview-423062455", "createdAt": "2020-06-02T21:14:32Z", "commit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMToxNDozMlrOGeEMug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQyMTo1MTowNVrOGf-Tgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3OTI1OA==", "bodyText": "Already included, can be removed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r434179258", "createdAt": "2020-06-02T21:14:32Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/pom.xml", "diffHunk": "@@ -214,6 +216,18 @@\n             <version>${testcontainers.version}</version>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>org.testcontainers</groupId>\n+            <artifactId>testcontainers</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE4MDk1OQ==", "bodyText": "Strings should all be @NotBlank.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r434180959", "createdAt": "2020-06-02T21:17:57Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/db/DBProperties.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.hedera.mirror.importer.db;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import javax.validation.constraints.NotNull;\n+import lombok.Builder;\n+import lombok.Data;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.boot.context.properties.ConstructorBinding;\n+import org.springframework.validation.annotation.Validated;\n+\n+@Data\n+@Validated\n+@Builder(toBuilder = true)\n+@ConfigurationProperties(\"hedera.mirror.importer.db\")\n+@ConstructorBinding\n+public class DBProperties {\n+    @NotNull", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE4MTI4Mw==", "bodyText": "Primitives can't be null. Min(0) would be appropriate though", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r434181283", "createdAt": "2020-06-02T21:18:34Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/db/DBProperties.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.hedera.mirror.importer.db;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import javax.validation.constraints.NotNull;\n+import lombok.Builder;\n+import lombok.Data;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.boot.context.properties.ConstructorBinding;\n+import org.springframework.validation.annotation.Validated;\n+\n+@Data\n+@Validated\n+@Builder(toBuilder = true)\n+@ConfigurationProperties(\"hedera.mirror.importer.db\")\n+@ConstructorBinding\n+public class DBProperties {\n+    @NotNull\n+    private String host = \"\";\n+\n+    @NotNull\n+    private String name = \"\";\n+\n+    @NotNull\n+    private String password = \"\";\n+\n+    @NotNull", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5NzIzMg==", "bodyText": "Shouldn't mix and match base images. Just use alpine for both if you can as it's smaller.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r434197232", "createdAt": "2020-06-02T21:54:55Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile", "diffHunk": "@@ -0,0 +1,33 @@\n+# docker build -f hedera-mirror-importer/src/test/resources/data/restore-client//Dockerfile \\\n+#   ./hedera-mirror-importer/src/test/resources/data/  \\\n+#   --build-arg dumpfile=<pgdump.gz>  --build-arg jsonkeyfile=bucket-download-key.json\n+#   -t hedera-mirror-node/postgres-restore-client\n+FROM debian:stretch AS build\n+\n+# get dump file\n+ARG dumpfile\n+ARG jsonkeyfile\n+\n+RUN apt-get -qqy update && apt-get install -qqy curl python-dev\n+RUN curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz\n+RUN tar -C /usr/local/ -xvf /tmp/google-cloud-sdk.tar.gz\n+RUN /usr/local/google-cloud-sdk/install.sh\n+\n+COPY ./$jsonkeyfile /tmp/config.json\n+RUN /usr/local/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file /tmp/config.json\n+\n+\n+RUN /usr/local/google-cloud-sdk/bin/gsutil cp gs://hedera-mirror-dev/database/$dumpfile /tmp/pgdump.gz\n+RUN rm /tmp/config.json\n+\n+FROM alpine:latest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIwMzQ0NQ==", "bodyText": "You don't need to provide build args if you just want to run the image. Those args are only for build stage which happens manually via mvn.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r434203445", "createdAt": "2020-06-02T22:10:57Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/CustomPostgresContainer.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.images.builder.ImageFromDockerfile;\n+\n+public class CustomPostgresContainer {\n+    public static ImageFromDockerfile createSeededDockerImage(String dockerFilePath, String pgDumpFile) {\n+        return new ImageFromDockerfile()\n+                .withFileFromClasspath(\"Dockerfile\", dockerFilePath)\n+                .withFileFromClasspath(\"bucket-download-key.json\", \"data/bucket-download-key.json\")\n+                .withFileFromClasspath(\"postgresql.conf\", \"data/postgresql.conf\")\n+                .withBuildArg(\"dumpfile\", pgDumpFile)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c0245f81b20475d738aa6b080ad5e8fadbf9614"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4NTgwNQ==", "bodyText": "nit: testcontainers.version", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r435985805", "createdAt": "2020-06-05T15:10:11Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/pom.xml", "diffHunk": "@@ -20,6 +20,7 @@\n         <commons-io.version>2.6</commons-io.version>\n         <guava.version>29.0-jre</guava.version>\n         <s3mock.version>0.2.5</s3mock.version>\n+        <testcontainer.version>1.14.3</testcontainer.version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4Njc2Mg==", "bodyText": "This file can be removed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r435986762", "createdAt": "2020-06-05T15:11:52Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/resources/data/postgresql.conf", "diffHunk": "@@ -0,0 +1,3 @@\n+listen_addresses = '*'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4Njk0OA==", "bodyText": "This file and folder can be removed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r435986948", "createdAt": "2020-06-05T15:12:07Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/resources/data/base-image/Dockerfile", "diffHunk": "@@ -0,0 +1,26 @@\n+# Empty postgres db image with mirror node users and empty database created\n+# Build using command from repo root:\n+# docker build -f hedera-mirror-importer/src/test/resources/data/base-image/Dockerfile \\\n+#   ./hedera-mirror-importer/ \\\n+#   -t gcr.io/mirrornode/hedera-mirror-node/postgres:latest\n+FROM postgres:9.6", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk5MTkxNA==", "bodyText": "We should not be creating users in a restore client docker image. This would fail if ran against Cloud SQL. Recommend removing restore.sh and just making entrypoint pg_restore", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r435991914", "createdAt": "2020-06-05T15:19:54Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/resources/data/restore.sh", "diffHunk": "@@ -0,0 +1,16 @@\n+#!/bin/sh\n+set -e\n+\n+echo \"Setting user and role for Mirror Node\"\n+PGPASSWORD=$DB_PASS psql -v ON_ERROR_STOP=1 --username \"$DB_USER\" --dbname \"$DB_NAME\" -p \"$DB_PORT\" -h localhost <<-EOSQL\n+    \\set db_user 'mirror_node'\n+    \\set db_password 'mirror_node_pass'\n+\n+    create user :db_user with login createrole password :'db_password';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk5NjQ4Ng==", "bodyText": "Not necessary to remove as this build image is not pushed anywhere.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r435996486", "createdAt": "2020-06-05T15:27:23Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile", "diffHunk": "@@ -0,0 +1,42 @@\n+# Creates image to be used as an executable container that performs a pg_restore against an already existing database\n+# docker build -f hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile \\\n+#   ./hedera-mirror-importer/src/test/resources/data/  \\\n+#   --build-arg dumpfile=<pgdump.gz>  --build-arg jsonkeyfile=bucket-download-key.json\n+#   -t gcr.io/mirrornode/hedera-mirror-node/postgres-restore-client:latest\n+FROM debian:stretch AS build\n+\n+ARG dumpfile\n+ARG jsonkeyfile\n+\n+# install gcloud tools\n+RUN apt-get -qqy update && apt-get install -qqy curl python-dev\n+RUN curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz\n+RUN tar -C /usr/local/ -xvf /tmp/google-cloud-sdk.tar.gz\n+RUN /usr/local/google-cloud-sdk/install.sh\n+\n+# pull in key file and set up account\n+COPY ./$jsonkeyfile /tmp/config.json\n+RUN /usr/local/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file /tmp/config.json\n+\n+# download file from remote bucket and remove key file\n+RUN /usr/local/google-cloud-sdk/bin/gsutil cp gs://hedera-mirror-dev/database/$dumpfile /tmp/pgdump.gz\n+RUN rm /tmp/config.json", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk5NjU4NQ==", "bodyText": "This file and associated files should not live in src/test/resources/data as they are not data. Would recommend src/test/resources/scripts/restore-client/", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r435996585", "createdAt": "2020-06-05T15:27:32Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile", "diffHunk": "@@ -0,0 +1,42 @@\n+# Creates image to be used as an executable container that performs a pg_restore against an already existing database\n+# docker build -f hedera-mirror-importer/src/test/resources/data/restore-client/Dockerfile \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk5OTg4Nw==", "bodyText": "Why are we duplicating and performance testing REST queries in the importer module? If the queries change in REST API we now have to change it here. We already have performance tests for the REST API in the REST API module. We should later figure out how to use the restore client to populate the data for the tests there. Recommend these be removed.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r435999887", "createdAt": "2020-06-05T15:33:00Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/PerformanceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.nio.file.Path;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Resource;\n+import javax.sql.DataSource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.test.context.SpringBootTest;\n+\n+import com.hedera.mirror.importer.FileCopier;\n+import com.hedera.mirror.importer.domain.ApplicationStatusCode;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.parser.record.RecordFileParser;\n+import com.hedera.mirror.importer.parser.record.RecordParserProperties;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+\n+@Log4j2\n+@SpringBootTest\n+public abstract class PerformanceIntegrationTest {\n+    @Resource\n+    DataSource dataSource;\n+\n+    Connection connection;\n+\n+    @Resource\n+    private ApplicationStatusRepository applicationStatusRepository;\n+\n+    @TempDir\n+    static Path dataPath;\n+\n+    @Value(\"classpath:data\")\n+    Path testPath;\n+\n+    @Resource\n+    private RecordFileParser recordFileParser;\n+\n+    private FileCopier fileCopier;\n+\n+    private StreamType streamType;\n+\n+    @Resource\n+    private RecordParserProperties parserProperties;\n+\n+    void parse(String filePath) {\n+        streamType = parserProperties.getStreamType();\n+        parserProperties.getMirrorProperties().setDataPath(dataPath);\n+        parserProperties.init();\n+\n+        fileCopier = FileCopier.create(testPath, dataPath)\n+                .from(streamType.getPath(), \"performance\")\n+                .filterFiles(filePath)\n+                .to(streamType.getPath(), streamType.getValid());\n+        fileCopier.copy();\n+\n+        recordFileParser.parse();\n+    }\n+\n+    void checkSeededTablesArePresent() {\n+        String[] tables = new String[] {\"account_balance_sets\", \"account_balances\", \"flyway_schema_history\",\n+                \"non_fee_transfers\", \"t_application_status\", \"t_contract_result\", \"t_cryptotransferlists\",\n+                \"t_entities\", \"t_entity_types\", \"t_file_data\", \"t_livehashes\", \"t_record_files\",\n+                \"t_transaction_results\",\n+                \"t_transaction_types\", \"t_transactions\", \"topic_message\"\n+        };\n+        List<String> discoveredTables = new ArrayList<>();\n+\n+        try (Connection connection = dataSource.getConnection();\n+             ResultSet rs = connection.getMetaData().getTables(null, null, null, new String[] {\"TABLE\"})) {\n+\n+            while (rs.next()) {\n+                discoveredTables.add(rs.getString(\"TABLE_NAME\"));\n+            }\n+        } catch (Exception e) {\n+            log.error(\"Unable to retrieve details from database\", e);\n+        }\n+\n+        assertThat(discoveredTables.size()).isGreaterThan(0);\n+        Collections.sort(discoveredTables);\n+        log.info(\"Encountered tables: {}\", discoveredTables);\n+        assertThat(discoveredTables).isEqualTo(Arrays.asList(tables));\n+    }\n+\n+    long getTableSize(String table) throws SQLException {\n+        PreparedStatement statement = connection.prepareStatement(\"select count (*) from \" + table);\n+        ResultSet rs = statement.executeQuery();\n+        rs.next();\n+        return rs.getLong(\"count\");\n+    }\n+\n+    void getAccounts(long pageSize) throws SQLException {\n+        String sqlQuery = \"select ab.balance as account_balance\\n\" +\n+                \"    , ab.consensus_timestamp as consensus_timestamp\\n\" +\n+                \"    , 0 as entity_shard\\n\" +\n+                \"    , coalesce(ab.account_realm_num, e.entity_realm) as entity_realm\\n\" +\n+                \"    , coalesce(ab.account_num, e.entity_num) as entity_num\\n\" +\n+                \"    , e.exp_time_ns\\n\" +\n+                \"    , e.auto_renew_period\\n\" +\n+                \"    , e.key\\n\" +\n+                \"    , e.deleted\\n\" +\n+                \"from account_balances ab\\n\" +\n+                \"full outer join t_entities e\\n\" +\n+                \"    on (0 = e.entity_shard\\n\" +\n+                \"        and ab.account_realm_num = e.entity_realm\\n\" +\n+                \"        and ab.account_num =  e.entity_num\\n\" +\n+                \"        and e.fk_entity_type_id < 3)\\n\" +\n+                \"where ab.consensus_timestamp = (select max(consensus_timestamp) from account_balances)\\n\" +\n+                \"    and \\n\" +\n+                \"1=1 and 1=1 and 1=1 order by coalesce(ab.account_num, e.entity_num) desc\\n\" +\n+                \"limit ?\";\n+        runSelectStatementWithPageSize(sqlQuery, pageSize);\n+    }\n+\n+    void getBalances(long pageSize) throws SQLException {\n+        String sqlQuery = \"select ab.consensus_timestamp,\\n\" +\n+                \"ab.account_realm_num as realm_num, ab.account_num as entity_num, ab.balance\\n\" +\n+                \" from account_balances ab\\n\" +\n+                \" where  consensus_timestamp = (select consensus_timestamp from account_balances ab\\n\" +\n+                \" where\\n\" +\n+                \"((ab.consensus_timestamp  >=  0) )\\n\" +\n+                \"order by consensus_timestamp desc limit 1)\\n\" +\n+                \" and\\n\" +\n+                \"1=1 and 1=1 and 1=1 order by consensus_timestamp desc, account_realm_num desc,account_num desc limit\" +\n+                \" ?\";\n+        runSelectStatementWithPageSize(sqlQuery, pageSize);\n+    }\n+\n+    void getTopicMessages(long pageSize) throws SQLException {\n+        String sqlQuery = \"select consensus_timestamp, realm_num, topic_num, message, running_hash, sequence_number\\n\" +\n+                \"from topic_message limit ?;\";\n+\n+        runSelectStatementWithPageSize(sqlQuery, pageSize);\n+    }\n+\n+    void getTransactions(long pageSize) throws SQLException {\n+        String sqlQuery = \"select etrans.entity_shard,  etrans.entity_realm, etrans.entity_num\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 166}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAxNzE0OQ==", "bodyText": "We should not be using lower level JDBC anywhere unless it truly demands it if there's no JPA equivalent. Here you can simply:\n@Resource\nprivate Collection<CrudRepository<?,?>> repositories;\n\n@Test\nvoid tablesExist() {\n  repositores.forEach(r -> assertThat(r.count()).isGreaterThan(0));\n}", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r436017149", "createdAt": "2020-06-05T16:01:48Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/PerformanceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.nio.file.Path;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Resource;\n+import javax.sql.DataSource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.test.context.SpringBootTest;\n+\n+import com.hedera.mirror.importer.FileCopier;\n+import com.hedera.mirror.importer.domain.ApplicationStatusCode;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.parser.record.RecordFileParser;\n+import com.hedera.mirror.importer.parser.record.RecordParserProperties;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+\n+@Log4j2\n+@SpringBootTest\n+public abstract class PerformanceIntegrationTest {\n+    @Resource\n+    DataSource dataSource;\n+\n+    Connection connection;\n+\n+    @Resource\n+    private ApplicationStatusRepository applicationStatusRepository;\n+\n+    @TempDir\n+    static Path dataPath;\n+\n+    @Value(\"classpath:data\")\n+    Path testPath;\n+\n+    @Resource\n+    private RecordFileParser recordFileParser;\n+\n+    private FileCopier fileCopier;\n+\n+    private StreamType streamType;\n+\n+    @Resource\n+    private RecordParserProperties parserProperties;\n+\n+    void parse(String filePath) {\n+        streamType = parserProperties.getStreamType();\n+        parserProperties.getMirrorProperties().setDataPath(dataPath);\n+        parserProperties.init();\n+\n+        fileCopier = FileCopier.create(testPath, dataPath)\n+                .from(streamType.getPath(), \"performance\")\n+                .filterFiles(filePath)\n+                .to(streamType.getPath(), streamType.getValid());\n+        fileCopier.copy();\n+\n+        recordFileParser.parse();\n+    }\n+\n+    void checkSeededTablesArePresent() {\n+        String[] tables = new String[] {\"account_balance_sets\", \"account_balances\", \"flyway_schema_history\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2NDY5OQ==", "bodyText": "This test can't work in CircleCI as it doesn't support Docker in Docker. In fact, in CircleCI it looks like it runs but finds no tests to execute:\n 2020-06-04 20:42:33,184 INFO  [main ] c.h.m.i.p.p.RestoreClientIntegrationTest Started RestoreClientIntegrationTest in 11.512 seconds (JVM running for 14.805)\n 2020-06-04 20:42:33,228 INFO  [task-1] c.h.m.i.p.b.BalanceFileParser Skip watching directory: ./data/accountBalances/valid\n 2020-06-04 20:42:33,282 INFO  [task-2] c.h.m.i.p.r.EntityIdCacheLoader Cached 0 entity id mappings in 60.23 ms\n 2020-06-04 20:42:33,289 INFO  [main ] c.h.m.i.p.p.RestoreClientIntegrationTest Stop container null\n [INFO] Tests run: 0, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 12.939 s - in com.hedera.mirror.importer.parser.****ormance.RestoreClientIntegrationTest", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r436164699", "createdAt": "2020-06-05T21:07:21Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/RestoreClientIntegrationTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+import javax.annotation.Resource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.Rule;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Disabled;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.junit.jupiter.api.Timeout;\n+import org.testcontainers.containers.GenericContainer;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+@Tag(\"performance\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2NzYwNw==", "bodyText": "I don't think we need to verify table size separately from checkSeededTablesArePresent(). Can combine", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r436167607", "createdAt": "2020-06-05T21:15:26Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/RestoreClientIntegrationTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+import javax.annotation.Resource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.Rule;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Disabled;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.junit.jupiter.api.Timeout;\n+import org.testcontainers.containers.GenericContainer;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+@Tag(\"performance\")\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+public class RestoreClientIntegrationTest extends PerformanceIntegrationTest {\n+    @Resource\n+    private DBProperties dbProperties;\n+\n+    @Rule\n+    GenericContainer customContainer;\n+\n+    private final long maxPageSize = 1000;\n+\n+    @BeforeAll\n+    void warmUp() throws SQLException {\n+        customContainer = CustomPostgresContainer.createRestoreContainer(\n+                \"data/restore-client/Dockerfile\",\n+                \"testnet_100k_pgdump.gz\",\n+                dbProperties);\n+\n+        log.info(\"Start container {}\", customContainer);\n+        customContainer.start();\n+        log.info(\"Database restore complete to {}\", dbProperties);\n+\n+        connection = dataSource.getConnection();\n+        checkSeededTablesArePresent();\n+    }\n+\n+    @AfterAll\n+    void coolOff() {\n+        log.info(\"Stop container {}\", customContainer);\n+        customContainer.stop();\n+    }\n+\n+    @Test\n+    public void parseAndIngestTransactions() throws Exception {\n+        clearLastProcessedRecordHash();\n+        parse(\"*.rcd\");\n+    }\n+\n+    @Timeout(1)\n+    @Test\n+    public void checkEntitiesTablesIsPopulated() throws Exception {\n+        verifyTableSize(\"t_entities\", \"entities\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2ODQ4Nw==", "bodyText": "Should not use JUnit 4.x features. I doubt this is even working as you are manually creating object and starting and stopping. JUnit 5.x recommended approach is to use @TestContainers + @Container.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r436168487", "createdAt": "2020-06-05T21:17:45Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/RestoreClientIntegrationTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+import javax.annotation.Resource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.Rule;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Disabled;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.junit.jupiter.api.Timeout;\n+import org.testcontainers.containers.GenericContainer;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+@Tag(\"performance\")\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+public class RestoreClientIntegrationTest extends PerformanceIntegrationTest {\n+    @Resource\n+    private DBProperties dbProperties;\n+\n+    @Rule", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2OTk0NQ==", "bodyText": "I don't see the need for this class.\na) It's no longer creating a postgres container, so it's named wrong.\nb) Has 3 public methods but only one actually used publically\nc) There is a PerformanceIntegrationTest where this logic makes more sense\nd) The static strings make it harder to read, not easier. They're not needed for performance or reuse reasons so better to inline.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r436169945", "createdAt": "2020-06-05T21:22:02Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/CustomPostgresContainer.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import lombok.extern.log4j.Log4j2;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.startupcheck.IndefiniteWaitOneShotStartupCheckStrategy;\n+import org.testcontainers.images.builder.ImageFromDockerfile;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+public class CustomPostgresContainer {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE3OTg0Mw==", "bodyText": "We can't create images in CircleCI currently. It would be better if we just pushed some golden images (100k, 1M, 10M) for use in these tests manually instead of building each time.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r436179843", "createdAt": "2020-06-05T21:51:05Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/CustomPostgresContainer.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import lombok.extern.log4j.Log4j2;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.startupcheck.IndefiniteWaitOneShotStartupCheckStrategy;\n+import org.testcontainers.images.builder.ImageFromDockerfile;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+public class CustomPostgresContainer {\n+\n+    private static final String dbNameEnvVar = \"DB_NAME\";\n+    private static final String dbUserEnvVar = \"DB_USER\";\n+    private static final String dbPasswordEnvVar = \"DB_PASS\";\n+    private static final String dbPortEnvVar = \"DB_PORT\";\n+    private static final String dockerFileName = \"Dockerfile\";\n+    private static final String dumpFileArgName = \"dumpfile\";\n+    private static final String jsonKeyFileArgName = \"jsonkeyfile\";\n+    private static final String jsonKeyFileName = \"bucket-download-key.json\";\n+    private static final String jsonKeyFilePath = \"data/bucket-download-key.json\";\n+    private static final String restoreScriptFileName = \"restore.sh\";\n+    private static final String restoreScriptFilePath = \"data/restore.sh\";\n+\n+    public static ImageFromDockerfile createBaseDockerImage(String dockerFilePath) {\n+        return new ImageFromDockerfile()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6323cc39b1dc268b849d253ca9744a25e55eff1d", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6323cc39b1dc268b849d253ca9744a25e55eff1d", "committedDate": "2020-06-08T22:53:27Z", "message": "Addressed feedback, reduced footprint\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfd27b124462c557edb3e8638f2dd80a7416ad22", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bfd27b124462c557edb3e8638f2dd80a7416ad22", "committedDate": "2020-06-08T23:30:19Z", "message": "Removed REST api related tests calls\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efd38ff1e986903045a87e8c8d49eaa74e1c6b20", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/efd38ff1e986903045a87e8c8d49eaa74e1c6b20", "committedDate": "2020-06-08T23:50:59Z", "message": "Clean up a bit\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MjM1OTU3", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#pullrequestreview-427235957", "createdAt": "2020-06-09T14:53:27Z", "commit": {"oid": "efd38ff1e986903045a87e8c8d49eaa74e1c6b20"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNDo1MzoyOFrOGhOEmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNToyNDozM1rOGhP__Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ4Njc0Ng==", "bodyText": "It's still using JDBC, which was my main complaint. I don't think you need to check if all these tables exist. Just check that one table exists and has data via count() along with the container exit code check should be sufficient.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437486746", "createdAt": "2020-06-09T14:53:28Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/PerformanceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,219 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.nio.file.Path;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Resource;\n+import javax.sql.DataSource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.test.context.SpringBootTest;\n+\n+import com.hedera.mirror.importer.FileCopier;\n+import com.hedera.mirror.importer.domain.ApplicationStatusCode;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.parser.record.RecordFileParser;\n+import com.hedera.mirror.importer.parser.record.RecordParserProperties;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+\n+@Log4j2\n+@SpringBootTest\n+public abstract class PerformanceIntegrationTest {\n+    @Resource\n+    DataSource dataSource;\n+\n+    Connection connection;\n+\n+    @Resource\n+    private ApplicationStatusRepository applicationStatusRepository;\n+\n+    @TempDir\n+    static Path dataPath;\n+\n+    @Value(\"classpath:data\")\n+    Path testPath;\n+\n+    @Resource\n+    private RecordFileParser recordFileParser;\n+\n+    private FileCopier fileCopier;\n+\n+    private StreamType streamType;\n+\n+    @Resource\n+    private RecordParserProperties parserProperties;\n+\n+    void parse(String filePath) {\n+        streamType = parserProperties.getStreamType();\n+        parserProperties.getMirrorProperties().setDataPath(dataPath);\n+        parserProperties.init();\n+\n+        fileCopier = FileCopier.create(testPath, dataPath)\n+                .from(streamType.getPath(), \"performance\")\n+                .filterFiles(filePath)\n+                .to(streamType.getPath(), streamType.getValid());\n+        fileCopier.copy();\n+\n+        recordFileParser.parse();\n+    }\n+\n+    void checkSeededTablesArePresent() {\n+        String[] tables = new String[] {\"account_balance_sets\", \"account_balances\", \"flyway_schema_history\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAxNzE0OQ=="}, "originalCommit": {"oid": "31d7146feb56ebf9c01909b5128adac0c16e1689"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ5MDQ4OQ==", "bodyText": "These are absolutely necessary to be not blank even if you're not using the REST API. This is because they run as part of Flyway migration and will fail if empty.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437490489", "createdAt": "2020-06-09T14:58:21Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/db/DBProperties.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.hedera.mirror.importer.db;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import javax.validation.constraints.Min;\n+import javax.validation.constraints.NotBlank;\n+import lombok.Builder;\n+import lombok.Data;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.boot.context.properties.ConstructorBinding;\n+import org.springframework.validation.annotation.Validated;\n+\n+@Data\n+@Validated\n+@Builder(toBuilder = true)\n+@ConfigurationProperties(\"hedera.mirror.importer.db\")\n+@ConstructorBinding\n+public class DBProperties {\n+    @NotBlank\n+    private String host = \"\";\n+\n+    @NotBlank\n+    private String name = \"\";\n+\n+    @NotBlank\n+    private String password = \"\";\n+\n+    @Min(0)\n+    private int port = 5432;\n+\n+    private String restPassword = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efd38ff1e986903045a87e8c8d49eaa74e1c6b20"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ5MzE1Mw==", "bodyText": "Should be protected and non-static. Can just inject DBProperties into this class and use it without having to pass it via parameter.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437493153", "createdAt": "2020-06-09T15:01:48Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/PerformanceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,166 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.nio.file.Path;\n+import java.sql.Connection;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Resource;\n+import javax.sql.DataSource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.test.context.SpringBootTest;\n+import org.springframework.data.repository.CrudRepository;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.startupcheck.IndefiniteWaitOneShotStartupCheckStrategy;\n+\n+import com.hedera.mirror.importer.FileCopier;\n+import com.hedera.mirror.importer.db.DBProperties;\n+import com.hedera.mirror.importer.domain.ApplicationStatusCode;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.parser.record.RecordFileParser;\n+import com.hedera.mirror.importer.parser.record.RecordParserProperties;\n+import com.hedera.mirror.importer.repository.AccountBalanceRepository;\n+import com.hedera.mirror.importer.repository.ApplicationStatusRepository;\n+import com.hedera.mirror.importer.repository.EntityRepository;\n+import com.hedera.mirror.importer.repository.TopicMessageRepository;\n+import com.hedera.mirror.importer.repository.TransactionRepository;\n+\n+@Log4j2\n+@SpringBootTest\n+public abstract class PerformanceIntegrationTest {\n+\n+    @TempDir\n+    static Path dataPath;\n+\n+    @Value(\"classpath:data\")\n+    Path testPath;\n+\n+    @Resource\n+    private RecordFileParser recordFileParser;\n+\n+    private FileCopier fileCopier;\n+\n+    private StreamType streamType;\n+\n+    @Resource\n+    private RecordParserProperties parserProperties;\n+\n+    @Resource\n+    DataSource dataSource;\n+\n+    Connection connection;\n+\n+    @Resource\n+    private ApplicationStatusRepository applicationStatusRepository;\n+\n+    @Resource\n+    private EntityRepository entityRepository;\n+\n+    @Resource\n+    private AccountBalanceRepository accountBalanceRepository;\n+\n+    @Resource\n+    private TopicMessageRepository topicMessageRepository;\n+\n+    @Resource\n+    private TransactionRepository transactionRepository;\n+\n+    private static final String restoreClientImagePrefix = \"gcr.io/mirrornode/hedera-mirror-node/postgres-restore\" +\n+            \"-client:\";\n+\n+    public static GenericContainer createRestoreContainer(String dockerImageTag, DBProperties db) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efd38ff1e986903045a87e8c8d49eaa74e1c6b20"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUxODMzMw==", "bodyText": "Do we need to assertThat(customContainer.getContainerInfo().getState().getExitCodeLong()).isEqualTo(0L);? Or does TestContainers automatically do that?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#discussion_r437518333", "createdAt": "2020-06-09T15:24:33Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/performance/RestoreClientIntegrationTest.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package com.hedera.mirror.importer.parser.performance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.sql.SQLException;\n+import javax.annotation.Resource;\n+import lombok.extern.log4j.Log4j2;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.junit.jupiter.Container;\n+import org.testcontainers.junit.jupiter.Testcontainers;\n+\n+import com.hedera.mirror.importer.db.DBProperties;\n+\n+@Log4j2\n+@Tag(\"largedbperf\")\n+@Testcontainers\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+public class RestoreClientIntegrationTest extends PerformanceIntegrationTest {\n+    @Resource\n+    private DBProperties dbProperties;\n+\n+    @Container\n+    GenericContainer customContainer;\n+\n+    @BeforeAll\n+    void warmUp() throws SQLException {\n+        customContainer = createRestoreContainer(\"100k\",\n+                dbProperties);\n+\n+        log.info(\"Start container {}\", customContainer);\n+        customContainer.start();\n+        log.info(\"Database restore complete to {}\", dbProperties);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efd38ff1e986903045a87e8c8d49eaa74e1c6b20"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3Mjg2Mjkx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/797#pullrequestreview-427286291", "createdAt": "2020-06-09T15:33:09Z", "commit": {"oid": "efd38ff1e986903045a87e8c8d49eaa74e1c6b20"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3173, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}