{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MzU2ODM5", "number": 1060, "title": "allow individual maxLimit config in rest service monitor", "bodyText": "Detailed description:\nSupports per-resource maxLimit config in rest service monitor, so ops can configure a smaller threshold for low traffic environments.\n\nAdds separate configuration option maxLimit for account, balance, and transaction. The value will overrides the global maxLimit if it's smaller\nAdds missing consensus timestamp ascending order check for transactions query\nRemoves dependency on hedera-mirror-rest/config and moves all configuration to serverlist.json\nAggregates http response code from all servers, returns 409 if there is at least one failed test\n\nWhich issue(s) this PR fixes:\nFixes #1033\nFixes #462\nSpecial notes for your reviewer:\nTested in perfnet.\n$ curl http://localhost:9001/api/v1/status/performance-6557 | jq .\n{\n  \"ip\": \"127.0.0.1\",\n  \"name\": \"performance-6557\",\n  \"port\": \"6557\",\n  \"results\": {\n    \"testResults\": [\n      {\n        \"at\": 1600439717484,\n        \"result\": \"passed\",\n        \"url\": \"http://127.0.0.1:6557/api/v1/balances?limit=100\",\n        \"message\": \"Successfully called balances and performed account check\",\n        \"failureMessages\": []\n      },\n      {\n        \"at\": 1600439717484,\n        \"result\": \"passed\",\n        \"url\": \"http://127.0.0.1:6557/api/v1/balances?limit=1\",\n        \"message\": \"Successfully retrieved balance from with 1800 seconds ago\",\n        \"failureMessages\": []\n      },\n      {\n        \"at\": 1600439717484,\n        \"result\": \"passed\",\n        \"url\": \"http://127.0.0.1:6557/api/v1/accounts?timestamp=gt%3A1600439399.310535&timestamp=lt%3A1600439401.310535&limit=1\",\n        \"message\": \"Successfully called accounts with time and limit params\",\n        \"failureMessages\": []\n      },\n      {\n        \"at\": 1600439717484,\n        \"result\": \"passed\",\n        \"url\": \"http://127.0.0.1:6557/api/v1/balances?timestamp=gt%3A1600439399.310535&timestamp=lt%3A1600439401.310535&limit=1\",\n        \"message\": \"Successfully called balances with time and limit params\",\n        \"failureMessages\": []\n      },\n      {\n        \"at\": 1600439717484,\n        \"result\": \"passed\",\n        \"url\": \"http://127.0.0.1:6557/api/v1/transactions?limit=1\",\n        \"message\": \"Successfully retrieved transactions from with 50 seconds ago\",\n        \"failureMessages\": []\n      },\n      {\n        \"at\": 1600439717484,\n        \"result\": \"passed\",\n        \"url\": \"http://127.0.0.1:6557/api/v1/balances?account.id=0.0.1009\",\n        \"message\": \"Successfully called balances and performed account check\",\n        \"failureMessages\": []\n      },\n      {\n        \"at\": 1600439717483,\n        \"result\": \"passed\",\n        \"url\": \"http://127.0.0.1:6557/api/v1/transactions?timestamp=gt%3A1600439702.316232&timestamp=lt%3A1600439704.316232&limit=1\",\n        \"message\": \"Successfully called transactions with time and limit params\",\n        \"failureMessages\": []\n      },\n      {\n        \"at\": 1600439717483,\n        \"result\": \"passed\",\n        \"url\": \"http://127.0.0.1:6557/api/v1/transactions/0.0.2-1600439692-302595000\",\n        \"message\": \"Successfully retrieved single transactions by id\",\n        \"failureMessages\": []\n      },\n      {\n        \"at\": 1600439717483,\n        \"result\": \"passed\",\n        \"url\": \"http://127.0.0.1:6557/api/v1/transactions?limit=10\",\n        \"message\": \"Successfully called transactions with limit params only\",\n        \"failureMessages\": []\n      },\n      {\n        \"at\": 1600439717484,\n        \"result\": \"passed\",\n        \"url\": \"http://127.0.0.1:6557/api/v1/accounts?account.id=1001&type=credit&limit=1\",\n        \"message\": \"Successfully called accounts and performed account check\",\n        \"failureMessages\": []\n      },\n      {\n        \"at\": 1600439717483,\n        \"result\": \"passed\",\n        \"url\": \"http://127.0.0.1:6557/api/v1/transactions?order=asc&limit=102\",\n        \"message\": \"Successfully called transactions with order params only\",\n        \"failureMessages\": []\n      },\n      {\n        \"at\": 1600439717483,\n        \"result\": \"passed\",\n        \"url\": \"http://127.0.0.1:6557/api/v1/transactions?account.id=3&type=credit&limit=1\",\n        \"message\": \"Successfully called transactions and performed account check\",\n        \"failureMessages\": []\n      },\n      {\n        \"at\": 1600439717484,\n        \"result\": \"passed\",\n        \"url\": \"http://127.0.0.1:6557/api/v1/accounts/0.0.1001\",\n        \"message\": \"Successfully called accounts for single account\",\n        \"failureMessages\": []\n      }\n    ],\n    \"numPassedTests\": 13,\n    \"numFailedTests\": 0,\n    \"success\": true,\n    \"message\": \"\",\n    \"startTime\": 1600439717483,\n    \"endTime\": 1600439717888\n  },\n  \"httpCode\": 200\n}\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-09-18T14:34:52Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1060", "merged": true, "mergeCommit": {"oid": "e6f6cf92a213c4a1a1e76dece34b9e94ffb0ecc8"}, "closed": true, "closedAt": "2020-09-22T01:24:22Z", "author": {"login": "xin-hedera"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJ7AFtgH2gAyNDg5MzU2ODM5OmJjOWJmNjhhMzk5ZTAwMmEwYTUzMDMxYmZlMGNkNzk2NDg1MTBhNzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLMgdXgFqTQ5MzA1ODk1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bc9bf68a399e002a0a53031bfe0cd79648510a79", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bc9bf68a399e002a0a53031bfe0cd79648510a79", "committedDate": "2020-09-18T01:07:03Z", "message": "enable per resource maxLimit config and some cleanup\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65ad20dd9e18b82706ae6ce93fb543af409960bc", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/65ad20dd9e18b82706ae6ce93fb543af409960bc", "committedDate": "2020-09-18T01:22:48Z", "message": "update readme\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "264ec6b7927d568f99f5100d80c963665b1cca96", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/264ec6b7927d568f99f5100d80c963665b1cca96", "committedDate": "2020-09-18T14:52:02Z", "message": "cleanup, prettier warnings\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNTY1OTI1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1060#pullrequestreview-491565925", "createdAt": "2020-09-18T15:24:45Z", "commit": {"oid": "264ec6b7927d568f99f5100d80c963665b1cca96"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5846464b84d27d298131537b3155c289ab8a8e56", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5846464b84d27d298131537b3155c289ab8a8e56", "committedDate": "2020-09-18T20:28:15Z", "message": "directly compare consensus timestamp string\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNzYzMDY2", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1060#pullrequestreview-491763066", "createdAt": "2020-09-18T20:31:02Z", "commit": {"oid": "5846464b84d27d298131537b3155c289ab8a8e56"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMDozMTowMlrOHUbAng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMDozMTowMlrOHUbAng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE3NjA5NA==", "bodyText": "changed from the last revision, directly compare the timestamp string", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1060#discussion_r491176094", "createdAt": "2020-09-18T20:31:02Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/monitoring/monitor_apis/transaction_tests.js", "diffHunk": "@@ -169,32 +170,40 @@ const getTransactionsWithAccountCheck = async (server, classResults) => {\n  * @param {Object} classResults shared class results object capturing tests for given endpoint\n  */\n const getTransactionsWithOrderParam = async (server, classResults) => {\n-  var currentTestResult = acctestutils.getMonitorTestResult();\n+  const currentTestResult = acctestutils.getMonitorTestResult();\n \n-  let url = acctestutils.getUrl(server, `${transactionsPath}?order=asc`);\n+  const query = {order: 'asc'};\n+  const {maxLimit, isGlobal} = acctestutils.getMaxLimit(resource);\n+  if (!isGlobal) {\n+    query.limit = maxLimit;\n+  }\n+\n+  const url = acctestutils.getUrl(server, transactionsPath, query);\n   currentTestResult.url = url;\n-  let transactions = await getTransactions(url, currentTestResult);\n+  const transactions = await getTransactions(url, currentTestResult);\n \n   if (undefined === transactions) {\n-    var message = `transactions is undefined`;\n+    const message = `transactions is undefined`;\n     currentTestResult.failureMessages.push(message);\n     acctestutils.addTestResult(classResults, currentTestResult, false);\n     return;\n   }\n \n   if (transactions.length !== maxLimit) {\n-    var message = `transactions.length of ${transactions.length} is less than limit ${maxLimit}`;\n+    const message = `transactions.length of ${transactions.length} is less than limit ${maxLimit}`;\n     currentTestResult.failureMessages.push(message);\n     acctestutils.addTestResult(classResults, currentTestResult, false);\n     return;\n   }\n \n-  let prevSeconds = 0;\n-  for (let txn of transactions) {\n-    if (acctestutils.secNsToSeconds(txn.seconds) < prevSeconds) {\n-      check = false;\n+  let previousConsensusTimestamp = '0';\n+  for (const txn of transactions) {\n+    if (txn.consensus_timestamp <= previousConsensusTimestamp) {\n+      currentTestResult.failureMessages.push('consensus timestamps are not in ascending order');\n+      acctestutils.addTestResult(classResults, currentTestResult, false);\n+      return;\n     }\n-    prevSeconds = acctestutils.secNsToSeconds(txn.seconds);\n+    previousConsensusTimestamp = txn.consensus_timestamp;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5846464b84d27d298131537b3155c289ab8a8e56"}, "originalPosition": 197}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNTkyNTc1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1060#pullrequestreview-491592575", "createdAt": "2020-09-18T15:58:35Z", "commit": {"oid": "264ec6b7927d568f99f5100d80c963665b1cca96"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNTo1ODozNVrOHUS-uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNjoyNjoyOVrOHVY-pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NDUzOQ==", "bodyText": "Adjust to two spaces indentation", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1060#discussion_r491044539", "createdAt": "2020-09-18T15:58:35Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/monitoring/README.md", "diffHunk": "@@ -39,6 +39,22 @@ git clone git@github.com:hashgraph/hedera-mirror-node.git\n cd hedera-mirror-node/hedera-mirror-rest/monitoring\n ```\n \n+To configure a smaller `maxLimit` threshold for individual resources (`account`, `balance`, or `transaction`), for example,\n+for environments with lower traffic volume, add the following section to `application.yml`:\n+\n+```yaml\n+hedera:\n+  mirror:\n+    rest:\n+      monitor:\n+        account:\n+                maxLimit: 100", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "264ec6b7927d568f99f5100d80c963665b1cca96"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE4ODU5Mg==", "bodyText": "It's quite strange that we're using the config reader from hedera-mirror-rest and that the monitor_api has two different config formats (e.g. application.yaml and serverlist.json). We should remove this dependency and just use serverlist.json.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1060#discussion_r492188592", "createdAt": "2020-09-21T16:21:59Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/monitoring/monitor_apis/monitortest_utils.js", "diffHunk": "@@ -17,10 +17,11 @@\n  * limitations under the License.\n  * \u200d\n  */\n-const math = require('mathjs');\n-const config = require('../../config.js');\n-const fetch = require('node-fetch');\n+\n const AbortController = require('abort-controller');\n+const config = require('../../config');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5846464b84d27d298131537b3155c289ab8a8e56"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE5MTM5OQ==", "bodyText": "This conditional logic seems unnecessary and breaks encapsulation of the maxLimit properties. We should always have a limit set and include that in the query, regardless if it's the global or not. We should default in the code if it's not in config.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1060#discussion_r492191399", "createdAt": "2020-09-21T16:26:29Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/monitoring/monitor_apis/account_tests.js", "diffHunk": "@@ -66,67 +68,65 @@ const checkMandatoryParams = (entry) => {\n  * @param {Object} classResults shared class results object capturing tests for given endpoint\n  */\n const getAccountsWithAccountCheck = async (server, classResults) => {\n-  var currentTestResult = acctestutils.getMonitorTestResult();\n+  const currentTestResult = acctestutils.getMonitorTestResult();\n+\n+  const query = {};\n+  const {maxLimit, isGlobal} = acctestutils.getMaxLimit(resource);\n+  if (!isGlobal) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5846464b84d27d298131537b3155c289ab8a8e56"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5262c1f2d8bf61bfc49089d52d9a8d35b8f0e2f3", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5262c1f2d8bf61bfc49089d52d9a8d35b8f0e2f3", "committedDate": "2020-09-21T18:50:18Z", "message": "refactor, move common functionality to utils\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9fae67d865b29b51cf97b0f70204d86d502c702", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a9fae67d865b29b51cf97b0f70204d86d502c702", "committedDate": "2020-09-21T19:25:41Z", "message": "Merge branch 'monitor-aggregate-http-status-code' into specific-check-config-for-monitor\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1548bd073cf283bfab4569b2183eceb69666292f", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1548bd073cf283bfab4569b2183eceb69666292f", "committedDate": "2020-09-21T21:03:55Z", "message": "- remove dependency on hedera-mirror-rest's config module\n- aggregate http response code from all servers for /status\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f22254db8c8f23e3e114e3e1f15e7aa0a9e8cd1d", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f22254db8c8f23e3e114e3e1f15e7aa0a9e8cd1d", "committedDate": "2020-09-21T21:09:11Z", "message": "return 409 in aggregated status if there is at least one failure\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDM2ODQw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1060#pullrequestreview-493036840", "createdAt": "2020-09-21T22:59:10Z", "commit": {"oid": "f22254db8c8f23e3e114e3e1f15e7aa0a9e8cd1d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDU4OTU0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1060#pullrequestreview-493058954", "createdAt": "2020-09-22T00:04:43Z", "commit": {"oid": "f22254db8c8f23e3e114e3e1f15e7aa0a9e8cd1d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3535, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}