{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyNTk3MzE3", "number": 1075, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxOTo1Mzo0NlrOEnMmIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxOTo1NjoxMVrOEpLqHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTM2Mjg5OnYy", "diffSide": "RIGHT", "path": "docs/configuration.md", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxOTo1Mzo0NlrOHXqYQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxOTowNjo1MFrOHYPYlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU3MzYzMg==", "bodyText": "nit: Redis and general messages not just topic messages\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            | `hedera.mirror.importer.parser.record.entity.redis.enabled`                 | true                    | Whether to use PostgreSQL Notify to send topic messages to the gRPC process                    |\n          \n          \n            \n            | `hedera.mirror.importer.parser.record.entity.redis.enabled`                 | true                    | Whether to use Redis Notify to send messages to the gRPC process                    |", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1075#discussion_r494573632", "createdAt": "2020-09-24T19:53:46Z", "author": {"login": "Nana-EC"}, "path": "docs/configuration.md", "diffHunk": "@@ -81,6 +81,7 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.importer.parser.record.entity.persist.nonFeeTransfers`       | false                   | Persist non-fee transfers for transactions that explicitly request hbar transfers              |\n | `hedera.mirror.importer.parser.record.entity.persist.systemFiles`           | true                    | Persist only system files (number lower than `1000`) to the database                           |\n | `hedera.mirror.importer.parser.record.entity.persist.transactionBytes`      | false                   | Persist raw transaction bytes to the database                                                  |\n+| `hedera.mirror.importer.parser.record.entity.redis.enabled`                 | true                    | Whether to use PostgreSQL Notify to send topic messages to the gRPC process                    |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1211b184fee41fa749fd9631ed278791a8f95d6"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE3OTkyNQ==", "bodyText": "Thanks, updated", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1075#discussion_r495179925", "createdAt": "2020-09-25T19:06:50Z", "author": {"login": "steven-sheehy"}, "path": "docs/configuration.md", "diffHunk": "@@ -81,6 +81,7 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.importer.parser.record.entity.persist.nonFeeTransfers`       | false                   | Persist non-fee transfers for transactions that explicitly request hbar transfers              |\n | `hedera.mirror.importer.parser.record.entity.persist.systemFiles`           | true                    | Persist only system files (number lower than `1000`) to the database                           |\n | `hedera.mirror.importer.parser.record.entity.persist.transactionBytes`      | false                   | Persist raw transaction bytes to the database                                                  |\n+| `hedera.mirror.importer.parser.record.entity.redis.enabled`                 | true                    | Whether to use PostgreSQL Notify to send topic messages to the gRPC process                    |", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU3MzYzMg=="}, "originalCommit": {"oid": "b1211b184fee41fa749fd9631ed278791a8f95d6"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTM3NTk2OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/RedisConfiguration.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxOTo1Nzo0MFrOHXqgUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQyMzoxNTozNVrOHYXV0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU3NTY5OQ==", "bodyText": "Should make this Configuration either entity agnostic or specific to TopicMessages in name i.e. RedisConfiguration <T> or RedisTopicMessageConfiguration\nThis was we have a foundation for reuse when we need to expand what we notify out", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1075#discussion_r494575699", "createdAt": "2020-09-24T19:57:40Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/RedisConfiguration.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package com.hedera.mirror.grpc.config;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import lombok.RequiredArgsConstructor;\n+import org.msgpack.jackson.dataformat.MessagePackFactory;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.data.redis.connection.ReactiveRedisConnectionFactory;\n+import org.springframework.data.redis.core.ReactiveRedisOperations;\n+import org.springframework.data.redis.core.ReactiveRedisTemplate;\n+import org.springframework.data.redis.listener.ReactiveRedisMessageListenerContainer;\n+import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;\n+import org.springframework.data.redis.serializer.RedisSerializationContext;\n+import org.springframework.data.redis.serializer.RedisSerializer;\n+import org.springframework.data.redis.serializer.StringRedisSerializer;\n+\n+import com.hedera.mirror.grpc.domain.TopicMessage;\n+\n+@Configuration\n+@RequiredArgsConstructor\n+public class RedisConfiguration {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1211b184fee41fa749fd9631ed278791a8f95d6"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTMxMDI5MA==", "bodyText": "Made it entity agnostic by introducing a StreamMessage (not sure about the naming) marker interface. So the redis serializers can now serialize anything that implements that interface.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1075#discussion_r495310290", "createdAt": "2020-09-25T23:15:35Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/RedisConfiguration.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package com.hedera.mirror.grpc.config;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import lombok.RequiredArgsConstructor;\n+import org.msgpack.jackson.dataformat.MessagePackFactory;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.data.redis.connection.ReactiveRedisConnectionFactory;\n+import org.springframework.data.redis.core.ReactiveRedisOperations;\n+import org.springframework.data.redis.core.ReactiveRedisTemplate;\n+import org.springframework.data.redis.listener.ReactiveRedisMessageListenerContainer;\n+import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;\n+import org.springframework.data.redis.serializer.RedisSerializationContext;\n+import org.springframework.data.redis.serializer.RedisSerializer;\n+import org.springframework.data.redis.serializer.StringRedisSerializer;\n+\n+import com.hedera.mirror.grpc.domain.TopicMessage;\n+\n+@Configuration\n+@RequiredArgsConstructor\n+public class RedisConfiguration {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU3NTY5OQ=="}, "originalCommit": {"oid": "b1211b184fee41fa749fd9631ed278791a8f95d6"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTM5NTQ0OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/listener/RedisTopicListener.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMDowMzoyOFrOHXqsBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxOTowNTo0NVrOHYPWgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU3ODY5NA==", "bodyText": "Can the log distinguish between Cancelled and Complete subscriptions.\nOr have an OnCancel() and OnComplete() with appropriate log that call unsubscribe()", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1075#discussion_r494578694", "createdAt": "2020-09-24T20:03:28Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/listener/RedisTopicListener.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.hedera.mirror.grpc.listener;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+import org.springframework.data.redis.connection.ReactiveSubscription.Message;\n+import org.springframework.data.redis.listener.ChannelTopic;\n+import org.springframework.data.redis.listener.ReactiveRedisMessageListenerContainer;\n+import org.springframework.data.redis.listener.Topic;\n+import org.springframework.data.redis.serializer.RedisSerializationContext.SerializationPair;\n+import org.springframework.data.redis.serializer.RedisSerializer;\n+import reactor.core.publisher.Flux;\n+import reactor.core.scheduler.Schedulers;\n+import reactor.util.retry.Retry;\n+\n+import com.hedera.mirror.grpc.GrpcProperties;\n+import com.hedera.mirror.grpc.domain.TopicMessage;\n+import com.hedera.mirror.grpc.domain.TopicMessageFilter;\n+\n+@Log4j2\n+@Named\n+public class RedisTopicListener extends SharedTopicListener {\n+\n+    private final GrpcProperties grpcProperties;\n+    private final ReactiveRedisMessageListenerContainer container;\n+    private final SerializationPair<String> channelSerializer;\n+    private final SerializationPair<TopicMessage> messageSerializer;\n+    private final Map<String, Flux<TopicMessage>> topicMessages; // Topic name to active subscription\n+\n+    public RedisTopicListener(GrpcProperties grpcProperties,\n+                              ListenerProperties listenerProperties,\n+                              ReactiveRedisMessageListenerContainer container,\n+                              RedisSerializer<TopicMessage> redisSerializer) {\n+        super(listenerProperties);\n+        this.grpcProperties = grpcProperties;\n+        this.container = container;\n+        this.channelSerializer = SerializationPair.fromSerializer(RedisSerializer.string());\n+        this.messageSerializer = SerializationPair.fromSerializer(redisSerializer);\n+        this.topicMessages = new ConcurrentHashMap<>();\n+    }\n+\n+    @Override\n+    protected Flux<TopicMessage> getSharedListener(TopicMessageFilter filter) {\n+        Topic topic = getTopic(filter);\n+        return topicMessages.computeIfAbsent(topic.getTopic(), key -> subscribe(topic))\n+                .doOnSubscribe(s -> log.info(\"Subscribing: {}\", filter));\n+    }\n+\n+    private Topic getTopic(TopicMessageFilter filter) {\n+        return ChannelTopic.of(String.format(\"topic.%d.%d.%d\",\n+                grpcProperties.getShard(), filter.getRealmNum(), filter.getTopicNum()));\n+    }\n+\n+    private Flux<TopicMessage> subscribe(Topic topic) {\n+        Duration frequency = listenerProperties.getFrequency();\n+\n+        return container.receive(Arrays.asList(topic), channelSerializer, messageSerializer)\n+                .map(Message::getMessage)\n+                .name(\"redis\")\n+                .metrics()\n+                .publishOn(Schedulers.boundedElastic())\n+                .doOnCancel(() -> unsubscribe(topic))\n+                .doOnComplete(() -> unsubscribe(topic))\n+                .doOnError(t -> log.error(\"Error listening for messages\", t))\n+                .doOnSubscribe(s -> log.info(\"Creating shared subscription to {}\", topic))\n+                .retryWhen(Retry.backoff(Long.MAX_VALUE, frequency).maxBackoff(frequency.multipliedBy(4L)))\n+                .share();\n+    }\n+\n+    private void unsubscribe(Topic topic) {\n+        topicMessages.remove(topic.getTopic());\n+        log.info(\"Cancelled shared subscription to {}\", topic);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1211b184fee41fa749fd9631ed278791a8f95d6"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE3OTM5Mw==", "bodyText": "Here it doesn't matter if the flux was cancelled or completed, this log is to denote the subscription status to Redis. As such, I've reworked the log to Unsubscribing from {}.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1075#discussion_r495179393", "createdAt": "2020-09-25T19:05:45Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/listener/RedisTopicListener.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.hedera.mirror.grpc.listener;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+import org.springframework.data.redis.connection.ReactiveSubscription.Message;\n+import org.springframework.data.redis.listener.ChannelTopic;\n+import org.springframework.data.redis.listener.ReactiveRedisMessageListenerContainer;\n+import org.springframework.data.redis.listener.Topic;\n+import org.springframework.data.redis.serializer.RedisSerializationContext.SerializationPair;\n+import org.springframework.data.redis.serializer.RedisSerializer;\n+import reactor.core.publisher.Flux;\n+import reactor.core.scheduler.Schedulers;\n+import reactor.util.retry.Retry;\n+\n+import com.hedera.mirror.grpc.GrpcProperties;\n+import com.hedera.mirror.grpc.domain.TopicMessage;\n+import com.hedera.mirror.grpc.domain.TopicMessageFilter;\n+\n+@Log4j2\n+@Named\n+public class RedisTopicListener extends SharedTopicListener {\n+\n+    private final GrpcProperties grpcProperties;\n+    private final ReactiveRedisMessageListenerContainer container;\n+    private final SerializationPair<String> channelSerializer;\n+    private final SerializationPair<TopicMessage> messageSerializer;\n+    private final Map<String, Flux<TopicMessage>> topicMessages; // Topic name to active subscription\n+\n+    public RedisTopicListener(GrpcProperties grpcProperties,\n+                              ListenerProperties listenerProperties,\n+                              ReactiveRedisMessageListenerContainer container,\n+                              RedisSerializer<TopicMessage> redisSerializer) {\n+        super(listenerProperties);\n+        this.grpcProperties = grpcProperties;\n+        this.container = container;\n+        this.channelSerializer = SerializationPair.fromSerializer(RedisSerializer.string());\n+        this.messageSerializer = SerializationPair.fromSerializer(redisSerializer);\n+        this.topicMessages = new ConcurrentHashMap<>();\n+    }\n+\n+    @Override\n+    protected Flux<TopicMessage> getSharedListener(TopicMessageFilter filter) {\n+        Topic topic = getTopic(filter);\n+        return topicMessages.computeIfAbsent(topic.getTopic(), key -> subscribe(topic))\n+                .doOnSubscribe(s -> log.info(\"Subscribing: {}\", filter));\n+    }\n+\n+    private Topic getTopic(TopicMessageFilter filter) {\n+        return ChannelTopic.of(String.format(\"topic.%d.%d.%d\",\n+                grpcProperties.getShard(), filter.getRealmNum(), filter.getTopicNum()));\n+    }\n+\n+    private Flux<TopicMessage> subscribe(Topic topic) {\n+        Duration frequency = listenerProperties.getFrequency();\n+\n+        return container.receive(Arrays.asList(topic), channelSerializer, messageSerializer)\n+                .map(Message::getMessage)\n+                .name(\"redis\")\n+                .metrics()\n+                .publishOn(Schedulers.boundedElastic())\n+                .doOnCancel(() -> unsubscribe(topic))\n+                .doOnComplete(() -> unsubscribe(topic))\n+                .doOnError(t -> log.error(\"Error listening for messages\", t))\n+                .doOnSubscribe(s -> log.info(\"Creating shared subscription to {}\", topic))\n+                .retryWhen(Retry.backoff(Long.MAX_VALUE, frequency).maxBackoff(frequency.multipliedBy(4L)))\n+                .share();\n+    }\n+\n+    private void unsubscribe(Topic topic) {\n+        topicMessages.remove(topic.getTopic());\n+        log.info(\"Cancelled shared subscription to {}\", topic);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU3ODY5NA=="}, "originalCommit": {"oid": "b1211b184fee41fa749fd9631ed278791a8f95d6"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTQyNjY0OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/config/RedisConfiguration.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMDoxMzoyMFrOHXq_Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQyMzoxNTo0MlrOHYXWHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU4MzY0Nw==", "bodyText": "Same shared configuration note on this one as previously", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1075#discussion_r494583647", "createdAt": "2020-09-24T20:13:20Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/config/RedisConfiguration.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.hedera.mirror.importer.config;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.msgpack.jackson.dataformat.MessagePackFactory;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.data.redis.connection.RedisConnectionFactory;\n+import org.springframework.data.redis.core.RedisOperations;\n+import org.springframework.data.redis.core.RedisTemplate;\n+import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;\n+import org.springframework.data.redis.serializer.RedisSerializer;\n+\n+import com.hedera.mirror.importer.domain.TopicMessage;\n+\n+@Configuration\n+public class RedisConfiguration {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1211b184fee41fa749fd9631ed278791a8f95d6"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTMxMDM2Nw==", "bodyText": "Made it entity agnostic by introducing a StreamMessage (not sure about the naming) marker interface. So the redis serializers can now serialize anything that implements that interface.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1075#discussion_r495310367", "createdAt": "2020-09-25T23:15:42Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/config/RedisConfiguration.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.hedera.mirror.importer.config;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.msgpack.jackson.dataformat.MessagePackFactory;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.data.redis.connection.RedisConnectionFactory;\n+import org.springframework.data.redis.core.RedisOperations;\n+import org.springframework.data.redis.core.RedisTemplate;\n+import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;\n+import org.springframework.data.redis.serializer.RedisSerializer;\n+\n+import com.hedera.mirror.importer.domain.TopicMessage;\n+\n+@Configuration\n+public class RedisConfiguration {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU4MzY0Nw=="}, "originalCommit": {"oid": "b1211b184fee41fa749fd9631ed278791a8f95d6"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTQ0NTM3OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/converter/EntityIdDeserializer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMDoxOToxNlrOHXrK5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxOTowNDo0MFrOHYPUdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU4NjU5Nw==", "bodyText": "The class notes the general EntityId but is only applicable for AccountID.\nThis should probably be renamed to AbstractEntityIdDeserializer, then have an AccountIdDeserializer that extends this and passes in EntityTypeEnum.ACCOUNT\nSimilar to was we do with the EntityIdConverters", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1075#discussion_r494586597", "createdAt": "2020-09-24T20:19:16Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/converter/EntityIdDeserializer.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package com.hedera.mirror.importer.converter;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.fasterxml.jackson.core.JsonParser;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.DeserializationContext;\n+import com.fasterxml.jackson.databind.JsonDeserializer;\n+import java.io.IOException;\n+\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.util.EntityIdEndec;\n+\n+public class EntityIdDeserializer extends JsonDeserializer<EntityId> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1211b184fee41fa749fd9631ed278791a8f95d6"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE3ODg3MQ==", "bodyText": "Renamed to AccountIdDeserializer. We can add an abstract one once we have at least two sub-classes.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1075#discussion_r495178871", "createdAt": "2020-09-25T19:04:40Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/converter/EntityIdDeserializer.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package com.hedera.mirror.importer.converter;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.fasterxml.jackson.core.JsonParser;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.DeserializationContext;\n+import com.fasterxml.jackson.databind.JsonDeserializer;\n+import java.io.IOException;\n+\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.util.EntityIdEndec;\n+\n+public class EntityIdDeserializer extends JsonDeserializer<EntityId> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU4NjU5Nw=="}, "originalCommit": {"oid": "b1211b184fee41fa749fd9631ed278791a8f95d6"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTUwNDE3OnYy", "diffSide": "RIGHT", "path": "docs/configuration.md", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMDozNjo1MFrOHXruqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNzo0MToyNlrOHZJCYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5NTc1Mw==", "bodyText": "Currently we support multiple listener options at the same time, should we consider making a list of enabled listeners e.g.\nhedera.mirror.importer.parser.record.entity.listeners = [REPOSITORY, SQL, PGNOTIFY, REDIS] That way there's no need to add an enabled configuration every time we add a new entity listener, as is the case with  hedera.mirror.importer.parser.record.entity.redis.enabled`", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1075#discussion_r494595753", "createdAt": "2020-09-24T20:36:50Z", "author": {"login": "Nana-EC"}, "path": "docs/configuration.md", "diffHunk": "@@ -81,6 +81,7 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.importer.parser.record.entity.persist.nonFeeTransfers`       | false                   | Persist non-fee transfers for transactions that explicitly request hbar transfers              |\n | `hedera.mirror.importer.parser.record.entity.persist.systemFiles`           | true                    | Persist only system files (number lower than `1000`) to the database                           |\n | `hedera.mirror.importer.parser.record.entity.persist.transactionBytes`      | false                   | Persist raw transaction bytes to the database                                                  |\n+| `hedera.mirror.importer.parser.record.entity.redis.enabled`                 | true                    | Whether to use PostgreSQL Notify to send topic messages to the gRPC process                    |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1211b184fee41fa749fd9631ed278791a8f95d6"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzOTE2Mw==", "bodyText": "It's a good idea, however the enabled flag is not just used in a centralized CompositeEntityListener, but also individually within the concrete EntityListener to see if the batch save should occur. We'd have to inject the EntityProperties to every EntityListener and somehow map the current class to a value within a list.\nAlso, if we have additional properties associated with a concrete EntityListener like maxJsonPayloadSize it makes more sense to have them separate.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1075#discussion_r496039163", "createdAt": "2020-09-28T15:26:10Z", "author": {"login": "steven-sheehy"}, "path": "docs/configuration.md", "diffHunk": "@@ -81,6 +81,7 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.importer.parser.record.entity.persist.nonFeeTransfers`       | false                   | Persist non-fee transfers for transactions that explicitly request hbar transfers              |\n | `hedera.mirror.importer.parser.record.entity.persist.systemFiles`           | true                    | Persist only system files (number lower than `1000`) to the database                           |\n | `hedera.mirror.importer.parser.record.entity.persist.transactionBytes`      | false                   | Persist raw transaction bytes to the database                                                  |\n+| `hedera.mirror.importer.parser.record.entity.redis.enabled`                 | true                    | Whether to use PostgreSQL Notify to send topic messages to the gRPC process                    |", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5NTc1Mw=="}, "originalCommit": {"oid": "b1211b184fee41fa749fd9631ed278791a8f95d6"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEyNDUxNQ==", "bodyText": "Sounds good", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1075#discussion_r496124515", "createdAt": "2020-09-28T17:41:26Z", "author": {"login": "Nana-EC"}, "path": "docs/configuration.md", "diffHunk": "@@ -81,6 +81,7 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.importer.parser.record.entity.persist.nonFeeTransfers`       | false                   | Persist non-fee transfers for transactions that explicitly request hbar transfers              |\n | `hedera.mirror.importer.parser.record.entity.persist.systemFiles`           | true                    | Persist only system files (number lower than `1000`) to the database                           |\n | `hedera.mirror.importer.parser.record.entity.persist.transactionBytes`      | false                   | Persist raw transaction bytes to the database                                                  |\n+| `hedera.mirror.importer.parser.record.entity.redis.enabled`                 | true                    | Whether to use PostgreSQL Notify to send topic messages to the gRPC process                    |", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5NTc1Mw=="}, "originalCommit": {"oid": "b1211b184fee41fa749fd9631ed278791a8f95d6"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNjE4MDc5OnYy", "diffSide": "RIGHT", "path": "docs/configuration.md", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxOTo1NjoxMVrOHatGng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMDoxNjo1MFrOHatv5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc2Mzk5OA==", "bodyText": "Weren't you supposed to leave the default as NOTIFY allowing to be configured to REDIS on demand. Then when you add the Helm stuff then change this to REDIS as default?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1075#discussion_r497763998", "createdAt": "2020-09-30T19:56:11Z", "author": {"login": "Nana-EC"}, "path": "docs/configuration.md", "diffHunk": "@@ -155,12 +156,12 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.grpc.db.username`                            | mirror_grpc      | The username the GRPC API uses to connect to the database                                      |\n | `hedera.mirror.grpc.endTimeInterval`                        | 30s              | How often we should check if a subscription has gone past the end time                         |\n | `hedera.mirror.grpc.entityCacheSize`                        | 50000            | The maximum size of the cache to store entities used for existence check                       |\n-| `hedera.mirror.grpc.listener.bufferTimeout`                 | 4000             | The time in milliseconds to wait for a client to receive all buffered messages after buffer overflow. On timeout, server will send an error |\n+| `hedera.mirror.grpc.listener.bufferTimeout`                 | 4s               | The time to wait for a client to receive all buffered messages after buffer overflow. On timeout, server will send an error. Can accept duration units like `50ms`, `10s`, etc. |\n | `hedera.mirror.grpc.listener.enabled`                       | true             | Whether to listen for incoming massages or not                                                 |\n | `hedera.mirror.grpc.listener.frequency`                     | 500ms            | How often to poll or retry errors (varies by type). Can accept duration units like `50ms`, `10s`, etc. |\n | `hedera.mirror.grpc.listener.maxBufferSize`                 | 16384            | The maximum number of messages the notifying listener or the shared polling listener buffers before sending an error to a client |\n | `hedera.mirror.grpc.listener.maxPageSize`                   | 5000             | The maximum number of messages the listener can return in a single call to the database        |\n-| `hedera.mirror.grpc.listener.type`                          | NOTIFY           | The type of listener to use for incoming messages. Accepts either NOTIFY, POLL or SHARED_POLL  |\n+| `hedera.mirror.grpc.listener.type`                          | REDIS            | The type of listener to use for incoming messages. Accepts either NOTIFY, POLL, REDIS or SHARED_POLL |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8907bf0c911d2f79748a6d5c32cbe4f1d7162bd"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc3NDU2Ng==", "bodyText": "Whoops, fixed.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1075#discussion_r497774566", "createdAt": "2020-09-30T20:16:50Z", "author": {"login": "steven-sheehy"}, "path": "docs/configuration.md", "diffHunk": "@@ -155,12 +156,12 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.grpc.db.username`                            | mirror_grpc      | The username the GRPC API uses to connect to the database                                      |\n | `hedera.mirror.grpc.endTimeInterval`                        | 30s              | How often we should check if a subscription has gone past the end time                         |\n | `hedera.mirror.grpc.entityCacheSize`                        | 50000            | The maximum size of the cache to store entities used for existence check                       |\n-| `hedera.mirror.grpc.listener.bufferTimeout`                 | 4000             | The time in milliseconds to wait for a client to receive all buffered messages after buffer overflow. On timeout, server will send an error |\n+| `hedera.mirror.grpc.listener.bufferTimeout`                 | 4s               | The time to wait for a client to receive all buffered messages after buffer overflow. On timeout, server will send an error. Can accept duration units like `50ms`, `10s`, etc. |\n | `hedera.mirror.grpc.listener.enabled`                       | true             | Whether to listen for incoming massages or not                                                 |\n | `hedera.mirror.grpc.listener.frequency`                     | 500ms            | How often to poll or retry errors (varies by type). Can accept duration units like `50ms`, `10s`, etc. |\n | `hedera.mirror.grpc.listener.maxBufferSize`                 | 16384            | The maximum number of messages the notifying listener or the shared polling listener buffers before sending an error to a client |\n | `hedera.mirror.grpc.listener.maxPageSize`                   | 5000             | The maximum number of messages the listener can return in a single call to the database        |\n-| `hedera.mirror.grpc.listener.type`                          | NOTIFY           | The type of listener to use for incoming messages. Accepts either NOTIFY, POLL or SHARED_POLL  |\n+| `hedera.mirror.grpc.listener.type`                          | REDIS            | The type of listener to use for incoming messages. Accepts either NOTIFY, POLL, REDIS or SHARED_POLL |", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc2Mzk5OA=="}, "originalCommit": {"oid": "f8907bf0c911d2f79748a6d5c32cbe4f1d7162bd"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1497, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}