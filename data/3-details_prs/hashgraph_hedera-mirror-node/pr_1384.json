{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzODA2ODA1", "number": 1384, "title": "Refactor signature file reader", "bodyText": "Detailed description:\nRefactor Signature File Reader logic to be easier to maintain and add new versions to\nWhich issue(s) this PR fixes:\nFixes #1370\nSpecial notes for your reviewer:\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-12-22T01:03:19Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384", "merged": true, "mergeCommit": {"oid": "d8e4ab2f3c0b7e85d4740766e1009aaef6bbbe82"}, "closed": true, "closedAt": "2021-01-04T21:17:02Z", "author": {"login": "ijungmann"}, "timelineItems": {"totalCount": 44, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdodyD8AH2gAyNTQzODA2ODA1OjUzMzA4ZGVkMjY1ODAwODEyNjllZTM0NTA2ZTQ2OTVkNTE3M2M5NzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABds8jn3gFqTU2MTMzMDc0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "53308ded26580081269ee34506e4695d5173c975", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/53308ded26580081269ee34506e4695d5173c975", "committedDate": "2020-12-21T22:36:08Z", "message": "Refactor to make nodeVerifier a bean, and add first draft of SignatureFileReader\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6087fa9a07591ca1312a0d38cb7310367a02c257", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6087fa9a07591ca1312a0d38cb7310367a02c257", "committedDate": "2020-12-22T00:57:09Z", "message": "Fix issues with the signature file reader\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MzE1OTI4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#pullrequestreview-557315928", "createdAt": "2020-12-22T19:26:58Z", "commit": {"oid": "6087fa9a07591ca1312a0d38cb7310367a02c257"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxOToyNjo1OFrOIKGsBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxOTo0Nzo1NFrOIKHRGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ2NjI0NA==", "bodyText": "Mark CompositeSignatureFileReader as @Primary and then can just inject SignatureFileReader here.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547466244", "createdAt": "2020-12-22T19:26:58Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/NodeSignatureVerifier.java", "diffHunk": "@@ -23,36 +23,40 @@\n import com.google.common.collect.HashMultimap;\n import com.google.common.collect.Multimap;\n import com.google.common.collect.Sets;\n+import java.io.BufferedInputStream;\n import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileNotFoundException;\n import java.security.PublicKey;\n import java.security.Signature;\n import java.util.Collection;\n import java.util.Map;\n import java.util.Set;\n import java.util.TreeSet;\n import java.util.stream.Collectors;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n import lombok.extern.log4j.Log4j2;\n import org.apache.commons.lang3.tuple.Pair;\n \n+import com.hedera.mirror.importer.addressbook.AddressBookService;\n import com.hedera.mirror.importer.domain.AddressBook;\n import com.hedera.mirror.importer.domain.AddressBookEntry;\n import com.hedera.mirror.importer.domain.FileStreamSignature;\n import com.hedera.mirror.importer.domain.FileStreamSignature.SignatureStatus;\n import com.hedera.mirror.importer.exception.SignatureVerificationException;\n-import com.hedera.mirror.importer.util.Utility;\n+import com.hedera.mirror.importer.reader.signature.CompositeSignatureFileReader;\n \n+@Named\n @Log4j2\n+@RequiredArgsConstructor\n public class NodeSignatureVerifier {\n \n-    private final Map<String, PublicKey> nodeAccountIDPubKeyMap;\n+    private final AddressBookService addressBookService;\n \n-    public NodeSignatureVerifier(AddressBook currentAddressBook) {\n-        nodeAccountIDPubKeyMap = currentAddressBook\n-                .getEntries()\n-                .stream()\n-                .collect(Collectors\n-                        .toMap(AddressBookEntry::getNodeAccountIdString, AddressBookEntry::getPublicKeyAsObject));\n-    }\n+    private final CompositeSignatureFileReader signatureFileReader;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6087fa9a07591ca1312a0d38cb7310367a02c257"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ2NjU5NA==", "bodyText": "Move to a @Get(lazy = true) transient field in AddressBook.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547466594", "createdAt": "2020-12-22T19:27:24Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/NodeSignatureVerifier.java", "diffHunk": "@@ -72,6 +76,15 @@ private static boolean canReachConsensus(long actualNodes, long expectedNodes) {\n      * @throws SignatureVerificationException\n      */\n     public void verify(Collection<FileStreamSignature> signatures) throws SignatureVerificationException {\n+\n+        AddressBook currentAddressBook = addressBookService.getCurrent();\n+        //TODO cache this based on the id of the address book?\n+        nodeAccountIDPubKeyMap = currentAddressBook", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6087fa9a07591ca1312a0d38cb7310367a02c257"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ2NzQ3NA==", "bodyText": "Using Pair is a code smell. The above isn't the interface in the related ticket:\npublic interface SignatureFileReader {\n  FileStreamSignature read(InputStream inputStream);\n}", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547467474", "createdAt": "2020-12-22T19:29:02Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/signature/SignatureFileReader.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package com.hedera.mirror.importer.reader.signature;/*\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedInputStream;\n+import org.apache.commons.lang3.tuple.Pair;\n+\n+public interface SignatureFileReader {\n+    Pair<byte[], byte[]> read(BufferedInputStream bufferedInputStream);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6087fa9a07591ca1312a0d38cb7310367a02c257"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ2NzU1Mw==", "bodyText": "Needs some newlines", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547467553", "createdAt": "2020-12-22T19:29:12Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/signature/SignatureFileReader.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package com.hedera.mirror.importer.reader.signature;/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6087fa9a07591ca1312a0d38cb7310367a02c257"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ2NzYzMg==", "bodyText": "newlines", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547467632", "createdAt": "2020-12-22T19:29:23Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/signature/CompositeSignatureFileReader.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.hedera.mirror.importer.reader.signature;/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6087fa9a07591ca1312a0d38cb7310367a02c257"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ2OTI3Nw==", "bodyText": "Let's remove the switch statement and parse them in the order they're supposed to show up in the file. Technically the switch would allow invalid files that had signatures and hashes in the wrong order.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547469277", "createdAt": "2020-12-22T19:33:10Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/signature/SignatureFileReaderV2.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package com.hedera.mirror.importer.reader.signature;/*\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedInputStream;\n+import java.io.DataInputStream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+import org.apache.commons.lang3.tuple.Pair;\n+\n+import com.hedera.mirror.importer.util.FileDelimiter;\n+\n+@Log4j2\n+@Named\n+public class SignatureFileReaderV2 implements SignatureFileReader {\n+    @Override\n+    public Pair<byte[], byte[]> read(BufferedInputStream bufferedInputStream) {\n+        byte[] sig = null;\n+\n+        try (DataInputStream dis = new DataInputStream(bufferedInputStream)) {\n+            byte[] fileHash = new byte[48];\n+\n+            while (dis.available() != 0) {\n+                byte typeDelimiter = dis.readByte();\n+\n+                switch (typeDelimiter) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6087fa9a07591ca1312a0d38cb7310367a02c257"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ3MjEwMg==", "bodyText": "Should be a constant for hash size", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547472102", "createdAt": "2020-12-22T19:38:52Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/signature/SignatureFileReaderV2.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package com.hedera.mirror.importer.reader.signature;/*\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedInputStream;\n+import java.io.DataInputStream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+import org.apache.commons.lang3.tuple.Pair;\n+\n+import com.hedera.mirror.importer.util.FileDelimiter;\n+\n+@Log4j2\n+@Named\n+public class SignatureFileReaderV2 implements SignatureFileReader {\n+    @Override\n+    public Pair<byte[], byte[]> read(BufferedInputStream bufferedInputStream) {\n+        byte[] sig = null;\n+\n+        try (DataInputStream dis = new DataInputStream(bufferedInputStream)) {\n+            byte[] fileHash = new byte[48];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6087fa9a07591ca1312a0d38cb7310367a02c257"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ3MjE3OQ==", "bodyText": "These constants should be moved to this class. FileDelimiter needs to be deleted depending on who's PR gets merged first.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547472179", "createdAt": "2020-12-22T19:39:04Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/signature/SignatureFileReaderV2.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package com.hedera.mirror.importer.reader.signature;/*\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedInputStream;\n+import java.io.DataInputStream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+import org.apache.commons.lang3.tuple.Pair;\n+\n+import com.hedera.mirror.importer.util.FileDelimiter;\n+\n+@Log4j2\n+@Named\n+public class SignatureFileReaderV2 implements SignatureFileReader {\n+    @Override\n+    public Pair<byte[], byte[]> read(BufferedInputStream bufferedInputStream) {\n+        byte[] sig = null;\n+\n+        try (DataInputStream dis = new DataInputStream(bufferedInputStream)) {\n+            byte[] fileHash = new byte[48];\n+\n+            while (dis.available() != 0) {\n+                byte typeDelimiter = dis.readByte();\n+\n+                switch (typeDelimiter) {\n+                    case FileDelimiter.SIGNATURE_TYPE_FILE_HASH:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6087fa9a07591ca1312a0d38cb7310367a02c257"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ3Mzk4OA==", "bodyText": "The first int from the file is actually a marker with the value 4 so we should be more accepting of things until then. We should probably use an if less than equal to 4 then use V2. Otherwise throw an unsupported error. There might actually be a v1 floating around somewhere as well but it should use the same format.\nShould add a comment explaining about why a value of 4 indicates v2.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547473988", "createdAt": "2020-12-22T19:43:41Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/signature/CompositeSignatureFileReader.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.hedera.mirror.importer.reader.signature;/*\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedInputStream;\n+import java.io.DataInputStream;\n+import java.io.IOException;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.apache.commons.lang3.tuple.Pair;\n+\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class CompositeSignatureFileReader implements SignatureFileReader {\n+\n+    private final SignatureFileReaderV2 signatureFileReaderV2;\n+\n+    @Override\n+    public Pair<byte[], byte[]> read(BufferedInputStream bufferedInputStream) {\n+\n+        try (DataInputStream dataInputStream =\n+                     new DataInputStream(bufferedInputStream)) {\n+            dataInputStream.mark(Integer.BYTES);\n+            int version = dataInputStream.readInt();\n+            dataInputStream.reset();\n+            switch (version) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6087fa9a07591ca1312a0d38cb7310367a02c257"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ3NDIxMg==", "bodyText": "Reader invocation should be done once at the bottom generically for all types.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547474212", "createdAt": "2020-12-22T19:44:12Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/signature/CompositeSignatureFileReader.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.hedera.mirror.importer.reader.signature;/*\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedInputStream;\n+import java.io.DataInputStream;\n+import java.io.IOException;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.apache.commons.lang3.tuple.Pair;\n+\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class CompositeSignatureFileReader implements SignatureFileReader {\n+\n+    private final SignatureFileReaderV2 signatureFileReaderV2;\n+\n+    @Override\n+    public Pair<byte[], byte[]> read(BufferedInputStream bufferedInputStream) {\n+\n+        try (DataInputStream dataInputStream =\n+                     new DataInputStream(bufferedInputStream)) {\n+            dataInputStream.mark(Integer.BYTES);\n+            int version = dataInputStream.readInt();\n+            dataInputStream.reset();\n+            switch (version) {\n+                default:\n+                    return signatureFileReaderV2.read(bufferedInputStream);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6087fa9a07591ca1312a0d38cb7310367a02c257"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ3NTE2MA==", "bodyText": "We shouldn't leak details of using BufferedInputStream to clients. Clients should pass InputStream and BufferedInputStream should be opened here. Javadocs on interface should indicate that read() will close the inputstream so try with resources by the client isn't necessary.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547475160", "createdAt": "2020-12-22T19:46:29Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/signature/CompositeSignatureFileReader.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.hedera.mirror.importer.reader.signature;/*\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedInputStream;\n+import java.io.DataInputStream;\n+import java.io.IOException;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.apache.commons.lang3.tuple.Pair;\n+\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class CompositeSignatureFileReader implements SignatureFileReader {\n+\n+    private final SignatureFileReaderV2 signatureFileReaderV2;\n+\n+    @Override\n+    public Pair<byte[], byte[]> read(BufferedInputStream bufferedInputStream) {\n+\n+        try (DataInputStream dataInputStream =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6087fa9a07591ca1312a0d38cb7310367a02c257"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ3NTczNw==", "bodyText": "On other PR I mentioned a Utility.openQuietly(File) that might be useful to add to not cause IOException be handled.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547475737", "createdAt": "2020-12-22T19:47:54Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/NodeSignatureVerifier.java", "diffHunk": "@@ -85,7 +98,14 @@ public void verify(Collection<FileStreamSignature> signatures) throws SignatureV\n         }\n \n         for (FileStreamSignature fileStreamSignature : signatures) {\n-            Pair<byte[], byte[]> hashAndSig = Utility.extractHashAndSigFromFile(fileStreamSignature.getFile());\n+//            Pair<byte[], byte[]> hashAndSig = Utility.extractHashAndSigFromFile(fileStreamSignature.getFile());\n+            Pair<byte[], byte[]> hashAndSig = null;\n+            try {\n+                hashAndSig = signatureFileReader\n+                        .read(new BufferedInputStream(new FileInputStream(fileStreamSignature.getFile())));\n+            } catch (FileNotFoundException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6087fa9a07591ca1312a0d38cb7310367a02c257"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MzI4MjU2", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#pullrequestreview-557328256", "createdAt": "2020-12-22T19:49:03Z", "commit": {"oid": "6087fa9a07591ca1312a0d38cb7310367a02c257"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cac0b5da5734e6e20300aa52ba2dca72fd0a62e", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9cac0b5da5734e6e20300aa52ba2dca72fd0a62e", "committedDate": "2020-12-22T20:31:15Z", "message": "Refactoring and getting rid of logging todos\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e093f2114fac1f09d0463d1cdfaf06c016bcab45", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e093f2114fac1f09d0463d1cdfaf06c016bcab45", "committedDate": "2020-12-22T22:11:15Z", "message": "Refactor and PR comment\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "caad439a13fd8ec150cddfd3abad722205a0ba8c", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/caad439a13fd8ec150cddfd3abad722205a0ba8c", "committedDate": "2020-12-22T22:37:32Z", "message": "Add transient attribute to AddressBook\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3NDA3NDg3", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#pullrequestreview-557407487", "createdAt": "2020-12-22T22:40:05Z", "commit": {"oid": "caad439a13fd8ec150cddfd3abad722205a0ba8c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQyMjo0MDowNVrOIKLR2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQyMjo0MDowNVrOIKLR2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU0MTQ2Ng==", "bodyText": "This should be a local variable", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547541466", "createdAt": "2020-12-22T22:40:05Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/NodeSignatureVerifier.java", "diffHunk": "@@ -72,6 +73,11 @@ private static boolean canReachConsensus(long actualNodes, long expectedNodes) {\n      * @throws SignatureVerificationException\n      */\n     public void verify(Collection<FileStreamSignature> signatures) throws SignatureVerificationException {\n+\n+        AddressBook currentAddressBook = addressBookService.getCurrent();\n+        //TODO This may need to move out of an attribute and be passed around.\n+        nodeAccountIDPubKeyMap = currentAddressBook.getNodeAccountIDPubKeyMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "caad439a13fd8ec150cddfd3abad722205a0ba8c"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c16ed03c26e07a39db3086638110b09765f94c0", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/7c16ed03c26e07a39db3086638110b09765f94c0", "committedDate": "2020-12-22T22:55:05Z", "message": "Add new exception and clear up composite code\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b226ea61b396f6809c2e2a5280a81ed7f0eba6d9", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b226ea61b396f6809c2e2a5280a81ed7f0eba6d9", "committedDate": "2020-12-22T22:59:50Z", "message": "Remove old method and static values\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d81a80c39beced1bb8a26f37d38de8015c79c1ec", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d81a80c39beced1bb8a26f37d38de8015c79c1ec", "committedDate": "2020-12-22T23:01:52Z", "message": "Make hash size constant\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b475172147477313bff58a762021b9c6d0e6c0f", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1b475172147477313bff58a762021b9c6d0e6c0f", "committedDate": "2020-12-22T23:16:24Z", "message": "First pass at making sig file parser v2 less forgiving\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac669ab0b803536fd7792198e881c67d7a18fca1", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ac669ab0b803536fd7792198e881c67d7a18fca1", "committedDate": "2020-12-22T23:18:28Z", "message": "Fix license\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c9cafab04b025dd5dc53e07962f1b6a5ac66107", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3c9cafab04b025dd5dc53e07962f1b6a5ac66107", "committedDate": "2020-12-23T00:12:13Z", "message": "Move sig file parsing to immediately after download\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca92a6985e432db794bffc4a46b514fbc8b5d159", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ca92a6985e432db794bffc4a46b514fbc8b5d159", "committedDate": "2020-12-23T00:13:24Z", "message": "Remove TODO\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3NjA2NjEw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#pullrequestreview-557606610", "createdAt": "2020-12-23T04:36:00Z", "commit": {"oid": "ca92a6985e432db794bffc4a46b514fbc8b5d159"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwNDozNjowMFrOIKQ9KA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwNDo1MTo1MlrOIKRKjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYzNDQ3Mg==", "bodyText": "It seems FileStreamSignature.status of PARSED is no longer relevant and can be removed.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547634472", "createdAt": "2020-12-23T04:36:00Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -238,19 +247,25 @@ protected void downloadNextBatch() {\n                     }\n \n                     /*\n-                     * With the list of pending downloads - wait for them to complete and add them to the list\n-                     * of downloaded signature files.\n+                     * With the list of pending downloads - wait for them to complete, parse them,  and add them to\n+                     * the list of signature files.\n                      */\n                     AtomicLong count = new AtomicLong();\n                     pendingDownloads.forEach(pendingDownload -> {\n                         try {\n                             if (pendingDownload.waitForCompletion()) {\n-                                count.incrementAndGet();\n                                 File sigFile = pendingDownload.getFile();\n-                                FileStreamSignature fileStreamSignature = new FileStreamSignature();\n-                                fileStreamSignature.setFile(sigFile);\n-                                fileStreamSignature.setNodeAccountId(nodeAccountId);\n-                                sigFilesMap.put(sigFile.getName(), fileStreamSignature);\n+                                try {\n+                                    InputStream inputStream = Utility.openQuietly(sigFile);\n+                                    FileStreamSignature fileStreamSignature = signatureFileReader.read(inputStream);\n+                                    fileStreamSignature.setFile(sigFile);\n+                                    fileStreamSignature.setNodeAccountId(nodeAccountId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca92a6985e432db794bffc4a46b514fbc8b5d159"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYzNTQ2Mg==", "bodyText": "Should be using the constant from SignatureFileReaderV2", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547635462", "createdAt": "2020-12-23T04:40:13Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/signature/CompositeSignatureFileReader.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package com.hedera.mirror.importer.reader.signature;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedInputStream;\n+import java.io.DataInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.springframework.context.annotation.Primary;\n+\n+import com.hedera.mirror.importer.domain.FileStreamSignature;\n+import com.hedera.mirror.importer.exception.SignatureFileParsingException;\n+\n+@Log4j2\n+@Named\n+@Primary\n+@RequiredArgsConstructor\n+public class CompositeSignatureFileReader implements SignatureFileReader {\n+\n+    private final SignatureFileReaderV2 signatureFileReaderV2;\n+\n+    @Override\n+    public FileStreamSignature read(InputStream inputStream) {\n+\n+        try (DataInputStream dataInputStream =\n+                     new DataInputStream(new BufferedInputStream(inputStream))) {\n+            dataInputStream.mark(Byte.BYTES);\n+            byte version = dataInputStream.readByte();\n+            dataInputStream.reset();\n+            SignatureFileReader fileReader;\n+            // Version 2 of the signature file begins with a byte of value 4.\n+            if (version <= 4) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca92a6985e432db794bffc4a46b514fbc8b5d159"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYzNTU5OA==", "bodyText": "Javadocs need adjusting", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547635598", "createdAt": "2020-12-23T04:41:01Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/signature/SignatureFileReader.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package com.hedera.mirror.importer.reader.signature;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.InputStream;\n+\n+import com.hedera.mirror.importer.domain.FileStreamSignature;\n+\n+public interface SignatureFileReader {\n+    /**\n+     * 1. Extract the Hash of the content of corresponding RecordStream file. This Hash is the signed Content of this\n+     * signature 2. Extract signature from the file.\n+     *\n+     * @param signatureFileData The input stream from a signature file to read\n+     * @return Pair of byte arrays, the left holding the file hash and the right the signature", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca92a6985e432db794bffc4a46b514fbc8b5d159"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYzNjQyOA==", "bodyText": "Shouldn't this throw the signature parse exception you added?\nAlso, the error message is not really accurate nor does it include the actual value. The old string seemed good enough to me: \"Unable to read signature file hash\". Would just add the actual value received.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547636428", "createdAt": "2020-12-23T04:45:11Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/signature/SignatureFileReaderV2.java", "diffHunk": "@@ -0,0 +1,75 @@\n+package com.hedera.mirror.importer.reader.signature;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedInputStream;\n+import java.io.DataInputStream;\n+import java.io.InputStream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.FileStreamSignature;\n+import com.hedera.mirror.importer.exception.SignatureFileParsingException;\n+\n+@Log4j2\n+@Named\n+public class SignatureFileReaderV2 implements SignatureFileReader {\n+\n+    private static final byte SIGNATURE_TYPE_SIGNATURE = 3; // the file content signature, should not be hashed\n+    public static final byte SIGNATURE_TYPE_FILE_HASH = 4; // next 48 bytes are SHA-384 of content of record file\n+    public static final byte HASH_SIZE = 48; // the size of the hash\n+\n+    @Override\n+    public FileStreamSignature read(InputStream inputStream) {\n+        FileStreamSignature fileStreamSignature = new FileStreamSignature();\n+\n+        try (DataInputStream dis = new DataInputStream(new BufferedInputStream(inputStream))) {\n+            byte[] fileHash = new byte[HASH_SIZE];\n+\n+            byte typeDelimiter = dis.readByte();\n+            if (typeDelimiter != SIGNATURE_TYPE_FILE_HASH) {\n+                throw new IllegalArgumentException(\"Signature file hash not in correct position\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca92a6985e432db794bffc4a46b514fbc8b5d159"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYzNjUwOA==", "bodyText": "Should add the actual size received and use the signature parse exception", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547636508", "createdAt": "2020-12-23T04:45:34Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/signature/SignatureFileReaderV2.java", "diffHunk": "@@ -0,0 +1,75 @@\n+package com.hedera.mirror.importer.reader.signature;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedInputStream;\n+import java.io.DataInputStream;\n+import java.io.InputStream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.FileStreamSignature;\n+import com.hedera.mirror.importer.exception.SignatureFileParsingException;\n+\n+@Log4j2\n+@Named\n+public class SignatureFileReaderV2 implements SignatureFileReader {\n+\n+    private static final byte SIGNATURE_TYPE_SIGNATURE = 3; // the file content signature, should not be hashed\n+    public static final byte SIGNATURE_TYPE_FILE_HASH = 4; // next 48 bytes are SHA-384 of content of record file\n+    public static final byte HASH_SIZE = 48; // the size of the hash\n+\n+    @Override\n+    public FileStreamSignature read(InputStream inputStream) {\n+        FileStreamSignature fileStreamSignature = new FileStreamSignature();\n+\n+        try (DataInputStream dis = new DataInputStream(new BufferedInputStream(inputStream))) {\n+            byte[] fileHash = new byte[HASH_SIZE];\n+\n+            byte typeDelimiter = dis.readByte();\n+            if (typeDelimiter != SIGNATURE_TYPE_FILE_HASH) {\n+                throw new IllegalArgumentException(\"Signature file hash not in correct position\");\n+            }\n+            int length = dis.read(fileHash);\n+            if (length != fileHash.length) {\n+                throw new IllegalArgumentException(\"Unable to read signature file hash\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca92a6985e432db794bffc4a46b514fbc8b5d159"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYzNzMyMA==", "bodyText": "Shouldn't reuse variables", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547637320", "createdAt": "2020-12-23T04:49:02Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/signature/SignatureFileReaderV2.java", "diffHunk": "@@ -0,0 +1,75 @@\n+package com.hedera.mirror.importer.reader.signature;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedInputStream;\n+import java.io.DataInputStream;\n+import java.io.InputStream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.FileStreamSignature;\n+import com.hedera.mirror.importer.exception.SignatureFileParsingException;\n+\n+@Log4j2\n+@Named\n+public class SignatureFileReaderV2 implements SignatureFileReader {\n+\n+    private static final byte SIGNATURE_TYPE_SIGNATURE = 3; // the file content signature, should not be hashed\n+    public static final byte SIGNATURE_TYPE_FILE_HASH = 4; // next 48 bytes are SHA-384 of content of record file\n+    public static final byte HASH_SIZE = 48; // the size of the hash\n+\n+    @Override\n+    public FileStreamSignature read(InputStream inputStream) {\n+        FileStreamSignature fileStreamSignature = new FileStreamSignature();\n+\n+        try (DataInputStream dis = new DataInputStream(new BufferedInputStream(inputStream))) {\n+            byte[] fileHash = new byte[HASH_SIZE];\n+\n+            byte typeDelimiter = dis.readByte();\n+            if (typeDelimiter != SIGNATURE_TYPE_FILE_HASH) {\n+                throw new IllegalArgumentException(\"Signature file hash not in correct position\");\n+            }\n+            int length = dis.read(fileHash);\n+            if (length != fileHash.length) {\n+                throw new IllegalArgumentException(\"Unable to read signature file hash\");\n+            }\n+            fileStreamSignature.setHash(fileHash);\n+\n+            typeDelimiter = dis.readByte();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca92a6985e432db794bffc4a46b514fbc8b5d159"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYzNzkwMg==", "bodyText": "Why are we wrapping the exceptions we throw? We should throw SignatureFileParsingException everywhere and probably only catch IOException and rethrow here.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r547637902", "createdAt": "2020-12-23T04:51:52Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/signature/SignatureFileReaderV2.java", "diffHunk": "@@ -0,0 +1,75 @@\n+package com.hedera.mirror.importer.reader.signature;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedInputStream;\n+import java.io.DataInputStream;\n+import java.io.InputStream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.FileStreamSignature;\n+import com.hedera.mirror.importer.exception.SignatureFileParsingException;\n+\n+@Log4j2\n+@Named\n+public class SignatureFileReaderV2 implements SignatureFileReader {\n+\n+    private static final byte SIGNATURE_TYPE_SIGNATURE = 3; // the file content signature, should not be hashed\n+    public static final byte SIGNATURE_TYPE_FILE_HASH = 4; // next 48 bytes are SHA-384 of content of record file\n+    public static final byte HASH_SIZE = 48; // the size of the hash\n+\n+    @Override\n+    public FileStreamSignature read(InputStream inputStream) {\n+        FileStreamSignature fileStreamSignature = new FileStreamSignature();\n+\n+        try (DataInputStream dis = new DataInputStream(new BufferedInputStream(inputStream))) {\n+            byte[] fileHash = new byte[HASH_SIZE];\n+\n+            byte typeDelimiter = dis.readByte();\n+            if (typeDelimiter != SIGNATURE_TYPE_FILE_HASH) {\n+                throw new IllegalArgumentException(\"Signature file hash not in correct position\");\n+            }\n+            int length = dis.read(fileHash);\n+            if (length != fileHash.length) {\n+                throw new IllegalArgumentException(\"Unable to read signature file hash\");\n+            }\n+            fileStreamSignature.setHash(fileHash);\n+\n+            typeDelimiter = dis.readByte();\n+            if (typeDelimiter != SIGNATURE_TYPE_SIGNATURE) {\n+                throw new IllegalArgumentException(\"Signature file signature not in correct position\");\n+            }\n+            int sigLength = dis.readInt();\n+            byte[] sigBytes = new byte[sigLength];\n+            dis.readFully(sigBytes);\n+            fileStreamSignature.setSignature(sigBytes);\n+\n+            if (dis.available() != 0) {\n+                throw new IllegalArgumentException(\"Extra data discovered in signature file\");\n+            }\n+\n+            return fileStreamSignature;\n+        } catch (Exception e) {\n+            throw new SignatureFileParsingException(\"Exception occurred reading signature file\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca92a6985e432db794bffc4a46b514fbc8b5d159"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4a748ddea7ebe862b9a515bfb90cabc9ea1d67e", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f4a748ddea7ebe862b9a515bfb90cabc9ea1d67e", "committedDate": "2020-12-23T06:20:19Z", "message": "Remove FileRecordStream.PARSED\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a8f832f69025a529904580654b1bb1d5d2968b2", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8a8f832f69025a529904580654b1bb1d5d2968b2", "committedDate": "2020-12-23T06:21:23Z", "message": "Make CompositeFileReader use v2 constant\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9888ca42d4d21d43b1e5b72605a2fb64dc5371ca", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9888ca42d4d21d43b1e5b72605a2fb64dc5371ca", "committedDate": "2020-12-23T06:22:54Z", "message": "Fix JavaDocs\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9af66e76a022d6d791215511d9fbba793958b36f", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9af66e76a022d6d791215511d9fbba793958b36f", "committedDate": "2020-12-23T06:23:57Z", "message": "PR Comments for file reader v2\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f493f23415fc404348338b271b16507ba684809", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5f493f23415fc404348338b271b16507ba684809", "committedDate": "2020-12-23T06:25:12Z", "message": "Typo in v2 exception message\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3426ec0b31285bcafff7fa23974f647838ba1b7", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d3426ec0b31285bcafff7fa23974f647838ba1b7", "committedDate": "2020-12-23T06:28:25Z", "message": "Remove TODO\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4763e51a5d4697daf9ba8b79ea40f6d806c6cc2", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a4763e51a5d4697daf9ba8b79ea40f6d806c6cc2", "committedDate": "2020-12-23T06:30:46Z", "message": "Remove unused variable\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "746626ea76509037c6058cf809183ae591debd8c", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/746626ea76509037c6058cf809183ae591debd8c", "committedDate": "2020-12-23T06:40:43Z", "message": "Refactor Dowmnloader to get rid of nested tries\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MTc2Njc3", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#pullrequestreview-558176677", "createdAt": "2020-12-23T18:58:24Z", "commit": {"oid": "746626ea76509037c6058cf809183ae591debd8c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MjM0NzU0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#pullrequestreview-558234754", "createdAt": "2020-12-23T21:24:23Z", "commit": {"oid": "746626ea76509037c6058cf809183ae591debd8c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a14bee495a2772d1d4950e57f01a247c5098b47e", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a14bee495a2772d1d4950e57f01a247c5098b47e", "committedDate": "2021-01-04T04:22:35Z", "message": "Add tests for Composite and V2 Signature file reader\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dd67f236e8693dbce256a6c2751b58123fbeebf", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2dd67f236e8693dbce256a6c2751b58123fbeebf", "committedDate": "2021-01-04T04:23:20Z", "message": "Add v2 signature file for tests\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0418eb4339ecbce6c29a9c809e7fde1ac9aba0cf", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0418eb4339ecbce6c29a9c809e7fde1ac9aba0cf", "committedDate": "2021-01-04T04:27:21Z", "message": "Rename signature file superclass to abstract\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c49f56282ec47725559f2aa536beaf3b535a36f", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8c49f56282ec47725559f2aa536beaf3b535a36f", "committedDate": "2021-01-04T04:42:50Z", "message": "Refactor and code smells\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "790ad680e4f984a5eed8e8edf77cc2faec73e977", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/790ad680e4f984a5eed8e8edf77cc2faec73e977", "committedDate": "2021-01-04T04:43:34Z", "message": "Code smells\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de9c2a9fdee653722bda1d5b09e190d6ffad42bd", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/de9c2a9fdee653722bda1d5b09e190d6ffad42bd", "committedDate": "2021-01-04T04:44:09Z", "message": "Code smells\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9293ccd3ee6fb23f8d14a5fd05b9a03c217695f4", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9293ccd3ee6fb23f8d14a5fd05b9a03c217695f4", "committedDate": "2021-01-04T04:49:18Z", "message": "Fix license\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMTQ3Mzgy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#pullrequestreview-561147382", "createdAt": "2021-01-04T16:07:06Z", "commit": {"oid": "9293ccd3ee6fb23f8d14a5fd05b9a03c217695f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNjowNzowNlrOIN3WQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNjowNzowNlrOIN3WQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQwOTIxNg==", "bodyText": "Shouldn't extend ParserException as signature file reading occurs during download phase. Can just extend ImporterException and only implement constructors that are used. This will also help address a code smell.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r551409216", "createdAt": "2021-01-04T16:07:06Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/exception/SignatureFileParsingException.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package com.hedera.mirror.importer.exception;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+public class SignatureFileParsingException extends ParserException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9293ccd3ee6fb23f8d14a5fd05b9a03c217695f4"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMTQ5NTc5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#pullrequestreview-561149579", "createdAt": "2021-01-04T16:09:37Z", "commit": {"oid": "9293ccd3ee6fb23f8d14a5fd05b9a03c217695f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNjowOTozN1rOIN3b9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNjowOTozN1rOIN3b9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQxMDY3OA==", "bodyText": "Don't have to write to a file since input can just be a ByteArrayInputStream.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r551410678", "createdAt": "2021-01-04T16:09:37Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/reader/signature/SignatureFileReaderV2Test.java", "diffHunk": "@@ -0,0 +1,133 @@\n+package com.hedera.mirror.importer.reader.signature;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertThrows;\n+import static org.junit.Assert.assertTrue;\n+\n+import com.google.common.primitives.Bytes;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.Arrays;\n+import javax.annotation.Resource;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Value;\n+\n+import com.hedera.mirror.importer.domain.FileStreamSignature;\n+import com.hedera.mirror.importer.exception.SignatureFileParsingException;\n+\n+class SignatureFileReaderV2Test extends AbstractSignatureFileReaderTest {\n+\n+    @Value(\"classpath:data/signature/v2/2019-08-30T18_10_00.419072Z.rcd_sig\")\n+    private File signatureFile;\n+\n+    @Resource\n+    SignatureFileReaderV2 fileReaderV2;\n+\n+    @Test\n+    void testReadValidFile() throws IOException {\n+        try (InputStream stream = getInputStream(signatureFile)) {\n+            FileStreamSignature answer = fileReaderV2.read(stream);\n+            assertNotNull(answer);\n+            assertNotNull(answer.getSignature());\n+            assertNotNull(answer.getHash());\n+        }\n+    }\n+\n+    @Test\n+    void testReadBlankFile() throws IOException {\n+        try (InputStream stream = getInputStream(createTempFile())) {\n+            SignatureFileParsingException exception = assertThrows(SignatureFileParsingException.class, () -> {\n+                fileReaderV2.read(stream);\n+            });\n+            assertTrue(exception.getCause() instanceof IOException);\n+        }\n+    }\n+\n+    @Test\n+    void testReadFileWithExtraData() throws IOException {\n+        File testFile = createTempFile();\n+        byte[] bytes = FileUtils.readFileToByteArray(signatureFile);\n+        byte[] extraBytes = \"extra\".getBytes();\n+        byte[] newFileBytes = Bytes.concat(bytes, extraBytes);\n+        FileUtils.writeByteArrayToFile(testFile, newFileBytes);\n+        try (InputStream stream = getInputStream(testFile)) {\n+            SignatureFileParsingException exception = assertThrows(SignatureFileParsingException.class, () -> {\n+                fileReaderV2.read(stream);\n+            });\n+            assertTrue(exception.getMessage().contains(\"Extra data discovered in signature file\"));\n+        }\n+    }\n+\n+    @Test\n+    void testReadFileHashWrongDelimiter() throws IOException {\n+        File testFile = createTempFile();\n+        byte[] bytes = FileUtils.readFileToByteArray(signatureFile);\n+        byte[] invalidDelimiter = {1};\n+        byte[] newFileBytes = Bytes.concat(invalidDelimiter, bytes);\n+        FileUtils.writeByteArrayToFile(testFile, newFileBytes);\n+        try (InputStream stream = getInputStream(testFile)) {\n+            SignatureFileParsingException exception = assertThrows(SignatureFileParsingException.class, () -> {\n+                fileReaderV2.read(stream);\n+            });\n+            assertTrue(exception.getMessage()\n+                    .contains(\"Unable to read signature file hash: type delimiter \" + invalidDelimiter[0]));\n+        }\n+    }\n+\n+    @Test\n+    void testReadFileHashTooShort() throws IOException {\n+        File testFile = createTempFile();\n+        byte[] bytes = FileUtils.readFileToByteArray(signatureFile);\n+        //Creating a file with only the first 47 bytes of the original (one less than the expected hash length)\n+        byte[] shortenedBytes = Arrays.copyOfRange(bytes, 0, 48);\n+        FileUtils.writeByteArrayToFile(testFile, shortenedBytes);\n+        try (InputStream stream = getInputStream(testFile)) {\n+            SignatureFileParsingException exception = assertThrows(SignatureFileParsingException.class, () -> {\n+                fileReaderV2.read(stream);\n+            });\n+            assertTrue(exception.getMessage()\n+                    .contains(\"Unable to read signature file hash: hash length 47\"));\n+        }\n+    }\n+\n+    @Test\n+    void testReadFileSignatureWrongDelimiter() throws IOException {\n+        File testFile = createTempFile();\n+        byte[] bytes = FileUtils.readFileToByteArray(signatureFile);\n+        byte[] invalidDelimiter = {1};\n+        byte[] hashBytes = Arrays.copyOfRange(bytes, 0, 49);\n+        byte[] signatureBytes = Arrays.copyOfRange(bytes, 50, bytes.length);\n+\n+        byte[] newFileBytes = Bytes.concat(hashBytes, invalidDelimiter, signatureBytes);\n+        FileUtils.writeByteArrayToFile(testFile, newFileBytes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9293ccd3ee6fb23f8d14a5fd05b9a03c217695f4"}, "originalPosition": 124}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMTM1NTI5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#pullrequestreview-561135529", "createdAt": "2021-01-04T15:50:56Z", "commit": {"oid": "9293ccd3ee6fb23f8d14a5fd05b9a03c217695f4"}, "state": "DISMISSED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNTo1MDo1NlrOIN2vQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNjowMjo0N1rOIN3MRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM5OTIzMw==", "bodyText": "nit: format", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r551399233", "createdAt": "2021-01-04T15:50:56Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -238,19 +246,20 @@ protected void downloadNextBatch() {\n                     }\n \n                     /*\n-                     * With the list of pending downloads - wait for them to complete and add them to the list\n-                     * of downloaded signature files.\n+                     * With the list of pending downloads - wait for them to complete, parse them,  and add them to\n+                     * the list of signature files.\n                      */\n                     AtomicLong count = new AtomicLong();\n                     pendingDownloads.forEach(pendingDownload -> {\n                         try {\n                             if (pendingDownload.waitForCompletion()) {\n-                                count.incrementAndGet();\n-                                File sigFile = pendingDownload.getFile();\n-                                FileStreamSignature fileStreamSignature = new FileStreamSignature();\n-                                fileStreamSignature.setFile(sigFile);\n-                                fileStreamSignature.setNodeAccountId(nodeAccountId);\n-                                sigFilesMap.put(sigFile.getName(), fileStreamSignature);\n+                                FileStreamSignature fileStreamSignature = parseSignatureFile(nodeAccountId,\n+                                        pendingDownload\n+                                                .getFile());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9293ccd3ee6fb23f8d14a5fd05b9a03c217695f4"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQwMDM4NQ==", "bodyText": "nit: can just catch ImporterException", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r551400385", "createdAt": "2021-01-04T15:52:50Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/downloader/Downloader.java", "diffHunk": "@@ -279,6 +288,19 @@ protected void downloadNextBatch() {\n         return sigFilesMap;\n     }\n \n+    private FileStreamSignature parseSignatureFile(EntityId nodeAccountId, File sigFile) {\n+        try {\n+            InputStream inputStream = Utility.openQuietly(sigFile);\n+            FileStreamSignature fileStreamSignature = signatureFileReader.read(inputStream);\n+            fileStreamSignature.setFile(sigFile);\n+            fileStreamSignature.setNodeAccountId(nodeAccountId);\n+            return fileStreamSignature;\n+        } catch (SignatureFileParsingException | FileOperationException ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9293ccd3ee6fb23f8d14a5fd05b9a03c217695f4"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQwNjQ1MA==", "bodyText": "format", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r551406450", "createdAt": "2021-01-04T16:02:24Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/signature/CompositeSignatureFileReader.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package com.hedera.mirror.importer.reader.signature;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedInputStream;\n+import java.io.DataInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.springframework.context.annotation.Primary;\n+\n+import com.hedera.mirror.importer.domain.FileStreamSignature;\n+import com.hedera.mirror.importer.exception.SignatureFileParsingException;\n+\n+@Log4j2\n+@Named\n+@Primary\n+@RequiredArgsConstructor\n+public class CompositeSignatureFileReader implements SignatureFileReader {\n+\n+    private final SignatureFileReaderV2 signatureFileReaderV2;\n+\n+    @Override\n+    public FileStreamSignature read(InputStream inputStream) {\n+\n+        try (DataInputStream dataInputStream =\n+                     new DataInputStream(new BufferedInputStream(inputStream))) {\n+            dataInputStream.mark(Byte.BYTES);\n+            byte version = dataInputStream.readByte();\n+            dataInputStream.reset();\n+            SignatureFileReader fileReader;\n+            // Version 2 of the signature file begins with a byte of value 4.\n+            if (version <= SignatureFileReaderV2.SIGNATURE_TYPE_FILE_HASH) {\n+                fileReader = signatureFileReaderV2;\n+            } else {\n+                throw new SignatureFileParsingException(\"Unsupported signature file version: \" + version);\n+            }\n+            return fileReader.read(dataInputStream);\n+        } catch (\n+                IOException ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9293ccd3ee6fb23f8d14a5fd05b9a03c217695f4"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQwNjY2MA==", "bodyText": "format, can fit in one line", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r551406660", "createdAt": "2021-01-04T16:02:47Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/signature/CompositeSignatureFileReader.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package com.hedera.mirror.importer.reader.signature;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedInputStream;\n+import java.io.DataInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.springframework.context.annotation.Primary;\n+\n+import com.hedera.mirror.importer.domain.FileStreamSignature;\n+import com.hedera.mirror.importer.exception.SignatureFileParsingException;\n+\n+@Log4j2\n+@Named\n+@Primary\n+@RequiredArgsConstructor\n+public class CompositeSignatureFileReader implements SignatureFileReader {\n+\n+    private final SignatureFileReaderV2 signatureFileReaderV2;\n+\n+    @Override\n+    public FileStreamSignature read(InputStream inputStream) {\n+\n+        try (DataInputStream dataInputStream =\n+                     new DataInputStream(new BufferedInputStream(inputStream))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9293ccd3ee6fb23f8d14a5fd05b9a03c217695f4"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d38217251d4ce728961c32e44a26f81f40d9110", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/7d38217251d4ce728961c32e44a26f81f40d9110", "committedDate": "2021-01-04T16:54:29Z", "message": "PR comment fixes\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bca3d884770cfbed0bcc45e08b8d362745c640c9", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bca3d884770cfbed0bcc45e08b8d362745c640c9", "committedDate": "2021-01-04T17:00:36Z", "message": "PR Comments\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMjA2MTEw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#pullrequestreview-561206110", "createdAt": "2021-01-04T17:28:46Z", "commit": {"oid": "bca3d884770cfbed0bcc45e08b8d362745c640c9"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMjE3NDQy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#pullrequestreview-561217442", "createdAt": "2021-01-04T17:46:36Z", "commit": {"oid": "bca3d884770cfbed0bcc45e08b8d362745c640c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNzo0NjozNlrOIN68YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNzo0NjozNlrOIN68YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ2ODEyOA==", "bodyText": "nit: You don't need to buffer an in memory byte[]. :)", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#discussion_r551468128", "createdAt": "2021-01-04T17:46:36Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/reader/signature/AbstractSignatureFileReaderTest.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.hedera.mirror.importer.reader.signature;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedInputStream;\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileNotFoundException;\n+import java.io.InputStream;\n+\n+import com.hedera.mirror.importer.IntegrationTest;\n+\n+abstract class AbstractSignatureFileReaderTest extends IntegrationTest {\n+\n+    protected InputStream getInputStream(File file) throws FileNotFoundException {\n+        return new BufferedInputStream(new FileInputStream(file));\n+    }\n+\n+    protected InputStream getInputStream(byte[] bytes) {\n+        return new BufferedInputStream(new ByteArrayInputStream(bytes));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bca3d884770cfbed0bcc45e08b8d362745c640c9"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMjQyNjQw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#pullrequestreview-561242640", "createdAt": "2021-01-04T18:25:37Z", "commit": {"oid": "bca3d884770cfbed0bcc45e08b8d362745c640c9"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e8d112422c8bc19ec75f4f597e1c0461270022a", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8e8d112422c8bc19ec75f4f597e1c0461270022a", "committedDate": "2021-01-04T20:25:52Z", "message": "Fix buffer stream around byte array stream\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMzI4MTYz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#pullrequestreview-561328163", "createdAt": "2021-01-04T20:38:49Z", "commit": {"oid": "8e8d112422c8bc19ec75f4f597e1c0461270022a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMzMwNzQ0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1384#pullrequestreview-561330744", "createdAt": "2021-01-04T20:43:08Z", "commit": {"oid": "8e8d112422c8bc19ec75f4f597e1c0461270022a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3459, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}