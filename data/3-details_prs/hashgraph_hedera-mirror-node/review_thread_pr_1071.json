{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNjAzMjIx", "number": 1071, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMDo0OTozMlrOEl41WQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNDoyNjoxM1rOEmHIGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MTYzOTI5OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/AccountBalance.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMDo0OTozMlrOHVnGcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzo1NjowMlrOHWF7rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyMjc2OQ==", "bodyText": "Serializationversionid should  probably be updated.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492422769", "createdAt": "2020-09-22T00:49:32Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/AccountBalance.java", "diffHunk": "@@ -57,8 +62,8 @@ public boolean isNew() {\n \n         private long consensusTimestamp;\n \n-        private int accountNum;\n-\n-        private int accountRealmNum;\n+        @Convert(converter = AccountIdConverter.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkyNzkxOA==", "bodyText": "Updated", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492927918", "createdAt": "2020-09-22T17:56:02Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/AccountBalance.java", "diffHunk": "@@ -57,8 +62,8 @@ public boolean isNew() {\n \n         private long consensusTimestamp;\n \n-        private int accountNum;\n-\n-        private int accountRealmNum;\n+        @Convert(converter = AccountIdConverter.class)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyMjc2OQ=="}, "originalCommit": {"oid": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MTY0NDkwOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.0__balance_entity_id.sql", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMDo1Mjo0N1rOHVnJjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzo1NTo0OFrOHWF7EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyMzU2NQ==", "bodyText": "Would prefer constraints start with table name like the below index does", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492423565", "createdAt": "2020-09-22T00:52:47Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.0__balance_entity_id.sql", "diffHunk": "@@ -0,0 +1,29 @@\n+-------------------\n+-- Update account_balance to use single entity_id column instead of account_realm_num and account_num\n+-------------------\n+\n+-- Drop pk and index that used account_realm_num and account_num. Drop first to make migration quicker\n+alter table account_balance drop constraint pk__account_balances;\n+drop index if exists idx__account_balances__account_then_timestamp;\n+\n+--  Add account_id entity_id column and set based on existing account_realm_num and account_num\n+alter table if exists account_balance\n+    add column account_id entity_id null;\n+\n+update account_balance\n+    set account_id = encodeEntityId(0, account_realm_num, account_num);\n+\n+alter table if exists account_balance\n+    alter column account_id set not null;\n+\n+-- Drop account_realm_num and account_num\n+alter table if exists account_balance\n+    drop column if exists account_realm_num,\n+    drop column if exists account_num;\n+\n+-- Add new pk and index using account_id\n+alter table account_balance\n+    add constraint pk__account_balance primary key (consensus_timestamp, account_id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkyNzc2MQ==", "bodyText": "Updated to account_balance__pk", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492927761", "createdAt": "2020-09-22T17:55:48Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.0__balance_entity_id.sql", "diffHunk": "@@ -0,0 +1,29 @@\n+-------------------\n+-- Update account_balance to use single entity_id column instead of account_realm_num and account_num\n+-------------------\n+\n+-- Drop pk and index that used account_realm_num and account_num. Drop first to make migration quicker\n+alter table account_balance drop constraint pk__account_balances;\n+drop index if exists idx__account_balances__account_then_timestamp;\n+\n+--  Add account_id entity_id column and set based on existing account_realm_num and account_num\n+alter table if exists account_balance\n+    add column account_id entity_id null;\n+\n+update account_balance\n+    set account_id = encodeEntityId(0, account_realm_num, account_num);\n+\n+alter table if exists account_balance\n+    alter column account_id set not null;\n+\n+-- Drop account_realm_num and account_num\n+alter table if exists account_balance\n+    drop column if exists account_realm_num,\n+    drop column if exists account_num;\n+\n+-- Add new pk and index using account_id\n+alter table account_balance\n+    add constraint pk__account_balance primary key (consensus_timestamp, account_id);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyMzU2NQ=="}, "originalCommit": {"oid": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MzkyNjEwOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/__tests__/accounts.test.js", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNDoxNToxMFrOHV8RhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzo1NTo0MlrOHWF6zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc2OTY2OQ==", "bodyText": "The response json didn't change, acc doesn't have an id field so this check is always false, should revert the changes", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492769669", "createdAt": "2020-09-22T14:15:10Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/__tests__/accounts.test.js", "diffHunk": "@@ -51,9 +51,8 @@ const validateAccNumRange = function (accounts, low, high) {\n   let ret = true;\n   let offender = null;\n   for (const acc of accounts.accounts) {\n-    const accNum = acc.account.split('.')[2];\n-    if (accNum < low || accNum > high) {\n-      offender = accNum;\n+    if (acc.id < low || acc.id > high) {\n+      offender = acc.id;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkyNzY5NA==", "bodyText": "Reverted", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492927694", "createdAt": "2020-09-22T17:55:42Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-rest/__tests__/accounts.test.js", "diffHunk": "@@ -51,9 +51,8 @@ const validateAccNumRange = function (accounts, low, high) {\n   let ret = true;\n   let offender = null;\n   for (const acc of accounts.accounts) {\n-    const accNum = acc.account.split('.')[2];\n-    if (accNum < low || accNum > high) {\n-      offender = accNum;\n+    if (acc.id < low || acc.id > high) {\n+      offender = acc.id;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc2OTY2OQ=="}, "originalCommit": {"oid": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4Mzk4MTA3OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/accounts.js", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNDoyNjoxM1rOHV80Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzo1NToyOVrOHWF6TQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc3ODUzNA==", "bodyText": "nit: extra space before e.id", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492778534", "createdAt": "2020-09-22T14:26:13Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/accounts.js", "diffHunk": "@@ -49,18 +49,14 @@ const processRow = function (row) {\n const getAccountQueryPrefix = function () {\n   return `select ab.balance as account_balance,\n        ab.consensus_timestamp as consensus_timestamp,\n-       ${config.shard} as entity_shard,\n-       coalesce(ab.account_realm_num, e.entity_realm) as entity_realm,\n-       coalesce(ab.account_num, e.entity_num) as entity_num,\n+       coalesce(ab.account_id, e.id) as entity_id,\n        e.exp_time_ns,\n        e.auto_renew_period,\n        e.key,\n        e.deleted\n     from account_balance ab\n     full outer join t_entities e on (\n-        ${config.shard} = e.entity_shard\n-        and ab.account_realm_num = e.entity_realm\n-        and ab.account_num =  e.entity_num\n+        ab.account_id =  e.id", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkyNzU2NQ==", "bodyText": "Removed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492927565", "createdAt": "2020-09-22T17:55:29Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-rest/accounts.js", "diffHunk": "@@ -49,18 +49,14 @@ const processRow = function (row) {\n const getAccountQueryPrefix = function () {\n   return `select ab.balance as account_balance,\n        ab.consensus_timestamp as consensus_timestamp,\n-       ${config.shard} as entity_shard,\n-       coalesce(ab.account_realm_num, e.entity_realm) as entity_realm,\n-       coalesce(ab.account_num, e.entity_num) as entity_num,\n+       coalesce(ab.account_id, e.id) as entity_id,\n        e.exp_time_ns,\n        e.auto_renew_period,\n        e.key,\n        e.deleted\n     from account_balance ab\n     full outer join t_entities e on (\n-        ${config.shard} = e.entity_shard\n-        and ab.account_realm_num = e.entity_realm\n-        and ab.account_num =  e.entity_num\n+        ab.account_id =  e.id", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc3ODUzNA=="}, "originalCommit": {"oid": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa"}, "originalPosition": 26}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1483, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}