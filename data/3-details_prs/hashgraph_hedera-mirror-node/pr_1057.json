{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4NzUyMTkz", "number": 1057, "title": "gRPC notify thread blocked improvement", "bodyText": "Detailed description:\nThe backpressure buffer and overflow mechanism was triggered too early in performance tests when ingestion TPS is high, which leads to gRPC clients being dropped before they can catch up. This improvement addresses the following:\n\nIncreases min/max of maxBufferSize and sets the default to 16384\nAdds timeout mechanism after backpressure buffer overflow\nFixes inaccurate polling stats in SharedPollingTopicListener\n\nWhich issue(s) this PR fixes:\nFixes #\nSpecial notes for your reviewer:\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-09-17T15:28:32Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1057", "merged": true, "mergeCommit": {"oid": "ab08066e4a51ccf0de6767699a8a04a026099986"}, "closed": true, "closedAt": "2020-09-22T00:37:03Z", "author": {"login": "xin-hedera"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJeJ-WAH2gAyNDg4NzUyMTkzOmEwZjBlM2Q3MjEyNzBkYTQ1OTY1YWZkYzBjOWZjYzc2NzYxNjhmZjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLMWLKgFqTQ5MzA1NTUxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a0f0e3d721270da45965afdc0c9fcc7676168ff0", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a0f0e3d721270da45965afdc0c9fcc7676168ff0", "committedDate": "2020-09-16T15:30:36Z", "message": "rework grpc notify thread blocked issue, increase maxBufferSize and add timeout mechanism\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0116da8034956a5ac3a97e1c87b196df4e5b4d3", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e0116da8034956a5ac3a97e1c87b196df4e5b4d3", "committedDate": "2020-09-17T15:12:06Z", "message": "add ClientTimeoutException, change max of maxBufferSize\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d74c87a70a08953c86b7bfeb61eafa0e8c05c87d", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d74c87a70a08953c86b7bfeb61eafa0e8c05c87d", "committedDate": "2020-09-17T15:28:05Z", "message": "fix test case\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63690388148350ccbd355a8e0380bc64b341355f", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/63690388148350ccbd355a8e0380bc64b341355f", "committedDate": "2020-09-17T15:41:08Z", "message": "remove accidentally checked-in file\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMDU2OTQy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1057#pullrequestreview-491056942", "createdAt": "2020-09-17T23:35:51Z", "commit": {"oid": "63690388148350ccbd355a8e0380bc64b341355f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMzozNTo1MVrOHT4-_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMzo0ODozNVrOHT5NpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYxODYyMQ==", "bodyText": "q: was AtomicLong having adverse effects? Why the change? I thought it was safer given the shared nature of this flow", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1057#discussion_r490618621", "createdAt": "2020-09-17T23:35:51Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/listener/SharedPollingTopicListener.java", "diffHunk": "@@ -94,38 +83,38 @@ public SharedPollingTopicListener(ListenerProperties listenerProperties,\n         return Flux.fromIterable(topicMessageRepository.findLatest(context.getLastConsensusTimestamp(), pageable))\n                 .name(\"findLatest\")\n                 .metrics()\n+                .doOnNext(context::onNext)\n                 .doOnCancel(context::onPollEnd)\n                 .doOnComplete(context::onPollEnd)\n                 .doOnSubscribe(context::onPollStart);\n     }\n \n-    private boolean filterMessage(TopicMessage message, TopicMessageFilter filter) {\n-        return message.getRealmNum() == filter.getRealmNum() &&\n-                message.getTopicNum() == filter.getTopicNum() &&\n-                message.getConsensusTimestamp() >= filter.getStartTimeLong();\n+    @Override\n+    protected Logger getLogger() {\n+        return log;\n     }\n \n     @Data\n     private class PollingContext {\n \n-        private final AtomicLong count = new AtomicLong(0L);\n+        private long count = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63690388148350ccbd355a8e0380bc64b341355f"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyMjM3Mw==", "bodyText": "Instead you could just add protected final Logger log = LogManager.getLogger(getClass()); to the class.\nThen all the classes extending wouldn't have to implement the getLogger()", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1057#discussion_r490622373", "createdAt": "2020-09-17T23:48:35Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/listener/SharedTopicListener.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package com.hedera.mirror.grpc.listener;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.time.Duration;\n+import org.apache.logging.log4j.Logger;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+import reactor.core.publisher.UnicastProcessor;\n+\n+import com.hedera.mirror.grpc.domain.TopicMessage;\n+import com.hedera.mirror.grpc.domain.TopicMessageFilter;\n+import com.hedera.mirror.grpc.exception.ClientTimeoutException;\n+\n+public abstract class SharedTopicListener implements TopicListener {\n+\n+    protected final ListenerProperties listenerProperties;\n+    protected Flux<TopicMessage> sharedTopicMessages;\n+\n+    public SharedTopicListener(ListenerProperties listenerProperties) {\n+        this.listenerProperties = listenerProperties;\n+    }\n+\n+    @Override\n+    public Flux<TopicMessage> listen(TopicMessageFilter filter) {\n+        Duration delay = Duration.ofMillis(listenerProperties.getBufferTimeout());\n+        UnicastProcessor<String> processor = UnicastProcessor.create();\n+        Flux<String> timeoutFlux = processor.delayElements(delay)\n+                .publish()\n+                .autoConnect();\n+\n+        return sharedTopicMessages.filter(t -> filterMessage(t, filter))\n+                .doOnSubscribe(s -> getLogger().info(\"Subscribing: {}\", filter))\n+                .doOnCancel(() -> processor.onNext(\"timeout\"))\n+                .onBackpressureBuffer(listenerProperties.getMaxBufferSize())\n+                .timeout(timeoutFlux, message -> timeoutFlux,\n+                        Mono.error(new ClientTimeoutException(\"Client times out to receive the buffered messages\")));\n+    }\n+\n+    private boolean filterMessage(TopicMessage message, TopicMessageFilter filter) {\n+        return message.getRealmNum() == filter.getRealmNum() &&\n+                message.getTopicNum() == filter.getTopicNum() &&\n+                message.getConsensusTimestamp() >= filter.getStartTimeLong();\n+    }\n+\n+    protected abstract Logger getLogger();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63690388148350ccbd355a8e0380bc64b341355f"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b9736241819384b0cc8dbd64eb698d24f94bd78", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2b9736241819384b0cc8dbd64eb698d24f94bd78", "committedDate": "2020-09-18T14:15:58Z", "message": "move log instantiation to abstract base class\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNTY4NDIy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1057#pullrequestreview-491568422", "createdAt": "2020-09-18T15:27:42Z", "commit": {"oid": "2b9736241819384b0cc8dbd64eb698d24f94bd78"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNzM4MDU4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1057#pullrequestreview-491738058", "createdAt": "2020-09-18T19:45:51Z", "commit": {"oid": "2b9736241819384b0cc8dbd64eb698d24f94bd78"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxOTo0NTo1MVrOHUZ1lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxOTo0NTo1MVrOHUZ1lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE1Njg4Nw==", "bodyText": "As I understand it, this code will trigger a cancellation after backpressure causes the buffer to fill up. That cancellation will trigger the timeoutFlux to publish after the buffer timeout. If no onNext occurs before the timeout, an exception is thrown.\nMy concern here is I don't see how this can recover from the cancellation? There's no repeat or retry logic here. Please add a test for this scenario.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1057#discussion_r491156887", "createdAt": "2020-09-18T19:45:51Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/listener/SharedTopicListener.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package com.hedera.mirror.grpc.listener;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.time.Duration;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+import reactor.core.publisher.UnicastProcessor;\n+\n+import com.hedera.mirror.grpc.domain.TopicMessage;\n+import com.hedera.mirror.grpc.domain.TopicMessageFilter;\n+import com.hedera.mirror.grpc.exception.ClientTimeoutException;\n+\n+public abstract class SharedTopicListener implements TopicListener {\n+\n+    protected final Logger log = LogManager.getLogger(getClass());\n+    protected final ListenerProperties listenerProperties;\n+    protected Flux<TopicMessage> sharedTopicMessages;\n+\n+    public SharedTopicListener(ListenerProperties listenerProperties) {\n+        this.listenerProperties = listenerProperties;\n+    }\n+\n+    @Override\n+    public Flux<TopicMessage> listen(TopicMessageFilter filter) {\n+        Duration delay = Duration.ofMillis(listenerProperties.getBufferTimeout());\n+        UnicastProcessor<String> processor = UnicastProcessor.create();\n+        Flux<String> timeoutFlux = processor.delayElements(delay)\n+                .publish()\n+                .autoConnect();\n+\n+        return sharedTopicMessages.filter(t -> filterMessage(t, filter))\n+                .doOnSubscribe(s -> log.info(\"Subscribing: {}\", filter))\n+                .doOnCancel(() -> processor.onNext(\"timeout\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b9736241819384b0cc8dbd64eb698d24f94bd78"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d52e6654a4a19dbec7c300ded5dbe9c5fd2a1b3", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/7d52e6654a4a19dbec7c300ded5dbe9c5fd2a1b3", "committedDate": "2020-09-19T15:46:15Z", "message": "change to replay the timeout message to mitigate potential race condition that \"timeout\" is received but doesn't trigger Flux.timeout() internal mechanism\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyODk3Mjcz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1057#pullrequestreview-492897273", "createdAt": "2020-09-21T19:00:37Z", "commit": {"oid": "7d52e6654a4a19dbec7c300ded5dbe9c5fd2a1b3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxOTowMDozN1rOHVeaxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxOTowMDozN1rOHVeaxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI4MDUxOQ==", "bodyText": "changed from publish() to replay(1)\nthere is a race condition in Flux.timeout():\n\nEvery timeout subscription has an index which is the sequence of the actual subscription's onNext call when the timeout subscription is created\nwhen onNext of the timeout subscription is called, it delegates to TimeoutMainSubscriber to handle the timeout only if the saved index equals to the index in TimeoutMainSubscriber\n\nIt's possible that the onNext of timeout subscription and the actual subscription happen around the same time in different threads, and the actual's onNext triggers index increment so timeout won't happened.\nBecause with publish(), the \"timeout\" message is one-shot and once it's consumed, there will be no more timeout triggered. Changing it to replay(1) will make the \"timeout\" message replayed to every subscriber of timeoutFlux thus timeout will happen even with the race condition", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1057#discussion_r492280519", "createdAt": "2020-09-21T19:00:37Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/listener/SharedTopicListener.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package com.hedera.mirror.grpc.listener;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.time.Duration;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+import reactor.core.publisher.UnicastProcessor;\n+\n+import com.hedera.mirror.grpc.domain.TopicMessage;\n+import com.hedera.mirror.grpc.domain.TopicMessageFilter;\n+import com.hedera.mirror.grpc.exception.ClientTimeoutException;\n+\n+public abstract class SharedTopicListener implements TopicListener {\n+\n+    protected final Logger log = LogManager.getLogger(getClass());\n+    protected final ListenerProperties listenerProperties;\n+    protected Flux<TopicMessage> sharedTopicMessages;\n+\n+    public SharedTopicListener(ListenerProperties listenerProperties) {\n+        this.listenerProperties = listenerProperties;\n+    }\n+\n+    @Override\n+    public Flux<TopicMessage> listen(TopicMessageFilter filter) {\n+        Duration delay = Duration.ofMillis(listenerProperties.getBufferTimeout());\n+        UnicastProcessor<String> processor = UnicastProcessor.create();\n+        Flux<String> timeoutFlux = processor.delayElements(delay)\n+                .replay(1)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d52e6654a4a19dbec7c300ded5dbe9c5fd2a1b3"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDI1MDA5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1057#pullrequestreview-493025009", "createdAt": "2020-09-21T22:30:41Z", "commit": {"oid": "7d52e6654a4a19dbec7c300ded5dbe9c5fd2a1b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDU1NTE0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1057#pullrequestreview-493055514", "createdAt": "2020-09-21T23:53:29Z", "commit": {"oid": "7d52e6654a4a19dbec7c300ded5dbe9c5fd2a1b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3534, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}