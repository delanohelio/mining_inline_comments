{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0NDA0ODQ2", "number": 1087, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMDoyMjo0NFrOEpMLtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNjowNDoxNVrOEpit1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNjI2Njc4OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/__tests__/specs/transactions-16-specefic-id-tokentransfer.spec.json", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMDoyMjo0NFrOHat8Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNDoyMDoxMlrOHbMuQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc3NzcyMg==", "bodyText": "file name is misspelled transactions-16-specefic-id-tokentransfer.spec.json. Should be transactions-16-specific-id-tokentransfer.spec.json", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1087#discussion_r497777722", "createdAt": "2020-09-30T20:22:44Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-rest/__tests__/specs/transactions-16-specefic-id-tokentransfer.spec.json", "diffHunk": "@@ -0,0 +1,97 @@\n+{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c975755061d6e22f04b72281e55b382a30a522b"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI4MjA0OA==", "bodyText": "thanks, updated", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1087#discussion_r498282048", "createdAt": "2020-10-01T14:20:12Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/__tests__/specs/transactions-16-specefic-id-tokentransfer.spec.json", "diffHunk": "@@ -0,0 +1,97 @@\n+{", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc3NzcyMg=="}, "originalCommit": {"oid": "3c975755061d6e22f04b72281e55b382a30a522b"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNjI4NTAwOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/balances.js", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMDoyODoxMlrOHauHSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMDoyODoxMlrOHauHSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc4MDU1NA==", "bodyText": "nit: You should add a comment highlighting you're formatting the response as an aggregate of comma separated tokenid balance paris e.g. \"0.0.2=1000,0.0.5=-333..\" so that you can easily split it out later", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1087#discussion_r497780554", "createdAt": "2020-09-30T20:28:12Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-rest/balances.js", "diffHunk": "@@ -51,54 +53,56 @@ const getBalances = async (req, res) => {\n     }\n   }\n \n-  let [tsQuery, tsParams] = utils.parseTimestampQueryParam(req.query, 'ab.consensus_timestamp');\n-\n-  let [balanceQuery, balanceParams] = utils.parseBalanceQueryParam(req.query, 'ab.balance');\n-\n-  let [pubKeyQuery, pubKeyParams] = utils.parsePublicKeyQueryParam(req.query, 'e.ed25519_public_key_hex');\n-  let joinEntities = '' !== pubKeyQuery; // Only need to join t_entites if we're selecting on publickey.\n-\n+  const [tsQuery, tsParams] = utils.parseTimestampQueryParam(req.query, 'ab.consensus_timestamp');\n+  const [balanceQuery, balanceParams] = utils.parseBalanceQueryParam(req.query, 'ab.balance');\n+  const [pubKeyQuery, pubKeyParams] = utils.parsePublicKeyQueryParam(req.query, 'e.ed25519_public_key_hex');\n   const {query, params, order, limit} = utils.parseLimitAndOrderParams(req, 'desc');\n \n   // Use the inner query to find the latest snapshot timestamp from the balance history table\n-  let innerQuery =\n-    'select consensus_timestamp from account_balance ab\\n' +\n-    ' where\\n' +\n-    (tsQuery === '' ? '1=1' : tsQuery) +\n-    '\\n' +\n-    'order by consensus_timestamp desc limit 1';\n-\n-  let sqlQuery = 'select ab.consensus_timestamp,\\n' + 'ab.account_id, ab.balance\\n' + ' from account_balance ab\\n';\n-  if (joinEntities) {\n-    sqlQuery +=\n-      ' join t_entities e\\n' +\n-      ' on e.id = ab.account_id\\n' +\n-      ' and e.entity_shard = ' +\n-      config.shard +\n-      '\\n' +\n-      ' and e.fk_entity_type_id < ' +\n-      utils.ENTITY_TYPE_FILE +\n-      '\\n';\n-  }\n-  sqlQuery +=\n-    ' where ' +\n-    ' consensus_timestamp = (' +\n-    innerQuery +\n-    ')\\n' +\n-    ' and\\n' +\n-    [accountQuery, pubKeyQuery, balanceQuery].map((q) => (q === '' ? '1=1' : q)).join(' and ') +\n-    ' order by consensus_timestamp desc, ' +\n-    'account_id ' +\n-    order +\n-    ' ' +\n-    query;\n-\n-  let sqlParams = tsParams.concat(accountParams).concat(pubKeyParams).concat(balanceParams).concat(params);\n-\n+  const innerQuery = `\n+      SELECT\n+        ab.consensus_timestamp\n+      FROM account_balance ab\n+      WHERE ${tsQuery === '' ? '1=1' : tsQuery}\n+      ORDER BY ab.consensus_timestamp DESC\n+      LIMIT 1`;\n+\n+  const whereClause = `\n+      WHERE ${[`ab.consensus_timestamp = (${innerQuery})`, accountQuery, pubKeyQuery, balanceQuery]\n+        .filter((q) => q !== '')\n+        .join(' AND ')}`;\n+\n+  // Only need to join t_entites if we're selecting on publickey.\n+  const joinEntityClause =\n+    pubKeyQuery !== ''\n+      ? `\n+      JOIN t_entities e\n+        ON e.id = ab.account_id\n+          AND e.entity_shard = ${config.shard}\n+          AND e.fk_entity_type_id < ${utils.ENTITY_TYPE_FILE}`\n+      : '';\n+\n+  const sqlQuery = `\n+      SELECT\n+        ab.consensus_timestamp,\n+        ab.account_id,\n+        ab.balance,\n+        string_agg(tb.token_id || '=' || tb.balance, ',' ORDER BY tb.token_id) AS token_balances", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c975755061d6e22f04b72281e55b382a30a522b"}, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNjI4OTE5OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/transactions.js", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMDoyOToyOVrOHauJ1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMDoyOToyOVrOHauJ1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc4MTIwNQ==", "bodyText": "nit: same thing here, add a comment with an example to highlight aggregation logic", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1087#discussion_r497781205", "createdAt": "2020-09-30T20:29:29Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -34,12 +35,40 @@ const selectClause = `SELECT\n        coalesce(ttr.result, 'UNKNOWN') AS result,\n        coalesce(ttt.name, 'UNKNOWN') AS name,\n        t.node_account_id,\n-       ctl.entity_id as ctl_entity_id,\n-       ctl.amount,\n+       ctl.entity_id AS ctl_entity_id,\n+       ctl.amount AS amount,\n+       string_agg(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c975755061d6e22f04b72281e55b382a30a522b"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExOTUwOTQ4OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.1__hts_support.sql", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNDoyNTowMVrOHbM9Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNDoyNTowMVrOHbM9Fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI4NTg0Ng==", "bodyText": "token balance query is by (consensus_timestamp, account_id), adjust the order of the column in the primary key so the query can utilize the index", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1087#discussion_r498285846", "createdAt": "2020-10-01T14:25:01Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.1__hts_support.sql", "diffHunk": "@@ -106,7 +106,7 @@ create table if not exists token_balance\n );\n \n alter table if exists token_balance\n-    add constraint token_balance__pk primary key (consensus_timestamp, token_id, account_id);\n+    add constraint token_balance__pk primary key (consensus_timestamp, account_id, token_id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a99344691976e16988a887aed15018228f562bc8"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExOTc0OTYxOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/__tests__/specs/transactions-01-no-args.spec.json", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNToxNTo0NFrOHbPTHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODoxODo1NFrOHbV8Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMyNDI1Mg==", "bodyText": "Having a token transfers array inside a token transfers array is confusing. Would prefer a flat structure like cryptotransfers. I don't think the payerAccountId, nodeAccountId and treasureAccountId are necessary as the recipient account is already created by entities array and linked via the token_transfers.account.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1087#discussion_r498324252", "createdAt": "2020-10-01T15:15:44Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/__tests__/specs/transactions-01-no-args.spec.json", "diffHunk": "@@ -45,12 +45,71 @@\n         \"nodeAccountId\": \"0.0.3\",\n         \"treasuryAccountId\": \"0.0.98\"\n       }\n+    ],\n+    \"tokentransfers\": [\n+      {\n+        \"consensus_timestamp\": \"1234567890000000004\",\n+        \"payerAccountId\": \"0.0.10\",\n+        \"nodeAccountId\": \"0.0.3\",\n+        \"treasuryAccountId\": \"0.0.98\",\n+        \"token_transfers\": [", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e96418ca0abe964fd9c3f6e752c13d658efbec8b"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM3MTYyOA==", "bodyText": "the array inside array is needed since there are test cases with multiple token transfers in one transaction, renaming tokentransfers to tokentransferstransactions can make it less confusing.\nthe various top level account ids are only used to create the crypto transfer list (actually it's just transaction fee and node fee) for the tokentransfers transaction", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1087#discussion_r498371628", "createdAt": "2020-10-01T16:26:37Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/__tests__/specs/transactions-01-no-args.spec.json", "diffHunk": "@@ -45,12 +45,71 @@\n         \"nodeAccountId\": \"0.0.3\",\n         \"treasuryAccountId\": \"0.0.98\"\n       }\n+    ],\n+    \"tokentransfers\": [\n+      {\n+        \"consensus_timestamp\": \"1234567890000000004\",\n+        \"payerAccountId\": \"0.0.10\",\n+        \"nodeAccountId\": \"0.0.3\",\n+        \"treasuryAccountId\": \"0.0.98\",\n+        \"token_transfers\": [", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMyNDI1Mg=="}, "originalCommit": {"oid": "e96418ca0abe964fd9c3f6e752c13d658efbec8b"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM4OTUwMg==", "bodyText": "Agreed it is just for setup but also agreed a flatter structure would be better.\nAll account Ids should be created in the \"accounts\" section.\nThen token_transfers only needs to contain the array of token_ids, accounts and amounts", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1087#discussion_r498389502", "createdAt": "2020-10-01T16:58:12Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-rest/__tests__/specs/transactions-01-no-args.spec.json", "diffHunk": "@@ -45,12 +45,71 @@\n         \"nodeAccountId\": \"0.0.3\",\n         \"treasuryAccountId\": \"0.0.98\"\n       }\n+    ],\n+    \"tokentransfers\": [\n+      {\n+        \"consensus_timestamp\": \"1234567890000000004\",\n+        \"payerAccountId\": \"0.0.10\",\n+        \"nodeAccountId\": \"0.0.3\",\n+        \"treasuryAccountId\": \"0.0.98\",\n+        \"token_transfers\": [", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMyNDI1Mg=="}, "originalCommit": {"oid": "e96418ca0abe964fd9c3f6e752c13d658efbec8b"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQwMjA0MQ==", "bodyText": "the various accounts in either cryptotransfers or tokentransfers are not for account creation into t_entities table. I see it's repeatedly mentioned otherways, did I miss anything?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1087#discussion_r498402041", "createdAt": "2020-10-01T17:21:29Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/__tests__/specs/transactions-01-no-args.spec.json", "diffHunk": "@@ -45,12 +45,71 @@\n         \"nodeAccountId\": \"0.0.3\",\n         \"treasuryAccountId\": \"0.0.98\"\n       }\n+    ],\n+    \"tokentransfers\": [\n+      {\n+        \"consensus_timestamp\": \"1234567890000000004\",\n+        \"payerAccountId\": \"0.0.10\",\n+        \"nodeAccountId\": \"0.0.3\",\n+        \"treasuryAccountId\": \"0.0.98\",\n+        \"token_transfers\": [", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMyNDI1Mg=="}, "originalCommit": {"oid": "e96418ca0abe964fd9c3f6e752c13d658efbec8b"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQxOTU2OQ==", "bodyText": "Correct, accounts don't get created via cryptotransfers but via entities array.\nIf a scenario is needed with multiple token transfers in one transaction, this can be done with a flat structure by simply duplicating the consensus timestamp. The setup json should match the table structure as much as possible to make it easy to insert and understand.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1087#discussion_r498419569", "createdAt": "2020-10-01T17:53:25Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/__tests__/specs/transactions-01-no-args.spec.json", "diffHunk": "@@ -45,12 +45,71 @@\n         \"nodeAccountId\": \"0.0.3\",\n         \"treasuryAccountId\": \"0.0.98\"\n       }\n+    ],\n+    \"tokentransfers\": [\n+      {\n+        \"consensus_timestamp\": \"1234567890000000004\",\n+        \"payerAccountId\": \"0.0.10\",\n+        \"nodeAccountId\": \"0.0.3\",\n+        \"treasuryAccountId\": \"0.0.98\",\n+        \"token_transfers\": [", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMyNDI1Mg=="}, "originalCommit": {"oid": "e96418ca0abe964fd9c3f6e752c13d658efbec8b"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQzMzA2Mg==", "bodyText": "I'd prefer the transfer array in transaction array structure. It reflects the layout of the transaction. Splitting entries in the list into multiple flat structure with the same consensus timestamp also makes it hard to correlate the input data and the expected json output.\non the other side, cryptotransfers is flat just because we don't test crypto transfers to multiple accounts and in fact we should, that would make it also a transfer array in transaction array structure.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1087#discussion_r498433062", "createdAt": "2020-10-01T18:18:54Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/__tests__/specs/transactions-01-no-args.spec.json", "diffHunk": "@@ -45,12 +45,71 @@\n         \"nodeAccountId\": \"0.0.3\",\n         \"treasuryAccountId\": \"0.0.98\"\n       }\n+    ],\n+    \"tokentransfers\": [\n+      {\n+        \"consensus_timestamp\": \"1234567890000000004\",\n+        \"payerAccountId\": \"0.0.10\",\n+        \"nodeAccountId\": \"0.0.3\",\n+        \"treasuryAccountId\": \"0.0.98\",\n+        \"token_transfers\": [", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMyNDI1Mg=="}, "originalCommit": {"oid": "e96418ca0abe964fd9c3f6e752c13d658efbec8b"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExOTg5MzU1OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/transactions.js", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNTo0Nzo0M1rOHbQtLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMDoyOTo0MVrOHbZzyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM0NzMxMQ==", "bodyText": "LEFT OUTER JOIN to be consistent with the others. Functionally they're both the same.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1087#discussion_r498347311", "createdAt": "2020-10-01T15:47:43Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -102,24 +133,28 @@ const createTransferLists = function (rows) {\n  * @return {String} outerQuery Fully formed SQL query\n  */\n const getTransactionsOuterQuery = function (innerQuery, order) {\n-  return (\n-    selectClause +\n-    `FROM ( ${innerQuery} ) AS tlist\n+  return `\n+    ${selectClause}\n+    FROM ( ${innerQuery} ) AS tlist\n        JOIN transaction t ON tlist.consensus_timestamp = t.consensus_ns\n        LEFT OUTER JOIN t_transaction_results ttr ON ttr.proto_id = t.result\n        LEFT OUTER JOIN t_transaction_types ttt ON ttt.proto_id = t.type\n        JOIN crypto_transfer ctl ON tlist.consensus_timestamp = ctl.consensus_timestamp\n-     ORDER BY t.consensus_ns ${order} , ctl_entity_id ASC, amount ASC`\n-  );\n+       LEFT JOIN token_transfer ttl", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e96418ca0abe964fd9c3f6e752c13d658efbec8b"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ5NjQ1Nw==", "bodyText": "sure, made the change", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1087#discussion_r498496457", "createdAt": "2020-10-01T20:29:41Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -102,24 +133,28 @@ const createTransferLists = function (rows) {\n  * @return {String} outerQuery Fully formed SQL query\n  */\n const getTransactionsOuterQuery = function (innerQuery, order) {\n-  return (\n-    selectClause +\n-    `FROM ( ${innerQuery} ) AS tlist\n+  return `\n+    ${selectClause}\n+    FROM ( ${innerQuery} ) AS tlist\n        JOIN transaction t ON tlist.consensus_timestamp = t.consensus_ns\n        LEFT OUTER JOIN t_transaction_results ttr ON ttr.proto_id = t.result\n        LEFT OUTER JOIN t_transaction_types ttt ON ttt.proto_id = t.type\n        JOIN crypto_transfer ctl ON tlist.consensus_timestamp = ctl.consensus_timestamp\n-     ORDER BY t.consensus_ns ${order} , ctl_entity_id ASC, amount ASC`\n-  );\n+       LEFT JOIN token_transfer ttl", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM0NzMxMQ=="}, "originalCommit": {"oid": "e96418ca0abe964fd9c3f6e752c13d658efbec8b"}, "originalPosition": 139}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExOTkwNjExOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/__tests__/specs/transactions-16-specific-id-tokentransfer.spec.json", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNTo1MDo1MVrOHbQ1fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMDoyOTowN1rOHbZyug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM0OTQzNw==", "bodyText": "The sort order differs from transfers and may not be deterministic. We should probably sort account_id asc, token_id asc.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1087#discussion_r498349437", "createdAt": "2020-10-01T15:50:51Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/__tests__/specs/transactions-16-specific-id-tokentransfer.spec.json", "diffHunk": "@@ -0,0 +1,97 @@\n+{\n+  \"description\": \"Transaction api calls for a specific transaction using transaction id\",\n+  \"setup\": {\n+    \"accounts\": [\n+      {\n+        \"entity_num\": 3\n+      },\n+      {\n+        \"entity_num\": 9\n+      },\n+      {\n+        \"entity_num\": 10\n+      },\n+      {\n+        \"entity_num\": 98\n+      }\n+    ],\n+    \"balances\": [],\n+    \"transactions\": [],\n+    \"cryptotransfers\": [],\n+    \"tokentransfers\": [\n+      {\n+        \"consensus_timestamp\": \"1565779555711927001\",\n+        \"payerAccountId\": \"0.0.300\",\n+        \"nodeAccountId\": \"0.0.3\",\n+        \"treasuryAccountId\": \"0.0.98\",\n+        \"token_transfers\": [\n+          {\n+            \"token_id\": \"0.0.90000\",\n+            \"account\": \"0.0.300\",\n+            \"amount\": -1200\n+          },\n+          {\n+            \"token_id\": \"0.0.90000\",\n+            \"account\": \"0.0.200\",\n+            \"amount\": 200\n+          },\n+          {\n+            \"token_id\": \"0.0.90000\",\n+            \"account\": \"0.0.400\",\n+            \"amount\": 1000\n+          }\n+        ]\n+      }\n+    ]\n+  },\n+  \"url\": \"/api/v1/transactions/0.0.300-1565779555-711927000\",\n+  \"responseStatus\": 200,\n+  \"responseJson\": {\n+    \"transactions\": [\n+      {\n+        \"consensus_timestamp\": \"1565779555.711927001\",\n+        \"valid_start_timestamp\": \"1565779555.711927000\",\n+        \"charged_tx_fee\": 7,\n+        \"memo_base64\": null,\n+        \"result\": \"SUCCESS\",\n+        \"transaction_hash\": \"aGFzaA==\",\n+        \"name\": \"TOKENTRANSFERS\",\n+        \"node\": \"0.0.3\",\n+        \"transaction_id\": \"0.0.300-1565779555-711927000\",\n+        \"valid_duration_seconds\": \"11\",\n+        \"max_fee\": \"33\",\n+        \"transfers\": [\n+          {\n+            \"account\": \"0.0.3\",\n+            \"amount\": 2\n+          },\n+          {\n+            \"account\": \"0.0.98\",\n+            \"amount\": 1\n+          },\n+          {\n+            \"account\": \"0.0.300\",\n+            \"amount\": -3\n+          }\n+        ],\n+        \"token_transfers\": [\n+          {\n+            \"account\": \"0.0.400\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e96418ca0abe964fd9c3f6e752c13d658efbec8b"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ5NjE4Ng==", "bodyText": "changed sorting order of token balance / token transfer to the top level resource", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1087#discussion_r498496186", "createdAt": "2020-10-01T20:29:07Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/__tests__/specs/transactions-16-specific-id-tokentransfer.spec.json", "diffHunk": "@@ -0,0 +1,97 @@\n+{\n+  \"description\": \"Transaction api calls for a specific transaction using transaction id\",\n+  \"setup\": {\n+    \"accounts\": [\n+      {\n+        \"entity_num\": 3\n+      },\n+      {\n+        \"entity_num\": 9\n+      },\n+      {\n+        \"entity_num\": 10\n+      },\n+      {\n+        \"entity_num\": 98\n+      }\n+    ],\n+    \"balances\": [],\n+    \"transactions\": [],\n+    \"cryptotransfers\": [],\n+    \"tokentransfers\": [\n+      {\n+        \"consensus_timestamp\": \"1565779555711927001\",\n+        \"payerAccountId\": \"0.0.300\",\n+        \"nodeAccountId\": \"0.0.3\",\n+        \"treasuryAccountId\": \"0.0.98\",\n+        \"token_transfers\": [\n+          {\n+            \"token_id\": \"0.0.90000\",\n+            \"account\": \"0.0.300\",\n+            \"amount\": -1200\n+          },\n+          {\n+            \"token_id\": \"0.0.90000\",\n+            \"account\": \"0.0.200\",\n+            \"amount\": 200\n+          },\n+          {\n+            \"token_id\": \"0.0.90000\",\n+            \"account\": \"0.0.400\",\n+            \"amount\": 1000\n+          }\n+        ]\n+      }\n+    ]\n+  },\n+  \"url\": \"/api/v1/transactions/0.0.300-1565779555-711927000\",\n+  \"responseStatus\": 200,\n+  \"responseJson\": {\n+    \"transactions\": [\n+      {\n+        \"consensus_timestamp\": \"1565779555.711927001\",\n+        \"valid_start_timestamp\": \"1565779555.711927000\",\n+        \"charged_tx_fee\": 7,\n+        \"memo_base64\": null,\n+        \"result\": \"SUCCESS\",\n+        \"transaction_hash\": \"aGFzaA==\",\n+        \"name\": \"TOKENTRANSFERS\",\n+        \"node\": \"0.0.3\",\n+        \"transaction_id\": \"0.0.300-1565779555-711927000\",\n+        \"valid_duration_seconds\": \"11\",\n+        \"max_fee\": \"33\",\n+        \"transfers\": [\n+          {\n+            \"account\": \"0.0.3\",\n+            \"amount\": 2\n+          },\n+          {\n+            \"account\": \"0.0.98\",\n+            \"amount\": 1\n+          },\n+          {\n+            \"account\": \"0.0.300\",\n+            \"amount\": -3\n+          }\n+        ],\n+        \"token_transfers\": [\n+          {\n+            \"account\": \"0.0.400\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM0OTQzNw=="}, "originalCommit": {"oid": "e96418ca0abe964fd9c3f6e752c13d658efbec8b"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExOTk1ODYxOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/balances.js", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNjowNDoxNVrOHbRXmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMDoyOToyOVrOHbZzag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM1ODE3MQ==", "bodyText": "Using json might be a better, more future-proof approach for nested data.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1087#discussion_r498358171", "createdAt": "2020-10-01T16:04:15Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/balances.js", "diffHunk": "@@ -51,54 +53,57 @@ const getBalances = async (req, res) => {\n     }\n   }\n \n-  let [tsQuery, tsParams] = utils.parseTimestampQueryParam(req.query, 'ab.consensus_timestamp');\n-\n-  let [balanceQuery, balanceParams] = utils.parseBalanceQueryParam(req.query, 'ab.balance');\n-\n-  let [pubKeyQuery, pubKeyParams] = utils.parsePublicKeyQueryParam(req.query, 'e.ed25519_public_key_hex');\n-  let joinEntities = '' !== pubKeyQuery; // Only need to join t_entites if we're selecting on publickey.\n-\n+  const [tsQuery, tsParams] = utils.parseTimestampQueryParam(req.query, 'ab.consensus_timestamp');\n+  const [balanceQuery, balanceParams] = utils.parseBalanceQueryParam(req.query, 'ab.balance');\n+  const [pubKeyQuery, pubKeyParams] = utils.parsePublicKeyQueryParam(req.query, 'e.ed25519_public_key_hex');\n   const {query, params, order, limit} = utils.parseLimitAndOrderParams(req, 'desc');\n \n   // Use the inner query to find the latest snapshot timestamp from the balance history table\n-  let innerQuery =\n-    'select consensus_timestamp from account_balance ab\\n' +\n-    ' where\\n' +\n-    (tsQuery === '' ? '1=1' : tsQuery) +\n-    '\\n' +\n-    'order by consensus_timestamp desc limit 1';\n-\n-  let sqlQuery = 'select ab.consensus_timestamp,\\n' + 'ab.account_id, ab.balance\\n' + ' from account_balance ab\\n';\n-  if (joinEntities) {\n-    sqlQuery +=\n-      ' join t_entities e\\n' +\n-      ' on e.id = ab.account_id\\n' +\n-      ' and e.entity_shard = ' +\n-      config.shard +\n-      '\\n' +\n-      ' and e.fk_entity_type_id < ' +\n-      utils.ENTITY_TYPE_FILE +\n-      '\\n';\n-  }\n-  sqlQuery +=\n-    ' where ' +\n-    ' consensus_timestamp = (' +\n-    innerQuery +\n-    ')\\n' +\n-    ' and\\n' +\n-    [accountQuery, pubKeyQuery, balanceQuery].map((q) => (q === '' ? '1=1' : q)).join(' and ') +\n-    ' order by consensus_timestamp desc, ' +\n-    'account_id ' +\n-    order +\n-    ' ' +\n-    query;\n-\n-  let sqlParams = tsParams.concat(accountParams).concat(pubKeyParams).concat(balanceParams).concat(params);\n-\n+  const innerQuery = `\n+      SELECT\n+        ab.consensus_timestamp\n+      FROM account_balance ab\n+      WHERE ${tsQuery === '' ? '1=1' : tsQuery}\n+      ORDER BY ab.consensus_timestamp DESC\n+      LIMIT 1`;\n+\n+  const whereClause = `\n+      WHERE ${[`ab.consensus_timestamp = (${innerQuery})`, accountQuery, pubKeyQuery, balanceQuery]\n+        .filter((q) => q !== '')\n+        .join(' AND ')}`;\n+\n+  // Only need to join t_entites if we're selecting on publickey.\n+  const joinEntityClause =\n+    pubKeyQuery !== ''\n+      ? `\n+      JOIN t_entities e\n+        ON e.id = ab.account_id\n+          AND e.entity_shard = ${config.shard}\n+          AND e.fk_entity_type_id < ${utils.ENTITY_TYPE_FILE}`\n+      : '';\n+\n+  // token balances pairs are aggregated as a string, e.g., \"100=600,101=700\"\n+  const sqlQuery = `\n+      SELECT\n+        ab.consensus_timestamp,\n+        ab.account_id,\n+        ab.balance,\n+        string_agg(tb.token_id || '=' || tb.balance, ',' ORDER BY tb.token_id) AS token_balances", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e96418ca0abe964fd9c3f6e752c13d658efbec8b"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ5NjM2Mg==", "bodyText": "switched to json_agg with json_build_object", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1087#discussion_r498496362", "createdAt": "2020-10-01T20:29:29Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/balances.js", "diffHunk": "@@ -51,54 +53,57 @@ const getBalances = async (req, res) => {\n     }\n   }\n \n-  let [tsQuery, tsParams] = utils.parseTimestampQueryParam(req.query, 'ab.consensus_timestamp');\n-\n-  let [balanceQuery, balanceParams] = utils.parseBalanceQueryParam(req.query, 'ab.balance');\n-\n-  let [pubKeyQuery, pubKeyParams] = utils.parsePublicKeyQueryParam(req.query, 'e.ed25519_public_key_hex');\n-  let joinEntities = '' !== pubKeyQuery; // Only need to join t_entites if we're selecting on publickey.\n-\n+  const [tsQuery, tsParams] = utils.parseTimestampQueryParam(req.query, 'ab.consensus_timestamp');\n+  const [balanceQuery, balanceParams] = utils.parseBalanceQueryParam(req.query, 'ab.balance');\n+  const [pubKeyQuery, pubKeyParams] = utils.parsePublicKeyQueryParam(req.query, 'e.ed25519_public_key_hex');\n   const {query, params, order, limit} = utils.parseLimitAndOrderParams(req, 'desc');\n \n   // Use the inner query to find the latest snapshot timestamp from the balance history table\n-  let innerQuery =\n-    'select consensus_timestamp from account_balance ab\\n' +\n-    ' where\\n' +\n-    (tsQuery === '' ? '1=1' : tsQuery) +\n-    '\\n' +\n-    'order by consensus_timestamp desc limit 1';\n-\n-  let sqlQuery = 'select ab.consensus_timestamp,\\n' + 'ab.account_id, ab.balance\\n' + ' from account_balance ab\\n';\n-  if (joinEntities) {\n-    sqlQuery +=\n-      ' join t_entities e\\n' +\n-      ' on e.id = ab.account_id\\n' +\n-      ' and e.entity_shard = ' +\n-      config.shard +\n-      '\\n' +\n-      ' and e.fk_entity_type_id < ' +\n-      utils.ENTITY_TYPE_FILE +\n-      '\\n';\n-  }\n-  sqlQuery +=\n-    ' where ' +\n-    ' consensus_timestamp = (' +\n-    innerQuery +\n-    ')\\n' +\n-    ' and\\n' +\n-    [accountQuery, pubKeyQuery, balanceQuery].map((q) => (q === '' ? '1=1' : q)).join(' and ') +\n-    ' order by consensus_timestamp desc, ' +\n-    'account_id ' +\n-    order +\n-    ' ' +\n-    query;\n-\n-  let sqlParams = tsParams.concat(accountParams).concat(pubKeyParams).concat(balanceParams).concat(params);\n-\n+  const innerQuery = `\n+      SELECT\n+        ab.consensus_timestamp\n+      FROM account_balance ab\n+      WHERE ${tsQuery === '' ? '1=1' : tsQuery}\n+      ORDER BY ab.consensus_timestamp DESC\n+      LIMIT 1`;\n+\n+  const whereClause = `\n+      WHERE ${[`ab.consensus_timestamp = (${innerQuery})`, accountQuery, pubKeyQuery, balanceQuery]\n+        .filter((q) => q !== '')\n+        .join(' AND ')}`;\n+\n+  // Only need to join t_entites if we're selecting on publickey.\n+  const joinEntityClause =\n+    pubKeyQuery !== ''\n+      ? `\n+      JOIN t_entities e\n+        ON e.id = ab.account_id\n+          AND e.entity_shard = ${config.shard}\n+          AND e.fk_entity_type_id < ${utils.ENTITY_TYPE_FILE}`\n+      : '';\n+\n+  // token balances pairs are aggregated as a string, e.g., \"100=600,101=700\"\n+  const sqlQuery = `\n+      SELECT\n+        ab.consensus_timestamp,\n+        ab.account_id,\n+        ab.balance,\n+        string_agg(tb.token_id || '=' || tb.balance, ',' ORDER BY tb.token_id) AS token_balances", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM1ODE3MQ=="}, "originalCommit": {"oid": "e96418ca0abe964fd9c3f6e752c13d658efbec8b"}, "originalPosition": 106}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1506, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}