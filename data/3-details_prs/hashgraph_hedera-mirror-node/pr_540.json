{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NjI1NTkx", "number": 540, "title": "Set maxConcurrentCallsPerConnection to prevent excessive calls ", "bodyText": "Detailed description:\nRecently in testnet we observed a single IP client with multiple subscriptions to from a single connection. This resulted in a high CPU usage as Netty scaled to support all the calls to HCS topics.\nThis fix puts a cap on the number of allowed calls by setting the NettyServerBuilder.maxConcurrentCallsPerConnection property. In this case calls above this number will be rejected.\nWhich issue(s) this PR fixes:\nPartially addresses #536\nSpecial notes for your reviewer:\nVerified using jmeter performance tests and observing gRPC process CPU usage.\nIn the unbounded case CPU usage could go as high as 851% and hold for over a minute.\nIn the bounded case CPU usage was seen to go as high as 430% but only for 1-3 seconds before averaging at around 70% for the length of the subscription where messages were being delivered.\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-02-15T00:05:30Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540", "merged": true, "mergeCommit": {"oid": "412d73cecab93f31d7f15a96243113f86bc1c5bd"}, "closed": true, "closedAt": "2020-02-18T21:16:38Z", "author": {"login": "Nana-EC"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEYjL6AH2gAyMzc1NjI1NTkxOmYwYjIzZjEwY2Q1OGMwNDY4ZmE3ZGViNTllYjg3YWFiMWM2ZjYxOTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFonYJgFqTM2MDY3NzM1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f0b23f10cd58c0468fa7deb59eb87aab1c6f6198", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f0b23f10cd58c0468fa7deb59eb87aab1c6f6198", "committedDate": "2020-02-14T23:57:56Z", "message": "Set maxConcurrentCallsPerConnection to prevent excessive calls from single connection\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MjgyMzUy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#pullrequestreview-359282352", "createdAt": "2020-02-15T00:09:34Z", "commit": {"oid": "f0b23f10cd58c0468fa7deb59eb87aab1c6f6198"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQwMDowOTozNFrOFqG3IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQwMDoyMTowOFrOFqG-OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5NjkyOQ==", "bodyText": "Since this variable is static and there are multiple threads setting it, this needs to be protected by a synchronized block", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#discussion_r379696929", "createdAt": "2020-02-15T00:09:34Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/client/SingleTopicHCSClient.java", "diffHunk": "@@ -66,11 +70,23 @@ public void setupTest(JavaSamplerContext context) {\n             builder.setLimit(limit);\n         }\n \n-        hcsTopicSampler = new HCSTopicSampler(host, port, builder.build());\n+        setSampler(sharedChannel, host, port, builder.build());\n \n         super.setupTest(context);\n     }\n \n+    private void setSampler(boolean sharedChannel, String host, int port, ConsensusTopicQuery consensusTopicQuery) {\n+        if (sharedChannel) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0b23f10cd58c0468fa7deb59eb87aab1c6f6198"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5ODU1OA==", "bodyText": "I think 5 would be better. Min should be 1.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#discussion_r379698558", "createdAt": "2020-02-15T00:20:09Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/NettyProperties.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package com.hedera.mirror.grpc.config;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import javax.validation.constraints.Min;\n+import lombok.Data;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.validation.annotation.Validated;\n+\n+@Data\n+@Validated\n+@ConfigurationProperties(\"hedera.mirror.grpc.netty\")\n+public class NettyProperties {\n+    @Min(5)\n+    private int maxConcurrentCallsPerConnection = 10;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0b23f10cd58c0468fa7deb59eb87aab1c6f6198"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5ODc0NA==", "bodyText": "I think we should take this time to see if the other settings that HAPI use that can be utilized here.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#discussion_r379698744", "createdAt": "2020-02-15T00:21:08Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/GrpcConfiguration.java", "diffHunk": "@@ -46,4 +50,10 @@ CompositeHealthContributor grpcServices(GrpcServiceDiscoverer grpcServiceDiscove\n \n         return CompositeHealthContributor.fromMap(healthIndicators);\n     }\n+\n+    @Bean\n+    public GrpcServerConfigurer grpcServerConfigurer(NettyProperties nettyProperties) {\n+        return serverBuilder -> ((NettyServerBuilder) serverBuilder)\n+                .maxConcurrentCallsPerConnection(nettyProperties.getMaxConcurrentCallsPerConnection());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0b23f10cd58c0468fa7deb59eb87aab1c6f6198"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5Mjg4NjYw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#pullrequestreview-359288660", "createdAt": "2020-02-15T00:47:48Z", "commit": {"oid": "f0b23f10cd58c0468fa7deb59eb87aab1c6f6198"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQwMDo0Nzo0OVrOFqHNeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQwMDo0Nzo0OVrOFqHNeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTcwMjY0OA==", "bodyText": "it would be good if all  hedera.mirror.grpc.*  properties can reference back to single place GrpcProperties.\nAdding private NettyProperties netty = new NettyProperties() to  GrpcProperties would be sufficient. @ConfigurationProperties can be removed then.\nhttps://github.com/spring-projects/spring-boot/wiki/Spring-Boot-Configuration-Binding#nested-property", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#discussion_r379702648", "createdAt": "2020-02-15T00:47:49Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/NettyProperties.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package com.hedera.mirror.grpc.config;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import javax.validation.constraints.Min;\n+import lombok.Data;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.validation.annotation.Validated;\n+\n+@Data\n+@Validated\n+@ConfigurationProperties(\"hedera.mirror.grpc.netty\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0b23f10cd58c0468fa7deb59eb87aab1c6f6198"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5Mjg4ODkx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#pullrequestreview-359288891", "createdAt": "2020-02-15T00:49:22Z", "commit": {"oid": "f0b23f10cd58c0468fa7deb59eb87aab1c6f6198"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7d8ba80772d5a86ec1be584fd2440ffc39ee8c4", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a7d8ba80772d5a86ec1be584fd2440ffc39ee8c4", "committedDate": "2020-02-18T18:12:03Z", "message": "Updated maxConcurrentCallsPerConnection default and validation. Nested NettyProperties into GrpcProperties\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNTc0Mjg5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#pullrequestreview-360574289", "createdAt": "2020-02-18T18:32:45Z", "commit": {"oid": "a7d8ba80772d5a86ec1be584fd2440ffc39ee8c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxODozMjo0NlrOFrNrVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxODozMjo0NlrOFrNrVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg1NzE3Mg==", "bodyText": "probably should be if (channel == null) { channel = ...; } inside synchronized.\nI'm guessing this is the standard case of initializing variable shared by multiple threads. I haven't seen rest of the code, so the suggestion maybe wrong.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#discussion_r380857172", "createdAt": "2020-02-18T18:32:46Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/client/SingleTopicHCSClient.java", "diffHunk": "@@ -78,7 +78,9 @@ public void setupTest(JavaSamplerContext context) {\n     private void setSampler(boolean sharedChannel, String host, int port, ConsensusTopicQuery consensusTopicQuery) {\n         if (sharedChannel) {\n             if (channel == null) {\n-                channel = ManagedChannelBuilder.forAddress(host, port).usePlaintext(true).build();\n+                synchronized (this) {\n+                    channel = ManagedChannelBuilder.forAddress(host, port).usePlaintext(true).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7d8ba80772d5a86ec1be584fd2440ffc39ee8c4"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8af99c6217079a2708864bfffe23ff1c8bd4042f", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8af99c6217079a2708864bfffe23ff1c8bd4042f", "committedDate": "2020-02-18T20:12:06Z", "message": "Addressed synchronized feedback and added Netty_MaxConcurrentCallsPerConnection.jmx test plan to verify\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNjU2MDI5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#pullrequestreview-360656029", "createdAt": "2020-02-18T20:39:43Z", "commit": {"oid": "8af99c6217079a2708864bfffe23ff1c8bd4042f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNjc3MzUz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/540#pullrequestreview-360677353", "createdAt": "2020-02-18T21:14:55Z", "commit": {"oid": "8af99c6217079a2708864bfffe23ff1c8bd4042f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3249, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}