{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1NTU0NzYw", "number": 995, "title": "Composite entity listener", "bodyText": "Detailed description:\n\nAdd ability to notify multiple EntityListener of new objects\nAdd a NotifyingEntityListener to decouple pg_notify from inserts\nAdd an experimental RepositoryEntityListener to test performance of more maintainable repositories and provide a backup insert mechanism\nAdd properties to disable each EntityListener\nChange domain classes to not find before insert when using repositories\nChange AddressBookService to not save since Java migration expects it to already exist and this doesn't work with repositories\nFix gRPC entity cache not correcting itself in environments that are reset by adding a 24h cache limit\nFix closing PgCopy connection on every batch save\nFix domain classes with composite keys\nFix handling of crypto transfers for non-zero shards and realms\nFix warmup in RecordFileParserPerformanceTest\n\nWhich issue(s) this PR fixes:\nPartially solves #893\nSpecial notes for your reviewer:\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-08-28T17:54:30Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/995", "merged": true, "mergeCommit": {"oid": "9c13a19e8f4506ecdb2519a1e45a45f61dc34f56"}, "closed": true, "closedAt": "2020-09-02T14:43:20Z", "author": {"login": "steven-sheehy"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6CZ1VgH2gAyNDc1NTU0NzYwOjM5M2JiNzZjYWM4ZDI4ZTczMjJjNGJmZmFhNGE5YzM0ZDA0M2I0YTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEwA1MgFqTQ4MDE4MzYzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "393bb76cac8d28e7322c4bffaa4a9c34d043b4a4", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/393bb76cac8d28e7322c4bffaa4a9c34d043b4a4", "committedDate": "2020-07-30T16:41:43Z", "message": "Notify topic messages via Redis Streams\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "645c675fb4d3f25c963a0f62ca3c96abd66e3972", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/645c675fb4d3f25c963a0f62ca3c96abd66e3972", "committedDate": "2020-08-05T21:49:40Z", "message": "Add redis topic listener\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5924da4fd02167582fbb4ca110dbd719591a70c0", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5924da4fd02167582fbb4ca110dbd719591a70c0", "committedDate": "2020-08-25T19:48:13Z", "message": "Merge remote-tracking branch 'origin/master' into redis-streams"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23408640abda2eb9559066b48d23a509fcea4350", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/23408640abda2eb9559066b48d23a509fcea4350", "committedDate": "2020-08-25T20:23:57Z", "message": "Remove redis\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "111c5f4dd08c9f66fd63506f3d4e4f40f3f9f574", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/111c5f4dd08c9f66fd63506f3d4e4f40f3f9f574", "committedDate": "2020-08-25T20:26:23Z", "message": "Fix\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "697c90750cb2ddebbbd2e09323a68a78196636d6", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/697c90750cb2ddebbbd2e09323a68a78196636d6", "committedDate": "2020-08-26T21:09:19Z", "message": "Add a RepositoryEntityListener\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "517bde0468c157d1071a66d19ee1ab0273dc9226", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/517bde0468c157d1071a66d19ee1ab0273dc9226", "committedDate": "2020-08-26T23:32:14Z", "message": "Merge remote-tracking branch 'origin/master' into composite-entity-listener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "381dd8e399b40d35af4878c82c6f1dbf51c12403", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/381dd8e399b40d35af4878c82c6f1dbf51c12403", "committedDate": "2020-08-28T17:40:40Z", "message": "Add a RepositoryEntityListener\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3OTUzMTYy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/995#pullrequestreview-477953162", "createdAt": "2020-08-28T18:47:48Z", "commit": {"oid": "381dd8e399b40d35af4878c82c6f1dbf51c12403"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxODo0Nzo0OFrOHJRA3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxODo0Nzo0OFrOHJRA3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ3Nzk4MQ==", "bodyText": "Payer account already added to transfer list in buildTransactionRecord().", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/995#discussion_r479477981", "createdAt": "2020-08-28T18:47:48Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/entity/EntityRecordItemListenerCryptoTest.java", "diffHunk": "@@ -59,8 +59,8 @@\n     private static final long INITIAL_BALANCE = 1000L;\n     private static final AccountID accountId = AccountID.newBuilder().setShardNum(0).setRealmNum(0).setAccountNum(1001)\n             .build();\n-    private static final long[] additionalTransfers = {5000, 6000, PAYER.getAccountNum()};\n-    private static final long[] additionalTransferAmounts = {1000, 1000, -2000};\n+    private static final long[] additionalTransfers = {5000, 6000};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "381dd8e399b40d35af4878c82c6f1dbf51c12403"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf26f1586363cef78c8e0282404f2cf5788621f4", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/cf26f1586363cef78c8e0282404f2cf5788621f4", "committedDate": "2020-08-28T21:19:59Z", "message": "Fix caching\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25f481d01ad9cb9d73321c1ca3e85c13a4bb76ad", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/25f481d01ad9cb9d73321c1ca3e85c13a4bb76ad", "committedDate": "2020-08-28T21:43:12Z", "message": "Fix performance test warmup\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MDcyOTEw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/995#pullrequestreview-478072910", "createdAt": "2020-08-28T23:39:04Z", "commit": {"oid": "381dd8e399b40d35af4878c82c6f1dbf51c12403"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQyMzozOTowNFrOHJW8ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQyMzozOTowNFrOHJW8ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3NTIwMw==", "bodyText": "You should add a comment here. Initially I thought this was a mistake and it should be !addressBoo. However, I get that you removed the fileData persistence from AddressBookService back to here\nAlso does this check need the addressBook boolean check, since 'entityId.getEntityNum() < 1000' will be true?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/995#discussion_r479575203", "createdAt": "2020-08-28T23:39:04Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/EntityRecordItemListener.java", "diffHunk": "@@ -266,15 +267,15 @@ private void insertFileUpdate(long consensusTimestamp, FileUpdateTransactionBody\n     private void insertFileData(long consensusTimestamp, byte[] contents, FileID fileID, int transactionTypeEnum) {\n         EntityId entityId = EntityId.of(fileID);\n         FileData fileData = new FileData(consensusTimestamp, contents, entityId, transactionTypeEnum);\n+        boolean addressBook = addressBookService.isAddressBook(entityId);\n \n-        if (addressBookService.isAddressBook(entityId)) {\n-            // if address book allow immediate persistence instead of waiting for batch\n+        if (addressBook || entityProperties.getPersist().isFiles() ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "381dd8e399b40d35af4878c82c6f1dbf51c12403"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93b5bf2b34d7f8cc1a258b9dd5b32b6a356e2f65", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/93b5bf2b34d7f8cc1a258b9dd5b32b6a356e2f65", "committedDate": "2020-08-31T17:21:46Z", "message": "Fix warmup in performance test\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9c45e98a066a1fcec9338b92dac2a173469c649", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b9c45e98a066a1fcec9338b92dac2a173469c649", "committedDate": "2020-08-31T22:56:37Z", "message": "Fix test\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d57e70abdfd2a446cafa37c6a360e6918a01bb12", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d57e70abdfd2a446cafa37c6a360e6918a01bb12", "committedDate": "2020-09-01T19:49:43Z", "message": "Fix performance regression\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e95798309425244f8006410cfda706f6b0027ff", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2e95798309425244f8006410cfda706f6b0027ff", "committedDate": "2020-09-01T19:55:24Z", "message": "Address review feedback\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMTgzNjMz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/995#pullrequestreview-480183633", "createdAt": "2020-09-01T23:29:17Z", "commit": {"oid": "2e95798309425244f8006410cfda706f6b0027ff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3654, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}