{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0OTI0Mzcw", "number": 1339, "title": "Add rest percentage check to monitor", "bodyText": "Detailed description:\n\nAdd property samplePercent to monitor to only validate certain transactions via REST.\n\nWhich issue(s) this PR fixes:\nFixes #1315\nSpecial notes for your reviewer:\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-12-09T05:54:45Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1339", "merged": true, "mergeCommit": {"oid": "1d40ec0e65a1a7f6b1a05ac3fc5d78d57067cd6e"}, "closed": true, "closedAt": "2020-12-11T16:24:51Z", "author": {"login": "ijungmann"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkYNANAH2gAyNTM0OTI0MzcwOjMwZWZlNzNmYzA1MWZmMjAyYjY4MmNiMjQzMjZjNGY3ZTI1OTI3Zjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlKba3AFqTU1MDI0NDMxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "30efe73fc051ff202b682cb24326c4f7e25927f8", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/30efe73fc051ff202b682cb24326c4f7e25927f8", "committedDate": "2020-12-09T05:50:26Z", "message": "Add rest percentage check to monitor\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "720cb7e10568ffd5d934ac38df7b91b94c383ec7", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/720cb7e10568ffd5d934ac38df7b91b94c383ec7", "committedDate": "2020-12-09T17:46:37Z", "message": "Fix test\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "405a09212d40afccab4cc5c6ce55a0ff80e39c18", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/405a09212d40afccab4cc5c6ce55a0ff80e39c18", "committedDate": "2020-12-09T20:59:11Z", "message": "Merge branch 'master' into monitor_spot_check_rest_subscriber"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fee077a639c11ccf8e716042ea8d31a5a3818f4d", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/fee077a639c11ccf8e716042ea8d31a5a3818f4d", "committedDate": "2020-12-10T05:38:38Z", "message": "Refactor and add test\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97ce7363b6f882439a034c9c4c7601250c5c992c", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/97ce7363b6f882439a034c9c4c7601250c5c992c", "committedDate": "2020-12-10T05:43:49Z", "message": "Refactor\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NjM5NzQy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1339#pullrequestreview-549639742", "createdAt": "2020-12-10T22:02:39Z", "commit": {"oid": "97ce7363b6f882439a034c9c4c7601250c5c992c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NjMzODQx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1339#pullrequestreview-549633841", "createdAt": "2020-12-10T21:54:01Z", "commit": {"oid": "97ce7363b6f882439a034c9c4c7601250c5c992c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMTo1NDowMVrOIDe-0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMjozMzoxOFrOIDgUsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDUyNDI0Mw==", "bodyText": "It shouldn't be greater than 1. So @Min(0) @Max(1) would be better.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1339#discussion_r540524243", "createdAt": "2020-12-10T21:54:01Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-monitor/src/main/java/com/hedera/mirror/monitor/subscribe/RestSubscriberProperties.java", "diffHunk": "@@ -38,4 +39,7 @@\n     public long getLimit() {\n         return limit > 0 ? limit : Long.MAX_VALUE;\n     }\n+\n+    @PositiveOrZero", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ce7363b6f882439a034c9c4c7601250c5c992c"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDUzMzk4Ng==", "bodyText": "Percentage is grammatically used for general measurements and not specific values. We should use percent instead.\nBut really what we're doing here is sampling. Generally that's measured in total sample size or sample rate/frequency. Ours is a sample percentage of the transaction rate. So we should either name it sampleRate or samplePercent to make clear it's a percentage.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1339#discussion_r540533986", "createdAt": "2020-12-10T22:10:44Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-monitor/src/main/java/com/hedera/mirror/monitor/subscribe/RestSubscriberProperties.java", "diffHunk": "@@ -38,4 +39,7 @@\n     public long getLimit() {\n         return limit > 0 ? limit : Long.MAX_VALUE;\n     }\n+\n+    @PositiveOrZero\n+    private double validationPercentage = 1.0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ce7363b6f882439a034c9c4c7601250c5c992c"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDUzNDQ3Mg==", "bodyText": "We should have tests for 100% and for a percent in between with a large enough sample size. See ConfigurableTransactionGeneratorTest for an example.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1339#discussion_r540534472", "createdAt": "2020-12-10T22:11:35Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-monitor/src/test/java/com/hedera/mirror/monitor/subscribe/RestSubscriberTest.java", "diffHunk": "@@ -170,6 +170,19 @@ void neverRecovers() throws Exception {\n         assertMetric(0L);\n     }\n \n+    @Test\n+    void zeroValidationPercentage() throws InterruptedException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ce7363b6f882439a034c9c4c7601250c5c992c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDUzNTk4NQ==", "bodyText": "Avoid the property reflection penalty by getting the percent once outside the flux as a primitive.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1339#discussion_r540535985", "createdAt": "2020-12-10T22:14:02Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-monitor/src/main/java/com/hedera/mirror/monitor/subscribe/RestSubscriber.java", "diffHunk": "@@ -72,12 +74,14 @@ public RestSubscriber(MeterRegistry meterRegistry, MonitorProperties monitorProp\n                         r.totalRetries() + 1, r.failure()));\n \n         directProcessor.doOnSubscribe(s -> log.info(\"Connecting to mirror node {}\", url))\n+                .filter(publishResponse -> shouldFilter(publishResponse, properties.getValidationPercentage()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ce7363b6f882439a034c9c4c7601250c5c992c"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU0MjM1MQ==", "bodyText": "RANDOM.nextDouble() < validationPercentage) is much more readable than Double.compare() in my opinion.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1339#discussion_r540542351", "createdAt": "2020-12-10T22:25:52Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-monitor/src/main/java/com/hedera/mirror/monitor/subscribe/RestSubscriber.java", "diffHunk": "@@ -98,6 +102,16 @@ private boolean shouldRetry(Throwable t) {\n                 ((WebClientResponseException) t).getStatusCode() == HttpStatus.NOT_FOUND;\n     }\n \n+    //Randomly filter out transactions to only validate a set percentage\n+    private boolean shouldFilter(PublishResponse publishResponse, double validationPercentage) {\n+        boolean filterOut = Double\n+                .compare(RANDOM.nextDouble(), validationPercentage) != -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ce7363b6f882439a034c9c4c7601250c5c992c"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU0NjIyNw==", "bodyText": "Inverting this logic just for an off by default log statement makes it more verbose and harder to understand. What's wrong with .filter(r -> RANDOM.nextDouble() < samplePercent)?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1339#discussion_r540546227", "createdAt": "2020-12-10T22:33:18Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-monitor/src/main/java/com/hedera/mirror/monitor/subscribe/RestSubscriber.java", "diffHunk": "@@ -98,6 +102,16 @@ private boolean shouldRetry(Throwable t) {\n                 ((WebClientResponseException) t).getStatusCode() == HttpStatus.NOT_FOUND;\n     }\n \n+    //Randomly filter out transactions to only validate a set percentage\n+    private boolean shouldFilter(PublishResponse publishResponse, double validationPercentage) {\n+        boolean filterOut = Double", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ce7363b6f882439a034c9c4c7601250c5c992c"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f16723b4696741e70b3d91dded76b64e52876121", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f16723b4696741e70b3d91dded76b64e52876121", "committedDate": "2020-12-10T23:38:40Z", "message": "Refactor for PR comments\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06ee39b2aba887eae2931b45978c98ddf09b6b83", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/06ee39b2aba887eae2931b45978c98ddf09b6b83", "committedDate": "2020-12-10T23:45:58Z", "message": "Refactor subscriber properties\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3773a3c65198f68c3ed88ab620fc6675f244d15", "author": {"user": {"login": "ijungmann", "name": "Ian Jungmann"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b3773a3c65198f68c3ed88ab620fc6675f244d15", "committedDate": "2020-12-11T03:19:44Z", "message": "Add tests\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMjMzNjky", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1339#pullrequestreview-550233692", "createdAt": "2020-12-11T16:08:25Z", "commit": {"oid": "b3773a3c65198f68c3ed88ab620fc6675f244d15"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMjQ0MzEw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1339#pullrequestreview-550244310", "createdAt": "2020-12-11T16:21:26Z", "commit": {"oid": "b3773a3c65198f68c3ed88ab620fc6675f244d15"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3408, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}