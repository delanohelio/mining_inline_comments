{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNTQxNzQy", "number": 663, "title": "Implement async rest api routes and centralized error handling", "bodyText": "Detailed description:\nIssue #631 noted a few short falls of The REST API code. Including\n\nunused Cacher.js\npartial asynchronous flows in requests\nTedious Error object sets in response with lots of distributed similar code\nSynchronous and asynchronous error catching mixed together\n\nThis change addresses the asks by\n\nAdding @awaitjs/express to allow for a middleware error handling using express logic\nMaking all route calls asynchronous\nMoving error logic to centralized error.js\nBubbling errors up to middleware\nRemoving unused methods from utils.js\nUpdating validation methods to throw errors instead of setting response\nUpdating specs and tests appropriately, also utilizing jest snapshots\n\nWhich issue(s) this PR fixes:\nFixes #631\nSpecial notes for your reviewer:\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-04-07T22:56:58Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663", "merged": true, "mergeCommit": {"oid": "b9250ea937b9bd84fa5264a6e1ddfa58f484486b"}, "closed": true, "closedAt": "2020-04-10T00:40:09Z", "author": {"login": "Nana-EC"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVbDEkgH2gAyNDAwNTQxNzQyOmMzOTMwMTUwNDY1NGM2YmExYTVmODVkOWY5ZWFkZWE1YTk3MDI3MjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWGGQmgFqTM5MTIxMjYxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c39301504654c6ba1a5f85d9f9eadea5a9702722", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c39301504654c6ba1a5f85d9f9eadea5a9702722", "committedDate": "2020-04-07T22:29:17Z", "message": "Implement async rest api routes and centralized error handling\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4842e61a51315f20c5bd8b9c60aafbfbe4477e82", "committedDate": "2020-04-07T22:46:16Z", "message": "Merge w master for v0.9 change\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NjY5MTc2", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#pullrequestreview-389669176", "createdAt": "2020-04-08T05:52:50Z", "commit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNTo1Mjo1MFrOGCf7FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNjozMToxNlrOGCgx3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI3MzM2NQ==", "bodyText": "Nice encapsulation of code and message.\nWould suggest naming it something different though since it is not 'handling' any error, it's a plain object (like domains in java). Say HttpError, HandlerException (since it is thrown by request handlers, or better yet HttpHandlerException), etc", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405273365", "createdAt": "2020-04-08T05:52:50Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/helpers/error.js", "diffHunk": "@@ -0,0 +1,88 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+class ErrorHandler extends Error {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI3Mzg5MA==", "bodyText": "this seems to be removing caching altogether, or maybe am missing something?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405273890", "createdAt": "2020-04-08T05:54:22Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/server.js", "diffHunk": "@@ -91,35 +92,25 @@ app.use(bodyParser.json());\n app.use(compression());\n app.use(cors());\n \n-let caches = {};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI3NDIyMA==", "bodyText": "adding a comment for special test hook would be useful", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405274220", "createdAt": "2020-04-08T05:55:19Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/helpers/error.js", "diffHunk": "@@ -0,0 +1,88 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+class ErrorHandler extends Error {\n+  constructor(statusCode, message) {\n+    super();\n+    this.statusCode = statusCode;\n+\n+    // support single error message or array of messages\n+    this.message = Array.isArray(message) ? message : [errorMessage(message)];\n+  }\n+}\n+\n+const httpStatusCodes = {\n+  OK: 200,\n+  BAD_REQUEST: 400,\n+  NOT_FOUND: 404,\n+  INTERNAL_ERROR: 500,\n+  SERVICE_UNAVAILABLE: 503,\n+};\n+\n+const httpErrorMessages = {\n+  NOT_FOUND: 'Not found',\n+  INTERNAL_ERROR: 'Internal error',\n+};\n+\n+const errorMessage = (message) => {\n+  return {message: message};\n+};\n+\n+const errorMessageFormat = (messages) => {\n+  return {\n+    _status: {\n+      messages: messages,\n+    },\n+  };\n+};\n+\n+const createSingleErrorJsonResponse = (message) => {\n+  return errorMessageFormat([errorMessage(message)]);\n+};\n+\n+const handleError = (err, req, res, next) => {\n+  if (process.env.NODE_ENV !== 'test') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI3NTc0NA==", "bodyText": "pardon my limited knowledge of rest api code, it is possible to catch this where this error is actually thrown and convert to 'our application error'. If not possible technically, then we should add a comment here.\nJust that seeing special case so high up in abstraction layer seems bad.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405275744", "createdAt": "2020-04-08T05:59:20Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/helpers/error.js", "diffHunk": "@@ -0,0 +1,88 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+class ErrorHandler extends Error {\n+  constructor(statusCode, message) {\n+    super();\n+    this.statusCode = statusCode;\n+\n+    // support single error message or array of messages\n+    this.message = Array.isArray(message) ? message : [errorMessage(message)];\n+  }\n+}\n+\n+const httpStatusCodes = {\n+  OK: 200,\n+  BAD_REQUEST: 400,\n+  NOT_FOUND: 404,\n+  INTERNAL_ERROR: 500,\n+  SERVICE_UNAVAILABLE: 503,\n+};\n+\n+const httpErrorMessages = {\n+  NOT_FOUND: 'Not found',\n+  INTERNAL_ERROR: 'Internal error',\n+};\n+\n+const errorMessage = (message) => {\n+  return {message: message};\n+};\n+\n+const errorMessageFormat = (messages) => {\n+  return {\n+    _status: {\n+      messages: messages,\n+    },\n+  };\n+};\n+\n+const createSingleErrorJsonResponse = (message) => {\n+  return errorMessageFormat([errorMessage(message)]);\n+};\n+\n+const handleError = (err, req, res, next) => {\n+  if (process.env.NODE_ENV !== 'test') {\n+    logger.error(`Error processing ${req.originalUrl}: `, err);\n+  }\n+\n+  const {statusCode, message} = err;\n+\n+  if (/ECONNREFUSED/.test(message)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI3OTI3OQ==", "bodyText": "events and eventAnalytics are also unused. We can remove them.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405279279", "createdAt": "2020-04-08T06:08:46Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/server.js", "diffHunk": "@@ -40,7 +41,7 @@ const accounts = require('./accounts.js');\n const topicmessage = require('./topicmessage.js');\n const eventAnalytics = require('./eventAnalytics.js');\n const utils = require('./utils.js');\n-const Cacher = require('./cacher.js');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4MDc4NA==", "bodyText": "Where is this thrown? Can't seem to find the code which throws this.\nEither ways, let's add the comment explaining the need to override the message...\"do not expose detailed internal errors externally...etc etc\"", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405280784", "createdAt": "2020-04-08T06:13:04Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/helpers/error.js", "diffHunk": "@@ -0,0 +1,88 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+class ErrorHandler extends Error {\n+  constructor(statusCode, message) {\n+    super();\n+    this.statusCode = statusCode;\n+\n+    // support single error message or array of messages\n+    this.message = Array.isArray(message) ? message : [errorMessage(message)];\n+  }\n+}\n+\n+const httpStatusCodes = {\n+  OK: 200,\n+  BAD_REQUEST: 400,\n+  NOT_FOUND: 404,\n+  INTERNAL_ERROR: 500,\n+  SERVICE_UNAVAILABLE: 503,\n+};\n+\n+const httpErrorMessages = {\n+  NOT_FOUND: 'Not found',\n+  INTERNAL_ERROR: 'Internal error',\n+};\n+\n+const errorMessage = (message) => {\n+  return {message: message};\n+};\n+\n+const errorMessageFormat = (messages) => {\n+  return {\n+    _status: {\n+      messages: messages,\n+    },\n+  };\n+};\n+\n+const createSingleErrorJsonResponse = (message) => {\n+  return errorMessageFormat([errorMessage(message)]);\n+};\n+\n+const handleError = (err, req, res, next) => {\n+  if (process.env.NODE_ENV !== 'test') {\n+    logger.error(`Error processing ${req.originalUrl}: `, err);\n+  }\n+\n+  const {statusCode, message} = err;\n+\n+  if (/ECONNREFUSED/.test(message)) {\n+    res\n+      .status(httpStatusCodes.SERVICE_UNAVAILABLE)\n+      .json(createSingleErrorJsonResponse('Unable to connect to database. Please retry later'));\n+    return;\n+  }\n+\n+  if (statusCode === httpStatusCodes.INTERNAL_ERROR) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4NDY3NA==", "bodyText": "This seems to be popular error. Would be good to have a function in error.js like\nconst ErrorForInvalidParams = function (params) => {\n  messages = params.map(param => {\n    return {message: `Invalid parameter: ${parama}`}\n  })\n  return new ErrorHandler(BAD_REQUEST, messages);\n}\n\nThen badParams will actually be just params, rather than messages.\nWill also remove many calls to getInvalidParameterMessageObject and utils will have 2 less functions.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405284674", "createdAt": "2020-04-08T06:23:53Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/topicmessage.js", "diffHunk": "@@ -60,37 +63,33 @@ const validateGetSequenceMessageParams = function (topicId, seqNum) {\n     badParams.push(utils.getInvalidParameterMessageObject(topicMessageColumns.SEQUENCE_NUMBER));\n   }\n \n-  return utils.makeValidationResponse(badParams);\n+  if (badParams.length > 0) {\n+    throw new ErrorHandler(httpStatusCodes.BAD_REQUEST, badParams);\n+  }\n+\n+  return true;\n };\n \n /**\n  * Verify topicId and sequencenumber meet entity_num and limit format\n  */\n const validateGetTopicMessagesParams = function (topicId) {\n-  let badParams = [];\n   if (!utils.isValidEntityNum(topicId)) {\n-    badParams.push(utils.getInvalidParameterMessageObject(topicMessageColumns.TOPIC_NUM));\n+    throw new ErrorHandler(httpStatusCodes.BAD_REQUEST, [", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4NDk5NA==", "bodyText": "is return value still needed?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405284994", "createdAt": "2020-04-08T06:24:47Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/topicmessage.js", "diffHunk": "@@ -60,37 +63,33 @@ const validateGetSequenceMessageParams = function (topicId, seqNum) {\n     badParams.push(utils.getInvalidParameterMessageObject(topicMessageColumns.SEQUENCE_NUMBER));\n   }\n \n-  return utils.makeValidationResponse(badParams);\n+  if (badParams.length > 0) {\n+    throw new ErrorHandler(httpStatusCodes.BAD_REQUEST, badParams);\n+  }\n+\n+  return true;\n };\n \n /**\n  * Verify topicId and sequencenumber meet entity_num and limit format\n  */\n const validateGetTopicMessagesParams = function (topicId) {\n-  let badParams = [];\n   if (!utils.isValidEntityNum(topicId)) {\n-    badParams.push(utils.getInvalidParameterMessageObject(topicMessageColumns.TOPIC_NUM));\n+    throw new ErrorHandler(httpStatusCodes.BAD_REQUEST, [\n+      utils.getInvalidParameterMessageObject(topicMessageColumns.TOPIC_NUM),\n+    ]);\n   }\n \n-  return utils.makeValidationResponse(badParams);\n+  return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4NTI1NA==", "bodyText": "nit: empty tags can be removed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405285254", "createdAt": "2020-04-08T06:25:25Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/topicmessage.js", "diffHunk": "@@ -271,31 +253,33 @@ const getMessages = async (pgSqlQuery, pgSqlParams) => {\n  * @param {Request} req HTTP request object\n  * @return {Promise} Promise for PostgreSQL query\n  */\n-const getMessageByConsensusTimestamp = function (req, res) {\n+const getMessageByConsensusTimestamp = async (req, res) => {\n   logger.debug('--------------------  getMessageByConsensusTimestamp --------------------');\n   logger.debug(`Client: [ ${req.ip} ] URL: ${req.originalUrl}`);\n-  return processGetMessageByConsensusTimestampRequest(req.params, res).catch((error) =>\n-    utils.errorHandler(error, req, res, null)\n-  );\n+  return processGetMessageByConsensusTimestampRequest(req.params, res);\n };\n \n /**\n  * Handler function for /:id/message/:sequencenumber API.\n  * @param {Request} req HTTP request object\n  * @return {Promise} Promise for PostgreSQL query\n  */\n-const getMessageByTopicAndSequenceRequest = function (req, res) {\n+const getMessageByTopicAndSequenceRequest = async (req, res) => {\n   logger.debug('--------------------  getMessageByTopicAndSequenceRequest --------------------');\n   logger.debug(`Client: [ ${req.ip} ] URL: ${req.originalUrl}`);\n-  return processGetMessageByTopicAndSequenceRequest(req.params, res).catch((error) =>\n-    utils.errorHandler(error, req, res, null)\n-  );\n+  return processGetMessageByTopicAndSequenceRequest(req.params, res);\n };\n \n-const getTopicMessages = (req, res) => {\n+/**\n+ * Handler function for /topics/:id API.\n+ * @param req", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 171}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4NzM4OQ==", "bodyText": "we can make this just logger.debug() too. If okay to have debug as default log level in tests, but tests hooks in prod code are code smell.\ni know this is not your code, but I blame you for making all the past code here awesome.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405287389", "createdAt": "2020-04-08T06:31:16Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -304,30 +297,26 @@ const getOneTransaction = function (req, res) {\n   logger.trace('getOneTransaction query: ' + pgSqlQuery + JSON.stringify(sqlParams));\n \n   // Execute query\n-  pool\n-    .query(pgSqlQuery, sqlParams)\n-    .then((results) => {\n-      let ret = {\n-        transactions: [],\n-      };\n-\n-      logger.debug('# rows returned: ' + results.rows.length);\n-      const tl = createTransferLists(results.rows, ret);\n-      ret = tl.ret;\n-\n-      if (ret.transactions.length === 0) {\n-        res.status(utils.httpStatusCodes.NOT_FOUND).send(utils.createSingleErrorJsonResponse('Not found'));\n-        return;\n-      }\n-\n-      if (process.env.NODE_ENV === 'test') {\n-        ret.sqlQuery = results.sqlQuery;\n-      }\n-\n-      logger.debug('getOneTransaction returning ' + ret.transactions.length + ' entries');\n-      res.json(ret);\n-    })\n-    .catch((error) => utils.errorHandler(error, req, res, null));\n+  return await pool.query(pgSqlQuery, sqlParams).then((results) => {\n+    let ret = {\n+      transactions: [],\n+    };\n+\n+    logger.debug('# rows returned: ' + results.rows.length);\n+    const tl = createTransferLists(results.rows, ret);\n+    ret = tl.ret;\n+\n+    if (ret.transactions.length === 0) {\n+      throw new ErrorHandler(httpStatusCodes.NOT_FOUND, 'Not found');\n+    }\n+\n+    if (process.env.NODE_ENV === 'test') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMDcxMzcx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#pullrequestreview-390071371", "createdAt": "2020-04-08T15:13:41Z", "commit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNToxMzo0MVrOGCz8mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNTo0NDo1MFrOGC1XKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYwMTQzMg==", "bodyText": "Can remove", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405601432", "createdAt": "2020-04-08T15:13:41Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/server.js", "diffHunk": "@@ -91,35 +92,25 @@ app.use(bodyParser.json());\n app.use(compression());\n app.use(cors());\n \n-let caches = {};\n-for (const api of [\n-  {name: 'transactions', ttl: config.api.ttl.transactions},\n-  {name: 'balances', ttl: config.api.ttl.balances},\n-  {name: 'accounts', ttl: config.api.ttl.accounts},\n-  {name: 'events', ttl: config.api.ttl.events},\n-]) {\n-  caches[api.name] = new Cacher(api.ttl);\n-}\n-\n let apiPrefix = '/api/v1';\n \n // routes\n-app.get(apiPrefix + '/transactions', (req, res) =>\n-  caches['transactions'].getResponse(req, res, transactions.getTransactions)\n-);\n-app.get(apiPrefix + '/transactions/:id', transactions.getOneTransaction);\n-app.get(apiPrefix + '/balances', (req, res) => caches['balances'].getResponse(req, res, balances.getBalances));\n-app.get(apiPrefix + '/accounts', (req, res) => caches['accounts'].getResponse(req, res, accounts.getAccounts));\n-app.get(apiPrefix + '/accounts/:id', accounts.getOneAccount);\n-app.get(apiPrefix + '/topic/message/:consensusTimestamp', topicmessage.getMessageByConsensusTimestamp);\n-app.use(utils.errorHandler);\n+app.getAsync(apiPrefix + '/transactions', transactions.getTransactions);\n+app.getAsync(apiPrefix + '/transactions/:id', transactions.getOneTransaction);\n+app.getAsync(apiPrefix + '/balances', balances.getBalances);\n+app.getAsync(apiPrefix + '/accounts', accounts.getAccounts);\n+app.getAsync(apiPrefix + '/accounts/:id', accounts.getOneAccount);\n+app.getAsync(apiPrefix + '/topic/message/:consensusTimestamp', topicmessage.getMessageByConsensusTimestamp);\n \n // support singular and plural resource naming for single topic message via id and sequence\n-app.get(apiPrefix + '/topic/:id/message/:sequencenumber', topicmessage.getMessageByTopicAndSequenceRequest);\n-app.get(apiPrefix + '/topics/:id/messages/:sequencenumber', topicmessage.getMessageByTopicAndSequenceRequest);\n+app.getAsync(apiPrefix + '/topic/:id/message/:sequencenumber', topicmessage.getMessageByTopicAndSequenceRequest);\n+app.getAsync(apiPrefix + '/topics/:id/messages/:sequencenumber', topicmessage.getMessageByTopicAndSequenceRequest);\n+\n+app.getAsync(apiPrefix + '/topics/:id', topicmessage.getTopicMessages);\n+app.getAsync(apiPrefix + '/topic/:id', topicmessage.getTopicMessages);\n \n-app.get(apiPrefix + '/topics/:id', topicmessage.getTopicMessages);\n-app.get(apiPrefix + '/topic/:id', topicmessage.getTopicMessages);\n+// app.use(utils.errorHandler);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYxMzEzOA==", "bodyText": "I don't like the intermixing of three separate concerns:\n\nError itself\nError handling\nHTTP\n\nThere should not be a single error type but a hierarchy of errors like InvalidArgumentError, NotFoundError, etc. These should not contain any HTTP specific knowledge like status codes. There should be a HttpErrorHandler that maps these application errors to HTTP responses.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405613138", "createdAt": "2020-04-08T15:29:10Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/helpers/error.js", "diffHunk": "@@ -0,0 +1,88 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+class ErrorHandler extends Error {\n+  constructor(statusCode, message) {\n+    super();\n+    this.statusCode = statusCode;\n+\n+    // support single error message or array of messages\n+    this.message = Array.isArray(message) ? message : [errorMessage(message)];\n+  }\n+}\n+\n+const httpStatusCodes = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYxMzc5Nw==", "bodyText": "We shouldn't be throwing INTERNAL_ERROR. Instead, it should be the default response if the error is not one of the errors we explicitly throw.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405613797", "createdAt": "2020-04-08T15:30:03Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/helpers/error.js", "diffHunk": "@@ -0,0 +1,88 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+class ErrorHandler extends Error {\n+  constructor(statusCode, message) {\n+    super();\n+    this.statusCode = statusCode;\n+\n+    // support single error message or array of messages\n+    this.message = Array.isArray(message) ? message : [errorMessage(message)];\n+  }\n+}\n+\n+const httpStatusCodes = {\n+  OK: 200,\n+  BAD_REQUEST: 400,\n+  NOT_FOUND: 404,\n+  INTERNAL_ERROR: 500,\n+  SERVICE_UNAVAILABLE: 503,\n+};\n+\n+const httpErrorMessages = {\n+  NOT_FOUND: 'Not found',\n+  INTERNAL_ERROR: 'Internal error',\n+};\n+\n+const errorMessage = (message) => {\n+  return {message: message};\n+};\n+\n+const errorMessageFormat = (messages) => {\n+  return {\n+    _status: {\n+      messages: messages,\n+    },\n+  };\n+};\n+\n+const createSingleErrorJsonResponse = (message) => {\n+  return errorMessageFormat([errorMessage(message)]);\n+};\n+\n+const handleError = (err, req, res, next) => {\n+  if (process.env.NODE_ENV !== 'test') {\n+    logger.error(`Error processing ${req.originalUrl}: `, err);\n+  }\n+\n+  const {statusCode, message} = err;\n+\n+  if (/ECONNREFUSED/.test(message)) {\n+    res\n+      .status(httpStatusCodes.SERVICE_UNAVAILABLE)\n+      .json(createSingleErrorJsonResponse('Unable to connect to database. Please retry later'));\n+    return;\n+  }\n+\n+  if (statusCode === httpStatusCodes.INTERNAL_ERROR) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYxNDk0Mg==", "bodyText": "Let's just remove the file (and node-cache). We can add it back if needed in #668. This logic can move to the error handler", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405614942", "createdAt": "2020-04-08T15:31:37Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/cacher.js", "diffHunk": "@@ -50,17 +50,13 @@ class Cacher {\n     // TODO: Enable intellgent caching later by detecting if the content is\n     // cacheable by checking if the response to the query will not change.\n     // For now, we disable caching.\n-    func(req, res)\n-      .then((data) => {\n-        if (data.code != utils.httpStatusCodes.OK) {\n-          res.status(data.code).send(data.contents);\n-        } else {\n-          res.json(data.contents);\n-        }\n-      })\n-      .catch((err) => {\n-        utils.errorHandler(err, req, res, null);\n-      });\n+    func(req, res).then((data) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYxNTM4NA==", "bodyText": "Why are we blocking here? Should just return the promise. Same comment everywhere else.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405615384", "createdAt": "2020-04-08T15:32:12Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/balances.js", "diffHunk": "@@ -119,7 +113,7 @@ const getBalances = function (req, res) {\n   logger.trace('getBalance query: ' + pgSqlQuery + JSON.stringify(sqlParams));\n \n   // Execute query\n-  return pool.query(pgSqlQuery, sqlParams).then((results) => {\n+  return await pool.query(pgSqlQuery, sqlParams).then((results) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYxNzcwOA==", "bodyText": "These options should also be removed from config/application.yaml and docs/configuration.md (and search for others)", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405617708", "createdAt": "2020-04-08T15:35:20Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/server.js", "diffHunk": "@@ -91,35 +92,25 @@ app.use(bodyParser.json());\n app.use(compression());\n app.use(cors());\n \n-let caches = {};\n-for (const api of [\n-  {name: 'transactions', ttl: config.api.ttl.transactions},", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYxODY3Ng==", "bodyText": "Would prefer an error package and handler and concrete errors all existing in there. Helpers is generic and is not self descriptive", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405618676", "createdAt": "2020-04-08T15:36:35Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/server.js", "diffHunk": "@@ -40,7 +41,7 @@ const accounts = require('./accounts.js');\n const topicmessage = require('./topicmessage.js');\n const eventAnalytics = require('./eventAnalytics.js');\n const utils = require('./utils.js');\n-const Cacher = require('./cacher.js');\n+const {handleError} = require('./helpers/error');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYxOTUzNQ==", "bodyText": "Agree, except would recommend a concrete InvalidArgumentError extends Error that does this.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405619535", "createdAt": "2020-04-08T15:37:42Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/topicmessage.js", "diffHunk": "@@ -60,37 +63,33 @@ const validateGetSequenceMessageParams = function (topicId, seqNum) {\n     badParams.push(utils.getInvalidParameterMessageObject(topicMessageColumns.SEQUENCE_NUMBER));\n   }\n \n-  return utils.makeValidationResponse(badParams);\n+  if (badParams.length > 0) {\n+    throw new ErrorHandler(httpStatusCodes.BAD_REQUEST, badParams);\n+  }\n+\n+  return true;\n };\n \n /**\n  * Verify topicId and sequencenumber meet entity_num and limit format\n  */\n const validateGetTopicMessagesParams = function (topicId) {\n-  let badParams = [];\n   if (!utils.isValidEntityNum(topicId)) {\n-    badParams.push(utils.getInvalidParameterMessageObject(topicMessageColumns.TOPIC_NUM));\n+    throw new ErrorHandler(httpStatusCodes.BAD_REQUEST, [", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4NDY3NA=="}, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYyMDQ5NA==", "bodyText": "All these validate methods should not need to return booleans anymore if they throw errors as Appy indicated below as well.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405620494", "createdAt": "2020-04-08T15:39:03Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/topicmessage.js", "diffHunk": "@@ -40,11 +41,13 @@ const columnMap = {\n  * Verify consensusTimestamp meets seconds or seconds.upto 9 digits format\n  */\n const validateConsensusTimestampParam = function (consensusTimestamp) {\n-  let badParams = [];\n   if (!utils.isValidTimestampParam(consensusTimestamp)) {\n-    badParams.push({message: `Invalid parameter: consensusTimestamp`});\n+    throw new ErrorHandler(httpStatusCodes.BAD_REQUEST, [\n+      utils.getInvalidParameterMessageObject(topicMessageColumns.CONSENSUS_TIMESTAMP),\n+    ]);\n   }\n-  return utils.makeValidationResponse(badParams);\n+\n+  return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYyMTU3NA==", "bodyText": "Don't have to do it in this PR, but we should probably wrap these heavyweight query logs in if (logger.isTraceEnabled()) to avoid the performance penalty of constructing the strings.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405621574", "createdAt": "2020-04-08T15:40:35Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -198,21 +199,16 @@ const reqToSql = function (req) {\n  * @param {Request} req HTTP request object\n  * @return {Promise} Promise for PostgreSQL query\n  */\n-const getTransactions = function (req) {\n+const getTransactions = async (req, res) => {\n   // Validate query parameters first\n-  const valid = utils.validateReq(req);\n-  if (!valid.isValid) {\n-    return new Promise((resolve, reject) => {\n-      resolve(valid);\n-    });\n-  }\n+  utils.validateReq(req);\n \n   let query = reqToSql(req);\n \n   logger.trace('getTransactions query: ' + query.query + JSON.stringify(query.params));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYyMjU1NQ==", "bodyText": "Can we just return ret and higher level middleware convert to json? We may want to support other content types in the future, for example and would like to move service layer to not be http specific. Same comment applies to other areas.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405622555", "createdAt": "2020-04-08T15:42:02Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -240,10 +236,7 @@ const getTransactions = function (req) {\n \n     logger.debug('getTransactions returning ' + ret.transactions.length + ' entries');\n \n-    return {\n-      code: utils.httpStatusCodes.OK,\n-      contents: ret,\n-    };\n+    res.json(ret);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYyNDYxOQ==", "bodyText": "Agree, don't like if (process.env.NODE_ENV === 'test') anywhere. Think this is not used for logging though but for unit tests. But code should probably be refactored later to move sql construction to separate method that can be unit tested. Think that's a bigger change though.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405624619", "createdAt": "2020-04-08T15:44:50Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -304,30 +297,26 @@ const getOneTransaction = function (req, res) {\n   logger.trace('getOneTransaction query: ' + pgSqlQuery + JSON.stringify(sqlParams));\n \n   // Execute query\n-  pool\n-    .query(pgSqlQuery, sqlParams)\n-    .then((results) => {\n-      let ret = {\n-        transactions: [],\n-      };\n-\n-      logger.debug('# rows returned: ' + results.rows.length);\n-      const tl = createTransferLists(results.rows, ret);\n-      ret = tl.ret;\n-\n-      if (ret.transactions.length === 0) {\n-        res.status(utils.httpStatusCodes.NOT_FOUND).send(utils.createSingleErrorJsonResponse('Not found'));\n-        return;\n-      }\n-\n-      if (process.env.NODE_ENV === 'test') {\n-        ret.sqlQuery = results.sqlQuery;\n-      }\n-\n-      logger.debug('getOneTransaction returning ' + ret.transactions.length + ' entries');\n-      res.json(ret);\n-    })\n-    .catch((error) => utils.errorHandler(error, req, res, null));\n+  return await pool.query(pgSqlQuery, sqlParams).then((results) => {\n+    let ret = {\n+      transactions: [],\n+    };\n+\n+    logger.debug('# rows returned: ' + results.rows.length);\n+    const tl = createTransferLists(results.rows, ret);\n+    ret = tl.ret;\n+\n+    if (ret.transactions.length === 0) {\n+      throw new ErrorHandler(httpStatusCodes.NOT_FOUND, 'Not found');\n+    }\n+\n+    if (process.env.NODE_ENV === 'test') {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4NzM4OQ=="}, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NjkxMTE5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#pullrequestreview-389691119", "createdAt": "2020-04-08T06:44:02Z", "commit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNjo0NDowM1rOGChFgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMTo0MDo1MlrOGDB_2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI5MjQxOA==", "bodyText": "I believe it can be very useful to separate expected values when they are ~100 lines, to improve test code readability. For this particular case, since expected values are trivial and can be defined as constants in utilsFilters and shared across the tests in that file - splitting into snapshot seems unnecessary fragmentation.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405292418", "createdAt": "2020-04-08T06:44:03Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/__tests__/__snapshots__/topicmessage.test.js.snap", "diffHunk": "@@ -0,0 +1,74 @@\n+// Jest Snapshot v1, https://goo.gl/fbAQLP\n+\n+exports[`topicmessage validateConsensusTimestampParam tests Verify validateConsensusTimestampParam returns correct result for -1234567890.000000001 1`] = `", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc4ODg3Nw==", "bodyText": "looks like not used?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405788877", "createdAt": "2020-04-08T20:18:22Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/__tests__/utils.test.js", "diffHunk": "@@ -19,10 +19,9 @@\n  */\n 'use strict';\n \n-const request = require('supertest');\n const utils = require('../utils.js');\n-const constants = require('../constants.js');\n const config = require('../config.js');\n+const {httpStatusCodes} = require('../helpers/error');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzMTY0MQ==", "bodyText": "yeah, expected values broken into separate file decreases readability. We are going towards less cohesion and more coupling (between files, matching on test names) when the tests are simple enough to not need jest snapshots.\nAlso, this is an internal function (not api) with an internal object as expected value. Standard way of building expected value (using Error's constructor) and then matching the objects seems right.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405831641", "createdAt": "2020-04-08T21:40:52Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/__tests__/utilsFilters.test.js", "diffHunk": "@@ -211,16 +194,7 @@ describe('utils validateAndParseFilters tests', () => {\n       utils.buildComparatorFilter(constants.filterKeys.ACCOUNT_BALANCE, '23456789012345678901234'),\n     ];\n \n-    let validationResponse = utils.validateAndParseFilters(filters);\n-\n-    verifyInvalidFilters(validationResponse, [\n-      constants.filterKeys.ACCOUNT_ID,\n-      constants.filterKeys.TIMESTAMP,\n-      constants.filterKeys.LIMIT,\n-      constants.filterKeys.SEQUENCE_NUMBER,\n-      constants.filterKeys.ACCOUNT_PUBLICKEY,\n-      constants.filterKeys.ACCOUNT_BALANCE,\n-    ]);\n+    verifyInvalidFilters(filters);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4842e61a51315f20c5bd8b9c60aafbfbe4477e82"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4eaecbe2a2d3664fa1bbb2476858eec7a1d338e8", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4eaecbe2a2d3664fa1bbb2476858eec7a1d338e8", "committedDate": "2020-04-09T00:53:34Z", "message": "Implemented custome error classes and addressed other feedback\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07a72f468d993eb6b8dd89784bf600aacf750858", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/07a72f468d993eb6b8dd89784bf600aacf750858", "committedDate": "2020-04-09T00:57:25Z", "message": "Merge w master 4/8/20\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57fc87cbe9b8a4503186775d12232574bb691e01", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/57fc87cbe9b8a4503186775d12232574bb691e01", "committedDate": "2020-04-09T01:22:12Z", "message": "Updated validation to not return true and affected tests appropriately\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDMwNjI4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#pullrequestreview-390430628", "createdAt": "2020-04-09T01:12:01Z", "commit": {"oid": "07a72f468d993eb6b8dd89784bf600aacf750858"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMTozNzo0N1rOGDGqIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMTozNzo0N1rOGDGqIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkwODAwMA==", "bodyText": "Right now sub-classes are use ctor if it's single message, otherwise directly setting this.message in their own ctor. And all sub-classes are taking responsibility of formatting messages.\nWe can make things simpler.\n\nknowledge of error message --> json formatting abstraction can be limited to this class. This class can take in single/array of plain error strings. Sub-classes don't need to bother with knowledge of json formatting (and adhering to it)\nhere in this ctor:\n\nif (!Array.isArray(messages)) {\n  messages = [messages]\n}\nthis.jsonError = {\n    _status: {\n      messages: messages.map(m => { return {message: m}; }),\n    },\n  };\n\n('message' is being used in 5-6 different contexts, becoming confusing. We can use different variable names, hence 'jsonError')\n\n3 other fns in this class can be deleted\n\nIn sub-classes:\n\nno change in badRequestError, httpError, notFoundError\ndbError can have boolean isDbConnectionError. It can be set in ctor.\ninvalidArgumentError\n\n// Plain ctor like other errors. If any api wants to throw custom error messages on invalid argument, it can directly use ctor.\n\n// factory method to help common case\nstatic forParams(badParams) {\n  if(!Array.isArray(badParams) {\n    badParam = [badParams];\n  }\n  return new InvalidArgumentError(badParams.map(p => `${httpErrorMessages.INVALID_ARGUMENT}${message}`));\n}", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405908000", "createdAt": "2020-04-09T01:37:47Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/errors/formattedError.js", "diffHunk": "@@ -0,0 +1,63 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+class FormattedError extends Error {\n+  constructor(message) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07a72f468d993eb6b8dd89784bf600aacf750858"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91d996201a7d5cdb0c80c7796c922a8172ec14fa", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/91d996201a7d5cdb0c80c7796c922a8172ec14fa", "committedDate": "2020-04-09T02:54:02Z", "message": "Implemented middleware to set the response json\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44abd7e050753c0c5a0e20ddc30d0c33cdea82fc", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/44abd7e050753c0c5a0e20ddc30d0c33cdea82fc", "committedDate": "2020-04-09T03:06:03Z", "message": "Simplified error message formatting per Appy recommendations\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNTgyNTMy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#pullrequestreview-390582532", "createdAt": "2020-04-09T08:17:20Z", "commit": {"oid": "44abd7e050753c0c5a0e20ddc30d0c33cdea82fc"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwODoxNzoyMFrOGDOXyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwODo0MzozMFrOGDPTiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAzNDM3OA==", "bodyText": "It's clear what it's doing. Why it's doing that would be more useful in comment. I am sure you tried to remove it and found a gotcha. Documenting that gotcha is important so that anyone working in these parts in future can avoid the pit you just found.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r406034378", "createdAt": "2020-04-09T08:17:20Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/middleware/httpErrorHandler.js", "diffHunk": "@@ -0,0 +1,55 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const {DbError} = require('../errors/dbError');\n+const {FormattedError} = require('../errors/formattedError');\n+const {httpStatusCodes, HttpError} = require('../errors/httpError');\n+\n+const handleError = (err, req, res, next) => {\n+  // only logs in non test environment", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44abd7e050753c0c5a0e20ddc30d0c33cdea82fc"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAzOTEyMA==", "bodyText": "statusCode is not valid unless error has been verified to be instance of HttpError.\nSo this should be inside if (err instanceof HttpError)", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r406039120", "createdAt": "2020-04-09T08:25:33Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/middleware/httpErrorHandler.js", "diffHunk": "@@ -0,0 +1,55 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const {DbError} = require('../errors/dbError');\n+const {FormattedError} = require('../errors/formattedError');\n+const {httpStatusCodes, HttpError} = require('../errors/httpError');\n+\n+const handleError = (err, req, res, next) => {\n+  // only logs in non test environment\n+  if (process.env.NODE_ENV !== 'test') {\n+    logger.error(`Error processing ${req.originalUrl}: `, err);\n+  }\n+\n+  const {statusCode, message} = err;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44abd7e050753c0c5a0e20ddc30d0c33cdea82fc"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0OTY3Mg==", "bodyText": "This is just doing regex match on generic error.message like before rather than taking the advantage of our new custom errors.\nAs it is, isDbConnectionError function can even be moved to util and it doesn't affect anything.\nRather, it can be made property of error itself. A DbError can be connection error or not. And it should easy to check it by something like error.isConnectionError.\nThe code here would be then:\nif (err instanceof DbError && err.isConnectionError) {\n  res.status(..).json(...); \n}\n\nAlso, creating a new DbError() just to get DbErrorMessage suggests something is wrong.\nIn DbError,\n\nactual message should be use to set isConnectionError property\nalways pass DbErrorMessage to parent class\nAdditionally, log the actual underlying error here. It can be stored in this.baseError or field of similar sort.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r406049672", "createdAt": "2020-04-09T08:43:30Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/middleware/httpErrorHandler.js", "diffHunk": "@@ -0,0 +1,55 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const {DbError} = require('../errors/dbError');\n+const {FormattedError} = require('../errors/formattedError');\n+const {httpStatusCodes, HttpError} = require('../errors/httpError');\n+\n+const handleError = (err, req, res, next) => {\n+  // only logs in non test environment\n+  if (process.env.NODE_ENV !== 'test') {\n+    logger.error(`Error processing ${req.originalUrl}: `, err);\n+  }\n+\n+  const {statusCode, message} = err;\n+  // catch DB errors\n+  if (DbError.isDbConnectionError(message)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44abd7e050753c0c5a0e20ddc30d0c33cdea82fc"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDYzODE4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#pullrequestreview-390463818", "createdAt": "2020-04-09T03:11:32Z", "commit": {"oid": "44abd7e050753c0c5a0e20ddc30d0c33cdea82fc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzoxMTozMlrOGDIGlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNjowOToyNFrOGDfg7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMTY3MQ==", "bodyText": "Undo extra spacing. We may need to tweak prettier's config to change  indenting or add *.yaml/yml to .prettierignore.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405931671", "createdAt": "2020-04-09T03:11:32Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/config/application.yml", "diffHunk": "@@ -1,21 +1,16 @@\n # This file contains application defaults and shouldn't be modified. See docs/configuration.md for how to override.\n hedera:\n-  mirror:\n-    api:\n-      includeHostInLink: false\n-      maxLimit: 1000\n-      log:\n-        level: debug\n-      port: 5551\n-      ttl:\n-        accounts: 60\n-        balances: 60\n-        events: 10\n-        transactions: 10\n-    db:\n-      apiPassword: mirror_api_pass\n-      apiUsername: mirror_api\n-      host: 127.0.0.1\n-      name: mirror_node\n-      port: 5432\n-    shard: 0\n+    mirror:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44abd7e050753c0c5a0e20ddc30d0c33cdea82fc"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMjA0Ng==", "bodyText": "I'm confused. Why would the return value be set on the request object? This is undocumented and seems like bad practice. The recommended way is to use res.locals. Though if you set a variable on the response you might as well just res.json(ret) as it's not much of an improvement. Also, not sure if you're required to call next() in this scenario.\nMy intent was to decouple the service layer from the HTTP layer. Why don't we just return ret; and then in server.js:\napp.getAsync(apiPrefix + '/transactions', (req, res) => transactions.getTransactions(req).then(ret => res.json(ret)));", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405932046", "createdAt": "2020-04-09T03:13:07Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/accounts.js", "diffHunk": "@@ -173,11 +171,7 @@ const getAccounts = function (req) {\n     }\n \n     logger.debug('getAccounts returning ' + ret.accounts.length + ' entries');\n-\n-    return {\n-      code: utils.httpStatusCodes.OK,\n-      contents: ret,\n-    };\n+    req[constants.responseDataLabel] = ret;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44abd7e050753c0c5a0e20ddc30d0c33cdea82fc"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMzI2Nw==", "bodyText": "Why would this not just be InvalidArgumentError? I don't understand the need for BadRequestError as they both return the same http status code and are about bad input.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r405933267", "createdAt": "2020-04-09T03:18:03Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -265,8 +259,8 @@ const getOneTransaction = function (req, res) {\n     let message =\n       'Invalid Transaction id. Please use \"shard.realm.num-ssssssssss-nnnnnnnnn\" ' +\n       'format where ssss are 10 digits seconds and nnn are 9 digits nanoseconds';\n-    res.status(utils.httpStatusCodes.BAD_REQUEST).send(utils.createSingleErrorJsonResponse(message));\n-    return;\n+\n+    throw new BadRequestError(message);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44abd7e050753c0c5a0e20ddc30d0c33cdea82fc"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMxNTI0NA==", "bodyText": "res can be removed from all the service layer methods.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r406315244", "createdAt": "2020-04-09T16:09:24Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/topicmessage.js", "diffHunk": "@@ -271,31 +246,33 @@ const getMessages = async (pgSqlQuery, pgSqlParams) => {\n  * @param {Request} req HTTP request object\n  * @return {Promise} Promise for PostgreSQL query\n  */\n-const getMessageByConsensusTimestamp = function (req, res) {\n+const getMessageByConsensusTimestamp = async (req, res) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44abd7e050753c0c5a0e20ddc30d0c33cdea82fc"}, "originalPosition": 194}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76525b87edc26dccf1597dce849f9985399c3fb3", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/76525b87edc26dccf1597dce849f9985399c3fb3", "committedDate": "2020-04-09T18:35:46Z", "message": "Fixed error hierarchy design issues\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e931b1e0215ba518c042bfde08e9057d9b94ae9", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9e931b1e0215ba518c042bfde08e9057d9b94ae9", "committedDate": "2020-04-09T19:28:32Z", "message": "Removed unused res params\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMDcyNzk3", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#pullrequestreview-391072797", "createdAt": "2020-04-09T19:30:02Z", "commit": {"oid": "76525b87edc26dccf1597dce849f9985399c3fb3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxOTozMDowMlrOGDmcYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxOTo0MzozOVrOGDm3bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQyODc2OQ==", "bodyText": "can do return (/ECONNREFUSED/.test(errorMessage) || /Connection terminated unexpectedly/.test(errorMessage) || /unable to read data from DB/.test(errorMessage))", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r406428769", "createdAt": "2020-04-09T19:30:02Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/errors/dbError.js", "diffHunk": "@@ -0,0 +1,53 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+const {FormattedError} = require('./formattedError');\n+\n+const DbErrorMessage = 'Unable to connect to database. Please retry later';\n+\n+class DbError extends FormattedError {\n+  constructor(errorMessage) {\n+    super(DbErrorMessage);\n+    this.dbErrorMessage = errorMessage;\n+    this.isConnectionError = this.isDbConnectionError(errorMessage);\n+  }\n+\n+  /**\n+   * Match known db error connection messages\n+   * @param errorMessage\n+   * @returns {boolean}\n+   */\n+  isDbConnectionError(errorMessage) {\n+    if (", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76525b87edc26dccf1597dce849f9985399c3fb3"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQzNTY5Mg==", "bodyText": "I agree that having two classes here for same logical error is not required. An earlier suggestion to avoid the same was making InvalidArgumentError class ctor general (and similar to other errors), and a helper method for common case. Copying it below. The code here will use the ctor.\n// Plain ctor like other errors. If any api wants to throw custom error messages on invalid argument, it can directly use ctor.\n\n// factory method to help common case\nstatic forParams(badParams) {\n  if(!Array.isArray(badParams) {\n    badParam = [badParams];\n  }\n  return new InvalidArgumentError(badParams.map(p => `${httpErrorMessages.INVALID_ARGUMENT}${message}`));\n}", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r406435692", "createdAt": "2020-04-09T19:43:39Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -265,8 +259,8 @@ const getOneTransaction = function (req, res) {\n     let message =\n       'Invalid Transaction id. Please use \"shard.realm.num-ssssssssss-nnnnnnnnn\" ' +\n       'format where ssss are 10 digits seconds and nnn are 9 digits nanoseconds';\n-    res.status(utils.httpStatusCodes.BAD_REQUEST).send(utils.createSingleErrorJsonResponse(message));\n-    return;\n+\n+    throw new BadRequestError(message);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMzI2Nw=="}, "originalCommit": {"oid": "44abd7e050753c0c5a0e20ddc30d0c33cdea82fc"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMDkwMTIx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#pullrequestreview-391090121", "createdAt": "2020-04-09T19:57:25Z", "commit": {"oid": "9e931b1e0215ba518c042bfde08e9057d9b94ae9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxOTo1NzoyNVrOGDnT1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxOTo1NzoyNVrOGDnT1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ0Mjk2NA==", "bodyText": "FormattedError is just converting single message to array. It is not a 'type of error'.\nWe should remove this and let httpErrorHandler.errorMessageFormat do the if(!Array...)", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r406442964", "createdAt": "2020-04-09T19:57:25Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/errors/formattedError.js", "diffHunk": "@@ -0,0 +1,36 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+class FormattedError extends Error {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e931b1e0215ba518c042bfde08e9057d9b94ae9"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44fe3f0482766b2d4ab86c39ca23ffda157f822a", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/44fe3f0482766b2d4ab86c39ca23ffda157f822a", "committedDate": "2020-04-09T20:25:37Z", "message": "Removed FormattedError and BadRequestError\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTQ5MzEz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#pullrequestreview-391149313", "createdAt": "2020-04-09T21:37:09Z", "commit": {"oid": "44fe3f0482766b2d4ab86c39ca23ffda157f822a"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMTozNzoxMFrOGDqSwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMTo0Mjo0NFrOGDqc6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ5MTg0MA==", "bodyText": "nit: Don't think we need to export InvalidArgumentErrorMessageFormat", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r406491840", "createdAt": "2020-04-09T21:37:10Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/errors/invalidArgumentError.js", "diffHunk": "@@ -0,0 +1,42 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+const InvalidArgumentErrorMessageFormat = 'Invalid parameter: ';\n+\n+class InvalidArgumentError extends Error {\n+  constructor(errorMessage) {\n+    super();\n+\n+    this.message = errorMessage;\n+  }\n+\n+  // factory method to help common case\n+  static forParams(badParams) {\n+    if (!Array.isArray(badParams)) {\n+      badParams = [badParams];\n+    }\n+    return new InvalidArgumentError(badParams.map((message) => `${InvalidArgumentErrorMessageFormat}${message}`));\n+  }\n+}\n+\n+module.exports = {\n+  InvalidArgumentError,\n+  InvalidArgumentErrorMessageFormat,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44fe3f0482766b2d4ab86c39ca23ffda157f822a"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ5MjIxOQ==", "bodyText": "Same", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r406492219", "createdAt": "2020-04-09T21:37:56Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/errors/notFoundError.js", "diffHunk": "@@ -0,0 +1,33 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+const NotFoundErrorMessage = 'Not found';\n+\n+class NotFoundError extends Error {\n+  constructor(errorMessage) {\n+    super();\n+    this.message = errorMessage === undefined ? NotFoundErrorMessage : errorMessage;\n+  }\n+}\n+\n+module.exports = {\n+  NotFoundError,\n+  NotFoundErrorMessage,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44fe3f0482766b2d4ab86c39ca23ffda157f822a"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ5MjQ0Mg==", "bodyText": "Same", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r406492442", "createdAt": "2020-04-09T21:38:25Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/middleware/httpErrorHandler.js", "diffHunk": "@@ -0,0 +1,85 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const {DbError} = require('../errors/dbError');\n+const {InvalidArgumentError} = require('../errors/invalidArgumentError');\n+const {NotFoundError} = require('../errors/notFoundError');\n+\n+const httpStatusCodes = {\n+  OK: 200,\n+  BAD_REQUEST: 400,\n+  NOT_FOUND: 404,\n+  INTERNAL_ERROR: 500,\n+  SERVICE_UNAVAILABLE: 503,\n+};\n+\n+// Error middleware which formats thrown errors and maps them to appropriate http status codes\n+// next param is required to ensure express maps to this middleware and can also be used to pass onto future middleware\n+const handleError = (err, req, res, next) => {\n+  // only logs in non test environment\n+  if (process.env.NODE_ENV !== 'test') {\n+    logger.error(`Error processing ${req.originalUrl}: `, err);\n+  }\n+\n+  // get application error message format\n+  const errorMessage = errorMessageFormat(err.message);\n+\n+  // map errors to desired http status codes\n+  switch (err.constructor) {\n+    case DbError:\n+      logger.debug(`DB error: ${err.dbErrorMessage}`);\n+      res.status(httpStatusCodes.SERVICE_UNAVAILABLE).json(errorMessage);\n+      return;\n+    case InvalidArgumentError:\n+      res.status(httpStatusCodes.BAD_REQUEST).json(errorMessage);\n+      return;\n+    case NotFoundError:\n+      res.status(httpStatusCodes.NOT_FOUND).json(errorMessage);\n+      return;\n+    default:\n+      logger.trace(`Unhandled error encountered`);\n+      res.status(httpStatusCodes.INTERNAL_ERROR).json(errorMessage);\n+  }\n+};\n+\n+/**\n+ * Application error message format\n+ * @param array of messages\n+ * @returns {{_status: {messages: *}}}\n+ */\n+const errorMessageFormat = (errorMessages) => {\n+  if (!Array.isArray(errorMessages)) {\n+    errorMessages = [errorMessages];\n+  }\n+\n+  return {\n+    _status: {\n+      messages: errorMessages.map((m) => {\n+        return {message: m};\n+      }),\n+    },\n+  };\n+};\n+\n+module.exports = {\n+  handleError,\n+  httpStatusCodes,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44fe3f0482766b2d4ab86c39ca23ffda157f822a"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ5NDQ0MA==", "bodyText": "Same", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#discussion_r406494440", "createdAt": "2020-04-09T21:42:44Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/topicmessage.js", "diffHunk": "@@ -304,6 +292,7 @@ module.exports = {\n   getMessageByConsensusTimestamp: getMessageByConsensusTimestamp,\n   getMessageByTopicAndSequenceRequest: getMessageByTopicAndSequenceRequest,\n   getTopicMessages: getTopicMessages,\n+  topicMessageColumns: topicMessageColumns,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44fe3f0482766b2d4ab86c39ca23ffda157f822a"}, "originalPosition": 268}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b4128436eae9722c38a0ef5130e2aa0c1178dee", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3b4128436eae9722c38a0ef5130e2aa0c1178dee", "committedDate": "2020-04-09T23:19:00Z", "message": "Removed unnecessary exports\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMjEwMDEw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#pullrequestreview-391210010", "createdAt": "2020-04-10T00:28:06Z", "commit": {"oid": "3b4128436eae9722c38a0ef5130e2aa0c1178dee"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e26bcab6e81d77c582dad9bac63bf6091be48b60", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e26bcab6e81d77c582dad9bac63bf6091be48b60", "committedDate": "2020-04-10T00:31:59Z", "message": "Merged master to get miscellaneous fixes to tests\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMjEyNjE4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/663#pullrequestreview-391212618", "createdAt": "2020-04-10T00:38:41Z", "commit": {"oid": "3b4128436eae9722c38a0ef5130e2aa0c1178dee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3058, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}