{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1NTYxNTA5", "number": 1090, "reviewThreads": {"totalCount": 44, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODozMDozMVrOEpXtJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNToxMTo1M1rOEqydmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExODE1NDYzOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/AccountBalance.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODozMDozMVrOHa_8OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMDoyNTowMFrOHcsg0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3MjYzMw==", "bodyText": "The FileLoader test seems to show these aren't actually being picked up by the repository, despite them being in the DB.  Need to investigate", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498072633", "createdAt": "2020-10-01T08:30:31Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/AccountBalance.java", "diffHunk": "@@ -43,6 +49,13 @@\n \n     private long balance;\n \n+    @OneToMany(cascade = {CascadeType.ALL}, orphanRemoval = true, fetch = FetchType.EAGER)\n+    @JoinColumns({\n+            @JoinColumn(name = \"consensusTimestamp\"),\n+            @JoinColumn(name = \"accountId\")\n+    })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "552801f4b2a63d039ae1fd0958f0907b0869874c"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg1MTQ3Mg==", "bodyText": "There were flipped in the flyway script, so they weren't joining properly.  This has been fixed and tests confirm.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499851472", "createdAt": "2020-10-05T20:25:00Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/AccountBalance.java", "diffHunk": "@@ -43,6 +49,13 @@\n \n     private long balance;\n \n+    @OneToMany(cascade = {CascadeType.ALL}, orphanRemoval = true, fetch = FetchType.EAGER)\n+    @JoinColumns({\n+            @JoinColumn(name = \"consensusTimestamp\"),\n+            @JoinColumn(name = \"accountId\")\n+    })", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3MjYzMw=="}, "originalCommit": {"oid": "552801f4b2a63d039ae1fd0958f0907b0869874c"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExODE1Njg0OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODozMTowNVrOHa_9mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwNTo1MzowN1rOHb_1gA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3Mjk4NQ==", "bodyText": "Add a test for this class", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498072985", "createdAt": "2020-10-01T08:31:05Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_010_HEADER_PREFIX = \"# 0.1.0\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "552801f4b2a63d039ae1fd0958f0907b0869874c"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTExOTQ4OA==", "bodyText": "Done", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499119488", "createdAt": "2020-10-03T05:53:07Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_010_HEADER_PREFIX = \"# 0.1.0\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3Mjk4NQ=="}, "originalCommit": {"oid": "552801f4b2a63d039ae1fd0958f0907b0869874c"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDE1ODU5OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/TokenBalance.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNzowMjo0MlrOHbTb4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjoyNDoxOFrOHbz2Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM5MjAzMw==", "bodyText": "nit: can remove\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            //import com.hedera.mirror.importer.converter.TokenIdConverter;", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498392033", "createdAt": "2020-10-01T17:02:42Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/TokenBalance.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package com.hedera.mirror.importer.domain;\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ *\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.fasterxml.jackson.annotation.JsonUnwrapped;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import java.io.Serializable;\n+import javax.persistence.Convert;\n+import javax.persistence.Embeddable;\n+import javax.persistence.EmbeddedId;\n+import javax.persistence.Entity;\n+import lombok.AllArgsConstructor;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n+import org.springframework.data.domain.Persistable;\n+\n+import com.hedera.mirror.importer.converter.AccountIdConverter;\n+import com.hedera.mirror.importer.converter.EntityIdSerializer;\n+import com.hedera.mirror.importer.converter.TokenIdConverter;\n+//import com.hedera.mirror.importer.converter.TokenIdConverter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyMzA5MA==", "bodyText": "Removed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498923090", "createdAt": "2020-10-02T16:24:18Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/TokenBalance.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package com.hedera.mirror.importer.domain;\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ *\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.fasterxml.jackson.annotation.JsonUnwrapped;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import java.io.Serializable;\n+import javax.persistence.Convert;\n+import javax.persistence.Embeddable;\n+import javax.persistence.EmbeddedId;\n+import javax.persistence.Entity;\n+import lombok.AllArgsConstructor;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n+import org.springframework.data.domain.Persistable;\n+\n+import com.hedera.mirror.importer.converter.AccountIdConverter;\n+import com.hedera.mirror.importer.converter.EntityIdSerializer;\n+import com.hedera.mirror.importer.converter.TokenIdConverter;\n+//import com.hedera.mirror.importer.converter.TokenIdConverter;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM5MjAzMw=="}, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDE2MjEyOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/TokenBalance.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNzowMzo0NlrOHbTeRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjoyNDoyN1rOHbz2ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM5MjY0Nw==", "bodyText": "nit: empty line between members for readability", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498392647", "createdAt": "2020-10-01T17:03:46Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/TokenBalance.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package com.hedera.mirror.importer.domain;\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ *\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.fasterxml.jackson.annotation.JsonUnwrapped;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import java.io.Serializable;\n+import javax.persistence.Convert;\n+import javax.persistence.Embeddable;\n+import javax.persistence.EmbeddedId;\n+import javax.persistence.Entity;\n+import lombok.AllArgsConstructor;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n+import org.springframework.data.domain.Persistable;\n+\n+import com.hedera.mirror.importer.converter.AccountIdConverter;\n+import com.hedera.mirror.importer.converter.EntityIdSerializer;\n+import com.hedera.mirror.importer.converter.TokenIdConverter;\n+//import com.hedera.mirror.importer.converter.TokenIdConverter;\n+\n+@Data\n+@AllArgsConstructor\n+@NoArgsConstructor\n+@Entity\n+public class TokenBalance implements Persistable<TokenBalance.Id> {\n+    private long balance;\n+    @EmbeddedId\n+    @JsonUnwrapped\n+    private TokenBalance.Id id;\n+\n+    @Override\n+    public boolean isNew() {\n+        return true; // Since we never update balances and use a natural ID, avoid Hibernate querying before insert\n+    }\n+\n+    @Data\n+    @AllArgsConstructor\n+    @NoArgsConstructor\n+    @Embeddable\n+    public static class Id implements Serializable {\n+        private static final long serialVersionUID = -8547332015249955424L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyMzE3MQ==", "bodyText": "Added", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498923171", "createdAt": "2020-10-02T16:24:27Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/TokenBalance.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package com.hedera.mirror.importer.domain;\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ *\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.fasterxml.jackson.annotation.JsonUnwrapped;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import java.io.Serializable;\n+import javax.persistence.Convert;\n+import javax.persistence.Embeddable;\n+import javax.persistence.EmbeddedId;\n+import javax.persistence.Entity;\n+import lombok.AllArgsConstructor;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n+import org.springframework.data.domain.Persistable;\n+\n+import com.hedera.mirror.importer.converter.AccountIdConverter;\n+import com.hedera.mirror.importer.converter.EntityIdSerializer;\n+import com.hedera.mirror.importer.converter.TokenIdConverter;\n+//import com.hedera.mirror.importer.converter.TokenIdConverter;\n+\n+@Data\n+@AllArgsConstructor\n+@NoArgsConstructor\n+@Entity\n+public class TokenBalance implements Persistable<TokenBalance.Id> {\n+    private long balance;\n+    @EmbeddedId\n+    @JsonUnwrapped\n+    private TokenBalance.Id id;\n+\n+    @Override\n+    public boolean isNew() {\n+        return true; // Since we never update balances and use a natural ID, avoid Hibernate querying before insert\n+    }\n+\n+    @Data\n+    @AllArgsConstructor\n+    @NoArgsConstructor\n+    @Embeddable\n+    public static class Id implements Serializable {\n+        private static final long serialVersionUID = -8547332015249955424L;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM5MjY0Nw=="}, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDE2ODg0OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNzowNjowNFrOHbTiyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjoyNDozM1rOHbz20A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM5MzgwMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    tryExecuteBatchStatement(insertBalanceStatement, \"Some account balance insert statement in the \" +\n          \n          \n            \n                    tryExecuteBatchStatement(insertBalanceStatement, \"Some account balance insert statements in the \" +", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498393803", "createdAt": "2020-10-01T17:06:04Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoader.java", "diffHunk": "@@ -175,31 +189,63 @@ private void insertAccountBalanceSet(PreparedStatement insertSetStatement, long\n         insertSetStatement.execute();\n     }\n \n-    private void tryInsertBatchAccountBalance(PreparedStatement insertBalanceStatement,\n-                                              List<AccountBalance> accountBalanceList, int threshold) throws SQLException {\n+    private void tryInsertBatchAccountBalanceAndTokenBalance(PreparedStatement insertBalanceStatement,\n+                                                             PreparedStatement insertBatchTokenBalanceStatement,\n+                                                             List<AccountBalance> accountBalanceList, int threshold) throws SQLException {\n         if (accountBalanceList.size() < threshold) {\n             return;\n         }\n-\n         for (var accountBalance : accountBalanceList) {\n-            AccountBalance.Id id = accountBalance.getId();\n-            insertBalanceStatement.setLong(F_INSERT_BALANCE.CONSENSUS_TIMESTAMP.ordinal(), id.getConsensusTimestamp());\n-            insertBalanceStatement.setLong(F_INSERT_BALANCE.ACCOUNT_ID.ordinal(), id.getAccountId().getId());\n-            insertBalanceStatement.setLong(F_INSERT_BALANCE.BALANCE.ordinal(), accountBalance.getBalance());\n-            insertBalanceStatement.addBatch();\n+            buildBatchAccountBalanceStatement(insertBalanceStatement, accountBalance);\n+            buildBatchAccountTokenBalanceStatement(insertBatchTokenBalanceStatement, accountBalance.getTokenBalances());\n         }\n-\n+        tryExecuteBatchStatement(insertBalanceStatement, \"Some account balance insert statement in the \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyMzIxNg==", "bodyText": "Fixed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498923216", "createdAt": "2020-10-02T16:24:33Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoader.java", "diffHunk": "@@ -175,31 +189,63 @@ private void insertAccountBalanceSet(PreparedStatement insertSetStatement, long\n         insertSetStatement.execute();\n     }\n \n-    private void tryInsertBatchAccountBalance(PreparedStatement insertBalanceStatement,\n-                                              List<AccountBalance> accountBalanceList, int threshold) throws SQLException {\n+    private void tryInsertBatchAccountBalanceAndTokenBalance(PreparedStatement insertBalanceStatement,\n+                                                             PreparedStatement insertBatchTokenBalanceStatement,\n+                                                             List<AccountBalance> accountBalanceList, int threshold) throws SQLException {\n         if (accountBalanceList.size() < threshold) {\n             return;\n         }\n-\n         for (var accountBalance : accountBalanceList) {\n-            AccountBalance.Id id = accountBalance.getId();\n-            insertBalanceStatement.setLong(F_INSERT_BALANCE.CONSENSUS_TIMESTAMP.ordinal(), id.getConsensusTimestamp());\n-            insertBalanceStatement.setLong(F_INSERT_BALANCE.ACCOUNT_ID.ordinal(), id.getAccountId().getId());\n-            insertBalanceStatement.setLong(F_INSERT_BALANCE.BALANCE.ordinal(), accountBalance.getBalance());\n-            insertBalanceStatement.addBatch();\n+            buildBatchAccountBalanceStatement(insertBalanceStatement, accountBalance);\n+            buildBatchAccountTokenBalanceStatement(insertBatchTokenBalanceStatement, accountBalance.getTokenBalances());\n         }\n-\n+        tryExecuteBatchStatement(insertBalanceStatement, \"Some account balance insert statement in the \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM5MzgwMw=="}, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDE2OTkwOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNzowNjozMVrOHbTjmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNzowNjozMVrOHbTjmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM5NDAxMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    tryExecuteBatchStatement(insertBatchTokenBalanceStatement, \"Some account token balance insert statement in \" +\n          \n          \n            \n                    tryExecuteBatchStatement(insertBatchTokenBalanceStatement, \"Some account token balance insert statements in \" +", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498394011", "createdAt": "2020-10-01T17:06:31Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoader.java", "diffHunk": "@@ -175,31 +189,63 @@ private void insertAccountBalanceSet(PreparedStatement insertSetStatement, long\n         insertSetStatement.execute();\n     }\n \n-    private void tryInsertBatchAccountBalance(PreparedStatement insertBalanceStatement,\n-                                              List<AccountBalance> accountBalanceList, int threshold) throws SQLException {\n+    private void tryInsertBatchAccountBalanceAndTokenBalance(PreparedStatement insertBalanceStatement,\n+                                                             PreparedStatement insertBatchTokenBalanceStatement,\n+                                                             List<AccountBalance> accountBalanceList, int threshold) throws SQLException {\n         if (accountBalanceList.size() < threshold) {\n             return;\n         }\n-\n         for (var accountBalance : accountBalanceList) {\n-            AccountBalance.Id id = accountBalance.getId();\n-            insertBalanceStatement.setLong(F_INSERT_BALANCE.CONSENSUS_TIMESTAMP.ordinal(), id.getConsensusTimestamp());\n-            insertBalanceStatement.setLong(F_INSERT_BALANCE.ACCOUNT_ID.ordinal(), id.getAccountId().getId());\n-            insertBalanceStatement.setLong(F_INSERT_BALANCE.BALANCE.ordinal(), accountBalance.getBalance());\n-            insertBalanceStatement.addBatch();\n+            buildBatchAccountBalanceStatement(insertBalanceStatement, accountBalance);\n+            buildBatchAccountTokenBalanceStatement(insertBatchTokenBalanceStatement, accountBalance.getTokenBalances());\n         }\n-\n+        tryExecuteBatchStatement(insertBalanceStatement, \"Some account balance insert statement in the \" +\n+                \"batch failed to execute\");\n+        tryExecuteBatchStatement(insertBatchTokenBalanceStatement, \"Some account token balance insert statement in \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDE3ODkxOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNzowOTozMFrOHbTptw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjoyNTo1NVrOHbz5dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM5NTU3NQ==", "bodyText": "This should be v2, service should have made that fix but you can verify\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final String VERSION_010_HEADER_PREFIX = \"# 0.1.0\";\n          \n          \n            \n                private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498395575", "createdAt": "2020-10-01T17:09:30Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_010_HEADER_PREFIX = \"# 0.1.0\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyMzg5Mw==", "bodyText": "Corrected", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498923893", "createdAt": "2020-10-02T16:25:55Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_010_HEADER_PREFIX = \"# 0.1.0\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM5NTU3NQ=="}, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDQyNjI3OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODoyNTozMlrOHbWJwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjoyNjoxN1rOHbz6Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQzNjU0NQ==", "bodyText": "Not needed. I think we had discussed being strict on this version of the file, so we expect line 1 to have the version", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498436545", "createdAt": "2020-10-01T18:25:32Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final int MAX_HEADER_ROWS = 10;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyNDA3OQ==", "bodyText": "Sure thing, fixed to only check line 2", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498924079", "createdAt": "2020-10-02T16:26:17Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final int MAX_HEADER_ROWS = 10;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQzNjU0NQ=="}, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDQ5OTQyOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoaderTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODo0ODo0N1rOHbW4iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjoyNjo0OVrOHbz7Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ0ODUyMQ==", "bodyText": "The source file TokenBalanceRepository.java is missing", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498448521", "createdAt": "2020-10-01T18:48:47Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoaderTest.java", "diffHunk": "@@ -47,9 +47,11 @@\n import com.hedera.mirror.importer.domain.AccountBalanceFile;\n import com.hedera.mirror.importer.domain.EntityId;\n import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n import com.hedera.mirror.importer.repository.AccountBalanceFileRepository;\n import com.hedera.mirror.importer.repository.AccountBalanceRepository;\n import com.hedera.mirror.importer.repository.AccountBalanceSetRepository;\n+import com.hedera.mirror.importer.repository.TokenBalanceRepository;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyNDM0Ng==", "bodyText": "Added", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498924346", "createdAt": "2020-10-02T16:26:49Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoaderTest.java", "diffHunk": "@@ -47,9 +47,11 @@\n import com.hedera.mirror.importer.domain.AccountBalanceFile;\n import com.hedera.mirror.importer.domain.EntityId;\n import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n import com.hedera.mirror.importer.repository.AccountBalanceFileRepository;\n import com.hedera.mirror.importer.repository.AccountBalanceRepository;\n import com.hedera.mirror.importer.repository.AccountBalanceSetRepository;\n+import com.hedera.mirror.importer.repository.TokenBalanceRepository;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ0ODUyMQ=="}, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDgxMzUyOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoader.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMDo0MDo1MVrOHbaG9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjozNTowN1rOHb0LvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUwMTM2Nw==", "bodyText": "the number of token balances overall and the number of account balances will differ most likely, batching them together actually honor the batchSize for account balances but not for token balances. this will have an impact on performance", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498501367", "createdAt": "2020-10-01T20:40:51Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoader.java", "diffHunk": "@@ -175,31 +189,63 @@ private void insertAccountBalanceSet(PreparedStatement insertSetStatement, long\n         insertSetStatement.execute();\n     }\n \n-    private void tryInsertBatchAccountBalance(PreparedStatement insertBalanceStatement,\n-                                              List<AccountBalance> accountBalanceList, int threshold) throws SQLException {\n+    private void tryInsertBatchAccountBalanceAndTokenBalance(PreparedStatement insertBalanceStatement,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYxOTM4NQ==", "bodyText": "Yes, I was a little worried about that, I wasn't sure if it was worth it to always insert TokenBalances at the same time as AccountBalances or to save them separately when the batch size is hit..  I can put it back to having them be separate methods.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498619385", "createdAt": "2020-10-02T05:02:03Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoader.java", "diffHunk": "@@ -175,31 +189,63 @@ private void insertAccountBalanceSet(PreparedStatement insertSetStatement, long\n         insertSetStatement.execute();\n     }\n \n-    private void tryInsertBatchAccountBalance(PreparedStatement insertBalanceStatement,\n-                                              List<AccountBalance> accountBalanceList, int threshold) throws SQLException {\n+    private void tryInsertBatchAccountBalanceAndTokenBalance(PreparedStatement insertBalanceStatement,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUwMTM2Nw=="}, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyODU3Mw==", "bodyText": "I've put it back to being separate calls, each looking at their respective list size.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498928573", "createdAt": "2020-10-02T16:35:07Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoader.java", "diffHunk": "@@ -175,31 +189,63 @@ private void insertAccountBalanceSet(PreparedStatement insertSetStatement, long\n         insertSetStatement.execute();\n     }\n \n-    private void tryInsertBatchAccountBalance(PreparedStatement insertBalanceStatement,\n-                                              List<AccountBalance> accountBalanceList, int threshold) throws SQLException {\n+    private void tryInsertBatchAccountBalanceAndTokenBalance(PreparedStatement insertBalanceStatement,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUwMTM2Nw=="}, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDg2OTExOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoaderTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMTowMDozNFrOHbaraQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjoxNzoxMFrOHckW-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxMDY5Nw==", "bodyText": "should test both v1 and v2 balance files", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498510697", "createdAt": "2020-10-01T21:00:34Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoaderTest.java", "diffHunk": "@@ -65,37 +67,40 @@\n     @Resource\n     private AccountBalanceRepository accountBalanceRepository;\n \n+    @Resource\n+    private TokenBalanceRepository tokenBalanceRepository;\n+\n     @Resource\n     private AccountBalanceSetRepository accountBalanceSetRepository;\n \n     @Resource\n     private AccountBalanceFileRepository accountBalanceFileRepository;\n \n     @Resource\n-    private BalanceFileReaderImpl balanceFileReader;\n+    private BalanceFileReaderImplV2 balanceFileReader;\n \n     private FileCopier fileCopier;\n     private BalanceFile balanceFile;\n     private File testFile;\n \n     @BeforeEach\n     void setup() {\n-        balanceFile = new BalanceFile(1567188900016002001L, 25391, \"2019-08-30T18_15_00.016002001Z_Balances.csv\");\n+        balanceFile = new BalanceFile(1600748700083212003L, 106, \"2020-09-22T04_25_00.083212003Z_Balances.csv\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcxNzg4MQ==", "bodyText": "Redid this test suite to make it easy to test multiple versions, it now tests v1 and v2", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499717881", "createdAt": "2020-10-05T16:17:10Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoaderTest.java", "diffHunk": "@@ -65,37 +67,40 @@\n     @Resource\n     private AccountBalanceRepository accountBalanceRepository;\n \n+    @Resource\n+    private TokenBalanceRepository tokenBalanceRepository;\n+\n     @Resource\n     private AccountBalanceSetRepository accountBalanceSetRepository;\n \n     @Resource\n     private AccountBalanceFileRepository accountBalanceFileRepository;\n \n     @Resource\n-    private BalanceFileReaderImpl balanceFileReader;\n+    private BalanceFileReaderImplV2 balanceFileReader;\n \n     private FileCopier fileCopier;\n     private BalanceFile balanceFile;\n     private File testFile;\n \n     @BeforeEach\n     void setup() {\n-        balanceFile = new BalanceFile(1567188900016002001L, 25391, \"2019-08-30T18_15_00.016002001Z_Balances.csv\");\n+        balanceFile = new BalanceFile(1600748700083212003L, 106, \"2020-09-22T04_25_00.083212003Z_Balances.csv\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxMDY5Nw=="}, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDg5MjIwOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2Test.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMTowOToyOFrOHba6ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMTo1ODowMFrOHb8pCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxNDU5MA==", "bodyText": "the expected token balance list should be something like \",\" separated tokenid=balance string, not the base64 encoded protobuf", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498514590", "createdAt": "2020-10-01T21:09:28Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2Test.java", "diffHunk": "@@ -0,0 +1,100 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import org.apache.commons.codec.binary.Base64;\n+import org.apache.commons.lang3.StringUtils;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.CsvSource;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+class AccountBalanceLineParserV2Test {\n+\n+    private static final long timestamp = 1596340377922333444L;\n+    private static final long systemShardNum = 0;\n+\n+    @DisplayName(\"Parse account balance line\")\n+    @ParameterizedTest(name = \"from \\\"{0}\\\"\")\n+    @CsvSource(value = {\n+            \"'0,0,123,700,CggKAxjsBxCEBwoHCgMY7QcQGQoKCgMY7gcQwKilBAoICgMY8gcQhAcKBwoDGPMHEBkKCgoDGPQHEMCopQQ';false;\" +\n+                    \"0;123;700;CggKAxjsBxCEBwoHCgMY7QcQGQoKCgMY7gcQwKilBAoICgMY8gcQhAcKBwoDGPMHEBkKCgoDGPQHEMCopQQ\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA2NzE0NA==", "bodyText": "Converted test to use comma separated list of values.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499067144", "createdAt": "2020-10-02T21:58:00Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2Test.java", "diffHunk": "@@ -0,0 +1,100 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import org.apache.commons.codec.binary.Base64;\n+import org.apache.commons.lang3.StringUtils;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.CsvSource;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+class AccountBalanceLineParserV2Test {\n+\n+    private static final long timestamp = 1596340377922333444L;\n+    private static final long systemShardNum = 0;\n+\n+    @DisplayName(\"Parse account balance line\")\n+    @ParameterizedTest(name = \"from \\\"{0}\\\"\")\n+    @CsvSource(value = {\n+            \"'0,0,123,700,CggKAxjsBxCEBwoHCgMY7QcQGQoKCgMY7gcQwKilBAoICgMY8gcQhAcKBwoDGPMHEBkKCgoDGPQHEMCopQQ';false;\" +\n+                    \"0;123;700;CggKAxjsBxCEBwoHCgMY7QcQGQoKCgMY7gcQwKilBAoICgMY8gcQhAcKBwoDGPMHEBkKCgoDGPQHEMCopQQ\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxNDU5MA=="}, "originalCommit": {"oid": "47363c0779322d56febd4778de6d404046ce6598"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzM0MjQ3OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo1NTowOVrOHby7ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMTo1ODoxNVrOHb8pTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwODA5MA==", "bodyText": "tryInsertBatchAccountBalance  is called twice\ntryInsertBatchTokenBalance does nothing because accountBalanceList is cleared by tryInsertBatchAccountBalance this leads to loss of all token balances", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498908090", "createdAt": "2020-10-02T15:55:09Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoader.java", "diffHunk": "@@ -148,11 +159,14 @@ public void loadAccountBalances(@NonNull File balanceFile, DateRangeFilter dateR\n                 if (!skip) {\n                     accountBalanceList.add(accountBalance);\n                     tryInsertBatchAccountBalance(insertBalanceStatement, accountBalanceList, insertBatchSize);\n+                    tryInsertBatchAccountBalance(insertBalanceStatement, accountBalanceList, insertBatchSize);\n+                    tryInsertBatchTokenBalance(insertTokenBalanceStatement, accountBalanceList, insertBatchSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA2NzIxNQ==", "bodyText": "Fixed.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499067215", "createdAt": "2020-10-02T21:58:15Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/AccountBalancesFileLoader.java", "diffHunk": "@@ -148,11 +159,14 @@ public void loadAccountBalances(@NonNull File balanceFile, DateRangeFilter dateR\n                 if (!skip) {\n                     accountBalanceList.add(accountBalance);\n                     tryInsertBatchAccountBalance(insertBalanceStatement, accountBalanceList, insertBatchSize);\n+                    tryInsertBatchAccountBalance(insertBalanceStatement, accountBalanceList, insertBatchSize);\n+                    tryInsertBatchTokenBalance(insertTokenBalanceStatement, accountBalanceList, insertBatchSize);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwODA5MA=="}, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzM3NzExOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjowNTo1MVrOHbzRoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwMzo1NDowMFrOHb_cEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxMzY5Nw==", "bodyText": "should handle NPE", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498913697", "createdAt": "2020-10-02T16:05:51Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.version1Reader = balanceFileReaderImplV1;\n+        this.version2Reader = balanceFileReaderImplV2;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            String line = Optional.of(reader.readLine()).get().trim();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTExMjk3Nw==", "bodyText": "Should now be handled", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499112977", "createdAt": "2020-10-03T03:54:00Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.version1Reader = balanceFileReaderImplV1;\n+        this.version2Reader = balanceFileReaderImplV2;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            String line = Optional.of(reader.readLine()).get().trim();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxMzY5Nw=="}, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzQxODg3OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjoxOTowNFrOHbzr9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwNTo1MzozNlrOHb_1mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyMDQzNw==", "bodyText": "accountId created twice", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498920437", "createdAt": "2020-10-02T16:19:04Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 {\n+\n+    /**\n+     * Parses an account balance line to extract shard, realm, account, and balance. If the shard matches\n+     * systemShardNum, creates and returns an {@code AccountBalance} entity object. The account balance line should be\n+     * in the format of \"shard,realm,account,balance\"\n+     *\n+     * @param line               The account balance line\n+     * @param consensusTimestamp The consensus timestamp of the account balance line\n+     * @param systemShardNum     The system shard number\n+     * @return {@code AccountBalance} entity object\n+     * @throws InvalidDatasetException if the line is malformed or the shard does not match {@code systemShardNum}\n+     */\n+    public AccountBalance parse(String line, long consensusTimestamp, long systemShardNum) {\n+        try {\n+            String[] parts = line.split(\",\");\n+            boolean hasTokenBalance;\n+            if (parts.length == 5) {\n+                hasTokenBalance = true;\n+            } else if (parts.length == 4) {\n+                hasTokenBalance = false;\n+            } else {\n+                throw new InvalidDatasetException(\"Invalid account balance line: \" + line);\n+            }\n+\n+            long shardNum = Long.parseLong(parts[0]);\n+            int realmNum = Integer.parseInt(parts[1]);\n+            int accountNum = Integer.parseInt(parts[2]);\n+            long balance = Long.parseLong(parts[3]);\n+\n+            if (shardNum < 0 || realmNum < 0 || accountNum < 0 || balance < 0) {\n+                throw new InvalidDatasetException(\"Invalid account balance line: \" + line);\n+            }\n+\n+            if (shardNum != systemShardNum) {\n+                throw new InvalidDatasetException(String.format(\"Invalid account balance line: %s. Expect \" +\n+                        \"shard (%d), got shard (%d)\", line, systemShardNum, shardNum));\n+            }\n+\n+            EntityId accountId = EntityId\n+                    .of(shardNum, realmNum, accountNum, EntityTypeEnum.ACCOUNT);\n+\n+            List<TokenBalance> tokenBalances = hasTokenBalance ? parseTokenBalanceList(parts[4], consensusTimestamp,\n+                    accountId) : Collections\n+                    .emptyList();\n+\n+            return new AccountBalance(balance, tokenBalances, new AccountBalance.Id(consensusTimestamp, EntityId", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTExOTUxNQ==", "bodyText": "Fixed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499119515", "createdAt": "2020-10-03T05:53:36Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 {\n+\n+    /**\n+     * Parses an account balance line to extract shard, realm, account, and balance. If the shard matches\n+     * systemShardNum, creates and returns an {@code AccountBalance} entity object. The account balance line should be\n+     * in the format of \"shard,realm,account,balance\"\n+     *\n+     * @param line               The account balance line\n+     * @param consensusTimestamp The consensus timestamp of the account balance line\n+     * @param systemShardNum     The system shard number\n+     * @return {@code AccountBalance} entity object\n+     * @throws InvalidDatasetException if the line is malformed or the shard does not match {@code systemShardNum}\n+     */\n+    public AccountBalance parse(String line, long consensusTimestamp, long systemShardNum) {\n+        try {\n+            String[] parts = line.split(\",\");\n+            boolean hasTokenBalance;\n+            if (parts.length == 5) {\n+                hasTokenBalance = true;\n+            } else if (parts.length == 4) {\n+                hasTokenBalance = false;\n+            } else {\n+                throw new InvalidDatasetException(\"Invalid account balance line: \" + line);\n+            }\n+\n+            long shardNum = Long.parseLong(parts[0]);\n+            int realmNum = Integer.parseInt(parts[1]);\n+            int accountNum = Integer.parseInt(parts[2]);\n+            long balance = Long.parseLong(parts[3]);\n+\n+            if (shardNum < 0 || realmNum < 0 || accountNum < 0 || balance < 0) {\n+                throw new InvalidDatasetException(\"Invalid account balance line: \" + line);\n+            }\n+\n+            if (shardNum != systemShardNum) {\n+                throw new InvalidDatasetException(String.format(\"Invalid account balance line: %s. Expect \" +\n+                        \"shard (%d), got shard (%d)\", line, systemShardNum, shardNum));\n+            }\n+\n+            EntityId accountId = EntityId\n+                    .of(shardNum, realmNum, accountNum, EntityTypeEnum.ACCOUNT);\n+\n+            List<TokenBalance> tokenBalances = hasTokenBalance ? parseTokenBalanceList(parts[4], consensusTimestamp,\n+                    accountId) : Collections\n+                    .emptyList();\n+\n+            return new AccountBalance(balance, tokenBalances, new AccountBalance.Id(consensusTimestamp, EntityId", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyMDQzNw=="}, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzQzNDE1OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/resources/data/accountBalances/v2/2020-09-22T04_25_00.083212003Z_Balances.csv", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjoyNDowN1rOHbz19Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMjowMzozNVrOHb8vCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyMjk5Nw==", "bodyText": "the first line does not match CompositeBalanceFileReader.VERSION_2_HEADER_PREFIX", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498922997", "createdAt": "2020-10-02T16:24:07Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/test/resources/data/accountBalances/v2/2020-09-22T04_25_00.083212003Z_Balances.csv", "diffHunk": "@@ -0,0 +1,109 @@\n+# 0.1.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA2ODY4Mw==", "bodyText": "Fixed.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499068683", "createdAt": "2020-10-02T22:03:35Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/test/resources/data/accountBalances/v2/2020-09-22T04_25_00.083212003Z_Balances.csv", "diffHunk": "@@ -0,0 +1,109 @@\n+# 0.1.0", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyMjk5Nw=="}, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzQ0OTYyOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjoyOToxNFrOHb0AEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwNTo1NDozNlrOHb_10A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyNTU4NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new InvalidDatasetException(\"Timestamp / column header not found in account balance file\");\n          \n          \n            \n                            throw new InvalidDatasetException(\"Timestamp header not found in account balance file\");", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498925584", "createdAt": "2020-10-02T16:29:14Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# timestamp:\";\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+\n+    private final int fileBufferSize;\n+    private final long systemShardNum;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    public BalanceFileReaderImplV2(BalanceParserProperties balanceParserProperties, AccountBalanceLineParserV2\n+            parser) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.systemShardNum = balanceParserProperties.getMirrorProperties().getShard();\n+        this.parser = parser;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, systemShardNum);\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            //Discard the first line/version number\n+            reader.readLine();\n+            line = Optional.of(reader.readLine()).get().trim();\n+            String lineLowered = line.toLowerCase();\n+            if (lineLowered.startsWith(TIMESTAMP_HEADER_PREFIX)) {\n+                return convertTimestampLine(line);\n+            } else {\n+                throw new InvalidDatasetException(\"Timestamp / column header not found in account balance file\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyNjYzOQ==", "bodyText": "should read the column header after the timestamp line. otherwise the column header line is fed to the parser although the reader would just swallow the InvalidDataSetException and return a null which is then filtered in the streams pipeline.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498926639", "createdAt": "2020-10-02T16:31:15Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# timestamp:\";\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+\n+    private final int fileBufferSize;\n+    private final long systemShardNum;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    public BalanceFileReaderImplV2(BalanceParserProperties balanceParserProperties, AccountBalanceLineParserV2\n+            parser) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.systemShardNum = balanceParserProperties.getMirrorProperties().getShard();\n+        this.parser = parser;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, systemShardNum);\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            //Discard the first line/version number\n+            reader.readLine();\n+            line = Optional.of(reader.readLine()).get().trim();\n+            String lineLowered = line.toLowerCase();\n+            if (lineLowered.startsWith(TIMESTAMP_HEADER_PREFIX)) {\n+                return convertTimestampLine(line);\n+            } else {\n+                throw new InvalidDatasetException(\"Timestamp / column header not found in account balance file\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyNTU4NA=="}, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1Njg0NQ==", "bodyText": "What he said.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499056845", "createdAt": "2020-10-02T21:24:50Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# timestamp:\";\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+\n+    private final int fileBufferSize;\n+    private final long systemShardNum;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    public BalanceFileReaderImplV2(BalanceParserProperties balanceParserProperties, AccountBalanceLineParserV2\n+            parser) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.systemShardNum = balanceParserProperties.getMirrorProperties().getShard();\n+        this.parser = parser;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, systemShardNum);\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            //Discard the first line/version number\n+            reader.readLine();\n+            line = Optional.of(reader.readLine()).get().trim();\n+            String lineLowered = line.toLowerCase();\n+            if (lineLowered.startsWith(TIMESTAMP_HEADER_PREFIX)) {\n+                return convertTimestampLine(line);\n+            } else {\n+                throw new InvalidDatasetException(\"Timestamp / column header not found in account balance file\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyNTU4NA=="}, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTExOTU2OA==", "bodyText": "Should be fixed, added a check as well to make sure the next line has the column headers", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499119568", "createdAt": "2020-10-03T05:54:36Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# timestamp:\";\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+\n+    private final int fileBufferSize;\n+    private final long systemShardNum;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    public BalanceFileReaderImplV2(BalanceParserProperties balanceParserProperties, AccountBalanceLineParserV2\n+            parser) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.systemShardNum = balanceParserProperties.getMirrorProperties().getShard();\n+        this.parser = parser;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, systemShardNum);\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            //Discard the first line/version number\n+            reader.readLine();\n+            line = Optional.of(reader.readLine()).get().trim();\n+            String lineLowered = line.toLowerCase();\n+            if (lineLowered.startsWith(TIMESTAMP_HEADER_PREFIX)) {\n+                return convertTimestampLine(line);\n+            } else {\n+                throw new InvalidDatasetException(\"Timestamp / column header not found in account balance file\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyNTU4NA=="}, "originalCommit": {"oid": "e2c668358b16977fb2a3d82ea0f95d4bad1f11e2"}, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzcwOTQ3OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNzo1NzowMFrOHb2k6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwNDoyMToyOVrOHb_iKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk2Nzc4Nw==", "bodyText": "Reader not being closed on unhappy path. Use try with resources", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498967787", "createdAt": "2020-10-02T17:57:00Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.version1Reader = balanceFileReaderImplV1;\n+        this.version2Reader = balanceFileReaderImplV2;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTExMjgzMQ==", "bodyText": "Wrapped in try with resources, also wrapped the two other Readers in a try with resources", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499112831", "createdAt": "2020-10-03T03:51:23Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.version1Reader = balanceFileReaderImplV1;\n+        this.version2Reader = balanceFileReaderImplV2;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk2Nzc4Nw=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTExNDUzOA==", "bodyText": "Scratch that, I refactored this one to be a try with resource, I see the other two won't work with that because they are returning streams, I have put those back.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499114538", "createdAt": "2020-10-03T04:21:29Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.version1Reader = balanceFileReaderImplV1;\n+        this.version2Reader = balanceFileReaderImplV2;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk2Nzc4Nw=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzcxMzc0OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNzo1ODozMVrOHb2npQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwMzoxNDozNVrOHb_TDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk2ODQ4NQ==", "bodyText": "The reader classes should go in com.hedera.mirror.importer.reader.balance so they can be later shared with downloader.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498968485", "createdAt": "2020-10-02T17:58:31Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTExMDY2OA==", "bodyText": "All four Reader classes have been moved to that package", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499110668", "createdAt": "2020-10-03T03:14:35Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk2ODQ4NQ=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzc4MjAwOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxODoxOTo1MVrOHb3VVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwMzoxNDo0NlrOHb_TEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4MDE4Mw==", "bodyText": "You don't need this. The composite only reads a single line so it's inefficient to tell the reader to load 200K characters. Can switch to @RequiredArgsConstructor once removed.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498980183", "createdAt": "2020-10-02T18:19:51Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTExMDY3Mg==", "bodyText": "Removed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499110672", "createdAt": "2020-10-03T03:14:46Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4MDE4Mw=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzc4NTAzOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxODoyMDo0OVrOHb3XHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwMzo1MzozNFrOHb_b8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4MDYzOQ==", "bodyText": "We don't need as much buffer as fileBufferSize property and even the default in BufferedReader might be too much. Please considering passing a reasonable value to read one line.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498980639", "createdAt": "2020-10-02T18:20:49Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.version1Reader = balanceFileReaderImplV1;\n+        this.version2Reader = balanceFileReaderImplV2;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTExMjk0NQ==", "bodyText": "Knocked the buffer size down to 16, the smallest power of 2 to fit the Version 2 header in.  Since we're also only looking for those first characters, not even the entire first line, I added a BoundedInputStream so we're not reading the entire first line, and I added a test to confirm this works.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499112945", "createdAt": "2020-10-03T03:53:34Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.version1Reader = balanceFileReaderImplV1;\n+        this.version2Reader = balanceFileReaderImplV2;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4MDYzOQ=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzc5OTg3OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxODoyNTozN1rOHb3gPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwMzo1NDoxNFrOHb_cIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4Mjk3Mw==", "bodyText": "I'm not sure we should be so lenient with case or spaces. Maybe trailing spaces but not leading spaces. Recommend avoiding optional, trim, toLowerCase and just using StringUtils.startsWith(line, VERSION_2_HEADER_PREFIX).", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498982973", "createdAt": "2020-10-02T18:25:37Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.version1Reader = balanceFileReaderImplV1;\n+        this.version2Reader = balanceFileReaderImplV2;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            String line = Optional.of(reader.readLine()).get().trim();\n+            String lineLowered = line.toLowerCase();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTExMjk5NQ==", "bodyText": "Removed all leniency.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499112995", "createdAt": "2020-10-03T03:54:14Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.version1Reader = balanceFileReaderImplV1;\n+        this.version2Reader = balanceFileReaderImplV2;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            String line = Optional.of(reader.readLine()).get().trim();\n+            String lineLowered = line.toLowerCase();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4Mjk3Mw=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzgxNTMyOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxODozMDoxOFrOHb3pew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwMzo1NToxN1rOHb_cYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4NTMzOQ==", "bodyText": "Duplicates call to read. Would be better to have a private BalanceFileReader getReader(file) method that encapsulates the reader selection.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498985339", "createdAt": "2020-10-02T18:30:18Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.version1Reader = balanceFileReaderImplV1;\n+        this.version2Reader = balanceFileReaderImplV2;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            String line = Optional.of(reader.readLine()).get().trim();\n+            String lineLowered = line.toLowerCase();\n+            reader.close();\n+            if (lineLowered.startsWith(VERSION_2_HEADER_PREFIX)) {\n+                return version2Reader.read(file);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTExMzA1OA==", "bodyText": "Added that method to only call read() once", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499113058", "createdAt": "2020-10-03T03:55:17Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final int fileBufferSize;\n+\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    public CompositeBalanceFileReader(BalanceParserProperties balanceParserProperties,\n+                                      BalanceFileReaderImplV1 balanceFileReaderImplV1,\n+                                      BalanceFileReaderImplV2 balanceFileReaderImplV2) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.version1Reader = balanceFileReaderImplV1;\n+        this.version2Reader = balanceFileReaderImplV2;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            String line = Optional.of(reader.readLine()).get().trim();\n+            String lineLowered = line.toLowerCase();\n+            reader.close();\n+            if (lineLowered.startsWith(VERSION_2_HEADER_PREFIX)) {\n+                return version2Reader.read(file);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4NTMzOQ=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzgyMjg4OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxODozMjo1M1rOHb3uTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwNjoyMzoyNVrOHb_8IA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4NjU3Mg==", "bodyText": "Please create an interface that these both implement.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r498986572", "createdAt": "2020-10-02T18:32:53Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyMTE4NA==", "bodyText": "Created AccountBalanceLineParser interface", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499121184", "createdAt": "2020-10-03T06:23:25Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4NjU3Mg=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzkzMzkxOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxOToxMzoyOFrOHb40xA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwNjoyMzozOFrOHb_8NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAwNDYxMg==", "bodyText": "Comment out of date", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499004612", "createdAt": "2020-10-02T19:13:28Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 {\n+\n+    /**\n+     * Parses an account balance line to extract shard, realm, account, and balance. If the shard matches", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyMTIwNQ==", "bodyText": "Adjusted comment to mention token balances", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499121205", "createdAt": "2020-10-03T06:23:38Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 {\n+\n+    /**\n+     * Parses an account balance line to extract shard, realm, account, and balance. If the shard matches", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAwNDYxMg=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzk0MjU0OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxOToxNjo1MlrOHb46VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwNjoyODo1OFrOHb_9eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAwNjAzNw==", "bodyText": "Would be more robust to use Splitter.on(',').trimResults().omitEmptyStrings().splitToList(line).", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499006037", "createdAt": "2020-10-02T19:16:52Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 {\n+\n+    /**\n+     * Parses an account balance line to extract shard, realm, account, and balance. If the shard matches\n+     * systemShardNum, creates and returns an {@code AccountBalance} entity object. The account balance line should be\n+     * in the format of \"shard,realm,account,balance\"\n+     *\n+     * @param line               The account balance line\n+     * @param consensusTimestamp The consensus timestamp of the account balance line\n+     * @param systemShardNum     The system shard number\n+     * @return {@code AccountBalance} entity object\n+     * @throws InvalidDatasetException if the line is malformed or the shard does not match {@code systemShardNum}\n+     */\n+    public AccountBalance parse(String line, long consensusTimestamp, long systemShardNum) {\n+        try {\n+            String[] parts = line.split(\",\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyMTUzMA==", "bodyText": "Done here and in the v1 parser", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499121530", "createdAt": "2020-10-03T06:28:58Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 {\n+\n+    /**\n+     * Parses an account balance line to extract shard, realm, account, and balance. If the shard matches\n+     * systemShardNum, creates and returns an {@code AccountBalance} entity object. The account balance line should be\n+     * in the format of \"shard,realm,account,balance\"\n+     *\n+     * @param line               The account balance line\n+     * @param consensusTimestamp The consensus timestamp of the account balance line\n+     * @param systemShardNum     The system shard number\n+     * @return {@code AccountBalance} entity object\n+     * @throws InvalidDatasetException if the line is malformed or the shard does not match {@code systemShardNum}\n+     */\n+    public AccountBalance parse(String line, long consensusTimestamp, long systemShardNum) {\n+        try {\n+            String[] parts = line.split(\",\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAwNjAzNw=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzk1NTQxOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxOToyMTozNlrOHb5Cig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwMzo1NzowNVrOHb_cug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAwODEzOA==", "bodyText": "We don't need to store these properties separately. Just store the BalanceParserProperties as a field. This allows these values to change without requiring a restart. We should probably change the other reader.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499008138", "createdAt": "2020-10-02T19:21:36Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# timestamp:\";\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+\n+    private final int fileBufferSize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTExMzE0Ng==", "bodyText": "Removed from both readers", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499113146", "createdAt": "2020-10-03T03:57:05Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# timestamp:\";\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+\n+    private final int fileBufferSize;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAwODEzOA=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzk3NTA3OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/resources/data/accountBalances/v2/2020-09-22T04_25_00.083212003Z_Balances.csv", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxOToyOToxMlrOHb5PHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzozOTo1OFrOHcnObA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAxMTM1OA==", "bodyText": "The existing CSVs should be moved to a v1 folder.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499011358", "createdAt": "2020-10-02T19:29:12Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/resources/data/accountBalances/v2/2020-09-22T04_25_00.083212003Z_Balances.csv", "diffHunk": "@@ -0,0 +1,109 @@\n+# 0.1.0\n+# TimeStamp:2020-09-22T04:25:00.083212003Z\n+shardNum,realmNum,accountNum,balance,tokenBalances", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2NDg0NA==", "bodyText": "All previous files have been moved to v1, and all tests have been refactored to point to the new dir", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499764844", "createdAt": "2020-10-05T17:39:58Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/test/resources/data/accountBalances/v2/2020-09-22T04_25_00.083212003Z_Balances.csv", "diffHunk": "@@ -0,0 +1,109 @@\n+# 0.1.0\n+# TimeStamp:2020-09-22T04:25:00.083212003Z\n+shardNum,realmNum,accountNum,balance,tokenBalances", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAxMTM1OA=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzk4NzEzOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2Test.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxOTozMzo0OFrOHb5WsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwNDoxOToyNlrOHb_hqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAxMzI5Nw==", "bodyText": "This test doesn't need to copy any files and it doesn't need a temp path. Can remove fileCopier, sampleFile, testFile, mirrorProperties and dataPath. Just inject the example file and directly balanceFileReader.read(balanceFile). Inject like so:\n@Value(\"classpath:data/accountBalances/v2/2020-09-22T04_25_00.083212003Z_Balances.csv\")\nprivate File balanceFile;", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499013297", "createdAt": "2020-10-02T19:33:48Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2Test.java", "diffHunk": "@@ -0,0 +1,216 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.file.Path;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.stream.Stream;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.springframework.core.io.ClassPathResource;\n+\n+import com.hedera.mirror.importer.FileCopier;\n+import com.hedera.mirror.importer.MirrorProperties;\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+class BalanceFileReaderImplV2Test {\n+    private static final String sampleBalanceFileName = \"2020-09-22T04_25_00.083212003Z_Balances.csv\";\n+\n+    @TempDir\n+    Path dataPath;\n+\n+    private MirrorProperties mirrorProperties;\n+    private BalanceFileReaderImplV2 balanceFileReader;\n+    private AccountBalanceLineParserV2 parser;\n+\n+    private long sampleConsensusTimestamp;\n+    private FileCopier fileCopier;\n+    private File sampleFile;\n+    private File testFile;\n+\n+    @BeforeEach\n+    void setup() throws IOException {\n+        mirrorProperties = new MirrorProperties();\n+        parser = new AccountBalanceLineParserV2();\n+        balanceFileReader = new BalanceFileReaderImplV2(new BalanceParserProperties(mirrorProperties), parser);\n+        var resource = new ClassPathResource(\"data\");\n+        StreamType streamType = StreamType.BALANCE;\n+        fileCopier = FileCopier", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTExNDQxMA==", "bodyText": "Refactored this to not use the file copy.  Also refactored the V1Reader test to do the same.  Couple things:\n\nHad to make it a Spring Boot test to use the @Value, I extended the Integration Test since it seemed appropriate\nStill need the testFile to write temporary lines to so it doesn't destroy the sample file, I just converted this to a temp file\nThe mirror properties are being used in a couple places in the tests to get the shard num.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499114410", "createdAt": "2020-10-03T04:19:26Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2Test.java", "diffHunk": "@@ -0,0 +1,216 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.file.Path;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.stream.Stream;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.springframework.core.io.ClassPathResource;\n+\n+import com.hedera.mirror.importer.FileCopier;\n+import com.hedera.mirror.importer.MirrorProperties;\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.StreamType;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+class BalanceFileReaderImplV2Test {\n+    private static final String sampleBalanceFileName = \"2020-09-22T04_25_00.083212003Z_Balances.csv\";\n+\n+    @TempDir\n+    Path dataPath;\n+\n+    private MirrorProperties mirrorProperties;\n+    private BalanceFileReaderImplV2 balanceFileReader;\n+    private AccountBalanceLineParserV2 parser;\n+\n+    private long sampleConsensusTimestamp;\n+    private FileCopier fileCopier;\n+    private File sampleFile;\n+    private File testFile;\n+\n+    @BeforeEach\n+    void setup() throws IOException {\n+        mirrorProperties = new MirrorProperties();\n+        parser = new AccountBalanceLineParserV2();\n+        balanceFileReader = new BalanceFileReaderImplV2(new BalanceParserProperties(mirrorProperties), parser);\n+        var resource = new ClassPathResource(\"data\");\n+        StreamType streamType = StreamType.BALANCE;\n+        fileCopier = FileCopier", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAxMzI5Nw=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNDA2MTIxOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/repository/AccountBalanceRepositoryTest.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMDowMjo0M1rOHb6FPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMDoyNzowM1rOHcslJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyNTIxNA==", "bodyText": "The test failure is caused by actual tokenBalances not equal to expected tokenBalances\nIn addition, since AccountBalance has oneToMany field List<TokenBalance>, we should test with token balance data instead of empty", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499025214", "createdAt": "2020-10-02T20:02:43Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/repository/AccountBalanceRepositoryTest.java", "diffHunk": "@@ -39,7 +40,7 @@ void findByConsensusTimestamp() {\n         AccountBalance accountBalance1 = create(1L, 1, 100);\n         AccountBalance accountBalance2 = create(1L, 2, 200);\n         create(2L, 1, 50);\n-\n+        \n         assertThat(accountBalanceRepository.findByIdConsensusTimestamp(1L))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEyMDA3OQ==", "bodyText": "I've added the usingRecursiveFieldByFieldElementComparator to force the check to look at the tokenBalance fields instead of doing a basic ==.  Will work on adding token balance data.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499120079", "createdAt": "2020-10-03T06:04:57Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/repository/AccountBalanceRepositoryTest.java", "diffHunk": "@@ -39,7 +40,7 @@ void findByConsensusTimestamp() {\n         AccountBalance accountBalance1 = create(1L, 1, 100);\n         AccountBalance accountBalance2 = create(1L, 2, 200);\n         create(2L, 1, 50);\n-\n+        \n         assertThat(accountBalanceRepository.findByIdConsensusTimestamp(1L))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyNTIxNA=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0MzEyMA==", "bodyText": "Added Token Balance data to this test, I'm seeing some very odd behavior with the repository that's causing this test to fail so I will continue investigating.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499743120", "createdAt": "2020-10-05T17:00:01Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/repository/AccountBalanceRepositoryTest.java", "diffHunk": "@@ -39,7 +40,7 @@ void findByConsensusTimestamp() {\n         AccountBalance accountBalance1 = create(1L, 1, 100);\n         AccountBalance accountBalance2 = create(1L, 2, 200);\n         create(2L, 1, 50);\n-\n+        \n         assertThat(accountBalanceRepository.findByIdConsensusTimestamp(1L))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyNTIxNA=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg1MjU4Mw==", "bodyText": "The issues with the join have been resolved, this is now fully fixed.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499852583", "createdAt": "2020-10-05T20:27:03Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/repository/AccountBalanceRepositoryTest.java", "diffHunk": "@@ -39,7 +40,7 @@ void findByConsensusTimestamp() {\n         AccountBalance accountBalance1 = create(1L, 1, 100);\n         AccountBalance accountBalance2 = create(1L, 2, 200);\n         create(2L, 1, 50);\n-\n+        \n         assertThat(accountBalanceRepository.findByIdConsensusTimestamp(1L))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyNTIxNA=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNDIzNTAzOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/repository/TokenBalanceRepository.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMToxMjo1MFrOHb7wsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwNTo0OTo0MVrOHb_0tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1MjcyMg==", "bodyText": "Missing copyright. Please scan the other new files for the same.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499052722", "createdAt": "2020-10-02T21:12:50Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/repository/TokenBalanceRepository.java", "diffHunk": "@@ -0,0 +1,8 @@\n+package com.hedera.mirror.importer.repository;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTExOTI4Ng==", "bodyText": "Added copyright", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499119286", "createdAt": "2020-10-03T05:49:41Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/repository/TokenBalanceRepository.java", "diffHunk": "@@ -0,0 +1,8 @@\n+package com.hedera.mirror.importer.repository;\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1MjcyMg=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNDI1MTczOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMToyMDozMFrOHb768g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwNTo0MTowNFrOHb_zFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1NTM0Ng==", "bodyText": "NPE. There's no point in using Optional here. StringUtils.defaultString(reader.readLine()) might be appropriate if you don't want to have to check for null.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499055346", "createdAt": "2020-10-02T21:20:30Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# timestamp:\";\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+\n+    private final int fileBufferSize;\n+    private final long systemShardNum;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    public BalanceFileReaderImplV2(BalanceParserProperties balanceParserProperties, AccountBalanceLineParserV2\n+            parser) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.systemShardNum = balanceParserProperties.getMirrorProperties().getShard();\n+        this.parser = parser;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, systemShardNum);\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            //Discard the first line/version number\n+            reader.readLine();\n+            line = Optional.of(reader.readLine()).get().trim();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTExODg3MA==", "bodyText": "Removed, and catching the NPE", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499118870", "createdAt": "2020-10-03T05:41:04Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# timestamp:\";\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+\n+    private final int fileBufferSize;\n+    private final long systemShardNum;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    public BalanceFileReaderImplV2(BalanceParserProperties balanceParserProperties, AccountBalanceLineParserV2\n+            parser) {\n+        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n+        this.systemShardNum = balanceParserProperties.getMirrorProperties().getShard();\n+        this.parser = parser;\n+    }\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    fileBufferSize);\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, systemShardNum);\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            //Discard the first line/version number\n+            reader.readLine();\n+            line = Optional.of(reader.readLine()).get().trim();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1NTM0Ng=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNDI1NTY2OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMToyMjoxMFrOHb79XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwNTo0MDoyNVrOHb_y4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1NTk2NQ==", "bodyText": "This constant belongs in BalanceFileReaderImplV2. BalanceFileReaderImplV2 should also probably be verifying this line so it can be encapsulated.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499055965", "createdAt": "2020-10-02T21:22:10Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTExODgxOQ==", "bodyText": "Moved to BalanceFileReaderImplV2", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499118819", "createdAt": "2020-10-03T05:40:25Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.hedera.mirror.importer.parser.balance;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.v1.BalanceFileReaderImplV1;\n+import com.hedera.mirror.importer.parser.balance.v2.BalanceFileReaderImplV2;\n+\n+@Named\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1NTk2NQ=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNDI1NzY2OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMToyMzowOFrOHb7-ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QwMzo1NjozN1rOHb_ckQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1NjI2Ng==", "bodyText": "Unused?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499056266", "createdAt": "2020-10-02T21:23:08Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# timestamp:\";\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTExMzEwNQ==", "bodyText": "Now being used to confirm column headers exist", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499113105", "createdAt": "2020-10-03T03:56:37Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/v2/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.hedera.mirror.importer.parser.balance.v2;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceFileReader;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# timestamp:\";\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1NjI2Ng=="}, "originalCommit": {"oid": "31b80795d0a0591f2de99cd3290080b28453deee"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODkwMDA1OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/CompositeBalanceFileReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjozMTozNVrOHck5Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwMDoyNDowMFrOHcx__Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcyNjYzOA==", "bodyText": "Catching NPE is an anti-pattern, in my opinion. The code should be fixed to handle all the null scenarios. Here, version2Reader.isFirstLineFromFileVersion(line) should be fixed to either check if line is not null before comparison or use a library like StringUtils.startsWith().", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499726638", "createdAt": "2020-10-05T16:31:35Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import org.apache.commons.io.input.BoundedInputStream;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+@RequiredArgsConstructor\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+\n+    static final int BUFFER_SIZE = 16;\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        return getReader(file).read(file);\n+    }\n+\n+    private BalanceFileReader getReader(File file) {\n+        try (BufferedReader reader =\n+                     new BufferedReader(new InputStreamReader(new BoundedInputStream(new FileInputStream(file),\n+                             BUFFER_SIZE)), BUFFER_SIZE)) {\n+            String line = reader.readLine();\n+            if (version2Reader.isFirstLineFromFileVersion(line)) {\n+                return version2Reader;\n+            } else {\n+                return version1Reader;\n+            }\n+        } catch (IOException | NullPointerException ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c0297538487d7d960b69313d0de408cd7ee662"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk0MTM3Mw==", "bodyText": "I've switched isFirstLineFromFileVersion to use the StringUtils to be null safe.\n\n\nI've also added a check to the Composite Reader to see if the first line is null, as the documentation says that a null line would only be returned if the end of the stream is reached, which would mean we got an empty file that no reader would be able to do anything with.\n\n\nAlso added null checks for File at the beginning of each reader.\n\n\nRemoved all NPE catches", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499941373", "createdAt": "2020-10-06T00:24:00Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/CompositeBalanceFileReader.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import org.apache.commons.io.input.BoundedInputStream;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+@RequiredArgsConstructor\n+public class CompositeBalanceFileReader implements BalanceFileReader {\n+\n+    static final int BUFFER_SIZE = 16;\n+    private final BalanceFileReaderImplV1 version1Reader;\n+    private final BalanceFileReaderImplV2 version2Reader;\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        return getReader(file).read(file);\n+    }\n+\n+    private BalanceFileReader getReader(File file) {\n+        try (BufferedReader reader =\n+                     new BufferedReader(new InputStreamReader(new BoundedInputStream(new FileInputStream(file),\n+                             BUFFER_SIZE)), BUFFER_SIZE)) {\n+            String line = reader.readLine();\n+            if (version2Reader.isFirstLineFromFileVersion(line)) {\n+                return version2Reader;\n+            } else {\n+                return version1Reader;\n+            }\n+        } catch (IOException | NullPointerException ex) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcyNjYzOA=="}, "originalCommit": {"oid": "61c0297538487d7d960b69313d0de408cd7ee662"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODkwNDcwOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjozMjo1N1rOHck8DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwMDoyNjoxN1rOHcyCOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcyNzM3Mw==", "bodyText": "See previous comment about anti-pattern. Also because a null check is orders of magnitude faster than generating an exception. Please check if readLine() calls return null.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499727373", "createdAt": "2020-10-05T16:32:57Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.parser.balance.line.AccountBalanceLineParserV2;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# TimeStamp:\";\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final BalanceParserProperties balanceParserProperties;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    balanceParserProperties.getFileBufferSize());\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, balanceParserProperties.getMirrorProperties()\n+                                    .getShard());\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    public boolean isFirstLineFromFileVersion(String firstLine) {\n+        return firstLine.startsWith(VERSION_2_HEADER_PREFIX);\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            //Discard the first line/version number\n+            reader.readLine();\n+            line = reader.readLine();\n+            if (line.startsWith(TIMESTAMP_HEADER_PREFIX)) {\n+                long consensusTimestamp = convertTimestampLine(line);\n+                line = reader.readLine();\n+                if (line.startsWith(COLUMN_HEADER_PREFIX)) {\n+                    return consensusTimestamp;\n+                } else {\n+                    throw new InvalidDatasetException(\"Column header not found in account balance file\");\n+                }\n+            } else {\n+                throw new InvalidDatasetException(\"Timestamp not found in account balance file\");\n+            }\n+        } catch (NullPointerException ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c0297538487d7d960b69313d0de408cd7ee662"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk0MTk0NA==", "bodyText": "Removed NPE checks and added explicit null checks with clearer exceptions", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499941944", "createdAt": "2020-10-06T00:26:17Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.parser.balance.line.AccountBalanceLineParserV2;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# TimeStamp:\";\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final BalanceParserProperties balanceParserProperties;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    balanceParserProperties.getFileBufferSize());\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, balanceParserProperties.getMirrorProperties()\n+                                    .getShard());\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    public boolean isFirstLineFromFileVersion(String firstLine) {\n+        return firstLine.startsWith(VERSION_2_HEADER_PREFIX);\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            //Discard the first line/version number\n+            reader.readLine();\n+            line = reader.readLine();\n+            if (line.startsWith(TIMESTAMP_HEADER_PREFIX)) {\n+                long consensusTimestamp = convertTimestampLine(line);\n+                line = reader.readLine();\n+                if (line.startsWith(COLUMN_HEADER_PREFIX)) {\n+                    return consensusTimestamp;\n+                } else {\n+                    throw new InvalidDatasetException(\"Column header not found in account balance file\");\n+                }\n+            } else {\n+                throw new InvalidDatasetException(\"Timestamp not found in account balance file\");\n+            }\n+        } catch (NullPointerException ex) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcyNzM3Mw=="}, "originalCommit": {"oid": "61c0297538487d7d960b69313d0de408cd7ee662"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODkyNjMzOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjozOToxMVrOHclKFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMzo0MjoxNVrOHcxROQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczMDk2Ng==", "bodyText": "Since the line parsers are only used by the readers, they should probably be moved to the same package as the readers (or a sub-package).", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499730966", "createdAt": "2020-10-05T16:39:11Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.parser.balance.line.AccountBalanceLineParserV2;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c0297538487d7d960b69313d0de408cd7ee662"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkyOTQwMQ==", "bodyText": "moved to reader.balance.line", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499929401", "createdAt": "2020-10-05T23:42:15Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.parser.balance.line.AccountBalanceLineParserV2;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczMDk2Ng=="}, "originalCommit": {"oid": "61c0297538487d7d960b69313d0de408cd7ee662"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODkzNjkzOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/line/AccountBalanceLineParserV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjo0MjowNVrOHclQuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMzo0MzowMFrOHcxR8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczMjY2NQ==", "bodyText": "Splitter is an immutable, stateless object so its construction can be moved to a class static constant. e.g.\nprivate static final Splitter SPLITTER = Splitter.on(',').trimResults().omitEmptyStrings();", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499732665", "createdAt": "2020-10-05T16:42:05Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/line/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package com.hedera.mirror.importer.parser.balance.line;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.google.common.base.Splitter;\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 implements AccountBalanceLineParser {\n+\n+    /**\n+     * Parses an account balance line to extract shard, realm, account, balance, and token balances. If the shard\n+     * matches systemShardNum, creates and returns an {@code AccountBalance} entity object. The account balance line\n+     * should be in the format of \"shard,realm,account,balance\"\n+     *\n+     * @param line               The account balance line\n+     * @param consensusTimestamp The consensus timestamp of the account balance line\n+     * @param systemShardNum     The system shard number\n+     * @return {@code AccountBalance} entity object\n+     * @throws InvalidDatasetException if the line is malformed or the shard does not match {@code systemShardNum}\n+     */\n+    @Override\n+    public AccountBalance parse(String line, long consensusTimestamp, long systemShardNum) {\n+        try {\n+            List<String> parts = Splitter.on(',').trimResults().omitEmptyStrings().splitToList(line);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c0297538487d7d960b69313d0de408cd7ee662"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkyOTU4NQ==", "bodyText": "I've added the Splitter as a constant to both versions of the FileReader", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499929585", "createdAt": "2020-10-05T23:43:00Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/line/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package com.hedera.mirror.importer.parser.balance.line;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.google.common.base.Splitter;\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 implements AccountBalanceLineParser {\n+\n+    /**\n+     * Parses an account balance line to extract shard, realm, account, balance, and token balances. If the shard\n+     * matches systemShardNum, creates and returns an {@code AccountBalance} entity object. The account balance line\n+     * should be in the format of \"shard,realm,account,balance\"\n+     *\n+     * @param line               The account balance line\n+     * @param consensusTimestamp The consensus timestamp of the account balance line\n+     * @param systemShardNum     The system shard number\n+     * @return {@code AccountBalance} entity object\n+     * @throws InvalidDatasetException if the line is malformed or the shard does not match {@code systemShardNum}\n+     */\n+    @Override\n+    public AccountBalance parse(String line, long consensusTimestamp, long systemShardNum) {\n+        try {\n+            List<String> parts = Splitter.on(',').trimResults().omitEmptyStrings().splitToList(line);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczMjY2NQ=="}, "originalCommit": {"oid": "61c0297538487d7d960b69313d0de408cd7ee662"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODk0MDYzOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2Test.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjo0MzowNVrOHclTAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMzo0Mzo1NFrOHcxS7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczMzI0OQ==", "bodyText": "nit: Both Files should be private.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499733249", "createdAt": "2020-10-05T16:43:05Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2Test.java", "diffHunk": "@@ -0,0 +1,249 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.file.Files;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.stream.Stream;\n+import javax.annotation.Resource;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Value;\n+\n+import com.hedera.mirror.importer.IntegrationTest;\n+import com.hedera.mirror.importer.MirrorProperties;\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.line.AccountBalanceLineParserV2;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+class BalanceFileReaderImplV2Test extends IntegrationTest {\n+\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+    private static final String VERSION_1_TIMESTAMP_HEADER_PREFIX = \"timestamp:\";\n+\n+    @Resource\n+    private MirrorProperties mirrorProperties;\n+    @Resource\n+    private BalanceFileReaderImplV2 balanceFileReader;\n+    @Resource\n+    private AccountBalanceLineParserV2 parser;\n+\n+    private long sampleConsensusTimestamp;\n+\n+    @Value(\"classpath:data/accountBalances/v2/2020-09-22T04_25_00.083212003Z_Balances.csv\")\n+    File balanceFile;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c0297538487d7d960b69313d0de408cd7ee662"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkyOTgzNg==", "bodyText": "Made the files private here and in a few other places I spotted it", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499929836", "createdAt": "2020-10-05T23:43:54Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2Test.java", "diffHunk": "@@ -0,0 +1,249 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.file.Files;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.stream.Stream;\n+import javax.annotation.Resource;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Value;\n+\n+import com.hedera.mirror.importer.IntegrationTest;\n+import com.hedera.mirror.importer.MirrorProperties;\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.line.AccountBalanceLineParserV2;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+class BalanceFileReaderImplV2Test extends IntegrationTest {\n+\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+    private static final String VERSION_1_TIMESTAMP_HEADER_PREFIX = \"timestamp:\";\n+\n+    @Resource\n+    private MirrorProperties mirrorProperties;\n+    @Resource\n+    private BalanceFileReaderImplV2 balanceFileReader;\n+    @Resource\n+    private AccountBalanceLineParserV2 parser;\n+\n+    private long sampleConsensusTimestamp;\n+\n+    @Value(\"classpath:data/accountBalances/v2/2020-09-22T04_25_00.083212003Z_Balances.csv\")\n+    File balanceFile;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczMzI0OQ=="}, "originalCommit": {"oid": "61c0297538487d7d960b69313d0de408cd7ee662"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMDAwMjk5OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/line/AccountBalanceLineParserV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMjoxNjo1OVrOHcvoZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwMDo1MTozMFrOHcyauQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMjU2Ng==", "bodyText": "Again, NPE should be avoided. Can simply wrap for loop in check for StringUtils.isNotBlank(line) and return empty tokenBalances.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499902566", "createdAt": "2020-10-05T22:16:59Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/line/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package com.hedera.mirror.importer.parser.balance.line;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.google.common.base.Splitter;\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 implements AccountBalanceLineParser {\n+\n+    /**\n+     * Parses an account balance line to extract shard, realm, account, balance, and token balances. If the shard\n+     * matches systemShardNum, creates and returns an {@code AccountBalance} entity object. The account balance line\n+     * should be in the format of \"shard,realm,account,balance\"\n+     *\n+     * @param line               The account balance line\n+     * @param consensusTimestamp The consensus timestamp of the account balance line\n+     * @param systemShardNum     The system shard number\n+     * @return {@code AccountBalance} entity object\n+     * @throws InvalidDatasetException if the line is malformed or the shard does not match {@code systemShardNum}\n+     */\n+    @Override\n+    public AccountBalance parse(String line, long consensusTimestamp, long systemShardNum) {\n+        try {\n+            List<String> parts = Splitter.on(',').trimResults().omitEmptyStrings().splitToList(line);\n+            boolean hasTokenBalance;\n+            if (parts.size() == 5) {\n+                hasTokenBalance = true;\n+            } else if (parts.size() == 4) {\n+                hasTokenBalance = false;\n+            } else {\n+                throw new InvalidDatasetException(\"Invalid account balance line: \" + line);\n+            }\n+\n+            long shardNum = Long.parseLong(parts.get(0));\n+            int realmNum = Integer.parseInt(parts.get(1));\n+            int accountNum = Integer.parseInt(parts.get(2));\n+            long balance = Long.parseLong(parts.get(3));\n+\n+            if (shardNum < 0 || realmNum < 0 || accountNum < 0 || balance < 0) {\n+                throw new InvalidDatasetException(\"Invalid account balance line: \" + line);\n+            }\n+\n+            if (shardNum != systemShardNum) {\n+                throw new InvalidDatasetException(String.format(\"Invalid account balance line: %s. Expect \" +\n+                        \"shard (%d), got shard (%d)\", line, systemShardNum, shardNum));\n+            }\n+\n+            EntityId accountId = EntityId\n+                    .of(shardNum, realmNum, accountNum, EntityTypeEnum.ACCOUNT);\n+\n+            List<TokenBalance> tokenBalances = hasTokenBalance ? parseTokenBalanceList(parts.get(4), consensusTimestamp,\n+                    accountId) : Collections\n+                    .emptyList();\n+\n+            return new AccountBalance(balance, tokenBalances, new AccountBalance.Id(consensusTimestamp, accountId));\n+        } catch (NullPointerException | NumberFormatException | InvalidProtocolBufferException ex) {\n+            throw new InvalidDatasetException(\"Invalid account balance line: \" + line, ex);\n+        }\n+    }\n+\n+    private List<TokenBalance> parseTokenBalanceList(String tokenBalancesProtoString, long consensusTimestamp,\n+                                                     EntityId accountId) throws InvalidProtocolBufferException {\n+        List<com.hederahashgraph.api.proto.java.TokenBalance> tokenBalanceProtoList =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7ca1fb11f36879e03a66021b19da3b253088915"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk0ODIxNw==", "bodyText": "I think the NPE catch was meant for the line splitter when it was still doing line.split(\",\").  If it gets to this point in the code it should have a non-null string, which means if it fails it will be because it can't decode the protobuf, from there protobuf should always return a non-null list so we should be safe unless I'm missing something.\nI've removed the NPE catch and did an explicit check on the line not being null, if you want to have it swallow/log the InvalidProtocolBufferException and return an empty list I can do that, but I think NPE-wise we're safe.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499948217", "createdAt": "2020-10-06T00:51:30Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/balance/line/AccountBalanceLineParserV2.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package com.hedera.mirror.importer.parser.balance.line;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.google.common.base.Splitter;\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.hederahashgraph.api.proto.java.TokenBalances;\n+import com.hederahashgraph.api.proto.java.TokenID;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.inject.Named;\n+import org.apache.commons.codec.binary.Base64;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+import com.hedera.mirror.importer.domain.TokenBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+\n+@Named\n+public class AccountBalanceLineParserV2 implements AccountBalanceLineParser {\n+\n+    /**\n+     * Parses an account balance line to extract shard, realm, account, balance, and token balances. If the shard\n+     * matches systemShardNum, creates and returns an {@code AccountBalance} entity object. The account balance line\n+     * should be in the format of \"shard,realm,account,balance\"\n+     *\n+     * @param line               The account balance line\n+     * @param consensusTimestamp The consensus timestamp of the account balance line\n+     * @param systemShardNum     The system shard number\n+     * @return {@code AccountBalance} entity object\n+     * @throws InvalidDatasetException if the line is malformed or the shard does not match {@code systemShardNum}\n+     */\n+    @Override\n+    public AccountBalance parse(String line, long consensusTimestamp, long systemShardNum) {\n+        try {\n+            List<String> parts = Splitter.on(',').trimResults().omitEmptyStrings().splitToList(line);\n+            boolean hasTokenBalance;\n+            if (parts.size() == 5) {\n+                hasTokenBalance = true;\n+            } else if (parts.size() == 4) {\n+                hasTokenBalance = false;\n+            } else {\n+                throw new InvalidDatasetException(\"Invalid account balance line: \" + line);\n+            }\n+\n+            long shardNum = Long.parseLong(parts.get(0));\n+            int realmNum = Integer.parseInt(parts.get(1));\n+            int accountNum = Integer.parseInt(parts.get(2));\n+            long balance = Long.parseLong(parts.get(3));\n+\n+            if (shardNum < 0 || realmNum < 0 || accountNum < 0 || balance < 0) {\n+                throw new InvalidDatasetException(\"Invalid account balance line: \" + line);\n+            }\n+\n+            if (shardNum != systemShardNum) {\n+                throw new InvalidDatasetException(String.format(\"Invalid account balance line: %s. Expect \" +\n+                        \"shard (%d), got shard (%d)\", line, systemShardNum, shardNum));\n+            }\n+\n+            EntityId accountId = EntityId\n+                    .of(shardNum, realmNum, accountNum, EntityTypeEnum.ACCOUNT);\n+\n+            List<TokenBalance> tokenBalances = hasTokenBalance ? parseTokenBalanceList(parts.get(4), consensusTimestamp,\n+                    accountId) : Collections\n+                    .emptyList();\n+\n+            return new AccountBalance(balance, tokenBalances, new AccountBalance.Id(consensusTimestamp, accountId));\n+        } catch (NullPointerException | NumberFormatException | InvalidProtocolBufferException ex) {\n+            throw new InvalidDatasetException(\"Invalid account balance line: \" + line, ex);\n+        }\n+    }\n+\n+    private List<TokenBalance> parseTokenBalanceList(String tokenBalancesProtoString, long consensusTimestamp,\n+                                                     EntityId accountId) throws InvalidProtocolBufferException {\n+        List<com.hederahashgraph.api.proto.java.TokenBalance> tokenBalanceProtoList =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMjU2Ng=="}, "originalCommit": {"oid": "d7ca1fb11f36879e03a66021b19da3b253088915"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMDAwNjczOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMjoxODozOVrOHcvqng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMzo1NDoxMFrOHcxfxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMzEzNA==", "bodyText": "Would prefer version check is repeated here for encapsulation in case this class is ever used outside the composite in the future.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499903134", "createdAt": "2020-10-05T22:18:39Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.parser.balance.line.AccountBalanceLineParserV2;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# TimeStamp:\";\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final BalanceParserProperties balanceParserProperties;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    balanceParserProperties.getFileBufferSize());\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, balanceParserProperties.getMirrorProperties()\n+                                    .getShard());\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    public boolean isFirstLineFromFileVersion(String firstLine) {\n+        return firstLine.startsWith(VERSION_2_HEADER_PREFIX);\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            //Discard the first line/version number\n+            reader.readLine();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7ca1fb11f36879e03a66021b19da3b253088915"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkzMzEyNw==", "bodyText": "Added this check.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r499933127", "createdAt": "2020-10-05T23:54:10Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.parser.balance.line.AccountBalanceLineParserV2;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# TimeStamp:\";\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final BalanceParserProperties balanceParserProperties;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    balanceParserProperties.getFileBufferSize());\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, balanceParserProperties.getMirrorProperties()\n+                                    .getShard());\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    public boolean isFirstLineFromFileVersion(String firstLine) {\n+        return firstLine.startsWith(VERSION_2_HEADER_PREFIX);\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            //Discard the first line/version number\n+            reader.readLine();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMzEzNA=="}, "originalCommit": {"oid": "d7ca1fb11f36879e03a66021b19da3b253088915"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMjkxNjUxOnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNDo1MzozNVrOHdLY5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTo0MDoxNFrOHdOE0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM1NzM1MQ==", "bodyText": "nit: For future reference, prefer fail fast exception throwing where the negative path is first. This leads to less nested code and is easier to understand and maintain. e.g.\nif (!correct) {\n throw ...\n}\nif (stillNotCorrect) {\n  throw ...\n}\nreturn someValue;", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r500357351", "createdAt": "2020-10-06T14:53:35Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.apache.commons.lang3.StringUtils;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.reader.balance.line.AccountBalanceLineParserV2;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# TimeStamp:\";\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final BalanceParserProperties balanceParserProperties;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        if (file == null) {\n+            throw new InvalidDatasetException(\"Null file provided to balance file reader\");\n+        }\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    balanceParserProperties.getFileBufferSize());\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, balanceParserProperties.getMirrorProperties()\n+                                    .getShard());\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    public boolean isFirstLineFromFileVersion(String firstLine) {\n+        return StringUtils.startsWith(firstLine, VERSION_2_HEADER_PREFIX);\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            line = reader.readLine();\n+            if (isFirstLineFromFileVersion(line)) {\n+                line = reader.readLine();\n+                if (StringUtils.startsWith(line, TIMESTAMP_HEADER_PREFIX)) {\n+                    long consensusTimestamp = convertTimestampLine(line);\n+                    line = reader.readLine();\n+                    if (StringUtils.startsWith(line, COLUMN_HEADER_PREFIX)) {\n+                        return consensusTimestamp;\n+                    } else {\n+                        throw new InvalidDatasetException(\"Column header not found in account balance file\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70bd15d8d5f6872f35f3b7de31ee7663a09c1219"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQwMTM2Mw==", "bodyText": "Sure, that makes sense, I went ahead and fixed that.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r500401363", "createdAt": "2020-10-06T15:40:14Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.apache.commons.lang3.StringUtils;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.reader.balance.line.AccountBalanceLineParserV2;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# TimeStamp:\";\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final BalanceParserProperties balanceParserProperties;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        if (file == null) {\n+            throw new InvalidDatasetException(\"Null file provided to balance file reader\");\n+        }\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    balanceParserProperties.getFileBufferSize());\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, balanceParserProperties.getMirrorProperties()\n+                                    .getShard());\n+                        } catch (InvalidDatasetException ex) {\n+                            log.error(ex);\n+                            return null;\n+                        }\n+                    })\n+                    .filter(Objects::nonNull)\n+                    .onClose(() -> {\n+                        try {\n+                            reader.close();\n+                        } catch (Exception ex) {\n+                        }\n+                    });\n+        } catch (IOException ex) {\n+            throw new InvalidDatasetException(\"Error reading account balance file\", ex);\n+        }\n+    }\n+\n+    public boolean isFirstLineFromFileVersion(String firstLine) {\n+        return StringUtils.startsWith(firstLine, VERSION_2_HEADER_PREFIX);\n+    }\n+\n+    private long parseHeaderForConsensusTimestamp(BufferedReader reader) {\n+        String line = null;\n+        try {\n+            line = reader.readLine();\n+            if (isFirstLineFromFileVersion(line)) {\n+                line = reader.readLine();\n+                if (StringUtils.startsWith(line, TIMESTAMP_HEADER_PREFIX)) {\n+                    long consensusTimestamp = convertTimestampLine(line);\n+                    line = reader.readLine();\n+                    if (StringUtils.startsWith(line, COLUMN_HEADER_PREFIX)) {\n+                        return consensusTimestamp;\n+                    } else {\n+                        throw new InvalidDatasetException(\"Column header not found in account balance file\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM1NzM1MQ=="}, "originalCommit": {"oid": "70bd15d8d5f6872f35f3b7de31ee7663a09c1219"}, "originalPosition": 102}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMzAwMTQ4OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV1.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTowODowOFrOHdMPAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTo0MDoyNlrOHdOFlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3MTIwMw==", "bodyText": "balanceParserProperties.getMirrorProperties().getShard() is called per account balance line, there can be considerable performance hit. Please move it out of the streams pipeline.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r500371203", "createdAt": "2020-10-06T15:08:08Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV1.java", "diffHunk": "@@ -28,43 +28,45 @@\n import java.time.Instant;\n import java.time.format.DateTimeParseException;\n import java.util.Objects;\n-import java.util.Optional;\n import java.util.stream.Stream;\n import javax.inject.Named;\n+import lombok.AllArgsConstructor;\n import lombok.extern.log4j.Log4j2;\n+import org.apache.commons.lang3.StringUtils;\n \n import com.hedera.mirror.importer.domain.AccountBalance;\n import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.reader.balance.line.AccountBalanceLineParserV1;\n import com.hedera.mirror.importer.util.Utility;\n \n+@AllArgsConstructor\n @Log4j2\n @Named\n-public class BalanceFileReaderImpl implements BalanceFileReader {\n+public class BalanceFileReaderImplV1 implements BalanceFileReader {\n     private static final int MAX_HEADER_ROWS = 10;\n     private static final String TIMESTAMP_HEADER_PREFIX = \"timestamp:\";\n     private static final String COLUMN_HEADER_PREFIX = \"shard\";\n \n-    private final int fileBufferSize;\n-    private final long systemShardNum;\n-    private final AccountBalanceLineParser parser;\n-\n-    public BalanceFileReaderImpl(BalanceParserProperties balanceParserProperties, AccountBalanceLineParser parser) {\n-        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n-        this.systemShardNum = balanceParserProperties.getMirrorProperties().getShard();\n-        this.parser = parser;\n-    }\n+    private final BalanceParserProperties balanceParserProperties;\n+    private final AccountBalanceLineParserV1 parser;\n \n     @Override\n     public Stream<AccountBalance> read(File file) {\n+        if (file == null) {\n+            throw new InvalidDatasetException(\"Null file provided to balance file reader\");\n+        }\n         try {\n-            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)), fileBufferSize);\n-            final long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    balanceParserProperties.getFileBufferSize());\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n \n             return reader.lines()\n                     .map(line -> {\n                         try {\n-                            return parser.parse(line, consensusTimestamp, systemShardNum);\n-                        } catch(InvalidDatasetException ex) {\n+                            return parser.parse(line, consensusTimestamp, balanceParserProperties.getMirrorProperties()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70bd15d8d5f6872f35f3b7de31ee7663a09c1219"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM5MjcyOA==", "bodyText": "True, just meant to remove as class variable in my previous comment but for performance it should be a method scoped variable.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r500392728", "createdAt": "2020-10-06T15:30:48Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV1.java", "diffHunk": "@@ -28,43 +28,45 @@\n import java.time.Instant;\n import java.time.format.DateTimeParseException;\n import java.util.Objects;\n-import java.util.Optional;\n import java.util.stream.Stream;\n import javax.inject.Named;\n+import lombok.AllArgsConstructor;\n import lombok.extern.log4j.Log4j2;\n+import org.apache.commons.lang3.StringUtils;\n \n import com.hedera.mirror.importer.domain.AccountBalance;\n import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.reader.balance.line.AccountBalanceLineParserV1;\n import com.hedera.mirror.importer.util.Utility;\n \n+@AllArgsConstructor\n @Log4j2\n @Named\n-public class BalanceFileReaderImpl implements BalanceFileReader {\n+public class BalanceFileReaderImplV1 implements BalanceFileReader {\n     private static final int MAX_HEADER_ROWS = 10;\n     private static final String TIMESTAMP_HEADER_PREFIX = \"timestamp:\";\n     private static final String COLUMN_HEADER_PREFIX = \"shard\";\n \n-    private final int fileBufferSize;\n-    private final long systemShardNum;\n-    private final AccountBalanceLineParser parser;\n-\n-    public BalanceFileReaderImpl(BalanceParserProperties balanceParserProperties, AccountBalanceLineParser parser) {\n-        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n-        this.systemShardNum = balanceParserProperties.getMirrorProperties().getShard();\n-        this.parser = parser;\n-    }\n+    private final BalanceParserProperties balanceParserProperties;\n+    private final AccountBalanceLineParserV1 parser;\n \n     @Override\n     public Stream<AccountBalance> read(File file) {\n+        if (file == null) {\n+            throw new InvalidDatasetException(\"Null file provided to balance file reader\");\n+        }\n         try {\n-            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)), fileBufferSize);\n-            final long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    balanceParserProperties.getFileBufferSize());\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n \n             return reader.lines()\n                     .map(line -> {\n                         try {\n-                            return parser.parse(line, consensusTimestamp, systemShardNum);\n-                        } catch(InvalidDatasetException ex) {\n+                            return parser.parse(line, consensusTimestamp, balanceParserProperties.getMirrorProperties()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3MTIwMw=="}, "originalCommit": {"oid": "70bd15d8d5f6872f35f3b7de31ee7663a09c1219"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQwMTU1Nw==", "bodyText": "Fixed.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r500401557", "createdAt": "2020-10-06T15:40:26Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV1.java", "diffHunk": "@@ -28,43 +28,45 @@\n import java.time.Instant;\n import java.time.format.DateTimeParseException;\n import java.util.Objects;\n-import java.util.Optional;\n import java.util.stream.Stream;\n import javax.inject.Named;\n+import lombok.AllArgsConstructor;\n import lombok.extern.log4j.Log4j2;\n+import org.apache.commons.lang3.StringUtils;\n \n import com.hedera.mirror.importer.domain.AccountBalance;\n import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.reader.balance.line.AccountBalanceLineParserV1;\n import com.hedera.mirror.importer.util.Utility;\n \n+@AllArgsConstructor\n @Log4j2\n @Named\n-public class BalanceFileReaderImpl implements BalanceFileReader {\n+public class BalanceFileReaderImplV1 implements BalanceFileReader {\n     private static final int MAX_HEADER_ROWS = 10;\n     private static final String TIMESTAMP_HEADER_PREFIX = \"timestamp:\";\n     private static final String COLUMN_HEADER_PREFIX = \"shard\";\n \n-    private final int fileBufferSize;\n-    private final long systemShardNum;\n-    private final AccountBalanceLineParser parser;\n-\n-    public BalanceFileReaderImpl(BalanceParserProperties balanceParserProperties, AccountBalanceLineParser parser) {\n-        this.fileBufferSize = balanceParserProperties.getFileBufferSize();\n-        this.systemShardNum = balanceParserProperties.getMirrorProperties().getShard();\n-        this.parser = parser;\n-    }\n+    private final BalanceParserProperties balanceParserProperties;\n+    private final AccountBalanceLineParserV1 parser;\n \n     @Override\n     public Stream<AccountBalance> read(File file) {\n+        if (file == null) {\n+            throw new InvalidDatasetException(\"Null file provided to balance file reader\");\n+        }\n         try {\n-            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)), fileBufferSize);\n-            final long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    balanceParserProperties.getFileBufferSize());\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n \n             return reader.lines()\n                     .map(line -> {\n                         try {\n-                            return parser.parse(line, consensusTimestamp, systemShardNum);\n-                        } catch(InvalidDatasetException ex) {\n+                            return parser.parse(line, consensusTimestamp, balanceParserProperties.getMirrorProperties()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3MTIwMw=="}, "originalCommit": {"oid": "70bd15d8d5f6872f35f3b7de31ee7663a09c1219"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMzAyNDI0OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNToxMTo1M1rOHdMdgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTo0MDozMFrOHdOFww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3NDkxNA==", "bodyText": "same as above", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r500374914", "createdAt": "2020-10-06T15:11:53Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.apache.commons.lang3.StringUtils;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.reader.balance.line.AccountBalanceLineParserV2;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# TimeStamp:\";\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final BalanceParserProperties balanceParserProperties;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        if (file == null) {\n+            throw new InvalidDatasetException(\"Null file provided to balance file reader\");\n+        }\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    balanceParserProperties.getFileBufferSize());\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, balanceParserProperties.getMirrorProperties()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70bd15d8d5f6872f35f3b7de31ee7663a09c1219"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQwMTYwMw==", "bodyText": "Fixed.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1090#discussion_r500401603", "createdAt": "2020-10-06T15:40:30Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/reader/balance/BalanceFileReaderImplV2.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.hedera.mirror.importer.reader.balance;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.time.Instant;\n+import java.time.format.DateTimeParseException;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import javax.inject.Named;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+import org.apache.commons.lang3.StringUtils;\n+\n+import com.hedera.mirror.importer.domain.AccountBalance;\n+import com.hedera.mirror.importer.exception.InvalidDatasetException;\n+import com.hedera.mirror.importer.parser.balance.BalanceParserProperties;\n+import com.hedera.mirror.importer.reader.balance.line.AccountBalanceLineParserV2;\n+import com.hedera.mirror.importer.util.Utility;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class BalanceFileReaderImplV2 implements BalanceFileReader {\n+    private static final String COLUMN_HEADER_PREFIX = \"shard\";\n+    private static final String TIMESTAMP_HEADER_PREFIX = \"# TimeStamp:\";\n+    private static final String VERSION_2_HEADER_PREFIX = \"# version:2\";\n+\n+    private final BalanceParserProperties balanceParserProperties;\n+    private final AccountBalanceLineParserV2 parser;\n+\n+    @Override\n+    public Stream<AccountBalance> read(File file) {\n+        if (file == null) {\n+            throw new InvalidDatasetException(\"Null file provided to balance file reader\");\n+        }\n+        try {\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file)),\n+                    balanceParserProperties.getFileBufferSize());\n+            long consensusTimestamp = parseHeaderForConsensusTimestamp(reader);\n+\n+            return reader.lines()\n+                    .map(line -> {\n+                        try {\n+                            return parser.parse(line, consensusTimestamp, balanceParserProperties.getMirrorProperties()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3NDkxNA=="}, "originalCommit": {"oid": "70bd15d8d5f6872f35f3b7de31ee7663a09c1219"}, "originalPosition": 67}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1522, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}