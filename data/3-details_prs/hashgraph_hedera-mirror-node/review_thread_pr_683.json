{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyODQ4NjA4", "number": 683, "reviewThreads": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwMDozMzo1MFrODx3wXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxODoyOToyMFrODzAOfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNjIwMzE5OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwMDozMzo1MVrOGFls_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwMDozMzo1MVrOGFls_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxMzc5MQ==", "bodyText": "to-do: Set to \"-7 days\"", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r408513791", "createdAt": "2020-04-15T00:33:51Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,40 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Cleans up old master images\"\n+          command: |\n+            DELETE_BEFORE=$(date --utc -d \"-2 hours\" '+%FT%TZ')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f0b2da8a705c072bdd028018ebb5a376231041a"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNjIwNDA0OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwMDozNDoxNFrOGFlteg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwMDozNDoxNFrOGFlteg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxMzkxNA==", "bodyText": "remove echo of command", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r408513914", "createdAt": "2020-04-15T00:34:14Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,40 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Cleans up old master images\"\n+          command: |\n+            DELETE_BEFORE=$(date --utc -d \"-2 hours\" '+%FT%TZ')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            echo List tags command: gcloud container images list-tags ${IMAGE_PATH} \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f0b2da8a705c072bdd028018ebb5a376231041a"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNjIwNTE0OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwMDozNDo1NlrOGFluIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxODozODozNVrOGGGpKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxNDA4MA==", "bodyText": "remove \"echo Command: \" once filter logic is confirmed to do deletes", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r408514080", "createdAt": "2020-04-15T00:34:56Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,40 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Cleans up old master images\"\n+          command: |\n+            DELETE_BEFORE=$(date --utc -d \"-2 hours\" '+%FT%TZ')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            echo List tags command: gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"'tags:image* AND timestamp.datetime < ${DELETE_BEFORE}'\" \\\n+              --format=\"'get(digest)'\"\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:image* AND timestamp.datetime < ${DELETE_BEFORE}\" \\\n+              --format=\"get(digest)\")\n+            for digest in ${OLD_IMAGES[*]}; do\n+            (\n+              echo Delete image: \"${IMAGE_PATH}@${digest}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f0b2da8a705c072bdd028018ebb5a376231041a"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1MzQ4Mw==", "bodyText": "Leaving for #689 to resolve", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409053483", "createdAt": "2020-04-15T18:38:35Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,40 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Cleans up old master images\"\n+          command: |\n+            DELETE_BEFORE=$(date --utc -d \"-2 hours\" '+%FT%TZ')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            echo List tags command: gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"'tags:image* AND timestamp.datetime < ${DELETE_BEFORE}'\" \\\n+              --format=\"'get(digest)'\"\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:image* AND timestamp.datetime < ${DELETE_BEFORE}\" \\\n+              --format=\"get(digest)\")\n+            for digest in ${OLD_IMAGES[*]}; do\n+            (\n+              echo Delete image: \"${IMAGE_PATH}@${digest}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxNDA4MA=="}, "originalCommit": {"oid": "0f0b2da8a705c072bdd028018ebb5a376231041a"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNjIwNTc0OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwMDozNToxOFrOGFlucw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwMDozNToxOFrOGFlucw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxNDE2Mw==", "bodyText": "remove image-deploy-cleanup and leave only master", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r408514163", "createdAt": "2020-04-15T00:35:18Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -66,7 +98,10 @@ workflows:\n             - build_rest\n           filters:\n             branches:\n-              ignore: /.*/\n+              only:\n+                - master\n+                # image-deploy-cleanup branch present for testing to be removed\n+                - image-deploy-cleanup", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f0b2da8a705c072bdd028018ebb5a376231041a"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNjIwNjU1OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwMDozNTo1MlrOGFlu8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwMDozNTo1MlrOGFlu8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxNDI5MQ==", "bodyText": "set tag filter to be \"master-\" instead of current \"image\"", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r408514291", "createdAt": "2020-04-15T00:35:52Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,40 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Cleans up old master images\"\n+          command: |\n+            DELETE_BEFORE=$(date --utc -d \"-2 hours\" '+%FT%TZ')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            echo List tags command: gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"'tags:image* AND timestamp.datetime < ${DELETE_BEFORE}'\" \\\n+              --format=\"'get(digest)'\"\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:image* AND timestamp.datetime < ${DELETE_BEFORE}\" \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f0b2da8a705c072bdd028018ebb5a376231041a"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzOTgzNDU4OnYy", "diffSide": "RIGHT", "path": "pom.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTo0MjowN1rOGGI2qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMDoyNToyMVrOGGQLkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA4OTcwNw==", "bodyText": "just docker.version.tag and docker.latest.tag since tag's and push are orthogonal concepts. You can have tags without needing to push.\nRemove 'push' from the name.\nLet's rename to docker.tag.version and docker.tag.latest", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409089707", "createdAt": "2020-04-15T19:42:07Z", "author": {"login": "apeksharma"}, "path": "pom.xml", "diffHunk": "@@ -55,6 +55,8 @@\n     <properties>\n         <disruptor.version>3.4.2</disruptor.version> <!-- Used for asynchronous logging -->\n         <docker.push.repository>gcr.io/mirrornode</docker.push.repository>\n+        <docker.push.version.tag>${project.version}</docker.push.version.tag>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIwOTc0NA==", "bodyText": "Sure", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409209744", "createdAt": "2020-04-16T00:25:21Z", "author": {"login": "Nana-EC"}, "path": "pom.xml", "diffHunk": "@@ -55,6 +55,8 @@\n     <properties>\n         <disruptor.version>3.4.2</disruptor.version> <!-- Used for asynchronous logging -->\n         <docker.push.repository>gcr.io/mirrornode</docker.push.repository>\n+        <docker.push.version.tag>${project.version}</docker.push.version.tag>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA4OTcwNw=="}, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzOTg0NjEzOnYy", "diffSide": "RIGHT", "path": "pom.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTo0NTo1M1rOGGI-EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMDoyODozMlrOGGQPEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5MTYwMA==", "bodyText": "no need for profile. Directly override docker.tag.version property from command line.\nhttps://stackoverflow.com/a/13709976/895111", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409091600", "createdAt": "2020-04-15T19:45:53Z", "author": {"login": "apeksharma"}, "path": "pom.xml", "diffHunk": "@@ -84,6 +86,21 @@\n         </dependencies>\n     </dependencyManagement>\n \n+    <profiles>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxMDY0MA==", "bodyText": "I considered this first but went profile way. I can revert to that.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409210640", "createdAt": "2020-04-16T00:28:32Z", "author": {"login": "Nana-EC"}, "path": "pom.xml", "diffHunk": "@@ -84,6 +86,21 @@\n         </dependencies>\n     </dependencyManagement>\n \n+    <profiles>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5MTYwMA=="}, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzOTg3MDM2OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTo1MzozM1rOGGJNcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMDozNDoxNVrOGGQVcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5NTUzNg==", "bodyText": "Am okay with cleanup on every master commit.\nAlternate suggestion would be to cleanup once every 2 week when version is tagged.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409095536", "createdAt": "2020-04-15T19:53:33Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -75,6 +106,15 @@ workflows:\n               only: /.*/\n             tags:\n               only: /.*/\n+      - cleanup_images:\n+          requires:\n+            - publish_images\n+          filters:\n+            branches:\n+              only:\n+                - master", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxMjI3Mg==", "bodyText": "Doing every 2 weeks would mean for those 2 weeks the image counts just going up. Really depends on how many PR's we have going through.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409212272", "createdAt": "2020-04-16T00:34:15Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -75,6 +106,15 @@ workflows:\n               only: /.*/\n             tags:\n               only: /.*/\n+      - cleanup_images:\n+          requires:\n+            - publish_images\n+          filters:\n+            branches:\n+              only:\n+                - master", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5NTUzNg=="}, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzOTg3NTg1OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTo1NTowM1rOGGJQyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMTozMDoyMFrOGGRSiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5NjM5NQ==", "bodyText": "should be 2\nhttps://circleci.com/docs/2.0/configuration-reference/#version-1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409096395", "createdAt": "2020-04-15T19:55:03Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:master-* AND timestamp.datetime < '${DELETE_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,timestamp)\")\n+            echo OLD_IMAGES: ${OLD_IMAGES}\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest timestamp \\<<< ${image}\n+              echo Delete image: \"${IMAGE_PATH}@${digest} created on ${timestamp}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"\n+            )\n+            done\n+\n workflows:\n-  version: 2\n+  version: 2.1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNDE1NA==", "bodyText": "This works as is. Is there a reason to go down? I had wanted to remove this but it wouldn't validate without the version.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409214154", "createdAt": "2020-04-16T00:40:53Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:master-* AND timestamp.datetime < '${DELETE_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,timestamp)\")\n+            echo OLD_IMAGES: ${OLD_IMAGES}\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest timestamp \\<<< ${image}\n+              echo Delete image: \"${IMAGE_PATH}@${digest} created on ${timestamp}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"\n+            )\n+            done\n+\n workflows:\n-  version: 2\n+  version: 2.1", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5NjM5NQ=="}, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNzkxMw==", "bodyText": "Did the revert", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409227913", "createdAt": "2020-04-16T01:30:20Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:master-* AND timestamp.datetime < '${DELETE_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,timestamp)\")\n+            echo OLD_IMAGES: ${OLD_IMAGES}\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest timestamp \\<<< ${image}\n+              echo Delete image: \"${IMAGE_PATH}@${digest} created on ${timestamp}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"\n+            )\n+            done\n+\n workflows:\n-  version: 2\n+  version: 2.1", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5NjM5NQ=="}, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzOTg4Mjc4OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTo1NzowOVrOGGJVLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMDo0MToxOVrOGGQdTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5NzUxNw==", "bodyText": "line not needed.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409097517", "createdAt": "2020-04-15T19:57:09Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -235,5 +275,26 @@ jobs:\n       - *restore_maven_cache\n       - run:\n           name: Running maven deploy\n-          command: ./mvnw ${MAVEN_CLI_OPTS} deploy -DskipTests\n+          command: |\n+            DOCKERPUSHTAG=", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNDI4NQ==", "bodyText": "Removing", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409214285", "createdAt": "2020-04-16T00:41:19Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -235,5 +275,26 @@ jobs:\n       - *restore_maven_cache\n       - run:\n           name: Running maven deploy\n-          command: ./mvnw ${MAVEN_CLI_OPTS} deploy -DskipTests\n+          command: |\n+            DOCKERPUSHTAG=", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5NzUxNw=="}, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzOTg5MzE2OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMDowMDowOFrOGGJbdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMDo0Mjo1MFrOGGQe4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5OTEyNQ==", "bodyText": "After the pom profile is removed, we should override docker.tag.version here only if DOCKERPUSHTAG is set.\nnit: Rename the variable to DOCKER_TAG_VERSION_OVERRIDE", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409099125", "createdAt": "2020-04-15T20:00:08Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -235,5 +275,26 @@ jobs:\n       - *restore_maven_cache\n       - run:\n           name: Running maven deploy\n-          command: ./mvnw ${MAVEN_CLI_OPTS} deploy -DskipTests\n+          command: |\n+            DOCKERPUSHTAG=\n+            if [ \"$CIRCLE_BRANCH\" = \"master\" ]; then\n+                DOCKERPUSHTAG=${CIRCLE_BRANCH}-${CIRCLE_SHA1}\n+            fi\n+            echo DOCKERPUSHTAG: ${DOCKERPUSHTAG}\n+            ./mvnw ${MAVEN_CLI_OPTS} deploy -DskipTests -Dcircle.docker.tag=${DOCKERPUSHTAG}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNDY4OA==", "bodyText": "There's actually 2 items to override here - version and latest. I'll use a single variable to create the extra string for the command, which will only be set in the appropriate case", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409214688", "createdAt": "2020-04-16T00:42:50Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -235,5 +275,26 @@ jobs:\n       - *restore_maven_cache\n       - run:\n           name: Running maven deploy\n-          command: ./mvnw ${MAVEN_CLI_OPTS} deploy -DskipTests\n+          command: |\n+            DOCKERPUSHTAG=\n+            if [ \"$CIRCLE_BRANCH\" = \"master\" ]; then\n+                DOCKERPUSHTAG=${CIRCLE_BRANCH}-${CIRCLE_SHA1}\n+            fi\n+            echo DOCKERPUSHTAG: ${DOCKERPUSHTAG}\n+            ./mvnw ${MAVEN_CLI_OPTS} deploy -DskipTests -Dcircle.docker.tag=${DOCKERPUSHTAG}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5OTEyNQ=="}, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzOTkxOTczOnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMDowODoxMFrOGGJsfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMDo0NDo1NVrOGGQhKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwMzQ4Nw==", "bodyText": "what does this output?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409103487", "createdAt": "2020-04-15T20:08:10Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNTI3Mg==", "bodyText": "Left over troubleshooting. Was checking console bash .\nRemoved", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409215272", "createdAt": "2020-04-16T00:44:55Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwMzQ4Nw=="}, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzOTkyOTcxOnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMDoxMTozNFrOGGJzKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMDo0NjoxM1rOGGQidg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwNTE5NQ==", "bodyText": "you can add set -x at the top, very helpful in debugging. Then no need to echo each variable.\nWe can leave it there, no need to remove before committing since the output will be tiny and useful.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409105195", "createdAt": "2020-04-15T20:11:34Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNTYwNg==", "bodyText": "Good idea", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409215606", "createdAt": "2020-04-16T00:46:13Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwNTE5NQ=="}, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzOTk0MjY4OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMDoxNToxOVrOGGJ7Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMDo0NzowMlrOGGQjbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwNzIzOA==", "bodyText": "there is no need for a limit here in our case, so we should not put one.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409107238", "createdAt": "2020-04-15T20:15:19Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNTg1Mg==", "bodyText": "True, unlikely we'd hit our limit between the time master builds occur. I just like it as good practice on a query.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409215852", "createdAt": "2020-04-16T00:47:02Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwNzIzOA=="}, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzOTk1ODk3OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMDoyMDozOFrOGGKFkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTo1MDowN1rOGGr5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwOTkwNg==", "bodyText": "When we tag a version, it'll create image with same sha, and tag an existing image (pushed as master-<sha>) with vX.Y.Z). Wouldn't --force-delete-tags` remove that image too? We want to keep around images for released versions.\nIrrespective, --force-delete-tags is dangerous in first iteration, let's remove it.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409109906", "createdAt": "2020-04-15T20:20:38Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:master-* AND timestamp.datetime < '${DELETE_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,timestamp)\")\n+            echo OLD_IMAGES: ${OLD_IMAGES}\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest timestamp \\<<< ${image}\n+              echo Delete image: \"${IMAGE_PATH}@${digest} created on ${timestamp}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTExMjk4Mw==", "bodyText": "A better way would be:\n\nuntag all master-<sha> older than 7 days.\nDelete all untagged images", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409112983", "createdAt": "2020-04-15T20:26:30Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:master-* AND timestamp.datetime < '${DELETE_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,timestamp)\")\n+            echo OLD_IMAGES: ${OLD_IMAGES}\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest timestamp \\<<< ${image}\n+              echo Delete image: \"${IMAGE_PATH}@${digest} created on ${timestamp}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwOTkwNg=="}, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNjAyOQ==", "bodyText": "So that actually won't happen. The master tags are only added for the master branch.\nWhen you tag a version it actually doesn't have a circle ci branch, the value is empty.\nSee\nhttps://app.circleci.com/pipelines/github/hashgraph/hedera-mirror-node/1862/workflows/0afb9a24-135c-4646-9db0-5a0510c0e812/jobs/3948\nvs\nhttps://app.circleci.com/pipelines/github/hashgraph/hedera-mirror-node/1863/workflows/d306e28d-4fdb-4c4c-8d2b-59b18856bbd4/jobs/3954\nAlso no release version will have the same sha as master. Release version happen in their own branch with their own changes that won't match a master version\nSo when we tag a release the image tags will be as is x.y.z and latest tags will be added to a new image", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409226029", "createdAt": "2020-04-16T01:23:38Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:master-* AND timestamp.datetime < '${DELETE_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,timestamp)\")\n+            echo OLD_IMAGES: ${OLD_IMAGES}\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest timestamp \\<<< ${image}\n+              echo Delete image: \"${IMAGE_PATH}@${digest} created on ${timestamp}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwOTkwNg=="}, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNjE0OA==", "bodyText": "Reason I don't want to delete untagged images is cause as we speak there's one release image that isn't tagged. Not sure if that was a mistake but it could happen.\nI'd rather intentionally delete tags when they are identifiable as master and release tags won't intersect.\nIt's a fair strategy though so I'll think on it.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409226148", "createdAt": "2020-04-16T01:24:02Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:master-* AND timestamp.datetime < '${DELETE_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,timestamp)\")\n+            echo OLD_IMAGES: ${OLD_IMAGES}\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest timestamp \\<<< ${image}\n+              echo Delete image: \"${IMAGE_PATH}@${digest} created on ${timestamp}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwOTkwNg=="}, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI1MTE1Nw==", "bodyText": "I can't see a reason to keep untagged images in the repo. If an image has a reason to be in that repo, the reason should be its tag, like - master-<sha>, v0.9.0-rc1 or <reason> (for circumstances not discernible).\nIf there is an untagged image, let's delete it/tag it.\nFor the case i mentioned earlier, we tag v0.X.0-rc1 on master commits.\nSo i was wondering if the images pushed when (1) commit was merged into master and (2) on tagging the commit, would be same. I quickly tried testing it by pushing vTest on a commit of this PR's branch, but it resulted in different sha. I was expecting them to be same, but apparently they are not (maybe since at least the git.properties file differ).\nSo i guess it's okay.\nI'd still prefer not doing force deletes, rather untag them and then clear all untagged images. But i leave it to your's and steven's preferences.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409251157", "createdAt": "2020-04-16T02:56:34Z", "author": {"login": "apeksharma"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:master-* AND timestamp.datetime < '${DELETE_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,timestamp)\")\n+            echo OLD_IMAGES: ${OLD_IMAGES}\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest timestamp \\<<< ${image}\n+              echo Delete image: \"${IMAGE_PATH}@${digest} created on ${timestamp}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwOTkwNg=="}, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY2Mzc5Mg==", "bodyText": "Seriously, good point. I thought about it a bit more and revisited the docs and I think this is the cause of the discrepancies I was seeing.\n--force-delete-tags Deletes the image (and tags) from the input IMAGE_NAME:\nhttps://cloud.google.com/sdk/gcloud/reference/beta/container/images/delete\nUntagging old images for future delete might be the better way indeed. Thanks.\nLet me try this out. Next commit will have this change and support to test it out so bare with me", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409663792", "createdAt": "2020-04-16T15:50:07Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:master-* AND timestamp.datetime < '${DELETE_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,timestamp)\")\n+            echo OLD_IMAGES: ${OLD_IMAGES}\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest timestamp \\<<< ${image}\n+              echo Delete image: \"${IMAGE_PATH}@${digest} created on ${timestamp}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwOTkwNg=="}, "originalCommit": {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NDU5MzM0OnYy", "diffSide": "RIGHT", "path": "hedera-mirror-rest/.prettierignore", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMDo1NTowM1rOGG2zJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMDo1NTowM1rOGG2zJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg0MjQ2OA==", "bodyText": "We should add *.yaml as well", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409842468", "createdAt": "2020-04-16T20:55:03Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/.prettierignore", "diffHunk": "@@ -3,4 +3,5 @@ charts/**\n hedera-mirror-importer/**\n hedera-mirror-grpc/**\n hedera-mirror-datagenerator/**\n+*.yml", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0861861389d62064a330e1f8fd1cdf279a81d14b"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NDY2NDc1OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMToxNzoyN1rOGG3fOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMToxNzoyN1rOGG3fOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1Mzc1Mw==", "bodyText": "Should be set -ex to fail fast", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409853753", "createdAt": "2020-04-16T21:17:27Z", "author": {"login": "steven-sheehy"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,6 +35,55 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_untag:\n+    description: \"Untags old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Untags old master images\"\n+          command: |\n+            set -x\n+            UNTAG_BEFORE=$(date -d \"-3 hours\" '+%FT%T')\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:image-* AND timestamp.datetime < '${UNTAG_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,tags,timestamp)\")\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest tag timestamp \\<<< ${image}\n+              gcloud container images untag -q \"${IMAGE_PATH}:${tag}\"\n+            )\n+            done\n+  gcloud_image_delete:\n+    description: \"Deletes old untagged images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Deletes old untagged images\"\n+          command: |\n+            set -x", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5152f1ba7ed6bd718e84f0734ecab59bb76a4b33"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NDY2NTAyOnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMToxNzozMlrOGG3fYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMToxNzozMlrOGG3fYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1Mzc5NA==", "bodyText": "Should be set -ex to fail fast", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409853794", "createdAt": "2020-04-16T21:17:32Z", "author": {"login": "steven-sheehy"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,6 +35,55 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_untag:\n+    description: \"Untags old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Untags old master images\"\n+          command: |\n+            set -x", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5152f1ba7ed6bd718e84f0734ecab59bb76a4b33"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NDcwNTM2OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMTozMDo1NVrOGG34jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNToyMToyNlrOGHSXzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2MDIzOA==", "bodyText": "Technically we can just untag and then directly delete, right? Then we shouldn't really need gcloud_image_delete as all images should be tagged going forward. Would prefer to combine the two functions somehow.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409860238", "createdAt": "2020-04-16T21:30:55Z", "author": {"login": "steven-sheehy"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,6 +35,55 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_untag:\n+    description: \"Untags old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Untags old master images\"\n+          command: |\n+            set -x\n+            UNTAG_BEFORE=$(date -d \"-3 hours\" '+%FT%T')\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:image-* AND timestamp.datetime < '${UNTAG_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,tags,timestamp)\")\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest tag timestamp \\<<< ${image}\n+              gcloud container images untag -q \"${IMAGE_PATH}:${tag}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5152f1ba7ed6bd718e84f0734ecab59bb76a4b33"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg3NzMzNA==", "bodyText": "Can do.\nI had considered that but wanted to leave the opportunity of a few seconds passing by between untag and delete incase gcloud had issues.\nAlso I wanted the delete to be able to capture untagged images that were already untagged prior to this run e.g. say there's a failure to delete on one run but images were untagged. You'd want the next run to not be limited to images that are being untagged in the given run.\nI can make it one function but would recommend still 2 searches i.e 2 image lists", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409877334", "createdAt": "2020-04-16T22:09:06Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,6 +35,55 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_untag:\n+    description: \"Untags old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Untags old master images\"\n+          command: |\n+            set -x\n+            UNTAG_BEFORE=$(date -d \"-3 hours\" '+%FT%T')\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:image-* AND timestamp.datetime < '${UNTAG_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,tags,timestamp)\")\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest tag timestamp \\<<< ${image}\n+              gcloud container images untag -q \"${IMAGE_PATH}:${tag}\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2MDIzOA=="}, "originalCommit": {"oid": "5152f1ba7ed6bd718e84f0734ecab59bb76a4b33"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI5NDIyMQ==", "bodyText": "Thought about it a bit more and chatted offline.\nI think it's valuable to have them separate. If there's ever a case where some tags don't get deleted we'd want the delete step to pick them up on the next round and not be limited to only tags that were just untagged.\nLeaving as is.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r410294221", "createdAt": "2020-04-17T15:21:26Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -35,6 +35,55 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_untag:\n+    description: \"Untags old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Untags old master images\"\n+          command: |\n+            set -x\n+            UNTAG_BEFORE=$(date -d \"-3 hours\" '+%FT%T')\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:image-* AND timestamp.datetime < '${UNTAG_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,tags,timestamp)\")\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest tag timestamp \\<<< ${image}\n+              gcloud container images untag -q \"${IMAGE_PATH}:${tag}\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2MDIzOA=="}, "originalCommit": {"oid": "5152f1ba7ed6bd718e84f0734ecab59bb76a4b33"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODA3Njc2OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxODoyOToyMFrOGHYwNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMToyMDo1MFrOGHddCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM5ODc3NA==", "bodyText": "We probably don't need to cleanup images on tags, just master commits, right?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r410398774", "createdAt": "2020-04-17T18:29:20Z", "author": {"login": "steven-sheehy"}, "path": ".circleci/config.yml", "diffHunk": "@@ -75,6 +125,15 @@ workflows:\n               only: /.*/\n             tags:\n               only: /.*/\n+      - cleanup_images:\n+          requires:\n+            - publish_images\n+          filters:\n+            branches:\n+              only:\n+                - master\n+            tags:\n+              only: /^.*/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc2f662230aae819bc88e7a39fa6b6fb6605427c"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ3NTc4Nw==", "bodyText": "Yeah just master.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r410475787", "createdAt": "2020-04-17T21:20:50Z", "author": {"login": "Nana-EC"}, "path": ".circleci/config.yml", "diffHunk": "@@ -75,6 +125,15 @@ workflows:\n               only: /.*/\n             tags:\n               only: /.*/\n+      - cleanup_images:\n+          requires:\n+            - publish_images\n+          filters:\n+            branches:\n+              only:\n+                - master\n+            tags:\n+              only: /^.*/", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM5ODc3NA=="}, "originalCommit": {"oid": "dc2f662230aae819bc88e7a39fa6b6fb6605427c"}, "originalPosition": 84}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 971, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}