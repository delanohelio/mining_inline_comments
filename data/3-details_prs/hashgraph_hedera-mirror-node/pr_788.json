{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzNDIyMTE2", "number": 788, "title": "Ensure 404 repsonse for unmatched routes", "bodyText": "Detailed description:\nUnmatched route end points were not being handled as 404's\nThis change\n\nAdds a pageNotFound middleware method to the httpErrorHandler\nUpdates the responseHandler to call the next() function when response data is not defined.\nUpdates server.js to use pageNotFound middleware\nAdds 2 integration tests to verify 404's are sent in response cases\n\nWhich issue(s) this PR fixes:\nFixes #751\nSpecial notes for your reviewer:\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-05-26T19:42:52Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/788", "merged": true, "mergeCommit": {"oid": "f78faef2f488bca1c973bbbbe9450f55b45edaaa"}, "closed": true, "closedAt": "2020-05-27T15:34:04Z", "author": {"login": "Nana-EC"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclJuOdgH2gAyNDIzNDIyMTE2OmU2MWI0ZWVkZGYwZTQxZDA4Y2U1NDdlODc5ODkwYjg2ZWZiYzY1YzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcldSwkgFqTQxOTQ4NDA2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e61b4eeddf0e41d08ce547e879890b86efbc65c5", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e61b4eeddf0e41d08ce547e879890b86efbc65c5", "committedDate": "2020-05-26T19:20:55Z", "message": "Ensure 404 repsonse for unmatched routes\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NjY5MTAw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/788#pullrequestreview-418669100", "createdAt": "2020-05-26T20:50:29Z", "commit": {"oid": "e61b4eeddf0e41d08ce547e879890b86efbc65c5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMDo1MDoyOVrOGav15A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMDo1MTowNVrOGav3Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcwMDAwNA==", "bodyText": "Would be preferable to throw NotFoundError here and let it be handled by httpErrorHandler instead of deal with next() and adding new middleware", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/788#discussion_r430700004", "createdAt": "2020-05-26T20:50:29Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/middleware/responseHandler.js", "diffHunk": "@@ -21,11 +21,18 @@\n \n const constants = require('../constants.js');\n \n-// response middleware that pull response data passed through request and sets in json response\n+// response middleware that pulls response data passed through request and sets in json response\n // next param is required to ensure express maps to this middleware and can also be used to pass onto future middleware\n-const responseHandler = (req, res, next) => {\n-  // set response json\n-  res.json(res.locals[constants.responseDataLabel]);\n+const responseHandler = async (req, res, next) => {\n+  const responseData = res.locals[constants.responseDataLabel];\n+  if (responseData === undefined) {\n+    // unmatched route will have no response data", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e61b4eeddf0e41d08ce547e879890b86efbc65c5"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcwMDMyNg==", "bodyText": "handleError should be async, right?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/788#discussion_r430700326", "createdAt": "2020-05-26T20:51:05Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/middleware/httpErrorHandler.js", "diffHunk": "@@ -62,6 +62,14 @@ const handleError = (err, req, res, next) => {\n       logger.trace(`Unhandled error encountered: ${err.message}`);\n       res.status(httpStatusCodes.INTERNAL_ERROR).json(errorMessageFormat(httpErrorMessages.INTERNAL_ERROR));\n   }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e61b4eeddf0e41d08ce547e879890b86efbc65c5"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef8a7f6aa1a877fa5e413eaf9fe7e766c143423e", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ef8a7f6aa1a877fa5e413eaf9fe7e766c143423e", "committedDate": "2020-05-26T21:15:02Z", "message": " Throw notfound in responsehandler\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4Njg2MzIz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/788#pullrequestreview-418686323", "createdAt": "2020-05-26T21:18:04Z", "commit": {"oid": "ef8a7f6aa1a877fa5e413eaf9fe7e766c143423e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMToxODowNFrOGawqGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMToxODowNFrOGawqGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcxMzM2OA==", "bodyText": "Can be removed as this is no longer exported/existing", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/788#discussion_r430713368", "createdAt": "2020-05-26T21:18:04Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/server.js", "diffHunk": "@@ -33,7 +33,7 @@ const transactions = require('./transactions.js');\n const balances = require('./balances.js');\n const accounts = require('./accounts.js');\n const topicmessage = require('./topicmessage.js');\n-const {handleError} = require('./middleware/httpErrorHandler');\n+const {handleError, pageNotFound} = require('./middleware/httpErrorHandler');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef8a7f6aa1a877fa5e413eaf9fe7e766c143423e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4Njg2OTY2", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/788#pullrequestreview-418686966", "createdAt": "2020-05-26T21:19:14Z", "commit": {"oid": "ef8a7f6aa1a877fa5e413eaf9fe7e766c143423e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMToxOToxNFrOGawsAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMToxOToxNFrOGawsAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcxMzg1OQ==", "bodyText": "Log not necessary, error handler already logs URL and error message at error level", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/788#discussion_r430713859", "createdAt": "2020-05-26T21:19:14Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/middleware/responseHandler.js", "diffHunk": "@@ -20,12 +20,20 @@\n 'use strict';\n \n const constants = require('../constants.js');\n+const {NotFoundError} = require('../errors/notFoundError');\n \n-// response middleware that pull response data passed through request and sets in json response\n+// response middleware that pulls response data passed through request and sets in json response\n // next param is required to ensure express maps to this middleware and can also be used to pass onto future middleware\n-const responseHandler = (req, res, next) => {\n-  // set response json\n-  res.json(res.locals[constants.responseDataLabel]);\n+const responseHandler = async (req, res, next) => {\n+  const responseData = res.locals[constants.responseDataLabel];\n+  if (responseData === undefined) {\n+    // unmatched route will have no response data, pass NotFoundError to next middleware\n+    logger.debug(`Unsupported API endpoint: ${req.originalUrl}`);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef8a7f6aa1a877fa5e413eaf9fe7e766c143423e"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4Njg3MTQ5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/788#pullrequestreview-418687149", "createdAt": "2020-05-26T21:19:32Z", "commit": {"oid": "ef8a7f6aa1a877fa5e413eaf9fe7e766c143423e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMToxOTozMlrOGawslQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMToxOTozMlrOGawslQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcxNDAwNQ==", "bodyText": "Do we still need this?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/788#discussion_r430714005", "createdAt": "2020-05-26T21:19:32Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/middleware/httpErrorHandler.js", "diffHunk": "@@ -62,6 +62,8 @@ const handleError = (err, req, res, next) => {\n       logger.trace(`Unhandled error encountered: ${err.message}`);\n       res.status(httpStatusCodes.INTERNAL_ERROR).json(errorMessageFormat(httpErrorMessages.INTERNAL_ERROR));\n   }\n+\n+  next();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef8a7f6aa1a877fa5e413eaf9fe7e766c143423e"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4Njg3NDY5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/788#pullrequestreview-418687469", "createdAt": "2020-05-26T21:20:07Z", "commit": {"oid": "ef8a7f6aa1a877fa5e413eaf9fe7e766c143423e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMToyMDowOFrOGawttQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMToyMDowOFrOGawttQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcxNDI5Mw==", "bodyText": "Not needed", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/788#discussion_r430714293", "createdAt": "2020-05-26T21:20:08Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/middleware/httpErrorHandler.js", "diffHunk": "@@ -21,7 +21,7 @@\n \n const {DbError} = require('../errors/dbError');\n const {InvalidArgumentError} = require('../errors/invalidArgumentError');\n-const {NotFoundError} = require('../errors/notFoundError');\n+const {NotFoundError, NotFoundErrorMessage} = require('../errors/notFoundError');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef8a7f6aa1a877fa5e413eaf9fe7e766c143423e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d21d519bebb59eba6a41cd347ba164afd627c69f", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d21d519bebb59eba6a41cd347ba164afd627c69f", "committedDate": "2020-05-26T21:51:35Z", "message": "Clean up\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NzA1ODIy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/788#pullrequestreview-418705822", "createdAt": "2020-05-26T21:53:18Z", "commit": {"oid": "d21d519bebb59eba6a41cd347ba164afd627c69f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NDg0MDY4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/788#pullrequestreview-419484068", "createdAt": "2020-05-27T18:07:47Z", "commit": {"oid": "d21d519bebb59eba6a41cd347ba164afd627c69f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxODowNzo0N1rOGbXIhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxODowNzo0N1rOGbXIhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM0Mzc1MA==", "bodyText": "just a fyi for future: https://stackoverflow.com/questions/16810449/when-to-use-next-and-return-next-in-node-js", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/788#discussion_r431343750", "createdAt": "2020-05-27T18:07:47Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/middleware/httpErrorHandler.js", "diffHunk": "@@ -62,6 +62,8 @@ const handleError = (err, req, res, next) => {\n       logger.trace(`Unhandled error encountered: ${err.message}`);\n       res.status(httpStatusCodes.INTERNAL_ERROR).json(errorMessageFormat(httpErrorMessages.INTERNAL_ERROR));\n   }\n+\n+  next();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcxNDAwNQ=="}, "originalCommit": {"oid": "ef8a7f6aa1a877fa5e413eaf9fe7e766c143423e"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3164, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}