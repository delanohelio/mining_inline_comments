{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxNDQ2NDcx", "number": 772, "title": "Add option to archive verified signature files", "bodyText": "Detailed description:\n\nAdd property hedera.mirror.importer.downloader.balance.keepSignatures=false\nAdd property hedera.mirror.importer.downloader.record.keepSignatures=false\nDownload signatures to tmp/0.0.X\nMove verified signatures to signatures/0.0.X/YYYY/MM/DD if keepSignatures is true\nDelete verified signatures if keepSignatures is false\n\nWhich issue(s) this PR fixes:\nFixes #510\nSpecial notes for your reviewer:\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-05-21T16:16:30Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/772", "merged": true, "mergeCommit": {"oid": "0bc1f23d6d75e0d9667a515f28f3d37319f89b5d"}, "closed": true, "closedAt": "2020-05-21T21:59:30Z", "author": {"login": "steven-sheehy"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjf1VwgH2gAyNDIxNDQ2NDcxOjI2OTJmZmRjMmU2ZWU3OGI3MmZiZTI5YjFiYzkwZThhNTViMDU1NTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjk_CWAFqTQxNjUyMjQyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2692ffdc2e6ee78b72fbe29b1bc90e8a55b05555", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2692ffdc2e6ee78b72fbe29b1bc90e8a55b05555", "committedDate": "2020-05-21T15:58:45Z", "message": "Add option to keep signatures\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2Mjk2Nzgw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/772#pullrequestreview-416296780", "createdAt": "2020-05-21T16:21:09Z", "commit": {"oid": "2692ffdc2e6ee78b72fbe29b1bc90e8a55b05555"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNjoyMToxMFrOGY5oTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNjoyMToxMFrOGY5oTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc2MzIxNQ==", "bodyText": "Using parser specific properties in a generic utility class is a code smell. It also didn't allow for code reuse with the new downloader properties. Instead move this back to layer where it belongs even if it duplicates 4 lines of code. This duplication will be gone anyway once we integrate balance parsing into the new framework (#573).", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/772#discussion_r428763215", "createdAt": "2020-05-21T16:21:10Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/util/Utility.java", "diffHunk": "@@ -311,38 +310,21 @@ public static boolean hashIsEmpty(String hash) {\n         return StringUtils.isBlank(hash) || hash.equals(EMPTY_HASH);\n     }\n \n-    public static void moveFileToParsedDir(String filePath, ParserProperties parserProperties) {\n-        Path source = Path.of(filePath);\n-        String fileName = source.getFileName().toString();\n-        String dateSubDir = fileName.substring(0, 10).replace(\"-\", File.separator);\n-        Path destination = parserProperties.getParsedPath().resolve(dateSubDir).resolve(fileName);\n-        destination.getParent().toFile().mkdirs();\n+    // Moves a file in the form 2019-08-30T18_10_00.419072Z.rcd to destinationRoot/2019/08/30\n+    public static void archiveFile(File source, Path destinationRoot) {\n+        String filename = source.getName();\n+        String date = filename.substring(0, 10).replace(\"-\", File.separator);\n+        Path destination = destinationRoot.resolve(date);\n \n         try {\n-            Files.move(source, destination, StandardCopyOption.REPLACE_EXISTING);\n+            destination.toFile().mkdirs();\n+            Files.move(source.toPath(), destination.resolve(filename), StandardCopyOption.REPLACE_EXISTING);\n             log.trace(\"Moved {} to {}\", source, destination);\n         } catch (Exception e) {\n             log.error(\"Error moving file {} to {}\", source, destination, e);\n         }\n     }\n \n-    public static void deleteFile(String fileName) {\n-        try {\n-            Files.delete(new File(fileName).toPath());\n-            log.trace(\"Deleted file {}\", fileName);\n-        } catch (Exception e) {\n-            log.error(\"Error deleting file {}\", fileName);\n-        }\n-    }\n-\n-    public static void moveOrDeleteParsedFile(String fileName, ParserProperties parserProperties) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2692ffdc2e6ee78b72fbe29b1bc90e8a55b05555"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NDA4ODcw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/772#pullrequestreview-416408870", "createdAt": "2020-05-21T18:58:01Z", "commit": {"oid": "2692ffdc2e6ee78b72fbe29b1bc90e8a55b05555"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxODo1ODowMVrOGY-8tQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxOTowMjoyMlrOGY_FpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1MDM1Nw==", "bodyText": "nit: you can be specific here and say 'balance signature files' since you are describing hedera.mirror.importer.downloader.balance.keepSignatures.\nIt's a given by the property name but the description out of context could be misunderstood for all signature files", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/772#discussion_r428850357", "createdAt": "2020-05-21T18:58:01Z", "author": {"login": "Nana-EC"}, "path": "docs/configuration.md", "diffHunk": "@@ -34,6 +34,7 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.importer.downloader.balance.batchSize`                | 15                      | The number of signature files to download per node before downloading the signed files         |\n | `hedera.mirror.importer.downloader.balance.enabled`                  | true                    | Whether to enable balance file downloads                                                       |\n | `hedera.mirror.importer.downloader.balance.frequency`                | 30s                     | The fixed period between invocations. Can accept duration units like `10s`, `2m` etc.          |\n+| `hedera.mirror.importer.downloader.balance.keepSignatures`           | false                   | Whether to keep signature files after successful verification. If false, files are deleted.    |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2692ffdc2e6ee78b72fbe29b1bc90e8a55b05555"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1MjY0NA==", "bodyText": "nit: same nit above but for record", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/772#discussion_r428852644", "createdAt": "2020-05-21T19:02:22Z", "author": {"login": "Nana-EC"}, "path": "docs/configuration.md", "diffHunk": "@@ -42,6 +43,7 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.importer.downloader.record.batchSize`                 | 40                      | The number of signature files to download per node before downloading the signed files         |\n | `hedera.mirror.importer.downloader.record.enabled`                   | true                    | Whether to enable record file downloads                                                        |\n | `hedera.mirror.importer.downloader.record.frequency`                 | 500ms                   | The fixed period between invocations. Can accept duration units like `10s`, `2m` etc.          |\n+| `hedera.mirror.importer.downloader.record.keepSignatures`            | false                   | Whether to keep signature files after successful verification. If false, files are deleted.    |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2692ffdc2e6ee78b72fbe29b1bc90e8a55b05555"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcfbdf73da0b3afa49eadb4cd8d1638884df39d3", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/fcfbdf73da0b3afa49eadb4cd8d1638884df39d3", "committedDate": "2020-05-21T21:49:13Z", "message": "Address review\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NTIyNDI4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/772#pullrequestreview-416522428", "createdAt": "2020-05-21T21:58:52Z", "commit": {"oid": "fcfbdf73da0b3afa49eadb4cd8d1638884df39d3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3156, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}