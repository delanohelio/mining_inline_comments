{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2MzE5MTY5", "number": 698, "title": "Fix topic messages REST route", "bodyText": "Detailed description:\nIn v0.9 we released the /topics/:id endpoint which returned a collection of topic messages under a topic.\nThis route was incorrect and should have been /topics/:id/messages as it refers to the messages entity and not the topic entity.\nThis changes\n\nUpdates server.js with the correct api path\nRe organizes server.js to make it easier to follow\nUpdates spec topic messages tests\nEncapsulates some regex logic into methods.\nMoves some text to the constants.js file\nEnsure a standard message is shown for unhandled messages and internal code is not exposed in error message\n\nWhich issue(s) this PR fixes:\nFixes #699\nSpecial notes for your reviewer:\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-04-20T21:45:06Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698", "merged": true, "mergeCommit": {"oid": "85a94f1ba836ae7df3e81079cda5eb9c954b5e98"}, "closed": true, "closedAt": "2020-04-21T20:20:56Z", "author": {"login": "Nana-EC"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZmIp1AH2gAyNDA2MzE5MTY5OjZkMzQxZGE3NzYzMjkzZDllMjg3YWE1NWRiODg1NDRmODYxNTc4MmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZ5Qn0AFqTM5NzYyOTA4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6d341da7763293d9e287aa55db88544f8615782c", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6d341da7763293d9e287aa55db88544f8615782c", "committedDate": "2020-04-20T21:40:02Z", "message": "Fix topic messages REST route\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2OTA0MjE4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#pullrequestreview-396904218", "createdAt": "2020-04-21T00:14:49Z", "commit": {"oid": "6d341da7763293d9e287aa55db88544f8615782c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwMDoxNDo1MFrOGIs6zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwMDoyNToyNFrOGItIFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc3Nzc0Mw==", "bodyText": "nits: no need of 's' in middle words (messages, transactions).\norderFilterValues \u2192 'orderBy' (order is not filter)\ntopicMessagesFormatFilterValues \u2192 topicMessageFormat (response format is not a filter)\ntransactionResultFilterValues \u2192 transactionResultFilter\ntransactionsTypeFilterValues \u2192 cryptoTransferType (transactionType has different connotation in rest of our stack)", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#discussion_r411777743", "createdAt": "2020-04-21T00:14:50Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/constants.js", "diffHunk": "@@ -40,8 +40,32 @@ const entityColumns = {\n \n const responseDataLabel = 'mirrorRestData';\n \n+const orderFilterValues = {\n+  ASC: 'asc',\n+  DESC: 'desc',\n+};\n+\n+// topic messages filter options\n+const topicMessagesFormatFilterValues = {\n+  BINARY: 'binary',\n+  TEXT: 'text',\n+};\n+\n+const transactionsResultFilterValues = {\n+  SUCCESS: 'success',\n+  FAIL: 'fail',\n+};\n+\n+const transactionsTypeFilterValues = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d341da7763293d9e287aa55db88544f8615782c"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc4MDUxMQ==", "bodyText": "function is not being used anywhere.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#discussion_r411780511", "createdAt": "2020-04-21T00:23:22Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -75,6 +64,22 @@ const isValidNum = (num) => {\n   return /^\\d{1,16}$/.test(num) && num > 0 && num <= Number.MAX_SAFE_INTEGER;\n };\n \n+const isValidMessageQuery = (query) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d341da7763293d9e287aa55db88544f8615782c"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc4MTE0Mw==", "bodyText": "Please also change other 'asc'/'desc' strings in this file to use constants.orderFilterValues too.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#discussion_r411781143", "createdAt": "2020-04-21T00:25:24Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -113,44 +118,44 @@ const filterValidityChecks = function (param, op, val) {\n   }\n \n   // Validate operator\n-  if (!/^(gte?|lte?|eq|ne)$/.test(op)) {\n+  if (!isValidOperatorQuery(op)) {\n     return ret;\n   }\n \n   // Validate the value\n   switch (param) {\n-    case filterKeys.ACCOUNT_ID:\n+    case constants.filterKeys.ACCOUNT_ID:\n       // Accepted forms: shard.realm.num or num\n       ret = isValidEntityNum(val);\n       break;\n-    case filterKeys.TIMESTAMP:\n+    case constants.filterKeys.TIMESTAMP:\n       ret = isValidTimestampParam(val);\n       break;\n-    case filterKeys.ACCOUNT_BALANCE:\n+    case constants.filterKeys.ACCOUNT_BALANCE:\n       // Accepted forms: Upto 50 billion\n-      ret = /^\\d{1,19}$/.test(val);\n+      ret = isValidAccountBalanceQuery(val);\n       break;\n-    case filterKeys.ACCOUNT_PUBLICKEY:\n+    case constants.filterKeys.ACCOUNT_PUBLICKEY:\n       // Acceptable forms: exactly 64 characters or +12 bytes (DER encoded)\n-      ret = /^[0-9a-fA-F]{64}$/.test(val) || /^[0-9a-fA-F]{88}$/.test(val);\n+      ret = isValidPublicKeyQuery(val);\n       break;\n-    case filterKeys.LIMIT:\n+    case constants.filterKeys.LIMIT:\n       // Acceptable forms: upto 4 digits\n       ret = isValidLimitNum(val);\n       break;\n-    case filterKeys.ORDER:\n+    case constants.filterKeys.ORDER:\n       // Acceptable words: asc or desc\n-      ret = ['asc', 'desc'].includes(val);\n+      ret = Object.values(constants.orderFilterValues).includes(val);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d341da7763293d9e287aa55db88544f8615782c"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfcfea8b828d0439b5ac652ea39157094e3972ad", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bfcfea8b828d0439b5ac652ea39157094e3972ad", "committedDate": "2020-04-21T05:48:34Z", "message": "Addressed feedback on namings\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDU3NDQ1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#pullrequestreview-397457445", "createdAt": "2020-04-21T15:55:44Z", "commit": {"oid": "bfcfea8b828d0439b5ac652ea39157094e3972ad"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNTo1NTo0NVrOGJMiCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNjozMDo0NVrOGJNRvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5NTY5MQ==", "bodyText": "nit: const", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#discussion_r412295691", "createdAt": "2020-04-21T15:55:45Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/server.js", "diffHunk": "@@ -19,20 +19,15 @@\n  */\n 'uses strict';\n \n+// external libraries\n const express = require('express');\n const {addAsync} = require('@awaitjs/express');\n const bodyParser = require('body-parser');\n-let Pool;\n-if (process.env.NODE_ENV !== 'test') {\n-  Pool = require('pg').Pool;\n-} else {\n-  Pool = require('./__tests__/mockpool.js'); // Use a mocked up DB for jest unit tests\n-}\n-const app = addAsync(express());\n const cors = require('cors');\n const log4js = require('log4js');\n-const logger = log4js.getLogger();\n+var compression = require('compression');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfcfea8b828d0439b5ac652ea39157094e3972ad"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMwNzkwMA==", "bodyText": "/topic/:id/message. Also update tests with the same.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#discussion_r412307900", "createdAt": "2020-04-21T16:30:45Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-rest/server.js", "diffHunk": "@@ -110,8 +113,8 @@ app.getAsync(apiPrefix + '/topic/message/:consensusTimestamp', topicmessage.getM\n app.getAsync(apiPrefix + '/topic/:id/message/:sequencenumber', topicmessage.getMessageByTopicAndSequenceRequest);\n app.getAsync(apiPrefix + '/topics/:id/messages/:sequencenumber', topicmessage.getMessageByTopicAndSequenceRequest);\n \n-app.getAsync(apiPrefix + '/topics/:id', topicmessage.getTopicMessages);\n-app.getAsync(apiPrefix + '/topic/:id', topicmessage.getTopicMessages);\n+app.getAsync(apiPrefix + '/topics/:id/messages', topicmessage.getTopicMessages);\n+app.getAsync(apiPrefix + '/topic/:id/messages', topicmessage.getTopicMessages);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfcfea8b828d0439b5ac652ea39157094e3972ad"}, "originalPosition": 86}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a370dc60f1fc3899c01e040a5b5ca13fd232d4f5", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a370dc60f1fc3899c01e040a5b5ca13fd232d4f5", "committedDate": "2020-04-21T17:43:13Z", "message": "Addressed nit on var\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NTczNDQw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#pullrequestreview-397573440", "createdAt": "2020-04-21T18:37:24Z", "commit": {"oid": "a370dc60f1fc3899c01e040a5b5ca13fd232d4f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NjI5MDgw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#pullrequestreview-397629080", "createdAt": "2020-04-21T19:56:56Z", "commit": {"oid": "a370dc60f1fc3899c01e040a5b5ca13fd232d4f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3084, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}