{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NTA1MTIz", "number": 552, "title": "Specify Bounded Executor for NettyServerBuilder", "bodyText": "Detailed description:\nWe recently experienced undesirable effects of traffic in testnet which prompted us to revisit our gRPC service configurations around security and performance.\nThis change sets further Netty properties to aid security and performance.\n\nSets custom executor to bound thread pool used for application logic\n\nWhich issue(s) this PR fixes:\nFixes #536\nSpecial notes for your reviewer:\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-02-21T22:49:38Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552", "merged": true, "mergeCommit": {"oid": "90ab551273d3f8fa14e2e3fa475a22d2c44c8cc7"}, "closed": true, "closedAt": "2020-02-24T16:47:05Z", "author": {"login": "Nana-EC"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGnuOegH2gAyMzc4NTA1MTIzOmJkMzA5ZmU2YTAwMTExNTcxZDQxNDgxZjY0MjlkYWY2OTU0MzRiZmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHfscMgFqTM2MzUwMDAxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bd309fe6a00111571d41481f6429daf695434bff", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bd309fe6a00111571d41481f6429daf695434bff", "committedDate": "2020-02-21T22:46:25Z", "message": "Specify Bounded Executor for NettyServerBuilder\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTcxNTY3", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#pullrequestreview-362971567", "createdAt": "2020-02-21T23:15:06Z", "commit": {"oid": "bd309fe6a00111571d41481f6429daf695434bff"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMzoxNTowNlrOFtHSEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMzo1ODo1M1rOFtH39g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0OTU1Mw==", "bodyText": "Min should be 1.\n1k seems fine. Since every thread will\n\ndo 200-page-size query every 2 second in historical mode\nno db query in listening mode\nGiven we can have up to 100 connections to the db, we are good as long as those 200-page-size queries take <200ms (=2sec/(1000/100)) which seems reasonable. And not that all of them will be doing historical queries.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382849553", "createdAt": "2020-02-21T23:15:06Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/NettyProperties.java", "diffHunk": "@@ -38,4 +38,7 @@\n \n     @Min(8) // 1 kb\n     private int maxMetadataSize = 1024;\n+\n+    @Min(8)\n+    private int threadPoolThreadCount = 1000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd309fe6a00111571d41481f6429daf695434bff"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1ODA3MQ==", "bodyText": "since the executor is agnostic to application logic, naming it based on application would be confusing when reading logs.  would suggest name like 'grpc-executor-%d'", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382858071", "createdAt": "2020-02-21T23:53:02Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/GrpcConfiguration.java", "diffHunk": "@@ -54,7 +57,15 @@ CompositeHealthContributor grpcServices(GrpcServiceDiscoverer grpcServiceDiscove\n     @Bean\n     public GrpcServerConfigurer grpcServerConfigurer(GrpcProperties grpcProperties) {\n         NettyProperties nettyProperties = grpcProperties.getNetty();\n+        Executor executor = Executors.newFixedThreadPool(\n+                nettyProperties.getThreadPoolThreadCount(),\n+                new ThreadFactoryBuilder()\n+                        .setDaemon(true)\n+                        .setNameFormat(\"hcs-executor-%d\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd309fe6a00111571d41481f6429daf695434bff"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1OTI1NA==", "bodyText": "We should move this to grpc properties since it's used by grpc (ServerImpl class). It's not used by netty library. Sorry that it's confusing since we set it via NettyServerBuilder. :)\nAlso, specifying in name what the thread pool is about would be useful - grpcExecutorThread....", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382859254", "createdAt": "2020-02-21T23:58:53Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/NettyProperties.java", "diffHunk": "@@ -38,4 +38,7 @@\n \n     @Min(8) // 1 kb\n     private int maxMetadataSize = 1024;\n+\n+    @Min(8)\n+    private int threadPoolThreadCount = 1000;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0OTU1Mw=="}, "originalCommit": {"oid": "bd309fe6a00111571d41481f6429daf695434bff"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fde50fb6b87fabdb6eb93de7a55fbf7abffe6d0a", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/fde50fb6b87fabdb6eb93de7a55fbf7abffe6d0a", "committedDate": "2020-02-22T00:10:53Z", "message": "Utilize SynchronousQueue to reuse threads and kill after keep alive time. Added min and max thread count aswell\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4d89a454fef3f6e63f6bf918e5439296f5fa347", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c4d89a454fef3f6e63f6bf918e5439296f5fa347", "committedDate": "2020-02-22T00:16:51Z", "message": "Set executorThreadMinCount to 1 and deafult to 10\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f0855e38f5394e17ce85ef452accc5b1ab8ced4", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2f0855e38f5394e17ce85ef452accc5b1ab8ced4", "committedDate": "2020-02-22T00:28:01Z", "message": "Updating netty prop names to match properties in server builder\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8a0b6bf522fb81bae7788ba4554cb9b607b528f", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d8a0b6bf522fb81bae7788ba4554cb9b607b528f", "committedDate": "2020-02-22T00:40:49Z", "message": "Updated configuration docs and props names as a result\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTk0NzE3", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#pullrequestreview-362994717", "createdAt": "2020-02-22T01:02:25Z", "commit": {"oid": "d8a0b6bf522fb81bae7788ba4554cb9b607b528f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTk3ODIz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#pullrequestreview-362997823", "createdAt": "2020-02-22T01:26:00Z", "commit": {"oid": "d8a0b6bf522fb81bae7788ba4554cb9b607b528f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwMToyNjowMFrOFtIrmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwMToyNjowMFrOFtIrmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MjQ3Mw==", "bodyText": "default grpc executor uses daemon threads. Without specifying a thread pool factory, the defaultThreadFactory will use non-daemon threads. Just want to confirm that's what we want?\nWith default thread factory, thread names would  be \"pool-X-thread-Y\" (where X may change if process restarts)\nWhen you posted this stack trace (https://app.zenhub.com/workspaces/hedera-mirror-node-5d6fc4fca9be420001e7d223/issues/hashgraph/hedera-mirror-node/486#issuecomment-581468326), the line was useful since it gave good context of the thread reporting the leak (grpc-default-executor-916).\nIn general too, thread names are indispensable when debugging some of the gnarly bugs. I'd like to request again to give it a name like 'grpc-executor-', please.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382872473", "createdAt": "2020-02-22T01:26:00Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/GrpcConfiguration.java", "diffHunk": "@@ -54,10 +58,18 @@ CompositeHealthContributor grpcServices(GrpcServiceDiscoverer grpcServiceDiscove\n     @Bean\n     public GrpcServerConfigurer grpcServerConfigurer(GrpcProperties grpcProperties) {\n         NettyProperties nettyProperties = grpcProperties.getNetty();\n+        Executor executor = new ThreadPoolExecutor(\n+                nettyProperties.getExecutorCoreThreadCount(),\n+                nettyProperties.getExecutorMaxThreadCount(),\n+                nettyProperties.getThreadKeepAliveTime(),\n+                TimeUnit.SECONDS,\n+                new SynchronousQueue<>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8a0b6bf522fb81bae7788ba4554cb9b607b528f"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f8ea58ef85b0f161eef84e3b543fbc5a7c03bb9", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3f8ea58ef85b0f161eef84e3b543fbc5a7c03bb9", "committedDate": "2020-02-24T00:03:13Z", "message": "Use daemon threads for executor and provide custom name for easier debugging\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNTAwMDEy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#pullrequestreview-363500012", "createdAt": "2020-02-24T15:59:09Z", "commit": {"oid": "3f8ea58ef85b0f161eef84e3b543fbc5a7c03bb9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3271, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}