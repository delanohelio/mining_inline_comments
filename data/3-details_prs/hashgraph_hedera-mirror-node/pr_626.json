{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzODc1ODc2", "number": 626, "title": "Updated HCS Acceptance tests for easy running by devops", "bodyText": "Detailed description:\nDevOps is looking to automate usage of our acceptance tests.\nTo assist this the PR includes changes to make the tests more configurable but also more conservative on assessments.\n\nAdded retry logic using spring-retry annotations on multiple service calls to recover from situations where the transaction for topic creation or message publishing may not have hit the db yet.\nAdded background message publishing to encourage service file closing and reducing wait time on message in environments with low tps\nUpdated Readme file\nUpdated properties config with new emitBackgroundMessages, existingTopicNum. Changed timeout to duration\nImproved some of the logging.\n\nSpecial notes for your reviewer:\nTests can be configured to be more aggressive in regards to latency. Defaults just reduce necessary configuration but still ensure some good traffic to nodes.\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-03-25T23:21:16Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626", "merged": true, "mergeCommit": {"oid": "3faf97cc157ff41e64ab894b15f56132a15bfae4"}, "closed": true, "closedAt": "2020-04-03T20:53:56Z", "author": {"login": "Nana-EC"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRPuG8AH2gAyMzkzODc1ODc2OjEyZTc4NTkxNmYzZjc2NTdkODA1M2E4NWI4YWI2NTYyYzM5ZWQ0NDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcUHNsyAFqTM4NzU3MTAzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "12e785916f3f7657d8053a85b8ab6562c39ed448", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/12e785916f3f7657d8053a85b8ab6562c39ed448", "committedDate": "2020-03-25T23:01:44Z", "message": "Updated HCS Acceptance tests for easy running by devops\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "079950a30d47cb2578c480d14547958cd0f20e02", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/079950a30d47cb2578c480d14547958cd0f20e02", "committedDate": "2020-03-25T23:06:26Z", "message": "Set subscribeonly topic id to empty to force manual setting\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2770e3b4dd8fab74a6f790c19f49f8be597ef629", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2770e3b4dd8fab74a6f790c19f49f8be597ef629", "committedDate": "2020-03-25T23:17:49Z", "message": "Updated readme file\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d449344ebd6a4c843e09882e0fc46231a87f157", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8d449344ebd6a4c843e09882e0fc46231a87f157", "committedDate": "2020-03-25T23:20:19Z", "message": "Added note about Java sdk usage\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14d7833e168fd41f394ac734a76bc9861cea643a", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/14d7833e168fd41f394ac734a76bc9861cea643a", "committedDate": "2020-03-26T19:55:32Z", "message": "Added existingTopicNum param. Moves config from code to application.yml file\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMzcwOTU1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#pullrequestreview-382370955", "createdAt": "2020-03-26T20:01:26Z", "commit": {"oid": "14d7833e168fd41f394ac734a76bc9861cea643a"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f13e87798f23f98c08d0404e9e11548c86d2ee0", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2f13e87798f23f98c08d0404e9e11548c86d2ee0", "committedDate": "2020-03-26T20:55:17Z", "message": "Updated topicmessages tests to use shard value from config\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNDIwNjQx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#pullrequestreview-382420641", "createdAt": "2020-03-26T21:06:39Z", "commit": {"oid": "2f13e87798f23f98c08d0404e9e11548c86d2ee0"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "206bfbbed00b96829d56d540b2b1104af4181f2c", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/206bfbbed00b96829d56d540b2b1104af4181f2c", "committedDate": "2020-03-26T22:48:52Z", "message": "Added existingTopicNum place holder to application-default\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNTgyMDY4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#pullrequestreview-382582068", "createdAt": "2020-03-27T05:03:37Z", "commit": {"oid": "206bfbbed00b96829d56d540b2b1104af4181f2c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwNTowMzozN1rOF8jTUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwNToxOToyMVrOF8jhOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAzNzI2NQ==", "bodyText": "I think instead of a subscribe delay this should be a subscribe timeout. Subscribe delay is a slow and brittle approach that always waits that amount of time before subscribing. Brittle because if it's not an appropriate value for that environment it will fail.\nA subscribe timeout is a smarter approach that would retry subscribe every 1s up to the timeout when a topic not found is returned, potentially returning quicker than the delay. This may have been what Appy was getting at.\nI understand you have message timeout, but that should probably be adjusted to start after subscription is successful.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#discussion_r399037265", "createdAt": "2020-03-27T05:03:37Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-test/src/test/java/com/hedera/mirror/test/e2e/acceptance/client/MirrorNodeClient.java", "diffHunk": "@@ -38,16 +38,19 @@\n public class MirrorNodeClient {\n     private final MirrorClient mirrorClient;\n     private final int messageTimeout;\n+    private final int subscribeDelay;\n \n     public MirrorNodeClient(AcceptanceTestProperties acceptanceTestProperties) {\n         String mirrorNodeAddress = acceptanceTestProperties.getMirrorNodeAddress();\n         log.debug(\"Creating Mirror Node client for {}\", mirrorNodeAddress);\n         mirrorClient = new MirrorClient(Objects.requireNonNull(mirrorNodeAddress));\n         messageTimeout = acceptanceTestProperties.getMessageTimeout();\n+        subscribeDelay = acceptanceTestProperties.getSubscribeDelay() * 1000;\n     }\n \n     public SubscriptionResponse subscribeToTopic(MirrorConsensusTopicQuery mirrorConsensusTopicQuery) throws Throwable {\n-        log.debug(\"Subscribing to topic\");\n+        log.debug(\"Subscribing to topic. Subscribe is delayed by {} ms\", subscribeDelay);\n+        Thread.sleep(subscribeDelay, 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "206bfbbed00b96829d56d540b2b1104af4181f2c"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAzNzc2NQ==", "bodyText": "These timeouts/delays should be a Duration", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#discussion_r399037765", "createdAt": "2020-03-27T05:06:03Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-test/src/test/java/com/hedera/mirror/test/e2e/acceptance/config/AcceptanceTestProperties.java", "diffHunk": "@@ -44,4 +45,8 @@\n     private String operatorKey;\n     @Min(0)\n     private int messageTimeout;\n+    @Min(0)\n+    private int subscribeDelay;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "206bfbbed00b96829d56d540b2b1104af4181f2c"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAzNzk3Mg==", "bodyText": "Why are we duplicately storing these instead of just storing the AcceptanceTestProperties?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#discussion_r399037972", "createdAt": "2020-03-27T05:06:55Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-test/src/test/java/com/hedera/mirror/test/e2e/acceptance/client/MirrorNodeClient.java", "diffHunk": "@@ -38,16 +38,19 @@\n public class MirrorNodeClient {\n     private final MirrorClient mirrorClient;\n     private final int messageTimeout;\n+    private final int subscribeDelay;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "206bfbbed00b96829d56d540b2b1104af4181f2c"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA0MDgyNQ==", "bodyText": "Updated .feature files to specify an expectedCount of messages which can differ from the published amount. This allows for environments where transaction volume is small and files aren't closed as often.\n\nAs a non-programmer, I should be able to read these feature files and understand them. These changes makes it non-obvious and confusing. A better approach would be to revert to the old feature file with a single numMessages, then publish numMessages and every second after publish one more message until timeout. The additional messages are just for closing the record file and can be ignored and you just verify you received at least numMessages.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#discussion_r399040825", "createdAt": "2020-03-27T05:19:21Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-test/src/test/resources/features/hcs/hcs.feature", "diffHunk": "@@ -5,23 +5,23 @@ Feature: HCS Base Coverage Feature\n     Scenario Outline: Validate Topic message submission\n         Given I successfully create a new topic id\n         And I publish and verify <numMessages> messages sent\n-        When I provide a number of messages <numMessages> I want to receive\n+        When I provide a number of messages <expectedCount> I want to receive\n         And I subscribe with a filter to retrieve messages\n         Then the network should successfully observe these messages\n         Examples:\n-            | numMessages |\n-            | 100         |\n+            | numMessages | expectedCount |\n+            | 15          | 10            |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "206bfbbed00b96829d56d540b2b1104af4181f2c"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "554922d257ba898d226ccbc6b1a2b7f6091297a1", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/554922d257ba898d226ccbc6b1a2b7f6091297a1", "committedDate": "2020-03-30T21:38:57Z", "message": " Added retry logic and background message publish logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44600b0b5ac1d45244ec5dbf8a7856df92b188f7", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/44600b0b5ac1d45244ec5dbf8a7856df92b188f7", "committedDate": "2020-03-30T22:30:36Z", "message": "Added retry logic logging visibility\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5762da92923872c2dfb2485035339eef9b5157a6", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5762da92923872c2dfb2485035339eef9b5157a6", "committedDate": "2020-03-31T16:44:54Z", "message": "Updated readme w emitBackgroundMessages\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6417513cb443b837d2051b33a7301d2df86a0fac", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6417513cb443b837d2051b33a7301d2df86a0fac", "committedDate": "2020-03-31T22:14:34Z", "message": "Added matching recover methods and summaries appropriately.\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0OTcyNjEy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#pullrequestreview-384972612", "createdAt": "2020-03-31T17:56:05Z", "commit": {"oid": "5762da92923872c2dfb2485035339eef9b5157a6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNzo1NzoyMVrOF-hlfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMjoxMjoxMVrOF-qHqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEwNjMwMQ==", "bodyText": "This will retry all StatusRuntimeException, not just NOT_FOUND. You probably want to set exceptionExpression to interrogate the code.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#discussion_r401106301", "createdAt": "2020-03-31T17:57:21Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-test/src/test/java/com/hedera/mirror/test/e2e/acceptance/client/MirrorNodeClient.java", "diffHunk": "@@ -62,11 +65,12 @@ public SubscriptionResponse subscribeToTopic(MirrorConsensusTopicQuery mirrorCon\n         return subscriptionResponse;\n     }\n \n+    @Retryable(value = {StatusRuntimeException.class})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5762da92923872c2dfb2485035339eef9b5157a6"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE2NzE1Ng==", "bodyText": "This is now unused, right? Though we do need some sort of limit to subscribe: either subscribeTimeout or subscribeRetries?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#discussion_r401167156", "createdAt": "2020-03-31T19:40:00Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-test/src/test/resources/application-default.yml", "diffHunk": "@@ -2,9 +2,12 @@ hedera:\n   mirror:\n     test:\n       acceptance:\n-        messageTimeout: 20\n+        emitBackgroundMessages: false\n+        existingTopicNum:\n+        messageTimeout: 20s\n+        mirrorNodeAddress: hcs.testnet.mirrornode.hedera.com:5600\n         nodeId: 0.0.3\n         nodeAddress: testnet\n-        mirrorNodeAddress: hcs.testnet.mirrornode.hedera.com:5600\n         operatorId:\n         operatorKey:\n+        subscribeDelay: 2s", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5762da92923872c2dfb2485035339eef9b5157a6"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE2ODIzOQ==", "bodyText": "Default should be in code. Can remove default in config or duplicate it.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#discussion_r401168239", "createdAt": "2020-03-31T19:41:58Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-test/src/test/java/com/hedera/mirror/test/e2e/acceptance/config/AcceptanceTestProperties.java", "diffHunk": "@@ -42,6 +43,10 @@\n     private String operatorId;\n     @NotBlank\n     private String operatorKey;\n-    @Min(0)\n-    private int messageTimeout;\n+    @NotNull\n+    private Duration messageTimeout;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5762da92923872c2dfb2485035339eef9b5157a6"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE3MzQyMA==", "bodyText": "Why are we retrying create topics? They could've potentially failed for valid reasons like no funds or invalid input. Or if we do need it we should interrogate code only for particular types.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#discussion_r401173420", "createdAt": "2020-03-31T19:51:26Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-test/src/test/java/com/hedera/mirror/test/e2e/acceptance/steps/TopicFeature.java", "diffHunk": "@@ -41,27 +44,32 @@\n import com.hedera.mirror.test.e2e.acceptance.client.MirrorNodeClient;\n import com.hedera.mirror.test.e2e.acceptance.client.SubscriptionResponse;\n import com.hedera.mirror.test.e2e.acceptance.client.TopicClient;\n+import com.hedera.mirror.test.e2e.acceptance.config.AcceptanceTestProperties;\n import com.hedera.mirror.test.e2e.acceptance.util.FeatureInputHandler;\n \n @Log4j2\n @Cucumber\n public class TopicFeature {\n+    private final AcceptanceTestProperties acceptanceProps;\n     private int messageSubscribeCount;\n-    private int latency;\n+    private long latency;\n     private MirrorConsensusTopicQuery mirrorConsensusTopicQuery;\n     private ConsensusTopicId consensusTopicId;\n     private SubscriptionResponse subscriptionResponse;\n     private Ed25519PrivateKey submitKey;\n     private Instant testInstantReference;\n     private List<TransactionReceipt> publishedTransactionReceipts;\n-\n     @Autowired\n     private MirrorNodeClient mirrorClient;\n-\n     @Autowired\n     private TopicClient topicClient;\n \n+    public TopicFeature(AcceptanceTestProperties acceptanceTestProperties) {\n+        acceptanceProps = acceptanceTestProperties;\n+    }\n+\n     @Given(\"I successfully create a new topic id\")\n+    @Retryable(value = {StatusRuntimeException.class})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5762da92923872c2dfb2485035339eef9b5157a6"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0MTgzMA==", "bodyText": "I don't think you can retry a batch, right? You might've sent one successfully then got an exception on second. It would then try to send the first one again. Retry should be on the single publish message if at all.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#discussion_r401241830", "createdAt": "2020-03-31T22:02:01Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-test/src/test/java/com/hedera/mirror/test/e2e/acceptance/steps/TopicFeature.java", "diffHunk": "@@ -198,17 +223,17 @@ public void verifySubscriptionChannelConnection() throws Throwable {\n     }\n \n     @When(\"I publish {int} batches of {int} messages every {long} milliseconds\")\n+    @Retryable(value = {StatusRuntimeException.class})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5762da92923872c2dfb2485035339eef9b5157a6"}, "originalPosition": 168}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NTE0OQ==", "bodyText": "3rd param is numBatches so why is a message timeout being passed?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#discussion_r401245149", "createdAt": "2020-03-31T22:09:48Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-test/src/test/java/com/hedera/mirror/test/e2e/acceptance/steps/TopicFeature.java", "diffHunk": "@@ -312,4 +337,56 @@ public void closeClients() {\n             }\n         }\n     }\n+\n+    /**\n+     * Subscribe to topic and observe messages while emitting background messages to encourage service file close in\n+     * environments with low traffic.\n+     *\n+     * @return SubscriptionResponse\n+     * @throws InterruptedException\n+     */\n+    public SubscriptionResponse subscribeWithBackgroundMessageEmission() throws Throwable {\n+        Thread backgroundMessageThread = null;\n+\n+        if (acceptanceProps.isEmitBackgroundMessages()) {\n+            backgroundMessageThread = new Thread(topicClient\n+                    .getBackgroundMessagePublisher(consensusTopicId, submitKey, (int) acceptanceProps", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5762da92923872c2dfb2485035339eef9b5157a6"}, "originalPosition": 235}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NjEyMQ==", "bodyText": "This is all  quite tightly coupled together. A feature should not know about threads, retrying or background production of messages. Would be better if topicClient handled it internally via one of its existing methods. Could be done in follow up", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#discussion_r401246121", "createdAt": "2020-03-31T22:12:11Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-test/src/test/java/com/hedera/mirror/test/e2e/acceptance/steps/TopicFeature.java", "diffHunk": "@@ -312,4 +337,56 @@ public void closeClients() {\n             }\n         }\n     }\n+\n+    /**\n+     * Subscribe to topic and observe messages while emitting background messages to encourage service file close in\n+     * environments with low traffic.\n+     *\n+     * @return SubscriptionResponse\n+     * @throws InterruptedException\n+     */\n+    public SubscriptionResponse subscribeWithBackgroundMessageEmission() throws Throwable {\n+        Thread backgroundMessageThread = null;\n+\n+        if (acceptanceProps.isEmitBackgroundMessages()) {\n+            backgroundMessageThread = new Thread(topicClient", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5762da92923872c2dfb2485035339eef9b5157a6"}, "originalPosition": 234}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3125694e30398ca0793b0801b37712fcf24e55cf", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3125694e30398ca0793b0801b37712fcf24e55cf", "committedDate": "2020-04-01T21:32:41Z", "message": "Merge master to get test fragility fixes\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f6566b597747796171c4d1ef4ddba51e0e33e15", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1f6566b597747796171c4d1ef4ddba51e0e33e15", "committedDate": "2020-04-01T23:07:33Z", "message": "Addressed feedback. Used scheduler and filtered on retries\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d84e871e97fddc8ffe6ae9a48d4f42faed5ae2a0", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d84e871e97fddc8ffe6ae9a48d4f42faed5ae2a0", "committedDate": "2020-04-02T03:02:31Z", "message": "Overloaded publishTopicMessages method to retry only single publish attempts not batches\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa62b4b1aeb200c3b2b578a6f05a30503091eb34", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/aa62b4b1aeb200c3b2b578a6f05a30503091eb34", "committedDate": "2020-04-02T18:06:18Z", "message": "Signed-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>\nMerge branch 'master' into hcs-acceptance-devops"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2Njk2ODM4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#pullrequestreview-386696838", "createdAt": "2020-04-02T18:39:17Z", "commit": {"oid": "aa62b4b1aeb200c3b2b578a6f05a30503091eb34"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxODozOToxN1rOF_4iNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxODozOToxN1rOF_4iNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzMDg3MA==", "bodyText": "Don't think this will work. Did you try? It should be a spel expression that interrogates the object:\n@Retryable(include = {StatusRuntimeException.class}, exceptionExpression = \"#{message.contains('this can be retried')}\")`\n\n@Retryable(include = {StatusRuntimeException.class}, exceptionExpression = \"#{status == Status.NOT_FOUND}\")`", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#discussion_r402530870", "createdAt": "2020-04-02T18:39:17Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-test/src/test/java/com/hedera/mirror/test/e2e/acceptance/client/MirrorNodeClient.java", "diffHunk": "@@ -37,17 +40,18 @@\n @Log4j2\n public class MirrorNodeClient {\n     private final MirrorClient mirrorClient;\n-    private final int messageTimeout;\n+    private final AcceptanceTestProperties acceptanceProps;\n \n     public MirrorNodeClient(AcceptanceTestProperties acceptanceTestProperties) {\n         String mirrorNodeAddress = acceptanceTestProperties.getMirrorNodeAddress();\n         log.debug(\"Creating Mirror Node client for {}\", mirrorNodeAddress);\n         mirrorClient = new MirrorClient(Objects.requireNonNull(mirrorNodeAddress));\n-        messageTimeout = acceptanceTestProperties.getMessageTimeout();\n+        acceptanceProps = acceptanceTestProperties;\n     }\n \n+    @Retryable(value = {StatusRuntimeException.class}, exceptionExpression = \"NOT_FOUND\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa62b4b1aeb200c3b2b578a6f05a30503091eb34"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2Njk5NDM0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#pullrequestreview-386699434", "createdAt": "2020-04-02T18:42:51Z", "commit": {"oid": "aa62b4b1aeb200c3b2b578a6f05a30503091eb34"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxODo0Mjo1MVrOF_4qIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxOTowMDo1MFrOF_5UJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzMjg5Ng==", "bodyText": "These two methods now seem to be unused", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#discussion_r402532896", "createdAt": "2020-04-02T18:42:51Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-test/src/test/java/com/hedera/mirror/test/e2e/acceptance/client/TopicClient.java", "diffHunk": "@@ -179,4 +184,40 @@ public Instant getInstantOfPublishedMessage(long sequenceNumber) {\n     public Instant getInstantOfFirstPublishedMessage() {\n         return recordPublishInstants.get(0L);\n     }\n+\n+    public List<TransactionReceipt> batchPublishMessages(ConsensusTopicId topicId,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa62b4b1aeb200c3b2b578a6f05a30503091eb34"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzMzIwNg==", "bodyText": "subscribeRetryBackoffPeriod and should be Duration. and not null", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#discussion_r402533206", "createdAt": "2020-04-02T18:43:23Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-test/src/test/java/com/hedera/mirror/test/e2e/acceptance/config/AcceptanceTestProperties.java", "diffHunk": "@@ -42,6 +44,15 @@\n     private String operatorId;\n     @NotBlank\n     private String operatorKey;\n-    @Min(0)\n-    private int messageTimeout;\n+    @NotNull\n+    private Duration messageTimeout = Duration.ofSeconds(20);\n+    @NotNull\n+    private Long existingTopicNum;\n+\n+    private boolean emitBackgroundMessages = false;\n+\n+    @Max(5)\n+    private int subscribeRetries = 3;\n+\n+    private long subscribeRetryOffPeriod = 2000l;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa62b4b1aeb200c3b2b578a6f05a30503091eb34"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0MzY1NA==", "bodyText": "I thought it was implied, but will state explicitly: exceptionExpression should be populated on all retryables", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#discussion_r402543654", "createdAt": "2020-04-02T19:00:50Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-test/src/test/java/com/hedera/mirror/test/e2e/acceptance/steps/TopicFeature.java", "diffHunk": "@@ -201,14 +229,22 @@ public void verifySubscriptionChannelConnection() throws Throwable {\n     public void publishTopicMessages(int numGroups, int messageCount, long milliSleep) throws InterruptedException,\n             HederaStatusException {\n         for (int i = 0; i < numGroups; i++) {\n-            topicClient.publishMessagesToTopic(consensusTopicId, \"New message\", submitKey, messageCount, false);\n             Thread.sleep(milliSleep, 0);\n+            publishTopicMessages(messageCount);\n+            log.trace(\"Emitted {} message(s) in batch {} of {} potential batches. Will sleep {} ms until \" +\n+                    \"next batch\", messageCount, i + 1, numGroups, milliSleep);\n         }\n \n         messageSubscribeCount = numGroups * messageCount;\n     }\n \n+    @Retryable(value = {StatusRuntimeException.class})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa62b4b1aeb200c3b2b578a6f05a30503091eb34"}, "originalPosition": 181}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f5d3700f6150d07098931a69a0539728d3134f0", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/7f5d3700f6150d07098931a69a0539728d3134f0", "committedDate": "2020-04-03T18:54:56Z", "message": "Updated exceptionExpression and addressed other feedback\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b679876a6ff9446b031d6ed3f88b3e144b9aed8", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2b679876a6ff9446b031d6ed3f88b3e144b9aed8", "committedDate": "2020-04-03T18:58:36Z", "message": "Renamed subscribeRetryOffPeriod to subscribeRetryBackoffPeriod\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NTcxMDM1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/626#pullrequestreview-387571035", "createdAt": "2020-04-03T20:48:52Z", "commit": {"oid": "2b679876a6ff9446b031d6ed3f88b3e144b9aed8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3356, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}