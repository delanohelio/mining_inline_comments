{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5Nzc2OTU2", "number": 869, "title": "Improve topic message ingest rate", "bodyText": "Detailed description:\n\nAdd batching of select pg_notify(topic_message, ${json}) commands in code to improve performance\nAdd hedera.mirror.importer.parser.record.entity.sql.notifyTopicMessage=true property to dynamically control notification\nAdd node account ID to error logs when getting hash mismatch or unable to download errors\nRemove duplicate hash mismatch log\nRemove for each row trigger to notify gRPC of new topic messages\n\nWhich issue(s) this PR fixes:\nFixes #868\nSpecial notes for your reviewer:\nTesting in integration environment indicates around a 500 TPS improvement\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-07-15T22:35:58Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869", "merged": true, "mergeCommit": {"oid": "b97c4971b5eb03c2866094eff4fc821d2f47d051"}, "closed": true, "closedAt": "2020-07-17T15:44:15Z", "author": {"login": "steven-sheehy"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1Snd0AH2gAyNDQ5Nzc2OTU2OmVmMjU0NmZhN2FmZGM3Mzc0MDdkMDhmMmNhZTAyYmQ1ODEwZjE0NGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc11xgvgFqTQ1MDc2NDU2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ef2546fa7afdc737407d08f2cae02bd5810f144d", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ef2546fa7afdc737407d08f2cae02bd5810f144d", "committedDate": "2020-07-15T22:45:28Z", "message": "Remove notify trigger\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de44afc65211482f7551f7771d8fcff8470ae5e0", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/de44afc65211482f7551f7771d8fcff8470ae5e0", "committedDate": "2020-07-15T22:14:46Z", "message": "Remove notify trigger\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}, "afterCommit": {"oid": "ef2546fa7afdc737407d08f2cae02bd5810f144d", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ef2546fa7afdc737407d08f2cae02bd5810f144d", "committedDate": "2020-07-15T22:45:28Z", "message": "Remove notify trigger\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MzkzODc1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#pullrequestreview-449393875", "createdAt": "2020-07-15T22:45:19Z", "commit": {"oid": "de44afc65211482f7551f7771d8fcff8470ae5e0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo0NToxOVrOGyT3oQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo0Nzo1MFrOGyT69Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwNzUyMQ==", "bodyText": "nit: just do , topic notifications: {} as a standalone like the rest so it reads easier", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#discussion_r455407521", "createdAt": "2020-07-15T22:45:19Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/sql/SqlEntityListener.java", "diffHunk": "@@ -190,10 +199,11 @@ private void executeBatches() {\n             var contractResult = executeBatch(sqlInsertContractResult);\n             var liveHashes = executeBatch(sqlInsertLiveHashes);\n             var topicMessages = executeBatch(sqlInsertTopicMessage);\n+            var topicMessageNotifications = executeBatch(sqlNotifyTopicMessage);\n             log.info(\"Inserted transactions: {}, entities: {}, transfer lists: {}, files: {}, contracts: {}, \" +\n-                            \"claims: {}, topic messages: {}, non-fee transfers: {}\",\n+                            \"claims: {}, topic messages: {}+({}ms), non-fee transfers: {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de44afc65211482f7551f7771d8fcff8470ae5e0"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwODM3Mw==", "bodyText": "I believe we current base64 encode the message and running hash. I think that logic is missing from here.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#discussion_r455408373", "createdAt": "2020-07-15T22:47:50Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/sql/SqlEntityListener.java", "diffHunk": "@@ -323,6 +333,18 @@ public void onTopicMessage(TopicMessage topicMessage) throws ImporterException {\n         } catch (SQLException e) {\n             throw new ParserSQLException(e);\n         }\n+\n+        try {\n+            if (properties.isNotifyTopicMessage()) {\n+                String json = OBJECT_MAPPER.writeValueAsString(topicMessage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef2546fa7afdc737407d08f2cae02bd5810f144d"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMDEzNjA5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#pullrequestreview-450013609", "createdAt": "2020-07-16T16:24:56Z", "commit": {"oid": "ef2546fa7afdc737407d08f2cae02bd5810f144d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxNjoyNDo1N1rOGyywgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxNjoyNDo1N1rOGyywgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkxMzYwMg==", "bodyText": "20 may be still low. the longest run I saw in CircleCI run is 27.x secs, so in other PRs it's set to 30.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#discussion_r455913602", "createdAt": "2020-07-16T16:24:57Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/RecordFileParserPerformanceTest.java", "diffHunk": "@@ -69,7 +69,7 @@ void before() {\n         parserProperties.init();\n     }\n \n-    @Timeout(10)\n+    @Timeout(20)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef2546fa7afdc737407d08f2cae02bd5810f144d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6d72957d5a663d066ebf9cd48c6110135df828c", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a6d72957d5a663d066ebf9cd48c6110135df828c", "committedDate": "2020-07-16T23:53:25Z", "message": "Merge remote-tracking branch 'origin/release/0.15' into remove-notify-trigger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ffa551bb21bff2b16cb0014f17ce84521b0154d", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4ffa551bb21bff2b16cb0014f17ce84521b0154d", "committedDate": "2020-07-17T00:51:10Z", "message": "Fix tests and address feedback\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzA5NDI2", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#pullrequestreview-450309426", "createdAt": "2020-07-17T00:59:43Z", "commit": {"oid": "4ffa551bb21bff2b16cb0014f17ce84521b0154d"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDo1OTo0M1rOGzBygA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDo1OTo0M1rOGzBygA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1OTg3Mg==", "bodyText": "nit: we can document this now right. But we can do it in master for v0.16", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#discussion_r456159872", "createdAt": "2020-07-17T00:59:43Z", "author": {"login": "Nana-EC"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/sql/SqlProperties.java", "diffHunk": "@@ -32,4 +32,7 @@\n      */\n     @Min(1)\n     private int batchSize = 2000;\n+\n+    // Not documenting this for now since it may be temporary pending further refactorings", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ffa551bb21bff2b16cb0014f17ce84521b0154d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "499f4aaf40a7380fe53786b3e198325d0aa2a094", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/499f4aaf40a7380fe53786b3e198325d0aa2a094", "committedDate": "2020-07-17T03:33:43Z", "message": "Fix bad merge causing failed test\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a39fc56cdddc3694060b1a9ec15bcedfb1d224a5", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a39fc56cdddc3694060b1a9ec15bcedfb1d224a5", "committedDate": "2020-07-17T03:36:02Z", "message": "Bump versions to 0.15.2-rc1\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c770b782e67411ef2d06a5838b425ff913206afb", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c770b782e67411ef2d06a5838b425ff913206afb", "committedDate": "2020-07-17T14:40:18Z", "message": "Fix ConsensusControllerTest\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfb238277f578423407fb1ffdffe406e0ca8aea7", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bfb238277f578423407fb1ffdffe406e0ca8aea7", "committedDate": "2020-07-17T15:18:53Z", "message": "Bump version to 0.15.2\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNzY0NTYx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#pullrequestreview-450764561", "createdAt": "2020-07-17T15:43:07Z", "commit": {"oid": "bfb238277f578423407fb1ffdffe406e0ca8aea7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3005, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}