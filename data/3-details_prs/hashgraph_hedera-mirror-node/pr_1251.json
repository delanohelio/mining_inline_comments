{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4MDQ5MjI0", "number": 1251, "title": "Add monitor charts", "bodyText": "Detailed description:\n\nAdd helm charts for monitor\nAdd monitor to hedera-mirror charts and update values\nAdd monitor to docker-compose.yaml\n\nWhich issue(s) this PR fixes:\nFixes #1216\nSpecial notes for your reviewer:\ndashboard for monitor will be addressed in a future ticket.\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-11-09T21:25:41Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251", "merged": true, "mergeCommit": {"oid": "9249f95d4b6aa13be2cd35b6a318da00d606ad95"}, "closed": true, "closedAt": "2020-11-10T18:41:29Z", "author": {"login": "xin-hedera"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABda5VT-AH2gAyNTE4MDQ5MjI0OjNkZWVhMzQyYmUyNTJhMzhjNzZhZDJjNDFmZDZlZWFhODM1NTI5YWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbNzM-gFqTUyNzQ5NjY4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3deea342be252a38c76ad2c41fd6eeaa835529ae", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3deea342be252a38c76ad2c41fd6eeaa835529ae", "committedDate": "2020-11-09T18:47:08Z", "message": "helm charts for hedera-mirror-monitor\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "373553de9415d58231113c1970d7795706a91fd5", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/373553de9415d58231113c1970d7795706a91fd5", "committedDate": "2020-11-09T20:22:33Z", "message": "add headless service for service monitor\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83b3336a18bcc9cfc6f21919f4b414d0f6aa78e2", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/83b3336a18bcc9cfc6f21919f4b414d0f6aa78e2", "committedDate": "2020-11-09T20:25:46Z", "message": "update notes\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e2a6c849983bc9b3f8a2222155af568df692a9b", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1e2a6c849983bc9b3f8a2222155af568df692a9b", "committedDate": "2020-11-09T21:01:48Z", "message": "podMonitor, add monitor to hedera-mirror\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ebe78692f4adbcc87fbc183521fbd2399f53164", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0ebe78692f4adbcc87fbc183521fbd2399f53164", "committedDate": "2020-11-09T21:13:49Z", "message": "add monitor to docker-compose.yml\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1350306f6395e34be1b1125e42130263fc427a37", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1350306f6395e34be1b1125e42130263fc427a37", "committedDate": "2020-11-09T21:16:34Z", "message": "name -> component\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NjcwODE4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#pullrequestreview-526670818", "createdAt": "2020-11-09T21:31:49Z", "commit": {"oid": "1350306f6395e34be1b1125e42130263fc427a37"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTozMTo0OVrOHwCatQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTozNDozNVrOHwCgjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzMzMwMQ==", "bodyText": "Maybe we should disable this by default since we want to make it easy for people to get up and running without requiring any config? Or can we set replicas=0 to effectively disable?", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#discussion_r520133301", "createdAt": "2020-11-09T21:31:49Z", "author": {"login": "steven-sheehy"}, "path": "docker-compose.yml", "diffHunk": "@@ -40,6 +40,14 @@ services:\n       - ./data:/var/lib/hedera-mirror-importer\n       - ./application.yml:/usr/etc/hedera-mirror-importer/application.yml\n \n+  monitor:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1350306f6395e34be1b1125e42130263fc427a37"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzNDU2MA==", "bodyText": "Can you test if we can lower this? It should start up much quicker than grpc which requires redis and postgresql.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#discussion_r520134560", "createdAt": "2020-11-09T21:34:10Z", "author": {"login": "steven-sheehy"}, "path": "charts/hedera-mirror-monitor/values.yaml", "diffHunk": "@@ -0,0 +1,144 @@\n+affinity:\n+  podAntiAffinity:\n+    preferredDuringSchedulingIgnoredDuringExecution:\n+      - weight: 100\n+        podAffinityTerm:\n+          topologyKey: kubernetes.io/hostname\n+          labelSelector:\n+            matchLabels:\n+              app.kubernetes.io/component: monitor\n+\n+annotations: {}\n+\n+config:\n+  hedera:\n+    mirror:\n+      monitor: {}\n+\n+fullnameOverride: \"\"\n+\n+global:\n+  namespaceOverride: \"\"\n+\n+image:\n+  pullPolicy: IfNotPresent\n+  repository: gcr.io/mirrornode/hedera-mirror-monitor\n+  tag: \"\"  # Default to the chart's app version\n+\n+imagePullSecrets: []\n+\n+labels: {}\n+\n+livenessProbe:\n+  httpGet:\n+    path: /actuator/health/liveness\n+    port: http\n+  initialDelaySeconds: 100\n+  periodSeconds: 10\n+  timeoutSeconds: 2\n+\n+nodeSelector: {}\n+\n+podMonitor:\n+  enabled: false\n+  interval: 30s\n+\n+podSecurityContext:\n+  fsGroup: 1000\n+\n+priorityClassName: \"\"\n+\n+prometheusRules:\n+  enabled: false\n+  MonitorHighCPU:\n+    annotations:\n+      description: \"{{ $labels.namespace }}/{{ $labels.pod }} CPU usage reached {{ $value | humanizePercentage }}%\"\n+      summary: \"Mirror Monitor CPU usage exceeds 80%\"\n+    enabled: true\n+    expr: sum(process_cpu_usage{application=\"hedera-mirror-monitor\"}) by (namespace, pod) / sum(system_cpu_count{application=\"hedera-mirror-monitor\"}) by (namespace, pod) > 0.8\n+    for: 5m\n+    labels:\n+      severity: critical\n+\n+  MonitorHighMemory:\n+    annotations:\n+      description: \"{{ $labels.namespace }}/{{ $labels.pod }} memory usage reached {{ $value | humanizePercentage }}%\"\n+      summary: \"Mirror Monitor memory usage exceeds 80%\"\n+    enabled: true\n+    expr: sum(jvm_memory_used_bytes{application=\"hedera-mirror-monitor\"}) by (namespace, pod) / sum(jvm_memory_max_bytes{application=\"hedera-mirror-monitor\"}) by (namespace, pod) > 0.8\n+    for: 5m\n+    labels:\n+      severity: critical\n+\n+  MonitorLog4j2Errors:\n+    annotations:\n+      description: \"{{ $labels.namespace }}/{{ $labels.pod }} encountered {{ $value }} exceptions in a 2m period\"\n+      summary: \"High rate of log4j2 errors\"\n+    enabled: true\n+    expr: sum(increase(log4j2_events_total{application=\"hedera-mirror-monitor\", level=\"error\"}[2m])) by (namespace, pod) >= 2\n+    for: 3m\n+    labels:\n+      severity: critical\n+\n+  MonitorPublishErrors:\n+    annotations:\n+      description: \"{{ $value | humanizePercentage }}% Error rate publishing {{ $labels.type }} transactions from {{ $labels.namespace }}/{{ $labels.pod }}\"\n+      summary: \"Publish error rate exceeds 5%\"\n+    enabled: true\n+    expr: sum(rate(hedera_mirror_monitor_publish_seconds_sum{application=\"hedera-mirror-monitor\",status!=\"SUCCESS\"}[2m])) by (namespace, pod, type) / sum(rate(hedera_mirror_monitor_publish_seconds_count{application=\"hedera-mirror-monitor\"}[2m])) by (namespace, pod, type) > 0.05\n+    for: 2m\n+    labels:\n+      severity: critical\n+\n+  MonitorPublishLatency:\n+    annotations:\n+      description: \"Publish latency exceeded {{ $value | humanizeDuration }} for {{ $labels.type }} transaction for {{ $labels.namespace }}/{{ $labels.pod }}\"\n+      summary: \"Publish latency exceeds 4s\"\n+    enabled: true\n+    expr: sum(rate(hedera_mirror_monitor_publish_seconds_sum{application=\"hedera-mirror-monitor\"}[2m])) by (namespace, pod, type) / sum(rate(hedera_mirror_monitor_publish_seconds_count{application=\"hedera-mirror-monitor\"}[2m])) by (namespace, pod, type) > 4\n+    for: 2m\n+    labels:\n+      severity: critical\n+\n+rbac:\n+  enabled: true\n+\n+readinessProbe:\n+  httpGet:\n+    path: /actuator/health/readiness\n+    port: http\n+  initialDelaySeconds: 100", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1350306f6395e34be1b1125e42130263fc427a37"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzNDc5OA==", "bodyText": "Can you test if we can lower this? It should start up much quicker than grpc which requires redis and postgresql.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#discussion_r520134798", "createdAt": "2020-11-09T21:34:35Z", "author": {"login": "steven-sheehy"}, "path": "charts/hedera-mirror-monitor/values.yaml", "diffHunk": "@@ -0,0 +1,144 @@\n+affinity:\n+  podAntiAffinity:\n+    preferredDuringSchedulingIgnoredDuringExecution:\n+      - weight: 100\n+        podAffinityTerm:\n+          topologyKey: kubernetes.io/hostname\n+          labelSelector:\n+            matchLabels:\n+              app.kubernetes.io/component: monitor\n+\n+annotations: {}\n+\n+config:\n+  hedera:\n+    mirror:\n+      monitor: {}\n+\n+fullnameOverride: \"\"\n+\n+global:\n+  namespaceOverride: \"\"\n+\n+image:\n+  pullPolicy: IfNotPresent\n+  repository: gcr.io/mirrornode/hedera-mirror-monitor\n+  tag: \"\"  # Default to the chart's app version\n+\n+imagePullSecrets: []\n+\n+labels: {}\n+\n+livenessProbe:\n+  httpGet:\n+    path: /actuator/health/liveness\n+    port: http\n+  initialDelaySeconds: 100", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1350306f6395e34be1b1125e42130263fc427a37"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzYwODUy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#pullrequestreview-526760852", "createdAt": "2020-11-10T00:27:25Z", "commit": {"oid": "1350306f6395e34be1b1125e42130263fc427a37"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd2fe0c3aedf4a2022dc45f30811403c42ea911d", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/dd2fe0c3aedf4a2022dc45f30811403c42ea911d", "committedDate": "2020-11-10T01:52:19Z", "message": "address review feedback\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1a9517c26a064db9fcea4783eacbb7a4f037af2", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b1a9517c26a064db9fcea4783eacbb7a4f037af2", "committedDate": "2020-11-10T03:16:26Z", "message": "revert changes to deployment.yaml\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7a7fd6666ffd8b413e27f39a3ea87a67c2f46f5", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d7a7fd6666ffd8b413e27f39a3ea87a67c2f46f5", "committedDate": "2020-11-10T03:23:40Z", "message": "set deploy.replicas = 0 for monitor in docker-compose.yml\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2ODQ2NTE2", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#pullrequestreview-526846516", "createdAt": "2020-11-10T04:36:05Z", "commit": {"oid": "dd2fe0c3aedf4a2022dc45f30811403c42ea911d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwNDozNjowNVrOHwLbCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwNDozNjowNVrOHwLbCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI4MDg0Mw==", "bodyText": "This if/else can be removed. Only reason it's there for gRPC is because it has an HPA and the HPA manages the value of the replicas field. Can simply be replicas: {{ .Values.replicas }}. Please also put a default of 1 in the values.yaml.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#discussion_r520280843", "createdAt": "2020-11-10T04:36:05Z", "author": {"login": "steven-sheehy"}, "path": "charts/hedera-mirror-monitor/templates/deployment.yaml", "diffHunk": "@@ -0,0 +1,70 @@\n+apiVersion: apps/v1\n+kind: Deployment\n+metadata:\n+  annotations:\n+    {{- toYaml .Values.annotations | nindent 4 }}\n+  labels:\n+    {{- include \"hedera-mirror-monitor.labels\" . | nindent 4 }}\n+  name: {{ include \"hedera-mirror-monitor.fullname\" . }}\n+  namespace: {{ include \"hedera-mirror-monitor.namespace\" . }}\n+spec:\n+  {{- if .Values.replicas }}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd2fe0c3aedf4a2022dc45f30811403c42ea911d"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdac47c72711ab687a62c34ab422fffbd6e697ae", "author": {"user": {"login": "xin-hedera", "name": "Xin Li"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bdac47c72711ab687a62c34ab422fffbd6e697ae", "committedDate": "2020-11-10T15:16:38Z", "message": "set monitor deployment replicas default to 1\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NDI0ODc5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#pullrequestreview-527424879", "createdAt": "2020-11-10T17:12:16Z", "commit": {"oid": "bdac47c72711ab687a62c34ab422fffbd6e697ae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NDM0ODE2", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#pullrequestreview-527434816", "createdAt": "2020-11-10T17:23:10Z", "commit": {"oid": "bdac47c72711ab687a62c34ab422fffbd6e697ae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NDk2Njg0", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#pullrequestreview-527496684", "createdAt": "2020-11-10T18:37:53Z", "commit": {"oid": "bdac47c72711ab687a62c34ab422fffbd6e697ae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3497, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}