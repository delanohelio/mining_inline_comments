{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMzQ2NTI1", "number": 1361, "title": "Automatically create monitor entities", "bodyText": "Detailed description:\n\nAdd ability to automatically create account, token or topic entities needed for monitoring\nAdd property to control frequency of publish status log\nAdd a default publish and subscribe scenario in application.yml both as an example and for less config for our deployments\nChange status frequency to every 10 seconds\n\nWhich issue(s) this PR fixes:\nFixes #1220\nSpecial notes for your reviewer:\nExpression format is ${type.name} where type is either account, token or topic and name is a descriptive label that allows it to be referenced in multiple places but only created once.\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-12-15T15:46:04Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1361", "merged": true, "mergeCommit": {"oid": "7ed041e569f707884bb79026b5d00b8991038e4f"}, "closed": true, "closedAt": "2020-12-15T22:49:05Z", "author": {"login": "steven-sheehy"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmcTq1gH2gAyNTQwMzQ2NTI1OjYzNWJjMTE5NDE2OWEzOTYxMzg3NDJhNTk4YzkzMGExNjAyNmJlZGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmiMpygFqTU1MzAxMDI4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "635bc1194169a396138742a598c930a16026bedd", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/635bc1194169a396138742a598c930a16026bedd", "committedDate": "2020-12-15T15:45:11Z", "message": "Auto create monitor entities\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNzU1NDUy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1361#pullrequestreview-552755452", "createdAt": "2020-12-15T18:38:22Z", "commit": {"oid": "635bc1194169a396138742a598c930a16026bedd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxODozODoyM1rOIGaJaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxODozODoyM1rOIGaJaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU5MDc2MA==", "bodyText": "This may be out of scope, but I'm wondering if this is enough to cover Token Transfers.  For HCS and crypto transfers it's enough to have created accounts and topics, but for Token Transfer it has to also associate the accounts to the token.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1361#discussion_r543590760", "createdAt": "2020-12-15T18:38:23Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-monitor/src/main/java/com/hedera/mirror/monitor/expression/ExpressionConverterImpl.java", "diffHunk": "@@ -0,0 +1,142 @@\n+package com.hedera.mirror.monitor.expression;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.time.Instant;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.function.Function;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.inject.Named;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Value;\n+import lombok.extern.log4j.Log4j2;\n+import org.apache.commons.lang3.StringUtils;\n+\n+import com.hedera.datagenerator.sdk.supplier.TransactionSupplier;\n+import com.hedera.datagenerator.sdk.supplier.TransactionType;\n+import com.hedera.datagenerator.sdk.supplier.token.TokenCreateTransactionSupplier;\n+import com.hedera.hashgraph.sdk.TransactionReceipt;\n+import com.hedera.mirror.monitor.publish.PublishRequest;\n+import com.hedera.mirror.monitor.publish.PublishResponse;\n+import com.hedera.mirror.monitor.publish.TransactionPublisher;\n+\n+@Log4j2\n+@Named\n+@RequiredArgsConstructor\n+public class ExpressionConverterImpl implements ExpressionConverter {\n+\n+    private static final String EXPRESSION_START = \"${\";\n+    private static final String EXPRESSION_END = \"}\";\n+    private static final Pattern EXPRESSION_PATTERN = Pattern.compile(\"\\\\$\\\\{(account|token|topic)\\\\.([A-Za-z0-9_]+)}\");\n+\n+    private final Map<Expression, String> expressions = new ConcurrentHashMap<>();\n+    private final TransactionPublisher transactionPublisher;\n+\n+    @Override\n+    public String convert(String property) {\n+        if (!StringUtils.startsWith(property, EXPRESSION_START) || !StringUtils.endsWith(property, EXPRESSION_END)) {\n+            return property;\n+        }\n+\n+        Expression expression = parse(property);\n+        String convertedProperty = expressions.computeIfAbsent(expression, this::doConvert);\n+        log.info(\"Converted property {} to {}\", property, convertedProperty);\n+        return convertedProperty;\n+    }\n+\n+    private synchronized String doConvert(Expression expression) {\n+        if (expressions.containsKey(expression)) {\n+            return expressions.get(expression);\n+        }\n+\n+        return publish(expression);\n+    }\n+\n+    private String publish(Expression expression) {\n+        try {\n+            ExpressionType type = expression.getType();\n+            Class<? extends TransactionSupplier<?>> supplierClass = type.getTransactionType().getSupplier();\n+            TransactionSupplier<?> transactionSupplier = supplierClass.getConstructor().newInstance();\n+\n+            if (transactionSupplier instanceof TokenCreateTransactionSupplier) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "635bc1194169a396138742a598c930a16026bedd"}, "originalPosition": 82}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyODU4MzEz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1361#pullrequestreview-552858313", "createdAt": "2020-12-15T20:52:11Z", "commit": {"oid": "635bc1194169a396138742a598c930a16026bedd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyODYwMTk3", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1361#pullrequestreview-552860197", "createdAt": "2020-12-15T20:54:51Z", "commit": {"oid": "635bc1194169a396138742a598c930a16026bedd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "200e0df5a9b67ecee8ea504cad80c5d153410a0d", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/200e0df5a9b67ecee8ea504cad80c5d153410a0d", "committedDate": "2020-12-15T22:07:26Z", "message": "Fix code smells & token create\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyOTgyNTIx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1361#pullrequestreview-552982521", "createdAt": "2020-12-15T22:17:42Z", "commit": {"oid": "200e0df5a9b67ecee8ea504cad80c5d153410a0d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMjoxNzo0MlrOIGif3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMjoxNzo0MlrOIGif3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcyNzU4MA==", "bodyText": "Sonarcloud doesn't like this.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1361#discussion_r543727580", "createdAt": "2020-12-15T22:17:42Z", "author": {"login": "ijungmann"}, "path": "hedera-mirror-datagenerator/src/main/java/com/hedera/datagenerator/sdk/supplier/token/TokenCreateTransactionSupplier.java", "diffHunk": "@@ -47,25 +48,24 @@\n     private long maxTransactionFee = 1_000_000_000;\n \n     @NotBlank\n-    private String symbol = \"HMNT\";\n+    private String symbol = RandomStringUtils.randomAlphabetic(5);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "200e0df5a9b67ecee8ea504cad80c5d153410a0d"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c44e8de8c59b9bd2357a8da99de1d8c83c6c3d7a", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c44e8de8c59b9bd2357a8da99de1d8c83c6c3d7a", "committedDate": "2020-12-15T22:29:54Z", "message": "Fix security hotspot\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMDA4OTM4", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1361#pullrequestreview-553008938", "createdAt": "2020-12-15T22:36:00Z", "commit": {"oid": "c44e8de8c59b9bd2357a8da99de1d8c83c6c3d7a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMDEwMjgz", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1361#pullrequestreview-553010283", "createdAt": "2020-12-15T22:36:57Z", "commit": {"oid": "c44e8de8c59b9bd2357a8da99de1d8c83c6c3d7a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3436, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}