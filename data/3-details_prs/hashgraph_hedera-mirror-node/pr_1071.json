{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNjAzMjIx", "number": 1071, "title": "Replace account_realm_num and account_num with  account_id in account_balance table", "bodyText": "Detailed description:\naccount_balance table was one of the few tables that still used separate realm and num columns instead of the aggregated entity_id table.\nThe change\n\nReplaces account_realm_num and account_num with  account_id in account_balance table\nUpdates AccountBalance domain replacing accoutnRealmNum and accountNum with new accountId\nUpdates account.js and balances.js` REST API queries with updated columns\nUpdates AccountBalanceLineParser to use new column on inserts\nUpdates affected tests\n\nWhich issue(s) this PR fixes:\nFixes #1070\nSpecial notes for your reviewer:\nMigration tested on dev\naccount_balance 1814 MB, 36555409 rows\nSep 21 23:38:58 mirrornode-dev-1 java[1410]: 2020-09-21 23:38:58,597 INFO  [main ] o.f.c.i.c.DbMigrate Migrating schema \"public\" to version 1.30.0 - balance entity id Sep 21 23:44:22 mirrornode-dev-1 java[1410]: 2020-09-21 23:44:22,718 INFO  [main ] o.f.c.i.c.DbMigrate Successfully applied 1 migrations to schema \"public\" (execution time 05:24.159s)\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-09-21T23:01:08Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071", "merged": true, "mergeCommit": {"oid": "92c9afeab5459a98ff2ea8168f24703139ba999a"}, "closed": true, "closedAt": "2020-09-22T19:42:34Z", "author": {"login": "Nana-EC"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLLeraAH2gAyNDkwNjAzMjIxOjAwZjMyZWExM2Y1YzMyZWZiMTQ0M2MwMWNjZGJkZWYyN2Q3N2MwZmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLdOSHgFqTQ5Mzc4MzM0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/00f32ea13f5c32efb1443c01ccdbdef27d77c0fa", "committedDate": "2020-09-21T22:52:52Z", "message": "Replace account_reallm_num and account_num with  account_id in account_balance table\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDcwNDI1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#pullrequestreview-493070425", "createdAt": "2020-09-22T00:49:32Z", "commit": {"oid": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMDo0OTozMlrOHVnGcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMDo1Mjo0N1rOHVnJjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyMjc2OQ==", "bodyText": "Serializationversionid should  probably be updated.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492422769", "createdAt": "2020-09-22T00:49:32Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/AccountBalance.java", "diffHunk": "@@ -57,8 +62,8 @@ public boolean isNew() {\n \n         private long consensusTimestamp;\n \n-        private int accountNum;\n-\n-        private int accountRealmNum;\n+        @Convert(converter = AccountIdConverter.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyMzU2NQ==", "bodyText": "Would prefer constraints start with table name like the below index does", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492423565", "createdAt": "2020-09-22T00:52:47Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.0__balance_entity_id.sql", "diffHunk": "@@ -0,0 +1,29 @@\n+-------------------\n+-- Update account_balance to use single entity_id column instead of account_realm_num and account_num\n+-------------------\n+\n+-- Drop pk and index that used account_realm_num and account_num. Drop first to make migration quicker\n+alter table account_balance drop constraint pk__account_balances;\n+drop index if exists idx__account_balances__account_then_timestamp;\n+\n+--  Add account_id entity_id column and set based on existing account_realm_num and account_num\n+alter table if exists account_balance\n+    add column account_id entity_id null;\n+\n+update account_balance\n+    set account_id = encodeEntityId(0, account_realm_num, account_num);\n+\n+alter table if exists account_balance\n+    alter column account_id set not null;\n+\n+-- Drop account_realm_num and account_num\n+alter table if exists account_balance\n+    drop column if exists account_realm_num,\n+    drop column if exists account_num;\n+\n+-- Add new pk and index using account_id\n+alter table account_balance\n+    add constraint pk__account_balance primary key (consensus_timestamp, account_id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNTA3MjE1", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#pullrequestreview-493507215", "createdAt": "2020-09-22T14:15:10Z", "commit": {"oid": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNDoxNToxMFrOHV8RhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNDoxNToxMFrOHV8RhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc2OTY2OQ==", "bodyText": "The response json didn't change, acc doesn't have an id field so this check is always false, should revert the changes", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492769669", "createdAt": "2020-09-22T14:15:10Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/__tests__/accounts.test.js", "diffHunk": "@@ -51,9 +51,8 @@ const validateAccNumRange = function (accounts, low, high) {\n   let ret = true;\n   let offender = null;\n   for (const acc of accounts.accounts) {\n-    const accNum = acc.account.split('.')[2];\n-    if (accNum < low || accNum > high) {\n-      offender = accNum;\n+    if (acc.id < low || acc.id > high) {\n+      offender = acc.id;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNTE5Mzgy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#pullrequestreview-493519382", "createdAt": "2020-09-22T14:26:13Z", "commit": {"oid": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNDoyNjoxM1rOHV80Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNDoyNjoxM1rOHV80Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc3ODUzNA==", "bodyText": "nit: extra space before e.id", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492778534", "createdAt": "2020-09-22T14:26:13Z", "author": {"login": "xin-hedera"}, "path": "hedera-mirror-rest/accounts.js", "diffHunk": "@@ -49,18 +49,14 @@ const processRow = function (row) {\n const getAccountQueryPrefix = function () {\n   return `select ab.balance as account_balance,\n        ab.consensus_timestamp as consensus_timestamp,\n-       ${config.shard} as entity_shard,\n-       coalesce(ab.account_realm_num, e.entity_realm) as entity_realm,\n-       coalesce(ab.account_num, e.entity_num) as entity_num,\n+       coalesce(ab.account_id, e.id) as entity_id,\n        e.exp_time_ns,\n        e.auto_renew_period,\n        e.key,\n        e.deleted\n     from account_balance ab\n     full outer join t_entities e on (\n-        ${config.shard} = e.entity_shard\n-        and ab.account_realm_num = e.entity_realm\n-        and ab.account_num =  e.entity_num\n+        ab.account_id =  e.id", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1708aafde80a489f8f08da767440d62bd6aae67d", "author": {"user": {"login": "Nana-EC", "name": null}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1708aafde80a489f8f08da767440d62bd6aae67d", "committedDate": "2020-09-22T17:51:45Z", "message": "Addressed feedback\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzY4MTIx", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#pullrequestreview-493768121", "createdAt": "2020-09-22T19:11:24Z", "commit": {"oid": "1708aafde80a489f8f08da767440d62bd6aae67d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzgzMzQw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#pullrequestreview-493783340", "createdAt": "2020-09-22T19:33:15Z", "commit": {"oid": "1708aafde80a489f8f08da767440d62bd6aae67d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3541, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}