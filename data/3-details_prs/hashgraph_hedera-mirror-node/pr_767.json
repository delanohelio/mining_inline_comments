{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwMzMwNDg0", "number": 767, "title": "Fix failed crypto transfers with non-fee transfers enabled crashing importer", "bodyText": "Detailed description:\nOnly add non-fee transfers for successful transactions.\nWhich issue(s) this PR fixes:\nFixes #647\nSpecial notes for your reviewer:\nChecklist\n\n Documentation added\n Tests updated", "createdAt": "2020-05-19T19:51:07Z", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/767", "merged": true, "mergeCommit": {"oid": "181013f8f179d4bb051a76a2830997b2b612041b"}, "closed": true, "closedAt": "2020-05-20T23:06:33Z", "author": {"login": "steven-sheehy"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABci6OMJAH2gAyNDIwMzMwNDg0OjU3NWNhNWU5N2U1Yjg4OTU1YmQzMDdiMGNhODE3MWZlNTJhYTFiMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjRJUoAFqTQxNTc2ODM1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "575ca5e97e5b88955bd307b0ca8171fe52aa1b04", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/575ca5e97e5b88955bd307b0ca8171fe52aa1b04", "committedDate": "2020-05-19T20:09:30Z", "message": "Fix failed non-fee transfers crashing importer\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "08347599627fd54366392291abf393fc361ac2c4", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/08347599627fd54366392291abf393fc361ac2c4", "committedDate": "2020-05-19T19:47:18Z", "message": "Fix failed non-fee transfers crashing importer\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}, "afterCommit": {"oid": "575ca5e97e5b88955bd307b0ca8171fe52aa1b04", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/575ca5e97e5b88955bd307b0ca8171fe52aa1b04", "committedDate": "2020-05-19T20:09:30Z", "message": "Fix failed non-fee transfers crashing importer\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0ODEwNjgw", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/767#pullrequestreview-414810680", "createdAt": "2020-05-19T20:47:34Z", "commit": {"oid": "575ca5e97e5b88955bd307b0ca8171fe52aa1b04"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0ODcyODM3", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/767#pullrequestreview-414872837", "createdAt": "2020-05-19T22:40:12Z", "commit": {"oid": "575ca5e97e5b88955bd307b0ca8171fe52aa1b04"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMjo0MDoxMlrOGX1G9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMzowMTo0NlrOGX1jyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY0MDU2Ng==", "bodyText": "For failed txns, we want to insert only basic txn info (t_transactions) and fee transfers.\nFor that invariant, lines 128-133 should be moved inside if cond following them.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/767#discussion_r427640566", "createdAt": "2020-05-19T22:40:12Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/EntityRecordItemListener.java", "diffHunk": "@@ -112,7 +112,12 @@ public void onItem(RecordItem recordItem) throws ImporterException {\n         tx.setEntity(getEntity(recordItem, transactionHandler, entityId, isSuccessful));\n \n         if ((txRecord.hasTransferList()) && entityProperties.getPersist().isCryptoTransferAmounts()) {\n-            processNonFeeTransfers(consensusNs, body, txRecord);\n+            // Don't add failed non-fee transfers as they can contain invalid data and we don't add failed\n+            // transactions for aggregated transfers\n+            if (isSuccessful) {\n+                processNonFeeTransfers(consensusNs, body, txRecord);\n+            }\n+\n             if (body.hasCryptoCreateAccount() && isSuccessful(txRecord)) {\n                 insertCryptoCreateTransferList(consensusNs, txRecord, body);\n             } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "575ca5e97e5b88955bd307b0ca8171fe52aa1b04"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY0Nzk0NQ==", "bodyText": "Just realized that logic in insertCryptoCreateTransferList may be duplicating transfers related to initialBalance which have already been processed by processNonFeeTransfers.\nPTAL.", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/767#discussion_r427647945", "createdAt": "2020-05-19T23:01:46Z", "author": {"login": "apeksharma"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/EntityRecordItemListener.java", "diffHunk": "@@ -112,7 +112,12 @@ public void onItem(RecordItem recordItem) throws ImporterException {\n         tx.setEntity(getEntity(recordItem, transactionHandler, entityId, isSuccessful));\n \n         if ((txRecord.hasTransferList()) && entityProperties.getPersist().isCryptoTransferAmounts()) {\n-            processNonFeeTransfers(consensusNs, body, txRecord);\n+            // Don't add failed non-fee transfers as they can contain invalid data and we don't add failed\n+            // transactions for aggregated transfers\n+            if (isSuccessful) {\n+                processNonFeeTransfers(consensusNs, body, txRecord);\n+            }\n+\n             if (body.hasCryptoCreateAccount() && isSuccessful(txRecord)) {\n                 insertCryptoCreateTransferList(consensusNs, txRecord, body);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "575ca5e97e5b88955bd307b0ca8171fe52aa1b04"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d0ccb6c19dfb43bbb6ffb406ee8e5fa18c46334", "author": {"user": {"login": "steven-sheehy", "name": "Steven Sheehy"}}, "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2d0ccb6c19dfb43bbb6ffb406ee8e5fa18c46334", "committedDate": "2020-05-20T19:21:59Z", "message": "Address review feedback\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NjYwMjgy", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/767#pullrequestreview-415660282", "createdAt": "2020-05-20T19:44:31Z", "commit": {"oid": "2d0ccb6c19dfb43bbb6ffb406ee8e5fa18c46334"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxOTo0NDozMVrOGYbQOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxOTo0NDozMVrOGYbQOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI2NTUyOA==", "bodyText": "We already log the full transaction proto in RecordFileParser", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/767#discussion_r428265528", "createdAt": "2020-05-20T19:44:31Z", "author": {"login": "steven-sheehy"}, "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/EntityRecordItemListener.java", "diffHunk": "@@ -93,11 +93,11 @@ public void onItem(RecordItem recordItem) throws ImporterException {\n         TransactionRecord txRecord = recordItem.getRecord();\n         TransactionBody body = recordItem.getTransactionBody();\n         TransactionHandler transactionHandler = transactionHandlerFactory.create(body);\n-        log.trace(\"Processing transaction : {}\", () -> Utility.printProtoMessage(body));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d0ccb6c19dfb43bbb6ffb406ee8e5fa18c46334"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1Njg0Nzky", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/767#pullrequestreview-415684792", "createdAt": "2020-05-20T20:20:51Z", "commit": {"oid": "2d0ccb6c19dfb43bbb6ffb406ee8e5fa18c46334"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NzY4MzU5", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/767#pullrequestreview-415768359", "createdAt": "2020-05-20T22:52:00Z", "commit": {"oid": "2d0ccb6c19dfb43bbb6ffb406ee8e5fa18c46334"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3152, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}