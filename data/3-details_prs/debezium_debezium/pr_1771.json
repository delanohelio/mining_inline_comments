{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2MzQwNTU2", "number": 1771, "title": "DBZ-2396 ByteBufferConverter support converter delegation for unsupported values", "bodyText": "https://issues.redhat.com/browse/DBZ-2396", "createdAt": "2020-08-31T14:37:25Z", "url": "https://github.com/debezium/debezium/pull/1771", "merged": true, "mergeCommit": {"oid": "aebf2516ded64c32592a20140671e6d82865a366"}, "closed": true, "closedAt": "2020-09-24T05:41:37Z", "author": {"login": "Naros"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEUJ-qABqjM3MTAzMDA5MDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdL6hXAAH2gAyNDc2MzQwNTU2OmQ1ZDViNzZlZGU5NjI2YWJjYTFjMGI1N2MwMTUzMDM0ODExZTg1NWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5Mzg4Mjgz", "url": "https://github.com/debezium/debezium/pull/1771#pullrequestreview-479388283", "createdAt": "2020-09-01T04:16:16Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwNDoxNjoxN1rOHKfkQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwNDoxNjoxN1rOHKfkQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDc2NDk5NA==", "bodyText": "@Naros I wonder if we should use nested conditions. Would not it be better to introduce new method on SMT manager like isDataChangeMessage? It might make sense in case of other heartbeat sensitive SMTs.", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r480764994", "createdAt": "2020-09-01T04:16:17Z", "author": {"login": "jpechane"}, "path": "debezium-core/src/main/java/io/debezium/transforms/outbox/EventRouter.java", "diffHunk": "@@ -81,6 +81,9 @@ public R apply(R r) {\n         // Ignoring messages which do not adhere to the CDC Envelope, for instance:\n         // Heartbeat and Schema Change messages\n         if (!smtManager.isValidEnvelope(r)) {\n+            if (smtManager.isHeartbeat(r)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NTA2NjEy", "url": "https://github.com/debezium/debezium/pull/1771#pullrequestreview-479506612", "createdAt": "2020-09-01T08:20:23Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwODoyMDoyNFrOHKrZXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwODoyNDoxNlrOHKrixw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk1ODgxNA==", "bodyText": "Why is it that heartbeats are skipped? They should be passed on unmodified (i.e. as it was before), as otherwise people would e.g. run into WAL growth issues.", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r480958814", "createdAt": "2020-09-01T08:20:24Z", "author": {"login": "gunnarmorling"}, "path": "debezium-core/src/main/java/io/debezium/transforms/outbox/EventRouter.java", "diffHunk": "@@ -81,6 +81,9 @@ public R apply(R r) {\n         // Ignoring messages which do not adhere to the CDC Envelope, for instance:\n         // Heartbeat and Schema Change messages\n         if (!smtManager.isValidEnvelope(r)) {\n+            if (smtManager.isHeartbeat(r)) {\n+                return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk2MDk4MQ==", "bodyText": "+1, I like that idea.", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r480960981", "createdAt": "2020-09-01T08:23:57Z", "author": {"login": "gunnarmorling"}, "path": "debezium-core/src/main/java/io/debezium/transforms/outbox/EventRouter.java", "diffHunk": "@@ -81,6 +81,9 @@ public R apply(R r) {\n         // Ignoring messages which do not adhere to the CDC Envelope, for instance:\n         // Heartbeat and Schema Change messages\n         if (!smtManager.isValidEnvelope(r)) {\n+            if (smtManager.isHeartbeat(r)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDc2NDk5NA=="}, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk2MTIyMw==", "bodyText": "See above; I don't think this behavioral change should be done.", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r480961223", "createdAt": "2020-09-01T08:24:16Z", "author": {"login": "gunnarmorling"}, "path": "debezium-core/src/test/java/io/debezium/transforms/outbox/EventRouterTest.java", "diffHunk": "@@ -172,7 +172,7 @@ public void canSkipMessagesWithoutDebeziumCdcEnvelopeDueToMissingSchemaNameSuffi\n \n         final SourceRecord eventRouted = router.apply(eventRecord);\n \n-        assertThat(eventRouted).isSameAs(eventRecord);\n+        assertThat(eventRouted).isNull();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42729b0ec19dc067e015955556d294b066a55980", "author": {"user": {"login": "Naros", "name": "Chris Cranford"}}, "url": "https://github.com/debezium/debezium/commit/42729b0ec19dc067e015955556d294b066a55980", "committedDate": "2020-09-23T14:29:33Z", "message": "DBZ-2396 Support Converter delegation in ByteBufferConverter\n\nIn the even that the value supplied to the ByteBufferConverter\nis not supported, e.g. not BYTES, the converter should then\nsupport delegation to a configured converter."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "42729b0ec19dc067e015955556d294b066a55980", "author": {"user": {"login": "Naros", "name": "Chris Cranford"}}, "url": "https://github.com/debezium/debezium/commit/42729b0ec19dc067e015955556d294b066a55980", "committedDate": "2020-09-23T14:29:33Z", "message": "DBZ-2396 Support Converter delegation in ByteBufferConverter\n\nIn the even that the value supplied to the ByteBufferConverter\nis not supported, e.g. not BYTES, the converter should then\nsupport delegation to a configured converter."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NzgxOTE0", "url": "https://github.com/debezium/debezium/pull/1771#pullrequestreview-494781914", "createdAt": "2020-09-23T15:25:01Z", "commit": {"oid": "42729b0ec19dc067e015955556d294b066a55980"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNToyNTowMVrOHW0FAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNToyNjowMFrOHW0H9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4Mzk2OQ==", "bodyText": "Could you add a test for specifying an option, e.g. include.schema set to false for the JSON converter?", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r493683969", "createdAt": "2020-09-23T15:25:01Z", "author": {"login": "gunnarmorling"}, "path": "debezium-core/src/test/java/io/debezium/converters/ByteBufferConverterTest.java", "diffHunk": "@@ -97,4 +101,35 @@ public void shouldConvertToConnectDataForNullValue() {\n         assertThat(schemaAndValue.schema()).isEqualTo(Schema.OPTIONAL_BYTES_SCHEMA);\n         assertThat(schemaAndValue.value()).isNull();\n     }\n+\n+    @Test\n+    public void shouldThrowWhenNoDelegateConverterConfigured() {\n+        try {\n+            converter.fromConnectData(TOPIC, Schema.OPTIONAL_STRING_SCHEMA, \"Hello World\");\n+            fail(\"now expected exception thrown\");\n+        }\n+        catch (Exception e) {\n+            assertThat(e).isExactlyInstanceOf(DataException.class);\n+        }\n+    }\n+\n+    @Test\n+    public void shouldConvertUsingDelegateConverter() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42729b0ec19dc067e015955556d294b066a55980"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4NDcyNw==", "bodyText": "It's not only about heartbeats, but also TX metadata and schema change history (for those connectors supporting it).\nDocs should also mention how the delegate converter is configured (see my comment on testing above).", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r493684727", "createdAt": "2020-09-23T15:26:00Z", "author": {"login": "gunnarmorling"}, "path": "documentation/modules/ROOT/pages/configuration/outbox-event-router.adoc", "diffHunk": "@@ -205,6 +205,12 @@ transforms.outbox.type=io.debezium.transforms.outbox.EventRouter\n value.converter=io.debezium.converters.ByteBufferConverter\n ----\n \n+[WARNING]\n+====\n+If the connector is configured to emit heartbeat events, an additional configuration option `value.converter.delegate.converter.type` will be required.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42729b0ec19dc067e015955556d294b066a55980"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dbbc348fe10a20f2f507aad192bcc47e4e4e98d", "author": {"user": {"login": "Naros", "name": "Chris Cranford"}}, "url": "https://github.com/debezium/debezium/commit/1dbbc348fe10a20f2f507aad192bcc47e4e4e98d", "committedDate": "2020-09-23T20:25:59Z", "message": "DBZ-2396 Suggested changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MjMzNDg0", "url": "https://github.com/debezium/debezium/pull/1771#pullrequestreview-495233484", "createdAt": "2020-09-24T05:40:13Z", "commit": {"oid": "1dbbc348fe10a20f2f507aad192bcc47e4e4e98d"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwNTo0MDoxM1rOHXKc5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwNTo0MDozOVrOHXKdeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA1MDUzNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The {prodname} connector may be configured to emit heartbeat, transaction metadata, or schena change events (support varies by connector).\n          \n          \n            \n            The {prodname} connectors may be configured to emit heartbeat, transaction metadata, or schema change events (support varies by connector).", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r494050535", "createdAt": "2020-09-24T05:40:13Z", "author": {"login": "gunnarmorling"}, "path": "documentation/modules/ROOT/pages/configuration/outbox-event-router.adoc", "diffHunk": "@@ -208,6 +208,22 @@ value.converter=io.debezium.converters.ByteBufferConverter\n By default, the `payload` column value (the Avro data) is the only message value.\n Configuration of `ByteBufferConverter` as the value converter propagates the `payload` column value as-is into the Kafka message value.\n \n+The {prodname} connector may be configured to emit heartbeat, transaction metadata, or schena change events (support varies by connector).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dbbc348fe10a20f2f507aad192bcc47e4e4e98d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA1MDY4MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            If any extra configuration options are needed by the converter, they can also be specified, such as the disablement of schemas show above using `schemas.enable=false`.\n          \n          \n            \n            If any extra configuration options are needed by the converter, they can also be specified, such as the disablement of schemas shown above using `schemas.enable=false`.", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r494050680", "createdAt": "2020-09-24T05:40:39Z", "author": {"login": "gunnarmorling"}, "path": "documentation/modules/ROOT/pages/configuration/outbox-event-router.adoc", "diffHunk": "@@ -208,6 +208,22 @@ value.converter=io.debezium.converters.ByteBufferConverter\n By default, the `payload` column value (the Avro data) is the only message value.\n Configuration of `ByteBufferConverter` as the value converter propagates the `payload` column value as-is into the Kafka message value.\n \n+The {prodname} connector may be configured to emit heartbeat, transaction metadata, or schena change events (support varies by connector).\n+These events cannot be serialized by the `ByteBufferConverter` so additional configuration must be provided so the converter knows how to serialize these events.\n+As an example, the following configuration illustrates using the Apache Kafka `JsonConverter` with no schemas:\n+\n+[source]\n+----\n+transforms=outbox,...\n+transforms.outbox.type=io.debezium.transforms.outbox.EventRouter\n+value.converter=io.debezium.converters.ByteBufferConverter\n+value.converter.delegate.converter.type=org.apache.kafka.connect.json.JsonConverter\n+value.converter.delegate.converter.type.schemas.enable=false\n+----\n+\n+The delegate `Converter` implementation is specified by the `delegate.converter.type` option.\n+If any extra configuration options are needed by the converter, they can also be specified, such as the disablement of schemas show above using `schemas.enable=false`.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dbbc348fe10a20f2f507aad192bcc47e4e4e98d"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5d5b76ede9626abca1c0b57c0153034811e855d", "author": {"user": {"login": "gunnarmorling", "name": "Gunnar Morling"}}, "url": "https://github.com/debezium/debezium/commit/d5d5b76ede9626abca1c0b57c0153034811e855d", "committedDate": "2020-09-24T05:41:20Z", "message": "DBZ-2396 Typo fixes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2393, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}