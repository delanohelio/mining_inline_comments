{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4NjE5NDYz", "number": 1938, "title": "DBZ-2580 Fix \"The primary key cannot reference a non-existant column\" error", "bodyText": "DBZ-2580 Fix \"The primary key cannot reference a non-existant column\" error from MySQL DDL parser when CREATE TABLE statement starts with a primary key definition like\nCREATE TABLE Products (\n    PRIMARY KEY (id),\n ...\n)\n\nwhere the referenced primary key column is not yet defined.\ncloses https://issues.redhat.com/browse/DBZ-2580", "createdAt": "2020-11-10T16:41:55Z", "url": "https://github.com/debezium/debezium/pull/1938", "merged": true, "mergeCommit": {"oid": "a61197926880991c45c247c1fb0fab47e9718afc"}, "closed": true, "closedAt": "2020-11-12T06:42:49Z", "author": {"login": "rk3rn3r"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbMQWzgBqjM5Nzk5MjYzNDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbbjNSgBqjM5ODMyMjE5Njc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NDA1ODkz", "url": "https://github.com/debezium/debezium/pull/1938#pullrequestreview-527405893", "createdAt": "2020-11-10T16:52:08Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNjo1MjowOFrOHwl8ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNjo1MjowOFrOHwl8ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcxNTM4Nw==", "bodyText": "I decided to just log an error here. But maybe we can throw the previous IllegalArgumentException here. This should not happen from a proper captured DB schema, the reason can either be a bug in callers or a bug in the DDL parser logic. WDYT?", "url": "https://github.com/debezium/debezium/pull/1938#discussion_r520715387", "createdAt": "2020-11-10T16:52:08Z", "author": {"login": "rk3rn3r"}, "path": "debezium-core/src/main/java/io/debezium/relational/TableEditorImpl.java", "diffHunk": "@@ -92,47 +96,30 @@ public TableEditor setColumns(Column... columns) {\n     public TableEditor setColumns(Iterable<Column> columns) {\n         sortedColumns.clear();\n         addColumns(columns);\n-        updatePrimaryKeys();\n         assert positionsAreValid();\n         return this;\n     }\n \n     protected void updatePrimaryKeys() {\n-        // table does not have any primary key, no need to update\n-        if (uniqueValues) {\n-            return;\n-        }\n-        Iterator<String> nameIter = this.pkColumnNames.iterator();\n-        while (nameIter.hasNext()) {\n-            String pkColumnName = nameIter.next();\n-            if (!hasColumnWithName(pkColumnName)) {\n-                nameIter.remove();\n-            }\n+        if (!uniqueValues) {\n+            // table does have any primary key --> we need to remove it\n+            this.pkColumnNames.removeIf(pkColumnName -> {\n+                boolean pkColumnDoesNotExists = !hasColumnWithName(pkColumnName);\n+                if (pkColumnDoesNotExists) {\n+                    LOGGER.warn(\"The column \\\"\" + pkColumnName + \"\\\" is referenced as PRIMARY KEY, but a matching column is not defined in table \\\"\" + tableId() + \"\\\"!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c13440e562a2d5cfb6e40d720190860edd295441", "author": {"user": {"login": "rk3rn3r", "name": "Ren\u00e9 Kerner"}}, "url": "https://github.com/debezium/debezium/commit/c13440e562a2d5cfb6e40d720190860edd295441", "committedDate": "2020-11-10T16:58:04Z", "message": "DBZ-2580 Fix \"The primary key cannot reference a non-existant column\" error from MySQL DDL parser when CREATE TABLE statement starts with a primary key definition like \"CREATE TABLE Products (PRIMARY KEY (id), ...\" where the referenced primary key column is not yet defined"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "c13440e562a2d5cfb6e40d720190860edd295441", "author": {"user": {"login": "rk3rn3r", "name": "Ren\u00e9 Kerner"}}, "url": "https://github.com/debezium/debezium/commit/c13440e562a2d5cfb6e40d720190860edd295441", "committedDate": "2020-11-10T16:58:04Z", "message": "DBZ-2580 Fix \"The primary key cannot reference a non-existant column\" error from MySQL DDL parser when CREATE TABLE statement starts with a primary key definition like \"CREATE TABLE Products (PRIMARY KEY (id), ...\" where the referenced primary key column is not yet defined"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4ef608a94b3ceb51ba61a70d6142834ef1b9b73", "author": {"user": {"login": "rk3rn3r", "name": "Ren\u00e9 Kerner"}}, "url": "https://github.com/debezium/debezium/commit/e4ef608a94b3ceb51ba61a70d6142834ef1b9b73", "committedDate": "2020-11-11T10:38:53Z", "message": "DBZ-2580 apply PR feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "e4ef608a94b3ceb51ba61a70d6142834ef1b9b73", "author": {"user": {"login": "rk3rn3r", "name": "Ren\u00e9 Kerner"}}, "url": "https://github.com/debezium/debezium/commit/e4ef608a94b3ceb51ba61a70d6142834ef1b9b73", "committedDate": "2020-11-11T10:38:53Z", "message": "DBZ-2580 apply PR feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2367, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}