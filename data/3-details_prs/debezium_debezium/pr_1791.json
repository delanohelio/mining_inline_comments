{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgwODczNTI0", "number": 1791, "title": "DBZ-2456 selective snapshot implementation", "bodyText": "https://issues.redhat.com/browse/DBZ-2456\nHi @jpechane, @gunnarmorling as per your comments on #1766. I have re-modeled the change to include a property snapshot.table, which would allow for selectively taking the snapshot and is honored by all types of connectors. So Effectively only the subset of tables specified in the above configuration are considered for snapshots and are locked, post which streaming resumes. Could you please check and let me know if this suffices.\nMy apologies for creating a new PR as I had some problems in merging the refs from upstream.", "createdAt": "2020-09-06T19:49:54Z", "url": "https://github.com/debezium/debezium/pull/1791", "merged": true, "mergeCommit": {"oid": "fcb5c8d2528dfc117e59bb1bcc77b0cb5f4c6bea"}, "closed": true, "closedAt": "2020-10-16T08:13:49Z", "author": {"login": "KaushikIyer16"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJDilvgFqTQ4ODQ0MTc1Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdRZt7-gBqjM4NjM0MDM1NjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NDQxNzU2", "url": "https://github.com/debezium/debezium/pull/1791#pullrequestreview-488441756", "createdAt": "2020-09-15T08:22:40Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwODoyMjo0MFrOHR2awg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwODoyOToxM1rOHR2rng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ3OTQyNg==", "bodyText": "This could need some streamlining with existing option names and structures. How about \"table.snapshot.include.list\" as a name? And making it a list of regexps, as is done for the other similar options?", "url": "https://github.com/debezium/debezium/pull/1791#discussion_r488479426", "createdAt": "2020-09-15T08:22:40Z", "author": {"login": "gunnarmorling"}, "path": "debezium-core/src/main/java/io/debezium/config/CommonConnectorConfig.java", "diffHunk": "@@ -308,6 +310,14 @@ public static BinaryHandlingMode parse(String value, String defaultValue) {\n             .withDescription(\"The maximum number of records that should be loaded into memory while performing a snapshot\")\n             .withValidation(Field::isNonNegativeInteger);\n \n+    public static final Field SNAPSHOT_MODE_TABLES = Field.create(\"snapshot.table\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ3OTQ3OQ==", "bodyText": "Needs updating", "url": "https://github.com/debezium/debezium/pull/1791#discussion_r488479479", "createdAt": "2020-09-15T08:22:46Z", "author": {"login": "gunnarmorling"}, "path": "debezium-core/src/main/java/io/debezium/config/CommonConnectorConfig.java", "diffHunk": "@@ -308,6 +310,14 @@ public static BinaryHandlingMode parse(String value, String defaultValue) {\n             .withDescription(\"The maximum number of records that should be loaded into memory while performing a snapshot\")\n             .withValidation(Field::isNonNegativeInteger);\n \n+    public static final Field SNAPSHOT_MODE_TABLES = Field.create(\"snapshot.table\")\n+            .withDisplayName(\"Snapshot Mode Custom Tables\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ4MDM5Mg==", "bodyText": "How about getTablesToBeSnapshotted()?", "url": "https://github.com/debezium/debezium/pull/1791#discussion_r488480392", "createdAt": "2020-09-15T08:24:11Z", "author": {"login": "gunnarmorling"}, "path": "debezium-core/src/main/java/io/debezium/config/CommonConnectorConfig.java", "diffHunk": "@@ -524,6 +535,12 @@ public boolean getSanitizeFieldNames() {\n         }\n     }\n \n+    public Set<String> getSnapshotAllowedTables() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ4MDg5MQ==", "bodyText": "determineDataCollectionsToBeSnapshotted().", "url": "https://github.com/debezium/debezium/pull/1791#discussion_r488480891", "createdAt": "2020-09-15T08:25:00Z", "author": {"login": "gunnarmorling"}, "path": "debezium-core/src/main/java/io/debezium/pipeline/source/AbstractSnapshotChangeEventSource.java", "diffHunk": "@@ -81,6 +84,18 @@ public SnapshotResult execute(ChangeEventSourceContext context) throws Interrupt\n         }\n     }\n \n+    protected <T extends DataCollectionId> Set<T> determineAllowedDataCollectionsForSnapshot(final Set<T> allDataCollections) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ4MTgxNA==", "bodyText": "Could you add the @FixFor annotation (here and elsewhere)?", "url": "https://github.com/debezium/debezium/pull/1791#discussion_r488481814", "createdAt": "2020-09-15T08:26:18Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresConnectorIT.java", "diffHunk": "@@ -1157,6 +1157,57 @@ public void shouldAllowForCustomSnapshot() throws InterruptedException {\n         VerifyRecord.isValidRead(s2recs.get(1), PK_FIELD, 2);\n     }\n \n+    @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ4MjkyMA==", "bodyText": "Wow, that's quite something. @jpechane, I think that's good, a bit hard to believe we locked indeed all tables before? Thinking of it, wasn't there even a report related to this?", "url": "https://github.com/debezium/debezium/pull/1791#discussion_r488482920", "createdAt": "2020-09-15T08:27:57Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/PostgresSnapshotChangeEventSource.java", "diffHunk": "@@ -94,7 +94,7 @@ protected void connectionCreated(RelationalSnapshotContext snapshotContext) thro\n     protected void lockTablesForSchemaSnapshot(ChangeEventSourceContext sourceContext, RelationalSnapshotContext snapshotContext)\n             throws SQLException, InterruptedException {\n         final Duration lockTimeout = connectorConfig.snapshotLockTimeout();\n-        final Optional<String> lockStatement = snapshotter.snapshotTableLockingStatement(lockTimeout, schema.tableIds());\n+        final Optional<String> lockStatement = snapshotter.snapshotTableLockingStatement(lockTimeout, snapshotContext.capturedTables);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ4Mzc0Mg==", "bodyText": "Interesting style. Is there a reason for making this a predicate instead of simply a private method which takes the table id?", "url": "https://github.com/debezium/debezium/pull/1791#discussion_r488483742", "createdAt": "2020-09-15T08:29:13Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-mysql/src/main/java/io/debezium/connector/mysql/SnapshotReader.java", "diffHunk": "@@ -254,6 +255,9 @@ protected void execute() {\n         final List<TableId> tablesToSnapshotSchemaAfterUnlock = new ArrayList<>();\n         Set<TableId> lockedTables = Collections.emptySet();\n \n+        final Set<String> snapshotAllowedTables = context.getConnectorConfig().getSnapshotAllowedTables();\n+        final Predicate<TableId> isAllowedForSnapshot = tableId -> snapshotAllowedTables.size() == 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NDY1MDI4", "url": "https://github.com/debezium/debezium/pull/1791#pullrequestreview-488465028", "createdAt": "2020-09-15T08:50:51Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwODo1MDo1MVrOHR3hsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwODo1MDo1MVrOHR3hsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ5NzU4Ng==", "bodyText": "Please remove the empty comment", "url": "https://github.com/debezium/debezium/pull/1791#discussion_r488497586", "createdAt": "2020-09-15T08:50:51Z", "author": {"login": "jpechane"}, "path": "debezium-connector-mysql/src/main/java/io/debezium/connector/mysql/SnapshotReader.java", "diffHunk": "@@ -404,7 +408,8 @@ protected void execute() {\n                                 else {\n                                     logger.info(\"\\t '{}' is not added among known tables\", id);\n                                 }\n-                                if (filters.tableFilter().test(id)) {\n+                                //", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NDY2ODQz", "url": "https://github.com/debezium/debezium/pull/1791#pullrequestreview-488466843", "createdAt": "2020-09-15T08:53:01Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwODo1MzowMlrOHR3nDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwODo1MzowMlrOHR3nDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ5ODk1OQ==", "bodyText": "Can't we use different name like snapshot.data.collection to encompass both tables and MongoDB collections?", "url": "https://github.com/debezium/debezium/pull/1791#discussion_r488498959", "createdAt": "2020-09-15T08:53:02Z", "author": {"login": "jpechane"}, "path": "debezium-core/src/main/java/io/debezium/config/CommonConnectorConfig.java", "diffHunk": "@@ -308,6 +310,14 @@ public static BinaryHandlingMode parse(String value, String defaultValue) {\n             .withDescription(\"The maximum number of records that should be loaded into memory while performing a snapshot\")\n             .withValidation(Field::isNonNegativeInteger);\n \n+    public static final Field SNAPSHOT_MODE_TABLES = Field.create(\"snapshot.table\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NDY4NDQ0", "url": "https://github.com/debezium/debezium/pull/1791#pullrequestreview-488468444", "createdAt": "2020-09-15T08:54:51Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwODo1NDo1MVrOHR3r6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwODo1NDo1MVrOHR3r6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwMDIwMg==", "bodyText": "Again, should use generic names like snapshotAllowedDataCollections", "url": "https://github.com/debezium/debezium/pull/1791#discussion_r488500202", "createdAt": "2020-09-15T08:54:51Z", "author": {"login": "jpechane"}, "path": "debezium-core/src/main/java/io/debezium/pipeline/source/AbstractSnapshotChangeEventSource.java", "diffHunk": "@@ -81,6 +84,18 @@ public SnapshotResult execute(ChangeEventSourceContext context) throws Interrupt\n         }\n     }\n \n+    protected <T extends DataCollectionId> Set<T> determineAllowedDataCollectionsForSnapshot(final Set<T> allDataCollections) {\n+        final Set<String> snapshotAllowedTables = connectorConfig.getSnapshotAllowedTables();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NDcwMjAy", "url": "https://github.com/debezium/debezium/pull/1791#pullrequestreview-488470202", "createdAt": "2020-09-15T08:56:58Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwODo1Njo1OVrOHR3xYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwODo1Njo1OVrOHR3xYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwMTYwMw==", "bodyText": "There is a planned Jira for snapshotting collections based on the include list order. Could we keep this as a List?", "url": "https://github.com/debezium/debezium/pull/1791#discussion_r488501603", "createdAt": "2020-09-15T08:56:59Z", "author": {"login": "jpechane"}, "path": "debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoDbSnapshotChangeEventSource.java", "diffHunk": "@@ -342,7 +343,7 @@ private void createDataEventsForReplicaSet(ChangeEventSourceContext sourceContex\n \n         LOGGER.info(\"Beginning snapshot of '{}' at {}\", rsName, rsOffsetContext.getOffset());\n \n-        final List<CollectionId> collections = primaryClient.collections();\n+        final Set<CollectionId> collections = determineAllowedDataCollectionsForSnapshot(primaryClient.collections());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "91ec934f1bffd4dbf5ab1d4498ac01f2197802e7", "author": {"user": {"login": "KaushikIyer16", "name": "Kaushik N S Iyer"}}, "url": "https://github.com/debezium/debezium/commit/91ec934f1bffd4dbf5ab1d4498ac01f2197802e7", "committedDate": "2020-10-11T06:45:50Z", "message": "DBZ-2456 selective snapshot implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "355f57bb945750cdb7bbfe98561d6b2a81fa2b80", "author": {"user": {"login": "KaushikIyer16", "name": "Kaushik N S Iyer"}}, "url": "https://github.com/debezium/debezium/commit/355f57bb945750cdb7bbfe98561d6b2a81fa2b80", "committedDate": "2020-10-11T06:45:50Z", "message": "DBZ-2456 style change fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "922ca872dca3f165364731893d8204652ac3aade", "author": {"user": {"login": "KaushikIyer16", "name": "Kaushik N S Iyer"}}, "url": "https://github.com/debezium/debezium/commit/922ca872dca3f165364731893d8204652ac3aade", "committedDate": "2020-10-11T06:45:50Z", "message": "DBZ-2456 updated common connector config with generalized naming"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b396d014ffe77030c36d6b69d501c5606276be46", "author": {"user": {"login": "KaushikIyer16", "name": "Kaushik N S Iyer"}}, "url": "https://github.com/debezium/debezium/commit/b396d014ffe77030c36d6b69d501c5606276be46", "committedDate": "2020-10-11T06:45:50Z", "message": "DBZ-2456 style change fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0381bdd7fce502dbb31b0ec8836cf082bd7f455b", "author": {"user": {"login": "KaushikIyer16", "name": "Kaushik N S Iyer"}}, "url": "https://github.com/debezium/debezium/commit/0381bdd7fce502dbb31b0ec8836cf082bd7f455b", "committedDate": "2020-10-11T06:45:57Z", "message": "DBZ-2456 selective snapshot rebase fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b7594e6fc174471299c81bf4a901c43616903d8", "author": {"user": {"login": "KaushikIyer16", "name": "Kaushik N S Iyer"}}, "url": "https://github.com/debezium/debezium/commit/6b7594e6fc174471299c81bf4a901c43616903d8", "committedDate": "2020-10-11T06:46:32Z", "message": "DBZ-2456 fixes after rebase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef23701c757841b5dfdc27fac753553475c6b6ef", "author": {"user": {"login": "KaushikIyer16", "name": "Kaushik N S Iyer"}}, "url": "https://github.com/debezium/debezium/commit/ef23701c757841b5dfdc27fac753553475c6b6ef", "committedDate": "2020-10-11T06:49:05Z", "message": "DBZ-2456 rebase documentation fixes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "ef23701c757841b5dfdc27fac753553475c6b6ef", "author": {"user": {"login": "KaushikIyer16", "name": "Kaushik N S Iyer"}}, "url": "https://github.com/debezium/debezium/commit/ef23701c757841b5dfdc27fac753553475c6b6ef", "committedDate": "2020-10-11T06:49:05Z", "message": "DBZ-2456 rebase documentation fixes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2406, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}