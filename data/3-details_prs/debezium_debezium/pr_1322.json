{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MTU3ODU0", "number": 1322, "title": "DBZ-1730 Stream from replica slot position not end of tx log", "bodyText": "https://issues.redhat.com/browse/DBZ-1730", "createdAt": "2020-03-10T14:13:17Z", "url": "https://github.com/debezium/debezium/pull/1322", "merged": true, "mergeCommit": {"oid": "4ffed1fa465354a364be6116f3cefc3515bb51ab"}, "closed": true, "closedAt": "2020-03-13T08:39:24Z", "author": {"login": "jpechane"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMTSxAAFqTM3MTk5NzE3MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNLg3UgBqjMxMjU3MjQ0NjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxOTk3MTcw", "url": "https://github.com/debezium/debezium/pull/1322#pullrequestreview-371997170", "createdAt": "2020-03-10T14:21:52Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDoyMTo1MlrOF0RBJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDoyMTo1MlrOF0RBJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM0OTA5Mw==", "bodyText": "Do you also need to change this a few lines down?\nthis.lastCompletelyProcessedLsn = offsetContext.lsn();", "url": "https://github.com/debezium/debezium/pull/1322#discussion_r390349093", "createdAt": "2020-03-10T14:21:52Z", "author": {"login": "cjbooms"}, "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/PostgresStreamingChangeEventSource.java", "diffHunk": "@@ -92,7 +96,7 @@ public void execute(ChangeEventSourceContext context) throws InterruptedExceptio\n         }\n \n         try {\n-            if (offsetContext.hasLastKnownPosition()) {\n+            if (hasStartLsnStoredInContext) {\n                 // start streaming from the last recorded position in the offset\n                 final Long lsn = offsetContext.lastCompletelyProcessedLsn() != null ? offsetContext.lastCompletelyProcessedLsn() : offsetContext.lsn();\n                 if (LOGGER.isDebugEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "b5f2db3be47a35d1761accb694b38e6718f0e2db", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/b5f2db3be47a35d1761accb694b38e6718f0e2db", "committedDate": "2020-03-10T14:51:18Z", "message": "DBZ-1730 Stream from replica slot position not end of tx log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMzc1NDcx", "url": "https://github.com/debezium/debezium/pull/1322#pullrequestreview-372375471", "createdAt": "2020-03-10T22:53:42Z", "commit": {"oid": "b5f2db3be47a35d1761accb694b38e6718f0e2db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMjo1Mzo0MlrOF0j0mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMjo1Mzo0MlrOF0j0mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY1NzE3OQ==", "bodyText": "This looks good to me. I had hoped you could instead create an initial empty context here, but my attempt to do so caused test failures.", "url": "https://github.com/debezium/debezium/pull/1322#discussion_r390657179", "createdAt": "2020-03-10T22:53:42Z", "author": {"login": "cjbooms"}, "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/PostgresStreamingChangeEventSource.java", "diffHunk": "@@ -78,6 +79,9 @@ public PostgresStreamingChangeEventSource(PostgresConnectorConfig connectorConfi\n         this.clock = clock;\n         this.schema = schema;\n         this.offsetContext = (offsetContext != null) ? offsetContext : PostgresOffsetContext.initialContext(connectorConfig, connection, clock);\n+        // replication slot could exist at the time of starting Debezium so we will stream from the position in the slot\n+        // instead of the last position in the database\n+        this.hasStartLsnStoredInContext = (offsetContext != null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5f2db3be47a35d1761accb694b38e6718f0e2db"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMzc2NDIz", "url": "https://github.com/debezium/debezium/pull/1322#pullrequestreview-372376423", "createdAt": "2020-03-10T22:56:02Z", "commit": {"oid": "b5f2db3be47a35d1761accb694b38e6718f0e2db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMjo1NjowMlrOF0j3xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMjo1NjowMlrOF0j3xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY1Nzk5MA==", "bodyText": "In fact I think you will always get one duplicate record re-emitted due to this logic, which disables skipping of the first flushed record:\n        boolean skipFirstFlushRecord = true;\n        initConnection();\n\n        connect();\n        if (offset == null || offset <= 0) {\n            offset = defaultStartingPos;\n            skipFirstFlushRecord = false;\n        }", "url": "https://github.com/debezium/debezium/pull/1322#discussion_r390657990", "createdAt": "2020-03-10T22:56:02Z", "author": {"login": "cjbooms"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/RecordsStreamProducerIT.java", "diffHunk": "@@ -1613,6 +1616,39 @@ public void stopInTheMiddleOfTxAndResume() throws Exception {\n         }\n     }\n \n+    @Test\n+    @FixFor(\"DBZ-1730\")\n+    public void shouldStartConsumingFromSlotLocation() throws Exception {\n+        Testing.Print.enable();\n+\n+        startConnector(config -> config\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, false)\n+                .with(EmbeddedEngine.OFFSET_STORAGE, MemoryOffsetBackingStore.class), true);\n+        waitForStreamingToStart();\n+\n+        consumer = testConsumer(1);\n+        executeAndWait(\"INSERT INTO test_table (text) VALUES ('insert2')\");\n+        consumer.remove();\n+\n+        stopConnector();\n+        TestHelper.execute(\n+                \"INSERT INTO test_table (text) VALUES ('insert3');\",\n+                \"INSERT INTO test_table (text) VALUES ('insert4')\");\n+        startConnector(config -> config\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, true)\n+                .with(PostgresConnectorConfig.SNAPSHOT_MODE, PostgresConnectorConfig.SnapshotMode.NEVER)\n+                .with(EmbeddedEngine.OFFSET_STORAGE, MemoryOffsetBackingStore.class), false);\n+\n+        consumer.expects(2);\n+        consumer.await(TestHelper.waitTimeForRecords() * 5, TimeUnit.SECONDS);\n+\n+        // We cannot guarantee the flush timing so it is possible that insert2 record will be redelivered\n+        Assertions.assertThat(((Struct) consumer.remove().value()).getStruct(\"after\").getString(\"text\")).isIn(Collect.unmodifiableSet(\"insert2\", \"insert3\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5f2db3be47a35d1761accb694b38e6718f0e2db"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e42dfce810c810255d0f149aa933129e9111666f", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/e42dfce810c810255d0f149aa933129e9111666f", "committedDate": "2020-03-12T14:20:13Z", "message": "DBZ-1730 Stream from replica slot position not end of tx log"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5f2db3be47a35d1761accb694b38e6718f0e2db", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/b5f2db3be47a35d1761accb694b38e6718f0e2db", "committedDate": "2020-03-10T14:51:18Z", "message": "DBZ-1730 Stream from replica slot position not end of tx log"}, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "95b55ffaf64fe7bd28039c3cf7235d37f772395e", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/95b55ffaf64fe7bd28039c3cf7235d37f772395e", "committedDate": "2020-03-12T15:25:05Z", "message": "DBZ-1730 Improve test limits description"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "95b55ffaf64fe7bd28039c3cf7235d37f772395e", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/95b55ffaf64fe7bd28039c3cf7235d37f772395e", "committedDate": "2020-03-12T15:25:05Z", "message": "DBZ-1730 Improve test limits description"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "95b55ffaf64fe7bd28039c3cf7235d37f772395e", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/95b55ffaf64fe7bd28039c3cf7235d37f772395e", "committedDate": "2020-03-12T15:25:05Z", "message": "DBZ-1730 Improve test limits description"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2125, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}