{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4NjQ4MjUx", "number": 1983, "title": "DBZ-2698 Added support for null default value for types int, bigint, smallint, tinyint, float, real", "bodyText": "https://issues.redhat.com/browse/DBZ-2698\nDBZ-2698 Added support for null default value for types int, bigint, smallint, tinyint, float, real", "createdAt": "2020-11-27T14:37:57Z", "url": "https://github.com/debezium/debezium/pull/1983", "merged": true, "mergeCommit": {"oid": "8cd2da3bfb499db7827ef2c6c35c5bde9248d696"}, "closed": true, "closedAt": "2021-01-19T07:50:48Z", "author": {"login": "zxxz"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhi-54gFqTU0MDc4NDEyNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdxaJvrABqjQyMTkyMTg4ODQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNzg0MTI1", "url": "https://github.com/debezium/debezium/pull/1983#pullrequestreview-540784125", "createdAt": "2020-11-30T10:38:15Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMDozODoxNVrOH71Hjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMDo0MTo1MFrOH71QKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ5ODMxOA==", "bodyText": "Using an inline regexp isn't ideal for this one. At the very least, this should be pre-compiled into a Pattern, but actually, there's a better way:\nLong.parseLong(value.charAt(lastIndex) == '.' ? value.substring(0, lastIndex) : value)\n\nIt's an order of magnitude faster as per a quick JMH benchmark:\nBenchmark                                  Mode  Cnt          Score          Error  Units\nTrimBenchmark.testCompiledRegexp          thrpt    3   46507099,171 \u00b1  3115790,518  ops/s\nTrimBenchmark.testRegexp                  thrpt    3   24495251,001 \u00b1 18640458,291  ops/s\nTrimBenchmark.testSubstringEndsWith       thrpt    3  286420819,975 \u00b1 38003048,105  ops/s\nTrimBenchmark.testSubstringCharAt         thrpt    3  301351671,658 \u00b1 86578981,123  ops/s", "url": "https://github.com/debezium/debezium/pull/1983#discussion_r532498318", "createdAt": "2020-11-30T10:38:15Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerDefaultValueConverter.java", "diffHunk": "@@ -118,19 +118,19 @@ private Object convertDefaultValue(Object defaultValue, Column column) {\n         final Map<String, DefaultValueMapper> result = new HashMap<>();\n \n         // Exact numbers\n-        result.put(\"bigint\", v -> Long.parseLong(v.substring(2, v.length() - 3))); // Sample value: ((3147483648.))\n-        result.put(\"int\", v -> Integer.parseInt(v.substring(2, v.length() - 2))); // Sample value: ((2147483647))\n-        result.put(\"smallint\", v -> Short.parseShort(v.substring(2, v.length() - 2))); // Sample value: ((32767))\n-        result.put(\"tinyint\", v -> Short.parseShort(v.substring(2, v.length() - 2))); // Sample value: ((255))\n+        result.put(\"bigint\", v -> nullableDefaultValueMapper(v, value -> Long.parseLong(value.replaceAll(\"(\\\\.)$\", \"\")))); // Sample value: ((3147483648.))", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ5OTY0NA==", "bodyText": "See above; let's rather use subString().", "url": "https://github.com/debezium/debezium/pull/1983#discussion_r532499644", "createdAt": "2020-11-30T10:40:23Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerDefaultValueConverter.java", "diffHunk": "@@ -178,4 +178,14 @@ private Object convertDefaultValue(Object defaultValue, Column column) {\n         // Other data types, such as cursor, xml or uniqueidentifier, have been omitted.\n         return result;\n     }\n+\n+    public static Object nullableDefaultValueMapper(String v, DefaultValueMapper mapper) throws Exception {\n+        final String value = v.replaceAll(\"^[\\\\(]+|[\\\\)]+$\", \"\"); // trim leading and trailing parenthesis", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjUwMDUyMQ==", "bodyText": "Let's rather use Awaitility with a defined condition (see other tests for examples).", "url": "https://github.com/debezium/debezium/pull/1983#discussion_r532500521", "createdAt": "2020-11-30T10:41:50Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-sqlserver/src/test/java/io/debezium/connector/sqlserver/SqlServerConnectionIT.java", "diffHunk": "@@ -250,6 +250,131 @@ public void shouldProperlyGetDefaultColumnValues() throws Exception {\n         }\n     }\n \n+    @Test\n+    @FixFor(\"DBZ-2698\")\n+    public void shouldProperlyGetDefaultColumnNullValues() throws Exception {\n+        try (SqlServerConnection connection = TestHelper.adminConnection()) {\n+            connection.connect();\n+            connection.execute(\"CREATE DATABASE testDB\");\n+            connection.execute(\"USE testDB\");\n+        }\n+\n+        try (SqlServerConnection connection = TestHelper.testConnection()) {\n+            connection.connect();\n+            // NOTE: you cannot enable CDC on master\n+            TestHelper.enableDbCdc(connection, \"testDB\");\n+\n+            // create table if exists\n+            String sql = \"IF EXISTS (select 1 from sys.objects where name = 'table_with_defaults' and type = 'u')\\n\"\n+                    + \"DROP TABLE testTable\\n\"\n+                    + \"CREATE TABLE testDB.dbo.table_with_defaults (\"\n+                    + \"    int_no_default_not_null int not null,\"\n+                    + \"    int_no_default int,\"\n+                    + \"    int_default_null int default null,\"\n+                    + \"    int_column int default (2147483647),\"\n+\n+                    + \"    bigint_no_default_not_null bigint not null,\"\n+                    + \"    bigint_no_default bigint,\"\n+                    + \"    bigint_default_null bigint default null,\"\n+                    + \"    bigint_column bigint default (3147483648),\"\n+\n+                    + \"    smallint_no_default_not_null smallint not null,\"\n+                    + \"    smallint_no_default smallint,\"\n+                    + \"    smallint_default_null smallint default null,\"\n+                    + \"    smallint_column smallint default (32767),\"\n+\n+                    + \"    tinyint_no_default_not_null tinyint not null,\"\n+                    + \"    tinyint_no_default tinyint,\"\n+                    + \"    tinyint_default_null tinyint default null,\"\n+                    + \"    tinyint_column tinyint default (255),\"\n+\n+                    + \"    float_no_default_not_null float not null,\"\n+                    + \"    float_no_default float,\"\n+                    + \"    float_default_null float default null,\"\n+                    + \"    float_column float default (1.2345e2),\"\n+\n+                    + \"    real_no_default_not_null real not null,\"\n+                    + \"    real_no_default real,\"\n+                    + \"    real_default_null real default null,\"\n+                    + \"    real_column real default (1.2345e3),\"\n+                    + \");\";\n+\n+            connection.execute(sql);\n+\n+            // then enable CDC and wrapper functions\n+            TestHelper.enableTableCdc(connection, \"table_with_defaults\");\n+            // insert some data\n+\n+            // and issue a test call to a CDC wrapper function\n+            Thread.sleep(5_000); // Need to wait to make sure the min_lsn is available", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1875826d3a89e5fc63b2b6bef0b545b7f637be53", "author": {"user": {"login": "zxxz", "name": "Giovanni De Stefano"}}, "url": "https://github.com/debezium/debezium/commit/1875826d3a89e5fc63b2b6bef0b545b7f637be53", "committedDate": "2021-01-18T16:55:56Z", "message": "DBZ-2698 Added support for null default value for types int, bigint, smallint, tinyint, float, real"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cd2da3bfb499db7827ef2c6c35c5bde9248d696", "author": {"user": {"login": "zxxz", "name": "Giovanni De Stefano"}}, "url": "https://github.com/debezium/debezium/commit/8cd2da3bfb499db7827ef2c6c35c5bde9248d696", "committedDate": "2021-01-18T17:04:34Z", "message": "DBZ-2698 Added support for null default value for types int, bigint, smallint, tinyint, float, real"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "8cd2da3bfb499db7827ef2c6c35c5bde9248d696", "author": {"user": {"login": "zxxz", "name": "Giovanni De Stefano"}}, "url": "https://github.com/debezium/debezium/commit/8cd2da3bfb499db7827ef2c6c35c5bde9248d696", "committedDate": "2021-01-18T17:04:34Z", "message": "DBZ-2698 Added support for null default value for types int, bigint, smallint, tinyint, float, real"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2243, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}