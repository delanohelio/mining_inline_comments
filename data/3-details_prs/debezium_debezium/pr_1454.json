{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5NzA0OTYy", "number": 1454, "title": "DBZ-1969 Add support for enum arrays", "bodyText": "https://issues.redhat.com/browse/DBZ-1969", "createdAt": "2020-04-27T19:38:58Z", "url": "https://github.com/debezium/debezium/pull/1454", "merged": true, "mergeCommit": {"oid": "284a4357e01e485a8e4d53b2f7aa46b768a5df78"}, "closed": true, "closedAt": "2020-04-29T17:06:44Z", "author": {"login": "bradengroom"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccLGwlAFqTQwMjIzOTA2OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcca-y8gH2gAyNDA5NzA0OTYyOjYyMmM4ZDY3MmE5NTNjZWRhYTY1YjE3MTEwMTU4ZmY3NDE5MDViOWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMjM5MDY4", "url": "https://github.com/debezium/debezium/pull/1454#pullrequestreview-402239068", "createdAt": "2020-04-28T21:52:17Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMTo1MjoxOFrOGNoYTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMTo1MjoxOFrOGNoYTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk0NjI1NQ==", "bodyText": "This test isn't working for some reason. After adding a bunch of logging, it looks like my type registry is getting cleared out or something. I see the enum array type get added to the type registry, but at some point it is no longer in my type registry. Any ideas here?", "url": "https://github.com/debezium/debezium/pull/1454#discussion_r416946255", "createdAt": "2020-04-28T21:52:18Z", "author": {"login": "bradengroom"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/RecordsStreamProducerIT.java", "diffHunk": "@@ -2088,6 +2088,100 @@ public void shouldStreamEnumAsKnownType() throws Exception {\n         assertThat(consumer.isEmpty()).isTrue();\n     }\n \n+    // @Test\n+    // public void shouldStreamEnumArrayAsKnownType() throws Exception {\n+    // // Specifically enable `column.propagate.source.type` here to validate later that the actual\n+    // // type, length, and scale values are resolved correctly when paired with Enum types.\n+    // TestHelper.execute(\"CREATE TABLE enum_array_table (pk SERIAL, PRIMARY KEY (pk));\");\n+    // startConnector(config -> config\n+    // .with(PostgresConnectorConfig.INCLUDE_UNKNOWN_DATATYPES, true)\n+    // .with(PostgresConnectorConfig.SNAPSHOT_MODE, SnapshotMode.NEVER)\n+    // .with(\"column.propagate.source.type\", \"public.enum_array_table.value\")\n+    // .with(PostgresConnectorConfig.TABLE_WHITELIST, \"public.enum_array_table\"), false);\n+\n+    // waitForStreamingToStart();\n+\n+    // // We create the enum type after streaming started to simulate some future schema change\n+\n+    // TestHelper.execute(\"CREATE TYPE test_type AS ENUM ('V1','V2');\");\n+    // TestHelper.execute(\"ALTER TABLE enum_array_table ADD COLUMN value test_type[] NOT NULL\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMjM5OTMx", "url": "https://github.com/debezium/debezium/pull/1454#pullrequestreview-402239931", "createdAt": "2020-04-28T21:53:52Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMTo1Mzo1MlrOGNoa_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMTo1Mzo1MlrOGNoa_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk0Njk0Mw==", "bodyText": "This is returning false for some reason, but I'm not sure why. The values appear to be the same when I print them:\nvalueSchemasEqual: false\nSCHEMA 1: {\"name\" : \"io.debezium.data.Enum\", \"type\" : \"STRING\", \"optional\" : \"false\", \"version\" : \"1\"}\nSCHEMA 2: {\"name\" : \"io.debezium.data.Enum\", \"type\" : \"STRING\", \"optional\" : \"false\", \"version\" : \"1\"}\n\nAny ideas?", "url": "https://github.com/debezium/debezium/pull/1454#discussion_r416946943", "createdAt": "2020-04-28T21:53:52Z", "author": {"login": "bradengroom"}, "path": "debezium-core/src/test/java/io/debezium/data/VerifyRecord.java", "diffHunk": "@@ -1090,7 +1090,11 @@ private static boolean areConnectSchemasEqual(Schema schema1, Schema schema2) {\n             valueSchemasEqual = Objects.equals(schema1.valueSchema(), schema2.valueSchema());\n         }\n         else if (schema1.type() == Type.ARRAY && schema2.type() == Type.ARRAY) {\n-            valueSchemasEqual = Objects.equals(schema1.valueSchema(), schema2.valueSchema());\n+            // TODO:\n+            // valueSchemasEqual = Objects.equals(schema1.valueSchema(), schema2.valueSchema());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMjQwODA1", "url": "https://github.com/debezium/debezium/pull/1454#pullrequestreview-402240805", "createdAt": "2020-04-28T21:55:33Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMTo1NTozNFrOGNod4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMTo1NTozNFrOGNod4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk0NzY4Mw==", "bodyText": "I had to add this or else my test would just get an array of bytes. It looks like this file is responsible for the protobuf decoder? Do I need to do anything to make sure things work with native logical replication & wal2json?", "url": "https://github.com/debezium/debezium/pull/1454#discussion_r416947683", "createdAt": "2020-04-28T21:55:34Z", "author": {"login": "bradengroom"}, "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/connection/pgproto/PgProtoColumnValue.java", "diffHunk": "@@ -325,6 +325,9 @@ public Object asDefault(TypeRegistry typeRegistry, int columnType, String column\n                 type.getOid() == typeRegistry.hstoreArrayOid()) {\n             return asArray(columnName, type, fullType, connection);\n         }\n+        if (type.isArrayType() && type.getElementType().isEnumType()) {\n+            return asArray(columnName, type, fullType, connection);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNTI0Njg4", "url": "https://github.com/debezium/debezium/pull/1454#pullrequestreview-402524688", "createdAt": "2020-04-29T10:01:23Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxMDowMToyNFrOGN37WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxMDowMToyNFrOGN37WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIwMDk4NA==", "bodyText": "I've pushed a commit for changing the previous string-based comparison to calling this method again for the value schema. It revealed one glitch in the expected schema for the UPDATE case. Could you double-check that last commit I've added? Thanks!", "url": "https://github.com/debezium/debezium/pull/1454#discussion_r417200984", "createdAt": "2020-04-29T10:01:24Z", "author": {"login": "gunnarmorling"}, "path": "debezium-core/src/test/java/io/debezium/data/VerifyRecord.java", "diffHunk": "@@ -1090,7 +1090,7 @@ private static boolean areConnectSchemasEqual(Schema schema1, Schema schema2) {\n             valueSchemasEqual = Objects.equals(schema1.valueSchema(), schema2.valueSchema());\n         }\n         else if (schema1.type() == Type.ARRAY && schema2.type() == Type.ARRAY) {\n-            valueSchemasEqual = Objects.equals(schema1.valueSchema(), schema2.valueSchema());\n+            valueSchemasEqual = areConnectSchemasEqual(schema1.valueSchema(), schema2.valueSchema());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ff60dd30df5e21322734ee4be90a791d2428cc1", "author": {"user": {"login": "bradengroom", "name": "Braden Groom"}}, "url": "https://github.com/debezium/debezium/commit/2ff60dd30df5e21322734ee4be90a791d2428cc1", "committedDate": "2020-04-29T14:52:16Z", "message": "DBZ-1969 Add support for Postgres enum arrays"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ced6dc2276ec53436ad30c08ab562b54451ec7a", "author": {"user": {"login": "gunnarmorling", "name": "Gunnar Morling"}}, "url": "https://github.com/debezium/debezium/commit/8ced6dc2276ec53436ad30c08ab562b54451ec7a", "committedDate": "2020-04-29T14:52:24Z", "message": "DBZ-1969 Simplifying array handling in PgProtoColumnValue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34a8651b60c18a9356dd6fc3b4afd53de7bf74e7", "author": {"user": {"login": "gunnarmorling", "name": "Gunnar Morling"}}, "url": "https://github.com/debezium/debezium/commit/34a8651b60c18a9356dd6fc3b4afd53de7bf74e7", "committedDate": "2020-04-29T14:52:24Z", "message": "DBZ-1969 Fixing incorrect assertion and utility which concealed this"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "34a8651b60c18a9356dd6fc3b4afd53de7bf74e7", "author": {"user": {"login": "gunnarmorling", "name": "Gunnar Morling"}}, "url": "https://github.com/debezium/debezium/commit/34a8651b60c18a9356dd6fc3b4afd53de7bf74e7", "committedDate": "2020-04-29T14:52:24Z", "message": "DBZ-1969 Fixing incorrect assertion and utility which concealed this"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31aafd091a8fcc8f606a00c87377b35d7c010be4", "author": {"user": {"login": "bradengroom", "name": "Braden Groom"}}, "url": "https://github.com/debezium/debezium/commit/31aafd091a8fcc8f606a00c87377b35d7c010be4", "committedDate": "2020-04-29T15:43:08Z", "message": "DBZ-1969 Have isArray return false for Postgres LTree arrays"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "622c8d672a953cedaa65b17110158ff741905b9f", "author": {"user": {"login": "bradengroom", "name": "Braden Groom"}}, "url": "https://github.com/debezium/debezium/commit/622c8d672a953cedaa65b17110158ff741905b9f", "committedDate": "2020-04-29T16:22:05Z", "message": "DBZ-1969 Update convertLtreeArray to handle List instances"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2055, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}