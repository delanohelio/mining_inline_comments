{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5ODU0OTk3", "number": 1347, "title": "DBZ-1857 Support for autorestart for embedded engine", "bodyText": "https://issues.redhat.com/browse/DBZ-1857", "createdAt": "2020-03-17T14:01:21Z", "url": "https://github.com/debezium/debezium/pull/1347", "merged": true, "mergeCommit": {"oid": "32b6a8cb3cb014d6ed675c7f1abcf6eb1ef468f7"}, "closed": true, "closedAt": "2020-03-23T12:56:31Z", "author": {"login": "jpechane"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOkH4ogBqjMxMzc3MzU5NDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQd3ISAFqTM3OTQwMTMzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MzA1MTQ2", "url": "https://github.com/debezium/debezium/pull/1347#pullrequestreview-378305146", "createdAt": "2020-03-20T08:43:14Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwODo0MzoxNVrOF5LUbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwODo0NTowNVrOF5LXYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5ODYwNg==", "bodyText": "This test fails on CI.", "url": "https://github.com/debezium/debezium/pull/1347#discussion_r395498606", "createdAt": "2020-03-20T08:43:15Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresConnectorIT.java", "diffHunk": "@@ -695,6 +697,34 @@ public void shouldResumeSnapshotIfFailingMidstream() throws Exception {\n         TestHelper.dropDefaultReplicationSlot();\n     }\n \n+    @Test\n+    @FixFor(\"DBZ-1857\")\n+    // The column used to kill connection is only supported since Postgres version 10\n+    @SkipWhenDatabaseVersionLessThan(POSTGRES_10)\n+    public void shouldRecoverFromRetriableException() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5OTAzMw==", "bodyText": "I was using something slightly different:\nSELECT  pg_terminate_backend(pid) FROM pg_stat_activity WHERE pid = (SELECT * FROM pg_stat_activity where datname = 'postgres');\n\nCould work on PG 9, too, perhaps?", "url": "https://github.com/debezium/debezium/pull/1347#discussion_r395499033", "createdAt": "2020-03-20T08:44:15Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresConnectorIT.java", "diffHunk": "@@ -695,6 +697,34 @@ public void shouldResumeSnapshotIfFailingMidstream() throws Exception {\n         TestHelper.dropDefaultReplicationSlot();\n     }\n \n+    @Test\n+    @FixFor(\"DBZ-1857\")\n+    // The column used to kill connection is only supported since Postgres version 10\n+    @SkipWhenDatabaseVersionLessThan(POSTGRES_10)\n+    public void shouldRecoverFromRetriableException() throws Exception {\n+        // Testing.Print.enable();\n+        String setupStmt = SETUP_TABLES_STMT;\n+        TestHelper.execute(setupStmt);\n+        Configuration config = TestHelper.defaultConfig()\n+                .with(PostgresConnectorConfig.SNAPSHOT_MODE, SnapshotMode.INITIAL.getValue())\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, Boolean.FALSE)\n+                .build();\n+\n+        start(PostgresConnector.class, config);\n+        assertConnectorIsRunning();\n+        waitForStreamingRunning(\"postgres\", TestHelper.TEST_SERVER);\n+\n+        assertRecordsFromSnapshot(2, 1, 1);\n+\n+        // kill all opened connections to the database\n+        TestHelper.execute(\"SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE backend_type='walsender'\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5OTM2MQ==", "bodyText": "This doesn't do anything; some left-over?", "url": "https://github.com/debezium/debezium/pull/1347#discussion_r395499361", "createdAt": "2020-03-20T08:45:05Z", "author": {"login": "gunnarmorling"}, "path": "debezium-core/src/main/java/io/debezium/connector/common/BaseSourceTask.java", "diffHunk": "@@ -195,6 +195,7 @@ private void stop(boolean restart) {\n \n             if (restart && restartDelay == null) {\n                 restartDelay = ElapsedTimeStrategy.constant(Clock.system(), 10_000);\n+                restartDelay.hasElapsed();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff1e0f1a24043aa15c22e3914ca6a426c8c711d2", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/ff1e0f1a24043aa15c22e3914ca6a426c8c711d2", "committedDate": "2020-03-23T11:05:49Z", "message": "DBZ-1857 Support for autorestart for embedded engine"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "ff1e0f1a24043aa15c22e3914ca6a426c8c711d2", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/ff1e0f1a24043aa15c22e3914ca6a426c8c711d2", "committedDate": "2020-03-23T11:05:49Z", "message": "DBZ-1857 Support for autorestart for embedded engine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4aec59ac4c0ff4519fd7db2459d51c27ef523c43", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/4aec59ac4c0ff4519fd7db2459d51c27ef523c43", "committedDate": "2020-03-23T11:40:37Z", "message": "DBZ-1889 Prevent Connect throttling while connection is down"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5Mzg0NTkz", "url": "https://github.com/debezium/debezium/pull/1347#pullrequestreview-379384593", "createdAt": "2020-03-23T12:32:36Z", "commit": {"oid": "4aec59ac4c0ff4519fd7db2459d51c27ef523c43"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMjozMjozN1rOF6DUHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMjozMjozN1rOF6DUHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQxNjAzMQ==", "bodyText": "Should be Metronome#parker().", "url": "https://github.com/debezium/debezium/pull/1347#discussion_r396416031", "createdAt": "2020-03-23T12:32:37Z", "author": {"login": "gunnarmorling"}, "path": "debezium-core/src/main/java/io/debezium/connector/common/BaseSourceTask.java", "diffHunk": "@@ -117,6 +119,10 @@ public final void start(Map<String, String> props) {\n \n         // in backoff period after a retriable exception\n         if (!started) {\n+            // WorkerSourceTask calls us immediately after we return the empty list.\n+            // This turns into a throttling so we need to make a pause before we return\n+            // the control back.\n+            Thread.sleep(PAUSE_WHEN_NOT_STARTED);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4aec59ac4c0ff4519fd7db2459d51c27ef523c43"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5Mzg1Mjcw", "url": "https://github.com/debezium/debezium/pull/1347#pullrequestreview-379385270", "createdAt": "2020-03-23T12:33:37Z", "commit": {"oid": "4aec59ac4c0ff4519fd7db2459d51c27ef523c43"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMjozMzozOFrOF6DWQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMjozMzozOFrOF6DWQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQxNjU3Nw==", "bodyText": "Let's log the exception on info or debug.", "url": "https://github.com/debezium/debezium/pull/1347#discussion_r396416577", "createdAt": "2020-03-23T12:33:38Z", "author": {"login": "gunnarmorling"}, "path": "debezium-embedded/src/main/java/io/debezium/embedded/EmbeddedEngine.java", "diffHunk": "@@ -753,6 +754,11 @@ public OffsetStorageReader offsetStorageReader() {\n                                 }\n                                 break;\n                             }\n+                            catch (RetriableException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4aec59ac4c0ff4519fd7db2459d51c27ef523c43"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca6e5b98dacdcdf556562aeffa383f8d2af5bf0c", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/ca6e5b98dacdcdf556562aeffa383f8d2af5bf0c", "committedDate": "2020-03-23T12:43:36Z", "message": "DBZ-1889 Use parker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NDAxMzMx", "url": "https://github.com/debezium/debezium/pull/1347#pullrequestreview-379401331", "createdAt": "2020-03-23T12:56:20Z", "commit": {"oid": "ca6e5b98dacdcdf556562aeffa383f8d2af5bf0c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2147, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}