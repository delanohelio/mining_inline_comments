{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1NDc0NDI3", "number": 1373, "title": "DBZ-1663 Resume tests after Connect crash in OpenShift for MySQL and PostgreSQL", "bodyText": "The Connect crash is currently simulated by\n\nDisabling Kafka Operator by scaling it to ZERO\nConnect pods are then force deleted (grace period ZERO)\nImmediately after Connect deployment is scaled to ZERO -- this prevents new pod to fully start\n\nAfter that, we make a database insert and verify that the connector is indeed down.\nIn the last step, Operator is enabled again, given time to reconcile deployed Connect cluster and then we check for number of messages as well as \"grep\" for the inserted record by used email.", "createdAt": "2020-03-30T08:01:27Z", "url": "https://github.com/debezium/debezium/pull/1373", "merged": true, "mergeCommit": {"oid": "a8bb0079a4d1be3c70320fe98f55a1cc84b9e153"}, "closed": true, "closedAt": "2020-03-31T11:59:53Z", "author": {"login": "jcechace"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcSuD80AFqTM4MzgxOTkxNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcSzLZ2ABqjMxODAwMTUxNTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzODE5OTE0", "url": "https://github.com/debezium/debezium/pull/1373#pullrequestreview-383819914", "createdAt": "2020-03-30T12:50:56Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxMjo1MDo1NlrOF9oJGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxMjo1NTo0NlrOF9oVUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE2NTE0NQ==", "bodyText": "Typo in name", "url": "https://github.com/debezium/debezium/pull/1373#discussion_r400165145", "createdAt": "2020-03-30T12:50:56Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-openshift/src/test/java/io/debezium/testing/openshift/ConnectorTestBase.java", "diffHunk": "@@ -126,13 +126,24 @@ protected void assertRecordsCount(String topic, int count) {\n         }\n     }\n \n+    protected void assertMinimaltRecordsCount(String topic, int count) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE2NjY2MA==", "bodyText": "Are you really scaling down operator?", "url": "https://github.com/debezium/debezium/pull/1373#discussion_r400166660", "createdAt": "2020-03-30T12:53:20Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-openshift/src/main/java/io/debezium/testing/openshift/tools/kafka/KafkaConnectController.java", "diffHunk": "@@ -73,6 +76,43 @@ public KafkaConnectController(KafkaConnect kafkaConnect, OpenShiftClient ocp, Ok\n         this.httpUtils = new HttpUtils(http);\n     }\n \n+    /**\n+     * Disables Strimzi cluster operator by scaling it to ZERO", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE2Njc5NQ==", "bodyText": "Is the comment valid?", "url": "https://github.com/debezium/debezium/pull/1373#discussion_r400166795", "createdAt": "2020-03-30T12:53:33Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-openshift/src/main/java/io/debezium/testing/openshift/tools/kafka/KafkaConnectController.java", "diffHunk": "@@ -73,6 +76,43 @@ public KafkaConnectController(KafkaConnect kafkaConnect, OpenShiftClient ocp, Ok\n         this.httpUtils = new HttpUtils(http);\n     }\n \n+    /**\n+     * Disables Strimzi cluster operator by scaling it to ZERO\n+     *\n+     * NOTICE: cluster operator needs to be disabled first!\n+     */\n+    public void disable() {\n+        LOGGER.info(\"Disabling KafkaConnect deployment (scaling to ZERO).\");\n+        ocp.apps().deployments().inNamespace(project).withName(this.kafkaConnect.getMetadata().getName() + \"-connect\")\n+                .edit().editSpec().withReplicas(0).endSpec().done();\n+        await()\n+                .atMost(30, SECONDS)\n+                .pollDelay(5, SECONDS)\n+                .pollInterval(3, SECONDS)\n+                .until(() -> ocp.pods().inNamespace(project).withLabel(\"strimzi.io/kind\", \"KafkaConnect\").list().getItems().isEmpty());\n+    }\n+\n+    /**\n+     * Disables Strimzi cluster operator by scaling it to ZERO", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE2ODI3Mw==", "bodyText": "Should not this class have an @AfterClass method that would enable operator to make sure it is running for the further tests?", "url": "https://github.com/debezium/debezium/pull/1373#discussion_r400168273", "createdAt": "2020-03-30T12:55:46Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-openshift/src/test/java/io/debezium/testing/openshift/mysql/MySqlConnectorIT.java", "diffHunk": "@@ -138,4 +138,27 @@ public void shouldResumeStreamingAfterRedeployment() throws IOException, Interru\n                 .untilAsserted(() -> assertRecordsCount(connectorName + \".inventory.customers\", 6));\n         assertRecordsContain(connectorName + \".inventory.customers\", \"jerry@test.com\");\n     }\n+\n+    @Test\n+    @Order(7)\n+    public void shouldBeDownAfterCrash() throws SQLException {\n+        operatorController.disable();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 8}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e36712bcb57fe9cc61a9ea6756c6c11b453b53a", "author": {"user": {"login": "jcechace", "name": "Jakub Cechacek"}}, "url": "https://github.com/debezium/debezium/commit/1e36712bcb57fe9cc61a9ea6756c6c11b453b53a", "committedDate": "2020-03-30T18:54:11Z", "message": "DBZ-1663 Resume tests after Connect crash in OpenShift for MySQL and PostgreSQL"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "1e36712bcb57fe9cc61a9ea6756c6c11b453b53a", "author": {"user": {"login": "jcechace", "name": "Jakub Cechacek"}}, "url": "https://github.com/debezium/debezium/commit/1e36712bcb57fe9cc61a9ea6756c6c11b453b53a", "committedDate": "2020-03-30T18:54:11Z", "message": "DBZ-1663 Resume tests after Connect crash in OpenShift for MySQL and PostgreSQL"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1963, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}