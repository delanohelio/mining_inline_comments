{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzMDQ2OTg2", "number": 1843, "title": "DBZ-2582 Updating LSN handling", "bodyText": "https://issues.redhat.com/browse/DBZ-2582.\nThis is an example of what would be done if the changes for DBZ-2582 were implemented across the board.\nA more general/customizable option should be built instead.\nEdit: I updated the PR to make the select something that's configurable. I really do not like any of the names I gave these things (the configuration and the class/variable names), but I am honestly not sure what to call them that is concise yet informative. Suggestions welcome!", "createdAt": "2020-09-25T12:43:57Z", "url": "https://github.com/debezium/debezium/pull/1843", "merged": true, "mergeCommit": {"oid": "bea46a3059d3cf3d0c82c5ec2153440db35f1a31"}, "closed": true, "closedAt": "2020-10-19T07:19:55Z", "author": {"login": "jgormley6"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNPzYegBqjM4MTM0MzYzMjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQ633KAH2gAyNDkzMDQ2OTg2OmJkOGRiNzk3OWY0MDc2ODE1NTRmY2I3MWJjNGZlNjU5Y2Y0ZGE2Y2E=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5MjUwMDY2", "url": "https://github.com/debezium/debezium/pull/1843#pullrequestreview-499250066", "createdAt": "2020-09-30T09:32:40Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwOTozMjo0MVrOHaVP3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMDowNjoyNlrOHaWf0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM3MzE1MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        LOGGER.trace(\"Current maximum lsn is {}\", ret);\n          \n          \n            \n                        LOGGER.trace(\"Current maximum LSN is {}\", ret);", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497373150", "createdAt": "2020-09-30T09:32:41Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -150,6 +151,26 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n+    public MaxLsnResult getMaxLsnResult(String alternativeMaxTransactionalQuery) throws SQLException {\n+        Lsn maxLsn = queryAndMap(GET_MAX_LSN, singleResultMapper(rs -> {\n+            final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n+            LOGGER.trace(\"Current maximum lsn is {}\", ret);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM3MzI4OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        LOGGER.trace(\"Current maximum transactional lsn is {}\", ret);\n          \n          \n            \n                        LOGGER.trace(\"Current maximum transactional LSN is {}\", ret);", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497373289", "createdAt": "2020-09-30T09:32:50Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -150,6 +151,26 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n+    public MaxLsnResult getMaxLsnResult(String alternativeMaxTransactionalQuery) throws SQLException {\n+        Lsn maxLsn = queryAndMap(GET_MAX_LSN, singleResultMapper(rs -> {\n+            final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n+            LOGGER.trace(\"Current maximum lsn is {}\", ret);\n+            return ret;\n+        }, \"Maximum LSN query must return exactly one value\"));\n+\n+        if (StringUtils.isEmpty(alternativeMaxTransactionalQuery)) {\n+            // If not alternative query is provided, return the default for both.\n+            return new MaxLsnResult(maxLsn, maxLsn);\n+        }\n+\n+        // Else run the alternative query for getting the largest lsn related to a valid transaction.\n+        return new MaxLsnResult(maxLsn, queryAndMap(alternativeMaxTransactionalQuery, singleResultMapper(rs -> {\n+            final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n+            LOGGER.trace(\"Current maximum transactional lsn is {}\", ret);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM4NDAwMw==", "bodyText": "Would be better to use prepared statements to avoid the repeated parsing (see preparedQueryAndMap()), for that one and similar queries (I suppose this started off not using PS once and then similar methods followed that precedence).", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497384003", "createdAt": "2020-09-30T09:50:35Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -150,6 +151,26 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n+    public MaxLsnResult getMaxLsnResult(String alternativeMaxTransactionalQuery) throws SQLException {\n+        Lsn maxLsn = queryAndMap(GET_MAX_LSN, singleResultMapper(rs -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MDM0OQ==", "bodyText": "Btw. in the Jira statement you originally suggested a single statement to get both LSN values. Can we actually do this, avoiding one round-trip to the DB?", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497390349", "createdAt": "2020-09-30T10:00:58Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -150,6 +151,26 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n+    public MaxLsnResult getMaxLsnResult(String alternativeMaxTransactionalQuery) throws SQLException {\n+        Lsn maxLsn = queryAndMap(GET_MAX_LSN, singleResultMapper(rs -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM4NDAwMw=="}, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MTE3NQ==", "bodyText": "Also, should the existing getMaxLsn() method be removed, and all callers be updated to use this one?", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497391175", "createdAt": "2020-09-30T10:02:33Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -150,6 +151,26 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n+    public MaxLsnResult getMaxLsnResult(String alternativeMaxTransactionalQuery) throws SQLException {\n+        Lsn maxLsn = queryAndMap(GET_MAX_LSN, singleResultMapper(rs -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM4NDAwMw=="}, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MTkzMQ==", "bodyText": "Seems this would only be the case if someone set the statement explicitly to \"\"; is this what you're expecting here?", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497391931", "createdAt": "2020-09-30T10:03:40Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -150,6 +151,26 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n+    public MaxLsnResult getMaxLsnResult(String alternativeMaxTransactionalQuery) throws SQLException {\n+        Lsn maxLsn = queryAndMap(GET_MAX_LSN, singleResultMapper(rs -> {\n+            final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n+            LOGGER.trace(\"Current maximum lsn is {}\", ret);\n+            return ret;\n+        }, \"Maximum LSN query must return exactly one value\"));\n+\n+        if (StringUtils.isEmpty(alternativeMaxTransactionalQuery)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MzYxOQ==", "bodyText": "Do we actually need to expose both values to calling code? Wouldn't it suffice to expose only the lower of the two?", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497393619", "createdAt": "2020-09-30T10:06:26Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/MaxLsnResult.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.debezium.connector.sqlserver;\n+\n+/**\n+ * Stores the result from querying the lsn_time_mapping for the highest LSNs.\n+ */\n+public class MaxLsnResult {\n+\n+    /**\n+     * The highest lsn regardless of configuration. This should be utilized when querying the CDC tables as using an LSN that is no longer valid can lead to errors.\n+     */\n+    private final Lsn maxLsn;\n+\n+    /**\n+     * The highest lsn belonging to a valid change transaction as determined by {@link SqlServerConnectorConfig#STREAMING_MAX_LSN_SELECT_STATEMENT} or default to the same as maxLsn.\n+     */\n+    private final Lsn maxTransactionalLsn;\n+\n+    public MaxLsnResult(Lsn maxLsn, Lsn maxTransactionalLsn) {\n+        this.maxLsn = maxLsn;\n+        this.maxTransactionalLsn = maxTransactionalLsn;\n+    }\n+\n+    public Lsn getMaxLsn() {\n+        return maxLsn;\n+    }\n+\n+    public Lsn getMaxTransactionalLsn() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "203e73ab61c4e6a879a20916262516ae589699e0", "author": {"user": {"login": "jgormley6", "name": "James Gormley"}}, "url": "https://github.com/debezium/debezium/commit/203e73ab61c4e6a879a20916262516ae589699e0", "committedDate": "2020-10-08T13:01:54Z", "message": "DBZ-2582 Updating LSN handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e55c5c016ec0b0beaf7f10225d9f15589b2bf4b", "author": {"user": {"login": "jgormley6", "name": "James Gormley"}}, "url": "https://github.com/debezium/debezium/commit/6e55c5c016ec0b0beaf7f10225d9f15589b2bf4b", "committedDate": "2020-10-08T13:01:54Z", "message": "DBZ-2582-lsn-changes revert log change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05497e16cd3c998a8a17b28f67f2d166f197e05a", "author": {"user": {"login": "jgormley6", "name": "James Gormley"}}, "url": "https://github.com/debezium/debezium/commit/05497e16cd3c998a8a17b28f67f2d166f197e05a", "committedDate": "2020-10-08T13:01:54Z", "message": "DBZ-2582 Fixing tests and adding pause back"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "410f2d74b3c4378b065d3ea9464577475de26bb8", "author": {"user": {"login": "jgormley6", "name": "James Gormley"}}, "url": "https://github.com/debezium/debezium/commit/410f2d74b3c4378b065d3ea9464577475de26bb8", "committedDate": "2020-10-08T13:01:54Z", "message": "DBZ-2582 Adding copyright"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0339efe1cf12536c545f04f9d9e6f7658c30739", "author": {"user": {"login": "jgormley6", "name": "James Gormley"}}, "url": "https://github.com/debezium/debezium/commit/e0339efe1cf12536c545f04f9d9e6f7658c30739", "committedDate": "2020-10-08T13:01:54Z", "message": "DBZ-2582 Apply suggestions from code review\n\nCo-authored-by: Gunnar Morling <gunnar.morling@googlemail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "714edc7b4a61340fd5f19ced8dec95c0de96a561", "author": {"user": {"login": "jgormley6", "name": "James Gormley"}}, "url": "https://github.com/debezium/debezium/commit/714edc7b4a61340fd5f19ced8dec95c0de96a561", "committedDate": "2020-10-08T13:01:55Z", "message": "DBZ-2582 Updating configuration to be feature flag and using prepared statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcd7c5bf5f18eee77511ec7742a37f7282881e7f", "author": {"user": {"login": "jgormley6", "name": "James Gormley"}}, "url": "https://github.com/debezium/debezium/commit/fcd7c5bf5f18eee77511ec7742a37f7282881e7f", "committedDate": "2020-10-08T13:01:55Z", "message": "DBZ-2582 Updating test for consistency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38e6cc678169daf3518e6ab2be8c4f275bde4ac2", "author": {"user": {"login": "jgormley6", "name": "James Gormley"}}, "url": "https://github.com/debezium/debezium/commit/38e6cc678169daf3518e6ab2be8c4f275bde4ac2", "committedDate": "2020-10-08T13:01:55Z", "message": "DBZ-2582 Adding boolean check and removing TODO as no changes are necessary"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "38e6cc678169daf3518e6ab2be8c4f275bde4ac2", "author": {"user": {"login": "jgormley6", "name": "James Gormley"}}, "url": "https://github.com/debezium/debezium/commit/38e6cc678169daf3518e6ab2be8c4f275bde4ac2", "committedDate": "2020-10-08T13:01:55Z", "message": "DBZ-2582 Adding boolean check and removing TODO as no changes are necessary"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NDM4OTA2", "url": "https://github.com/debezium/debezium/pull/1843#pullrequestreview-505438906", "createdAt": "2020-10-09T07:51:16Z", "commit": {"oid": "38e6cc678169daf3518e6ab2be8c4f275bde4ac2"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNzo1MToxN1rOHe-5og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNzo1MTozOVrOHe-6fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI0OTg5MA==", "bodyText": "Tiny nit: \"LSN\" -> \"Lsn\" (this isn't done consistently across the code base yet, but it's the casing we want to converge on eventually for abbreviations in type/method/variable names).", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r502249890", "createdAt": "2020-10-09T07:51:17Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java", "diffHunk": "@@ -442,6 +452,10 @@ public boolean isReadOnlyDatabaseConnection() {\n         return readOnlyDatabaseConnection;\n     }\n \n+    public boolean isSkipLowActivityLSNsEnabled() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38e6cc678169daf3518e6ab2be8c4f275bde4ac2"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI1MDEwOQ==", "bodyText": "Same comment as below.", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r502250109", "createdAt": "2020-10-09T07:51:39Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -153,6 +156,24 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n+    public MaxLsnResult getMaxLsnResult(boolean skipLowActivityLSNsEnabled) throws SQLException {\n+        if (skipLowActivityLSNsEnabled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38e6cc678169daf3518e6ab2be8c4f275bde4ac2"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd8db7979f407681554fcb71bc4fe659cf4da6ca", "author": {"user": {"login": "jgormley6", "name": "James Gormley"}}, "url": "https://github.com/debezium/debezium/commit/bd8db7979f407681554fcb71bc4fe659cf4da6ca", "committedDate": "2020-10-09T18:55:32Z", "message": "DBZ-2582 Fixing LSN casing"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2454, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}