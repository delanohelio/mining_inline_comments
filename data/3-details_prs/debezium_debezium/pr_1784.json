{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4NTIwODgw", "number": 1784, "title": "DBZ-2461 LSN must not be flushed after connection close", "bodyText": "https://issues.redhat.com/browse/DBZ-2461", "createdAt": "2020-09-03T10:13:05Z", "url": "https://github.com/debezium/debezium/pull/1784", "merged": true, "mergeCommit": {"oid": "eed321d485682175e5ba138d6eb6360aee0ae460"}, "closed": true, "closedAt": "2020-09-16T09:40:53Z", "author": {"login": "jpechane"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFN0DsgH2gAyNDc4NTIwODgwOjgzNWVjNzVmZWFlMGIyNmVjYTQ1MzNlMTU0ZmY5ODAxY2Q5ZDcwMjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJDzxWgBqjM3NjcxNzAxODg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "835ec75feae0b26eca4533e154ff9801cd9d7029", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/835ec75feae0b26eca4533e154ff9801cd9d7029", "committedDate": "2020-09-03T10:12:29Z", "message": "DBZ-2461 LSN must not be flushed after connection close"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNzA5NTEz", "url": "https://github.com/debezium/debezium/pull/1784#pullrequestreview-481709513", "createdAt": "2020-09-03T10:33:56Z", "commit": {"oid": "835ec75feae0b26eca4533e154ff9801cd9d7029"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMDozMzo1NlrOHMghaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMDozMzo1NlrOHMghaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3NzgwMw==", "bodyText": "Can we avoid this via Awaitility?", "url": "https://github.com/debezium/debezium/pull/1784#discussion_r482877803", "createdAt": "2020-09-03T10:33:56Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/DebeziumEngineIT.java", "diffHunk": "@@ -197,4 +198,61 @@ public void shouldSerializeToCloudEvents() throws Exception {\n         }\n     }\n \n+    @Test\n+    @FixFor(\"DBZ-2461\")\n+    public void testOffsetsCommitAfterStop() throws Exception {\n+        final AtomicReference<Throwable> exception = new AtomicReference<>();\n+        DebeziumEngine<ChangeEvent<String, String>> engine;\n+\n+        TestHelper.execute(\"DROP TABLE IF EXISTS tests;\", \"CREATE TABLE tests (id SERIAL PRIMARY KEY);\");\n+\n+        final Properties props = new Properties();\n+        props.putAll(TestHelper.defaultConfig().build().asMap());\n+        props.setProperty(\"name\", \"debezium-engine\");\n+        props.setProperty(\"connector.class\", \"io.debezium.connector.postgresql.PostgresConnector\");\n+        props.setProperty(StandaloneConfig.OFFSET_STORAGE_FILE_FILENAME_CONFIG,\n+                OFFSET_STORE_PATH.toAbsolutePath().toString());\n+        props.setProperty(\"offset.flush.interval.ms\", \"3000\");\n+        props.setProperty(\"converter.schemas.enable\", \"false\");\n+\n+        engine = DebeziumEngine.create(Json.class).using(props).using(new DebeziumEngine.ConnectorCallback() {\n+            @Override\n+            public void connectorStarted() {\n+            }\n+\n+            @Override\n+            public void connectorStopped() {\n+            }\n+        }).using((success, message, error) -> {\n+            exception.compareAndSet(null, error);\n+        }).notifying((records, committer) -> {\n+            try {\n+\n+                for (ChangeEvent<String, String> record : records) {\n+                    committer.markProcessed(record);\n+                }\n+                committer.markBatchFinished();\n+            }\n+            catch (Exception e) {\n+                Testing.printError(e);\n+            }\n+        }).build();\n+\n+        ExecutorService executor = Executors.newSingleThreadExecutor();\n+        executor.execute(engine);\n+\n+        for (int i = 0; i < 100; i++) {\n+            TestHelper.execute(\"INSERT INTO tests VALUES(default)\");\n+        }\n+        Thread.sleep(5000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "835ec75feae0b26eca4533e154ff9801cd9d7029"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f70c241c83d82da4622dd4428a1c565118da894", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/6f70c241c83d82da4622dd4428a1c565118da894", "committedDate": "2020-09-15T08:48:27Z", "message": "DBZ-2461 Remove sleeps from test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "6f70c241c83d82da4622dd4428a1c565118da894", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/6f70c241c83d82da4622dd4428a1c565118da894", "committedDate": "2020-09-15T08:48:27Z", "message": "DBZ-2461 Remove sleeps from test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2397, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}