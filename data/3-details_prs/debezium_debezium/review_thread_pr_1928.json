{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1Mjc1NDc2", "number": 1928, "reviewThreads": {"totalCount": 35, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMDowODozOFrOE1J9BA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMjo1MTozMFrOE2v6JQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MTczMDYwOnYy", "diffSide": "RIGHT", "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/PostgresChangeRecordEmitter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMDowODozOFrOHtRSgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMDowODozOFrOHtRSgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzMTIzMg==", "bodyText": "unrelated cleanup in separate commit", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517231232", "createdAt": "2020-11-04T10:08:38Z", "author": {"login": "rk3rn3r"}, "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/PostgresChangeRecordEmitter.java", "diffHunk": "@@ -273,7 +273,7 @@ private boolean schemaChanged(List<ReplicationMessage.Column> columns, Table tab\n \n         // go through the list of columns from the message to figure out if any of them are new or have changed their type based\n         // on what we have in the table metadata....\n-        return columns.stream().filter(message -> {\n+        return columns.stream().anyMatch(message -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4475f92765aea2e4943d4ea9edabf85ddd07f2fa"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MTczMTE3OnYy", "diffSide": "RIGHT", "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/PostgresStreamingChangeEventSource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMDowODo0OFrOHtRS3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMDowODo0OFrOHtRS3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzMTMyNA==", "bodyText": "unrelated cleanup in separate commit", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517231324", "createdAt": "2020-11-04T10:08:48Z", "author": {"login": "rk3rn3r"}, "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/PostgresStreamingChangeEventSource.java", "diffHunk": "@@ -224,16 +224,15 @@ else if (message.getOperation() == Operation.COMMIT) {\n                     offsetContext.updateWalPosition(lsn, lastCompletelyProcessedLsn, message.getCommitTime(), message.getTransactionId(), tableId,\n                             taskContext.getSlotXmin(connection));\n \n-                    boolean dispatched = (message.getOperation() == Operation.NOOP) ? false\n-                            : dispatcher.dispatchDataChangeEvent(\n-                                    tableId,\n-                                    new PostgresChangeRecordEmitter(\n-                                            offsetContext,\n-                                            clock,\n-                                            connectorConfig,\n-                                            schema,\n-                                            connection,\n-                                            message));\n+                    boolean dispatched = message.getOperation() != Operation.NOOP && dispatcher.dispatchDataChangeEvent(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4475f92765aea2e4943d4ea9edabf85ddd07f2fa"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MTczNzk0OnYy", "diffSide": "RIGHT", "path": "debezium-embedded/src/test/java/io/debezium/embedded/AbstractConnectorTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMDoxMDoyNlrOHtRW0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMDoxMDoyNlrOHtRW0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzMjMzNg==", "bodyText": "unrelated change (1000 seconds is about 16,6 minutes) but I think we don't have to wait so long? wdyt?", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517232336", "createdAt": "2020-11-04T10:10:26Z", "author": {"login": "rk3rn3r"}, "path": "debezium-embedded/src/test/java/io/debezium/embedded/AbstractConnectorTest.java", "diffHunk": "@@ -353,7 +354,7 @@ public void taskStarted() {\n             engine.run();\n         });\n         try {\n-            if (!latch.await(1000, TimeUnit.SECONDS)) {\n+            if (!latch.await(5, TimeUnit.MINUTES)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4475f92765aea2e4943d4ea9edabf85ddd07f2fa"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MTc1MzQxOnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/pom.xml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMDoxNDoyN1rOHtRgGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDozMjowMlrOHtauTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzNDcxNA==", "bodyText": "Not sure, but maybe this could be <scope>provided</scope> , but I'm not sure about it. Also debezium-testing-testcontainers is only a test scope dependency it should not impact production JARs negatively, wdyt?", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517234714", "createdAt": "2020-11-04T10:14:27Z", "author": {"login": "rk3rn3r"}, "path": "debezium-testing/debezium-testing-testcontainers/pom.xml", "diffHunk": "@@ -41,6 +41,10 @@\n       <groupId>com.fasterxml.jackson.core</groupId>\n       <artifactId>jackson-databind</artifactId>\n     </dependency>\n+    <dependency>\n+      <groupId>org.testcontainers</groupId>\n+      <artifactId>postgresql</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4475f92765aea2e4943d4ea9edabf85ddd07f2fa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI4OTU1Ng==", "bodyText": "Why it can't saty test scope as it was before?", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517289556", "createdAt": "2020-11-04T11:51:43Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/pom.xml", "diffHunk": "@@ -41,6 +41,10 @@\n       <groupId>com.fasterxml.jackson.core</groupId>\n       <artifactId>jackson-databind</artifactId>\n     </dependency>\n+    <dependency>\n+      <groupId>org.testcontainers</groupId>\n+      <artifactId>postgresql</artifactId>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzNDcxNA=="}, "originalCommit": {"oid": "4475f92765aea2e4943d4ea9edabf85ddd07f2fa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4NTgwNA==", "bodyText": "Because it is used in ./src/ now.", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517385804", "createdAt": "2020-11-04T14:32:02Z", "author": {"login": "rk3rn3r"}, "path": "debezium-testing/debezium-testing-testcontainers/pom.xml", "diffHunk": "@@ -41,6 +41,10 @@\n       <groupId>com.fasterxml.jackson.core</groupId>\n       <artifactId>jackson-databind</artifactId>\n     </dependency>\n+    <dependency>\n+      <groupId>org.testcontainers</groupId>\n+      <artifactId>postgresql</artifactId>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzNDcxNA=="}, "originalCommit": {"oid": "4475f92765aea2e4943d4ea9edabf85ddd07f2fa"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjAzNDc4OnYy", "diffSide": "RIGHT", "path": "debezium-connector-postgres/pom.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTozMTowMlrOHtUNPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMzo0NzoyNVrOHtYxPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI3OTAzOA==", "bodyText": "Should not be here test scope too?", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517279038", "createdAt": "2020-11-04T11:31:02Z", "author": {"login": "jpechane"}, "path": "debezium-connector-postgres/pom.xml", "diffHunk": "@@ -108,6 +108,16 @@\n             <artifactId>kafka-connect-avro-converter</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>org.testcontainers</groupId>\n+            <artifactId>testcontainers</artifactId>\n+            <scope>test</scope>\n+        </dependency>\n+        <dependency>\n+            <groupId>io.debezium</groupId>\n+            <artifactId>debezium-testing-testcontainers</artifactId>\n+            <version>${project.version}</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM1Mzc4OA==", "bodyText": "Yep", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517353788", "createdAt": "2020-11-04T13:47:25Z", "author": {"login": "rk3rn3r"}, "path": "debezium-connector-postgres/pom.xml", "diffHunk": "@@ -108,6 +108,16 @@\n             <artifactId>kafka-connect-avro-converter</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>org.testcontainers</groupId>\n+            <artifactId>testcontainers</artifactId>\n+            <scope>test</scope>\n+        </dependency>\n+        <dependency>\n+            <groupId>io.debezium</groupId>\n+            <artifactId>debezium-testing-testcontainers</artifactId>\n+            <version>${project.version}</version>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI3OTAzOA=="}, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjA3MjgxOnYy", "diffSide": "RIGHT", "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo0Mjo0MlrOHtUkRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMzo0MzowN1rOHtYmjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI4NDkzMg==", "bodyText": "I think you should read the property value and set it to the previous one not making any assumptions", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517284932", "createdAt": "2020-11-04T11:42:42Z", "author": {"login": "jpechane"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package io.debezium.connector.postgresql;\n+\n+import static org.junit.Assert.assertFalse;\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.awaitility.Awaitility;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.testcontainers.containers.Container;\n+\n+import io.debezium.config.CommonConnectorConfig;\n+import io.debezium.config.Configuration;\n+import io.debezium.connector.postgresql.PostgresConnectorConfig.SnapshotMode;\n+import io.debezium.doc.FixFor;\n+import io.debezium.embedded.AbstractConnectorTest;\n+import io.debezium.embedded.EmbeddedEngine;\n+import io.debezium.heartbeat.DatabaseHeartbeatImpl;\n+import io.debezium.heartbeat.Heartbeat;\n+import io.debezium.jdbc.JdbcConfiguration;\n+import io.debezium.testing.testcontainers.PostgresInfrastructure;\n+import io.debezium.util.Testing;\n+\n+/**\n+ * Integration test for {@link PostgresConnector} using an {@link EmbeddedEngine} and Testcontainers infrastructure for when Postgres is shutdown during streaming\n+ */\n+public class PostgresShutdownIT extends AbstractConnectorTest {\n+\n+    /*\n+     * Specific tests that need to extend the initial DDL set should do it in a form of\n+     * TestHelper.execute(SETUP_TABLES_STMT + ADDITIONAL_STATEMENTS)\n+     */\n+    private static final String INSERT_STMT = \"INSERT INTO s1.a (aa) VALUES (1);\" +\n+            \"INSERT INTO s2.a (aa) VALUES (1);\";\n+    private static final String CREATE_TABLES_STMT = \"DROP SCHEMA IF EXISTS s1 CASCADE;\" +\n+            \"DROP SCHEMA IF EXISTS s2 CASCADE;\" +\n+            \"CREATE SCHEMA s1; \" +\n+            \"CREATE SCHEMA s2; \" +\n+            \"CREATE TABLE s1.a (pk SERIAL, aa integer, PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s2.a (pk SERIAL, aa integer, bb varchar(20), PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s1.heartbeat (ts TIMESTAMP WITH TIME ZONE PRIMARY KEY);\" +\n+            \"INSERT INTO s1.heartbeat (ts) VALUES (NOW());\";\n+    private static final String SETUP_TABLES_STMT = CREATE_TABLES_STMT + INSERT_STMT;\n+\n+    private PostgresInfrastructure infrastructure;\n+\n+    @Before\n+    public void setUp() {\n+        infrastructure = PostgresInfrastructure.getDebeziumPostgresInfrastructure();\n+        infrastructure.startContainer();\n+        System.setProperty(\"database.port\", String.valueOf(infrastructure.getPostgresContainer().getMappedPort(5432)));\n+        try {\n+            TestHelper.dropAllSchemas();\n+        }\n+        catch (SQLException exception) {\n+            throw new RuntimeException(exception);\n+        }\n+        initializeConnectorTestFramework();\n+    }\n+\n+    @After\n+    public void tearDown() {\n+        stopConnector();\n+        TestHelper.dropDefaultReplicationSlot();\n+        TestHelper.dropPublication();\n+        infrastructure.getPostgresContainer().stop();\n+        System.setProperty(\"database.port\", \"5432\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM1MTA1Mw==", "bodyText": "Good point.", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517351053", "createdAt": "2020-11-04T13:43:07Z", "author": {"login": "rk3rn3r"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package io.debezium.connector.postgresql;\n+\n+import static org.junit.Assert.assertFalse;\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.awaitility.Awaitility;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.testcontainers.containers.Container;\n+\n+import io.debezium.config.CommonConnectorConfig;\n+import io.debezium.config.Configuration;\n+import io.debezium.connector.postgresql.PostgresConnectorConfig.SnapshotMode;\n+import io.debezium.doc.FixFor;\n+import io.debezium.embedded.AbstractConnectorTest;\n+import io.debezium.embedded.EmbeddedEngine;\n+import io.debezium.heartbeat.DatabaseHeartbeatImpl;\n+import io.debezium.heartbeat.Heartbeat;\n+import io.debezium.jdbc.JdbcConfiguration;\n+import io.debezium.testing.testcontainers.PostgresInfrastructure;\n+import io.debezium.util.Testing;\n+\n+/**\n+ * Integration test for {@link PostgresConnector} using an {@link EmbeddedEngine} and Testcontainers infrastructure for when Postgres is shutdown during streaming\n+ */\n+public class PostgresShutdownIT extends AbstractConnectorTest {\n+\n+    /*\n+     * Specific tests that need to extend the initial DDL set should do it in a form of\n+     * TestHelper.execute(SETUP_TABLES_STMT + ADDITIONAL_STATEMENTS)\n+     */\n+    private static final String INSERT_STMT = \"INSERT INTO s1.a (aa) VALUES (1);\" +\n+            \"INSERT INTO s2.a (aa) VALUES (1);\";\n+    private static final String CREATE_TABLES_STMT = \"DROP SCHEMA IF EXISTS s1 CASCADE;\" +\n+            \"DROP SCHEMA IF EXISTS s2 CASCADE;\" +\n+            \"CREATE SCHEMA s1; \" +\n+            \"CREATE SCHEMA s2; \" +\n+            \"CREATE TABLE s1.a (pk SERIAL, aa integer, PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s2.a (pk SERIAL, aa integer, bb varchar(20), PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s1.heartbeat (ts TIMESTAMP WITH TIME ZONE PRIMARY KEY);\" +\n+            \"INSERT INTO s1.heartbeat (ts) VALUES (NOW());\";\n+    private static final String SETUP_TABLES_STMT = CREATE_TABLES_STMT + INSERT_STMT;\n+\n+    private PostgresInfrastructure infrastructure;\n+\n+    @Before\n+    public void setUp() {\n+        infrastructure = PostgresInfrastructure.getDebeziumPostgresInfrastructure();\n+        infrastructure.startContainer();\n+        System.setProperty(\"database.port\", String.valueOf(infrastructure.getPostgresContainer().getMappedPort(5432)));\n+        try {\n+            TestHelper.dropAllSchemas();\n+        }\n+        catch (SQLException exception) {\n+            throw new RuntimeException(exception);\n+        }\n+        initializeConnectorTestFramework();\n+    }\n+\n+    @After\n+    public void tearDown() {\n+        stopConnector();\n+        TestHelper.dropDefaultReplicationSlot();\n+        TestHelper.dropPublication();\n+        infrastructure.getPostgresContainer().stop();\n+        System.setProperty(\"database.port\", \"5432\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI4NDkzMg=="}, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjA3NjU1OnYy", "diffSide": "RIGHT", "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo0Mzo0NVrOHtUmXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDoxMDoxNFrOHtZvXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI4NTQ2OQ==", "bodyText": "Check io.debezium.jdbc.JdbcConnection.singleResultMapper(ResultSetExtractor<T>, String)", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517285469", "createdAt": "2020-11-04T11:43:45Z", "author": {"login": "jpechane"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package io.debezium.connector.postgresql;\n+\n+import static org.junit.Assert.assertFalse;\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.awaitility.Awaitility;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.testcontainers.containers.Container;\n+\n+import io.debezium.config.CommonConnectorConfig;\n+import io.debezium.config.Configuration;\n+import io.debezium.connector.postgresql.PostgresConnectorConfig.SnapshotMode;\n+import io.debezium.doc.FixFor;\n+import io.debezium.embedded.AbstractConnectorTest;\n+import io.debezium.embedded.EmbeddedEngine;\n+import io.debezium.heartbeat.DatabaseHeartbeatImpl;\n+import io.debezium.heartbeat.Heartbeat;\n+import io.debezium.jdbc.JdbcConfiguration;\n+import io.debezium.testing.testcontainers.PostgresInfrastructure;\n+import io.debezium.util.Testing;\n+\n+/**\n+ * Integration test for {@link PostgresConnector} using an {@link EmbeddedEngine} and Testcontainers infrastructure for when Postgres is shutdown during streaming\n+ */\n+public class PostgresShutdownIT extends AbstractConnectorTest {\n+\n+    /*\n+     * Specific tests that need to extend the initial DDL set should do it in a form of\n+     * TestHelper.execute(SETUP_TABLES_STMT + ADDITIONAL_STATEMENTS)\n+     */\n+    private static final String INSERT_STMT = \"INSERT INTO s1.a (aa) VALUES (1);\" +\n+            \"INSERT INTO s2.a (aa) VALUES (1);\";\n+    private static final String CREATE_TABLES_STMT = \"DROP SCHEMA IF EXISTS s1 CASCADE;\" +\n+            \"DROP SCHEMA IF EXISTS s2 CASCADE;\" +\n+            \"CREATE SCHEMA s1; \" +\n+            \"CREATE SCHEMA s2; \" +\n+            \"CREATE TABLE s1.a (pk SERIAL, aa integer, PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s2.a (pk SERIAL, aa integer, bb varchar(20), PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s1.heartbeat (ts TIMESTAMP WITH TIME ZONE PRIMARY KEY);\" +\n+            \"INSERT INTO s1.heartbeat (ts) VALUES (NOW());\";\n+    private static final String SETUP_TABLES_STMT = CREATE_TABLES_STMT + INSERT_STMT;\n+\n+    private PostgresInfrastructure infrastructure;\n+\n+    @Before\n+    public void setUp() {\n+        infrastructure = PostgresInfrastructure.getDebeziumPostgresInfrastructure();\n+        infrastructure.startContainer();\n+        System.setProperty(\"database.port\", String.valueOf(infrastructure.getPostgresContainer().getMappedPort(5432)));\n+        try {\n+            TestHelper.dropAllSchemas();\n+        }\n+        catch (SQLException exception) {\n+            throw new RuntimeException(exception);\n+        }\n+        initializeConnectorTestFramework();\n+    }\n+\n+    @After\n+    public void tearDown() {\n+        stopConnector();\n+        TestHelper.dropDefaultReplicationSlot();\n+        TestHelper.dropPublication();\n+        infrastructure.getPostgresContainer().stop();\n+        System.setProperty(\"database.port\", \"5432\");\n+    }\n+\n+    @Test\n+    @FixFor(\"DBZ-2617\")\n+    public void shouldStopOnPostgresFastShutdown() throws Exception {\n+        TestHelper.execute(SETUP_TABLES_STMT);\n+        final int recordCount = 100;\n+\n+        for (int i = 0; i < recordCount - 1; i++) {\n+            TestHelper.execute(INSERT_STMT);\n+        }\n+        Configuration.Builder configBuilder = TestHelper.defaultConfig()\n+                .with(CommonConnectorConfig.DATABASE_CONFIG_PREFIX + JdbcConfiguration.PORT, infrastructure.getPostgresContainer().getMappedPort(5432))\n+                .with(PostgresConnectorConfig.SNAPSHOT_MODE, SnapshotMode.ALWAYS.getValue())\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, false)\n+                .with(PostgresConnectorConfig.SCHEMA_INCLUDE_LIST, \"s1\")\n+                .with(Heartbeat.HEARTBEAT_INTERVAL, 500)\n+                .with(DatabaseHeartbeatImpl.HEARTBEAT_ACTION_QUERY, \"UPDATE s1.heartbeat SET ts=NOW();\");\n+\n+        Testing.Print.enable();\n+        String initialHeartbeat = TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM2OTY5NQ==", "bodyText": "That makes it easier! Thx", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517369695", "createdAt": "2020-11-04T14:10:14Z", "author": {"login": "rk3rn3r"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package io.debezium.connector.postgresql;\n+\n+import static org.junit.Assert.assertFalse;\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.awaitility.Awaitility;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.testcontainers.containers.Container;\n+\n+import io.debezium.config.CommonConnectorConfig;\n+import io.debezium.config.Configuration;\n+import io.debezium.connector.postgresql.PostgresConnectorConfig.SnapshotMode;\n+import io.debezium.doc.FixFor;\n+import io.debezium.embedded.AbstractConnectorTest;\n+import io.debezium.embedded.EmbeddedEngine;\n+import io.debezium.heartbeat.DatabaseHeartbeatImpl;\n+import io.debezium.heartbeat.Heartbeat;\n+import io.debezium.jdbc.JdbcConfiguration;\n+import io.debezium.testing.testcontainers.PostgresInfrastructure;\n+import io.debezium.util.Testing;\n+\n+/**\n+ * Integration test for {@link PostgresConnector} using an {@link EmbeddedEngine} and Testcontainers infrastructure for when Postgres is shutdown during streaming\n+ */\n+public class PostgresShutdownIT extends AbstractConnectorTest {\n+\n+    /*\n+     * Specific tests that need to extend the initial DDL set should do it in a form of\n+     * TestHelper.execute(SETUP_TABLES_STMT + ADDITIONAL_STATEMENTS)\n+     */\n+    private static final String INSERT_STMT = \"INSERT INTO s1.a (aa) VALUES (1);\" +\n+            \"INSERT INTO s2.a (aa) VALUES (1);\";\n+    private static final String CREATE_TABLES_STMT = \"DROP SCHEMA IF EXISTS s1 CASCADE;\" +\n+            \"DROP SCHEMA IF EXISTS s2 CASCADE;\" +\n+            \"CREATE SCHEMA s1; \" +\n+            \"CREATE SCHEMA s2; \" +\n+            \"CREATE TABLE s1.a (pk SERIAL, aa integer, PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s2.a (pk SERIAL, aa integer, bb varchar(20), PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s1.heartbeat (ts TIMESTAMP WITH TIME ZONE PRIMARY KEY);\" +\n+            \"INSERT INTO s1.heartbeat (ts) VALUES (NOW());\";\n+    private static final String SETUP_TABLES_STMT = CREATE_TABLES_STMT + INSERT_STMT;\n+\n+    private PostgresInfrastructure infrastructure;\n+\n+    @Before\n+    public void setUp() {\n+        infrastructure = PostgresInfrastructure.getDebeziumPostgresInfrastructure();\n+        infrastructure.startContainer();\n+        System.setProperty(\"database.port\", String.valueOf(infrastructure.getPostgresContainer().getMappedPort(5432)));\n+        try {\n+            TestHelper.dropAllSchemas();\n+        }\n+        catch (SQLException exception) {\n+            throw new RuntimeException(exception);\n+        }\n+        initializeConnectorTestFramework();\n+    }\n+\n+    @After\n+    public void tearDown() {\n+        stopConnector();\n+        TestHelper.dropDefaultReplicationSlot();\n+        TestHelper.dropPublication();\n+        infrastructure.getPostgresContainer().stop();\n+        System.setProperty(\"database.port\", \"5432\");\n+    }\n+\n+    @Test\n+    @FixFor(\"DBZ-2617\")\n+    public void shouldStopOnPostgresFastShutdown() throws Exception {\n+        TestHelper.execute(SETUP_TABLES_STMT);\n+        final int recordCount = 100;\n+\n+        for (int i = 0; i < recordCount - 1; i++) {\n+            TestHelper.execute(INSERT_STMT);\n+        }\n+        Configuration.Builder configBuilder = TestHelper.defaultConfig()\n+                .with(CommonConnectorConfig.DATABASE_CONFIG_PREFIX + JdbcConfiguration.PORT, infrastructure.getPostgresContainer().getMappedPort(5432))\n+                .with(PostgresConnectorConfig.SNAPSHOT_MODE, SnapshotMode.ALWAYS.getValue())\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, false)\n+                .with(PostgresConnectorConfig.SCHEMA_INCLUDE_LIST, \"s1\")\n+                .with(Heartbeat.HEARTBEAT_INTERVAL, 500)\n+                .with(DatabaseHeartbeatImpl.HEARTBEAT_ACTION_QUERY, \"UPDATE s1.heartbeat SET ts=NOW();\");\n+\n+        Testing.Print.enable();\n+        String initialHeartbeat = TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI4NTQ2OQ=="}, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjA3OTEyOnYy", "diffSide": "RIGHT", "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo0NDozMFrOHtUn3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo0NDozMFrOHtUn3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI4NTg1Mw==", "bodyText": "Please derive it from io.debezium.connector.postgresql.TestHelper.waitTimeForRecords()", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517285853", "createdAt": "2020-11-04T11:44:30Z", "author": {"login": "jpechane"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package io.debezium.connector.postgresql;\n+\n+import static org.junit.Assert.assertFalse;\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.awaitility.Awaitility;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.testcontainers.containers.Container;\n+\n+import io.debezium.config.CommonConnectorConfig;\n+import io.debezium.config.Configuration;\n+import io.debezium.connector.postgresql.PostgresConnectorConfig.SnapshotMode;\n+import io.debezium.doc.FixFor;\n+import io.debezium.embedded.AbstractConnectorTest;\n+import io.debezium.embedded.EmbeddedEngine;\n+import io.debezium.heartbeat.DatabaseHeartbeatImpl;\n+import io.debezium.heartbeat.Heartbeat;\n+import io.debezium.jdbc.JdbcConfiguration;\n+import io.debezium.testing.testcontainers.PostgresInfrastructure;\n+import io.debezium.util.Testing;\n+\n+/**\n+ * Integration test for {@link PostgresConnector} using an {@link EmbeddedEngine} and Testcontainers infrastructure for when Postgres is shutdown during streaming\n+ */\n+public class PostgresShutdownIT extends AbstractConnectorTest {\n+\n+    /*\n+     * Specific tests that need to extend the initial DDL set should do it in a form of\n+     * TestHelper.execute(SETUP_TABLES_STMT + ADDITIONAL_STATEMENTS)\n+     */\n+    private static final String INSERT_STMT = \"INSERT INTO s1.a (aa) VALUES (1);\" +\n+            \"INSERT INTO s2.a (aa) VALUES (1);\";\n+    private static final String CREATE_TABLES_STMT = \"DROP SCHEMA IF EXISTS s1 CASCADE;\" +\n+            \"DROP SCHEMA IF EXISTS s2 CASCADE;\" +\n+            \"CREATE SCHEMA s1; \" +\n+            \"CREATE SCHEMA s2; \" +\n+            \"CREATE TABLE s1.a (pk SERIAL, aa integer, PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s2.a (pk SERIAL, aa integer, bb varchar(20), PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s1.heartbeat (ts TIMESTAMP WITH TIME ZONE PRIMARY KEY);\" +\n+            \"INSERT INTO s1.heartbeat (ts) VALUES (NOW());\";\n+    private static final String SETUP_TABLES_STMT = CREATE_TABLES_STMT + INSERT_STMT;\n+\n+    private PostgresInfrastructure infrastructure;\n+\n+    @Before\n+    public void setUp() {\n+        infrastructure = PostgresInfrastructure.getDebeziumPostgresInfrastructure();\n+        infrastructure.startContainer();\n+        System.setProperty(\"database.port\", String.valueOf(infrastructure.getPostgresContainer().getMappedPort(5432)));\n+        try {\n+            TestHelper.dropAllSchemas();\n+        }\n+        catch (SQLException exception) {\n+            throw new RuntimeException(exception);\n+        }\n+        initializeConnectorTestFramework();\n+    }\n+\n+    @After\n+    public void tearDown() {\n+        stopConnector();\n+        TestHelper.dropDefaultReplicationSlot();\n+        TestHelper.dropPublication();\n+        infrastructure.getPostgresContainer().stop();\n+        System.setProperty(\"database.port\", \"5432\");\n+    }\n+\n+    @Test\n+    @FixFor(\"DBZ-2617\")\n+    public void shouldStopOnPostgresFastShutdown() throws Exception {\n+        TestHelper.execute(SETUP_TABLES_STMT);\n+        final int recordCount = 100;\n+\n+        for (int i = 0; i < recordCount - 1; i++) {\n+            TestHelper.execute(INSERT_STMT);\n+        }\n+        Configuration.Builder configBuilder = TestHelper.defaultConfig()\n+                .with(CommonConnectorConfig.DATABASE_CONFIG_PREFIX + JdbcConfiguration.PORT, infrastructure.getPostgresContainer().getMappedPort(5432))\n+                .with(PostgresConnectorConfig.SNAPSHOT_MODE, SnapshotMode.ALWAYS.getValue())\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, false)\n+                .with(PostgresConnectorConfig.SCHEMA_INCLUDE_LIST, \"s1\")\n+                .with(Heartbeat.HEARTBEAT_INTERVAL, 500)\n+                .with(DatabaseHeartbeatImpl.HEARTBEAT_ACTION_QUERY, \"UPDATE s1.heartbeat SET ts=NOW();\");\n+\n+        Testing.Print.enable();\n+        String initialHeartbeat = TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {\n+            rs.next();\n+            return rs.getString(\"ts\");\n+        });\n+        start(PostgresConnector.class, configBuilder.build());\n+        assertConnectorIsRunning();\n+\n+        waitForSnapshotToBeCompleted(\"postgres\", TestHelper.TEST_SERVER);\n+        waitForStreamingRunning(\"postgres\", TestHelper.TEST_SERVER);\n+\n+        System.out.println(\"Waiting for heartbeats...\");\n+        Awaitility.await()\n+                .pollInterval(250, TimeUnit.MILLISECONDS)\n+                .atMost(10, TimeUnit.SECONDS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjA4MDM3OnYy", "diffSide": "RIGHT", "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo0NDo1NFrOHtUomg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDoxNDoxMlrOHtZ7MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI4NjA0Mg==", "bodyText": "System.out should not be used", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517286042", "createdAt": "2020-11-04T11:44:54Z", "author": {"login": "jpechane"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package io.debezium.connector.postgresql;\n+\n+import static org.junit.Assert.assertFalse;\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.awaitility.Awaitility;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.testcontainers.containers.Container;\n+\n+import io.debezium.config.CommonConnectorConfig;\n+import io.debezium.config.Configuration;\n+import io.debezium.connector.postgresql.PostgresConnectorConfig.SnapshotMode;\n+import io.debezium.doc.FixFor;\n+import io.debezium.embedded.AbstractConnectorTest;\n+import io.debezium.embedded.EmbeddedEngine;\n+import io.debezium.heartbeat.DatabaseHeartbeatImpl;\n+import io.debezium.heartbeat.Heartbeat;\n+import io.debezium.jdbc.JdbcConfiguration;\n+import io.debezium.testing.testcontainers.PostgresInfrastructure;\n+import io.debezium.util.Testing;\n+\n+/**\n+ * Integration test for {@link PostgresConnector} using an {@link EmbeddedEngine} and Testcontainers infrastructure for when Postgres is shutdown during streaming\n+ */\n+public class PostgresShutdownIT extends AbstractConnectorTest {\n+\n+    /*\n+     * Specific tests that need to extend the initial DDL set should do it in a form of\n+     * TestHelper.execute(SETUP_TABLES_STMT + ADDITIONAL_STATEMENTS)\n+     */\n+    private static final String INSERT_STMT = \"INSERT INTO s1.a (aa) VALUES (1);\" +\n+            \"INSERT INTO s2.a (aa) VALUES (1);\";\n+    private static final String CREATE_TABLES_STMT = \"DROP SCHEMA IF EXISTS s1 CASCADE;\" +\n+            \"DROP SCHEMA IF EXISTS s2 CASCADE;\" +\n+            \"CREATE SCHEMA s1; \" +\n+            \"CREATE SCHEMA s2; \" +\n+            \"CREATE TABLE s1.a (pk SERIAL, aa integer, PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s2.a (pk SERIAL, aa integer, bb varchar(20), PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s1.heartbeat (ts TIMESTAMP WITH TIME ZONE PRIMARY KEY);\" +\n+            \"INSERT INTO s1.heartbeat (ts) VALUES (NOW());\";\n+    private static final String SETUP_TABLES_STMT = CREATE_TABLES_STMT + INSERT_STMT;\n+\n+    private PostgresInfrastructure infrastructure;\n+\n+    @Before\n+    public void setUp() {\n+        infrastructure = PostgresInfrastructure.getDebeziumPostgresInfrastructure();\n+        infrastructure.startContainer();\n+        System.setProperty(\"database.port\", String.valueOf(infrastructure.getPostgresContainer().getMappedPort(5432)));\n+        try {\n+            TestHelper.dropAllSchemas();\n+        }\n+        catch (SQLException exception) {\n+            throw new RuntimeException(exception);\n+        }\n+        initializeConnectorTestFramework();\n+    }\n+\n+    @After\n+    public void tearDown() {\n+        stopConnector();\n+        TestHelper.dropDefaultReplicationSlot();\n+        TestHelper.dropPublication();\n+        infrastructure.getPostgresContainer().stop();\n+        System.setProperty(\"database.port\", \"5432\");\n+    }\n+\n+    @Test\n+    @FixFor(\"DBZ-2617\")\n+    public void shouldStopOnPostgresFastShutdown() throws Exception {\n+        TestHelper.execute(SETUP_TABLES_STMT);\n+        final int recordCount = 100;\n+\n+        for (int i = 0; i < recordCount - 1; i++) {\n+            TestHelper.execute(INSERT_STMT);\n+        }\n+        Configuration.Builder configBuilder = TestHelper.defaultConfig()\n+                .with(CommonConnectorConfig.DATABASE_CONFIG_PREFIX + JdbcConfiguration.PORT, infrastructure.getPostgresContainer().getMappedPort(5432))\n+                .with(PostgresConnectorConfig.SNAPSHOT_MODE, SnapshotMode.ALWAYS.getValue())\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, false)\n+                .with(PostgresConnectorConfig.SCHEMA_INCLUDE_LIST, \"s1\")\n+                .with(Heartbeat.HEARTBEAT_INTERVAL, 500)\n+                .with(DatabaseHeartbeatImpl.HEARTBEAT_ACTION_QUERY, \"UPDATE s1.heartbeat SET ts=NOW();\");\n+\n+        Testing.Print.enable();\n+        String initialHeartbeat = TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {\n+            rs.next();\n+            return rs.getString(\"ts\");\n+        });\n+        start(PostgresConnector.class, configBuilder.build());\n+        assertConnectorIsRunning();\n+\n+        waitForSnapshotToBeCompleted(\"postgres\", TestHelper.TEST_SERVER);\n+        waitForStreamingRunning(\"postgres\", TestHelper.TEST_SERVER);\n+\n+        System.out.println(\"Waiting for heartbeats...\");\n+        Awaitility.await()\n+                .pollInterval(250, TimeUnit.MILLISECONDS)\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> !initialHeartbeat.equals(TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {\n+                    rs.next();\n+                    return rs.getString(\"ts\");\n+                })));\n+        System.out.println(\"INTIAL Heartbeat: \" + initialHeartbeat + \" ; CURRENT heartbeat: \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM3MjcyMA==", "bodyText": "Ooops!", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517372720", "createdAt": "2020-11-04T14:14:12Z", "author": {"login": "rk3rn3r"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package io.debezium.connector.postgresql;\n+\n+import static org.junit.Assert.assertFalse;\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.awaitility.Awaitility;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.testcontainers.containers.Container;\n+\n+import io.debezium.config.CommonConnectorConfig;\n+import io.debezium.config.Configuration;\n+import io.debezium.connector.postgresql.PostgresConnectorConfig.SnapshotMode;\n+import io.debezium.doc.FixFor;\n+import io.debezium.embedded.AbstractConnectorTest;\n+import io.debezium.embedded.EmbeddedEngine;\n+import io.debezium.heartbeat.DatabaseHeartbeatImpl;\n+import io.debezium.heartbeat.Heartbeat;\n+import io.debezium.jdbc.JdbcConfiguration;\n+import io.debezium.testing.testcontainers.PostgresInfrastructure;\n+import io.debezium.util.Testing;\n+\n+/**\n+ * Integration test for {@link PostgresConnector} using an {@link EmbeddedEngine} and Testcontainers infrastructure for when Postgres is shutdown during streaming\n+ */\n+public class PostgresShutdownIT extends AbstractConnectorTest {\n+\n+    /*\n+     * Specific tests that need to extend the initial DDL set should do it in a form of\n+     * TestHelper.execute(SETUP_TABLES_STMT + ADDITIONAL_STATEMENTS)\n+     */\n+    private static final String INSERT_STMT = \"INSERT INTO s1.a (aa) VALUES (1);\" +\n+            \"INSERT INTO s2.a (aa) VALUES (1);\";\n+    private static final String CREATE_TABLES_STMT = \"DROP SCHEMA IF EXISTS s1 CASCADE;\" +\n+            \"DROP SCHEMA IF EXISTS s2 CASCADE;\" +\n+            \"CREATE SCHEMA s1; \" +\n+            \"CREATE SCHEMA s2; \" +\n+            \"CREATE TABLE s1.a (pk SERIAL, aa integer, PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s2.a (pk SERIAL, aa integer, bb varchar(20), PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s1.heartbeat (ts TIMESTAMP WITH TIME ZONE PRIMARY KEY);\" +\n+            \"INSERT INTO s1.heartbeat (ts) VALUES (NOW());\";\n+    private static final String SETUP_TABLES_STMT = CREATE_TABLES_STMT + INSERT_STMT;\n+\n+    private PostgresInfrastructure infrastructure;\n+\n+    @Before\n+    public void setUp() {\n+        infrastructure = PostgresInfrastructure.getDebeziumPostgresInfrastructure();\n+        infrastructure.startContainer();\n+        System.setProperty(\"database.port\", String.valueOf(infrastructure.getPostgresContainer().getMappedPort(5432)));\n+        try {\n+            TestHelper.dropAllSchemas();\n+        }\n+        catch (SQLException exception) {\n+            throw new RuntimeException(exception);\n+        }\n+        initializeConnectorTestFramework();\n+    }\n+\n+    @After\n+    public void tearDown() {\n+        stopConnector();\n+        TestHelper.dropDefaultReplicationSlot();\n+        TestHelper.dropPublication();\n+        infrastructure.getPostgresContainer().stop();\n+        System.setProperty(\"database.port\", \"5432\");\n+    }\n+\n+    @Test\n+    @FixFor(\"DBZ-2617\")\n+    public void shouldStopOnPostgresFastShutdown() throws Exception {\n+        TestHelper.execute(SETUP_TABLES_STMT);\n+        final int recordCount = 100;\n+\n+        for (int i = 0; i < recordCount - 1; i++) {\n+            TestHelper.execute(INSERT_STMT);\n+        }\n+        Configuration.Builder configBuilder = TestHelper.defaultConfig()\n+                .with(CommonConnectorConfig.DATABASE_CONFIG_PREFIX + JdbcConfiguration.PORT, infrastructure.getPostgresContainer().getMappedPort(5432))\n+                .with(PostgresConnectorConfig.SNAPSHOT_MODE, SnapshotMode.ALWAYS.getValue())\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, false)\n+                .with(PostgresConnectorConfig.SCHEMA_INCLUDE_LIST, \"s1\")\n+                .with(Heartbeat.HEARTBEAT_INTERVAL, 500)\n+                .with(DatabaseHeartbeatImpl.HEARTBEAT_ACTION_QUERY, \"UPDATE s1.heartbeat SET ts=NOW();\");\n+\n+        Testing.Print.enable();\n+        String initialHeartbeat = TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {\n+            rs.next();\n+            return rs.getString(\"ts\");\n+        });\n+        start(PostgresConnector.class, configBuilder.build());\n+        assertConnectorIsRunning();\n+\n+        waitForSnapshotToBeCompleted(\"postgres\", TestHelper.TEST_SERVER);\n+        waitForStreamingRunning(\"postgres\", TestHelper.TEST_SERVER);\n+\n+        System.out.println(\"Waiting for heartbeats...\");\n+        Awaitility.await()\n+                .pollInterval(250, TimeUnit.MILLISECONDS)\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> !initialHeartbeat.equals(TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {\n+                    rs.next();\n+                    return rs.getString(\"ts\");\n+                })));\n+        System.out.println(\"INTIAL Heartbeat: \" + initialHeartbeat + \" ; CURRENT heartbeat: \"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI4NjA0Mg=="}, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 114}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjA4MTY0OnYy", "diffSide": "RIGHT", "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo0NToxNlrOHtUpWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo0NToxNlrOHtUpWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI4NjIzMw==", "bodyText": "See mapper above", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517286233", "createdAt": "2020-11-04T11:45:16Z", "author": {"login": "jpechane"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package io.debezium.connector.postgresql;\n+\n+import static org.junit.Assert.assertFalse;\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.awaitility.Awaitility;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.testcontainers.containers.Container;\n+\n+import io.debezium.config.CommonConnectorConfig;\n+import io.debezium.config.Configuration;\n+import io.debezium.connector.postgresql.PostgresConnectorConfig.SnapshotMode;\n+import io.debezium.doc.FixFor;\n+import io.debezium.embedded.AbstractConnectorTest;\n+import io.debezium.embedded.EmbeddedEngine;\n+import io.debezium.heartbeat.DatabaseHeartbeatImpl;\n+import io.debezium.heartbeat.Heartbeat;\n+import io.debezium.jdbc.JdbcConfiguration;\n+import io.debezium.testing.testcontainers.PostgresInfrastructure;\n+import io.debezium.util.Testing;\n+\n+/**\n+ * Integration test for {@link PostgresConnector} using an {@link EmbeddedEngine} and Testcontainers infrastructure for when Postgres is shutdown during streaming\n+ */\n+public class PostgresShutdownIT extends AbstractConnectorTest {\n+\n+    /*\n+     * Specific tests that need to extend the initial DDL set should do it in a form of\n+     * TestHelper.execute(SETUP_TABLES_STMT + ADDITIONAL_STATEMENTS)\n+     */\n+    private static final String INSERT_STMT = \"INSERT INTO s1.a (aa) VALUES (1);\" +\n+            \"INSERT INTO s2.a (aa) VALUES (1);\";\n+    private static final String CREATE_TABLES_STMT = \"DROP SCHEMA IF EXISTS s1 CASCADE;\" +\n+            \"DROP SCHEMA IF EXISTS s2 CASCADE;\" +\n+            \"CREATE SCHEMA s1; \" +\n+            \"CREATE SCHEMA s2; \" +\n+            \"CREATE TABLE s1.a (pk SERIAL, aa integer, PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s2.a (pk SERIAL, aa integer, bb varchar(20), PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s1.heartbeat (ts TIMESTAMP WITH TIME ZONE PRIMARY KEY);\" +\n+            \"INSERT INTO s1.heartbeat (ts) VALUES (NOW());\";\n+    private static final String SETUP_TABLES_STMT = CREATE_TABLES_STMT + INSERT_STMT;\n+\n+    private PostgresInfrastructure infrastructure;\n+\n+    @Before\n+    public void setUp() {\n+        infrastructure = PostgresInfrastructure.getDebeziumPostgresInfrastructure();\n+        infrastructure.startContainer();\n+        System.setProperty(\"database.port\", String.valueOf(infrastructure.getPostgresContainer().getMappedPort(5432)));\n+        try {\n+            TestHelper.dropAllSchemas();\n+        }\n+        catch (SQLException exception) {\n+            throw new RuntimeException(exception);\n+        }\n+        initializeConnectorTestFramework();\n+    }\n+\n+    @After\n+    public void tearDown() {\n+        stopConnector();\n+        TestHelper.dropDefaultReplicationSlot();\n+        TestHelper.dropPublication();\n+        infrastructure.getPostgresContainer().stop();\n+        System.setProperty(\"database.port\", \"5432\");\n+    }\n+\n+    @Test\n+    @FixFor(\"DBZ-2617\")\n+    public void shouldStopOnPostgresFastShutdown() throws Exception {\n+        TestHelper.execute(SETUP_TABLES_STMT);\n+        final int recordCount = 100;\n+\n+        for (int i = 0; i < recordCount - 1; i++) {\n+            TestHelper.execute(INSERT_STMT);\n+        }\n+        Configuration.Builder configBuilder = TestHelper.defaultConfig()\n+                .with(CommonConnectorConfig.DATABASE_CONFIG_PREFIX + JdbcConfiguration.PORT, infrastructure.getPostgresContainer().getMappedPort(5432))\n+                .with(PostgresConnectorConfig.SNAPSHOT_MODE, SnapshotMode.ALWAYS.getValue())\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, false)\n+                .with(PostgresConnectorConfig.SCHEMA_INCLUDE_LIST, \"s1\")\n+                .with(Heartbeat.HEARTBEAT_INTERVAL, 500)\n+                .with(DatabaseHeartbeatImpl.HEARTBEAT_ACTION_QUERY, \"UPDATE s1.heartbeat SET ts=NOW();\");\n+\n+        Testing.Print.enable();\n+        String initialHeartbeat = TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {\n+            rs.next();\n+            return rs.getString(\"ts\");\n+        });\n+        start(PostgresConnector.class, configBuilder.build());\n+        assertConnectorIsRunning();\n+\n+        waitForSnapshotToBeCompleted(\"postgres\", TestHelper.TEST_SERVER);\n+        waitForStreamingRunning(\"postgres\", TestHelper.TEST_SERVER);\n+\n+        System.out.println(\"Waiting for heartbeats...\");\n+        Awaitility.await()\n+                .pollInterval(250, TimeUnit.MILLISECONDS)\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> !initialHeartbeat.equals(TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {\n+                    rs.next();\n+                    return rs.getString(\"ts\");\n+                })));\n+        System.out.println(\"INTIAL Heartbeat: \" + initialHeartbeat + \" ; CURRENT heartbeat: \"\n+                + TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 115}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjA4MjUyOnYy", "diffSide": "RIGHT", "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo0NTozNlrOHtUp3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo0NTozNlrOHtUp3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI4NjM2NA==", "bodyText": "System.out", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517286364", "createdAt": "2020-11-04T11:45:36Z", "author": {"login": "jpechane"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package io.debezium.connector.postgresql;\n+\n+import static org.junit.Assert.assertFalse;\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.awaitility.Awaitility;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.testcontainers.containers.Container;\n+\n+import io.debezium.config.CommonConnectorConfig;\n+import io.debezium.config.Configuration;\n+import io.debezium.connector.postgresql.PostgresConnectorConfig.SnapshotMode;\n+import io.debezium.doc.FixFor;\n+import io.debezium.embedded.AbstractConnectorTest;\n+import io.debezium.embedded.EmbeddedEngine;\n+import io.debezium.heartbeat.DatabaseHeartbeatImpl;\n+import io.debezium.heartbeat.Heartbeat;\n+import io.debezium.jdbc.JdbcConfiguration;\n+import io.debezium.testing.testcontainers.PostgresInfrastructure;\n+import io.debezium.util.Testing;\n+\n+/**\n+ * Integration test for {@link PostgresConnector} using an {@link EmbeddedEngine} and Testcontainers infrastructure for when Postgres is shutdown during streaming\n+ */\n+public class PostgresShutdownIT extends AbstractConnectorTest {\n+\n+    /*\n+     * Specific tests that need to extend the initial DDL set should do it in a form of\n+     * TestHelper.execute(SETUP_TABLES_STMT + ADDITIONAL_STATEMENTS)\n+     */\n+    private static final String INSERT_STMT = \"INSERT INTO s1.a (aa) VALUES (1);\" +\n+            \"INSERT INTO s2.a (aa) VALUES (1);\";\n+    private static final String CREATE_TABLES_STMT = \"DROP SCHEMA IF EXISTS s1 CASCADE;\" +\n+            \"DROP SCHEMA IF EXISTS s2 CASCADE;\" +\n+            \"CREATE SCHEMA s1; \" +\n+            \"CREATE SCHEMA s2; \" +\n+            \"CREATE TABLE s1.a (pk SERIAL, aa integer, PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s2.a (pk SERIAL, aa integer, bb varchar(20), PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s1.heartbeat (ts TIMESTAMP WITH TIME ZONE PRIMARY KEY);\" +\n+            \"INSERT INTO s1.heartbeat (ts) VALUES (NOW());\";\n+    private static final String SETUP_TABLES_STMT = CREATE_TABLES_STMT + INSERT_STMT;\n+\n+    private PostgresInfrastructure infrastructure;\n+\n+    @Before\n+    public void setUp() {\n+        infrastructure = PostgresInfrastructure.getDebeziumPostgresInfrastructure();\n+        infrastructure.startContainer();\n+        System.setProperty(\"database.port\", String.valueOf(infrastructure.getPostgresContainer().getMappedPort(5432)));\n+        try {\n+            TestHelper.dropAllSchemas();\n+        }\n+        catch (SQLException exception) {\n+            throw new RuntimeException(exception);\n+        }\n+        initializeConnectorTestFramework();\n+    }\n+\n+    @After\n+    public void tearDown() {\n+        stopConnector();\n+        TestHelper.dropDefaultReplicationSlot();\n+        TestHelper.dropPublication();\n+        infrastructure.getPostgresContainer().stop();\n+        System.setProperty(\"database.port\", \"5432\");\n+    }\n+\n+    @Test\n+    @FixFor(\"DBZ-2617\")\n+    public void shouldStopOnPostgresFastShutdown() throws Exception {\n+        TestHelper.execute(SETUP_TABLES_STMT);\n+        final int recordCount = 100;\n+\n+        for (int i = 0; i < recordCount - 1; i++) {\n+            TestHelper.execute(INSERT_STMT);\n+        }\n+        Configuration.Builder configBuilder = TestHelper.defaultConfig()\n+                .with(CommonConnectorConfig.DATABASE_CONFIG_PREFIX + JdbcConfiguration.PORT, infrastructure.getPostgresContainer().getMappedPort(5432))\n+                .with(PostgresConnectorConfig.SNAPSHOT_MODE, SnapshotMode.ALWAYS.getValue())\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, false)\n+                .with(PostgresConnectorConfig.SCHEMA_INCLUDE_LIST, \"s1\")\n+                .with(Heartbeat.HEARTBEAT_INTERVAL, 500)\n+                .with(DatabaseHeartbeatImpl.HEARTBEAT_ACTION_QUERY, \"UPDATE s1.heartbeat SET ts=NOW();\");\n+\n+        Testing.Print.enable();\n+        String initialHeartbeat = TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {\n+            rs.next();\n+            return rs.getString(\"ts\");\n+        });\n+        start(PostgresConnector.class, configBuilder.build());\n+        assertConnectorIsRunning();\n+\n+        waitForSnapshotToBeCompleted(\"postgres\", TestHelper.TEST_SERVER);\n+        waitForStreamingRunning(\"postgres\", TestHelper.TEST_SERVER);\n+\n+        System.out.println(\"Waiting for heartbeats...\");\n+        Awaitility.await()\n+                .pollInterval(250, TimeUnit.MILLISECONDS)\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> !initialHeartbeat.equals(TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {\n+                    rs.next();\n+                    return rs.getString(\"ts\");\n+                })));\n+        System.out.println(\"INTIAL Heartbeat: \" + initialHeartbeat + \" ; CURRENT heartbeat: \"\n+                + TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {\n+                    rs.next();\n+                    return rs.getString(\"ts\");\n+                }));\n+\n+        System.out.println(\"Execute Postgres shutdown...\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 120}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjA4MzMxOnYy", "diffSide": "RIGHT", "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo0NTo1MFrOHtUqVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo0NTo1MFrOHtUqVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI4NjQ4Nw==", "bodyText": "System.out", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517286487", "createdAt": "2020-11-04T11:45:50Z", "author": {"login": "jpechane"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package io.debezium.connector.postgresql;\n+\n+import static org.junit.Assert.assertFalse;\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.awaitility.Awaitility;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.testcontainers.containers.Container;\n+\n+import io.debezium.config.CommonConnectorConfig;\n+import io.debezium.config.Configuration;\n+import io.debezium.connector.postgresql.PostgresConnectorConfig.SnapshotMode;\n+import io.debezium.doc.FixFor;\n+import io.debezium.embedded.AbstractConnectorTest;\n+import io.debezium.embedded.EmbeddedEngine;\n+import io.debezium.heartbeat.DatabaseHeartbeatImpl;\n+import io.debezium.heartbeat.Heartbeat;\n+import io.debezium.jdbc.JdbcConfiguration;\n+import io.debezium.testing.testcontainers.PostgresInfrastructure;\n+import io.debezium.util.Testing;\n+\n+/**\n+ * Integration test for {@link PostgresConnector} using an {@link EmbeddedEngine} and Testcontainers infrastructure for when Postgres is shutdown during streaming\n+ */\n+public class PostgresShutdownIT extends AbstractConnectorTest {\n+\n+    /*\n+     * Specific tests that need to extend the initial DDL set should do it in a form of\n+     * TestHelper.execute(SETUP_TABLES_STMT + ADDITIONAL_STATEMENTS)\n+     */\n+    private static final String INSERT_STMT = \"INSERT INTO s1.a (aa) VALUES (1);\" +\n+            \"INSERT INTO s2.a (aa) VALUES (1);\";\n+    private static final String CREATE_TABLES_STMT = \"DROP SCHEMA IF EXISTS s1 CASCADE;\" +\n+            \"DROP SCHEMA IF EXISTS s2 CASCADE;\" +\n+            \"CREATE SCHEMA s1; \" +\n+            \"CREATE SCHEMA s2; \" +\n+            \"CREATE TABLE s1.a (pk SERIAL, aa integer, PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s2.a (pk SERIAL, aa integer, bb varchar(20), PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s1.heartbeat (ts TIMESTAMP WITH TIME ZONE PRIMARY KEY);\" +\n+            \"INSERT INTO s1.heartbeat (ts) VALUES (NOW());\";\n+    private static final String SETUP_TABLES_STMT = CREATE_TABLES_STMT + INSERT_STMT;\n+\n+    private PostgresInfrastructure infrastructure;\n+\n+    @Before\n+    public void setUp() {\n+        infrastructure = PostgresInfrastructure.getDebeziumPostgresInfrastructure();\n+        infrastructure.startContainer();\n+        System.setProperty(\"database.port\", String.valueOf(infrastructure.getPostgresContainer().getMappedPort(5432)));\n+        try {\n+            TestHelper.dropAllSchemas();\n+        }\n+        catch (SQLException exception) {\n+            throw new RuntimeException(exception);\n+        }\n+        initializeConnectorTestFramework();\n+    }\n+\n+    @After\n+    public void tearDown() {\n+        stopConnector();\n+        TestHelper.dropDefaultReplicationSlot();\n+        TestHelper.dropPublication();\n+        infrastructure.getPostgresContainer().stop();\n+        System.setProperty(\"database.port\", \"5432\");\n+    }\n+\n+    @Test\n+    @FixFor(\"DBZ-2617\")\n+    public void shouldStopOnPostgresFastShutdown() throws Exception {\n+        TestHelper.execute(SETUP_TABLES_STMT);\n+        final int recordCount = 100;\n+\n+        for (int i = 0; i < recordCount - 1; i++) {\n+            TestHelper.execute(INSERT_STMT);\n+        }\n+        Configuration.Builder configBuilder = TestHelper.defaultConfig()\n+                .with(CommonConnectorConfig.DATABASE_CONFIG_PREFIX + JdbcConfiguration.PORT, infrastructure.getPostgresContainer().getMappedPort(5432))\n+                .with(PostgresConnectorConfig.SNAPSHOT_MODE, SnapshotMode.ALWAYS.getValue())\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, false)\n+                .with(PostgresConnectorConfig.SCHEMA_INCLUDE_LIST, \"s1\")\n+                .with(Heartbeat.HEARTBEAT_INTERVAL, 500)\n+                .with(DatabaseHeartbeatImpl.HEARTBEAT_ACTION_QUERY, \"UPDATE s1.heartbeat SET ts=NOW();\");\n+\n+        Testing.Print.enable();\n+        String initialHeartbeat = TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {\n+            rs.next();\n+            return rs.getString(\"ts\");\n+        });\n+        start(PostgresConnector.class, configBuilder.build());\n+        assertConnectorIsRunning();\n+\n+        waitForSnapshotToBeCompleted(\"postgres\", TestHelper.TEST_SERVER);\n+        waitForStreamingRunning(\"postgres\", TestHelper.TEST_SERVER);\n+\n+        System.out.println(\"Waiting for heartbeats...\");\n+        Awaitility.await()\n+                .pollInterval(250, TimeUnit.MILLISECONDS)\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> !initialHeartbeat.equals(TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {\n+                    rs.next();\n+                    return rs.getString(\"ts\");\n+                })));\n+        System.out.println(\"INTIAL Heartbeat: \" + initialHeartbeat + \" ; CURRENT heartbeat: \"\n+                + TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {\n+                    rs.next();\n+                    return rs.getString(\"ts\");\n+                }));\n+\n+        System.out.println(\"Execute Postgres shutdown...\");\n+        Container.ExecResult result = infrastructure.getPostgresContainer()\n+                .execInContainer(\"su\", \"-\", \"postgres\", \"-c\", \"/usr/lib/postgresql/11/bin/pg_ctl -m fast -D /var/lib/postgresql/data stop\");\n+        System.out.println(result.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 123}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjA4NjY2OnYy", "diffSide": "RIGHT", "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo0Njo0NlrOHtUsVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo0Njo0NlrOHtUsVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI4Njk5OQ==", "bodyText": "Please derive it from io.debezium.connector.postgresql.TestHelper.waitTimeForRecords()", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517286999", "createdAt": "2020-11-04T11:46:46Z", "author": {"login": "jpechane"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package io.debezium.connector.postgresql;\n+\n+import static org.junit.Assert.assertFalse;\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.awaitility.Awaitility;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.testcontainers.containers.Container;\n+\n+import io.debezium.config.CommonConnectorConfig;\n+import io.debezium.config.Configuration;\n+import io.debezium.connector.postgresql.PostgresConnectorConfig.SnapshotMode;\n+import io.debezium.doc.FixFor;\n+import io.debezium.embedded.AbstractConnectorTest;\n+import io.debezium.embedded.EmbeddedEngine;\n+import io.debezium.heartbeat.DatabaseHeartbeatImpl;\n+import io.debezium.heartbeat.Heartbeat;\n+import io.debezium.jdbc.JdbcConfiguration;\n+import io.debezium.testing.testcontainers.PostgresInfrastructure;\n+import io.debezium.util.Testing;\n+\n+/**\n+ * Integration test for {@link PostgresConnector} using an {@link EmbeddedEngine} and Testcontainers infrastructure for when Postgres is shutdown during streaming\n+ */\n+public class PostgresShutdownIT extends AbstractConnectorTest {\n+\n+    /*\n+     * Specific tests that need to extend the initial DDL set should do it in a form of\n+     * TestHelper.execute(SETUP_TABLES_STMT + ADDITIONAL_STATEMENTS)\n+     */\n+    private static final String INSERT_STMT = \"INSERT INTO s1.a (aa) VALUES (1);\" +\n+            \"INSERT INTO s2.a (aa) VALUES (1);\";\n+    private static final String CREATE_TABLES_STMT = \"DROP SCHEMA IF EXISTS s1 CASCADE;\" +\n+            \"DROP SCHEMA IF EXISTS s2 CASCADE;\" +\n+            \"CREATE SCHEMA s1; \" +\n+            \"CREATE SCHEMA s2; \" +\n+            \"CREATE TABLE s1.a (pk SERIAL, aa integer, PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s2.a (pk SERIAL, aa integer, bb varchar(20), PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s1.heartbeat (ts TIMESTAMP WITH TIME ZONE PRIMARY KEY);\" +\n+            \"INSERT INTO s1.heartbeat (ts) VALUES (NOW());\";\n+    private static final String SETUP_TABLES_STMT = CREATE_TABLES_STMT + INSERT_STMT;\n+\n+    private PostgresInfrastructure infrastructure;\n+\n+    @Before\n+    public void setUp() {\n+        infrastructure = PostgresInfrastructure.getDebeziumPostgresInfrastructure();\n+        infrastructure.startContainer();\n+        System.setProperty(\"database.port\", String.valueOf(infrastructure.getPostgresContainer().getMappedPort(5432)));\n+        try {\n+            TestHelper.dropAllSchemas();\n+        }\n+        catch (SQLException exception) {\n+            throw new RuntimeException(exception);\n+        }\n+        initializeConnectorTestFramework();\n+    }\n+\n+    @After\n+    public void tearDown() {\n+        stopConnector();\n+        TestHelper.dropDefaultReplicationSlot();\n+        TestHelper.dropPublication();\n+        infrastructure.getPostgresContainer().stop();\n+        System.setProperty(\"database.port\", \"5432\");\n+    }\n+\n+    @Test\n+    @FixFor(\"DBZ-2617\")\n+    public void shouldStopOnPostgresFastShutdown() throws Exception {\n+        TestHelper.execute(SETUP_TABLES_STMT);\n+        final int recordCount = 100;\n+\n+        for (int i = 0; i < recordCount - 1; i++) {\n+            TestHelper.execute(INSERT_STMT);\n+        }\n+        Configuration.Builder configBuilder = TestHelper.defaultConfig()\n+                .with(CommonConnectorConfig.DATABASE_CONFIG_PREFIX + JdbcConfiguration.PORT, infrastructure.getPostgresContainer().getMappedPort(5432))\n+                .with(PostgresConnectorConfig.SNAPSHOT_MODE, SnapshotMode.ALWAYS.getValue())\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, false)\n+                .with(PostgresConnectorConfig.SCHEMA_INCLUDE_LIST, \"s1\")\n+                .with(Heartbeat.HEARTBEAT_INTERVAL, 500)\n+                .with(DatabaseHeartbeatImpl.HEARTBEAT_ACTION_QUERY, \"UPDATE s1.heartbeat SET ts=NOW();\");\n+\n+        Testing.Print.enable();\n+        String initialHeartbeat = TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {\n+            rs.next();\n+            return rs.getString(\"ts\");\n+        });\n+        start(PostgresConnector.class, configBuilder.build());\n+        assertConnectorIsRunning();\n+\n+        waitForSnapshotToBeCompleted(\"postgres\", TestHelper.TEST_SERVER);\n+        waitForStreamingRunning(\"postgres\", TestHelper.TEST_SERVER);\n+\n+        System.out.println(\"Waiting for heartbeats...\");\n+        Awaitility.await()\n+                .pollInterval(250, TimeUnit.MILLISECONDS)\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> !initialHeartbeat.equals(TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {\n+                    rs.next();\n+                    return rs.getString(\"ts\");\n+                })));\n+        System.out.println(\"INTIAL Heartbeat: \" + initialHeartbeat + \" ; CURRENT heartbeat: \"\n+                + TestHelper.create().queryAndMap(\"SELECT ts FROM s1.heartbeat;\", rs -> {\n+                    rs.next();\n+                    return rs.getString(\"ts\");\n+                }));\n+\n+        System.out.println(\"Execute Postgres shutdown...\");\n+        Container.ExecResult result = infrastructure.getPostgresContainer()\n+                .execInContainer(\"su\", \"-\", \"postgres\", \"-c\", \"/usr/lib/postgresql/11/bin/pg_ctl -m fast -D /var/lib/postgresql/data stop\");\n+        System.out.println(result.toString());\n+\n+        System.out.println(\"Waiting for Postgres to shutdown...\");\n+        waitForPostgresShutdown();\n+\n+        assertFalse(isStreamingRunning(\"postgres\", TestHelper.TEST_SERVER));\n+    }\n+\n+    private void waitForPostgresShutdown() {\n+        Awaitility.await()\n+                .pollInterval(200, TimeUnit.MILLISECONDS)\n+                .atMost(2, TimeUnit.MINUTES)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 134}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjA5NDgyOnYy", "diffSide": "RIGHT", "path": "debezium-embedded/src/test/java/io/debezium/embedded/AbstractConnectorTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo0OToxNFrOHtUxTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMToxNTozM1rOHuqFQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI4ODI2OQ==", "bodyText": "As you are doing the unrelated changes please again replace it with a value derived from configurable timeout", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517288269", "createdAt": "2020-11-04T11:49:14Z", "author": {"login": "jpechane"}, "path": "debezium-embedded/src/test/java/io/debezium/embedded/AbstractConnectorTest.java", "diffHunk": "@@ -1052,12 +1053,23 @@ public static void waitForStreamingRunning(String connector, String server, Stri\n                 .pollInterval(100, TimeUnit.MILLISECONDS)\n                 .atMost(60, TimeUnit.SECONDS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY4NjAxOA==", "bodyText": "will do", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r518686018", "createdAt": "2020-11-06T11:15:33Z", "author": {"login": "rk3rn3r"}, "path": "debezium-embedded/src/test/java/io/debezium/embedded/AbstractConnectorTest.java", "diffHunk": "@@ -1052,12 +1053,23 @@ public static void waitForStreamingRunning(String connector, String server, Stri\n                 .pollInterval(100, TimeUnit.MILLISECONDS)\n                 .atMost(60, TimeUnit.SECONDS)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI4ODI2OQ=="}, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjA5ODQzOnYy", "diffSide": "RIGHT", "path": "debezium-embedded/src/test/java/io/debezium/embedded/AbstractConnectorTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo1MDoxNlrOHtUzZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo1MDoxNlrOHtUzZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI4ODgwNA==", "bodyText": "Channge to call of isStreamingRunning", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517288804", "createdAt": "2020-11-04T11:50:16Z", "author": {"login": "jpechane"}, "path": "debezium-embedded/src/test/java/io/debezium/embedded/AbstractConnectorTest.java", "diffHunk": "@@ -1052,12 +1053,23 @@ public static void waitForStreamingRunning(String connector, String server, Stri\n                 .pollInterval(100, TimeUnit.MILLISECONDS)\n                 .atMost(60, TimeUnit.SECONDS)\n                 .ignoreException(InstanceNotFoundException.class)\n-                .until(() -> {\n-                    boolean connected = (boolean) mbeanServer\n-                            .getAttribute(getStreamingMetricsObjectName(connector, server, contextName), \"Connected\");\n+                .until(() -> (boolean) mbeanServer", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjEwNTEyOnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/ConnectorConfiguration.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo1MjoxNFrOHtU3Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo1MjoxNFrOHtU3Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI4OTgwMg==", "bodyText": "final", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517289802", "createdAt": "2020-11-04T11:52:14Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/ConnectorConfiguration.java", "diffHunk": "@@ -18,11 +18,11 @@\n  */\n public class ConnectorConfiguration {\n \n-    private final ObjectMapper mapper = new ObjectMapper();\n     private final ObjectNode configNode;\n \n     protected ConnectorConfiguration() {\n-        this.configNode = this.mapper.createObjectNode();\n+        ObjectMapper mapper = new ObjectMapper();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjEwNzI2OnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo1MzowNVrOHtU4uA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDozOTozNVrOHtbD_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5MDE2OA==", "bodyText": "Should be KAFKA_CONNECT_PORT?", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517290168", "createdAt": "2020-11-04T11:53:05Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -68,10 +77,42 @@ public DebeziumContainer withKafka(final Network network, final String bootstrap\n         return self();\n     }\n \n+    public String getTarget() {\n+        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5MTM1Nw==", "bodyText": "That's the same method as before it just moved up. the env var is container specific. this code uses the Testcontainers API to get the correct values.", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517391357", "createdAt": "2020-11-04T14:39:35Z", "author": {"login": "rk3rn3r"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -68,10 +77,42 @@ public DebeziumContainer withKafka(final Network network, final String bootstrap\n         return self();\n     }\n \n+    public String getTarget() {\n+        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5MDE2OA=="}, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjExMjM5OnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo1NDo0MFrOHtU77g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo1NDo0MFrOHtU77g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5MDk5MA==", "bodyText": "final", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517290990", "createdAt": "2020-11-04T11:54:40Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 106}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjExNTg0OnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo1NTozOVrOHtU99A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNTowMDoxMlrOHtcAbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5MTUwOA==", "bodyText": "Is it necessary? You use try with resources. Then you can also use only return without helper variable.", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517291508", "createdAt": "2020-11-04T11:55:39Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNjgzMQ==", "bodyText": "I thought that as well, but there were warnings when I introduced it without the manual closing about not closing it properly (with quarkus + resteasy) and they were gone after adding it everywhere.", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517406831", "createdAt": "2020-11-04T15:00:12Z", "author": {"login": "rk3rn3r"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5MTUwOA=="}, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 127}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjEyMDE4OnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo1Njo1NlrOHtVAnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo1Njo1NlrOHtVAnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5MjE5MQ==", "bodyText": "Make it configurable - mind CI", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517292191", "createdAt": "2020-11-04T11:56:56Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 150}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjEyNjQzOnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo1ODo0N1rOHtVEcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo1ODo0N1rOHtVEcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5MzE2OQ==", "bodyText": "final", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517293169", "createdAt": "2020-11-04T11:58:47Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 157}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjEyODQ4OnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo1OToyM1rOHtVFxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwOTo1NzoxNlrOHunbOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5MzUwOQ==", "bodyText": "Method signature contains IOException - why do you encapsulate it?", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517293509", "createdAt": "2020-11-04T11:59:23Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();\n+                return MAPPER.readValue(string, new TypeReference<List<String>>() {\n+                });\n+            }\n+        }\n+        catch (IOException e) {\n+            throw new RuntimeException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 167}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0MjQ5MA==", "bodyText": "The signature was old code, I removed the exception on the signature now. This is used for integration testing. When we are not able to talk to the Container it should imo be a RuntimeException and fail because the reason can only be a wrong state created by the testing code.", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r518642490", "createdAt": "2020-11-06T09:57:16Z", "author": {"login": "rk3rn3r"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();\n+                return MAPPER.readValue(string, new TypeReference<List<String>>() {\n+                });\n+            }\n+        }\n+        catch (IOException e) {\n+            throw new RuntimeException(e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5MzUwOQ=="}, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 167}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjEzMDI0OnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTo1OTo1MVrOHtVGxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNTowNDo0N1rOHtcNvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5Mzc2NQ==", "bodyText": "Try with resources", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517293765", "createdAt": "2020-11-04T11:59:51Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 161}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQxMDIzNw==", "bodyText": "see above", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517410237", "createdAt": "2020-11-04T15:04:47Z", "author": {"login": "rk3rn3r"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5Mzc2NQ=="}, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 161}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjEzMTU0OnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMDoxMlrOHtVHgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMDoxMlrOHtVHgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5Mzk1NQ==", "bodyText": "Try with resources", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517293955", "createdAt": "2020-11-04T12:00:12Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();\n+                return MAPPER.readValue(string, new TypeReference<List<String>>() {\n+                });\n+            }\n+        }\n+        catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+        return Collections.emptyList();\n+    }\n+\n+    public boolean isConnectorConfigured(String connectorName) throws IOException {\n+        Request request = new Request.Builder().url(getConnectorURI(connectorName)).get().build();\n+        try (Response response = executeRequest(request)) {\n+            boolean isConnectorConfigured = response.isSuccessful();\n+            response.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 176}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjEzMjgzOnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMDozNFrOHtVIPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMToyNDozNFrOHuqWnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NDE0MQ==", "bodyText": "Configurable timeout", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517294141", "createdAt": "2020-11-04T12:00:34Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();\n+                return MAPPER.readValue(string, new TypeReference<List<String>>() {\n+                });\n+            }\n+        }\n+        catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+        return Collections.emptyList();\n+    }\n+\n+    public boolean isConnectorConfigured(String connectorName) throws IOException {\n+        Request request = new Request.Builder().url(getConnectorURI(connectorName)).get().build();\n+        try (Response response = executeRequest(request)) {\n+            boolean isConnectorConfigured = response.isSuccessful();\n+            response.close();\n+            return isConnectorConfigured;\n+        }\n+    }\n+\n+    public void ensureConnectorRegistered(String connectorName) {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 183}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY5MDQ2Mw==", "bodyText": "Done", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r518690463", "createdAt": "2020-11-06T11:24:34Z", "author": {"login": "rk3rn3r"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();\n+                return MAPPER.readValue(string, new TypeReference<List<String>>() {\n+                });\n+            }\n+        }\n+        catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+        return Collections.emptyList();\n+    }\n+\n+    public boolean isConnectorConfigured(String connectorName) throws IOException {\n+        Request request = new Request.Builder().url(getConnectorURI(connectorName)).get().build();\n+        try (Response response = executeRequest(request)) {\n+            boolean isConnectorConfigured = response.isSuccessful();\n+            response.close();\n+            return isConnectorConfigured;\n+        }\n+    }\n+\n+    public void ensureConnectorRegistered(String connectorName) {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NDE0MQ=="}, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 183}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjEzNDA1OnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMDo1N1rOHtVI_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMDowMDoxNVrOHuniMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NDMzMw==", "bodyText": "Configurable timeout", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517294333", "createdAt": "2020-11-04T12:00:57Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();\n+                return MAPPER.readValue(string, new TypeReference<List<String>>() {\n+                });\n+            }\n+        }\n+        catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+        return Collections.emptyList();\n+    }\n+\n+    public boolean isConnectorConfigured(String connectorName) throws IOException {\n+        Request request = new Request.Builder().url(getConnectorURI(connectorName)).get().build();\n+        try (Response response = executeRequest(request)) {\n+            boolean isConnectorConfigured = response.isSuccessful();\n+            response.close();\n+            return isConnectorConfigured;\n+        }\n+    }\n+\n+    public void ensureConnectorRegistered(String connectorName) {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> isConnectorConfigured(connectorName));\n+    }\n+\n+    public void deleteAllConnectors() throws IOException {\n+        List<String> connectorNames = getRegisteredConnectors();\n+\n+        for (String connectorName : connectorNames) {\n+            deleteDebeziumConnector(connectorName);\n+        }\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 195}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0NDI3Mg==", "bodyText": "same as above", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r518644272", "createdAt": "2020-11-06T10:00:15Z", "author": {"login": "rk3rn3r"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();\n+                return MAPPER.readValue(string, new TypeReference<List<String>>() {\n+                });\n+            }\n+        }\n+        catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+        return Collections.emptyList();\n+    }\n+\n+    public boolean isConnectorConfigured(String connectorName) throws IOException {\n+        Request request = new Request.Builder().url(getConnectorURI(connectorName)).get().build();\n+        try (Response response = executeRequest(request)) {\n+            boolean isConnectorConfigured = response.isSuccessful();\n+            response.close();\n+            return isConnectorConfigured;\n+        }\n+    }\n+\n+    public void ensureConnectorRegistered(String connectorName) {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> isConnectorConfigured(connectorName));\n+    }\n+\n+    public void deleteAllConnectors() throws IOException {\n+        List<String> connectorNames = getRegisteredConnectors();\n+\n+        for (String connectorName : connectorNames) {\n+            deleteDebeziumConnector(connectorName);\n+        }\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NDMzMw=="}, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 195}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjEzNjY4OnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMTo0N1rOHtVKmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMTo0N1rOHtVKmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NDc0Nw==", "bodyText": "final", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517294747", "createdAt": "2020-11-04T12:01:47Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();\n+                return MAPPER.readValue(string, new TypeReference<List<String>>() {\n+                });\n+            }\n+        }\n+        catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+        return Collections.emptyList();\n+    }\n+\n+    public boolean isConnectorConfigured(String connectorName) throws IOException {\n+        Request request = new Request.Builder().url(getConnectorURI(connectorName)).get().build();\n+        try (Response response = executeRequest(request)) {\n+            boolean isConnectorConfigured = response.isSuccessful();\n+            response.close();\n+            return isConnectorConfigured;\n+        }\n+    }\n+\n+    public void ensureConnectorRegistered(String connectorName) {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> isConnectorConfigured(connectorName));\n+    }\n+\n+    public void deleteAllConnectors() throws IOException {\n+        List<String> connectorNames = getRegisteredConnectors();\n+\n+        for (String connectorName : connectorNames) {\n+            deleteDebeziumConnector(connectorName);\n+        }\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> getRegisteredConnectors().size() == 0);\n+    }\n+\n+    public Connector.State getConnectorState(String connectorName) throws IOException {\n+        final Request request = new Request.Builder().url(getConnectorStatusURI(connectorName)).get().build();\n+        ResponseBody responseBody = executeRequestSuccessful(request).body();\n+        if (null != responseBody) {\n+            ObjectNode parsedObject = (ObjectNode) MAPPER.readTree(responseBody.string());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 203}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjEzNzg3OnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMjowNVrOHtVLPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMjowNVrOHtVLPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NDkxMQ==", "bodyText": "Use try witf resorces", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517294911", "createdAt": "2020-11-04T12:02:05Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();\n+                return MAPPER.readValue(string, new TypeReference<List<String>>() {\n+                });\n+            }\n+        }\n+        catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+        return Collections.emptyList();\n+    }\n+\n+    public boolean isConnectorConfigured(String connectorName) throws IOException {\n+        Request request = new Request.Builder().url(getConnectorURI(connectorName)).get().build();\n+        try (Response response = executeRequest(request)) {\n+            boolean isConnectorConfigured = response.isSuccessful();\n+            response.close();\n+            return isConnectorConfigured;\n+        }\n+    }\n+\n+    public void ensureConnectorRegistered(String connectorName) {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> isConnectorConfigured(connectorName));\n+    }\n+\n+    public void deleteAllConnectors() throws IOException {\n+        List<String> connectorNames = getRegisteredConnectors();\n+\n+        for (String connectorName : connectorNames) {\n+            deleteDebeziumConnector(connectorName);\n+        }\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> getRegisteredConnectors().size() == 0);\n+    }\n+\n+    public Connector.State getConnectorState(String connectorName) throws IOException {\n+        final Request request = new Request.Builder().url(getConnectorStatusURI(connectorName)).get().build();\n+        ResponseBody responseBody = executeRequestSuccessful(request).body();\n+        if (null != responseBody) {\n+            ObjectNode parsedObject = (ObjectNode) MAPPER.readTree(responseBody.string());\n+            responseBody.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 204}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjEzODg1OnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMjoyM1rOHtVL0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMjoyM1rOHtVL0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NTA1OQ==", "bodyText": "final", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517295059", "createdAt": "2020-11-04T12:02:23Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();\n+                return MAPPER.readValue(string, new TypeReference<List<String>>() {\n+                });\n+            }\n+        }\n+        catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+        return Collections.emptyList();\n+    }\n+\n+    public boolean isConnectorConfigured(String connectorName) throws IOException {\n+        Request request = new Request.Builder().url(getConnectorURI(connectorName)).get().build();\n+        try (Response response = executeRequest(request)) {\n+            boolean isConnectorConfigured = response.isSuccessful();\n+            response.close();\n+            return isConnectorConfigured;\n+        }\n+    }\n+\n+    public void ensureConnectorRegistered(String connectorName) {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> isConnectorConfigured(connectorName));\n+    }\n+\n+    public void deleteAllConnectors() throws IOException {\n+        List<String> connectorNames = getRegisteredConnectors();\n+\n+        for (String connectorName : connectorNames) {\n+            deleteDebeziumConnector(connectorName);\n+        }\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> getRegisteredConnectors().size() == 0);\n+    }\n+\n+    public Connector.State getConnectorState(String connectorName) throws IOException {\n+        final Request request = new Request.Builder().url(getConnectorStatusURI(connectorName)).get().build();\n+        ResponseBody responseBody = executeRequestSuccessful(request).body();\n+        if (null != responseBody) {\n+            ObjectNode parsedObject = (ObjectNode) MAPPER.readTree(responseBody.string());\n+            responseBody.close();\n+            return Connector.State.valueOf(parsedObject.get(\"connector\").get(\"state\").asText());\n+        }\n+        return null;\n+    }\n+\n+    public Connector.State getConnectorTaskState(String connectorName, int taskNumber) throws IOException {\n+        final Request request = new Request.Builder().url(getConnectorStatusURI(connectorName)).get().build();\n+        ResponseBody responseBody = executeRequestSuccessful(request).body();\n+        if (null != responseBody) {\n+            ObjectNode parsedObject = (ObjectNode) MAPPER.readTree(responseBody.string());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 214}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjEzOTYxOnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMjozOVrOHtVMUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMjozOVrOHtVMUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NTE4NQ==", "bodyText": "try with resources", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517295185", "createdAt": "2020-11-04T12:02:39Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();\n+                return MAPPER.readValue(string, new TypeReference<List<String>>() {\n+                });\n+            }\n+        }\n+        catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+        return Collections.emptyList();\n+    }\n+\n+    public boolean isConnectorConfigured(String connectorName) throws IOException {\n+        Request request = new Request.Builder().url(getConnectorURI(connectorName)).get().build();\n+        try (Response response = executeRequest(request)) {\n+            boolean isConnectorConfigured = response.isSuccessful();\n+            response.close();\n+            return isConnectorConfigured;\n+        }\n+    }\n+\n+    public void ensureConnectorRegistered(String connectorName) {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> isConnectorConfigured(connectorName));\n+    }\n+\n+    public void deleteAllConnectors() throws IOException {\n+        List<String> connectorNames = getRegisteredConnectors();\n+\n+        for (String connectorName : connectorNames) {\n+            deleteDebeziumConnector(connectorName);\n+        }\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> getRegisteredConnectors().size() == 0);\n+    }\n+\n+    public Connector.State getConnectorState(String connectorName) throws IOException {\n+        final Request request = new Request.Builder().url(getConnectorStatusURI(connectorName)).get().build();\n+        ResponseBody responseBody = executeRequestSuccessful(request).body();\n+        if (null != responseBody) {\n+            ObjectNode parsedObject = (ObjectNode) MAPPER.readTree(responseBody.string());\n+            responseBody.close();\n+            return Connector.State.valueOf(parsedObject.get(\"connector\").get(\"state\").asText());\n+        }\n+        return null;\n+    }\n+\n+    public Connector.State getConnectorTaskState(String connectorName, int taskNumber) throws IOException {\n+        final Request request = new Request.Builder().url(getConnectorStatusURI(connectorName)).get().build();\n+        ResponseBody responseBody = executeRequestSuccessful(request).body();\n+        if (null != responseBody) {\n+            ObjectNode parsedObject = (ObjectNode) MAPPER.readTree(responseBody.string());\n+            responseBody.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 215}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjE0MDg2OnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMzowMFrOHtVNCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMzowMFrOHtVNCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NTM2OQ==", "bodyText": "Configurable timeout", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517295369", "createdAt": "2020-11-04T12:03:00Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();\n+                return MAPPER.readValue(string, new TypeReference<List<String>>() {\n+                });\n+            }\n+        }\n+        catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+        return Collections.emptyList();\n+    }\n+\n+    public boolean isConnectorConfigured(String connectorName) throws IOException {\n+        Request request = new Request.Builder().url(getConnectorURI(connectorName)).get().build();\n+        try (Response response = executeRequest(request)) {\n+            boolean isConnectorConfigured = response.isSuccessful();\n+            response.close();\n+            return isConnectorConfigured;\n+        }\n+    }\n+\n+    public void ensureConnectorRegistered(String connectorName) {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> isConnectorConfigured(connectorName));\n+    }\n+\n+    public void deleteAllConnectors() throws IOException {\n+        List<String> connectorNames = getRegisteredConnectors();\n+\n+        for (String connectorName : connectorNames) {\n+            deleteDebeziumConnector(connectorName);\n+        }\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> getRegisteredConnectors().size() == 0);\n+    }\n+\n+    public Connector.State getConnectorState(String connectorName) throws IOException {\n+        final Request request = new Request.Builder().url(getConnectorStatusURI(connectorName)).get().build();\n+        ResponseBody responseBody = executeRequestSuccessful(request).body();\n+        if (null != responseBody) {\n+            ObjectNode parsedObject = (ObjectNode) MAPPER.readTree(responseBody.string());\n+            responseBody.close();\n+            return Connector.State.valueOf(parsedObject.get(\"connector\").get(\"state\").asText());\n+        }\n+        return null;\n+    }\n+\n+    public Connector.State getConnectorTaskState(String connectorName, int taskNumber) throws IOException {\n+        final Request request = new Request.Builder().url(getConnectorStatusURI(connectorName)).get().build();\n+        ResponseBody responseBody = executeRequestSuccessful(request).body();\n+        if (null != responseBody) {\n+            ObjectNode parsedObject = (ObjectNode) MAPPER.readTree(responseBody.string());\n+            responseBody.close();\n+            return Connector.State.valueOf(parsedObject.get(\"tasks\").get(taskNumber).get(\"state\").asText());\n+        }\n+        return null;\n+    }\n+\n+    public void pauseConnector(String connectorName) throws IOException {\n+        final Request request = new Request.Builder()\n+                .url(getPauseConnectorURI(connectorName))\n+                .put(RequestBody.create(\"\", JSON))\n+                .build();\n+        executeRequestSuccessful(request).close();\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 229}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjE0MTA2OnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMzowNVrOHtVNJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMDowMToxMFrOHunkFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NTM5OA==", "bodyText": "Configurable timeout", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517295398", "createdAt": "2020-11-04T12:03:05Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();\n+                return MAPPER.readValue(string, new TypeReference<List<String>>() {\n+                });\n+            }\n+        }\n+        catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+        return Collections.emptyList();\n+    }\n+\n+    public boolean isConnectorConfigured(String connectorName) throws IOException {\n+        Request request = new Request.Builder().url(getConnectorURI(connectorName)).get().build();\n+        try (Response response = executeRequest(request)) {\n+            boolean isConnectorConfigured = response.isSuccessful();\n+            response.close();\n+            return isConnectorConfigured;\n+        }\n+    }\n+\n+    public void ensureConnectorRegistered(String connectorName) {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> isConnectorConfigured(connectorName));\n+    }\n+\n+    public void deleteAllConnectors() throws IOException {\n+        List<String> connectorNames = getRegisteredConnectors();\n+\n+        for (String connectorName : connectorNames) {\n+            deleteDebeziumConnector(connectorName);\n+        }\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> getRegisteredConnectors().size() == 0);\n+    }\n+\n+    public Connector.State getConnectorState(String connectorName) throws IOException {\n+        final Request request = new Request.Builder().url(getConnectorStatusURI(connectorName)).get().build();\n+        ResponseBody responseBody = executeRequestSuccessful(request).body();\n+        if (null != responseBody) {\n+            ObjectNode parsedObject = (ObjectNode) MAPPER.readTree(responseBody.string());\n+            responseBody.close();\n+            return Connector.State.valueOf(parsedObject.get(\"connector\").get(\"state\").asText());\n+        }\n+        return null;\n+    }\n+\n+    public Connector.State getConnectorTaskState(String connectorName, int taskNumber) throws IOException {\n+        final Request request = new Request.Builder().url(getConnectorStatusURI(connectorName)).get().build();\n+        ResponseBody responseBody = executeRequestSuccessful(request).body();\n+        if (null != responseBody) {\n+            ObjectNode parsedObject = (ObjectNode) MAPPER.readTree(responseBody.string());\n+            responseBody.close();\n+            return Connector.State.valueOf(parsedObject.get(\"tasks\").get(taskNumber).get(\"state\").asText());\n+        }\n+        return null;\n+    }\n+\n+    public void pauseConnector(String connectorName) throws IOException {\n+        final Request request = new Request.Builder()\n+                .url(getPauseConnectorURI(connectorName))\n+                .put(RequestBody.create(\"\", JSON))\n+                .build();\n+        executeRequestSuccessful(request).close();\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> getConnectorState(connectorName) == Connector.State.PAUSED);\n+    }\n+\n+    public void ensureConnectorState(String connectorName, Connector.State status) throws IOException {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 235}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0NDc1Ng==", "bodyText": "same here as well", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r518644756", "createdAt": "2020-11-06T10:01:10Z", "author": {"login": "rk3rn3r"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();\n+                return MAPPER.readValue(string, new TypeReference<List<String>>() {\n+                });\n+            }\n+        }\n+        catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+        return Collections.emptyList();\n+    }\n+\n+    public boolean isConnectorConfigured(String connectorName) throws IOException {\n+        Request request = new Request.Builder().url(getConnectorURI(connectorName)).get().build();\n+        try (Response response = executeRequest(request)) {\n+            boolean isConnectorConfigured = response.isSuccessful();\n+            response.close();\n+            return isConnectorConfigured;\n+        }\n+    }\n+\n+    public void ensureConnectorRegistered(String connectorName) {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> isConnectorConfigured(connectorName));\n+    }\n+\n+    public void deleteAllConnectors() throws IOException {\n+        List<String> connectorNames = getRegisteredConnectors();\n+\n+        for (String connectorName : connectorNames) {\n+            deleteDebeziumConnector(connectorName);\n+        }\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> getRegisteredConnectors().size() == 0);\n+    }\n+\n+    public Connector.State getConnectorState(String connectorName) throws IOException {\n+        final Request request = new Request.Builder().url(getConnectorStatusURI(connectorName)).get().build();\n+        ResponseBody responseBody = executeRequestSuccessful(request).body();\n+        if (null != responseBody) {\n+            ObjectNode parsedObject = (ObjectNode) MAPPER.readTree(responseBody.string());\n+            responseBody.close();\n+            return Connector.State.valueOf(parsedObject.get(\"connector\").get(\"state\").asText());\n+        }\n+        return null;\n+    }\n+\n+    public Connector.State getConnectorTaskState(String connectorName, int taskNumber) throws IOException {\n+        final Request request = new Request.Builder().url(getConnectorStatusURI(connectorName)).get().build();\n+        ResponseBody responseBody = executeRequestSuccessful(request).body();\n+        if (null != responseBody) {\n+            ObjectNode parsedObject = (ObjectNode) MAPPER.readTree(responseBody.string());\n+            responseBody.close();\n+            return Connector.State.valueOf(parsedObject.get(\"tasks\").get(taskNumber).get(\"state\").asText());\n+        }\n+        return null;\n+    }\n+\n+    public void pauseConnector(String connectorName) throws IOException {\n+        final Request request = new Request.Builder()\n+                .url(getPauseConnectorURI(connectorName))\n+                .put(RequestBody.create(\"\", JSON))\n+                .build();\n+        executeRequestSuccessful(request).close();\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> getConnectorState(connectorName) == Connector.State.PAUSED);\n+    }\n+\n+    public void ensureConnectorState(String connectorName, Connector.State status) throws IOException {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NTM5OA=="}, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 235}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjE0MTYzOnYy", "diffSide": "RIGHT", "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMzoxNlrOHtVNgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMDowMTo1MFrOHunlow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NTQ4OA==", "bodyText": "Configurable timeout", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r517295488", "createdAt": "2020-11-04T12:03:16Z", "author": {"login": "jpechane"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();\n+                return MAPPER.readValue(string, new TypeReference<List<String>>() {\n+                });\n+            }\n+        }\n+        catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+        return Collections.emptyList();\n+    }\n+\n+    public boolean isConnectorConfigured(String connectorName) throws IOException {\n+        Request request = new Request.Builder().url(getConnectorURI(connectorName)).get().build();\n+        try (Response response = executeRequest(request)) {\n+            boolean isConnectorConfigured = response.isSuccessful();\n+            response.close();\n+            return isConnectorConfigured;\n+        }\n+    }\n+\n+    public void ensureConnectorRegistered(String connectorName) {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> isConnectorConfigured(connectorName));\n+    }\n+\n+    public void deleteAllConnectors() throws IOException {\n+        List<String> connectorNames = getRegisteredConnectors();\n+\n+        for (String connectorName : connectorNames) {\n+            deleteDebeziumConnector(connectorName);\n+        }\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> getRegisteredConnectors().size() == 0);\n+    }\n+\n+    public Connector.State getConnectorState(String connectorName) throws IOException {\n+        final Request request = new Request.Builder().url(getConnectorStatusURI(connectorName)).get().build();\n+        ResponseBody responseBody = executeRequestSuccessful(request).body();\n+        if (null != responseBody) {\n+            ObjectNode parsedObject = (ObjectNode) MAPPER.readTree(responseBody.string());\n+            responseBody.close();\n+            return Connector.State.valueOf(parsedObject.get(\"connector\").get(\"state\").asText());\n+        }\n+        return null;\n+    }\n+\n+    public Connector.State getConnectorTaskState(String connectorName, int taskNumber) throws IOException {\n+        final Request request = new Request.Builder().url(getConnectorStatusURI(connectorName)).get().build();\n+        ResponseBody responseBody = executeRequestSuccessful(request).body();\n+        if (null != responseBody) {\n+            ObjectNode parsedObject = (ObjectNode) MAPPER.readTree(responseBody.string());\n+            responseBody.close();\n+            return Connector.State.valueOf(parsedObject.get(\"tasks\").get(taskNumber).get(\"state\").asText());\n+        }\n+        return null;\n+    }\n+\n+    public void pauseConnector(String connectorName) throws IOException {\n+        final Request request = new Request.Builder()\n+                .url(getPauseConnectorURI(connectorName))\n+                .put(RequestBody.create(\"\", JSON))\n+                .build();\n+        executeRequestSuccessful(request).close();\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> getConnectorState(connectorName) == Connector.State.PAUSED);\n+    }\n+\n+    public void ensureConnectorState(String connectorName, Connector.State status) throws IOException {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> getConnectorState(connectorName) == status);\n+    }\n+\n+    public void ensureConnectorTaskState(String connectorName, int taskNumber, Connector.State status) throws IOException {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 241}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0NTE1NQ==", "bodyText": "same here", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r518645155", "createdAt": "2020-11-06T10:01:50Z", "author": {"login": "rk3rn3r"}, "path": "debezium-testing/debezium-testing-testcontainers/src/main/java/io/debezium/testing/testcontainers/DebeziumContainer.java", "diffHunk": "@@ -84,45 +125,137 @@ private void registerConnectorToDebezium(final String payload, final String full\n         final RequestBody body = RequestBody.create(payload, JSON);\n         final Request request = new Request.Builder().url(fullUrl).post(body).build();\n \n-        try (Response response = client.newCall(request).execute()) {\n+        try (Response response = CLIENT.newCall(request).execute()) {\n             if (!response.isSuccessful()) {\n-                throw new IOException(\"Unexpected code \" + response + \"Message: \" + response.body().string());\n+                throw new IOException(\"Unexpected code \" + response + \"Message: \" + Objects.requireNonNull(response.body()).string());\n             }\n         }\n     }\n \n-    private boolean isConnectorConfigured(String connectorName) throws IOException {\n-        final Request request = new Request.Builder()\n-                .url(getConnector(connectorName))\n-                .build();\n+    protected static Response executeRequest(Request request) throws IOException {\n+        return CLIENT.newCall(request).execute();\n+    }\n \n-        try (Response response = client.newCall(request).execute()) {\n-            return response.isSuccessful();\n+    protected static Response executeRequestSuccessful(Request request) throws IOException {\n+        Response response = executeRequest(request);\n+        String responseBodyContent = \"{empty response body}\";\n+        if (!response.isSuccessful()) {\n+            ResponseBody responseBody = response.body();\n+            if (null != responseBody) {\n+                responseBodyContent = responseBody.string();\n+                responseBody.close();\n+            }\n+            throw new IOException(\"Unexpected response: \" + response + \" Response Body: \" + responseBodyContent);\n         }\n+        return response;\n     }\n \n-    /**\n-     * Returns the \"/connectors\" endpoint.\n-     */\n-    public String getConnectors() {\n-        return getTarget() + \"/connectors/\";\n+    public boolean connectorIsNotRegistered(String connectorName) throws IOException {\n+        try (Response response = executeRequest(new Request.Builder().url(getConnectorURI(connectorName)).get().build())) {\n+            boolean connectorIsNotRegistered = response.code() == 404;\n+            response.close();\n+            return connectorIsNotRegistered;\n+        }\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>\" endpoint.\n-     */\n-    public String getConnector(String connectorName) {\n-        return getConnectors() + connectorName;\n+    protected void deleteDebeziumConnector(String connectorName) throws IOException {\n+        executeRequestSuccessful(new Request.Builder().url(getConnectorURI(connectorName)).delete().build()).close();\n     }\n \n-    /**\n-     * Returns the \"/connectors/<connector>/status\" endpoint.\n-     */\n-    public String getConnectorStatus(String connectorName) {\n-        return getConnectors() + connectorName + \"/status\";\n+    public void deleteConnector(String connectorName) throws IOException {\n+        deleteDebeziumConnector(connectorName);\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> connectorIsNotRegistered(connectorName));\n     }\n \n-    public String getTarget() {\n-        return \"http://\" + getContainerIpAddress() + \":\" + getMappedPort(8083);\n+    public List<String> getRegisteredConnectors() throws IOException {\n+        Request request = new Request.Builder().url(getConnectorsURI()).get().build();\n+        try (ResponseBody responseBody = executeRequestSuccessful(request).body()) {\n+            if (null != responseBody) {\n+                String string = responseBody.string();\n+                responseBody.close();\n+                return MAPPER.readValue(string, new TypeReference<List<String>>() {\n+                });\n+            }\n+        }\n+        catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+        return Collections.emptyList();\n+    }\n+\n+    public boolean isConnectorConfigured(String connectorName) throws IOException {\n+        Request request = new Request.Builder().url(getConnectorURI(connectorName)).get().build();\n+        try (Response response = executeRequest(request)) {\n+            boolean isConnectorConfigured = response.isSuccessful();\n+            response.close();\n+            return isConnectorConfigured;\n+        }\n+    }\n+\n+    public void ensureConnectorRegistered(String connectorName) {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> isConnectorConfigured(connectorName));\n+    }\n+\n+    public void deleteAllConnectors() throws IOException {\n+        List<String> connectorNames = getRegisteredConnectors();\n+\n+        for (String connectorName : connectorNames) {\n+            deleteDebeziumConnector(connectorName);\n+        }\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> getRegisteredConnectors().size() == 0);\n+    }\n+\n+    public Connector.State getConnectorState(String connectorName) throws IOException {\n+        final Request request = new Request.Builder().url(getConnectorStatusURI(connectorName)).get().build();\n+        ResponseBody responseBody = executeRequestSuccessful(request).body();\n+        if (null != responseBody) {\n+            ObjectNode parsedObject = (ObjectNode) MAPPER.readTree(responseBody.string());\n+            responseBody.close();\n+            return Connector.State.valueOf(parsedObject.get(\"connector\").get(\"state\").asText());\n+        }\n+        return null;\n+    }\n+\n+    public Connector.State getConnectorTaskState(String connectorName, int taskNumber) throws IOException {\n+        final Request request = new Request.Builder().url(getConnectorStatusURI(connectorName)).get().build();\n+        ResponseBody responseBody = executeRequestSuccessful(request).body();\n+        if (null != responseBody) {\n+            ObjectNode parsedObject = (ObjectNode) MAPPER.readTree(responseBody.string());\n+            responseBody.close();\n+            return Connector.State.valueOf(parsedObject.get(\"tasks\").get(taskNumber).get(\"state\").asText());\n+        }\n+        return null;\n+    }\n+\n+    public void pauseConnector(String connectorName) throws IOException {\n+        final Request request = new Request.Builder()\n+                .url(getPauseConnectorURI(connectorName))\n+                .put(RequestBody.create(\"\", JSON))\n+                .build();\n+        executeRequestSuccessful(request).close();\n+\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> getConnectorState(connectorName) == Connector.State.PAUSED);\n+    }\n+\n+    public void ensureConnectorState(String connectorName, Connector.State status) throws IOException {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> getConnectorState(connectorName) == status);\n+    }\n+\n+    public void ensureConnectorTaskState(String connectorName, int taskNumber, Connector.State status) throws IOException {\n+        Awaitility.await()\n+                .atMost(10, TimeUnit.SECONDS)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NTQ4OA=="}, "originalCommit": {"oid": "0a1fe2c0a0eb880a376a1e2574f76e347ef69766"}, "originalPosition": 241}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1ODQzMzE2OnYy", "diffSide": "RIGHT", "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMjo1MTowMFrOHvtCJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMjo1MTowMFrOHvtCJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc4Mjk0OA==", "bodyText": "@jpechane it says isStreamingRunning(String, String) is not a defined symbol.\nBut AbstractConnectorTest which has isStreamingRunning is the parent class.\nWth am I doing wrong? I'm blind to whatever mistake I did....", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r519782948", "createdAt": "2020-11-09T12:51:00Z", "author": {"login": "rk3rn3r"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresShutdownIT.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package io.debezium.connector.postgresql;\n+\n+import static org.junit.Assert.assertFalse;\n+\n+import java.sql.SQLException;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.awaitility.Awaitility;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.testcontainers.containers.Container;\n+\n+import io.debezium.config.CommonConnectorConfig;\n+import io.debezium.config.Configuration;\n+import io.debezium.connector.postgresql.PostgresConnectorConfig.SnapshotMode;\n+import io.debezium.connector.postgresql.connection.PostgresConnection;\n+import io.debezium.doc.FixFor;\n+import io.debezium.embedded.AbstractConnectorTest;\n+import io.debezium.embedded.EmbeddedEngine;\n+import io.debezium.heartbeat.DatabaseHeartbeatImpl;\n+import io.debezium.heartbeat.Heartbeat;\n+import io.debezium.jdbc.JdbcConfiguration;\n+import io.debezium.testing.testcontainers.PostgresInfrastructure;\n+import io.debezium.util.Testing;\n+\n+/**\n+ * Integration test for {@link PostgresConnector} using an {@link EmbeddedEngine} and Testcontainers infrastructure for when Postgres is shutdown during streaming\n+ */\n+public class PostgresShutdownIT extends AbstractConnectorTest {\n+\n+    /*\n+     * Specific tests that need to extend the initial DDL set should do it in a form of\n+     * TestHelper.execute(SETUP_TABLES_STMT + ADDITIONAL_STATEMENTS)\n+     */\n+    private static final String INSERT_STMT = \"INSERT INTO s1.a (aa) VALUES (1);\" +\n+            \"INSERT INTO s2.a (aa) VALUES (1);\";\n+    private static final String CREATE_TABLES_STMT = \"DROP SCHEMA IF EXISTS s1 CASCADE;\" +\n+            \"DROP SCHEMA IF EXISTS s2 CASCADE;\" +\n+            \"CREATE SCHEMA s1; \" +\n+            \"CREATE SCHEMA s2; \" +\n+            \"CREATE TABLE s1.a (pk SERIAL, aa integer, PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s2.a (pk SERIAL, aa integer, bb varchar(20), PRIMARY KEY(pk));\" +\n+            \"CREATE TABLE s1.heartbeat (ts TIMESTAMP WITH TIME ZONE PRIMARY KEY);\" +\n+            \"INSERT INTO s1.heartbeat (ts) VALUES (NOW());\";\n+    private static final String SETUP_TABLES_STMT = CREATE_TABLES_STMT + INSERT_STMT;\n+\n+    private PostgresInfrastructure infrastructure;\n+    private String oldContainerPort;\n+\n+    @Before\n+    public void setUp() {\n+        infrastructure = PostgresInfrastructure.getDebeziumPostgresInfrastructure();\n+        infrastructure.startContainer();\n+        oldContainerPort = System.getProperty(\"database.port\", \"5432\");\n+        System.setProperty(\"database.port\", String.valueOf(infrastructure.getPostgresContainer().getMappedPort(5432)));\n+        try {\n+            TestHelper.dropAllSchemas();\n+        }\n+        catch (SQLException exception) {\n+            throw new RuntimeException(exception);\n+        }\n+        initializeConnectorTestFramework();\n+    }\n+\n+    @After\n+    public void tearDown() {\n+        stopConnector();\n+        TestHelper.dropDefaultReplicationSlot();\n+        TestHelper.dropPublication();\n+        infrastructure.getPostgresContainer().stop();\n+        System.setProperty(\"database.port\", oldContainerPort);\n+    }\n+\n+    @Test\n+    @FixFor(\"DBZ-2617\")\n+    public void shouldStopOnPostgresFastShutdown() throws Exception {\n+        TestHelper.execute(SETUP_TABLES_STMT);\n+        final int recordCount = 100;\n+\n+        for (int i = 0; i < recordCount - 1; i++) {\n+            TestHelper.execute(INSERT_STMT);\n+        }\n+        Configuration.Builder configBuilder = TestHelper.defaultConfig()\n+                .with(CommonConnectorConfig.DATABASE_CONFIG_PREFIX + JdbcConfiguration.PORT, infrastructure.getPostgresContainer().getMappedPort(5432))\n+                .with(PostgresConnectorConfig.SNAPSHOT_MODE, SnapshotMode.ALWAYS.getValue())\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, false)\n+                .with(PostgresConnectorConfig.SCHEMA_INCLUDE_LIST, \"s1\")\n+                .with(Heartbeat.HEARTBEAT_INTERVAL, 500)\n+                .with(DatabaseHeartbeatImpl.HEARTBEAT_ACTION_QUERY, \"UPDATE s1.heartbeat SET ts=NOW();\");\n+\n+        Testing.Print.enable();\n+        PostgresConnection postgresConnection = TestHelper.create();\n+        String initialHeartbeat = postgresConnection.queryAndMap(\n+                \"SELECT ts FROM s1.heartbeat;\",\n+                postgresConnection.singleResultMapper(rs -> rs.getString(\"ts\"), \"Could not fetch keepalive info\"));\n+        start(PostgresConnector.class, configBuilder.build());\n+        assertConnectorIsRunning();\n+\n+        waitForSnapshotToBeCompleted(\"postgres\", TestHelper.TEST_SERVER);\n+        waitForStreamingRunning(\"postgres\", TestHelper.TEST_SERVER);\n+\n+        logger.info(\"Waiting for heartbeats...\");\n+        Awaitility.await()\n+                .pollInterval(250, TimeUnit.MILLISECONDS)\n+                .atMost(5 * TestHelper.waitTimeForRecords(), TimeUnit.SECONDS)\n+                .until(() -> !initialHeartbeat.equals(postgresConnection.queryAndMap(\n+                        \"SELECT ts FROM s1.heartbeat;\",\n+                        postgresConnection.singleResultMapper(rs -> rs.getString(\"ts\"), \"Could not fetch keepalive info\"))));\n+        logger.info(\"INTIAL Heartbeat: \" + initialHeartbeat + \" ; CURRENT heartbeat: \"\n+                + postgresConnection.queryAndMap(\n+                        \"SELECT ts FROM s1.heartbeat;\",\n+                        postgresConnection.singleResultMapper(rs -> rs.getString(\"ts\"), \"Could not fetch keepalive info\")));\n+\n+        logger.info(\"Execute Postgres shutdown...\");\n+        Container.ExecResult result = infrastructure.getPostgresContainer()\n+                .execInContainer(\"su\", \"-\", \"postgres\", \"-c\", \"/usr/lib/postgresql/11/bin/pg_ctl -m fast -D /var/lib/postgresql/data stop\");\n+        logger.info(result.toString());\n+\n+        logger.info(\"Waiting for Postgres to shutdown...\");\n+        waitForPostgresShutdown();\n+\n+        assertFalse(isStreamingRunning(\"postgres\", TestHelper.TEST_SERVER));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db1013080455093ef5190c940a0da6c9d94132a1"}, "originalPosition": 129}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1ODQzNDkzOnYy", "diffSide": "RIGHT", "path": "debezium-embedded/src/test/java/io/debezium/embedded/AbstractConnectorTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMjo1MTozMFrOHvtDMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMjo1MTozMFrOHvtDMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc4MzIxNg==", "bodyText": "@jpechane  but it's defined here.", "url": "https://github.com/debezium/debezium/pull/1928#discussion_r519783216", "createdAt": "2020-11-09T12:51:30Z", "author": {"login": "rk3rn3r"}, "path": "debezium-embedded/src/test/java/io/debezium/embedded/AbstractConnectorTest.java", "diffHunk": "@@ -1044,20 +1050,28 @@ public static void waitForStreamingRunning(String connector, String server) thro\n         waitForStreamingRunning(connector, server, \"streaming\");\n     }\n \n-    public static void waitForStreamingRunning(String connector, String server, String contextName) throws InterruptedException {\n-        final MBeanServer mbeanServer = ManagementFactory.getPlatformMBeanServer();\n-\n+    public static void waitForStreamingRunning(String connector, String server, String contextName) {\n         Awaitility.await()\n                 .alias(\"Streaming was not started on time\")\n                 .pollInterval(100, TimeUnit.MILLISECONDS)\n-                .atMost(60, TimeUnit.SECONDS)\n+                .atMost(waitTimeForRecords() * 30, TimeUnit.SECONDS)\n                 .ignoreException(InstanceNotFoundException.class)\n-                .until(() -> {\n-                    boolean connected = (boolean) mbeanServer\n-                            .getAttribute(getStreamingMetricsObjectName(connector, server, contextName), \"Connected\");\n+                .until(() -> isStreamingRunning(connector, server, contextName));\n+    }\n \n-                    return connected;\n-                });\n+    public static boolean isStreamingRunning(String connector, String server) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db1013080455093ef5190c940a0da6c9d94132a1"}, "originalPosition": 93}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4155, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}