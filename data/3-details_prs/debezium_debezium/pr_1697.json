{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4Nzk4ODk2", "number": 1697, "title": "DBZ-2288 Events in exported snapshot no longer filtered by LSN", "bodyText": "https://issues.redhat.com/browse/DBZ-2288", "createdAt": "2020-07-14T10:40:02Z", "url": "https://github.com/debezium/debezium/pull/1697", "merged": true, "mergeCommit": {"oid": "c2a40b7ed441bd98100a6b81d20415632f72e778"}, "closed": true, "closedAt": "2020-07-16T07:51:01Z", "author": {"login": "jpechane"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0zoW3gH2gAyNDQ4Nzk4ODk2OjFkN2FmNDcyOTU0NDRjMzVkYTE5YjYwZWY5MTY4M2FmMzJhYTQwYjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1ZsaGAH2gAyNDQ4Nzk4ODk2OjEyYzk0MjE2ZTNlZDNmNjNhMTcyOGYzYjg2NWFjNGRiZGEzNmJkNGI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1d7af47295444c35da19b60ef91683af32aa40b8", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/1d7af47295444c35da19b60ef91683af32aa40b8", "committedDate": "2020-07-14T10:39:23Z", "message": "DBZ-2288 Events in exported snapshot no longer filtered by LSN"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6379ff5cb42828bd9951531c5ac0c09b1447c8b", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/e6379ff5cb42828bd9951531c5ac0c09b1447c8b", "committedDate": "2020-07-14T12:51:03Z", "message": "DBZ-2288 Test for pgoutput"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NzIzNTMw", "url": "https://github.com/debezium/debezium/pull/1697#pullrequestreview-448723530", "createdAt": "2020-07-15T08:09:06Z", "commit": {"oid": "e6379ff5cb42828bd9951531c5ac0c09b1447c8b"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwODowOTowNlrOGxzD_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwODozMzowMFrOGxz7aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg3MDAxMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param exportSnapshot            whether the connector is doing snapshot\n          \n          \n            \n                 * @param doSnapshot            whether the connector is doing snapshot", "url": "https://github.com/debezium/debezium/pull/1697#discussion_r454870013", "createdAt": "2020-07-15T08:09:06Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/connection/PostgresReplicationConnection.java", "diffHunk": "@@ -88,6 +88,7 @@\n      * @param dropSlotOnClose           whether the replication slot should be dropped once the connection is closed\n      * @param statusUpdateInterval      the interval at which the replication connection should periodically send status\n      * @param exportSnapshot            whether the replication should export a snapshot when created\n+     * @param exportSnapshot            whether the connector is doing snapshot", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6379ff5cb42828bd9951531c5ac0c09b1447c8b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg3MDM5Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     * @param doSnapshot true if a snapshot should is going to be executed, false if otherwise\n          \n          \n            \n                     * @param doSnapshot true if a snapshot is going to be executed, false if otherwise", "url": "https://github.com/debezium/debezium/pull/1697#discussion_r454870397", "createdAt": "2020-07-15T08:09:45Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/connection/ReplicationConnection.java", "diffHunk": "@@ -206,6 +206,14 @@ static String format(long lsn) {\n          */\n         Builder exportSnapshotOnCreate(final boolean exportSnapshot);\n \n+        /**\n+         * Whether or not the snapshot is executed\n+         * @param doSnapshot true if a snapshot should is going to be executed, false if otherwise", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6379ff5cb42828bd9951531c5ac0c09b1447c8b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg3NTQ0MA==", "bodyText": "But are you skipping it in this case?", "url": "https://github.com/debezium/debezium/pull/1697#discussion_r454875440", "createdAt": "2020-07-15T08:18:21Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/connection/AbstractMessageDecoder.java", "diffHunk": "@@ -42,8 +51,13 @@ public boolean shouldMessageBeSkipped(ByteBuffer buffer, Long lastReceivedLsn, L\n         // the lsn we started from is inclusive, so we need to avoid sending back the same message twice\n         // but for the first record seen ever it is possible we received the same LSN as the one obtained from replication slot\n         if (startLsn.compareTo(lastReceivedLsn) > 0 || (startLsn.equals(lastReceivedLsn) && skipFirstFlushRecord)) {\n-            LOGGER.info(\"Streaming requested from LSN {} but received LSN {} that is same or smaller so skipping the message\", startLsn, lastReceivedLsn);\n-            return true;\n+            if (filterBasedOnLsn) {\n+                LOGGER.info(\"Streaming requested from LSN {} but received LSN {} that is same or smaller so skipping the message\", startLsn, lastReceivedLsn);\n+                return true;\n+            }\n+            else {\n+                LOGGER.trace(\"Streaming requested from LSN {} but received LSN {} that is same or smaller so skipping the message\", startLsn, lastReceivedLsn);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6379ff5cb42828bd9951531c5ac0c09b1447c8b"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg3NjMxOQ==", "bodyText": "Couldn't you just create the publication always, and it only would be used when running the test for pgoutput? That way we'd keep a single test.", "url": "https://github.com/debezium/debezium/pull/1697#discussion_r454876319", "createdAt": "2020-07-15T08:19:47Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresConnectorIT.java", "diffHunk": "@@ -1118,6 +1119,110 @@ public void shouldAllowForExportedSnapshot() throws Exception {\n         VerifyRecord.isValidInsert(s2recs.get(0), PK_FIELD, 3);\n     }\n \n+    @Test\n+    @FixFor(\"DBZ-2288\")\n+    @SkipWhenDecoderPluginNameIs(value = SkipWhenDecoderPluginNameIs.DecoderPluginName.PGOUTPUT, reason = \"PgOutput needs publication for manually created slot\")\n+    public void exportedSnapshotShouldNotSkipRecordOfParallelTx() throws Exception {\n+        TestHelper.dropDefaultReplicationSlot();\n+        TestHelper.createDefaultReplicationSlot();\n+\n+        // Testing.Print.enable();\n+        TestHelper.execute(SETUP_TABLES_STMT);\n+        TestHelper.execute(INSERT_STMT);\n+\n+        Configuration config = TestHelper.defaultConfig()\n+                .with(PostgresConnectorConfig.SNAPSHOT_MODE, SnapshotMode.EXPORTED.getValue())\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, Boolean.FALSE)\n+                .with(PostgresConnectorConfig.MAX_QUEUE_SIZE, 2)\n+                .with(PostgresConnectorConfig.MAX_BATCH_SIZE, 1)\n+                .build();\n+        final PostgresConnection pgConnection = TestHelper.create();\n+        pgConnection.setAutoCommit(false);\n+        pgConnection.executeWithoutCommitting(INSERT_STMT);\n+        final AtomicBoolean inserted = new AtomicBoolean();\n+        start(PostgresConnector.class, config, loggingCompletion(), x -> false, x -> {\n+            if (!inserted.get()) {\n+                TestHelper.execute(INSERT_STMT);\n+                try {\n+                    pgConnection.commit();\n+                }\n+                catch (Exception e) {\n+                    e.printStackTrace();\n+                }\n+                inserted.set(true);\n+            }\n+        });\n+        assertConnectorIsRunning();\n+\n+        // Consume records from the snapshot\n+        SourceRecords actualRecords = consumeRecordsByTopic(4);\n+\n+        // Consume records from concurrent transactions\n+        actualRecords = consumeRecordsByTopic(4);\n+\n+        List<SourceRecord> s1recs = actualRecords.recordsForTopic(topicName(\"s1.a\"));\n+        List<SourceRecord> s2recs = actualRecords.recordsForTopic(topicName(\"s1.a\"));\n+        s2recs = actualRecords.recordsForTopic(topicName(\"s2.a\"));\n+        assertThat(s1recs.size()).isEqualTo(2);\n+        assertThat(s2recs.size()).isEqualTo(2);\n+\n+        stopConnector();\n+        TestHelper.dropDefaultReplicationSlot();\n+    }\n+\n+    @Test\n+    @FixFor(\"DBZ-2288\")\n+    @SkipWhenDecoderPluginNameIsNot(value = SkipWhenDecoderPluginNameIsNot.DecoderPluginName.PGOUTPUT, reason = \"Publication not supported\")\n+    public void exportedSnapshotShouldNotSkipRecordOfParallelTxPgoutput() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6379ff5cb42828bd9951531c5ac0c09b1447c8b"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg4NDIwMw==", "bodyText": "This shouldn't apply here?", "url": "https://github.com/debezium/debezium/pull/1697#discussion_r454884203", "createdAt": "2020-07-15T08:33:00Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/connection/ReplicationConnection.java", "diffHunk": "@@ -206,6 +206,14 @@ static String format(long lsn) {\n          */\n         Builder exportSnapshotOnCreate(final boolean exportSnapshot);\n \n+        /**\n+         * Whether or not the snapshot is executed\n+         * @param doSnapshot true if a snapshot should is going to be executed, false if otherwise\n+         * @return this instance\n+         * @see #DEFAULT_EXPORT_SNAPSHOT", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6379ff5cb42828bd9951531c5ac0c09b1447c8b"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2fc4a6558f7771ccb2074f2e78ac7003bfccefb", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/a2fc4a6558f7771ccb2074f2e78ac7003bfccefb", "committedDate": "2020-07-15T08:44:20Z", "message": "DBZ-2288 Fix copy/paste errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NTQxNzUx", "url": "https://github.com/debezium/debezium/pull/1697#pullrequestreview-449541751", "createdAt": "2020-07-16T06:32:42Z", "commit": {"oid": "a2fc4a6558f7771ccb2074f2e78ac7003bfccefb"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwNjozMjo0MlrOGyb8vQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwNjozMjo1MlrOGyb88g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzOTkwMQ==", "bodyText": "Rather rethrow it?", "url": "https://github.com/debezium/debezium/pull/1697#discussion_r455539901", "createdAt": "2020-07-16T06:32:42Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresConnectorIT.java", "diffHunk": "@@ -1118,6 +1119,110 @@ public void shouldAllowForExportedSnapshot() throws Exception {\n         VerifyRecord.isValidInsert(s2recs.get(0), PK_FIELD, 3);\n     }\n \n+    @Test\n+    @FixFor(\"DBZ-2288\")\n+    @SkipWhenDecoderPluginNameIs(value = SkipWhenDecoderPluginNameIs.DecoderPluginName.PGOUTPUT, reason = \"PgOutput needs publication for manually created slot\")\n+    public void exportedSnapshotShouldNotSkipRecordOfParallelTx() throws Exception {\n+        TestHelper.dropDefaultReplicationSlot();\n+        TestHelper.createDefaultReplicationSlot();\n+\n+        // Testing.Print.enable();\n+        TestHelper.execute(SETUP_TABLES_STMT);\n+        TestHelper.execute(INSERT_STMT);\n+\n+        Configuration config = TestHelper.defaultConfig()\n+                .with(PostgresConnectorConfig.SNAPSHOT_MODE, SnapshotMode.EXPORTED.getValue())\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, Boolean.FALSE)\n+                .with(PostgresConnectorConfig.MAX_QUEUE_SIZE, 2)\n+                .with(PostgresConnectorConfig.MAX_BATCH_SIZE, 1)\n+                .build();\n+        final PostgresConnection pgConnection = TestHelper.create();\n+        pgConnection.setAutoCommit(false);\n+        pgConnection.executeWithoutCommitting(INSERT_STMT);\n+        final AtomicBoolean inserted = new AtomicBoolean();\n+        start(PostgresConnector.class, config, loggingCompletion(), x -> false, x -> {\n+            if (!inserted.get()) {\n+                TestHelper.execute(INSERT_STMT);\n+                try {\n+                    pgConnection.commit();\n+                }\n+                catch (Exception e) {\n+                    e.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2fc4a6558f7771ccb2074f2e78ac7003bfccefb"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzOTk1NA==", "bodyText": "As above.", "url": "https://github.com/debezium/debezium/pull/1697#discussion_r455539954", "createdAt": "2020-07-16T06:32:52Z", "author": {"login": "gunnarmorling"}, "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresConnectorIT.java", "diffHunk": "@@ -1118,6 +1119,110 @@ public void shouldAllowForExportedSnapshot() throws Exception {\n         VerifyRecord.isValidInsert(s2recs.get(0), PK_FIELD, 3);\n     }\n \n+    @Test\n+    @FixFor(\"DBZ-2288\")\n+    @SkipWhenDecoderPluginNameIs(value = SkipWhenDecoderPluginNameIs.DecoderPluginName.PGOUTPUT, reason = \"PgOutput needs publication for manually created slot\")\n+    public void exportedSnapshotShouldNotSkipRecordOfParallelTx() throws Exception {\n+        TestHelper.dropDefaultReplicationSlot();\n+        TestHelper.createDefaultReplicationSlot();\n+\n+        // Testing.Print.enable();\n+        TestHelper.execute(SETUP_TABLES_STMT);\n+        TestHelper.execute(INSERT_STMT);\n+\n+        Configuration config = TestHelper.defaultConfig()\n+                .with(PostgresConnectorConfig.SNAPSHOT_MODE, SnapshotMode.EXPORTED.getValue())\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, Boolean.FALSE)\n+                .with(PostgresConnectorConfig.MAX_QUEUE_SIZE, 2)\n+                .with(PostgresConnectorConfig.MAX_BATCH_SIZE, 1)\n+                .build();\n+        final PostgresConnection pgConnection = TestHelper.create();\n+        pgConnection.setAutoCommit(false);\n+        pgConnection.executeWithoutCommitting(INSERT_STMT);\n+        final AtomicBoolean inserted = new AtomicBoolean();\n+        start(PostgresConnector.class, config, loggingCompletion(), x -> false, x -> {\n+            if (!inserted.get()) {\n+                TestHelper.execute(INSERT_STMT);\n+                try {\n+                    pgConnection.commit();\n+                }\n+                catch (Exception e) {\n+                    e.printStackTrace();\n+                }\n+                inserted.set(true);\n+            }\n+        });\n+        assertConnectorIsRunning();\n+\n+        // Consume records from the snapshot\n+        SourceRecords actualRecords = consumeRecordsByTopic(4);\n+\n+        // Consume records from concurrent transactions\n+        actualRecords = consumeRecordsByTopic(4);\n+\n+        List<SourceRecord> s1recs = actualRecords.recordsForTopic(topicName(\"s1.a\"));\n+        List<SourceRecord> s2recs = actualRecords.recordsForTopic(topicName(\"s1.a\"));\n+        s2recs = actualRecords.recordsForTopic(topicName(\"s2.a\"));\n+        assertThat(s1recs.size()).isEqualTo(2);\n+        assertThat(s2recs.size()).isEqualTo(2);\n+\n+        stopConnector();\n+        TestHelper.dropDefaultReplicationSlot();\n+    }\n+\n+    @Test\n+    @FixFor(\"DBZ-2288\")\n+    @SkipWhenDecoderPluginNameIsNot(value = SkipWhenDecoderPluginNameIsNot.DecoderPluginName.PGOUTPUT, reason = \"Publication not supported\")\n+    public void exportedSnapshotShouldNotSkipRecordOfParallelTxPgoutput() throws Exception {\n+        TestHelper.dropDefaultReplicationSlot();\n+        TestHelper.createDefaultReplicationSlot();\n+        TestHelper.execute(\"CREATE PUBLICATION dbz_publication FOR ALL TABLES;\");\n+\n+        // Testing.Print.enable();\n+        TestHelper.execute(SETUP_TABLES_STMT);\n+        TestHelper.execute(INSERT_STMT);\n+\n+        Configuration config = TestHelper.defaultConfig()\n+                .with(PostgresConnectorConfig.SNAPSHOT_MODE, SnapshotMode.EXPORTED.getValue())\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, Boolean.FALSE)\n+                .with(PostgresConnectorConfig.MAX_QUEUE_SIZE, 2)\n+                .with(PostgresConnectorConfig.MAX_BATCH_SIZE, 1)\n+                .build();\n+        final PostgresConnection pgConnection = TestHelper.create();\n+        pgConnection.setAutoCommit(false);\n+        pgConnection.executeWithoutCommitting(INSERT_STMT);\n+        final AtomicBoolean inserted = new AtomicBoolean();\n+        start(PostgresConnector.class, config, loggingCompletion(), x -> false, x -> {\n+            if (!inserted.get()) {\n+                TestHelper.execute(INSERT_STMT);\n+                try {\n+                    pgConnection.commit();\n+                }\n+                catch (Exception e) {\n+                    e.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2fc4a6558f7771ccb2074f2e78ac7003bfccefb"}, "originalPosition": 92}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4e0a1f12b17a101c82e57454bce9da001c587a7", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/c4e0a1f12b17a101c82e57454bce9da001c587a7", "committedDate": "2020-07-16T06:51:09Z", "message": "DBZ-2288 Rethrow exception in test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12c94216e3ed3f63a1728f3b865ac4dbda36bd4b", "author": {"user": {"login": "jpechane", "name": "Jiri Pechanec"}}, "url": "https://github.com/debezium/debezium/commit/12c94216e3ed3f63a1728f3b865ac4dbda36bd4b", "committedDate": "2020-07-16T07:00:12Z", "message": "DBZ-2288 Add documentation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2494, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}