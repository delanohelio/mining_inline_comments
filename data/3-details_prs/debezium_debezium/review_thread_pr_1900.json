{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2ODk3MzU4", "number": 1900, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNToyNDozNlrOEv1oRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzo0MzoyMlrOEwQbEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NTk3MTg4OnYy", "diffSide": "RIGHT", "path": "debezium-core/src/main/java/io/debezium/heartbeat/DatabaseHeartbeatImpl.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNToyNDozNlrOHlC1IA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzozOTowOVrOHlsqJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYwNTcyOA==", "bodyText": "Checking Postgres error codes inside debezium-core might smell, but it solves the issue. WDYT?\nI could add a constructor parameter and inject a List of heartbeat errors which should trigger an exception instead of logging an error, but I don't know if you think it's worth?", "url": "https://github.com/debezium/debezium/pull/1900#discussion_r508605728", "createdAt": "2020-10-20T15:24:36Z", "author": {"login": "rk3rn3r"}, "path": "debezium-core/src/main/java/io/debezium/heartbeat/DatabaseHeartbeatImpl.java", "diffHunk": "@@ -47,8 +49,16 @@ public void forcedBeat(Map<String, ?> partition, Map<String, ?> offset, Blocking\n         try {\n             jdbcConnection.execute(heartBeatActionQuery);\n         }\n-        catch (Exception e) {\n-            LOGGER.error(\"Could not execute heartbeat action\", e);\n+        catch (SQLException e) {\n+            String sqlErrorId = e.getSQLState();\n+            switch (sqlErrorId) {\n+                case \"57P01\":  // Postgres error admin_shutdown, see https://www.postgresql.org/docs/9.4/errcodes-appendix.html", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY1MDUzNA==", "bodyText": "This is definitely not a ood solution. It woud be valid to change Heartbeat contract in the way that for example you'd pass a code that would do the evaluation you do right now. In the similar way as is done in io.debezium.pipeline.ErrorHandler.\nAlso do you really want to throw the exception? It sounds like a real hack here. In fact it should be a callback that will be passed from the connector. When this happens the callback will change a flag monitored in the main connector loop or ideall in io.debezium.pipeline.ChangeEventSourceCoordinator.ChangeEventSourceContextImpl or call connector stop. This will trigger graceful connector shutdown", "url": "https://github.com/debezium/debezium/pull/1900#discussion_r508650534", "createdAt": "2020-10-20T16:03:21Z", "author": {"login": "jpechane"}, "path": "debezium-core/src/main/java/io/debezium/heartbeat/DatabaseHeartbeatImpl.java", "diffHunk": "@@ -47,8 +49,16 @@ public void forcedBeat(Map<String, ?> partition, Map<String, ?> offset, Blocking\n         try {\n             jdbcConnection.execute(heartBeatActionQuery);\n         }\n-        catch (Exception e) {\n-            LOGGER.error(\"Could not execute heartbeat action\", e);\n+        catch (SQLException e) {\n+            String sqlErrorId = e.getSQLState();\n+            switch (sqlErrorId) {\n+                case \"57P01\":  // Postgres error admin_shutdown, see https://www.postgresql.org/docs/9.4/errcodes-appendix.html", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYwNTcyOA=="}, "originalCommit": null, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5MTA0Ng==", "bodyText": "Thank you @jpechane. I applied most parts of you feedback, I guess.\nI will reply on the exception vs graceful stop in the refactored code.", "url": "https://github.com/debezium/debezium/pull/1900#discussion_r509291046", "createdAt": "2020-10-21T13:39:09Z", "author": {"login": "rk3rn3r"}, "path": "debezium-core/src/main/java/io/debezium/heartbeat/DatabaseHeartbeatImpl.java", "diffHunk": "@@ -47,8 +49,16 @@ public void forcedBeat(Map<String, ?> partition, Map<String, ?> offset, Blocking\n         try {\n             jdbcConnection.execute(heartBeatActionQuery);\n         }\n-        catch (Exception e) {\n-            LOGGER.error(\"Could not execute heartbeat action\", e);\n+        catch (SQLException e) {\n+            String sqlErrorId = e.getSQLState();\n+            switch (sqlErrorId) {\n+                case \"57P01\":  // Postgres error admin_shutdown, see https://www.postgresql.org/docs/9.4/errcodes-appendix.html", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYwNTcyOA=="}, "originalCommit": null, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NTk5MDExOnYy", "diffSide": "RIGHT", "path": "debezium-core/src/main/java/io/debezium/heartbeat/Heartbeat.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNToyNzoxMFrOHlDBHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNToyNzoxMFrOHlDBHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYwODc5Ng==", "bodyText": "This and other lines in that file are unrelated, just housekeeping (but depending on the previous question I need to edit that file anyway).\nEverything on an interface is public static per default and final as well.", "url": "https://github.com/debezium/debezium/pull/1900#discussion_r508608796", "createdAt": "2020-10-20T15:27:10Z", "author": {"login": "rk3rn3r"}, "path": "debezium-core/src/main/java/io/debezium/heartbeat/Heartbeat.java", "diffHunk": "@@ -28,15 +28,15 @@\n  */\n public interface Heartbeat {\n \n-    public static final String HEARTBEAT_INTERVAL_PROPERTY_NAME = \"heartbeat.interval.ms\";\n+    String HEARTBEAT_INTERVAL_PROPERTY_NAME = \"heartbeat.interval.ms\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NTk5NzU5OnYy", "diffSide": "RIGHT", "path": "pom.xml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNToyODoxNFrOHlDGFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNToyODoxNFrOHlDGFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYxMDA2OA==", "bodyText": "unrelated, just housekeeping (unifying and updating)", "url": "https://github.com/debezium/debezium/pull/1900#discussion_r508610068", "createdAt": "2020-10-20T15:28:14Z", "author": {"login": "rk3rn3r"}, "path": "pom.xml", "diffHunk": "@@ -85,7 +85,7 @@\n         <quarkus.version>1.7.1.Final</quarkus.version>\n \n         <!-- HTTP client -->\n-        <version.okhttp>4.2.2</version.okhttp>\n+        <version.okhttp>4.8.1</version.okhttp>", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDMyNzM3OnYy", "diffSide": "RIGHT", "path": "debezium-core/src/main/java/io/debezium/heartbeat/DatabaseHeartbeatImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzozNjoyMlrOHlsh_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzozNjoyMlrOHlsh_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI4ODk1Ng==", "bodyText": "I decoupled Heartbeat from the dependency to Configuration. Instead heartbeatInterval is passed explicitly (and heartbeatQuery where applicable).", "url": "https://github.com/debezium/debezium/pull/1900#discussion_r509288956", "createdAt": "2020-10-21T13:36:22Z", "author": {"login": "rk3rn3r"}, "path": "debezium-core/src/main/java/io/debezium/heartbeat/DatabaseHeartbeatImpl.java", "diffHunk": "@@ -34,21 +35,27 @@\n \n     private final String heartBeatActionQuery;\n     private final JdbcConnection jdbcConnection;\n+    private final HeartbeatErrorHandler errorHandler;\n \n-    DatabaseHeartbeatImpl(Configuration configuration, String topicName, String key, JdbcConnection jdbcConnection, String heartBeatActionQuery) {\n-        super(configuration, topicName, key);\n+    DatabaseHeartbeatImpl(Duration heartbeatInterval, String topicName, String key, JdbcConnection jdbcConnection, String heartBeatActionQuery,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "185f18766b035c734ca02bf8f323f383bdf1c232"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDM2MTc5OnYy", "diffSide": "RIGHT", "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/PostgresConnectorTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzo0MzoyMlrOHls3ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwNjoyMjozMVrOHshaGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5NDQ5NA==", "bodyText": "@jpechane I don't think that this is a reason for a graceful shutdown of the connector. I think the connector should go into FAILED state and the user needs to resolve the Postgres issue. Then the user can simply resume the connector via Kafka Connect REST API.\ncannot_connect_now can also maybe also happen during boot or reboot and might be retriable (depending on the timing). At least we can now specify the behavior per connector and maybe see how it behaves in the wild, wdyt?", "url": "https://github.com/debezium/debezium/pull/1900#discussion_r509294494", "createdAt": "2020-10-21T13:43:22Z", "author": {"login": "rk3rn3r"}, "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/PostgresConnectorTask.java", "diffHunk": "@@ -151,12 +153,28 @@ public ChangeEventSourceCoordinator start(Configuration config) {\n                     .loggingContextSupplier(() -> taskContext.configureLoggingContext(CONTEXT_NAME))\n                     .build();\n \n-            errorHandler = new PostgresErrorHandler(connectorConfig.getLogicalName(), queue);\n+            ErrorHandler errorHandler = new PostgresErrorHandler(connectorConfig.getLogicalName(), queue);\n \n             final PostgresEventMetadataProvider metadataProvider = new PostgresEventMetadataProvider();\n \n-            Heartbeat heartbeat = Heartbeat.create(connectorConfig.getConfig(), topicSelector.getHeartbeatTopic(),\n-                    connectorConfig.getLogicalName(), heartbeatConnection);\n+            Configuration configuration = connectorConfig.getConfig();\n+            Heartbeat heartbeat = Heartbeat.create(\n+                    configuration.getDuration(Heartbeat.HEARTBEAT_INTERVAL, ChronoUnit.MILLIS),\n+                    configuration.getString(DatabaseHeartbeatImpl.HEARTBEAT_ACTION_QUERY),\n+                    topicSelector.getHeartbeatTopic(),\n+                    connectorConfig.getLogicalName(), heartbeatConnection, exception -> {\n+                        String sqlErrorId = exception.getSQLState();\n+                        switch (sqlErrorId) {\n+                            case \"57P01\":\n+                                // Postgres error admin_shutdown, see https://www.postgresql.org/docs/12/errcodes-appendix.html\n+                                throw new DebeziumException(\"Could not execute heartbeat action (Error: \" + sqlErrorId + \")\", exception);\n+                            case \"57P03\":\n+                                // Postgres error cannot_connect_now, see https://www.postgresql.org/docs/12/errcodes-appendix.html\n+                                throw new RetriableException(\"Could not execute heartbeat action (Error: \" + sqlErrorId + \")\", exception);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "185f18766b035c734ca02bf8f323f383bdf1c232"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ0Njc0Ng==", "bodyText": "@rk3rn3r You are right!", "url": "https://github.com/debezium/debezium/pull/1900#discussion_r516446746", "createdAt": "2020-11-03T06:22:31Z", "author": {"login": "jpechane"}, "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/PostgresConnectorTask.java", "diffHunk": "@@ -151,12 +153,28 @@ public ChangeEventSourceCoordinator start(Configuration config) {\n                     .loggingContextSupplier(() -> taskContext.configureLoggingContext(CONTEXT_NAME))\n                     .build();\n \n-            errorHandler = new PostgresErrorHandler(connectorConfig.getLogicalName(), queue);\n+            ErrorHandler errorHandler = new PostgresErrorHandler(connectorConfig.getLogicalName(), queue);\n \n             final PostgresEventMetadataProvider metadataProvider = new PostgresEventMetadataProvider();\n \n-            Heartbeat heartbeat = Heartbeat.create(connectorConfig.getConfig(), topicSelector.getHeartbeatTopic(),\n-                    connectorConfig.getLogicalName(), heartbeatConnection);\n+            Configuration configuration = connectorConfig.getConfig();\n+            Heartbeat heartbeat = Heartbeat.create(\n+                    configuration.getDuration(Heartbeat.HEARTBEAT_INTERVAL, ChronoUnit.MILLIS),\n+                    configuration.getString(DatabaseHeartbeatImpl.HEARTBEAT_ACTION_QUERY),\n+                    topicSelector.getHeartbeatTopic(),\n+                    connectorConfig.getLogicalName(), heartbeatConnection, exception -> {\n+                        String sqlErrorId = exception.getSQLState();\n+                        switch (sqlErrorId) {\n+                            case \"57P01\":\n+                                // Postgres error admin_shutdown, see https://www.postgresql.org/docs/12/errcodes-appendix.html\n+                                throw new DebeziumException(\"Could not execute heartbeat action (Error: \" + sqlErrorId + \")\", exception);\n+                            case \"57P03\":\n+                                // Postgres error cannot_connect_now, see https://www.postgresql.org/docs/12/errcodes-appendix.html\n+                                throw new RetriableException(\"Could not execute heartbeat action (Error: \" + sqlErrorId + \")\", exception);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5NDQ5NA=="}, "originalCommit": {"oid": "185f18766b035c734ca02bf8f323f383bdf1c232"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4139, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}