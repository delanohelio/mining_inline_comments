{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxMDc0MDA4", "number": 197, "title": "FM2-209: Implement search for MedicationRequest Resource", "bodyText": "FM2-209: Implement search for MedicationRequest Resource\nissue: https://issues.openmrs.org/browse/FM2-209\nIt is still a work in progress and so I have made this initial PR to get some feedback before implementing in r4 as well as writing more tests. cc. @ibacher\n\n\n\nDescription of what I changed\n\n\nIssue I worked on\n\n\n\n\nsee https://issues.openmrs.org/browse/FM2-\nChecklist: I completed these to help reviewers :)\n\n\n\n\n My IDE is configured to follow the code style of this project.\nNo? Unsure? -> configure your IDE, format the code and add the changes with git add . && git commit --amend\n\n\n I have added tests to cover my changes. (If you refactored\nexisting code that was well tested you do not have to add tests)\nNo? -> write tests and add them to this commit git add . && git commit --amend\n\n\n I ran mvn clean package right before creating this pull request and\nadded all formatting changes to my commit.\nNo? -> execute above command\n\n\n All new and existing tests passed.\nNo? -> figure out why and add the fix to your commit. It is your responsibility to make sure your code works.\n\n\n My pull request is based on the latest changes of the master branch.\nNo? Unsure? -> execute command git pull --rebase upstream master", "createdAt": "2020-06-08T11:44:11Z", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197", "merged": true, "mergeCommit": {"oid": "e83a4fe104d7e150084c931591f878badf9d169b"}, "closed": true, "closedAt": "2020-06-12T18:53:42Z", "author": {"login": "reagan-meant"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpO6jMAH2gAyNDMxMDc0MDA4OmY4MGVjOTgzYWI5OGE2Mjg0NTU3ODc5YTM4NTg1NTA0MTE5MjU4MGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqnf7CAFqTQyOTk2ODMwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f80ec983ab98a6284557879a385855041192580e", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/f80ec983ab98a6284557879a385855041192580e", "committedDate": "2020-06-08T11:39:36Z", "message": "FM2-209: Implement search for MedicationRequest Resource"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MTUwNDU0", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#pullrequestreview-426150454", "createdAt": "2020-06-08T11:48:47Z", "commit": {"oid": "f80ec983ab98a6284557879a385855041192580e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMTo0ODo0N1rOGgaK4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMTo0ODo0N1rOGgaK4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzNjM4NA==", "bodyText": "@ibacher  Need some clarity especially on this case and this case   because I am still struggling to understand the two despite reading up from the documentation", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r436636384", "createdAt": "2020-06-08T11:48:47Z", "author": {"login": "reagan-meant"}, "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirMedicationRequestDaoImpl.java", "diffHunk": "@@ -9,14 +9,62 @@\n  */\n package org.openmrs.module.fhir2.api.dao.impl;\n \n+import ca.uhn.fhir.rest.param.ReferenceAndListParam;\n+import ca.uhn.fhir.rest.param.TokenAndListParam;\n import lombok.AccessLevel;\n import lombok.Setter;\n+import org.hibernate.Criteria;\n import org.openmrs.DrugOrder;\n+import org.openmrs.module.fhir2.FhirConstants;\n import org.openmrs.module.fhir2.api.dao.FhirMedicationRequestDao;\n+import org.openmrs.module.fhir2.api.search.param.SearchParameterMap;\n import org.springframework.stereotype.Component;\n \n @Component\n @Setter(AccessLevel.PACKAGE)\n public class FhirMedicationRequestDaoImpl extends BaseFhirDao<DrugOrder> implements FhirMedicationRequestDao {\n \t\n+\t@Override\n+\tprotected void setupSearchParams(Criteria criteria, SearchParameterMap theParams) {\n+\t\ttheParams.getParameters().forEach(entry -> {\n+\t\t\tswitch (entry.getKey()) {\n+\t\t\t\tcase FhirConstants.ENCOUNTER_REFERENCE_SEARCH_HANDLER:\n+\t\t\t\t\tentry.getValue().forEach(p -> handleEncounterReference(\"e\", (ReferenceAndListParam) p.getParam())\n+\t\t\t\t\t        .ifPresent(c -> criteria.createAlias(\"encounter\", \"e\").add(c)));\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase FhirConstants.PATIENT_REFERENCE_SEARCH_HANDLER:\n+\t\t\t\t\tentry.getValue().forEach(patientReference -> handlePatientReference(criteria,\n+\t\t\t\t\t    (ReferenceAndListParam) patientReference.getParam(), \"person\"));\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase FhirConstants.CODED_SEARCH_HANDLER:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f80ec983ab98a6284557879a385855041192580e"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MjM4Mzgy", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#pullrequestreview-426238382", "createdAt": "2020-06-08T13:31:48Z", "commit": {"oid": "f80ec983ab98a6284557879a385855041192580e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzozMTo0OFrOGgePag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzozMTo0OFrOGgePag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwMzA4Mg==", "bodyText": "Always have a newline at the end of a file", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r436703082", "createdAt": "2020-06-08T13:31:48Z", "author": {"login": "ibacher"}, "path": "api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirMedicationRequestServiceImpl.java", "diffHunk": "@@ -12,22 +12,54 @@\n import lombok.AccessLevel;\n import lombok.Getter;\n import lombok.Setter;\n+\n+import java.util.Collection;\n+\n import org.hl7.fhir.r4.model.MedicationRequest;\n+import org.openmrs.DrugOrder;\n+import org.openmrs.module.fhir2.FhirConstants;\n import org.openmrs.module.fhir2.api.FhirMedicationRequestService;\n+import org.openmrs.module.fhir2.api.dao.FhirDao;\n import org.openmrs.module.fhir2.api.dao.FhirMedicationRequestDao;\n+import org.openmrs.module.fhir2.api.search.SearchQuery;\n+import org.openmrs.module.fhir2.api.search.param.SearchParameterMap;\n import org.openmrs.module.fhir2.api.translators.MedicationRequestTranslator;\n+import org.openmrs.module.fhir2.api.translators.OpenmrsFhirTranslator;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Component;\n \n+import ca.uhn.fhir.rest.api.server.IBundleProvider;\n+import ca.uhn.fhir.rest.param.ReferenceAndListParam;\n+import ca.uhn.fhir.rest.param.TokenAndListParam;\n+\n @Component\n @Setter(AccessLevel.PACKAGE)\n @Getter(AccessLevel.PROTECTED)\n-public class FhirMedicationRequestServiceImpl extends BaseFhirService<MedicationRequest, org.openmrs.DrugOrder> implements FhirMedicationRequestService {\n-\t\n+public class FhirMedicationRequestServiceImpl extends BaseFhirService<MedicationRequest, org.openmrs.DrugOrder>\n+\t\timplements FhirMedicationRequestService {\n+\n \t@Autowired\n \tprivate MedicationRequestTranslator translator;\n-\t\n+\n \t@Autowired\n \tprivate FhirMedicationRequestDao dao;\n+\n+\t@Autowired\n+\tprivate SearchQuery<DrugOrder, MedicationRequest, FhirMedicationRequestDao, MedicationRequestTranslator> searchQuery;\n+\n+\t@Override\n+\tpublic IBundleProvider searchForMedicationRequests(ReferenceAndListParam patientReference, ReferenceAndListParam encounterReference, TokenAndListParam code,\n+\t\t\tReferenceAndListParam participantReference, ReferenceAndListParam medicationReference) {\n+\n+\t\t\t\tSearchParameterMap theParams = new SearchParameterMap()\n+\t\t        .addParameter(FhirConstants.ENCOUNTER_REFERENCE_SEARCH_HANDLER, encounterReference)\n+\t\t        .addParameter(FhirConstants.PATIENT_REFERENCE_SEARCH_HANDLER, patientReference)\n+\t\t\t\t.addParameter(FhirConstants.CODED_SEARCH_HANDLER, code)\n+\t\t\t\t.addParameter(FhirConstants.PARTICIPANT_REFERENCE_SEARCH_HANDLER, participantReference)\n+\t\t\t\t.addParameter(FhirConstants.MEDICATION_REFERENCE_SEARCH_HANDLER, medicationReference);\n+\n+\t\treturn searchQuery.getQueryResults(theParams, dao, translator);\n+\t}\n+\n \t\n-}\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f80ec983ab98a6284557879a385855041192580e"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MjM4Njk5", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#pullrequestreview-426238699", "createdAt": "2020-06-08T13:31:59Z", "commit": {"oid": "f80ec983ab98a6284557879a385855041192580e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzozMTo1OVrOGgeP9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzozMTo1OVrOGgeP9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwMzIyMw==", "bodyText": "Don't use * imports", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r436703223", "createdAt": "2020-06-08T13:31:59Z", "author": {"login": "ibacher"}, "path": "api/src/main/java/org/openmrs/module/fhir2/providers/r3/MedicationRequestFhirResourceProvider.java", "diffHunk": "@@ -11,17 +11,28 @@\n \n import javax.validation.constraints.NotNull;\n \n-import ca.uhn.fhir.rest.annotation.IdParam;\n-import ca.uhn.fhir.rest.annotation.Read;\n+import ca.uhn.fhir.rest.annotation.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f80ec983ab98a6284557879a385855041192580e"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MjQwNDAw", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#pullrequestreview-426240400", "createdAt": "2020-06-08T13:32:59Z", "commit": {"oid": "f80ec983ab98a6284557879a385855041192580e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzozMzowMFrOGgeSjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzozMzowMFrOGgeSjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwMzg4NA==", "bodyText": "This should initially be developed in the R4 ResourceProvider and then added to R3 afterwards.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r436703884", "createdAt": "2020-06-08T13:33:00Z", "author": {"login": "ibacher"}, "path": "api/src/main/java/org/openmrs/module/fhir2/providers/r3/MedicationRequestFhirResourceProvider.java", "diffHunk": "@@ -49,4 +60,28 @@ public MedicationRequest getMedicationRequestById(@IdParam @NotNull IdType id) {\n \t\t\n \t\treturn MedicationRequest30_40.convertMedicationRequest(medicationRequest);\n \t}\n+\n+\t@Search", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f80ec983ab98a6284557879a385855041192580e"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e8b604465c83c40da25a96241365dc874cf165a", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/4e8b604465c83c40da25a96241365dc874cf165a", "committedDate": "2020-06-09T11:18:04Z", "message": " FM2-209: Implement search for MedicationRequest Resource"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MTk2MDM3", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#pullrequestreview-427196037", "createdAt": "2020-06-09T14:15:08Z", "commit": {"oid": "4e8b604465c83c40da25a96241365dc874cf165a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNDoxNTowOFrOGhMPMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNDoxNTowOFrOGhMPMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ1NjY5MA==", "bodyText": "@ibacher do you mean this for r4 ?", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r437456690", "createdAt": "2020-06-09T14:15:08Z", "author": {"login": "reagan-meant"}, "path": "api/src/main/java/org/openmrs/module/fhir2/providers/r4/MedicationRequestFhirResourceProvider.java", "diffHunk": "@@ -48,4 +57,29 @@ public MedicationRequest getMedicationRequestByUuid(@IdParam @NotNull IdType id)\n \t\treturn medicationRequest;\n \t}\n \t\n+\t\n+\t@Search\n+\t@SuppressWarnings(\"unused\")\n+\tpublic IBundleProvider searchForMedicationRequests(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e8b604465c83c40da25a96241365dc874cf165a"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MjM4NzY3", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#pullrequestreview-427238767", "createdAt": "2020-06-09T14:56:06Z", "commit": {"oid": "4e8b604465c83c40da25a96241365dc874cf165a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNDo1NjowNlrOGhOM0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNDo1NjowNlrOGhOM0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ4ODg0OA==", "bodyText": "@reagan-meant  Can we have a get() method which just gets the resources once instead of querying the database repeatedly? Please use this comment throughout the PR.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r437488848", "createdAt": "2020-06-09T14:56:06Z", "author": {"login": "varung-31"}, "path": "api/src/test/java/org/openmrs/module/fhir2/providers/r4/MedicationRequestFhirResourceProviderTest.java", "diffHunk": "@@ -73,4 +89,97 @@ public void getMedicationRequestByUuid_shouldThrowResourceNotFoundException() {\n \t\tMedicationRequest medicationRequest = resourceProvider.getMedicationRequestByUuid(id);\n \t\tassertThat(medicationRequest, nullValue());\n \t}\n+\n+\t\n+\t@Test\n+\tpublic void searchMedicationRequest_shouldReturnMatchingMedicationRequestUsingCode() {\n+\t\n+\t\twhen(fhirMedicationRequestService.searchForMedicationRequests(any(), any(), any(), any(), any()))\n+\t\t\t\t.thenReturn(new BaseFhirIBundleResourceProviderTest<>(Collections.singletonList(medicationRequest), 10, 1));\n+\t\t\n+\t\tTokenAndListParam code = new TokenAndListParam();\n+\t\tTokenParam codingToken = new TokenParam();\n+\t\tcodingToken.setValue(\"1000\");\n+\t\tcode.addAnd(codingToken);\n+\t\t\n+\t\tIBundleProvider results = resourceProvider.searchForMedicationRequests(null, null, null, code, null, null);\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results.getResources(1, 5), hasSize(equalTo(1)));\n+\t\tassertThat(results.getResources(1, 5).get(0), notNullValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e8b604465c83c40da25a96241365dc874cf165a"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6795213811d0c7fdb282a12fffda9ac779c55560", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/6795213811d0c7fdb282a12fffda9ac779c55560", "committedDate": "2020-06-10T12:16:12Z", "message": "FM2-209: Implement search for MedicationRequest Resource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "667ee1107bac3b09eee6d0c09bb5cbb528725f40", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/667ee1107bac3b09eee6d0c09bb5cbb528725f40", "committedDate": "2020-06-12T09:24:13Z", "message": " FM2-209: Implement search for MedicationRequest Resource"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5OTY4MzAz", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#pullrequestreview-429968303", "createdAt": "2020-06-12T18:52:04Z", "commit": {"oid": "667ee1107bac3b09eee6d0c09bb5cbb528725f40"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4053, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}