{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExNjk0NTA2", "number": 158, "title": "FM2-183: Add support for DSTU3", "bodyText": "@VaishSiddharth I'm opening this as a draft PR as the communication tools are better integrated than what we've been doing.\nAnyone else, we're currently building support for DSTU3 into the module. This will also serve as the pattern for integrating new versions of FHIR into the module, though we may not really be looking to support versions earlier that DSTU3.", "createdAt": "2020-04-30T16:21:34Z", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158", "merged": true, "mergeCommit": {"oid": "e3114b0aef80ae7f5c5d6bc43becfda8164e66e6"}, "closed": true, "closedAt": "2020-05-22T20:29:29Z", "author": {"login": "ibacher"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccv1PPgFqTQwMzY3OTQyNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcj4D6FgBqjMzNjYwNzI3NTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNjc5NDI0", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#pullrequestreview-403679424", "createdAt": "2020-04-30T16:22:33Z", "commit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "state": "COMMENTED", "comments": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNjoyMjozM1rOGOw0BQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNjozODo0OVrOGOxb7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzMjk5Nw==", "bodyText": "Minor point, but please configure your IDE not to introduce * imports. OpenMRS doesn't like anyone to use them, and it makes some sense.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418132997", "createdAt": "2020-04-30T16:22:33Z", "author": {"login": "ibacher"}, "path": "omod-dstu3/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceDstu3FhirResourceProvider.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.providers;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.List;\n+\n+import ca.uhn.fhir.rest.annotation.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzMzI2NQ==", "bodyText": "Remove the * import", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418133265", "createdAt": "2020-04-30T16:22:58Z", "author": {"login": "ibacher"}, "path": "omod-dstu3/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceDstu3FhirResourceProvider.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.providers;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.List;\n+\n+import ca.uhn.fhir.rest.annotation.*;\n+import ca.uhn.fhir.rest.param.ReferenceAndListParam;\n+import ca.uhn.fhir.rest.param.TokenAndListParam;\n+import ca.uhn.fhir.rest.param.TokenOrListParam;\n+import ca.uhn.fhir.rest.server.IResourceProvider;\n+import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;\n+import lombok.AccessLevel;\n+import lombok.Setter;\n+import org.hl7.fhir.convertors.VersionConvertor_30_40;\n+import org.hl7.fhir.dstu3.model.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzMzY4OQ==", "bodyText": "Yes! We should implement this!", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418133689", "createdAt": "2020-04-30T16:23:43Z", "author": {"login": "ibacher"}, "path": "omod-dstu3/src/main/java/org/openmrs/module/fhir2/providers/ConditionDstu3FhirResourceProvider.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.providers;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.List;\n+\n+import ca.uhn.fhir.rest.annotation.*;\n+import ca.uhn.fhir.rest.api.SortSpec;\n+import ca.uhn.fhir.rest.param.DateRangeParam;\n+import ca.uhn.fhir.rest.param.QuantityAndListParam;\n+import ca.uhn.fhir.rest.param.ReferenceAndListParam;\n+import ca.uhn.fhir.rest.param.TokenAndListParam;\n+import ca.uhn.fhir.rest.server.IResourceProvider;\n+import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;\n+import lombok.AccessLevel;\n+import lombok.Setter;\n+import org.hl7.fhir.convertors.VersionConvertor_30_40;\n+import org.hl7.fhir.dstu3.model.*;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.openmrs.module.fhir2.api.FhirConditionService;\n+import org.openmrs.module.fhir2.util.FhirServerUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+@Qualifier(\"fhirDstu3Resources\")\n+@Setter(AccessLevel.PACKAGE)\n+public class ConditionDstu3FhirResourceProvider implements IResourceProvider {\n+\t\n+\t@Autowired\n+\tprivate FhirConditionService conditionService;\n+\t\n+\t@Override\n+\tpublic Class<? extends IBaseResource> getResourceType() {\n+\t\treturn Condition.class;\n+\t}\n+\t\n+\t@Read\n+\t@SuppressWarnings(\"unused\")\n+\tpublic Condition getConditionById(@IdParam @NotNull IdType id) {\n+\t\torg.hl7.fhir.r4.model.Condition condition = conditionService.getConditionByUuid(id.getIdPart());\n+\t\tif (condition == null) {\n+\t\t\tthrow new ResourceNotFoundException(\"Could not find condition with Id \" + id.getIdPart());\n+\t\t}\n+\t\t\n+\t\treturn VersionConvertor_30_40.convertCondition(condition);\n+\t}\n+\t\n+\t@History\n+\t@SuppressWarnings(\"unused\")\n+\tpublic List<Resource> getConditionHistoryById(@IdParam @NotNull IdType id) {\n+\t\torg.hl7.fhir.r4.model.Condition condition = conditionService.getConditionByUuid(id.getIdPart());\n+\t\tif (condition == null) {\n+\t\t\tthrow new ResourceNotFoundException(\"Could not find condition with Id \" + id.getIdPart());\n+\t\t}\n+\t\treturn VersionConvertor_30_40.convertCondition(condition).getContained();\n+\t}\n+\t\n+\t//\t// TODO: Required or not?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzNDMyNQ==", "bodyText": "Required, but we will obviously be given the R3 version of the DiagnosticReport here.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418134325", "createdAt": "2020-04-30T16:24:36Z", "author": {"login": "ibacher"}, "path": "omod-dstu3/src/main/java/org/openmrs/module/fhir2/providers/DiagnosticReportDstu3FhirResourceProvider.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.providers;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import ca.uhn.fhir.rest.annotation.*;\n+import ca.uhn.fhir.rest.api.MethodOutcome;\n+import ca.uhn.fhir.rest.server.IResourceProvider;\n+import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;\n+import lombok.AccessLevel;\n+import lombok.Setter;\n+import org.hl7.fhir.convertors.VersionConvertor_30_40;\n+import org.hl7.fhir.dstu3.model.DiagnosticReport;\n+import org.hl7.fhir.dstu3.model.IdType;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.openmrs.module.fhir2.api.FhirDiagnosticReportService;\n+import org.openmrs.module.fhir2.util.FhirServerUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+@Qualifier(\"fhirDstu3Resources\")\n+@Setter(AccessLevel.PACKAGE)\n+public class DiagnosticReportDstu3FhirResourceProvider implements IResourceProvider {\n+\t\n+\t@Autowired\n+\tprivate FhirDiagnosticReportService diagnosticReportService;\n+\t\n+\t@Override\n+\tpublic Class<? extends IBaseResource> getResourceType() {\n+\t\treturn DiagnosticReport.class;\n+\t}\n+\t\n+\t@Read\n+\t@SuppressWarnings(\"unused\")\n+\tpublic DiagnosticReport getDiagnosticReportById(@IdParam @NotNull IdType id) {\n+\t\torg.hl7.fhir.r4.model.DiagnosticReport diagnosticReport = diagnosticReportService\n+\t\t        .getDiagnosticReportByUuid(id.getIdPart());\n+\t\tif (diagnosticReport == null) {\n+\t\t\tthrow new ResourceNotFoundException(\"Could not find diagnosticReport with Id \" + id.getIdPart());\n+\t\t}\n+\t\t\n+\t\treturn VersionConvertor_30_40.convertDiagnosticReport(diagnosticReport);\n+\t}\n+\t\n+\t// TODO: Required or not?\n+\t@Create\n+\tpublic MethodOutcome createDiagnosticReport(@ResourceParam org.hl7.fhir.r4.model.DiagnosticReport diagnosticReport) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzNDUyMg==", "bodyText": "Required, but we will obviously be given the R3 version of the DiagnosticReport here.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418134522", "createdAt": "2020-04-30T16:24:55Z", "author": {"login": "ibacher"}, "path": "omod-dstu3/src/main/java/org/openmrs/module/fhir2/providers/DiagnosticReportDstu3FhirResourceProvider.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.providers;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import ca.uhn.fhir.rest.annotation.*;\n+import ca.uhn.fhir.rest.api.MethodOutcome;\n+import ca.uhn.fhir.rest.server.IResourceProvider;\n+import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;\n+import lombok.AccessLevel;\n+import lombok.Setter;\n+import org.hl7.fhir.convertors.VersionConvertor_30_40;\n+import org.hl7.fhir.dstu3.model.DiagnosticReport;\n+import org.hl7.fhir.dstu3.model.IdType;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.openmrs.module.fhir2.api.FhirDiagnosticReportService;\n+import org.openmrs.module.fhir2.util.FhirServerUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+@Qualifier(\"fhirDstu3Resources\")\n+@Setter(AccessLevel.PACKAGE)\n+public class DiagnosticReportDstu3FhirResourceProvider implements IResourceProvider {\n+\t\n+\t@Autowired\n+\tprivate FhirDiagnosticReportService diagnosticReportService;\n+\t\n+\t@Override\n+\tpublic Class<? extends IBaseResource> getResourceType() {\n+\t\treturn DiagnosticReport.class;\n+\t}\n+\t\n+\t@Read\n+\t@SuppressWarnings(\"unused\")\n+\tpublic DiagnosticReport getDiagnosticReportById(@IdParam @NotNull IdType id) {\n+\t\torg.hl7.fhir.r4.model.DiagnosticReport diagnosticReport = diagnosticReportService\n+\t\t        .getDiagnosticReportByUuid(id.getIdPart());\n+\t\tif (diagnosticReport == null) {\n+\t\t\tthrow new ResourceNotFoundException(\"Could not find diagnosticReport with Id \" + id.getIdPart());\n+\t\t}\n+\t\t\n+\t\treturn VersionConvertor_30_40.convertDiagnosticReport(diagnosticReport);\n+\t}\n+\t\n+\t// TODO: Required or not?\n+\t@Create\n+\tpublic MethodOutcome createDiagnosticReport(@ResourceParam org.hl7.fhir.r4.model.DiagnosticReport diagnosticReport) {\n+\t\treturn FhirServerUtils.buildCreate(diagnosticReportService.saveDiagnosticReport(diagnosticReport));\n+\t}\n+\t\n+\t// TODO: Required or not?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzNTAzMw==", "bodyText": "I'd prefer if these files were structured similarly, i.e. with the @History method following the @Read method.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418135033", "createdAt": "2020-04-30T16:25:47Z", "author": {"login": "ibacher"}, "path": "omod-dstu3/src/main/java/org/openmrs/module/fhir2/providers/EncounterDstu3FhirResourceProvider.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.providers;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.List;\n+\n+import ca.uhn.fhir.rest.annotation.*;\n+import ca.uhn.fhir.rest.param.DateRangeParam;\n+import ca.uhn.fhir.rest.param.ReferenceAndListParam;\n+import ca.uhn.fhir.rest.server.IResourceProvider;\n+import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;\n+import lombok.AccessLevel;\n+import lombok.Setter;\n+import org.hl7.fhir.convertors.VersionConvertor_30_40;\n+import org.hl7.fhir.dstu3.model.*;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.openmrs.module.fhir2.api.FhirEncounterService;\n+import org.openmrs.module.fhir2.util.FhirServerUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+@Qualifier(\"fhirDstu3Resources\")\n+@Setter(AccessLevel.PACKAGE)\n+public class EncounterDstu3FhirResourceProvider implements IResourceProvider {\n+\t\n+\t@Autowired\n+\tprivate FhirEncounterService encounterService;\n+\t\n+\t@Override\n+\tpublic Class<? extends IBaseResource> getResourceType() {\n+\t\treturn Encounter.class;\n+\t}\n+\t\n+\t@Read\n+\t@SuppressWarnings(\"unused\")\n+\tpublic Encounter getEncounterById(@IdParam @NotNull IdType id) {\n+\t\torg.hl7.fhir.r4.model.Encounter encounter = encounterService.getEncounterByUuid(id.getIdPart());\n+\t\tif (encounter == null) {\n+\t\t\tthrow new ResourceNotFoundException(\"Could not find encounter with Id \" + id.getIdPart());\n+\t\t}\n+\t\t\n+\t\treturn VersionConvertor_30_40.convertEncounter(encounter);\n+\t}\n+\t\n+\t@Search\n+\tpublic Bundle searchEncounter(@OptionalParam(name = Encounter.SP_DATE) DateRangeParam date,\n+\t        @OptionalParam(name = Encounter.SP_LOCATION, chainWhitelist = { \"\", Location.SP_ADDRESS_CITY,\n+\t                Location.SP_ADDRESS_STATE, Location.SP_ADDRESS_COUNTRY,\n+\t                Location.SP_ADDRESS_POSTALCODE }, targetTypes = Location.class) ReferenceAndListParam location,\n+\t        @OptionalParam(name = Encounter.SP_PARTICIPANT, chainWhitelist = { \"\", Practitioner.SP_IDENTIFIER,\n+\t                Practitioner.SP_GIVEN, Practitioner.SP_FAMILY,\n+\t                Practitioner.SP_NAME }, targetTypes = Practitioner.class) ReferenceAndListParam participantReference,\n+\t        @OptionalParam(name = Encounter.SP_SUBJECT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER, Patient.SP_GIVEN,\n+\t                Patient.SP_FAMILY,\n+\t                Patient.SP_NAME }, targetTypes = Patient.class) ReferenceAndListParam subjectReference) {\n+\t\treturn VersionConvertor_30_40.convertBundle(FhirServerUtils.convertSearchResultsToBundle(\n+\t\t    encounterService.searchForEncounters(date, location, participantReference, subjectReference)));\n+\t\t\n+\t}\n+\t\n+\t@History\n+\t@SuppressWarnings(\"unused\")\n+\tpublic List<Resource> getEncounterHistoryById(@IdParam @NotNull IdType id) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzNjI0Nw==", "bodyText": "Thinking about this some more, I think that instead of naming every ResourceProvider ...DStu3ResourceProvider we should move them into a r3 package so, for instance, this class would become org.openmrs.module.fhir2.providers.r3.AllergyIntoleranceFhirResourceProvider.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418136247", "createdAt": "2020-04-30T16:27:38Z", "author": {"login": "ibacher"}, "path": "omod-dstu3/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceDstu3FhirResourceProvider.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.providers;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzNzc4OQ==", "bodyText": "Let's shorten this to fhirR3Resources (R3 is the release, but was called STU3 \u2014 standard trial use; R2 was released and called DSTU2 \u2014 draft standard trial use; I'm just favouring the shorter one!)", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418137789", "createdAt": "2020-04-30T16:30:03Z", "author": {"login": "ibacher"}, "path": "omod-dstu3/src/main/java/org/openmrs/module/fhir2/providers/AllergyIntoleranceDstu3FhirResourceProvider.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.providers;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.List;\n+\n+import ca.uhn.fhir.rest.annotation.*;\n+import ca.uhn.fhir.rest.param.ReferenceAndListParam;\n+import ca.uhn.fhir.rest.param.TokenAndListParam;\n+import ca.uhn.fhir.rest.param.TokenOrListParam;\n+import ca.uhn.fhir.rest.server.IResourceProvider;\n+import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;\n+import lombok.AccessLevel;\n+import lombok.Setter;\n+import org.hl7.fhir.convertors.VersionConvertor_30_40;\n+import org.hl7.fhir.dstu3.model.*;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.openmrs.module.fhir2.api.FhirAllergyIntoleranceService;\n+import org.openmrs.module.fhir2.util.FhirServerUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+@Qualifier(\"fhirDstu3Resources\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzODcxMQ==", "bodyText": "See above about the order of methods", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418138711", "createdAt": "2020-04-30T16:31:34Z", "author": {"login": "ibacher"}, "path": "omod-dstu3/src/main/java/org/openmrs/module/fhir2/providers/ObservationDstu3FhirResourceProvider.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.providers;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.List;\n+\n+import ca.uhn.fhir.rest.annotation.*;\n+import ca.uhn.fhir.rest.api.SortSpec;\n+import ca.uhn.fhir.rest.param.*;\n+import ca.uhn.fhir.rest.server.IResourceProvider;\n+import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;\n+import lombok.AccessLevel;\n+import lombok.Setter;\n+import org.hl7.fhir.convertors.VersionConvertor_30_40;\n+import org.hl7.fhir.dstu3.model.*;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.openmrs.module.fhir2.api.FhirObservationService;\n+import org.openmrs.module.fhir2.util.FhirServerUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+@Qualifier(\"fhirDstu3Resources\")\n+@Setter(AccessLevel.PACKAGE)\n+public class ObservationDstu3FhirResourceProvider implements IResourceProvider {\n+\t\n+\t@Autowired\n+\tprivate FhirObservationService observationService;\n+\t\n+\t@Override\n+\tpublic Class<? extends IBaseResource> getResourceType() {\n+\t\treturn Observation.class;\n+\t}\n+\t\n+\t@Read\n+\t@SuppressWarnings(\"unused\")\n+\tpublic Observation getObservationById(@IdParam @NotNull IdType id) {\n+\t\torg.hl7.fhir.r4.model.Observation observation = observationService.getObservationByUuid(id.getIdPart());\n+\t\tif (observation == null) {\n+\t\t\tthrow new ResourceNotFoundException(\"Could not find observation with Id \" + id.getIdPart());\n+\t\t}\n+\t\t\n+\t\treturn VersionConvertor_30_40.convertObservation(observation);\n+\t}\n+\t\n+\t@Search\n+\tpublic Bundle searchObservations(\n+\t        @OptionalParam(name = Observation.SP_ENCOUNTER) ReferenceAndListParam encounterReference,\n+\t        @OptionalParam(name = Observation.SP_SUBJECT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER, Patient.SP_GIVEN,\n+\t                Patient.SP_FAMILY,\n+\t                Patient.SP_NAME }, targetTypes = Patient.class) ReferenceAndListParam patientReference,\n+\t        //TODO: SP_HAS_MEMBER not found converted to SP_BASED_ON it's wrong\n+\t        @OptionalParam(name = Observation.SP_BASED_ON, chainWhitelist = { \"\",\n+\t                Observation.SP_CODE }, targetTypes = Observation.class) ReferenceParam hasMemberReference,\n+\t        @OptionalParam(name = Observation.SP_VALUE_CONCEPT) TokenAndListParam valueConcept,\n+\t        @OptionalParam(name = Observation.SP_VALUE_DATE) DateRangeParam valueDateParam,\n+\t        @OptionalParam(name = Observation.SP_VALUE_QUANTITY) QuantityAndListParam valueQuantityParam,\n+\t        @OptionalParam(name = Observation.SP_VALUE_STRING) StringAndListParam valueStringParam,\n+\t        @OptionalParam(name = Observation.SP_DATE) DateRangeParam date,\n+\t        @OptionalParam(name = Observation.SP_CODE) TokenAndListParam code, @Sort SortSpec sort) {\n+\t\treturn VersionConvertor_30_40.convertBundle(FhirServerUtils.convertSearchResultsToBundle(\n+\t\t    observationService.searchForObservations(encounterReference, patientReference, hasMemberReference, valueConcept,\n+\t\t        valueDateParam, valueQuantityParam, valueStringParam, date, code, sort)));\n+\t}\n+\t\n+\t@History\n+\tpublic List<Resource> getObservationHistoryById(@IdParam @NotNull IdType id) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzOTA3OQ==", "bodyText": "getPatientHistoryById, also ordering.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418139079", "createdAt": "2020-04-30T16:32:07Z", "author": {"login": "ibacher"}, "path": "omod-dstu3/src/main/java/org/openmrs/module/fhir2/providers/PatientDstu3FhirResourceProvider.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.providers;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.List;\n+\n+import ca.uhn.fhir.rest.annotation.*;\n+import ca.uhn.fhir.rest.api.SortSpec;\n+import ca.uhn.fhir.rest.param.DateRangeParam;\n+import ca.uhn.fhir.rest.param.StringOrListParam;\n+import ca.uhn.fhir.rest.param.TokenOrListParam;\n+import ca.uhn.fhir.rest.server.IResourceProvider;\n+import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;\n+import lombok.AccessLevel;\n+import lombok.Setter;\n+import org.hl7.fhir.convertors.VersionConvertor_30_40;\n+import org.hl7.fhir.dstu3.model.*;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.openmrs.module.fhir2.api.FhirPatientService;\n+import org.openmrs.module.fhir2.util.FhirServerUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+@Qualifier(\"fhirDstu3Resources\")\n+@Setter(AccessLevel.PACKAGE)\n+public class PatientDstu3FhirResourceProvider implements IResourceProvider {\n+\t\n+\t@Autowired\n+\tprivate FhirPatientService patientService;\n+\t\n+\t@Override\n+\tpublic Class<? extends IBaseResource> getResourceType() {\n+\t\treturn Patient.class;\n+\t}\n+\t\n+\t@Read\n+\t@SuppressWarnings(\"unused\")\n+\tpublic Patient getPatientById(@IdParam @NotNull IdType id) {\n+\t\torg.hl7.fhir.r4.model.Patient patient = patientService.getPatientByUuid(id.getIdPart());\n+\t\tif (patient == null) {\n+\t\t\tthrow new ResourceNotFoundException(\"Could not find patient with Id \" + id.getIdPart());\n+\t\t}\n+\t\t\n+\t\treturn VersionConvertor_30_40.convertPatient(patient);\n+\t}\n+\t\n+\t@Search\n+\t@SuppressWarnings(\"unused\")\n+\tpublic Bundle searchPatients(@OptionalParam(name = Patient.SP_NAME) StringOrListParam name,\n+\t        @OptionalParam(name = Patient.SP_GIVEN) StringOrListParam given,\n+\t        @OptionalParam(name = Patient.SP_FAMILY) StringOrListParam family,\n+\t        @OptionalParam(name = Patient.SP_IDENTIFIER) TokenOrListParam identifier,\n+\t        @OptionalParam(name = Patient.SP_GENDER) TokenOrListParam gender,\n+\t        @OptionalParam(name = Patient.SP_BIRTHDATE) DateRangeParam birthDate,\n+\t        @OptionalParam(name = Patient.SP_DEATH_DATE) DateRangeParam deathDate,\n+\t        @OptionalParam(name = Patient.SP_DECEASED) TokenOrListParam deceased,\n+\t        @OptionalParam(name = Patient.SP_ADDRESS_CITY) StringOrListParam city,\n+\t        @OptionalParam(name = Patient.SP_ADDRESS_STATE) StringOrListParam state,\n+\t        @OptionalParam(name = Patient.SP_ADDRESS_POSTALCODE) StringOrListParam postalCode,\n+\t        @OptionalParam(name = Patient.SP_ADDRESS_COUNTRY) StringOrListParam country, @Sort SortSpec sort) {\n+\t\treturn VersionConvertor_30_40\n+\t\t        .convertBundle(FhirServerUtils.convertSearchResultsToBundle(patientService.searchForPatients(name, given,\n+\t\t            family, identifier, gender, birthDate, deathDate, deceased, city, state, postalCode, country, sort)));\n+\t}\n+\t\n+\t@History\n+\t@SuppressWarnings(\"unused\")\n+\tpublic List<Resource> getPatientResourceHistory(@IdParam @NotNull IdType id) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzOTY4OQ==", "bodyText": "To be consistent, let's call this FhirR3RestServlet", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418139689", "createdAt": "2020-04-30T16:33:07Z", "author": {"login": "ibacher"}, "path": "omod-dstu3/src/main/java/org/openmrs/module/fhir2/web/servlet/FhirDstu3RestServlet.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.web.servlet;\n+\n+import java.util.Collection;\n+\n+import ca.uhn.fhir.context.FhirContext;\n+import ca.uhn.fhir.rest.server.IResourceProvider;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class FhirDstu3RestServlet extends FhirRestServlet {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE0MDI3MA==", "bodyText": "Let's remove this from this switch since we aren't going to use it right now.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418140270", "createdAt": "2020-04-30T16:34:06Z", "author": {"login": "ibacher"}, "path": "omod/src/main/java/org/openmrs/module/fhir2/web/filter/ForwardingFilter.java", "diffHunk": "@@ -33,7 +38,29 @@ public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)\n \t\tString contextPath = ((HttpServletRequest) req).getContextPath();\n \t\tString prefix = contextPath + \"/ws/fhir2/\";\n \t\tif (requestURI.startsWith(prefix)) {\n-\t\t\tString newURI = requestURI.replace(prefix, \"/ms/fhir2Servlet/\");\n+\t\t\tString[] requestPath = requestURI.split(prefix, 1);\n+\t\t\tString maybeVersion = requestPath[1].split(\"/\", 1)[0];\n+\t\t\t\n+\t\t\tString replacement;\n+\t\t\tswitch (maybeVersion) {\n+\t\t\t\tcase \"R2\":\n+\t\t\t\t\tprefix += \"/\" + maybeVersion + \"/\";\n+\t\t\t\t\treplacement = \"/ms/fhir2Dstu2Servlet\";\n+\t\t\t\t\tbreak;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE0MDkxMQ==", "bodyText": "We should remove this servlet mapping", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418140911", "createdAt": "2020-04-30T16:35:10Z", "author": {"login": "ibacher"}, "path": "omod/src/main/resources/config.xml", "diffHunk": "@@ -50,6 +50,16 @@\n \t\t<servlet-class>org.openmrs.module.fhir2.web.servlet.FhirRestServlet</servlet-class>\n \t</servlet>\n \n+\t<servlet>\n+\t\t<servlet-name>fhir2Dstu3Servlet</servlet-name>\n+\t\t<servlet-class>org.openmrs.module.fhir2.web.servlet.FhirDstu3RestServlet</servlet-class>\n+\t</servlet>\n+\n+\t<servlet>\n+\t\t<servlet-name>fhir2Dstu2Servlet</servlet-name>\n+\t\t<servlet-class>org.openmrs.module.fhir2.web.servlet.FhirDstu2RestServlet</servlet-class>\n+\t</servlet>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE0MTA1OA==", "bodyText": "We should change this servlet-name to fhir2R3Servlet", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418141058", "createdAt": "2020-04-30T16:35:25Z", "author": {"login": "ibacher"}, "path": "omod/src/main/resources/config.xml", "diffHunk": "@@ -50,6 +50,16 @@\n \t\t<servlet-class>org.openmrs.module.fhir2.web.servlet.FhirRestServlet</servlet-class>\n \t</servlet>\n \n+\t<servlet>\n+\t\t<servlet-name>fhir2Dstu3Servlet</servlet-name>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE0MTUyMw==", "bodyText": "We need to rethink this. We should return an error if the value isn't a known version so that we're using a consistent access URL.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418141523", "createdAt": "2020-04-30T16:36:14Z", "author": {"login": "ibacher"}, "path": "omod/src/main/java/org/openmrs/module/fhir2/web/filter/ForwardingFilter.java", "diffHunk": "@@ -33,7 +38,29 @@ public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)\n \t\tString contextPath = ((HttpServletRequest) req).getContextPath();\n \t\tString prefix = contextPath + \"/ws/fhir2/\";\n \t\tif (requestURI.startsWith(prefix)) {\n-\t\t\tString newURI = requestURI.replace(prefix, \"/ms/fhir2Servlet/\");\n+\t\t\tString[] requestPath = requestURI.split(prefix, 1);\n+\t\t\tString maybeVersion = requestPath[1].split(\"/\", 1)[0];\n+\t\t\t\n+\t\t\tString replacement;\n+\t\t\tswitch (maybeVersion) {\n+\t\t\t\tcase \"R2\":\n+\t\t\t\t\tprefix += \"/\" + maybeVersion + \"/\";\n+\t\t\t\t\treplacement = \"/ms/fhir2Dstu2Servlet\";\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase \"R3\":\n+\t\t\t\t\tprefix += \"/\" + maybeVersion + \"/\";\n+\t\t\t\t\treplacement = \"/ms/fhir2Dstu3Servlet\";\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase \"R4\":\n+\t\t\t\t\tprefix += \"/\" + maybeVersion + \"/\";\n+\t\t\t\t\treplacement = \"/ms/fhir2Servlet\";\n+\t\t\t\t\tbreak;\n+\t\t\t\tdefault:\n+\t\t\t\t\treplacement = \"/ms/fhir2Servlet\";\n+\t\t\t\t\tbreak;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE0MjcyNQ==", "bodyText": "Instead of making a fork of this class, maybe it makes more sense to call the version here BaseFhirR3ResourceProviderTest and have it extend BaseFhirResourceProviderTest and then make the changes that we need here. This might involve changing BaseFhirResourceProviderTest, but that's ok.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418142725", "createdAt": "2020-04-30T16:38:05Z", "author": {"login": "ibacher"}, "path": "omod-dstu3/src/test/java/org/openmrs/module/fhir2/web/servlet/BaseFhirResourceProviderTest.java", "diffHunk": "@@ -0,0 +1,255 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.web.servlet;\n+\n+import static org.springframework.http.HttpHeaders.ACCEPT;\n+import static org.springframework.http.HttpHeaders.CONTENT_TYPE;\n+\n+import javax.servlet.ServletConfig;\n+import javax.servlet.ServletException;\n+import javax.validation.constraints.NotNull;\n+\n+import java.io.IOException;\n+import java.io.UnsupportedEncodingException;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.util.stream.Collectors;\n+\n+import ca.uhn.fhir.context.FhirContext;\n+import ca.uhn.fhir.parser.DataFormatException;\n+import ca.uhn.fhir.parser.IParser;\n+import ca.uhn.fhir.rest.api.RequestTypeEnum;\n+import ca.uhn.fhir.rest.server.IResourceProvider;\n+import ca.uhn.fhir.rest.server.interceptor.LoggingInterceptor;\n+import lombok.SneakyThrows;\n+import org.hamcrest.Description;\n+import org.hamcrest.Matcher;\n+import org.hamcrest.TypeSafeMatcher;\n+import org.hl7.fhir.dstu3.model.Bundle;\n+import org.hl7.fhir.dstu3.model.OperationOutcome;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.openmrs.api.APIException;\n+import org.openmrs.module.fhir2.FhirConstants;\n+import org.openmrs.module.fhir2.api.impl.FhirGlobalPropertyServiceImpl;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.mock.web.MockHttpServletRequest;\n+import org.springframework.mock.web.MockHttpServletResponse;\n+import org.springframework.mock.web.MockServletConfig;\n+import org.springframework.mock.web.MockServletContext;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+public abstract class BaseFhirResourceProviderTest<T extends IResourceProvider, U extends IBaseResource> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE0MzIxMw==", "bodyText": "Instead of making a fork of this class, maybe it makes more sense to call the version here BaseFhirR3ProvenanceResourceTest and have it extend BaseFhirProvenanceResourceTest and then make the changes that we need here. This might involve changing BaseFhirProvenanceResourceTest, but that's ok.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418143213", "createdAt": "2020-04-30T16:38:49Z", "author": {"login": "ibacher"}, "path": "omod-dstu3/src/test/java/org/openmrs/module/fhir2/web/servlet/BaseFhirProvenanceResourceTest.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.web.servlet;\n+\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Arrays;\n+import java.util.Date;\n+\n+import org.hl7.fhir.convertors.VersionConvertor_30_40;\n+import org.hl7.fhir.dstu3.model.DomainResource;\n+import org.hl7.fhir.r4.model.CodeableConcept;\n+import org.hl7.fhir.r4.model.Coding;\n+import org.hl7.fhir.r4.model.Practitioner;\n+import org.hl7.fhir.r4.model.Provenance;\n+import org.hl7.fhir.r4.model.Reference;\n+import org.mockito.Mock;\n+import org.openmrs.User;\n+import org.openmrs.module.fhir2.FhirConstants;\n+import org.openmrs.module.fhir2.api.translators.PractitionerReferenceTranslator;\n+\n+public abstract class BaseFhirProvenanceResourceTest<T extends DomainResource> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97a17de2cccf29cebd349a2cd7af83ac4c2673"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "26ae928da969de56d653e5a4079a00c05b52cd0b", "author": {"user": {"login": "VaishSiddharth", "name": "Siddharth Vaish"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/26ae928da969de56d653e5a4079a00c05b52cd0b", "committedDate": "2020-04-30T18:14:27Z", "message": "refactored code"}, "afterCommit": {"oid": "84293a9076dfb4f095fcbfd6eb9a05ab2a2a4e26", "author": {"user": {"login": "VaishSiddharth", "name": "Siddharth Vaish"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/84293a9076dfb4f095fcbfd6eb9a05ab2a2a4e26", "committedDate": "2020-04-30T18:26:01Z", "message": "refactored code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNzc5OTQw", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#pullrequestreview-403779940", "createdAt": "2020-04-30T18:37:57Z", "commit": {"oid": "84293a9076dfb4f095fcbfd6eb9a05ab2a2a4e26"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODozNzo1OFrOGO1pAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODozNzo1OFrOGO1pAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIxMjA5OA==", "bodyText": "@ibacher Test for all these @History functions fail. Can you give an idea, what's wrong here", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r418212098", "createdAt": "2020-04-30T18:37:58Z", "author": {"login": "VaishSiddharth"}, "path": "omod-dstu3/src/main/java/org/openmrs/module/fhir2/providers/r3/EncounterFhirResourceProvider.java", "diffHunk": "@@ -53,6 +53,16 @@ public Encounter getEncounterById(@IdParam @NotNull IdType id) {\n \t\treturn VersionConvertor_30_40.convertEncounter(encounter);\n \t}\n \t\n+\t@History\n+\t@SuppressWarnings(\"unused\")\n+\tpublic List<Resource> getEncounterHistoryById(@IdParam @NotNull IdType id) {\n+\t\torg.hl7.fhir.r4.model.Encounter encounter = encounterService.getEncounterByUuid(id.getIdPart());\n+\t\tif (encounter == null) {\n+\t\t\tthrow new ResourceNotFoundException(\"Could not find encounter with Id \" + id.getIdPart());\n+\t\t}\n+\t\treturn VersionConvertor_30_40.convertEncounter(encounter).getContained();\n+\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84293a9076dfb4f095fcbfd6eb9a05ab2a2a4e26"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d062566380898e6e89ad3408ad85fffb22eadacf", "author": {"user": {"login": "VaishSiddharth", "name": "Siddharth Vaish"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/d062566380898e6e89ad3408ad85fffb22eadacf", "committedDate": "2020-04-30T18:35:54Z", "message": "compliation error fix"}, "afterCommit": {"oid": "67de14579b01b01a52086af97c80fd6daa74319d", "author": {"user": {"login": "VaishSiddharth", "name": "Siddharth Vaish"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/67de14579b01b01a52086af97c80fd6daa74319d", "committedDate": "2020-05-07T16:28:13Z", "message": "servlet function fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NjcxMjY5", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#pullrequestreview-407671269", "createdAt": "2020-05-07T17:09:38Z", "commit": {"oid": "f754bd0f49ebbef8ef681b2c794fceadf34a8b76"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNzowOTozOFrOGSII9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNzowOTozOFrOGSII9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY2MDkxOA==", "bodyText": "@ibacher I have added an interface like this.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r421660918", "createdAt": "2020-05-07T17:09:38Z", "author": {"login": "VaishSiddharth"}, "path": "omod/src/test/java/org/openmrs/module/fhir2/providers/FhirResourceProviderTest.java", "diffHunk": "@@ -0,0 +1,10 @@\n+package org.openmrs.module.fhir2.providers;\n+\n+import org.hl7.fhir.instance.model.api.IBaseBundle;\n+import org.springframework.mock.web.MockHttpServletResponse;\n+\n+import java.io.UnsupportedEncodingException;\n+\n+public interface FhirResourceProviderTest {\n+    IBaseBundle readBundleResponse(MockHttpServletResponse response) throws UnsupportedEncodingException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f754bd0f49ebbef8ef681b2c794fceadf34a8b76"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2502743268221af68195c158d7fa8ee9dc2295f8", "author": {"user": {"login": "VaishSiddharth", "name": "Siddharth Vaish"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/2502743268221af68195c158d7fa8ee9dc2295f8", "committedDate": "2020-05-07T21:20:09Z", "message": "all test pass"}, "afterCommit": {"oid": "e47594a80b0b4ba3cf77c683a2e001140bc53ce7", "author": {"user": {"login": "VaishSiddharth", "name": "Siddharth Vaish"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/e47594a80b0b4ba3cf77c683a2e001140bc53ce7", "committedDate": "2020-05-07T21:27:32Z", "message": "all test pass"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MjI3MTkz", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#pullrequestreview-408227193", "createdAt": "2020-05-08T13:12:15Z", "commit": {"oid": "1c139e48446381c4e91525c556fcf8741788c527"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxMzoxMjoxNVrOGSlCRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxMzoxMjoxNVrOGSlCRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEzNDM0Mw==", "bodyText": "This is correct.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r422134343", "createdAt": "2020-05-08T13:12:15Z", "author": {"login": "ibacher"}, "path": "omod-dstu3/src/main/java/org/openmrs/module/fhir2/providers/r3/ConditionFhirResourceProvider.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.providers.r3;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.List;\n+\n+import ca.uhn.fhir.rest.annotation.*;\n+import ca.uhn.fhir.rest.api.MethodOutcome;\n+import ca.uhn.fhir.rest.api.SortSpec;\n+import ca.uhn.fhir.rest.param.DateRangeParam;\n+import ca.uhn.fhir.rest.param.QuantityAndListParam;\n+import ca.uhn.fhir.rest.param.ReferenceAndListParam;\n+import ca.uhn.fhir.rest.param.TokenAndListParam;\n+import ca.uhn.fhir.rest.server.IResourceProvider;\n+import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;\n+import lombok.AccessLevel;\n+import lombok.Setter;\n+import org.hl7.fhir.convertors.VersionConvertor_30_40;\n+import org.hl7.fhir.dstu3.model.*;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.openmrs.module.fhir2.api.FhirConditionService;\n+import org.openmrs.module.fhir2.util.FhirServerUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+@Qualifier(\"fhirR3Resources\")\n+@Setter(AccessLevel.PACKAGE)\n+public class ConditionFhirResourceProvider implements IResourceProvider {\n+\t\n+\t@Autowired\n+\tprivate FhirConditionService conditionService;\n+\t\n+\t@Override\n+\tpublic Class<? extends IBaseResource> getResourceType() {\n+\t\treturn Condition.class;\n+\t}\n+\t\n+\t@Read\n+\t@SuppressWarnings(\"unused\")\n+\tpublic Condition getConditionById(@IdParam @NotNull IdType id) {\n+\t\torg.hl7.fhir.r4.model.Condition condition = conditionService.getConditionByUuid(id.getIdPart());\n+\t\tif (condition == null) {\n+\t\t\tthrow new ResourceNotFoundException(\"Could not find condition with Id \" + id.getIdPart());\n+\t\t}\n+\t\t\n+\t\treturn VersionConvertor_30_40.convertCondition(condition);\n+\t}\n+\t\n+\t@History\n+\t@SuppressWarnings(\"unused\")\n+\tpublic List<Resource> getConditionHistoryById(@IdParam @NotNull IdType id) {\n+\t\torg.hl7.fhir.r4.model.Condition condition = conditionService.getConditionByUuid(id.getIdPart());\n+\t\tif (condition == null) {\n+\t\t\tthrow new ResourceNotFoundException(\"Could not find condition with Id \" + id.getIdPart());\n+\t\t}\n+\t\treturn VersionConvertor_30_40.convertCondition(condition).getContained();\n+\t}\n+\t\n+\t@Create\n+\t@SuppressWarnings(\"unused\")\n+\tpublic MethodOutcome createCondition(@ResourceParam Condition newCondition) {\n+\t\treturn FhirServerUtils\n+\t\t        .buildCreate(conditionService.saveCondition(VersionConvertor_30_40.convertCondition(newCondition)));\n+\t}\n+\t\n+\t@Search\n+\t@SuppressWarnings(\"unused\")\n+\tpublic Bundle searchConditions(\n+\t        @OptionalParam(name = Condition.SP_PATIENT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER, Patient.SP_NAME,\n+\t                Patient.SP_GIVEN, Patient.SP_FAMILY }) ReferenceAndListParam patientParam,\n+\t        @OptionalParam(name = Condition.SP_SUBJECT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER, Patient.SP_NAME,\n+\t                Patient.SP_GIVEN, Patient.SP_FAMILY }) ReferenceAndListParam subjectParam,\n+\t        @OptionalParam(name = Condition.SP_CODE) TokenAndListParam code,\n+\t        @OptionalParam(name = Condition.SP_CLINICAL_STATUS) TokenAndListParam clinicalStatus,\n+\t        @OptionalParam(name = Condition.SP_ONSET_DATE) DateRangeParam onsetDate,\n+\t        @OptionalParam(name = Condition.SP_ONSET_AGE) QuantityAndListParam onsetAge,\n+\t        //SP_RECORDED_DATE not present so changed to SP_ASSERTED_DATE", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c139e48446381c4e91525c556fcf8741788c527"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MjI3ODIx", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#pullrequestreview-408227821", "createdAt": "2020-05-08T13:13:14Z", "commit": {"oid": "1c139e48446381c4e91525c556fcf8741788c527"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxMzoxMzoxNFrOGSlELQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxMzoxMzoxNFrOGSlELQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEzNDgyOQ==", "bodyText": "This should be SP_RELATED, but note that SP_RELATED has a somewhat different structure.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r422134829", "createdAt": "2020-05-08T13:13:14Z", "author": {"login": "ibacher"}, "path": "omod-dstu3/src/main/java/org/openmrs/module/fhir2/providers/r3/ObservationFhirResourceProvider.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.providers.r3;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.List;\n+\n+import ca.uhn.fhir.rest.annotation.*;\n+import ca.uhn.fhir.rest.api.SortSpec;\n+import ca.uhn.fhir.rest.api.server.IBundleProvider;\n+import ca.uhn.fhir.rest.param.*;\n+import ca.uhn.fhir.rest.server.IResourceProvider;\n+import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;\n+import lombok.AccessLevel;\n+import lombok.Setter;\n+import org.hl7.fhir.convertors.VersionConvertor_30_40;\n+import org.hl7.fhir.dstu3.model.*;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.openmrs.module.fhir2.api.FhirObservationService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+@Qualifier(\"fhirR3Resources\")\n+@Setter(AccessLevel.PACKAGE)\n+public class ObservationFhirResourceProvider implements IResourceProvider {\n+\t\n+\t@Autowired\n+\tprivate FhirObservationService observationService;\n+\t\n+\t@Override\n+\tpublic Class<? extends IBaseResource> getResourceType() {\n+\t\treturn Observation.class;\n+\t}\n+\t\n+\t@Read\n+\t@SuppressWarnings(\"unused\")\n+\tpublic Observation getObservationById(@IdParam @NotNull IdType id) {\n+\t\torg.hl7.fhir.r4.model.Observation observation = observationService.get(id.getIdPart());\n+\t\tif (observation == null) {\n+\t\t\tthrow new ResourceNotFoundException(\"Could not find observation with Id \" + id.getIdPart());\n+\t\t}\n+\t\t\n+\t\treturn VersionConvertor_30_40.convertObservation(observation);\n+\t}\n+\t\n+\t@History\n+\tpublic List<Resource> getObservationHistoryById(@IdParam @NotNull IdType id) {\n+\t\torg.hl7.fhir.r4.model.Observation observation = observationService.get(id.getIdPart());\n+\t\tif (observation == null) {\n+\t\t\tthrow new ResourceNotFoundException(\"Could not find Observation with Id \" + id.getIdPart());\n+\t\t}\n+\t\treturn VersionConvertor_30_40.convertObservation(observation).getContained();\n+\t}\n+\t\n+\t@Search\n+\tpublic IBundleProvider searchObservations(\n+\t        @OptionalParam(name = Observation.SP_ENCOUNTER) ReferenceAndListParam encounterReference,\n+\t        @OptionalParam(name = Observation.SP_SUBJECT, chainWhitelist = { \"\", Patient.SP_IDENTIFIER, Patient.SP_GIVEN,\n+\t                Patient.SP_FAMILY,\n+\t                Patient.SP_NAME }, targetTypes = Patient.class) ReferenceAndListParam patientReference,\n+\t        //TODO: SP_HAS_MEMBER not present so converted to SP_BASED_ON just to prevent errors", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c139e48446381c4e91525c556fcf8741788c527"}, "originalPosition": 71}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd41743ed219dded722c4a787aab69ea03cdaac3", "author": {"user": {"login": "VaishSiddharth", "name": "Siddharth Vaish"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/fd41743ed219dded722c4a787aab69ea03cdaac3", "committedDate": "2020-05-12T20:39:26Z", "message": "url mapping corrected"}, "afterCommit": {"oid": "09403985f04f71319a406df5a1bec9e230822988", "author": {"user": {"login": "VaishSiddharth", "name": "Siddharth Vaish"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/09403985f04f71319a406df5a1bec9e230822988", "committedDate": "2020-05-13T18:37:54Z", "message": "rebase fix and static fun in task converter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d64e0c9fe4481d71b0bd6c0f923cb7a87ad10a86", "author": {"user": {"login": "VaishSiddharth", "name": "Siddharth Vaish"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/d64e0c9fe4481d71b0bd6c0f923cb7a87ad10a86", "committedDate": "2020-05-14T15:49:25Z", "message": "search parameter added to Task"}, "afterCommit": {"oid": "4296003bcbea2d3837618cd1a1e401edd52c74e8", "author": {"user": {"login": "VaishSiddharth", "name": "Siddharth Vaish"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/4296003bcbea2d3837618cd1a1e401edd52c74e8", "committedDate": "2020-05-14T17:59:39Z", "message": "rebase"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMTY4MDAx", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#pullrequestreview-413168001", "createdAt": "2020-05-17T14:26:02Z", "commit": {"oid": "52e50aa183c7fcb22ccb9ddd642eef317b083630"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QxNDoyNjowM1rOGWhUCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QxNDoyNjowM1rOGWhUCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI2NzY1OA==", "bodyText": "@ibacher I get a NPE here when I do something like this\nreturn request.getScheme() + \"://\" + request.getServerName() + port + \"/\" + contextPath + \"/ws/fhir2/\"\n\t\t        + FhirVersionUtils.getFhirResourceVersion(request);\nin OpenmrsFhirAddressStrategy", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r426267658", "createdAt": "2020-05-17T14:26:03Z", "author": {"login": "VaishSiddharth"}, "path": "omod/src/main/java/org/openmrs/module/fhir2/web/servlet/FhirVersionUtils.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.web.servlet;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+public class FhirVersionUtils {\n+\t\n+\tpublic enum FhirVersion {\n+\t\tR4,\n+\t\tR3,\n+\t\tERROR\n+\t}\n+\t\n+\tpublic static Enum<FhirVersion> getFhirResourceVersion(HttpServletRequest request) {\n+\t\tString requestURI = request.getRequestURI();\n+\t\tString contextPath = request.getContextPath();\n+\t\tString prefix = contextPath + \"/ws/fhir2\";\n+\t\tif (requestURI.startsWith(prefix)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52e50aa183c7fcb22ccb9ddd642eef317b083630"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNjI2MzQ0", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#pullrequestreview-413626344", "createdAt": "2020-05-18T14:04:24Z", "commit": {"oid": "52e50aa183c7fcb22ccb9ddd642eef317b083630"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNDowNDoyNVrOGW4ruw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNDowOTozNlrOGW45qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY1MDU1NQ==", "bodyText": "I would make this UNKNOWN. Also I would order the values in the enum this way: UNKNOWN, R3, R4. That way we're adding values to the end and (hopefully) not messing up the ordinal order of the enum.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r426650555", "createdAt": "2020-05-18T14:04:25Z", "author": {"login": "ibacher"}, "path": "omod/src/main/java/org/openmrs/module/fhir2/web/servlet/FhirVersionUtils.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.web.servlet;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+public class FhirVersionUtils {\n+\t\n+\tpublic enum FhirVersion {\n+\t\tR4,\n+\t\tR3,\n+\t\tERROR", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52e50aa183c7fcb22ccb9ddd642eef317b083630"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY1MTU4Nw==", "bodyText": "It would be better to switch on the enum value here, even if we do need to calculate the string value. That way we have a compile-time check of the various cases.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r426651587", "createdAt": "2020-05-18T14:05:54Z", "author": {"login": "ibacher"}, "path": "omod/src/main/java/org/openmrs/module/fhir2/web/filter/ForwardingFilter.java", "diffHunk": "@@ -39,45 +40,26 @@ public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)\n \t\t\t\n \t\t\tString contextPath = ((HttpServletRequest) req).getContextPath();\n \t\t\tString prefix = contextPath + \"/ws/fhir2\";\n-\t\t\tif (requestURI.startsWith(prefix)) {\n-\t\t\t\tint prefixIdx = requestURI.indexOf(prefix);\n-\t\t\t\tif (prefixIdx >= 0) {\n-\t\t\t\t\tint prefixEnd = prefixIdx + prefix.length();\n-\t\t\t\t\tint pathIdx = requestURI.indexOf('/', prefixEnd + 1);\n-\t\t\t\t\t\n-\t\t\t\t\tif (pathIdx >= 0) {\n-\t\t\t\t\t\tString version = requestURI.substring(prefixEnd, pathIdx);\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tif (version.isEmpty()) {\n-\t\t\t\t\t\t\t((HttpServletResponse) res).sendError(HttpServletResponse.SC_NOT_FOUND);\n-\t\t\t\t\t\t\treturn;\n-\t\t\t\t\t\t}\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tif (version.charAt(0) == '/') {\n-\t\t\t\t\t\t\tversion = version.substring(1);\n-\t\t\t\t\t\t}\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tString replacement;\n-\t\t\t\t\t\tswitch (version) {\n-\t\t\t\t\t\t\tcase \"R3\":\n-\t\t\t\t\t\t\t\tprefix += \"/\" + version;\n-\t\t\t\t\t\t\t\treplacement = \"/ms/fhir2R3Servlet\";\n-\t\t\t\t\t\t\t\tbreak;\n-\t\t\t\t\t\t\tcase \"R4\":\n-\t\t\t\t\t\t\t\tprefix += \"/\" + version;\n-\t\t\t\t\t\t\t\treplacement = \"/ms/fhir2Servlet\";\n-\t\t\t\t\t\t\t\tbreak;\n-\t\t\t\t\t\t\tdefault:\n-\t\t\t\t\t\t\t\t((HttpServletResponse) res).sendError(HttpServletResponse.SC_NOT_FOUND);\n-\t\t\t\t\t\t\t\treturn;\n-\t\t\t\t\t\t}\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tString newURI = requestURI.replace(prefix, replacement);\n-\t\t\t\t\t\treq.getRequestDispatcher(newURI).forward(req, res);\n-\t\t\t\t\t\treturn;\n-\t\t\t\t\t}\n-\t\t\t\t}\n+\t\t\tString fhirVersion = String.valueOf(FhirVersionUtils.getFhirResourceVersion(request));\n+\t\t\t\n+\t\t\tString replacement;\n+\t\t\tswitch (fhirVersion) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52e50aa183c7fcb22ccb9ddd642eef317b083630"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY1NDEyMw==", "bodyText": "Can you give me some more context for this? What does the new version of OpenmrsFhirAddressStrategy look like? What does the test case that you are using look like?", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/158#discussion_r426654123", "createdAt": "2020-05-18T14:09:36Z", "author": {"login": "ibacher"}, "path": "omod/src/main/java/org/openmrs/module/fhir2/web/servlet/FhirVersionUtils.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.web.servlet;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+public class FhirVersionUtils {\n+\t\n+\tpublic enum FhirVersion {\n+\t\tR4,\n+\t\tR3,\n+\t\tERROR\n+\t}\n+\t\n+\tpublic static Enum<FhirVersion> getFhirResourceVersion(HttpServletRequest request) {\n+\t\tString requestURI = request.getRequestURI();\n+\t\tString contextPath = request.getContextPath();\n+\t\tString prefix = contextPath + \"/ws/fhir2\";\n+\t\tif (requestURI.startsWith(prefix)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI2NzY1OA=="}, "originalCommit": {"oid": "52e50aa183c7fcb22ccb9ddd642eef317b083630"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c748087a254a88bc8e591c8128bd7474d3d33bc2", "author": {"user": {"login": "VaishSiddharth", "name": "Siddharth Vaish"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/c748087a254a88bc8e591c8128bd7474d3d33bc2", "committedDate": "2020-05-18T17:57:55Z", "message": "global property set for R3 and R4"}, "afterCommit": {"oid": "c5afde39b611fb4959bb859191e3d289ba0c2952", "author": {"user": {"login": "VaishSiddharth", "name": "Siddharth Vaish"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/c5afde39b611fb4959bb859191e3d289ba0c2952", "committedDate": "2020-05-18T18:13:47Z", "message": "rebase"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c5afde39b611fb4959bb859191e3d289ba0c2952", "author": {"user": {"login": "VaishSiddharth", "name": "Siddharth Vaish"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/c5afde39b611fb4959bb859191e3d289ba0c2952", "committedDate": "2020-05-18T18:13:47Z", "message": "rebase"}, "afterCommit": {"oid": "b589db4b84413fcf953e3e21449f2554358ab82a", "author": {"user": {"login": "VaishSiddharth", "name": "Siddharth Vaish"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/b589db4b84413fcf953e3e21449f2554358ab82a", "committedDate": "2020-05-22T17:00:40Z", "message": "rebase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc217f6eb8c43371674d67149f05d2356272d4a0", "author": {"user": {"login": "VaishSiddharth", "name": "Siddharth Vaish"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/fc217f6eb8c43371674d67149f05d2356272d4a0", "committedDate": "2020-05-22T20:12:06Z", "message": "FM2-183: Add support for DSTU3"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b589db4b84413fcf953e3e21449f2554358ab82a", "author": {"user": {"login": "VaishSiddharth", "name": "Siddharth Vaish"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/b589db4b84413fcf953e3e21449f2554358ab82a", "committedDate": "2020-05-22T17:00:40Z", "message": "rebase"}, "afterCommit": {"oid": "fc217f6eb8c43371674d67149f05d2356272d4a0", "author": {"user": {"login": "VaishSiddharth", "name": "Siddharth Vaish"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/fc217f6eb8c43371674d67149f05d2356272d4a0", "committedDate": "2020-05-22T20:12:06Z", "message": "FM2-183: Add support for DSTU3"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4296, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}