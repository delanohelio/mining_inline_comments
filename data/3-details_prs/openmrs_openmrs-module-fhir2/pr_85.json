{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NjE4Nzgw", "number": 85, "title": "FM2-81: Improving Search for Person Resource", "bodyText": "Description of what I changed\n\n\nModel FhirPersonResourceProvider  to provide search  by name, gender, birth date, address.\nAdded tests for the Provider class\n\nTodo:\n\n Implement the search in FhirPersonDaoImpl.\n Add tests for FhirPersonResourceWebTest, FhirPersonDao,  FhirPersonDaoImpl\n\nIssue I worked on\n\n\n\n\nsee https://issues.openmrs.org/browse/FM2-81\nChecklist: I completed these to help reviewers :)\n\n\n\n\n My pull request only contains ONE single commit.\nNo? -> read here on how to squash multiple commits into one\n\n\n My IDE is configured to follow the code style of this project.\nNo? Unsure? -> configure your IDE, format the code and add the changes with git add . && git commit --amend\n\n\n I have added tests to cover my changes. (If you refactored\nexisting code that was well tested you do not have to add tests)\nNo? -> write tests and add them to this commit git add . && git commit --amend\n\n\n I ran mvn clean package right before creating this pull request and\nadded all formatting changes to my commit.\nNo? -> execute above command\n\n\n All new and existing tests passed.\nNo? -> figure out why and add the fix to your commit. It is your responsibility to make sure your code works.\n\n\n My pull request is based on the latest changes of the master branch.\nNo? Unsure? -> execute command git pull --rebase upstream master", "createdAt": "2020-02-22T18:37:54Z", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85", "merged": true, "mergeCommit": {"oid": "d82c1aa02f98a10b1fd31a145a52c2c0c05c2535"}, "closed": true, "closedAt": "2020-02-27T20:37:27Z", "author": {"login": "CaptainDaVinci"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcG6dkSgFqTM2MzA0OTY0OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIhCifgBqjMwNzkzMTU1NzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDQ5NjQ4", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#pullrequestreview-363049648", "createdAt": "2020-02-22T20:36:24Z", "commit": {"oid": "7a6d78bd65b1d2cfab46379b2754b2a79802936a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQyMDozNjoyNFrOFtMyqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQyMDozNjoyNFrOFtMyqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkzOTgxNw==", "bodyText": "@CaptainDaVinci I think we'll have to write something like what's written in FhirObservationDaoImpl @ibacher Please guide\n@Override\n\tpublic Collection<Obs> searchForObservations(ReferenceParam encounterReference, ReferenceParam patientReference,\n\t        TokenAndListParam code, SortSpec sort) {\n\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Obs.class);\n\t\t\n\t\thandleEncounterReference(\"e\", encounterReference).ifPresent(c -> criteria.createAlias(\"encounter\", \"e\").add(c));\n\t\thandlePatientReference(criteria, patientReference);\n\t\thandleCodedConcept(criteria, code);\n\t\thandleSort(criteria, sort);\n\t\t\n\t\treturn criteria.list();\n\t}", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#discussion_r382939817", "createdAt": "2020-02-22T20:36:24Z", "author": {"login": "VaishSiddharth"}, "path": "api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirPersonServiceImpl.java", "diffHunk": "@@ -68,4 +72,13 @@ public Person getPersonByUuid(String uuid) {\n \t\treturn fhirPersonDao.findPersonsByGender(gender).stream().map(personTranslator::toFhirResource)\n \t\t        .collect(Collectors.toList());\n \t}\n+\t\n+\t@Override\n+\tpublic Collection<Person> searchForPeople(StringOrListParam name, TokenOrListParam identifier, TokenOrListParam gender,\n+\t        DateRangeParam birthDate, StringOrListParam city, StringOrListParam state, StringOrListParam postalCode,\n+\t        SortSpec sort) {\n+\t\t// TODO Auto-generated method stub", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a6d78bd65b1d2cfab46379b2754b2a79802936a"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzg3NzYz", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#pullrequestreview-363387763", "createdAt": "2020-02-24T13:29:53Z", "commit": {"oid": "ba294ba8e29673f591e1f059e4329ee48a48a4ca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzoyOTo1NFrOFtgnDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzoyOTo1NFrOFtgnDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI2NDUyNA==", "bodyText": "@CaptainDaVinci I would suggest you to write test for this as I am facing issues while implementing this for Encounters Don't know why but my tests are failing", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#discussion_r383264524", "createdAt": "2020-02-24T13:29:54Z", "author": {"login": "VaishSiddharth"}, "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirPersonDaoImpl.java", "diffHunk": "@@ -74,4 +87,61 @@ public Person getPersonByUuid(String uuid) {\n \t\t        .createAlias(\"attributeType\", \"pat\").add(eq(\"pat.uuid\", personAttributeTypeUuid)).add(eq(\"voided\", false))\n \t\t        .list();\n \t}\n+\t\n+\t@Override\n+\tpublic Collection<Person> searchForPeople(StringOrListParam name, TokenOrListParam identifier, TokenOrListParam gender,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba294ba8e29673f591e1f059e4329ee48a48a4ca"}, "originalPosition": 48}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4d6effba2188bd0eb1ff48278addd5f9f94c5a2", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/e4d6effba2188bd0eb1ff48278addd5f9f94c5a2", "committedDate": "2020-02-24T13:49:22Z", "message": "Refactor BaseDaoImple.java to contains handleNames and handleIdentifier methods"}, "afterCommit": {"oid": "85dbc2fd3d8c7ae7f19bb142cb76fdcaca98fe51", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/85dbc2fd3d8c7ae7f19bb142cb76fdcaca98fe51", "committedDate": "2020-02-24T14:37:52Z", "message": "Refactor BaseDaoImple.java to contains handleNames and handleIdentifier methods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNDUwMDU4", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#pullrequestreview-363450058", "createdAt": "2020-02-24T14:57:34Z", "commit": {"oid": "85dbc2fd3d8c7ae7f19bb142cb76fdcaca98fe51"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNDo1NzozNFrOFtjlxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNDo1ODoyMlrOFtjn9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMxMzM0OA==", "bodyText": "We actually don't want to support \"identifier\" for Person, mainly because we are not currently mapping the identifier field for Person.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#discussion_r383313348", "createdAt": "2020-02-24T14:57:34Z", "author": {"login": "ibacher"}, "path": "api/src/main/java/org/openmrs/module/fhir2/api/FhirPersonService.java", "diffHunk": "@@ -25,4 +29,9 @@\n \tCollection<Person> findPersonsByGender(String gender);\n \t\n \tCollection<Person> findPersonsByBirthDate(Date birthDate);\n+\t\n+\tCollection<Person> searchForPeople(StringOrListParam name, TokenOrListParam identifier, TokenOrListParam gender,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85dbc2fd3d8c7ae7f19bb142cb76fdcaca98fe51"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMxMzkwOQ==", "bodyText": "We should also support address-country.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#discussion_r383313909", "createdAt": "2020-02-24T14:58:22Z", "author": {"login": "ibacher"}, "path": "api/src/main/java/org/openmrs/module/fhir2/api/FhirPersonService.java", "diffHunk": "@@ -25,4 +29,9 @@\n \tCollection<Person> findPersonsByGender(String gender);\n \t\n \tCollection<Person> findPersonsByBirthDate(Date birthDate);\n+\t\n+\tCollection<Person> searchForPeople(StringOrListParam name, TokenOrListParam identifier, TokenOrListParam gender,\n+\t        DateRangeParam birthDate, StringOrListParam city, StringOrListParam state, StringOrListParam postalCode,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85dbc2fd3d8c7ae7f19bb142cb76fdcaca98fe51"}, "originalPosition": 17}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "33989f4a2ac8155a140f0cdaae58d7b120acbcfd", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/33989f4a2ac8155a140f0cdaae58d7b120acbcfd", "committedDate": "2020-02-24T18:01:03Z", "message": "Resolve merge coflicts"}, "afterCommit": {"oid": "9d2420dcac91fbdad6af7a1fff1dd6a1a918b8c6", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/9d2420dcac91fbdad6af7a1fff1dd6a1a918b8c6", "committedDate": "2020-02-24T18:05:31Z", "message": "Added implementation for PersonDao"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "96976c680f13fdb9bda1376ac080b622888500a9", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/96976c680f13fdb9bda1376ac080b622888500a9", "committedDate": "2020-02-25T08:24:40Z", "message": "Add tests to PersonFhirResourceProviderWebTest"}, "afterCommit": {"oid": "6cff3da634553100843df602e34e75d8b52bbf25", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/6cff3da634553100843df602e34e75d8b52bbf25", "committedDate": "2020-02-25T09:26:43Z", "message": "Add tests to PersonFhirResourceProviderWebTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MTQ4MDc4", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#pullrequestreview-364148078", "createdAt": "2020-02-25T13:42:47Z", "commit": {"oid": "6cff3da634553100843df602e34e75d8b52bbf25"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cff3da634553100843df602e34e75d8b52bbf25", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/6cff3da634553100843df602e34e75d8b52bbf25", "committedDate": "2020-02-25T09:26:43Z", "message": "Add tests to PersonFhirResourceProviderWebTest"}, "afterCommit": {"oid": "d2d58faa2d38933bda833973cbece6ffd91fab04", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/d2d58faa2d38933bda833973cbece6ffd91fab04", "committedDate": "2020-02-25T15:47:29Z", "message": "Add tests to PersonFhirResourceProviderWebTest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2d58faa2d38933bda833973cbece6ffd91fab04", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/d2d58faa2d38933bda833973cbece6ffd91fab04", "committedDate": "2020-02-25T15:47:29Z", "message": "Add tests to PersonFhirResourceProviderWebTest"}, "afterCommit": {"oid": "741ad7874a964b743a7b1ccffd3bbbada77fcbd7", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/741ad7874a964b743a7b1ccffd3bbbada77fcbd7", "committedDate": "2020-02-25T16:08:30Z", "message": "Add tests to PersonFhirResourceProviderWebTest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "741ad7874a964b743a7b1ccffd3bbbada77fcbd7", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/741ad7874a964b743a7b1ccffd3bbbada77fcbd7", "committedDate": "2020-02-25T16:08:30Z", "message": "Add tests to PersonFhirResourceProviderWebTest"}, "afterCommit": {"oid": "7ad79f2cc3892ad245c35c66d4d9b5a1f1a9f5ee", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/7ad79f2cc3892ad245c35c66d4d9b5a1f1a9f5ee", "committedDate": "2020-02-25T16:27:32Z", "message": "Add tests to PersonFhirResourceProviderWebTest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad06f4a59cec4b5fd17163639a8679a0be978b0d", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/ad06f4a59cec4b5fd17163639a8679a0be978b0d", "committedDate": "2020-02-25T20:43:27Z", "message": "Add tests for FhirPersonDaoImpl"}, "afterCommit": {"oid": "5931580ece81bc1f05f7d32cf1a57f9a00e4b2f0", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/5931580ece81bc1f05f7d32cf1a57f9a00e4b2f0", "committedDate": "2020-02-25T20:57:44Z", "message": "Add tests for FhirPersonDaoImpl"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e18249e40307bb4c87b74726982c8dec331828a5", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/e18249e40307bb4c87b74726982c8dec331828a5", "committedDate": "2020-02-26T13:01:11Z", "message": "Handle Sort"}, "afterCommit": {"oid": "e342172717cf2f872bd9bb0ef1924e231bc3ce04", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/e342172717cf2f872bd9bb0ef1924e231bc3ce04", "committedDate": "2020-02-26T13:14:08Z", "message": "Handle Sort"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0OTY5MDEw", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#pullrequestreview-364969010", "createdAt": "2020-02-26T14:59:06Z", "commit": {"oid": "e342172717cf2f872bd9bb0ef1924e231bc3ce04"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNDo1OTowNlrOFuu4Qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTowOToxMlrOFuvSRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0Njg4Mw==", "bodyText": "Note to self: create ticket to add country as a search parameter to Patient.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#discussion_r384546883", "createdAt": "2020-02-26T14:59:06Z", "author": {"login": "ibacher"}, "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirPatientDaoImpl.java", "diffHunk": "@@ -88,7 +81,7 @@ public PatientIdentifierType getPatientIdentifierTypeByNameOrUuid(String name, S\n \t\thandleDateRange(\"birthdate\", birthDate).ifPresent(criteria::add);\n \t\thandleDateRange(\"deathdate\", deathDate).ifPresent(criteria::add);\n \t\thandleBoolean(\"dead\", deceased).ifPresent(criteria::add);\n-\t\thandlePersonAddress(\"pad\", city, state, postalCode).ifPresent(c -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e342172717cf2f872bd9bb0ef1924e231bc3ce04"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0NzY5Nw==", "bodyText": "Was this change necessary?", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#discussion_r384547697", "createdAt": "2020-02-26T15:00:18Z", "author": {"login": "ibacher"}, "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirPersonDaoImplTest.java", "diffHunk": "@@ -62,18 +65,24 @@\n \t\n \tprivate static final String NOT_FOUND_NAME = \"not found name\";\n \t\n-\tprivate static final int PERSON_BIRTH_YEAR = 1999;\n-\t\n-\tprivate static final int WRONG_BIRTH_YEAR = 1000;\n-\t\n \tprivate static final SimpleDateFormat DATE_FORMAT = new SimpleDateFormat(\"yyyy-MM-dd\");\n \t\n \tprivate static final String BIRTH_DATE = \"1999-12-20\";\n \t\n-\tprivate static final String NOT_FOUND_BIRTH_DATE = \"1000-00-00\";\n+\tprivate static final String NOT_FOUND_BIRTH_DATE = \"0001-01-01\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e342172717cf2f872bd9bb0ef1924e231bc3ce04"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0ODIxOA==", "bodyText": "I don't think we need a new-line here", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#discussion_r384548218", "createdAt": "2020-02-26T15:01:00Z", "author": {"login": "ibacher"}, "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirPersonDaoImplTest.java", "diffHunk": "@@ -187,4 +240,5 @@ public void getActiveAttributesByPersonAndAttributeTypeUuid_shouldReturnPersonAt\n \t\t\n \t\tassertThat(attributeList, notNullValue());\n \t}\n+\t", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e342172717cf2f872bd9bb0ef1924e231bc3ce04"}, "originalPosition": 204}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0ODcxNg==", "bodyText": "Is it possible to add a test/tests here that searches by multiple parameters at the same time?", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#discussion_r384548716", "createdAt": "2020-02-26T15:01:44Z", "author": {"login": "ibacher"}, "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirPersonDaoImplTest.java", "diffHunk": "@@ -27,9 +27,12 @@\n import java.text.ParseException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e342172717cf2f872bd9bb0ef1924e231bc3ce04"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU1MzU0Mw==", "bodyText": "I know this isn't in the model I provided, but it would be nice if this included a test or tests for \"complex\" queries such as /Person?given=Harold&gender=male,other.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#discussion_r384553543", "createdAt": "2020-02-26T15:09:12Z", "author": {"login": "ibacher"}, "path": "omod/src/test/java/org/openmrs/module/fhir2/providers/PersonFhirResourceProviderWebTest.java", "diffHunk": "@@ -10,15 +10,33 @@\n package org.openmrs.module.fhir2.providers;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e342172717cf2f872bd9bb0ef1924e231bc3ce04"}, "originalPosition": 1}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "844a86005d1e07150ec868ce52c0fa1ee5c0f45a", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/844a86005d1e07150ec868ce52c0fa1ee5c0f45a", "committedDate": "2020-02-26T20:50:00Z", "message": "Add support for sorting"}, "afterCommit": {"oid": "d1a5a4d4e518e590136f3c38539f170bc9dece92", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/d1a5a4d4e518e590136f3c38539f170bc9dece92", "committedDate": "2020-02-26T20:59:07Z", "message": "Add support for sorting"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "20342bed5cbddf9245d5e771cff2769f0b18d9ce", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/20342bed5cbddf9245d5e771cff2769f0b18d9ce", "committedDate": "2020-02-26T21:10:42Z", "message": "Merge master"}, "afterCommit": {"oid": "456ff557a131cc59836bf615e6c50cda26eb8156", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/456ff557a131cc59836bf615e6c50cda26eb8156", "committedDate": "2020-02-26T21:13:29Z", "message": "Merge master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cf2517fdf9fec73831b8b39e37a182974c9a093", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/6cf2517fdf9fec73831b8b39e37a182974c9a093", "committedDate": "2020-02-27T09:57:03Z", "message": "Add complex queries"}, "afterCommit": {"oid": "6af11928c6a21d38e15beab6fadeb461bdf8ada7", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/6af11928c6a21d38e15beab6fadeb461bdf8ada7", "committedDate": "2020-02-27T10:06:32Z", "message": "FM2-81: Improving Search for Person Resource"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1ODc1NzMy", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#pullrequestreview-365875732", "createdAt": "2020-02-27T17:57:10Z", "commit": {"oid": "6af11928c6a21d38e15beab6fadeb461bdf8ada7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNzo1NzoxMFrOFvbV0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNzo1NzoxMFrOFvbV0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NTM0NA==", "bodyText": "Again... this is creating the alias regardless of what is being queried, which is not what we want to do. I might change your paramToProp() to something like this:\nprotected String paramToProp(String param) {\n\t\tString prop = null;\n\n\t\tswitch (param) {\n\t\t\tcase \"name\":\n\t\t\t\tif (!containsAlias(criteria, \"pn\")) {\n\t\t\t\t\tcriteria.createAlias(\"names\", \"pn\");\n\t\t\t\t}\n\n\t\t\t\treturn \"pn.givenName\";\n\t\t\tcase \"birthDate\":\n\t\t\t\treturn \"birthdate\";\n\t\t\tcase \"city\":\n\t\t\t\tprop = \"pad.cityVillage\";\n\t\t\tcase \"state\":\n\t\t\t\tprop = \"pad.stateProvince\";\n\t\t\tcase \"postalCode\":\n\t\t\t\tprop = \"pad.postalCode\";\n\t\t\tcase \"country\":\n\t\t\t\tprop = \"pad.country\";\n                \n                if (!containsAlias(criteria, \"pad\")) {\n\t\t\t\t\tcriteria.createAlias(\"addresses\", \"pad\");\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\treturn prop;\n\t\t\tdefault:\n\t\t\t\treturn null;\n\t\t}\n\t}", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#discussion_r385275344", "createdAt": "2020-02-27T17:57:10Z", "author": {"login": "ibacher"}, "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirPersonDaoImpl.java", "diffHunk": "@@ -45,33 +49,56 @@ public Person getPersonByUuid(String uuid) {\n \t}\n \t\n \t@Override\n-\tpublic Collection<Person> findPersonsByName(String name) {\n-\t\treturn personService.getPeople(name, false);\n-\t}\n-\t\n-\t@Override\n-\t@SuppressWarnings(\"unchecked\")\n-\tpublic Collection<Person> findPersonsByBirthDate(Date birthDate) {\n-\t\treturn sessionFactory.getCurrentSession().createCriteria(Person.class).add(eq(\"birthdate\", birthDate)).list();\n+\tpublic List<PersonAttribute> getActiveAttributesByPersonAndAttributeTypeUuid(Person person,\n+\t        String personAttributeTypeUuid) {\n+\t\treturn (List<PersonAttribute>) sessionFactory.getCurrentSession().createCriteria(PersonAttribute.class)\n+\t\t        .createAlias(\"person\", \"p\", JoinType.INNER_JOIN, eq(\"p.id\", person.getId()))\n+\t\t        .createAlias(\"attributeType\", \"pat\").add(eq(\"pat.uuid\", personAttributeTypeUuid)).add(eq(\"voided\", false))\n+\t\t        .list();\n \t}\n \t\n \t@Override\n-\tpublic Collection<Person> findSimilarPeople(String name, Integer birthYear, String gender) {\n-\t\treturn personService.getSimilarPeople(name, birthYear, gender);\n+\tpublic Collection<Person> searchForPeople(StringOrListParam name, TokenOrListParam gender, DateRangeParam birthDate,\n+\t        StringOrListParam city, StringOrListParam state, StringOrListParam postalCode, StringOrListParam country,\n+\t        SortSpec sort) {\n+\t\tCriteria criteria = sessionFactory.getCurrentSession().createCriteria(Person.class);\n+\t\t\n+\t\thandleNames(criteria, name, null, null);\n+\t\thandleGender(\"gender\", gender).ifPresent(criteria::add);\n+\t\thandleDateRange(\"birthdate\", birthDate).ifPresent(criteria::add);\n+\t\thandlePersonAddress(\"pad\", city, state, postalCode, country).ifPresent(c -> {\n+\t\t\tcriteria.createAlias(\"addresses\", \"pad\");\n+\t\t\tcriteria.add(c);\n+\t\t});\n+\t\tif (!containsAlias(criteria, \"pn\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6af11928c6a21d38e15beab6fadeb461bdf8ada7"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1OTUwNjg1", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#pullrequestreview-365950685", "createdAt": "2020-02-27T19:48:48Z", "commit": {"oid": "6bbf03652278d6a9fb94887dbb1639894d405305"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxOTo0ODo0OFrOFve85w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxOTo1MDowN1rOFve_Uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMzNDUwMw==", "bodyText": "I still don't like this solution. For example, if I were to sort by \"birthdate\", I'd still get joins against PersonName and PersonAddress.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#discussion_r385334503", "createdAt": "2020-02-27T19:48:48Z", "author": {"login": "ibacher"}, "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirPersonDaoImpl.java", "diffHunk": "@@ -70,11 +70,13 @@ public Person getPersonByUuid(String uuid) {\n \t\t\tcriteria.createAlias(\"addresses\", \"pad\");\n \t\t\tcriteria.add(c);\n \t\t});\n-\t\tif (!containsAlias(criteria, \"pn\")) {\n-\t\t\tcriteria.createAlias(\"names\", \"pn\");\n-\t\t}\n-\t\tif (!containsAlias(criteria, \"pad\")) {\n-\t\t\tcriteria.createAlias(\"addresses\", \"pad\");\n+\t\tif (sort != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bbf03652278d6a9fb94887dbb1639894d405305"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMzNTEyMw==", "bodyText": "This should be \"birthdate\" to match the name of the search parameter.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#discussion_r385335123", "createdAt": "2020-02-27T19:50:07Z", "author": {"login": "ibacher"}, "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirPersonDaoImpl.java", "diffHunk": "@@ -88,13 +90,13 @@ protected String paramToProp(String param) {\n \t\t\t\treturn \"pn.givenName\";\n \t\t\tcase \"birthDate\":", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bbf03652278d6a9fb94887dbb1639894d405305"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1OTYxMDg5", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/85#pullrequestreview-365961089", "createdAt": "2020-02-27T20:05:01Z", "commit": {"oid": "c97c5dbc26d7da7480e4e56481b528619250ec25"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b156f29aad45efd0b3d35955c04498f6a2d9f6b", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/2b156f29aad45efd0b3d35955c04498f6a2d9f6b", "committedDate": "2020-02-27T20:06:47Z", "message": "FM2-81: Improving Search for Person Resource"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c97c5dbc26d7da7480e4e56481b528619250ec25", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/c97c5dbc26d7da7480e4e56481b528619250ec25", "committedDate": "2020-02-27T20:01:55Z", "message": "Changed sort parameter birthDate to birthdate"}, "afterCommit": {"oid": "2b156f29aad45efd0b3d35955c04498f6a2d9f6b", "author": {"user": {"login": "CaptainDaVinci", "name": "Yash  Kothari"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/2b156f29aad45efd0b3d35955c04498f6a2d9f6b", "committedDate": "2020-02-27T20:06:47Z", "message": "FM2-81: Improving Search for Person Resource"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4213, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}