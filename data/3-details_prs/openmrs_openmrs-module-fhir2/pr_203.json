{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzMzQ0NTky", "number": 203, "title": "FM2-139: Add initial changes for the related person search.", "bodyText": "Description of what I changed\nAdd search support for related person resources.\nIssue I worked on\nhttps://issues.openmrs.org/browse/FM2-139\nChecklist: I completed these to help reviewers :)\n\n\n[ X] My IDE is configured to follow the code style of this project.\nNo? Unsure? -> configure your IDE, format the code and add the changes with git add . && git commit --amend\n\n\n[ X] I have added tests to cover my changes. (If you refactored\nexisting code that was well tested you do not have to add tests)\nNo? -> write tests and add them to this commit git add . && git commit --amend\n\n\n[X ] I ran mvn clean package right before creating this pull request and\nadded all formatting changes to my commit.\nNo? -> execute above command\n\n\n[ X] All new and existing tests passed.\nNo? -> figure out why and add the fix to your commit. It is your responsibility to make sure your code works.\n\n\n[ X] My pull request is based on the latest changes of the master branch.\nNo? Unsure? -> execute command git pull --rebase upstream master", "createdAt": "2020-06-11T21:36:45Z", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/203", "merged": true, "mergeCommit": {"oid": "aa8de5dc2e3f72d7bfe180322d3b6ed9988b9937"}, "closed": true, "closedAt": "2020-06-18T19:56:33Z", "author": {"login": "Akayeshmantha"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqVgNEgBqjM0MzYwODQ2Mzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcskA_igFqTQzMzYwMjY3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8c460cb142174cc03c0ecb3c19e8ff3c6781af73", "author": {"user": {"login": "Akayeshmantha", "name": "Ayeshmantha Perera"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/8c460cb142174cc03c0ecb3c19e8ff3c6781af73", "committedDate": "2020-06-11T21:33:43Z", "message": "Add initial changes for the related person search."}, "afterCommit": {"oid": "6c1dc0cbb56cc7d6347a5243a73e2b363bb19590", "author": {"user": {"login": "Akayeshmantha", "name": "Ayeshmantha Perera"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/6c1dc0cbb56cc7d6347a5243a73e2b363bb19590", "committedDate": "2020-06-11T21:53:03Z", "message": "FM2-139 Add initial changes for the related person search."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c1dc0cbb56cc7d6347a5243a73e2b363bb19590", "author": {"user": {"login": "Akayeshmantha", "name": "Ayeshmantha Perera"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/6c1dc0cbb56cc7d6347a5243a73e2b363bb19590", "committedDate": "2020-06-11T21:53:03Z", "message": "FM2-139 Add initial changes for the related person search."}, "afterCommit": {"oid": "de39856eb1341b1a7b2a5a8f73c069e3b2e9834e", "author": {"user": {"login": "Akayeshmantha", "name": "Ayeshmantha Perera"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/de39856eb1341b1a7b2a5a8f73c069e3b2e9834e", "committedDate": "2020-06-11T22:39:39Z", "message": "FM2-139 Add initial changes for the related person search."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5OTU0ODkw", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/203#pullrequestreview-429954890", "createdAt": "2020-06-12T18:29:19Z", "commit": {"oid": "de39856eb1341b1a7b2a5a8f73c069e3b2e9834e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODoyOToxOVrOGjN08Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODozODozNFrOGjOE7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU3OTg4OQ==", "bodyText": "Does this need to be in a separate class? The reason BasePersonDao is separated out is because there are a number of resources that all use Person and need to have similar logic, but the logic here seems pretty specific to RelatedPerson. Or is there something I'm missing?", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/203#discussion_r439579889", "createdAt": "2020-06-12T18:29:19Z", "author": {"login": "ibacher"}, "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseRelatedPersonDao.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.api.dao.impl;\n+\n+import static org.hibernate.criterion.Restrictions.and;\n+import static org.hibernate.criterion.Restrictions.eq;\n+import static org.hibernate.criterion.Restrictions.isNull;\n+import static org.hibernate.criterion.Restrictions.or;\n+import static org.hibernate.criterion.Restrictions.sqlRestriction;\n+import static org.hl7.fhir.r4.model.Patient.SP_FAMILY;\n+import static org.hl7.fhir.r4.model.Patient.SP_GIVEN;\n+import static org.hl7.fhir.r4.model.Person.SP_ADDRESS_CITY;\n+import static org.hl7.fhir.r4.model.Person.SP_ADDRESS_COUNTRY;\n+import static org.hl7.fhir.r4.model.Person.SP_ADDRESS_POSTALCODE;\n+import static org.hl7.fhir.r4.model.Person.SP_ADDRESS_STATE;\n+import static org.hl7.fhir.r4.model.Person.SP_BIRTHDATE;\n+import static org.hl7.fhir.r4.model.Person.SP_NAME;\n+\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.stream.Collectors;\n+\n+import org.hibernate.Criteria;\n+import org.hibernate.criterion.DetachedCriteria;\n+import org.hibernate.criterion.Order;\n+import org.hibernate.criterion.Projections;\n+import org.hibernate.criterion.Subqueries;\n+import org.hibernate.sql.JoinType;\n+import org.openmrs.Auditable;\n+import org.openmrs.OpenmrsObject;\n+import org.openmrs.PersonName;\n+\n+public abstract class BaseRelatedPersonDao<T extends OpenmrsObject & Auditable> extends BaseFhirDao<T> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de39856eb1341b1a7b2a5a8f73c069e3b2e9834e"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU4MzIxMA==", "bodyText": "Instead of doing this, I think it would be better to do something like this:\nprotected void handleNames(Criteria criteria, StringAndListParam name, StringAndListParam given, StringAndListParam family) {\n    return handleNames(criteria, name, given, family, null);\n}\n\nprotected void handleNames(Criteria criteria, StringAndListParam name, StringAndListParam given, StringAndListParam family, String personAlias) {\n    if (name == null & given == null && family == null) {\n        return;\n    }\n\n    if (StringUtils.isNotBlank(personAlias) {\n        criteria.createAlias(String.format(\"%.names\", personAlias), \"pn\");\n    } else {\n        criteria.createAlias(\"names\", \"pn\");\n    }\n    \n    ...\n}\nThis doesn't break existing code and, to me, at any rate personAlias tells me what that parameter is and why it's important more than isInnerQuery does.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/203#discussion_r439583210", "createdAt": "2020-06-12T18:36:43Z", "author": {"login": "ibacher"}, "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDao.java", "diffHunk": "@@ -652,12 +652,16 @@ protected void handleIdentifier(Criteria criteria, TokenAndListParam identifier)\n \t}\n \t\n \tprotected void handleNames(Criteria criteria, StringAndListParam name, StringAndListParam given,\n-\t        StringAndListParam family) {\n+\t        StringAndListParam family, Boolean isInnerQuery) {\n \t\tif (name == null && given == null && family == null) {\n \t\t\treturn;\n \t\t}\n \t\t\n-\t\tcriteria.createAlias(\"names\", \"pn\");\n+\t\tif (isInnerQuery) {\n+\t\t\tcriteria.createAlias(\"m.names\", \"pn\");\n+\t\t} else {\n+\t\t\tcriteria.createAlias(\"names\", \"pn\");\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de39856eb1341b1a7b2a5a8f73c069e3b2e9834e"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU4Mzk4MQ==", "bodyText": "I don't think we actually need this unless we're actually reusing the BasePersonDao class.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/203#discussion_r439583981", "createdAt": "2020-06-12T18:38:34Z", "author": {"login": "ibacher"}, "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirRelatedPersonDaoImpl.java", "diffHunk": "@@ -9,14 +9,48 @@\n  */\n package org.openmrs.module.fhir2.api.dao.impl;\n \n+import java.util.Collection;\n+\n+import ca.uhn.fhir.rest.api.SortSpec;\n+import ca.uhn.fhir.rest.param.DateRangeParam;\n+import ca.uhn.fhir.rest.param.StringAndListParam;\n+import ca.uhn.fhir.rest.param.TokenAndListParam;\n import lombok.AccessLevel;\n import lombok.Setter;\n+import org.hibernate.Criteria;\n import org.openmrs.Relationship;\n import org.openmrs.module.fhir2.api.dao.FhirRelatedPersonDao;\n import org.springframework.stereotype.Component;\n \n @Component\n @Setter(AccessLevel.PACKAGE)\n-public class FhirRelatedPersonDaoImpl extends BaseFhirDao<Relationship> implements FhirRelatedPersonDao {\n+public class FhirRelatedPersonDaoImpl extends BaseRelatedPersonDao<Relationship> implements FhirRelatedPersonDao {\n+\t\n+\tprivate boolean isInnerQuery = true;\n+\t\n+\t@Override\n+\tpublic Collection<Relationship> searchRelationships(StringAndListParam name, TokenAndListParam gender,\n+\t        DateRangeParam birthDate, StringAndListParam city, StringAndListParam state, StringAndListParam postalCode,\n+\t        StringAndListParam country, SortSpec sort) {\n+\t\t\n+\t\tCriteria criteria = getSessionFactory().getCurrentSession().createCriteria(Relationship.class, \"r\");\n+\t\t\n+\t\tcriteria.createAlias(\"r.personA\", \"m\"); //inner join with person table\n+\t\thandleNames(criteria, name, null, null, isInnerQuery);\n+\t\thandleGender(\"m.gender\", gender).ifPresent(criteria::add);\n+\t\thandleDateRange(\"m.birthdate\", birthDate).ifPresent(criteria::add);\n+\t\thandlePersonAddress(\"pad\", city, state, postalCode, country).ifPresent(c -> {\n+\t\t\tcriteria.createAlias(\"m.addresses\", \"pad\");\n+\t\t\tcriteria.add(c);\n+\t\t});\n+\t\t\n+\t\thandleSort(criteria, sort);\n+\t\t\n+\t\treturn criteria.list();\n+\t}\n \t\n+\t@Override\n+\tprotected String getSqlAlias() {\n+\t\treturn \"this_\";\n+\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de39856eb1341b1a7b2a5a8f73c069e3b2e9834e"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMDMyMDkx", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/203#pullrequestreview-430032091", "createdAt": "2020-06-12T20:54:24Z", "commit": {"oid": "de39856eb1341b1a7b2a5a8f73c069e3b2e9834e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQyMDo1NDoyNVrOGjRX9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQyMDo1NDoyNVrOGjRX9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYzODAwNg==", "bodyText": "We should remove star-imports", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/203#discussion_r439638006", "createdAt": "2020-06-12T20:54:25Z", "author": {"login": "varung-31"}, "path": "api/src/main/java/org/openmrs/module/fhir2/providers/r3/RelatedPersonFhirResourceProvider.java", "diffHunk": "@@ -11,17 +11,26 @@\n \n import javax.validation.constraints.NotNull;\n \n+import ca.uhn.fhir.rest.annotation.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de39856eb1341b1a7b2a5a8f73c069e3b2e9834e"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de39856eb1341b1a7b2a5a8f73c069e3b2e9834e", "author": {"user": {"login": "Akayeshmantha", "name": "Ayeshmantha Perera"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/de39856eb1341b1a7b2a5a8f73c069e3b2e9834e", "committedDate": "2020-06-11T22:39:39Z", "message": "FM2-139 Add initial changes for the related person search."}, "afterCommit": {"oid": "39f6ff97e756e94ac9f762c802708040bac63460", "author": {"user": {"login": "Akayeshmantha", "name": "Ayeshmantha Perera"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/39f6ff97e756e94ac9f762c802708040bac63460", "committedDate": "2020-06-12T22:45:55Z", "message": "fix changes."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39f6ff97e756e94ac9f762c802708040bac63460", "author": {"user": {"login": "Akayeshmantha", "name": "Ayeshmantha Perera"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/39f6ff97e756e94ac9f762c802708040bac63460", "committedDate": "2020-06-12T22:45:55Z", "message": "fix changes."}, "afterCommit": {"oid": "acc7781e9ce676597e22a545a67f23efc9503229", "author": {"user": {"login": "Akayeshmantha", "name": "Ayeshmantha Perera"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/acc7781e9ce676597e22a545a67f23efc9503229", "committedDate": "2020-06-12T22:54:52Z", "message": "FM2-139 Add initial changes for the related person search."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3229ffafa69a05c7a30868eeeb42a04b4b8a9c31", "author": {"user": {"login": "Akayeshmantha", "name": "Ayeshmantha Perera"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/3229ffafa69a05c7a30868eeeb42a04b4b8a9c31", "committedDate": "2020-06-15T19:21:32Z", "message": "FM2-139 Add support for related person search."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "acc7781e9ce676597e22a545a67f23efc9503229", "author": {"user": {"login": "Akayeshmantha", "name": "Ayeshmantha Perera"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/acc7781e9ce676597e22a545a67f23efc9503229", "committedDate": "2020-06-12T22:54:52Z", "message": "FM2-139 Add initial changes for the related person search."}, "afterCommit": {"oid": "3229ffafa69a05c7a30868eeeb42a04b4b8a9c31", "author": {"user": {"login": "Akayeshmantha", "name": "Ayeshmantha Perera"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/3229ffafa69a05c7a30868eeeb42a04b4b8a9c31", "committedDate": "2020-06-15T19:21:32Z", "message": "FM2-139 Add support for related person search."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNjAyNjcw", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/203#pullrequestreview-433602670", "createdAt": "2020-06-18T19:56:25Z", "commit": {"oid": "3229ffafa69a05c7a30868eeeb42a04b4b8a9c31"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4063, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}