{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3NjU0NzUx", "number": 194, "title": "FM2-193: Generate default narratives provided by HAPI FHIR", "bodyText": "Description of what I changed\nSet Thymeleaf Narrative Generator (with propFile as the properties file of HAPI FHIR) while initialising FhirRestServlet.\nIssue I worked on\nsee https://issues.openmrs.org/browse/FM2-193\nChecklist: I completed these to help reviewers :)\n\n\n\n\n My IDE is configured to follow the code style of this project.\n\n\n I have added tests to cover my changes. (If you refactored\nexisting code that was well tested you do not have to add tests)\n\n\n I ran mvn clean package right before creating this pull request and\nadded all formatting changes to my commit.\n\n\n All new and existing tests passed.\n\n\n My pull request is based on the latest changes of the master branch.", "createdAt": "2020-06-04T07:53:08Z", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/194", "merged": true, "mergeCommit": {"oid": "9306ca2f51f17fa5702c70c4ecbda35167d0ddc3"}, "closed": true, "closedAt": "2020-06-09T16:19:48Z", "author": {"login": "ShivanshRakesh"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcn-j-MAFqTQyNDQ3NzE2Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoCVGzgFqTQyNDcxOTgxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NDc3MTYy", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/194#pullrequestreview-424477162", "createdAt": "2020-06-04T13:58:13Z", "commit": {"oid": "9ead16f584ead2d2b141a561128a17fe4e3627d3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxMzo1ODoxM1rOGfHUOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxNDowMjowM1rOGfHfuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI3ODkwNQ==", "bodyText": "Constants should be UPPER_CASE. Also, we have a FhirConstants class for holding this type of information.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/194#discussion_r435278905", "createdAt": "2020-06-04T13:58:13Z", "author": {"login": "ibacher"}, "path": "omod/src/main/java/org/openmrs/module/fhir2/web/servlet/FhirRestServlet.java", "diffHunk": "@@ -34,6 +35,8 @@\n \t\n \tprivate static final long serialVersionUID = 1L;\n \t\n+\tprotected static final String hapiDefaultNarrativesPropFile = \"classpath:ca/uhn/fhir/narrative/narratives.properties\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ead16f584ead2d2b141a561128a17fe4e3627d3"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI4MTg1MQ==", "bodyText": "Please don't do this this way. The problem here is that you're hard-coding the FhirContext which is actually being set by Spring (see above). The correct thing to do here would be to replace where you have the call to this.setDefaultNarrativeGenerator() with the last line of code:\ngetFhirContext().setNarrativeGenerator(new CustomThymeleafNarrativeGenerator(hapiDefaultNarrativesPropFile));\nThat way, it only depends on the FhirContext that is set by Spring, so that we don't break support for DSTU3 while doing this.\nIt might also be worth thinking about if we could load the ThymeleafNarrativeGenerator from Spring, as this might give us more flexibility in defining the property files to load, instead of needing to know about them ahead of time.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/194#discussion_r435281851", "createdAt": "2020-06-04T14:02:03Z", "author": {"login": "ibacher"}, "path": "omod/src/main/java/org/openmrs/module/fhir2/web/servlet/FhirRestServlet.java", "diffHunk": "@@ -92,4 +97,9 @@ public void setResourceProviders(Collection<IResourceProvider> theProviders) {\n \tpublic void setServerAddressStrategy(IServerAddressStrategy theServerAddressStrategy) {\n \t\tsuper.setServerAddressStrategy(theServerAddressStrategy);\n \t}\n+\t\n+\tprotected void setDefaultNarrativeGenerator() {\n+\t\tthis.setFhirContext(FhirContext.forR4());\n+\t\tgetFhirContext().setNarrativeGenerator(new CustomThymeleafNarrativeGenerator(hapiDefaultNarrativesPropFile));\n+\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ead16f584ead2d2b141a561128a17fe4e3627d3"}, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ead16f584ead2d2b141a561128a17fe4e3627d3", "author": {"user": {"login": "ShivanshRakesh", "name": "Shivansh Rakesh"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/9ead16f584ead2d2b141a561128a17fe4e3627d3", "committedDate": "2020-06-04T07:46:27Z", "message": "FM2-193: Generating HAPI Default Narratives"}, "afterCommit": {"oid": "15e7fd07a99b3d9a49b5149fd98e00db15af0e2a", "author": {"user": {"login": "ShivanshRakesh", "name": "Shivansh Rakesh"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/15e7fd07a99b3d9a49b5149fd98e00db15af0e2a", "committedDate": "2020-06-04T15:08:07Z", "message": "FM2-193: Generating HAPI Default Narratives"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NjUzNTY2", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/194#pullrequestreview-424653566", "createdAt": "2020-06-04T17:03:41Z", "commit": {"oid": "15e7fd07a99b3d9a49b5149fd98e00db15af0e2a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxNzowMzo0MVrOGfPdaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxNzowMzo0MVrOGfPdaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQxMjMyOA==", "bodyText": "So the set of dependencies here should be kept as minimal as possible. These should be moved to the dependencyManagement section and then included in the POM where they are necessary (possibly only in the OMOD). I'd also drop the dependency on commons-io or change it's scope to \"provided\", since it's included in the platform.", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/194#discussion_r435412328", "createdAt": "2020-06-04T17:03:41Z", "author": {"login": "ibacher"}, "path": "pom.xml", "diffHunk": "@@ -319,6 +319,21 @@\n \t\t\t<artifactId>powermock-api-mockito2</artifactId>\n \t\t\t<scope>test</scope>\n \t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.thymeleaf</groupId>\n+\t\t\t<artifactId>thymeleaf</artifactId>\n+\t\t\t<version>3.0.11.RELEASE</version>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>commons-io</groupId>\n+\t\t\t<artifactId>commons-io</artifactId>\n+\t\t\t<version>2.6</version>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>com.github.ben-manes.caffeine</groupId>\n+\t\t\t<artifactId>caffeine</artifactId>\n+\t\t\t<version>2.8.2</version>\n+\t\t</dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15e7fd07a99b3d9a49b5149fd98e00db15af0e2a"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8f9d80fddfc0f549fa846734c1aaa05e45106bb", "author": {"user": {"login": "ShivanshRakesh", "name": "Shivansh Rakesh"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/a8f9d80fddfc0f549fa846734c1aaa05e45106bb", "committedDate": "2020-06-04T17:22:53Z", "message": "FM2-193: Generating HAPI Default Narratives"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15e7fd07a99b3d9a49b5149fd98e00db15af0e2a", "author": {"user": {"login": "ShivanshRakesh", "name": "Shivansh Rakesh"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/15e7fd07a99b3d9a49b5149fd98e00db15af0e2a", "committedDate": "2020-06-04T15:08:07Z", "message": "FM2-193: Generating HAPI Default Narratives"}, "afterCommit": {"oid": "a8f9d80fddfc0f549fa846734c1aaa05e45106bb", "author": {"user": {"login": "ShivanshRakesh", "name": "Shivansh Rakesh"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/a8f9d80fddfc0f549fa846734c1aaa05e45106bb", "committedDate": "2020-06-04T17:22:53Z", "message": "FM2-193: Generating HAPI Default Narratives"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e07d7925c362107383f8f20e62b4d531b803796", "author": {"user": {"login": "ibacher", "name": "Ian"}}, "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/6e07d7925c362107383f8f20e62b4d531b803796", "committedDate": "2020-06-04T18:25:26Z", "message": "Update pom.xml"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NzE5ODE3", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/194#pullrequestreview-424719817", "createdAt": "2020-06-04T18:25:55Z", "commit": {"oid": "6e07d7925c362107383f8f20e62b4d531b803796"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4047, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}