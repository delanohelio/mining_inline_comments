{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyODYxMjMx", "number": 7355, "title": "[1.16.x] Add event for player changing game mode", "bodyText": "The problem at hand:\nThere is currently no way to check if a player's game mode has changed besides having code that caches player states every tick using one of the tick events. This can be slow in the case of having to manage hundreds of players in one tick.\n\nOn server side the event is fired after packets are sent to clients notifying the change.\nOn client side the event is fired when the client receives a packet changing the local client player game mode.\n\nThis PR adds:\n\nA new event for when the player changes from an old game type to the current type\nPatches to PlayerInteractionManager and NetworkPlayerInfo\nA test mod\n\nAn example of how this event could be used:\n    @SubscribeEvent\n    public void onEvent(PlayerEvent.PlayerChangeGameModeEvent event)\n    {\n        // Event is only fired when a player's game mode changes, \n        // which for this specific case is usually once every 10-20 minutes\n        PlayerEntity player = event.getPlayer();\n        if (this.gameRunning && event.getNewGameMode() != GameType.ADVENTURE)\n            this.killPlayer(player, DamageSource.GENERIC);\n    }\nPreviously had to do something similar to:\n    private final Map<UUID, GameType> lastPlayerGameTypes = new HashMap<>();\n\n    @SubscribeEvent\n    public void onEvent(TickEvent.ServerTickEvent event)\n    {\n        // Basic implementation of checking\n        this.gameManager.getServer().getPlayerList().getPlayers().forEach(player ->\n        {\n            UUID uuid = player.getUniqueID();\n            GameType gameType = player.interactionManager.getGameType();\n            if (this.lastPlayerGameTypes.getOrDefault(uuid, GameType.NOT_SET) != gameType)\n            {\n                // Mark player as already being checked\n                this.lastPlayerGameTypes.put(player.getUniqueID(), player.interactionManager.getGameType());\n               \n                // Process player\n                if (this.gameRunning && gameType != GameType.ADVENTURE)\n                    this.killPlayer(player, DamageSource.GENERIC);\n            }\n        });\n    }\n\n    @SubscribeEvent\n    public void onEvent(PlayerEvent.PlayerLoggedOutEvent event)\n    {\n        // Required to make sure the code will be executed consistently\n        this.lastPlayerGameTypes.remove(event.getPlayer().getUniqueID()); \n    }", "createdAt": "2020-09-25T06:21:42Z", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355", "merged": true, "mergeCommit": {"oid": "51fa230e7bc705603e2678589bc39e47addcef58"}, "closed": true, "closedAt": "2020-10-15T17:15:07Z", "author": {"login": "Ocelot5836"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMPOAWAH2gAyNDkyODYxMjMxOjA2NzU2MmM2N2ZmNjBkNTMwNjA5ZTEzNzMxNTBiYjYxMGQ0ZWQyMTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdS1BzygH2gAyNDkyODYxMjMxOjkzM2MyZDk2ODg4MjczNDQ0OTk3ZGU5YjUyNDA4NWVhYWMzNjJjYjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "067562c67ff60d530609e1373150bb610d4ed211", "author": {"user": {"login": "Ocelot5836", "name": "Ocelot"}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/067562c67ff60d530609e1373150bb610d4ed211", "committedDate": "2020-09-25T05:48:12Z", "message": "Added PlayerChangeGameModeEvent to allow better detection of changes in game mode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebb014bb4bdec51c165415b8381a66be7015ec85", "author": {"user": {"login": "Ocelot5836", "name": "Ocelot"}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/ebb014bb4bdec51c165415b8381a66be7015ec85", "committedDate": "2020-09-25T05:48:40Z", "message": "Add test mod"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2MTk2MjQ2", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#pullrequestreview-496196246", "createdAt": "2020-09-25T08:02:52Z", "commit": {"oid": "ebb014bb4bdec51c165415b8381a66be7015ec85"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwODowMjo1MlrOHX5PEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwODowOTo1OFrOHX5dvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgxNzA0Mg==", "bodyText": "This \"via\" info makes no sense, the event docs are in need of changes and new events should not follow the existing guides.\nYou should describe when the event fires, not which method is responsible for it.", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#discussion_r494817042", "createdAt": "2020-09-25T08:02:52Z", "author": {"login": "diesieben07"}, "path": "src/main/java/net/minecraftforge/event/entity/player/PlayerEvent.java", "diffHunk": "@@ -510,4 +511,30 @@ public PlayerChangedDimensionEvent(PlayerEntity player, RegistryKey<World> fromD\n             return this.toDim;\n         }\n     }\n+\n+    /**\n+     * On the server side fired when any player has their game mode changed via {@link net.minecraft.server.management.PlayerInteractionManager#setGameType(GameType)}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebb014bb4bdec51c165415b8381a66be7015ec85"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgxNzEzMQ==", "bodyText": "Formatting (braces on newlines)", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#discussion_r494817131", "createdAt": "2020-09-25T08:03:03Z", "author": {"login": "diesieben07"}, "path": "src/main/java/net/minecraftforge/event/entity/player/PlayerEvent.java", "diffHunk": "@@ -510,4 +511,30 @@ public PlayerChangedDimensionEvent(PlayerEntity player, RegistryKey<World> fromD\n             return this.toDim;\n         }\n     }\n+\n+    /**\n+     * On the server side fired when any player has their game mode changed via {@link net.minecraft.server.management.PlayerInteractionManager#setGameType(GameType)}.\n+     * On the client side fired when only when the client player changes their game mode.\n+     */\n+    public static class PlayerChangeGameModeEvent extends PlayerEvent {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebb014bb4bdec51c165415b8381a66be7015ec85"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgyMDc5OQ==", "bodyText": "Formatting (don't change indentation)\nExtract this logic into the ForgeHooks method, that's what its there for. You can have this be a much simpler patch by doing:\nthis.gameType = ForgeHooks.onClientChangeGameType(gameMode, this.gameType, ...)", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#discussion_r494820799", "createdAt": "2020-09-25T08:09:58Z", "author": {"login": "diesieben07"}, "path": "patches/minecraft/net/minecraft/client/network/play/NetworkPlayerInfo.java.patch", "diffHunk": "@@ -0,0 +1,13 @@\n+--- a/net/minecraft/client/network/play/NetworkPlayerInfo.java\n++++ b/net/minecraft/client/network/play/NetworkPlayerInfo.java\n+@@ -50,7 +50,9 @@\n+    }\n+ \n+    protected void func_178839_a(GameType p_178839_1_) {\n+-      this.field_178866_b = p_178839_1_;\n++       GameType oldGameType = this.field_178866_b;\n++       this.field_178866_b = p_178839_1_;\n++       if(Minecraft.func_71410_x().field_71439_g != null && this.field_178867_a.getId().equals(Minecraft.func_71410_x().field_71439_g.func_110124_au())) net.minecraftforge.common.ForgeHooks.onChangeGameMode(Minecraft.func_71410_x().field_71439_g, p_178839_1_, oldGameType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebb014bb4bdec51c165415b8381a66be7015ec85"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf0baabacc30394c0da61d2f157198e675d5b408", "author": {"user": {"login": "Ocelot5836", "name": "Ocelot"}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/cf0baabacc30394c0da61d2f157198e675d5b408", "committedDate": "2020-09-25T20:34:55Z", "message": "Added client game mode event and made server event cancellable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f68aa0807902497bfa3199aac56488c33ad55a5f", "author": {"user": {"login": "Ocelot5836", "name": "Ocelot"}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/f68aa0807902497bfa3199aac56488c33ad55a5f", "committedDate": "2020-09-25T20:35:04Z", "message": "Update test mod"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDcwMjAx", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#pullrequestreview-497070201", "createdAt": "2020-09-27T10:13:46Z", "commit": {"oid": "f68aa0807902497bfa3199aac56488c33ad55a5f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxMDoxMzo0NlrOHYmVuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxMDoxNTowNlrOHYmWQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU1NjAyNQ==", "bodyText": "Indentation still wrong. Also missing space after if.\nAlso, my point of separating client and server event was so that you can fire the event on the client always, by not including the PlayerEntity.", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#discussion_r495556025", "createdAt": "2020-09-27T10:13:46Z", "author": {"login": "diesieben07"}, "path": "patches/minecraft/net/minecraft/client/network/play/NetworkPlayerInfo.java.patch", "diffHunk": "@@ -0,0 +1,12 @@\n+--- a/net/minecraft/client/network/play/NetworkPlayerInfo.java\n++++ b/net/minecraft/client/network/play/NetworkPlayerInfo.java\n+@@ -50,7 +50,8 @@\n+    }\n+ \n+    protected void func_178839_a(GameType p_178839_1_) {\n+-      this.field_178866_b = p_178839_1_;\n++       if(Minecraft.func_71410_x().field_71439_g != null && this.field_178867_a.getId().equals(Minecraft.func_71410_x().field_71439_g.func_110124_au()) && this.field_178866_b != p_178839_1_) net.minecraftforge.common.ForgeHooks.onClientChangeGameMode(Minecraft.func_71410_x().field_71439_g, this.field_178866_b, p_178839_1_);\n++       this.field_178866_b = p_178839_1_;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f68aa0807902497bfa3199aac56488c33ad55a5f"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU1NjAzOQ==", "bodyText": "Formatting, space after if.", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#discussion_r495556039", "createdAt": "2020-09-27T10:14:02Z", "author": {"login": "diesieben07"}, "path": "patches/minecraft/net/minecraft/entity/player/ServerPlayerEntity.java.patch", "diffHunk": "@@ -130,15 +130,23 @@\n     }\n  \n     protected void func_70670_a(EffectInstance p_70670_1_) {\n-@@ -1187,6 +1208,7 @@\n+@@ -1139,6 +1160,7 @@\n+    }\n+ \n+    public void func_71033_a(GameType p_71033_1_) {\n++      if(!net.minecraftforge.common.ForgeHooks.onChangeGameMode(this, this.field_71134_c.func_73081_b(), p_71033_1_)) return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f68aa0807902497bfa3199aac56488c33ad55a5f"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU1NjE2Mg==", "bodyText": "I have no idea what you mean to say with this sentence. \"changed to a unique value\"? And what listeners are you talking about?\nYou also need to add a note about what happens when the event is cancelled.", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#discussion_r495556162", "createdAt": "2020-09-27T10:15:06Z", "author": {"login": "diesieben07"}, "path": "src/main/java/net/minecraftforge/event/entity/player/PlayerEvent.java", "diffHunk": "@@ -510,4 +511,65 @@ public PlayerChangedDimensionEvent(PlayerEntity player, RegistryKey<World> fromD\n             return this.toDim;\n         }\n     }\n+\n+    /**\n+     * Fired when the game type of a server player is changed to a unique value before listeners are fired.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f68aa0807902497bfa3199aac56488c33ad55a5f"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19a1e19fc6398f86a2665b965ecde97832d6f684", "author": {"user": {"login": "Ocelot5836", "name": "Ocelot"}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/19a1e19fc6398f86a2665b965ecde97832d6f684", "committedDate": "2020-09-27T18:47:33Z", "message": "Fixed patch formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0be573d6b18323acf2d2675bed9e738839a1f54b", "author": {"user": {"login": "Ocelot5836", "name": "Ocelot"}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/0be573d6b18323acf2d2675bed9e738839a1f54b", "committedDate": "2020-09-27T18:47:40Z", "message": "Updated documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96949d8a3918acdcc20c3371c7b62d446fab72cf", "author": {"user": {"login": "Ocelot5836", "name": "Ocelot"}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/96949d8a3918acdcc20c3371c7b62d446fab72cf", "committedDate": "2020-09-27T19:12:25Z", "message": "Client change game mode event now fires for all players"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf1c50c10031a0fc5666b61f96b6a2306e1d13be", "author": {"user": {"login": "Ocelot5836", "name": "Ocelot"}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/cf1c50c10031a0fc5666b61f96b6a2306e1d13be", "committedDate": "2020-09-27T19:13:51Z", "message": "Updated patches"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5MjA0NzY0", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#pullrequestreview-499204764", "createdAt": "2020-09-30T08:36:45Z", "commit": {"oid": "cf1c50c10031a0fc5666b61f96b6a2306e1d13be"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwODozNjo0NVrOHaTHgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwODozNjo0NVrOHaTHgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzMzODI0Mw==", "bodyText": "You have not fixed this.", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#discussion_r497338243", "createdAt": "2020-09-30T08:36:45Z", "author": {"login": "diesieben07"}, "path": "patches/minecraft/net/minecraft/entity/player/ServerPlayerEntity.java.patch", "diffHunk": "@@ -130,15 +130,23 @@\n     }\n  \n     protected void func_70670_a(EffectInstance p_70670_1_) {\n-@@ -1187,6 +1208,7 @@\n+@@ -1139,6 +1160,7 @@\n+    }\n+ \n+    public void func_71033_a(GameType p_71033_1_) {\n++      if(!net.minecraftforge.common.ForgeHooks.onChangeGameMode(this, this.field_71134_c.func_73081_b(), p_71033_1_)) return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf1c50c10031a0fc5666b61f96b6a2306e1d13be"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bce13f1e6bc2b6540e8896a330d67bc046fb4c18", "author": {"user": {"login": "Ocelot5836", "name": "Ocelot"}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/bce13f1e6bc2b6540e8896a330d67bc046fb4c18", "committedDate": "2020-10-01T04:22:01Z", "message": "Learned how to press the space bar"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMDcyMDc3", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#pullrequestreview-500072077", "createdAt": "2020-10-01T07:25:15Z", "commit": {"oid": "bce13f1e6bc2b6540e8896a330d67bc046fb4c18"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15d3aae444f4b5d8f9fea216445b1f3006fa4f5b", "author": {"user": {"login": "Ocelot5836", "name": "Ocelot"}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/15d3aae444f4b5d8f9fea216445b1f3006fa4f5b", "committedDate": "2020-10-15T05:11:34Z", "message": "Disabled test mod"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "933c2d96888273444997de9b524085eaac362cb7", "author": {"user": {"login": "LexManos", "name": "LexManos"}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/933c2d96888273444997de9b524085eaac362cb7", "committedDate": "2020-10-15T17:14:49Z", "message": "Merge branch '1.16.x' into change_gamemode_event"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2294, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}