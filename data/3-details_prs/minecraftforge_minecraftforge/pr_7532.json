{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxNzUyMzUz", "number": 7532, "title": "Fix Deadlock when adding Entities during Chunk Load (#7519)", "bodyText": "NOTE: This PR was changed to only target the issues in forge's IForgeItem, this does not fix mods.\nOriginal below:\nDelays the firing of EntityJoinWorldEvent during chunk load until after the chunk is available.\nThis prevent deadlocks if a listener of the event tries to add an entity to the chunk being loaded.\n\nChunkEvent.Load I've moved this so it still fires after Entity Removal (I'm not sure if this change is right).\n\nTested via #7519 (comment).\nSeeing as we just saw someone have an issue with this in production (On Forge Discord), thought it was worth moving this to a PR.\nA second look by someone who's had more experience with the ChunkManager's code (and the mess of completablefutures) is probably worthwhile.\nThere's still probably a better fix available but this seems to work.", "createdAt": "2020-12-03T12:45:01Z", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7532", "merged": true, "mergeCommit": {"oid": "72d05d17a92b7060d6262d9553f4b7d5d6bc0a8f"}, "closed": true, "closedAt": "2021-03-12T18:50:05Z", "author": {"login": "AterAnimAvis"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiknpigFqTU0NDA1MjIzNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABeCc9ktAH2gAyNTMxNzUyMzUzOjY2NmE0MTY0MTVkMjMxMGZkNzgwNTYzMTUxYTI5NTkwNDM0MTkwM2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MDUyMjM0", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7532#pullrequestreview-544052234", "createdAt": "2020-12-03T15:10:30Z", "commit": {"oid": "9487ac35043c4b9e9b6693e77fa67cd0b4cd677d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNToxMDozMFrOH-hFwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNToxMDozMFrOH-hFwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMxNTkwNA==", "bodyText": "If you don't change the indentation of this inner stuff the patch will be a lot cleaner/smaller.", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7532#discussion_r535315904", "createdAt": "2020-12-03T15:10:30Z", "author": {"login": "pupnewfster"}, "path": "patches/minecraft/net/minecraft/world/server/ChunkManager.java.patch", "diffHunk": "@@ -8,23 +8,58 @@\n                 }\n  \n                 this.func_219229_a(p_219185_5_);\n-@@ -601,6 +602,7 @@\n-                if (list != null) {\n-                   list.forEach(chunk::func_76622_b);\n-                }\n-+               net.minecraftforge.common.MinecraftForge.EVENT_BUS.post(new net.minecraftforge.event.world.ChunkEvent.Load(chunk));\n+@@ -582,25 +583,28 @@\n+             if (this.field_219254_h.add(chunkpos.func_201841_a())) {\n+                chunk.func_177417_c(true);\n+                this.field_219255_i.func_147448_a(chunk.func_177434_r().values());\n+-               List<Entity> list = null;\n+-               ClassInheritanceMultiMap<Entity>[] aclassinheritancemultimap = chunk.func_177429_s();\n+-               int i = aclassinheritancemultimap.length;\n++               p_219200_1_.func_219276_a(ChunkStatus.field_222617_m, this).thenRun(() -> { //Forge: Delay EntityJoinWorld events until chunk is available to prevent deadlocks\n++                  List<Entity> list = null;\n++                  ClassInheritanceMultiMap<Entity>[] aclassinheritancemultimap = chunk.func_177429_s();\n++                  int i = aclassinheritancemultimap.length;\n+ \n+-               for(int j = 0; j < i; ++j) {\n+-                  for(Entity entity : aclassinheritancemultimap[j]) {\n+-                     if (!(entity instanceof PlayerEntity) && !this.field_219255_i.func_217440_f(entity)) {\n+-                        if (list == null) {\n+-                           list = Lists.newArrayList(entity);\n+-                        } else {\n+-                           list.add(entity);\n++                  for(int j = 0; j < i; ++j) {\n++                     for(Entity entity : aclassinheritancemultimap[j]) {\n++                        if (!(entity instanceof PlayerEntity) && !this.field_219255_i.func_217440_f(entity)) {\n++                           if (list == null) {\n++                              list = Lists.newArrayList(entity);\n++                           } else {\n++                              list.add(entity);\n++                           }\n+                         }\n+                      }\n+                   }\n+-               }\n+ \n+-               if (list != null) {\n+-                  list.forEach(chunk::func_76622_b);\n+-               }\n++                  if (list != null) {\n++                     list.forEach(chunk::func_76622_b);\n++                  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9487ac35043c4b9e9b6693e77fa67cd0b4cd677d"}, "originalPosition": 46}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9487ac35043c4b9e9b6693e77fa67cd0b4cd677d", "author": {"user": {"login": "AterAnimAvis", "name": null}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/9487ac35043c4b9e9b6693e77fa67cd0b4cd677d", "committedDate": "2020-12-03T12:35:13Z", "message": "Fix Deadlock when adding Entities during Chunk Load (#7519)\n---\n\nDelays the firing of EntityJoinWorldEvent during chunk load until after the chunk is available.\nThis prevent deadlocks if a listener of the event tries to add an entity to the chunk being loaded."}, "afterCommit": {"oid": "e3fba1c2723bc0fc83541cb0f84ba191e0b87de3", "author": {"user": {"login": "AterAnimAvis", "name": null}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/e3fba1c2723bc0fc83541cb0f84ba191e0b87de3", "committedDate": "2020-12-03T15:36:02Z", "message": "Fix Deadlock when adding Entities during Chunk Load (#7519)\n---\n\nDelays the firing of EntityJoinWorldEvent during chunk load until after the chunk is available.\nThis prevent deadlocks if a listener of the event tries to add an entity to the chunk being loaded."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9f44c991fdaaeda6849cee354592fe71036e37f", "author": {"user": {"login": "AterAnimAvis", "name": null}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/a9f44c991fdaaeda6849cee354592fe71036e37f", "committedDate": "2021-03-10T15:52:42Z", "message": "Fix Deadlock when adding Entities during Chunk Load (#7519)\n---\n\nDelays the firing of EntityJoinWorldEvent during chunk load until after the chunk is available.\nThis prevent deadlocks if a listener of the event tries to add an entity to the chunk being loaded."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90ac3233a4d3bc71429e0a7fc9969aa552136361", "author": {"user": {"login": "AterAnimAvis", "name": null}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/90ac3233a4d3bc71429e0a7fc9969aa552136361", "committedDate": "2021-03-10T15:54:27Z", "message": "fix: also move tile-entities loading to the delayed execution\n---\n\nSigned-off-by: AterAnimAvis <AterAnimAvis@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2984f665ed17a916f61eec2558480027f302affb", "author": {"user": {"login": "AterAnimAvis", "name": null}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/2984f665ed17a916f61eec2558480027f302affb", "committedDate": "2021-02-16T15:11:40Z", "message": "fix: also move tile-entities loading to the delayed execution\n---\n\nSigned-off-by: AterAnimAvis <AterAnimAvis@gmail.com>"}, "afterCommit": {"oid": "90ac3233a4d3bc71429e0a7fc9969aa552136361", "author": {"user": {"login": "AterAnimAvis", "name": null}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/90ac3233a4d3bc71429e0a7fc9969aa552136361", "committedDate": "2021-03-10T15:54:27Z", "message": "fix: also move tile-entities loading to the delayed execution\n---\n\nSigned-off-by: AterAnimAvis <AterAnimAvis@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "666a416415d2310fd780563151a295904341903c", "author": {"user": {"login": "AterAnimAvis", "name": null}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/666a416415d2310fd780563151a295904341903c", "committedDate": "2021-03-12T16:20:50Z", "message": "Migrate to only fix the issue in ForgeInternalHandler#onEntityJoinWorld + add warning to relevant events.\n---\n\nSigned-off-by: AterAnimAvis <AterAnimAvis@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2240, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}