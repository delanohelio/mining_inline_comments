{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4NDIyNTEx", "number": 7256, "title": "Improve startup time by caching the manifest data for mod jars", "bodyText": "Fixes cpw/modlauncher#55\n\nI originally thought this was a ModLauncher issue because I didn't look at the stack in detail after it entered ModLauncher. Looking at it again the time I thought was in ModLauncher is actually in the method I'm changing in this PR.\nI'm using AtomicReference since a) it needs to be thread safe (the method is called in classloading), b) AFAIK accessing an atomic is faster than acquiring and releasing a lock and c) parsing the manifest on multiple threads will not cause any issues and can only happen once per mod.\nI'll happily accept suggestions for getting rid of the Optional<Optional<\u2026>>. IntelliJ puts out a warning when comparing an Optional to null and I agree that nullable Optionals are bad design, but I'm not sure this is better. This is in fmllauncher, so using Lazy<T> is not an option.\n\nThe table below shows launch time in seconds with patch applied to Forge 106. The setup is slightly different from the one I used in the ModLauncher issue, but is mostly similar. I'm using three launches for each configuration to get more reliable values. The Forge builds for both tests are unsigned (didn't set up signing for Forge). With the official 106 Forge build start time without mods is ~50 s, which would probably also be reduced by my changes.\n\n\n\nWith PR\nMods\nFirst launch\nSecond launch\nThird launch\n\n\n\n\nNo\nImmersive Engineering, signed\n77\n73\n73\n\n\nYes\nImmersive Engineering, signed\n52\n48\n49\n\n\nNo\nImmersive Engineering, unsigned\n51\n55\n56\n\n\nYes\nImmersive Engineering, unsigned\n51\n56\n52\n\n\nNo\nNone\n38\n39\n43\n\n\nYes\nNone\n38\n39\n38", "createdAt": "2020-08-16T09:42:43Z", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7256", "merged": true, "mergeCommit": {"oid": "5037adede907b1c03b0f4e8227d882f491f8481d"}, "closed": true, "closedAt": "2020-08-21T04:29:03Z", "author": {"login": "malte0811"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_Zn3ggH2gAyNDY4NDIyNTExOmM4OGVlZWQ1MjQ3NTJiYTZkYzk3OGEzZGIzYjk2OTIwOTE4ZWMyZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAuWI5gFqTQ3MTQ5NTM3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c88eeed524752ba6dc978a3db3b96920918ec2de", "author": {"user": {"login": "malte0811", "name": null}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/c88eeed524752ba6dc978a3db3b96920918ec2de", "committedDate": "2020-08-16T08:34:29Z", "message": "Improve startup time by caching the manifest data for mod jars\nFixes cpw/modlauncher#55"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MDUzMDU2", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7256#pullrequestreview-468053056", "createdAt": "2020-08-16T10:40:35Z", "commit": {"oid": "c88eeed524752ba6dc978a3db3b96920918ec2de"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c71b96cad3946f60da9a6c6222d7c58aba2d5be8", "author": {"user": {"login": "malte0811", "name": null}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/c71b96cad3946f60da9a6c6222d7c58aba2d5be8", "committedDate": "2020-08-16T11:27:49Z", "message": "Use volatile instead of AtomicReference and get rid of Optional<Optional<>>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MDU2NjY0", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7256#pullrequestreview-468056664", "createdAt": "2020-08-16T11:34:23Z", "commit": {"oid": "c71b96cad3946f60da9a6c6222d7c58aba2d5be8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNlQxMTozNDoyNFrOHBRxAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNlQxMTozNDoyNFrOHBRxAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTEwMTY5Ng==", "bodyText": "Braces on new lines (might want to fix the one on the method signature as well while you're at it).", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7256#discussion_r471101696", "createdAt": "2020-08-16T11:34:24Z", "author": {"login": "diesieben07"}, "path": "src/fmllauncher/java/net/minecraftforge/fml/loading/moddiscovery/ModFileInfo.java", "diffHunk": "@@ -115,12 +118,12 @@ public VersionRange getModLoaderVersion()\n     }\n \n     public Optional<Manifest> getManifest() {\n-        Optional<Optional<Manifest>> manifest = this.manifest.get();\n-        if (!manifest.isPresent()) {\n-            manifest = Optional.of(modFile.getLocator().findManifest(modFile.getFilePath()));\n-            this.manifest.set(manifest);\n+        Optional<Manifest> result = manifest;\n+        if (result == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c71b96cad3946f60da9a6c6222d7c58aba2d5be8"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "651fe7637567a10394897c63f103ecc0eaea563a", "author": {"user": {"login": "malte0811", "name": null}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/651fe7637567a10394897c63f103ecc0eaea563a", "committedDate": "2020-08-16T11:53:04Z", "message": "Fix formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5MjE3NjUz", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7256#pullrequestreview-469217653", "createdAt": "2020-08-18T11:04:32Z", "commit": {"oid": "651fe7637567a10394897c63f103ecc0eaea563a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxMTowNDozMlrOHCOatg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxMTowNDozMlrOHCOatg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA5NTQxNA==", "bodyText": "If it doesn't matter that two threads hold different instances of the manifest (with the same content), this does not need to be volatile", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7256#discussion_r472095414", "createdAt": "2020-08-18T11:04:32Z", "author": {"login": "ichttt"}, "path": "src/fmllauncher/java/net/minecraftforge/fml/loading/moddiscovery/ModFileInfo.java", "diffHunk": "@@ -54,6 +55,10 @@\n     private final List<IModInfo> mods;\n     private final Map<String,Object> properties;\n     private final String license;\n+    // Caches the manifest of the mod jar as parsing the manifest can be expensive for\n+    // signed jars. The manifest needs to be an Optional<Manifest>, so a nullable Optional\n+    // is probably the best option.\n+    private volatile Optional<Manifest> manifest = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651fe7637567a10394897c63f103ecc0eaea563a"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33d1c9084d0b546f9e8ddf00feb85b2da5932cc0", "author": {"user": {"login": "malte0811", "name": null}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/33d1c9084d0b546f9e8ddf00feb85b2da5932cc0", "committedDate": "2020-08-19T14:47:46Z", "message": "Parse the manifest on mod construction to avoid threading issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMzA1ODY1", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7256#pullrequestreview-471305865", "createdAt": "2020-08-20T07:15:44Z", "commit": {"oid": "33d1c9084d0b546f9e8ddf00feb85b2da5932cc0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwNzoxNTo0NFrOHDvRrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwNzoxNTo0NFrOHDvRrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY4MjM1MA==", "bodyText": "Pointless import, other than this looks good now.", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7256#discussion_r473682350", "createdAt": "2020-08-20T07:15:44Z", "author": {"login": "diesieben07"}, "path": "src/fmllauncher/java/net/minecraftforge/fml/loading/moddiscovery/ModFileInfo.java", "diffHunk": "@@ -37,6 +37,7 @@\n import java.util.Map;\n import java.util.Objects;\n import java.util.Optional;\n+import java.util.concurrent.atomic.AtomicReference;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33d1c9084d0b546f9e8ddf00feb85b2da5932cc0"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7146204a14d8aeccf01423e83661f59dc8e012af", "author": {"user": {"login": "malte0811", "name": null}}, "url": "https://github.com/MinecraftForge/MinecraftForge/commit/7146204a14d8aeccf01423e83661f59dc8e012af", "committedDate": "2020-08-20T07:33:47Z", "message": "Remove useless import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNDk1Mzcy", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7256#pullrequestreview-471495372", "createdAt": "2020-08-20T11:17:03Z", "commit": {"oid": "7146204a14d8aeccf01423e83661f59dc8e012af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2439, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}