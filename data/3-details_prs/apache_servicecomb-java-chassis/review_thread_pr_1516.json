{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwOTI0Njc1", "number": 1516, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwMDo0ODo1MFrODXBn1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwMDo1MDoxOVrODXBoig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1NDcwNDIyOnYy", "diffSide": "RIGHT", "path": "foundations/foundation-common/src/test/java/org/apache/servicecomb/foundation/common/concurrency/RunnableWrapperTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwMDo0ODo1MFrOFcHnng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNzoyNjo0N1rOFcMBbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTAyOTI3OA==", "bodyText": "it's better to call scheduledThreadPoolExecutor.shutDownNow to terminate the thread pool", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1516#discussion_r365029278", "createdAt": "2020-01-10T00:48:50Z", "author": {"login": "liubao68"}, "path": "foundations/foundation-common/src/test/java/org/apache/servicecomb/foundation/common/concurrency/RunnableWrapperTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.servicecomb.foundation.common.concurrency;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ScheduledThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.junit.Test;\n+\n+public class RunnableWrapperTest {\n+  /**\n+   * {@link SuppressedRunnableWrapper} should ensure that any {@link Throwable} thrown from {@link Runnable}\n+   * should not interrupt the scheduled tasks.\n+   */\n+  @Test\n+  public void run() throws InterruptedException {\n+    ScheduledThreadPoolExecutor scheduledThreadPoolExecutor = new ScheduledThreadPoolExecutor(1);\n+    CountDownLatch countDownLatch = new CountDownLatch(3);\n+    scheduledThreadPoolExecutor.scheduleAtFixedRate(\n+        new SuppressedRunnableWrapper(\n+            () -> {\n+              countDownLatch.countDown();\n+              switch ((int) countDownLatch.getCount()) {\n+                case 2:\n+                  throw new Error(\"Normal case, this is a mocked error\");\n+                case 1:\n+                  throw new IllegalStateException(\"Normal case, this is a mocked exception\");\n+                default:\n+              }\n+            }\n+        ),\n+        1,\n+        1,\n+        TimeUnit.MILLISECONDS);\n+\n+    countDownLatch.await(1000, TimeUnit.MILLISECONDS);\n+    assertEquals(0, countDownLatch.getCount());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bf17b11a169f41968d36e1f5ad70d525a15c4bc"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEwMTQyMg==", "bodyText": "Done. the try catch block is added and the thread pool is shutdown in the finally block.", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1516#discussion_r365101422", "createdAt": "2020-01-10T07:26:47Z", "author": {"login": "yhs0092"}, "path": "foundations/foundation-common/src/test/java/org/apache/servicecomb/foundation/common/concurrency/RunnableWrapperTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.servicecomb.foundation.common.concurrency;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ScheduledThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.junit.Test;\n+\n+public class RunnableWrapperTest {\n+  /**\n+   * {@link SuppressedRunnableWrapper} should ensure that any {@link Throwable} thrown from {@link Runnable}\n+   * should not interrupt the scheduled tasks.\n+   */\n+  @Test\n+  public void run() throws InterruptedException {\n+    ScheduledThreadPoolExecutor scheduledThreadPoolExecutor = new ScheduledThreadPoolExecutor(1);\n+    CountDownLatch countDownLatch = new CountDownLatch(3);\n+    scheduledThreadPoolExecutor.scheduleAtFixedRate(\n+        new SuppressedRunnableWrapper(\n+            () -> {\n+              countDownLatch.countDown();\n+              switch ((int) countDownLatch.getCount()) {\n+                case 2:\n+                  throw new Error(\"Normal case, this is a mocked error\");\n+                case 1:\n+                  throw new IllegalStateException(\"Normal case, this is a mocked exception\");\n+                default:\n+              }\n+            }\n+        ),\n+        1,\n+        1,\n+        TimeUnit.MILLISECONDS);\n+\n+    countDownLatch.await(1000, TimeUnit.MILLISECONDS);\n+    assertEquals(0, countDownLatch.getCount());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTAyOTI3OA=="}, "originalCommit": {"oid": "9bf17b11a169f41968d36e1f5ad70d525a15c4bc"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1NDcwNjAyOnYy", "diffSide": "RIGHT", "path": "service-registry/src/main/java/org/apache/servicecomb/serviceregistry/registry/RemoteServiceRegistry.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwMDo1MDoxOVrOFcHo3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNzoyNzozM1rOFcMCJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTAyOTU5Nw==", "bodyText": "It's better to assign a default value explicitly", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1516#discussion_r365029597", "createdAt": "2020-01-10T00:50:19Z", "author": {"login": "liubao68"}, "path": "service-registry/src/main/java/org/apache/servicecomb/serviceregistry/registry/RemoteServiceRegistry.java", "diffHunk": "@@ -50,18 +52,16 @@ public RemoteServiceRegistry(EventBus eventBus, ServiceRegistryConfig serviceReg\n   public void init() {\n     super.init();\n     taskPool = new ScheduledThreadPoolExecutor(3,\n-        task -> {\n-          return new Thread(task) {\n-            @Override\n-            public void run() {\n-              try {\n-                setName(\"Service Center Task [\" + task.toString() + \"[\" + this.getId() + \"]]\");\n-                super.run();\n-              } catch (Throwable e) {\n-                LOGGER.error(\"task {} execute error.\", getName(), e);\n-              }\n-            }\n-          };\n+        new ThreadFactory() {\n+          private int taskId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bf17b11a169f41968d36e1f5ad70d525a15c4bc"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEwMTYwNw==", "bodyText": "Done. pls check it.", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1516#discussion_r365101607", "createdAt": "2020-01-10T07:27:33Z", "author": {"login": "yhs0092"}, "path": "service-registry/src/main/java/org/apache/servicecomb/serviceregistry/registry/RemoteServiceRegistry.java", "diffHunk": "@@ -50,18 +52,16 @@ public RemoteServiceRegistry(EventBus eventBus, ServiceRegistryConfig serviceReg\n   public void init() {\n     super.init();\n     taskPool = new ScheduledThreadPoolExecutor(3,\n-        task -> {\n-          return new Thread(task) {\n-            @Override\n-            public void run() {\n-              try {\n-                setName(\"Service Center Task [\" + task.toString() + \"[\" + this.getId() + \"]]\");\n-                super.run();\n-              } catch (Throwable e) {\n-                LOGGER.error(\"task {} execute error.\", getName(), e);\n-              }\n-            }\n-          };\n+        new ThreadFactory() {\n+          private int taskId;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTAyOTU5Nw=="}, "originalCommit": {"oid": "9bf17b11a169f41968d36e1f5ad70d525a15c4bc"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1350, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}