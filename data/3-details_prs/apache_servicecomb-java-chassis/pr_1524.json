{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNjkwODEw", "number": 1524, "title": "[SCB-1716] Fix high cpu load when there are too many instances", "bodyText": "Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Make sure there is a JIRA issue filed for the change (usually before you start working on it).  Trivial changes like typos do not require a JIRA issue.  Your pull request should address just this issue, without pulling in other changes.\n Each commit in the pull request should have a meaningful subject line and body.\n Format the pull request title like [SCB-XXX] Fixes bug in ApproximateQuantiles, where you replace SCB-XXX with the appropriate JIRA issue.\n Write a pull request description that is detailed enough to understand what the pull request does, how, and why.\n Run mvn clean install -Pit to make sure basic checks pass. A more thorough check will be performed on your pull request automatically.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.", "createdAt": "2020-01-11T03:47:55Z", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524", "merged": true, "mergeCommit": {"oid": "8aa6a8248ef1027e188ca10b2d506c048edfaf3a"}, "closed": true, "closedAt": "2020-01-14T06:28:21Z", "author": {"login": "AngLi2"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5KgRpgH2gAyMzYxNjkwODEwOjUyMzUwODVhOTRlMGY5MWFjZDY2MjQxNGZlNWNkMGVhODY2ZjMyNjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6K9AEgFqTM0MjMxMjM2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5235085a94e0f91acd662414fe5cd0ea866f3269", "author": {"user": {"login": "AngLi2", "name": "Ang Li"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/5235085a94e0f91acd662414fe5cd0ea866f3269", "committedDate": "2020-01-11T03:22:55Z", "message": "[SCB-1716] Fix high cpu load when there are too many instances"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19c9c40e1e918586aafba0a99082bd2c88997f76", "author": {"user": {"login": "AngLi2", "name": "Ang Li"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/19c9c40e1e918586aafba0a99082bd2c88997f76", "committedDate": "2020-01-11T03:46:38Z", "message": "Fix typos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61ba0671f5a07eb25e2443cd88062a6624c62b07", "author": {"user": {"login": "AngLi2", "name": "Ang Li"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/61ba0671f5a07eb25e2443cd88062a6624c62b07", "committedDate": "2020-01-11T07:09:58Z", "message": "Add alias for servicecomb.loadbalance.stats.timerIntervalInMilis"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNjEzOTMw", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#pullrequestreview-341613930", "createdAt": "2020-01-13T01:00:18Z", "commit": {"oid": "61ba0671f5a07eb25e2443cd88062a6624c62b07"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwMTowMDoxOFrOFcsCHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwMTowMDoxOFrOFcsCHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYyNTg4NA==", "bodyText": "change to timerIntervalInMillis", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#discussion_r365625884", "createdAt": "2020-01-13T01:00:18Z", "author": {"login": "liubao68"}, "path": "handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java", "diffHunk": "@@ -31,9 +31,9 @@\n   //// 2.1 configuration items\n   public static final String PROP_ROOT = \"servicecomb.loadbalance.\";\n \n-  public static final String RPOP_SERVER_EXPIRED_IN_SECONDS = \"servicecomb.loadbalance.stats.serverExpiredInSeconds\";\n+  public static final String PROP_SERVER_EXPIRED_IN_SECONDS = \"servicecomb.loadbalance.stats.serverExpiredInSeconds\";\n \n-  public static final String RPOP_TIMER_INTERVAL_IN_MINIS = \"servicecomb.loadbalance.stats.timerIntervalInMilis\";\n+  public static final String PROP_TIMER_INTERVAL_IN_MILLIS = \"servicecomb.loadbalance.stats.timerIntervalInMilis\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61ba0671f5a07eb25e2443cd88062a6624c62b07"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNjE0MDI5", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#pullrequestreview-341614029", "createdAt": "2020-01-13T01:01:37Z", "commit": {"oid": "61ba0671f5a07eb25e2443cd88062a6624c62b07"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwMTowMTozN1rOFcsCZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwMTowMTozN1rOFcsCZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYyNTk1OQ==", "bodyText": "getRetry can change to a better name", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#discussion_r365625959", "createdAt": "2020-01-13T01:01:37Z", "author": {"login": "liubao68"}, "path": "handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java", "diffHunk": "@@ -122,10 +122,14 @@ public boolean isRetryEnabled(String microservice) {\n   }\n \n   public int getRetryOnNext(String microservice) {\n+    return getRetry(microservice, PROP_RETRY_ONNEXT);\n+  }\n+\n+  private int getRetry(String microservice, String propRetry) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61ba0671f5a07eb25e2443cd88062a6624c62b07"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNjE0MzEy", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#pullrequestreview-341614312", "createdAt": "2020-01-13T01:05:25Z", "commit": {"oid": "5235085a94e0f91acd662414fe5cd0ea866f3269"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwMTowNToyNVrOFcsDWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwMTowNToyNVrOFcsDWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYyNjIwMA==", "bodyText": "getServiceCombServerOld is never used", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#discussion_r365626200", "createdAt": "2020-01-13T01:05:25Z", "author": {"login": "liubao68"}, "path": "handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/ServiceCombLoadBalancerStats.java", "diffHunk": "@@ -104,6 +106,10 @@ public ServiceCombServerStats getServiceCombServerStats(ServiceCombServer server\n   }\n \n   public ServiceCombServer getServiceCombServer(MicroserviceInstance instance) {\n+    return serviceCombServers.get(instance.getInstanceId());\n+  }\n+\n+  public ServiceCombServer getServiceCombServerOld(MicroserviceInstance instance) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5235085a94e0f91acd662414fe5cd0ea866f3269"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNjE5NTU2", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#pullrequestreview-341619556", "createdAt": "2020-01-13T02:10:04Z", "commit": {"oid": "7e1aa0024d2d762e29de83a8581d41bab0b04794"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwMjoxMDowNVrOFcsWAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwMjoxMDowNVrOFcsWAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzMDk3Nw==", "bodyText": "timerIntervalInMilis not changed", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#discussion_r365630977", "createdAt": "2020-01-13T02:10:05Z", "author": {"login": "liubao68"}, "path": "handlers/handler-loadbalance/src/main/java/org/apache/servicecomb/loadbalance/Configuration.java", "diffHunk": "@@ -29,25 +29,25 @@\n  */\n public final class Configuration {\n   //// 2.1 configuration items\n-  public static final String PROP_ROOT = \"servicecomb.loadbalance.\";\n+  public static final String ROOT = \"servicecomb.loadbalance.\";\n \n-  public static final String PROP_SERVER_EXPIRED_IN_SECONDS = \"servicecomb.loadbalance.stats.serverExpiredInSeconds\";\n+  public static final String SERVER_EXPIRED_IN_SECONDS = \"servicecomb.loadbalance.stats.serverExpiredInSeconds\";\n \n-  public static final String PROP_TIMER_INTERVAL_IN_MILLIS = \"servicecomb.loadbalance.stats.timerIntervalInMilis\";\n+  public static final String TIMER_INTERVAL_IN_MILLIS = \"servicecomb.loadbalance.stats.timerIntervalInMilis\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e1aa0024d2d762e29de83a8581d41bab0b04794"}, "originalPosition": 11}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e1aa0024d2d762e29de83a8581d41bab0b04794", "author": {"user": {"login": "AngLi2", "name": "Ang Li"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/7e1aa0024d2d762e29de83a8581d41bab0b04794", "committedDate": "2020-01-13T02:02:38Z", "message": "Rename configurations, remove unused method"}, "afterCommit": {"oid": "6dd9dd3890afda4eb8e0430d3ca153a42c2ebcf6", "author": {"user": {"login": "AngLi2", "name": "Ang Li"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/6dd9dd3890afda4eb8e0430d3ca153a42c2ebcf6", "committedDate": "2020-01-13T02:14:21Z", "message": "Rename configurations, remove unused method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNjI0OTk4", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#pullrequestreview-341624998", "createdAt": "2020-01-13T02:58:51Z", "commit": {"oid": "6dd9dd3890afda4eb8e0430d3ca153a42c2ebcf6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwMjo1ODo1MVrOFcsn9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwMjo1ODo1MVrOFcsn9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzNTU3NQ==", "bodyText": "Hello, it's better to write a UT case to cover here.\nThis configuration seems wrong. It means mapping servicecomb.loadbalance.stats.timerIntervalInMillis to servicecomb.loadbalance.stats.timerIntervalInMilis, while it doesn't take effect in the opposite direction. Since you get the config value from servicecomb.loadbalance.stats.timerIntervalInMillis, maybe here should be like below?\nservicecomb.loadbalance.stats.timerIntervalInMilis:\n  - servicecomb.loadbalance.stats.timerIntervalInMillis", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#discussion_r365635575", "createdAt": "2020-01-13T02:58:51Z", "author": {"login": "yhs0092"}, "path": "foundations/foundation-config/src/main/resources/mapping.yaml", "diffHunk": "@@ -16,3 +16,6 @@\n ## ---------------------------------------------------------------------------\n \n SERVICECOMB_ENV: service_description.environment\n+\n+servicecomb.loadbalance.stats.timerIntervalInMillis:\n+  - servicecomb.loadbalance.stats.timerIntervalInMilis", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dd9dd3890afda4eb8e0430d3ca153a42c2ebcf6"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6dd9dd3890afda4eb8e0430d3ca153a42c2ebcf6", "author": {"user": {"login": "AngLi2", "name": "Ang Li"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/6dd9dd3890afda4eb8e0430d3ca153a42c2ebcf6", "committedDate": "2020-01-13T02:14:21Z", "message": "Rename configurations, remove unused method"}, "afterCommit": {"oid": "e568e37ecff3068665b6af6b156b109c4995d203", "author": {"user": {"login": "AngLi2", "name": "Ang Li"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/e568e37ecff3068665b6af6b156b109c4995d203", "committedDate": "2020-01-13T07:18:05Z", "message": "Rename configurations, remove unused method, add UT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e568e37ecff3068665b6af6b156b109c4995d203", "author": {"user": {"login": "AngLi2", "name": "Ang Li"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/e568e37ecff3068665b6af6b156b109c4995d203", "committedDate": "2020-01-13T07:18:05Z", "message": "Rename configurations, remove unused method, add UT"}, "afterCommit": {"oid": "b5bf1301822fe0edc9c93646d183425fbd292041", "author": {"user": {"login": "AngLi2", "name": "Ang Li"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/b5bf1301822fe0edc9c93646d183425fbd292041", "committedDate": "2020-01-13T07:27:28Z", "message": "Rename configurations, remove unused method, add UT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "714a4a05984c94a0438cc30dc336bf19c2ea844d", "author": {"user": {"login": "AngLi2", "name": "Ang Li"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/714a4a05984c94a0438cc30dc336bf19c2ea844d", "committedDate": "2020-01-13T07:47:22Z", "message": "Rename configurations, remove unused method, add UT, refactoring\nConfigMapping.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5bf1301822fe0edc9c93646d183425fbd292041", "author": {"user": {"login": "AngLi2", "name": "Ang Li"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/b5bf1301822fe0edc9c93646d183425fbd292041", "committedDate": "2020-01-13T07:27:28Z", "message": "Rename configurations, remove unused method, add UT"}, "afterCommit": {"oid": "714a4a05984c94a0438cc30dc336bf19c2ea844d", "author": {"user": {"login": "AngLi2", "name": "Ang Li"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/714a4a05984c94a0438cc30dc336bf19c2ea844d", "committedDate": "2020-01-13T07:47:22Z", "message": "Rename configurations, remove unused method, add UT, refactoring\nConfigMapping.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMjYzNTM4", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#pullrequestreview-342263538", "createdAt": "2020-01-14T02:41:58Z", "commit": {"oid": "714a4a05984c94a0438cc30dc336bf19c2ea844d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMzEyMzY4", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1524#pullrequestreview-342312368", "createdAt": "2020-01-14T06:28:13Z", "commit": {"oid": "714a4a05984c94a0438cc30dc336bf19c2ea844d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4530, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}