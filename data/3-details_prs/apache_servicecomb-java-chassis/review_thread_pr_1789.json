{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0Mjg4NDc3", "number": 1789, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzo1MzozOFrOEAZi0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODoxNDo0MVrOEAZ8yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4ODUzOTY5OnYy", "diffSide": "RIGHT", "path": "demo/demo-multi-registries/demo-multi-registries-client/src/main/java/org/apache/servicecomb/demo/registry/IServerEndpoint.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzo1MzozOFrOGbptIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODoyMToyOFrOGbqpGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY0ODAzMg==", "bodyText": "no need prefix \"I\"?", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1789#discussion_r431648032", "createdAt": "2020-05-28T07:53:38Z", "author": {"login": "wujimin"}, "path": "demo/demo-multi-registries/demo-multi-registries-client/src/main/java/org/apache/servicecomb/demo/registry/IServerEndpoint.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.servicecomb.demo.registry;\n+\n+public interface IServerEndpoint {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2753d18f25f48c2f7c51bde43fe1c4fc7abf3f6e"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY2MzM4Ng==", "bodyText": "ServerEndpoint is used for class. Here is a demo, try a quick name like other interfaces in the demo.", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1789#discussion_r431663386", "createdAt": "2020-05-28T08:21:28Z", "author": {"login": "liubao68"}, "path": "demo/demo-multi-registries/demo-multi-registries-client/src/main/java/org/apache/servicecomb/demo/registry/IServerEndpoint.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.servicecomb.demo.registry;\n+\n+public interface IServerEndpoint {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY0ODAzMg=="}, "originalCommit": {"oid": "2753d18f25f48c2f7c51bde43fe1c4fc7abf3f6e"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4ODU1NzE5OnYy", "diffSide": "RIGHT", "path": "foundations/foundation-registry/src/main/java/org/apache/servicecomb/registry/consumer/MicroserviceManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzo1OToxNVrOGbp49g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzo1OToxNVrOGbp49g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY1MTA2Mg==", "bodyText": "hashmap is not thread safe, not only for write, but also for read", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1789#discussion_r431651062", "createdAt": "2020-05-28T07:59:15Z", "author": {"login": "wujimin"}, "path": "foundations/foundation-registry/src/main/java/org/apache/servicecomb/registry/consumer/MicroserviceManager.java", "diffHunk": "@@ -45,11 +47,21 @@ public MicroserviceManager(AppManager appManager, String appId) {\n   }\n \n   public MicroserviceVersions getOrCreateMicroserviceVersions(String microserviceName) {\n-    MicroserviceVersions microserviceVersions = versionsByName.computeIfAbsent(microserviceName, name -> {\n-      MicroserviceVersions instance = new MicroserviceVersions(appManager, appId, microserviceName);\n-      instance.pullInstances();\n-      return instance;\n-    });\n+    // do not use ConcurrentHashMap computeIfAbsent for versionsByName\n+    // because: when create MicroserviceVersions, one creation may depend on another\n+    // MicroserviceVersions. And pullInstances will create a new MicroserviceVersions.\n+    // Calling ConcurrentHashMap computeIfAbsent inside will get deadlock.\n+    MicroserviceVersions microserviceVersions = versionsByName.get(microserviceName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2753d18f25f48c2f7c51bde43fe1c4fc7abf3f6e"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4ODU3MDExOnYy", "diffSide": "RIGHT", "path": "service-registry/registry-local/src/main/java/org/apache/servicecomb/localregistry/LocalRegistryStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODowMzozOVrOGbqB4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODozOToxOVrOGbrTkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY1MzM0NQ==", "bodyText": "try org.apache.servicecomb.foundation.common.utils.ResourceUtil#findResourcesBySuffix?", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1789#discussion_r431653345", "createdAt": "2020-05-28T08:03:39Z", "author": {"login": "wujimin"}, "path": "service-registry/registry-local/src/main/java/org/apache/servicecomb/localregistry/LocalRegistryStore.java", "diffHunk": "@@ -83,9 +90,28 @@ public void run() {\n     selfMicroserviceInstance.setInstanceId(selfMicroservice.getServiceId());\n     selfMicroserviceInstance.setServiceId(selfMicroservice.getServiceId());\n \n-    InputStream is = this.getClass().getClassLoader().getResourceAsStream(REGISTRY_FILE_NAME);\n-    if (is != null) {\n-      initFromData(is);\n+    InputStream is = null;\n+\n+    try {\n+      ClassLoader loader = JvmUtils.findClassLoader();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2753d18f25f48c2f7c51bde43fe1c4fc7abf3f6e"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3NDI1Nw==", "bodyText": "I see many ohter places code like this.\n'ResourceUtil#findResourcesBySuffix' returns List<URI> and not convinient for open stream.", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1789#discussion_r431674257", "createdAt": "2020-05-28T08:39:19Z", "author": {"login": "liubao68"}, "path": "service-registry/registry-local/src/main/java/org/apache/servicecomb/localregistry/LocalRegistryStore.java", "diffHunk": "@@ -83,9 +90,28 @@ public void run() {\n     selfMicroserviceInstance.setInstanceId(selfMicroservice.getServiceId());\n     selfMicroserviceInstance.setServiceId(selfMicroservice.getServiceId());\n \n-    InputStream is = this.getClass().getClassLoader().getResourceAsStream(REGISTRY_FILE_NAME);\n-    if (is != null) {\n-      initFromData(is);\n+    InputStream is = null;\n+\n+    try {\n+      ClassLoader loader = JvmUtils.findClassLoader();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY1MzM0NQ=="}, "originalCommit": {"oid": "2753d18f25f48c2f7c51bde43fe1c4fc7abf3f6e"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4ODYwNjE4OnYy", "diffSide": "RIGHT", "path": "service-registry/registry-service-center/src/main/java/org/apache/servicecomb/serviceregistry/registry/AbstractServiceRegistry.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODoxNDo0MVrOGbqZsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODoyMjowMlrOGbqqVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY1OTQ0Mw==", "bodyText": "3rd party is a good mechanism\uff0c must not delete it.", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1789#discussion_r431659443", "createdAt": "2020-05-28T08:14:41Z", "author": {"login": "wujimin"}, "path": "service-registry/registry-service-center/src/main/java/org/apache/servicecomb/serviceregistry/registry/AbstractServiceRegistry.java", "diffHunk": "@@ -263,6 +263,7 @@ public void destroy() {\n \n   @Override\n   // TODO: this is for 3rd party invocation, and a better way can be provided\n+  // TODO:  microserviceManager.getVersionsByName() can not be used, will delete this in SCB-1949", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2753d18f25f48c2f7c51bde43fe1c4fc7abf3f6e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY2MzcwMA==", "bodyText": "OK. I'll fix the problem in next PR without delete the interface.", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1789#discussion_r431663700", "createdAt": "2020-05-28T08:22:02Z", "author": {"login": "liubao68"}, "path": "service-registry/registry-service-center/src/main/java/org/apache/servicecomb/serviceregistry/registry/AbstractServiceRegistry.java", "diffHunk": "@@ -263,6 +263,7 @@ public void destroy() {\n \n   @Override\n   // TODO: this is for 3rd party invocation, and a better way can be provided\n+  // TODO:  microserviceManager.getVersionsByName() can not be used, will delete this in SCB-1949", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY1OTQ0Mw=="}, "originalCommit": {"oid": "2753d18f25f48c2f7c51bde43fe1c4fc7abf3f6e"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1266, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}