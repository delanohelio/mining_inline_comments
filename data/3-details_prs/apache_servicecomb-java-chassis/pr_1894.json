{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2OTkzMDQ3", "number": 1894, "title": "[SCB-2043] flow control support custom / bug fix", "bodyText": "(cherry picked from commit eed0e46)\nFollow this checklist to help us incorporate your contribution quickly and easily:\n\n Make sure there is a JIRA issue filed for the change (usually before you start working on it).  Trivial changes like typos do not require a JIRA issue.  Your pull request should address just this issue, without pulling in other changes.\n Each commit in the pull request should have a meaningful subject line and body.\n Format the pull request title like [SCB-XXX] Fixes bug in ApproximateQuantiles, where you replace SCB-XXX with the appropriate JIRA issue.\n Write a pull request description that is detailed enough to understand what the pull request does, how, and why.\n Run mvn clean install -Pit to make sure basic checks pass. A more thorough check will be performed on your pull request automatically.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.", "createdAt": "2020-07-27T08:19:59Z", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894", "merged": true, "mergeCommit": {"oid": "5a780aeca1a99b3cfd999d5443d6e69f0ea25b52"}, "closed": true, "closedAt": "2020-07-30T11:42:50Z", "author": {"login": "GuoYL123"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc49a6pgH2gAyNDU2OTkzMDQ3OjU1YWExNmY5MDgyOWM1MmU4ZWMwYjBjZWE1NTdkNDQ4NjU2ZDc1MTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5-IFzgFqTQ1ODMyMjExMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "55aa16f90829c52e8ec0b0cea557d448656d7510", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/55aa16f90829c52e8ec0b0cea557d448656d7510", "committedDate": "2020-07-27T08:19:27Z", "message": "[SCB-2043] flow control bug fix\n\n(cherry picked from commit eed0e46cf448b0caab1b7211f9780bbd82f55a6b)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4856844705321c95180e9f8f2bff361a82ee7d85", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/4856844705321c95180e9f8f2bff361a82ee7d85", "committedDate": "2020-07-27T11:34:44Z", "message": "[SCB-2043] flow control support custom"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MjQwMzUw", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894#pullrequestreview-456240350", "createdAt": "2020-07-28T01:25:22Z", "commit": {"oid": "4856844705321c95180e9f8f2bff361a82ee7d85"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwMToyNToyMlrOG35PPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwMToyNToyMlrOG35PPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI2MjY1Mg==", "bodyText": "Maybe this code can be better refactored.\n\nall strategies are SPI\nany implementation have a name\nchoose the target strategy by configured name and default to 'FixedWindow'\n\nBy doing this, the strategy enum and case statements can be removed.", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894#discussion_r461262652", "createdAt": "2020-07-28T01:25:22Z", "author": {"login": "liubao68"}, "path": "handlers/handler-flowcontrol-qps/src/main/java/org/apache/servicecomb/qps/QpsControllerManager.java", "diffHunk": "@@ -211,6 +212,8 @@ public QpsControllerManager setGlobalQpsStrategy(String globalLimitKey, String g\n   private AbstractQpsStrategy chooseStrategy(String globalConfigKey, Long limit, Long bucket,\n       String strategyKey) {\n     AbstractQpsStrategy strategy;\n+    AbstractQpsStrategy customStrategy = SPIServiceUtils", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4856844705321c95180e9f8f2bff361a82ee7d85"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NjAwMjI5", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894#pullrequestreview-456600229", "createdAt": "2020-07-28T12:54:31Z", "commit": {"oid": "e3d2ec6eb473e376325dd08879c03f173d2668d0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMjo1NDozMVrOG4LJyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMjo1NDozMVrOG4LJyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU1NjE3MQ==", "bodyText": "strategyKey can have default value 'FixedWindow', wrong used defined value can throw exception. So here do not need new a default strategy.", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894#discussion_r461556171", "createdAt": "2020-07-28T12:54:31Z", "author": {"login": "liubao68"}, "path": "handlers/handler-flowcontrol-qps/src/main/java/org/apache/servicecomb/qps/QpsControllerManager.java", "diffHunk": "@@ -210,21 +209,17 @@ public QpsControllerManager setGlobalQpsStrategy(String globalLimitKey, String g\n \n   private AbstractQpsStrategy chooseStrategy(String globalConfigKey, Long limit, Long bucket,\n       String strategyKey) {\n-    AbstractQpsStrategy strategy;\n-    switch (StrategyType.parseStrategyType(strategyKey)) {\n-      case FixedWindow:\n-        strategy = new FixedWindowStrategy(globalConfigKey, limit);\n-        break;\n-      case LeakyBucket:\n-        strategy = new LeakyBucketStrategy(globalConfigKey, limit);\n-        break;\n-      case TokenBucket:\n-        strategy = new TokenBucketStrategy(globalConfigKey, limit, bucket);\n-        break;\n-      case SlidingWindow:\n-      default:\n-        strategy = new FixedWindowStrategy(globalConfigKey, limit);\n+    AbstractQpsStrategy strategy = new FixedWindowStrategy(globalConfigKey, limit);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3d2ec6eb473e376325dd08879c03f173d2668d0"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NjAwNTUx", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894#pullrequestreview-456600551", "createdAt": "2020-07-28T12:54:54Z", "commit": {"oid": "e3d2ec6eb473e376325dd08879c03f173d2668d0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMjo1NDo1NFrOG4LKww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMjo1NDo1NFrOG4LKww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU1NjQxOQ==", "bodyText": "Add a break is better.", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894#discussion_r461556419", "createdAt": "2020-07-28T12:54:54Z", "author": {"login": "liubao68"}, "path": "handlers/handler-flowcontrol-qps/src/main/java/org/apache/servicecomb/qps/QpsControllerManager.java", "diffHunk": "@@ -210,21 +209,17 @@ public QpsControllerManager setGlobalQpsStrategy(String globalLimitKey, String g\n \n   private AbstractQpsStrategy chooseStrategy(String globalConfigKey, Long limit, Long bucket,\n       String strategyKey) {\n-    AbstractQpsStrategy strategy;\n-    switch (StrategyType.parseStrategyType(strategyKey)) {\n-      case FixedWindow:\n-        strategy = new FixedWindowStrategy(globalConfigKey, limit);\n-        break;\n-      case LeakyBucket:\n-        strategy = new LeakyBucketStrategy(globalConfigKey, limit);\n-        break;\n-      case TokenBucket:\n-        strategy = new TokenBucketStrategy(globalConfigKey, limit, bucket);\n-        break;\n-      case SlidingWindow:\n-      default:\n-        strategy = new FixedWindowStrategy(globalConfigKey, limit);\n+    AbstractQpsStrategy strategy = new FixedWindowStrategy(globalConfigKey, limit);\n+    List<AbstractQpsStrategy> customStrategy = SPIServiceUtils\n+        .getOrLoadSortedService(AbstractQpsStrategy.class);\n+    for (AbstractQpsStrategy abstractQpsStrategy : customStrategy) {\n+      if (abstractQpsStrategy.name().equals(strategyKey)) {\n+        strategy = abstractQpsStrategy;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3d2ec6eb473e376325dd08879c03f173d2668d0"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NjAxNjA4", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894#pullrequestreview-456601608", "createdAt": "2020-07-28T12:56:12Z", "commit": {"oid": "e3d2ec6eb473e376325dd08879c03f173d2668d0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMjo1NjoxMlrOG4LN1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMjo1NjoxMlrOG4LN1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU1NzIwNg==", "bodyText": "strategyKey  better to rename to 'strategy', it is not a key , but a value.", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894#discussion_r461557206", "createdAt": "2020-07-28T12:56:12Z", "author": {"login": "liubao68"}, "path": "handlers/handler-flowcontrol-qps/src/main/java/org/apache/servicecomb/qps/QpsControllerManager.java", "diffHunk": "@@ -210,21 +209,17 @@ public QpsControllerManager setGlobalQpsStrategy(String globalLimitKey, String g\n \n   private AbstractQpsStrategy chooseStrategy(String globalConfigKey, Long limit, Long bucket,\n       String strategyKey) {\n-    AbstractQpsStrategy strategy;\n-    switch (StrategyType.parseStrategyType(strategyKey)) {\n-      case FixedWindow:\n-        strategy = new FixedWindowStrategy(globalConfigKey, limit);\n-        break;\n-      case LeakyBucket:\n-        strategy = new LeakyBucketStrategy(globalConfigKey, limit);\n-        break;\n-      case TokenBucket:\n-        strategy = new TokenBucketStrategy(globalConfigKey, limit, bucket);\n-        break;\n-      case SlidingWindow:\n-      default:\n-        strategy = new FixedWindowStrategy(globalConfigKey, limit);\n+    AbstractQpsStrategy strategy = new FixedWindowStrategy(globalConfigKey, limit);\n+    List<AbstractQpsStrategy> customStrategy = SPIServiceUtils\n+        .getOrLoadSortedService(AbstractQpsStrategy.class);\n+    for (AbstractQpsStrategy abstractQpsStrategy : customStrategy) {\n+      if (abstractQpsStrategy.name().equals(strategyKey)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3d2ec6eb473e376325dd08879c03f173d2668d0"}, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e3d2ec6eb473e376325dd08879c03f173d2668d0", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/e3d2ec6eb473e376325dd08879c03f173d2668d0", "committedDate": "2020-07-28T09:26:06Z", "message": "[SCB-2043] refactory as comment"}, "afterCommit": {"oid": "6af810e2dede1a37e654b32142e0a3f9a0487677", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/6af810e2dede1a37e654b32142e0a3f9a0487677", "committedDate": "2020-07-29T02:00:23Z", "message": "[SCB-2043] refactory as comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6af810e2dede1a37e654b32142e0a3f9a0487677", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/6af810e2dede1a37e654b32142e0a3f9a0487677", "committedDate": "2020-07-29T02:00:23Z", "message": "[SCB-2043] refactory as comment"}, "afterCommit": {"oid": "47e5bbb6889dff04fea6e139f44d3ae32c44e5e0", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/47e5bbb6889dff04fea6e139f44d3ae32c44e5e0", "committedDate": "2020-07-29T02:07:28Z", "message": "[SCB-2043] refactory as comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MTYxMjg2", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894#pullrequestreview-457161286", "createdAt": "2020-07-29T02:59:00Z", "commit": {"oid": "47e5bbb6889dff04fea6e139f44d3ae32c44e5e0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMjo1OTowMFrOG4mxoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMjo1OTowMFrOG4mxoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwODczNw==", "bodyText": "strategyName do not have a default value.", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894#discussion_r462008737", "createdAt": "2020-07-29T02:59:00Z", "author": {"login": "liubao68"}, "path": "handlers/handler-flowcontrol-qps/src/main/java/org/apache/servicecomb/qps/QpsControllerManager.java", "diffHunk": "@@ -209,22 +208,21 @@ public QpsControllerManager setGlobalQpsStrategy(String globalLimitKey, String g\n   }\n \n   private AbstractQpsStrategy chooseStrategy(String globalConfigKey, Long limit, Long bucket,\n-      String strategyKey) {\n-    AbstractQpsStrategy strategy;\n-    switch (StrategyType.parseStrategyType(strategyKey)) {\n-      case FixedWindow:\n-        strategy = new FixedWindowStrategy(globalConfigKey, limit);\n-        break;\n-      case LeakyBucket:\n-        strategy = new LeakyBucketStrategy(globalConfigKey, limit);\n-        break;\n-      case TokenBucket:\n-        strategy = new TokenBucketStrategy(globalConfigKey, limit, bucket);\n-        break;\n-      case SlidingWindow:\n-      default:\n-        strategy = new FixedWindowStrategy(globalConfigKey, limit);\n+      String strategyName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47e5bbb6889dff04fea6e139f44d3ae32c44e5e0"}, "originalPosition": 39}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "47e5bbb6889dff04fea6e139f44d3ae32c44e5e0", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/47e5bbb6889dff04fea6e139f44d3ae32c44e5e0", "committedDate": "2020-07-29T02:07:28Z", "message": "[SCB-2043] refactory as comment"}, "afterCommit": {"oid": "4cf527ed69010abcbc1985851617873ed5eafed5", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/4cf527ed69010abcbc1985851617873ed5eafed5", "committedDate": "2020-07-29T07:20:25Z", "message": "[SCB-2043] refactory as comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4cf527ed69010abcbc1985851617873ed5eafed5", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/4cf527ed69010abcbc1985851617873ed5eafed5", "committedDate": "2020-07-29T07:20:25Z", "message": "[SCB-2043] refactory as comment"}, "afterCommit": {"oid": "dba245c150823271c45351381ed4018c02a0b9d2", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/dba245c150823271c45351381ed4018c02a0b9d2", "committedDate": "2020-07-29T07:24:20Z", "message": "[SCB-2043] refactory as comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MjgyOTgw", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894#pullrequestreview-457282980", "createdAt": "2020-07-29T08:00:01Z", "commit": {"oid": "dba245c150823271c45351381ed4018c02a0b9d2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwODowMDowMVrOG4tErg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwODowMDowMVrOG4tErg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExMTkxOA==", "bodyText": "use commons lang3 api", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894#discussion_r462111918", "createdAt": "2020-07-29T08:00:01Z", "author": {"login": "liubao68"}, "path": "handlers/handler-flowcontrol-qps/src/main/java/org/apache/servicecomb/qps/QpsControllerManager.java", "diffHunk": "@@ -17,20 +17,20 @@\n \n package org.apache.servicecomb.qps;\n \n+import java.util.List;\n import java.util.Map;\n import java.util.Map.Entry;\n \n import org.apache.servicecomb.core.Invocation;\n import org.apache.servicecomb.foundation.common.concurrent.ConcurrentHashMapEx;\n+import org.apache.servicecomb.foundation.common.exceptions.ServiceCombException;\n+import org.apache.servicecomb.foundation.common.utils.SPIServiceUtils;\n import org.apache.servicecomb.qps.strategy.AbstractQpsStrategy;\n-import org.apache.servicecomb.qps.strategy.FixedWindowStrategy;\n-import org.apache.servicecomb.qps.strategy.LeakyBucketStrategy;\n-import org.apache.servicecomb.qps.strategy.StrategyType;\n-import org.apache.servicecomb.qps.strategy.TokenBucketStrategy;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n import com.netflix.config.DynamicProperty;\n+import org.springframework.util.StringUtils;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dba245c150823271c45351381ed4018c02a0b9d2"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dba245c150823271c45351381ed4018c02a0b9d2", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/dba245c150823271c45351381ed4018c02a0b9d2", "committedDate": "2020-07-29T07:24:20Z", "message": "[SCB-2043] refactory as comment"}, "afterCommit": {"oid": "dcf104c8754f350d6918db5de0c397b43c5a58e3", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/dcf104c8754f350d6918db5de0c397b43c5a58e3", "committedDate": "2020-07-29T09:00:50Z", "message": "[SCB-2043] refactory as comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dcf104c8754f350d6918db5de0c397b43c5a58e3", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/dcf104c8754f350d6918db5de0c397b43c5a58e3", "committedDate": "2020-07-29T09:00:50Z", "message": "[SCB-2043] refactory as comment"}, "afterCommit": {"oid": "ce3c5f58c982bdd659da5e85b9baac87a51dee0e", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/ce3c5f58c982bdd659da5e85b9baac87a51dee0e", "committedDate": "2020-07-29T09:02:39Z", "message": "[SCB-2043] refactory as comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce3c5f58c982bdd659da5e85b9baac87a51dee0e", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/ce3c5f58c982bdd659da5e85b9baac87a51dee0e", "committedDate": "2020-07-29T09:02:39Z", "message": "[SCB-2043] refactory as comment"}, "afterCommit": {"oid": "f62dee43e5517b3dcf80848aa50c44e6d11a7132", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/f62dee43e5517b3dcf80848aa50c44e6d11a7132", "committedDate": "2020-07-30T01:25:35Z", "message": "[SCB-2043] refactory as comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MDUxNjcy", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894#pullrequestreview-458051672", "createdAt": "2020-07-30T03:47:18Z", "commit": {"oid": "f62dee43e5517b3dcf80848aa50c44e6d11a7132"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMzo0NzoxOFrOG5SCBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMzo0NzoxOFrOG5SCBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcxNzQ0Nw==", "bodyText": "exeception message is better to include strategyName", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894#discussion_r462717447", "createdAt": "2020-07-30T03:47:18Z", "author": {"login": "liubao68"}, "path": "handlers/handler-flowcontrol-qps/src/main/java/org/apache/servicecomb/qps/QpsControllerManager.java", "diffHunk": "@@ -209,22 +210,25 @@ public QpsControllerManager setGlobalQpsStrategy(String globalLimitKey, String g\n   }\n \n   private AbstractQpsStrategy chooseStrategy(String globalConfigKey, Long limit, Long bucket,\n-      String strategyKey) {\n-    AbstractQpsStrategy strategy;\n-    switch (StrategyType.parseStrategyType(strategyKey)) {\n-      case FixedWindow:\n-        strategy = new FixedWindowStrategy(globalConfigKey, limit);\n-        break;\n-      case LeakyBucket:\n-        strategy = new LeakyBucketStrategy(globalConfigKey, limit);\n-        break;\n-      case TokenBucket:\n-        strategy = new TokenBucketStrategy(globalConfigKey, limit, bucket);\n+      String strategyName) {\n+    if (StringUtils.isEmpty(strategyName)) {\n+      strategyName = \"FixedWindow\";\n+    }\n+    AbstractQpsStrategy strategy = null;\n+    List<IStrategyFactory> strategyFactories = SPIServiceUtils\n+        .getOrLoadSortedService(IStrategyFactory.class);\n+    for (IStrategyFactory strategyFactory : strategyFactories) {\n+      strategy = strategyFactory.getStrategy(strategyName);\n+      if (strategy != null) {\n         break;\n-      case SlidingWindow:\n-      default:\n-        strategy = new FixedWindowStrategy(globalConfigKey, limit);\n+      }\n+    }\n+    if (strategy == null) {\n+      throw new ServiceCombException(\"the qps strategy name is not exist , please check.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f62dee43e5517b3dcf80848aa50c44e6d11a7132"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MDUxODg1", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894#pullrequestreview-458051885", "createdAt": "2020-07-30T03:48:11Z", "commit": {"oid": "f62dee43e5517b3dcf80848aa50c44e6d11a7132"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMzo0ODoxMVrOG5SCqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMzo0ODoxMVrOG5SCqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcxNzYwOA==", "bodyText": "It's better to use createStrategy", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894#discussion_r462717608", "createdAt": "2020-07-30T03:48:11Z", "author": {"login": "liubao68"}, "path": "handlers/handler-flowcontrol-qps/src/main/java/org/apache/servicecomb/qps/strategy/DefaultStrategyFactory.java", "diffHunk": "@@ -14,27 +14,20 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n-\n package org.apache.servicecomb.qps.strategy;\n \n-import org.apache.commons.lang3.StringUtils;\n-\n-public enum StrategyType {\n-  TokenBucket,\n-  LeakyBucket,\n-  FixedWindow,\n-  SlidingWindow;\n-\n-\n-  public static StrategyType parseStrategyType(String type) {\n-    if (StringUtils.isEmpty(type)) {\n-      return StrategyType.FixedWindow;\n-    }\n+public class DefaultStrategyFactory implements IStrategyFactory {\n \n-    try {\n-      return StrategyType.valueOf(type.toUpperCase());\n-    } catch (IllegalArgumentException e) {\n-      return StrategyType.FixedWindow;\n+  public AbstractQpsStrategy getStrategy(String strategyName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f62dee43e5517b3dcf80848aa50c44e6d11a7132"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f62dee43e5517b3dcf80848aa50c44e6d11a7132", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/f62dee43e5517b3dcf80848aa50c44e6d11a7132", "committedDate": "2020-07-30T01:25:35Z", "message": "[SCB-2043] refactory as comment"}, "afterCommit": {"oid": "79e7d056dd5e373a61894d83503c8cff784eeded", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/79e7d056dd5e373a61894d83503c8cff784eeded", "committedDate": "2020-07-30T08:03:36Z", "message": "[SCB-2043] refactory as comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cfefd9cc87cbbc4be862b7865432b752c8df411", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/2cfefd9cc87cbbc4be862b7865432b752c8df411", "committedDate": "2020-07-30T08:29:09Z", "message": "[SCB-2043] refactory as comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79e7d056dd5e373a61894d83503c8cff784eeded", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/79e7d056dd5e373a61894d83503c8cff784eeded", "committedDate": "2020-07-30T08:03:36Z", "message": "[SCB-2043] refactory as comment"}, "afterCommit": {"oid": "f6fadc3efbc75a949d87303bb71ba71e26655df4", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/f6fadc3efbc75a949d87303bb71ba71e26655df4", "committedDate": "2020-07-30T08:29:25Z", "message": "[SCB-2043] add IT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6fadc3efbc75a949d87303bb71ba71e26655df4", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/f6fadc3efbc75a949d87303bb71ba71e26655df4", "committedDate": "2020-07-30T08:29:25Z", "message": "[SCB-2043] add IT"}, "afterCommit": {"oid": "09601c60a50a5f0b16c38eaec611026512722c0e", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/09601c60a50a5f0b16c38eaec611026512722c0e", "committedDate": "2020-07-30T09:22:10Z", "message": "[SCB-2043] add IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d9373dd00f21c318f77fb72d7fd77641ed2ed9b", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/3d9373dd00f21c318f77fb72d7fd77641ed2ed9b", "committedDate": "2020-07-30T09:41:29Z", "message": "[SCB-2043] add IT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "09601c60a50a5f0b16c38eaec611026512722c0e", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/09601c60a50a5f0b16c38eaec611026512722c0e", "committedDate": "2020-07-30T09:22:10Z", "message": "[SCB-2043] add IT"}, "afterCommit": {"oid": "3d9373dd00f21c318f77fb72d7fd77641ed2ed9b", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/3d9373dd00f21c318f77fb72d7fd77641ed2ed9b", "committedDate": "2020-07-30T09:41:29Z", "message": "[SCB-2043] add IT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MzIyMTEw", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1894#pullrequestreview-458322110", "createdAt": "2020-07-30T11:42:43Z", "commit": {"oid": "3d9373dd00f21c318f77fb72d7fd77641ed2ed9b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4468, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}