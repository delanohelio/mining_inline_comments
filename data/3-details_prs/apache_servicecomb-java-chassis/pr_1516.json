{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwOTI0Njc1", "number": 1516, "title": "[SCB-1710] catch the throwable from the scheduled pulling task", "bodyText": "https://issues.apache.org/jira/browse/SCB-1710\nsolution:\n\nadd a wrapper class SuppressedRunnableWrapper to decorate the scheduled tasks, to ensure that no Throwable is thrown out of the tasks. This wrapper can be reused later.\nwrap the org.apache.servicecomb.serviceregistry.consumer.AppManager#pullInstances scheduled task by SuppressedRunnableWrapper", "createdAt": "2020-01-09T12:02:08Z", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1516", "merged": true, "mergeCommit": {"oid": "99b683344c53c1f8f0a75cd9fef6a6b7c14e0670"}, "closed": true, "closedAt": "2020-01-11T01:25:14Z", "author": {"login": "yhs0092"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4omx_gH2gAyMzYwOTI0Njc1OjliZjE3YjExYTE2OWY0MTk2OGQzNmUxZjVhZDcwZDUyNWExNWM0YmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb5I0YYAFqTM0MTQ5MzQwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9bf17b11a169f41968d36e1f5ad70d525a15c4bc", "author": {"user": {"login": "yhs0092", "name": null}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/9bf17b11a169f41968d36e1f5ad70d525a15c4bc", "committedDate": "2020-01-09T11:53:15Z", "message": "[SCB-1710] catch the throwable from the scheduled pulling task"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwOTAyMTc2", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1516#pullrequestreview-340902176", "createdAt": "2020-01-10T00:48:49Z", "commit": {"oid": "9bf17b11a169f41968d36e1f5ad70d525a15c4bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwMDo0ODo1MFrOFcHnng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwMDo0ODo1MFrOFcHnng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTAyOTI3OA==", "bodyText": "it's better to call scheduledThreadPoolExecutor.shutDownNow to terminate the thread pool", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1516#discussion_r365029278", "createdAt": "2020-01-10T00:48:50Z", "author": {"login": "liubao68"}, "path": "foundations/foundation-common/src/test/java/org/apache/servicecomb/foundation/common/concurrency/RunnableWrapperTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.servicecomb.foundation.common.concurrency;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ScheduledThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.junit.Test;\n+\n+public class RunnableWrapperTest {\n+  /**\n+   * {@link SuppressedRunnableWrapper} should ensure that any {@link Throwable} thrown from {@link Runnable}\n+   * should not interrupt the scheduled tasks.\n+   */\n+  @Test\n+  public void run() throws InterruptedException {\n+    ScheduledThreadPoolExecutor scheduledThreadPoolExecutor = new ScheduledThreadPoolExecutor(1);\n+    CountDownLatch countDownLatch = new CountDownLatch(3);\n+    scheduledThreadPoolExecutor.scheduleAtFixedRate(\n+        new SuppressedRunnableWrapper(\n+            () -> {\n+              countDownLatch.countDown();\n+              switch ((int) countDownLatch.getCount()) {\n+                case 2:\n+                  throw new Error(\"Normal case, this is a mocked error\");\n+                case 1:\n+                  throw new IllegalStateException(\"Normal case, this is a mocked exception\");\n+                default:\n+              }\n+            }\n+        ),\n+        1,\n+        1,\n+        TimeUnit.MILLISECONDS);\n+\n+    countDownLatch.await(1000, TimeUnit.MILLISECONDS);\n+    assertEquals(0, countDownLatch.getCount());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bf17b11a169f41968d36e1f5ad70d525a15c4bc"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwOTAyNjAy", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1516#pullrequestreview-340902602", "createdAt": "2020-01-10T00:50:19Z", "commit": {"oid": "9bf17b11a169f41968d36e1f5ad70d525a15c4bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwMDo1MDoxOVrOFcHo3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwMDo1MDoxOVrOFcHo3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTAyOTU5Nw==", "bodyText": "It's better to assign a default value explicitly", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1516#discussion_r365029597", "createdAt": "2020-01-10T00:50:19Z", "author": {"login": "liubao68"}, "path": "service-registry/src/main/java/org/apache/servicecomb/serviceregistry/registry/RemoteServiceRegistry.java", "diffHunk": "@@ -50,18 +52,16 @@ public RemoteServiceRegistry(EventBus eventBus, ServiceRegistryConfig serviceReg\n   public void init() {\n     super.init();\n     taskPool = new ScheduledThreadPoolExecutor(3,\n-        task -> {\n-          return new Thread(task) {\n-            @Override\n-            public void run() {\n-              try {\n-                setName(\"Service Center Task [\" + task.toString() + \"[\" + this.getId() + \"]]\");\n-                super.run();\n-              } catch (Throwable e) {\n-                LOGGER.error(\"task {} execute error.\", getName(), e);\n-              }\n-            }\n-          };\n+        new ThreadFactory() {\n+          private int taskId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bf17b11a169f41968d36e1f5ad70d525a15c4bc"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b7132e7bedf9eb2c5c0b53ec8260ee558b37a8c", "author": {"user": {"login": "yhs0092", "name": null}}, "url": "https://github.com/apache/servicecomb-java-chassis/commit/9b7132e7bedf9eb2c5c0b53ec8260ee558b37a8c", "committedDate": "2020-01-10T06:55:18Z", "message": "[SCB-1710] fix as review opinion\n\n- initialize taskId explicitly\n- shutdown Executor in finally block in the UT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNDkzNDAz", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1516#pullrequestreview-341493403", "createdAt": "2020-01-11T01:25:04Z", "commit": {"oid": "9b7132e7bedf9eb2c5c0b53ec8260ee558b37a8c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4522, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}