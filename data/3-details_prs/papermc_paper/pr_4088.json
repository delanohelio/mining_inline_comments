{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MTEyMzM5", "number": 4088, "title": "Restore incremental player saving", "bodyText": "This patch was dropped in 1.14 . I couldn't find it in removed so I got it from 1.13\nTested with 30-40 players and works fine with default settings.\nCloses #4070", "createdAt": "2020-08-09T06:07:27Z", "url": "https://github.com/PaperMC/Paper/pull/4088", "merged": true, "mergeCommit": {"oid": "2b4ce0b370f2697616c4c73dbb42cd3d749b73c9"}, "closed": true, "closedAt": "2020-08-11T13:55:11Z", "author": {"login": "MrIvanPlays"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9dtP8AFqTQ2NDAzMDE3OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9wQjPgBqjM2NDE1NDAxMzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MDMwMTc4", "url": "https://github.com/PaperMC/Paper/pull/4088#pullrequestreview-464030178", "createdAt": "2020-08-10T08:12:07Z", "commit": {"oid": "06264131548f79834dc90c7071c32b2789edfb37"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODoxMjowOFrOG-FDxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODoxMjowOFrOG-FDxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc0Nzc4Mg==", "bodyText": "// Paper", "url": "https://github.com/PaperMC/Paper/pull/4088#discussion_r467747782", "createdAt": "2020-08-10T08:12:08Z", "author": {"login": "MiniDigger"}, "path": "Spigot-Server-Patches/0551-Incremental-player-saving.patch", "diffHunk": "@@ -0,0 +1,96 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Aikar <aikar@aikar.co>\n+Date: Sun, 9 Aug 2020 08:59:25 +0300\n+Subject: [PATCH] Incremental player saving\n+\n+Co-Authored-By: MrIvanPlays <ivan@mrivanplays.com> - ported to 1.16(.1)\n+\n+diff --git a/src/main/java/com/destroystokyo/paper/PaperConfig.java b/src/main/java/com/destroystokyo/paper/PaperConfig.java\n+index 56e4359ba32339e1bef58061585ff3e12e4215f3..60f03502a7fd622d2de3b2da9fe8014b289f3d31 100644\n+--- a/src/main/java/com/destroystokyo/paper/PaperConfig.java\n++++ b/src/main/java/com/destroystokyo/paper/PaperConfig.java\n+@@ -435,4 +435,15 @@ public class PaperConfig {\n+         allowPistonDuplication = getBoolean(\"settings.unsupported-settings.allow-piston-duplication\", config.getBoolean(\"settings.unsupported-settings.allow-tnt-duplication\", false));\n+         set(\"settings.unsupported-settings.allow-tnt-duplication\", null);\n+     }\n++\n++    public static int playerAutoSaveRate = -1;\n++    public static int maxPlayerAutoSavePerTick = 10;\n++    private static void playerAutoSaveRate() {\n++        playerAutoSaveRate = getInt(\"settings.player-auto-save-rate\", -1);\n++        maxPlayerAutoSavePerTick = getInt(\"settings.max-player-auto-save-per-tick\", -1);\n++        if (maxPlayerAutoSavePerTick == -1) { // -1 Automatic / \"Recommended\"\n++            // 10 should be safe for everyone unless you mass spamming player auto save\n++            maxPlayerAutoSavePerTick = (playerAutoSaveRate == -1 || playerAutoSaveRate > 100) ? 10 : 20;\n++        }\n++    }\n+ }\n+diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java\n+index e5a81f831813209d224ffedbc03f6d8243721a25..c72cfd2bdfbe4536f6799fc4dff195c1f66d4c94 100644\n+--- a/src/main/java/net/minecraft/server/EntityPlayer.java\n++++ b/src/main/java/net/minecraft/server/EntityPlayer.java\n+@@ -42,6 +42,7 @@ import org.bukkit.inventory.MainHand;\n+ public class EntityPlayer extends EntityHuman implements ICrafting {\n+ \n+     private static final Logger LOGGER = LogManager.getLogger();\n++    public long lastSave = MinecraftServer.currentTick; // Paper\n+     public PlayerConnection playerConnection;\n+     public NetworkManager networkManager; // Paper\n+     public final MinecraftServer server;\n+diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java\n+index 3130c68e7318a41e763575b245ee1b5298c92a16..0defaec8a8a25b1a0172f211d599d07264977cfa 100644\n+--- a/src/main/java/net/minecraft/server/MinecraftServer.java\n++++ b/src/main/java/net/minecraft/server/MinecraftServer.java\n+@@ -1228,9 +1228,15 @@ public abstract class MinecraftServer extends IAsyncTaskHandlerReentrant<TickTas\n+         //if (autosavePeriod > 0 && this.ticks % autosavePeriod == 0) { // CraftBukkit // Paper - move down\n+             //MinecraftServer.LOGGER.debug(\"Autosave started\"); // Paper\n+             serverAutoSave = (autosavePeriod > 0 && this.ticks % autosavePeriod == 0); // Paper\n++            // Paper start\n++            int playerSaveInterval = com.destroystokyo.paper.PaperConfig.playerAutoSaveRate;\n++            if (playerSaveInterval < 0) {\n++                playerSaveInterval = autosavePeriod;\n++            }\n++            // Paper end\n+             this.methodProfiler.enter(\"save\");\n+-            if (autosavePeriod > 0 && this.ticks % autosavePeriod == 0) { // Paper\n+-            this.playerList.savePlayers();\n++            if (playerSaveInterval > 0) { // Paper\n++            this.playerList.savePlayers(playerSaveInterval); // Paper\n+             }// Paper\n+             // Paper start\n+             for (WorldServer world : getWorlds()) {\n+diff --git a/src/main/java/net/minecraft/server/PlayerList.java b/src/main/java/net/minecraft/server/PlayerList.java\n+index 9382e8f79e8edec8885c629a36e230fbec50e1fb..1ffb68e6657fe2cb3153d724d89b1a474c6d4d84 100644\n+--- a/src/main/java/net/minecraft/server/PlayerList.java\n++++ b/src/main/java/net/minecraft/server/PlayerList.java\n+@@ -482,6 +482,7 @@ public abstract class PlayerList {\n+     protected void savePlayerFile(EntityPlayer entityplayer) {\n+         if (!entityplayer.getBukkitEntity().isPersistent()) return; // CraftBukkit\n+         if (!entityplayer.didPlayerJoinEvent) return; // Paper - If we never fired PJE, we disconnected during login. Data has not changed, and additionally, our saved vehicle is not loaded! If we save now, we will lose our vehicle (CraftBukkit bug)\n++        entityplayer.lastSave = MinecraftServer.currentTick;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06264131548f79834dc90c7071c32b2789edfb37"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d01e4d9d39956264c8414ca18bf0557210ccbe79", "author": {"user": null}, "url": "https://github.com/PaperMC/Paper/commit/d01e4d9d39956264c8414ca18bf0557210ccbe79", "committedDate": "2020-08-11T05:48:22Z", "message": "Restore incremental player saving\n\nThis patch was dropped in 1.14 . I couldn't find it in removed so I got it from 1.13\nTested with 30-40 players and works fine with default settings.\nCloses https://github.com/PaperMC/Paper/issues/4070"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff04b676be7f5efbd05e05814f09aac1d018de9f", "author": {"user": null}, "url": "https://github.com/PaperMC/Paper/commit/ff04b676be7f5efbd05e05814f09aac1d018de9f", "committedDate": "2020-08-11T05:47:36Z", "message": "Remove me from here too so they don't start screamin' at this PR atleast"}, "afterCommit": {"oid": "d01e4d9d39956264c8414ca18bf0557210ccbe79", "author": {"user": null}, "url": "https://github.com/PaperMC/Paper/commit/d01e4d9d39956264c8414ca18bf0557210ccbe79", "committedDate": "2020-08-11T05:48:22Z", "message": "Restore incremental player saving\n\nThis patch was dropped in 1.14 . I couldn't find it in removed so I got it from 1.13\nTested with 30-40 players and works fine with default settings.\nCloses https://github.com/PaperMC/Paper/issues/4070"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1721, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}