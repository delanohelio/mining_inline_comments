{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMjUwNDE1", "number": 3116, "title": "Async command map building", "bodyText": "Builds the command map async, focuses on fixing the root problem described in #2938 instead of just ignoring it. Leaf said he had a better idea but since I had this finished already.. thought might as well PR it.\nNeeds testing from someone who suffers from lag spikes when players connect/change worlds.\nShows up as CommandDispatcher.a() in sampler reports.", "createdAt": "2020-04-09T07:12:51Z", "url": "https://github.com/PaperMC/Paper/pull/3116", "merged": true, "mergeCommit": {"oid": "06044e24584c48a6c8380872a250275b06418b6d"}, "closed": true, "closedAt": "2020-04-12T21:12:47Z", "author": {"login": "Callahhh"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcV3NTWAFqTM5MDU0NDkyNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcW_qvPgH2gAyNDAxMjUwNDE1OjA2MDQ0ZTI0NTg0YzQ4YTZjODM4MDg3MmEyNTAyNzViMDY0MThiNmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNTQ0OTI1", "url": "https://github.com/PaperMC/Paper/pull/3116#pullrequestreview-390544925", "createdAt": "2020-04-09T07:17:48Z", "commit": {"oid": "80a379eb5ddc3f653dd3abf952ec44e8352f8819"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNTQ1Mjkx", "url": "https://github.com/PaperMC/Paper/pull/3116#pullrequestreview-390545291", "createdAt": "2020-04-09T07:18:23Z", "commit": {"oid": "80a379eb5ddc3f653dd3abf952ec44e8352f8819"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzoxODoyM1rOGDMeWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzoxODo0MFrOGDMeww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwMzI5MQ==", "bodyText": "this should be up at the private void runSync", "url": "https://github.com/PaperMC/Paper/pull/3116#discussion_r406003291", "createdAt": "2020-04-09T07:18:23Z", "author": {"login": "aikar"}, "path": "Spigot-Server-Patches/0463-Async-command-map-building.patch", "diffHunk": "@@ -0,0 +1,50 @@\n+From bde0fc09db464680cfd12a76c32076d450ac7cfe Mon Sep 17 00:00:00 2001\n+From: Callahan <mr.callahhh@gmail.com>\n+Date: Wed, 8 Apr 2020 02:42:14 -0500\n+Subject: [PATCH] Async command map building\n+\n+\n+diff --git a/src/main/java/net/minecraft/server/CommandDispatcher.java b/src/main/java/net/minecraft/server/CommandDispatcher.java\n+index 37b1a7947..97d608be9 100644\n+--- a/src/main/java/net/minecraft/server/CommandDispatcher.java\n++++ b/src/main/java/net/minecraft/server/CommandDispatcher.java\n+@@ -241,6 +241,13 @@ public class CommandDispatcher {\n+         if ( org.spigotmc.SpigotConfig.tabComplete < 0 ) return; // Spigot\n+         // CraftBukkit start\n+         // Register Vanilla commands into builtRoot as before\n++        // Paper start - Async command map building\n++        java.util.concurrent.ForkJoinPool.commonPool().submit(() -> {\n++            sendAsync(entityplayer);\n++        });\n++    }\n++    \n++    private void sendAsync(EntityPlayer entityplayer) {\n+         Map<CommandNode<CommandListenerWrapper>, CommandNode<ICompletionProvider>> map = Maps.newIdentityHashMap(); // Use identity to prevent aliasing issues\n+         RootCommandNode vanillaRoot = new RootCommandNode();\n+ \n+@@ -258,7 +265,13 @@ public class CommandDispatcher {\n+         for (CommandNode node : rootcommandnode.getChildren()) {\n+             bukkit.add(node.getName());\n+         }\n+-\n++        \n++        MinecraftServer.getServer().postToMainThread(() -> {\n++           runSync(entityplayer, bukkit, rootcommandnode);\n++        });\n++    }\n++    \n++    private void runSync(EntityPlayer entityplayer, Collection<String> bukkit, RootCommandNode<ICompletionProvider> rootcommandnode) {\n+         PlayerCommandSendEvent event = new PlayerCommandSendEvent(entityplayer.getBukkitEntity(), new LinkedHashSet<>(bukkit));\n+         event.getPlayer().getServer().getPluginManager().callEvent(event);\n+ \n+@@ -271,6 +284,7 @@ public class CommandDispatcher {\n+         // CraftBukkit end\n+         entityplayer.playerConnection.sendPacket(new PacketPlayOutCommands(rootcommandnode));\n+     }\n++    // Paper end - Async command map building", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80a379eb5ddc3f653dd3abf952ec44e8352f8819"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwMzMzMw==", "bodyText": "paper start here", "url": "https://github.com/PaperMC/Paper/pull/3116#discussion_r406003333", "createdAt": "2020-04-09T07:18:32Z", "author": {"login": "aikar"}, "path": "Spigot-Server-Patches/0463-Async-command-map-building.patch", "diffHunk": "@@ -0,0 +1,50 @@\n+From bde0fc09db464680cfd12a76c32076d450ac7cfe Mon Sep 17 00:00:00 2001\n+From: Callahan <mr.callahhh@gmail.com>\n+Date: Wed, 8 Apr 2020 02:42:14 -0500\n+Subject: [PATCH] Async command map building\n+\n+\n+diff --git a/src/main/java/net/minecraft/server/CommandDispatcher.java b/src/main/java/net/minecraft/server/CommandDispatcher.java\n+index 37b1a7947..97d608be9 100644\n+--- a/src/main/java/net/minecraft/server/CommandDispatcher.java\n++++ b/src/main/java/net/minecraft/server/CommandDispatcher.java\n+@@ -241,6 +241,13 @@ public class CommandDispatcher {\n+         if ( org.spigotmc.SpigotConfig.tabComplete < 0 ) return; // Spigot\n+         // CraftBukkit start\n+         // Register Vanilla commands into builtRoot as before\n++        // Paper start - Async command map building\n++        java.util.concurrent.ForkJoinPool.commonPool().submit(() -> {\n++            sendAsync(entityplayer);\n++        });\n++    }\n++    \n++    private void sendAsync(EntityPlayer entityplayer) {\n+         Map<CommandNode<CommandListenerWrapper>, CommandNode<ICompletionProvider>> map = Maps.newIdentityHashMap(); // Use identity to prevent aliasing issues\n+         RootCommandNode vanillaRoot = new RootCommandNode();\n+ \n+@@ -258,7 +265,13 @@ public class CommandDispatcher {\n+         for (CommandNode node : rootcommandnode.getChildren()) {\n+             bukkit.add(node.getName());\n+         }\n+-\n++        ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80a379eb5ddc3f653dd3abf952ec44e8352f8819"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwMzM5NQ==", "bodyText": "paper end here", "url": "https://github.com/PaperMC/Paper/pull/3116#discussion_r406003395", "createdAt": "2020-04-09T07:18:40Z", "author": {"login": "aikar"}, "path": "Spigot-Server-Patches/0463-Async-command-map-building.patch", "diffHunk": "@@ -0,0 +1,50 @@\n+From bde0fc09db464680cfd12a76c32076d450ac7cfe Mon Sep 17 00:00:00 2001\n+From: Callahan <mr.callahhh@gmail.com>\n+Date: Wed, 8 Apr 2020 02:42:14 -0500\n+Subject: [PATCH] Async command map building\n+\n+\n+diff --git a/src/main/java/net/minecraft/server/CommandDispatcher.java b/src/main/java/net/minecraft/server/CommandDispatcher.java\n+index 37b1a7947..97d608be9 100644\n+--- a/src/main/java/net/minecraft/server/CommandDispatcher.java\n++++ b/src/main/java/net/minecraft/server/CommandDispatcher.java\n+@@ -241,6 +241,13 @@ public class CommandDispatcher {\n+         if ( org.spigotmc.SpigotConfig.tabComplete < 0 ) return; // Spigot\n+         // CraftBukkit start\n+         // Register Vanilla commands into builtRoot as before\n++        // Paper start - Async command map building\n++        java.util.concurrent.ForkJoinPool.commonPool().submit(() -> {\n++            sendAsync(entityplayer);\n++        });\n++    }\n++    \n++    private void sendAsync(EntityPlayer entityplayer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80a379eb5ddc3f653dd3abf952ec44e8352f8819"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNTUzMDI2", "url": "https://github.com/PaperMC/Paper/pull/3116#pullrequestreview-390553026", "createdAt": "2020-04-09T07:31:49Z", "commit": {"oid": "1f0e385929c57924bc4b864045cdd28c46f8867e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNjA4NDQy", "url": "https://github.com/PaperMC/Paper/pull/3116#pullrequestreview-391608442", "createdAt": "2020-04-10T19:02:25Z", "commit": {"oid": "1f0e385929c57924bc4b864045cdd28c46f8867e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxOTowMjoyNVrOGEDF4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxOTowMjoyNVrOGEDF4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg5ODE0Ng==", "bodyText": "Shouldn't this be execute so its executed? You're just submitting it to queue but never executing.", "url": "https://github.com/PaperMC/Paper/pull/3116#discussion_r406898146", "createdAt": "2020-04-10T19:02:25Z", "author": {"login": "BillyGalbreath"}, "path": "Spigot-Server-Patches/0463-Async-command-map-building.patch", "diffHunk": "@@ -0,0 +1,44 @@\n+From 5ccaf0bce5b7928151762866ba6383aeaef4bd81 Mon Sep 17 00:00:00 2001\n+From: Callahan <mr.callahhh@gmail.com>\n+Date: Wed, 8 Apr 2020 02:42:14 -0500\n+Subject: [PATCH] Async command map building\n+\n+\n+diff --git a/src/main/java/net/minecraft/server/CommandDispatcher.java b/src/main/java/net/minecraft/server/CommandDispatcher.java\n+index 37b1a7947..1a99e37bc 100644\n+--- a/src/main/java/net/minecraft/server/CommandDispatcher.java\n++++ b/src/main/java/net/minecraft/server/CommandDispatcher.java\n+@@ -241,6 +241,14 @@ public class CommandDispatcher {\n+         if ( org.spigotmc.SpigotConfig.tabComplete < 0 ) return; // Spigot\n+         // CraftBukkit start\n+         // Register Vanilla commands into builtRoot as before\n++        // Paper start - Async command map building\n++        java.util.concurrent.ForkJoinPool.commonPool().submit(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f0e385929c57924bc4b864045cdd28c46f8867e"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06044e24584c48a6c8380872a250275b06418b6d", "author": {"user": {"login": "Callahhh", "name": null}}, "url": "https://github.com/PaperMC/Paper/commit/06044e24584c48a6c8380872a250275b06418b6d", "committedDate": "2020-04-12T19:43:07Z", "message": "Async command map building\n\nReduces lag created on login and world change for sending the command map to client"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1257, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}