{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5OTE2Nzcy", "number": 2924, "title": "Pillager patrol spawn settings and per player options", "bodyText": "This adds config options for defining the spawn chance, spawn delay and spawn start day as well as toggles for handling the spawn delay and start day per player. (Based on the time played statistic)\nWhen not per player it will use the Vanilla mechanic of one delay per world and the world age for the start day.", "createdAt": "2020-02-01T16:53:20Z", "url": "https://github.com/PaperMC/Paper/pull/2924", "merged": true, "mergeCommit": {"oid": "28cf6540c649ec8f3230b99f8e21c36b445b075e"}, "closed": true, "closedAt": "2020-03-31T03:27:59Z", "author": {"login": "Phoenix616"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcAGqXLgH2gAyMzY5OTE2NzcyOjIxOGFjNzkxNDFhNzNmMjZkZjQ5ZmUwYTkwMjgzOTQ5M2I3NTYzZWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcR4cR3AFqTM4MzIzNDI2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "218ac79141a73f26df49fe0a902839493b7563ef", "author": {"user": {"login": "Phoenix616", "name": "Max Lee"}}, "url": "https://github.com/PaperMC/Paper/commit/218ac79141a73f26df49fe0a902839493b7563ef", "committedDate": "2020-02-01T16:51:47Z", "message": "Pillager patrol spawn settings and per player options"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjMwMDg5", "url": "https://github.com/PaperMC/Paper/pull/2924#pullrequestreview-383230089", "createdAt": "2020-03-27T22:16:15Z", "commit": {"oid": "218ac79141a73f26df49fe0a902839493b7563ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMjoxNjoxNlrOF9DYCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMjoxNjoxNlrOF9DYCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2Mjc2MA==", "bodyText": "not sure if it's my head spinning or if I'm actually brain here, but is this the correct way around?", "url": "https://github.com/PaperMC/Paper/pull/2924#discussion_r399562760", "createdAt": "2020-03-27T22:16:16Z", "author": {"login": "electronicboy"}, "path": "Spigot-Server-Patches/0435-Pillager-patrol-spawn-settings-and-per-player-option.patch", "diffHunk": "@@ -0,0 +1,144 @@\n+From 81740bc0e805b9b73bba0d7d3694300e609a6cf1 Mon Sep 17 00:00:00 2001\n+From: Phoenix616 <mail@moep.tv>\n+Date: Sat, 1 Feb 2020 16:50:39 +0100\n+Subject: [PATCH] Pillager patrol spawn settings and per player options\n+\n+This adds config options for defining the spawn chance, spawn delay and\n+spawn start day as well as toggles for handling the spawn delay and\n+start day per player. (Based on the time played statistic)\n+When not per player it will use the Vanilla mechanic of one delay per\n+world and the world age for the start day.\n+\n+diff --git a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java\n+index bce502181..3f7841471 100644\n+--- a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java\n++++ b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java\n+@@ -636,10 +636,21 @@ public class PaperWorldConfig {\n+     }\n+ \n+     public boolean disablePillagerPatrols = false;\n++    public double patrolSpawnChance = 0.2;\n++    public boolean patrolPerPlayerDelay = false;\n++    public int patrolDelay = 12000;\n++    public boolean patrolPerPlayerStart = false;\n++    public int patrolStartDay = 5;\n+     private void pillagerSettings() {\n+         disablePillagerPatrols = getBoolean(\"game-mechanics.disable-pillager-patrols\", disablePillagerPatrols);\n++        patrolSpawnChance = getDouble(\"game-mechanics.pillager-patrols.spawn-chance\", patrolSpawnChance);\n++        patrolPerPlayerDelay = getBoolean(\"game-mechanics.pillager-patrols.spawn-delay.per-player\", patrolPerPlayerDelay);\n++        patrolDelay = getInt(\"game-mechanics.pillager-patrols.spawn-delay.ticks\", patrolDelay);\n++        patrolPerPlayerStart = getBoolean(\"game-mechanics.pillager-patrols.start.per-player\", patrolPerPlayerStart);\n++        patrolStartDay = getInt(\"game-mechanics.pillager-patrols.start.day\", patrolStartDay);\n+     }\n+ \n++\n+     public boolean entitiesTargetWithFollowRange = false;\n+     private void entitiesTargetWithFollowRange() {\n+         entitiesTargetWithFollowRange = getBoolean(\"entities-target-with-follow-range\", entitiesTargetWithFollowRange);\n+diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java\n+index 15230a834..c49e48e57 100644\n+--- a/src/main/java/net/minecraft/server/EntityPlayer.java\n++++ b/src/main/java/net/minecraft/server/EntityPlayer.java\n+@@ -76,6 +76,7 @@ public class EntityPlayer extends EntityHuman implements ICrafting {\n+     public boolean viewingCredits;\n+     private int containerUpdateDelay; // Paper\n+     public long loginTime; // Paper\n++    public int patrolSpawnDelay; // Paper - per player patrol spawns\n+     // Paper start - cancellable death event\n+     public boolean queueHealthUpdatePacket = false;\n+     public net.minecraft.server.PacketPlayOutUpdateHealth queuedHealthUpdatePacket;\n+diff --git a/src/main/java/net/minecraft/server/MobSpawnerPatrol.java b/src/main/java/net/minecraft/server/MobSpawnerPatrol.java\n+index a0f582807..edca6d3ab 100644\n+--- a/src/main/java/net/minecraft/server/MobSpawnerPatrol.java\n++++ b/src/main/java/net/minecraft/server/MobSpawnerPatrol.java\n+@@ -4,12 +4,14 @@ import java.util.Random;\n+ \n+ public class MobSpawnerPatrol {\n+ \n++    private int getSpawnDelay() { return a; } // Paper - OBFHELPER\n++    private void setSpawnDelay(int spawnDelay) { this.a = spawnDelay; } // Paper - OBFHELPER\n+     private int a;\n+ \n+     public MobSpawnerPatrol() {}\n+ \n+     public int a(WorldServer worldserver, boolean flag, boolean flag1) {\n+-        if (worldserver.paperConfig.disablePillagerPatrols) return 0; // Paper\n++        if (worldserver.paperConfig.disablePillagerPatrols || worldserver.paperConfig.patrolSpawnChance == 0) return 0; // Paper\n+         if (!flag) {\n+             return 0;\n+         } else if (!worldserver.getGameRules().getBoolean(GameRules.DO_PATROL_SPAWNING)) {\n+@@ -17,23 +19,51 @@ public class MobSpawnerPatrol {\n+         } else {\n+             Random random = worldserver.random;\n+ \n+-            --this.a;\n+-            if (this.a > 0) {\n++            // Paper start - Patrol settings\n++            // Random player selection moved up for per player spawning and configuration\n++            int j = worldserver.getPlayers().size();\n++            if (j < 1) {\n+                 return 0;\n++            }\n++\n++            EntityPlayer entityhuman = worldserver.getPlayers().get(random.nextInt(j));\n++            if (entityhuman.isSpectator()) {\n++                return 0;\n++            }\n++\n++            int patrolSpawnDelay;\n++            if (worldserver.paperConfig.patrolPerPlayerDelay) {\n++                --entityhuman.patrolSpawnDelay;\n++                patrolSpawnDelay = entityhuman.patrolSpawnDelay;\n+             } else {\n+-                this.a += 12000 + random.nextInt(1200);\n+-                long i = worldserver.getDayTime() / 24000L;\n++                setSpawnDelay(getSpawnDelay() - 1);\n++                patrolSpawnDelay = getSpawnDelay();\n++            }\n++\n++            if (patrolSpawnDelay > 0) {\n++                return 0;\n++            } else {\n++                long days;\n++                if (worldserver.paperConfig.patrolPerPlayerStart) {\n++                    days = entityhuman.getStatisticManager().getStatisticValue(StatisticList.CUSTOM.get(StatisticList.PLAY_ONE_MINUTE)) / 24000L; // PLAY_ONE_MINUTE is actually counting in ticks, a misnomer by Mojang\n++                } else {\n++                    days = worldserver.getDayTime() / 24000L;\n++                }\n++                if (worldserver.paperConfig.patrolPerPlayerDelay) {\n++                    entityhuman.patrolSpawnDelay += worldserver.paperConfig.patrolDelay + random.nextInt(1200);\n++                } else {\n++                    setSpawnDelay(getSpawnDelay() + worldserver.paperConfig.patrolDelay + random.nextInt(1200));\n++                }\n+ \n+-                if (i >= 5L && worldserver.isDay()) {\n+-                    if (random.nextInt(5) != 0) {\n++                if (days >= worldserver.paperConfig.patrolStartDay && worldserver.isDay()) {\n++                    if (random.nextDouble() >= worldserver.paperConfig.patrolSpawnChance) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "218ac79141a73f26df49fe0a902839493b7563ef"}, "originalPosition": 117}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjM0MjY1", "url": "https://github.com/PaperMC/Paper/pull/2924#pullrequestreview-383234265", "createdAt": "2020-03-27T22:28:22Z", "commit": {"oid": "218ac79141a73f26df49fe0a902839493b7563ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1200, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}