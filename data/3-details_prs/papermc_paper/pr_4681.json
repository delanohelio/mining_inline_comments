{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5MDQ0Mjc3", "number": 4681, "title": "Avoid crashing clients when fishing loot is empty, Fixes #4235", "bodyText": "", "createdAt": "2020-10-23T15:29:14Z", "url": "https://github.com/PaperMC/Paper/pull/4681", "merged": true, "mergeCommit": {"oid": "0ac53efb30de4f07cc673c37d5a24b24b750395b"}, "closed": true, "closedAt": "2020-10-28T20:39:03Z", "author": {"login": "schoentoon"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVYZthgFqTUxNTc4MzU0MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXDkUsgFqTUxOTA1NTU0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NzgzNTQw", "url": "https://github.com/PaperMC/Paper/pull/4681#pullrequestreview-515783540", "createdAt": "2020-10-23T15:34:15Z", "commit": {"oid": "381eabd208383b58248aaa09d7c070901ae58ce0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNTozNDoxNlrOHnTEzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNTozNTowN1rOHnTG5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk2OTAzOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            +                    PlayerFishEvent playerFishEvent = new PlayerFishEvent((Player) entityhuman.getBukkitEntity(), entityitem != null ? entityitem.getBukkitEntity() : null, (FishHook) this.getBukkitEntity(), PlayerFishEvent.State.CAUGHT_FISH);\n          \n          \n            \n            +                    PlayerFishEvent playerFishEvent = new PlayerFishEvent((Player) entityhuman.getBukkitEntity(), entityitem != null ? entityitem.getBukkitEntity() : null, (FishHook) this.getBukkitEntity(), PlayerFishEvent.State.CAUGHT_FISH); // Paper - entityitem may be null", "url": "https://github.com/PaperMC/Paper/pull/4681#discussion_r510969038", "createdAt": "2020-10-23T15:34:16Z", "author": {"login": "Proximyst"}, "path": "Spigot-Server-Patches/0594-Avoid-error-bubbling-up-when-item-stack-is-empty-in-.patch", "diffHunk": "@@ -0,0 +1,46 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Toon Schoenmakers <nighteyes1993@gmail.com>\n+Date: Fri, 23 Oct 2020 15:01:44 +0200\n+Subject: [PATCH] Avoid error bubbling up when item stack is empty in fishing\n+ loot\n+\n+This can realistically only happen if there's custom loot active on fishing\n+which can return 0 items. This would disconnect the player who's fishing.\n+\n+diff --git a/src/main/java/net/minecraft/server/EntityFishingHook.java b/src/main/java/net/minecraft/server/EntityFishingHook.java\n+index b6cace72ab2f3389408a5e528981fcff3b511180..01c3737389f5b921de0b81eb09a0e5601151d978 100644\n+--- a/src/main/java/net/minecraft/server/EntityFishingHook.java\n++++ b/src/main/java/net/minecraft/server/EntityFishingHook.java\n+@@ -433,9 +433,15 @@ public class EntityFishingHook extends IProjectile {\n+ \n+                 while (iterator.hasNext()) {\n+                     ItemStack itemstack1 = (ItemStack) iterator.next();\n+-                    EntityItem entityitem = new EntityItem(this.world, this.locX(), this.locY(), this.locZ(), itemstack1);\n++                    // Paper start, new EntityItem would throw if for whatever reason (mostly shitty datapacks) the itemstack1 turns out to be empty\n++                    // if the item stack is empty we instead just have our entityitem as null\n++                    EntityItem entityitem = null;\n++                    if (!itemstack1.isEmpty()) {\n++                        entityitem = new EntityItem(this.world, this.locX(), this.locY(), this.locZ(), itemstack1);\n++                    }\n++                    // Paper end\n+                     // CraftBukkit start\n+-                    PlayerFishEvent playerFishEvent = new PlayerFishEvent((Player) entityhuman.getBukkitEntity(), entityitem.getBukkitEntity(), (FishHook) this.getBukkitEntity(), PlayerFishEvent.State.CAUGHT_FISH);\n++                    PlayerFishEvent playerFishEvent = new PlayerFishEvent((Player) entityhuman.getBukkitEntity(), entityitem != null ? entityitem.getBukkitEntity() : null, (FishHook) this.getBukkitEntity(), PlayerFishEvent.State.CAUGHT_FISH);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "381eabd208383b58248aaa09d7c070901ae58ce0"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk2OTU3Mw==", "bodyText": "Debug", "url": "https://github.com/PaperMC/Paper/pull/4681#discussion_r510969573", "createdAt": "2020-10-23T15:35:07Z", "author": {"login": "Proximyst"}, "path": "Spigot-Server-Patches/0594-Don-t-crash-on-negative-item-count-for-fishing-loot.patch", "diffHunk": "@@ -0,0 +1,18 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Toon Schoenmakers <nighteyes1993@gmail.com>\n+Date: Fri, 23 Oct 2020 15:01:44 +0200\n+Subject: [PATCH] Don't crash on negative item count for fishing loot\n+\n+\n+diff --git a/src/main/java/net/minecraft/server/EntityFishingHook.java b/src/main/java/net/minecraft/server/EntityFishingHook.java\n+index b6cace72ab2f3389408a5e528981fcff3b511180..f056192d513e27716136eaafe23d087e3fe42668 100644\n+--- a/src/main/java/net/minecraft/server/EntityFishingHook.java\n++++ b/src/main/java/net/minecraft/server/EntityFishingHook.java\n+@@ -433,6 +433,7 @@ public class EntityFishingHook extends IProjectile {\n+ \n+                 while (iterator.hasNext()) {\n+                     ItemStack itemstack1 = (ItemStack) iterator.next();\n++                    System.err.println(\"getCount() = \" + itemstack1.getCount());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "381eabd208383b58248aaa09d7c070901ae58ce0"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82a09927f546169f8686109c4e8fd2f115c39620", "author": {"user": {"login": "schoentoon", "name": "Toon Schoenmakers"}}, "url": "https://github.com/PaperMC/Paper/commit/82a09927f546169f8686109c4e8fd2f115c39620", "committedDate": "2020-10-23T15:46:52Z", "message": "Avoid error bubbling up when item stack is empty in fishing loot\n\nThis would fix #4235"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "381eabd208383b58248aaa09d7c070901ae58ce0", "author": {"user": {"login": "schoentoon", "name": "Toon Schoenmakers"}}, "url": "https://github.com/PaperMC/Paper/commit/381eabd208383b58248aaa09d7c070901ae58ce0", "committedDate": "2020-10-23T15:18:35Z", "message": "Avoid error bubbling up when item stack is empty in fishing loot\n\nThis would fix #4235"}, "afterCommit": {"oid": "82a09927f546169f8686109c4e8fd2f115c39620", "author": {"user": {"login": "schoentoon", "name": "Toon Schoenmakers"}}, "url": "https://github.com/PaperMC/Paper/commit/82a09927f546169f8686109c4e8fd2f115c39620", "committedDate": "2020-10-23T15:46:52Z", "message": "Avoid error bubbling up when item stack is empty in fishing loot\n\nThis would fix #4235"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MjY5NTk0", "url": "https://github.com/PaperMC/Paper/pull/4681#pullrequestreview-516269594", "createdAt": "2020-10-24T11:11:09Z", "commit": {"oid": "82a09927f546169f8686109c4e8fd2f115c39620"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MDU1NTQ2", "url": "https://github.com/PaperMC/Paper/pull/4681#pullrequestreview-519055546", "createdAt": "2020-10-28T20:26:54Z", "commit": {"oid": "82a09927f546169f8686109c4e8fd2f115c39620"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1414, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}