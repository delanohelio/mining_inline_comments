{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxMDM2OTY5", "number": 4766, "title": "fixed kick event leave message", "bodyText": "closes #4031", "createdAt": "2020-11-14T17:37:57Z", "url": "https://github.com/PaperMC/Paper/pull/4766", "merged": true, "mergeCommit": {"oid": "871f30038e07e9d290f706724f3b3bb0423942e0"}, "closed": true, "closedAt": "2021-07-09T19:03:28Z", "author": {"login": "Machine-Maker"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcfdz6AFqTUzMDU5MzMxNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABeoyfi0ABqjUwMDE4MTY5NzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTkzMzE2", "url": "https://github.com/PaperMC/Paper/pull/4766#pullrequestreview-530593316", "createdAt": "2020-11-14T17:45:19Z", "commit": {"oid": "e93de5a037784a55cf818865028564c63d6c1a58"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQxNzo0NToxOVrOHzMggw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQxNzo0NToyNFrOHzMgiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NDM1NQ==", "bodyText": "Move this up to the method declaration", "url": "https://github.com/PaperMC/Paper/pull/4766#discussion_r523444355", "createdAt": "2020-11-14T17:45:19Z", "author": {"login": "Proximyst"}, "path": "Spigot-Server-Patches/0599-Fixed-kick-event-leave-message-not-being-sent.patch", "diffHunk": "@@ -0,0 +1,69 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Jake Potrebic <jake.m.potrebic@gmail.com>\n+Date: Sat, 14 Nov 2020 09:36:43 -0800\n+Subject: [PATCH] Fixed kick event leave message not being sent\n+\n+\n+diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java\n+index 563ae7355f4f4645d21f2fbd494a5b5656c5e664..daff4bd095ee2ab1b6462c0d8258503da92c013a 100644\n+--- a/src/main/java/net/minecraft/server/PlayerConnection.java\n++++ b/src/main/java/net/minecraft/server/PlayerConnection.java\n+@@ -303,7 +303,7 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+         this.networkManager.sendPacket(new PacketPlayOutKickDisconnect(ichatbasecomponent), (future) -> {\n+             this.networkManager.close(ichatbasecomponent);\n+         });\n+-        this.a(ichatbasecomponent); // CraftBukkit - fire quit instantly\n++        this.onAllDisconnect(ichatbasecomponent, event.getLeaveMessage()); // CraftBukkit - fire quit instantly // Paper\n+         this.networkManager.stopReading();\n+         MinecraftServer minecraftserver = this.minecraftServer;\n+         NetworkManager networkmanager = this.networkManager;\n+@@ -1658,6 +1658,11 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+ \n+     @Override\n+     public void a(IChatBaseComponent ichatbasecomponent) {\n++        // Paper start\n++        this.onAllDisconnect(ichatbasecomponent, this.minecraftServer.getPlayerList().disconnect(this.player, \"\\u00A7e\" + this.player.getName() + \" left the game\"));\n++    }\n++\n++    private void onAllDisconnect(IChatBaseComponent ichatbasecomponent, String quitMessage) {\n+         // CraftBukkit start - Rarely it would send a disconnect line twice\n+         if (this.processedDisconnect) {\n+             return;\n+@@ -1673,7 +1678,6 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+         */\n+ \n+         this.player.p();\n+-        String quitMessage = this.minecraftServer.getPlayerList().disconnect(this.player);\n+         if ((quitMessage != null) && (quitMessage.length() > 0)) {\n+             this.minecraftServer.getPlayerList().sendMessage(CraftChatMessage.fromString(quitMessage));\n+         }\n+@@ -1690,6 +1694,7 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+         }\n+ \n+     }\n++    // Paper end", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e93de5a037784a55cf818865028564c63d6c1a58"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NDM2MA==", "bodyText": "Comment this", "url": "https://github.com/PaperMC/Paper/pull/4766#discussion_r523444360", "createdAt": "2020-11-14T17:45:24Z", "author": {"login": "Proximyst"}, "path": "Spigot-Server-Patches/0599-Fixed-kick-event-leave-message-not-being-sent.patch", "diffHunk": "@@ -0,0 +1,69 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Jake Potrebic <jake.m.potrebic@gmail.com>\n+Date: Sat, 14 Nov 2020 09:36:43 -0800\n+Subject: [PATCH] Fixed kick event leave message not being sent\n+\n+\n+diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java\n+index 563ae7355f4f4645d21f2fbd494a5b5656c5e664..daff4bd095ee2ab1b6462c0d8258503da92c013a 100644\n+--- a/src/main/java/net/minecraft/server/PlayerConnection.java\n++++ b/src/main/java/net/minecraft/server/PlayerConnection.java\n+@@ -303,7 +303,7 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+         this.networkManager.sendPacket(new PacketPlayOutKickDisconnect(ichatbasecomponent), (future) -> {\n+             this.networkManager.close(ichatbasecomponent);\n+         });\n+-        this.a(ichatbasecomponent); // CraftBukkit - fire quit instantly\n++        this.onAllDisconnect(ichatbasecomponent, event.getLeaveMessage()); // CraftBukkit - fire quit instantly // Paper\n+         this.networkManager.stopReading();\n+         MinecraftServer minecraftserver = this.minecraftServer;\n+         NetworkManager networkmanager = this.networkManager;\n+@@ -1658,6 +1658,11 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+ \n+     @Override\n+     public void a(IChatBaseComponent ichatbasecomponent) {\n++        // Paper start\n++        this.onAllDisconnect(ichatbasecomponent, this.minecraftServer.getPlayerList().disconnect(this.player, \"\\u00A7e\" + this.player.getName() + \" left the game\"));\n++    }\n++\n++    private void onAllDisconnect(IChatBaseComponent ichatbasecomponent, String quitMessage) {\n+         // CraftBukkit start - Rarely it would send a disconnect line twice\n+         if (this.processedDisconnect) {\n+             return;\n+@@ -1673,7 +1678,6 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+         */\n+ \n+         this.player.p();\n+-        String quitMessage = this.minecraftServer.getPlayerList().disconnect(this.player);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e93de5a037784a55cf818865028564c63d6c1a58"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTk3MTAz", "url": "https://github.com/PaperMC/Paper/pull/4766#pullrequestreview-530597103", "createdAt": "2020-11-14T18:50:09Z", "commit": {"oid": "23f0dfa66cc9df25c55747130315043d24e30913"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQxODo1MDowOVrOHzM35g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQxODo1MDowOVrOHzM35g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ1MDM0Mg==", "bodyText": "I meant move this under the declaration, i.e.:\nprivate void onAllDisconnect(IChatBaseComponent ichatbasecomponent, String quitMessage) {\n    // Paper end", "url": "https://github.com/PaperMC/Paper/pull/4766#discussion_r523450342", "createdAt": "2020-11-14T18:50:09Z", "author": {"login": "Proximyst"}, "path": "Spigot-Server-Patches/0599-Fixed-kick-event-leave-message-not-being-sent.patch", "diffHunk": "@@ -0,0 +1,71 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Jake Potrebic <jake.m.potrebic@gmail.com>\n+Date: Sat, 14 Nov 2020 09:36:43 -0800\n+Subject: [PATCH] Fixed kick event leave message not being sent\n+\n+\n+diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java\n+index 563ae7355f4f4645d21f2fbd494a5b5656c5e664..7b44f231f03d41d83c7680cfa9efc729e8d646ed 100644\n+--- a/src/main/java/net/minecraft/server/PlayerConnection.java\n++++ b/src/main/java/net/minecraft/server/PlayerConnection.java\n+@@ -303,7 +303,7 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+         this.networkManager.sendPacket(new PacketPlayOutKickDisconnect(ichatbasecomponent), (future) -> {\n+             this.networkManager.close(ichatbasecomponent);\n+         });\n+-        this.a(ichatbasecomponent); // CraftBukkit - fire quit instantly\n++        this.onAllDisconnect(ichatbasecomponent, event.getLeaveMessage()); // CraftBukkit - fire quit instantly // Paper\n+         this.networkManager.stopReading();\n+         MinecraftServer minecraftserver = this.minecraftServer;\n+         NetworkManager networkmanager = this.networkManager;\n+@@ -1658,6 +1658,11 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+ \n+     @Override\n+     public void a(IChatBaseComponent ichatbasecomponent) {\n++        // Paper start\n++        this.onAllDisconnect(ichatbasecomponent, this.minecraftServer.getPlayerList().disconnect(this.player, \"\\u00A7e\" + this.player.getName() + \" left the game\"));\n++    }\n++\n++    private void onAllDisconnect(IChatBaseComponent ichatbasecomponent, String quitMessage) {\n+         // CraftBukkit start - Rarely it would send a disconnect line twice\n+         if (this.processedDisconnect) {\n+             return;\n+@@ -1673,7 +1678,7 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+         */\n+ \n+         this.player.p();\n+-        String quitMessage = this.minecraftServer.getPlayerList().disconnect(this.player);\n++        // String quitMessage = this.minecraftServer.getPlayerList().disconnect(this.player); // Paper\n+         if ((quitMessage != null) && (quitMessage.length() > 0)) {\n+             this.minecraftServer.getPlayerList().sendMessage(CraftChatMessage.fromString(quitMessage));\n+         }\n+@@ -1688,7 +1693,7 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+             PlayerConnection.LOGGER.info(\"Stopping singleplayer server as player logged out\");\n+             this.minecraftServer.safeShutdown(false);\n+         }\n+-\n++        // Paper end", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23f0dfa66cc9df25c55747130315043d24e30913"}, "originalPosition": 46}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2f7e9c813a518f42e02a621584988991bc700c8d", "author": {"user": {"login": "Machine-Maker", "name": "Jake Potrebic"}}, "url": "https://github.com/PaperMC/Paper/commit/2f7e9c813a518f42e02a621584988991bc700c8d", "committedDate": "2020-11-14T21:20:09Z", "message": "moved paper end comment"}, "afterCommit": {"oid": "3b548b4187cae5b4554260d3c7aee99d571416c3", "author": {"user": {"login": "Machine-Maker", "name": "Jake Potrebic"}}, "url": "https://github.com/PaperMC/Paper/commit/3b548b4187cae5b4554260d3c7aee99d571416c3", "committedDate": "2020-11-14T22:04:33Z", "message": "adjusted for quit reason"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b548b4187cae5b4554260d3c7aee99d571416c3", "author": {"user": {"login": "Machine-Maker", "name": "Jake Potrebic"}}, "url": "https://github.com/PaperMC/Paper/commit/3b548b4187cae5b4554260d3c7aee99d571416c3", "committedDate": "2020-11-14T22:04:33Z", "message": "adjusted for quit reason"}, "afterCommit": {"oid": "7adf8a472b6b837c8b53ceec0ff5fc06dd956028", "author": {"user": {"login": "Machine-Maker", "name": "Jake Potrebic"}}, "url": "https://github.com/PaperMC/Paper/commit/7adf8a472b6b837c8b53ceec0ff5fc06dd956028", "committedDate": "2021-03-21T23:13:13Z", "message": "fixed kick event leave message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7adf8a472b6b837c8b53ceec0ff5fc06dd956028", "author": {"user": {"login": "Machine-Maker", "name": "Jake Potrebic"}}, "url": "https://github.com/PaperMC/Paper/commit/7adf8a472b6b837c8b53ceec0ff5fc06dd956028", "committedDate": "2021-03-21T23:13:13Z", "message": "fixed kick event leave message"}, "afterCommit": {"oid": "8ed7fae55949b56a3e43834d2878f2648275c207", "author": {"user": {"login": "Machine-Maker", "name": "Jake Potrebic"}}, "url": "https://github.com/PaperMC/Paper/commit/8ed7fae55949b56a3e43834d2878f2648275c207", "committedDate": "2021-05-19T03:27:34Z", "message": "fixed kick event leave message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ed7fae55949b56a3e43834d2878f2648275c207", "author": {"user": {"login": "Machine-Maker", "name": "Jake Potrebic"}}, "url": "https://github.com/PaperMC/Paper/commit/8ed7fae55949b56a3e43834d2878f2648275c207", "committedDate": "2021-05-19T03:27:34Z", "message": "fixed kick event leave message"}, "afterCommit": {"oid": "1e1231124e1fcbe772da4361033572a2f60bf4cf", "author": {"user": {"login": "Machine-Maker", "name": "Jake Potrebic"}}, "url": "https://github.com/PaperMC/Paper/commit/1e1231124e1fcbe772da4361033572a2f60bf4cf", "committedDate": "2021-05-24T05:49:26Z", "message": "fixed kick event leave message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e1231124e1fcbe772da4361033572a2f60bf4cf", "author": {"user": {"login": "Machine-Maker", "name": "Jake Potrebic"}}, "url": "https://github.com/PaperMC/Paper/commit/1e1231124e1fcbe772da4361033572a2f60bf4cf", "committedDate": "2021-05-24T05:49:26Z", "message": "fixed kick event leave message"}, "afterCommit": {"oid": "c809a41fa47a551375ad0817227dc64a08540100", "author": {"user": {"login": "Machine-Maker", "name": "Jake Potrebic"}}, "url": "https://github.com/PaperMC/Paper/commit/c809a41fa47a551375ad0817227dc64a08540100", "committedDate": "2021-07-07T23:20:55Z", "message": "Fixes kick event leave message not being sent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzAxNTIyNDMy", "url": "https://github.com/PaperMC/Paper/pull/4766#pullrequestreview-701522432", "createdAt": "2021-07-07T23:25:34Z", "commit": {"oid": "c809a41fa47a551375ad0817227dc64a08540100"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzAyNzE0OTg3", "url": "https://github.com/PaperMC/Paper/pull/4766#pullrequestreview-702714987", "createdAt": "2021-07-09T06:17:40Z", "commit": {"oid": "c809a41fa47a551375ad0817227dc64a08540100"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8159e38a78075a6127da21a32ea836728fde407", "author": {"user": {"login": "Machine-Maker", "name": "Jake Potrebic"}}, "url": "https://github.com/PaperMC/Paper/commit/e8159e38a78075a6127da21a32ea836728fde407", "committedDate": "2021-07-09T18:53:33Z", "message": "Fixes kick event leave message not being sent"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c809a41fa47a551375ad0817227dc64a08540100", "author": {"user": {"login": "Machine-Maker", "name": "Jake Potrebic"}}, "url": "https://github.com/PaperMC/Paper/commit/c809a41fa47a551375ad0817227dc64a08540100", "committedDate": "2021-07-07T23:20:55Z", "message": "Fixes kick event leave message not being sent"}, "afterCommit": {"oid": "e8159e38a78075a6127da21a32ea836728fde407", "author": {"user": {"login": "Machine-Maker", "name": "Jake Potrebic"}}, "url": "https://github.com/PaperMC/Paper/commit/e8159e38a78075a6127da21a32ea836728fde407", "committedDate": "2021-07-09T18:53:33Z", "message": "Fixes kick event leave message not being sent"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1480, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}