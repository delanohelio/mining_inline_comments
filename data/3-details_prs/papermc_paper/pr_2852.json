{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyMTgxNzcz", "number": 2852, "title": "Seed based feature search (Fixes #2312)", "bodyText": "This fixes the issue where the server will load surrounding chunks up to a radius of 100 chunks in order to search for features e.g. when running the /locate command or for treasure maps (issue #2312).\nThis is done by using the same seed checking functionality that is used by the server when generating these features before actually attempting to load the chunk to check if a feature is available in it.\nWhile the chunk loading itself will still be done on the main thread it should ideally only ever load a single chunk so this will be more compatible with existing usages of the feature search both in the server and the API. Theoretically this could be amended to also provide API methods to toggle this or to use the async chunk loading API but async chunk loading would require larger changes that require more looking into how to integrate into the rest of the server without breaking existing mechanics.\nThe only downside of this is that it breaks once the seed or generator changes but this should usually not happen. A config option to disable this improvement is added though in case that should ever be necessary.", "createdAt": "2020-01-13T15:37:01Z", "url": "https://github.com/PaperMC/Paper/pull/2852", "merged": true, "mergeCommit": {"oid": "e0da6d4b81114315f4a09c6202560df1c86f8eb2"}, "closed": true, "closedAt": "2020-01-24T19:07:15Z", "author": {"login": "Phoenix616"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6A6SSAFqTM0MjA1ODEyMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9g3xDgBqjI5Nzc2NzE3NDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMDU4MTIw", "url": "https://github.com/PaperMC/Paper/pull/2852#pullrequestreview-342058120", "createdAt": "2020-01-13T18:46:11Z", "commit": {"oid": "4d6c1935fd43820cf987ff308432f7ed2fa27a0b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxODo0NjoxMlrOFdAxvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxODo0NjoxMlrOFdAxvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk2NTc1Ng==", "bodyText": "Override should be moved to next line for effective use of the OPFHELPER.", "url": "https://github.com/PaperMC/Paper/pull/2852#discussion_r365965756", "createdAt": "2020-01-13T18:46:12Z", "author": {"login": "Black-Hole"}, "path": "Spigot-Server-Patches/0424-Seed-based-feature-search.patch", "diffHunk": "@@ -0,0 +1,110 @@\n+From 55f062af7886e33bc8945d0b3c97ea7ebcf0f4cd Mon Sep 17 00:00:00 2001\n+From: Phoenix616 <mail@moep.tv>\n+Date: Mon, 13 Jan 2020 15:40:32 +0100\n+Subject: [PATCH] Seed based feature search\n+\n+This fixes the issue where the server will load surrounding chunks up to\n+a radius of 100 chunks in order to search for features e.g. when running\n+the /locate command or for treasure maps (issue #2312).\n+This is done by using the same seed checking functionality that is used\n+by the server when generating these features before actually attempting\n+to load the chunk to check if a feature is available in it.\n+\n+The only downside of this is that it breaks once the seed or generator\n+changes but this should usually not happen. A config option to disable\n+this improvement is added though in case that should ever be necessary.\n+\n+diff --git a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java\n+index b309fdaba..0b86502eb 100644\n+--- a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java\n++++ b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java\n+@@ -357,6 +357,12 @@ public class PaperWorldConfig {\n+         }\n+     }\n+ \n++    public boolean seedBasedFeatureSearch = true;\n++    private void seedBasedFeatureSearch() {\n++        seedBasedFeatureSearch = getBoolean(\"seed-based-feature-search\", seedBasedFeatureSearch);\n++        log(\"Feature search is based on seed: \" + seedBasedFeatureSearch);\n++    }\n++\n+     public int maxCollisionsPerEntity;\n+     private void maxEntityCollision() {\n+         maxCollisionsPerEntity = getInt( \"max-entity-collisions\", this.spigotConfig.getInt(\"max-entity-collisions\", 8) );\n+diff --git a/src/main/java/net/minecraft/server/BiomeManager.java b/src/main/java/net/minecraft/server/BiomeManager.java\n+index e96f544f1..68423645d 100644\n+--- a/src/main/java/net/minecraft/server/BiomeManager.java\n++++ b/src/main/java/net/minecraft/server/BiomeManager.java\n+@@ -12,10 +12,12 @@ public class BiomeManager {\n+         this.c = genlayerzoomer;\n+     }\n+ \n++    public BiomeManager withProvider(WorldChunkManager worldchunkmanager) { return a(worldchunkmanager); } // Paper - OBFHELPER\n+     public BiomeManager a(WorldChunkManager worldchunkmanager) {\n+         return new BiomeManager(worldchunkmanager, this.b, this.c);\n+     }\n+ \n++    public BiomeBase getBiome(BlockPosition blockposition) { return a(blockposition); } // Paper - OBFHELPER\n+     public BiomeBase a(BlockPosition blockposition) {\n+         return this.c.a(this.b, blockposition.getX(), blockposition.getY(), blockposition.getZ(), this.a);\n+     }\n+diff --git a/src/main/java/net/minecraft/server/ChunkCoordIntPair.java b/src/main/java/net/minecraft/server/ChunkCoordIntPair.java\n+index f2a19acd8..09f1308b0 100644\n+--- a/src/main/java/net/minecraft/server/ChunkCoordIntPair.java\n++++ b/src/main/java/net/minecraft/server/ChunkCoordIntPair.java\n+@@ -64,10 +64,12 @@ public class ChunkCoordIntPair {\n+         }\n+     }\n+ \n++    public int getBlockX() { return d(); } // Paper - OBFHELPER\n+     public int d() {\n+         return this.x << 4;\n+     }\n+ \n++    public int getBlockZ() { return e(); } // Paper - OBFHELPER\n+     public int e() {\n+         return this.z << 4;\n+     }\n+diff --git a/src/main/java/net/minecraft/server/StructureGenerator.java b/src/main/java/net/minecraft/server/StructureGenerator.java\n+index e8ce2ecf2..acfe732af 100644\n+--- a/src/main/java/net/minecraft/server/StructureGenerator.java\n++++ b/src/main/java/net/minecraft/server/StructureGenerator.java\n+@@ -109,6 +109,15 @@ public abstract class StructureGenerator<C extends WorldGenFeatureConfiguration>\n+                             if (flag1 || flag2) {\n+                                 ChunkCoordIntPair chunkcoordintpair = this.a(chunkgenerator, seededrandom, j, k, i1, j1);\n+                                 if (!world.getWorldBorder().isChunkInBounds(chunkcoordintpair.x, chunkcoordintpair.z)) { continue; } // Paper\n++                                // Paper start - seed based feature search\n++                                if (world.paperConfig.seedBasedFeatureSearch) {\n++                                    BiomeManager biomeManager = world.getBiomeManager().withProvider(chunkgenerator.getWorldChunkManager());\n++                                    BiomeBase biomeBase = biomeManager.getBiome(new BlockPosition(chunkcoordintpair.getBlockX() + 9, 0, chunkcoordintpair.getBlockZ() + 9));\n++                                    if (!shouldGenerate(biomeManager, chunkgenerator, seededrandom, chunkcoordintpair.x, chunkcoordintpair.z, biomeBase)) {\n++                                        continue;\n++                                    }\n++                                }\n++                                // Paper end\n+                                 StructureStart structurestart = world.getChunkAt(chunkcoordintpair.x, chunkcoordintpair.z, ChunkStatus.STRUCTURE_STARTS).a(this.b());\n+ \n+                                 if (structurestart != null && structurestart.e()) {\n+@@ -165,6 +174,7 @@ public abstract class StructureGenerator<C extends WorldGenFeatureConfiguration>\n+         return new ChunkCoordIntPair(i + k, j + l);\n+     }\n+ \n++    public boolean shouldGenerate(BiomeManager biomemanager, ChunkGenerator<?> chunkgenerator, Random random, int chunkX, int chunkZ, BiomeBase biomebase) { return a(biomemanager, chunkgenerator, random, chunkX, chunkZ, biomebase); } // Paper - OBFHELPER\n+     public abstract boolean a(BiomeManager biomemanager, ChunkGenerator<?> chunkgenerator, Random random, int i, int j, BiomeBase biomebase);\n+ \n+     public abstract StructureGenerator.a a();\n+diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java\n+index 5460ace8f..999338cfc 100644\n+--- a/src/main/java/net/minecraft/server/World.java\n++++ b/src/main/java/net/minecraft/server/World.java\n+@@ -1584,6 +1584,7 @@ public abstract class World implements GeneratorAccess, AutoCloseable {\n+         return this.methodProfiler;\n+     }\n+ \n++    public BiomeManager getBiomeManager() { return d(); } // Paper - OBFHELPER\n+     @Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d6c1935fd43820cf987ff308432f7ed2fa27a0b"}, "originalPosition": 105}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NTc5MTYx", "url": "https://github.com/PaperMC/Paper/pull/2852#pullrequestreview-347579161", "createdAt": "2020-01-23T20:16:28Z", "commit": {"oid": "8de564672c0f2960d2e3f8fecc63d002cb908e37"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QyMDoxNjoyOVrOFhLUtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QyMDoxNjoyOVrOFhLUtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMzMjg1NQ==", "bodyText": "We need to synchronize on the StructureGenerator if we're generating a Stronghold due to some concurrency concerns here, but otherwise, this looks fine following the existing server logic here", "url": "https://github.com/PaperMC/Paper/pull/2852#discussion_r370332855", "createdAt": "2020-01-23T20:16:29Z", "author": {"login": "electronicboy"}, "path": "Spigot-Server-Patches/0424-Seed-based-feature-search.patch", "diffHunk": "@@ -0,0 +1,113 @@\n+From 53a8c63edaf854bf9daad63d9d3426541e6069d8 Mon Sep 17 00:00:00 2001\n+From: Phoenix616 <mail@moep.tv>\n+Date: Mon, 13 Jan 2020 15:40:32 +0100\n+Subject: [PATCH] Seed based feature search\n+\n+This fixes the issue where the server will load surrounding chunks up to\n+a radius of 100 chunks in order to search for features e.g. when running\n+the /locate command or for treasure maps (issue #2312).\n+This is done by using the same seed checking functionality that is used\n+by the server when generating these features before actually attempting\n+to load the chunk to check if a feature is available in it.\n+\n+The only downside of this is that it breaks once the seed or generator\n+changes but this should usually not happen. A config option to disable\n+this improvement is added though in case that should ever be necessary.\n+\n+diff --git a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java\n+index b309fdaba..0b86502eb 100644\n+--- a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java\n++++ b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java\n+@@ -357,6 +357,12 @@ public class PaperWorldConfig {\n+         }\n+     }\n+ \n++    public boolean seedBasedFeatureSearch = true;\n++    private void seedBasedFeatureSearch() {\n++        seedBasedFeatureSearch = getBoolean(\"seed-based-feature-search\", seedBasedFeatureSearch);\n++        log(\"Feature search is based on seed: \" + seedBasedFeatureSearch);\n++    }\n++\n+     public int maxCollisionsPerEntity;\n+     private void maxEntityCollision() {\n+         maxCollisionsPerEntity = getInt( \"max-entity-collisions\", this.spigotConfig.getInt(\"max-entity-collisions\", 8) );\n+diff --git a/src/main/java/net/minecraft/server/BiomeManager.java b/src/main/java/net/minecraft/server/BiomeManager.java\n+index e96f544f1..68423645d 100644\n+--- a/src/main/java/net/minecraft/server/BiomeManager.java\n++++ b/src/main/java/net/minecraft/server/BiomeManager.java\n+@@ -12,10 +12,12 @@ public class BiomeManager {\n+         this.c = genlayerzoomer;\n+     }\n+ \n++    public BiomeManager withProvider(WorldChunkManager worldchunkmanager) { return a(worldchunkmanager); } // Paper - OBFHELPER\n+     public BiomeManager a(WorldChunkManager worldchunkmanager) {\n+         return new BiomeManager(worldchunkmanager, this.b, this.c);\n+     }\n+ \n++    public BiomeBase getBiome(BlockPosition blockposition) { return a(blockposition); } // Paper - OBFHELPER\n+     public BiomeBase a(BlockPosition blockposition) {\n+         return this.c.a(this.b, blockposition.getX(), blockposition.getY(), blockposition.getZ(), this.a);\n+     }\n+diff --git a/src/main/java/net/minecraft/server/ChunkCoordIntPair.java b/src/main/java/net/minecraft/server/ChunkCoordIntPair.java\n+index f2a19acd8..09f1308b0 100644\n+--- a/src/main/java/net/minecraft/server/ChunkCoordIntPair.java\n++++ b/src/main/java/net/minecraft/server/ChunkCoordIntPair.java\n+@@ -64,10 +64,12 @@ public class ChunkCoordIntPair {\n+         }\n+     }\n+ \n++    public int getBlockX() { return d(); } // Paper - OBFHELPER\n+     public int d() {\n+         return this.x << 4;\n+     }\n+ \n++    public int getBlockZ() { return e(); } // Paper - OBFHELPER\n+     public int e() {\n+         return this.z << 4;\n+     }\n+diff --git a/src/main/java/net/minecraft/server/StructureGenerator.java b/src/main/java/net/minecraft/server/StructureGenerator.java\n+index e8ce2ecf2..acfe732af 100644\n+--- a/src/main/java/net/minecraft/server/StructureGenerator.java\n++++ b/src/main/java/net/minecraft/server/StructureGenerator.java\n+@@ -109,6 +109,15 @@ public abstract class StructureGenerator<C extends WorldGenFeatureConfiguration>\n+                             if (flag1 || flag2) {\n+                                 ChunkCoordIntPair chunkcoordintpair = this.a(chunkgenerator, seededrandom, j, k, i1, j1);\n+                                 if (!world.getWorldBorder().isChunkInBounds(chunkcoordintpair.x, chunkcoordintpair.z)) { continue; } // Paper\n++                                // Paper start - seed based feature search\n++                                if (world.paperConfig.seedBasedFeatureSearch) {\n++                                    BiomeManager biomeManager = world.getBiomeManager().withProvider(chunkgenerator.getWorldChunkManager());\n++                                    BiomeBase biomeBase = biomeManager.getBiome(new BlockPosition(chunkcoordintpair.getBlockX() + 9, 0, chunkcoordintpair.getBlockZ() + 9));\n++                                    if (!shouldGenerate(biomeManager, chunkgenerator, seededrandom, chunkcoordintpair.x, chunkcoordintpair.z, biomeBase)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8de564672c0f2960d2e3f8fecc63d002cb908e37"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NjcyNjk2", "url": "https://github.com/PaperMC/Paper/pull/2852#pullrequestreview-347672696", "createdAt": "2020-01-23T23:19:47Z", "commit": {"oid": "8de564672c0f2960d2e3f8fecc63d002cb908e37"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NzExNTgy", "url": "https://github.com/PaperMC/Paper/pull/2852#pullrequestreview-347711582", "createdAt": "2020-01-24T01:29:42Z", "commit": {"oid": "8de564672c0f2960d2e3f8fecc63d002cb908e37"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6313ef0202a70aaeae1135346a1fd5bd5a825ff", "author": {"user": {"login": "Phoenix616", "name": "Max Lee"}}, "url": "https://github.com/PaperMC/Paper/commit/b6313ef0202a70aaeae1135346a1fd5bd5a825ff", "committedDate": "2020-01-24T15:16:52Z", "message": "Seed based feature search (Fixes #2312)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df453c5f5aa10d3cc80328629cc7e30615538ed1", "author": {"user": {"login": "Phoenix616", "name": "Max Lee"}}, "url": "https://github.com/PaperMC/Paper/commit/df453c5f5aa10d3cc80328629cc7e30615538ed1", "committedDate": "2020-01-24T15:16:52Z", "message": "Improve obfuscation helper to produce conflict when obfuscation changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cd904acb5a781c2635086fdfc22442eb69728ef", "author": {"user": {"login": "Phoenix616", "name": "Max Lee"}}, "url": "https://github.com/PaperMC/Paper/commit/9cd904acb5a781c2635086fdfc22442eb69728ef", "committedDate": "2020-01-24T15:38:35Z", "message": "Rebuild"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8de564672c0f2960d2e3f8fecc63d002cb908e37", "author": {"user": {"login": "Phoenix616", "name": "Max Lee"}}, "url": "https://github.com/PaperMC/Paper/commit/8de564672c0f2960d2e3f8fecc63d002cb908e37", "committedDate": "2020-01-13T22:28:14Z", "message": "Improve obfuscation helper to produce conflict when obfuscation changes"}, "afterCommit": {"oid": "9cd904acb5a781c2635086fdfc22442eb69728ef", "author": {"user": {"login": "Phoenix616", "name": "Max Lee"}}, "url": "https://github.com/PaperMC/Paper/commit/9cd904acb5a781c2635086fdfc22442eb69728ef", "committedDate": "2020-01-24T15:38:35Z", "message": "Rebuild"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1321, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}