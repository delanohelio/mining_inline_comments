{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0MDQxNzY1", "number": 6932, "title": "xds: allow duplicated route matcher and prefix='/'", "bodyText": "Allow duplicate route as discussed in design change https://docs.google.com/document/d/1r52-9_I5oso2b-b3BCZ_O5SYR6n7AolhXVpF9yETMxU/edit?disco=AAAAJTxmCz8\n\n\nAllow default matcher to be prefix match with either \"\" or \"/\".\n\n\nI used a method boolean isDefaultRoute(). An alternative is to normalize the data by converting prefix \"/\" to \"\".", "createdAt": "2020-04-15T23:42:47Z", "url": "https://github.com/grpc/grpc-java/pull/6932", "merged": true, "mergeCommit": {"oid": "3bd141bf184a82a2cc92c98c906141d5b32ee88e"}, "closed": true, "closedAt": "2020-04-16T20:50:26Z", "author": {"login": "dapengzhang0"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYA1eAAH2gAyNDA0MDQxNzY1OmJiZWQ0NDBiZGRkM2U3YjEzMDAzZDYyYTVlODQwOWRmMjkyMWMxNTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYS-yOAFqTM5NDk4NjgwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bbed440bddd3e7b13003d62a5e8409df2921c151", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/bbed440bddd3e7b13003d62a5e8409df2921c151", "committedDate": "2020-04-15T23:38:40Z", "message": "xds: allow duplicated route matcher and prefix='/'"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0Mzg4ODEx", "url": "https://github.com/grpc/grpc-java/pull/6932#pullrequestreview-394388811", "createdAt": "2020-04-16T08:02:19Z", "commit": {"oid": "bbed440bddd3e7b13003d62a5e8409df2921c151"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwODowMjoxOVrOGGZSlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwODowMjoxOVrOGGZSlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1ODk5OQ==", "bodyText": "Isn't duplicate allowed?", "url": "https://github.com/grpc/grpc-java/pull/6932#discussion_r409358999", "createdAt": "2020-04-16T08:02:19Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -944,35 +942,28 @@ private static String validateRoutes(List<EnvoyProtoData.Route> routes) {\n       }\n \n       RouteMatch routeMatch = route.getRouteMatch();\n-      String prefix = routeMatch.getPrefix();\n-      String path = routeMatch.getPath();\n-      if (!prefix.isEmpty()) {\n-        if (!prefix.startsWith(\"/\") || !prefix.endsWith(\"/\") || prefix.length() < 3) {\n-          return \"Prefix route match must be in the format of '/service/'\";\n-        }\n-        if (prefixMatches.contains(prefix)) {\n-          return \"Duplicate prefix match found\";\n-        }\n-        prefixMatches.add(prefix);\n-      } else if (!path.isEmpty()) {\n-        int lastSlash = path.lastIndexOf('/');\n-        if (!path.startsWith(\"/\") || lastSlash == 0 || lastSlash ==  path.length() - 1) {\n-          return \"Path route match must be in the format of '/service/method'\";\n-        }\n-        if (pathMatches.contains(path)) {\n-          return \"Duplicate path match found\";\n-        }\n-        pathMatches.add(path);\n-      } else if (routeMatch.hasRegex()) {\n-        return \"Regex route match not supported\";\n-      } else { // Default route match\n-        if (i != routes.size() - 1) {\n-          return \"Default route found but is not the last route in the route list\";\n+      if (!routeMatch.isDefaultMatcher()) {\n+        String prefix = routeMatch.getPrefix();\n+        String path = routeMatch.getPath();\n+        if (!prefix.isEmpty()) {\n+          if (!prefix.startsWith(\"/\") || !prefix.endsWith(\"/\") || prefix.length() < 3) {\n+            return \"Prefix route match must be in the format of '/service/'\";\n+          }\n+        } else if (!path.isEmpty()) {\n+          int lastSlash = path.lastIndexOf('/');\n+          if (!path.startsWith(\"/\") || lastSlash == 0 || lastSlash == path.length() - 1) {\n+            return \"Path route match must be in the format of '/service/method'\";\n+          }\n+          if (pathMatches.contains(path)) {\n+            return \"Duplicate path match found\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbed440bddd3e7b13003d62a5e8409df2921c151"}, "originalPosition": 59}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e76feaa5801a6866c9c1ee69a1596d3cd7b3713", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/2e76feaa5801a6866c9c1ee69a1596d3cd7b3713", "committedDate": "2020-04-16T20:08:27Z", "message": "allow duplicate path and add regression test"}, "afterCommit": {"oid": "b36831c19f34454a06d5ec9f9b2a5634d1940028", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/b36831c19f34454a06d5ec9f9b2a5634d1940028", "committedDate": "2020-04-16T20:13:42Z", "message": "allow duplicate path and add regression test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "781ae3d484f3a37cfbd91d0428541178ba28186c", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/781ae3d484f3a37cfbd91d0428541178ba28186c", "committedDate": "2020-04-16T20:15:54Z", "message": "allow duplicate path and add regression test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b36831c19f34454a06d5ec9f9b2a5634d1940028", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/b36831c19f34454a06d5ec9f9b2a5634d1940028", "committedDate": "2020-04-16T20:13:42Z", "message": "allow duplicate path and add regression test"}, "afterCommit": {"oid": "781ae3d484f3a37cfbd91d0428541178ba28186c", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/781ae3d484f3a37cfbd91d0428541178ba28186c", "committedDate": "2020-04-16T20:15:54Z", "message": "allow duplicate path and add regression test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0OTg2ODA5", "url": "https://github.com/grpc/grpc-java/pull/6932#pullrequestreview-394986809", "createdAt": "2020-04-16T20:47:08Z", "commit": {"oid": "781ae3d484f3a37cfbd91d0428541178ba28186c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4540, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}