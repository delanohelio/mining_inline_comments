{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0MDUyNzkx", "number": 7709, "title": "xds: move subchannel TLS context attaching code to cluster_impl LB policy", "bodyText": "We will be supporting aggregate clusters in CDS LB policy (see design at go/grpc-xds-directpath-c2p-fallback). This PR moves the xDS security implementation that attaches an SSLContextProviderSupplier as EAG attributes from CDS LB policy to cluster_impl LB policy.\nIt is similar to how DropOverload and circuit breakers work. This change assumes the UpstreamTlsContext in an CDS response is configured for underlying clusters in the context of supporting aggregate clusters (I strongly believe it should be, @sanjaypujare please figure it out).\nThe UpstreamTlsContext configuration is obtained from CdsUpdate, then it is passed through the child EDS LB policy's config and then the priority LB policy.\n\nNote in a later change, we will replace the EDS LB policy with a cluster_resolver LB policy (#7685), whose config consists a list of DiscoveryMechanisms for underlying clusters. Each cluster's UpstreamTlsContext will be part of its DiscoveryMechanism and then passed to cluster_impl LB policy's config.", "createdAt": "2020-12-08T01:18:59Z", "url": "https://github.com/grpc/grpc-java/pull/7709", "merged": true, "mergeCommit": {"oid": "9ead2c7c2898f192456436fe3be0c377546bb976"}, "closed": true, "closedAt": "2020-12-15T01:08:52Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdj_caJAH2gAyNTM0MDUyNzkxOjJjMmRkZmJhZDIwYTBlMmI1MzU4NjQ4MGUwNGI5ODIxNzY1NDUwZDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmPeRgAFqTU1MjAyMDk2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2c2ddfbad20a0e2b53586480e04b9821765450d7", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/2c2ddfbad20a0e2b53586480e04b9821765450d7", "committedDate": "2020-12-08T00:59:38Z", "message": "Add TLS context to cluster_impl LB policy config."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74676a409e6598fcc487440f3bdf9e7df92dbde5", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/74676a409e6598fcc487440f3bdf9e7df92dbde5", "committedDate": "2020-12-08T00:59:38Z", "message": "buildscripts: add missing CI coverage for examples (#7708)\n\nAdds CI coverage for building example/android/strictmode and examples/example-jwt-auth. Also cleans up existing Gradle and Maven build command in the CIs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2369d1e93a9d9ba05bb72d12a4cb86da4b57888", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/d2369d1e93a9d9ba05bb72d12a4cb86da4b57888", "committedDate": "2020-12-08T00:59:38Z", "message": "Decorating LB Helper with logic of attaching SSL context provider supplier to EAGs when creating subchannels in cluster_resolver LB policy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ade2cb0a4ed41c23a2b540e350f3a20366234e47", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/ade2cb0a4ed41c23a2b540e350f3a20366234e47", "committedDate": "2020-12-08T00:59:38Z", "message": "Pass TLS context through EDS LB policy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29c3b031bda88cfd6163276e8fe735d58c3a666b", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/29c3b031bda88cfd6163276e8fe735d58c3a666b", "committedDate": "2020-12-08T00:59:38Z", "message": "Delete logic for wrapping LB helper with logic of attaching TLS context to EAGs when creating subchannels in CDS LB policy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fa43a68a75ffe3b9f26453eddbfcfaf74723bcf", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/4fa43a68a75ffe3b9f26453eddbfcfaf74723bcf", "committedDate": "2020-12-08T01:20:41Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/move_endpoint_tls_context_decor_logic_into_cluster_impl_lb_policy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5ODk3NDI1", "url": "https://github.com/grpc/grpc-java/pull/7709#pullrequestreview-549897425", "createdAt": "2020-12-11T08:40:18Z", "commit": {"oid": "4fa43a68a75ffe3b9f26453eddbfcfaf74723bcf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwODo0MDoxOFrOIDuh-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwODo0MDoxOFrOIDuh-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc3OTAwMw==", "bodyText": "Why is this called populate...? It is misleading. It is just extracting a tlsContext from the child policy of a priority. extractTlsContext would be more appropriate.", "url": "https://github.com/grpc/grpc-java/pull/7709#discussion_r540779003", "createdAt": "2020-12-11T08:40:18Z", "author": {"login": "sanjaypujare"}, "path": "xds/src/test/java/io/grpc/xds/EdsLoadBalancer2Test.java", "diffHunk": "@@ -493,16 +489,30 @@ private Long populateMaxConcurrentRequests(PriorityLbConfig config, String prior\n     return clusterImplConfig.maxConcurrentRequests;\n   }\n \n-  private PolicySelection populateLeafLbPolicy(PriorityLbConfig config, String priority,\n-      Locality locality) {\n+  @Test\n+  public void configUpdate_changeTlsContext_propagateToChildLb() {\n+    deliverSimpleClusterLoadAssignment(EDS_SERVICE_NAME);\n+    FakeLoadBalancer childBalancer = Iterables.getOnlyElement(childBalancers);\n+    PriorityLbConfig childLbConfig = (PriorityLbConfig) childBalancer.config;\n+    assertThat(populateTlsContext(childLbConfig, \"priority1\")).isNull();\n+\n+    UpstreamTlsContext upstreamTlsContext =\n+        CommonTlsContextTestsUtil.buildUpstreamTlsContextFromFilenames(\n+            CommonTlsContextTestsUtil.CLIENT_KEY_FILE,\n+            CommonTlsContextTestsUtil.CLIENT_PEM_FILE,\n+            CommonTlsContextTestsUtil.CA_PEM_FILE);\n+    EdsConfig config = new EdsConfig(CLUSTER, EDS_SERVICE_NAME, LRS_SERVER_NAME, 100L,\n+        upstreamTlsContext, weightedTarget, roundRobin);\n+    deliverConfig(config);\n+    assertThat(Iterables.getOnlyElement(childBalancers)).isSameInstanceAs(childBalancer);\n+    childLbConfig = (PriorityLbConfig) childBalancer.config;\n+    assertThat(populateTlsContext(childLbConfig, \"priority1\")).isEqualTo(upstreamTlsContext);\n+  }\n+\n+  private UpstreamTlsContext populateTlsContext(PriorityLbConfig config, String priority) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fa43a68a75ffe3b9f26453eddbfcfaf74723bcf"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNTY2MjYy", "url": "https://github.com/grpc/grpc-java/pull/7709#pullrequestreview-550566262", "createdAt": "2020-12-11T20:46:23Z", "commit": {"oid": "4fa43a68a75ffe3b9f26453eddbfcfaf74723bcf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDo0NjoyM1rOIEMlzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDo0NjoyM1rOIEMlzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI3MTUwMw==", "bodyText": "How does tlsContext.toString() look? Seems it contains nested Any field.", "url": "https://github.com/grpc/grpc-java/pull/7709#discussion_r541271503", "createdAt": "2020-12-11T20:46:23Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancerProvider.java", "diffHunk": "@@ -78,23 +82,50 @@ public ConfigOrError parseLoadBalancingPolicyConfig(\n         @Nullable String edsServiceName,\n         @Nullable String lrsServerName,\n         @Nullable Long maxConcurrentRequests,\n+        @Nullable UpstreamTlsContext tlsContext,\n         PolicySelection localityPickingPolicy,\n         PolicySelection endpointPickingPolicy) {\n       this.clusterName = checkNotNull(clusterName, \"clusterName\");\n       this.edsServiceName = edsServiceName;\n       this.lrsServerName = lrsServerName;\n       this.maxConcurrentRequests = maxConcurrentRequests;\n+      this.tlsContext = tlsContext;\n       this.localityPickingPolicy = checkNotNull(localityPickingPolicy, \"localityPickingPolicy\");\n       this.endpointPickingPolicy = checkNotNull(endpointPickingPolicy, \"endpointPickingPolicy\");\n     }\n \n+    @Override\n+    public int hashCode() {\n+      return Objects.hash(clusterName, edsServiceName, lrsServerName, maxConcurrentRequests,\n+          tlsContext, localityPickingPolicy, endpointPickingPolicy);\n+    }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+      if (this == o) {\n+        return true;\n+      }\n+      if (o == null || getClass() != o.getClass()) {\n+        return false;\n+      }\n+      EdsConfig that = (EdsConfig) o;\n+      return Objects.equals(clusterName, that.clusterName)\n+          && Objects.equals(edsServiceName, that.edsServiceName)\n+          && Objects.equals(lrsServerName, that.lrsServerName)\n+          && Objects.equals(maxConcurrentRequests, that.maxConcurrentRequests)\n+          && Objects.equals(tlsContext, that.tlsContext)\n+          && Objects.equals(localityPickingPolicy, that.localityPickingPolicy)\n+          && Objects.equals(endpointPickingPolicy, that.endpointPickingPolicy);\n+    }\n+\n     @Override\n     public String toString() {\n       return MoreObjects.toStringHelper(this)\n           .add(\"clusterName\", clusterName)\n           .add(\"edsServiceName\", edsServiceName)\n           .add(\"lrsServerName\", lrsServerName)\n           .add(\"maxConcurrentRequests\", maxConcurrentRequests)\n+          .add(\"tlsContext\", tlsContext)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fa43a68a75ffe3b9f26453eddbfcfaf74723bcf"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3e942776925a74d9b0c36bcec714bc679be2c8f", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/c3e942776925a74d9b0c36bcec714bc679be2c8f", "committedDate": "2020-12-12T00:27:43Z", "message": "Remove printing UpstreamTlsContext in data structures including it."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMDgyMDQ0", "url": "https://github.com/grpc/grpc-java/pull/7709#pullrequestreview-551082044", "createdAt": "2020-12-14T06:48:40Z", "commit": {"oid": "c3e942776925a74d9b0c36bcec714bc679be2c8f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMDIwOTYz", "url": "https://github.com/grpc/grpc-java/pull/7709#pullrequestreview-552020963", "createdAt": "2020-12-15T00:48:01Z", "commit": {"oid": "c3e942776925a74d9b0c36bcec714bc679be2c8f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4747, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}