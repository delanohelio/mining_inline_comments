{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4NTczMTEz", "number": 7207, "title": "Add xds client flags", "bodyText": "New test cases require the --rpc and --metadata flags. This PR is the Java analog/port of the Go change in grpc/grpc-go#3737\ncc @menghanl", "createdAt": "2020-07-14T00:23:32Z", "url": "https://github.com/grpc/grpc-java/pull/7207", "merged": true, "mergeCommit": {"oid": "4fbe6bef7d17a354cd94ac68c23a753e6a60cdbb"}, "closed": true, "closedAt": "2020-07-28T19:43:01Z", "author": {"login": "ericgribkoff"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0qz-wAH2gAyNDQ4NTczMTEzOjM1ZWZhMjMyMDU5Nzg4MzU4ZmQ2NGVhOTZlY2UxMTE5YzNiMTM5NDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5bQfigH2gAyNDQ4NTczMTEzOjZhYmI4Y2ViODBlMzU4MzU4NDZkM2I3NGYwYzhiNzE0ZjVjYWZiOTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "35efa232059788358fd64ea96ece1119c3b13948", "author": {"user": {"login": "ericgribkoff", "name": "Eric Gribkoff"}}, "url": "https://github.com/grpc/grpc-java/commit/35efa232059788358fd64ea96ece1119c3b13948", "committedDate": "2020-07-14T00:22:56Z", "message": "interop-testing: add flags to xds test client"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTU5ODYy", "url": "https://github.com/grpc/grpc-java/pull/7207#pullrequestreview-448559862", "createdAt": "2020-07-15T00:55:48Z", "commit": {"oid": "35efa232059788358fd64ea96ece1119c3b13948"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMDo1NTo0OVrOGxqXcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMDo1NTo0OVrOGxqXcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcyNzUzNw==", "bodyText": "Let's call this field rpcs_by_method. Also updated in https://github.com/grpc/grpc/pull/23436/files", "url": "https://github.com/grpc/grpc-java/pull/7207#discussion_r454727537", "createdAt": "2020-07-15T00:55:49Z", "author": {"login": "menghanl"}, "path": "interop-testing/src/main/proto/grpc/testing/messages.proto", "diffHunk": "@@ -195,4 +195,10 @@ message LoadBalancerStatsResponse {\n   map<string, int32> rpcs_by_peer = 1;\n   // The number of RPCs that failed to record a remote peer.\n   int32 num_failures = 2;\n+  message RpcsByPeer {\n+    // The number of completed RPCs for each peer.\n+    map<string, int32> rpcs_by_peer = 1;\n+  }\n+  // The number of completed RPCs for each type (UnaryCall or EmptyCall).\n+  map<string, RpcsByPeer> rpcs_by_type = 3;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35efa232059788358fd64ea96ece1119c3b13948"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b00f4c12c2eb3076067774c65f10033fa48cbb68", "author": {"user": {"login": "ericgribkoff", "name": "Eric Gribkoff"}}, "url": "https://github.com/grpc/grpc-java/commit/b00f4c12c2eb3076067774c65f10033fa48cbb68", "committedDate": "2020-07-21T17:16:34Z", "message": "s/rpcs_by_type/rpcs_by_method/"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNzQ5NDIz", "url": "https://github.com/grpc/grpc-java/pull/7207#pullrequestreview-453749423", "createdAt": "2020-07-22T23:21:11Z", "commit": {"oid": "b00f4c12c2eb3076067774c65f10033fa48cbb68"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMzoyMToxMlrOG13h2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMzoyMToxMlrOG13h2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEzNzQ5OQ==", "bodyText": "Is there an easy way for the client to read both resp.Hostname and the hostname from header?\nThis will be necessary if we want to merge this PR before updating the test server image to send hostname in headers.", "url": "https://github.com/grpc/grpc-java/pull/7207#discussion_r459137499", "createdAt": "2020-07-22T23:21:12Z", "author": {"login": "menghanl"}, "path": "interop-testing/src/main/java/io/grpc/testing/integration/XdsTestClient.java", "diffHunk": "@@ -197,65 +268,87 @@ public void run() {\n           savedWatchers.addAll(watchers);\n         }\n \n-        SimpleRequest request = SimpleRequest.newBuilder().setFillServerId(true).build();\n+        final Metadata headersToSend;\n+        if (metadata.containsKey(rpcType)) {\n+          headersToSend = metadata.get(rpcType);\n+        } else {\n+          headersToSend = new Metadata();\n+        }\n         ManagedChannel channel = channels.get((int) (requestId % channels.size()));\n-        final ClientCall<SimpleRequest, SimpleResponse> call =\n-            channel.newCall(\n-                TestServiceGrpc.getUnaryCallMethod(),\n-                CallOptions.DEFAULT.withDeadlineAfter(rpcTimeoutSec, TimeUnit.SECONDS));\n-        call.start(\n-            new ClientCall.Listener<SimpleResponse>() {\n-              private String hostname;\n+        TestServiceGrpc.TestServiceBlockingStub stub = TestServiceGrpc.newBlockingStub(channel);\n+        final AtomicReference<ClientCall<?, ?>> clientCallRef = new AtomicReference<>();\n+        final AtomicReference<String> hostnameRef = new AtomicReference<>();\n+        stub =\n+            stub.withDeadlineAfter(rpcTimeoutSec, TimeUnit.SECONDS)\n+                .withInterceptors(\n+                    new ClientInterceptor() {\n+                      @Override\n+                      public <ReqT, RespT> ClientCall<ReqT, RespT> interceptCall(\n+                          MethodDescriptor<ReqT, RespT> method,\n+                          CallOptions callOptions,\n+                          Channel next) {\n+                        ClientCall<ReqT, RespT> call = next.newCall(method, callOptions);\n+                        clientCallRef.set(call);\n+                        return new SimpleForwardingClientCall<ReqT, RespT>(call) {\n+                          @Override\n+                          public void start(Listener<RespT> responseListener, Metadata headers) {\n+                            headers.merge(headersToSend);\n+                            super.start(\n+                                new SimpleForwardingClientCallListener<RespT>(responseListener) {\n+                                  @Override\n+                                  public void onHeaders(Metadata headers) {\n+                                    hostnameRef.set(headers.get(XdsTestServer.HOSTNAME_KEY));\n+                                    super.onHeaders(headers);\n+                                  }\n+                                },\n+                                headers);\n+                          }\n+                        };\n+                      }\n+                    });\n \n-              @Override\n-              public void onMessage(SimpleResponse response) {\n-                hostname = response.getHostname();\n-                // TODO(ericgribkoff) Currently some test environments cannot access the stats RPC\n-                // service and rely on parsing stdout.\n-                if (printResponse) {\n-                  System.out.println(\n-                      \"Greeting: Hello world, this is \"\n-                          + hostname\n-                          + \", from \"\n-                          + call.getAttributes().get(Grpc.TRANSPORT_ATTR_REMOTE_ADDR));\n-                }\n-              }\n-\n-              @Override\n-              public void onClose(Status status, Metadata trailers) {\n-                if (printResponse && !status.isOk()) {\n-                  logger.log(Level.WARNING, \"Greeting RPC failed with status {0}\", status);\n-                }\n-                for (XdsStatsWatcher watcher : savedWatchers) {\n-                  watcher.rpcCompleted(requestId, hostname);\n-                }\n-              }\n-            },\n-            new Metadata());\n-\n-        call.sendMessage(request);\n-        call.request(1);\n-        call.halfClose();\n+        if (rpcType == RpcType.EMPTY_CALL) {\n+          stub.emptyCall(EmptyProtos.Empty.getDefaultInstance());\n+        } else if (rpcType == RpcType.UNARY_CALL) {\n+          SimpleRequest request = SimpleRequest.newBuilder().setFillServerId(true).build();\n+          SimpleResponse response = stub.unaryCall(request);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b00f4c12c2eb3076067774c65f10033fa48cbb68"}, "originalPosition": 235}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afb2c215152e4de7f2abd7994258d78a067c9672", "author": {"user": {"login": "ericgribkoff", "name": "Eric Gribkoff"}}, "url": "https://github.com/grpc/grpc-java/commit/afb2c215152e4de7f2abd7994258d78a067c9672", "committedDate": "2020-07-24T05:31:20Z", "message": "Fallback to response hostname"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02b91fada18eabd41645c8d1bd738d92306fa74d", "author": {"user": {"login": "ericgribkoff", "name": "Eric Gribkoff"}}, "url": "https://github.com/grpc/grpc-java/commit/02b91fada18eabd41645c8d1bd738d92306fa74d", "committedDate": "2020-07-24T06:08:42Z", "message": "Fix default rpc timeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1276db3308f17286ee021f0a40212707f819cb9c", "author": {"user": {"login": "ericgribkoff", "name": "Eric Gribkoff"}}, "url": "https://github.com/grpc/grpc-java/commit/1276db3308f17286ee021f0a40212707f819cb9c", "committedDate": "2020-07-24T06:43:46Z", "message": "Use async API, do not fail on failed rpc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MTY0MDE0", "url": "https://github.com/grpc/grpc-java/pull/7207#pullrequestreview-456164014", "createdAt": "2020-07-27T21:56:54Z", "commit": {"oid": "1276db3308f17286ee021f0a40212707f819cb9c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMTo1Njo1NVrOG31C6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNzozOTo0M1rOG4XbcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5Mzk2MQ==", "bodyText": "Rename to rpcTypes?", "url": "https://github.com/grpc/grpc-java/pull/7207#discussion_r461193961", "createdAt": "2020-07-27T21:56:55Z", "author": {"login": "dapengzhang0"}, "path": "interop-testing/src/main/java/io/grpc/testing/integration/XdsTestClient.java", "diffHunk": "@@ -62,13 +70,24 @@\n   private int numChannels = 1;\n   private boolean printResponse = false;\n   private int qps = 1;\n-  private int rpcTimeoutSec = 2;\n+  private List<RpcType> rpc = ImmutableList.of(RpcType.UNARY_CALL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1276db3308f17286ee021f0a40212707f819cb9c"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc0Njg4OA==", "bodyText": "Default: UnaryCall", "url": "https://github.com/grpc/grpc-java/pull/7207#discussion_r461746888", "createdAt": "2020-07-28T17:22:35Z", "author": {"login": "dapengzhang0"}, "path": "interop-testing/src/main/java/io/grpc/testing/integration/XdsTestClient.java", "diffHunk": "@@ -139,8 +162,12 @@ private void parseArgs(String[] args) {\n               + c.numChannels\n               + \"\\n  --print_response=BOOL  Write RPC response to stdout. Default: \"\n               + c.printResponse\n-              + \"\\n  --qps=INT              Qps per channel. Default: \"\n+              + \"\\n  --qps=INT              Qps per channel, for each type of RPC. Default: \"\n               + c.qps\n+              + \"\\n  --rpc=STR              Types of RPCs to make, ',' separated string. RPCs can \"\n+              + \"be EmptyCall or UnaryCall.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1276db3308f17286ee021f0a40212707f819cb9c"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc1NzI5Ng==", "bodyText": "Can it be EnumMap?", "url": "https://github.com/grpc/grpc-java/pull/7207#discussion_r461757296", "createdAt": "2020-07-28T17:39:43Z", "author": {"login": "dapengzhang0"}, "path": "interop-testing/src/main/java/io/grpc/testing/integration/XdsTestClient.java", "diffHunk": "@@ -286,6 +429,7 @@ public void getClientStats(\n     private final long startId;\n     private final long endId;\n     private final Map<String, Integer> rpcsByPeer = new HashMap<>();\n+    private final Map<String, Map<String, Integer>> rpcsByTypeAndPeer = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1276db3308f17286ee021f0a40212707f819cb9c"}, "originalPosition": 343}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b5e7e0c44ebbeb420508c654e34be679569f341", "author": {"user": {"login": "ericgribkoff", "name": "Eric Gribkoff"}}, "url": "https://github.com/grpc/grpc-java/commit/1b5e7e0c44ebbeb420508c654e34be679569f341", "committedDate": "2020-07-28T18:51:35Z", "message": "EnumMap, default val, rpcTypes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTE3MzA5", "url": "https://github.com/grpc/grpc-java/pull/7207#pullrequestreview-456917309", "createdAt": "2020-07-28T18:54:49Z", "commit": {"oid": "1b5e7e0c44ebbeb420508c654e34be679569f341"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e993632a709941e6ad88a6ba48d73712a823f32", "author": {"user": {"login": "ericgribkoff", "name": "Eric Gribkoff"}}, "url": "https://github.com/grpc/grpc-java/commit/5e993632a709941e6ad88a6ba48d73712a823f32", "committedDate": "2020-07-28T19:00:05Z", "message": "more EnumMap"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6abb8ceb80e35835846d3b74f0c8b714f5cafb90", "author": {"user": {"login": "ericgribkoff", "name": "Eric Gribkoff"}}, "url": "https://github.com/grpc/grpc-java/commit/6abb8ceb80e35835846d3b74f0c8b714f5cafb90", "committedDate": "2020-07-28T19:05:13Z", "message": "include path_matching and header_matching tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4314, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}