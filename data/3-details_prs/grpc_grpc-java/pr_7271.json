{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5NjE1NzI3", "number": 7271, "title": "xds: Add server features support to Bootstrapper", "bodyText": "In preparation for xds-v3 support.", "createdAt": "2020-07-30T21:32:57Z", "url": "https://github.com/grpc/grpc-java/pull/7271", "merged": true, "mergeCommit": {"oid": "22b5480aed6c22290f248929cf883aa58fb06771"}, "closed": true, "closedAt": "2020-07-31T01:00:37Z", "author": {"login": "dapengzhang0"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6GiomgH2gAyNDU5NjE1NzI3OjBiMWI5ZDlkNDVkYzI1YmMyZDk5MWRlZWVlMmE5NDA3N2MxYzVjNDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6I6H6gFqTQ1ODg0NDA4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0b1b9d9d45dc25bc2d991deeee2a94077c1c5c40", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/0b1b9d9d45dc25bc2d991deeee2a94077c1c5c40", "committedDate": "2020-07-30T21:30:57Z", "message": "xds: Add server features support to Bootstrapper"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NzkxMDY4", "url": "https://github.com/grpc/grpc-java/pull/7271#pullrequestreview-458791068", "createdAt": "2020-07-30T22:10:53Z", "commit": {"oid": "0b1b9d9d45dc25bc2d991deeee2a94077c1c5c40"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjoxMDo1M1rOG51lKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjoxMDo1M1rOG51lKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI5OTg4MQ==", "bodyText": "It doesn't make sense to put such an API here. This makes a factory class stateful.\nMaybe it is time to eliminate XdsChannelFactory, instead we do need something like Helper.createResolvingOobChannel(), but accessible inside NameResolver.\nLast time when I was doing some local e2e test for traffic splitting and routing, the gRPC channel is using plaintext, but the xDS channel is fixed to use TLS (if not google_default) instead of falling back to use the same configuration as its parent channel. This is broken for Java. It is not bitting us because we are always using TLS if not google_default in production.\nWe should support such a feature correctly. Basically, the creation of xDS channel will be done outside XdsClientImpl. For EDS only's code path, we are roughly able to do it with Helper.createResolvingOobChannel(), so not a problem for migrating.\nFor now, I think a better way is to change the createChannel API for XdsChannelFactory. You could define a simple class that contains a Channel and server features.", "url": "https://github.com/grpc/grpc-java/pull/7271#discussion_r463299881", "createdAt": "2020-07-30T22:10:53Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClient.java", "diffHunk": "@@ -643,5 +650,14 @@ static XdsChannelFactory getInstance() {\n      * Creates a channel to one of the provided management servers.\n      */\n     abstract ManagedChannel createChannel(List<ServerInfo> servers);\n+\n+    /**\n+     * Gets features of the server that the channel is created for. Value is only available\n+     * after {@link #createChannel} is called.\n+     */\n+    @Nullable\n+    List<?> getSelectedServerFeatures() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b1b9d9d45dc25bc2d991deeee2a94077c1c5c40"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe503de1f4ff643f50f0e9c10a40d47cb90d48fb", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/fe503de1f4ff643f50f0e9c10a40d47cb90d48fb", "committedDate": "2020-07-30T23:04:28Z", "message": "refactor XdsChannelFactor return type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cef59413fa954e7bf1abfea030abbb04014f8548", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/cef59413fa954e7bf1abfea030abbb04014f8548", "committedDate": "2020-07-30T23:15:02Z", "message": "expose only proto from ServerInfo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODI4NzIw", "url": "https://github.com/grpc/grpc-java/pull/7271#pullrequestreview-458828720", "createdAt": "2020-07-30T23:27:24Z", "commit": {"oid": "cef59413fa954e7bf1abfea030abbb04014f8548"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMzoyNzoyNFrOG53JmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMzoyNzoyNFrOG53JmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMyNTU5Mg==", "bodyText": "Given that the format of server_features is undefined. Maybe it's better to just parse it to a String list.\nThe parser should not try to interpret what is being parsed. It's just a list of string. \"xds_v3\" should be defined in the consumer class, which is XdsChannelFactory (e.g., String PROTOCOL_VERSION = \"xds_v3). The channel factory looks up the parsed server features and check if the expected protocol version setting is there.", "url": "https://github.com/grpc/grpc-java/pull/7271#discussion_r463325592", "createdAt": "2020-07-30T23:27:24Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/Bootstrapper.java", "diffHunk": "@@ -111,7 +112,11 @@ static BootstrapInfo parseConfig(String rawData) throws IOException {\n           channelCredsOptions.add(creds);\n         }\n       }\n-      servers.add(new ServerInfo(serverUri, channelCredsOptions));\n+      List<?> serverFeatures = JsonUtil.getList(serverConfig, \"server_features\");\n+      if (serverFeatures != null && serverFeatures.contains(XDS_V3_SERVER_FEATURE)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cef59413fa954e7bf1abfea030abbb04014f8548"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8a8d70bb5f8789257b42ee222328e0b63d14331", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/d8a8d70bb5f8789257b42ee222328e0b63d14331", "committedDate": "2020-07-30T23:33:01Z", "message": "read env"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c700e81d911a594f19493d2bf81f5090faec0df2", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/c700e81d911a594f19493d2bf81f5090faec0df2", "committedDate": "2020-07-30T23:56:54Z", "message": "return list of String for server_features"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4de628f586b96a6316acfc05e67bd5d8a6d6033", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/f4de628f586b96a6316acfc05e67bd5d8a6d6033", "committedDate": "2020-07-31T00:01:32Z", "message": "parse boolean"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cefc8a3a2060e43935085e4643ac35f8972e7835", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/cefc8a3a2060e43935085e4643ac35f8972e7835", "committedDate": "2020-07-31T00:00:56Z", "message": "parse boolean"}, "afterCommit": {"oid": "f4de628f586b96a6316acfc05e67bd5d8a6d6033", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/f4de628f586b96a6316acfc05e67bd5d8a6d6033", "committedDate": "2020-07-31T00:01:32Z", "message": "parse boolean"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f592405b8cc44378238f5ef064943a7197c54d51", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/f592405b8cc44378238f5ef064943a7197c54d51", "committedDate": "2020-07-31T00:08:08Z", "message": "format"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a1082c18242cab69f57db1db869181d612ff537", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/6a1082c18242cab69f57db1db869181d612ff537", "committedDate": "2020-07-31T00:07:01Z", "message": "format"}, "afterCommit": {"oid": "f592405b8cc44378238f5ef064943a7197c54d51", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/f592405b8cc44378238f5ef064943a7197c54d51", "committedDate": "2020-07-31T00:08:08Z", "message": "format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODQ0MDgw", "url": "https://github.com/grpc/grpc-java/pull/7271#pullrequestreview-458844080", "createdAt": "2020-07-31T00:16:25Z", "commit": {"oid": "f592405b8cc44378238f5ef064943a7197c54d51"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4126, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}