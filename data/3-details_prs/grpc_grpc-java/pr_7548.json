{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4NDkxMDM1", "number": 7548, "title": "interop-testing: support rpc keep-open for xDS test server", "bodyText": "Sending out server changes separately to unblock other languages' test client.\n/cc @donnadionne @menghanl", "createdAt": "2020-10-22T18:50:11Z", "url": "https://github.com/grpc/grpc-java/pull/7548", "merged": true, "mergeCommit": {"oid": "b2bf5fa7f50cc96649f07728ebebba8fea9cf9d2"}, "closed": true, "closedAt": "2020-11-03T18:33:17Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVGkZlAH2gAyNTA4NDkxMDM1OjEwOGI4ZGMxNjJkMTVmZDU1MWM1MjkyZTllN2VjNjU5NWUyMjMyODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY0uU-gFqTUyMjI2MTcwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "108b8dc162d15fd551c5292e9e7ec6595e223283", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/108b8dc162d15fd551c5292e9e7ec6595e223283", "committedDate": "2020-10-22T18:48:50Z", "message": "Support keep-open on the server side."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de84e5afdbcb03029ae5ef0b410ba6aadec19a9b", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/de84e5afdbcb03029ae5ef0b410ba6aadec19a9b", "committedDate": "2020-10-22T20:29:07Z", "message": "Make rpc-behavior key private."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MTYzMjI4", "url": "https://github.com/grpc/grpc-java/pull/7548#pullrequestreview-516163228", "createdAt": "2020-10-24T06:14:09Z", "commit": {"oid": "de84e5afdbcb03029ae5ef0b410ba6aadec19a9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQwNjoxNDowOVrOHno45w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQwNjoxNDowOVrOHno45w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyNjQzOQ==", "bodyText": "I don't see how the keepOpen atomic's value is correlated with this call after this interceptor sets it to true.\nMy reading of the spec for these tests was that, for an incoming call with keep-open in the metadata, that call should be kept open by the server. As I understand the code here, instead any call with keep-open in the metadata essentially flips a global boolean and all calls from that point on will be kept open (at least until another RPC comes without keep-open). Is that intended?\nTo set a value that would instead be scoped to this particular call, I think you could set a value in the context, as in https://github.com/GoogleCloudPlatform/traffic-director-grpc-examples/blob/master/java/src/main/java/io/grpc/examples/wallet/WalletInterceptors.java#L106 (there might be a better way to accomplish this)", "url": "https://github.com/grpc/grpc-java/pull/7548#discussion_r511326439", "createdAt": "2020-10-24T06:14:09Z", "author": {"login": "ericgribkoff"}, "path": "interop-testing/src/main/java/io/grpc/testing/integration/XdsTestServer.java", "diffHunk": "@@ -203,18 +214,22 @@ public void setNotServing(\n     }\n   }\n \n-  private static class HostnameInterceptor implements ServerInterceptor {\n+  private static class TestInfoInterceptor implements ServerInterceptor {\n     private final String host;\n+    private final AtomicBoolean keepOpenCaptor;\n \n-    private HostnameInterceptor(String host) {\n+    private TestInfoInterceptor(String host, AtomicBoolean keepOpenCaptor) {\n       this.host = host;\n+      this.keepOpenCaptor = keepOpenCaptor;\n     }\n \n     @Override\n     public <ReqT, RespT> ServerCall.Listener<ReqT> interceptCall(\n         ServerCall<ReqT, RespT> call,\n         final Metadata requestHeaders,\n         ServerCallHandler<ReqT, RespT> next) {\n+      String callBehavior = requestHeaders.get(CALL_BEHAVIOR_KEY);\n+      keepOpenCaptor.set(\"keep-open\".equals(callBehavior));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de84e5afdbcb03029ae5ef0b410ba6aadec19a9b"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51703da987c5074ec01c56e8c720e0bab4d40fc2", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/51703da987c5074ec01c56e8c720e0bab4d40fc2", "committedDate": "2020-10-26T07:44:22Z", "message": "Convert put call_behavior metadata into Context and use it as per call basis."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "36e9dc66e221fbb72e69b5715b728b8182c7205a", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/36e9dc66e221fbb72e69b5715b728b8182c7205a", "committedDate": "2020-10-26T07:42:43Z", "message": "Convert put call_behavior metadata into Context and use it as per call basis."}, "afterCommit": {"oid": "51703da987c5074ec01c56e8c720e0bab4d40fc2", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/51703da987c5074ec01c56e8c720e0bab4d40fc2", "committedDate": "2020-10-26T07:44:22Z", "message": "Convert put call_behavior metadata into Context and use it as per call basis."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMjYxNzA3", "url": "https://github.com/grpc/grpc-java/pull/7548#pullrequestreview-522261707", "createdAt": "2020-11-03T08:17:05Z", "commit": {"oid": "51703da987c5074ec01c56e8c720e0bab4d40fc2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3935, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}