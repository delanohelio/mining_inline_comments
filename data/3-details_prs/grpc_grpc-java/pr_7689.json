{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxNDA2MjE5", "number": 7689, "title": "xds: fix ServerXdsClient to return subscribed resources only for LDS", "bodyText": "", "createdAt": "2020-12-03T02:11:20Z", "url": "https://github.com/grpc/grpc-java/pull/7689", "merged": true, "mergeCommit": {"oid": "20fc907b2184f6e73f293c308385fb6be67c7d34"}, "closed": true, "closedAt": "2020-12-10T01:42:13Z", "author": {"login": "sanjaypujare"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiZdIDAH2gAyNTMxNDA2MjE5OmI4MWM1MGU2NDBmODAzOGMwYTFlYzVhYzcwNTlmMGE5ODcwYTFiZTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkpIj3AFqTU0ODc1MTA3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b81c50e640f8038c0a1ec5ac7059f0a9870a1be4", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/b81c50e640f8038c0a1ec5ac7059f0a9870a1be4", "committedDate": "2020-12-03T02:10:06Z", "message": "xds: fix ServerXdsClient to return subscribed resources only for LDS"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0Mjg3ODMw", "url": "https://github.com/grpc/grpc-java/pull/7689#pullrequestreview-544287830", "createdAt": "2020-12-03T19:06:30Z", "commit": {"oid": "b81c50e640f8038c0a1ec5ac7059f0a9870a1be4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxOTowNjozMFrOH-sn-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxOTowNjozMFrOH-sn-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUwNDg5MA==", "bodyText": "This is still incorrect. It should always return null for type != ResourceType.LDS.", "url": "https://github.com/grpc/grpc-java/pull/7689#discussion_r535504890", "createdAt": "2020-12-03T19:06:30Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/ServerXdsClient.java", "diffHunk": "@@ -107,7 +107,7 @@ public void run() {\n   @Nullable\n   @Override\n   Collection<String> getSubscribedResources(ResourceType type) {\n-    if (newServerApi) {\n+    if (newServerApi && (type == ResourceType.LDS)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b81c50e640f8038c0a1ec5ac7059f0a9870a1be4"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f6813fb54e009af7ca43ddd26e6cb56327c7395", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/8f6813fb54e009af7ca43ddd26e6cb56327c7395", "committedDate": "2020-12-04T06:43:00Z", "message": "address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MzkxNTg4", "url": "https://github.com/grpc/grpc-java/pull/7689#pullrequestreview-545391588", "createdAt": "2020-12-05T01:58:54Z", "commit": {"oid": "8f6813fb54e009af7ca43ddd26e6cb56327c7395"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQwMTo1ODo1NFrOH_oJJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQwMTo1ODo1NFrOH_oJJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ4MDAzNw==", "bodyText": "Such a test is fairly weak. It would be much more robust to verify xDS requests sent to an in-process service implementation.", "url": "https://github.com/grpc/grpc-java/pull/7689#discussion_r536480037", "createdAt": "2020-12-05T01:58:54Z", "author": {"login": "voidzcy"}, "path": "xds/src/test/java/io/grpc/xds/ServerXdsClientTest.java", "diffHunk": "@@ -759,6 +759,15 @@ public void streamClosedAndRetry() {\n         backoffPolicy2);\n   }\n \n+  @Test\n+  public void getSubscribedResources() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f6813fb54e009af7ca43ddd26e6cb56327c7395"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "466ddc5c534fdb069b1ee770cc4160bfbbbf6eba", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/466ddc5c534fdb069b1ee770cc4160bfbbbf6eba", "committedDate": "2020-12-09T22:54:00Z", "message": "address review comments: part 2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34ac6d3ee6251df41f0ad8ec4655daea0d588e41", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/34ac6d3ee6251df41f0ad8ec4655daea0d588e41", "committedDate": "2020-12-09T23:38:53Z", "message": "put the tests in the right place: fix prev commit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NzAyNjUz", "url": "https://github.com/grpc/grpc-java/pull/7689#pullrequestreview-548702653", "createdAt": "2020-12-09T23:35:57Z", "commit": {"oid": "466ddc5c534fdb069b1ee770cc4160bfbbbf6eba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMzozNTo1N1rOICubIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMzozNTo1N1rOICubIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyODY3NQ==", "bodyText": "This verify isn't useful. any(DiscoveryRequest.class) doesn't include anything, you need to be explicit for things you want to verify (on the other hand, for things not interested in terms of its behavior for a particular test case, you should just not verify it). I don't think we are much interested in verifying the ACK behavior particularly in this test case (that's why it was omitted in the original version). getSubscribedResources() is not covered by this test case, it's not called anywhere inside this test case's operations. It should be verified in streamClosedAndRetry() test case. One more thing, try to keep the two copies of ServerXdsClientTest consistent (that's why I hate maintaining two copies of tests \ud83d\ude04 ).", "url": "https://github.com/grpc/grpc-java/pull/7689#discussion_r539728675", "createdAt": "2020-12-09T23:35:57Z", "author": {"login": "voidzcy"}, "path": "xds/src/test/java/io/grpc/xds/ServerXdsClientNewServerApiTest.java", "diffHunk": "@@ -376,6 +376,8 @@ public void notifyUpdatedListener() {\n     ArgumentCaptor<ListenerUpdate> listenerUpdateCaptor = ArgumentCaptor.forClass(null);\n     verify(listenerWatcher, times(1)).onListenerChanged(listenerUpdateCaptor.capture());\n \n+    // expect only 2 requests: original req and ACK: no other req for no other resource\n+    verify(requestObserver, times(2)).onNext(any(DiscoveryRequest.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "466ddc5c534fdb069b1ee770cc4160bfbbbf6eba"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NzExNTc3", "url": "https://github.com/grpc/grpc-java/pull/7689#pullrequestreview-548711577", "createdAt": "2020-12-09T23:51:09Z", "commit": {"oid": "34ac6d3ee6251df41f0ad8ec4655daea0d588e41"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMzo1MToxMFrOICu3uQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMzo1MToxMFrOICu3uQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTczNTk5Mw==", "bodyText": "Isn't this just what the previous line verified, except it adds the times(1) restriction? I think all you need is verifyNoMoreInteractions(requestObserver) at the end of the lifecycle of each requestObserver instance (note there are several requestObserver updates in this test as more than one RPCs are made).", "url": "https://github.com/grpc/grpc-java/pull/7689#discussion_r539735993", "createdAt": "2020-12-09T23:51:10Z", "author": {"login": "voidzcy"}, "path": "xds/src/test/java/io/grpc/xds/ServerXdsClientTest.java", "diffHunk": "@@ -639,6 +636,8 @@ public void streamClosedAndRetry() {\n     verify(requestObserver)\n         .onNext(eq(buildDiscoveryRequest(getNodeToVerify(), \"\",\n             ResourceType.LDS.typeUrlV2(), \"\")));\n+    // expect only 1 request: for LDS\n+    verify(requestObserver, times(1)).onNext(any(DiscoveryRequest.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34ac6d3ee6251df41f0ad8ec4655daea0d588e41"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f09a351f0f77e1272ac57e4229ad226c4fd6613", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/6f09a351f0f77e1272ac57e4229ad226c4fd6613", "committedDate": "2020-12-10T01:12:43Z", "message": "use better verification method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NzUxMDcw", "url": "https://github.com/grpc/grpc-java/pull/7689#pullrequestreview-548751070", "createdAt": "2020-12-10T01:33:53Z", "commit": {"oid": "6f09a351f0f77e1272ac57e4229ad226c4fd6613"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwMTozMzo1NFrOICxTpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwMTozMzo1NFrOICxTpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTc3NTkwOQ==", "bodyText": "Well, the two copies of tests have already diverged.  But it is minor...", "url": "https://github.com/grpc/grpc-java/pull/7689#discussion_r539775909", "createdAt": "2020-12-10T01:33:54Z", "author": {"login": "voidzcy"}, "path": "xds/src/test/java/io/grpc/xds/ServerXdsClientTest.java", "diffHunk": "@@ -636,6 +636,7 @@ public void streamClosedAndRetry() {\n     verify(requestObserver)\n         .onNext(eq(buildDiscoveryRequest(getNodeToVerify(), \"\",\n             ResourceType.LDS.typeUrlV2(), \"\")));\n+    verifyNoMoreInteractions(requestObserver);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f09a351f0f77e1272ac57e4229ad226c4fd6613"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4735, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}