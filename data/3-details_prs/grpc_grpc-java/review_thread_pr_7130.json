{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0OTczODA5", "number": 7130, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxOToxMToxM1rOEGEsfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxODowMzowMVrOEHMp_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0ODAzODM5OnYy", "diffSide": "RIGHT", "path": "xds/src/main/java/io/grpc/xds/RouteMatch.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxOToxMToxM1rOGkphYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMTowMDo1MlrOGlXQnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4MjIxMA==", "bodyText": "Why not Long?", "url": "https://github.com/grpc/grpc-java/pull/7130#discussion_r441082210", "createdAt": "2020-06-16T19:11:13Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/RouteMatch.java", "diffHunk": "@@ -196,6 +239,29 @@ public String toString() {\n       this.isInvertedMatch = isInvertedMatch;\n     }\n \n+    private boolean matchesValue(String value) {\n+      boolean baseMatch;\n+      if (exactMatch != null) {\n+        baseMatch = exactMatch.equals(value);\n+      } else if (safeRegExMatch != null) {\n+        baseMatch = safeRegExMatch.matches(value);\n+      } else if (rangeMatch != null) {\n+        try {\n+          Integer numValue = Integer.parseInt(value);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "887a51ed4e8d640dbab6ade2b6d7bc98a851ccf4"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgyNjE3MQ==", "bodyText": "It is specified by proto:\n\nThe entire request header value must represent an integer in base 10 notation: consisting of an optional plus or minus sign followed by a sequence of digits. The rule will not match if the header value does not represent an integer. Match will fail for empty values, floating point numbers or if only a subsequence of the header value is an integer.", "url": "https://github.com/grpc/grpc-java/pull/7130#discussion_r441826171", "createdAt": "2020-06-17T20:50:05Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/RouteMatch.java", "diffHunk": "@@ -196,6 +239,29 @@ public String toString() {\n       this.isInvertedMatch = isInvertedMatch;\n     }\n \n+    private boolean matchesValue(String value) {\n+      boolean baseMatch;\n+      if (exactMatch != null) {\n+        baseMatch = exactMatch.equals(value);\n+      } else if (safeRegExMatch != null) {\n+        baseMatch = safeRegExMatch.matches(value);\n+      } else if (rangeMatch != null) {\n+        try {\n+          Integer numValue = Integer.parseInt(value);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4MjIxMA=="}, "originalCommit": {"oid": "887a51ed4e8d640dbab6ade2b6d7bc98a851ccf4"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgzMTU4MA==", "bodyText": "I think that \"integer\" in the spec is not Java Integer. The type is Int64, corresponding to Java Long.", "url": "https://github.com/grpc/grpc-java/pull/7130#discussion_r441831580", "createdAt": "2020-06-17T21:00:52Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/RouteMatch.java", "diffHunk": "@@ -196,6 +239,29 @@ public String toString() {\n       this.isInvertedMatch = isInvertedMatch;\n     }\n \n+    private boolean matchesValue(String value) {\n+      boolean baseMatch;\n+      if (exactMatch != null) {\n+        baseMatch = exactMatch.equals(value);\n+      } else if (safeRegExMatch != null) {\n+        baseMatch = safeRegExMatch.matches(value);\n+      } else if (rangeMatch != null) {\n+        try {\n+          Integer numValue = Integer.parseInt(value);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4MjIxMA=="}, "originalCommit": {"oid": "887a51ed4e8d640dbab6ade2b6d7bc98a851ccf4"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MjMwMTkyOnYy", "diffSide": "RIGHT", "path": "xds/src/main/java/io/grpc/xds/RouteMatch.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxOTowMzoxMFrOGlTf1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxOTowMzoxMFrOGlTf1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc2OTk0MA==", "bodyText": "What if headerMatcher.presentMatch.equals(Boolean.FALSE)? Or what if headerMatcher.presentMatch.equals(Boolean.TRUE) and headerMatcher.isInvertedMatch is true?", "url": "https://github.com/grpc/grpc-java/pull/7130#discussion_r441769940", "createdAt": "2020-06-17T19:03:10Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/RouteMatch.java", "diffHunk": "@@ -48,6 +51,37 @@\n         Collections.<HeaderMatcher>emptyList(), null);\n   }\n \n+  /**\n+   * Returns {@code true} if a request with the given path and headers passes all the rules\n+   * specified by this RouteMatch.\n+   *\n+   * <p>The request's headers are given as a key-values mapping, where multiple values can\n+   * be mapped to the same key.\n+   *\n+   * <p>Match is not deterministic if a runtime fraction match rule presents in this RouteMatch.\n+   */\n+  boolean matches(String path, Map<String, Set<String>> headers) {\n+    if (!pathMatch.matches(path)) {\n+      return false;\n+    }\n+    for (HeaderMatcher headerMatcher : headerMatchers) {\n+      if (!headers.containsKey(headerMatcher.getName())) {\n+        return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "887a51ed4e8d640dbab6ade2b6d7bc98a851ccf4"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MjM2ODk2OnYy", "diffSide": "RIGHT", "path": "xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxOToyNDozMlrOGlULIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMTowMjoyMlrOGlXTtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4MTAyNA==", "bodyText": "We should prepend '/' to args.getMethodDescriptor().getFullMethodName(), because the route's path or prefix in TD's config will always start with '/'. @menghanl Can you confirm?", "url": "https://github.com/grpc/grpc-java/pull/7130#discussion_r441781024", "createdAt": "2020-06-17T19:24:32Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java", "diffHunk": "@@ -190,8 +192,27 @@ protected Helper delegate() {\n \n     @Override\n     public PickResult pickSubchannel(PickSubchannelArgs args) {\n-      // TODO(chengyuanzhang): to be implemented.\n-      return PickResult.withError(Status.INTERNAL.withDescription(\"routing picker unimplemented\"));\n+      // Index ASCII headers by keys.\n+      Map<String, Set<String>> asciiHeaders = new HashMap<>();\n+      Metadata headers = args.getHeaders();\n+      for (String headerName : headers.keys()) {\n+        if (headerName.endsWith(Metadata.BINARY_HEADER_SUFFIX)) {\n+          continue;\n+        }\n+        Set<String> headerValues = new HashSet<>();\n+        Metadata.Key<String> key = Metadata.Key.of(headerName, Metadata.ASCII_STRING_MARSHALLER);\n+        for (String value : headers.getAll(key)) {\n+          headerValues.add(value);\n+        }\n+        asciiHeaders.put(headerName, headerValues);\n+      }\n+      for (Map.Entry<RouteMatch, SubchannelPicker> entry : routePickers.entrySet()) {\n+        RouteMatch routeMatch = entry.getKey();\n+        if (routeMatch.matches(args.getMethodDescriptor().getFullMethodName(), asciiHeaders)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "887a51ed4e8d640dbab6ade2b6d7bc98a851ccf4"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgyNjM5MA==", "bodyText": "Path starts with \"/\", as defined in https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-HTTP2.md#requests", "url": "https://github.com/grpc/grpc-java/pull/7130#discussion_r441826390", "createdAt": "2020-06-17T20:50:29Z", "author": {"login": "menghanl"}, "path": "xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java", "diffHunk": "@@ -190,8 +192,27 @@ protected Helper delegate() {\n \n     @Override\n     public PickResult pickSubchannel(PickSubchannelArgs args) {\n-      // TODO(chengyuanzhang): to be implemented.\n-      return PickResult.withError(Status.INTERNAL.withDescription(\"routing picker unimplemented\"));\n+      // Index ASCII headers by keys.\n+      Map<String, Set<String>> asciiHeaders = new HashMap<>();\n+      Metadata headers = args.getHeaders();\n+      for (String headerName : headers.keys()) {\n+        if (headerName.endsWith(Metadata.BINARY_HEADER_SUFFIX)) {\n+          continue;\n+        }\n+        Set<String> headerValues = new HashSet<>();\n+        Metadata.Key<String> key = Metadata.Key.of(headerName, Metadata.ASCII_STRING_MARSHALLER);\n+        for (String value : headers.getAll(key)) {\n+          headerValues.add(value);\n+        }\n+        asciiHeaders.put(headerName, headerValues);\n+      }\n+      for (Map.Entry<RouteMatch, SubchannelPicker> entry : routePickers.entrySet()) {\n+        RouteMatch routeMatch = entry.getKey();\n+        if (routeMatch.matches(args.getMethodDescriptor().getFullMethodName(), asciiHeaders)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4MTAyNA=="}, "originalCommit": {"oid": "887a51ed4e8d640dbab6ade2b6d7bc98a851ccf4"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgzMjM3Mg==", "bodyText": "Path starts with \"/\", as defined in https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-HTTP2.md#requests\n\nYeah, java MethodDescriptor.getFullMethodName() does not include the leading '/', so we need prepend it.", "url": "https://github.com/grpc/grpc-java/pull/7130#discussion_r441832372", "createdAt": "2020-06-17T21:02:22Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java", "diffHunk": "@@ -190,8 +192,27 @@ protected Helper delegate() {\n \n     @Override\n     public PickResult pickSubchannel(PickSubchannelArgs args) {\n-      // TODO(chengyuanzhang): to be implemented.\n-      return PickResult.withError(Status.INTERNAL.withDescription(\"routing picker unimplemented\"));\n+      // Index ASCII headers by keys.\n+      Map<String, Set<String>> asciiHeaders = new HashMap<>();\n+      Metadata headers = args.getHeaders();\n+      for (String headerName : headers.keys()) {\n+        if (headerName.endsWith(Metadata.BINARY_HEADER_SUFFIX)) {\n+          continue;\n+        }\n+        Set<String> headerValues = new HashSet<>();\n+        Metadata.Key<String> key = Metadata.Key.of(headerName, Metadata.ASCII_STRING_MARSHALLER);\n+        for (String value : headers.getAll(key)) {\n+          headerValues.add(value);\n+        }\n+        asciiHeaders.put(headerName, headerValues);\n+      }\n+      for (Map.Entry<RouteMatch, SubchannelPicker> entry : routePickers.entrySet()) {\n+        RouteMatch routeMatch = entry.getKey();\n+        if (routeMatch.matches(args.getMethodDescriptor().getFullMethodName(), asciiHeaders)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4MTAyNA=="}, "originalCommit": {"oid": "887a51ed4e8d640dbab6ade2b6d7bc98a851ccf4"}, "originalPosition": 99}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MjU2MDgyOnYy", "diffSide": "LEFT", "path": "xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMDoyNToyM1rOGlWExg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNDo1OTozN1rOGlfo7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgxMjE2Ng==", "bodyText": "The TODO is still valid.", "url": "https://github.com/grpc/grpc-java/pull/7130#discussion_r441812166", "createdAt": "2020-06-17T20:25:23Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java", "diffHunk": "@@ -80,19 +83,15 @@ public void handleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n         routeBalancers.get(actionName).switchTo(action.getProvider());\n       }\n     }\n-\n     this.routes = xdsRoutingConfig.routes;\n     this.actions = newActions;\n-\n     for (String actionName : actions.keySet()) {\n       routeBalancers.get(actionName).handleResolvedAddresses(\n           resolvedAddresses.toBuilder()\n               .setLoadBalancingPolicyConfig(actions.get(actionName).getConfig())\n               .build());\n     }\n \n-    // Cleanup removed actions.\n-    // TODO(zdapeng): cache removed actions for 15 minutes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "887a51ed4e8d640dbab6ade2b6d7bc98a851ccf4"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk2ODg3OQ==", "bodyText": "Implemented.", "url": "https://github.com/grpc/grpc-java/pull/7130#discussion_r441968879", "createdAt": "2020-06-18T04:59:37Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java", "diffHunk": "@@ -80,19 +83,15 @@ public void handleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n         routeBalancers.get(actionName).switchTo(action.getProvider());\n       }\n     }\n-\n     this.routes = xdsRoutingConfig.routes;\n     this.actions = newActions;\n-\n     for (String actionName : actions.keySet()) {\n       routeBalancers.get(actionName).handleResolvedAddresses(\n           resolvedAddresses.toBuilder()\n               .setLoadBalancingPolicyConfig(actions.get(actionName).getConfig())\n               .build());\n     }\n \n-    // Cleanup removed actions.\n-    // TODO(zdapeng): cache removed actions for 15 minutes.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgxMjE2Ng=="}, "originalCommit": {"oid": "887a51ed4e8d640dbab6ade2b6d7bc98a851ccf4"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1Mjk4NjYxOnYy", "diffSide": "RIGHT", "path": "xds/src/main/java/io/grpc/xds/RouteMatch.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMzowNjozOVrOGlaQAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNDo1OTozMFrOGlfo1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg4MDU3OA==", "bodyText": "nit: the following might be easier to follow\nfor (String value : values) {\n  if (exactMatch != null) {\n    baseMatch = exactMatch.equals(value);\n  } else if {\n    ...\n  }\n  if (baseMatch) {\n    break;\n  }\n}", "url": "https://github.com/grpc/grpc-java/pull/7130#discussion_r441880578", "createdAt": "2020-06-17T23:06:39Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/RouteMatch.java", "diffHunk": "@@ -196,6 +229,36 @@ public String toString() {\n       this.isInvertedMatch = isInvertedMatch;\n     }\n \n+    private boolean matchesValue(@Nullable Set<String> values) {\n+      if (presentMatch != null) {\n+        return (values == null) == presentMatch.equals(isInvertedMatch);\n+      }\n+      if (values == null) {\n+        return false;\n+      }\n+      boolean baseMatch = false;\n+      for (String value : values) {\n+        if (exactMatch != null) {\n+          baseMatch |= exactMatch.equals(value);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563ba55d0f0075c5abd9658bf45744ebd6c154a8"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk2ODg1NQ==", "bodyText": "Sure.", "url": "https://github.com/grpc/grpc-java/pull/7130#discussion_r441968855", "createdAt": "2020-06-18T04:59:30Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/RouteMatch.java", "diffHunk": "@@ -196,6 +229,36 @@ public String toString() {\n       this.isInvertedMatch = isInvertedMatch;\n     }\n \n+    private boolean matchesValue(@Nullable Set<String> values) {\n+      if (presentMatch != null) {\n+        return (values == null) == presentMatch.equals(isInvertedMatch);\n+      }\n+      if (values == null) {\n+        return false;\n+      }\n+      boolean baseMatch = false;\n+      for (String value : values) {\n+        if (exactMatch != null) {\n+          baseMatch |= exactMatch.equals(value);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg4MDU3OA=="}, "originalCommit": {"oid": "563ba55d0f0075c5abd9658bf45744ebd6c154a8"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1Mjk5NTE5OnYy", "diffSide": "RIGHT", "path": "xds/src/test/java/io/grpc/xds/RouteMatchTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMzoxMDo1NlrOGlaVBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNDo1OToyNVrOGlfowQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg4MTg2MQ==", "bodyText": "Why not just use Set<T> Collections.singleton(T o)", "url": "https://github.com/grpc/grpc-java/pull/7130#discussion_r441881861", "createdAt": "2020-06-17T23:10:56Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/test/java/io/grpc/xds/RouteMatchTest.java", "diffHunk": "@@ -0,0 +1,166 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.re2j.Pattern;\n+import io.grpc.xds.RouteMatch.FractionMatcher;\n+import io.grpc.xds.RouteMatch.HeaderMatcher;\n+import io.grpc.xds.RouteMatch.HeaderMatcher.Range;\n+import io.grpc.xds.RouteMatch.PathMatcher;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/** Tests for {@link RouteMatch}. */\n+public class RouteMatchTest {\n+\n+  private final Map<String, Set<String>> headers = new HashMap<>();\n+\n+  @Before\n+  public void setUp() {\n+    headers.put(\"content-type\", new HashSet<>(Collections.singletonList(\"application/grpc\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563ba55d0f0075c5abd9658bf45744ebd6c154a8"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk2ODgzMw==", "bodyText": "Yep, good to know.", "url": "https://github.com/grpc/grpc-java/pull/7130#discussion_r441968833", "createdAt": "2020-06-18T04:59:25Z", "author": {"login": "voidzcy"}, "path": "xds/src/test/java/io/grpc/xds/RouteMatchTest.java", "diffHunk": "@@ -0,0 +1,166 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.re2j.Pattern;\n+import io.grpc.xds.RouteMatch.FractionMatcher;\n+import io.grpc.xds.RouteMatch.HeaderMatcher;\n+import io.grpc.xds.RouteMatch.HeaderMatcher.Range;\n+import io.grpc.xds.RouteMatch.PathMatcher;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/** Tests for {@link RouteMatch}. */\n+public class RouteMatchTest {\n+\n+  private final Map<String, Set<String>> headers = new HashMap<>();\n+\n+  @Before\n+  public void setUp() {\n+    headers.put(\"content-type\", new HashSet<>(Collections.singletonList(\"application/grpc\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg4MTg2MQ=="}, "originalCommit": {"oid": "563ba55d0f0075c5abd9658bf45744ebd6c154a8"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTgyODQ0OnYy", "diffSide": "RIGHT", "path": "xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxODowMzowMVrOGmdOjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQyMjo1OToyMlrOGmi-Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk3NzkzNQ==", "bodyText": "I would not execute childLb.handleResolvedAddresses() when this.childLbStates and this.routes are in a half-baked state. In extreme case childLb.handleResolvedAddresses() may trigger balancing state update inline.", "url": "https://github.com/grpc/grpc-java/pull/7130#discussion_r442977935", "createdAt": "2020-06-19T18:03:01Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java", "diffHunk": "@@ -69,54 +79,47 @@ public void handleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n     logger.log(XdsLogLevel.DEBUG, \"Received resolution result: {0}\", resolvedAddresses);\n     XdsRoutingConfig xdsRoutingConfig =\n         (XdsRoutingConfig) resolvedAddresses.getLoadBalancingPolicyConfig();\n-    checkNotNull(xdsRoutingConfig, \"Missing xds_routing lb config\");\n     Map<String, PolicySelection> newActions = xdsRoutingConfig.actions;\n     for (String actionName : newActions.keySet()) {\n       PolicySelection action = newActions.get(actionName);\n-      if (!actions.containsKey(actionName)) {\n-        RouteHelper routeHelper = new RouteHelper();\n-        GracefulSwitchLoadBalancer routeBalancer = new GracefulSwitchLoadBalancer(routeHelper);\n-        routeBalancer.switchTo(action.getProvider());\n-        routeHelpers.put(actionName, routeHelper);\n-        routeBalancers.put(actionName, routeBalancer);\n-      } else if (!action.getProvider().equals(actions.get(actionName).getProvider())) {\n-        routeBalancers.get(actionName).switchTo(action.getProvider());\n+      if (!childLbStates.containsKey(actionName)) {\n+        childLbStates.put(actionName, new ChildLbState(actionName, action.getProvider()));\n+      } else {\n+        childLbStates.get(actionName).reactivate(action.getProvider());\n       }\n+      childLbStates.get(actionName).lb\n+          .handleResolvedAddresses(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9c7a2fc0c371bbdd28db183c76f4d68f81cd7f7"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3MjA3NA==", "bodyText": "You are right. Fixed.", "url": "https://github.com/grpc/grpc-java/pull/7130#discussion_r443072074", "createdAt": "2020-06-19T22:59:22Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java", "diffHunk": "@@ -69,54 +79,47 @@ public void handleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n     logger.log(XdsLogLevel.DEBUG, \"Received resolution result: {0}\", resolvedAddresses);\n     XdsRoutingConfig xdsRoutingConfig =\n         (XdsRoutingConfig) resolvedAddresses.getLoadBalancingPolicyConfig();\n-    checkNotNull(xdsRoutingConfig, \"Missing xds_routing lb config\");\n     Map<String, PolicySelection> newActions = xdsRoutingConfig.actions;\n     for (String actionName : newActions.keySet()) {\n       PolicySelection action = newActions.get(actionName);\n-      if (!actions.containsKey(actionName)) {\n-        RouteHelper routeHelper = new RouteHelper();\n-        GracefulSwitchLoadBalancer routeBalancer = new GracefulSwitchLoadBalancer(routeHelper);\n-        routeBalancer.switchTo(action.getProvider());\n-        routeHelpers.put(actionName, routeHelper);\n-        routeBalancers.put(actionName, routeBalancer);\n-      } else if (!action.getProvider().equals(actions.get(actionName).getProvider())) {\n-        routeBalancers.get(actionName).switchTo(action.getProvider());\n+      if (!childLbStates.containsKey(actionName)) {\n+        childLbStates.put(actionName, new ChildLbState(actionName, action.getProvider()));\n+      } else {\n+        childLbStates.get(actionName).reactivate(action.getProvider());\n       }\n+      childLbStates.get(actionName).lb\n+          .handleResolvedAddresses(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk3NzkzNQ=="}, "originalCommit": {"oid": "d9c7a2fc0c371bbdd28db183c76f4d68f81cd7f7"}, "originalPosition": 71}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2538, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}