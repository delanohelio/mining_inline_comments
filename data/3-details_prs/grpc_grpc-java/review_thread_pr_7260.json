{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MTE2NDY4", "number": 7260, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxOTo1Njo1OFrOETZ40A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMjoxMzo0NVrOETclIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NzgyNTQ0OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/io/grpc/InternalConfigSelector.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxOTo1Njo1OFrOG5H4TA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxOTo1Njo1OFrOG5H4TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1MTExNg==", "bodyText": "nit: Creates", "url": "https://github.com/grpc/grpc-java/pull/7260#discussion_r462551116", "createdAt": "2020-07-29T19:56:58Z", "author": {"login": "dapengzhang0"}, "path": "api/src/main/java/io/grpc/InternalConfigSelector.java", "diffHunk": "@@ -37,28 +38,51 @@\n   public abstract Result selectConfig(LoadBalancer.PickSubchannelArgs args);\n \n   public static final class Result {\n+    private final Status status;\n+    @Nullable\n     private final Object config;\n+    @Nullable\n     private final CallOptions callOptions;\n     @Nullable\n     private final Runnable committedCallback;\n \n-    private Result(Object config, CallOptions callOptions, @Nullable Runnable committedCallback) {\n-      this.config = checkNotNull(config, \"config\");\n-      this.callOptions = checkNotNull(callOptions, \"callOptions\");\n+    private Result(\n+        Status status, Object config, CallOptions callOptions, Runnable committedCallback) {\n+      this.status = checkNotNull(status, \"status\");\n+      this.config = config;\n+      this.callOptions = callOptions;\n       this.committedCallback = committedCallback;\n     }\n \n+    /**\n+     * Create a {@code Result} with the given error status.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "524371b2e937e51f3bab57c6ef61433887656223"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NzgzMjg2OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/io/grpc/InternalConfigSelector.java", "isResolved": false, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxOTo1OToyMVrOG5H9HQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzowNjo1NVrOG5NUOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1MjM0OQ==", "bodyText": "config and callOptions here must not be null", "url": "https://github.com/grpc/grpc-java/pull/7260#discussion_r462552349", "createdAt": "2020-07-29T19:59:21Z", "author": {"login": "dapengzhang0"}, "path": "api/src/main/java/io/grpc/InternalConfigSelector.java", "diffHunk": "@@ -113,7 +137,7 @@ public Builder setCommittedCallback(@Nullable Runnable committedCallback) {\n       }\n \n       public Result build() {\n-        return new Result(config, callOptions, committedCallback);\n+        return new Result(Status.OK, config, callOptions, committedCallback);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "524371b2e937e51f3bab57c6ef61433887656223"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3NTU1Nw==", "bodyText": "Why they must not be null? For cases the status is not OK.", "url": "https://github.com/grpc/grpc-java/pull/7260#discussion_r462575557", "createdAt": "2020-07-29T20:41:37Z", "author": {"login": "voidzcy"}, "path": "api/src/main/java/io/grpc/InternalConfigSelector.java", "diffHunk": "@@ -113,7 +137,7 @@ public Builder setCommittedCallback(@Nullable Runnable committedCallback) {\n       }\n \n       public Result build() {\n-        return new Result(config, callOptions, committedCallback);\n+        return new Result(Status.OK, config, callOptions, committedCallback);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1MjM0OQ=="}, "originalCommit": {"oid": "524371b2e937e51f3bab57c6ef61433887656223"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3ODk1Ng==", "bodyText": "For cases is OK, they must be not null.", "url": "https://github.com/grpc/grpc-java/pull/7260#discussion_r462578956", "createdAt": "2020-07-29T20:48:08Z", "author": {"login": "dapengzhang0"}, "path": "api/src/main/java/io/grpc/InternalConfigSelector.java", "diffHunk": "@@ -113,7 +137,7 @@ public Builder setCommittedCallback(@Nullable Runnable committedCallback) {\n       }\n \n       public Result build() {\n-        return new Result(config, callOptions, committedCallback);\n+        return new Result(Status.OK, config, callOptions, committedCallback);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1MjM0OQ=="}, "originalCommit": {"oid": "524371b2e937e51f3bab57c6ef61433887656223"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYwMDExNA==", "bodyText": "Ok, checked. Does this really provide a stronger API guarantee or it only weakens the specification by requiring a stronger precondition?", "url": "https://github.com/grpc/grpc-java/pull/7260#discussion_r462600114", "createdAt": "2020-07-29T21:28:26Z", "author": {"login": "voidzcy"}, "path": "api/src/main/java/io/grpc/InternalConfigSelector.java", "diffHunk": "@@ -113,7 +137,7 @@ public Builder setCommittedCallback(@Nullable Runnable committedCallback) {\n       }\n \n       public Result build() {\n-        return new Result(config, callOptions, committedCallback);\n+        return new Result(Status.OK, config, callOptions, committedCallback);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1MjM0OQ=="}, "originalCommit": {"oid": "524371b2e937e51f3bab57c6ef61433887656223"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxMjE0Mg==", "bodyText": "We should specify the Result must be either with error status (all other fields are ignored), or with OK status in which case config (parsed config) and callOptions are not null.", "url": "https://github.com/grpc/grpc-java/pull/7260#discussion_r462612142", "createdAt": "2020-07-29T21:54:24Z", "author": {"login": "dapengzhang0"}, "path": "api/src/main/java/io/grpc/InternalConfigSelector.java", "diffHunk": "@@ -113,7 +137,7 @@ public Builder setCommittedCallback(@Nullable Runnable committedCallback) {\n       }\n \n       public Result build() {\n-        return new Result(config, callOptions, committedCallback);\n+        return new Result(Status.OK, config, callOptions, committedCallback);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1MjM0OQ=="}, "originalCommit": {"oid": "524371b2e937e51f3bab57c6ef61433887656223"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxNzgzOA==", "bodyText": "It's mentioned in getStatus().", "url": "https://github.com/grpc/grpc-java/pull/7260#discussion_r462617838", "createdAt": "2020-07-29T22:07:14Z", "author": {"login": "voidzcy"}, "path": "api/src/main/java/io/grpc/InternalConfigSelector.java", "diffHunk": "@@ -113,7 +137,7 @@ public Builder setCommittedCallback(@Nullable Runnable committedCallback) {\n       }\n \n       public Result build() {\n-        return new Result(config, callOptions, committedCallback);\n+        return new Result(Status.OK, config, callOptions, committedCallback);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1MjM0OQ=="}, "originalCommit": {"oid": "524371b2e937e51f3bab57c6ef61433887656223"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY0MDE4Nw==", "bodyText": "It's not mentioning \"with OK status, callOptions is not null.\" I'm not going to be nagging on about this. LGTM.", "url": "https://github.com/grpc/grpc-java/pull/7260#discussion_r462640187", "createdAt": "2020-07-29T23:06:55Z", "author": {"login": "dapengzhang0"}, "path": "api/src/main/java/io/grpc/InternalConfigSelector.java", "diffHunk": "@@ -113,7 +137,7 @@ public Builder setCommittedCallback(@Nullable Runnable committedCallback) {\n       }\n \n       public Result build() {\n-        return new Result(config, callOptions, committedCallback);\n+        return new Result(Status.OK, config, callOptions, committedCallback);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1MjM0OQ=="}, "originalCommit": {"oid": "524371b2e937e51f3bab57c6ef61433887656223"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODI2NjU2OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/io/grpc/InternalConfigSelector.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMjoxMzo0NVrOG5MHOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMjozMTo1MlrOG5Mj_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYyMDQ3Mg==", "bodyText": "@Nullable is misleading. Although it is nullable from the programing language point of view. The null case is when status is an error you call getConfig(), which is wrong usecase. The only true @Nullable is getCommittedCallback().", "url": "https://github.com/grpc/grpc-java/pull/7260#discussion_r462620472", "createdAt": "2020-07-29T22:13:45Z", "author": {"login": "dapengzhang0"}, "path": "api/src/main/java/io/grpc/InternalConfigSelector.java", "diffHunk": "@@ -37,28 +39,51 @@\n   public abstract Result selectConfig(LoadBalancer.PickSubchannelArgs args);\n \n   public static final class Result {\n+    private final Status status;\n+    @Nullable\n     private final Object config;\n+    @Nullable\n     private final CallOptions callOptions;\n     @Nullable\n     private final Runnable committedCallback;\n \n-    private Result(Object config, CallOptions callOptions, @Nullable Runnable committedCallback) {\n-      this.config = checkNotNull(config, \"config\");\n-      this.callOptions = checkNotNull(callOptions, \"callOptions\");\n+    private Result(\n+        Status status, Object config, CallOptions callOptions, Runnable committedCallback) {\n+      this.status = checkNotNull(status, \"status\");\n+      this.config = config;\n+      this.callOptions = callOptions;\n       this.committedCallback = committedCallback;\n     }\n \n+    /**\n+     * Creates a {@code Result} with the given error status.\n+     */\n+    public static Result forError(Status status) {\n+      checkArgument(!status.isOk(), \"status is OK\");\n+      return new Result(status, null, null, null);\n+    }\n+\n+    /**\n+     * Returns the status of the config selection operation. If status is not {@link Status#OK},\n+     * this result should not be used.\n+     */\n+    public Status getStatus() {\n+      return status;\n+    }\n+\n     /**\n      * Returns a parsed config. Must have been returned via\n      * ServiceConfigParser.parseServiceConfig().getConfig()\n      */\n+    @Nullable\n     public Object getConfig() {\n       return config;\n     }\n \n     /**\n      * Returns a config-selector-modified CallOptions for the RPC.\n      */\n+    @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "532ac5a58c85c426c9ee59388bbbeb3d14ab0f8f"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYyNzgzOQ==", "bodyText": "From the pure API point of view (just as how a checker framework or IDE uses this annotation), this Nullable is legit. For API integrity, nothing can prevent the API consumer calling getConfig() even if the Result is with an error status. It would be the consumer's responsibility to use it correctly. But as the API provider, it should tell what is indeed happening.\nSimilar case is for PickResult. This is the limitation of such an API.", "url": "https://github.com/grpc/grpc-java/pull/7260#discussion_r462627839", "createdAt": "2020-07-29T22:31:52Z", "author": {"login": "voidzcy"}, "path": "api/src/main/java/io/grpc/InternalConfigSelector.java", "diffHunk": "@@ -37,28 +39,51 @@\n   public abstract Result selectConfig(LoadBalancer.PickSubchannelArgs args);\n \n   public static final class Result {\n+    private final Status status;\n+    @Nullable\n     private final Object config;\n+    @Nullable\n     private final CallOptions callOptions;\n     @Nullable\n     private final Runnable committedCallback;\n \n-    private Result(Object config, CallOptions callOptions, @Nullable Runnable committedCallback) {\n-      this.config = checkNotNull(config, \"config\");\n-      this.callOptions = checkNotNull(callOptions, \"callOptions\");\n+    private Result(\n+        Status status, Object config, CallOptions callOptions, Runnable committedCallback) {\n+      this.status = checkNotNull(status, \"status\");\n+      this.config = config;\n+      this.callOptions = callOptions;\n       this.committedCallback = committedCallback;\n     }\n \n+    /**\n+     * Creates a {@code Result} with the given error status.\n+     */\n+    public static Result forError(Status status) {\n+      checkArgument(!status.isOk(), \"status is OK\");\n+      return new Result(status, null, null, null);\n+    }\n+\n+    /**\n+     * Returns the status of the config selection operation. If status is not {@link Status#OK},\n+     * this result should not be used.\n+     */\n+    public Status getStatus() {\n+      return status;\n+    }\n+\n     /**\n      * Returns a parsed config. Must have been returned via\n      * ServiceConfigParser.parseServiceConfig().getConfig()\n      */\n+    @Nullable\n     public Object getConfig() {\n       return config;\n     }\n \n     /**\n      * Returns a config-selector-modified CallOptions for the RPC.\n      */\n+    @Nullable", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYyMDQ3Mg=="}, "originalCommit": {"oid": "532ac5a58c85c426c9ee59388bbbeb3d14ab0f8f"}, "originalPosition": 61}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2419, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}