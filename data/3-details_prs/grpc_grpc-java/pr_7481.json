{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3MTY4NTMy", "number": 7481, "title": "xds: implement xDS timeout", "bodyText": "Implements the xDS timeout feature. See details in gRFC-A31.\nEach Route (converted) contains the per-route timeout setting that is from RouteAction.max_stream_duration.grpc_timeout_header_max or RouteAction.max_stream_duration.max_stream_duration if the former is not set in the xDS protocol. It falls back to the max_stream_duration setting in HttpConnectionManager.common_http_options if neither of the previous two is set.\n\nSome caveats:\n\nThe effective fallback httpMaxStreamDuration value should be consistent with routes selected by ConfigSelector (aka, RPC). Consider the following scenario:\n\nt=t1, receives an LDS update with httpMaxStreamDuration = 2s and a list of routes (L1) for the targeted authority. None of the routes have per-route timeout value set. So after calls are able to pick up the latest config selector, they will have timeout value of 2s.\nt=t2, receives an LDS update with httpMaxStreamDuration = 5s and an RDS resource name. So the resolver starts subscribing to the corresponding RDS resource.\nt=t3, receives an RDS update for the subscribed RDS resource containing a list of routes (L2). None of the routes have per-route timeout value set.\n\n\n\nNote calls started between t1 and t3 should have timeout value set to 2s. Only after t3, the calls started with the latest config selector will have timeout value set to 5s. That is, the timeout value of 2s should be configured for the list of routes L1 and the timeout value of 5s should be configured for the list of routes L2. Before the config selector updates to select from L2, the fallback timeout value should have not been updated.", "createdAt": "2020-10-02T22:58:06Z", "url": "https://github.com/grpc/grpc-java/pull/7481", "merged": true, "mergeCommit": {"oid": "d25f5acf1f6eaf0abb9262313d9f003dae495dab"}, "closed": true, "closedAt": "2020-10-15T00:53:31Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOuOv3gBqjM4MzU4OTU5MDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSmkYQABqjM4NzkwMTk0MDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "24e1886f99ce2b03b41e8033692c5652e7949c3f", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/24e1886f99ce2b03b41e8033692c5652e7949c3f", "committedDate": "2020-10-02T22:56:15Z", "message": "Retrieve timeout value from RouteAction's max_stream_duration."}, "afterCommit": {"oid": "58e6038400834b2e405077692e42e3bd897b7aa9", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/58e6038400834b2e405077692e42e3bd897b7aa9", "committedDate": "2020-10-02T23:03:43Z", "message": "Retrieve timeout value from RouteAction's max_stream_duration."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e103a9eda6315831bd0926aeee09b14ba3135128", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/e103a9eda6315831bd0926aeee09b14ba3135128", "committedDate": "2020-10-05T20:31:33Z", "message": "Retrieve timeout value from RouteAction's max_stream_duration."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "58e6038400834b2e405077692e42e3bd897b7aa9", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/58e6038400834b2e405077692e42e3bd897b7aa9", "committedDate": "2020-10-02T23:03:43Z", "message": "Retrieve timeout value from RouteAction's max_stream_duration."}, "afterCommit": {"oid": "e103a9eda6315831bd0926aeee09b14ba3135128", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/e103a9eda6315831bd0926aeee09b14ba3135128", "committedDate": "2020-10-05T20:31:33Z", "message": "Retrieve timeout value from RouteAction's max_stream_duration."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0642c4a0e551f71cae017dc7deaac3e5dc231541", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/0642c4a0e551f71cae017dc7deaac3e5dc231541", "committedDate": "2020-10-08T20:36:26Z", "message": "Fix the bug of setting the wrong field."}, "afterCommit": {"oid": "d2c53f6d833944aff19dba52741ed3ead95bbe37", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/d2c53f6d833944aff19dba52741ed3ead95bbe37", "committedDate": "2020-10-08T21:17:51Z", "message": "Fix the bug of setting the wrong field."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MTkwOTEw", "url": "https://github.com/grpc/grpc-java/pull/7481#pullrequestreview-505190910", "createdAt": "2020-10-08T21:49:57Z", "commit": {"oid": "e25669edbddd46f229b567da25215d9e71717d97"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMTo0OTo1N1rOHexoNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMTo0OTo1N1rOHexoNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzMjQzOQ==", "bodyText": "Note there is a race between updating currentRoutes and fallbackTimeoutNano. The config selector might select a route from the updated currentRoutes list while using the old fallbackTimeoutNano. That is, these two updates should be atomic but actually it is not. The race window should be extremely small (should be almost negligible).\nOne option is to create a data structure that groups these two fields so that the update can be atomic. But given the race window is small, may not be necessary to do that.", "url": "https://github.com/grpc/grpc-java/pull/7481#discussion_r502032439", "createdAt": "2020-10-08T21:49:57Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsNameResolver.java", "diffHunk": "@@ -511,6 +522,7 @@ private void updateRoutes(List<VirtualHost> virtualHosts) {\n       // Make newly added clusters selectable by config selector and deleted clusters no longer\n       // selectable.\n       currentRoutes = routes;\n+      fallbackTimeoutNano = httpMaxStreamDurationNano;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e25669edbddd46f229b567da25215d9e71717d97"}, "originalPosition": 55}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "18b23af396c44b4c14de6a38c22f500c3ad2edc6", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/18b23af396c44b4c14de6a38c22f500c3ad2edc6", "committedDate": "2020-10-08T22:11:06Z", "message": "Add comments for RoutingConfig"}, "afterCommit": {"oid": "bd82d8ec656515c66560f9acb451b7fa32cbfb05", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/bd82d8ec656515c66560f9acb451b7fa32cbfb05", "committedDate": "2020-10-12T22:50:32Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/xds_timeout_with_max_stream_duration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8276e3de61ba1338b67c0378f01302f738a4e8b2", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/8276e3de61ba1338b67c0378f01302f738a4e8b2", "committedDate": "2020-10-12T23:23:35Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/xds_timeout_with_max_stream_duration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "baaba746349e7e4c5bee418d71023327aef76d86", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/baaba746349e7e4c5bee418d71023327aef76d86", "committedDate": "2020-10-12T23:34:35Z", "message": "Fix number style."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49c14d25f4545b208121a1c29eef9a6a3f579a45", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/49c14d25f4545b208121a1c29eef9a6a3f579a45", "committedDate": "2020-10-12T23:36:11Z", "message": "Generate service config with method config containing timeout configuration that falls back to LDS's http protocol option max stream duration."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd82d8ec656515c66560f9acb451b7fa32cbfb05", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/bd82d8ec656515c66560f9acb451b7fa32cbfb05", "committedDate": "2020-10-12T22:50:32Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/xds_timeout_with_max_stream_duration"}, "afterCommit": {"oid": "49c14d25f4545b208121a1c29eef9a6a3f579a45", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/49c14d25f4545b208121a1c29eef9a6a3f579a45", "committedDate": "2020-10-12T23:36:11Z", "message": "Generate service config with method config containing timeout configuration that falls back to LDS's http protocol option max stream duration."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NzkzODY0", "url": "https://github.com/grpc/grpc-java/pull/7481#pullrequestreview-508793864", "createdAt": "2020-10-14T21:47:49Z", "commit": {"oid": "49c14d25f4545b208121a1c29eef9a6a3f579a45"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTo0Nzo1MFrOHhmRkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTo0Nzo1MFrOHhmRkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk5MjE0NA==", "bodyText": "I think we should expose hasMaxStreamDuration() based on the 3rd bullet point in https://github.com/grpc/proposal/blob/master/A31-xds-timeout-support-and-config-selector.md#supported-fields\nWe can not simply check timeoutNano == 0 instead of maxStreamDuration.hasMaxStreamDuration()). Two cases that's not working as spec:\n\n\nCase 1: maxStreamDuration.hasGrpcTimeoutHeaderMax() and maxStreamDuration.getGrpcTimeoutHeaderMax() == 0. In this case, we should use 0 regardless of value of fallback timeout.\n\n\nCase 2: !maxStreamDuration.hasGrpcTimeoutHeaderMax() and maxStreamDuration.hasMaxStreamDuration() and maxStreamDuration.getMaxStreamDuration() == 0. In this case, we should use 0 regardless of value of fallback timeout.", "url": "https://github.com/grpc/grpc-java/pull/7481#discussion_r504992144", "createdAt": "2020-10-14T21:47:50Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -1231,14 +1230,15 @@ public String toString() {\n           return StructOrError.fromError(\n               \"Unknown cluster specifier: \" + proto.getClusterSpecifierCase());\n       }\n-      long timeoutNano = TimeUnit.SECONDS.toNanos(15L);  // default 15s\n-      if (proto.hasMaxGrpcTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getMaxGrpcTimeout());\n-      } else if (proto.hasTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getTimeout());\n-      }\n-      if (timeoutNano == 0) {\n-        timeoutNano = Long.MAX_VALUE;\n+      long timeoutNano = 0L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49c14d25f4545b208121a1c29eef9a6a3f579a45"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77c9ba2fb6b2eeb3bf4ce81451e850afa02d790e", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/77c9ba2fb6b2eeb3bf4ce81451e850afa02d790e", "committedDate": "2020-10-14T23:20:23Z", "message": "Explicitly set value of 0 in RouteAction is different than unset. Fallback should not happen if the timeout value in RouteAction is set (including 0)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODQ5NjQ3", "url": "https://github.com/grpc/grpc-java/pull/7481#pullrequestreview-508849647", "createdAt": "2020-10-14T23:59:37Z", "commit": {"oid": "77c9ba2fb6b2eeb3bf4ce81451e850afa02d790e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d488707b8aa5180892d1417ebc7977b835da63a3", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/d488707b8aa5180892d1417ebc7977b835da63a3", "committedDate": "2020-10-15T00:23:45Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/xds_timeout_with_max_stream_duration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "076adf23b94d459023be3f30182c1def08f63ed1", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/076adf23b94d459023be3f30182c1def08f63ed1", "committedDate": "2020-10-15T00:06:10Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/xds_timeout_with_max_stream_duration"}, "afterCommit": {"oid": "d488707b8aa5180892d1417ebc7977b835da63a3", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/d488707b8aa5180892d1417ebc7977b835da63a3", "committedDate": "2020-10-15T00:23:45Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/xds_timeout_with_max_stream_duration"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4070, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}