{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2MTkzOTQz", "number": 7081, "title": "xds: no longer use existing Subchannels after xDS resource becomes unavailable", "bodyText": "Put Channel into TRANSIENT_FAILURE when CDS/EDS resource that is currently being watched becomes unavailable.\n\nFor CDS policy, it simply shuts down its child EDS policy and propagate TRANSIENT_FAILURE to its parent policy.\nFor EDS policy, existing LocalityStore.reset() works similar to shutting down downstream balancers and doing cleanup. Whether or not stop load reporting for current {cluster:eds_service} (note EDS resource = if eds_service != null then eds_service else cluster) is an open question. In this change, it will be stopped.\n\nTests for EdsLoadBalancer is sort of messy, largely because we are also trying to maintain the functionality of it being working alone (although the internal interop tests for real use cases had been deleted). It might get cleaner after we eliminate LocalityStore.", "createdAt": "2020-06-01T20:21:05Z", "url": "https://github.com/grpc/grpc-java/pull/7081", "merged": true, "mergeCommit": {"oid": "26cf60d8c7f84697bb043d2f136158188bdc1202"}, "closed": true, "closedAt": "2020-06-03T01:51:40Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnGJGfAH2gAyNDI2MTkzOTQzOmE5ZTIwY2FjMTIxZjVjZDA2YjY1ZGQ1MTE4NmNmOWFlM2E5ODMzZDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnecAKAFqTQyMzE0NTIzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a9e20cac121f5cd06b65dd51186cf9ae3a9833d5", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/a9e20cac121f5cd06b65dd51186cf9ae3a9833d5", "committedDate": "2020-06-01T20:18:30Z", "message": "Shut down EDS downstream balancers when the watched EDS resource becomes unavailable."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db58599447cf9acb8235a3a7bbf72e1c02186597", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/db58599447cf9acb8235a3a7bbf72e1c02186597", "committedDate": "2020-06-01T20:19:06Z", "message": "Shut down CDS downstream balancers immediately when the watched CDS resource becomes unavailable."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMTEwNDY3", "url": "https://github.com/grpc/grpc-java/pull/7081#pullrequestreview-423110467", "createdAt": "2020-06-02T22:54:19Z", "commit": {"oid": "db58599447cf9acb8235a3a7bbf72e1c02186597"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMjo1NDoxOVrOGeGlnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMzoxNToxN1rOGeG_ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIxODM5OQ==", "bodyText": "Need change the comment of the edsBalancer field.", "url": "https://github.com/grpc/grpc-java/pull/7081#discussion_r434218399", "createdAt": "2020-06-02T22:54:19Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/CdsLoadBalancer.java", "diffHunk": "@@ -325,15 +325,14 @@ private void updateSslContextProvider(UpstreamTlsContext newUpstreamTlsContext)\n     @Override\n     public void onResourceDoesNotExist(String resourceName) {\n       logger.log(XdsLogLevel.INFO, \"Resource {0} is unavailable\", resourceName);\n-      // TODO(chengyuanzhang): should unconditionally propagate to downstream instances and\n-      //  go to TRANSIENT_FAILURE.\n-      if (edsBalancer == null) {\n-        helper.updateBalancingState(\n-            TRANSIENT_FAILURE,\n-            new ErrorPicker(\n-                Status.UNAVAILABLE.withDescription(\n-                    \"Resource \" + resourceName + \" is unavailable\")));\n+      if (edsBalancer != null) {\n+        edsBalancer.shutdown();\n+        edsBalancer = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db58599447cf9acb8235a3a7bbf72e1c02186597"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIyNTAzNA==", "bodyText": "Also set edsBalancer = null at https://github.com/grpc/grpc-java/pull/7081/files#diff-78c989ecc725727447eb9aaf38e31055R182 to avoid edsBalancer double shutdown.", "url": "https://github.com/grpc/grpc-java/pull/7081#discussion_r434225034", "createdAt": "2020-06-02T23:15:17Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/CdsLoadBalancer.java", "diffHunk": "@@ -325,15 +325,14 @@ private void updateSslContextProvider(UpstreamTlsContext newUpstreamTlsContext)\n     @Override\n     public void onResourceDoesNotExist(String resourceName) {\n       logger.log(XdsLogLevel.INFO, \"Resource {0} is unavailable\", resourceName);\n-      // TODO(chengyuanzhang): should unconditionally propagate to downstream instances and\n-      //  go to TRANSIENT_FAILURE.\n-      if (edsBalancer == null) {\n-        helper.updateBalancingState(\n-            TRANSIENT_FAILURE,\n-            new ErrorPicker(\n-                Status.UNAVAILABLE.withDescription(\n-                    \"Resource \" + resourceName + \" is unavailable\")));\n+      if (edsBalancer != null) {\n+        edsBalancer.shutdown();\n+        edsBalancer = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db58599447cf9acb8235a3a7bbf72e1c02186597"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c73d36320539d6e76afe098178c79ed0aaa7423", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/5c73d36320539d6e76afe098178c79ed0aaa7423", "committedDate": "2020-06-03T00:28:52Z", "message": "Remove comment, child balancer will be shutted down if resource does not exist. When the resource is added back, it will be recreated."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMTQ1MjM0", "url": "https://github.com/grpc/grpc-java/pull/7081#pullrequestreview-423145234", "createdAt": "2020-06-03T00:36:52Z", "commit": {"oid": "5c73d36320539d6e76afe098178c79ed0aaa7423"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4456, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}