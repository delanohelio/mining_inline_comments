{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2NzQ3NTM0", "number": 6637, "title": "core, grpclb: change policy selection strategy for Grpclb policy (take one: eliminate special logic for deciding grpclb policy in core)", "bodyText": "In this take:\n\nDnsNameResolver returns balancer addresses as a GrpcAttributes.ATTR_LB_ADDRS attribute in ResolutionResult.\nAutoConfiguredLoadBalancerFactory decides LB policy solely based on parsed service config without looking at resolved addresses. Behavior changes:\n\nIf no LB policy is specified in service config, default to pick_first, even if there exist balancer addresses.\nIf grpclb specified but not available and no other specified policies available, it will fail without fallback to round_robin.\n\n\nGrpclbLoadBalancer populates balancer addresses from ResolvedAddresses's attribute (GrpclbConstants.ATTR_LB_ADDRS) instead of sieving from addresses.\n\nNext step after this change is to separate logic for querying SRV record in DnsNameResolver to a grpclb specific resolver.", "createdAt": "2020-01-24T09:30:11Z", "url": "https://github.com/grpc/grpc-java/pull/6637", "merged": true, "mergeCommit": {"oid": "c0f37e59abc40d699d85aaed5b10f100feb6908e"}, "closed": true, "closedAt": "2020-01-31T18:41:44Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9bhWBAH2gAyMzY2NzQ3NTM0OjVjYTgwNTRhMDBjM2Y1NjE0YTk4YjQyOTNjNmEyNGRkOTdiNjljN2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_jke2gBqjI5OTUzNTM3OTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5ca8054a00c3f5614a98b4293c6a24dd97b69c7c", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/5ca8054a00c3f5614a98b4293c6a24dd97b69c7c", "committedDate": "2020-01-24T09:28:10Z", "message": "Change DNS resolver to return balancer addresses as attributes of resolution result. Change AutoConfiguredLoadBalancerFactory to choose LB policy purely based on lb policy config in service config. GrpclbLoadBalancer populates balancer address from attributes instead of from addresses."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e33ec5ec22afee34f38bf5320aee6d79c4016b9", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/4e33ec5ec22afee34f38bf5320aee6d79c4016b9", "committedDate": "2020-01-25T01:04:12Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/grpclb_selection_change_take_one"}, "afterCommit": {"oid": "c090767035fdce2da6f135b61d181516bc6cf96f", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/c090767035fdce2da6f135b61d181516bc6cf96f", "committedDate": "2020-01-27T08:36:28Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/grpclb_selection_change_take_one"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da29532e15f103810235ce354de4f366329b953e", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/da29532e15f103810235ce354de4f366329b953e", "committedDate": "2020-01-27T08:44:32Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/grpclb_selection_change_take_one"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c090767035fdce2da6f135b61d181516bc6cf96f", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/c090767035fdce2da6f135b61d181516bc6cf96f", "committedDate": "2020-01-27T08:36:28Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/grpclb_selection_change_take_one"}, "afterCommit": {"oid": "da29532e15f103810235ce354de4f366329b953e", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/da29532e15f103810235ce354de4f366329b953e", "committedDate": "2020-01-27T08:44:32Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/grpclb_selection_change_take_one"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c817b6f38f3e6079a834ef830642450512777792", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/c817b6f38f3e6079a834ef830642450512777792", "committedDate": "2020-01-27T18:03:06Z", "message": "Add annotation for LB addrs attributes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MDU4OTc1", "url": "https://github.com/grpc/grpc-java/pull/6637#pullrequestreview-349058975", "createdAt": "2020-01-28T00:03:16Z", "commit": {"oid": "c817b6f38f3e6079a834ef830642450512777792"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwMDowMzoxNlrOFiVn0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwMDoyMjoyMlrOFiV7uA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1MDE2MA==", "bodyText": "can you also remove the ResolvedPolicySelection class?", "url": "https://github.com/grpc/grpc-java/pull/6637#discussion_r371550160", "createdAt": "2020-01-28T00:03:16Z", "author": {"login": "creamsoup"}, "path": "core/src/main/java/io/grpc/internal/AutoConfiguredLoadBalancerFactory.java", "diffHunk": "@@ -125,48 +120,53 @@ Status tryHandleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n       }\n       PolicySelection policySelection =\n           (PolicySelection) resolvedAddresses.getLoadBalancingPolicyConfig();\n-      ResolvedPolicySelection resolvedSelection;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c817b6f38f3e6079a834ef830642450512777792"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1MTY3MQ==", "bodyText": "this will be overwritten in some case where it execute L330. it looks like we should have both.", "url": "https://github.com/grpc/grpc-java/pull/6637#discussion_r371551671", "createdAt": "2020-01-28T00:08:40Z", "author": {"login": "creamsoup"}, "path": "core/src/main/java/io/grpc/internal/DnsNameResolver.java", "diffHunk": "@@ -293,19 +293,24 @@ public void run() {\n             Status.UNAVAILABLE.withDescription(\"Unable to resolve host \" + host).withCause(e));\n         return;\n       }\n+      if (resolutionResults.addresses.isEmpty() && resolutionResults.balancerAddresses.isEmpty()) {\n+        savedListener.onError(Status.UNAVAILABLE.withDescription(\n+            \"No DNS backend or balancer addresses found for \" + host));\n+        return;\n+      }\n       // Each address forms an EAG\n       List<EquivalentAddressGroup> servers = new ArrayList<>();\n       for (InetAddress inetAddr : resolutionResults.addresses) {\n         servers.add(new EquivalentAddressGroup(new InetSocketAddress(inetAddr, port)));\n       }\n-      servers.addAll(resolutionResults.balancerAddresses);\n-      if (servers.isEmpty()) {\n-        savedListener.onError(Status.UNAVAILABLE.withDescription(\n-            \"No DNS backend or balancer addresses found for \" + host));\n-        return;\n-      }\n \n-      ResolutionResult.Builder resultBuilder = ResolutionResult.newBuilder().setAddresses(servers);\n+      ResolutionResult.Builder resultBuilder =\n+          ResolutionResult.newBuilder()\n+              .setAddresses(servers)\n+              .setAttributes(\n+                  Attributes.newBuilder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c817b6f38f3e6079a834ef830642450512777792"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1MzE4NQ==", "bodyText": "it makes sense it is here. but it is quite different than proposal. can you update the wrong one?", "url": "https://github.com/grpc/grpc-java/pull/6637#discussion_r371553185", "createdAt": "2020-01-28T00:14:29Z", "author": {"login": "creamsoup"}, "path": "core/src/main/java/io/grpc/internal/GrpcAttributes.java", "diffHunk": "@@ -37,6 +38,10 @@\n   public static final Attributes.Key<Map<String, ?>> NAME_RESOLVER_SERVICE_CONFIG =\n       Attributes.Key.create(\"service-config\");\n \n+  @NameResolver.ResolutionResultAttr\n+  public static final Attributes.Key<List<EquivalentAddressGroup>> ATTR_LB_ADDRS =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c817b6f38f3e6079a834ef830642450512777792"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1NTI1Ng==", "bodyText": "oh i may need to fix\nhttps://github.com/grpc/grpc-java/blob/master/core/src/main/java/io/grpc/internal/ManagedChannelImpl.java#L1388", "url": "https://github.com/grpc/grpc-java/pull/6637#discussion_r371555256", "createdAt": "2020-01-28T00:22:22Z", "author": {"login": "creamsoup"}, "path": "grpclb/src/main/java/io/grpc/grpclb/GrpclbLoadBalancer.java", "diffHunk": "@@ -184,6 +185,11 @@ public void handleNameResolutionError(Status error) {\n     }\n   }\n \n+  @Override\n+  public boolean canHandleEmptyAddressListFromNameResolution() {\n+    return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c817b6f38f3e6079a834ef830642450512777792"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fccafe4b573c1fc68fdb0422e48f2d704bbb086", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/3fccafe4b573c1fc68fdb0422e48f2d704bbb086", "committedDate": "2020-01-28T09:33:28Z", "message": "Resolver can return empty result and let LB policy handle the error of no usable addresses."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f02a7fab6dc898c853168bc414afb861d6a43f89", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/f02a7fab6dc898c853168bc414afb861d6a43f89", "committedDate": "2020-01-28T18:05:11Z", "message": "Do not set ATTR_LB_ADDRS for test if resolved addresses do not contain balancer addresses, this mirrors the real behavior of DnsNameResolver."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19d2d7c0100a4f0d8e8fb90900d4e931294bd63a", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/19d2d7c0100a4f0d8e8fb90900d4e931294bd63a", "committedDate": "2020-01-28T18:06:37Z", "message": "Fix attributes being overwritten."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a9d6a40944a1eef4dfe808a11f822ca7aa9ea6aa", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/a9d6a40944a1eef4dfe808a11f822ca7aa9ea6aa", "committedDate": "2020-01-28T09:39:27Z", "message": "Do not set ATTR_LB_ADDR if not balancer addresses specified for test, mirror what DnsNameResolver is doing."}, "afterCommit": {"oid": "b428ae3538353a45b0c8b703e5c876c1fde5c291", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/b428ae3538353a45b0c8b703e5c876c1fde5c291", "committedDate": "2020-01-28T18:07:05Z", "message": "Delete no longer used class."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5adefa9b5760870406d41bf4d9beedde11819a9a", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/5adefa9b5760870406d41bf4d9beedde11819a9a", "committedDate": "2020-01-28T23:03:23Z", "message": "Delete no longer used class."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b428ae3538353a45b0c8b703e5c876c1fde5c291", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/b428ae3538353a45b0c8b703e5c876c1fde5c291", "committedDate": "2020-01-28T18:07:05Z", "message": "Delete no longer used class."}, "afterCommit": {"oid": "5adefa9b5760870406d41bf4d9beedde11819a9a", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/5adefa9b5760870406d41bf4d9beedde11819a9a", "committedDate": "2020-01-28T23:03:23Z", "message": "Delete no longer used class."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NjU5NjQ0", "url": "https://github.com/grpc/grpc-java/pull/6637#pullrequestreview-349659644", "createdAt": "2020-01-28T19:55:53Z", "commit": {"oid": "b428ae3538353a45b0c8b703e5c876c1fde5c291"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxOTo1NTo1M1rOFiyghA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxOTo1NTo1M1rOFiyghA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAyMzQyOA==", "bodyText": "can we mark those as deprecated and ask to use GrpcLbConstants?", "url": "https://github.com/grpc/grpc-java/pull/6637#discussion_r372023428", "createdAt": "2020-01-28T19:55:53Z", "author": {"login": "creamsoup"}, "path": "core/src/main/java/io/grpc/internal/GrpcAttributes.java", "diffHunk": "@@ -37,6 +38,10 @@\n   public static final Attributes.Key<Map<String, ?>> NAME_RESOLVER_SERVICE_CONFIG =\n       Attributes.Key.create(\"service-config\");\n \n+  @NameResolver.ResolutionResultAttr\n+  public static final Attributes.Key<List<EquivalentAddressGroup>> ATTR_LB_ADDRS =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1MzE4NQ=="}, "originalCommit": {"oid": "c817b6f38f3e6079a834ef830642450512777792"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd81164f0cc18856e492ef80335680026c3ccb5b", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/bd81164f0cc18856e492ef80335680026c3ccb5b", "committedDate": "2020-01-30T00:56:04Z", "message": "Add annotation for attribute keys being depracated."}, "afterCommit": {"oid": "8f38f42b6344fd01f2c15872acd16083116ab4bb", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/8f38f42b6344fd01f2c15872acd16083116ab4bb", "committedDate": "2020-01-30T23:03:44Z", "message": "Add annotation for attribute keys being depracated."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f38f42b6344fd01f2c15872acd16083116ab4bb", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/8f38f42b6344fd01f2c15872acd16083116ab4bb", "committedDate": "2020-01-30T23:03:44Z", "message": "Add annotation for attribute keys being depracated."}, "afterCommit": {"oid": "ab974ef96a06e41cac5f2f98e1120888e7ca3d05", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/ab974ef96a06e41cac5f2f98e1120888e7ca3d05", "committedDate": "2020-01-30T23:21:31Z", "message": "Add annotation for attribute keys being depracated."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08cb3d8c56becf15c8d77032ce8206444a99557e", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/08cb3d8c56becf15c8d77032ce8206444a99557e", "committedDate": "2020-01-30T23:58:27Z", "message": "Add annotation for attribute keys being depracated."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab974ef96a06e41cac5f2f98e1120888e7ca3d05", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/ab974ef96a06e41cac5f2f98e1120888e7ca3d05", "committedDate": "2020-01-30T23:21:31Z", "message": "Add annotation for attribute keys being depracated."}, "afterCommit": {"oid": "08cb3d8c56becf15c8d77032ce8206444a99557e", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/08cb3d8c56becf15c8d77032ce8206444a99557e", "committedDate": "2020-01-30T23:58:27Z", "message": "Add annotation for attribute keys being depracated."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4670, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}