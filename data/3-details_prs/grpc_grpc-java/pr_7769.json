{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2NjcyMDEy", "number": 7769, "title": "xds: wire up re-resolution requests from LB policies for DNS clusters and bypass requests from LB policies for EDS clusters", "bodyText": "LoadBalancer.Helper has the API refreshNameResolution() that provides a way for LBs to send re-resolution requests to the (DNS) resolver (for async streaming resolvers like xDS, refreshing is undefined).\nIn ClusterResolverLoadBalancer, it supports resolving endpoint resources with a DNS resolver. Therefore, its refresh() should be wired up correctly for its downstream LBs (although currently none of them, including pick_first and round_robin will send re-resolution requests).\nIn the context of aggregate cluster, ClusterResolverLoadBalancer is the aggregated place for discovering endpoints for multiple underlying clusters. Endpoint load balancing for different underlying clusters is fanned out as individual ClusterImplLoadBalancer instances by its parent LB policy, which is PriorityLoadBalancer. Helpers passed to each ClusterImplLoadBalancer instance is wrapped to turn refreshNameResolution() into NO-OP if the priority instance is not from a DNS cluster. This information is added to the config for each priority.\nSee details in go/grpc-xds-directpath-c2p-fallback.", "createdAt": "2020-12-29T23:31:34Z", "url": "https://github.com/grpc/grpc-java/pull/7769", "merged": true, "mergeCommit": {"oid": "18772e247051def412dadf1ac92a6375efcd3737"}, "closed": true, "closedAt": "2021-01-08T09:08:13Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdo4ox_AH2gAyNTQ2NjcyMDEyOmM0MzUxYzI0NDc3ODVlMDEzMWM2ODJiNDAzYTM1NDE3MmJkOTI5YWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdt5QwTgH2gAyNTQ2NjcyMDEyOmZhODVlNzBjODIwMzI5NjM5MzZmZjViMzBhZmNjZGViNTBjM2YxYTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c4351c2447785e0131c682b403a354172bd929ab", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/c4351c2447785e0131c682b403a354172bd929ab", "committedDate": "2020-12-23T05:53:26Z", "message": "Handle DNS resolution refresh from downstream LB policies in cluster_resolver LB policy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d642e8c57544ac3c00dba5b6a5755fbe535505de", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/d642e8c57544ac3c00dba5b6a5755fbe535505de", "committedDate": "2020-12-29T23:14:28Z", "message": "Add ignore_reresolution field to PriorityLb policy config's per-priority config."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b718304eab6d30328ce8630e63537926b94a6bd1", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/b718304eab6d30328ce8630e63537926b94a6bd1", "committedDate": "2020-12-29T23:15:40Z", "message": "Bypass reresolution requests from downstream LB policies if its config specifies so."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fdf1a2378476f079fe45d4798265b77102dd746", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/8fdf1a2378476f079fe45d4798265b77102dd746", "committedDate": "2020-12-29T23:17:18Z", "message": "Put ignore_reresolution=true for EDS cluter's priority config and ignore_reresolution=false for DNS cluster's."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf8ef3637442e89b511aff359a47534f75b04dfe", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/bf8ef3637442e89b511aff359a47534f75b04dfe", "committedDate": "2020-12-29T23:17:46Z", "message": "Fix PriorityLbConfig usage in EDS LB policy accordingly."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77ae013f99dfdc75b9d00c8b8803ba6fd3f0cfbc", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/77ae013f99dfdc75b9d00c8b8803ba6fd3f0cfbc", "committedDate": "2020-12-30T02:01:43Z", "message": "Fix formatting."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyOTQxODUw", "url": "https://github.com/grpc/grpc-java/pull/7769#pullrequestreview-562941850", "createdAt": "2021-01-06T18:25:13Z", "commit": {"oid": "77ae013f99dfdc75b9d00c8b8803ba6fd3f0cfbc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQxODoyNToxM1rOIPRjig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQxODoyNToxM1rOIPRjig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg4NzE3OA==", "bodyText": "Also call delegate. refreshNameResolution()?", "url": "https://github.com/grpc/grpc-java/pull/7769#discussion_r552887178", "createdAt": "2021-01-06T18:25:13Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/ClusterResolverLoadBalancer.java", "diffHunk": "@@ -273,6 +275,31 @@ private void handleEndpointResolutionError() {\n       }\n     }\n \n+    /**\n+     * Wires re-resolution requests from downstream LB policies with DNS resolver.\n+     */\n+    private final class RefreshableHelper extends ForwardingLoadBalancerHelper {\n+      private final Helper delegate;\n+\n+      private RefreshableHelper(Helper delegate) {\n+        this.delegate = checkNotNull(delegate, \"delegate\");\n+      }\n+\n+      @Override\n+      public void refreshNameResolution() {\n+        for (ClusterState state : clusterStates.values()) {\n+          if (state instanceof LogicalDnsClusterState) {\n+            ((LogicalDnsClusterState) state).refresh();\n+          }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77ae013f99dfdc75b9d00c8b8803ba6fd3f0cfbc"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMDU0NDI1", "url": "https://github.com/grpc/grpc-java/pull/7769#pullrequestreview-563054425", "createdAt": "2021-01-06T21:41:30Z", "commit": {"oid": "77ae013f99dfdc75b9d00c8b8803ba6fd3f0cfbc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa85e70c82032963936ff5b30afccdeb50c3f1a9", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/fa85e70c82032963936ff5b30afccdeb50c3f1a9", "committedDate": "2021-01-07T19:26:43Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/wire_up_dns_cluster_reresolution"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4712, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}