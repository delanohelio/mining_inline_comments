{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0NjMxOTEw", "number": 6706, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMToyMTowNlrODfwLNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMDozMjoyNVrODhRZRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0NjIxNzQ5OnYy", "diffSide": "RIGHT", "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMToyMTowNlrOFppCLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMToyMTowNlrOFppCLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIwODIzOQ==", "bodyText": "It only works for the case cluster_service name is never changed, otherwise the first ClusterEndpointsBalancer.shutdown will cancel the second ClusterEndpointsBalancer's load report. It that intended behavior for now?", "url": "https://github.com/grpc/grpc-java/pull/6706#discussion_r379208239", "createdAt": "2020-02-14T01:21:06Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java", "diffHunk": "@@ -339,9 +324,9 @@ public boolean canHandleEmptyAddressListFromNameResolution() {\n \n       @Override\n       public void shutdown() {\n-        loadStatsStoreMap.remove(clusterServiceName);\n-        if (isReportingStats()) {\n-          loadReportClient.removeLoadStatsStore(clusterServiceName);\n+        if (isReportingLoad) {\n+          xdsClient.cancelClientStatsReport(clusterName, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efce45619e2b9913fd448e1b069f2443c8e9883f"}, "originalPosition": 129}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0NjIzMTgwOnYy", "diffSide": "RIGHT", "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMTozMDoxOFrOFppKrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMTozMDoxOFrOFppKrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIxMDQxNQ==", "bodyText": "This only works for the case cluster_service name is never changed, otherwise it will throw because of the graceful switch. It that intended behavior for now?", "url": "https://github.com/grpc/grpc-java/pull/6706#discussion_r379210415", "createdAt": "2020-02-14T01:30:18Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java", "diffHunk": "@@ -321,7 +287,26 @@ public int hashCode() {\n         EdsLoadBalancer.this.endpointWatcher = endpointWatcher;\n       }\n \n-      // TODO(zddapeng): In handleResolvedAddresses() handle child policy change if any.\n+      @Override\n+      public void handleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n+        XdsConfig config = (XdsConfig) resolvedAddresses.getLoadBalancingPolicyConfig();\n+        if (config.lrsServerName != null) {\n+          if (!config.lrsServerName.equals(\"\")) {\n+            throw new AssertionError(\n+                \"Can only report load to the same management server\");\n+          }\n+          if (!isReportingLoad) {\n+            xdsClient.reportClientStats(clusterName, null, loadStatsStore);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efce45619e2b9913fd448e1b069f2443c8e9883f"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MjE0NTk2OnYy", "diffSide": "RIGHT", "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMDozMjoyNVrOFr8owA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMDo1MzozM1rOFr9Bbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYyNjU2MA==", "bodyText": "(If there is attributes or addresses change in resolvedAddresses) we still need call switchingLoadBalancer.handleResolvedAddresses(resolvedAddresses)\nbefore return.", "url": "https://github.com/grpc/grpc-java/pull/6706#discussion_r381626560", "createdAt": "2020-02-20T00:32:25Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java", "diffHunk": "@@ -114,6 +117,9 @@ public void handleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n       return;\n     }\n     XdsConfig newXdsConfig = (XdsConfig) lbConfig;\n+    if (Objects.equals(newXdsConfig, xdsConfig)) {\n+      return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ddf7f7a04714cc2a7251bf4f1b8b7f8531125d"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYzMjg3OA==", "bodyText": "Sure, removed this block. The following two blocks will only happen when specific fields (i.e., lrsServerName, edsServiceName) in lb config changes. ResolvedAddresses is always delegated to switchLoadBalancer.handleResolvedAddresses(...).", "url": "https://github.com/grpc/grpc-java/pull/6706#discussion_r381632878", "createdAt": "2020-02-20T00:53:33Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java", "diffHunk": "@@ -114,6 +117,9 @@ public void handleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n       return;\n     }\n     XdsConfig newXdsConfig = (XdsConfig) lbConfig;\n+    if (Objects.equals(newXdsConfig, xdsConfig)) {\n+      return;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYyNjU2MA=="}, "originalCommit": {"oid": "74ddf7f7a04714cc2a7251bf4f1b8b7f8531125d"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2830, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}