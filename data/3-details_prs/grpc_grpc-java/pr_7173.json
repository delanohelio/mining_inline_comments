{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMzA1ODMz", "number": 7173, "title": "stub: Only throw on cancellation for streaming responses", "bodyText": "Unary are far more common than streaming, and we're throwing for unary even\nthough it doesn't help the service. Let's stop doing that. We also stop\nthrowing in onComplete() for all cases, because it doesn't help any service;\nit doesn't stop the service's processing and isn't even all that informative\nsince the cancellation can happen even after onComplete() is called.\n\nThis is related to #7172, and the docs there would need to be updated. Whichever is merged last will need to be updated.\nNote that I saw it is weird that we call both the cancellation and onError callbacks. We should probably just call onError, but that has a greater chance of \"being noticed\" so I didn't want it to add risk to this PR.", "createdAt": "2020-06-30T21:27:50Z", "url": "https://github.com/grpc/grpc-java/pull/7173", "merged": true, "mergeCommit": {"oid": "0cd56c29d61f1f09bbed7e15cd8f4b6c25cdda85"}, "closed": true, "closedAt": "2020-10-01T20:10:31Z", "author": {"login": "ejona86"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwrRaXgBqjM1MDI3ODk4MjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOWpHqAH2gAyNDQyMzA1ODMzOjEwNmQ5NjRlODdjNTk3YmMzMDEyYTNhMzk4MGJiNmMwOGI2YzIzODA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c917ac83dd3b4311c03a968e7bb4ea8df4c475b", "author": {"user": {"login": "ejona86", "name": "Eric Anderson"}}, "url": "https://github.com/grpc/grpc-java/commit/3c917ac83dd3b4311c03a968e7bb4ea8df4c475b", "committedDate": "2020-06-30T21:24:57Z", "message": "stub: Only throw on cancellation for streaming responses\n\nUnary are far more common that streaming, and we're throwing for unary even\nthough it doesn't help the service. Let's stop doing that."}, "afterCommit": {"oid": "b7cf787b526407b4539e6195d0c24c8f4b77f271", "author": {"user": {"login": "ejona86", "name": "Eric Anderson"}}, "url": "https://github.com/grpc/grpc-java/commit/b7cf787b526407b4539e6195d0c24c8f4b77f271", "committedDate": "2020-07-01T14:39:07Z", "message": "stub: Only throw on cancellation for streaming responses\n\nUnary are far more common than streaming, and we're throwing for unary even\nthough it doesn't help the service. Let's stop doing that. We also stop\nthrowing in onComplete() for all cases, because it doesn't help any service;\nit doesn't stop the service's processing and isn't even all that informative\nsince the cancellation can happen even after onComplete() is called."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMDc1ODI2", "url": "https://github.com/grpc/grpc-java/pull/7173#pullrequestreview-441075826", "createdAt": "2020-07-01T17:43:53Z", "commit": {"oid": "b7cf787b526407b4539e6195d0c24c8f4b77f271"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNzo0Mzo1M1rOGrvihA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNzo0Mzo1M1rOGrvihA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMDgzNg==", "bodyText": "I feel this method is just adding an annoying redirection. Why not just call new UnaryServerCallHandler<>(method, serverStreaming) directly whenever asyncUnaryRequestCall is called?", "url": "https://github.com/grpc/grpc-java/pull/7173#discussion_r448520836", "createdAt": "2020-07-01T17:43:53Z", "author": {"login": "dapengzhang0"}, "path": "stub/src/main/java/io/grpc/stub/ServerCalls.java", "diffHunk": "@@ -211,24 +215,26 @@ public void onReady() {\n    * @param method an adaptor to the actual method on the service implementation.\n    */\n   private static <ReqT, RespT> ServerCallHandler<ReqT, RespT> asyncUnaryRequestCall(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7cf787b526407b4539e6195d0c24c8f4b77f271"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad44ed00d14f5a0a20eeebef97c82380d1502cc4", "author": {"user": {"login": "ejona86", "name": "Eric Anderson"}}, "url": "https://github.com/grpc/grpc-java/commit/ad44ed00d14f5a0a20eeebef97c82380d1502cc4", "committedDate": "2020-07-21T22:00:02Z", "message": "stub: Only throw on cancellation for streaming responses\n\nUnary are far more common than streaming, and we're throwing for unary even\nthough it doesn't help the service. Let's stop doing that. We also stop\nthrowing in onComplete() for all cases, because it doesn't help any service;\nit doesn't stop the service's processing and isn't even all that informative\nsince the cancellation can happen even after onComplete() is called."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c111d855a4a714b26d4ddeac6851a0c2177a7529", "author": {"user": {"login": "ejona86", "name": "Eric Anderson"}}, "url": "https://github.com/grpc/grpc-java/commit/c111d855a4a714b26d4ddeac6851a0c2177a7529", "committedDate": "2020-07-21T22:03:57Z", "message": "Add notice that setOnCancelHandler disables the exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b7cf787b526407b4539e6195d0c24c8f4b77f271", "author": {"user": {"login": "ejona86", "name": "Eric Anderson"}}, "url": "https://github.com/grpc/grpc-java/commit/b7cf787b526407b4539e6195d0c24c8f4b77f271", "committedDate": "2020-07-01T14:39:07Z", "message": "stub: Only throw on cancellation for streaming responses\n\nUnary are far more common than streaming, and we're throwing for unary even\nthough it doesn't help the service. Let's stop doing that. We also stop\nthrowing in onComplete() for all cases, because it doesn't help any service;\nit doesn't stop the service's processing and isn't even all that informative\nsince the cancellation can happen even after onComplete() is called."}, "afterCommit": {"oid": "c111d855a4a714b26d4ddeac6851a0c2177a7529", "author": {"user": {"login": "ejona86", "name": "Eric Anderson"}}, "url": "https://github.com/grpc/grpc-java/commit/c111d855a4a714b26d4ddeac6851a0c2177a7529", "committedDate": "2020-07-21T22:03:57Z", "message": "Add notice that setOnCancelHandler disables the exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyOTE3NTg3", "url": "https://github.com/grpc/grpc-java/pull/7173#pullrequestreview-452917587", "createdAt": "2020-07-22T00:31:09Z", "commit": {"oid": "c111d855a4a714b26d4ddeac6851a0c2177a7529"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMDozMTowOVrOG1Oe5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMDozMTowOVrOG1Oe5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ2NDk5OQ==", "bodyText": "This message is confusing. It seems a hint to the developer to change their source code: \"To disable this exception: use ServerCallStreamObserver.setOnCancelHandler()\", not an error message to users.", "url": "https://github.com/grpc/grpc-java/pull/7173#discussion_r458464999", "createdAt": "2020-07-22T00:31:09Z", "author": {"login": "dapengzhang0"}, "path": "stub/src/main/java/io/grpc/stub/ServerCalls.java", "diffHunk": "@@ -331,10 +344,17 @@ public void setCompression(String compression) {\n     @Override\n     public void onNext(RespT response) {\n       if (cancelled) {\n-        if (onCancelHandler == null) {\n-          throw Status.CANCELLED.withDescription(\"call already cancelled\").asRuntimeException();\n+        if (serverStreamingOrBidi) {\n+          throw Status.CANCELLED\n+              .withDescription(\"call already cancelled. \"\n+                  + \"ServerCallStreamObserver.setOnCancelHandler() disables this exception\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c111d855a4a714b26d4ddeac6851a0c2177a7529"}, "originalPosition": 143}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "106d964e87c597bc3012a3a3980bb6c08b6c2380", "author": {"user": {"login": "ejona86", "name": "Eric Anderson"}}, "url": "https://github.com/grpc/grpc-java/commit/106d964e87c597bc3012a3a3980bb6c08b6c2380", "committedDate": "2020-10-01T19:35:00Z", "message": "Reword exception message"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4285, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}