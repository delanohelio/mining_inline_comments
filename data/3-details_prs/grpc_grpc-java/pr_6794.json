{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNjg4MzYz", "number": 6794, "title": "all: refactor select lb policy from a list of raw configs", "bodyText": "Refactor to reuse PolicySelection and the implementation in AutoConfiguredLoadBalancerFactory.parseLoadBalancerPolicy().", "createdAt": "2020-03-03T00:56:48Z", "url": "https://github.com/grpc/grpc-java/pull/6794", "merged": true, "mergeCommit": {"oid": "6d3ffc7892c1812fd8be860957a7e82d91a56669"}, "closed": true, "closedAt": "2020-03-03T19:24:59Z", "author": {"login": "dapengzhang0"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJ3jNLAH2gAyMzgyNjg4MzYzOjY3NzVlYjFlNzEwZjYxNDQzNjhmNTIxZmYzNTZmZjQxMGFkMWU0NTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKHD5ZgFqTM2ODI0MDgwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6775eb1e710f6144368f521ff356ff410ad1e457", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/6775eb1e710f6144368f521ff356ff410ad1e457", "committedDate": "2020-03-03T00:54:38Z", "message": "all: refactor select lb policy from a list of raw configs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NjQzNzIz", "url": "https://github.com/grpc/grpc-java/pull/6794#pullrequestreview-367643723", "createdAt": "2020-03-03T01:17:53Z", "commit": {"oid": "6775eb1e710f6144368f521ff356ff410ad1e457"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMToxNzo1M1rOFw1MMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxODowMTo1OVrOFxQmKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc0NzQ0Mw==", "bodyText": "This is not necessary, even if you have a field marked as deprecated. You are not using something defined somewhere else that is deprecated.", "url": "https://github.com/grpc/grpc-java/pull/6794#discussion_r386747443", "createdAt": "2020-03-03T01:17:53Z", "author": {"login": "voidzcy"}, "path": "core/src/main/java/io/grpc/internal/ServiceConfigUtil.java", "diffHunk": "@@ -367,4 +405,53 @@ public String toString() {\n           .toString();\n     }\n   }\n+\n+  @SuppressWarnings(\"deprecation\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6775eb1e710f6144368f521ff356ff410ad1e457"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5MzM4Mw==", "bodyText": "You would need public getters.", "url": "https://github.com/grpc/grpc-java/pull/6794#discussion_r387193383", "createdAt": "2020-03-03T17:56:14Z", "author": {"login": "voidzcy"}, "path": "core/src/main/java/io/grpc/internal/ServiceConfigUtil.java", "diffHunk": "@@ -367,4 +405,53 @@ public String toString() {\n           .toString();\n     }\n   }\n+\n+  @SuppressWarnings(\"deprecation\")\n+  public static final class PolicySelection {\n+    final LoadBalancerProvider provider;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6775eb1e710f6144368f521ff356ff410ad1e457"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5NjQ1OA==", "bodyText": "Reformat this into one line.", "url": "https://github.com/grpc/grpc-java/pull/6794#discussion_r387196458", "createdAt": "2020-03-03T18:01:59Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancerProvider.java", "diffHunk": "@@ -114,36 +111,16 @@ public ConfigOrError parseLoadBalancingPolicyConfig(Map<String, ?> rawConfig) {\n               \"No child policy for action \" + name + \" in xds_routing LB policy: \"\n                   + rawConfig));\n         }\n-        boolean targetParsingSucceeded = false;\n-        for (LbConfig lbConfig : childConfigCandidates) {\n-          String policyName = lbConfig.getPolicyName();\n-          LoadBalancerProvider lbProvider = loadBalancerRegistry().getProvider(policyName);\n-          if (lbProvider == null) {\n-            logger.log(\n-                Level.FINEST,\n-                \"The policy for {0} is not available in xds_routing LB policy: {1}\",\n-                new Object[]{policyName, rawConfig});\n-          } else {\n-            ConfigOrError parsedLbPolicyConfig = lbProvider\n-                .parseLoadBalancingPolicyConfig(lbConfig.getRawConfigValue());\n-            if (parsedLbPolicyConfig.getError() != null) {\n-              // Based on service config error-handling spec, if the chosen config is found invalid\n-              // while other configs that come later were valid, the gRPC config would still be\n-              // considered invalid as a whole.\n-              return parsedLbPolicyConfig;\n-            }\n-            parsedActions.put(\n-                name,\n-                new ChildConfig(policyName, parsedLbPolicyConfig.getConfig()));\n-            targetParsingSucceeded = true;\n-            break;\n-          }\n-        }\n-        if (!targetParsingSucceeded) {\n-          return ConfigOrError.fromError(Status.INTERNAL.withDescription(\n-              \"No child policy available for action \" + name + \" in xds_routing LB policy: \"\n-                  + rawConfig));\n+\n+        ConfigOrError selectedConfigOrError =\n+            ServiceConfigUtil.selectLbPolicyFromList(childConfigCandidates, loadBalancerRegistry());\n+        if (selectedConfigOrError.getError() != null) {\n+          return selectedConfigOrError;\n         }\n+\n+        parsedActions.put(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6775eb1e710f6144368f521ff356ff410ad1e457"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8705309e9cdf49f6b8b79f8681bee4eb22bb46e", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/f8705309e9cdf49f6b8b79f8681bee4eb22bb46e", "committedDate": "2020-03-03T18:32:35Z", "message": "fix review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MjM5MTAz", "url": "https://github.com/grpc/grpc-java/pull/6794#pullrequestreview-368239103", "createdAt": "2020-03-03T18:56:31Z", "commit": {"oid": "f8705309e9cdf49f6b8b79f8681bee4eb22bb46e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MjQwODAw", "url": "https://github.com/grpc/grpc-java/pull/6794#pullrequestreview-368240800", "createdAt": "2020-03-03T18:58:55Z", "commit": {"oid": "f8705309e9cdf49f6b8b79f8681bee4eb22bb46e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4621, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}