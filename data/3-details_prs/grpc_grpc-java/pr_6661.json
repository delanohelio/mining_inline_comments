{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5MjgwNTYz", "number": 6661, "title": "xds: precise logic for selecting the virtual host in RDS responses", "bodyText": "Implements the precise logic for choosing the virtual host in RouteConfiguration of RDS responses. Specifically, fixes logic for domain search order. Minor fix for checking match field in RouteConfiguration. Please see RouteConfiguration Proto section in gRPC Client xDS API Flow design doc for specification.", "createdAt": "2020-01-30T20:49:48Z", "url": "https://github.com/grpc/grpc-java/pull/6661", "merged": true, "mergeCommit": {"oid": "3e6a77a7ef4ab5b687da2e5ea04e798e9bd275af"}, "closed": true, "closedAt": "2020-01-31T00:24:19Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_gwcZAH2gAyMzY5MjgwNTYzOjg0ZjIxYzIxZDMzZTU0OGIwM2FkN2MzOGM0Zjc3ZGJhYjkxMjdlZWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_jsnXAFqTM1MTIyNTQ1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "84f21c21d33e548b03ad7c38c4f77dbab9127eeb", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/84f21c21d33e548b03ad7c38c4f77dbab9127eeb", "committedDate": "2020-01-30T20:42:02Z", "message": "Correct logic for choosing the right VirtualHost."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMTQzMjYz", "url": "https://github.com/grpc/grpc-java/pull/6661#pullrequestreview-351143263", "createdAt": "2020-01-30T21:09:37Z", "commit": {"oid": "84f21c21d33e548b03ad7c38c4f77dbab9127eeb"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMTowOTozN1rOFj5__w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMToxNTo1MVrOFj6KeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE5NDc1MQ==", "bodyText": "If both a.example.com (exact matching) and *.example.com (suffix matching ) are in the list, then suffix matching will be finally selected if it comes later.", "url": "https://github.com/grpc/grpc-java/pull/6661#discussion_r373194751", "createdAt": "2020-01-30T21:09:37Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -624,21 +624,39 @@ private void handleRdsResponse(DiscoveryResponse rdsResponse) {\n   }\n \n   /**\n-   * Processes RouteConfiguration message (from an resource information in an LDS or RDS\n-   * response), which may contain a VirtualHost with domains matching the \"xds:\"\n-   * URI hostname directly in-line. Returns the clusterName found in that VirtualHost\n-   * message. Returns {@code null} if such a clusterName cannot be resolved.\n+   * Processes a RouteConfiguration message to find the name of upstream cluster that requests\n+   * for the given host will be routed to. Returns the clusterName if found.\n+   * Otherwise, returns {@code null}.\n    *\n-   * <p>Note we only validate VirtualHosts with domains matching the \"xds:\" URI hostname.\n    */\n+  @VisibleForTesting\n   @Nullable\n-  private String processRouteConfig(RouteConfiguration config) {\n+  static String findClusterNameInRouteConfig(RouteConfiguration config, String hostname) {\n     List<VirtualHost> virtualHosts = config.getVirtualHostsList();\n-    int matchingLen = -1;  // longest length of wildcard pattern that matches host name\n+    // Domain search order:\n+    //  1. Exact domain names: ``www.foo.com``.\n+    //  2. Suffix domain wildcards: ``*.foo.com`` or ``*-bar.foo.com``.\n+    //  3. Prefix domain wildcards: ``foo.*`` or ``foo-*``.\n+    //  4. Special wildcard ``*`` matching any domain.\n+    //\n+    //  The longest wildcards match first.\n+    //  Assuming only a single virtual host in the entire route configuration can match\n+    //  on ``*`` and a domain must be unique across all virtual hosts.\n+    int matchingLen = -1; // longest length of wildcard pattern that matches host name\n     VirtualHost targetVirtualHost = null;  // target VirtualHost with longest matched domain\n     for (VirtualHost vHost : virtualHosts) {\n       for (String domain : vHost.getDomainsList()) {\n-        if (matchHostName(hostName, domain) && domain.length() > matchingLen) {\n+        boolean selected = false;\n+        if (matchHostName(hostname, domain)) { // matching\n+          if (!domain.contains(\"*\")) { // exact matching\n+            selected = true;\n+          } else if (domain.length() > matchingLen) { // longer matching pattern\n+            selected = true;\n+          } else if (domain.length() == matchingLen && domain.startsWith(\"*\")) { // suffix matching", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84f21c21d33e548b03ad7c38c4f77dbab9127eeb"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE5NzQzMw==", "bodyText": "Not sure about the spec. If the best matching targetVirtualHost doesn't satisfy this condition, but the rank 2 matching satisfies, still return null?", "url": "https://github.com/grpc/grpc-java/pull/6661#discussion_r373197433", "createdAt": "2020-01-30T21:15:51Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -649,13 +667,15 @@ private String processRouteConfig(RouteConfiguration config) {\n     // hostname in original \"xds:\" URI.\n     if (targetVirtualHost != null) {\n       // The client will look only at the last route in the list (the default route),\n-      // whose match field must be empty and whose route field must be set.\n+      // whose match field must contain a prefix field whose value is empty string\n+      // and whose route field must be set.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84f21c21d33e548b03ad7c38c4f77dbab9127eeb"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39bad7060fc4ef86b14e8dab44961fc1f9e9b387", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/39bad7060fc4ef86b14e8dab44961fc1f9e9b387", "committedDate": "2020-01-30T21:49:03Z", "message": "Fix style issue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "700bcf50b9c6fb4a6610220ef947b3b4cebb6626", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/700bcf50b9c6fb4a6610220ef947b3b4cebb6626", "committedDate": "2020-01-30T22:56:11Z", "message": "Fix logic bug of domain matching. A domain name with ending asterisk takes over exact matching if appears after the exact matching domain and the asterisk matches a single character."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fdd04e8aef5ca55bef6d72ce322c36ee37365d2", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/0fdd04e8aef5ca55bef6d72ce322c36ee37365d2", "committedDate": "2020-01-30T23:01:04Z", "message": "Add a note for subtle edge case of selected virtual host not correctly configured."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMjI1NDU2", "url": "https://github.com/grpc/grpc-java/pull/6661#pullrequestreview-351225456", "createdAt": "2020-01-31T00:07:34Z", "commit": {"oid": "0fdd04e8aef5ca55bef6d72ce322c36ee37365d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4690, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}