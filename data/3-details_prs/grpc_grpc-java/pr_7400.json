{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyMjc5ODAx", "number": 7400, "title": "xds: fail to create xDS channel if no server with supported channel creds found", "bodyText": "Follow up for #7396.\nThe main change is to create the xDS channel outside XdsClient and creating the xDS channel can fail.", "createdAt": "2020-09-08T20:30:37Z", "url": "https://github.com/grpc/grpc-java/pull/7400", "merged": true, "mergeCommit": {"oid": "b31d6830a2af3196e588217320d2781112b7cf73"}, "closed": true, "closedAt": "2020-09-19T00:55:31Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJM9HRAH2gAyNDgyMjc5ODAxOmVlODlmM2U2YzJiYmVjZjdjOTI0NjNkNzEwNjEwY2ZiNjliYmI0Njg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKOh95gH2gAyNDgyMjc5ODAxOmEzMzJkMmQ0Y2M5ODdiODY2YzU1MTlkOWZkOWJiYmUwNzAxY2NmOWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ee89f3e6c2bbecf7c92463d710610cfb69bbb468", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/ee89f3e6c2bbecf7c92463d710610cfb69bbb468", "committedDate": "2020-09-15T19:28:10Z", "message": "Move XdsChannelFactory to its own file and improve tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "603d92972116414747b37c34a728ccd4e1bae4d7", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/603d92972116414747b37c34a728ccd4e1bae4d7", "committedDate": "2020-09-15T19:28:19Z", "message": "Constructing XdsClient with channel injected."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "612b791d9596c9ee41b0cdcf19974a2183b33568", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/612b791d9596c9ee41b0cdcf19974a2183b33568", "committedDate": "2020-09-15T19:28:19Z", "message": "Create the xDS channel outside XdsClient."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c1f54ce35aaa885dabc1bf600f2e475c62d4629e", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/c1f54ce35aaa885dabc1bf600f2e475c62d4629e", "committedDate": "2020-09-08T20:25:00Z", "message": "Throw exception is no server with supported channel creds is found."}, "afterCommit": {"oid": "612b791d9596c9ee41b0cdcf19974a2183b33568", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/612b791d9596c9ee41b0cdcf19974a2183b33568", "committedDate": "2020-09-15T19:28:19Z", "message": "Create the xDS channel outside XdsClient."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MDA5NjQz", "url": "https://github.com/grpc/grpc-java/pull/7400#pullrequestreview-489009643", "createdAt": "2020-09-15T19:36:06Z", "commit": {"oid": "612b791d9596c9ee41b0cdcf19974a2183b33568"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxOTozNjowNlrOHSRgbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxOTozNjowNlrOHSRgbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkyMzI0Ng==", "bodyText": "This EDS-only codepath will be deleted in #7391.", "url": "https://github.com/grpc/grpc-java/pull/7400#discussion_r488923246", "createdAt": "2020-09-15T19:36:06Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java", "diffHunk": "@@ -129,8 +128,10 @@ public void handleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n       xdsClientPool = attributes.get(XdsAttributes.XDS_CLIENT_POOL);\n       if (xdsClientPool == null) {\n         final BootstrapInfo bootstrapInfo;\n+        final XdsChannel channel;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "612b791d9596c9ee41b0cdcf19974a2183b33568"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MDEwMzM3", "url": "https://github.com/grpc/grpc-java/pull/7400#pullrequestreview-489010337", "createdAt": "2020-09-15T19:37:11Z", "commit": {"oid": "612b791d9596c9ee41b0cdcf19974a2183b33568"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxOTozNzoxMlrOHSRkPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxOTozNzoxMlrOHSRkPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkyNDIyMA==", "bodyText": "More cleanup to be done to put RefCountedXdsClientObjectPool into its own file.", "url": "https://github.com/grpc/grpc-java/pull/7400#discussion_r488924220", "createdAt": "2020-09-15T19:37:12Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClient.java", "diffHunk": "@@ -687,8 +623,4 @@ boolean isUseProtocolV3() {\n       return useProtocolV3;\n     }\n   }\n-\n-  interface XdsClientPoolFactory {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "612b791d9596c9ee41b0cdcf19974a2183b33568"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMDQwMTY5", "url": "https://github.com/grpc/grpc-java/pull/7400#pullrequestreview-491040169", "createdAt": "2020-09-17T22:48:30Z", "commit": {"oid": "ee89f3e6c2bbecf7c92463d710610cfb69bbb468"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo0ODozMFrOHT4GAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo0ODozMFrOHT4GAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNDAzMg==", "bodyText": "You should also check\nserver1 with experimentalV3SupportEnvVar = true\nand\nserver2 with experimentalV3SupportEnvVar = false\nstill do not support v3.", "url": "https://github.com/grpc/grpc-java/pull/7400#discussion_r490604032", "createdAt": "2020-09-17T22:48:30Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/test/java/io/grpc/xds/XdsChannelFactoryTest.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.junit.Assert.fail;\n+\n+import io.grpc.xds.Bootstrapper.ChannelCreds;\n+import io.grpc.xds.Bootstrapper.ServerInfo;\n+import io.grpc.xds.XdsClient.XdsChannel;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+/**\n+ * Tests for {@link XdsChannelFactory}.\n+ */\n+@RunWith(JUnit4.class)\n+public class XdsChannelFactoryTest {\n+\n+  private final XdsChannelFactory channelFactory = XdsChannelFactory.getInstance();\n+  private final List<XdsChannel> channels = new ArrayList<>();\n+  private ServerInfo server1;  // google_default\n+  private ServerInfo server2;  // plaintext, v3\n+  private ServerInfo server3;  // unsupported\n+\n+  @Before\n+  public void setUp() {\n+    ChannelCreds googleDefault = new ChannelCreds(\"google_default\", null);\n+    ChannelCreds insecure = new ChannelCreds(\"insecure\", null);\n+    ChannelCreds unsupported = new ChannelCreds(\"unsupported\", null);\n+    server1 = new ServerInfo(\"server1.com\", Collections.singletonList(googleDefault),\n+        Collections.<String>emptyList());\n+    server2 = new ServerInfo(\"server2.com\", Collections.singletonList(insecure),\n+        Collections.singletonList(\"xds_v3\"));\n+    server3 = new ServerInfo(\"server4.com\", Collections.singletonList(unsupported),\n+        Collections.<String>emptyList());\n+  }\n+\n+  @After\n+  public void tearDown() {\n+    for (XdsChannel channel : channels) {\n+      channel.getManagedChannel().shutdown();\n+    }\n+  }\n+\n+  @Test\n+  public void failToCreateChannel_unsupportedChannelCreds() {\n+    try {\n+      createChannel(server3);\n+      fail(\"Should have thrown\");\n+    } catch (XdsInitializationException expected) {\n+    }\n+  }\n+\n+  @Test\n+  public void defaultUseV2ProtocolL() throws XdsInitializationException {\n+    XdsChannel channel = createChannel(server1);\n+    assertThat(channel.isUseProtocolV3()).isFalse();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee89f3e6c2bbecf7c92463d710610cfb69bbb468"}, "originalPosition": 79}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxODMwMTM0", "url": "https://github.com/grpc/grpc-java/pull/7400#pullrequestreview-491830134", "createdAt": "2020-09-18T23:25:51Z", "commit": {"oid": "612b791d9596c9ee41b0cdcf19974a2183b33568"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMzoyNTo1MVrOHUehsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMzoyNTo1MVrOHUehsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIzMzcxMw==", "bodyText": "Might as well throw XdsInitializationException?", "url": "https://github.com/grpc/grpc-java/pull/7400#discussion_r491233713", "createdAt": "2020-09-18T23:25:51Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/XdsChannelFactory.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import io.grpc.ManagedChannel;\n+import io.grpc.ManagedChannelBuilder;\n+import io.grpc.alts.GoogleDefaultChannelBuilder;\n+import io.grpc.xds.Bootstrapper.ChannelCreds;\n+import io.grpc.xds.Bootstrapper.ServerInfo;\n+import io.grpc.xds.XdsClient.XdsChannel;\n+import io.grpc.xds.XdsLogger.XdsLogLevel;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Factory for creating channels to xDS severs.\n+ */\n+abstract class XdsChannelFactory {\n+  @VisibleForTesting\n+  static boolean experimentalV3SupportEnvVar = Boolean.parseBoolean(\n+      System.getenv(\"GRPC_XDS_EXPERIMENTAL_V3_SUPPORT\"));\n+\n+  private static final String XDS_V3_SERVER_FEATURE = \"xds_v3\";\n+  private static final XdsChannelFactory DEFAULT_INSTANCE = new XdsChannelFactory() {\n+    /**\n+     * Creates a channel to the first server in the given list.\n+     */\n+    @Override\n+    XdsChannel createChannel(List<ServerInfo> servers) throws XdsInitializationException {\n+      checkArgument(!servers.isEmpty(), \"No management server provided.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "612b791d9596c9ee41b0cdcf19974a2183b33568"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a332d2d4cc987b866c5519d9fd9bbbe0701ccf9d", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/a332d2d4cc987b866c5519d9fd9bbbe0701ccf9d", "committedDate": "2020-09-18T23:52:15Z", "message": "Throw XdsInitializationException if the given server list to create the xDS channel is empty."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4029, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}