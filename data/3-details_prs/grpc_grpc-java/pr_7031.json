{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2ODg3OTQz", "number": 7031, "title": "xds: add more route matching types in converted Route data structure", "bodyText": "All objects of converted types should be valid to gRPC (if the original proto message contains invalid data, the conversion should fail and no object should be instantiated).\nUse null in converted objects for unset fields in proto messages. This puts a much stronger/clearer signal for proto's oneof type.\n\nMost conversion logic and tests are trivial. But the way we represent data and perform checks matters.", "createdAt": "2020-05-12T18:12:09Z", "url": "https://github.com/grpc/grpc-java/pull/7031", "merged": true, "mergeCommit": {"oid": "02e3c00c390af1c1c197865cb92f8c83fba610c5"}, "closed": true, "closedAt": "2020-05-18T18:47:37Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgoS3WAH2gAyNDE2ODg3OTQzOmY0Nzk1ZGUwMTkxNzM4ZDk3ZDVkOTViMjU0YjliZWFjNmQyNjc0NmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcikVqWgFqTQxMzg0NTE3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f4795de0191738d97d5d95b254b9beac6d26746b", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/f4795de0191738d97d5d95b254b9beac6d26746b", "committedDate": "2020-05-12T18:08:28Z", "message": "Implement Envoy proto message converters, with validation logics embedded."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dadc87733e0407e7e72da81c61c743fe01dce0b7", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/dadc87733e0407e7e72da81c61c743fe01dce0b7", "committedDate": "2020-05-12T18:09:22Z", "message": "Clean up route validation logic in XdsClient, it's done alone with the conversion."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a8a4820c74271e3ebbc34fa57f90f007564bafc", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/1a8a4820c74271e3ebbc34fa57f90f007564bafc", "committedDate": "2020-05-12T18:10:27Z", "message": "Fix tests for the xDS resolver for the new invariants of converted data."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9403c0f3559c5c97a304044aa7c03a728b79aafe", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/9403c0f3559c5c97a304044aa7c03a728b79aafe", "committedDate": "2020-05-12T23:00:10Z", "message": "Clean up route data conversion and add test coverage."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db8a10207f5e335328387351ffd92c17422adfa6", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/db8a10207f5e335328387351ffd92c17422adfa6", "committedDate": "2020-05-12T23:01:42Z", "message": "Use java.util.Objects instand of Guava's."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed0415c7004a91bd787b7fadbfbc8605cf57649d", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/ed0415c7004a91bd787b7fadbfbc8605cf57649d", "committedDate": "2020-05-12T23:10:39Z", "message": "Add document to specify the idea of converting Envoy's proto message to Java objects."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDg2ODcw", "url": "https://github.com/grpc/grpc-java/pull/7031#pullrequestreview-410486870", "createdAt": "2020-05-12T23:15:31Z", "commit": {"oid": "ed0415c7004a91bd787b7fadbfbc8605cf57649d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzoxNTozMVrOGUcL2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzoxODoxNlrOGUcPAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4NjQ4OQ==", "bodyText": "Justification: a valid Route should always have a valid matcher and a valid action.", "url": "https://github.com/grpc/grpc-java/pull/7031#discussion_r424086489", "createdAt": "2020-05-12T23:15:31Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -342,7 +425,6 @@ public String toString() {\n   /** See corresponding Envoy proto message {@link io.envoyproxy.envoy.api.v2.route.Route}. */\n   static final class Route {\n     private final RouteMatch routeMatch;\n-    @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed0415c7004a91bd787b7fadbfbc8605cf57649d"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4NzI5OQ==", "bodyText": "Justification: use null for unset values as in proto only one of prefix, path, regex can be set. It is ambiguous for converted objects to use \"\" for unset fields given that \"\" itself can be a set value.", "url": "https://github.com/grpc/grpc-java/pull/7031#discussion_r424087299", "createdAt": "2020-05-12T23:18:16Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -386,55 +471,98 @@ public String toString() {\n           .toString();\n     }\n \n-    static Route fromEnvoyProtoRoute(io.envoyproxy.envoy.api.v2.route.Route proto) {\n-      RouteMatch routeMatch = RouteMatch.fromEnvoyProtoRouteMatch(proto.getMatch());\n-      RouteAction routeAction = null;\n-      if (proto.hasRoute()) {\n-        routeAction = RouteAction.fromEnvoyProtoRouteAction(proto.getRoute());\n+    @Nullable\n+    static StructOrError<Route> fromEnvoyProtoRoute(io.envoyproxy.envoy.api.v2.route.Route proto) {\n+      StructOrError<RouteMatch> routeMatch = RouteMatch.fromEnvoyProtoRouteMatch(proto.getMatch());\n+      if (routeMatch == null) {\n+        return null;\n+      }\n+      if (routeMatch.getErrorDetail() != null) {\n+        return StructOrError.fromError(\n+            \"Invalid route [\" + proto.getName() + \"] : \" + routeMatch.getErrorDetail());\n+      }\n+\n+      StructOrError<RouteAction> routeAction;\n+      switch (proto.getActionCase()) {\n+        case ROUTE:\n+          routeAction = RouteAction.fromEnvoyProtoRouteAction(proto.getRoute());\n+          break;\n+        case REDIRECT:\n+          return StructOrError.fromError(\"Unsupported action type: redirect\");\n+        case DIRECT_RESPONSE:\n+          return StructOrError.fromError(\"Unsupported action type: direct_response\");\n+        case FILTER_ACTION:\n+          return StructOrError.fromError(\"Unsupported action type: filter_action\");\n+        case ACTION_NOT_SET:\n+          // fall through\n+        default:\n+          return StructOrError.fromError(\"Unknown action type: \" + proto.getActionCase());\n       }\n-      return new Route(routeMatch, routeAction);\n+      if (routeAction.getErrorDetail() != null) {\n+        return StructOrError.fromError(\n+            \"Invalid route [\" + proto.getName() + \"] : \" + routeAction.getErrorDetail());\n+      }\n+      return StructOrError.fromStruct(new Route(routeMatch.getStruct(), routeAction.getStruct()));\n     }\n   }\n \n   /** See corresponding Envoy proto message {@link io.envoyproxy.envoy.api.v2.route.RouteMatch}. */\n   static final class RouteMatch {\n-    private final String prefix;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed0415c7004a91bd787b7fadbfbc8605cf57649d"}, "originalPosition": 175}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cee407ebb3722c376318216faf2c8b6f98dbe59", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/7cee407ebb3722c376318216faf2c8b6f98dbe59", "committedDate": "2020-05-13T00:44:36Z", "message": "Increase coverage by adding more tests for data conversions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3dd2b6ed6a298fc9c73383c399b3fedb0585f83", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/d3dd2b6ed6a298fc9c73383c399b3fedb0585f83", "committedDate": "2020-05-14T23:20:23Z", "message": "Clean up XdsClientImpl tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyODA2NjQ1", "url": "https://github.com/grpc/grpc-java/pull/7031#pullrequestreview-412806645", "createdAt": "2020-05-15T16:44:19Z", "commit": {"oid": "d3dd2b6ed6a298fc9c73383c399b3fedb0585f83"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNjo0NDoyMFrOGWMT3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMTo0Nzo1OVrOGWUv4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTkyMzU1MQ==", "bodyText": "s/\"] : \"/\"]: \"", "url": "https://github.com/grpc/grpc-java/pull/7031#discussion_r425923551", "createdAt": "2020-05-15T16:44:20Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -386,55 +471,98 @@ public String toString() {\n           .toString();\n     }\n \n-    static Route fromEnvoyProtoRoute(io.envoyproxy.envoy.api.v2.route.Route proto) {\n-      RouteMatch routeMatch = RouteMatch.fromEnvoyProtoRouteMatch(proto.getMatch());\n-      RouteAction routeAction = null;\n-      if (proto.hasRoute()) {\n-        routeAction = RouteAction.fromEnvoyProtoRouteAction(proto.getRoute());\n+    @Nullable\n+    static StructOrError<Route> fromEnvoyProtoRoute(io.envoyproxy.envoy.api.v2.route.Route proto) {\n+      StructOrError<RouteMatch> routeMatch = RouteMatch.fromEnvoyProtoRouteMatch(proto.getMatch());\n+      if (routeMatch == null) {\n+        return null;\n+      }\n+      if (routeMatch.getErrorDetail() != null) {\n+        return StructOrError.fromError(\n+            \"Invalid route [\" + proto.getName() + \"] : \" + routeMatch.getErrorDetail());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3dd2b6ed6a298fc9c73383c399b3fedb0585f83"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTkyMzg5NQ==", "bodyText": "Comment not necessary. The code explains itself. For google java style, this special comment is not required in the last statement group of the switch block.", "url": "https://github.com/grpc/grpc-java/pull/7031#discussion_r425923895", "createdAt": "2020-05-15T16:44:57Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -386,55 +471,98 @@ public String toString() {\n           .toString();\n     }\n \n-    static Route fromEnvoyProtoRoute(io.envoyproxy.envoy.api.v2.route.Route proto) {\n-      RouteMatch routeMatch = RouteMatch.fromEnvoyProtoRouteMatch(proto.getMatch());\n-      RouteAction routeAction = null;\n-      if (proto.hasRoute()) {\n-        routeAction = RouteAction.fromEnvoyProtoRouteAction(proto.getRoute());\n+    @Nullable\n+    static StructOrError<Route> fromEnvoyProtoRoute(io.envoyproxy.envoy.api.v2.route.Route proto) {\n+      StructOrError<RouteMatch> routeMatch = RouteMatch.fromEnvoyProtoRouteMatch(proto.getMatch());\n+      if (routeMatch == null) {\n+        return null;\n+      }\n+      if (routeMatch.getErrorDetail() != null) {\n+        return StructOrError.fromError(\n+            \"Invalid route [\" + proto.getName() + \"] : \" + routeMatch.getErrorDetail());\n+      }\n+\n+      StructOrError<RouteAction> routeAction;\n+      switch (proto.getActionCase()) {\n+        case ROUTE:\n+          routeAction = RouteAction.fromEnvoyProtoRouteAction(proto.getRoute());\n+          break;\n+        case REDIRECT:\n+          return StructOrError.fromError(\"Unsupported action type: redirect\");\n+        case DIRECT_RESPONSE:\n+          return StructOrError.fromError(\"Unsupported action type: direct_response\");\n+        case FILTER_ACTION:\n+          return StructOrError.fromError(\"Unsupported action type: filter_action\");\n+        case ACTION_NOT_SET:\n+          // fall through", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3dd2b6ed6a298fc9c73383c399b3fedb0585f83"}, "originalPosition": 160}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxNTU0OQ==", "bodyText": "It shouldn't.  The above is the only case for default matcher. It's not practical to check if a regex can match all.", "url": "https://github.com/grpc/grpc-java/pull/7031#discussion_r426015549", "createdAt": "2020-05-15T19:51:32Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -386,55 +471,98 @@ public String toString() {\n           .toString();\n     }\n \n-    static Route fromEnvoyProtoRoute(io.envoyproxy.envoy.api.v2.route.Route proto) {\n-      RouteMatch routeMatch = RouteMatch.fromEnvoyProtoRouteMatch(proto.getMatch());\n-      RouteAction routeAction = null;\n-      if (proto.hasRoute()) {\n-        routeAction = RouteAction.fromEnvoyProtoRouteAction(proto.getRoute());\n+    @Nullable\n+    static StructOrError<Route> fromEnvoyProtoRoute(io.envoyproxy.envoy.api.v2.route.Route proto) {\n+      StructOrError<RouteMatch> routeMatch = RouteMatch.fromEnvoyProtoRouteMatch(proto.getMatch());\n+      if (routeMatch == null) {\n+        return null;\n+      }\n+      if (routeMatch.getErrorDetail() != null) {\n+        return StructOrError.fromError(\n+            \"Invalid route [\" + proto.getName() + \"] : \" + routeMatch.getErrorDetail());\n+      }\n+\n+      StructOrError<RouteAction> routeAction;\n+      switch (proto.getActionCase()) {\n+        case ROUTE:\n+          routeAction = RouteAction.fromEnvoyProtoRouteAction(proto.getRoute());\n+          break;\n+        case REDIRECT:\n+          return StructOrError.fromError(\"Unsupported action type: redirect\");\n+        case DIRECT_RESPONSE:\n+          return StructOrError.fromError(\"Unsupported action type: direct_response\");\n+        case FILTER_ACTION:\n+          return StructOrError.fromError(\"Unsupported action type: filter_action\");\n+        case ACTION_NOT_SET:\n+          // fall through\n+        default:\n+          return StructOrError.fromError(\"Unknown action type: \" + proto.getActionCase());\n       }\n-      return new Route(routeMatch, routeAction);\n+      if (routeAction.getErrorDetail() != null) {\n+        return StructOrError.fromError(\n+            \"Invalid route [\" + proto.getName() + \"] : \" + routeAction.getErrorDetail());\n+      }\n+      return StructOrError.fromStruct(new Route(routeMatch.getStruct(), routeAction.getStruct()));\n     }\n   }\n \n   /** See corresponding Envoy proto message {@link io.envoyproxy.envoy.api.v2.route.RouteMatch}. */\n   static final class RouteMatch {\n-    private final String prefix;\n-    private final String path;\n-    private final boolean hasRegex;\n-    private final boolean caseSensitive;\n-\n-    @VisibleForTesting\n-    RouteMatch(String prefix, String path, boolean hasRegex, boolean caseSensitive) {\n-      this.prefix = prefix;\n-      this.path = path;\n-      this.hasRegex = hasRegex;\n-      this.caseSensitive = caseSensitive;\n-    }\n+    // Exactly one of the following fields is non-null.\n+    @Nullable\n+    private final String pathPrefixMatch;\n+    @Nullable\n+    private final String pathExactMatch;\n+    @Nullable\n+    private final String pathSafeRegExMatch;\n \n-    String getPrefix() {\n-      return prefix;\n-    }\n+    private final List<HeaderMatcher> headerMatchers;\n+    @Nullable\n+    private final Fraction fractionMatch;\n \n-    String getPath() {\n-      return path;\n+    @VisibleForTesting\n+    RouteMatch(\n+        @Nullable String pathPrefixMatch, @Nullable String pathExactMatch,\n+        @Nullable String pathSafeRegExMatch, @Nullable Fraction fractionMatch,\n+        List<HeaderMatcher> headerMatchers) {\n+      this.pathPrefixMatch = pathPrefixMatch;\n+      this.pathExactMatch = pathExactMatch;\n+      this.pathSafeRegExMatch = pathSafeRegExMatch;\n+      this.fractionMatch = fractionMatch;\n+      this.headerMatchers = headerMatchers;\n+    }\n+\n+    RouteMatch(@Nullable String pathPrefixMatch, @Nullable String pathExactMatch) {\n+      this(\n+          pathPrefixMatch, pathExactMatch, null, null,\n+          Collections.<HeaderMatcher>emptyList());\n     }\n \n-    boolean hasRegex() {\n-      return hasRegex;\n+    @Nullable\n+    String getPathPrefixMatch() {\n+      return pathPrefixMatch;\n     }\n \n-    boolean isCaseSensitive() {\n-      return caseSensitive;\n+    @Nullable\n+    String getPathExactMatch() {\n+      return pathExactMatch;\n     }\n \n-    boolean isDefaultMatcher() {\n-      if (hasRegex) {\n+    boolean isMatchAll() {\n+      if (pathSafeRegExMatch != null || fractionMatch != null) {\n         return false;\n       }\n-      if (!path.isEmpty()) {\n+      if (headerMatchers != null && !headerMatchers.isEmpty()) {\n         return false;\n       }\n-      return prefix.isEmpty() || prefix.equals(\"/\");\n+      if (pathExactMatch != null) {\n+        return pathExactMatch.isEmpty();\n+      }\n+      if (pathPrefixMatch != null) {\n+        return pathPrefixMatch.isEmpty() || pathPrefixMatch.equals(\"/\");\n+      }\n+      // TODO (chengyuanzhang): can path match with regex be a default route?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3dd2b6ed6a298fc9c73383c399b3fedb0585f83"}, "originalPosition": 253}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxNTkwMQ==", "bodyText": "Seems headerMatchers is never null. It's not a oneof element.", "url": "https://github.com/grpc/grpc-java/pull/7031#discussion_r426015901", "createdAt": "2020-05-15T19:52:21Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -386,55 +471,98 @@ public String toString() {\n           .toString();\n     }\n \n-    static Route fromEnvoyProtoRoute(io.envoyproxy.envoy.api.v2.route.Route proto) {\n-      RouteMatch routeMatch = RouteMatch.fromEnvoyProtoRouteMatch(proto.getMatch());\n-      RouteAction routeAction = null;\n-      if (proto.hasRoute()) {\n-        routeAction = RouteAction.fromEnvoyProtoRouteAction(proto.getRoute());\n+    @Nullable\n+    static StructOrError<Route> fromEnvoyProtoRoute(io.envoyproxy.envoy.api.v2.route.Route proto) {\n+      StructOrError<RouteMatch> routeMatch = RouteMatch.fromEnvoyProtoRouteMatch(proto.getMatch());\n+      if (routeMatch == null) {\n+        return null;\n+      }\n+      if (routeMatch.getErrorDetail() != null) {\n+        return StructOrError.fromError(\n+            \"Invalid route [\" + proto.getName() + \"] : \" + routeMatch.getErrorDetail());\n+      }\n+\n+      StructOrError<RouteAction> routeAction;\n+      switch (proto.getActionCase()) {\n+        case ROUTE:\n+          routeAction = RouteAction.fromEnvoyProtoRouteAction(proto.getRoute());\n+          break;\n+        case REDIRECT:\n+          return StructOrError.fromError(\"Unsupported action type: redirect\");\n+        case DIRECT_RESPONSE:\n+          return StructOrError.fromError(\"Unsupported action type: direct_response\");\n+        case FILTER_ACTION:\n+          return StructOrError.fromError(\"Unsupported action type: filter_action\");\n+        case ACTION_NOT_SET:\n+          // fall through\n+        default:\n+          return StructOrError.fromError(\"Unknown action type: \" + proto.getActionCase());\n       }\n-      return new Route(routeMatch, routeAction);\n+      if (routeAction.getErrorDetail() != null) {\n+        return StructOrError.fromError(\n+            \"Invalid route [\" + proto.getName() + \"] : \" + routeAction.getErrorDetail());\n+      }\n+      return StructOrError.fromStruct(new Route(routeMatch.getStruct(), routeAction.getStruct()));\n     }\n   }\n \n   /** See corresponding Envoy proto message {@link io.envoyproxy.envoy.api.v2.route.RouteMatch}. */\n   static final class RouteMatch {\n-    private final String prefix;\n-    private final String path;\n-    private final boolean hasRegex;\n-    private final boolean caseSensitive;\n-\n-    @VisibleForTesting\n-    RouteMatch(String prefix, String path, boolean hasRegex, boolean caseSensitive) {\n-      this.prefix = prefix;\n-      this.path = path;\n-      this.hasRegex = hasRegex;\n-      this.caseSensitive = caseSensitive;\n-    }\n+    // Exactly one of the following fields is non-null.\n+    @Nullable\n+    private final String pathPrefixMatch;\n+    @Nullable\n+    private final String pathExactMatch;\n+    @Nullable\n+    private final String pathSafeRegExMatch;\n \n-    String getPrefix() {\n-      return prefix;\n-    }\n+    private final List<HeaderMatcher> headerMatchers;\n+    @Nullable\n+    private final Fraction fractionMatch;\n \n-    String getPath() {\n-      return path;\n+    @VisibleForTesting\n+    RouteMatch(\n+        @Nullable String pathPrefixMatch, @Nullable String pathExactMatch,\n+        @Nullable String pathSafeRegExMatch, @Nullable Fraction fractionMatch,\n+        List<HeaderMatcher> headerMatchers) {\n+      this.pathPrefixMatch = pathPrefixMatch;\n+      this.pathExactMatch = pathExactMatch;\n+      this.pathSafeRegExMatch = pathSafeRegExMatch;\n+      this.fractionMatch = fractionMatch;\n+      this.headerMatchers = headerMatchers;\n+    }\n+\n+    RouteMatch(@Nullable String pathPrefixMatch, @Nullable String pathExactMatch) {\n+      this(\n+          pathPrefixMatch, pathExactMatch, null, null,\n+          Collections.<HeaderMatcher>emptyList());\n     }\n \n-    boolean hasRegex() {\n-      return hasRegex;\n+    @Nullable\n+    String getPathPrefixMatch() {\n+      return pathPrefixMatch;\n     }\n \n-    boolean isCaseSensitive() {\n-      return caseSensitive;\n+    @Nullable\n+    String getPathExactMatch() {\n+      return pathExactMatch;\n     }\n \n-    boolean isDefaultMatcher() {\n-      if (hasRegex) {\n+    boolean isMatchAll() {\n+      if (pathSafeRegExMatch != null || fractionMatch != null) {\n         return false;\n       }\n-      if (!path.isEmpty()) {\n+      if (headerMatchers != null && !headerMatchers.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3dd2b6ed6a298fc9c73383c399b3fedb0585f83"}, "originalPosition": 243}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2MTI4MA==", "bodyText": "Should return false.", "url": "https://github.com/grpc/grpc-java/pull/7031#discussion_r426061280", "createdAt": "2020-05-15T21:46:13Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -386,55 +471,98 @@ public String toString() {\n           .toString();\n     }\n \n-    static Route fromEnvoyProtoRoute(io.envoyproxy.envoy.api.v2.route.Route proto) {\n-      RouteMatch routeMatch = RouteMatch.fromEnvoyProtoRouteMatch(proto.getMatch());\n-      RouteAction routeAction = null;\n-      if (proto.hasRoute()) {\n-        routeAction = RouteAction.fromEnvoyProtoRouteAction(proto.getRoute());\n+    @Nullable\n+    static StructOrError<Route> fromEnvoyProtoRoute(io.envoyproxy.envoy.api.v2.route.Route proto) {\n+      StructOrError<RouteMatch> routeMatch = RouteMatch.fromEnvoyProtoRouteMatch(proto.getMatch());\n+      if (routeMatch == null) {\n+        return null;\n+      }\n+      if (routeMatch.getErrorDetail() != null) {\n+        return StructOrError.fromError(\n+            \"Invalid route [\" + proto.getName() + \"] : \" + routeMatch.getErrorDetail());\n+      }\n+\n+      StructOrError<RouteAction> routeAction;\n+      switch (proto.getActionCase()) {\n+        case ROUTE:\n+          routeAction = RouteAction.fromEnvoyProtoRouteAction(proto.getRoute());\n+          break;\n+        case REDIRECT:\n+          return StructOrError.fromError(\"Unsupported action type: redirect\");\n+        case DIRECT_RESPONSE:\n+          return StructOrError.fromError(\"Unsupported action type: direct_response\");\n+        case FILTER_ACTION:\n+          return StructOrError.fromError(\"Unsupported action type: filter_action\");\n+        case ACTION_NOT_SET:\n+          // fall through\n+        default:\n+          return StructOrError.fromError(\"Unknown action type: \" + proto.getActionCase());\n       }\n-      return new Route(routeMatch, routeAction);\n+      if (routeAction.getErrorDetail() != null) {\n+        return StructOrError.fromError(\n+            \"Invalid route [\" + proto.getName() + \"] : \" + routeAction.getErrorDetail());\n+      }\n+      return StructOrError.fromStruct(new Route(routeMatch.getStruct(), routeAction.getStruct()));\n     }\n   }\n \n   /** See corresponding Envoy proto message {@link io.envoyproxy.envoy.api.v2.route.RouteMatch}. */\n   static final class RouteMatch {\n-    private final String prefix;\n-    private final String path;\n-    private final boolean hasRegex;\n-    private final boolean caseSensitive;\n-\n-    @VisibleForTesting\n-    RouteMatch(String prefix, String path, boolean hasRegex, boolean caseSensitive) {\n-      this.prefix = prefix;\n-      this.path = path;\n-      this.hasRegex = hasRegex;\n-      this.caseSensitive = caseSensitive;\n-    }\n+    // Exactly one of the following fields is non-null.\n+    @Nullable\n+    private final String pathPrefixMatch;\n+    @Nullable\n+    private final String pathExactMatch;\n+    @Nullable\n+    private final String pathSafeRegExMatch;\n \n-    String getPrefix() {\n-      return prefix;\n-    }\n+    private final List<HeaderMatcher> headerMatchers;\n+    @Nullable\n+    private final Fraction fractionMatch;\n \n-    String getPath() {\n-      return path;\n+    @VisibleForTesting\n+    RouteMatch(\n+        @Nullable String pathPrefixMatch, @Nullable String pathExactMatch,\n+        @Nullable String pathSafeRegExMatch, @Nullable Fraction fractionMatch,\n+        List<HeaderMatcher> headerMatchers) {\n+      this.pathPrefixMatch = pathPrefixMatch;\n+      this.pathExactMatch = pathExactMatch;\n+      this.pathSafeRegExMatch = pathSafeRegExMatch;\n+      this.fractionMatch = fractionMatch;\n+      this.headerMatchers = headerMatchers;\n+    }\n+\n+    RouteMatch(@Nullable String pathPrefixMatch, @Nullable String pathExactMatch) {\n+      this(\n+          pathPrefixMatch, pathExactMatch, null, null,\n+          Collections.<HeaderMatcher>emptyList());\n     }\n \n-    boolean hasRegex() {\n-      return hasRegex;\n+    @Nullable\n+    String getPathPrefixMatch() {\n+      return pathPrefixMatch;\n     }\n \n-    boolean isCaseSensitive() {\n-      return caseSensitive;\n+    @Nullable\n+    String getPathExactMatch() {\n+      return pathExactMatch;\n     }\n \n-    boolean isDefaultMatcher() {\n-      if (hasRegex) {\n+    boolean isMatchAll() {\n+      if (pathSafeRegExMatch != null || fractionMatch != null) {\n         return false;\n       }\n-      if (!path.isEmpty()) {\n+      if (headerMatchers != null && !headerMatchers.isEmpty()) {\n         return false;\n       }\n-      return prefix.isEmpty() || prefix.equals(\"/\");\n+      if (pathExactMatch != null) {\n+        return pathExactMatch.isEmpty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3dd2b6ed6a298fc9c73383c399b3fedb0585f83"}, "originalPosition": 248}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2MTc5NA==", "bodyText": "\"\" in path is not default. It's not valid.", "url": "https://github.com/grpc/grpc-java/pull/7031#discussion_r426061794", "createdAt": "2020-05-15T21:47:59Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -446,62 +574,357 @@ public boolean equals(Object o) {\n         return false;\n       }\n       RouteMatch that = (RouteMatch) o;\n-      return hasRegex == that.hasRegex\n-          && caseSensitive == that.caseSensitive\n-          && Objects.equals(prefix, that.prefix)\n-          && Objects.equals(path, that.path);\n+      return Objects.equals(pathPrefixMatch, that.pathPrefixMatch)\n+          && Objects.equals(pathExactMatch, that.pathExactMatch)\n+          && Objects.equals(pathSafeRegExMatch, that.pathSafeRegExMatch)\n+          && Objects.equals(fractionMatch, that.fractionMatch)\n+          && Objects.equals(headerMatchers, that.headerMatchers);\n     }\n \n     @Override\n     public int hashCode() {\n-      return Objects.hash(prefix, path, caseSensitive, hasRegex);\n+      return Objects.hash(pathPrefixMatch, pathExactMatch, headerMatchers, fractionMatch);\n     }\n \n     @Override\n     public String toString() {\n       return MoreObjects.toStringHelper(this)\n-          .add(\"prefix\", prefix)\n-          .add(\"path\", path)\n-          .add(\"hasRegex\", hasRegex)\n-          .add(\"caseSensitive\", caseSensitive)\n+          .add(\"prefixPathMatch\", pathPrefixMatch)\n+          .add(\"exactPathMatch\", pathExactMatch)\n+          .add(\"safeRegExPathMatch\", pathSafeRegExMatch)\n+          .add(\"headerMatchers\", headerMatchers)\n+          .add(\"fractionMatch\", fractionMatch)\n           .toString();\n     }\n \n     @VisibleForTesting\n-    static RouteMatch fromEnvoyProtoRouteMatch(\n+    @SuppressWarnings(\"deprecation\")\n+    @Nullable\n+    static StructOrError<RouteMatch> fromEnvoyProtoRouteMatch(\n         io.envoyproxy.envoy.api.v2.route.RouteMatch proto) {\n-      return new RouteMatch(\n-          /* prefix= */ proto.getPrefix(),\n-          /* path= */ proto.getPath(),\n-          /* hasRegex= */ !proto.getRegex().isEmpty() || proto.hasSafeRegex(),\n-          // case_sensitive defaults to true if the field is not set\n-          /*caseSensitive= */ !proto.hasCaseSensitive() || proto.getCaseSensitive().getValue());\n+      if (proto.getQueryParametersCount() != 0) {\n+        return null;\n+      }\n+      if (proto.hasCaseSensitive() && !proto.getCaseSensitive().getValue()) {\n+        return StructOrError.fromError(\"Unsupported match option: case insensitive\");\n+      }\n+\n+      Fraction fraction = null;\n+      if (proto.hasRuntimeFraction()) {\n+        io.envoyproxy.envoy.type.FractionalPercent percent =\n+            proto.getRuntimeFraction().getDefaultValue();\n+        int numerator = percent.getNumerator();\n+        int denominator = 0;\n+        switch (percent.getDenominator()) {\n+          case HUNDRED:\n+            denominator = 100;\n+            break;\n+          case TEN_THOUSAND:\n+            denominator = 10_000;\n+            break;\n+          case MILLION:\n+            denominator = 1_000_000;\n+            break;\n+          case UNRECOGNIZED:\n+            // fall through\n+          default:\n+            return StructOrError.fromError(\n+                \"Unrecognized fractional percent denominator: \" + percent.getDenominator());\n+        }\n+        fraction = new Fraction(numerator, denominator);\n+      }\n+\n+      String prefixPathMatch = null;\n+      String exactPathMatch = null;\n+      String safeRegExPathMatch = null;\n+      switch (proto.getPathSpecifierCase()) {\n+        case PREFIX:\n+          prefixPathMatch = proto.getPrefix();\n+          // Supported prefix match format:\n+          // \"\", \"/\" (default)\n+          // \"/service/\"\n+          if (!prefixPathMatch.isEmpty() && !prefixPathMatch.equals(\"/\")) {\n+            if (!prefixPathMatch.startsWith(\"/\") || !prefixPathMatch.endsWith(\"/\")\n+                || prefixPathMatch.length() < 3) {\n+              return StructOrError.fromError(\n+                  \"Invalid format of prefix path match: \" + prefixPathMatch);\n+            }\n+          }\n+          break;\n+        case PATH:\n+          exactPathMatch = proto.getPath();\n+          int lastSlash = exactPathMatch.lastIndexOf('/');\n+          // Supported exact match format:\n+          // \"\" (default)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3dd2b6ed6a298fc9c73383c399b3fedb0585f83"}, "originalPosition": 359}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d6cc36d68fde01528a89f6befafee525c58d56d", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/3d6cc36d68fde01528a89f6befafee525c58d56d", "committedDate": "2020-05-15T22:45:30Z", "message": "Fix formatting issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2178d014f2ee4c7a9f265b5cfaaa81266aac8d3", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/c2178d014f2ee4c7a9f265b5cfaaa81266aac8d3", "committedDate": "2020-05-15T23:12:33Z", "message": "Fix rules for default route."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyOTk4MDIy", "url": "https://github.com/grpc/grpc-java/pull/7031#pullrequestreview-412998022", "createdAt": "2020-05-15T22:18:57Z", "commit": {"oid": "d3dd2b6ed6a298fc9c73383c399b3fedb0585f83"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMjoxODo1OFrOGWVTQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMzoxODoyNVrOGWWLXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA3MDg0OA==", "bodyText": "@Nullable", "url": "https://github.com/grpc/grpc-java/pull/7031#discussion_r426070848", "createdAt": "2020-05-15T22:18:58Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -824,34 +811,89 @@ private void handleRdsResponse(DiscoveryResponse rdsResponse) {\n         rdsRespTimer.cancel();\n         rdsRespTimer = null;\n       }\n-\n-      // Found routes in the in-lined RouteConfiguration.\n-      ConfigUpdate configUpdate;\n-      if (!enableExperimentalRouting) {\n-        EnvoyProtoData.Route defaultRoute = Iterables.getLast(routes);\n-        configUpdate =\n-            ConfigUpdate.newBuilder()\n-                .addRoutes(ImmutableList.of(defaultRoute))\n-                .build();\n-        logger.log(\n-            XdsLogLevel.INFO,\n-            \"Found cluster name: {0}\",\n-            defaultRoute.getRouteAction().getCluster());\n-      } else {\n-        configUpdate = ConfigUpdate.newBuilder().addRoutes(routes).build();\n-        logger.log(XdsLogLevel.INFO, \"Found {0} routes\", routes.size());\n-        logger.log(XdsLogLevel.DEBUG, \"Found routes: {0}\", routes);\n-      }\n+      logger.log(XdsLogLevel.DEBUG, \"Found routes: {0}\", routes);\n+      ConfigUpdate configUpdate  =\n+          ConfigUpdate.newBuilder().addRoutes(routes).build();\n       configWatcher.onConfigChanged(configUpdate);\n     }\n   }\n \n   /**\n    * Processes a RouteConfiguration message to find the routes that requests for the given host will\n    * be routed to.\n+   *\n+   * @throws InvalidProtoDataException if the message contains invalid data.\n    */\n   @VisibleForTesting\n-  static List<EnvoyProtoData.Route> findRoutesInRouteConfig(\n+  private static List<EnvoyProtoData.Route> findRoutesInRouteConfig(\n+      RouteConfiguration config, String hostName) throws InvalidProtoDataException {\n+    VirtualHost targetVirtualHost = findVirtualHostForHostName(config, hostName);\n+    if (targetVirtualHost == null) {\n+      throw new InvalidProtoDataException(\"Unable to find virtual host for \" + hostName);\n+    }\n+\n+    // Note we would consider upstream cluster not found if the virtual host is not configured\n+    // correctly for gRPC, even if there exist other virtual hosts with (lower priority)\n+    // matching domains.\n+    return populateRoutesInVirtualHost(targetVirtualHost);\n+  }\n+\n+  @VisibleForTesting\n+  static List<EnvoyProtoData.Route> populateRoutesInVirtualHost(VirtualHost virtualHost)\n+      throws InvalidProtoDataException {\n+    List<EnvoyProtoData.Route> routes = new ArrayList<>();\n+    List<Route> routesProto = virtualHost.getRoutesList();\n+    for (Route routeProto : routesProto) {\n+      StructOrError<EnvoyProtoData.Route> route =\n+          EnvoyProtoData.Route.fromEnvoyProtoRoute(routeProto);\n+      if (route == null) {\n+        continue;\n+      } else if (route.getErrorDetail() != null) {\n+        throw new InvalidProtoDataException(\n+            \"Virtual host [\" + virtualHost.getName() + \"] contains invalid route : \"\n+                + route.getErrorDetail());\n+      }\n+      routes.add(route.getStruct());\n+    }\n+    if (routes.isEmpty()) {\n+      throw new InvalidProtoDataException(\n+          \"Virtual host [\" + virtualHost.getName() + \"] contains no usable route\");\n+    }\n+    // The last route must be a default route.\n+    if (!Iterables.getLast(routes).isDefaultRoute()) {\n+      throw new InvalidProtoDataException(\n+          \"Virtual host [\" + virtualHost.getName()\n+              + \"] contains non-default route as the last route\");\n+    }\n+    // We only validate the default route unless path matching is enabled.\n+    if (!enableExperimentalRouting) {\n+      EnvoyProtoData.Route defaultRoute = Iterables.getLast(routes);\n+      if (defaultRoute.getRouteAction().getCluster() == null) {\n+        throw new InvalidProtoDataException(\n+            \"Virtual host [\" + virtualHost.getName()\n+                + \"] default route contains no cluster name\");\n+      }\n+      return Collections.singletonList(defaultRoute);\n+    }\n+\n+    // We do more validation if path matching is enabled, but whether every single route is\n+    // required to be valid for grpc is TBD.\n+    // For now we consider the whole list invalid if anything invalid for grpc is found.\n+    // TODO(zdapeng): Fix it if the decision is different from current implementation.\n+    // TODO(zdapeng): Add test for validation.\n+    for (EnvoyProtoData.Route route : routes) {\n+      if (route.getRouteAction().getCluster() == null\n+          && route.getRouteAction().getWeightedCluster() == null) {\n+        throw new InvalidProtoDataException(\n+            \"Virtual host [\" + virtualHost.getName()\n+                + \"] contains route without cluster or weighted cluster\");\n+      }\n+    }\n+    return Collections.unmodifiableList(routes);\n+  }\n+\n+  @VisibleForTesting\n+  static VirtualHost findVirtualHostForHostName(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3dd2b6ed6a298fc9c73383c399b3fedb0585f83"}, "originalPosition": 182}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA3NDYzNg==", "bodyText": "Remove @VisibleForTesting", "url": "https://github.com/grpc/grpc-java/pull/7031#discussion_r426074636", "createdAt": "2020-05-15T22:33:07Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -824,34 +811,89 @@ private void handleRdsResponse(DiscoveryResponse rdsResponse) {\n         rdsRespTimer.cancel();\n         rdsRespTimer = null;\n       }\n-\n-      // Found routes in the in-lined RouteConfiguration.\n-      ConfigUpdate configUpdate;\n-      if (!enableExperimentalRouting) {\n-        EnvoyProtoData.Route defaultRoute = Iterables.getLast(routes);\n-        configUpdate =\n-            ConfigUpdate.newBuilder()\n-                .addRoutes(ImmutableList.of(defaultRoute))\n-                .build();\n-        logger.log(\n-            XdsLogLevel.INFO,\n-            \"Found cluster name: {0}\",\n-            defaultRoute.getRouteAction().getCluster());\n-      } else {\n-        configUpdate = ConfigUpdate.newBuilder().addRoutes(routes).build();\n-        logger.log(XdsLogLevel.INFO, \"Found {0} routes\", routes.size());\n-        logger.log(XdsLogLevel.DEBUG, \"Found routes: {0}\", routes);\n-      }\n+      logger.log(XdsLogLevel.DEBUG, \"Found routes: {0}\", routes);\n+      ConfigUpdate configUpdate  =\n+          ConfigUpdate.newBuilder().addRoutes(routes).build();\n       configWatcher.onConfigChanged(configUpdate);\n     }\n   }\n \n   /**\n    * Processes a RouteConfiguration message to find the routes that requests for the given host will\n    * be routed to.\n+   *\n+   * @throws InvalidProtoDataException if the message contains invalid data.\n    */\n   @VisibleForTesting\n-  static List<EnvoyProtoData.Route> findRoutesInRouteConfig(\n+  private static List<EnvoyProtoData.Route> findRoutesInRouteConfig(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3dd2b6ed6a298fc9c73383c399b3fedb0585f83"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4NTIxMw==", "bodyText": "Might better to disable stacktrace which causes a lot of memory allocation.", "url": "https://github.com/grpc/grpc-java/pull/7031#discussion_r426085213", "createdAt": "2020-05-15T23:18:25Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -1792,4 +1750,13 @@ String print(MessageOrBuilder message) {\n       return res;\n     }\n   }\n+\n+  @VisibleForTesting\n+  static final class InvalidProtoDataException extends RuntimeException {\n+    private static final long serialVersionUID = 1L;\n+\n+    private InvalidProtoDataException(String message) {\n+      super(message);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2178d014f2ee4c7a9f265b5cfaaa81266aac8d3"}, "originalPosition": 289}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ed8ac3ac3be228acfd41726ce55207781b159af", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/4ed8ac3ac3be228acfd41726ce55207781b159af", "committedDate": "2020-05-15T23:42:58Z", "message": "Add re2j dependency to grpc-xds for path/header matching."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "213388b3a98a836afa8826a12fae832955435d83", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/213388b3a98a836afa8826a12fae832955435d83", "committedDate": "2020-05-15T23:43:25Z", "message": "Safe regex should be verified by compiling it during data conversion."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8928bbd4baa1fbd1cb1f642873f10b9129f849ff", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/8928bbd4baa1fbd1cb1f642873f10b9129f849ff", "committedDate": "2020-05-15T23:46:33Z", "message": "Fix annotation styling issue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dd103d6211d3dcec0f768ba8ed8cca158d3d0dd", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/0dd103d6211d3dcec0f768ba8ed8cca158d3d0dd", "committedDate": "2020-05-15T23:53:54Z", "message": "Disable unnecessary stacktrace and suppresion info for InvalidProtoDataException, as it's used internally."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMDI0ODMz", "url": "https://github.com/grpc/grpc-java/pull/7031#pullrequestreview-413024833", "createdAt": "2020-05-16T00:06:24Z", "commit": {"oid": "213388b3a98a836afa8826a12fae832955435d83"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQwMDowNjoyNFrOGWWuMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQwMDowNjoyNFrOGWWuMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA5NDEzMQ==", "bodyText": "Equal objects must have equal hashCode.", "url": "https://github.com/grpc/grpc-java/pull/7031#discussion_r426094131", "createdAt": "2020-05-16T00:06:24Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -574,7 +576,9 @@ public boolean equals(Object o) {\n       RouteMatch that = (RouteMatch) o;\n       return Objects.equals(pathPrefixMatch, that.pathPrefixMatch)\n           && Objects.equals(pathExactMatch, that.pathExactMatch)\n-          && Objects.equals(pathSafeRegExMatch, that.pathSafeRegExMatch)\n+          && Objects.equals(\n+              pathSafeRegExMatch == null ? null : pathSafeRegExMatch.pattern(),\n+              that.pathSafeRegExMatch == null  ? null : that.pathSafeRegExMatch.pattern())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "213388b3a98a836afa8826a12fae832955435d83"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf84387478f02dc9bc020268ec641532339ee3fc", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/cf84387478f02dc9bc020268ec641532339ee3fc", "committedDate": "2020-05-18T17:28:03Z", "message": "Fix hashCode for equal HeaderMatcher object."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6038df23dcbf57c589f0e6a1e72bfb9555713ddb", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/6038df23dcbf57c589f0e6a1e72bfb9555713ddb", "committedDate": "2020-05-18T17:38:58Z", "message": "Improve toString."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzODA1Mjc2", "url": "https://github.com/grpc/grpc-java/pull/7031#pullrequestreview-413805276", "createdAt": "2020-05-18T17:39:21Z", "commit": {"oid": "cf84387478f02dc9bc020268ec641532339ee3fc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cbf1936e66749746389f5ffca8f1a777923a790", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/1cbf1936e66749746389f5ffca8f1a777923a790", "committedDate": "2020-05-18T18:00:08Z", "message": "Style issue (whitespace)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzODQ1MTc4", "url": "https://github.com/grpc/grpc-java/pull/7031#pullrequestreview-413845178", "createdAt": "2020-05-18T18:39:45Z", "commit": {"oid": "1cbf1936e66749746389f5ffca8f1a777923a790"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4411, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}