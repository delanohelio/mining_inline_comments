{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3MTY4NTMy", "number": 7481, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMTo0OTo1N1rOErzYOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTo0Nzo1MFrOEtrJzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MzY2MDEwOnYy", "diffSide": "RIGHT", "path": "xds/src/main/java/io/grpc/xds/XdsNameResolver.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMTo0OTo1N1rOHexoNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjowODozN1rOHeyFjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzMjQzOQ==", "bodyText": "Note there is a race between updating currentRoutes and fallbackTimeoutNano. The config selector might select a route from the updated currentRoutes list while using the old fallbackTimeoutNano. That is, these two updates should be atomic but actually it is not. The race window should be extremely small (should be almost negligible).\nOne option is to create a data structure that groups these two fields so that the update can be atomic. But given the race window is small, may not be necessary to do that.", "url": "https://github.com/grpc/grpc-java/pull/7481#discussion_r502032439", "createdAt": "2020-10-08T21:49:57Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsNameResolver.java", "diffHunk": "@@ -511,6 +522,7 @@ private void updateRoutes(List<VirtualHost> virtualHosts) {\n       // Make newly added clusters selectable by config selector and deleted clusters no longer\n       // selectable.\n       currentRoutes = routes;\n+      fallbackTimeoutNano = httpMaxStreamDurationNano;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e25669edbddd46f229b567da25215d9e71717d97"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzOTk0OA==", "bodyText": "Alright, eliminated the race by grouping the list of routes and fallback timeout value into RoutingConfig.", "url": "https://github.com/grpc/grpc-java/pull/7481#discussion_r502039948", "createdAt": "2020-10-08T22:08:37Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsNameResolver.java", "diffHunk": "@@ -511,6 +522,7 @@ private void updateRoutes(List<VirtualHost> virtualHosts) {\n       // Make newly added clusters selectable by config selector and deleted clusters no longer\n       // selectable.\n       currentRoutes = routes;\n+      fallbackTimeoutNano = httpMaxStreamDurationNano;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzMjQzOQ=="}, "originalCommit": {"oid": "e25669edbddd46f229b567da25215d9e71717d97"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MzI4Mzk3OnYy", "diffSide": "RIGHT", "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "isResolved": false, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTo0Nzo1MFrOHhmRkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMzoyMzo0M1rOHhqjQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk5MjE0NA==", "bodyText": "I think we should expose hasMaxStreamDuration() based on the 3rd bullet point in https://github.com/grpc/proposal/blob/master/A31-xds-timeout-support-and-config-selector.md#supported-fields\nWe can not simply check timeoutNano == 0 instead of maxStreamDuration.hasMaxStreamDuration()). Two cases that's not working as spec:\n\n\nCase 1: maxStreamDuration.hasGrpcTimeoutHeaderMax() and maxStreamDuration.getGrpcTimeoutHeaderMax() == 0. In this case, we should use 0 regardless of value of fallback timeout.\n\n\nCase 2: !maxStreamDuration.hasGrpcTimeoutHeaderMax() and maxStreamDuration.hasMaxStreamDuration() and maxStreamDuration.getMaxStreamDuration() == 0. In this case, we should use 0 regardless of value of fallback timeout.", "url": "https://github.com/grpc/grpc-java/pull/7481#discussion_r504992144", "createdAt": "2020-10-14T21:47:50Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -1231,14 +1230,15 @@ public String toString() {\n           return StructOrError.fromError(\n               \"Unknown cluster specifier: \" + proto.getClusterSpecifierCase());\n       }\n-      long timeoutNano = TimeUnit.SECONDS.toNanos(15L);  // default 15s\n-      if (proto.hasMaxGrpcTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getMaxGrpcTimeout());\n-      } else if (proto.hasTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getTimeout());\n-      }\n-      if (timeoutNano == 0) {\n-        timeoutNano = Long.MAX_VALUE;\n+      long timeoutNano = 0L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49c14d25f4545b208121a1c29eef9a6a3f579a45"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAxMjgyOQ==", "bodyText": "Nope, if you look at the table in the gRFC, a value of 0 for any of those fields is effectively equivalent to the field is not set.\nSo the order of preference is:\n\nIf maxStreamDuration.hasGrpcTimeoutHeaderMax() and maxStreamDuration.getGrpcTimeoutHeaderMax() != 0: use it. Otherwise, go to next step.\nIf maxStreamDuration.hasMaxStreamDuration() and maxStreamDuration.getMaxStreamDuration() != 0: use it. Otherwise, go to next step.\nIf max_stream_duration from the HttpConnectionManager.common_http_options is not 0, use this as timeout. Otherwise, use application's timeout.", "url": "https://github.com/grpc/grpc-java/pull/7481#discussion_r505012829", "createdAt": "2020-10-14T22:14:07Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -1231,14 +1230,15 @@ public String toString() {\n           return StructOrError.fromError(\n               \"Unknown cluster specifier: \" + proto.getClusterSpecifierCase());\n       }\n-      long timeoutNano = TimeUnit.SECONDS.toNanos(15L);  // default 15s\n-      if (proto.hasMaxGrpcTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getMaxGrpcTimeout());\n-      } else if (proto.hasTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getTimeout());\n-      }\n-      if (timeoutNano == 0) {\n-        timeoutNano = Long.MAX_VALUE;\n+      long timeoutNano = 0L;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk5MjE0NA=="}, "originalCommit": {"oid": "49c14d25f4545b208121a1c29eef9a6a3f579a45"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAxNDgxNQ==", "bodyText": "The table is after applying the fallback if possible.\n\"Note that the max_stream_duration column refers to the effective setting based on both RouteAction.max_stream_duration.max_stream_duration and the max_stream_duration from the HTTP Connection Manager's common_http_options.\"\nThe condition for when to apply fallback does not change.", "url": "https://github.com/grpc/grpc-java/pull/7481#discussion_r505014815", "createdAt": "2020-10-14T22:16:39Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -1231,14 +1230,15 @@ public String toString() {\n           return StructOrError.fromError(\n               \"Unknown cluster specifier: \" + proto.getClusterSpecifierCase());\n       }\n-      long timeoutNano = TimeUnit.SECONDS.toNanos(15L);  // default 15s\n-      if (proto.hasMaxGrpcTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getMaxGrpcTimeout());\n-      } else if (proto.hasTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getTimeout());\n-      }\n-      if (timeoutNano == 0) {\n-        timeoutNano = Long.MAX_VALUE;\n+      long timeoutNano = 0L;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk5MjE0NA=="}, "originalCommit": {"oid": "49c14d25f4545b208121a1c29eef9a6a3f579a45"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAxNzMyOQ==", "bodyText": "See my updated comment. I don't understand your point. But, a value of 0 is effectively equivalent to it is not set, do you agree with that?", "url": "https://github.com/grpc/grpc-java/pull/7481#discussion_r505017329", "createdAt": "2020-10-14T22:19:55Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -1231,14 +1230,15 @@ public String toString() {\n           return StructOrError.fromError(\n               \"Unknown cluster specifier: \" + proto.getClusterSpecifierCase());\n       }\n-      long timeoutNano = TimeUnit.SECONDS.toNanos(15L);  // default 15s\n-      if (proto.hasMaxGrpcTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getMaxGrpcTimeout());\n-      } else if (proto.hasTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getTimeout());\n-      }\n-      if (timeoutNano == 0) {\n-        timeoutNano = Long.MAX_VALUE;\n+      long timeoutNano = 0L;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk5MjE0NA=="}, "originalCommit": {"oid": "49c14d25f4545b208121a1c29eef9a6a3f579a45"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAxOTI0OA==", "bodyText": "Case 1 corresponds to row 4 of the table.\n\nIf maxStreamDuration.hasGrpcTimeoutHeaderMax() and maxStreamDuration.getGrpcTimeoutHeaderMax() != 0: use it. Otherwise, go to next step.\n\nThis is completely broken for case 1.", "url": "https://github.com/grpc/grpc-java/pull/7481#discussion_r505019248", "createdAt": "2020-10-14T22:22:33Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -1231,14 +1230,15 @@ public String toString() {\n           return StructOrError.fromError(\n               \"Unknown cluster specifier: \" + proto.getClusterSpecifierCase());\n       }\n-      long timeoutNano = TimeUnit.SECONDS.toNanos(15L);  // default 15s\n-      if (proto.hasMaxGrpcTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getMaxGrpcTimeout());\n-      } else if (proto.hasTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getTimeout());\n-      }\n-      if (timeoutNano == 0) {\n-        timeoutNano = Long.MAX_VALUE;\n+      long timeoutNano = 0L;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk5MjE0NA=="}, "originalCommit": {"oid": "49c14d25f4545b208121a1c29eef9a6a3f579a45"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAyMTAzNQ==", "bodyText": "Ah, that table is problematic. If you interpret it in that way, the second last row is a counter-example...", "url": "https://github.com/grpc/grpc-java/pull/7481#discussion_r505021035", "createdAt": "2020-10-14T22:24:55Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -1231,14 +1230,15 @@ public String toString() {\n           return StructOrError.fromError(\n               \"Unknown cluster specifier: \" + proto.getClusterSpecifierCase());\n       }\n-      long timeoutNano = TimeUnit.SECONDS.toNanos(15L);  // default 15s\n-      if (proto.hasMaxGrpcTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getMaxGrpcTimeout());\n-      } else if (proto.hasTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getTimeout());\n-      }\n-      if (timeoutNano == 0) {\n-        timeoutNano = Long.MAX_VALUE;\n+      long timeoutNano = 0L;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk5MjE0NA=="}, "originalCommit": {"oid": "49c14d25f4545b208121a1c29eef9a6a3f579a45"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAyMjU2NQ==", "bodyText": "the second last row is a counter-example\n\nThe second from the last row does not conflict with any other row, it just takes min(20, infinite).", "url": "https://github.com/grpc/grpc-java/pull/7481#discussion_r505022565", "createdAt": "2020-10-14T22:27:09Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -1231,14 +1230,15 @@ public String toString() {\n           return StructOrError.fromError(\n               \"Unknown cluster specifier: \" + proto.getClusterSpecifierCase());\n       }\n-      long timeoutNano = TimeUnit.SECONDS.toNanos(15L);  // default 15s\n-      if (proto.hasMaxGrpcTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getMaxGrpcTimeout());\n-      } else if (proto.hasTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getTimeout());\n-      }\n-      if (timeoutNano == 0) {\n-        timeoutNano = Long.MAX_VALUE;\n+      long timeoutNano = 0L;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk5MjE0NA=="}, "originalCommit": {"oid": "49c14d25f4545b208121a1c29eef9a6a3f579a45"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA2MjIxMA==", "bodyText": "Okay, fixed. Falling back to max_stream_duration from the HttpConnectionManager.common_http_options will only take place if both !maxStreamDuration.hasGrpcTimeoutHeaderMax() and !maxStreamDuration.hasMaxStreamDuration() hold. We don't need to make the last fallback value nullable as its value of 0 and unset are treated equivalently (aka, as infinite) when it is indeed used.", "url": "https://github.com/grpc/grpc-java/pull/7481#discussion_r505062210", "createdAt": "2020-10-14T23:23:43Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -1231,14 +1230,15 @@ public String toString() {\n           return StructOrError.fromError(\n               \"Unknown cluster specifier: \" + proto.getClusterSpecifierCase());\n       }\n-      long timeoutNano = TimeUnit.SECONDS.toNanos(15L);  // default 15s\n-      if (proto.hasMaxGrpcTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getMaxGrpcTimeout());\n-      } else if (proto.hasTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getTimeout());\n-      }\n-      if (timeoutNano == 0) {\n-        timeoutNano = Long.MAX_VALUE;\n+      long timeoutNano = 0L;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk5MjE0NA=="}, "originalCommit": {"oid": "49c14d25f4545b208121a1c29eef9a6a3f579a45"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2373, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}