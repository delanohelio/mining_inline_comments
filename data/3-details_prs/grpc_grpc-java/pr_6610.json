{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzMzI5MDkz", "number": 6610, "title": "netty: fix a race for channelz at server transport creation", "bodyText": "A race condition was reported by user in #6601:\nServerImpl.start() calls NettyServer.start() while holding ServerImpl.lock. NettyServer.start() awaits a submitted runnable in eventloop. However, this pending runnable may never be executed because the eventloop might be executing some other task, like ServerListenerImpl.transportCreated(), that is trying to acquire ServerImpl.lock causing a deadlock.\nThis PR resolves the particular issue reported in #6601 for server with a single port, but NettyServer (https://github.com/grpc/grpc-java/blob/v1.26.0/netty/src/main/java/io/grpc/netty/NettyServer.java#L251) and ServerImpl (https://github.com/grpc/grpc-java/blob/v1.26.0/core/src/main/java/io/grpc/internal/ServerImpl.java#L184) in general still have the same potential risk of deadlock, which need further fix.", "createdAt": "2020-01-15T20:43:33Z", "url": "https://github.com/grpc/grpc-java/pull/6610", "merged": true, "mergeCommit": {"oid": "b8474d61c966f60cc0bad4e5abaca351e90afc9d"}, "closed": true, "closedAt": "2020-01-16T19:53:38Z", "author": {"login": "dapengzhang0"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6r3gegBqjI5NTIyNjk3OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6_LpwgFqTM0NDE1NDQ4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c03404c2e7315bc42fbc1b710765c0f668517ec5", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/c03404c2e7315bc42fbc1b710765c0f668517ec5", "committedDate": "2020-01-15T20:42:33Z", "message": "core,netty: fix a race for channelz at server transport creation"}, "afterCommit": {"oid": "98b11bdde4c792f9b817d7fed46dfcad5195140e", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/98b11bdde4c792f9b817d7fed46dfcad5195140e", "committedDate": "2020-01-15T20:48:47Z", "message": "core,netty: fix a race for channelz at server transport creation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4077bfe8be5d70741343a224af11fc472c1dc46", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/a4077bfe8be5d70741343a224af11fc472c1dc46", "committedDate": "2020-01-15T21:00:14Z", "message": "netty: fix a race for channelz at server transport creation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98b11bdde4c792f9b817d7fed46dfcad5195140e", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/98b11bdde4c792f9b817d7fed46dfcad5195140e", "committedDate": "2020-01-15T20:48:47Z", "message": "core,netty: fix a race for channelz at server transport creation"}, "afterCommit": {"oid": "a4077bfe8be5d70741343a224af11fc472c1dc46", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/a4077bfe8be5d70741343a224af11fc472c1dc46", "committedDate": "2020-01-15T21:00:14Z", "message": "netty: fix a race for channelz at server transport creation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNTkzNDU2", "url": "https://github.com/grpc/grpc-java/pull/6610#pullrequestreview-343593456", "createdAt": "2020-01-15T23:36:59Z", "commit": {"oid": "a4077bfe8be5d70741343a224af11fc472c1dc46"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMzozNjo1OVrOFeJ30w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMzozNjo1OVrOFeJ30w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE2MzM0Nw==", "bodyText": "Make a comment here that this requires the channel to have completed bind()ing.", "url": "https://github.com/grpc/grpc-java/pull/6610#discussion_r367163347", "createdAt": "2020-01-15T23:36:59Z", "author": {"login": "ejona86"}, "path": "netty/src/main/java/io/grpc/netty/NettyServer.java", "diffHunk": "@@ -251,19 +251,10 @@ public void operationComplete(ChannelFuture future) throws Exception {\n       throw new IOException(\"Failed to bind\", future.cause());\n     }\n     channel = future.channel();\n-    Future<?> channelzFuture = channel.eventLoop().submit(new Runnable() {\n-      @Override\n-      public void run() {\n-        InternalInstrumented<SocketStats> listenSocket = new ListenSocket(channel);\n-        listenSocketStats.set(listenSocket);\n-        channelz.addListenSocket(listenSocket);\n-      }\n-    });\n-    try {\n-      channelzFuture.await();\n-    } catch (InterruptedException ex) {\n-      throw new RuntimeException(\"Interrupted while registering listen socket to channelz\", ex);\n-    }\n+\n+    InternalInstrumented<SocketStats> listenSocket = new ListenSocket(channel);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4077bfe8be5d70741343a224af11fc472c1dc46"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dab94306d0a4334bd5854cf6b79c4e2ff7cd9ae8", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/dab94306d0a4334bd5854cf6b79c4e2ff7cd9ae8", "committedDate": "2020-01-16T00:52:17Z", "message": "add SocketStats in event loop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MTA5Mjk4", "url": "https://github.com/grpc/grpc-java/pull/6610#pullrequestreview-344109298", "createdAt": "2020-01-16T18:03:43Z", "commit": {"oid": "dab94306d0a4334bd5854cf6b79c4e2ff7cd9ae8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxODowMzo0NFrOFeimKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxODoxMjoyOVrOFei07A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU2ODQyNQ==", "bodyText": "Binding is complete when start() returns, so I don't think this comment is accurate.", "url": "https://github.com/grpc/grpc-java/pull/6610#discussion_r367568425", "createdAt": "2020-01-16T18:03:44Z", "author": {"login": "ejona86"}, "path": "netty/src/test/java/io/grpc/netty/NettyServerTest.java", "diffHunk": "@@ -239,8 +241,13 @@ public void serverShutdown() {\n         shutdownCompleted.set(null);\n       }\n     });\n+\n     assertThat(((InetSocketAddress) ns.getListenSocketAddress()).getPort()).isGreaterThan(0);\n \n+    Socket socket = new Socket();\n+    socket.connect(ns.getListenSocketAddress(), /* timeout= */ 8000);\n+    socket.close();\n+    countDownLatch.await(); // SocketStats won't be available until binding complete.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dab94306d0a4334bd5854cf6b79c4e2ff7cd9ae8"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU3MjIwNA==", "bodyText": "This works, but is a roundabout way of making sure the event loop has completed the runnable. Would it be better to Create a single EventLoop and pass that as the boss+worker EventLoopGroup to the NettyServer constructor? Then you can submit() your own Runnable and await its completion. We could use that same EventLoop for all the tests, really, if you'd prefer a @BeforeClass/@AfterClass to manage its lifetime.", "url": "https://github.com/grpc/grpc-java/pull/6610#discussion_r367572204", "createdAt": "2020-01-16T18:12:29Z", "author": {"login": "ejona86"}, "path": "netty/src/test/java/io/grpc/netty/NettyServerTest.java", "diffHunk": "@@ -239,8 +241,13 @@ public void serverShutdown() {\n         shutdownCompleted.set(null);\n       }\n     });\n+\n     assertThat(((InetSocketAddress) ns.getListenSocketAddress()).getPort()).isGreaterThan(0);\n \n+    Socket socket = new Socket();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dab94306d0a4334bd5854cf6b79c4e2ff7cd9ae8"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f07f0c5640ec2497857830825a06d4fc82557eea", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/f07f0c5640ec2497857830825a06d4fc82557eea", "committedDate": "2020-01-16T18:28:01Z", "message": "change comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7259df3ecb733a07f022551b1314f8dd2e16fdd5", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/7259df3ecb733a07f022551b1314f8dd2e16fdd5", "committedDate": "2020-01-16T19:10:29Z", "message": "Use fix eventLoop pool in test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MTU0NDg0", "url": "https://github.com/grpc/grpc-java/pull/6610#pullrequestreview-344154484", "createdAt": "2020-01-16T19:19:18Z", "commit": {"oid": "7259df3ecb733a07f022551b1314f8dd2e16fdd5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4810, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}