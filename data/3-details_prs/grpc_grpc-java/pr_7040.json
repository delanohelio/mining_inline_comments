{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NjcyMDcw", "number": 7040, "title": "xds: provide fallback protocol negotiator", "bodyText": "", "createdAt": "2020-05-13T23:51:03Z", "url": "https://github.com/grpc/grpc-java/pull/7040", "merged": true, "mergeCommit": {"oid": "efa9cf67989afd83b5ae52dd46e10f9d6c346fb8"}, "closed": true, "closedAt": "2020-05-18T17:30:14Z", "author": {"login": "sanjaypujare"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchBxFVAH2gAyNDE3NjcyMDcwOjQ2YjkzZWE1NmYyYWUwODQxMzNmZDczNjg3ZDEzZTA0NTg2ZTczMjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcii6eagH2gAyNDE3NjcyMDcwOjNlNTUzNjA3YjVhOTk4ODYxMDZkZjgxYTNkYmZmYjk1ZWY5Y2ZjZGU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "46b93ea56f2ae084133fd73687d13e04586e7320", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/46b93ea56f2ae084133fd73687d13e04586e7320", "committedDate": "2020-05-13T23:49:06Z", "message": "xds: provide fallback protocol negotiator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMDAxNjQ2", "url": "https://github.com/grpc/grpc-java/pull/7040#pullrequestreview-412001646", "createdAt": "2020-05-14T16:55:48Z", "commit": {"oid": "46b93ea56f2ae084133fd73687d13e04586e7320"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNjo1NTo0OVrOGVlmlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNzoyMDowMlrOGVmjxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI4OTM2Ng==", "bodyText": "this comment is not correct, remove it?", "url": "https://github.com/grpc/grpc-java/pull/7040#discussion_r425289366", "createdAt": "2020-05-14T16:55:49Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/internal/sds/XdsServerBuilder.java", "diffHunk": "@@ -129,8 +139,9 @@ public static XdsServerBuilder forPort(int port) {\n   @Override\n   public Server build() {\n     // note: doing it in build() will overwrite any previously set ProtocolNegotiator", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46b93ea56f2ae084133fd73687d13e04586e7320"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI4OTkyNw==", "bodyText": "do we want to provide default value? if no default value, probably no fallback instead of throwing NPE?", "url": "https://github.com/grpc/grpc-java/pull/7040#discussion_r425289927", "createdAt": "2020-05-14T16:56:38Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/internal/sds/XdsServerBuilder.java", "diffHunk": "@@ -43,6 +46,7 @@\n \n   private final NettyServerBuilder delegate;\n   private final int port;\n+  private ProtocolNegotiator fallbackProtocolNegotiator;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46b93ea56f2ae084133fd73687d13e04586e7320"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI5MjkzMA==", "bodyText": "null check here would be nice.", "url": "https://github.com/grpc/grpc-java/pull/7040#discussion_r425292930", "createdAt": "2020-05-14T17:01:25Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/internal/sds/XdsServerBuilder.java", "diffHunk": "@@ -120,6 +124,12 @@ public XdsServerBuilder intercept(ServerInterceptor interceptor) {\n     return this;\n   }\n \n+  public XdsServerBuilder fallbackProtocolNegotiator(\n+      ProtocolNegotiator fallbackProtocolNegotiator) {\n+    this.fallbackProtocolNegotiator = fallbackProtocolNegotiator;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46b93ea56f2ae084133fd73687d13e04586e7320"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMwNTAyOQ==", "bodyText": "i am not sure what this is testing. it provides fallbackPN that throws \"no fallback negotiation\" exception?", "url": "https://github.com/grpc/grpc-java/pull/7040#discussion_r425305029", "createdAt": "2020-05-14T17:20:02Z", "author": {"login": "creamsoup"}, "path": "xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java", "diffHunk": "@@ -87,6 +92,34 @@ public void plaintextClientServer() throws IOException, URISyntaxException {\n     assertThat(unaryRpc(\"buddy\", blockingStub)).isEqualTo(\"Hello buddy\");\n   }\n \n+  @Test\n+  public void fallbackProtocolNegotiator_expectException() throws IOException, URISyntaxException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46b93ea56f2ae084133fd73687d13e04586e7320"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMTY2MzI2", "url": "https://github.com/grpc/grpc-java/pull/7040#pullrequestreview-412166326", "createdAt": "2020-05-14T20:38:28Z", "commit": {"oid": "46b93ea56f2ae084133fd73687d13e04586e7320"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c30db2de23b53795d9942671dae66296cd9b20a", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/2c30db2de23b53795d9942671dae66296cd9b20a", "committedDate": "2020-05-15T05:56:24Z", "message": "xds: address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyODEwMzEx", "url": "https://github.com/grpc/grpc-java/pull/7040#pullrequestreview-412810311", "createdAt": "2020-05-15T16:49:47Z", "commit": {"oid": "2c30db2de23b53795d9942671dae66296cd9b20a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNjo0OTo0N1rOGWMe6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNzowNTo0OFrOGWNAHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTkyNjM3Nw==", "bodyText": "those are @Nullable (anything accept fallbackProtocolNegotiator, there are quite a few of those)", "url": "https://github.com/grpc/grpc-java/pull/7040#discussion_r425926377", "createdAt": "2020-05-15T16:49:47Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/internal/sds/SdsProtocolNegotiators.java", "diffHunk": "@@ -232,12 +236,15 @@ public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause)\n   public static final class ServerSdsProtocolNegotiator implements ProtocolNegotiator {\n \n     private final XdsClientWrapperForServerSds xdsClientWrapperForServerSds;\n+    private final ProtocolNegotiator fallbackProtocolNegotiator;\n \n     /** Constructor. */\n     @VisibleForTesting\n-    public ServerSdsProtocolNegotiator(XdsClientWrapperForServerSds xdsClientWrapperForServerSds) {\n+    public ServerSdsProtocolNegotiator(XdsClientWrapperForServerSds xdsClientWrapperForServerSds,\n+        ProtocolNegotiator fallbackProtocolNegotiator) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c30db2de23b53795d9942671dae66296cd9b20a"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTkzNDg3OA==", "bodyText": "no reply for my previous comment. consider mock here. you can verify newHandler is called or not. this is cleaner and we can remove L316-344.", "url": "https://github.com/grpc/grpc-java/pull/7040#discussion_r425934878", "createdAt": "2020-05-15T17:05:48Z", "author": {"login": "creamsoup"}, "path": "xds/src/test/java/io/grpc/xds/internal/sds/SdsProtocolNegotiatorsTest.java", "diffHunk": "@@ -239,10 +245,11 @@ public SocketAddress localAddress() {\n   }\n \n   @Test\n-  public void serverSdsHandler_nullTlsContext_expectPlaintext() throws IOException {\n+  public void serverSdsHandler_nullTlsContext_expectFallbackProtocolNegotiator() {\n     SdsProtocolNegotiators.HandlerPickerHandler handlerPickerHandler =\n         new SdsProtocolNegotiators.HandlerPickerHandler(\n-            grpcHandler, /* xdsClientWrapperForServerSds= */ null);\n+            grpcHandler, /* xdsClientWrapperForServerSds= */ null,\n+            new FallbackProtocolNegotiator());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c30db2de23b53795d9942671dae66296cd9b20a"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77b3e2cb7ec6cd1fe868973f7f4e652f079804fb", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/77b3e2cb7ec6cd1fe868973f7f4e652f079804fb", "committedDate": "2020-05-17T04:53:36Z", "message": "xds: address review comments - 2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNzczNjYw", "url": "https://github.com/grpc/grpc-java/pull/7040#pullrequestreview-413773660", "createdAt": "2020-05-18T16:53:27Z", "commit": {"oid": "77b3e2cb7ec6cd1fe868973f7f4e652f079804fb"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNjo1MzoyN1rOGW_uAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNjo1MzoyN1rOGW_uAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc2NTgyNw==", "bodyText": "nit: this comment (ed code?) is confusing", "url": "https://github.com/grpc/grpc-java/pull/7040#discussion_r426765827", "createdAt": "2020-05-18T16:53:27Z", "author": {"login": "creamsoup"}, "path": "xds/src/test/java/io/grpc/xds/internal/sds/SdsProtocolNegotiatorsTest.java", "diffHunk": "@@ -239,10 +244,14 @@ public SocketAddress localAddress() {\n   }\n \n   @Test\n-  public void serverSdsHandler_nullTlsContext_expectPlaintext() throws IOException {\n+  public void serverSdsHandler_nullTlsContext_expectFallbackProtocolNegotiator() {\n+    ChannelHandler mockChannelHandler = mock(ChannelHandler.class);\n+    ProtocolNegotiator mockProtocolNegotiator = mock(ProtocolNegotiator.class);\n+    when(mockProtocolNegotiator.newHandler(grpcHandler)).thenReturn(mockChannelHandler);\n     SdsProtocolNegotiators.HandlerPickerHandler handlerPickerHandler =\n         new SdsProtocolNegotiators.HandlerPickerHandler(\n-            grpcHandler, /* xdsClientWrapperForServerSds= */ null);\n+            grpcHandler, /* xdsClientWrapperForServerSds= */ null,\n+            mockProtocolNegotiator);  // new FallbackProtocolNegotiator()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77b3e2cb7ec6cd1fe868973f7f4e652f079804fb"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e553607b5a99886106df81a3dbffb95ef9cfcde", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/3e553607b5a99886106df81a3dbffb95ef9cfcde", "committedDate": "2020-05-18T17:00:09Z", "message": "xds: remove commented code"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4428, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}