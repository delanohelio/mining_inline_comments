{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NzQ3NDI0", "number": 7618, "title": "interop-testing: fix wrong semantics for RPC failure stats in xDS test client", "bodyText": "This is something I found very confusing and error-prone.\nThe proto field is named as num_failures but its comment is saying it is for number of RPCs that failed to record a remote peer.\nRPC failed == RPC failed to record a remote peer was true previously (so no existing tests should be affected by this changed) as server completed RPCs immediately. It is no longer true with server capability to keep the call open/delayed.\nNo change needed for implemented the circuit breaking test as it uses accumulated stats for test logic (connection warmup is not affected).\n\n/cc @menghanl @donnadionne if other languages are also having this issue (you might be in a debug hell in the future with the existing semantics \ud83d\ude22 )", "createdAt": "2020-11-12T09:29:44Z", "url": "https://github.com/grpc/grpc-java/pull/7618", "merged": true, "mergeCommit": {"oid": "76ad953c3639cc42f76b04cd8798e4d64da47e04"}, "closed": true, "closedAt": "2020-11-13T18:28:45Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbu-auAH2gAyNTE5NzQ3NDI0OjUzNjM0OTU4NDFlNmE5ZWZiZTMyYzU0YjM4OWEwZjVkNjQyMDE1N2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcCoqEAFqTUyOTg1MjQ5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5363495841e6a9efbe32c54b389a0f5d6420157f", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/5363495841e6a9efbe32c54b389a0f5d6420157f", "committedDate": "2020-11-12T09:17:00Z", "message": "Clarify the actual semantics of num_failures."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57461432f3e302ced52c5c3c9480e3082d45a6b3", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/57461432f3e302ced52c5c3c9480e3082d45a6b3", "committedDate": "2020-11-12T19:06:36Z", "message": "Should not count RPCs reached the server but failed to num_failures."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93065a2385811a73bf0b9ab5e93ee6236932e50a", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/93065a2385811a73bf0b9ab5e93ee6236932e50a", "committedDate": "2020-11-12T09:17:33Z", "message": "Should not count RPCs reached the server but failed to num_failures."}, "afterCommit": {"oid": "57461432f3e302ced52c5c3c9480e3082d45a6b3", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/57461432f3e302ced52c5c3c9480e3082d45a6b3", "committedDate": "2020-11-12T19:06:36Z", "message": "Should not count RPCs reached the server but failed to num_failures."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NTY4MDg3", "url": "https://github.com/grpc/grpc-java/pull/7618#pullrequestreview-529568087", "createdAt": "2020-11-12T22:55:46Z", "commit": {"oid": "57461432f3e302ced52c5c3c9480e3082d45a6b3"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjo1NTo0N1rOHySDJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjo1NzowMVrOHySGrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4NjU2NA==", "bodyText": "Do your tests need to distinguish between rpcs that have failed (rpcsFailed) versus still pending on the server (latch.getCount())?", "url": "https://github.com/grpc/grpc-java/pull/7618#discussion_r522486564", "createdAt": "2020-11-12T22:55:47Z", "author": {"login": "ericgribkoff"}, "path": "interop-testing/src/main/java/io/grpc/testing/integration/XdsTestClient.java", "diffHunk": "@@ -565,7 +564,7 @@ LoadBalancerStatsResponse waitForRpcStats(long timeoutSeconds) {\n           rpcs.putAllRpcsByPeer(entry.getValue());\n           builder.putRpcsByMethod(getRpcTypeString(entry.getKey()), rpcs.build());\n         }\n-        builder.setNumFailures(noRemotePeer + (int) latch.getCount());\n+        builder.setNumFailures(rpcsFailed + (int) latch.getCount());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57461432f3e302ced52c5c3c9480e3082d45a6b3"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4NzQ2OA==", "bodyText": "Just \"The number of RPCs that failed\" would seem to be enough here.\nWe then also want to change line 194 to say \"The number of successful RPCs for each peer\", right? (AFAICT this change also drops the distribution of errors, which is fine since nothing is relying on that but the comment string should make that clear)", "url": "https://github.com/grpc/grpc-java/pull/7618#discussion_r522487468", "createdAt": "2020-11-12T22:57:01Z", "author": {"login": "ericgribkoff"}, "path": "interop-testing/src/main/proto/grpc/testing/messages.proto", "diffHunk": "@@ -193,7 +193,8 @@ message LoadBalancerStatsRequest {\n message LoadBalancerStatsResponse {\n   // The number of completed RPCs for each peer.\n   map<string, int32> rpcs_by_peer = 1;\n-  // The number of RPCs that failed to record a remote peer.\n+  // The number of RPCs that failed. Either failed on the client before being", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57461432f3e302ced52c5c3c9480e3082d45a6b3"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NTc2MjUx", "url": "https://github.com/grpc/grpc-java/pull/7618#pullrequestreview-529576251", "createdAt": "2020-11-12T23:12:26Z", "commit": {"oid": "57461432f3e302ced52c5c3c9480e3082d45a6b3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMzoxMjoyN1rOHySguw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMzoxMjoyN1rOHySguw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ5NDEzOQ==", "bodyText": "Actually, could you clarify exactly what the problem is that you encountered with the current \"wrong\" semantics? (As best I can tell, these are not wrong exactly but made your new tests harder to debug, but maybe there's actually something broken here that I misunderstand). Were you getting failed RPCs that had still received a peer, so they were getting reported under rpcs_by_peer?\nSince this new change still seems to group outstanding RPCs into num_failures, I don't see how this semantics change directly helps debug any tests with RPCs that are kept-open indefinitely by the server. Unless these end up timing out on the client and then get reported as DEADLINE_EXECEEDED? Even so, that's dependent on the parameters (client-side time out and number of seconds to wait when querying the stats service) and may not always occur. Should this change should also remove latch.getCount() from the reported numberOfFailures?", "url": "https://github.com/grpc/grpc-java/pull/7618#discussion_r522494139", "createdAt": "2020-11-12T23:12:27Z", "author": {"login": "ericgribkoff"}, "path": "interop-testing/src/main/java/io/grpc/testing/integration/XdsTestClient.java", "diffHunk": "@@ -565,7 +564,7 @@ LoadBalancerStatsResponse waitForRpcStats(long timeoutSeconds) {\n           rpcs.putAllRpcsByPeer(entry.getValue());\n           builder.putRpcsByMethod(getRpcTypeString(entry.getKey()), rpcs.build());\n         }\n-        builder.setNumFailures(noRemotePeer + (int) latch.getCount());\n+        builder.setNumFailures(rpcsFailed + (int) latch.getCount());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4NjU2NA=="}, "originalCommit": {"oid": "57461432f3e302ced52c5c3c9480e3082d45a6b3"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c58863dfab4f46e07e8e236367f0f689c0c1713", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/5c58863dfab4f46e07e8e236367f0f689c0c1713", "committedDate": "2020-11-13T06:22:22Z", "message": "Clarify stats message fields."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bc24fc7c6f188fbb09a14702f20dc0743db3112", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/3bc24fc7c6f188fbb09a14702f20dc0743db3112", "committedDate": "2020-11-13T06:23:18Z", "message": "Do not include incompleted RPCs to number of failures."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5ODUyNDk3", "url": "https://github.com/grpc/grpc-java/pull/7618#pullrequestreview-529852497", "createdAt": "2020-11-13T08:11:20Z", "commit": {"oid": "3bc24fc7c6f188fbb09a14702f20dc0743db3112"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3987, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}