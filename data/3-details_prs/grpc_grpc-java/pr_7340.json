{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMzg2MjI5", "number": 7340, "title": "xds: refactor LoadReportClient for supporting LRS v3", "bodyText": "", "createdAt": "2020-08-19T19:16:44Z", "url": "https://github.com/grpc/grpc-java/pull/7340", "merged": true, "mergeCommit": {"oid": "c67dcb3b0884520d105725cad491cb58169ce810"}, "closed": true, "closedAt": "2020-08-20T03:01:30Z", "author": {"login": "dapengzhang0"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAgospgH2gAyNDcwMzg2MjI5OjlkNmQxZDQyN2Q0YzM5ZDBiMGE1NGRjN2M4Y2NkOTVhZDQ0YmU2OTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAlX65gFqTQ3MTA1NjMwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9d6d1d427d4c39d0b0a54dc7c8ccd95ad44be696", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/9d6d1d427d4c39d0b0a54dc7c8ccd95ad44be696", "committedDate": "2020-08-19T19:18:39Z", "message": "xds: refactor LoadReportClient for supporting LRS v3"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9bc8918e025e895c1e9caf54174af3eabe4900da", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/9bc8918e025e895c1e9caf54174af3eabe4900da", "committedDate": "2020-08-19T19:14:02Z", "message": "xds: refactor LoadReportClient for supporting LRS v3"}, "afterCommit": {"oid": "9d6d1d427d4c39d0b0a54dc7c8ccd95ad44be696", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/9d6d1d427d4c39d0b0a54dc7c8ccd95ad44be696", "committedDate": "2020-08-19T19:18:39Z", "message": "xds: refactor LoadReportClient for supporting LRS v3"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwODAyNjk4", "url": "https://github.com/grpc/grpc-java/pull/7340#pullrequestreview-470802698", "createdAt": "2020-08-19T19:49:53Z", "commit": {"oid": "9d6d1d427d4c39d0b0a54dc7c8ccd95ad44be696"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxOTo0OTo1M1rOHDWsWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxOTo1OTo0NlrOHDXA0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI3OTU3OQ==", "bodyText": "Oops, forgot to change this last time. Thanks.\nnit: It is better to just take in a Stopwatch.", "url": "https://github.com/grpc/grpc-java/pull/7340#discussion_r473279579", "createdAt": "2020-08-19T19:49:53Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/LoadReportClient.java", "diffHunk": "@@ -77,29 +74,27 @@\n   LoadReportClient(\n       String targetName,\n       LoadStatsManager loadStatsManager,\n-      ManagedChannel channel,\n+      XdsChannel xdsChannel,\n       Node node,\n       SynchronizationContext syncContext,\n       ScheduledExecutorService scheduledExecutorService,\n       BackoffPolicy.Provider backoffPolicyProvider,\n       Supplier<Stopwatch> stopwatchSupplier) {\n     this.loadStatsManager = checkNotNull(loadStatsManager, \"loadStatsManager\");\n-    this.channel = checkNotNull(channel, \"channel\");\n+    this.xdsChannel = checkNotNull(xdsChannel, \"xdsChannel\");\n     this.syncContext = checkNotNull(syncContext, \"syncContext\");\n     this.timerService = checkNotNull(scheduledExecutorService, \"timeService\");\n     this.backoffPolicyProvider = checkNotNull(backoffPolicyProvider, \"backoffPolicyProvider\");\n-    this.stopwatchSupplier = checkNotNull(stopwatchSupplier, \"stopwatchSupplier\");\n+    checkNotNull(stopwatchSupplier, \"stopwatchSupplier\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d6d1d427d4c39d0b0a54dc7c8ccd95ad44be696"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI4MjMyNg==", "bodyText": "Looks this block of code doesn't need to be moved to here.", "url": "https://github.com/grpc/grpc-java/pull/7340#discussion_r473282326", "createdAt": "2020-08-19T19:54:58Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/LoadReportClient.java", "diffHunk": "@@ -163,50 +158,43 @@ public void run() {\n \n   private void startLrsRpc() {\n     checkState(lrsStream == null, \"previous lbStream has not been cleared yet\");\n-    LoadReportingServiceGrpc.LoadReportingServiceStub stub\n-        = LoadReportingServiceGrpc.newStub(channel);\n-    lrsStream = new LrsStream(stub, stopwatchSupplier.get());\n+    // TODO(zdapeng): implement LrsStreamV3 and instantiate lrsStream based on value of\n+    //  xdsChannel.useProtocolV3\n+    lrsStream = new LrsStreamV2();\n     retryStopwatch.reset().start();\n     lrsStream.start();\n   }\n \n-  private class LrsStream implements StreamObserver<LoadStatsResponse> {\n-\n-    final LoadReportingServiceGrpc.LoadReportingServiceStub stub;\n-    StreamObserver<LoadStatsRequest> lrsRequestWriter;\n+  private abstract class LrsStream {\n     boolean initialResponseReceived;\n     boolean closed;\n     long loadReportIntervalNano = -1;\n     boolean reportAllClusters;\n     List<String> clusterNames;  // clusters to report loads for, if not report all.\n     ScheduledHandle loadReportTimer;\n \n-    LrsStream(LoadReportingServiceGrpc.LoadReportingServiceStub stub, Stopwatch stopwatch) {\n-      this.stub = checkNotNull(stub, \"stub\");\n-    }\n+    abstract void start();\n \n-    void start() {\n-      lrsRequestWriter = stub.withWaitForReady().streamLoadStats(this);\n-      LoadStatsRequest initRequest =\n-          LoadStatsRequest.newBuilder()\n-              .setNode(node)\n-              .build();\n-      lrsRequestWriter.onNext(initRequest);\n-      logger.log(XdsLogLevel.DEBUG, \"Initial LRS request sent:\\n{0}\", initRequest);\n-    }\n+    abstract void sendLoadStatsRequest(LoadStatsRequestData request);\n \n-    @Override\n-    public void onNext(final LoadStatsResponse response) {\n+    abstract void sendError(Exception error);\n+\n+    final void onLoadStatsResponse(final LoadStatsResponseData response) {\n       syncContext.execute(new Runnable() {\n         @Override\n         public void run() {\n+          if (!initialResponseReceived) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d6d1d427d4c39d0b0a54dc7c8ccd95ad44be696"}, "originalPosition": 131}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI4NDEwMQ==", "bodyText": "You can just have this class implements StreamObserver<io.envoyproxy.envoy.service.load_stats.v2.LoadStatsResponse>", "url": "https://github.com/grpc/grpc-java/pull/7340#discussion_r473284101", "createdAt": "2020-08-19T19:58:26Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/LoadReportClient.java", "diffHunk": "@@ -340,4 +313,106 @@ private void cleanUp() {\n       }\n     }\n   }\n+\n+  private final class LrsStreamV2 extends LrsStream {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d6d1d427d4c39d0b0a54dc7c8ccd95ad44be696"}, "originalPosition": 238}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI4NDgxNg==", "bodyText": "You can just have this class LrsStreamV2 implement StreamObserver<io.envoyproxy.envoy.service.load_stats.v2.LoadStatsResponse>. (Same thing for XdsClientImpl last time, but I forgot to point it out).", "url": "https://github.com/grpc/grpc-java/pull/7340#discussion_r473284816", "createdAt": "2020-08-19T19:59:46Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/LoadReportClient.java", "diffHunk": "@@ -340,4 +313,106 @@ private void cleanUp() {\n       }\n     }\n   }\n+\n+  private final class LrsStreamV2 extends LrsStream {\n+    StreamObserver<io.envoyproxy.envoy.service.load_stats.v2.LoadStatsRequest> lrsRequestWriterV2;\n+\n+    @Override\n+    void start() {\n+      StreamObserver<io.envoyproxy.envoy.service.load_stats.v2.LoadStatsResponse>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d6d1d427d4c39d0b0a54dc7c8ccd95ad44be696"}, "originalPosition": 243}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83e3d1598441b6ae53b1564155ba2734e90224f5", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/83e3d1598441b6ae53b1564155ba2734e90224f5", "committedDate": "2020-08-19T20:40:44Z", "message": "fix logging proto"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwOTM1MTcx", "url": "https://github.com/grpc/grpc-java/pull/7340#pullrequestreview-470935171", "createdAt": "2020-08-19T20:50:56Z", "commit": {"oid": "83e3d1598441b6ae53b1564155ba2734e90224f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMDo1MDo1NlrOHDYmWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMDo1MDo1NlrOHDYmWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxMDgwOA==", "bodyText": "Why not put the other one together?", "url": "https://github.com/grpc/grpc-java/pull/7340#discussion_r473310808", "createdAt": "2020-08-19T20:50:56Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/LoadReportClient.java", "diffHunk": "@@ -245,6 +239,10 @@ private void handleResponse(LoadStatsResponseData response) {\n       if (closed) {\n         return;\n       }\n+      if (!initialResponseReceived) {\n+        logger.log(XdsLogLevel.DEBUG, \"Initial LRS response received\");\n+        initialResponseReceived = true;\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83e3d1598441b6ae53b1564155ba2734e90224f5"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df267d4a31ae2e77e1ab4f6d7a4c609aa84f36ac", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/df267d4a31ae2e77e1ab4f6d7a4c609aa84f36ac", "committedDate": "2020-08-20T00:40:07Z", "message": "rename onError() and onComplete()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad3c67bac63a598910267c80cb9f41c0ede48a79", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/ad3c67bac63a598910267c80cb9f41c0ede48a79", "committedDate": "2020-08-20T00:45:51Z", "message": "inline handleResponse"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDU2MzA3", "url": "https://github.com/grpc/grpc-java/pull/7340#pullrequestreview-471056307", "createdAt": "2020-08-20T00:49:51Z", "commit": {"oid": "ad3c67bac63a598910267c80cb9f41c0ede48a79"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4181, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}