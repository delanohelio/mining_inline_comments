{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3OTI0NjY5", "number": 6824, "title": "xds: implement XdsRoutingLoadBalancer", "bodyText": "", "createdAt": "2020-03-13T18:44:25Z", "url": "https://github.com/grpc/grpc-java/pull/6824", "merged": true, "mergeCommit": {"oid": "6a64951005af01617a2384f9464883d60e9006ae"}, "closed": true, "closedAt": "2020-03-23T21:42:45Z", "author": {"login": "dapengzhang0"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOm5Y_AH2gAyMzg3OTI0NjY5OmY3OGI5NzRkYjUyOWRlMmIyMTUxYTY5MDY2MWE4MmFkNDY3NTMyOGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQi8TzgFqTM3OTcyNTAyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f78b974db529de2b2151a690661a82ad4675328a", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/f78b974db529de2b2151a690661a82ad4675328a", "committedDate": "2020-03-17T18:20:06Z", "message": "xds: implement XdsRoutingLoadBalancer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fe9053db2f0bfc8c0895a206ed26c0bf1ec29363", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/fe9053db2f0bfc8c0895a206ed26c0bf1ec29363", "committedDate": "2020-03-13T18:42:08Z", "message": "xds: implement XdsRoutingLoadBalancer"}, "afterCommit": {"oid": "f78b974db529de2b2151a690661a82ad4675328a", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/f78b974db529de2b2151a690661a82ad4675328a", "committedDate": "2020-03-17T18:20:06Z", "message": "xds: implement XdsRoutingLoadBalancer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODY1MjYy", "url": "https://github.com/grpc/grpc-java/pull/6824#pullrequestreview-378865262", "createdAt": "2020-03-20T23:45:14Z", "commit": {"oid": "f78b974db529de2b2151a690661a82ad4675328a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMzo0NToxNFrOF5l6bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMzo0NToxNFrOF5l6bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNDMxOA==", "bodyText": "This is wrong. This in core/src/test/java/io/grpc/internal/TestUtils.java. It is an in-module utility class for grpc-core's unit test only. Not a test utility.", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r395934318", "createdAt": "2020-03-20T23:45:14Z", "author": {"login": "voidzcy"}, "path": "core/src/test/java/io/grpc/internal/TestUtils.java", "diffHunk": "@@ -36,7 +41,41 @@\n /**\n  * Common utility methods for tests.\n  */\n-final class TestUtils {\n+public final class TestUtils {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f78b974db529de2b2151a690661a82ad4675328a"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODY2ODMx", "url": "https://github.com/grpc/grpc-java/pull/6824#pullrequestreview-378866831", "createdAt": "2020-03-20T23:53:05Z", "commit": {"oid": "f78b974db529de2b2151a690661a82ad4675328a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMzo1MzowNVrOF5mALg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMzo1MzowNVrOF5mALg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNTc5MA==", "bodyText": "A fake LoadBalancerProvider is trivial to implement, although it might be a little verbose to always implement isAvailable(), getPriority(), etc in unit test. If your test case is just trying to verify the behavior of looking up the registry correctly, the real default registry suffices.", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r395935790", "createdAt": "2020-03-20T23:53:05Z", "author": {"login": "voidzcy"}, "path": "core/src/test/java/io/grpc/internal/TestUtils.java", "diffHunk": "@@ -36,7 +41,41 @@\n /**\n  * Common utility methods for tests.\n  */\n-final class TestUtils {\n+public final class TestUtils {\n+\n+  /** Base class for a standard LoadBalancerProvider implementation. */\n+  public abstract static class StandardLoadBalancerProvider extends LoadBalancerProvider {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f78b974db529de2b2151a690661a82ad4675328a"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODY5MTAx", "url": "https://github.com/grpc/grpc-java/pull/6824#pullrequestreview-378869101", "createdAt": "2020-03-21T00:04:53Z", "commit": {"oid": "f78b974db529de2b2151a690661a82ad4675328a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQwMDowNDo1M1rOF5mIZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQwMDoxMzozMFrOF5mOFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNzg5NQ==", "bodyText": "nit: keep our convention checkNotNull, although the instantiation is completely internal. Maybe it's always a good practice to check null in constructors for arguments that are saved as fields and to be used later.", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r395937895", "createdAt": "2020-03-21T00:04:53Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java", "diffHunk": "@@ -16,18 +16,209 @@\n \n package io.grpc.xds;\n \n+import static io.grpc.ConnectivityState.CONNECTING;\n+import static io.grpc.ConnectivityState.IDLE;\n+import static io.grpc.ConnectivityState.READY;\n+import static io.grpc.ConnectivityState.TRANSIENT_FAILURE;\n+import static io.grpc.xds.XdsSubchannelPickers.BUFFER_PICKER;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import io.grpc.ConnectivityState;\n+import io.grpc.InternalLogId;\n import io.grpc.LoadBalancer;\n+import io.grpc.MethodDescriptor;\n import io.grpc.Status;\n+import io.grpc.internal.ServiceConfigUtil.PolicySelection;\n+import io.grpc.util.ForwardingLoadBalancerHelper;\n+import io.grpc.util.GracefulSwitchLoadBalancer;\n+import io.grpc.xds.XdsLogger.XdsLogLevel;\n+import io.grpc.xds.XdsRoutingLoadBalancerProvider.MethodName;\n+import io.grpc.xds.XdsRoutingLoadBalancerProvider.Route;\n+import io.grpc.xds.XdsRoutingLoadBalancerProvider.XdsRoutingConfig;\n+import io.grpc.xds.XdsSubchannelPickers.ErrorPicker;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+import javax.annotation.Nullable;\n \n-// TODO(zdapeng): Implementation.\n /** Load balancer for xds_routing policy. */\n final class XdsRoutingLoadBalancer extends LoadBalancer {\n \n+  private final XdsLogger logger;\n+  private final Helper helper;\n+  private final Map<String, GracefulSwitchLoadBalancer> routeBalancers = new HashMap<>();\n+  private final Map<String, RouteHelper> routeHelpers = new HashMap<>();\n+\n+  private Map<String, PolicySelection> actions = ImmutableMap.of();\n+  private List<Route> routes = ImmutableList.of();\n+\n+  XdsRoutingLoadBalancer(Helper helper) {\n+    this.helper = helper;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f78b974db529de2b2151a690661a82ad4675328a"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzOTEyNA==", "bodyText": "Should this also shut down child balancers (if exist) as well?\nNote you shouldn't call handleNameResolutionError() API directly. You could have a helper method for error handling and have handleNameResolutionError() call it as well.", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r395939124", "createdAt": "2020-03-21T00:12:08Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java", "diffHunk": "@@ -16,18 +16,209 @@\n \n package io.grpc.xds;\n \n+import static io.grpc.ConnectivityState.CONNECTING;\n+import static io.grpc.ConnectivityState.IDLE;\n+import static io.grpc.ConnectivityState.READY;\n+import static io.grpc.ConnectivityState.TRANSIENT_FAILURE;\n+import static io.grpc.xds.XdsSubchannelPickers.BUFFER_PICKER;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import io.grpc.ConnectivityState;\n+import io.grpc.InternalLogId;\n import io.grpc.LoadBalancer;\n+import io.grpc.MethodDescriptor;\n import io.grpc.Status;\n+import io.grpc.internal.ServiceConfigUtil.PolicySelection;\n+import io.grpc.util.ForwardingLoadBalancerHelper;\n+import io.grpc.util.GracefulSwitchLoadBalancer;\n+import io.grpc.xds.XdsLogger.XdsLogLevel;\n+import io.grpc.xds.XdsRoutingLoadBalancerProvider.MethodName;\n+import io.grpc.xds.XdsRoutingLoadBalancerProvider.Route;\n+import io.grpc.xds.XdsRoutingLoadBalancerProvider.XdsRoutingConfig;\n+import io.grpc.xds.XdsSubchannelPickers.ErrorPicker;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+import javax.annotation.Nullable;\n \n-// TODO(zdapeng): Implementation.\n /** Load balancer for xds_routing policy. */\n final class XdsRoutingLoadBalancer extends LoadBalancer {\n \n+  private final XdsLogger logger;\n+  private final Helper helper;\n+  private final Map<String, GracefulSwitchLoadBalancer> routeBalancers = new HashMap<>();\n+  private final Map<String, RouteHelper> routeHelpers = new HashMap<>();\n+\n+  private Map<String, PolicySelection> actions = ImmutableMap.of();\n+  private List<Route> routes = ImmutableList.of();\n+\n+  XdsRoutingLoadBalancer(Helper helper) {\n+    this.helper = helper;\n+    logger = XdsLogger.withLogId(\n+        InternalLogId.allocate(\"xds-routing-lb\", helper.getAuthority()));\n+    logger.log(XdsLogLevel.INFO, \"Created\");\n+  }\n+\n+  @Override\n+  public void handleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n+    logger.log(XdsLogLevel.DEBUG, \"Received resolution result: {0}\", resolvedAddresses);\n+    XdsRoutingConfig xdsRoutingConfig =\n+        (XdsRoutingConfig) resolvedAddresses.getLoadBalancingPolicyConfig();\n+    if (xdsRoutingConfig == null) {\n+      helper.updateBalancingState(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f78b974db529de2b2151a690661a82ad4675328a"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzOTM1MQ==", "bodyText": "It's a test utility for grpc-core's unit tests, not for other modules. Look at its file path. It's in the test sourceSet of grpc-core. It is intentionally package private.", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r395939351", "createdAt": "2020-03-21T00:13:30Z", "author": {"login": "voidzcy"}, "path": "core/src/test/java/io/grpc/internal/TestUtils.java", "diffHunk": "@@ -36,7 +41,41 @@\n /**\n  * Common utility methods for tests.\n  */\n-final class TestUtils {\n+public final class TestUtils {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNDMxOA=="}, "originalCommit": {"oid": "f78b974db529de2b2151a690661a82ad4675328a"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d8fc2e6d603eb2c36966b5382f09991e2509c90", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/2d8fc2e6d603eb2c36966b5382f09991e2509c90", "committedDate": "2020-03-23T16:02:50Z", "message": "check not null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb23aa0dddd477c7fcec8cfbd0f40fb450fa8e68", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/eb23aa0dddd477c7fcec8cfbd0f40fb450fa8e68", "committedDate": "2020-03-23T18:30:31Z", "message": "checkNotNull for resolved lb config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b761d94e965315a57cbb114001688df5488e966", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/2b761d94e965315a57cbb114001688df5488e966", "committedDate": "2020-03-23T18:46:45Z", "message": "minor grammar fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NzI1MDI5", "url": "https://github.com/grpc/grpc-java/pull/6824#pullrequestreview-379725029", "createdAt": "2020-03-23T18:51:31Z", "commit": {"oid": "2b761d94e965315a57cbb114001688df5488e966"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4649, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}