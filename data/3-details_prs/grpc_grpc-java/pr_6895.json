{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3ODEyNjk3", "number": 6895, "title": "xds: use separate LB configs for EDS policy running with different code paths", "bodyText": "In the latest design, the LB config for EDS policy started to diverge for the full xDS flow and for EDS only flow (internal. legacy?).\nThis changes separates the usage of LB configs for these two code paths:\nFor full xDS flow (received from CDS LB policy):\nclass EdsConfig {\n    final String clusterName;  // required\n    final String edsServiceName;  // optional\n    final String lrsServerName;  // optional\n    final PolicySelection endpointPickingPolicy;  // required\n}\nFor EDS only flow (received from remote resolver):\nclass XdsConfig {\n    final String edsServiceName;  // optional\n    final String lrsServerName;  // optional\n    final PolicySelection childPolicy;  // required, parser defaults to round_robin\n    final PolicySelection fallbackPolicy;  // required, parser defaults to round_robin\n}\nSince the EDS only flow (XdsLoadBalancer) also delegates load balancing logic to EdsLoadBalancer, it converts XdsConfig to EdsConfig by setting clusterName field to target authority.\n\nThis PR only cleans up LB config(s) (types) for EDS policy, no behavior-wise change.\nThis PR replaces #6887, which tries to do more cleanup (e.g., refactor FallbackLb, move logic of creating XdsClient object into XdsLoadBalancer) but failed to do so without rewriting the whole set of tests.", "createdAt": "2020-04-02T21:19:53Z", "url": "https://github.com/grpc/grpc-java/pull/6895", "merged": true, "mergeCommit": {"oid": "2478912d794e0b35c73210de1c9686c762a3bf28"}, "closed": true, "closedAt": "2020-04-15T20:12:02Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTyaIFAH2gAyMzk3ODEyNjk3OjUzNzU0NzIwOTY0N2I3ZjVjOGYzOTRjOWU2NzRjNGMyZDMyYTQ4Nzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcX9DpcAH2gAyMzk3ODEyNjk3OjBlZGIxMGJjZTZkY2NkNGMzOTFiMmQyZjI5NjMxMDQ2ZjJkZWIzYTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "537547209647b7f5c8f394c9e674c4c2d32a4879", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/537547209647b7f5c8f394c9e674c4c2d32a4879", "committedDate": "2020-04-02T20:34:26Z", "message": "Define EdsConfig for full LDS flow use case."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "417cb67bc77c5352b0aa89739545f4edc8e33235", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/417cb67bc77c5352b0aa89739545f4edc8e33235", "committedDate": "2020-04-02T20:35:44Z", "message": "EdsLoadBalancer will always receive EdsConfig rather than XdsConfig."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8322951695660069661d8a7bfddb3ef99d3d2028", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/8322951695660069661d8a7bfddb3ef99d3d2028", "committedDate": "2020-04-02T20:37:33Z", "message": "Change to generate EdsConfig in CdsLoadBalancer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0639fddc92d32e08d29e42db3f16cc8b0158318", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/a0639fddc92d32e08d29e42db3f16cc8b0158318", "committedDate": "2020-04-02T20:40:03Z", "message": "Modified XdsConfig definition to match that in internal proto definition. Changed its usage in XdsLoadBalancer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b4d5d43d95f35c8be82db3f3bdb4f45b3d23359", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/5b4d5d43d95f35c8be82db3f3bdb4f45b3d23359", "committedDate": "2020-04-02T20:40:51Z", "message": "Modified usage of XdsConfig in FallbackLb."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e890c201b858b6b02d917cffa884d8659dd5356", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/5e890c201b858b6b02d917cffa884d8659dd5356", "committedDate": "2020-04-14T19:39:38Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into refactor/use_separate_lb_config_for_full_flow_and_eds_only"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNDgwNTMy", "url": "https://github.com/grpc/grpc-java/pull/6895#pullrequestreview-393480532", "createdAt": "2020-04-15T06:12:39Z", "commit": {"oid": "5e890c201b858b6b02d917cffa884d8659dd5356"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwNjoxMjo0MFrOGFrISA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwNjozOTo0OFrOGFrvWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYwMjY5Ng==", "bodyText": "endpointPickingPolicy is not null", "url": "https://github.com/grpc/grpc-java/pull/6895#discussion_r408602696", "createdAt": "2020-04-15T06:12:40Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java", "diffHunk": "@@ -108,27 +108,26 @@\n   public void handleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n     logger.log(XdsLogLevel.DEBUG, \"Received resolution result: {0}\", resolvedAddresses);\n     Object lbConfig = resolvedAddresses.getLoadBalancingPolicyConfig();\n-    if (lbConfig == null) {\n-      edsLbHelper.updateBalancingState(\n-          TRANSIENT_FAILURE,\n-          new ErrorPicker(Status.UNAVAILABLE.withDescription(\"Missing EDS lb config\")));\n-      return;\n-    }\n-    XdsConfig newXdsConfig = (XdsConfig) lbConfig;\n+    checkNotNull(lbConfig, \"missing EDS lb config\");\n+    EdsConfig newEdsConfig = (EdsConfig) lbConfig;\n     if (logger.isLoggable(XdsLogLevel.INFO)) {\n       logger.log(\n           XdsLogLevel.INFO,\n-          \"Received EDS lb config: cluster={0}, child_policy={1}, fallback_policy={2}, \"\n-              + \"eds_service_name={3}, report_load={4}\",\n-          newXdsConfig.cluster,\n-          newXdsConfig.endpointPickingPolicy != null\n-              ? newXdsConfig.endpointPickingPolicy.getProvider().getPolicyName() : \"\",\n-          newXdsConfig.fallbackPolicy != null\n-              ? newXdsConfig.fallbackPolicy.getProvider().getPolicyName() : \"\",\n-          newXdsConfig.edsServiceName,\n-          newXdsConfig.lrsServerName != null);\n+          \"Received EDS lb config: cluster={0}, child_policy={1}, \"\n+              + \"eds_service_name={2}, report_load={3}\",\n+          newEdsConfig.clusterName,\n+          newEdsConfig.endpointPickingPolicy != null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e890c201b858b6b02d917cffa884d8659dd5356"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYxMDEyMw==", "bodyText": "nit: This field is only used in one place, and can be inlined with helper.getAuthority() there. No need to check nullness of  helper's authority.", "url": "https://github.com/grpc/grpc-java/pull/6895#discussion_r408610123", "createdAt": "2020-04-15T06:33:05Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/XdsLoadBalancer.java", "diffHunk": "@@ -91,7 +96,8 @@ public void onAllDrop() {\n       Helper helper,\n       PrimaryLbFactory primaryLbFactory,\n       LoadBalancer.Factory fallbackLbFactory) {\n-    this.helper = helper;\n+    this.helper = checkNotNull(helper, \"helper\");\n+    authority = checkNotNull(helper.getAuthority(), \"authority\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e890c201b858b6b02d917cffa884d8659dd5356"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYxMjY5Nw==", "bodyText": "Why change this behavior? If childPolicyConfigs  is not empty but does not include any registered policy, it should use round robin instead of return a ConfigOrError.", "url": "https://github.com/grpc/grpc-java/pull/6895#discussion_r408612697", "createdAt": "2020-04-15T06:39:48Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/XdsLoadBalancerProvider.java", "diffHunk": "@@ -77,32 +77,24 @@ public ConfigOrError parseLoadBalancingPolicyConfig(\n   static ConfigOrError parseLoadBalancingConfigPolicy(\n       Map<String, ?> rawLoadBalancingPolicyConfig, LoadBalancerRegistry registry) {\n     try {\n-      String cluster = JsonUtil.getString(rawLoadBalancingPolicyConfig, \"cluster\");\n-\n       LbConfig roundRobinConfig = new LbConfig(\"round_robin\", ImmutableMap.<String, Object>of());\n-      List<LbConfig> endpointPickingConfigs = ServiceConfigUtil.unwrapLoadBalancingConfigList(\n-          JsonUtil.getListOfObjects(rawLoadBalancingPolicyConfig, \"endpointPickingPolicy\"));\n-      if (endpointPickingConfigs == null) {\n-        endpointPickingConfigs = new ArrayList<>(1);\n-      } else {\n-        endpointPickingConfigs = new ArrayList<>(endpointPickingConfigs);\n+      List<LbConfig> childPolicyConfigs = ServiceConfigUtil.unwrapLoadBalancingConfigList(\n+          JsonUtil.getListOfObjects(rawLoadBalancingPolicyConfig, \"childPolicy\"));\n+      if (childPolicyConfigs == null || childPolicyConfigs.isEmpty()) {\n+        childPolicyConfigs = Collections.singletonList(roundRobinConfig);\n       }\n-      endpointPickingConfigs.add(roundRobinConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e890c201b858b6b02d917cffa884d8659dd5356"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MDIyNTMx", "url": "https://github.com/grpc/grpc-java/pull/6895#pullrequestreview-394022531", "createdAt": "2020-04-15T18:19:54Z", "commit": {"oid": "5e890c201b858b6b02d917cffa884d8659dd5356"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94f95392f01d5ef93e9d75db563b453befad1394", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/94f95392f01d5ef93e9d75db563b453befad1394", "committedDate": "2020-04-15T19:14:11Z", "message": "Removed unnecessary null branch for field that is never null."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0edb10bce6dccd4c391b2d2f29631046f2deb3a4", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/0edb10bce6dccd4c391b2d2f29631046f2deb3a4", "committedDate": "2020-04-15T19:14:32Z", "message": "Styling issue."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4507, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}