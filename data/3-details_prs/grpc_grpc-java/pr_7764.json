{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2MjE1NDQy", "number": 7764, "title": "xds: decouple xds channel creation and bootstrapping", "bodyText": "Fixes #7752.\nThe singleton XdsClient ObjectPool is cached for the entire process. The bootstrap file is read at the time this ObjectPool is created. The shared XdsClient instance has a much shorter lifecycle than the ObjectPool as the instance is only created upon the first call of getObject() and is destroyed when its reference count reaches zero. The ObjectPool creates a new XdsClient instance after the previous one was destroyed.\nThe ownership and lifecycle of the xDS channel is wrong. Currently the singleton XdsClient ObjectPool owns the xDS channel and it uses the same xDS channel even when recreating a new XdsClient instance. However, the channel would have been shutdown by the XdsClient.\nIn this change:\n\nReading the bootstrap will determine and create the ChannelCredentials for each specified xDS server. An exception will be thrown if any xDS server specifies some channel_creds type that is not supported, not just for the first server (which is the only one to be used now).\nReading the bootstrap also determines the xDS protocol version.\nThe xDS channel will have the same lifecycle as the XdsClient instance: an xDS channel is created at the first call of getObject() and is shut down at the same time as the XdsClient is shutting down.\n\n\nMain changes are in Bootstrapper.java and SharedXdsClientPoolProvider.java (and XdsClientWrapperForServerSds.java for server side XdsClient creation).\n/cc @sanjaypujare", "createdAt": "2020-12-28T19:46:08Z", "url": "https://github.com/grpc/grpc-java/pull/7764", "merged": true, "mergeCommit": {"oid": "cddc1a500c8f5d51b1f691d4017ebbfa634c0e8b"}, "closed": true, "closedAt": "2020-12-29T02:39:15Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdqrMyCAH2gAyNTQ2MjE1NDQyOmUyNTU0ODYyOTM4ZDlkOGE3ODE3NmE1YzU1NjljODNjY2FlNWQ3YzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdqwxUZAFqTU1OTM1MjQyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e2554862938d9d8a78176a5c5569c83ccae5d7c0", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/e2554862938d9d8a78176a5c5569c83ccae5d7c0", "committedDate": "2020-12-28T19:21:56Z", "message": "Select channel credentials for xDS servers during bootstrap."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d39f8884b44cd06126d997e87ddcd5b8c8242cb", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/2d39f8884b44cd06126d997e87ddcd5b8c8242cb", "committedDate": "2020-12-28T19:25:16Z", "message": "Eliminate XdsChannel, pass plain ManagedChannel and useProtocolV3 as arguements for XdsClient creations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "069f5234a4b13bfd5f9ef70c855f2864f14fe997", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/069f5234a4b13bfd5f9ef70c855f2864f14fe997", "committedDate": "2020-12-28T19:26:18Z", "message": "Fix usages of BootstrapInfo."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65cedd5e874135f49cc2a84c14be32692ef6d776", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/65cedd5e874135f49cc2a84c14be32692ef6d776", "committedDate": "2020-12-28T19:27:07Z", "message": "Decouple bootstrapping and xDS channel creation. Fix the lifecycle issue of xDS channel."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MzM1Mzc2", "url": "https://github.com/grpc/grpc-java/pull/7764#pullrequestreview-559335376", "createdAt": "2020-12-28T23:46:21Z", "commit": {"oid": "65cedd5e874135f49cc2a84c14be32692ef6d776"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQyMzo0NjoyMVrOIMEDjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQyMzo0NjoyMVrOIMEDjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUyMDI3MQ==", "bodyText": "It can be shutdown more gracefully with shutdown(). As long as all xdsClients cancel their streams in xdsClient.shutdown(), the channel can be terminated.", "url": "https://github.com/grpc/grpc-java/pull/7764#discussion_r549520271", "createdAt": "2020-12-28T23:46:21Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/SharedXdsClientPoolProvider.java", "diffHunk": "@@ -121,26 +134,27 @@ public XdsClient returnObject(Object object) {\n         if (refCount == 0) {\n           xdsClient.shutdown();\n           xdsClient = null;\n+          channel.shutdownNow();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65cedd5e874135f49cc2a84c14be32692ef6d776"}, "originalPosition": 119}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bc0b8a6d0c59c6eb7ff0adbd126987009466e5c", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/7bc0b8a6d0c59c6eb7ff0adbd126987009466e5c", "committedDate": "2020-12-29T01:29:03Z", "message": "Use shutdown() for XdsClient shutdown."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d80d7a00d269ebce7972599195b3dfcd6afd7549", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/d80d7a00d269ebce7972599195b3dfcd6afd7549", "committedDate": "2020-12-29T01:34:02Z", "message": "Avoid leaking channel between tests."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1c0cf7937e13e7803b935232415ae44688209e9c", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/1c0cf7937e13e7803b935232415ae44688209e9c", "committedDate": "2020-12-29T01:33:34Z", "message": "Avoid leaking channel between tests."}, "afterCommit": {"oid": "d80d7a00d269ebce7972599195b3dfcd6afd7549", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/d80d7a00d269ebce7972599195b3dfcd6afd7549", "committedDate": "2020-12-29T01:34:02Z", "message": "Avoid leaking channel between tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MzUyNDI4", "url": "https://github.com/grpc/grpc-java/pull/7764#pullrequestreview-559352428", "createdAt": "2020-12-29T01:51:22Z", "commit": {"oid": "d80d7a00d269ebce7972599195b3dfcd6afd7549"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4702, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}