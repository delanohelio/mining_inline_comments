{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5Njc0MjUy", "number": 6586, "title": "xds: add support for static and combined validation context and enhanced loggging", "bodyText": "", "createdAt": "2020-01-06T19:16:13Z", "url": "https://github.com/grpc/grpc-java/pull/6586", "merged": true, "mergeCommit": {"oid": "6517ac8a617c9d0ee6d1f87f4c36aafca049b5a4"}, "closed": true, "closedAt": "2020-01-09T00:41:17Z", "author": {"login": "sanjaypujare"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3xFwcAH2gAyMzU5Njc0MjUyOmIxYjU2ODU0ZjgwMmNiODg2OGUzODNmNjQ3OWFlZTllYWM5ZTk2ODc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4ewjCAFqTM0MDIyODE5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b1b56854f802cb8868e383f6479aee9eac9e9687", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/b1b56854f802cb8868e383f6479aee9eac9e9687", "committedDate": "2020-01-06T19:12:24Z", "message": "xds: add support for static and combined validation context and enhanced\nloggging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTI2OTMy", "url": "https://github.com/grpc/grpc-java/pull/6586#pullrequestreview-338926932", "createdAt": "2020-01-06T22:10:52Z", "commit": {"oid": "b1b56854f802cb8868e383f6479aee9eac9e9687"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMjoxMDo1MlrOFaqvEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMjoxOToyNlrOFaq68w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwNzQ3NA==", "bodyText": "why not throw exception? returning actual exception seems wrong. also the for loop seems unnecessary if size is fixed.", "url": "https://github.com/grpc/grpc-java/pull/6586#discussion_r363507474", "createdAt": "2020-01-06T22:10:52Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/sds/SdsClient.java", "diffHunk": "@@ -333,42 +338,34 @@ public void run() {\n     }\n   }\n \n-  private boolean processSecretsFromDiscoveryResponse(DiscoveryResponse response) {\n+  private Throwable processSecretsFromDiscoveryResponse(DiscoveryResponse response) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1b56854f802cb8868e383f6479aee9eac9e9687"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwOTM3MA==", "bodyText": "this is not consist with other code (eg L78 in new code). also L110", "url": "https://github.com/grpc/grpc-java/pull/6586#discussion_r363509370", "createdAt": "2020-01-06T22:16:16Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/sds/SdsSslContextProvider.java", "diffHunk": "@@ -97,9 +100,23 @@ private SdsSslContextProvider(\n       Executor channelExecutor) {\n     checkNotNull(upstreamTlsContext, \"upstreamTlsContext\");\n     CommonTlsContext commonTlsContext = upstreamTlsContext.getCommonTlsContext();\n-    SdsSecretConfig validationContextSdsConfig =\n-        commonTlsContext.getValidationContextSdsSecretConfig();\n-\n+    SdsSecretConfig validationContextSdsConfig = null;\n+    CertificateValidationContext staticCertValidationContext = null;\n+    if (commonTlsContext.hasCombinedValidationContext()) {\n+      CommonTlsContext.CombinedCertificateValidationContext combinedValidationContext\n+          = commonTlsContext.getCombinedValidationContext();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1b56854f802cb8868e383f6479aee9eac9e9687"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwOTk1Ng==", "bodyText": "nit: should be in 2 lines with comment about what it is for.", "url": "https://github.com/grpc/grpc-java/pull/6586#discussion_r363509956", "createdAt": "2020-01-06T22:17:55Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/sds/SdsSslContextProvider.java", "diffHunk": "@@ -135,7 +153,7 @@ private SdsSslContextProvider(\n         node,\n         certSdsConfig,\n         validationContextSdsConfig,\n-        watcherExecutor,\n+        null, watcherExecutor,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1b56854f802cb8868e383f6479aee9eac9e9687"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUxMDExNA==", "bodyText": "should be 1line. also should be indented 4 spaces (i can see this other lines e.g. L224)", "url": "https://github.com/grpc/grpc-java/pull/6586#discussion_r363510114", "createdAt": "2020-01-06T22:18:20Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/sds/SdsSslContextProvider.java", "diffHunk": "@@ -197,21 +220,27 @@ public synchronized void onSecretChanged(Secret secretUpdate) {\n   private void updateSslContext() {\n     try {\n       SslContextBuilder sslContextBuilder;\n+      CertificateValidationContext localCertValidationContext =\n+              mergeStaticAndDynamicCertContexts();\n       if (server) {\n+        logger.log(\n+                Level.FINEST, \"for server\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1b56854f802cb8868e383f6479aee9eac9e9687"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUxMDE5NQ==", "bodyText": "same here.", "url": "https://github.com/grpc/grpc-java/pull/6586#discussion_r363510195", "createdAt": "2020-01-06T22:18:31Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/sds/SdsSslContextProvider.java", "diffHunk": "@@ -197,21 +220,27 @@ public synchronized void onSecretChanged(Secret secretUpdate) {\n   private void updateSslContext() {\n     try {\n       SslContextBuilder sslContextBuilder;\n+      CertificateValidationContext localCertValidationContext =\n+              mergeStaticAndDynamicCertContexts();\n       if (server) {\n+        logger.log(\n+                Level.FINEST, \"for server\");\n         sslContextBuilder =\n             GrpcSslContexts.forServer(\n                 tlsCertificate.getCertificateChain().getInlineBytes().newInput(),\n                 tlsCertificate.getPrivateKey().getInlineBytes().newInput(),\n                 tlsCertificate.hasPassword()\n                     ? tlsCertificate.getPassword().getInlineString()\n                     : null);\n-        if (certificateValidationContext != null) {\n-          sslContextBuilder.trustManager(new SdsTrustManagerFactory(certificateValidationContext));\n+        if (localCertValidationContext != null) {\n+          sslContextBuilder.trustManager(new SdsTrustManagerFactory(localCertValidationContext));\n         }\n       } else {\n+        logger.log(\n+                Level.FINEST, \"for client\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1b56854f802cb8868e383f6479aee9eac9e9687"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUxMDUxNQ==", "bodyText": "those can be called a lot. can you use string interpolation (and probably elsewhere to save resource)? or better, remove those while converting other logging for FINE(ST)?\nbecause, this can be achieved by adding netty LoggingHandler.", "url": "https://github.com/grpc/grpc-java/pull/6586#discussion_r363510515", "createdAt": "2020-01-06T22:19:26Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/sds/internal/SdsProtocolNegotiators.java", "diffHunk": "@@ -150,23 +154,32 @@ public void close() {}\n \n     @Override\n     public void channelRead(ChannelHandlerContext ctx, Object msg) {\n+      logger.finest(\"ctx.name=\" + ctx.name() + \", msg=\" + msg);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1b56854f802cb8868e383f6479aee9eac9e9687"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2320bafecf7554e0c2945595474c372b43fab9bb", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/2320bafecf7554e0c2945595474c372b43fab9bb", "committedDate": "2020-01-08T18:32:43Z", "message": "address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ee2242ce5defdf4b1d3025235206f490dfd0e27", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/8ee2242ce5defdf4b1d3025235206f490dfd0e27", "committedDate": "2020-01-09T00:01:39Z", "message": "test code format fix and logger with parameters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a5be5db8a9721f056402a8a90e70b087298be40", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/1a5be5db8a9721f056402a8a90e70b087298be40", "committedDate": "2020-01-09T00:11:21Z", "message": "another minor reformat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04ee41cbd7d607863081d8f437d846da1a4e9257", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/04ee41cbd7d607863081d8f437d846da1a4e9257", "committedDate": "2020-01-09T00:22:20Z", "message": "another left over format issue fixed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMjI4MTkz", "url": "https://github.com/grpc/grpc-java/pull/6586#pullrequestreview-340228193", "createdAt": "2020-01-09T00:24:52Z", "commit": {"oid": "04ee41cbd7d607863081d8f437d846da1a4e9257"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4792, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}