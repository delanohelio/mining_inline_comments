{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwNjc5Mzcx", "number": 7686, "title": "alts: Limit number of concurrent handshakes to 32", "bodyText": "CC @susinmotion", "createdAt": "2020-12-02T01:32:29Z", "url": "https://github.com/grpc/grpc-java/pull/7686", "merged": true, "mergeCommit": {"oid": "814e36b54136fca39d86549c6c501ec49319bd0d"}, "closed": true, "closedAt": "2020-12-03T21:51:51Z", "author": {"login": "ejona86"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiESGXgH2gAyNTMwNjc5MzcxOmM1ZWYyN2JjNThhYWNjNmQzZGJlYmQ3MDliYWM4OWY0ODc5NDEyNmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiqHKnAFqTU0NDQ2NzQ1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c5ef27bc58aacc6d3dbebd709bac89f48794126b", "author": {"user": {"login": "ejona86", "name": "Eric Anderson"}}, "url": "https://github.com/grpc/grpc-java/commit/c5ef27bc58aacc6d3dbebd709bac89f48794126b", "committedDate": "2020-12-02T01:30:03Z", "message": "alts: Limit number of concurrent handshakes to 32"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMDY1NzEz", "url": "https://github.com/grpc/grpc-java/pull/7686#pullrequestreview-543065713", "createdAt": "2020-12-02T17:20:50Z", "commit": {"oid": "c5ef27bc58aacc6d3dbebd709bac89f48794126b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNzoyMDo1MFrOH9lyng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNzoyMDo1MFrOH9lyng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM0NDM1MA==", "bodyText": "Just curious, why we want to flush here?", "url": "https://github.com/grpc/grpc-java/pull/7686#discussion_r534344350", "createdAt": "2020-12-02T17:20:50Z", "author": {"login": "jiangtaoli2016"}, "path": "alts/src/main/java/io/grpc/alts/internal/TsiHandshakeHandler.java", "diffHunk": "@@ -137,13 +146,37 @@ protected void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) t\n   }\n \n   @Override\n-  public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {\n+  public void userEventTriggered(final ChannelHandlerContext ctx, Object evt) throws Exception {\n     if (evt instanceof ProtocolNegotiationEvent) {\n       checkState(pne == null, \"negotiation already started\");\n       pne = (ProtocolNegotiationEvent) evt;\n       InternalProtocolNegotiators.negotiationLogger(ctx)\n           .log(ChannelLogLevel.INFO, \"TsiHandshake started\");\n-      sendHandshake(ctx);\n+      ChannelFuture acquire = semaphore.acquire(ctx);\n+      if (acquire.isSuccess()) {\n+        semaphoreAcquired = true;\n+        sendHandshake(ctx);\n+      } else {\n+        acquire.addListener(new ChannelFutureListener() {\n+          @Override public void operationComplete(ChannelFuture future) {\n+            if (!future.isSuccess()) {\n+              ctx.fireExceptionCaught(future.cause());\n+              return;\n+            }\n+            if (ctx.isRemoved()) {\n+              semaphore.release();\n+              return;\n+            }\n+            semaphoreAcquired = true;\n+            try {\n+              sendHandshake(ctx);\n+            } catch (Exception ex) {\n+              ctx.fireExceptionCaught(ex);\n+            }\n+            ctx.flush();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5ef27bc58aacc6d3dbebd709bac89f48794126b"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MjI4NDc4", "url": "https://github.com/grpc/grpc-java/pull/7686#pullrequestreview-544228478", "createdAt": "2020-12-03T17:56:34Z", "commit": {"oid": "c5ef27bc58aacc6d3dbebd709bac89f48794126b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNzo1NjozNVrOH-ppjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNzo1NjozNVrOH-ppjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ1NjE0MQ==", "bodyText": "Drive by comment: I'd suggest removing the \"b/****\" in the comment. :)", "url": "https://github.com/grpc/grpc-java/pull/7686#discussion_r535456141", "createdAt": "2020-12-03T17:56:35Z", "author": {"login": "matthewstevenson88"}, "path": "alts/src/main/java/io/grpc/alts/internal/TsiHandshakeHandler.java", "diffHunk": "@@ -78,12 +82,17 @@ public abstract SecurityDetails validatePeerObject(Object peerObject)\n   }\n \n   private static final int HANDSHAKE_FRAME_SIZE = 1024;\n+  // Avoid performing too many handshakes in parallel, as it may cause queuing in the handshake\n+  // server and cause unbounded blocking on the event loop (b/168808426). This is a workaround until", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5ef27bc58aacc6d3dbebd709bac89f48794126b"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MjU0NzE3", "url": "https://github.com/grpc/grpc-java/pull/7686#pullrequestreview-544254717", "createdAt": "2020-12-03T18:26:13Z", "commit": {"oid": "c5ef27bc58aacc6d3dbebd709bac89f48794126b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxODoyNjoxNFrOH-rBcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxODoyNjoxNFrOH-rBcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3ODY0MQ==", "bodyText": "Question, which of the following can be assumed if tsiHandshakeHandler.userEventTriggered() is called multiple times?\n\nThe argument ChannelHandlerContext ctx can be different instances.\nThe argument evt of ProtocolNegotiationEvent type can be different instances for a fixed ctx argument.", "url": "https://github.com/grpc/grpc-java/pull/7686#discussion_r535478641", "createdAt": "2020-12-03T18:26:14Z", "author": {"login": "dapengzhang0"}, "path": "alts/src/main/java/io/grpc/alts/internal/TsiHandshakeHandler.java", "diffHunk": "@@ -137,13 +146,37 @@ protected void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) t\n   }\n \n   @Override\n-  public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {\n+  public void userEventTriggered(final ChannelHandlerContext ctx, Object evt) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5ef27bc58aacc6d3dbebd709bac89f48794126b"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NDY3NDU0", "url": "https://github.com/grpc/grpc-java/pull/7686#pullrequestreview-544467454", "createdAt": "2020-12-03T21:34:30Z", "commit": {"oid": "c5ef27bc58aacc6d3dbebd709bac89f48794126b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4732, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}