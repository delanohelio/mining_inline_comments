{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MjQ4MzQz", "number": 6654, "title": "xds: print xDS responses nicely with protobuf JsonFormat", "bodyText": "", "createdAt": "2020-01-28T21:50:12Z", "url": "https://github.com/grpc/grpc-java/pull/6654", "merged": true, "mergeCommit": {"oid": "4ad3acb8f2f7b4bbe02c0a1c8b2b7eb4eb6e23ee"}, "closed": true, "closedAt": "2020-01-29T17:58:48Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-4hgfgH2gAyMzY4MjQ4MzQzOjMwZTMwNzcwNmY4YzEwYjdlNWNlMmY1OGFhZTZiY2Q3OTA3MWYyNDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_CGLbgH2gAyMzY4MjQ4MzQzOjg4MzRhNWUzYzA3MWE1NGY3NGViMjlkNWU3MzAyZDBhZmMzNmUyMzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "30e307706f8c10b7e5ce2f58aae6bcd79071f240", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/30e307706f8c10b7e5ce2f58aae6bcd79071f240", "committedDate": "2020-01-28T21:49:31Z", "message": "Print xDS responses nicely with protobuf JsonFormat."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NzkyOTU3", "url": "https://github.com/grpc/grpc-java/pull/6654#pullrequestreview-349792957", "createdAt": "2020-01-29T00:15:19Z", "commit": {"oid": "30e307706f8c10b7e5ce2f58aae6bcd79071f240"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMDoxNToyMFrOFi5AtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMDoxNToyMFrOFi5AtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEyOTk3Mw==", "bodyText": "This language will be a bit confusing in the logs. Maybe something closer to: message + \" (failed to pretty-print: \" + e + \")\"", "url": "https://github.com/grpc/grpc-java/pull/6654#discussion_r372129973", "createdAt": "2020-01-29T00:15:20Z", "author": {"login": "ejona86"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -1360,4 +1364,37 @@ static boolean matchHostName(String hostName, String pattern) {\n     return index == pattern.length() - 1\n         && hostName.startsWith(pattern.substring(0, pattern.length() - 1));\n   }\n+\n+  /**\n+   * Convert protobuf message to human readable String format. Useful for protobuf messages\n+   * containing {@link com.google.protobuf.Any} fields.\n+   */\n+  @VisibleForTesting\n+  static class MessagePrinter {\n+    private final JsonFormat.Printer printer;\n+\n+    @VisibleForTesting\n+    MessagePrinter() {\n+      com.google.protobuf.TypeRegistry registry =\n+          com.google.protobuf.TypeRegistry.newBuilder()\n+              .add(Listener.getDescriptor())\n+              .add(HttpConnectionManager.getDescriptor())\n+              .add(RouteConfiguration.getDescriptor())\n+              .add(Cluster.getDescriptor())\n+              .add(ClusterLoadAssignment.getDescriptor())\n+              .build();\n+      printer = JsonFormat.printer().usingTypeRegistry(registry);\n+    }\n+\n+    @VisibleForTesting\n+    String print(MessageOrBuilder message) {\n+      String res;\n+      try {\n+        res = printer.print(message);\n+      } catch (InvalidProtocolBufferException e) {\n+        res = \"Failed to convert message [\" + message + \"] to readable String. Reason: \" + e;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30e307706f8c10b7e5ce2f58aae6bcd79071f240"}, "originalPosition": 86}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2205850ff8e6fc714959c0f67300853f1379d3de", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/2205850ff8e6fc714959c0f67300853f1379d3de", "committedDate": "2020-01-29T00:23:01Z", "message": "Rephrase error message for conversion failure."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODQyOTgw", "url": "https://github.com/grpc/grpc-java/pull/6654#pullrequestreview-349842980", "createdAt": "2020-01-29T03:25:29Z", "commit": {"oid": "2205850ff8e6fc714959c0f67300853f1379d3de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMzoyNToyOVrOFi7oCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMzoyNToyOVrOFi7oCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE3MjgxMA==", "bodyText": "Because respPrinter.print() is heavy, check isLoggable first. Otherwise LGTM.\nif (logger.isLoggable(Level.FINE)) {\n  logger.log(Level.FINE, \"Received an RDS response: {0}\", respPrinter.print(rdsResponse));\n}", "url": "https://github.com/grpc/grpc-java/pull/6654#discussion_r372172810", "createdAt": "2020-01-29T03:25:29Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -569,7 +573,7 @@ private void handleLdsResponse(DiscoveryResponse ldsResponse) {\n    * invalid data for gRPC's usage. Otherwise, an ACK request is sent to management server.\n    */\n   private void handleRdsResponse(DiscoveryResponse rdsResponse) {\n-    logger.log(Level.FINE, \"Received an RDS response: {0}\", rdsResponse);\n+    logger.log(Level.FINE, \"Received an RDS response: {0}\", respPrinter.print(rdsResponse));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2205850ff8e6fc714959c0f67300853f1379d3de"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8834a5e3c071a54f74eb29d5e7302d0afc36e238", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/8834a5e3c071a54f74eb29d5e7302d0afc36e238", "committedDate": "2020-01-29T08:58:43Z", "message": "Only log response messages when log level is FINE."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4686, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}