{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNzcwMzY2", "number": 7523, "title": "xds: simplify XdsClient APIs to start load reporting automatically when the first stats is added ", "bodyText": "Currently there are two load reporting related APIs on the XdsClient interface: addClientStats() and reportClientStats(). The former is for creating/getting the stats object for a cluster and the latter is to start load reporting RPC. This is a bit cumbersome as the two are always called together: the stats object is retrieved to record loads to be reported to the management server. In the context of sharing XdsClient between channels, all LB policy facing APIs need be thread-safe. It is unnecessarily cumbersome to make each of these two APIs thread-safe given that they are always used together.\nThis change is to combine the functionality of the two APIs (plus the corresponding removeClientStats() and cancelClientStatsReport()):\nAfter the change, the API would be very close to what C-core is doing (except we do not (have not) separated stats objects into cluster_drop_stats and locality_stats). See C-core's implementation.\n\naddClientStats(...): create or get the stats object for the given cluster, starts load reporting if it has not (The LoadReportClient takes existing stats from LoadStatsManager by itself. Remember which clusters to report loads is driven by the management server).\nremoveClientStats(...): discard (or decrease the ref count) the stats object for the given cluster. An optional TODO is to terminate load reporting when the last stats object is removed. It needs some sort of bookkeeping to know the call of this method removes the last stats object. But anyway, there is no harm to not terminate the load reporting RPC until the XdsClient is shut down. (In C-core, terminating load reporting when the last stats object is removed is not implemented either).\n\nThere are some relevant changes:\n\nCreate the LoadReportClient instance (but not started) at the same time the XdsClient instance is created. So they have the same lifecycle, we do not need to worry about its lifecycle with respect to addClientStats(...)/removeClientStats(...) APIs.", "createdAt": "2020-10-15T03:08:45Z", "url": "https://github.com/grpc/grpc-java/pull/7523", "merged": true, "mergeCommit": {"oid": "0b6f29371bd96614fdbdcd3638d4bb6312258da3"}, "closed": true, "closedAt": "2020-10-16T01:13:58Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSo26LgH2gAyNTAzNzcwMzY2OjBmMjY3ZTA4M2YzYzIwMzNhNWRjNzE2N2IyMzZhMmE5N2YyMTM3ZTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdS7iHWAFqTUwOTk0MjQ1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0f267e083f3c2033a5dc7167b236a2a97f2137e9", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/0f267e083f3c2033a5dc7167b236a2a97f2137e9", "committedDate": "2020-10-15T03:04:03Z", "message": "Only one stopwatch is needed for the LoadReportClient."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08d90d2736fdd77953044f3a72ab9174a2223507", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/08d90d2736fdd77953044f3a72ab9174a2223507", "committedDate": "2020-10-15T03:04:50Z", "message": "Eliminate reportClientStats/cancelClientStatsReport APIs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "204186c5d432f400b56ce17024c483327e5efa09", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/204186c5d432f400b56ce17024c483327e5efa09", "committedDate": "2020-10-15T03:06:07Z", "message": "Start load reporting internally in XdsClient in the first call of addClusterStats."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5ODY5OTY2", "url": "https://github.com/grpc/grpc-java/pull/7523#pullrequestreview-509869966", "createdAt": "2020-10-15T23:11:30Z", "commit": {"oid": "204186c5d432f400b56ce17024c483327e5efa09"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMzoxMTozMFrOHiel3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMzoxMTozMFrOHiel3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkxNDg0Ng==", "bodyText": "The purpose of using a supplier is to let this class own and solely manage the state of the stopwatch. Passing in a stopwatch instance in the constructor does not prevent the stopwatch instance from being shared and reset() outside this class from API perspective. You either call supplier.get() inside or outside the constructor, but I think the original version of constructor can not be misused.", "url": "https://github.com/grpc/grpc-java/pull/7523#discussion_r505914846", "createdAt": "2020-10-15T23:11:30Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/LoadReportClient.java", "diffHunk": "@@ -77,13 +76,13 @@\n       SynchronizationContext syncContext,\n       ScheduledExecutorService scheduledExecutorService,\n       BackoffPolicy.Provider backoffPolicyProvider,\n-      Supplier<Stopwatch> stopwatchSupplier) {\n+      Stopwatch stopwatch) {\n     this.loadStatsManager = checkNotNull(loadStatsManager, \"loadStatsManager\");\n     this.xdsChannel = checkNotNull(xdsChannel, \"xdsChannel\");\n     this.syncContext = checkNotNull(syncContext, \"syncContext\");\n     this.timerService = checkNotNull(scheduledExecutorService, \"timeService\");\n     this.backoffPolicyProvider = checkNotNull(backoffPolicyProvider, \"backoffPolicyProvider\");\n-    this.retryStopwatch = checkNotNull(stopwatchSupplier, \"stopwatchSupplier\").get();\n+    this.stopwatch = checkNotNull(stopwatch, \"stopwatch\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "204186c5d432f400b56ce17024c483327e5efa09"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69044b7c3945ba3349e67f7fb63906829cca73f2", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/69044b7c3945ba3349e67f7fb63906829cca73f2", "committedDate": "2020-10-15T23:48:21Z", "message": "Change back to pass a stopwatch supplier into LoadReportClient."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5OTQyNDU1", "url": "https://github.com/grpc/grpc-java/pull/7523#pullrequestreview-509942455", "createdAt": "2020-10-16T00:49:32Z", "commit": {"oid": "69044b7c3945ba3349e67f7fb63906829cca73f2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3915, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}