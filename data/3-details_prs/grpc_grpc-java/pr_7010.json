{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzODA2Mjk3", "number": 7010, "title": "xds: replace deprecated fields for Upstream and Downstream TlsContext", "bodyText": "", "createdAt": "2020-05-05T23:42:44Z", "url": "https://github.com/grpc/grpc-java/pull/7010", "merged": true, "mergeCommit": {"oid": "67cc3172f1ccbdf54bda4e4d9080a1d5e0792e17"}, "closed": true, "closedAt": "2020-05-07T23:01:05Z", "author": {"login": "sanjaypujare"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceeJT-AH2gAyNDEzODA2Mjk3OjAwOWFlODBhMTM0MTlmZmY1MGFiMmUxMTM1NWFiYWZlNDk0ZGNhYTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfCXr8gFqTQwNzc2ODE2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "009ae80a13419fff50ab2e11355abafe494dcaa3", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/009ae80a13419fff50ab2e11355abafe494dcaa3", "committedDate": "2020-05-06T01:11:08Z", "message": "xds: remove deprecated fields for Upstream and Downstream TlsContext"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9563cf8f6cbc1476906c0b44055707f8d38e7e8c", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/9563cf8f6cbc1476906c0b44055707f8d38e7e8c", "committedDate": "2020-05-05T23:40:22Z", "message": "xds: remove deprecated fields for Upstream and Downstream TlsContext"}, "afterCommit": {"oid": "009ae80a13419fff50ab2e11355abafe494dcaa3", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/009ae80a13419fff50ab2e11355abafe494dcaa3", "committedDate": "2020-05-06T01:11:08Z", "message": "xds: remove deprecated fields for Upstream and Downstream TlsContext"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2OTAwODAz", "url": "https://github.com/grpc/grpc-java/pull/7010#pullrequestreview-406900803", "createdAt": "2020-05-06T18:58:24Z", "commit": {"oid": "009ae80a13419fff50ab2e11355abafe494dcaa3"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxODo1ODoyNVrOGRhGOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxOTowODowN1rOGRhchg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyMTI0MA==", "bodyText": "isInitialized is always true for proto3 since it checks mandatory fields are set or not. this need to be fixed.\nalso, can upstreamTlsContext be null?", "url": "https://github.com/grpc/grpc-java/pull/7010#discussion_r421021240", "createdAt": "2020-05-06T18:58:25Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -1051,8 +1061,14 @@ private void handleCdsResponse(DiscoveryResponse cdsResponse) {\n         }\n         updateBuilder.setLrsServerName(\"\");\n       }\n-      if (cluster.hasTlsContext()) {\n-        updateBuilder.setUpstreamTlsContext(cluster.getTlsContext());\n+      try {\n+        UpstreamTlsContext upstreamTlsContext = getTlsContextFromCluster(cluster);\n+        if (upstreamTlsContext != null && upstreamTlsContext.isInitialized()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "009ae80a13419fff50ab2e11355abafe494dcaa3"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyMjQ1Nw==", "bodyText": "this always pass or it won't execute this line. i think you should check size of filterChains", "url": "https://github.com/grpc/grpc-java/pull/7010#discussion_r421022457", "createdAt": "2020-05-06T19:00:28Z", "author": {"login": "creamsoup"}, "path": "xds/src/test/java/io/grpc/xds/EnvoyServerProtoDataTest.java", "diffHunk": "@@ -93,6 +95,37 @@ public void listener_convertFromListenerProto() {\n     assertThat(tlsCertSdsConfigs.get(0).getName()).isEqualTo(\"google-sds-config-default\");\n   }\n \n+  // TODO(sanjaypujare): remove when we move to envoy protos v3\n+  @Test\n+  public void listener_convertFromDeprecatedListenerProto() throws InvalidProtocolBufferException {\n+    io.envoyproxy.envoy.api.v2.core.Address address =\n+        io.envoyproxy.envoy.api.v2.core.Address.newBuilder()\n+            .setSocketAddress(SocketAddress.newBuilder()\n+                .setPortValue(8000)\n+                .setAddress(\"10.2.1.34\")\n+                .build())\n+            .build();\n+    io.envoyproxy.envoy.api.v2.Listener listener =\n+        io.envoyproxy.envoy.api.v2.Listener.newBuilder()\n+            .setName(\"8000\")\n+            .setAddress(address)\n+            .addFilterChains(createDeprecatedInFilter())\n+            .build();\n+    Listener xdsListener = Listener.fromEnvoyProtoListener(listener);\n+    List<EnvoyServerProtoData.FilterChain> filterChains = xdsListener.getFilterChains();\n+    EnvoyServerProtoData.FilterChain inFilter = filterChains.get(0);\n+    assertThat(inFilter).isNotNull();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "009ae80a13419fff50ab2e11355abafe494dcaa3"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyNjk1MA==", "bodyText": "nit: && should be in front\nif (condition\n    && another_condition) {\n  ...\n}", "url": "https://github.com/grpc/grpc-java/pull/7010#discussion_r421026950", "createdAt": "2020-05-06T19:08:07Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/EnvoyServerProtoData.java", "diffHunk": "@@ -173,13 +176,26 @@ public String toString() {\n     }\n \n     static FilterChain fromEnvoyProtoFilterChain(\n-        io.envoyproxy.envoy.api.v2.listener.FilterChain proto) {\n+        io.envoyproxy.envoy.api.v2.listener.FilterChain proto)\n+        throws InvalidProtocolBufferException {\n       return new FilterChain(\n           FilterChainMatch.fromEnvoyProtoFilterChainMatch(proto.getFilterChainMatch()),\n-          proto.getTlsContext()\n+          getTlsContextFromFilterChain(proto)\n       );\n     }\n \n+    private static DownstreamTlsContext getTlsContextFromFilterChain(\n+        io.envoyproxy.envoy.api.v2.listener.FilterChain filterChain)\n+        throws InvalidProtocolBufferException {\n+      if (filterChain.hasTransportSocket() && \"tls\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "009ae80a13419fff50ab2e11355abafe494dcaa3"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9157439509ce079c9f855f25d1eb2bd547d1a9f2", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/9157439509ce079c9f855f25d1eb2bd547d1a9f2", "committedDate": "2020-05-07T06:05:29Z", "message": "xds: address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NjU1NjIx", "url": "https://github.com/grpc/grpc-java/pull/7010#pullrequestreview-407655621", "createdAt": "2020-05-07T16:49:03Z", "commit": {"oid": "9157439509ce079c9f855f25d1eb2bd547d1a9f2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NjgxMDc0", "url": "https://github.com/grpc/grpc-java/pull/7010#pullrequestreview-407681074", "createdAt": "2020-05-07T17:22:57Z", "commit": {"oid": "9157439509ce079c9f855f25d1eb2bd547d1a9f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNzoyMjo1N1rOGSInKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNzoyMjo1N1rOGSInKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY2ODY1MQ==", "bodyText": "The ACK should be sent before the information is used.", "url": "https://github.com/grpc/grpc-java/pull/7010#discussion_r421668651", "createdAt": "2020-05-07T17:22:57Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -708,22 +710,30 @@ private void handleLdsResponseForListener(DiscoveryResponse ldsResponse) {\n           ldsResponse.getVersionInfo(), \"Malformed LDS response: \" + e);\n       return;\n     }\n-    adsStream.sendAckRequest(ADS_TYPE_URL_LDS, ImmutableList.<String>of(),\n-        ldsResponse.getVersionInfo());\n     if (requestedListener != null) {\n       if (ldsRespTimer != null) {\n         ldsRespTimer.cancel();\n         ldsRespTimer = null;\n       }\n-      ListenerUpdate listenerUpdate = ListenerUpdate.newBuilder()\n-          .setListener(EnvoyServerProtoData.Listener.fromEnvoyProtoListener(requestedListener))\n-          .build();\n-      listenerWatcher.onListenerChanged(listenerUpdate);\n+      try {\n+        ListenerUpdate listenerUpdate = ListenerUpdate.newBuilder()\n+            .setListener(EnvoyServerProtoData.Listener.fromEnvoyProtoListener(requestedListener))\n+            .build();\n+        listenerWatcher.onListenerChanged(listenerUpdate);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9157439509ce079c9f855f25d1eb2bd547d1a9f2"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec1a36aed1290fb3a8c42da42d19eae4606ebe3e", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/ec1a36aed1290fb3a8c42da42d19eae4606ebe3e", "committedDate": "2020-05-07T18:27:17Z", "message": "xds: send ACK before calling listenerUpdate"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NzY4MTY5", "url": "https://github.com/grpc/grpc-java/pull/7010#pullrequestreview-407768169", "createdAt": "2020-05-07T19:23:25Z", "commit": {"oid": "ec1a36aed1290fb3a8c42da42d19eae4606ebe3e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4388, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}