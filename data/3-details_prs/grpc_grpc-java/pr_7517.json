{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyNzUzMzc0", "number": 7517, "title": "xds: implement xDS circuit breaking max_requests", "bodyText": "", "createdAt": "2020-10-13T19:44:04Z", "url": "https://github.com/grpc/grpc-java/pull/7517", "merged": true, "mergeCommit": {"oid": "47d1488373106c159ae6c863a9d046a0732f8ae0"}, "closed": true, "closedAt": "2020-11-02T22:24:23Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSN5HAgH2gAyNTAyNzUzMzc0OjE2ZjMwZTcwNjQ2MGQwZGU1Y2RiNzA0MzY3MWFhNTFkMzljYmYxNmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYqp8vgH2gAyNTAyNzUzMzc0OmI5Y2M0MTcwYjg1YzE0ZDg4NzhlYzI5OGMzYjI1Yjk5MWRkYjU0YzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "16f30e706460d0de5cdb7043671aa51d39cbf16f", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/16f30e706460d0de5cdb7043671aa51d39cbf16f", "committedDate": "2020-10-13T19:39:01Z", "message": "Add a new API on stats object for recording uncategorized drops."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2212e169deee12c9f27c696b184ab03215b64f03", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/2212e169deee12c9f27c696b184ab03215b64f03", "committedDate": "2020-10-13T19:39:40Z", "message": "Add field maxConcurrentRequets in CdsUpdate."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4533b881abb8b5b9619a10ead78c00f31f73a205", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/4533b881abb8b5b9619a10ead78c00f31f73a205", "committedDate": "2020-10-13T19:40:16Z", "message": "Add maxConcurrentRequests field in the EDS LB config."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60168b204e51e2c6c5e952b46870beeb7282909f", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/60168b204e51e2c6c5e952b46870beeb7282909f", "committedDate": "2020-10-13T19:43:15Z", "message": "Retrieve circuit breaker info from CDS responses."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff89007ea47ec5c6ac2332f496f46325b988ba87", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/ff89007ea47ec5c6ac2332f496f46325b988ba87", "committedDate": "2020-10-13T19:43:23Z", "message": "Generate EDS LB config with max_concurrent_requests in CDS LB policy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d59edce44de41f6691131d8bdd2fb8c8cdb5334", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/8d59edce44de41f6691131d8bdd2fb8c8cdb5334", "committedDate": "2020-10-13T19:43:23Z", "message": "Implement and test circuit breaking max_concurrent_requests feature in the EDS lb policy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17c8707dabd87b4797f93ec126becf0a912f558d", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/17c8707dabd87b4797f93ec126becf0a912f558d", "committedDate": "2020-10-13T20:27:35Z", "message": "Fix typo."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2efcbe05d732c408a031da77fec853f662a741a", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/d2efcbe05d732c408a031da77fec853f662a741a", "committedDate": "2020-10-23T17:48:03Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/xds_circuit_breaking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MDM5MDAw", "url": "https://github.com/grpc/grpc-java/pull/7517#pullrequestreview-517039000", "createdAt": "2020-10-26T17:56:54Z", "commit": {"oid": "d2efcbe05d732c408a031da77fec853f662a741a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNzo1Njo1NFrOHobyZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNzo1Njo1NFrOHobyZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE2MDM1OQ==", "bodyText": "If result is a buffering result, should we drop the request immediately as well?", "url": "https://github.com/grpc/grpc-java/pull/7517#discussion_r512160359", "createdAt": "2020-10-26T17:56:54Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer2.java", "diffHunk": "@@ -398,7 +393,97 @@ protected Helper delegate() {\n         private void updateDropPolicies(List<DropOverload> dropOverloads) {\n           dropPolicies = dropOverloads;\n         }\n+\n+        private void updateMaxConcurrentRequests(long maxConcurrentRequests) {\n+          this.maxConcurrentRequests = maxConcurrentRequests;\n+        }\n+\n+        private final class RequestLimitingSubchannelPicker extends SubchannelPicker {\n+          private final SubchannelPicker delegate;\n+          private final List<DropOverload> dropPolicies;\n+          private final long maxConcurrentRequests;\n+\n+          private RequestLimitingSubchannelPicker(SubchannelPicker delegate,\n+              List<DropOverload> dropPolicies, long maxConcurrentRequests) {\n+            this.delegate = delegate;\n+            this.dropPolicies = dropPolicies;\n+            this.maxConcurrentRequests = maxConcurrentRequests;\n+          }\n+\n+          @Override\n+          public PickResult pickSubchannel(PickSubchannelArgs args) {\n+            for (DropOverload dropOverload : dropPolicies) {\n+              int rand = random.nextInt(1_000_000);\n+              if (rand < dropOverload.getDropsPerMillion()) {\n+                logger.log(XdsLogLevel.INFO, \"Drop request with category: {0}\",\n+                    dropOverload.getCategory());\n+                if (loadStatsStore != null) {\n+                  loadStatsStore.recordDroppedRequest(dropOverload.getCategory());\n+                }\n+                return PickResult.withDrop(\n+                    Status.UNAVAILABLE.withDescription(\"Dropped: \" + dropOverload.getCategory()));\n+              }\n+            }\n+            PickResult result = delegate.pickSubchannel(args);\n+            if (result.getStatus().isOk() && result.getSubchannel() != null) {\n+              if (requestCount.get() >= maxConcurrentRequests) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2efcbe05d732c408a031da77fec853f662a741a"}, "originalPosition": 159}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da8b7c2049ff2497bbc7a3a76c1bc40aa5ff2d2d", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/da8b7c2049ff2497bbc7a3a76c1bc40aa5ff2d2d", "committedDate": "2020-10-29T00:04:38Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/xds_circuit_breaking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6895129cdfdb741d036efacb6572d0e6f529fd77", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/6895129cdfdb741d036efacb6572d0e6f529fd77", "committedDate": "2020-10-29T01:04:54Z", "message": "Sync with updated XdsClient implementation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0974ec31a1511ecaed49f4eef4b4e57b099eb06f", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/0974ec31a1511ecaed49f4eef4b4e57b099eb06f", "committedDate": "2020-10-30T00:23:05Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/xds_circuit_breaking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxODY4MTMy", "url": "https://github.com/grpc/grpc-java/pull/7517#pullrequestreview-521868132", "createdAt": "2020-11-02T17:55:09Z", "commit": {"oid": "0974ec31a1511ecaed49f4eef4b4e57b099eb06f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a877e529eac795b8dd46a54dd9e6e3ae74411ba2", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/a877e529eac795b8dd46a54dd9e6e3ae74411ba2", "committedDate": "2020-11-02T20:27:46Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/xds_circuit_breaking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9cc4170b85c14d8878ec298c3b25b991ddb54c6", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/b9cc4170b85c14d8878ec298c3b25b991ddb54c6", "committedDate": "2020-11-02T20:33:15Z", "message": "Remove unncessary (and incorrect) number masking."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4099, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}