{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MDQxMzc2", "number": 6737, "title": "xds: update LRS protocol and fix usage of cluster name in ClusterStats", "bodyText": "Major changes in this PR:\n\n\nAdded cluster field for cluster name in EDS LB config (i.e., XdsConfig). CDS policy will set it to the cluster name it receives from CDS responses.\n\nCurrently, cluster is optional since the resolver in prod tests does not have it. So for EDS-only, it will be set to the hostname (including port) for creating the gRPC channel.\n\n\n\nXdsClient will give edsServiceName exactly as it receives in CDS responses to CDS policy. That is, edsServiceName in ClusterUpdate can be null. LRS loads are grouped by each cluster:edsService, their values should match what is given in CDS responses exactly.\n\n\nUpdated LRS protocol. The Node sent in LRS requests use a special metadata PROXYLESS_CLIENT_HOSTNAME with value being the hostname (including port) for creating the gRPC channel. Management server is able to infer clusters that the gRPC client potentially sends load to. LRS initial request does not need to populate clusters it wants to report load for.", "createdAt": "2020-02-21T00:13:09Z", "url": "https://github.com/grpc/grpc-java/pull/6737", "merged": true, "mergeCommit": {"oid": "a98db126e265259ea73c2156833cbf872aa86811"}, "closed": true, "closedAt": "2020-02-21T23:32:28Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGRZxlAH2gAyMzc4MDQxMzc2OjFlMjg2ODRiNjI4YTIyNjlmNGQxNmYwZGEzYTEyNzJkNjI5OGRmZWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGoCAGgH2gAyMzc4MDQxMzc2OjlkYzEzZTg5ZWJjOTY2OTZiNTRjNGFjMGZmN2EyMmE3Mzk3MzUyOTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1e28684b628a2269f4d16f0da3a1272d6298dfee", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/1e28684b628a2269f4d16f0da3a1272d6298dfee", "committedDate": "2020-02-20T20:46:10Z", "message": "Add cluster name field in EDS LB config. Temporarily make it optional (it should be required)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c13271cfdc99f1439d147d8fd2ff1d143fe2de20", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/c13271cfdc99f1439d147d8fd2ff1d143fe2de20", "committedDate": "2020-02-20T20:47:57Z", "message": "Let XdsClient return an CdsUpdate that contains exactly what an CDS response contains. That is, if edsServiceName field is unset, leave it null."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7b6d6f0d8f378777215850fd4db5707fb6a403a", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/d7b6d6f0d8f378777215850fd4db5707fb6a403a", "committedDate": "2020-02-21T00:04:43Z", "message": "Change LoadReportClient for correct implementation of LRS protocol."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzM4NjYx", "url": "https://github.com/grpc/grpc-java/pull/6737#pullrequestreview-362338661", "createdAt": "2020-02-21T00:53:59Z", "commit": {"oid": "d7b6d6f0d8f378777215850fd4db5707fb6a403a"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwMDo1Mzo1OVrOFsoV8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODoyMTozOVrOFtAOMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM0MjY0Mg==", "bodyText": "cluster =, childPolicy = to be consistent. childPolicy not needed because it has a meaningful type.", "url": "https://github.com/grpc/grpc-java/pull/6737#discussion_r382342642", "createdAt": "2020-02-21T00:53:59Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/CdsLoadBalancer.java", "diffHunk": "@@ -280,11 +280,14 @@ public void onClusterChanged(ClusterUpdate newUpdate) {\n           newUpdate.getLbPolicy().equals(\"round_robin\"),\n           \"The load balancing policy in ClusterUpdate '%s' is not supported\", newUpdate);\n \n-      final XdsConfig edsConfig = new XdsConfig(\n-          new LbConfig(newUpdate.getLbPolicy(), ImmutableMap.<String, Object>of()),\n-          /* fallbackPolicy = */ null,\n-          /* edsServiceName = */ newUpdate.getEdsServiceName(),\n-          /* lrsServerName = */ newUpdate.getLrsServerName());\n+      final XdsConfig edsConfig =\n+          new XdsConfig(\n+              /* cluster */newUpdate.getClusterName(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7b6d6f0d8f378777215850fd4db5707fb6a403a"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1MDc5OQ==", "bodyText": "Did you forget to change EdsLoadBalancer.shutdown() back?", "url": "https://github.com/grpc/grpc-java/pull/6737#discussion_r382350799", "createdAt": "2020-02-21T01:24:04Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java", "diffHunk": "@@ -303,8 +298,12 @@ public boolean canHandleEmptyAddressListFromNameResolution() {\n \n       @Override\n       public void shutdown() {\n+        if (isReportingLoad) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7b6d6f0d8f378777215850fd4db5707fb6a403a"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1MzYyMQ==", "bodyText": "You can use %s placeholder and varargs to avoid stringcat.", "url": "https://github.com/grpc/grpc-java/pull/6737#discussion_r382353621", "createdAt": "2020-02-21T01:34:36Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/LoadReportClient.java", "diffHunk": "@@ -132,37 +143,35 @@ public void stopLoadReporting() {\n    * Provides this LoadReportClient source of load stats data for the given\n    * cluster:cluster_service. If requested, data from the given loadStatsStore is\n    * periodically queried and sent to traffic director by this LoadReportClient.\n-   *\n-   * <p>Currently we expect load stats data for all clusters to report loads for are provided\n-   * before load reporting starts (so that LRS initial request tells management server clusters\n-   * it is reporting loads for). Design TBD for reporting loads for extra clusters after load\n-   * reporting has started.\n-   *\n-   * <p>Note: currently clusterServiceName is always unset.\n    */\n-  public void addLoadStatsStore(\n+  void addLoadStatsStore(\n       String clusterName, @Nullable String clusterServiceName, LoadStatsStore loadStatsStore) {\n     checkState(\n-        !loadStatsStoreMap.containsKey(clusterName),\n-        \"load stats for cluster \" + clusterName + \" already exists\");\n-    // FIXME(chengyuanzhang): relax this restriction after design is fleshed out.\n-    checkState(\n-        !started,\n-        \"load stats for all clusters to report loads for should be provided before \"\n-            + \"load reporting has started\");\n-    loadStatsStoreMap.put(clusterName, loadStatsStore);\n+        !loadStatsStoreMap.containsKey(clusterName)\n+            || !loadStatsStoreMap.get(clusterName).containsKey(clusterServiceName),\n+        \"load stats for cluster: \" + clusterName + \", cluster service: \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7b6d6f0d8f378777215850fd4db5707fb6a403a"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1NDY5Ng==", "bodyText": "Ditto.", "url": "https://github.com/grpc/grpc-java/pull/6737#discussion_r382354696", "createdAt": "2020-02-21T01:38:59Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/LoadReportClient.java", "diffHunk": "@@ -132,37 +143,35 @@ public void stopLoadReporting() {\n    * Provides this LoadReportClient source of load stats data for the given\n    * cluster:cluster_service. If requested, data from the given loadStatsStore is\n    * periodically queried and sent to traffic director by this LoadReportClient.\n-   *\n-   * <p>Currently we expect load stats data for all clusters to report loads for are provided\n-   * before load reporting starts (so that LRS initial request tells management server clusters\n-   * it is reporting loads for). Design TBD for reporting loads for extra clusters after load\n-   * reporting has started.\n-   *\n-   * <p>Note: currently clusterServiceName is always unset.\n    */\n-  public void addLoadStatsStore(\n+  void addLoadStatsStore(\n       String clusterName, @Nullable String clusterServiceName, LoadStatsStore loadStatsStore) {\n     checkState(\n-        !loadStatsStoreMap.containsKey(clusterName),\n-        \"load stats for cluster \" + clusterName + \" already exists\");\n-    // FIXME(chengyuanzhang): relax this restriction after design is fleshed out.\n-    checkState(\n-        !started,\n-        \"load stats for all clusters to report loads for should be provided before \"\n-            + \"load reporting has started\");\n-    loadStatsStoreMap.put(clusterName, loadStatsStore);\n+        !loadStatsStoreMap.containsKey(clusterName)\n+            || !loadStatsStoreMap.get(clusterName).containsKey(clusterServiceName),\n+        \"load stats for cluster: \" + clusterName + \", cluster service: \"\n+            + clusterServiceName + \" already exists\");\n+    if (!loadStatsStoreMap.containsKey(clusterName)) {\n+      loadStatsStoreMap.put(clusterName, new HashMap<String, LoadStatsStore>());\n+    }\n+    Map<String, LoadStatsStore> clusterLoadStatsStores = loadStatsStoreMap.get(clusterName);\n+    clusterLoadStatsStores.put(clusterServiceName, loadStatsStore);\n   }\n \n   /**\n    * Stops providing load stats data for the given cluster:cluster_service.\n-   *\n-   * <p>Note: currently clusterServiceName is always unset.\n    */\n-  public void removeLoadStatsStore(String clusterName, @Nullable String clusterServiceName) {\n+  void removeLoadStatsStore(String clusterName, @Nullable String clusterServiceName) {\n     checkState(\n-        loadStatsStoreMap.containsKey(clusterName),\n-        \"load stats for cluster \" + clusterName + \" does not exist\");\n-    loadStatsStoreMap.remove(clusterName);\n+        loadStatsStoreMap.containsKey(clusterName)\n+            && loadStatsStoreMap.get(clusterName).containsKey(clusterServiceName),\n+        \"load stats for cluster: \" + clusterName + \", cluster service: \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7b6d6f0d8f378777215850fd4db5707fb6a403a"}, "originalPosition": 140}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1NTM4MA==", "bodyText": "This is redundant.", "url": "https://github.com/grpc/grpc-java/pull/6737#discussion_r382355380", "createdAt": "2020-02-21T01:41:55Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/LoadReportClient.java", "diffHunk": "@@ -80,19 +81,29 @@\n   private LoadReportCallback callback;\n \n   LoadReportClient(\n+      String targetName,\n       ManagedChannel channel,\n       Node node,\n       SynchronizationContext syncContext,\n       ScheduledExecutorService scheduledExecutorService,\n       BackoffPolicy.Provider backoffPolicyProvider,\n       Supplier<Stopwatch> stopwatchSupplier) {\n     this.channel = checkNotNull(channel, \"channel\");\n-    this.node = checkNotNull(node, \"node\");\n     this.syncContext = checkNotNull(syncContext, \"syncContext\");\n     this.timerService = checkNotNull(scheduledExecutorService, \"timeService\");\n     this.backoffPolicyProvider = checkNotNull(backoffPolicyProvider, \"backoffPolicyProvider\");\n     this.stopwatchSupplier = checkNotNull(stopwatchSupplier, \"stopwatchSupplier\");\n     this.retryStopwatch = stopwatchSupplier.get();\n+    checkNotNull(targetName, \"targetName\");\n+    checkNotNull(node, \"node\");\n+    this.node =\n+        node.toBuilder()\n+            .setMetadata(\n+                Struct.newBuilder()\n+                    .putFields(\n+                        TARGET_NAME_METADATA_KEY,\n+                        Value.newBuilder().setStringValue(targetName).build()))\n+            .build();\n     started = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7b6d6f0d8f378777215850fd4db5707fb6a403a"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczMzg3Mg==", "bodyText": "Can you change  \"edsServiceName1\" in this test to null? The clusterLoadAssignment then is expected to use CLUSTER_NAME. That is what is happening in real case.", "url": "https://github.com/grpc/grpc-java/pull/6737#discussion_r382733872", "createdAt": "2020-02-21T18:21:39Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/test/java/io/grpc/xds/EdsLoadBalancerTest.java", "diffHunk": "@@ -519,7 +525,7 @@ public PickResult pickSubchannel(PickSubchannelArgs args) {\n \n   @Test\n   public void handleLocalityAssignmentUpdates_pickersUpdatedFromChildBalancer() {\n-    deliverResolvedAddresses(new XdsConfig(null, null, \"edsServiceName1\", null));\n+    deliverResolvedAddresses(new XdsConfig(CLUSTER_NAME, null, null, \"edsServiceName1\", null));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7b6d6f0d8f378777215850fd4db5707fb6a403a"}, "originalPosition": 101}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c83e0f57d0e8fdf70897c7cf4f98750378eaeef", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/0c83e0f57d0e8fdf70897c7cf4f98750378eaeef", "committedDate": "2020-02-21T19:30:41Z", "message": "Fix style issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc4a26754e34fdc12036a92fea67a16d33efd103", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/dc4a26754e34fdc12036a92fea67a16d33efd103", "committedDate": "2020-02-21T19:41:13Z", "message": "Use null edsServiceName for tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "675e2c36e1bf8ccca1ba25bdb0edce779857f328", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/675e2c36e1bf8ccca1ba25bdb0edce779857f328", "committedDate": "2020-02-21T19:46:27Z", "message": "Clean up code in EdsLoadBalancer.shutdown."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTA5MDUy", "url": "https://github.com/grpc/grpc-java/pull/6737#pullrequestreview-362909052", "createdAt": "2020-02-21T20:51:27Z", "commit": {"oid": "675e2c36e1bf8ccca1ba25bdb0edce779857f328"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05ad799f8a53c5a99741267380ab07e90c5d9a29", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/05ad799f8a53c5a99741267380ab07e90c5d9a29", "committedDate": "2020-02-21T22:51:52Z", "message": "Node in LRS requests should preserve other metadata from bootstrap."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dc13e89ebc96696b54c4ac0ff7a22a739735295", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/9dc13e89ebc96696b54c4ac0ff7a22a739735295", "committedDate": "2020-02-21T23:08:01Z", "message": "Add test to ensure existing metadata from bootstrap is preserved."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4594, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}