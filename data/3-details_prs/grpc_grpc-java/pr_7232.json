{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxMzgzMjYz", "number": 7232, "title": "xds: implement STS based OAuth 2.0 credentials exchange", "bodyText": "", "createdAt": "2020-07-17T19:18:16Z", "url": "https://github.com/grpc/grpc-java/pull/7232", "merged": true, "mergeCommit": {"oid": "c60f5ff95bcd836672a0557981f0b8972e1aa406"}, "closed": true, "closedAt": "2020-07-22T23:36:38Z", "author": {"login": "sanjaypujare"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc14z0SgH2gAyNDUxMzgzMjYzOjIwMmQzYzRkOWUyNGZhN2Y1MmRlYzMyNjVhZWJjMWQzMzg2MTA0NDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3jLvUgH2gAyNDUxMzgzMjYzOjE0ZDcxMzk1MWFmYjNmYWYxMTE3Mjk4MjRjNTlmY2I5YzIwZDY1M2Q=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "202d3c4d9e24fa7f52dec3265aebc1d338610444", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/202d3c4d9e24fa7f52dec3265aebc1d338610444", "committedDate": "2020-07-17T19:15:21Z", "message": "xds: add STS based Oauth2 creds exchange"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "875201ff0ea1dc88b6fda9bb0960c0a7e21380ba", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/875201ff0ea1dc88b6fda9bb0960c0a7e21380ba", "committedDate": "2020-07-18T06:51:12Z", "message": "code coverage fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNTAzMjI4", "url": "https://github.com/grpc/grpc-java/pull/7232#pullrequestreview-453503228", "createdAt": "2020-07-22T16:48:25Z", "commit": {"oid": "875201ff0ea1dc88b6fda9bb0960c0a7e21380ba"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNjo0ODoyNVrOG1rUvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNzowNDo1OFrOG1r7Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzNzUzMg==", "bodyText": "It might be easier to read if this field is moved to the DefaultHttpTransportFactory class.", "url": "https://github.com/grpc/grpc-java/pull/7232#discussion_r458937532", "createdAt": "2020-07-22T16:48:25Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/internal/sts/StsCredentials.java", "diffHunk": "@@ -0,0 +1,164 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds.internal.sts;\n+\n+import com.google.api.client.http.GenericUrl;\n+import com.google.api.client.http.HttpContent;\n+import com.google.api.client.http.HttpRequest;\n+import com.google.api.client.http.HttpRequestFactory;\n+import com.google.api.client.http.HttpResponse;\n+import com.google.api.client.http.HttpStatusCodes;\n+import com.google.api.client.http.HttpTransport;\n+import com.google.api.client.http.javanet.NetHttpTransport;\n+import com.google.api.client.http.json.JsonHttpContent;\n+import com.google.api.client.json.JsonObjectParser;\n+import com.google.api.client.json.jackson2.JacksonFactory;\n+import com.google.api.client.util.GenericData;\n+import com.google.auth.http.HttpTransportFactory;\n+import com.google.auth.oauth2.AccessToken;\n+import com.google.auth.oauth2.GoogleCredentials;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.io.Files;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+// TODO(sanjaypujare): replace with the official implementation from google-auth once ready\n+/** Implementation of OAuth2 Token Exchange as per https://tools.ietf.org/html/rfc8693. */\n+public class StsCredentials extends GoogleCredentials {\n+  private static final long serialVersionUID = 6647041424685484932L;\n+\n+  private static final HttpTransportFactory defaultHttpTransportFactory =\n+      new DefaultHttpTransportFactory();\n+  private static final HttpTransport netHttpTransport = new NetHttpTransport();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "875201ff0ea1dc88b6fda9bb0960c0a7e21380ba"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzNzY1Nw==", "bodyText": "Do you want final class?", "url": "https://github.com/grpc/grpc-java/pull/7232#discussion_r458937657", "createdAt": "2020-07-22T16:48:40Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/internal/sts/StsCredentials.java", "diffHunk": "@@ -0,0 +1,164 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds.internal.sts;\n+\n+import com.google.api.client.http.GenericUrl;\n+import com.google.api.client.http.HttpContent;\n+import com.google.api.client.http.HttpRequest;\n+import com.google.api.client.http.HttpRequestFactory;\n+import com.google.api.client.http.HttpResponse;\n+import com.google.api.client.http.HttpStatusCodes;\n+import com.google.api.client.http.HttpTransport;\n+import com.google.api.client.http.javanet.NetHttpTransport;\n+import com.google.api.client.http.json.JsonHttpContent;\n+import com.google.api.client.json.JsonObjectParser;\n+import com.google.api.client.json.jackson2.JacksonFactory;\n+import com.google.api.client.util.GenericData;\n+import com.google.auth.http.HttpTransportFactory;\n+import com.google.auth.oauth2.AccessToken;\n+import com.google.auth.oauth2.GoogleCredentials;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.io.Files;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+// TODO(sanjaypujare): replace with the official implementation from google-auth once ready\n+/** Implementation of OAuth2 Token Exchange as per https://tools.ietf.org/html/rfc8693. */\n+public class StsCredentials extends GoogleCredentials {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "875201ff0ea1dc88b6fda9bb0960c0a7e21380ba"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk0NzQyMw==", "bodyText": "Surround this line with try{} and next line with finally{}?", "url": "https://github.com/grpc/grpc-java/pull/7232#discussion_r458947423", "createdAt": "2020-07-22T17:04:58Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/internal/sts/StsCredentials.java", "diffHunk": "@@ -0,0 +1,164 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds.internal.sts;\n+\n+import com.google.api.client.http.GenericUrl;\n+import com.google.api.client.http.HttpContent;\n+import com.google.api.client.http.HttpRequest;\n+import com.google.api.client.http.HttpRequestFactory;\n+import com.google.api.client.http.HttpResponse;\n+import com.google.api.client.http.HttpStatusCodes;\n+import com.google.api.client.http.HttpTransport;\n+import com.google.api.client.http.javanet.NetHttpTransport;\n+import com.google.api.client.http.json.JsonHttpContent;\n+import com.google.api.client.json.JsonObjectParser;\n+import com.google.api.client.json.jackson2.JacksonFactory;\n+import com.google.api.client.util.GenericData;\n+import com.google.auth.http.HttpTransportFactory;\n+import com.google.auth.oauth2.AccessToken;\n+import com.google.auth.oauth2.GoogleCredentials;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.io.Files;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+// TODO(sanjaypujare): replace with the official implementation from google-auth once ready\n+/** Implementation of OAuth2 Token Exchange as per https://tools.ietf.org/html/rfc8693. */\n+public class StsCredentials extends GoogleCredentials {\n+  private static final long serialVersionUID = 6647041424685484932L;\n+\n+  private static final HttpTransportFactory defaultHttpTransportFactory =\n+      new DefaultHttpTransportFactory();\n+  private static final HttpTransport netHttpTransport = new NetHttpTransport();\n+  private static final String CLOUD_PLATFORM_SCOPE =\n+      \"https://www.googleapis.com/auth/cloud-platform\";\n+  private final String sourceCredentialsFileLocation;\n+  private final String identityTokenEndpoint;\n+  private final String audience;\n+  private transient HttpTransportFactory transportFactory;\n+\n+  private StsCredentials(\n+      String identityTokenEndpoint,\n+      String audience,\n+      String sourceCredentialsFileLocation,\n+      HttpTransportFactory transportFactory) {\n+    this.identityTokenEndpoint = identityTokenEndpoint;\n+    this.audience = audience;\n+    this.sourceCredentialsFileLocation = sourceCredentialsFileLocation;\n+    this.transportFactory = transportFactory;\n+  }\n+\n+  /**\n+   * Creates an StsCredentials.\n+   *\n+   * @param identityTokenEndpoint  URL of the token exchange service to use.\n+   * @param audience Audience to use in the STS request.\n+   * @param sourceCredentialsFileLocation file-system location that contains the\n+   *                                      source creds e.g. JWT contents.\n+   */\n+  public static StsCredentials create(\n+      String identityTokenEndpoint, String audience, String sourceCredentialsFileLocation) {\n+    return create(\n+        identityTokenEndpoint,\n+        audience,\n+        sourceCredentialsFileLocation,\n+        getFromServiceLoader(HttpTransportFactory.class, defaultHttpTransportFactory));\n+  }\n+\n+  @VisibleForTesting\n+  static StsCredentials create(\n+      String identityTokenEndpoint,\n+      String audience,\n+      String sourceCredentialsFileLocation,\n+      HttpTransportFactory transportFactory) {\n+    return new StsCredentials(\n+        identityTokenEndpoint, audience, sourceCredentialsFileLocation, transportFactory);\n+  }\n+\n+  @Override\n+  public AccessToken refreshAccessToken() throws IOException {\n+    AccessToken tok = getSourceAccessTokenFromFileLocation();\n+\n+    HttpTransport httpTransport = this.transportFactory.create();\n+    JsonObjectParser parser = new JsonObjectParser(JacksonFactory.getDefaultInstance());\n+\n+    HttpRequestFactory requestFactory = httpTransport.createRequestFactory();\n+    GenericUrl url = new GenericUrl(identityTokenEndpoint);\n+\n+    Map<String, String> params = new HashMap<>();\n+    params.put(\"grant_type\", \"urn:ietf:params:oauth:grant-type:token-exchange\");\n+    params.put(\"subject_token_type\", \"urn:ietf:params:oauth:token-type:jwt\");\n+    params.put(\"requested_token_type\", \"urn:ietf:params:oauth:token-type:access_token\");\n+    params.put(\"subject_token\", tok.getTokenValue());\n+    params.put(\"scope\", CLOUD_PLATFORM_SCOPE);\n+    params.put(\"audience\", audience);\n+    HttpContent content = new JsonHttpContent(parser.getJsonFactory(), params);\n+    HttpRequest request = requestFactory.buildPostRequest(url, content);\n+    request.setParser(parser);\n+\n+    HttpResponse response = null;\n+    try {\n+      response = request.execute();\n+    } catch (IOException e) {\n+      throw new IOException(\"Error requesting access token\", e);\n+    }\n+\n+    if (response.getStatusCode() != HttpStatusCodes.STATUS_CODE_OK) {\n+      throw new IOException(\"Error getting access token \" + getStatusString(response));\n+    }\n+\n+    GenericData responseData = response.parseAs(GenericData.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "875201ff0ea1dc88b6fda9bb0960c0a7e21380ba"}, "originalPosition": 130}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ce8e93b2d0bdfb20b4c2f0e47eddc2e04c39303", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/7ce8e93b2d0bdfb20b4c2f0e47eddc2e04c39303", "committedDate": "2020-07-22T22:51:21Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNzQxODE2", "url": "https://github.com/grpc/grpc-java/pull/7232#pullrequestreview-453741816", "createdAt": "2020-07-22T23:00:07Z", "commit": {"oid": "7ce8e93b2d0bdfb20b4c2f0e47eddc2e04c39303"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMzowMDowOFrOG13Htg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMzowMDowOFrOG13Htg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEzMDgwNg==", "bodyText": "Maybe add a colon \"Error getting access token: \" + getStatusString(response)", "url": "https://github.com/grpc/grpc-java/pull/7232#discussion_r459130806", "createdAt": "2020-07-22T23:00:08Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/internal/sts/StsCredentials.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds.internal.sts;\n+\n+import com.google.api.client.http.GenericUrl;\n+import com.google.api.client.http.HttpContent;\n+import com.google.api.client.http.HttpRequest;\n+import com.google.api.client.http.HttpRequestFactory;\n+import com.google.api.client.http.HttpResponse;\n+import com.google.api.client.http.HttpStatusCodes;\n+import com.google.api.client.http.HttpTransport;\n+import com.google.api.client.http.javanet.NetHttpTransport;\n+import com.google.api.client.http.json.JsonHttpContent;\n+import com.google.api.client.json.JsonObjectParser;\n+import com.google.api.client.json.jackson2.JacksonFactory;\n+import com.google.api.client.util.GenericData;\n+import com.google.auth.http.HttpTransportFactory;\n+import com.google.auth.oauth2.AccessToken;\n+import com.google.auth.oauth2.GoogleCredentials;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.io.Files;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+// TODO(sanjaypujare): replace with the official implementation from google-auth once ready\n+/** Implementation of OAuth2 Token Exchange as per https://tools.ietf.org/html/rfc8693. */\n+public final class StsCredentials extends GoogleCredentials {\n+  private static final long serialVersionUID = 6647041424685484932L;\n+\n+  private static final HttpTransportFactory defaultHttpTransportFactory =\n+      new DefaultHttpTransportFactory();\n+  private static final String CLOUD_PLATFORM_SCOPE =\n+      \"https://www.googleapis.com/auth/cloud-platform\";\n+  private final String sourceCredentialsFileLocation;\n+  private final String identityTokenEndpoint;\n+  private final String audience;\n+  private transient HttpTransportFactory transportFactory;\n+\n+  private StsCredentials(\n+      String identityTokenEndpoint,\n+      String audience,\n+      String sourceCredentialsFileLocation,\n+      HttpTransportFactory transportFactory) {\n+    this.identityTokenEndpoint = identityTokenEndpoint;\n+    this.audience = audience;\n+    this.sourceCredentialsFileLocation = sourceCredentialsFileLocation;\n+    this.transportFactory = transportFactory;\n+  }\n+\n+  /**\n+   * Creates an StsCredentials.\n+   *\n+   * @param identityTokenEndpoint  URL of the token exchange service to use.\n+   * @param audience Audience to use in the STS request.\n+   * @param sourceCredentialsFileLocation file-system location that contains the\n+   *                                      source creds e.g. JWT contents.\n+   */\n+  public static StsCredentials create(\n+      String identityTokenEndpoint, String audience, String sourceCredentialsFileLocation) {\n+    return create(\n+        identityTokenEndpoint,\n+        audience,\n+        sourceCredentialsFileLocation,\n+        getFromServiceLoader(HttpTransportFactory.class, defaultHttpTransportFactory));\n+  }\n+\n+  @VisibleForTesting\n+  static StsCredentials create(\n+      String identityTokenEndpoint,\n+      String audience,\n+      String sourceCredentialsFileLocation,\n+      HttpTransportFactory transportFactory) {\n+    return new StsCredentials(\n+        identityTokenEndpoint, audience, sourceCredentialsFileLocation, transportFactory);\n+  }\n+\n+  @Override\n+  public AccessToken refreshAccessToken() throws IOException {\n+    AccessToken tok = getSourceAccessTokenFromFileLocation();\n+\n+    HttpTransport httpTransport = this.transportFactory.create();\n+    JsonObjectParser parser = new JsonObjectParser(JacksonFactory.getDefaultInstance());\n+\n+    HttpRequestFactory requestFactory = httpTransport.createRequestFactory();\n+    GenericUrl url = new GenericUrl(identityTokenEndpoint);\n+\n+    Map<String, String> params = new HashMap<>();\n+    params.put(\"grant_type\", \"urn:ietf:params:oauth:grant-type:token-exchange\");\n+    params.put(\"subject_token_type\", \"urn:ietf:params:oauth:token-type:jwt\");\n+    params.put(\"requested_token_type\", \"urn:ietf:params:oauth:token-type:access_token\");\n+    params.put(\"subject_token\", tok.getTokenValue());\n+    params.put(\"scope\", CLOUD_PLATFORM_SCOPE);\n+    params.put(\"audience\", audience);\n+    HttpContent content = new JsonHttpContent(parser.getJsonFactory(), params);\n+    HttpRequest request = requestFactory.buildPostRequest(url, content);\n+    request.setParser(parser);\n+\n+    HttpResponse response = null;\n+    try {\n+      response = request.execute();\n+    } catch (IOException e) {\n+      throw new IOException(\"Error requesting access token\", e);\n+    }\n+\n+    if (response.getStatusCode() != HttpStatusCodes.STATUS_CODE_OK) {\n+      throw new IOException(\"Error getting access token \" + getStatusString(response));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ce8e93b2d0bdfb20b4c2f0e47eddc2e04c39303"}, "originalPosition": 126}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14d713951afb3faf111729824c59fcb9c20d653d", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/14d713951afb3faf111729824c59fcb9c20d653d", "committedDate": "2020-07-22T23:11:25Z", "message": "address comments2"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4331, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}