{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyODQzNDEz", "number": 7285, "title": "xds: add support for cert-providers to bootstrap file", "bodyText": "", "createdAt": "2020-08-04T15:32:38Z", "url": "https://github.com/grpc/grpc-java/pull/7285", "merged": true, "mergeCommit": {"oid": "34513d7ed8912e700632aa06b9016760e852cc9a"}, "closed": true, "closedAt": "2020-08-05T05:32:27Z", "author": {"login": "sanjaypujare"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7oZa9gH2gAyNDYyODQzNDEzOjRiZDNiZTIxNmZiMDgwNDQ1OWZhYmJiNWRmYzRkNjliNGI3YzVhMDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc70F-MAH2gAyNDYyODQzNDEzOjhmYTNkNjc1MDRmNzhjYjdlYzIyYTZhMzExZmQ2YTljZTZhYWI2NGE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4bd3be216fb0804459fabbb5dfc4d69b4b7c5a00", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/4bd3be216fb0804459fabbb5dfc4d69b4b7c5a00", "committedDate": "2020-08-04T15:31:35Z", "message": "xds: add support for cert-providers to bootstrap file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1e30db91af9942fc8c2428b06bf6f67f69a7060", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/e1e30db91af9942fc8c2428b06bf6f67f69a7060", "committedDate": "2020-08-04T15:48:23Z", "message": "change cert-providers to certificate-providers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDc5ODA3", "url": "https://github.com/grpc/grpc-java/pull/7285#pullrequestreview-461079807", "createdAt": "2020-08-04T18:51:36Z", "commit": {"oid": "e1e30db91af9942fc8c2428b06bf6f67f69a7060"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDgwNjE0", "url": "https://github.com/grpc/grpc-java/pull/7285#pullrequestreview-461080614", "createdAt": "2020-08-04T18:52:52Z", "commit": {"oid": "e1e30db91af9942fc8c2428b06bf6f67f69a7060"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxODo1Mjo1MlrOG7tNlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxODo1Mjo1MlrOG7tNlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI1OTkyNg==", "bodyText": "Do you really just want to keep the content of certificate_providers as a blob? Ideally, we could parse it into an object explicitly. If design has a clear definition for what a certificate provider configuration would look like, then we should parse each field instead of dump them into a map, which is hard for consumers of certificate provider configurations to read off.", "url": "https://github.com/grpc/grpc-java/pull/7285#discussion_r465259926", "createdAt": "2020-08-04T18:52:52Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/Bootstrapper.java", "diffHunk": "@@ -160,7 +160,8 @@ static BootstrapInfo parseConfig(String rawData) throws IOException {\n     nodeBuilder.setUserAgentVersion(buildVersion.getImplementationVersion());\n     nodeBuilder.addClientFeatures(CLIENT_FEATURE_DISABLE_OVERPROVISIONING);\n \n-    return new BootstrapInfo(servers, nodeBuilder.build());\n+    Map<String, ?> certProviders = JsonUtil.getObject(rawBootstrap, \"certificate_providers\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1e30db91af9942fc8c2428b06bf6f67f69a7060"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDg2NzA4", "url": "https://github.com/grpc/grpc-java/pull/7285#pullrequestreview-461086708", "createdAt": "2020-08-04T19:02:03Z", "commit": {"oid": "e1e30db91af9942fc8c2428b06bf6f67f69a7060"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4d1bfbf4340c547afdd484020cb88ce0836b183", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/a4d1bfbf4340c547afdd484020cb88ce0836b183", "committedDate": "2020-08-04T21:35:39Z", "message": "address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTk3NDA2", "url": "https://github.com/grpc/grpc-java/pull/7285#pullrequestreview-461197406", "createdAt": "2020-08-04T21:46:47Z", "commit": {"oid": "a4d1bfbf4340c547afdd484020cb88ce0836b183"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMTo0Njo0N1rOG7yomA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMjowMDo0MlrOG7y_iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM0ODc2MA==", "bodyText": "Use JsonUtil.getObject(...). Same for config.", "url": "https://github.com/grpc/grpc-java/pull/7285#discussion_r465348760", "createdAt": "2020-08-04T21:46:47Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/Bootstrapper.java", "diffHunk": "@@ -160,7 +161,32 @@ static BootstrapInfo parseConfig(String rawData) throws IOException {\n     nodeBuilder.setUserAgentVersion(buildVersion.getImplementationVersion());\n     nodeBuilder.addClientFeatures(CLIENT_FEATURE_DISABLE_OVERPROVISIONING);\n \n-    return new BootstrapInfo(servers, nodeBuilder.build());\n+    Map<String, ?> certProvidersBlob = JsonUtil.getObject(rawBootstrap, \"certificate_providers\");\n+    Map<String, CertificateProviderInfo> certProviders = null;\n+    if (certProvidersBlob != null) {\n+      certProviders = new HashMap<>(certProvidersBlob.size());\n+      for (Map.Entry<String, ?> entry : certProvidersBlob.entrySet()) {\n+        String name = entry.getKey();\n+        Object value = entry.getValue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d1bfbf4340c547afdd484020cb88ce0836b183"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM0OTYyNA==", "bodyText": "You would probably want this to be public (and internal).", "url": "https://github.com/grpc/grpc-java/pull/7285#discussion_r465349624", "createdAt": "2020-08-04T21:48:47Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/Bootstrapper.java", "diffHunk": "@@ -225,6 +251,29 @@ String getServerUri() {\n     }\n   }\n \n+  /**\n+   * Data class containing Certificate provider information: the plugin-name and an opaque\n+   * Map that represents the config for that plugin.\n+   */\n+  @Immutable\n+  static class CertificateProviderInfo {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d1bfbf4340c547afdd484020cb88ce0836b183"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM1NDYzMw==", "bodyText": "nit: mark Nullable.", "url": "https://github.com/grpc/grpc-java/pull/7285#discussion_r465354633", "createdAt": "2020-08-04T22:00:42Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/Bootstrapper.java", "diffHunk": "@@ -233,11 +282,14 @@ String getServerUri() {\n   public static class BootstrapInfo {\n     private List<ServerInfo> servers;\n     private final Node node;\n+    private final Map<String, CertificateProviderInfo> certProviders;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d1bfbf4340c547afdd484020cb88ce0836b183"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78b7c73a2c528fd104cfa1ca19fa0ed4dde4837b", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/78b7c73a2c528fd104cfa1ca19fa0ed4dde4837b", "committedDate": "2020-08-04T22:43:54Z", "message": "address review comments-2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMjM2MzEy", "url": "https://github.com/grpc/grpc-java/pull/7285#pullrequestreview-461236312", "createdAt": "2020-08-04T23:10:03Z", "commit": {"oid": "78b7c73a2c528fd104cfa1ca19fa0ed4dde4837b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMzoxMDowM1rOG70h-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMzoxMDowM1rOG70h-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM3OTgzNQ==", "bodyText": "Since this is the parsing logic, the input (the boostrap JSON file) can contain anything, it needs to be defensive. You should always check if the retrieved result exists, a proper exception should be thrown if not. All exceptions should be checked, runtime exceptions will be a surprise.", "url": "https://github.com/grpc/grpc-java/pull/7285#discussion_r465379835", "createdAt": "2020-08-04T23:10:03Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/Bootstrapper.java", "diffHunk": "@@ -165,24 +167,12 @@ static BootstrapInfo parseConfig(String rawData) throws IOException {\n     Map<String, CertificateProviderInfo> certProviders = null;\n     if (certProvidersBlob != null) {\n       certProviders = new HashMap<>(certProvidersBlob.size());\n-      for (Map.Entry<String, ?> entry : certProvidersBlob.entrySet()) {\n-        String name = entry.getKey();\n-        Object value = entry.getValue();\n-        if (!(value instanceof Map)) {\n-          throw new IOException(\n-              \"Invalid bootstrap: invalid 'certificate_providers' entry for \" + name);\n-        }\n-        @SuppressWarnings(\"unchecked\")\n-        Map<String, ?> valueMap = (Map<String, ?>) value;\n-        Object pluginName = valueMap.get(\"plugin_name\");\n-        Object config = valueMap.get(\"config\");\n-        if (!(pluginName instanceof String) || !(config instanceof Map)) {\n-          throw new IOException(\n-              \"Invalid bootstrap: invalid 'certificate_providers' entry for \" + name);\n-        }\n-        @SuppressWarnings(\"unchecked\")\n+      for (String name : certProvidersBlob.keySet()) {\n+        Map<String, ?> valueMap = JsonUtil.getObject(certProvidersBlob, name);\n+        String pluginName = JsonUtil.getString(valueMap, \"plugin_name\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78b7c73a2c528fd104cfa1ca19fa0ed4dde4837b"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c3b88fc7dd9654e16d4325b623264356a1e6c44", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/1c3b88fc7dd9654e16d4325b623264356a1e6c44", "committedDate": "2020-08-05T04:34:33Z", "message": "address review comments-3"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMzM4NDg0", "url": "https://github.com/grpc/grpc-java/pull/7285#pullrequestreview-461338484", "createdAt": "2020-08-05T04:52:56Z", "commit": {"oid": "1c3b88fc7dd9654e16d4325b623264356a1e6c44"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fa3d67504f78cb7ec22a6a311fd6a9ce6aab64a", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/8fa3d67504f78cb7ec22a6a311fd6a9ce6aab64a", "committedDate": "2020-08-05T05:09:12Z", "message": "address review comments-4"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4145, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}