{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0NjMxOTEw", "number": 6706, "title": "xds: report load stats for all clusters over a single LRS client", "bodyText": "Terminology:\n\ncluster: CDS cluster\ncluster service: EDS service. Maybe null. Multiple clusters can point a client to the same cluster service. Also named eds service.\n\nClarification on load reporting:\n\nSimilar to XdsClient, each channel should have at most one LRS stream based on the current design of using a single management server. That is, each channel should have a single LRS client that is responsible for reporting loads for all clusters.\nIn LRS protocol, the server tells the client what clusters to report and the client gives the server data on a per-(cluster,eds_service_name) basis. So each ClusterStats in LRS request contains loads for each cluster:eds_service. For example, if gRPC client talked to service A and B instructed by CDS responses of cluster foo, and management server asks client to report loads for cluster foo. Then the LRS client should send an LRS request containing two ClusterStats: one for foo:A and one for foo:B.\n\nOpen questions on load reporting:\n\nLRS protocol has a mechanism of using initial request to tell management server which clusters the client wants to report loads. But this does not work if the client wants to report loads for other more clusters while load reporting is happening. Design TBD.\n\nCurrently we assume no cluster/eds service switch, which means we will report load for a single cluster/eds service. So we make the restriction to LoadReportClient#addLoadStatsStore() API that it cannot be called after load reporting has already started. This restriction will be removed after the above open question is resolved.\nChanges in this PR:\n\n\nEach LoadStatsStore instance is associated with clusterName:clusterServiceName. clusterName and clusterServiceName (nullable) is required to construct an LoadStatsStore instance.\n\nThe semantics is that an LoadStatsStore is responsible for recording loads sent to that cluster service of the cluster.\nThe queried load report (via LoadStatsStore#generateLoadReport()) will have cluster_name and cluster_service_name (if not null) set.\n\n\n\nA LoadReportClient is responsible for reporting loads for all clusters. Add LoadStatsStore to LoadReportClient via LoadReportClient#addLoadStatsStore(clusterName, clusterServiceName, loadStatsStore). This should be done before LoadReportClient#startLoadReporting() is called due to the above open question.\n\n\nAn XdsClient contains a single LoadReportClient instance. Its APIs XdsClient#reportClientStats(clusterName, clusterServiceName, loadStatsStore) calls LoadReportClient#addLoadStatsStore(clusterName, clusterServiceName, loadStatsStore) and then starts it. XdsClient#cancelClientStatsReport(clusterName, clusterServiceName) calls LoadReportClient#removeLoadStatsStore(clusterName, clusterServiceName) and stops it. LoadReportClient#addLoadStatsStore(clusterName, clusterServiceName, loadStatsStore) cannot be called repeatedly as once the load reporting started, we cannot change the cluster to report loads for. However, we are able to do report then cancel then report then cancel and so on.\n\n\nRefactored EdsLoadBalancer a bit, to accommodate the new APIs of enabling/disabling load reporting. The ClusterEndpointsLoadBalancer instance carries its own LoadStatsStore and controls start/cancel of load reporting.\n\n\nThe interface for LoadReportClient is eliminated. LoadReportClient will completely be a subcomponent of XdsClient.", "createdAt": "2020-02-13T02:05:47Z", "url": "https://github.com/grpc/grpc-java/pull/6706", "merged": true, "mergeCommit": {"oid": "88c027bac3b6ac40d1ea65f563bf1f9de8a9cc19"}, "closed": true, "closedAt": "2020-02-20T02:07:45Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDwAYhgH2gAyMzc0NjMxOTEwOmU5NmU2MGExNDZjOGVkMGI2NDRmNjBlODAxZTFhNzU1MmFhOGM4ZmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGAUhzgFqTM2MTU0NDMzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e96e60a146c8ed0b644f60e801e1a7552aa8c8fc", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/e96e60a146c8ed0b644f60e801e1a7552aa8c8fc", "committedDate": "2020-02-13T00:43:43Z", "message": "Bind each LoadStatsStore instance with cluster:eds_service."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e82e8370336ecc628f7c5a26b7ac7a7502c24f24", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/e82e8370336ecc628f7c5a26b7ac7a7502c24f24", "committedDate": "2020-02-13T00:44:59Z", "message": "An LoadReportClient instance should be responsible for reporting loads for all clusters."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d2f8fb1ab198362629e4bf25c159d660326619b", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/6d2f8fb1ab198362629e4bf25c159d660326619b", "committedDate": "2020-02-13T00:47:09Z", "message": "An XdsClient instance should contain at most one LoadReportClient instance. All load reporting work should be delegated to the contained LoadReportClient instance."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcc515c116a9a61ad355ac6e3313e1902378431c", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/dcc515c116a9a61ad355ac6e3313e1902378431c", "committedDate": "2020-02-13T01:09:15Z", "message": "Change EdsLoadBalancer to enable/disable load reporting with the new XdsClient APIs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efce45619e2b9913fd448e1b069f2443c8e9883f", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/efce45619e2b9913fd448e1b069f2443c8e9883f", "committedDate": "2020-02-13T01:09:22Z", "message": "Eliminate interface for LoadReportClient."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NjYxNzIx", "url": "https://github.com/grpc/grpc-java/pull/6706#pullrequestreview-358661721", "createdAt": "2020-02-14T01:21:06Z", "commit": {"oid": "efce45619e2b9913fd448e1b069f2443c8e9883f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMToyMTowNlrOFppCLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMToyMTowNlrOFppCLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIwODIzOQ==", "bodyText": "It only works for the case cluster_service name is never changed, otherwise the first ClusterEndpointsBalancer.shutdown will cancel the second ClusterEndpointsBalancer's load report. It that intended behavior for now?", "url": "https://github.com/grpc/grpc-java/pull/6706#discussion_r379208239", "createdAt": "2020-02-14T01:21:06Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java", "diffHunk": "@@ -339,9 +324,9 @@ public boolean canHandleEmptyAddressListFromNameResolution() {\n \n       @Override\n       public void shutdown() {\n-        loadStatsStoreMap.remove(clusterServiceName);\n-        if (isReportingStats()) {\n-          loadReportClient.removeLoadStatsStore(clusterServiceName);\n+        if (isReportingLoad) {\n+          xdsClient.cancelClientStatsReport(clusterName, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efce45619e2b9913fd448e1b069f2443c8e9883f"}, "originalPosition": 129}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NjY0MzE5", "url": "https://github.com/grpc/grpc-java/pull/6706#pullrequestreview-358664319", "createdAt": "2020-02-14T01:30:18Z", "commit": {"oid": "efce45619e2b9913fd448e1b069f2443c8e9883f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMTozMDoxOFrOFppKrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMTozMDoxOFrOFppKrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIxMDQxNQ==", "bodyText": "This only works for the case cluster_service name is never changed, otherwise it will throw because of the graceful switch. It that intended behavior for now?", "url": "https://github.com/grpc/grpc-java/pull/6706#discussion_r379210415", "createdAt": "2020-02-14T01:30:18Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java", "diffHunk": "@@ -321,7 +287,26 @@ public int hashCode() {\n         EdsLoadBalancer.this.endpointWatcher = endpointWatcher;\n       }\n \n-      // TODO(zddapeng): In handleResolvedAddresses() handle child policy change if any.\n+      @Override\n+      public void handleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n+        XdsConfig config = (XdsConfig) resolvedAddresses.getLoadBalancingPolicyConfig();\n+        if (config.lrsServerName != null) {\n+          if (!config.lrsServerName.equals(\"\")) {\n+            throw new AssertionError(\n+                \"Can only report load to the same management server\");\n+          }\n+          if (!isReportingLoad) {\n+            xdsClient.reportClientStats(clusterName, null, loadStatsStore);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efce45619e2b9913fd448e1b069f2443c8e9883f"}, "originalPosition": 107}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58bb8fea86c390f5b9354fca24b2042a451b2901", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/58bb8fea86c390f5b9354fca24b2042a451b2901", "committedDate": "2020-02-19T19:00:49Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/rework_lrs_integration_with_xds_client"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNTMxNDAy", "url": "https://github.com/grpc/grpc-java/pull/6706#pullrequestreview-361531402", "createdAt": "2020-02-20T00:15:00Z", "commit": {"oid": "58bb8fea86c390f5b9354fca24b2042a451b2901"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74ddf7f7a04714cc2a7251bf4f1b8b7f8531125d", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/74ddf7f7a04714cc2a7251bf4f1b8b7f8531125d", "committedDate": "2020-02-20T00:24:11Z", "message": "Do not support switching cluster_service, report loads per cluter only. Cluster_service field is never used."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNTM3NTcz", "url": "https://github.com/grpc/grpc-java/pull/6706#pullrequestreview-361537573", "createdAt": "2020-02-20T00:32:25Z", "commit": {"oid": "74ddf7f7a04714cc2a7251bf4f1b8b7f8531125d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMDozMjoyNVrOFr8owA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMDozMjoyNVrOFr8owA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYyNjU2MA==", "bodyText": "(If there is attributes or addresses change in resolvedAddresses) we still need call switchingLoadBalancer.handleResolvedAddresses(resolvedAddresses)\nbefore return.", "url": "https://github.com/grpc/grpc-java/pull/6706#discussion_r381626560", "createdAt": "2020-02-20T00:32:25Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java", "diffHunk": "@@ -114,6 +117,9 @@ public void handleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n       return;\n     }\n     XdsConfig newXdsConfig = (XdsConfig) lbConfig;\n+    if (Objects.equals(newXdsConfig, xdsConfig)) {\n+      return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ddf7f7a04714cc2a7251bf4f1b8b7f8531125d"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e09cb8b6abecdf098b9632d5da1779ca775c1ab", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/6e09cb8b6abecdf098b9632d5da1779ca775c1ab", "committedDate": "2020-02-20T00:50:45Z", "message": "Should still handle resolved addresses even if lb config does not change."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNTQ0MzMz", "url": "https://github.com/grpc/grpc-java/pull/6706#pullrequestreview-361544333", "createdAt": "2020-02-20T00:52:03Z", "commit": {"oid": "6e09cb8b6abecdf098b9632d5da1779ca775c1ab"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4574, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}