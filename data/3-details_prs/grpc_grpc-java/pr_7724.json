{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM3OTU3NTA0", "number": 7724, "title": "Add exporting SSL/TLS master key log feature", "bodyText": "@ejona86 Could you help to review this PR?\nEnable this feature by setting the system property in command argument\n   -Dio.netty.ssl.masterKeyHandler=true\n\nor in java code\n   System.setProperty(SslMasterKeyHandler.SYSTEM_PROP_KEY, \"true\");\nThe keys will be written to the log named \"io.netty.wireshark\" in the warnning level. To export the keys to a file, you can configure log factory like: (log4j.xml for example)\n...\n<appender name=\"key-file\" class=\"org.apache.log4j.RollingFileAppender\">\n\t<param name=\"file\" value=\"d:/keyfile.txt\"/>\n\t<layout class=\"org.apache.log4j.PatternLayout\">\n\t\t<param name=\"ConversionPattern\" value=\"%m%n\"/>\n\t</layout>\n</appender>\n<category name=\"io.netty.wireshark\">\n\t<priority value=\"DEBUG\" />\n\t<appender-ref ref=\"key-file\" />\n</category>\n...\nWireshark can analyze the messages gRPC over TLS with this key log file.\nThere is a sample capture and key log file generated by using this commit:\n\ngrpc_person_search_protobuf_and_json_tls.pcapng -- Person search gRPC sample capture (port 60051 for protobuf payload and 60052 for json payload).\nkeylog.txt --- grpc_person_search_protobuf_and_json_tls.keylog.txt -- Key log file for above capture.\n\nYou can refer to Wireshark gRPC wiki page for getting the\nperson_search_service.proto and addressbook.proto files, and how to set the Wireshark for parsing gRPC network traffic.\nAnd put the path of keylog.txt in the key log preference in Preferences->Protocols->TLS->(Pre)-Master-Secret log filename.\nFinally decode traffic on tcp port 60051 and 60052 as TLS.\nclose #7199", "createdAt": "2020-12-12T09:38:49Z", "url": "https://github.com/grpc/grpc-java/pull/7724", "merged": true, "mergeCommit": {"oid": "9bc05fba67b709d1e816f47c462b22d976194cca"}, "closed": true, "closedAt": "2021-01-08T21:11:25Z", "author": {"login": "huangqiangxiong"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmLM2egFqTU1MTc2Nzg3Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABduPWFbgFqTU2NDU4NDAwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxNzY3ODc2", "url": "https://github.com/grpc/grpc-java/pull/7724#pullrequestreview-551767876", "createdAt": "2020-12-14T18:18:30Z", "commit": {"oid": "e4bf807750284aa297a8d3aaa568184c1b1418f5"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxODoxODozMFrOIFd4cA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTo0NDo0NVrOIFjx0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwMzM3Ng==", "bodyText": "These resets don't do anything, as the test is over. Remove them?", "url": "https://github.com/grpc/grpc-java/pull/7724#discussion_r542603376", "createdAt": "2020-12-14T18:18:30Z", "author": {"login": "ejona86"}, "path": "netty/src/test/java/io/grpc/netty/ProtocolNegotiatorsTest.java", "diffHunk": "@@ -179,6 +195,10 @@ public void tearDown() {\n       chan.close();\n     }\n     group.shutdownGracefully();\n+\n+    Mockito.reset(mockLogger4KeyLog);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4bf807750284aa297a8d3aaa568184c1b1418f5"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwMzk2OA==", "bodyText": "This should be part of the one test that actually uses it.", "url": "https://github.com/grpc/grpc-java/pull/7724#discussion_r542603968", "createdAt": "2020-12-14T18:19:16Z", "author": {"login": "ejona86"}, "path": "netty/src/test/java/io/grpc/netty/ProtocolNegotiatorsTest.java", "diffHunk": "@@ -168,6 +179,11 @@ public void setUp() throws Exception {\n         .ciphers(TestUtils.preferredTestCiphers(), SupportedCipherSuiteFilter.INSTANCE).build();\n     engine = SSLContext.getDefault().createSSLEngine();\n     engine.setUseClientMode(true);\n+\n+    oldLoggerFactory = InternalLoggerFactory.getDefaultFactory();\n+    mockLogger4KeyLog = mock(InternalLogger.class);\n+    mockLogger4Others = mock(InternalLogger.class);\n+    InternalLoggerFactory.setDefaultFactory(new FakeLoggerFactory());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4bf807750284aa297a8d3aaa568184c1b1418f5"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwNTkyNQ==", "bodyText": "Merge this mock initialization with the declaration on lines 170-171.", "url": "https://github.com/grpc/grpc-java/pull/7724#discussion_r542605925", "createdAt": "2020-12-14T18:21:03Z", "author": {"login": "ejona86"}, "path": "netty/src/test/java/io/grpc/netty/ProtocolNegotiatorsTest.java", "diffHunk": "@@ -168,6 +179,11 @@ public void setUp() throws Exception {\n         .ciphers(TestUtils.preferredTestCiphers(), SupportedCipherSuiteFilter.INSTANCE).build();\n     engine = SSLContext.getDefault().createSSLEngine();\n     engine.setUseClientMode(true);\n+\n+    oldLoggerFactory = InternalLoggerFactory.getDefaultFactory();\n+    mockLogger4KeyLog = mock(InternalLogger.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4bf807750284aa297a8d3aaa568184c1b1418f5"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwNzk3Nw==", "bodyText": "any(String.class). Ditto elsewhere.", "url": "https://github.com/grpc/grpc-java/pull/7724#discussion_r542607977", "createdAt": "2020-12-14T18:22:54Z", "author": {"login": "ejona86"}, "path": "netty/src/test/java/io/grpc/netty/ProtocolNegotiatorsTest.java", "diffHunk": "@@ -1190,4 +1210,81 @@ public void handlerAdded(ChannelHandlerContext ctx) throws Exception {\n       ctx.pipeline().fireUserEventTriggered(ProtocolNegotiationEvent.DEFAULT);\n     }\n   }\n+\n+  @Test\n+  public void clientTlsHandler_serverTlsHandler_sslMasterKeyLog() throws Exception {\n+    // The master key log feature should be disabled\n+    // when the \"io.netty.ssl.masterKeyHandler\" property is missing.\n+    System.clearProperty(SslMasterKeyHandler.SYSTEM_PROP_KEY);\n+    clientTlsHandler_firesNegotiation();\n+    verify(mockLogger4KeyLog, never()).warn(argThat(new ArgumentMatcher<String>() {\n+      @Override\n+      public boolean matches(String arg) {\n+        return arg.contains(\" Master-Key:\");\n+      }\n+    }), argThat(new ArgumentMatcher<String>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4bf807750284aa297a8d3aaa568184c1b1418f5"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwODc4MA==", "bodyText": "ArgumentMatchers.contains(\" Master-Key:\"). Ditto elsewhere.", "url": "https://github.com/grpc/grpc-java/pull/7724#discussion_r542608780", "createdAt": "2020-12-14T18:23:39Z", "author": {"login": "ejona86"}, "path": "netty/src/test/java/io/grpc/netty/ProtocolNegotiatorsTest.java", "diffHunk": "@@ -1190,4 +1210,81 @@ public void handlerAdded(ChannelHandlerContext ctx) throws Exception {\n       ctx.pipeline().fireUserEventTriggered(ProtocolNegotiationEvent.DEFAULT);\n     }\n   }\n+\n+  @Test\n+  public void clientTlsHandler_serverTlsHandler_sslMasterKeyLog() throws Exception {\n+    // The master key log feature should be disabled\n+    // when the \"io.netty.ssl.masterKeyHandler\" property is missing.\n+    System.clearProperty(SslMasterKeyHandler.SYSTEM_PROP_KEY);\n+    clientTlsHandler_firesNegotiation();\n+    verify(mockLogger4KeyLog, never()).warn(argThat(new ArgumentMatcher<String>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4bf807750284aa297a8d3aaa568184c1b1418f5"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5OTk4Nw==", "bodyText": "Instead of returning this mockLogger4Others, how about the factory delegate to oldLoggerFactory?\nHonestly, even for mockLogger4KeyLog it'd probably be better to use AdditionalAnswers.delegatesTo() and delegate to a real instance. That gets you the recording capability of the mock while not needing to define Answers. Right now if the code under test did things like calling isWarnEnabled() it would be returned false and so may not log at all. That would fail one of the tests, but it is still good to back mocks with real objects for anything other than Listeners.", "url": "https://github.com/grpc/grpc-java/pull/7724#discussion_r542699987", "createdAt": "2020-12-14T19:44:45Z", "author": {"login": "ejona86"}, "path": "netty/src/test/java/io/grpc/netty/ProtocolNegotiatorsTest.java", "diffHunk": "@@ -160,6 +167,10 @@ public static void loadCerts() throws Exception {\n   private SSLEngine engine;\n   private ChannelHandlerContext channelHandlerCtx;\n \n+  private InternalLogger mockLogger4KeyLog;\n+  private InternalLogger mockLogger4Others;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4bf807750284aa297a8d3aaa568184c1b1418f5"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fd225cd3aa9035a865a9d46ddd1056bb600d7d0", "author": {"user": {"login": "huangqiangxiong", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/6fd225cd3aa9035a865a9d46ddd1056bb600d7d0", "committedDate": "2020-12-15T11:28:41Z", "message": "Add exporting SSL/TLS master key log feature\n\nEnable this feature by setting the system property\n   -Dio.netty.ssl.masterKeyHandler=true\nor\n   System.setProperty(SslMasterKeyHandler.SYSTEM_PROP_KEY, \"true\");\nThe keys will be written to the log named \"io.netty.wireshark\" in\nthe warnning level. To export the keys to a file, you can configure\nlog factory like: (with log4j.xml for example)\n<appender name=\"key-file\" class=\"org.apache.log4j.RollingFileAppender\">\n\t<param name=\"file\" value=\"d:/keyfile.txt\"/>\n\t<layout class=\"org.apache.log4j.PatternLayout\">\n\t\t<param name=\"ConversionPattern\" value=\"%m%n\"/>\n\t</layout>\n</appender>\n<category name=\"io.netty.wireshark\">\n\t<priority value=\"DEBUG\" />\n\t<appender-ref ref=\"key-file\" />\n</category>\n\nWireshark can analyze the messages gRPC over TLS with this\nkey log file.\n\nclose #7199"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4bf807750284aa297a8d3aaa568184c1b1418f5", "author": {"user": {"login": "huangqiangxiong", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/e4bf807750284aa297a8d3aaa568184c1b1418f5", "committedDate": "2020-12-12T08:35:20Z", "message": "Add exporting SSL/TLS master key log feature\n\nEnable this feature by setting the system property\n   -Dio.netty.ssl.masterKeyHandler=true\nor\n   System.setProperty(SslMasterKeyHandler.SYSTEM_PROP_KEY, \"true\");\nThe keys will be written to the log named \"io.netty.wireshark\" in\nthe warnning level. To export the keys to a file, you can configure\nlog factory like: (with log4j.xml for example)\n<appender name=\"key-file\" class=\"org.apache.log4j.RollingFileAppender\">\n\t<param name=\"file\" value=\"d:/keyfile.txt\"/>\n\t<layout class=\"org.apache.log4j.PatternLayout\">\n\t\t<param name=\"ConversionPattern\" value=\"%m%n\"/>\n\t</layout>\n</appender>\n<category name=\"io.netty.wireshark\">\n\t<priority value=\"DEBUG\" />\n\t<appender-ref ref=\"key-file\" />\n</category>\n\nWireshark can analyze the messages gRPC over TLS with this\nkey log file.\n\nclose #7199"}, "afterCommit": {"oid": "6fd225cd3aa9035a865a9d46ddd1056bb600d7d0", "author": {"user": {"login": "huangqiangxiong", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/6fd225cd3aa9035a865a9d46ddd1056bb600d7d0", "committedDate": "2020-12-15T11:28:41Z", "message": "Add exporting SSL/TLS master key log feature\n\nEnable this feature by setting the system property\n   -Dio.netty.ssl.masterKeyHandler=true\nor\n   System.setProperty(SslMasterKeyHandler.SYSTEM_PROP_KEY, \"true\");\nThe keys will be written to the log named \"io.netty.wireshark\" in\nthe warnning level. To export the keys to a file, you can configure\nlog factory like: (with log4j.xml for example)\n<appender name=\"key-file\" class=\"org.apache.log4j.RollingFileAppender\">\n\t<param name=\"file\" value=\"d:/keyfile.txt\"/>\n\t<layout class=\"org.apache.log4j.PatternLayout\">\n\t\t<param name=\"ConversionPattern\" value=\"%m%n\"/>\n\t</layout>\n</appender>\n<category name=\"io.netty.wireshark\">\n\t<priority value=\"DEBUG\" />\n\t<appender-ref ref=\"key-file\" />\n</category>\n\nWireshark can analyze the messages gRPC over TLS with this\nkey log file.\n\nclose #7199"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNzEzODEy", "url": "https://github.com/grpc/grpc-java/pull/7724#pullrequestreview-552713812", "createdAt": "2020-12-15T17:46:56Z", "commit": {"oid": "6fd225cd3aa9035a865a9d46ddd1056bb600d7d0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY0NTg0MDAx", "url": "https://github.com/grpc/grpc-java/pull/7724#pullrequestreview-564584001", "createdAt": "2021-01-08T21:10:27Z", "commit": {"oid": "6fd225cd3aa9035a865a9d46ddd1056bb600d7d0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4764, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}