{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5Njc0MjUy", "number": 6586, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMjoxMDo1MlrODWGd8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMjoxOToyNlrODWGlZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NTAxMjM0OnYy", "diffSide": "RIGHT", "path": "xds/src/main/java/io/grpc/xds/sds/SdsClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMjoxMDo1MlrOFaqvEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxODowOToxMlrOFbfV1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwNzQ3NA==", "bodyText": "why not throw exception? returning actual exception seems wrong. also the for loop seems unnecessary if size is fixed.", "url": "https://github.com/grpc/grpc-java/pull/6586#discussion_r363507474", "createdAt": "2020-01-06T22:10:52Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/sds/SdsClient.java", "diffHunk": "@@ -333,42 +338,34 @@ public void run() {\n     }\n   }\n \n-  private boolean processSecretsFromDiscoveryResponse(DiscoveryResponse response) {\n+  private Throwable processSecretsFromDiscoveryResponse(DiscoveryResponse response) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1b56854f802cb8868e383f6479aee9eac9e9687"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM2OTM2NA==", "bodyText": "good point - I was trying to reuse the old 'boolean' logic. Will try to propagate exception and use it to populate the Status.", "url": "https://github.com/grpc/grpc-java/pull/6586#discussion_r364369364", "createdAt": "2020-01-08T18:09:12Z", "author": {"login": "sanjaypujare"}, "path": "xds/src/main/java/io/grpc/xds/sds/SdsClient.java", "diffHunk": "@@ -333,42 +338,34 @@ public void run() {\n     }\n   }\n \n-  private boolean processSecretsFromDiscoveryResponse(DiscoveryResponse response) {\n+  private Throwable processSecretsFromDiscoveryResponse(DiscoveryResponse response) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwNzQ3NA=="}, "originalCommit": {"oid": "b1b56854f802cb8868e383f6479aee9eac9e9687"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NTAyNDE1OnYy", "diffSide": "RIGHT", "path": "xds/src/main/java/io/grpc/xds/sds/SdsSslContextProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMjoxNjoxNlrOFaq2eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMjoxNjoxNlrOFaq2eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwOTM3MA==", "bodyText": "this is not consist with other code (eg L78 in new code). also L110", "url": "https://github.com/grpc/grpc-java/pull/6586#discussion_r363509370", "createdAt": "2020-01-06T22:16:16Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/sds/SdsSslContextProvider.java", "diffHunk": "@@ -97,9 +100,23 @@ private SdsSslContextProvider(\n       Executor channelExecutor) {\n     checkNotNull(upstreamTlsContext, \"upstreamTlsContext\");\n     CommonTlsContext commonTlsContext = upstreamTlsContext.getCommonTlsContext();\n-    SdsSecretConfig validationContextSdsConfig =\n-        commonTlsContext.getValidationContextSdsSecretConfig();\n-\n+    SdsSecretConfig validationContextSdsConfig = null;\n+    CertificateValidationContext staticCertValidationContext = null;\n+    if (commonTlsContext.hasCombinedValidationContext()) {\n+      CommonTlsContext.CombinedCertificateValidationContext combinedValidationContext\n+          = commonTlsContext.getCombinedValidationContext();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1b56854f802cb8868e383f6479aee9eac9e9687"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NTAyNzc2OnYy", "diffSide": "RIGHT", "path": "xds/src/main/java/io/grpc/xds/sds/SdsSslContextProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMjoxNzo1NVrOFaq4xA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMjoxNzo1NVrOFaq4xA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwOTk1Ng==", "bodyText": "nit: should be in 2 lines with comment about what it is for.", "url": "https://github.com/grpc/grpc-java/pull/6586#discussion_r363509956", "createdAt": "2020-01-06T22:17:55Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/sds/SdsSslContextProvider.java", "diffHunk": "@@ -135,7 +153,7 @@ private SdsSslContextProvider(\n         node,\n         certSdsConfig,\n         validationContextSdsConfig,\n-        watcherExecutor,\n+        null, watcherExecutor,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1b56854f802cb8868e383f6479aee9eac9e9687"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NTAyODg2OnYy", "diffSide": "RIGHT", "path": "xds/src/main/java/io/grpc/xds/sds/SdsSslContextProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMjoxODoyMFrOFaq5Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMjoxODoyMFrOFaq5Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUxMDExNA==", "bodyText": "should be 1line. also should be indented 4 spaces (i can see this other lines e.g. L224)", "url": "https://github.com/grpc/grpc-java/pull/6586#discussion_r363510114", "createdAt": "2020-01-06T22:18:20Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/sds/SdsSslContextProvider.java", "diffHunk": "@@ -197,21 +220,27 @@ public synchronized void onSecretChanged(Secret secretUpdate) {\n   private void updateSslContext() {\n     try {\n       SslContextBuilder sslContextBuilder;\n+      CertificateValidationContext localCertValidationContext =\n+              mergeStaticAndDynamicCertContexts();\n       if (server) {\n+        logger.log(\n+                Level.FINEST, \"for server\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1b56854f802cb8868e383f6479aee9eac9e9687"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NTAyOTUxOnYy", "diffSide": "RIGHT", "path": "xds/src/main/java/io/grpc/xds/sds/SdsSslContextProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMjoxODozMVrOFaq5sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMjoxODozMVrOFaq5sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUxMDE5NQ==", "bodyText": "same here.", "url": "https://github.com/grpc/grpc-java/pull/6586#discussion_r363510195", "createdAt": "2020-01-06T22:18:31Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/sds/SdsSslContextProvider.java", "diffHunk": "@@ -197,21 +220,27 @@ public synchronized void onSecretChanged(Secret secretUpdate) {\n   private void updateSslContext() {\n     try {\n       SslContextBuilder sslContextBuilder;\n+      CertificateValidationContext localCertValidationContext =\n+              mergeStaticAndDynamicCertContexts();\n       if (server) {\n+        logger.log(\n+                Level.FINEST, \"for server\");\n         sslContextBuilder =\n             GrpcSslContexts.forServer(\n                 tlsCertificate.getCertificateChain().getInlineBytes().newInput(),\n                 tlsCertificate.getPrivateKey().getInlineBytes().newInput(),\n                 tlsCertificate.hasPassword()\n                     ? tlsCertificate.getPassword().getInlineString()\n                     : null);\n-        if (certificateValidationContext != null) {\n-          sslContextBuilder.trustManager(new SdsTrustManagerFactory(certificateValidationContext));\n+        if (localCertValidationContext != null) {\n+          sslContextBuilder.trustManager(new SdsTrustManagerFactory(localCertValidationContext));\n         }\n       } else {\n+        logger.log(\n+                Level.FINEST, \"for client\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1b56854f802cb8868e383f6479aee9eac9e9687"}, "originalPosition": 110}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NTAzMTQxOnYy", "diffSide": "RIGHT", "path": "xds/src/main/java/io/grpc/xds/sds/internal/SdsProtocolNegotiators.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMjoxOToyNlrOFaq68w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxODowMzo0MlrOFbfMzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUxMDUxNQ==", "bodyText": "those can be called a lot. can you use string interpolation (and probably elsewhere to save resource)? or better, remove those while converting other logging for FINE(ST)?\nbecause, this can be achieved by adding netty LoggingHandler.", "url": "https://github.com/grpc/grpc-java/pull/6586#discussion_r363510515", "createdAt": "2020-01-06T22:19:26Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/sds/internal/SdsProtocolNegotiators.java", "diffHunk": "@@ -150,23 +154,32 @@ public void close() {}\n \n     @Override\n     public void channelRead(ChannelHandlerContext ctx, Object msg) {\n+      logger.finest(\"ctx.name=\" + ctx.name() + \", msg=\" + msg);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1b56854f802cb8868e383f6479aee9eac9e9687"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM2NzA1NA==", "bodyText": "removing these as they are not needed at this time.", "url": "https://github.com/grpc/grpc-java/pull/6586#discussion_r364367054", "createdAt": "2020-01-08T18:03:42Z", "author": {"login": "sanjaypujare"}, "path": "xds/src/main/java/io/grpc/xds/sds/internal/SdsProtocolNegotiators.java", "diffHunk": "@@ -150,23 +154,32 @@ public void close() {}\n \n     @Override\n     public void channelRead(ChannelHandlerContext ctx, Object msg) {\n+      logger.finest(\"ctx.name=\" + ctx.name() + \", msg=\" + msg);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUxMDUxNQ=="}, "originalCommit": {"oid": "b1b56854f802cb8868e383f6479aee9eac9e9687"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3041, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}