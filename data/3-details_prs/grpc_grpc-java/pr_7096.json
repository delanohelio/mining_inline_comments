{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NjU0MjU4", "number": 7096, "title": "xds: retain locality stats counter when the child balancer for that locality is deactivated", "bodyText": "Bug description:\n\nWhen receiving an EDS update that removes a locality, the child balancer for that locality is not deleted immediately (delayed deletion for 15 minutes). However, the load stats counter for that locality is always deleted from the LoadStatsStore immediately! After a while (< 15 minutes) when this locality is added back, a new counter is created for it. However, the undeleted leaf balancer for this locality is still using the old counter. All loads are still recorded into the counter. This results in load reporting always reports 0 RPCs for that locality.\n\nFix:\n\nCreate the counter for recording per locality stats upon creating the child balancer for that locality. When the locality is deactivated (due to EDS response update removes it), the counter is not deleted from the LoadStatsStore. Delete it when the child balancer for that locality is shut down. In this way, the lifecycle of the load stats counter for a certain locality stays same with the child balancer for that locality. This is exactly what will happen after we refactor LocalityStore to PriorityLoadBalancer and LrsLoadBalancer (i.e., when some priority is deactivated, its subtree is not deleted immediately, so the LrsLoadBalancer instances for localities still hold the load stats counters).\n\nThis change also refactored class organizations (which I consider to be extremely messy) in LocalityStore", "createdAt": "2020-06-05T18:37:48Z", "url": "https://github.com/grpc/grpc-java/pull/7096", "merged": true, "mergeCommit": {"oid": "c777e0856327de03225bb3bdd9660001950f87e3"}, "closed": true, "closedAt": "2020-06-06T01:02:16Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoW8G0gH2gAyNDI4NjU0MjU4OmI3NjgxYWE1NmNhNTQ0Y2E5NzFmYWY4NDQ3MDU4YzMzMTdiMDJiNTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcocZUbgFqTQyNTY5NzQ2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b7681aa56ca544ca971faf8447058c3317b02b57", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/b7681aa56ca544ca971faf8447058c3317b02b57", "committedDate": "2020-06-05T18:26:37Z", "message": "Create the counter for recording per locality stats upon creating the child balancer for that locality. Delete it when the child balancer for that locality is shutted down. This change also refactored class organizations in LocalityStore."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7fb7f31b14900f9474e428752e0009833b79e0d4", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/7fb7f31b14900f9474e428752e0009833b79e0d4", "committedDate": "2020-06-05T18:44:25Z", "message": "Removed unused field."}, "afterCommit": {"oid": "c9f142bb206cfb40756e6615f21cd489ba3b9921", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/c9f142bb206cfb40756e6615f21cd489ba3b9921", "committedDate": "2020-06-05T18:47:22Z", "message": "Removed unused field."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1802e4e73a725a40f2296fe3b9c63824d58b7719", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/1802e4e73a725a40f2296fe3b9c63824d58b7719", "committedDate": "2020-06-05T18:59:03Z", "message": "Removed unused field."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c9f142bb206cfb40756e6615f21cd489ba3b9921", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/c9f142bb206cfb40756e6615f21cd489ba3b9921", "committedDate": "2020-06-05T18:47:22Z", "message": "Removed unused field."}, "afterCommit": {"oid": "1802e4e73a725a40f2296fe3b9c63824d58b7719", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/1802e4e73a725a40f2296fe3b9c63824d58b7719", "committedDate": "2020-06-05T18:59:03Z", "message": "Removed unused field."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NjQ1NzI0", "url": "https://github.com/grpc/grpc-java/pull/7096#pullrequestreview-425645724", "createdAt": "2020-06-05T21:52:25Z", "commit": {"oid": "1802e4e73a725a40f2296fe3b9c63824d58b7719"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQyMTo1MjoyNlrOGf-VLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQyMTo1MjoyNlrOGf-VLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE4MDI2OQ==", "bodyText": "BTW, this was also a bug. You should pass in the  ChildHelper instance of the LocalityLbInfo instead of just helper. It's lucky that ChildHelper's SynchronizationContext is just a delegation to helper's, so it did not cause problem. But this is wrong.\nArgument-passing, object ownership, lifecycle, etc. A lot of things in LocalityStore are messy. I hate this class, really. It might still contain unnoticed bug. Hope we can refactor to the LB structure and get rid of this early.", "url": "https://github.com/grpc/grpc-java/pull/7096#discussion_r436180269", "createdAt": "2020-06-05T21:52:26Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/LocalityStore.java", "diffHunk": "@@ -202,56 +198,20 @@ public void reset() {\n         localityMap.get(locality).shutdown();\n       }\n       localityMap.clear();\n-\n-      for (Locality locality : localities) {\n-        loadStatsStore.removeLocality(locality);\n-      }\n-      localities = ImmutableSet.of();\n-\n       priorityManager.reset();\n     }\n \n     @Override\n     public void updateLocalityStore(final Map<Locality, LocalityLbEndpoints> localityInfoMap) {\n-\n       Set<Locality> newLocalities = localityInfoMap.keySet();\n       // TODO: put endPointWeights into attributes for WRR.\n       for (Locality locality : newLocalities) {\n         if (localityMap.containsKey(locality)) {\n-          LocalityLbInfo localityLbInfo = localityMap.get(locality);\n-          LocalityLbEndpoints localityLbEndpoints = localityInfoMap.get(locality);\n-          handleEagsOnChildBalancer(helper, localityLbInfo, localityLbEndpoints, locality);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1802e4e73a725a40f2296fe3b9c63824d58b7719"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad31d85b3dfb3b7c5fff75d0c5d99aaf68588d22", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/ad31d85b3dfb3b7c5fff75d0c5d99aaf68588d22", "committedDate": "2020-06-06T00:34:14Z", "message": "Revert class name change."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1Njk3NDYz", "url": "https://github.com/grpc/grpc-java/pull/7096#pullrequestreview-425697463", "createdAt": "2020-06-06T00:47:35Z", "commit": {"oid": "ad31d85b3dfb3b7c5fff75d0c5d99aaf68588d22"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQwMDo0NzozNVrOGgAydQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQwMDo0NzozNVrOGgAydQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyMDUzMw==", "bodyText": "nit: All diffs except these 5 lines in ChildHelper class are unrelated.", "url": "https://github.com/grpc/grpc-java/pull/7096#discussion_r436220533", "createdAt": "2020-06-06T00:47:35Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/LocalityStore.java", "diffHunk": "@@ -375,73 +361,62 @@ void reactivate() {\n       boolean isDeactivated() {\n         return delayedDeletionTimer != null;\n       }\n-    }\n-\n-    class ChildHelper extends ForwardingLoadBalancerHelper {\n \n-      private final OrcaReportingHelperWrapper orcaReportingHelperWrapper;\n+      class ChildHelper extends ForwardingLoadBalancerHelper {\n \n-      private SubchannelPicker currentChildPicker = XdsSubchannelPickers.BUFFER_PICKER;\n-      private ConnectivityState currentChildState = CONNECTING;\n+        private final OrcaReportingHelperWrapper orcaReportingHelperWrapper;\n+        private SubchannelPicker currentChildPicker = XdsSubchannelPickers.BUFFER_PICKER;\n+        private ConnectivityState currentChildState = CONNECTING;\n \n-      ChildHelper(final Locality locality, final ClientLoadCounter counter,\n-          OrcaOobUtil orcaOobUtil) {\n-        checkNotNull(locality, \"locality\");\n-        checkNotNull(counter, \"counter\");\n-        checkNotNull(orcaOobUtil, \"orcaOobUtil\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad31d85b3dfb3b7c5fff75d0c5d99aaf68588d22"}, "originalPosition": 156}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4459, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}