{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MDgxMjM5", "number": 7209, "title": "xds: support load reporting all clusters option and fix actual report interval measurement", "bodyText": "Two changes for LoadReportClient in this PR:\n\n\nAdd support for send_all_clusters field in LRS response.\n\nWhen it is set to true, just send load reports for clusters that the client is currently tracking (aka, is sending load to).\n\n\n\nThe actual load report interval (in each ClusterStats message, which contains the stats for each cluster:eds_service) is tracked individually.\n\n\nExample:\nInitially, if the client has load stats recorded for cluster-foo:eds_service-foo and cluster-bar:eds_service-bar while the management server is only asking for load stats for cluster-foo:eds_service-foo to be reported every 10 seconds. The actual LRS requests sent to the management server should contain only one ClusterStats message (for cluster-foo:eds_service-foo) with load report interval being 10 seconds. After a while, the management server asks load stats for cluster-bar:eds_service-bar. Then the first LRS request after that should contain ClusterStats for cluster-bar:eds_service-bar should set its actual load report interval to the whole period from the beginning (Although the definition of \"beginning\" is unclear here. We use the time when the client starts to know the cluster while Envoy uses epoch. I think it shouldn't matter much for the first report of the cluster:eds_service). The point of this change is the actual load report interval for each cluster should be tracked individually as loads for clusters are not necessarily reported together.\n\n\nFor reference, see Enovy's implementation.", "createdAt": "2020-07-14T19:53:12Z", "url": "https://github.com/grpc/grpc-java/pull/7209", "merged": true, "mergeCommit": {"oid": "9f49e48237193c2ec3c17735f5c40dcb6b94a978"}, "closed": true, "closedAt": "2020-07-22T01:03:36Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc07Tz_gH2gAyNDQ5MDgxMjM5OjkzNWMwNTdlMDE5NWNkYTU3YmEyNDdjYjQ4OTA5NTU1ZjA0MjQzYWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3PxFDAFqTQ1MjkxODQzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "935c057e0195cda57ba247cb48909555f04243ad", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/935c057e0195cda57ba247cb48909555f04243ad", "committedDate": "2020-07-14T19:36:11Z", "message": "Support reporting loads for all clusters option. Fix load reporting interval measurement for each individual cluster:eds_service."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2e4762f208b8f95554747c1ecac0d4c9eac4770", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/b2e4762f208b8f95554747c1ecac0d4c9eac4770", "committedDate": "2020-07-14T19:36:26Z", "message": "Fix tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyODk4OTA2", "url": "https://github.com/grpc/grpc-java/pull/7209#pullrequestreview-452898906", "createdAt": "2020-07-21T23:33:47Z", "commit": {"oid": "b2e4762f208b8f95554747c1ecac0d4c9eac4770"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMzozMzo0N1rOG1Nckg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMzozMzo0N1rOG1Nckg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0ODAxOA==", "bodyText": "Better to pass a StopwatchSupplier in constructor, and create a new stopwatch here, so that it's clear that the stopwatch's lifecycle is solely managed by the LoadStatsEntity.", "url": "https://github.com/grpc/grpc-java/pull/7209#discussion_r458448018", "createdAt": "2020-07-21T23:33:47Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/LoadReportClient.java", "diffHunk": "@@ -401,6 +387,28 @@ private void cleanUp() {\n     }\n   }\n \n+  private static final class LoadStatsEntity {\n+    private final LoadStatsStore loadStatsStore;\n+    private final Stopwatch stopwatch;\n+\n+    private LoadStatsEntity(LoadStatsStore loadStatsStore, Stopwatch stopwatch) {\n+      this.loadStatsStore = loadStatsStore;\n+      this.stopwatch = stopwatch;\n+      stopwatch.reset().start();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2e4762f208b8f95554747c1ecac0d4c9eac4770"}, "originalPosition": 161}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "deb5186e6d4bbcb0d8bd6e8024d1788ce90feea1", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/deb5186e6d4bbcb0d8bd6e8024d1788ce90feea1", "committedDate": "2020-07-22T00:22:54Z", "message": "Clearer lifecylce of stopwatch in LoadStatsEntity."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyOTE4NDMw", "url": "https://github.com/grpc/grpc-java/pull/7209#pullrequestreview-452918430", "createdAt": "2020-07-22T00:34:06Z", "commit": {"oid": "deb5186e6d4bbcb0d8bd6e8024d1788ce90feea1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4317, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}