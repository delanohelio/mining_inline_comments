{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2NjQ5Nzk5", "number": 7386, "title": "Server builders extend public API", "bodyText": "The second part of #7211: Hide AbstractServerImplBuilder from public API.\nRef the first part: #7359.", "createdAt": "2020-08-31T23:27:42Z", "url": "https://github.com/grpc/grpc-java/pull/7386", "merged": true, "mergeCommit": {"oid": "3493347581c290b8d8be4627647d60a932572c54"}, "closed": true, "closedAt": "2020-09-03T20:26:05Z", "author": {"login": "sergiitk"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFAgKNgBqjM3MjEyNjE1MTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFV77LgBqjM3MjYzNDIxMDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b07aa731d01a87864294fcd9439f17766658cd7e", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/b07aa731d01a87864294fcd9439f17766658cd7e", "committedDate": "2020-08-31T23:18:24Z", "message": "interop-testing, testing: setup servers with internal server builders"}, "afterCommit": {"oid": "2e1be5e0c8ffd62717c018067e809a084c847339", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/2e1be5e0c8ffd62717c018067e809a084c847339", "committedDate": "2020-09-02T18:41:33Z", "message": "Fix merge"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e1be5e0c8ffd62717c018067e809a084c847339", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/2e1be5e0c8ffd62717c018067e809a084c847339", "committedDate": "2020-09-02T18:41:33Z", "message": "Fix merge"}, "afterCommit": {"oid": "7ed49e817ca7f3a30ed49652f56b7f819b710e6b", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/7ed49e817ca7f3a30ed49652f56b7f819b710e6b", "committedDate": "2020-09-02T19:34:56Z", "message": "Fix merges"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ed49e817ca7f3a30ed49652f56b7f819b710e6b", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/7ed49e817ca7f3a30ed49652f56b7f819b710e6b", "committedDate": "2020-09-02T19:34:56Z", "message": "Fix merges"}, "afterCommit": {"oid": "c76b2bcfd99500d6fd561092fe4b70638d4a448e", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/c76b2bcfd99500d6fd561092fe4b70638d4a448e", "committedDate": "2020-09-02T20:19:49Z", "message": "api, core: create ForwardingServerBuilder and ServerImplBuilder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b0ecb61aaac27db532bd2d105cfe8d87d1e52697", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/b0ecb61aaac27db532bd2d105cfe8d87d1e52697", "committedDate": "2020-09-02T20:49:11Z", "message": "okhttp, testing: remove server builder accessor hacks"}, "afterCommit": {"oid": "c3793c0e460b6cf7e3db4e95a984d56eb95f09b2", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/c3793c0e460b6cf7e3db4e95a984d56eb95f09b2", "committedDate": "2020-09-02T21:48:45Z", "message": "okhttp, testing: remove server builder accessor hacks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxOTA0NjI3", "url": "https://github.com/grpc/grpc-java/pull/7386#pullrequestreview-481904627", "createdAt": "2020-09-03T14:35:06Z", "commit": {"oid": "c3793c0e460b6cf7e3db4e95a984d56eb95f09b2"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNDo0MDozOFrOHMp5UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNTo1MDowOVrOHMs9Uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAzMTM3Nw==", "bodyText": "Remove unnecessary final. Ditto below.", "url": "https://github.com/grpc/grpc-java/pull/7386#discussion_r483031377", "createdAt": "2020-09-03T14:40:38Z", "author": {"login": "ejona86"}, "path": "okhttp/src/test/java/io/grpc/okhttp/OkHttpTransportTest.java", "diffHunk": "@@ -53,23 +53,21 @@ public void releaseClientFactory() {\n   @Override\n   protected List<? extends InternalServer> newServer(\n       List<ServerStreamTracer.Factory> streamTracerFactories) {\n-    return AccessProtectedHack.serverBuilderBuildTransportServer(\n-        NettyServerBuilder\n-            .forPort(0)\n-            .flowControlWindow(AbstractTransportTest.TEST_FLOW_CONTROL_WINDOW),\n-        streamTracerFactories,\n-        fakeClockTransportTracer);\n+    final NettyServerBuilder builder = NettyServerBuilder", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3793c0e460b6cf7e3db4e95a984d56eb95f09b2"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA0ODgxOA==", "bodyText": "Seems this was previously tangentally linked to metricsExpected(). Could we default to returning the value of metricsExpected()? I think very few tests would have the values be different, maybe only InProcessTest?", "url": "https://github.com/grpc/grpc-java/pull/7386#discussion_r483048818", "createdAt": "2020-09-03T15:04:01Z", "author": {"login": "ejona86"}, "path": "interop-testing/src/main/java/io/grpc/testing/integration/AbstractInteropTest.java", "diffHunk": "@@ -373,6 +357,20 @@ protected final ClientInterceptor createCensusStatsClientInterceptor() {\n                 true, true, true, false /* real-time metrics */);\n   }\n \n+  protected final ServerStreamTracer.Factory createCustomCensusTracerFactory() {\n+    return InternalCensusStatsAccessor.getServerStreamTracerFactory(\n+        tagger, tagContextBinarySerializer, serverStatsRecorder,\n+        GrpcUtil.STOPWATCH_SUPPLIER,\n+        true, true, true, false /* real-time metrics */);\n+  }\n+\n+  /**\n+   * Return {@code true} when custom census module used.\n+   */\n+  protected boolean customCensusModulePresent() {\n+    return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3793c0e460b6cf7e3db4e95a984d56eb95f09b2"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA4MDQ1OQ==", "bodyText": "If customCensusModulePresent() was not necessarily (because the default matches the stats boolean), then it would seem appropriate to remove this class and inline the calls to setStatsEnabled and addStreamTracerFactory; that's similar to what is being done on client-side.\nEven right now it's not clear this class is adding enough value for the complexity. Especially for the okhttp test extending it; it would be much better to duplicate to avoid the problem of needing to extend two classes and just to reduce surprise.", "url": "https://github.com/grpc/grpc-java/pull/7386#discussion_r483080459", "createdAt": "2020-09-03T15:48:31Z", "author": {"login": "ejona86"}, "path": "interop-testing/src/main/java/io/grpc/testing/integration/AbstractNettyInteropTest.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.testing.integration;\n+\n+import io.grpc.netty.InternalNettyServerBuilder;\n+import io.grpc.netty.NettyServerBuilder;\n+\n+public abstract class AbstractNettyInteropTest extends AbstractInteropTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3793c0e460b6cf7e3db4e95a984d56eb95f09b2"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA4MTU1NQ==", "bodyText": "This sort of method seems volatile and each time it changes it would change indentation for those builder methods. Let's just define a local variable for the builder and call withCustomCensusModule() on a separate line.", "url": "https://github.com/grpc/grpc-java/pull/7386#discussion_r483081555", "createdAt": "2020-09-03T15:50:09Z", "author": {"login": "ejona86"}, "path": "interop-testing/src/test/java/io/grpc/testing/integration/Http2NettyLocalChannelTest.java", "diffHunk": "@@ -33,19 +33,20 @@\n  * Run transport tests over the Netty in-process channel.\n  */\n @RunWith(JUnit4.class)\n-public class Http2NettyLocalChannelTest extends AbstractInteropTest {\n+public class Http2NettyLocalChannelTest extends AbstractNettyInteropTest {\n \n   private DefaultEventLoopGroup eventLoopGroup = new DefaultEventLoopGroup();\n \n   @Override\n-  protected AbstractServerImplBuilder<?> getServerBuilder() {\n-    return NettyServerBuilder\n-        .forAddress(new LocalAddress(\"in-process-1\"))\n-        .flowControlWindow(AbstractInteropTest.TEST_FLOW_CONTROL_WINDOW)\n-        .maxInboundMessageSize(AbstractInteropTest.MAX_MESSAGE_SIZE)\n-        .channelType(LocalServerChannel.class)\n-        .workerEventLoopGroup(eventLoopGroup)\n-        .bossEventLoopGroup(eventLoopGroup);\n+  protected ServerBuilder<?> getServerBuilder() {\n+    return withCustomCensusModule(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3793c0e460b6cf7e3db4e95a984d56eb95f09b2"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "66de42b7018ededb2f988f2b09ce8199342fc552", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/66de42b7018ededb2f988f2b09ce8199342fc552", "committedDate": "2020-09-03T19:06:53Z", "message": "address feedback wrt itrop tests. will be fixed up"}, "afterCommit": {"oid": "236611e6156667775fdcda09273adb93f9b4925e", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/236611e6156667775fdcda09273adb93f9b4925e", "committedDate": "2020-09-03T19:09:28Z", "message": "address feedback wrt itrop tests. will be fixed up"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMTI4ODE3", "url": "https://github.com/grpc/grpc-java/pull/7386#pullrequestreview-482128817", "createdAt": "2020-09-03T19:11:19Z", "commit": {"oid": "236611e6156667775fdcda09273adb93f9b4925e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxOToxMToxOVrOHM0EUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxOToxMToxOVrOHM0EUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE5ODAzNA==", "bodyText": "Restore original indentation.", "url": "https://github.com/grpc/grpc-java/pull/7386#discussion_r483198034", "createdAt": "2020-09-03T19:11:19Z", "author": {"login": "ejona86"}, "path": "interop-testing/src/test/java/io/grpc/testing/integration/TransportCompressionTest.java", "diffHunk": "@@ -83,21 +84,24 @@ public static void registerCompressors() {\n   }\n \n   @Override\n-  protected AbstractServerImplBuilder<?> getServerBuilder() {\n-    return NettyServerBuilder.forPort(0)\n+  protected ServerBuilder<?> getServerBuilder() {\n+    NettyServerBuilder builder = NettyServerBuilder.forPort(0)\n         .maxInboundMessageSize(AbstractInteropTest.MAX_MESSAGE_SIZE)\n         .compressorRegistry(compressors)\n         .decompressorRegistry(decompressors)\n         .intercept(new ServerInterceptor() {\n-            @Override\n-            public <ReqT, RespT> Listener<ReqT> interceptCall(ServerCall<ReqT, RespT> call,\n-                Metadata headers, ServerCallHandler<ReqT, RespT> next) {\n-              Listener<ReqT> listener = next.startCall(call, headers);\n-              // TODO(carl-mastrangelo): check that encoding was set.\n-              call.setMessageCompression(true);\n-              return listener;\n-            }\n-          });\n+          @Override\n+          public <ReqT, RespT> Listener<ReqT> interceptCall(ServerCall<ReqT, RespT> call,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "236611e6156667775fdcda09273adb93f9b4925e"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "236611e6156667775fdcda09273adb93f9b4925e", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/236611e6156667775fdcda09273adb93f9b4925e", "committedDate": "2020-09-03T19:09:28Z", "message": "address feedback wrt itrop tests. will be fixed up"}, "afterCommit": {"oid": "1fc27df5152006b213b21978c1efac203b361dc7", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/1fc27df5152006b213b21978c1efac203b361dc7", "committedDate": "2020-09-03T19:11:32Z", "message": "address feedback wrt itrop tests. will be fixed up"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1fc27df5152006b213b21978c1efac203b361dc7", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/1fc27df5152006b213b21978c1efac203b361dc7", "committedDate": "2020-09-03T19:11:32Z", "message": "address feedback wrt itrop tests. will be fixed up"}, "afterCommit": {"oid": "85158c71bd0fe9f42ce925b33d727d49660e48c0", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/85158c71bd0fe9f42ce925b33d727d49660e48c0", "committedDate": "2020-09-03T19:14:16Z", "message": "address feedback wrt itrop tests. will be fixed up"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85158c71bd0fe9f42ce925b33d727d49660e48c0", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/85158c71bd0fe9f42ce925b33d727d49660e48c0", "committedDate": "2020-09-03T19:14:16Z", "message": "address feedback wrt itrop tests. will be fixed up"}, "afterCommit": {"oid": "45702dbf8f1e344044ac9e93d052286269ebb376", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/45702dbf8f1e344044ac9e93d052286269ebb376", "committedDate": "2020-09-03T19:15:39Z", "message": "address feedback wrt itrop tests. will be fixed up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de83f81f3e388e9ad64d0e87ff3d7e5d708b6b56", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/de83f81f3e388e9ad64d0e87ff3d7e5d708b6b56", "committedDate": "2020-09-03T19:28:01Z", "message": "api, core: create ForwardingServerBuilder and ServerImplBuilder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "45702dbf8f1e344044ac9e93d052286269ebb376", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/45702dbf8f1e344044ac9e93d052286269ebb376", "committedDate": "2020-09-03T19:15:39Z", "message": "address feedback wrt itrop tests. will be fixed up"}, "afterCommit": {"oid": "90b6306f008c40e5e3a1740afa9f013d8238b83a", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/90b6306f008c40e5e3a1740afa9f013d8238b83a", "committedDate": "2020-09-03T19:28:07Z", "message": "okhttp, testing: remove server builder accessor hacks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca5f3a0f9000ba80e97c03b3d27ab1b27f744e4f", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/ca5f3a0f9000ba80e97c03b3d27ab1b27f744e4f", "committedDate": "2020-09-03T19:39:10Z", "message": "core, netty: server builders extend a public API class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e2c4604a5d4cc70f2bf29d4cec56a5db37a28d8", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/1e2c4604a5d4cc70f2bf29d4cec56a5db37a28d8", "committedDate": "2020-09-03T19:39:15Z", "message": "okhttp, testing: remove server builder accessor hacks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "90b6306f008c40e5e3a1740afa9f013d8238b83a", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/90b6306f008c40e5e3a1740afa9f013d8238b83a", "committedDate": "2020-09-03T19:28:07Z", "message": "okhttp, testing: remove server builder accessor hacks"}, "afterCommit": {"oid": "1e2c4604a5d4cc70f2bf29d4cec56a5db37a28d8", "author": {"user": {"login": "sergiitk", "name": "Sergii Tkachenko"}}, "url": "https://github.com/grpc/grpc-java/commit/1e2c4604a5d4cc70f2bf29d4cec56a5db37a28d8", "committedDate": "2020-09-03T19:39:15Z", "message": "okhttp, testing: remove server builder accessor hacks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4227, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}