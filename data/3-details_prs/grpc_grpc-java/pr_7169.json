{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxNzAwMzg2", "number": 7169, "title": "xds: parse Listener update as xDS v3 resource", "bodyText": "This is part of xDS v3 support as per go/grpc-xds-v3-support\nIn this PR:\n\nstill only send v2 requests to xDS server (No v3 bootstrap or env flag support)\nparse Listener update as v3 proto\nRefactor SDS's Listener watcher to use enovy v3 API\nstill parse other resources as v2 proto.", "createdAt": "2020-06-29T23:30:39Z", "url": "https://github.com/grpc/grpc-java/pull/7169", "merged": true, "mergeCommit": {"oid": "eaa98f8d910e691758f685bda7c121108112a9fd"}, "closed": true, "closedAt": "2020-07-06T17:25:47Z", "author": {"login": "dapengzhang0"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwJmDAgH2gAyNDQxNzAwMzg2OjBhMzE1ZDkxZDRmZjUwNjdhNzk2M2Y5NDMwNjk1ZjczOGFlZjI5NTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyUTjKgH2gAyNDQxNzAwMzg2OjhhOGU3YjY5Njg5MDJjZDFjMTU5MTc2YzM0M2M3ZjdkNmM5ZGI5YTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0a315d91d4ff5067a7963f9430695f738aef2952", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/0a315d91d4ff5067a7963f9430695f738aef2952", "committedDate": "2020-06-29T23:25:09Z", "message": "xds: parse Listener update as xds v3 resource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de976cda2df3c03f7a82680db784f8cb3a7699d5", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/de976cda2df3c03f7a82680db784f8cb3a7699d5", "committedDate": "2020-06-29T23:57:40Z", "message": "ignore UDS test for FileBasedPluginCredential"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5Nzk0MjM1", "url": "https://github.com/grpc/grpc-java/pull/7169#pullrequestreview-439794235", "createdAt": "2020-06-30T08:37:06Z", "commit": {"oid": "de976cda2df3c03f7a82680db784f8cb3a7699d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwODozNzowNlrOGqx8dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwODozNzowNlrOGqx8dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUxMTY3MA==", "bodyText": "Can you use fully qualified name for types that you want to distinguish in v2 and v3? It's hard to follow as there are some inconsistencies (e.g., constant ADS_TYPE_URL_LDS without v3 suffix refers to v2 type while Listener refers to v3 type).", "url": "https://github.com/grpc/grpc-java/pull/7169#discussion_r447511670", "createdAt": "2020-06-30T08:37:06Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -553,6 +555,9 @@ private void handleLdsResponseForConfigUpdate(DiscoveryResponse ldsResponse) {\n     List<String> listenerNames = new ArrayList<>(ldsResponse.getResourcesCount());\n     try {\n       for (com.google.protobuf.Any res : ldsResponse.getResourcesList()) {\n+        if (!res.is(Listener.class)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de976cda2df3c03f7a82680db784f8cb3a7699d5"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMTcyNjc3", "url": "https://github.com/grpc/grpc-java/pull/7169#pullrequestreview-440172677", "createdAt": "2020-06-30T16:09:33Z", "commit": {"oid": "de976cda2df3c03f7a82680db784f8cb3a7699d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNjowOTozM1rOGrDx4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNjowOTozM1rOGrDx4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgwMzg3Mw==", "bodyText": "If ADS_TYPE_URL_LDS needs to be visible for testing how come ADS_TYPE_URL_LDS_V3 doesn't need to be if the test is also migrated to v3?", "url": "https://github.com/grpc/grpc-java/pull/7169#discussion_r447803873", "createdAt": "2020-06-30T16:09:33Z", "author": {"login": "sanjaypujare"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -87,6 +87,8 @@\n \n   @VisibleForTesting\n   static final String ADS_TYPE_URL_LDS = \"type.googleapis.com/envoy.api.v2.Listener\";\n+  private static final String ADS_TYPE_URL_LDS_V3 =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de976cda2df3c03f7a82680db784f8cb3a7699d5"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMTc4ODY5", "url": "https://github.com/grpc/grpc-java/pull/7169#pullrequestreview-440178869", "createdAt": "2020-06-30T16:16:43Z", "commit": {"oid": "de976cda2df3c03f7a82680db784f8cb3a7699d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNjoxNjo0M1rOGrEFeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNjoxNjo0M1rOGrEFeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgwODg5MA==", "bodyText": "Can we change the import so we don't need the v3 fully qualified name?", "url": "https://github.com/grpc/grpc-java/pull/7169#discussion_r447808890", "createdAt": "2020-06-30T16:16:43Z", "author": {"login": "sanjaypujare"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -730,7 +738,7 @@ private boolean isRequestedListener(Listener listener) {\n         && hasMatchingFilter(listener.getFilterChainsList());\n   }\n \n-  private boolean isAddressMatching(Address address) {\n+  private boolean isAddressMatching(io.envoyproxy.envoy.config.core.v3.Address address) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de976cda2df3c03f7a82680db784f8cb3a7699d5"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMTkyNTc4", "url": "https://github.com/grpc/grpc-java/pull/7169#pullrequestreview-440192578", "createdAt": "2020-06-30T16:33:07Z", "commit": {"oid": "de976cda2df3c03f7a82680db784f8cb3a7699d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNjozMzowOFrOGrE3sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNjozMzowOFrOGrE3sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyMTc0NA==", "bodyText": "Just wondering - what is the need to keep both the v2 and v3 versions? When everything is moved to v3 are we going to remove the v2 version of the constructor?", "url": "https://github.com/grpc/grpc-java/pull/7169#discussion_r447821744", "createdAt": "2020-06-30T16:33:08Z", "author": {"login": "sanjaypujare"}, "path": "xds/src/main/java/io/grpc/xds/internal/sds/FileBasedPluginCredential.java", "diffHunk": "@@ -77,6 +78,19 @@\n     secretData = buildDataSourceFromConfigStruct(value.getStructValue());\n   }\n \n+  FileBasedPluginCredential(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de976cda2df3c03f7a82680db784f8cb3a7699d5"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMTk0NDgy", "url": "https://github.com/grpc/grpc-java/pull/7169#pullrequestreview-440194482", "createdAt": "2020-06-30T16:35:22Z", "commit": {"oid": "de976cda2df3c03f7a82680db784f8cb3a7699d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNjozNToyMlrOGrE9gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNjozNToyMlrOGrE9gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyMzIzMw==", "bodyText": "Can you comment this instead of deleting the call? Since the comment above is still there.", "url": "https://github.com/grpc/grpc-java/pull/7169#discussion_r447823233", "createdAt": "2020-06-30T16:35:22Z", "author": {"login": "sanjaypujare"}, "path": "xds/src/main/java/io/grpc/xds/internal/sds/trust/SdsX509TrustManager.java", "diffHunk": "@@ -223,15 +225,16 @@ void verifySubjectAltNameInChain(X509Certificate[] peerCertChain) throws Certifi\n     if (certContext == null) {\n       return;\n     }\n-    List<String> verifyList = certContext.getVerifySubjectAltNameList();\n+    List<StringMatcher> verifyList = certContext.getMatchSubjectAltNamesList();\n     if (verifyList.isEmpty()) {\n       return;\n     }\n     if (peerCertChain == null || peerCertChain.length < 1) {\n       throw new CertificateException(\"Peer certificate(s) missing\");\n     }\n     // verify SANs only in the top cert (leaf cert)\n-    verifySubjectAltNameInLeaf(peerCertChain[0], verifyList);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de976cda2df3c03f7a82680db784f8cb3a7699d5"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMjAyNzQ4", "url": "https://github.com/grpc/grpc-java/pull/7169#pullrequestreview-440202748", "createdAt": "2020-06-30T16:45:40Z", "commit": {"oid": "de976cda2df3c03f7a82680db784f8cb3a7699d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNjo0NTo0MFrOGrFZCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNjo0NTo0MFrOGrFZCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzMDI4MA==", "bodyText": "Good catch :-)", "url": "https://github.com/grpc/grpc-java/pull/7169#discussion_r447830280", "createdAt": "2020-06-30T16:45:40Z", "author": {"login": "sanjaypujare"}, "path": "xds/src/test/java/io/grpc/xds/EnvoyServerProtoDataTest.java", "diffHunk": "@@ -73,8 +73,7 @@ public void listener_convertFromListenerProto() throws InvalidProtocolBufferExce\n     assertThat(outFilterChainMatch.getApplicationProtocols()).isEmpty();\n     assertThat(outFilterChainMatch.getPrefixRanges()).isEmpty();\n     assertThat(outFilter.getDownstreamTlsContext())\n-        .isEqualTo(DownstreamTlsContext.fromEnvoyProtoDownstreamTlsContext(\n-                io.envoyproxy.envoy.api.v2.auth.DownstreamTlsContext.getDefaultInstance()));\n+        .isNull();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de976cda2df3c03f7a82680db784f8cb3a7699d5"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f85184c82b5ff0b110d68f2d7ce939b1f683ff50", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/f85184c82b5ff0b110d68f2d7ce939b1f683ff50", "committedDate": "2020-06-30T16:46:46Z", "message": "comment out v2 impl instead of removal"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMjA0OTI2", "url": "https://github.com/grpc/grpc-java/pull/7169#pullrequestreview-440204926", "createdAt": "2020-06-30T16:48:18Z", "commit": {"oid": "de976cda2df3c03f7a82680db784f8cb3a7699d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNjo0ODoxOFrOGrFfiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNjo0ODoxOFrOGrFfiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzMTk0Nw==", "bodyText": "Why V2 ? With all Listener related stuff migrating to v3 why can't this be v3 as well?", "url": "https://github.com/grpc/grpc-java/pull/7169#discussion_r447831947", "createdAt": "2020-06-30T16:48:18Z", "author": {"login": "sanjaypujare"}, "path": "xds/src/test/java/io/grpc/xds/EnvoyServerProtoDataTest.java", "diffHunk": "@@ -147,7 +119,8 @@ private static FilterChain createInFilter() {\n                     .addApplicationProtocols(\"managed-mtls\")\n                     .build())\n             .setTransportSocket(TransportSocket.newBuilder().setName(\"tls\")\n-                .setTypedConfig(Any.pack(CommonTlsContextTestsUtil.buildTestDownstreamTlsContext()))\n+                .setTypedConfig(\n+                    Any.pack(CommonTlsContextTestsUtil.buildTestDownstreamTlsContextV2()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de976cda2df3c03f7a82680db784f8cb3a7699d5"}, "originalPosition": 86}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18ed52d605e11f479c8f0ca1d23bc73565ca7925", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/18ed52d605e11f479c8f0ca1d23bc73565ca7925", "committedDate": "2020-06-30T16:53:09Z", "message": "make v2 identifiers explicit in code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "369305fe69fe68e08249220e7361799ad06e28a3", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/369305fe69fe68e08249220e7361799ad06e28a3", "committedDate": "2020-06-30T16:57:26Z", "message": "import v3 Address rather than v2 Address"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMjE1NjU3", "url": "https://github.com/grpc/grpc-java/pull/7169#pullrequestreview-440215657", "createdAt": "2020-06-30T17:01:13Z", "commit": {"oid": "de976cda2df3c03f7a82680db784f8cb3a7699d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNzowMToxM1rOGrGATA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNzowMToxM1rOGrGATA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0MDMzMg==", "bodyText": "Not sure I understand this. Does it need a TODO comment so this can be cleaned up later?", "url": "https://github.com/grpc/grpc-java/pull/7169#discussion_r447840332", "createdAt": "2020-06-30T17:01:13Z", "author": {"login": "sanjaypujare"}, "path": "xds/src/test/java/io/grpc/xds/XdsClientImplTest.java", "diffHunk": "@@ -1435,6 +1435,7 @@ public void cdsResponseWithUpstreamTlsContext() {\n     StreamObserver<DiscoveryRequest> requestObserver = requestObservers.poll();\n \n     // Management server sends back CDS response with UpstreamTlsContext.\n+    // Server still using envoy API V2.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de976cda2df3c03f7a82680db784f8cb3a7699d5"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5c8efdb04d0d38faf70a431d8d9fbd33b5cc64a", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/c5c8efdb04d0d38faf70a431d8d9fbd33b5cc64a", "committedDate": "2020-06-30T17:03:34Z", "message": "use v3 DownstreamTlsContext for EnvoyServerProtoDataTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f32fb0eec0589cd4d606418de35ca2a85cfb855", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/6f32fb0eec0589cd4d606418de35ca2a85cfb855", "committedDate": "2020-06-30T17:14:27Z", "message": "remove misleading comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTAyODU4", "url": "https://github.com/grpc/grpc-java/pull/7169#pullrequestreview-441102858", "createdAt": "2020-07-01T18:26:23Z", "commit": {"oid": "6f32fb0eec0589cd4d606418de35ca2a85cfb855"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODoyNjoyNFrOGrw2kQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODoyNjoyNFrOGrw2kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MjM1Mw==", "bodyText": "Looking at the latest findings in #7166 (comment) where we will use match_subject_alt_names with EXACT_MATCH most of these tests will be applicable (after making the change). Would it be better to @Ignore them instead of just deleting them?", "url": "https://github.com/grpc/grpc-java/pull/7169#discussion_r448542353", "createdAt": "2020-07-01T18:26:24Z", "author": {"login": "sanjaypujare"}, "path": "xds/src/test/java/io/grpc/xds/internal/sds/trust/SdsX509TrustManagerTest.java", "diffHunk": "@@ -84,180 +83,6 @@ public void emptySanListContextTest() throws CertificateException, IOException {\n     trustManager.verifySubjectAltNameInChain(certs);\n   }\n \n-  @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f32fb0eec0589cd4d606418de35ca2a85cfb855"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTI2NjU4", "url": "https://github.com/grpc/grpc-java/pull/7169#pullrequestreview-441126658", "createdAt": "2020-07-01T19:04:36Z", "commit": {"oid": "6f32fb0eec0589cd4d606418de35ca2a85cfb855"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOTowNDozN1rOGrx_Sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOTowNDozN1rOGrx_Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2MDk3MQ==", "bodyText": "With the import this type doesn't need to be fully qualified, correct?", "url": "https://github.com/grpc/grpc-java/pull/7169#discussion_r448560971", "createdAt": "2020-07-01T19:04:37Z", "author": {"login": "sanjaypujare"}, "path": "xds/src/test/java/io/grpc/xds/internal/sds/CommonTlsContextTestsUtil.java", "diffHunk": "@@ -48,18 +53,83 @@\n   public static final String BAD_CLIENT_PEM_FILE = \"badclient.pem\";\n   public static final String BAD_CLIENT_KEY_FILE = \"badclient.key\";\n \n-  static SdsSecretConfig buildSdsSecretConfig(String name, String targetUri, String channelType) {\n-    SdsSecretConfig sdsSecretConfig = null;\n+  static io.envoyproxy.envoy.api.v2.auth.SdsSecretConfig buildSdsSecretConfigV2(\n+      String name, String targetUri, String channelType) {\n+    io.envoyproxy.envoy.api.v2.auth.SdsSecretConfig sdsSecretConfig = null;\n     if (!Strings.isNullOrEmpty(name) && !Strings.isNullOrEmpty(targetUri)) {\n       sdsSecretConfig =\n-          SdsSecretConfig.newBuilder()\n+          io.envoyproxy.envoy.api.v2.auth.SdsSecretConfig.newBuilder()\n               .setName(name)\n-              .setSdsConfig(SdsClientTest.buildConfigSource(targetUri, channelType))\n+              .setSdsConfig(buildConfigSourceV2(targetUri, channelType))\n               .build();\n     }\n     return sdsSecretConfig;\n   }\n \n+  private static io.envoyproxy.envoy.extensions.transport_sockets.tls.v3.SdsSecretConfig", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f32fb0eec0589cd4d606418de35ca2a85cfb855"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTM1MTEw", "url": "https://github.com/grpc/grpc-java/pull/7169#pullrequestreview-441135110", "createdAt": "2020-07-01T19:18:59Z", "commit": {"oid": "6f32fb0eec0589cd4d606418de35ca2a85cfb855"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOToxODo1OVrOGryZhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOToxODo1OVrOGryZhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2NzY4NA==", "bodyText": "A high level comment about tests. So by renaming ADS_TYPE_URL_LDS to ADS_TYPE_URL_LDS_v2 we are only testing/validating v2 responses. What about testing v3 responses? Is there a separate PR for it or a TODO comment to indicate it needs to be done?", "url": "https://github.com/grpc/grpc-java/pull/7169#discussion_r448567684", "createdAt": "2020-07-01T19:18:59Z", "author": {"login": "sanjaypujare"}, "path": "xds/src/test/java/io/grpc/xds/XdsClientImplTest.java", "diffHunk": "@@ -336,7 +336,7 @@ public void ldsResponseWithoutMatchingResource() {\n     // Client sends an LDS request for the host name (with port) to management server.\n     verify(requestObserver)\n         .onNext(eq(buildDiscoveryRequest(NODE, \"\", TARGET_AUTHORITY,\n-            XdsClientImpl.ADS_TYPE_URL_LDS, \"\")));\n+            XdsClientImpl.ADS_TYPE_URL_LDS_v2, \"\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f32fb0eec0589cd4d606418de35ca2a85cfb855"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTU2ODkz", "url": "https://github.com/grpc/grpc-java/pull/7169#pullrequestreview-441156893", "createdAt": "2020-07-01T19:56:29Z", "commit": {"oid": "6f32fb0eec0589cd4d606418de35ca2a85cfb855"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOTo1NjoyOVrOGrzcRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOTo1NjoyOVrOGrzcRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4NDc3NA==", "bodyText": "Is the lowercase v2 intended or typo? A const literal should be all uppercase, right? Same thing for other _v2 literals below.", "url": "https://github.com/grpc/grpc-java/pull/7169#discussion_r448584774", "createdAt": "2020-07-01T19:56:29Z", "author": {"login": "sanjaypujare"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -86,7 +86,9 @@\n   static final int INITIAL_RESOURCE_FETCH_TIMEOUT_SEC = 15;\n \n   @VisibleForTesting\n-  static final String ADS_TYPE_URL_LDS = \"type.googleapis.com/envoy.api.v2.Listener\";\n+  static final String ADS_TYPE_URL_LDS_v2 = \"type.googleapis.com/envoy.api.v2.Listener\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f32fb0eec0589cd4d606418de35ca2a85cfb855"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTY2MTUz", "url": "https://github.com/grpc/grpc-java/pull/7169#pullrequestreview-441166153", "createdAt": "2020-07-01T20:12:37Z", "commit": {"oid": "6f32fb0eec0589cd4d606418de35ca2a85cfb855"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMDoxMjozOFrOGrz4EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMDoxMjozOFrOGrz4EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU5MTg4OQ==", "bodyText": "Couple of things:\n\nbased on https://github.com/envoyproxy/envoy/blob/master/api/envoy/service/discovery/v3/discovery.proto#L97 which says \"Type URL ... Must be consistent with the type_url in the 'resources' repeated Any\". Should we have that check here now that v2 and v3 are the 2 possibilities?\nshouldn't the typeUrl in ACK/NACK match what was there in the response? I think it is possible that the client asks for v3 in the request but the response comes back with v2. In that case should ACK/NACK match the typeUrl of the original request or the response?", "url": "https://github.com/grpc/grpc-java/pull/7169#discussion_r448591889", "createdAt": "2020-07-01T20:12:38Z", "author": {"login": "sanjaypujare"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -553,14 +555,17 @@ private void handleLdsResponseForConfigUpdate(DiscoveryResponse ldsResponse) {\n     List<String> listenerNames = new ArrayList<>(ldsResponse.getResourcesCount());\n     try {\n       for (com.google.protobuf.Any res : ldsResponse.getResourcesList()) {\n+        if (res.getTypeUrl().equals(ADS_TYPE_URL_LDS_v2)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f32fb0eec0589cd4d606418de35ca2a85cfb855"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTY3MTgw", "url": "https://github.com/grpc/grpc-java/pull/7169#pullrequestreview-441167180", "createdAt": "2020-07-01T20:14:28Z", "commit": {"oid": "6f32fb0eec0589cd4d606418de35ca2a85cfb855"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMDoxNDoyOVrOGrz7Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMDoxNDoyOVrOGrz7Vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU5MjcyNg==", "bodyText": "My comment above about v2 vs v3. For now this is okay but when the v3 migration is complete and our request uses v3 typeUrl should we analyze the responses for v2 vs v3 typeUrl and use that for resource validation and also subsequent ACK/NACK?", "url": "https://github.com/grpc/grpc-java/pull/7169#discussion_r448592726", "createdAt": "2020-07-01T20:14:29Z", "author": {"login": "sanjaypujare"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -553,14 +555,17 @@ private void handleLdsResponseForConfigUpdate(DiscoveryResponse ldsResponse) {\n     List<String> listenerNames = new ArrayList<>(ldsResponse.getResourcesCount());\n     try {\n       for (com.google.protobuf.Any res : ldsResponse.getResourcesList()) {\n+        if (res.getTypeUrl().equals(ADS_TYPE_URL_LDS_v2)) {\n+          res = res.toBuilder().setTypeUrl(ADS_TYPE_URL_LDS).build();\n+        }\n         Listener listener = res.unpack(Listener.class);\n         listeners.add(listener);\n         listenerNames.add(listener.getName());\n       }\n     } catch (InvalidProtocolBufferException e) {\n       logger.log(XdsLogLevel.WARNING, \"Failed to unpack Listeners in LDS response {0}\", e);\n       adsStream.sendNackRequest(\n-          ADS_TYPE_URL_LDS, ImmutableList.of(ldsResourceName),\n+          ADS_TYPE_URL_LDS_v2, ImmutableList.of(ldsResourceName),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f32fb0eec0589cd4d606418de35ca2a85cfb855"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e760d36e065765f36b44cad1fe2521213e548a4", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/8e760d36e065765f36b44cad1fe2521213e548a4", "committedDate": "2020-07-01T21:06:56Z", "message": "address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjE1MDY5", "url": "https://github.com/grpc/grpc-java/pull/7169#pullrequestreview-441215069", "createdAt": "2020-07-01T21:41:36Z", "commit": {"oid": "8e760d36e065765f36b44cad1fe2521213e548a4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo0MTozN1rOGr2RYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo0MTozN1rOGr2RYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMTEzOQ==", "bodyText": "Is this trick really gonna work?", "url": "https://github.com/grpc/grpc-java/pull/7169#discussion_r448631139", "createdAt": "2020-07-01T21:41:37Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -553,14 +555,17 @@ private void handleLdsResponseForConfigUpdate(DiscoveryResponse ldsResponse) {\n     List<String> listenerNames = new ArrayList<>(ldsResponse.getResourcesCount());\n     try {\n       for (com.google.protobuf.Any res : ldsResponse.getResourcesList()) {\n+        if (res.getTypeUrl().equals(ADS_TYPE_URL_LDS_V2)) {\n+          res = res.toBuilder().setTypeUrl(ADS_TYPE_URL_LDS).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e760d36e065765f36b44cad1fe2521213e548a4"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNTY3MzUx", "url": "https://github.com/grpc/grpc-java/pull/7169#pullrequestreview-442567351", "createdAt": "2020-07-03T22:06:36Z", "commit": {"oid": "8e760d36e065765f36b44cad1fe2521213e548a4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QyMjowNjozNlrOGs4NHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QyMjowNjozNlrOGs4NHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcxMTM4OA==", "bodyText": "I didn't see the correspnding v3 import for CombinedCertificateValidationContext. It will be good to have that", "url": "https://github.com/grpc/grpc-java/pull/7169#discussion_r449711388", "createdAt": "2020-07-03T22:06:36Z", "author": {"login": "sanjaypujare"}, "path": "xds/src/test/java/io/grpc/xds/internal/sds/CommonTlsContextTestsUtil.java", "diffHunk": "@@ -18,14 +18,19 @@\n \n import com.google.common.base.Strings;\n import com.google.protobuf.BoolValue;\n-import io.envoyproxy.envoy.api.v2.auth.CertificateValidationContext;\n-import io.envoyproxy.envoy.api.v2.auth.CommonTlsContext;\n-import io.envoyproxy.envoy.api.v2.auth.CommonTlsContext.CombinedCertificateValidationContext;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e760d36e065765f36b44cad1fe2521213e548a4"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNTY3ODEx", "url": "https://github.com/grpc/grpc-java/pull/7169#pullrequestreview-442567811", "createdAt": "2020-07-03T22:11:02Z", "commit": {"oid": "8e760d36e065765f36b44cad1fe2521213e548a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a8e7b6968902cd1c159176c343c7f7d6c9db9a6", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/8a8e7b6968902cd1c159176c343c7f7d6c9db9a6", "committedDate": "2020-07-06T17:01:45Z", "message": "import v3.CommonTlsContext.CombinedCertificateValidationContext"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4279, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}