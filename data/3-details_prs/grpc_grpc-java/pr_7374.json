{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1MDEyNTQw", "number": 7374, "title": "core: refactor handle config update with ConfigSelector", "bodyText": "Get rid of ServiceConfigInterceptor and handle config update with ConfigSelector inside ClientCallImpl.\nTests will pass once #7362 is merged.", "createdAt": "2020-08-28T00:06:26Z", "url": "https://github.com/grpc/grpc-java/pull/7374", "merged": true, "mergeCommit": {"oid": "f3a1a3ff10ee07383aad3a51afb3fbbc7fe3d0db"}, "closed": true, "closedAt": "2020-09-10T17:32:47Z", "author": {"login": "dapengzhang0"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDJlbTABqjM3MDE4NDYwNTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHkCe8AFqTQ4NjE0NTgzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "042800a2c8004fddcbb157d8c7be8c6663c25a9f", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/042800a2c8004fddcbb157d8c7be8c6663c25a9f", "committedDate": "2020-08-28T00:04:51Z", "message": "core: refactor handle config update with ConfigSelector"}, "afterCommit": {"oid": "869a0030297912700627591561dd55e29fad5167", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/869a0030297912700627591561dd55e29fad5167", "committedDate": "2020-08-28T00:08:46Z", "message": "core: refactor handle config update with ConfigSelector"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87f9b58b70b5ba84c700bf1bc3790a188ae82945", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/87f9b58b70b5ba84c700bf1bc3790a188ae82945", "committedDate": "2020-08-28T00:21:57Z", "message": "core: refactor handle config update with ConfigSelector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "869a0030297912700627591561dd55e29fad5167", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/869a0030297912700627591561dd55e29fad5167", "committedDate": "2020-08-28T00:08:46Z", "message": "core: refactor handle config update with ConfigSelector"}, "afterCommit": {"oid": "87f9b58b70b5ba84c700bf1bc3790a188ae82945", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/87f9b58b70b5ba84c700bf1bc3790a188ae82945", "committedDate": "2020-08-28T00:21:57Z", "message": "core: refactor handle config update with ConfigSelector"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99fd45e328682097c83fd6d7037474fdc407d97c", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/99fd45e328682097c83fd6d7037474fdc407d97c", "committedDate": "2020-09-03T23:45:38Z", "message": "test configSelector for ClientCallImpl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e51d709413955fafd0cf91a41494b6691a0b1631", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/e51d709413955fafd0cf91a41494b6691a0b1631", "committedDate": "2020-09-03T23:45:38Z", "message": "ManagedChannelServiceConfigTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "608e2301aba5e49fd9adafc55621bd9e5ce14c80", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/608e2301aba5e49fd9adafc55621bd9e5ce14c80", "committedDate": "2020-09-03T23:45:38Z", "message": "test method config propagated to new call"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MTk0NDI1", "url": "https://github.com/grpc/grpc-java/pull/7374#pullrequestreview-485194425", "createdAt": "2020-09-09T16:27:32Z", "commit": {"oid": "608e2301aba5e49fd9adafc55621bd9e5ce14c80"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNjoyNzozMlrOHPP20g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNjo0OToyOVrOHPQ_QA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc1MDQ4Mg==", "bodyText": "As discussed previously, let's keep this interface the same and pass the MethodInfo via CallOptions. (It is fine to continue using the separate keys like RETRY_POLICY_KEY for this PR, but long-term we'll swap to a single call option.)", "url": "https://github.com/grpc/grpc-java/pull/7374#discussion_r485750482", "createdAt": "2020-09-09T16:27:32Z", "author": {"login": "ejona86"}, "path": "core/src/main/java/io/grpc/internal/ClientCallImpl.java", "diffHunk": "@@ -154,7 +160,8 @@ ClientStream newStream(\n         MethodDescriptor<?, ?> method,\n         CallOptions callOptions,\n         Metadata headers,\n-        Context context);\n+        Context context,\n+        @Nullable MethodInfo methodInfo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "608e2301aba5e49fd9adafc55621bd9e5ce14c80"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc2MTUxMw==", "bodyText": "Why not use this? Was this from an earlier revision and wasn't updated?", "url": "https://github.com/grpc/grpc-java/pull/7374#discussion_r485761513", "createdAt": "2020-09-09T16:40:15Z", "author": {"login": "ejona86"}, "path": "core/src/main/java/io/grpc/internal/ManagedChannelServiceConfig.java", "diffHunk": "@@ -162,28 +164,37 @@ static ManagedChannelServiceConfig fromServiceConfig(\n             healthCheckingConfig);\n   }\n \n-  /**\n-   * Returns the per-service configuration for the channel.\n-   */\n-  Map<String, MethodInfo> getServiceMap() {\n-    return serviceMap;\n-  }\n-\n   @Nullable\n   Map<String, ?> getHealthCheckingConfig() {\n     return healthCheckingConfig;\n   }\n \n   /**\n-   * Returns the per-method configuration for the channel.\n+   * Used as a fallback per-RPC config supplier when the attributes value of {@link\n+   * InternalConfigSelector#KEY} is not available.\n    */\n-  Map<String, MethodInfo> getServiceMethodMap() {\n-    return serviceMethodMap;\n-  }\n-\n   @Nullable\n-  MethodInfo getDefaultMethodConfig() {\n-    return defaultMethodConfig;\n+  InternalConfigSelector getDefaultConfigSelector() {\n+    if (serviceMap.isEmpty() && serviceMethodMap.isEmpty() && defaultMethodConfig == null) {\n+      return null;\n+    }\n+    return new InternalConfigSelector() {\n+      @Override\n+      public Result selectConfig(PickSubchannelArgs args) {\n+        MethodInfo methodInfo = getMethodConfig(args.getMethodDescriptor());\n+        return Result.newBuilder()\n+            .setConfig(\n+                new ManagedChannelServiceConfig(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "608e2301aba5e49fd9adafc55621bd9e5ce14c80"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc2OTAyNA==", "bodyText": "I'm not wild about this channel logging, as it seems like spam and is unlikely to help notice a bug. But we can leave it for now and remove it if it becomes a problem.", "url": "https://github.com/grpc/grpc-java/pull/7374#discussion_r485769024", "createdAt": "2020-09-09T16:49:29Z", "author": {"login": "ejona86"}, "path": "core/src/main/java/io/grpc/internal/ManagedChannelImpl.java", "diffHunk": "@@ -1535,16 +1524,26 @@ public void run() {\n                   ChannelLogLevel.INFO,\n                   \"Config selector from name resolver discarded by channel settings\");\n             }\n-            configSelector.set(null);\n+            configSelector.set(effectiveServiceConfig.getDefaultConfigSelector());\n           } else {\n             // Try to use config if returned from name resolver\n             // Otherwise, try to use the default config if available\n             if (validServiceConfig != null) {\n               effectiveServiceConfig = validServiceConfig;\n-              configSelector.set(resolvedConfigSelector);\n+              if (resolvedConfigSelector != null) {\n+                configSelector.set(resolvedConfigSelector);\n+                if (effectiveServiceConfig.getDefaultConfigSelector() != null) {\n+                  channelLogger.log(\n+                      ChannelLogLevel.INFO,\n+                      \"Method configs in service config will be discarded due to presence of\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "608e2301aba5e49fd9adafc55621bd9e5ce14c80"}, "originalPosition": 110}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "385ccf6e1dbef7b833c1b25e2d16cf4f1933881c", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/385ccf6e1dbef7b833c1b25e2d16cf4f1933881c", "committedDate": "2020-09-09T18:36:48Z", "message": "change ChannelLogLevel.INFO to DEBUG"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4628d10a8ffc35c005afc899d094ff6613ec3893", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/4628d10a8ffc35c005afc899d094ff6613ec3893", "committedDate": "2020-09-09T18:58:26Z", "message": "propagate MethodInfo via CallOptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cf90ae53bd7d7e6c8e04500606837464d840409", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/9cf90ae53bd7d7e6c8e04500606837464d840409", "committedDate": "2020-09-10T01:13:07Z", "message": "Merge branch 'master' of https://github.com/grpc/grpc-java into update-config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f2d239d7fb5674de643df372ffcbe7e1a6296b8", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/7f2d239d7fb5674de643df372ffcbe7e1a6296b8", "committedDate": "2020-09-10T16:21:55Z", "message": "Set Result.config to the entire service config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f43733ca6373bc8e9df1062da3c4e79088d02fd5", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/f43733ca6373bc8e9df1062da3c4e79088d02fd5", "committedDate": "2020-09-10T17:00:11Z", "message": "Revert \"Set Result.config to the entire service config\"\n\nThis reverts commit 7f2d239d7fb5674de643df372ffcbe7e1a6296b8."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e56e773242c393adb16752c697cbbfc41f6e387c", "author": {"user": {"login": "dapengzhang0", "name": "ZHANG Dapeng"}}, "url": "https://github.com/grpc/grpc-java/commit/e56e773242c393adb16752c697cbbfc41f6e387c", "committedDate": "2020-09-10T17:07:52Z", "message": "Set Result.config to the entire service config bug keep optimization for null config selector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MTQ1ODM4", "url": "https://github.com/grpc/grpc-java/pull/7374#pullrequestreview-486145838", "createdAt": "2020-09-10T17:14:00Z", "commit": {"oid": "e56e773242c393adb16752c697cbbfc41f6e387c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4219, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}