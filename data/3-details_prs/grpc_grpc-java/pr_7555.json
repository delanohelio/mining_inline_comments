{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwMzc3OTg0", "number": 7555, "title": "xds: make stats objects thread-safe", "bodyText": "A LoadStatsStore instance will be used for tracking stats for a global cluster, and multiple client channel may retrieve the same instance for recording loads sent to the same global cluster.\nClientLoadCounter is already thread-safe for recording loads, mostly are just document improvements.", "createdAt": "2020-10-27T00:03:51Z", "url": "https://github.com/grpc/grpc-java/pull/7555", "merged": true, "mergeCommit": {"oid": "351d4b4d0fd3ca544c80bcb5ac55dbff56f8f387"}, "closed": true, "closedAt": "2020-10-28T19:40:08Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWdZXFgH2gAyNTEwMzc3OTg0OmZjMWIyNjM5MzBhZTgzMDJhMzk1N2Q2YjRkY2YwNzc0NTUzNjgxOWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXC1JKgFqTUxOTAxODY1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fc1b263930ae8302a3957d6b4dcf07745536819f", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/fc1b263930ae8302a3957d6b4dcf07745536819f", "committedDate": "2020-10-26T23:58:31Z", "message": "Document thread safety of ClientLoadCounter properly."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "841d0c7a0ae7ce0cf028137d69793e40184f5cf0", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/841d0c7a0ae7ce0cf028137d69793e40184f5cf0", "committedDate": "2020-10-27T00:07:05Z", "message": "LoadStatsStore instance should be thead-safe as it is used for global clusters."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da89d0d3cea10f7f84a47ed5e517843643f87f08", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/da89d0d3cea10f7f84a47ed5e517843643f87f08", "committedDate": "2020-10-26T23:59:10Z", "message": "LoadStatsStore instance should be thead-safe as it is used for global clusters."}, "afterCommit": {"oid": "841d0c7a0ae7ce0cf028137d69793e40184f5cf0", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/841d0c7a0ae7ce0cf028137d69793e40184f5cf0", "committedDate": "2020-10-27T00:07:05Z", "message": "LoadStatsStore instance should be thead-safe as it is used for global clusters."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "563a26a541c98010a1ec536a483c24ffdc0111a4", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/563a26a541c98010a1ec536a483c24ffdc0111a4", "committedDate": "2020-10-27T09:16:09Z", "message": "Fix modifying map in the loop issue."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDIyNzgx", "url": "https://github.com/grpc/grpc-java/pull/7555#pullrequestreview-518022781", "createdAt": "2020-10-27T18:32:59Z", "commit": {"oid": "563a26a541c98010a1ec536a483c24ffdc0111a4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODozMjo1OVrOHpLGug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODo0MDoxNlrOHpLXUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkzNTYxMA==", "bodyText": "What about declare it as a synchronized method instead of requiring serializing externally?", "url": "https://github.com/grpc/grpc-java/pull/7555#discussion_r512935610", "createdAt": "2020-10-27T18:32:59Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/ClientLoadCounter.java", "diffHunk": "@@ -83,6 +83,8 @@ void recordMetric(String name, double value) {\n   /**\n    * Generates a snapshot for load stats recorded in this counter for the interval between calls\n    * of this method.\n+   *\n+   * <p>Calls to this method must be serialized externally.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563a26a541c98010a1ec536a483c24ffdc0111a4"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkzOTg1OQ==", "bodyText": "Why remove this? Seems not correct. It needs be thread-safe.", "url": "https://github.com/grpc/grpc-java/pull/7555#discussion_r512939859", "createdAt": "2020-10-27T18:40:16Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/LoadStatsManager.java", "diffHunk": "@@ -119,43 +119,41 @@ void removeLoadStats(String cluster, @Nullable String clusterService) {\n     return res;\n   }\n \n+  // Introduced for testing.\n   @VisibleForTesting\n   interface LoadStatsStoreFactory {\n     LoadStatsStore newLoadStatsStore(String cluster, String clusterService);\n   }\n \n   /**\n-   * Interface for client side load stats store. An {@code LoadStatsStore} maintains load stats per\n-   * cluster:cluster_service exposed by traffic director from a gRPC client's perspective,\n-   * including dropped calls. Load stats for endpoints are aggregated in locality granularity\n-   * while the numbers of dropped calls are aggregated in cluster:cluster_service granularity.\n+   * Interface for client side load stats store. A {@link LoadStatsStore} instance holds the load\n+   * stats for a cluster from an gRPC client's perspective by maintaining a set of locality\n+   * counters for each locality it is tracking loads for.\n    */\n   interface LoadStatsStore {\n \n     /**\n      * Generates a report based on recorded load stats (including RPC counts, backend metrics and\n      * dropped calls) for the interval since the previous call of this method.\n      */\n-    // TODO(chengyuanzhang): do not use proto type directly.\n     ClusterStats generateLoadReport();\n \n     /**\n-     * Track load stats for endpoints in the provided locality. Only load stats for endpoints\n-     * in tracked localities will be included in generated load reports.\n+     * Adds tracking for load stats sent to the given {@code locality}. Returns the counter\n+     * object responsible for tracking the client load stats to the given {@code locality}.\n+     * Only load stats for tracked localities will be included in generated load reports.\n      */\n     ClientLoadCounter addLocality(Locality locality);\n \n     /**\n-     * Drop tracking load stats for endpoints in the provided locality. Load stats for endpoints\n-     * in removed localities will no longer be included in future generated load reports after\n+     * Drops tracking for load stats sent to the given {@code locality}. Load stats for removed\n+     * localities will no longer be included in future generated load reports after\n      * their currently recording stats have been fully reported.\n      */\n     void removeLocality(Locality locality);\n \n     /**\n      * Records a drop decision.\n-     *\n-     * <p>This method is thread-safe.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563a26a541c98010a1ec536a483c24ffdc0111a4"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e9a2ae9dc9face7333a8676094077b88ef772cf", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/1e9a2ae9dc9face7333a8676094077b88ef772cf", "committedDate": "2020-10-27T22:46:33Z", "message": "Update doc to specify thread-safety."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "997fc180834a6bfc6693d0f11716f7a09853d132", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/997fc180834a6bfc6693d0f11716f7a09853d132", "committedDate": "2020-10-27T22:51:30Z", "message": "Make ClientLoadCounter completely thread-safe and improve its annotations for thread-safety."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MDE4NjUz", "url": "https://github.com/grpc/grpc-java/pull/7555#pullrequestreview-519018653", "createdAt": "2020-10-28T19:35:21Z", "commit": {"oid": "997fc180834a6bfc6693d0f11716f7a09853d132"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3943, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}