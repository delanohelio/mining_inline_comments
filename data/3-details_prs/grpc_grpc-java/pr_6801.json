{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzODE2MzIy", "number": 6801, "title": "xds: add support for server side Listener watcher in XdsClient", "bodyText": "", "createdAt": "2020-03-04T19:34:09Z", "url": "https://github.com/grpc/grpc-java/pull/6801", "merged": true, "mergeCommit": {"oid": "46eac47efcbb25f6556994c8f4ad969f2de44413"}, "closed": true, "closedAt": "2020-03-11T15:27:27Z", "author": {"login": "sanjaypujare"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcLJcoWAFqTM3MDY1NTMyMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMiTF8AFqTM3MjUzMjk5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNjU1MzIw", "url": "https://github.com/grpc/grpc-java/pull/6801#pullrequestreview-370655320", "createdAt": "2020-03-06T22:05:22Z", "commit": {"oid": "f4c081008900d072be9e480d046977fa8863c29b"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMjowNToyM1rOFzI2lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDoxODoxMFrOFzLCRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE2Njc0MQ==", "bodyText": "nit: you can use MoreObjects.toStringHelper.", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389166741", "createdAt": "2020-03-06T22:05:23Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClient.java", "diffHunk": "@@ -352,6 +352,51 @@ EndpointUpdate build() {\n     }\n   }\n \n+  /**\n+   * Updates via resource discovery RPCs using LDS. Includes {@link Listener} object containing\n+   * config for security, RBAC or other server side features such as rate limit.\n+   */\n+  static final class ListenerUpdate {\n+    private final Listener listener;\n+\n+    private ListenerUpdate(Listener listener) {\n+      this.listener = listener;\n+    }\n+\n+    public Listener getListener() {\n+      return listener;\n+    }\n+\n+    @Override\n+    public String toString() {\n+      return \"ListenerUpdate{\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c081008900d072be9e480d046977fa8863c29b"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE3NjMzMw==", "bodyText": "nit: it's safest to initialize with private int port = -1;", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389176333", "createdAt": "2020-03-06T22:33:17Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -164,6 +170,12 @@\n   @Nullable\n   private String ldsResourceName;\n \n+  // only a ConfigWatcher or ListenerWatcher can be registered.\n+  @Nullable\n+  private ListenerWatcher listenerWatcher;\n+  // port of the listener that server builder is targeting for.\n+  private int port;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c081008900d072be9e480d046977fa8863c29b"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5MjI2Mw==", "bodyText": "I do not have the knowledge of design. But you are forwarding a complex structure Listener to gRPC, which seems very unnecessary. You could make the converted data as flat as possible. That's another reason to use converted data instead of proto.\nFrom existing code I see, I think at least the layer of this Listener encapsulation is redundant.\nclass ListenerUpdate {\n  private String listenerName;\n  private String listeningAddr;\n  private List<FilterChain> filterChains;\n}\nI don't know whether FilterChain can be further flattened or not depending on your design.", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389192263", "createdAt": "2020-03-06T23:29:13Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClient.java", "diffHunk": "@@ -352,6 +352,51 @@ EndpointUpdate build() {\n     }\n   }\n \n+  /**\n+   * Updates via resource discovery RPCs using LDS. Includes {@link Listener} object containing\n+   * config for security, RBAC or other server side features such as rate limit.\n+   */\n+  static final class ListenerUpdate {\n+    private final Listener listener;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c081008900d072be9e480d046977fa8863c29b"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NTMwNQ==", "bodyText": "nit: The added comment is redundant. It only adds confusion. You can just put it in updateNodeMetadataForListenerRequest method.", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389195305", "createdAt": "2020-03-06T23:42:28Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -99,8 +104,9 @@\n   private final Stopwatch adsStreamRetryStopwatch;\n   // The node identifier to be included in xDS requests. Management server only requires the\n   // first request to carry the node identifier on a stream. It should be identical if present\n-  // more than once.\n-  private final Node node;\n+  // more than once. In case of Listener watcher metadata will be updated to include specific", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c081008900d072be9e480d046977fa8863c29b"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NTg2MQ==", "bodyText": "You can just call with empty list (e.g., Collections.emptyList()) so that you don't need to any special logic in sendXXXRequest() method.", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389195861", "createdAt": "2020-03-06T23:45:00Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -414,6 +427,39 @@ void cancelEndpointDataWatch(String clusterName, EndpointWatcher watcher) {\n     }\n   }\n \n+  @Override\n+  void watchListenerData(int port, ListenerWatcher watcher) {\n+    checkState(configWatcher == null, \"ConfigWatcher for %s already registered\", hostName);\n+    checkState(listenerWatcher == null, \"ListenerWatcher already registered\");\n+    listenerWatcher = checkNotNull(watcher, \"watcher\");\n+    checkState(port > 0, \"port needs to be > 0\");\n+    this.port = port;\n+    logger.log(XdsLogLevel.INFO, \"Started watching listener for port {0}\", port);\n+    if (rpcRetryTimer != null && rpcRetryTimer.isPending()) {\n+      // Currently in retry backoff.\n+      return;\n+    }\n+    if (adsStream == null) {\n+      startRpcStream();\n+    }\n+    updateNodeMetadataForListenerRequest(port);\n+    adsStream.sendXdsRequest(ADS_TYPE_URL_LDS, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c081008900d072be9e480d046977fa8863c29b"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjUwMA==", "bodyText": "Let's make this more elegant. Put the logic of unpacking Listeners and selecting the requested Listener in handleLdsResponse(). Then branching into different helper methods for processing different data.\nvoid handleLdsResponse(DiscoverResponse ldsResponse) {\n  checkState((configWatcher != null) != (listenerWatcher != null), ...);  // XOR\n  Listener requestedListener = null;\n  // unpack Listeners and choose the only one that we are interested in.\n  // ...\n  if (configWatcher != null) {\n    processListenerForConfigUpdate(requestedListener);\n  } else {\n    processListenerForListenerUpdate(requestedListener);\n  }\n}\n\nvoid processListenerForConfigUpdate(Listener listener) {\n  // ...\n}\n\nvoid processListenerForListenerUpdate(Listener listener) {\n  // ...\n}", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389202500", "createdAt": "2020-03-07T00:18:10Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -472,14 +518,19 @@ private void startRpcStream() {\n   }\n \n   /**\n-   * Handles LDS response to find the HttpConnectionManager message for the requested resource name.\n+   * If listenerWatcher is set it just calls handleLdsResponseForListener. Otherwise\n+   * handles LDS response to find the HttpConnectionManager message for the requested resource name.\n    * Proceed with the resolved RouteConfiguration in HttpConnectionManager message of the requested\n    * listener, if exists, to find the VirtualHost configuration for the \"xds:\" URI\n    * (with the port, if any, stripped off). Or sends an RDS request if configured for dynamic\n    * resolution. The response is NACKed if contains invalid data for gRPC's usage. Otherwise, an\n    * ACK request is sent to management server.\n    */\n   private void handleLdsResponse(DiscoveryResponse ldsResponse) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c081008900d072be9e480d046977fa8863c29b"}, "originalPosition": 115}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNzA3NTE2", "url": "https://github.com/grpc/grpc-java/pull/6801#pullrequestreview-370707516", "createdAt": "2020-03-07T01:13:12Z", "commit": {"oid": "f4c081008900d072be9e480d046977fa8863c29b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMToxMzoxMlrOFzLlRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMToxMzoxMlrOFzLlRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMTQ2Mw==", "bodyText": "You should revert changes made in #6718 that puts a Listener into ConfigUpdate.", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389211463", "createdAt": "2020-03-07T01:13:12Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClient.java", "diffHunk": "@@ -352,6 +352,51 @@ EndpointUpdate build() {\n     }\n   }\n \n+  /**\n+   * Updates via resource discovery RPCs using LDS. Includes {@link Listener} object containing\n+   * config for security, RBAC or other server side features such as rate limit.\n+   */\n+  static final class ListenerUpdate {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c081008900d072be9e480d046977fa8863c29b"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0746fa6df72e477067a765fd3dc82b18ec465fff", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/0746fa6df72e477067a765fd3dc82b18ec465fff", "committedDate": "2020-03-09T19:42:16Z", "message": "xds: add support for server side Listener watcher in XdsClient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0f470ba97167862db88d560954d47c983a6e260", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/d0f470ba97167862db88d560954d47c983a6e260", "committedDate": "2020-03-09T19:42:16Z", "message": "add suppress-warning for deprecation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d246e558152212be440e7eacd426697972eeec0", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/0d246e558152212be440e7eacd426697972eeec0", "committedDate": "2020-03-09T21:32:48Z", "message": "rebase and address various review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f4c081008900d072be9e480d046977fa8863c29b", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/f4c081008900d072be9e480d046977fa8863c29b", "committedDate": "2020-03-04T20:52:30Z", "message": "add suppress-warning for deprecation"}, "afterCommit": {"oid": "0d246e558152212be440e7eacd426697972eeec0", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/0d246e558152212be440e7eacd426697972eeec0", "committedDate": "2020-03-09T21:32:48Z", "message": "rebase and address various review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTYyMjg1", "url": "https://github.com/grpc/grpc-java/pull/6801#pullrequestreview-369162285", "createdAt": "2020-03-04T22:11:59Z", "commit": {"oid": "f4c081008900d072be9e480d046977fa8863c29b"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjoxMTo1OVrOFx_jlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMTo1NjoxNlrOFz6vaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2NTg0Ng==", "bodyText": "builder pattern here seems a bit overkill unless you expect to add many more fields. consider Factory?", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r387965846", "createdAt": "2020-03-04T22:11:59Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/XdsClient.java", "diffHunk": "@@ -352,6 +352,51 @@ EndpointUpdate build() {\n     }\n   }\n \n+  /**\n+   * Updates via resource discovery RPCs using LDS. Includes {@link Listener} object containing\n+   * config for security, RBAC or other server side features such as rate limit.\n+   */\n+  static final class ListenerUpdate {\n+    private final Listener listener;\n+\n+    private ListenerUpdate(Listener listener) {\n+      this.listener = listener;\n+    }\n+\n+    public Listener getListener() {\n+      return listener;\n+    }\n+\n+    @Override\n+    public String toString() {\n+      return \"ListenerUpdate{\"\n+          + \"listener=\" + listener\n+          + '}';\n+    }\n+\n+    static Builder newBuilder() {\n+      return new Builder();\n+    }\n+\n+    static final class Builder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c081008900d072be9e480d046977fa8863c29b"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2Nzk3NA==", "bodyText": "if port sounds confusing, rename to listenerPort? can remove the comment after this.", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r387967974", "createdAt": "2020-03-04T22:16:41Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -164,6 +170,12 @@\n   @Nullable\n   private String ldsResourceName;\n \n+  // only a ConfigWatcher or ListenerWatcher can be registered.\n+  @Nullable\n+  private ListenerWatcher listenerWatcher;\n+  // port of the listener that server builder is targeting for.\n+  private int port;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c081008900d072be9e480d046977fa8863c29b"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MTUxNA==", "bodyText": "2020", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r387971514", "createdAt": "2020-03-04T22:25:04Z", "author": {"login": "creamsoup"}, "path": "xds/src/test/java/io/grpc/xds/XdsClientImplTestForListener.java", "diffHunk": "@@ -0,0 +1,664 @@\n+/*\n+ * Copyright 2019 The gRPC Authors", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c081008900d072be9e480d046977fa8863c29b"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MjUxNA==", "bodyText": "ConfigWatcher error message is not very clear, can you mention only one of them can be set?", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r387972514", "createdAt": "2020-03-04T22:27:17Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -414,6 +427,39 @@ void cancelEndpointDataWatch(String clusterName, EndpointWatcher watcher) {\n     }\n   }\n \n+  @Override\n+  void watchListenerData(int port, ListenerWatcher watcher) {\n+    checkState(configWatcher == null, \"ConfigWatcher for %s already registered\", hostName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c081008900d072be9e480d046977fa8863c29b"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk3Nzc3OA==", "bodyText": "btw, you can switch template in intellij to what @voidzcy suggested.", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389977778", "createdAt": "2020-03-09T21:41:32Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/XdsClient.java", "diffHunk": "@@ -352,6 +352,51 @@ EndpointUpdate build() {\n     }\n   }\n \n+  /**\n+   * Updates via resource discovery RPCs using LDS. Includes {@link Listener} object containing\n+   * config for security, RBAC or other server side features such as rate limit.\n+   */\n+  static final class ListenerUpdate {\n+    private final Listener listener;\n+\n+    private ListenerUpdate(Listener listener) {\n+      this.listener = listener;\n+    }\n+\n+    public Listener getListener() {\n+      return listener;\n+    }\n+\n+    @Override\n+    public String toString() {\n+      return \"ListenerUpdate{\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE2Njc0MQ=="}, "originalCommit": {"oid": "f4c081008900d072be9e480d046977fa8863c29b"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk3OTAxOQ==", "bodyText": "nit: checkArgument", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389979019", "createdAt": "2020-03-09T21:44:18Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -406,6 +418,40 @@ void cancelEndpointDataWatch(String clusterName, EndpointWatcher watcher) {\n     }\n   }\n \n+  @Override\n+  void watchListenerData(int port, ListenerWatcher watcher) {\n+    checkState(configWatcher == null, \"ConfigWatcher for %s already registered\", ldsResourceName);\n+    checkState(listenerWatcher == null, \"ListenerWatcher already registered\");\n+    listenerWatcher = checkNotNull(watcher, \"watcher\");\n+    checkState(port > 0, \"port needs to be > 0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d246e558152212be440e7eacd426697972eeec0"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MDMwNg==", "bodyText": "nit: those helper methods can be static", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389980306", "createdAt": "2020-03-09T21:47:09Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -605,6 +665,72 @@ private void handleLdsResponse(DiscoveryResponse ldsResponse) {\n     }\n   }\n \n+  private void handleLdsResponseForListener(DiscoveryResponse ldsResponse) {\n+    checkState(ldsResourceName == null && port > 0 && listenerWatcher != null,\n+        \"LDS request for ListenerWatcher was never sent!\");\n+\n+    // Unpack Listener messages.\n+    Listener requestedListener = null;\n+    logger.log(XdsLogLevel.DEBUG, \"Listener count: {0}\", ldsResponse.getResourcesCount());\n+    try {\n+      for (com.google.protobuf.Any res : ldsResponse.getResourcesList()) {\n+        Listener listener = res.unpack(Listener.class);\n+        logger.log(XdsLogLevel.DEBUG, \"Found listener {0}\", listener.toString());\n+        if (isRequestedListener(listener)) {\n+          requestedListener = listener;\n+          logger.log(XdsLogLevel.DEBUG, \"Requested listener found: {0}\", listener.getName());\n+        }\n+      }\n+    } catch (InvalidProtocolBufferException e) {\n+      adsStream.sendNackRequest(ADS_TYPE_URL_LDS, null,\n+          ldsResponse.getVersionInfo(), \"Broken LDS response.\");\n+      return;\n+    }\n+    adsStream.sendAckRequest(ADS_TYPE_URL_LDS, null,\n+        ldsResponse.getVersionInfo());\n+    if (requestedListener != null) {\n+      // Found requestedListener\n+      if (ldsRespTimer != null) {\n+        ldsRespTimer.cancel();\n+        ldsRespTimer = null;\n+      }\n+      ListenerUpdate listenerUpdate = ListenerUpdate.newBuilder()\n+          .setListener(EnvoyServerProtoData.Listener.fromEnvoyProtoListener(requestedListener))\n+          .build();\n+      listenerWatcher.onListenerChanged(listenerUpdate);\n+    } else {\n+      // did not find the requested listener:\n+      if (ldsRespTimer == null) {\n+        listenerWatcher.onError(Status.NOT_FOUND.withDescription(\"did not find listener for \"\n+            + port));\n+      }\n+    }\n+  }\n+\n+  private boolean isRequestedListener(Listener listener) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d246e558152212be440e7eacd426697972eeec0"}, "originalPosition": 186}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4NDEwNA==", "bodyText": "that is very surprising, do they check internal value of proto? it will still return emptyList. maybe different type of list.", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389984104", "createdAt": "2020-03-09T21:56:16Z", "author": {"login": "creamsoup"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -414,6 +427,39 @@ void cancelEndpointDataWatch(String clusterName, EndpointWatcher watcher) {\n     }\n   }\n \n+  @Override\n+  void watchListenerData(int port, ListenerWatcher watcher) {\n+    checkState(configWatcher == null, \"ConfigWatcher for %s already registered\", hostName);\n+    checkState(listenerWatcher == null, \"ListenerWatcher already registered\");\n+    listenerWatcher = checkNotNull(watcher, \"watcher\");\n+    checkState(port > 0, \"port needs to be > 0\");\n+    this.port = port;\n+    logger.log(XdsLogLevel.INFO, \"Started watching listener for port {0}\", port);\n+    if (rpcRetryTimer != null && rpcRetryTimer.isPending()) {\n+      // Currently in retry backoff.\n+      return;\n+    }\n+    if (adsStream == null) {\n+      startRpcStream();\n+    }\n+    updateNodeMetadataForListenerRequest(port);\n+    adsStream.sendXdsRequest(ADS_TYPE_URL_LDS, null);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NTg2MQ=="}, "originalCommit": {"oid": "f4c081008900d072be9e480d046977fa8863c29b"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a23b3c4c1e7264664b64c655297ffaf84dd00d0", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/2a23b3c4c1e7264664b64c655297ffaf84dd00d0", "committedDate": "2020-03-10T00:45:39Z", "message": "address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNjE5NjY1", "url": "https://github.com/grpc/grpc-java/pull/6801#pullrequestreview-371619665", "createdAt": "2020-03-10T00:56:39Z", "commit": {"oid": "2a23b3c4c1e7264664b64c655297ffaf84dd00d0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMDo1NjozOVrOFz-Jvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMDo1NjozOVrOFz-Jvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzOTk5OQ==", "bodyText": "I am confused about this method. Isn't ldsResourceName always null when XdsClient is used to watch Listener data? Then this should just be an empty list as always. Why do we need this helper method?", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390039999", "createdAt": "2020-03-10T00:56:39Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -406,6 +417,49 @@ void cancelEndpointDataWatch(String clusterName, EndpointWatcher watcher) {\n     }\n   }\n \n+  @Override\n+  void watchListenerData(int port, ListenerWatcher watcher) {\n+    checkState(configWatcher == null,\n+        \"ListenerWatcher cannot be set when ConfigWatcher set\");\n+    checkState(listenerWatcher == null, \"ListenerWatcher already registered\");\n+    listenerWatcher = checkNotNull(watcher, \"watcher\");\n+    checkArgument(port > 0, \"port needs to be > 0\");\n+    this.listenerPort = port;\n+    logger.log(XdsLogLevel.INFO, \"Started watching listener for port {0}\", port);\n+    if (rpcRetryTimer != null && rpcRetryTimer.isPending()) {\n+      // Currently in retry backoff.\n+      return;\n+    }\n+    if (adsStream == null) {\n+      startRpcStream();\n+    }\n+    updateNodeMetadataForListenerRequest(port);\n+    adsStream.sendXdsRequest(ADS_TYPE_URL_LDS, getListOfResourceNames(ldsResourceName));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a23b3c4c1e7264664b64c655297ffaf84dd00d0"}, "originalPosition": 78}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNzE5Mzgw", "url": "https://github.com/grpc/grpc-java/pull/6801#pullrequestreview-371719380", "createdAt": "2020-03-10T07:13:15Z", "commit": {"oid": "2a23b3c4c1e7264664b64c655297ffaf84dd00d0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwNzoxMzoxNlrOF0DemQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwNzoxMzoxNlrOF0DemQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEyNzI1Nw==", "bodyText": "nit: include the exception in error message. See line 495.", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390127257", "createdAt": "2020-03-10T07:13:16Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -605,6 +673,72 @@ private void handleLdsResponse(DiscoveryResponse ldsResponse) {\n     }\n   }\n \n+  private void handleLdsResponseForListener(DiscoveryResponse ldsResponse) {\n+    checkState(ldsResourceName == null && listenerPort > 0 && listenerWatcher != null,\n+        \"LDS request for ListenerWatcher was never sent!\");\n+\n+    // Unpack Listener messages.\n+    Listener requestedListener = null;\n+    logger.log(XdsLogLevel.DEBUG, \"Listener count: {0}\", ldsResponse.getResourcesCount());\n+    try {\n+      for (com.google.protobuf.Any res : ldsResponse.getResourcesList()) {\n+        Listener listener = res.unpack(Listener.class);\n+        logger.log(XdsLogLevel.DEBUG, \"Found listener {0}\", listener.toString());\n+        if (isRequestedListener(listener)) {\n+          requestedListener = listener;\n+          logger.log(XdsLogLevel.DEBUG, \"Requested listener found: {0}\", listener.getName());\n+        }\n+      }\n+    } catch (InvalidProtocolBufferException e) {\n+      adsStream.sendNackRequest(ADS_TYPE_URL_LDS, getListOfResourceNames(null),\n+          ldsResponse.getVersionInfo(), \"Broken LDS response.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a23b3c4c1e7264664b64c655297ffaf84dd00d0"}, "originalPosition": 202}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bbf048782d3d9fc430854873b8aff68717ec7ee", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/8bbf048782d3d9fc430854873b8aff68717ec7ee", "committedDate": "2020-03-10T15:55:03Z", "message": "address more review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMTMzMDcz", "url": "https://github.com/grpc/grpc-java/pull/6801#pullrequestreview-372133073", "createdAt": "2020-03-10T16:45:02Z", "commit": {"oid": "8bbf048782d3d9fc430854873b8aff68717ec7ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjo0NTowMlrOF0XnRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjo0NTowMlrOF0XnRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1NzE1Ng==", "bodyText": "nit: this should be private", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390457156", "createdAt": "2020-03-10T16:45:02Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -406,6 +417,41 @@ void cancelEndpointDataWatch(String clusterName, EndpointWatcher watcher) {\n     }\n   }\n \n+  @Override\n+  void watchListenerData(int port, ListenerWatcher watcher) {\n+    checkState(configWatcher == null,\n+        \"ListenerWatcher cannot be set when ConfigWatcher set\");\n+    checkState(listenerWatcher == null, \"ListenerWatcher already registered\");\n+    listenerWatcher = checkNotNull(watcher, \"watcher\");\n+    checkArgument(port > 0, \"port needs to be > 0\");\n+    this.listenerPort = port;\n+    logger.log(XdsLogLevel.INFO, \"Started watching listener for port {0}\", port);\n+    if (rpcRetryTimer != null && rpcRetryTimer.isPending()) {\n+      // Currently in retry backoff.\n+      return;\n+    }\n+    if (adsStream == null) {\n+      startRpcStream();\n+    }\n+    updateNodeMetadataForListenerRequest(port);\n+    adsStream.sendXdsRequest(ADS_TYPE_URL_LDS, ImmutableList.<String>of());\n+    ldsRespTimer =\n+        syncContext\n+            .schedule(\n+                new ListenerResourceFetchTimeoutTask(\":\" + port),\n+                INITIAL_RESOURCE_FETCH_TIMEOUT_SEC, TimeUnit.SECONDS, timeService);\n+  }\n+\n+  /** In case of Listener watcher metadata to be updated to include port. */\n+  void updateNodeMetadataForListenerRequest(int port) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bbf048782d3d9fc430854873b8aff68717ec7ee"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa6df647cc431a373c60db3a57dff3ca7e570913", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/fa6df647cc431a373c60db3a57dff3ca7e570913", "committedDate": "2020-03-10T16:48:07Z", "message": "address more review comments: make private"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMTM2MjQ5", "url": "https://github.com/grpc/grpc-java/pull/6801#pullrequestreview-372136249", "createdAt": "2020-03-10T16:48:45Z", "commit": {"oid": "8bbf048782d3d9fc430854873b8aff68717ec7ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjo0ODo0NVrOF0XxRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjo0ODo0NVrOF0XxRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1OTcxNg==", "bodyText": "Why change this? When configWatcher is not null, ldsResourceName will never be null.", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390459716", "createdAt": "2020-03-10T16:48:45Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -1021,7 +1147,8 @@ private void handleEdsResponse(DiscoveryResponse edsResponse) {\n     public void run() {\n       startRpcStream();\n       if (configWatcher != null) {\n-        adsStream.sendXdsRequest(ADS_TYPE_URL_LDS, ImmutableList.of(ldsResourceName));\n+        adsStream.sendXdsRequest(ADS_TYPE_URL_LDS, ldsResourceName != null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bbf048782d3d9fc430854873b8aff68717ec7ee"}, "originalPosition": 218}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fde93b30c2a1d4f47c909accc85a40bf525e0c58", "author": {"user": {"login": "sanjaypujare", "name": null}}, "url": "https://github.com/grpc/grpc-java/commit/fde93b30c2a1d4f47c909accc85a40bf525e0c58", "committedDate": "2020-03-10T23:49:54Z", "message": "address more review comments: more listener specific code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNTMyOTk0", "url": "https://github.com/grpc/grpc-java/pull/6801#pullrequestreview-372532994", "createdAt": "2020-03-11T07:50:48Z", "commit": {"oid": "fde93b30c2a1d4f47c909accc85a40bf525e0c58"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4633, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}