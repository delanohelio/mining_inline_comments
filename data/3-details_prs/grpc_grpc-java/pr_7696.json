{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyODgxMDU3", "number": 7696, "title": "xds: support getting logical DNS and aggregate cluster configurations from CDS responses", "bodyText": "CIs should pass after #7685 as it depends on policy/config definition of ClusterResolverLoadBalancer.\nI am splitting out the part for migrating to ClusterResolverLoadBalancer as the child LB for CdsLoadBalancer to a separate PR. This PR should only change how the XdsClient parses CDS responses. It can be reviewed and merged separately. No dependency needed from #7685.", "createdAt": "2020-12-05T02:49:26Z", "url": "https://github.com/grpc/grpc-java/pull/7696", "merged": true, "mergeCommit": {"oid": "73fe68eeca461a30bbacf16fc29333bf10e55cc2"}, "closed": true, "closedAt": "2020-12-31T00:30:36Z", "author": {"login": "voidzcy"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdjC8ddAH2gAyNTMyODgxMDU3OjEzN2ZlNjVjOTQzOWEzNTg5NTI3YzJlM2UxYjU2Y2JkZGE0NDNmZWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdrVfGIgH2gAyNTMyODgxMDU3OjViY2NmNjM3YzU3NTQwN2QzNDg4NjFjMWYwYjljOTA2MDkzN2FjMDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "137fe65c9439a3589527c2e3e1b56cbdda443feb", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/137fe65c9439a3589527c2e3e1b56cbdda443feb", "committedDate": "2020-12-05T02:30:26Z", "message": "Refactor CdsUpdate definition to support logical DNS and aggregate clusters."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bb72bb17cefbfda4cb20ed7e7d6f63f190fc199", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/2bb72bb17cefbfda4cb20ed7e7d6f63f190fc199", "committedDate": "2020-12-05T02:32:18Z", "message": "Support parsing CDS responses with logical DNS and aggregate cluster tyes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1OTc3NDQ4", "url": "https://github.com/grpc/grpc-java/pull/7696#pullrequestreview-545977448", "createdAt": "2020-12-07T09:42:32Z", "commit": {"oid": "31810dbf542306d1b0e73fe37234653eadb179b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwOTo0MjozMlrOIAeC1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwOTo0MjozMlrOIAeC1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM2MzE1Ng==", "bodyText": "TODO in a separate PR: I may want to clean up other resource update data structures as well, they are too verbose to use.", "url": "https://github.com/grpc/grpc-java/pull/7696#discussion_r537363156", "createdAt": "2020-12-07T09:42:32Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/XdsClient.java", "diffHunk": "@@ -193,93 +193,19 @@ public boolean equals(Object o) {\n   }\n \n   static final class CdsUpdate implements ResourceUpdate {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31810dbf542306d1b0e73fe37234653eadb179b8"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af9acaab18a2638b8dad55253298c82aa550cdfc", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/af9acaab18a2638b8dad55253298c82aa550cdfc", "committedDate": "2020-12-07T20:51:57Z", "message": "Fix CDS LB policy to use the new CDS update data structure."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31810dbf542306d1b0e73fe37234653eadb179b8", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/31810dbf542306d1b0e73fe37234653eadb179b8", "committedDate": "2020-12-05T02:33:40Z", "message": "Change CDS LB policy's usage of CdsUpdate, support EDS and logical DNS clusters only for now."}, "afterCommit": {"oid": "af9acaab18a2638b8dad55253298c82aa550cdfc", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/af9acaab18a2638b8dad55253298c82aa550cdfc", "committedDate": "2020-12-07T20:51:57Z", "message": "Fix CDS LB policy to use the new CDS update data structure."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTI5NDkw", "url": "https://github.com/grpc/grpc-java/pull/7696#pullrequestreview-546529490", "createdAt": "2020-12-07T20:56:53Z", "commit": {"oid": "af9acaab18a2638b8dad55253298c82aa550cdfc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMDo1Njo1M1rOIA6WdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMDo1Njo1M1rOIA6WdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgyNjkzMw==", "bodyText": "Name too verbose, causing line-to-long issue.", "url": "https://github.com/grpc/grpc-java/pull/7696#discussion_r537826933", "createdAt": "2020-12-07T20:56:53Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/CdsLoadBalancer.java", "diffHunk": "@@ -193,36 +194,37 @@ private CdsLbState() {\n     }\n \n     @Override\n-    public void onChanged(final CdsUpdate newUpdate) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af9acaab18a2638b8dad55253298c82aa550cdfc"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTMwMDIy", "url": "https://github.com/grpc/grpc-java/pull/7696#pullrequestreview-546530022", "createdAt": "2020-12-07T20:57:39Z", "commit": {"oid": "af9acaab18a2638b8dad55253298c82aa550cdfc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMDo1NzozOVrOIA6YZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMDo1NzozOVrOIA6YZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgyNzQzMA==", "bodyText": "Log too verbose.", "url": "https://github.com/grpc/grpc-java/pull/7696#discussion_r537827430", "createdAt": "2020-12-07T20:57:39Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/CdsLoadBalancer.java", "diffHunk": "@@ -193,36 +194,37 @@ private CdsLbState() {\n     }\n \n     @Override\n-    public void onChanged(final CdsUpdate newUpdate) {\n+    public void onChanged(final CdsUpdate update) {\n       syncContext.execute(new Runnable() {\n         @Override\n         public void run() {\n           if (shutdown) {\n             return;\n           }\n-          if (logger.isLoggable(XdsLogLevel.INFO)) {\n-            logger.log(XdsLogLevel.INFO, \"Received cluster update from xDS client {0}: \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af9acaab18a2638b8dad55253298c82aa550cdfc"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTMwOTEz", "url": "https://github.com/grpc/grpc-java/pull/7696#pullrequestreview-546530913", "createdAt": "2020-12-07T20:58:55Z", "commit": {"oid": "af9acaab18a2638b8dad55253298c82aa550cdfc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMDo1ODo1NlrOIA6bQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMDo1ODo1NlrOIA6bQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgyODE2MQ==", "bodyText": "This check is useless, \"round_robin\" is hard coded for CdsUpdate.", "url": "https://github.com/grpc/grpc-java/pull/7696#discussion_r537828161", "createdAt": "2020-12-07T20:58:56Z", "author": {"login": "voidzcy"}, "path": "xds/src/main/java/io/grpc/xds/CdsLoadBalancer.java", "diffHunk": "@@ -193,36 +194,37 @@ private CdsLbState() {\n     }\n \n     @Override\n-    public void onChanged(final CdsUpdate newUpdate) {\n+    public void onChanged(final CdsUpdate update) {\n       syncContext.execute(new Runnable() {\n         @Override\n         public void run() {\n           if (shutdown) {\n             return;\n           }\n-          if (logger.isLoggable(XdsLogLevel.INFO)) {\n-            logger.log(XdsLogLevel.INFO, \"Received cluster update from xDS client {0}: \"\n-                    + \"cluster_name={1}, eds_service_name={2}, lb_policy={3}, report_load={4}\",\n-                xdsClient, newUpdate.getClusterName(), newUpdate.getEdsServiceName(),\n-                newUpdate.getLbPolicy(), newUpdate.getLrsServerName() != null);\n+          // TODO(chengyuanzhang): implementations for logical DNS and aggregate clusters.\n+          if (update.clusterType != ClusterType.EDS) {\n+            logger.log(XdsLogLevel.WARNING, \"Unsupported cluster type: {0}\", update.clusterType);\n+            return;\n           }\n-          // FIXME(chengyuanzhang): handle error correctly to avoid being unnecessarily fragile.\n-          checkArgument(newUpdate.getLbPolicy().equals(\"round_robin\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af9acaab18a2638b8dad55253298c82aa550cdfc"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14b34b78301e91ac308eb11facfcb280a490a812", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/14b34b78301e91ac308eb11facfcb280a490a812", "committedDate": "2020-12-12T00:32:57Z", "message": "Do not print UpstreamTlsContext."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b36ef31c7aaaa2fbca57e1e37b5e34f22561adb6", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/b36ef31c7aaaa2fbca57e1e37b5e34f22561adb6", "committedDate": "2020-12-15T09:32:44Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/cds_update_with_cluster_type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NjU0MzMz", "url": "https://github.com/grpc/grpc-java/pull/7696#pullrequestreview-559654333", "createdAt": "2020-12-29T18:37:01Z", "commit": {"oid": "b36ef31c7aaaa2fbca57e1e37b5e34f22561adb6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxODozNzowMVrOIMVknw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxODozNzowMVrOIMVknw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTgwNzI2Mw==", "bodyText": ".cluster. or .clusters.?", "url": "https://github.com/grpc/grpc-java/pull/7696#discussion_r549807263", "createdAt": "2020-12-29T18:37:01Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/ClientXdsClient.java", "diffHunk": "@@ -70,6 +74,8 @@\n   // Longest time to wait, since the subscription to some resource, for concluding its absence.\n   @VisibleForTesting\n   static final int INITIAL_RESOURCE_FETCH_TIMEOUT_SEC = 15;\n+  @VisibleForTesting\n+  static final String AGGREGATE_CLUSTER_TYPE_NAME = \"envoy.cluster.aggregate\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b36ef31c7aaaa2fbca57e1e37b5e34f22561adb6"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NjU2Nzg0", "url": "https://github.com/grpc/grpc-java/pull/7696#pullrequestreview-559656784", "createdAt": "2020-12-29T18:44:42Z", "commit": {"oid": "b36ef31c7aaaa2fbca57e1e37b5e34f22561adb6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxODo0NDo0M1rOIMVs9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxODo0NDo0M1rOIMVs9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTgwOTM5OA==", "bodyText": "Why not check if(update==null) {return;} here?", "url": "https://github.com/grpc/grpc-java/pull/7696#discussion_r549809398", "createdAt": "2020-12-29T18:44:43Z", "author": {"login": "dapengzhang0"}, "path": "xds/src/main/java/io/grpc/xds/ClientXdsClient.java", "diffHunk": "@@ -280,88 +290,42 @@ protected void handleCdsResponse(String versionInfo, List<Any> resources, String\n     }\n     getLogger().log(XdsLogLevel.INFO, \"Received CDS response for resources: {0}\", clusterNames);\n \n-    String errorMessage = null;\n-    // Cluster information update for requested clusters received in this CDS response.\n     Map<String, CdsUpdate> cdsUpdates = new HashMap<>();\n-    // CDS responses represents the state of the world, EDS services not referenced by\n-    // Clusters are those no longer exist.\n-    Set<String> edsServices = new HashSet<>();\n+    // CDS responses represents the state of the world, EDS resources not referenced in CDS\n+    // resources should be deleted.\n+    Set<String> edsResources = new HashSet<>();  // retained EDS resources\n     for (Cluster cluster : clusters) {\n       String clusterName = cluster.getName();\n-      // Skip information for clusters not requested.\n       // Management server is required to always send newly requested resources, even if they\n       // may have been sent previously (proactively). Thus, client does not need to cache\n       // unrequested resources.\n       if (!cdsResourceSubscribers.containsKey(clusterName)) {\n         continue;\n       }\n-      CdsUpdate.Builder updateBuilder = CdsUpdate.newBuilder();\n-      updateBuilder.setClusterName(clusterName);\n-      // The type field must be set to EDS.\n-      if (!cluster.getType().equals(DiscoveryType.EDS)) {\n-        errorMessage = \"Cluster \" + clusterName + \" : only EDS discovery type is supported \"\n-            + \"in gRPC.\";\n-        break;\n-      }\n-      // In the eds_cluster_config field, the eds_config field must be set to indicate to\n-      // use EDS (must be set to use ADS).\n-      EdsClusterConfig edsClusterConfig = cluster.getEdsClusterConfig();\n-      if (!edsClusterConfig.getEdsConfig().hasAds()) {\n-        errorMessage = \"Cluster \" + clusterName + \" : field eds_cluster_config must be set to \"\n-            + \"indicate to use EDS over ADS.\";\n-        break;\n-      }\n-      // If the service_name field is set, that value will be used for the EDS request.\n-      if (!edsClusterConfig.getServiceName().isEmpty()) {\n-        updateBuilder.setEdsServiceName(edsClusterConfig.getServiceName());\n-        edsServices.add(edsClusterConfig.getServiceName());\n-      } else {\n-        edsServices.add(clusterName);\n-      }\n       // The lb_policy field must be set to ROUND_ROBIN.\n       if (!cluster.getLbPolicy().equals(LbPolicy.ROUND_ROBIN)) {\n-        errorMessage = \"Cluster \" + clusterName + \" : only round robin load balancing policy is \"\n-            + \"supported in gRPC.\";\n-        break;\n+        nackResponse(ResourceType.CDS, nonce,\n+            \"Cluster \" + clusterName + \": unsupported Lb policy: \" + cluster.getLbPolicy());\n+        return;\n       }\n-      updateBuilder.setLbPolicy(\"round_robin\");\n-      // If the lrs_server field is set, it must have its self field set, in which case the\n-      // client should use LRS for load reporting. Otherwise (the lrs_server field is not set),\n-      // LRS load reporting will be disabled.\n-      if (cluster.hasLrsServer()) {\n-        if (!cluster.getLrsServer().hasSelf()) {\n-          errorMessage = \"Cluster \" + clusterName + \" : only support enabling LRS for the same \"\n-              + \"management server.\";\n+      String lbPolicy = \"round_robin\";\n+      CdsUpdate update = null;\n+      switch (cluster.getClusterDiscoveryTypeCase()) {\n+        case TYPE:\n+          update = parseNonAggregateCluster(cluster, nonce, lbPolicy, edsResources);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b36ef31c7aaaa2fbca57e1e37b5e34f22561adb6"}, "originalPosition": 117}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NjY4MTY5", "url": "https://github.com/grpc/grpc-java/pull/7696#pullrequestreview-559668169", "createdAt": "2020-12-29T19:19:39Z", "commit": {"oid": "b36ef31c7aaaa2fbca57e1e37b5e34f22561adb6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95db4ec59e914a3b5bf29f02950979405c0e0504", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/95db4ec59e914a3b5bf29f02950979405c0e0504", "committedDate": "2020-12-29T20:41:39Z", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/cds_update_with_cluster_type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3889e089874e39349e8ae3a7f5b77e7c2c64d709", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/3889e089874e39349e8ae3a7f5b77e7c2c64d709", "committedDate": "2020-12-29T20:42:08Z", "message": "Fix aggregate cluster type name."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bccf637c575407d348861c1f0b9c9060937ac01", "author": {"user": {"login": "voidzcy", "name": "Chengyuan Zhang"}}, "url": "https://github.com/grpc/grpc-java/commit/5bccf637c575407d348861c1f0b9c9060937ac01", "committedDate": "2020-12-30T20:37:57Z", "message": "Improve cosmetical naming issue."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4738, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}