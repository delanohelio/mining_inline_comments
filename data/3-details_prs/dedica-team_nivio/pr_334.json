{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5MDcwOTQ2", "number": 334, "title": "332 fixes", "bodyText": "Fixes that SVG is loaded twice (cleanup of previous #332 fix attempt)\ncloses #304 (small UX improvement)", "createdAt": "2020-11-29T07:34:21Z", "url": "https://github.com/dedica-team/nivio/pull/334", "merged": true, "mergeCommit": {"oid": "00653010976f39612819e0555b3bb6af01ff157f"}, "closed": true, "closedAt": "2020-12-04T12:29:31Z", "author": {"login": "bonndan"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhLV8yAH2gAyNTI5MDcwOTQ2OjBmMTMyNjVmNDc0NTcxNWYzNDNkM2MxY2VjYzk3NGUyYTdmZTViNDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdi1TadAFqTU0NDg0MTIxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0f13265f4745715f343d3c1cecc974e2a7fe5b43", "author": {"user": null}, "url": "https://github.com/dedica-team/nivio/commit/0f13265f4745715f343d3c1cecc974e2a7fe5b43", "committedDate": "2020-11-29T07:09:40Z", "message": "[#332] avoid duplicate SVG loading"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "692253114a38423a966dcb08faafb27bb327450f", "author": {"user": null}, "url": "https://github.com/dedica-team/nivio/commit/692253114a38423a966dcb08faafb27bb327450f", "committedDate": "2020-11-29T07:15:40Z", "message": "[#332] removed deprecated icon, added link"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4412469244c9cf8a59b34c927ce2bcaadc6bbfad", "author": {"user": null}, "url": "https://github.com/dedica-team/nivio/commit/4412469244c9cf8a59b34c927ce2bcaadc6bbfad", "committedDate": "2020-11-29T07:31:45Z", "message": "[#304] map items clickable instead of labels only"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f836227f7b42e1a443e4394d6c9399cdb66a3b27", "author": {"user": null}, "url": "https://github.com/dedica-team/nivio/commit/f836227f7b42e1a443e4394d6c9399cdb66a3b27", "committedDate": "2020-11-29T07:55:28Z", "message": "[#304] fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNDgyMDQ0", "url": "https://github.com/dedica-team/nivio/pull/334#pullrequestreview-540482044", "createdAt": "2020-11-29T13:54:03Z", "commit": {"oid": "f836227f7b42e1a443e4394d6c9399cdb66a3b27"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQxMzo1NDowNFrOH7jssg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQxMzo1NDowNFrOH7jssg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIxMjkxNA==", "bodyText": "Was this what made the hexagons before? Are we not having the hexagons anymore?", "url": "https://github.com/dedica-team/nivio/pull/334#discussion_r532212914", "createdAt": "2020-11-29T13:54:04Z", "author": {"login": "mfbieber"}, "path": "src/main/java/de/bonndan/nivio/output/map/svg/SVGItem.java", "diffHunk": "@@ -81,11 +81,11 @@ public DomContent render() {\n             circle.attr(\"stroke-dasharray\", 5);\n             circle.attr(\"opacity\", 0.7);\n         }\n-        ContainerTag inner = SvgTagCreator.g(circle, content, children)\n-                .attr(\"class\", \"hexagon\");\n+        ContainerTag inner = SvgTagCreator.g(circle, content, children);\n \n         return SvgTagCreator.g(inner, icon)\n-                .attr(\"class\", \"hexagon-group\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f836227f7b42e1a443e4394d6c9399cdb66a3b27"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNDgyMzMz", "url": "https://github.com/dedica-team/nivio/pull/334#pullrequestreview-540482333", "createdAt": "2020-11-29T13:56:50Z", "commit": {"oid": "f836227f7b42e1a443e4394d6c9399cdb66a3b27"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQxMzo1Njo1MFrOH7juUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQxMzo1Njo1MFrOH7juUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIxMzMzMA==", "bodyText": "What does removing the \"data-identifier\" attribute do?", "url": "https://github.com/dedica-team/nivio/pull/334#discussion_r532213330", "createdAt": "2020-11-29T13:56:50Z", "author": {"login": "mfbieber"}, "path": "src/main/java/de/bonndan/nivio/output/map/svg/SVGItemLabel.java", "diffHunk": "@@ -27,11 +27,10 @@ public DomContent render() {\n \n         ContainerTag labelText = new SVGLabelText(name, \"0\", 2 * DEFAULT_ICON_SIZE + 30 + \"\", \"itemLabel\").render();\n \n-        ContainerTag g = SvgTagCreator.g(null, labelText).attr(\"class\", \"label\");\n-        g.attr(\"id\", id);\n-        g.attr(\"data-identifier\", identifier);\n-        g.attr(\"text-anchor\", \"middle\");\n-        return g;\n+        return SvgTagCreator.g(null, labelText)\n+                .attr(\"class\", \"label\")\n+                .attr(\"id\", id)\n+                .attr(\"text-anchor\", \"middle\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f836227f7b42e1a443e4394d6c9399cdb66a3b27"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNDgyMzk0", "url": "https://github.com/dedica-team/nivio/pull/334#pullrequestreview-540482394", "createdAt": "2020-11-29T13:57:34Z", "commit": {"oid": "f836227f7b42e1a443e4394d6c9399cdb66a3b27"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQxMzo1NzozNFrOH7jurQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQxMzo1NzozNFrOH7jurQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIxMzQyMQ==", "bodyText": "What does the data-identifier and the class attribute change here?", "url": "https://github.com/dedica-team/nivio/pull/334#discussion_r532213421", "createdAt": "2020-11-29T13:57:34Z", "author": {"login": "mfbieber"}, "path": "src/main/java/de/bonndan/nivio/output/map/svg/SVGItem.java", "diffHunk": "@@ -81,11 +81,11 @@ public DomContent render() {\n             circle.attr(\"stroke-dasharray\", 5);\n             circle.attr(\"opacity\", 0.7);\n         }\n-        ContainerTag inner = SvgTagCreator.g(circle, content, children)\n-                .attr(\"class\", \"hexagon\");\n+        ContainerTag inner = SvgTagCreator.g(circle, content, children);\n \n         return SvgTagCreator.g(inner, icon)\n-                .attr(\"class\", \"hexagon-group\")\n+                .attr(\"data-identifier\", this.id)\n+                .attr(\"class\", \"item\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f836227f7b42e1a443e4394d6c9399cdb66a3b27"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNDgyNjI2", "url": "https://github.com/dedica-team/nivio/pull/334#pullrequestreview-540482626", "createdAt": "2020-11-29T14:00:17Z", "commit": {"oid": "f836227f7b42e1a443e4394d6c9399cdb66a3b27"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQxNDowMDoxN1rOH7jwLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQxNDowMDoxN1rOH7jwLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIxMzgwNQ==", "bodyText": "How are we still testing the SVGItemLabel now?", "url": "https://github.com/dedica-team/nivio/pull/334#discussion_r532213805", "createdAt": "2020-11-29T14:00:17Z", "author": {"login": "mfbieber"}, "path": "src/test/java/de/bonndan/nivio/output/map/svg/SVGItemLabelTest.java", "diffHunk": "@@ -21,8 +24,8 @@ public void regression184() {\n         foo.setLandscape(landscape);\n \n \n-        SVGItemLabel svgItemLabel = new SVGItemLabel(foo);\n-        String render = svgItemLabel.render().render();\n+        SVGItem svgItem = new SVGItem(null, new LayoutedComponent(foo), new Point2D.Double(0,0));\n+        String render = svgItem.render().render();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f836227f7b42e1a443e4394d6c9399cdb66a3b27"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9a6741df15fa6c58b30a40ea784ae4f614e2bda", "author": {"user": null}, "url": "https://github.com/dedica-team/nivio/commit/e9a6741df15fa6c58b30a40ea784ae4f614e2bda", "committedDate": "2020-11-29T15:15:14Z", "message": "[#304] removed duplicate test (functionaly has been deleted fromm label)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43a679a75223e812261e0d12fbf5a6875a2dbfb9", "author": {"user": null}, "url": "https://github.com/dedica-team/nivio/commit/43a679a75223e812261e0d12fbf5a6875a2dbfb9", "committedDate": "2020-11-29T15:22:03Z", "message": "[#332] message fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a5841a8c7f7bae9dcfc9b2f8638d59ffe48d987", "author": {"user": null}, "url": "https://github.com/dedica-team/nivio/commit/2a5841a8c7f7bae9dcfc9b2f8638d59ffe48d987", "committedDate": "2020-11-29T15:26:33Z", "message": "[#332] removed dead code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6382733f69cbaacb0334eda71651a81974e52c32", "author": {"user": null}, "url": "https://github.com/dedica-team/nivio/commit/6382733f69cbaacb0334eda71651a81974e52c32", "committedDate": "2020-11-30T19:47:26Z", "message": "presence of icons dependency checked at application start"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6bc8775ae7dc494e613c3db7e9e1d97264c8b1e", "author": {"user": null}, "url": "https://github.com/dedica-team/nivio/commit/d6bc8775ae7dc494e613c3db7e9e1d97264c8b1e", "committedDate": "2020-11-30T19:48:57Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aca793e61c913a3476738b312863522589bddf8f", "author": {"user": null}, "url": "https://github.com/dedica-team/nivio/commit/aca793e61c913a3476738b312863522589bddf8f", "committedDate": "2020-11-30T19:55:33Z", "message": "ensure overriding icon folder has trailing slash"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0Mzc2ODEz", "url": "https://github.com/dedica-team/nivio/pull/334#pullrequestreview-544376813", "createdAt": "2020-12-03T20:10:12Z", "commit": {"oid": "aca793e61c913a3476738b312863522589bddf8f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDoxMDoxM1rOH-vg-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDoxMDoxM1rOH-vg-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU1MjI1MQ==", "bodyText": "Okay, the problem I had was indeed resolved by obtaining the npm dependency. \ud83d\udc4d", "url": "https://github.com/dedica-team/nivio/pull/334#discussion_r535552251", "createdAt": "2020-12-03T20:10:13Z", "author": {"login": "mfbieber"}, "path": "src/main/java/de/bonndan/nivio/output/icons/LocalIcons.java", "diffHunk": "@@ -3,33 +3,53 @@\n import de.bonndan.nivio.util.URLHelper;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n import org.springframework.stereotype.Component;\n import org.springframework.util.StringUtils;\n \n+import java.io.File;\n import java.net.URL;\n import java.util.Map;\n import java.util.Optional;\n import java.util.concurrent.ConcurrentHashMap;\n \n import static de.bonndan.nivio.output.icons.IconMapping.DEFAULT_ICON;\n \n+/**\n+ * This component is responsible to resolve icons into urls / data urls.\n+ */\n @Component\n public class LocalIcons {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(LocalIcons.class);\n+    private static final String initErrorMsg = \"Default icon could not be loaded from icon set folder %s.\" +\n+            \" Make sure all npm dependencies are installed (or run mvn package).\";\n+    private static final String DEFAULT_ICONS_FOLDER = \"/static/icons/svg/\";\n \n     /**\n      * default icon data url\n      */\n-    private String defaultIcon = null;\n+    private final String defaultIcon;\n+\n+    private final String iconFolder;\n \n     /**\n      * data url cache\n      */\n     private final Map<String, String> iconDataUrls = new ConcurrentHashMap<>();\n \n-    public LocalIcons() {\n-        getIconUrl(DEFAULT_ICON.getIcon()).ifPresent(s -> defaultIcon = s);\n+    /**\n+     * @param iconFolder optional dir containing a different icon set\n+     */\n+    public LocalIcons(@Value(\"${nivio.iconFolder:#{null}}\") String iconFolder) {\n+        if (iconFolder != null) {\n+            this.iconFolder = iconFolder.endsWith(File.separator) ? iconFolder : iconFolder + File.separator;\n+        } else {\n+            this.iconFolder = DEFAULT_ICONS_FOLDER;\n+        }\n+        defaultIcon = getIconUrl(DEFAULT_ICON.getIcon()).orElseThrow(() -> {\n+            throw new RuntimeException(String.format(initErrorMsg, this.iconFolder));\n+        });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aca793e61c913a3476738b312863522589bddf8f"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0Mzc3Mzg1", "url": "https://github.com/dedica-team/nivio/pull/334#pullrequestreview-544377385", "createdAt": "2020-12-03T20:11:01Z", "commit": {"oid": "aca793e61c913a3476738b312863522589bddf8f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDoxMTowMVrOH-vkLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDoxMTowMVrOH-vkLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU1MzA2OA==", "bodyText": "What do we need this for?", "url": "https://github.com/dedica-team/nivio/pull/334#discussion_r535553068", "createdAt": "2020-12-03T20:11:01Z", "author": {"login": "mfbieber"}, "path": "src/main/resources/application.yml", "diffHunk": "@@ -28,6 +28,7 @@ nivio:\n   baseUrl: ${NIVIO_BASE_URL:}\n   version: #project.version#\n   pollingMilliseconds: 30000 # 30 secs\n+  # iconFolder: /a/local/path", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aca793e61c913a3476738b312863522589bddf8f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "459e67d987512c9d3f70341a6a47e376ef5be1b0", "author": {"user": null}, "url": "https://github.com/dedica-team/nivio/commit/459e67d987512c9d3f70341a6a47e376ef5be1b0", "committedDate": "2020-12-04T06:46:42Z", "message": "[#332] LocalIcons component configured explicitly, with non-null arg"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0ODQxMjE4", "url": "https://github.com/dedica-team/nivio/pull/334#pullrequestreview-544841218", "createdAt": "2020-12-04T10:36:49Z", "commit": {"oid": "459e67d987512c9d3f70341a6a47e376ef5be1b0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMDozNjo0OVrOH_K8wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMDozNjo0OVrOH_K8wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAwMTcyOQ==", "bodyText": "This looks pretty now \ud83e\udd8b", "url": "https://github.com/dedica-team/nivio/pull/334#discussion_r536001729", "createdAt": "2020-12-04T10:36:49Z", "author": {"login": "mfbieber"}, "path": "src/test/java/de/bonndan/nivio/output/layout/OrganicLayouterTest.java", "diffHunk": "@@ -168,7 +168,7 @@ public void renderLandscapeItemModelWithMagicLabels() throws IOException {\n     public void renderCSV() throws IOException {\n \n         HttpService httpService = new HttpService();\n-        IconService iconService = new IconService(new LocalIcons(null), new VendorIcons(httpService));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "459e67d987512c9d3f70341a6a47e376ef5be1b0"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1916, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}