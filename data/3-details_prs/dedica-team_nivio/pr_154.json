{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNTc4MDUx", "number": 154, "title": "[#147][140] removed DirectoryWatcher etc, polling for changes", "bodyText": "fixes #147 and partially implements #140", "createdAt": "2020-06-10T16:44:17Z", "url": "https://github.com/dedica-team/nivio/pull/154", "merged": true, "mergeCommit": {"oid": "a3a6ef6e702d48d12fcc3b114315de7c404bd504"}, "closed": true, "closedAt": "2020-06-28T16:14:42Z", "author": {"login": "bonndan"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcp8dNRgH2gAyNDMyNTc4MDUxOjdmMmE2M2YzNjM2MTQ5YTI0ZGMzMDU4ZDU3MGExZThkNmFmYjZmMDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvuoZmgH2gAyNDMyNTc4MDUxOmEzOWRiNTY2NTUwNDYwYzJmNmRkMThlMDkyMTM5ZGZkZDZjZjJjMTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7f2a63f3636149a24dc3058d570a1e8d6afb6f02", "author": {"user": {"login": "bonndan", "name": "Daniel Pozzi"}}, "url": "https://github.com/dedica-team/nivio/commit/7f2a63f3636149a24dc3058d570a1e8d6afb6f02", "committedDate": "2020-06-10T16:43:11Z", "message": "[#147][140] removed DirectoryWatcher etc, polling for changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43b1062c8a3465e7853031424f1b8003b9a81cc5", "author": {"user": {"login": "bonndan", "name": "Daniel Pozzi"}}, "url": "https://github.com/dedica-team/nivio/commit/43b1062c8a3465e7853031424f1b8003b9a81cc5", "committedDate": "2020-06-10T19:04:33Z", "message": "[#147][#140] added log message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b96765805ed00808d69daeff36f618903cf9db1", "author": {"user": {"login": "bonndan", "name": "Daniel Pozzi"}}, "url": "https://github.com/dedica-team/nivio/commit/9b96765805ed00808d69daeff36f618903cf9db1", "committedDate": "2020-06-10T20:53:44Z", "message": "[#147][#140] concurrency fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94b56b44f87535706390fc97cde3349d0c59ccd4", "author": {"user": {"login": "bonndan", "name": "Daniel Pozzi"}}, "url": "https://github.com/dedica-team/nivio/commit/94b56b44f87535706390fc97cde3349d0c59ccd4", "committedDate": "2020-06-10T20:57:20Z", "message": "[#147][#140] added comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e132e821b4356ad7462a67a2fc8750dd5bb14aaf", "author": {"user": null}, "url": "https://github.com/dedica-team/nivio/commit/e132e821b4356ad7462a67a2fc8750dd5bb14aaf", "committedDate": "2020-06-12T17:24:40Z", "message": "add new assessment page for manual"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71029f98013fcc134590d43a6abee7b4dde10c1e", "author": {"user": {"login": "bonndan", "name": "Daniel Pozzi"}}, "url": "https://github.com/dedica-team/nivio/commit/71029f98013fcc134590d43a6abee7b4dde10c1e", "committedDate": "2020-06-12T19:33:03Z", "message": "Merge branch '147_remove_directory_watcher' of github.com:dedica-team/nivio into 147_remove_directory_watcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "050a21302abb895084b408d7ffbaa81faebfb356", "author": {"user": {"login": "bonndan", "name": "Daniel Pozzi"}}, "url": "https://github.com/dedica-team/nivio/commit/050a21302abb895084b408d7ffbaa81faebfb356", "committedDate": "2020-06-12T19:34:08Z", "message": "Merge branch 'develop' into 147_remove_directory_watcher"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTYyMjcw", "url": "https://github.com/dedica-team/nivio/pull/154#pullrequestreview-430962270", "createdAt": "2020-06-15T20:17:42Z", "commit": {"oid": "050a21302abb895084b408d7ffbaa81faebfb356"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDoxNzo0MlrOGkBREw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMTowMTo1NVrOGkCoIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyMjY3NQ==", "bodyText": "Oh, we are using HATEOAS, nice!", "url": "https://github.com/dedica-team/nivio/pull/154#discussion_r440422675", "createdAt": "2020-06-15T20:17:42Z", "author": {"login": "mfbieber"}, "path": "src/main/java/de/bonndan/nivio/Application.java", "diffHunk": "@@ -4,12 +4,14 @@\n import org.springframework.boot.SpringApplication;\n import org.springframework.boot.autoconfigure.SpringBootApplication;\n import org.springframework.context.annotation.Bean;\n-import org.springframework.core.task.TaskExecutor;\n-import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;\n+import org.springframework.hateoas.config.EnableHypermediaSupport;\n+import org.springframework.scheduling.annotation.EnableScheduling;\n import org.springframework.web.servlet.config.annotation.CorsRegistry;\n import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n \n @SpringBootApplication\n+@EnableHypermediaSupport(type = EnableHypermediaSupport.HypermediaType.HAL)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050a21302abb895084b408d7ffbaa81faebfb356"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyMzM0MQ==", "bodyText": "Nice, this will do the reading of the file system changes?", "url": "https://github.com/dedica-team/nivio/pull/154#discussion_r440423341", "createdAt": "2020-06-15T20:19:05Z", "author": {"login": "mfbieber"}, "path": "src/main/java/de/bonndan/nivio/Application.java", "diffHunk": "@@ -4,12 +4,14 @@\n import org.springframework.boot.SpringApplication;\n import org.springframework.boot.autoconfigure.SpringBootApplication;\n import org.springframework.context.annotation.Bean;\n-import org.springframework.core.task.TaskExecutor;\n-import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;\n+import org.springframework.hateoas.config.EnableHypermediaSupport;\n+import org.springframework.scheduling.annotation.EnableScheduling;\n import org.springframework.web.servlet.config.annotation.CorsRegistry;\n import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n \n @SpringBootApplication\n+@EnableHypermediaSupport(type = EnableHypermediaSupport.HypermediaType.HAL)\n+@EnableScheduling", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050a21302abb895084b408d7ffbaa81faebfb356"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyNTg5MA==", "bodyText": "Sounds like it. So, for me to understand, the triggerer (== the event source) is what exactly? A change in a file, right?", "url": "https://github.com/dedica-team/nivio/pull/154#discussion_r440425890", "createdAt": "2020-06-15T20:24:30Z", "author": {"login": "mfbieber"}, "path": "src/main/java/de/bonndan/nivio/ProcessingFinishedEvent.java", "diffHunk": "@@ -12,7 +13,11 @@\n \n     private final Landscape landscape;\n \n-    public ProcessingFinishedEvent(Object source, Landscape landscape) {\n+    /**\n+     * @param source TODO is this a misuse of event source? We store the LandscapeDescription instead of the triggerer", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050a21302abb895084b408d7ffbaa81faebfb356"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQzMDA4OA==", "bodyText": "Well, actually it might be okay. The ApplicationEventsays:\n/**\n * Create a new {@code ApplicationEvent}.\n * @param source the object on which the event initially occurred or with\n * which the event is associated (never {@code null})\n*/\npublic ApplicationEvent(Object source) {\n\tsuper(source);\n\tthis.timestamp = System.currentTimeMillis();\n}\n\nSo the LandscapeDescription is the object with which the event is associated with. In other words, there has been a change on the LandscapeDescription, so that is the event.\nSounds right to me.", "url": "https://github.com/dedica-team/nivio/pull/154#discussion_r440430088", "createdAt": "2020-06-15T20:32:36Z", "author": {"login": "mfbieber"}, "path": "src/main/java/de/bonndan/nivio/ProcessingFinishedEvent.java", "diffHunk": "@@ -12,7 +13,11 @@\n \n     private final Landscape landscape;\n \n-    public ProcessingFinishedEvent(Object source, Landscape landscape) {\n+    /**\n+     * @param source TODO is this a misuse of event source? We store the LandscapeDescription instead of the triggerer", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyNTg5MA=="}, "originalCommit": {"oid": "050a21302abb895084b408d7ffbaa81faebfb356"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQzMzAwNA==", "bodyText": "Don't we need to check here if the file is really a yaml/yml file?", "url": "https://github.com/dedica-team/nivio/pull/154#discussion_r440433004", "createdAt": "2020-06-15T20:38:30Z", "author": {"login": "mfbieber"}, "path": "src/main/java/de/bonndan/nivio/input/LandscapeDescriptionFactory.java", "diffHunk": "@@ -43,56 +44,41 @@ public LandscapeDescriptionFactory(ApplicationEventPublisher publisher, FileFetc\n     }\n \n     /**\n-     * Returns all {@link LandscapeDescription}s from config files named in the seed.\n+     * Returns a {@link LandscapeDescription}s from config file url.\n      *\n-     * @param seed seed object\n-     * @return list of fetched descriptions\n+     * @param old an outdated landscape / description\n+     * @return the description or null if the source is no URL\n      */\n-    public List<LandscapeDescription> getDescriptions(Seed seed) {\n-\n-        List<URL> locations = new ArrayList<>();\n+    @Nullable\n+    public LandscapeDescription from(Landscape old) {\n         try {\n-            if (seed.hasValue()) {\n-                locations = seed.getLocations();\n-            }\n-            if (!StringUtils.isEmpty(System.getenv(Seed.DEMO))) {\n-                locations.addAll(seed.getDemoFiles());\n-            }\n+            URL url = new URL(old.getSource());\n+            return from(url);\n         } catch (MalformedURLException e) {\n-            ProcessingException processingException = new ProcessingException(\"Failed to initialize watchers from seed\", e);\n-            publisher.publishEvent(new ProcessingErrorEvent(this, processingException));\n+            String msg = \"Source in landscape \" + old.getIdentifier() + \" might be no url: \" + old.getSource();\n+            LOGGER.info(msg);\n+            return null;\n         }\n+    }\n \n-        List<LandscapeDescription> descriptions = new ArrayList<>();\n-\n-        locations.forEach(url -> {\n-            LandscapeDescription env = null;\n+    @Nullable\n+    public LandscapeDescription from(URL url) {\n+        LandscapeDescription env = null;\n+        try {\n             if (URLHelper.isLocal(url)) {\n-                try {\n-                    File file = Paths.get(url.toURI()).toFile();\n-                    env = LandscapeDescriptionFactory.fromYaml(file);\n-                } catch (URISyntaxException | ProcessingException ex) {\n-                    if (ex instanceof URISyntaxException) {\n-                        publisher.publishEvent(new ProcessingErrorEvent(this, new ReadingException(\"Failed to handle file\", ex)));\n-                    } else {\n-                        publisher.publishEvent(new ProcessingErrorEvent(this, (ProcessingException) ex));\n-                    }\n-                    LOGGER.error(\"Failed to parse file {}\", url);\n-                }\n+                File file = Paths.get(url.toURI()).toFile();\n+                env = LandscapeDescriptionFactory.fromYaml(file);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050a21302abb895084b408d7ffbaa81faebfb356"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQzMzk0Ng==", "bodyText": "Is the file ending even relevant?", "url": "https://github.com/dedica-team/nivio/pull/154#discussion_r440433946", "createdAt": "2020-06-15T20:40:27Z", "author": {"login": "mfbieber"}, "path": "src/main/java/de/bonndan/nivio/input/LandscapeDescriptionFactory.java", "diffHunk": "@@ -43,56 +44,41 @@ public LandscapeDescriptionFactory(ApplicationEventPublisher publisher, FileFetc\n     }\n \n     /**\n-     * Returns all {@link LandscapeDescription}s from config files named in the seed.\n+     * Returns a {@link LandscapeDescription}s from config file url.\n      *\n-     * @param seed seed object\n-     * @return list of fetched descriptions\n+     * @param old an outdated landscape / description\n+     * @return the description or null if the source is no URL\n      */\n-    public List<LandscapeDescription> getDescriptions(Seed seed) {\n-\n-        List<URL> locations = new ArrayList<>();\n+    @Nullable\n+    public LandscapeDescription from(Landscape old) {\n         try {\n-            if (seed.hasValue()) {\n-                locations = seed.getLocations();\n-            }\n-            if (!StringUtils.isEmpty(System.getenv(Seed.DEMO))) {\n-                locations.addAll(seed.getDemoFiles());\n-            }\n+            URL url = new URL(old.getSource());\n+            return from(url);\n         } catch (MalformedURLException e) {\n-            ProcessingException processingException = new ProcessingException(\"Failed to initialize watchers from seed\", e);\n-            publisher.publishEvent(new ProcessingErrorEvent(this, processingException));\n+            String msg = \"Source in landscape \" + old.getIdentifier() + \" might be no url: \" + old.getSource();\n+            LOGGER.info(msg);\n+            return null;\n         }\n+    }\n \n-        List<LandscapeDescription> descriptions = new ArrayList<>();\n-\n-        locations.forEach(url -> {\n-            LandscapeDescription env = null;\n+    @Nullable\n+    public LandscapeDescription from(URL url) {\n+        LandscapeDescription env = null;\n+        try {\n             if (URLHelper.isLocal(url)) {\n-                try {\n-                    File file = Paths.get(url.toURI()).toFile();\n-                    env = LandscapeDescriptionFactory.fromYaml(file);\n-                } catch (URISyntaxException | ProcessingException ex) {\n-                    if (ex instanceof URISyntaxException) {\n-                        publisher.publishEvent(new ProcessingErrorEvent(this, new ReadingException(\"Failed to handle file\", ex)));\n-                    } else {\n-                        publisher.publishEvent(new ProcessingErrorEvent(this, (ProcessingException) ex));\n-                    }\n-                    LOGGER.error(\"Failed to parse file {}\", url);\n-                }\n+                File file = Paths.get(url.toURI()).toFile();\n+                env = LandscapeDescriptionFactory.fromYaml(file);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQzMzAwNA=="}, "originalCommit": {"oid": "050a21302abb895084b408d7ffbaa81faebfb356"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQzNTM5Ng==", "bodyText": "The methods in this class and the implementation in FileFetcher are quite similar. FileFetcher is also reading the contents of the files, very similar as it is done here.\nI would suggest a little bit of refactoring to have less of URLHelper.isLocal() and Files.readAllBytes() in both classes. Just a little bit of cleaning up and reducing complexity. What do you think?", "url": "https://github.com/dedica-team/nivio/pull/154#discussion_r440435396", "createdAt": "2020-06-15T20:43:18Z", "author": {"login": "mfbieber"}, "path": "src/main/java/de/bonndan/nivio/input/LandscapeDescriptionFactory.java", "diffHunk": "@@ -149,6 +135,7 @@ public static LandscapeDescription fromString(String yaml, String origin) {\n      * @param url  for updates\n      * @return env description\n      */\n+    @NonNull\n     public static LandscapeDescription fromString(String yaml, URL url) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050a21302abb895084b408d7ffbaa81faebfb356"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQzNjE1MA==", "bodyText": "This method is never used (according to my IDE). What was the intention for it? Is this going to be used later somewhere?", "url": "https://github.com/dedica-team/nivio/pull/154#discussion_r440436150", "createdAt": "2020-06-15T20:44:53Z", "author": {"login": "mfbieber"}, "path": "src/main/java/de/bonndan/nivio/input/LandscapeUrlsFactory.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package de.bonndan.nivio.input;\n+\n+import de.bonndan.nivio.ProcessingErrorEvent;\n+import de.bonndan.nivio.ProcessingException;\n+import de.bonndan.nivio.input.dto.LandscapeDescription;\n+import de.bonndan.nivio.input.dto.SourceReference;\n+import de.bonndan.nivio.model.Landscape;\n+import de.bonndan.nivio.util.URLHelper;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.ApplicationEventPublisher;\n+import org.springframework.lang.NonNull;\n+import org.springframework.lang.Nullable;\n+import org.springframework.stereotype.Component;\n+import org.springframework.util.StringUtils;\n+\n+import java.io.File;\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.nio.file.Paths;\n+import java.util.*;\n+\n+@Component\n+public class LandscapeUrlsFactory {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(LandscapeUrlsFactory.class);\n+\n+    private final ApplicationEventPublisher publisher;\n+\n+    private final FileFetcher fileFetcher;\n+\n+    public LandscapeUrlsFactory(ApplicationEventPublisher publisher, FileFetcher fileFetcher) {\n+        this.publisher = publisher;\n+        this.fileFetcher = fileFetcher;\n+    }\n+\n+    /**\n+     * Returns a list of URLs for a landscape description to watch for.\n+     *\n+     * @param seed the seed bean\n+     * @return a list of {@link URL}s per landscape.\n+     */\n+    public Map<Landscape, List<URL>> getLandscapeSourceLocations(Seed seed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050a21302abb895084b408d7ffbaa81faebfb356"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQzNjY5MA==", "bodyText": "This is the same logic as in FileFetcher and LandscapeDescriptionFactory. See my comment above, we could clean this up a bit.", "url": "https://github.com/dedica-team/nivio/pull/154#discussion_r440436690", "createdAt": "2020-06-15T20:45:57Z", "author": {"login": "mfbieber"}, "path": "src/main/java/de/bonndan/nivio/input/LandscapeUrlsFactory.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package de.bonndan.nivio.input;\n+\n+import de.bonndan.nivio.ProcessingErrorEvent;\n+import de.bonndan.nivio.ProcessingException;\n+import de.bonndan.nivio.input.dto.LandscapeDescription;\n+import de.bonndan.nivio.input.dto.SourceReference;\n+import de.bonndan.nivio.model.Landscape;\n+import de.bonndan.nivio.util.URLHelper;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.ApplicationEventPublisher;\n+import org.springframework.lang.NonNull;\n+import org.springframework.lang.Nullable;\n+import org.springframework.stereotype.Component;\n+import org.springframework.util.StringUtils;\n+\n+import java.io.File;\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.nio.file.Paths;\n+import java.util.*;\n+\n+@Component\n+public class LandscapeUrlsFactory {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(LandscapeUrlsFactory.class);\n+\n+    private final ApplicationEventPublisher publisher;\n+\n+    private final FileFetcher fileFetcher;\n+\n+    public LandscapeUrlsFactory(ApplicationEventPublisher publisher, FileFetcher fileFetcher) {\n+        this.publisher = publisher;\n+        this.fileFetcher = fileFetcher;\n+    }\n+\n+    /**\n+     * Returns a list of URLs for a landscape description to watch for.\n+     *\n+     * @param seed the seed bean\n+     * @return a list of {@link URL}s per landscape.\n+     */\n+    public Map<Landscape, List<URL>> getLandscapeSourceLocations(Seed seed) {\n+\n+        List<URL> landscapeDescriptionLocations = getUrls(seed);\n+\n+        Map<Landscape, List<URL>> landscapeWatchLocations = new HashMap<>();\n+\n+        landscapeDescriptionLocations.forEach(url -> {\n+\n+            LandscapeDescription env = null;\n+\n+            try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050a21302abb895084b408d7ffbaa81faebfb356"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ0MDQwMA==", "bodyText": "Cool, this is where you check the changes from the observerPool \ud83d\udc4d", "url": "https://github.com/dedica-team/nivio/pull/154#discussion_r440440400", "createdAt": "2020-06-15T20:53:16Z", "author": {"login": "mfbieber"}, "path": "src/main/java/de/bonndan/nivio/observation/ObserverRegistry.java", "diffHunk": "@@ -0,0 +1,109 @@\n+package de.bonndan.nivio.observation;\n+\n+import de.bonndan.nivio.IndexEvent;\n+import de.bonndan.nivio.ProcessingFinishedEvent;\n+import de.bonndan.nivio.input.LandscapeDescriptionFactory;\n+import de.bonndan.nivio.input.LandscapeUrlsFactory;\n+import de.bonndan.nivio.input.dto.LandscapeDescription;\n+import de.bonndan.nivio.model.Landscape;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.ApplicationEventPublisher;\n+import org.springframework.context.ApplicationListener;\n+import org.springframework.scheduling.annotation.Scheduled;\n+import org.springframework.stereotype.Service;\n+\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.util.*;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Service to register landscapes to observe description source changes.\n+ */\n+@Service\n+public class ObserverRegistry implements ApplicationListener<ProcessingFinishedEvent> {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ObserverRegistry.class);\n+\n+    private final Map<String, LandscapeObserverPool> observerMap = new ConcurrentHashMap<>();\n+    private final URLObserverFactory urlObserverFactory;\n+    private final LandscapeDescriptionFactory landscapeDescriptionFactory;\n+    private final LandscapeUrlsFactory landscapeUrlsFactory;\n+    private final ApplicationEventPublisher publisher;\n+\n+    public ObserverRegistry(URLObserverFactory urlObserverFactory,\n+                            LandscapeDescriptionFactory landscapeDescriptionFactory,\n+                            LandscapeUrlsFactory landscapeUrlsFactory,\n+                            ApplicationEventPublisher publisher\n+    ) {\n+        this.urlObserverFactory = urlObserverFactory;\n+        this.landscapeDescriptionFactory = landscapeDescriptionFactory;\n+        this.landscapeUrlsFactory = landscapeUrlsFactory;\n+        this.publisher = publisher;\n+    }\n+\n+    /**\n+     * Landscape are registered for observation here.\n+     * <p>\n+     * On processing success, {@link ProcessingFinishedEvent} is fired and read here to register the landscape.\n+     */\n+    @Override\n+    public void onApplicationEvent(ProcessingFinishedEvent event) {\n+        LandscapeDescription from = (LandscapeDescription) event.getSource();\n+        if (from == null) {\n+            LOGGER.warn(\"Landscape {} could not be registered for observation\", event.getLandscape().getIdentifier());\n+            return;\n+        }\n+\n+        URL sourceUrl = null;\n+        try {\n+            sourceUrl = new URL(from.getSource());\n+        } catch (MalformedURLException e) {\n+            LOGGER.info(\"Landscape {} does not seem to have a source\", from.getIdentifier());\n+        }\n+\n+        List<URL> landscapeSourceLocations = landscapeUrlsFactory.getLandscapeSourceLocations(from, sourceUrl);\n+        setLandscapeUrls(from, landscapeSourceLocations);\n+        LOGGER.info(\"Registered landscape {} for observation with {} urls.\", from, landscapeSourceLocations.size());\n+    }\n+\n+    /**\n+     * Polls for changes in landscapes.\n+     */\n+    @Scheduled(fixedDelay = 30000, initialDelay = 10000)\n+    public void poll() {\n+        LOGGER.info(\"Polling {} landscapes for changes.\", observerMap.size());\n+        observerMap.entrySet().parallelStream().forEach(e -> check(e.getValue()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050a21302abb895084b408d7ffbaa81faebfb356"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ0NDk2Mg==", "bodyText": "Just for my understanding, since you have already done a join above in line 44, would a .get() also do the job?", "url": "https://github.com/dedica-team/nivio/pull/154#discussion_r440444962", "createdAt": "2020-06-15T21:01:55Z", "author": {"login": "mfbieber"}, "path": "src/main/java/de/bonndan/nivio/observation/LandscapeObserverPool.java", "diffHunk": "@@ -0,0 +1,59 @@\n+package de.bonndan.nivio.observation;\n+\n+import de.bonndan.nivio.model.Landscape;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.util.StringUtils;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+/**\n+ * A wrapper around observers to reduce the async results to a single boolean.\n+ *\n+ *\n+ */\n+public class LandscapeObserverPool {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(LandscapeObserverPool.class);\n+    public static final String DELIM = \";\";\n+\n+    private final Landscape landscape;\n+    private final List<URLObserver> observers;\n+\n+    public LandscapeObserverPool(Landscape landscape, List<URLObserver> observers) {\n+        this.landscape = landscape;\n+        this.observers = observers;\n+    }\n+\n+    /**\n+     * @return the change\n+     */\n+    public Optional<String> hasChange() {\n+        LOGGER.info(\"Detecting changes in {} observers for landscape {}.\", observers.size(), landscape.getIdentifier());\n+\n+        CompletableFuture<String>[] futures = observers.stream().map(URLObserver::hasChange).toArray(CompletableFuture[]::new);\n+        CompletableFuture<Void> allDoneFuture = CompletableFuture.allOf(futures);\n+\n+        CompletableFuture<List<String>> listCompletableFuture = allDoneFuture.thenApply(\n+                v -> Stream.of(futures)\n+                        .map(CompletableFuture::join)\n+                        .filter(Objects::nonNull)\n+                        .collect(Collectors.toList())\n+        );\n+\n+        List<String> changes = listCompletableFuture.join();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050a21302abb895084b408d7ffbaa81faebfb356"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c8f661e5ee817e681b136b77e65fddb57f0000e", "author": {"user": {"login": "bonndan", "name": "Daniel Pozzi"}}, "url": "https://github.com/dedica-team/nivio/commit/4c8f661e5ee817e681b136b77e65fddb57f0000e", "committedDate": "2020-06-16T20:15:49Z", "message": "[#147] refactorings/cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88a8e7e7176eb2d9603c8ce5bdf29bb8006d1820", "author": {"user": null}, "url": "https://github.com/dedica-team/nivio/commit/88a8e7e7176eb2d9603c8ce5bdf29bb8006d1820", "committedDate": "2020-06-24T08:39:48Z", "message": "attempt to fix readEnvVars test without trying to modify system environment variables"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2NDQzODQ5", "url": "https://github.com/dedica-team/nivio/pull/154#pullrequestreview-436443849", "createdAt": "2020-06-24T08:43:13Z", "commit": {"oid": "88a8e7e7176eb2d9603c8ce5bdf29bb8006d1820"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwODo0MzoxM1rOGoItMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwODo0MzoxM1rOGoItMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDczODg2NQ==", "bodyText": "In my Windows 10 system, this is not able to modify the environment variables of the OS (although I see PRIVATE_TOKEN in a watcher while debugging in System.getenv()).\nWhat this test attempts to do is to verify that an env from the e.g. example_environment_vars.yml is read by the LandscapeDescriptionFactory, correct?\nSo reading e.g. just JAVA_HOME (which should be set on all OS we are using), will do the trick too? @bonndan : what do you think?", "url": "https://github.com/dedica-team/nivio/pull/154#discussion_r444738865", "createdAt": "2020-06-24T08:43:13Z", "author": {"login": "mfbieber"}, "path": "src/test/java/de/bonndan/nivio/input/LandscapeDescriptionFactoryTest.java", "diffHunk": "@@ -144,15 +146,13 @@ public void readEnvVars() throws IOException, NoSuchFieldException, IllegalAcces\n             if (\"java.util.Collections$UnmodifiableMap\".equals(c.getName())) {\n                 Field m = c.getDeclaredField(\"m\");\n                 m.setAccessible(true);\n-                var x = (Map<String, String>) m.get(System.getenv());\n-                x.put(\"PRIVATE_TOKEN\", \"veryPrivateToken\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88a8e7e7176eb2d9603c8ce5bdf29bb8006d1820"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9228182d6a3b4a9b8ef7b663bd5c634196c2dd13", "author": {"user": null}, "url": "https://github.com/dedica-team/nivio/commit/9228182d6a3b4a9b8ef7b663bd5c634196c2dd13", "committedDate": "2020-06-24T08:45:12Z", "message": "removed unneded imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a39db566550460c2f6dd18e092139dfdd6cf2c19", "author": {"user": {"login": "bonndan", "name": "Daniel Pozzi"}}, "url": "https://github.com/dedica-team/nivio/commit/a39db566550460c2f6dd18e092139dfdd6cf2c19", "committedDate": "2020-06-28T16:00:17Z", "message": "Merge branch 'develop' into 147_remove_directory_watcher"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3001, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}