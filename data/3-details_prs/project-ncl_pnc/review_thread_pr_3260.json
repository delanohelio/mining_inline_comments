{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyMzg5NjM3", "number": 3260, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwOTo0MjowNlrOEcf4ZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwOTo1NjoxOFrOEcgMtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4MzE3OTI0OnYy", "diffSide": "RIGHT", "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwOTo0MjowNlrOHHEXRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMDo1NjozMVrOHIK_hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE3MzU3Mw==", "bodyText": "What does \"AS agg\" accomplish? Is that intentional?", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r477173573", "createdAt": "2020-08-26T09:42:06Z", "author": {"login": "michalovjan"}, "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "diffHunk": "@@ -188,3 +188,34 @@ BEGIN transaction;\n     ALTER TABLE buildrecord ADD CONSTRAINT fk_buildrecord_norebuildcause\n     FOREIGN KEY (norebuildcause_id) REFERENCES buildrecord(id);\n COMMIT;\n+\n+\n+BEGIN transaction;\n+\n+    -- Verify that there are no duplicate data\n+    do $$\n+    declare\n+        total_dupes integer;\n+    begin\n+        SELECT count(*)\n+        INTO total_dupes\n+        FROM (SELECT built_artifact_id FROM build_record_built_artifact_map GROUP BY built_artifact_id HAVING count(*) > 1) AS agg;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4ef7279055637b9dd82eb2790d6b240ff6835e7"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI3ODM2MA==", "bodyText": "Fixes ERROR:  subquery in FROM must have an alias", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r478278360", "createdAt": "2020-08-27T09:21:13Z", "author": {"login": "janinko"}, "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "diffHunk": "@@ -188,3 +188,34 @@ BEGIN transaction;\n     ALTER TABLE buildrecord ADD CONSTRAINT fk_buildrecord_norebuildcause\n     FOREIGN KEY (norebuildcause_id) REFERENCES buildrecord(id);\n COMMIT;\n+\n+\n+BEGIN transaction;\n+\n+    -- Verify that there are no duplicate data\n+    do $$\n+    declare\n+        total_dupes integer;\n+    begin\n+        SELECT count(*)\n+        INTO total_dupes\n+        FROM (SELECT built_artifact_id FROM build_record_built_artifact_map GROUP BY built_artifact_id HAVING count(*) > 1) AS agg;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE3MzU3Mw=="}, "originalCommit": {"oid": "c4ef7279055637b9dd82eb2790d6b240ff6835e7"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMzMDc1Ng==", "bodyText": "Sure!", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r478330756", "createdAt": "2020-08-27T10:56:31Z", "author": {"login": "michalovjan"}, "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "diffHunk": "@@ -188,3 +188,34 @@ BEGIN transaction;\n     ALTER TABLE buildrecord ADD CONSTRAINT fk_buildrecord_norebuildcause\n     FOREIGN KEY (norebuildcause_id) REFERENCES buildrecord(id);\n COMMIT;\n+\n+\n+BEGIN transaction;\n+\n+    -- Verify that there are no duplicate data\n+    do $$\n+    declare\n+        total_dupes integer;\n+    begin\n+        SELECT count(*)\n+        INTO total_dupes\n+        FROM (SELECT built_artifact_id FROM build_record_built_artifact_map GROUP BY built_artifact_id HAVING count(*) > 1) AS agg;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE3MzU3Mw=="}, "originalCommit": {"oid": "c4ef7279055637b9dd82eb2790d6b240ff6835e7"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4MzIwMTY3OnYy", "diffSide": "RIGHT", "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwOTo0ODoxMlrOHHElUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwOTo0ODoxMlrOHHElUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE3NzE2OA==", "bodyText": "It should be\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                ALTER TABLE artifact ADD CONSTRAINT fk_artifact_buildrecord FOREIGN KEY (fk_artifact_buildrecord) REFERENCES buildrecord(id);\n          \n          \n            \n                ALTER TABLE artifact ADD CONSTRAINT fk_artifact_buildrecord FOREIGN KEY (buildrecord_id) REFERENCES buildrecord(id);", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r477177168", "createdAt": "2020-08-26T09:48:12Z", "author": {"login": "michalovjan"}, "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "diffHunk": "@@ -188,3 +188,34 @@ BEGIN transaction;\n     ALTER TABLE buildrecord ADD CONSTRAINT fk_buildrecord_norebuildcause\n     FOREIGN KEY (norebuildcause_id) REFERENCES buildrecord(id);\n COMMIT;\n+\n+\n+BEGIN transaction;\n+\n+    -- Verify that there are no duplicate data\n+    do $$\n+    declare\n+        total_dupes integer;\n+    begin\n+        SELECT count(*)\n+        INTO total_dupes\n+        FROM (SELECT built_artifact_id FROM build_record_built_artifact_map GROUP BY built_artifact_id HAVING count(*) > 1) AS agg;\n+\n+        assert total_dupes = 0;\n+    end$$;\n+\n+    -- Add new column to artifact table\n+    ALTER TABLE artifact ADD column buildrecord_id int4;\n+    CREATE INDEX idx_artifact_buildrecord ON artifact (buildrecord_id);\n+    ALTER TABLE artifact ADD CONSTRAINT fk_artifact_buildrecord FOREIGN KEY (fk_artifact_buildrecord) REFERENCES buildrecord(id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4ef7279055637b9dd82eb2790d6b240ff6835e7"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4MzIxNzgzOnYy", "diffSide": "RIGHT", "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwOTo1MjozMVrOHHEvNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwOTo1MjozMVrOHHEvNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE3OTcwMw==", "bodyText": "Add the Index also to Artifact model here \n  \n    \n      pnc/model/src/main/java/org/jboss/pnc/model/Artifact.java\n    \n    \n         Line 71\n      in\n      b9b4867\n    \n    \n    \n    \n\n        \n          \n           indexes = { @Index(name = \"idx_artifact_targetRepository\", columnList = \"targetRepository_id\"),", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r477179703", "createdAt": "2020-08-26T09:52:31Z", "author": {"login": "michalovjan"}, "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "diffHunk": "@@ -188,3 +188,34 @@ BEGIN transaction;\n     ALTER TABLE buildrecord ADD CONSTRAINT fk_buildrecord_norebuildcause\n     FOREIGN KEY (norebuildcause_id) REFERENCES buildrecord(id);\n COMMIT;\n+\n+\n+BEGIN transaction;\n+\n+    -- Verify that there are no duplicate data\n+    do $$\n+    declare\n+        total_dupes integer;\n+    begin\n+        SELECT count(*)\n+        INTO total_dupes\n+        FROM (SELECT built_artifact_id FROM build_record_built_artifact_map GROUP BY built_artifact_id HAVING count(*) > 1) AS agg;\n+\n+        assert total_dupes = 0;\n+    end$$;\n+\n+    -- Add new column to artifact table\n+    ALTER TABLE artifact ADD column buildrecord_id int4;\n+    CREATE INDEX idx_artifact_buildrecord ON artifact (buildrecord_id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4ef7279055637b9dd82eb2790d6b240ff6835e7"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4MzIzMTI3OnYy", "diffSide": "RIGHT", "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwOTo1NjoxOFrOHHE3tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMDo1Njo0OVrOHILAEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE4MTg3Ng==", "bodyText": "Are old associated indexes and constraints also dropped or do you have to do it manually?", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r477181876", "createdAt": "2020-08-26T09:56:18Z", "author": {"login": "michalovjan"}, "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "diffHunk": "@@ -188,3 +188,34 @@ BEGIN transaction;\n     ALTER TABLE buildrecord ADD CONSTRAINT fk_buildrecord_norebuildcause\n     FOREIGN KEY (norebuildcause_id) REFERENCES buildrecord(id);\n COMMIT;\n+\n+\n+BEGIN transaction;\n+\n+    -- Verify that there are no duplicate data\n+    do $$\n+    declare\n+        total_dupes integer;\n+    begin\n+        SELECT count(*)\n+        INTO total_dupes\n+        FROM (SELECT built_artifact_id FROM build_record_built_artifact_map GROUP BY built_artifact_id HAVING count(*) > 1) AS agg;\n+\n+        assert total_dupes = 0;\n+    end$$;\n+\n+    -- Add new column to artifact table\n+    ALTER TABLE artifact ADD column buildrecord_id int4;\n+    CREATE INDEX idx_artifact_buildrecord ON artifact (buildrecord_id);\n+    ALTER TABLE artifact ADD CONSTRAINT fk_artifact_buildrecord FOREIGN KEY (fk_artifact_buildrecord) REFERENCES buildrecord(id);\n+\n+    -- Copy data from old table\n+    UPDATE artifact\n+        SET buildrecord_id = build_record_built_artifact_map.build_record_id\n+        FROM build_record_built_artifact_map\n+        WHERE artifact.id = build_record_built_artifact_map.built_artifact_id;\n+\n+    -- Drop the old table\n+    DROP TABLE build_record_built_artifact_map;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4ef7279055637b9dd82eb2790d6b240ff6835e7"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI4MTUwOQ==", "bodyText": "Seems so.", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r478281509", "createdAt": "2020-08-27T09:26:29Z", "author": {"login": "janinko"}, "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "diffHunk": "@@ -188,3 +188,34 @@ BEGIN transaction;\n     ALTER TABLE buildrecord ADD CONSTRAINT fk_buildrecord_norebuildcause\n     FOREIGN KEY (norebuildcause_id) REFERENCES buildrecord(id);\n COMMIT;\n+\n+\n+BEGIN transaction;\n+\n+    -- Verify that there are no duplicate data\n+    do $$\n+    declare\n+        total_dupes integer;\n+    begin\n+        SELECT count(*)\n+        INTO total_dupes\n+        FROM (SELECT built_artifact_id FROM build_record_built_artifact_map GROUP BY built_artifact_id HAVING count(*) > 1) AS agg;\n+\n+        assert total_dupes = 0;\n+    end$$;\n+\n+    -- Add new column to artifact table\n+    ALTER TABLE artifact ADD column buildrecord_id int4;\n+    CREATE INDEX idx_artifact_buildrecord ON artifact (buildrecord_id);\n+    ALTER TABLE artifact ADD CONSTRAINT fk_artifact_buildrecord FOREIGN KEY (fk_artifact_buildrecord) REFERENCES buildrecord(id);\n+\n+    -- Copy data from old table\n+    UPDATE artifact\n+        SET buildrecord_id = build_record_built_artifact_map.build_record_id\n+        FROM build_record_built_artifact_map\n+        WHERE artifact.id = build_record_built_artifact_map.built_artifact_id;\n+\n+    -- Drop the old table\n+    DROP TABLE build_record_built_artifact_map;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE4MTg3Ng=="}, "originalCommit": {"oid": "c4ef7279055637b9dd82eb2790d6b240ff6835e7"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMzMDg5OQ==", "bodyText": "ok", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r478330899", "createdAt": "2020-08-27T10:56:49Z", "author": {"login": "michalovjan"}, "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "diffHunk": "@@ -188,3 +188,34 @@ BEGIN transaction;\n     ALTER TABLE buildrecord ADD CONSTRAINT fk_buildrecord_norebuildcause\n     FOREIGN KEY (norebuildcause_id) REFERENCES buildrecord(id);\n COMMIT;\n+\n+\n+BEGIN transaction;\n+\n+    -- Verify that there are no duplicate data\n+    do $$\n+    declare\n+        total_dupes integer;\n+    begin\n+        SELECT count(*)\n+        INTO total_dupes\n+        FROM (SELECT built_artifact_id FROM build_record_built_artifact_map GROUP BY built_artifact_id HAVING count(*) > 1) AS agg;\n+\n+        assert total_dupes = 0;\n+    end$$;\n+\n+    -- Add new column to artifact table\n+    ALTER TABLE artifact ADD column buildrecord_id int4;\n+    CREATE INDEX idx_artifact_buildrecord ON artifact (buildrecord_id);\n+    ALTER TABLE artifact ADD CONSTRAINT fk_artifact_buildrecord FOREIGN KEY (fk_artifact_buildrecord) REFERENCES buildrecord(id);\n+\n+    -- Copy data from old table\n+    UPDATE artifact\n+        SET buildrecord_id = build_record_built_artifact_map.build_record_id\n+        FROM build_record_built_artifact_map\n+        WHERE artifact.id = build_record_built_artifact_map.built_artifact_id;\n+\n+    -- Drop the old table\n+    DROP TABLE build_record_built_artifact_map;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE4MTg3Ng=="}, "originalCommit": {"oid": "c4ef7279055637b9dd82eb2790d6b240ff6835e7"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1752, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}