{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4NjM3NDk5", "number": 3341, "title": "[NCL-5812] Fix lazy loading workarounds", "bodyText": "", "createdAt": "2020-10-06T15:25:40Z", "url": "https://github.com/project-ncl/pnc/pull/3341", "merged": true, "mergeCommit": {"oid": "263a2e31c388e5c0a5d1c9f61308ead070d0390c"}, "closed": true, "closedAt": "2020-11-02T14:24:17Z", "author": {"login": "janinko"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP6F2bgFqTUwMzA5MDE2OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYiZbjABqjM5NDc1MDAwODA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMDkwMTY4", "url": "https://github.com/project-ncl/pnc/pull/3341#pullrequestreview-503090168", "createdAt": "2020-10-06T15:26:59Z", "commit": {"oid": "75f2e91d2490926fa78a10e432e2ddb51f3ddc0d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNToyNjo1OVrOHdNUkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNToyNjo1OVrOHdNUkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM4OTAwOA==", "bodyText": "Don't mind the cast here, it is for this prototype only. I would add the method to the root interface.", "url": "https://github.com/project-ncl/pnc/pull/3341#discussion_r500389008", "createdAt": "2020-10-06T15:26:59Z", "author": {"login": "janinko"}, "path": "facade/src/main/java/org/jboss/pnc/facade/providers/ProductMilestoneProviderImpl.java", "diffHunk": "@@ -113,28 +113,19 @@ public ProductMilestoneProviderImpl(\n     @Override\n     public ProductMilestone update(String id, ProductMilestone restEntity) {\n         validateBeforeUpdating(id, restEntity);\n-\n         org.jboss.pnc.model.ProductMilestone milestoneInDb = repository.queryById(Integer.valueOf(id));\n-        org.jboss.pnc.model.ProductMilestone milestoneRestDb = mapper.toEntity(restEntity);\n-\n         // we can't modify milestone if it's already released\n         if (milestoneInDb.getEndDate() != null) {\n             log.info(\"Milestone is already closed: no more modifications allowed\");\n             throw new RepositoryViolationException(\"Milestone is already closed! No more modifications allowed\");\n         }\n \n         log.debug(\"Updating milestone for id: {}\", id);\n-        milestoneRestDb.setId(Integer.valueOf(id));\n-\n-        // make sure that user cannot set the 'endDate' via the REST API\n-        // this should only be set after the release process is successful\n-        milestoneRestDb.setEndDate(milestoneInDb.getEndDate());\n-        // Make sure that user cannot change the product release of the milestone. This is set on release creation.\n-        milestoneRestDb.setProductRelease(milestoneInDb.getProductRelease());\n+        ((ProductMilestoneMapper) mapper).mergeEntity(restEntity, milestoneInDb);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75f2e91d2490926fa78a10e432e2ddb51f3ddc0d"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMDk1Mzcy", "url": "https://github.com/project-ncl/pnc/pull/3341#pullrequestreview-503095372", "createdAt": "2020-10-06T15:31:58Z", "commit": {"oid": "75f2e91d2490926fa78a10e432e2ddb51f3ddc0d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTozMTo1OVrOHdNnbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTozMTo1OVrOHdNnbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM5MzgzNw==", "bodyText": "productVersion is updatable=false", "url": "https://github.com/project-ncl/pnc/pull/3341#discussion_r500393837", "createdAt": "2020-10-06T15:31:59Z", "author": {"login": "janinko"}, "path": "mapper/src/main/java/org/jboss/pnc/mapper/api/ProductMilestoneMapper.java", "diffHunk": "@@ -42,6 +43,23 @@\n     @Mapping(target = \"performedBuilds\", ignore = true)\n     ProductMilestone toEntity(org.jboss.pnc.dto.ProductMilestone dtoEntity);\n \n+    /**\n+     * Merges DTO entity into database entity.\n+     *\n+     * @param dtoEntity DTO entity to be converted.\n+     * @param target\n+     */\n+    @Mapping(target = \"id\", ignore = true)\n+    // make sure that user cannot set the 'endDate' via the REST API\n+    // this should only be set after the release process is successful\n+    @Mapping(target = \"endDate\", ignore = true)\n+    @Mapping(target = \"productVersion\", ignore = true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75f2e91d2490926fa78a10e432e2ddb51f3ddc0d"}, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "75f2e91d2490926fa78a10e432e2ddb51f3ddc0d", "author": {"user": {"login": "janinko", "name": "Honza Br\u00e1zdil"}}, "url": "https://github.com/project-ncl/pnc/commit/75f2e91d2490926fa78a10e432e2ddb51f3ddc0d", "committedDate": "2020-10-06T15:24:59Z", "message": "Example: How to do updates correctly"}, "afterCommit": {"oid": "7c80c8e866aa3ff4d916df963da01dd9dec0b7e8", "author": {"user": {"login": "janinko", "name": "Honza Br\u00e1zdil"}}, "url": "https://github.com/project-ncl/pnc/commit/7c80c8e866aa3ff4d916df963da01dd9dec0b7e8", "committedDate": "2020-10-29T18:05:39Z", "message": "[NCL-5812] Add AbstractUpdatableProvider usin new updateEntity mapper methods to fix JPA problems"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5OTQ2MDY3", "url": "https://github.com/project-ncl/pnc/pull/3341#pullrequestreview-519946067", "createdAt": "2020-10-29T18:11:54Z", "commit": {"oid": "7c80c8e866aa3ff4d916df963da01dd9dec0b7e8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODoxMTo1NFrOHqomiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODoxMTo1NFrOHqomiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ2NzQ2NA==", "bodyText": "MWAHAHA", "url": "https://github.com/project-ncl/pnc/pull/3341#discussion_r514467464", "createdAt": "2020-10-29T18:11:54Z", "author": {"login": "janinko"}, "path": "facade/src/main/java/org/jboss/pnc/facade/providers/GroupConfigurationProviderImpl.java", "diffHunk": "@@ -78,19 +78,13 @@ public GroupConfiguration getSpecific(String id) {\n     }\n \n     @Override\n-    public GroupConfiguration update(String id, GroupConfiguration restEntity) {\n-        validateBeforeUpdating(id, restEntity);\n-        log.debug(\"Updating entity: \" + restEntity);\n-        BuildConfigurationSet dbEntity = repository.queryById(Integer.valueOf(id));\n+    protected void validateBeforeUpdating(String id, GroupConfiguration restEntity) {\n+        super.validateBeforeUpdating(id, restEntity);\n+\n+        BuildConfigurationSet dbEntity = findInDB(id);\n         if (dbEntity.isArchived()) {\n             throw new RepositoryViolationException(\"The Group Config \" + id + \" is already deleted.\");\n         }\n-        // DO NOT REMOVE - Triggers the inizialization of LAZY collections (fixes NCL-5804)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c80c8e866aa3ff4d916df963da01dd9dec0b7e8"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNDczNzcy", "url": "https://github.com/project-ncl/pnc/pull/3341#pullrequestreview-520473772", "createdAt": "2020-10-30T08:53:56Z", "commit": {"oid": "7c80c8e866aa3ff4d916df963da01dd9dec0b7e8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwODo1Mzo1NlrOHrGE5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwODo1Mzo1NlrOHrGE5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk1MDM3Mg==", "bodyText": "are these leftovers logs for debugging? you may want to remove them?", "url": "https://github.com/project-ncl/pnc/pull/3341#discussion_r514950372", "createdAt": "2020-10-30T08:53:56Z", "author": {"login": "vibe13"}, "path": "facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java", "diffHunk": "@@ -152,9 +122,33 @@ protected void validateBeforeSaving(ProductVersion restEntity) {\n     protected void validateBeforeUpdating(String id, ProductVersion restEntity) {\n         super.validateBeforeUpdating(id, restEntity);\n \n+        validateVersionChange(id, restEntity);\n+        validateGroupConfigsBeforeUpdating(id, restEntity);\n+    }\n+\n+    private void validateVersionChange(String id, ProductVersion restEntity) throws InvalidEntityException {\n+        org.jboss.pnc.model.ProductVersion entityInDb = findInDB(id);\n+        boolean changingVersion = !entityInDb.getVersion().equals(restEntity.getVersion());\n+        if (changingVersion) {\n+            boolean hasClosedMilestone = entityInDb.getProductMilestones()\n+                    .stream()\n+                    .anyMatch(milestone -> milestone.getEndDate() != null);\n+            if (hasClosedMilestone) {\n+                throw new InvalidEntityException(\n+                        \"Cannot change version due to having closed milestone. Product version id: \" + id);\n+            }\n+        }\n+    }\n+\n+    private void validateGroupConfigsBeforeUpdating(String id, ProductVersion restEntity)\n+            throws InvalidEntityException, NumberFormatException, ConflictedEntryException {\n         if (restEntity.getGroupConfigs() != null) {\n             for (String groupConfigId : restEntity.getGroupConfigs().keySet()) {\n+                log.warn(\"Checking group config: \" + groupConfigId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c80c8e866aa3ff4d916df963da01dd9dec0b7e8"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNDc5NTY2", "url": "https://github.com/project-ncl/pnc/pull/3341#pullrequestreview-520479566", "createdAt": "2020-10-30T09:02:24Z", "commit": {"oid": "7c80c8e866aa3ff4d916df963da01dd9dec0b7e8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c80c8e866aa3ff4d916df963da01dd9dec0b7e8", "author": {"user": {"login": "janinko", "name": "Honza Br\u00e1zdil"}}, "url": "https://github.com/project-ncl/pnc/commit/7c80c8e866aa3ff4d916df963da01dd9dec0b7e8", "committedDate": "2020-10-29T18:05:39Z", "message": "[NCL-5812] Add AbstractUpdatableProvider usin new updateEntity mapper methods to fix JPA problems"}, "afterCommit": {"oid": "2b3acc980beeb39a2d93ec8a10271489b68b699e", "author": {"user": {"login": "janinko", "name": "Honza Br\u00e1zdil"}}, "url": "https://github.com/project-ncl/pnc/commit/2b3acc980beeb39a2d93ec8a10271489b68b699e", "committedDate": "2020-11-02T10:24:28Z", "message": "[NCL-5812] Add AbstractUpdatableProvider usin new updateEntity mapper methods to fix JPA problems"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d890cead88315e47d5b51b38655d0184350b71b", "author": {"user": {"login": "janinko", "name": "Honza Br\u00e1zdil"}}, "url": "https://github.com/project-ncl/pnc/commit/6d890cead88315e47d5b51b38655d0184350b71b", "committedDate": "2020-11-02T10:35:50Z", "message": "Move AbstractArtifactMapper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93b46e339d223122ffbd46b3b64cc8bfb2c3f30e", "author": {"user": {"login": "janinko", "name": "Honza Br\u00e1zdil"}}, "url": "https://github.com/project-ncl/pnc/commit/93b46e339d223122ffbd46b3b64cc8bfb2c3f30e", "committedDate": "2020-11-02T10:35:50Z", "message": "[NCL-5812] Add UpdatableEntityMapper with updateEntiy method to update JPA entity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0291359dba9db6bfda56c190952f3d3a8d10b8d", "author": {"user": {"login": "janinko", "name": "Honza Br\u00e1zdil"}}, "url": "https://github.com/project-ncl/pnc/commit/c0291359dba9db6bfda56c190952f3d3a8d10b8d", "committedDate": "2020-11-02T10:55:50Z", "message": "[NCL-5812] Add AbstractUpdatableProvider usin new updateEntity mapper methods to fix JPA problems"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b3acc980beeb39a2d93ec8a10271489b68b699e", "author": {"user": {"login": "janinko", "name": "Honza Br\u00e1zdil"}}, "url": "https://github.com/project-ncl/pnc/commit/2b3acc980beeb39a2d93ec8a10271489b68b699e", "committedDate": "2020-11-02T10:24:28Z", "message": "[NCL-5812] Add AbstractUpdatableProvider usin new updateEntity mapper methods to fix JPA problems"}, "afterCommit": {"oid": "c0291359dba9db6bfda56c190952f3d3a8d10b8d", "author": {"user": {"login": "janinko", "name": "Honza Br\u00e1zdil"}}, "url": "https://github.com/project-ncl/pnc/commit/c0291359dba9db6bfda56c190952f3d3a8d10b8d", "committedDate": "2020-11-02T10:55:50Z", "message": "[NCL-5812] Add AbstractUpdatableProvider usin new updateEntity mapper methods to fix JPA problems"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2537, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}