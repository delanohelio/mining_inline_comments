{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NTQyMzcy", "number": 3048, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwOToyNzo1NVrOD_mD6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwOTozMToyM1rOD_mI4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MDEwNDc1OnYy", "diffSide": "RIGHT", "path": "integration-test/src/test/java/org/jboss/pnc/integration_new/endpoint/BuildConfigurationEndpointTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwOToyNzo1NVrOGaWGdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwOToyNzo1NVrOGaWGdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI3ODI2MA==", "bodyText": "You are traing to make a copy of existing? Are you sure it's failing because of non-null id and not for example existing name?", "url": "https://github.com/project-ncl/pnc/pull/3048#discussion_r430278260", "createdAt": "2020-05-26T09:27:55Z", "author": {"login": "janinko"}, "path": "integration-test/src/test/java/org/jboss/pnc/integration_new/endpoint/BuildConfigurationEndpointTest.java", "diffHunk": "@@ -606,4 +613,151 @@ public void shouldUpdateBuildConfigurationWithDependencies() throws ClientExcept\n         assertThat(updatedBC.getEnvironment().getId()).isEqualTo(environmentId);\n         assertThat(modificationTime).isNotEqualTo(updatedBC.getModificationTime());\n     }\n+\n+    @Test\n+    @InSequence(61)\n+    public void shouldChangeRepositoryConfiguration() throws ClientException {\n+        // given\n+        BuildConfigurationClient bcClient = new BuildConfigurationClient(RestClientConfiguration.asUser());\n+        SCMRepositoryClient scmClient = new SCMRepositoryClient(RestClientConfiguration.asAnonymous());\n+        BuildConfiguration buildConfiguration = bcClient.getSpecific(configuration4Id);\n+\n+        // make sure this RC is not already set\n+        assertThat(buildConfiguration.getScmRepository().getId()).isNotEqualTo(repositoryConfiguration2Id);\n+\n+        // when\n+        BuildConfiguration updateBC = BuildConfiguration.builder()\n+                .id(buildConfiguration.getId())\n+                .name(buildConfiguration.getName())\n+                .buildScript(buildConfiguration.getBuildScript())\n+                .creationTime(buildConfiguration.getCreationTime())\n+                .modificationTime(buildConfiguration.getModificationTime())\n+                .project(buildConfiguration.getProject())\n+                .environment(buildConfiguration.getEnvironment())\n+                .parameters(buildConfiguration.getParameters())\n+                .scmRepository(scmClient.getSpecific(repositoryConfiguration2Id))\n+                .buildType(buildConfiguration.getBuildType())\n+                .build();\n+        bcClient.update(updateBC.getId(), updateBC);\n+        BuildConfiguration updatedBC = bcClient.getSpecific(updateBC.getId());\n+\n+        // then\n+        assertThat(updateBC.getScmRepository().getId()).isEqualTo(repositoryConfiguration2Id);\n+    }\n+\n+    @Test\n+    public void shouldFailToCreateNewBuildConfigurationBecauseIdIsNotNull() throws ClientException {\n+        BuildConfigurationClient client = new BuildConfigurationClient(RestClientConfiguration.asUser());\n+\n+        BuildConfiguration bc = client.getSpecific(configurationId);\n+\n+        assertThatThrownBy(() -> client.createNew(bc)).hasCauseInstanceOf(BadRequestException.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd8f05ee6f795abd81caf1376a378fe5ab43c3e3"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MDExNzQ3OnYy", "diffSide": "RIGHT", "path": "integration-test/src/test/java/org/jboss/pnc/integration_new/endpoint/BuildConfigurationEndpointTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwOTozMToyM1rOGaWOiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwOTozMToyM1rOGaWOiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI4MDMzMQ==", "bodyText": "Please mention the test in the issue when merged", "url": "https://github.com/project-ncl/pnc/pull/3048#discussion_r430280331", "createdAt": "2020-05-26T09:31:23Z", "author": {"login": "janinko"}, "path": "integration-test/src/test/java/org/jboss/pnc/integration_new/endpoint/BuildConfigurationEndpointTest.java", "diffHunk": "@@ -606,4 +613,151 @@ public void shouldUpdateBuildConfigurationWithDependencies() throws ClientExcept\n         assertThat(updatedBC.getEnvironment().getId()).isEqualTo(environmentId);\n         assertThat(modificationTime).isNotEqualTo(updatedBC.getModificationTime());\n     }\n+\n+    @Test\n+    @InSequence(61)\n+    public void shouldChangeRepositoryConfiguration() throws ClientException {\n+        // given\n+        BuildConfigurationClient bcClient = new BuildConfigurationClient(RestClientConfiguration.asUser());\n+        SCMRepositoryClient scmClient = new SCMRepositoryClient(RestClientConfiguration.asAnonymous());\n+        BuildConfiguration buildConfiguration = bcClient.getSpecific(configuration4Id);\n+\n+        // make sure this RC is not already set\n+        assertThat(buildConfiguration.getScmRepository().getId()).isNotEqualTo(repositoryConfiguration2Id);\n+\n+        // when\n+        BuildConfiguration updateBC = BuildConfiguration.builder()\n+                .id(buildConfiguration.getId())\n+                .name(buildConfiguration.getName())\n+                .buildScript(buildConfiguration.getBuildScript())\n+                .creationTime(buildConfiguration.getCreationTime())\n+                .modificationTime(buildConfiguration.getModificationTime())\n+                .project(buildConfiguration.getProject())\n+                .environment(buildConfiguration.getEnvironment())\n+                .parameters(buildConfiguration.getParameters())\n+                .scmRepository(scmClient.getSpecific(repositoryConfiguration2Id))\n+                .buildType(buildConfiguration.getBuildType())\n+                .build();\n+        bcClient.update(updateBC.getId(), updateBC);\n+        BuildConfiguration updatedBC = bcClient.getSpecific(updateBC.getId());\n+\n+        // then\n+        assertThat(updateBC.getScmRepository().getId()).isEqualTo(repositoryConfiguration2Id);\n+    }\n+\n+    @Test\n+    public void shouldFailToCreateNewBuildConfigurationBecauseIdIsNotNull() throws ClientException {\n+        BuildConfigurationClient client = new BuildConfigurationClient(RestClientConfiguration.asUser());\n+\n+        BuildConfiguration bc = client.getSpecific(configurationId);\n+\n+        assertThatThrownBy(() -> client.createNew(bc)).hasCauseInstanceOf(BadRequestException.class);\n+    }\n+\n+    @Test\n+    public void shouldGetConflictWhenCreatingNewBuildConfigurationWithTheSameNameAndProjectId() throws ClientException {\n+        BuildConfigurationClient client = new BuildConfigurationClient(RestClientConfiguration.asUser());\n+\n+        BuildConfiguration bc = client.getSpecific(configurationId);\n+\n+        BuildConfiguration duplicate = BuildConfiguration.builder()\n+                .name(bc.getName())\n+                .buildScript(bc.getBuildScript())\n+                .project(bc.getProject())\n+                .environment(bc.getEnvironment())\n+                .parameters(bc.getParameters())\n+                .scmRepository(bc.getScmRepository())\n+                .buildType(bc.getBuildType())\n+                .build();\n+\n+        assertThatThrownBy(() -> client.createNew(duplicate)).hasCauseInstanceOf(ClientErrorException.class)\n+                .has(\n+                        new Condition<Throwable>(\n+                                (e -> ((ClientErrorException) e.getCause()).getResponse().getStatus() == 409),\n+                                \"HTTP 409 Conflict\"));\n+    }\n+\n+    @Test\n+    public void shouldFailToCreateBuildConfigurationWhichDoesntMatchRegexp() throws ClientException {\n+        BuildConfigurationClient client = new BuildConfigurationClient(RestClientConfiguration.asUser());\n+\n+        BuildConfiguration bc = client.getSpecific(configurationId);\n+\n+        BuildConfiguration invalidName = BuildConfiguration.builder()\n+                .name(\":\")\n+                .buildScript(bc.getBuildScript())\n+                .project(bc.getProject())\n+                .environment(bc.getEnvironment())\n+                .parameters(bc.getParameters())\n+                .scmRepository(bc.getScmRepository())\n+                .buildType(bc.getBuildType())\n+                .build();\n+\n+        assertThatThrownBy(() -> client.createNew(invalidName)).hasCauseInstanceOf(BadRequestException.class);\n+    }\n+\n+    @Test\n+    public void shouldNotCreateWithInternalUrlNotMatchingPattern() throws ClientException {\n+        BuildConfigurationClient client = new BuildConfigurationClient(RestClientConfiguration.asUser());\n+\n+        BuildConfiguration bc = client.getSpecific(configurationId);\n+        BuildConfiguration newBC = BuildConfiguration.builder()\n+                .name(\"othername\")\n+                .buildScript(bc.getBuildScript())\n+                .project(bc.getProject())\n+                .environment(bc.getEnvironment())\n+                .parameters(bc.getParameters())\n+                .buildType(bc.getBuildType())\n+                .build();\n+\n+        BuildConfigWithSCMRequest request = BuildConfigWithSCMRequest.builder()\n+                .buildConfig(newBC)\n+                .scmUrl(\"ssh://git@github.com:22/gerrit/newRepo.git\")\n+                .build();\n+        assertThatThrownBy(() -> client.createWithSCM(request)).hasCauseInstanceOf(BadRequestException.class);\n+        BuildConfigWithSCMRequest request2 = BuildConfigWithSCMRequest.builder()\n+                .buildConfig(newBC)\n+                .scmUrl(\"ssh://git@github.com:22/foo/newRepo\")\n+                .build();\n+        assertThatThrownBy(() -> client.createWithSCM(request2)).hasCauseInstanceOf(BadRequestException.class);\n+    }\n+\n+    @Test\n+    @InSequence(62)\n+    public void shouldCreateWithInternalUrlMatchingPattern() throws ClientException {\n+        // given\n+        BuildConfigurationClient client = new BuildConfigurationClient(RestClientConfiguration.asUser());\n+\n+        BuildConfiguration bc = client.getSpecific(configurationId);\n+        BuildConfiguration newBC = BuildConfiguration.builder()\n+                .name(\"othernameforbc\")\n+                .buildScript(bc.getBuildScript())\n+                .project(bc.getProject())\n+                .environment(bc.getEnvironment())\n+                .parameters(bc.getParameters())\n+                .buildType(bc.getBuildType())\n+                .build();\n+\n+        BuildConfigWithSCMRequest request = BuildConfigWithSCMRequest.builder()\n+                .buildConfig(newBC)\n+                .scmUrl(\"ssh://git@github.com:22/newUser/newRepo.git\")\n+                .build();\n+\n+        BuildConfigCreationResponse received = client.createWithSCM(request);\n+\n+        assertThat(received).isNotNull();\n+        assertThat(received.getBuildConfig().getId()).isNotNull();\n+        assertThat(client.getSpecific(received.getBuildConfig().getId()))\n+                .hasFieldOrPropertyWithValue(\"name\", \"othernameforbc\");\n+    }\n+\n+    // TODO Test will fail due to issue: NCL-4473, remove @Ignore when fixed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd8f05ee6f795abd81caf1376a378fe5ab43c3e3"}, "originalPosition": 177}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1881, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}