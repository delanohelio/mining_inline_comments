{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzNzY0OTY5", "number": 2970, "reviewThreads": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMzo0MjoxNFrODyE8Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjozMzowNFrODz0Sdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzODM2Mzc0OnYy", "diffSide": "RIGHT", "path": "bpm/src/main/java/org/jboss/pnc/bpm/causeway/BuildPushTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMzo0MjoxNVrOGF6R_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMzo0MjoxNVrOGF6R_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg1MDk0MQ==", "bodyText": "Rename: confusing with BPM task", "url": "https://github.com/project-ncl/pnc/pull/2970#discussion_r408850941", "createdAt": "2020-04-15T13:42:15Z", "author": {"login": "matejonnet"}, "path": "bpm/src/main/java/org/jboss/pnc/bpm/causeway/BuildPushTask.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/**\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2014-2020 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.jboss.pnc.bpm.causeway;\n+\n+import lombok.Value;\n+import org.jboss.pnc.model.BuildRecord;\n+\n+import java.util.UUID;\n+\n+@Value\n+public class BuildPushTask {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84c1a984e0a4ed21904873032649b712a381e7a"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzODQ1NjcxOnYy", "diffSide": "RIGHT", "path": "facade/src/main/java/org/jboss/pnc/facade/impl/BrewPusherImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNDowMToyNFrOGF7Ljg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNDowMToyNFrOGF7Ljg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg2NTY3OA==", "bodyText": "The push result is not stored to the BuildRecord that the user pushed.\neg. we have ID10-NO_REQUIRED, the result is stored to the previous ID9.\nShould the exception be thrown (not_allowed) in case of single build?\nAlso consider the case:\nID10-NO_REQUIRED\n\nuser force rebuild to record ID11\nwhen they try to push ID10, ID11 is pushed instead", "url": "https://github.com/project-ncl/pnc/pull/2970#discussion_r408865678", "createdAt": "2020-04-15T14:01:24Z", "author": {"login": "matejonnet"}, "path": "facade/src/main/java/org/jboss/pnc/facade/impl/BrewPusherImpl.java", "diffHunk": "@@ -73,63 +93,164 @@\n     private UserService userService;\n \n     @Override\n-    public void pushGroup(int id, String tagPrefix) {\n-\n+    public Set<BuildPushResult> pushGroup(int buildGroupId, String tagPrefix) {\n+        BuildPushParameters buildPushParameters = BuildPushParameters.builder()\n+                .tagPrefix(tagPrefix)\n+                .reimport(false)\n+                .build();\n         List<BuildRecord> buildRecords = buildRecordRepository\n-                .queryWithPredicates(BuildRecordPredicates.withBuildConfigSetRecordId(id));\n+                .queryWithPredicates(BuildRecordPredicates.withBuildConfigSetRecordId(buildGroupId));\n \n-        Set<String> buildRecordsIds = buildRecords.stream()\n-                .map(BuildRecord::getId)\n-                .map(String::valueOf)\n-                .collect(Collectors.toSet());\n-\n-        Set<Result> pushed = buildResultPushManager\n-                .push(buildRecordsIds, userService.currentUserToken(), getCompleteCallbackUrl(), tagPrefix, false);\n+        Set<BuildPushResult> results = new HashSet<>();\n+        for (BuildRecord buildRecord : buildRecords) {\n+            UUID buildPushResultId = UUID.randomUUID();\n+            MDCUtils.addProcessContext(buildPushResultId.toString());\n+            MDCUtils.addCustomContext(LOG_CONTEXT_BUILD_ID, buildRecord.getId().toString());\n+            try {\n+                results.add(doPushBuild(buildRecord.getId(), buildPushParameters, buildPushResultId));\n+            } catch (OperationNotAllowedException e) {\n+                results.add(\n+                        BuildPushResult.builder()\n+                                .status(BuildPushStatus.REJECTED)\n+                                .id(buildPushResultId.toString())\n+                                .buildId(buildRecord.getId().toString())\n+                                .message(e.getMessage())\n+                                .build());\n+            } catch (InconsistentDataException e) {\n+                results.add(\n+                        BuildPushResult.builder()\n+                                .status(BuildPushStatus.SYSTEM_ERROR)\n+                                .id(buildPushResultId.toString())\n+                                .buildId(buildRecord.getId().toString())\n+                                .message(e.getMessage())\n+                                .build());\n+            } catch (AlreadyRunningException e) {\n+                results.add(\n+                        BuildPushResult.builder()\n+                                .status(BuildPushStatus.REJECTED)\n+                                .id(buildPushResultId.toString())\n+                                .buildId(buildRecord.getId().toString())\n+                                .message(e.getMessage())\n+                                .build());\n+            } catch (ProcessException e) {\n+                results.add(\n+                        BuildPushResult.builder()\n+                                .status(BuildPushStatus.SYSTEM_ERROR)\n+                                .id(buildPushResultId.toString())\n+                                .buildId(buildRecord.getId().toString())\n+                                .message(e.getMessage())\n+                                .build());\n+            } finally {\n+                MDCUtils.removeProcessContext();\n+                MDCUtils.removeCustomContext(LOG_CONTEXT_BUILD_ID);\n+            }\n+        }\n+        return results;\n     }\n \n     @Override\n-    public BuildPushResult brewPush(String id, BuildPushRequest buildPushRequest) throws ProcessException {\n+    public BuildPushResult pushBuild(String buildId, BuildPushParameters buildPushParameters) throws ProcessException {\n+        UUID buildPushResultId = UUID.randomUUID();\n+        MDCUtils.addProcessContext(buildPushResultId.toString());\n+        MDCUtils.addCustomContext(LOG_CONTEXT_BUILD_ID, buildId);\n+        try {\n+            return doPushBuild(Integer.parseInt(buildId), buildPushParameters, buildPushResultId);\n+        } finally {\n+            MDCUtils.removeProcessContext();\n+            MDCUtils.removeCustomContext(LOG_CONTEXT_BUILD_ID);\n+        }\n+    }\n \n-        BuildRecord buildRecord = buildRecordRepository.queryById(Integer.valueOf(id));\n+    private BuildPushResult doPushBuild(\n+            Integer buildId,\n+            BuildPushParameters buildPushParameters,\n+            UUID buildPushResultId) throws ProcessException {\n \n-        if (buildRecord == null) {\n-            return null;\n+        // collect and validate input data\n+        BuildRecord buildRecord = getLatestSuccessfullyExecutedBuildRecord(buildId);\n+        List<Artifact> artifacts = artifactRepository\n+                .queryWithPredicates(ArtifactPredicates.withBuildRecordId(buildRecord.getId()));\n+        if (hasBadArtifactQuality(artifacts)) {\n+            String message = \"Build contains artifacts of insufficient quality: BLACKLISTED/DELETED.\";\n+            log.debug(message);\n+            BuildPushResult pushResult = BuildPushResult.builder()\n+                    .buildId(buildId.toString())\n+                    .status(BuildPushStatus.REJECTED)\n+                    .id(buildPushResultId.toString())\n+                    .logContext(buildPushResultId.toString())\n+                    .build();\n+            throw new OperationNotAllowedException(message, pushResult);\n         }\n \n-        log.debug(\"Pushing BuildRecord {}.\", id);\n-        Set<String> toPush = new HashSet<>();\n-        toPush.add(id);\n-\n-        Set<Result> pushed = buildResultPushManager.push(\n-                toPush,\n-                userService.currentUserToken(),\n-                getCompleteCallbackUrl(),\n-                buildPushRequest.getTagPrefix(),\n-                buildPushRequest.isReimport());\n-\n-        log.info(\"Push Results {}.\", pushed.stream().map(Result::getId).collect(Collectors.joining(\",\")));\n-\n-        List<BuildPushResult> pushedResponse = pushed.stream()\n-                .map(\n-                        r -> BuildPushResult.builder()\n-                                .id(r.getId())\n-                                .buildId(id)\n-                                .status(r.getStatus())\n-                                .log(r.getMessage())\n-                                .build())\n-                .collect(Collectors.toList());\n-        BuildPushResult result = pushedResponse.get(0);\n-\n-        if (result.getLog().contains(\"BLACKLISTED/DELETED\")) {\n-            throw new BadArtifactQualityException(\n-                    \"Build contains artifacts of insufficient quality: BLACKLISTED/DELETED.\",\n-                    result);\n-        }\n-        if (result.getLog().contains(\"already running\")) {\n-            throw new PushAlreadyRunningException(\"A push for this buildRecord is already running.\", result);\n+        log.debug(\"Pushing Build.id {}.\", buildRecord.getId());\n+\n+        BuildPushTask buildPushTask = new BuildPushTask(\n+                buildRecord,\n+                buildPushResultId,\n+                buildPushParameters.getTagPrefix(),\n+                buildPushParameters.isReimport(),\n+                getCompleteCallbackUrlTemplate());\n+\n+        Result pushResult = buildResultPushManager.push(buildPushTask, userService.currentUserToken());\n+        log.info(\"Push Result {}.\", pushResult);\n+\n+        BuildPushResult result = BuildPushResult.builder()\n+                .id(pushResult.getId())\n+                .buildId(pushResult.getBuildId())\n+                .status(pushResult.getStatus())\n+                .logContext(pushResult.getId())\n+                .build();\n+\n+        // verify operation status\n+        switch (pushResult.getStatus()) {\n+            case SUCCESS:\n+                return result;\n+            case REJECTED:\n+                throw new AlreadyRunningException(pushResult.getMessage(), result);\n+            case SYSTEM_ERROR:\n+                log.error(\"Brew push failed: \" + pushResult.getMessage());\n+                throw new ProcessException(pushResult.getMessage());\n+            default:\n+                log.error(\"Invalid push result status.\");\n+                throw new ProcessException(\"Invalid push result status.\");\n         }\n+    }\n \n-        return result;\n+    private boolean hasBadArtifactQuality(Collection<Artifact> builtArtifacts) {\n+        EnumSet<ArtifactQuality> badQuality = EnumSet.of(DELETED, BLACKLISTED);\n+        return builtArtifacts.stream().map(Artifact::getArtifactQuality).anyMatch(badQuality::contains);\n+    }\n+\n+    /**\n+     *\n+     * @param buildRecordId\n+     * @return Latest build record with status success or null if the build record does not exist.\n+     * @throws InconsistentDataException when there is no SUCCESS status before NO_REBUILD_REQUIRED\n+     * @throws InvalidEntityException when the status is not SUCCESS or NO_REBUILD_REQUIRED\n+     */\n+    private BuildRecord getLatestSuccessfullyExecutedBuildRecord(Integer buildRecordId) {\n+        BuildRecord buildRecord = buildRecordRepository.queryById(buildRecordId);\n+        if (buildRecord == null) {\n+            throw new EmptyEntityException(\"Build record not found.\");\n+        }\n+        if (BuildStatus.SUCCESS.equals(buildRecord.getStatus())) {\n+            return buildRecord;\n+        } else if (BuildStatus.NO_REBUILD_REQUIRED.equals(buildRecord.getStatus())) {\n+            // if status is NO_REBUILD_REQUIRED, find the last BuildRecord with status SUCCESS for the same idRev.\n+            IdRev idRev = buildRecord.getBuildConfigurationAuditedIdRev();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84c1a984e0a4ed21904873032649b712a381e7a"}, "originalPosition": 262}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzODYyNTI4OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/org/jboss/pnc/common/logging/MDCUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNDozNzo0OFrOGF823g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNDozNzo0OFrOGF823g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5MzE1MA==", "bodyText": "Move MDC field names to constants module.", "url": "https://github.com/project-ncl/pnc/pull/2970#discussion_r408893150", "createdAt": "2020-04-15T14:37:48Z", "author": {"login": "matejonnet"}, "path": "common/src/main/java/org/jboss/pnc/common/logging/MDCUtils.java", "diffHunk": "@@ -108,6 +108,10 @@ public static void addUserId(String userId) {\n         return Optional.ofNullable(getContextMap().get(USER_ID_KEY));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84c1a984e0a4ed21904873032649b712a381e7a"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzODY2MzgyOnYy", "diffSide": "RIGHT", "path": "dto/src/main/java/org/jboss/pnc/dto/ArtifactImportError.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNDo0NjowN1rOGF9QzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNDo0NjowN1rOGF9QzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5OTc4OA==", "bodyText": "Remove it, create a ticket to make sure Causeway is storing all the errors.", "url": "https://github.com/project-ncl/pnc/pull/2970#discussion_r408899788", "createdAt": "2020-04-15T14:46:07Z", "author": {"login": "matejonnet"}, "path": "dto/src/main/java/org/jboss/pnc/dto/ArtifactImportError.java", "diffHunk": "@@ -30,6 +30,7 @@\n  *\n  * @author Honza Br\u00e1zdil &lt;jbrazdil@redhat.com&gt;\n  */\n+// TODO do we need this one\n @Data", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84c1a984e0a4ed21904873032649b712a381e7a"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NTEzMjk1OnYy", "diffSide": "RIGHT", "path": "rest-new/src/main/java/org/jboss/pnc/rest/endpoints/GroupBuildEndpointImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMToyMDoyMFrOGIPnGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNDo0MjozOVrOGIYBCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI5NzU2Mg==", "bodyText": "What do you mean by this? Do you have JIRA for that?", "url": "https://github.com/project-ncl/pnc/pull/2970#discussion_r411297562", "createdAt": "2020-04-20T11:20:20Z", "author": {"login": "janinko"}, "path": "rest-new/src/main/java/org/jboss/pnc/rest/endpoints/GroupBuildEndpointImpl.java", "diffHunk": "@@ -93,6 +93,7 @@ public void delete(String id, String callback) {\n \n     @Override\n     public void brewPush(String id, GroupBuildPushRequest buildConfigSetRecordPushRequest) {\n+        // TODO progress updates", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d1b6dcdd0cc8ba1c52736224a4476316902ed1a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQzNTI3Mw==", "bodyText": "This one is out of the scope, not sure if it is already on our plan. But it fits there.", "url": "https://github.com/project-ncl/pnc/pull/2970#discussion_r411435273", "createdAt": "2020-04-20T14:42:39Z", "author": {"login": "matejonnet"}, "path": "rest-new/src/main/java/org/jboss/pnc/rest/endpoints/GroupBuildEndpointImpl.java", "diffHunk": "@@ -93,6 +93,7 @@ public void delete(String id, String callback) {\n \n     @Override\n     public void brewPush(String id, GroupBuildPushRequest buildConfigSetRecordPushRequest) {\n+        // TODO progress updates", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI5NzU2Mg=="}, "originalCommit": {"oid": "7d1b6dcdd0cc8ba1c52736224a4476316902ed1a"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NTE0ODUwOnYy", "diffSide": "RIGHT", "path": "common/src/main/java/org/jboss/pnc/common/logging/MDCUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMToyNDoyMVrOGIPv5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMToyNDoyMVrOGIPv5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI5OTgxNA==", "bodyText": "extra semicolon", "url": "https://github.com/project-ncl/pnc/pull/2970#discussion_r411299814", "createdAt": "2020-04-20T11:24:21Z", "author": {"login": "janinko"}, "path": "common/src/main/java/org/jboss/pnc/common/logging/MDCUtils.java", "diffHunk": "@@ -34,11 +35,7 @@\n \n     private static final Logger logger = LoggerFactory.getLogger(MDCUtils.class);\n \n-    public static final String REQUEST_CONTEXT_KEY = \"requestContext\";\n-    public static final String PROCESS_CONTEXT_KEY = \"processContext\";\n-    public static final String USER_ID_KEY = \"userId\";\n-    public static final String TMP_KEY = \"tmp\";;\n-    public static final String EXP_KEY = \"exp\";\n+    ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d1b6dcdd0cc8ba1c52736224a4476316902ed1a"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NTE1NjU2OnYy", "diffSide": "RIGHT", "path": "rest-api/src/main/java/org/jboss/pnc/rest/api/swagger/response/SwaggerPages.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMToyNjozMFrOGIP0fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMToyNjozMFrOGIP0fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMDk5MQ==", "bodyText": "rename ProductMilestoneReleasePage -> ProductMilestoneCloseResultPage", "url": "https://github.com/project-ncl/pnc/pull/2970#discussion_r411300991", "createdAt": "2020-04-20T11:26:30Z", "author": {"login": "janinko"}, "path": "rest-api/src/main/java/org/jboss/pnc/rest/api/swagger/response/SwaggerPages.java", "diffHunk": "@@ -79,6 +76,9 @@\n     public static class ProductMilestonePage extends Page<ProductMilestone> {\n     }\n \n+    public static class ProductMilestoneReleasePage extends Page<ProductMilestoneCloseResult> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d1b6dcdd0cc8ba1c52736224a4476316902ed1a"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NTI2NzM5OnYy", "diffSide": "RIGHT", "path": "model/src/main/java/org/jboss/pnc/model/ProductMilestoneRelease.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMTo1NToxNFrOGIQ0Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNDo0MDozOFrOGIX6uQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMxNzI4Ng==", "bodyText": "Please add the DB migration script.", "url": "https://github.com/project-ncl/pnc/pull/2970#discussion_r411317286", "createdAt": "2020-04-20T11:55:14Z", "author": {"login": "janinko"}, "path": "model/src/main/java/org/jboss/pnc/model/ProductMilestoneRelease.java", "diffHunk": "@@ -48,23 +47,26 @@\n @Cache(usage = CacheConcurrencyStrategy.READ_WRITE)\n @Entity\n @Table(indexes = @Index(name = \"idx_productmilestonerelease_milestone\", columnList = \"milestone_id\"))\n-public class ProductMilestoneRelease implements GenericEntity<Integer> {\n+public class ProductMilestoneRelease implements GenericEntity<UUID> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d1b6dcdd0cc8ba1c52736224a4476316902ed1a"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQzMzY1Nw==", "bodyText": "NCL-5704", "url": "https://github.com/project-ncl/pnc/pull/2970#discussion_r411433657", "createdAt": "2020-04-20T14:40:38Z", "author": {"login": "matejonnet"}, "path": "model/src/main/java/org/jboss/pnc/model/ProductMilestoneRelease.java", "diffHunk": "@@ -48,23 +47,26 @@\n @Cache(usage = CacheConcurrencyStrategy.READ_WRITE)\n @Entity\n @Table(indexes = @Index(name = \"idx_productmilestonerelease_milestone\", columnList = \"milestone_id\"))\n-public class ProductMilestoneRelease implements GenericEntity<Integer> {\n+public class ProductMilestoneRelease implements GenericEntity<UUID> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMxNzI4Ng=="}, "originalCommit": {"oid": "7d1b6dcdd0cc8ba1c52736224a4476316902ed1a"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NTI5MDQyOnYy", "diffSide": "RIGHT", "path": "integration-test/src/test/java/org/jboss/pnc/integration_new/endpoint/BuildConfigurationSerializationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMjowMToxOFrOGIRBXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNDo0NTo1OFrOGIYK-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMyMDY2OA==", "bodyText": "Do you have JIRA for this?", "url": "https://github.com/project-ncl/pnc/pull/2970#discussion_r411320668", "createdAt": "2020-04-20T12:01:18Z", "author": {"login": "janinko"}, "path": "integration-test/src/test/java/org/jboss/pnc/integration_new/endpoint/BuildConfigurationSerializationTest.java", "diffHunk": "@@ -37,7 +37,7 @@\n \n     private static final Logger logger = LoggerFactory.getLogger(BuildConfigurationSerializationTest.class);\n \n-    @Test\n+    @Test // TODO where is patch mentioned in the name ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d1b6dcdd0cc8ba1c52736224a4476316902ed1a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQzNzgxNw==", "bodyText": "NCL-5684", "url": "https://github.com/project-ncl/pnc/pull/2970#discussion_r411437817", "createdAt": "2020-04-20T14:45:58Z", "author": {"login": "matejonnet"}, "path": "integration-test/src/test/java/org/jboss/pnc/integration_new/endpoint/BuildConfigurationSerializationTest.java", "diffHunk": "@@ -37,7 +37,7 @@\n \n     private static final Logger logger = LoggerFactory.getLogger(BuildConfigurationSerializationTest.class);\n \n-    @Test\n+    @Test // TODO where is patch mentioned in the name ?", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMyMDY2OA=="}, "originalCommit": {"oid": "7d1b6dcdd0cc8ba1c52736224a4476316902ed1a"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NTMxMjA3OnYy", "diffSide": "RIGHT", "path": "mapper/src/main/java/org/jboss/pnc/mapper/api/BuildPushResultMapper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMjowNzoxMVrOGIROag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMjowNzoxMVrOGIROag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMyNDAxMA==", "bodyText": "You can map the context here:\n    @Mapping(target = \"logContext\", expression = \"java( logContext(db) )\")\n    // maybe default, because private static may not work in Java 8?\n    private static String logContext(BuildRecordPushResult db) {\n        ProductMilestoneRelease productMilestoneRelease = db.getProductMilestoneRelease();\n        if (productMilestoneRelease != null) { // is part of milestone release\n            return productMilestoneRelease.getId().toString();\n        } else {\n            return db.getId().toString();\n        }\n    }", "url": "https://github.com/project-ncl/pnc/pull/2970#discussion_r411324010", "createdAt": "2020-04-20T12:07:11Z", "author": {"login": "janinko"}, "path": "mapper/src/main/java/org/jboss/pnc/mapper/api/BuildPushResultMapper.java", "diffHunk": "@@ -18,24 +18,56 @@\n package org.jboss.pnc.mapper.api;\n \n import org.jboss.pnc.dto.BuildPushResult;\n+import org.jboss.pnc.dto.BuildPushResultRef;\n+import org.jboss.pnc.dto.ProductMilestoneCloseResultRef;\n+import org.jboss.pnc.mapper.UUIDMapper;\n import org.jboss.pnc.model.BuildRecordPushResult;\n import org.mapstruct.BeanMapping;\n import org.mapstruct.Mapper;\n import org.mapstruct.Mapping;\n \n+import java.util.UUID;\n+\n /**\n  * @author <a href=\"mailto:jmichalo@redhat.com\">Jan Michalov</a>\n  */\n-@Mapper(config = MapperCentralConfig.class, uses = { BuildMapper.IDMapper.class })\n-public interface BuildPushResultMapper {\n+@Mapper(\n+        config = MapperCentralConfig.class,\n+        uses = { UUIDMapper.class, BuildMapper.IDMapper.class, ProductMilestoneCloseResultMapper.class })\n+public interface BuildPushResultMapper\n+        extends EntityMapper<UUID, BuildRecordPushResult, BuildPushResult, BuildPushResultRef> {\n+\n+    @Override\n+    default BuildRecordPushResult toIDEntity(BuildPushResultRef dtoEntity) {\n+        if (dtoEntity == null) {\n+            return null;\n+        }\n+        BuildRecordPushResult buildRecordPushResult = new BuildRecordPushResult();\n+        buildRecordPushResult.setId(UUID.fromString(dtoEntity.getId()));\n+        return buildRecordPushResult;\n+    }\n \n     @Mapping(target = \"buildId\", source = \"buildRecord\")\n-    @Mapping(target = \"artifactImportErrors\", ignore = true)\n-    @BeanMapping(ignoreUnmappedSourceProperties = { \"tagPrefix\" })\n+    @Mapping(\n+            target = \"productMilestoneCloseResult\",\n+            source = \"productMilestoneRelease\",\n+            resultType = ProductMilestoneCloseResultRef.class)\n+    @Mapping(target = \"logContext\", ignore = true)\n+    @Mapping(target = \"message\", ignore = true)\n+    @BeanMapping(ignoreUnmappedSourceProperties = { \"tagPrefix\", \"artifactImportErrors\", \"log\" })\n     BuildPushResult toDTO(BuildRecordPushResult db);\n \n+    @Mapping(target = \"buildId\", source = \"buildRecord\")\n+    @BeanMapping(\n+            ignoreUnmappedSourceProperties = { \"tagPrefix\", \"artifactImportErrors\", \"log\", \"productMilestoneRelease\" })\n+    @Mapping(target = \"logContext\", ignore = true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d1b6dcdd0cc8ba1c52736224a4476316902ed1a"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NTQyNjY4OnYy", "diffSide": "RIGHT", "path": "facade/src/main/java/org/jboss/pnc/facade/providers/ProductMilestoneReleaseProviderImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMjozNTo1M1rOGISRrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMjozNTo1M1rOGISRrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM0MTIzMA==", "bodyText": "Should the class be renamed to ProductMilestoneCloseResultProvider(Impl)?", "url": "https://github.com/project-ncl/pnc/pull/2970#discussion_r411341230", "createdAt": "2020-04-20T12:35:53Z", "author": {"login": "janinko"}, "path": "facade/src/main/java/org/jboss/pnc/facade/providers/ProductMilestoneReleaseProviderImpl.java", "diffHunk": "@@ -42,7 +44,7 @@\n @PermitAll\n @Stateless\n public class ProductMilestoneReleaseProviderImpl extends\n-        AbstractIntIdProvider<org.jboss.pnc.model.ProductMilestoneRelease, org.jboss.pnc.dto.ProductMilestoneRelease, org.jboss.pnc.dto.ProductMilestoneReleaseRef>\n+        AbstractUUIDIdProvider<org.jboss.pnc.model.ProductMilestoneRelease, ProductMilestoneCloseResult, ProductMilestoneCloseResultRef>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d1b6dcdd0cc8ba1c52736224a4476316902ed1a"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NjYwNjYyOnYy", "diffSide": "RIGHT", "path": "common/src/test/java/org/jboss/pnc/common/UUIDCollisionTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjozMzowNFrOGIdUYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxODo1NToyOVrOGIi8HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUyMjE0NA==", "bodyText": "Is this still necessary?", "url": "https://github.com/project-ncl/pnc/pull/2970#discussion_r411522144", "createdAt": "2020-04-20T16:33:04Z", "author": {"login": "janinko"}, "path": "common/src/test/java/org/jboss/pnc/common/UUIDCollisionTest.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/**\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2014-2020 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.jboss.pnc.common;\n+\n+import org.junit.Ignore;\n+import org.junit.Test;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.UUID;\n+\n+public class UUIDCollisionTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "615413913c99187d318ec2592cf30e56b6eddf27"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYxNDIzNw==", "bodyText": "No, it had never been at all :)", "url": "https://github.com/project-ncl/pnc/pull/2970#discussion_r411614237", "createdAt": "2020-04-20T18:55:29Z", "author": {"login": "matejonnet"}, "path": "common/src/test/java/org/jboss/pnc/common/UUIDCollisionTest.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/**\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2014-2020 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.jboss.pnc.common;\n+\n+import org.junit.Ignore;\n+import org.junit.Test;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.UUID;\n+\n+public class UUIDCollisionTest {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUyMjE0NA=="}, "originalCommit": {"oid": "615413913c99187d318ec2592cf30e56b6eddf27"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1848, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}