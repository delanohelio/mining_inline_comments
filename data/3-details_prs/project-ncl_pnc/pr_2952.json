{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3MDI5ODc5", "number": 2952, "title": "[NCL-5597] fix running conditions in BuildCoordinator's tests", "bodyText": "InGroupDependentBuildsTest.shouldCreateTaskForDependentBuilt\nThere were 2 running conditions:\n\nconcurrent modification of mocked BuildRecordRepository (circa 1/100 probability)\n\n\nrepository was returning direct reference to the data collection\na method looping through the collection (in a stream) had the collection modified in the middle of loop resulting in a ConcurrentModificationException thrown from the inside of the Collection\ntried to wrap the collection in a new array so it wouldn't have direct reference but it caused some failures so I've decided to change the collection implementation to CopyOnWriteArray which is thread-safe (I haven't seen noticeable performance overhead)\n\n\nsuccessful BuildTask failing to notify dependant BuildTasks (circa 1/400 probability)\n\n\nthe BuildTasks in a BuildTaskSet were added to the BuildQueue in a random order\nrunning condition happened when there was a BuildTask with dependants added to readyQueue and finished before its dependants to waitingQueue\nsometimes it happened that BuildCoordinator thread picked up the BuildTask with dependants and finished before any dependant was added to the waiting queue\nduring finishing process there was no Task in waiting queue so the thread didn't notify any task\nfixed by ensuring that the order for adding task to queue is ordered from dependants to dependencies so that dependants are added to queue before dependencies\n\nSkippingBuiltConfigsTest.shouldNotTriggerTheSameBuildConfigurationViaDependency\nThere were 2 running condition:\n\nupdateBuildTaskStatus method took too long to finish\n\n\nBuildTask had an dependency that was in BUILDING status before condition that places new BuildTasks in appropriate queue (waiting or ready), therefore it was decided to be placed in waiting queue\nrace condition happened when a dependent Task finished before the aforementioned task was added to the waiting queue and after it was decided it should be placed in the waiting queue\nrace condition resulted in stuck BuildTask in WAITING_FOR_DEPENDENCIES as the dependency could not not notify the BuildTask because waiting queue was at that time empty\nsolved by short sleep in the test\n\n\nBuildTask being placed in ready queue twice\n\n\nhappened when attempting to add a Task to a queue when it was already there and an condition didn't catch it\nsolved by ignoring BuildTasks that are not NEW or ENQUEUED when adding to BuildQueue\n\n@matejonnet WDYT", "createdAt": "2020-04-01T14:24:52Z", "url": "https://github.com/project-ncl/pnc/pull/2952", "merged": true, "mergeCommit": {"oid": "8ba59eba0e6d13d3243f55cd84b1df0ee77afa38"}, "closed": true, "closedAt": "2020-04-06T11:20:06Z", "author": {"login": "michalovjan"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTZJyxAFqTM4NTY4MDQxOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcU7_wGABqjMyMDQ2NDg2Mzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NjgwNDE5", "url": "https://github.com/project-ncl/pnc/pull/2952#pullrequestreview-385680419", "createdAt": "2020-04-01T15:08:58Z", "commit": {"oid": "f2755dfb7961beee11818aa8a200c37b48c0f290"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNTowODo1OFrOF_FOTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNTowODo1OFrOF_FOTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY5MDE5MA==", "bodyText": "Have you imported the ide-config to your IDE?", "url": "https://github.com/project-ncl/pnc/pull/2952#discussion_r401690190", "createdAt": "2020-04-01T15:08:58Z", "author": {"login": "jbartece"}, "path": "build-coordinator/src/main/java/org/jboss/pnc/coordinator/builder/DefaultBuildCoordinator.java", "diffHunk": "@@ -49,35 +68,15 @@\n import org.jboss.pnc.spi.coordinator.events.DefaultBuildSetStatusChangedEvent;\n import org.jboss.pnc.spi.coordinator.events.DefaultBuildStatusChangedEvent;\n import org.jboss.pnc.spi.datastore.DatastoreException;\n-import org.jboss.pnc.spi.events.BuildStatusChangedEvent;\n import org.jboss.pnc.spi.events.BuildSetStatusChangedEvent;\n+import org.jboss.pnc.spi.events.BuildStatusChangedEvent;\n import org.jboss.pnc.spi.exception.BuildConflictException;\n import org.jboss.pnc.spi.exception.CoreException;\n import org.jboss.pnc.spi.executor.exceptions.ExecutorException;\n import org.jboss.pnc.spi.repour.RepourResult;\n-\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import javax.annotation.PostConstruct;\n-import javax.enterprise.context.ApplicationScoped;\n-import javax.enterprise.event.Event;\n-import javax.inject.Inject;\n-\n-import java.time.Instant;\n-import java.util.Date;\n-import java.util.HashSet;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.Optional;\n-import java.util.Set;\n-import java.util.concurrent.ExecutorService;\n-import java.util.concurrent.ScheduledFuture;\n-import java.util.concurrent.TimeUnit;\n-import java.util.function.Consumer;\n-\n-import static org.jboss.pnc.common.util.CollectionUtils.hasCycle;\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2755dfb7961beee11818aa8a200c37b48c0f290"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MDQxNjA2", "url": "https://github.com/project-ncl/pnc/pull/2952#pullrequestreview-388041606", "createdAt": "2020-04-06T08:39:44Z", "commit": {"oid": "f2755dfb7961beee11818aa8a200c37b48c0f290"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cc8d3066a9bac0b4e2026019b2b8fdc386b1132", "author": {"user": {"login": "michalovjan", "name": null}}, "url": "https://github.com/project-ncl/pnc/commit/8cc8d3066a9bac0b4e2026019b2b8fdc386b1132", "committedDate": "2020-04-06T10:18:18Z", "message": "[NCL-5597] fix running conditions in BuildCoordinator's tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f2755dfb7961beee11818aa8a200c37b48c0f290", "author": {"user": {"login": "michalovjan", "name": null}}, "url": "https://github.com/project-ncl/pnc/commit/f2755dfb7961beee11818aa8a200c37b48c0f290", "committedDate": "2020-04-01T14:17:31Z", "message": "[NCL-5597] fix running conditions in BuildCoordinator's tests"}, "afterCommit": {"oid": "8cc8d3066a9bac0b4e2026019b2b8fdc386b1132", "author": {"user": {"login": "michalovjan", "name": null}}, "url": "https://github.com/project-ncl/pnc/commit/8cc8d3066a9bac0b4e2026019b2b8fdc386b1132", "committedDate": "2020-04-06T10:18:18Z", "message": "[NCL-5597] fix running conditions in BuildCoordinator's tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2696, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}