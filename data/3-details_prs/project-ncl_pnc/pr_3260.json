{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyMzg5NjM3", "number": 3260, "title": "[NCL-5910] add DB migration script for artifact -built-by-> build rel\u2026", "bodyText": "\u2026ationship\nChecklist:\n\n Have you added a note in the CHANGELOG wiki for your change if user-facing?\n Have you added unit tests for your change?", "createdAt": "2020-08-24T09:28:09Z", "url": "https://github.com/project-ncl/pnc/pull/3260", "merged": true, "mergeCommit": {"oid": "fd45fdbd9356c61a99fafa49bb984ff698606c5f"}, "closed": true, "closedAt": "2020-08-27T11:07:20Z", "author": {"login": "janinko"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCo1CWgFqTQ3NTMyNDcwNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdC-Q5LgFqTQ3NjYwNjI2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MzI0NzA3", "url": "https://github.com/project-ncl/pnc/pull/3260#pullrequestreview-475324707", "createdAt": "2020-08-26T09:42:06Z", "commit": {"oid": "c4ef7279055637b9dd82eb2790d6b240ff6835e7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwOTo0MjowNlrOHHEXRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwOTo1NjoxOFrOHHE3tA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE3MzU3Mw==", "bodyText": "What does \"AS agg\" accomplish? Is that intentional?", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r477173573", "createdAt": "2020-08-26T09:42:06Z", "author": {"login": "michalovjan"}, "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "diffHunk": "@@ -188,3 +188,34 @@ BEGIN transaction;\n     ALTER TABLE buildrecord ADD CONSTRAINT fk_buildrecord_norebuildcause\n     FOREIGN KEY (norebuildcause_id) REFERENCES buildrecord(id);\n COMMIT;\n+\n+\n+BEGIN transaction;\n+\n+    -- Verify that there are no duplicate data\n+    do $$\n+    declare\n+        total_dupes integer;\n+    begin\n+        SELECT count(*)\n+        INTO total_dupes\n+        FROM (SELECT built_artifact_id FROM build_record_built_artifact_map GROUP BY built_artifact_id HAVING count(*) > 1) AS agg;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4ef7279055637b9dd82eb2790d6b240ff6835e7"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE3NzE2OA==", "bodyText": "It should be\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                ALTER TABLE artifact ADD CONSTRAINT fk_artifact_buildrecord FOREIGN KEY (fk_artifact_buildrecord) REFERENCES buildrecord(id);\n          \n          \n            \n                ALTER TABLE artifact ADD CONSTRAINT fk_artifact_buildrecord FOREIGN KEY (buildrecord_id) REFERENCES buildrecord(id);", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r477177168", "createdAt": "2020-08-26T09:48:12Z", "author": {"login": "michalovjan"}, "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "diffHunk": "@@ -188,3 +188,34 @@ BEGIN transaction;\n     ALTER TABLE buildrecord ADD CONSTRAINT fk_buildrecord_norebuildcause\n     FOREIGN KEY (norebuildcause_id) REFERENCES buildrecord(id);\n COMMIT;\n+\n+\n+BEGIN transaction;\n+\n+    -- Verify that there are no duplicate data\n+    do $$\n+    declare\n+        total_dupes integer;\n+    begin\n+        SELECT count(*)\n+        INTO total_dupes\n+        FROM (SELECT built_artifact_id FROM build_record_built_artifact_map GROUP BY built_artifact_id HAVING count(*) > 1) AS agg;\n+\n+        assert total_dupes = 0;\n+    end$$;\n+\n+    -- Add new column to artifact table\n+    ALTER TABLE artifact ADD column buildrecord_id int4;\n+    CREATE INDEX idx_artifact_buildrecord ON artifact (buildrecord_id);\n+    ALTER TABLE artifact ADD CONSTRAINT fk_artifact_buildrecord FOREIGN KEY (fk_artifact_buildrecord) REFERENCES buildrecord(id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4ef7279055637b9dd82eb2790d6b240ff6835e7"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE3OTcwMw==", "bodyText": "Add the Index also to Artifact model here \n  \n    \n      pnc/model/src/main/java/org/jboss/pnc/model/Artifact.java\n    \n    \n         Line 71\n      in\n      b9b4867\n    \n    \n    \n    \n\n        \n          \n           indexes = { @Index(name = \"idx_artifact_targetRepository\", columnList = \"targetRepository_id\"),", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r477179703", "createdAt": "2020-08-26T09:52:31Z", "author": {"login": "michalovjan"}, "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "diffHunk": "@@ -188,3 +188,34 @@ BEGIN transaction;\n     ALTER TABLE buildrecord ADD CONSTRAINT fk_buildrecord_norebuildcause\n     FOREIGN KEY (norebuildcause_id) REFERENCES buildrecord(id);\n COMMIT;\n+\n+\n+BEGIN transaction;\n+\n+    -- Verify that there are no duplicate data\n+    do $$\n+    declare\n+        total_dupes integer;\n+    begin\n+        SELECT count(*)\n+        INTO total_dupes\n+        FROM (SELECT built_artifact_id FROM build_record_built_artifact_map GROUP BY built_artifact_id HAVING count(*) > 1) AS agg;\n+\n+        assert total_dupes = 0;\n+    end$$;\n+\n+    -- Add new column to artifact table\n+    ALTER TABLE artifact ADD column buildrecord_id int4;\n+    CREATE INDEX idx_artifact_buildrecord ON artifact (buildrecord_id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4ef7279055637b9dd82eb2790d6b240ff6835e7"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE4MTg3Ng==", "bodyText": "Are old associated indexes and constraints also dropped or do you have to do it manually?", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r477181876", "createdAt": "2020-08-26T09:56:18Z", "author": {"login": "michalovjan"}, "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "diffHunk": "@@ -188,3 +188,34 @@ BEGIN transaction;\n     ALTER TABLE buildrecord ADD CONSTRAINT fk_buildrecord_norebuildcause\n     FOREIGN KEY (norebuildcause_id) REFERENCES buildrecord(id);\n COMMIT;\n+\n+\n+BEGIN transaction;\n+\n+    -- Verify that there are no duplicate data\n+    do $$\n+    declare\n+        total_dupes integer;\n+    begin\n+        SELECT count(*)\n+        INTO total_dupes\n+        FROM (SELECT built_artifact_id FROM build_record_built_artifact_map GROUP BY built_artifact_id HAVING count(*) > 1) AS agg;\n+\n+        assert total_dupes = 0;\n+    end$$;\n+\n+    -- Add new column to artifact table\n+    ALTER TABLE artifact ADD column buildrecord_id int4;\n+    CREATE INDEX idx_artifact_buildrecord ON artifact (buildrecord_id);\n+    ALTER TABLE artifact ADD CONSTRAINT fk_artifact_buildrecord FOREIGN KEY (fk_artifact_buildrecord) REFERENCES buildrecord(id);\n+\n+    -- Copy data from old table\n+    UPDATE artifact\n+        SET buildrecord_id = build_record_built_artifact_map.build_record_id\n+        FROM build_record_built_artifact_map\n+        WHERE artifact.id = build_record_built_artifact_map.built_artifact_id;\n+\n+    -- Drop the old table\n+    DROP TABLE build_record_built_artifact_map;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4ef7279055637b9dd82eb2790d6b240ff6835e7"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c950b156aff8a952af80d99d291702fd756c0d1", "author": {"user": {"login": "janinko", "name": "Honza Br\u00e1zdil"}}, "url": "https://github.com/project-ncl/pnc/commit/5c950b156aff8a952af80d99d291702fd756c0d1", "committedDate": "2020-08-27T09:28:21Z", "message": "[NCL-5910] add DB migration script for artifact -built-by-> build relationship"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c4ef7279055637b9dd82eb2790d6b240ff6835e7", "author": {"user": {"login": "janinko", "name": "Honza Br\u00e1zdil"}}, "url": "https://github.com/project-ncl/pnc/commit/c4ef7279055637b9dd82eb2790d6b240ff6835e7", "committedDate": "2020-08-24T09:24:54Z", "message": "[NCL-5910] add DB migration script for artifact -built-by-> build relationship"}, "afterCommit": {"oid": "5c950b156aff8a952af80d99d291702fd756c0d1", "author": {"user": {"login": "janinko", "name": "Honza Br\u00e1zdil"}}, "url": "https://github.com/project-ncl/pnc/commit/5c950b156aff8a952af80d99d291702fd756c0d1", "committedDate": "2020-08-27T09:28:21Z", "message": "[NCL-5910] add DB migration script for artifact -built-by-> build relationship"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NTg5OTQ3", "url": "https://github.com/project-ncl/pnc/pull/3260#pullrequestreview-476589947", "createdAt": "2020-08-27T10:32:08Z", "commit": {"oid": "5c950b156aff8a952af80d99d291702fd756c0d1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NjA2MjY0", "url": "https://github.com/project-ncl/pnc/pull/3260#pullrequestreview-476606264", "createdAt": "2020-08-27T10:57:39Z", "commit": {"oid": "5c950b156aff8a952af80d99d291702fd756c0d1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2513, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}