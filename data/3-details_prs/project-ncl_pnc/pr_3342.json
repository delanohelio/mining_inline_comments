{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5MTI1NzU2", "number": 3342, "title": "[NCL-6011] Add websocket notifications for milestone push jobs", "bodyText": "Checklist:\n\n Have you added a note in the CHANGELOG wiki for your change if user-facing?\n Have you added unit tests for your change?", "createdAt": "2020-10-07T09:52:10Z", "url": "https://github.com/project-ncl/pnc/pull/3342", "merged": true, "mergeCommit": {"oid": "6230e5003f8a3e144d404e4a9a61b286589443df"}, "closed": true, "closedAt": "2020-10-26T15:28:10Z", "author": {"login": "jomrazek"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSHIFJAFqTUwMzcxODY5Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWRgseAFqTUxNjYyNjg4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNzE4Njky", "url": "https://github.com/project-ncl/pnc/pull/3342#pullrequestreview-503718692", "createdAt": "2020-10-07T10:02:00Z", "commit": {"oid": "7d70cbc7cab14c1bc687c460379904ddeb094eff"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMDowMjowMFrOHdr5nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMTo0NTo0MFrOHgioWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg5MDAxMg==", "bodyText": "Please add super.close() there so that the underlying regular client closes too.", "url": "https://github.com/project-ncl/pnc/pull/3342#discussion_r500890012", "createdAt": "2020-10-07T10:02:00Z", "author": {"login": "michalovjan"}, "path": "rest-client/src/main/java/org/jboss/pnc/restclient/AdvancedProductMilestoneClient.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/**\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2014-2020 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.jboss.pnc.restclient;\n+\n+import org.jboss.pnc.client.Configuration;\n+import org.jboss.pnc.client.ProductMilestoneClient;\n+import org.jboss.pnc.client.RemoteResourceException;\n+import org.jboss.pnc.dto.ProductMilestoneCloseResult;\n+import org.jboss.pnc.dto.notification.ProductMilestoneCloseResultNotification;\n+import org.jboss.pnc.restclient.websocket.VertxWebSocketClient;\n+import org.jboss.pnc.restclient.websocket.WebSocketClient;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+import static org.jboss.pnc.restclient.websocket.predicates.ProductMilestoneCloseResultNotificationPredicates.withMilestoneId;\n+\n+public class AdvancedProductMilestoneClient extends ProductMilestoneClient {\n+\n+    private WebSocketClient webSocketClient = new VertxWebSocketClient();\n+\n+    public AdvancedProductMilestoneClient(Configuration configuration) {\n+        super(configuration);\n+    }\n+\n+    public CompletableFuture<ProductMilestoneCloseResult> waitForMilestoneClose(String milestoneId) {\n+        webSocketClient.connect(\"ws://\" + configuration.getHost() + BASE_PATH + \"/notifications\").join();\n+        return webSocketClient.catchProductMilestoneCloseResult(withMilestoneId(milestoneId))\n+                .thenApply(ProductMilestoneCloseResultNotification::getProductMilestoneCloseResult)\n+                .whenComplete((x, y) -> webSocketClient.disconnect());\n+    }\n+\n+    public CompletableFuture<ProductMilestoneCloseResult> executeMilestoneClose(String milestoneId)\n+            throws RemoteResourceException {\n+        CompletableFuture<ProductMilestoneCloseResult> future = waitForMilestoneClose(milestoneId);\n+        super.closeMilestone(milestoneId);\n+        return future;\n+    }\n+\n+    @Override\n+    public void close() {\n+        if (webSocketClient != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d70cbc7cab14c1bc687c460379904ddeb094eff"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg5MDUwNQ==", "bodyText": "JavaDoc :D", "url": "https://github.com/project-ncl/pnc/pull/3342#discussion_r500890505", "createdAt": "2020-10-07T10:02:46Z", "author": {"login": "michalovjan"}, "path": "rest-client/src/main/java/org/jboss/pnc/restclient/websocket/WebSocketClient.java", "diffHunk": "@@ -196,6 +197,10 @@ ListenerUnsubscriber onSCMRepositoryCreationSuccess(\n             Consumer<SCMRepositoryCreationSuccess> onNotification,\n             Predicate<SCMRepositoryCreationSuccess>... filters) throws ConnectionClosedException;\n \n+    ListenerUnsubscriber onProductMilestoneCloseResult(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d70cbc7cab14c1bc687c460379904ddeb094eff"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg4Mzg2Ng==", "bodyText": "If the close fails, is the milestone present? I'd like to avoid all possible NPEs.", "url": "https://github.com/project-ncl/pnc/pull/3342#discussion_r503883866", "createdAt": "2020-10-13T11:45:40Z", "author": {"login": "michalovjan"}, "path": "rest-client/src/main/java/org/jboss/pnc/restclient/websocket/predicates/ProductMilestoneCloseResultNotificationPredicates.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/**\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2014-2020 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.jboss.pnc.restclient.websocket.predicates;\n+\n+import org.jboss.pnc.dto.notification.ProductMilestoneCloseResultNotification;\n+\n+import java.util.function.Predicate;\n+\n+public final class ProductMilestoneCloseResultNotificationPredicates {\n+\n+    public static Predicate<ProductMilestoneCloseResultNotification> withMilestoneId(String milestoneId) {\n+        return (notification) -> notification.getProductMilestoneCloseResult() == null ? false\n+                : notification.getProductMilestoneCloseResult().getMilestone().getId().equals(milestoneId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d70cbc7cab14c1bc687c460379904ddeb094eff"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8f2fb9918d33c8fcc830c441c742bf60579f254", "author": {"user": {"login": "jomrazek", "name": null}}, "url": "https://github.com/project-ncl/pnc/commit/f8f2fb9918d33c8fcc830c441c742bf60579f254", "committedDate": "2020-10-18T10:25:27Z", "message": "[NCL-6011] Add websocket notifications for milestone push jobs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7d70cbc7cab14c1bc687c460379904ddeb094eff", "author": {"user": {"login": "jomrazek", "name": null}}, "url": "https://github.com/project-ncl/pnc/commit/7d70cbc7cab14c1bc687c460379904ddeb094eff", "committedDate": "2020-10-07T09:51:10Z", "message": "[NCL-6011] Add websocket notifications for milestone push jobs"}, "afterCommit": {"oid": "f8f2fb9918d33c8fcc830c441c742bf60579f254", "author": {"user": {"login": "jomrazek", "name": null}}, "url": "https://github.com/project-ncl/pnc/commit/f8f2fb9918d33c8fcc830c441c742bf60579f254", "committedDate": "2020-10-18T10:25:27Z", "message": "[NCL-6011] Add websocket notifications for milestone push jobs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNjc0MjQx", "url": "https://github.com/project-ncl/pnc/pull/3342#pullrequestreview-511674241", "createdAt": "2020-10-19T11:45:08Z", "commit": {"oid": "f8f2fb9918d33c8fcc830c441c742bf60579f254"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMTo0NTowOFrOHkKYfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMTo0ODowOFrOHkKezg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY4MDg5Mw==", "bodyText": "I meant it like this scenario. You request a milestone close (request is successful) -> milestone closing in progress -> milestone close fails -> orch sends a notification that the close failed. Will the notification have anything missing that could throw NPE here?", "url": "https://github.com/project-ncl/pnc/pull/3342#discussion_r507680893", "createdAt": "2020-10-19T11:45:08Z", "author": {"login": "michalovjan"}, "path": "rest-client/src/main/java/org/jboss/pnc/restclient/websocket/predicates/ProductMilestoneCloseResultNotificationPredicates.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/**\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2014-2020 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.jboss.pnc.restclient.websocket.predicates;\n+\n+import org.jboss.pnc.dto.notification.ProductMilestoneCloseResultNotification;\n+\n+import java.util.function.Predicate;\n+\n+public final class ProductMilestoneCloseResultNotificationPredicates {\n+\n+    public static Predicate<ProductMilestoneCloseResultNotification> withMilestoneId(String milestoneId) {\n+        return (notification) -> notification.getProductMilestoneCloseResult() == null ? false\n+                : notification.getProductMilestoneCloseResult().getMilestone().getId().equals(milestoneId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg4Mzg2Ng=="}, "originalCommit": {"oid": "7d70cbc7cab14c1bc687c460379904ddeb094eff"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY4MjUxMA==", "bodyText": "I am aware. I've got them fixed in up-and-not-in-nearest-time-coming issue NCL-5662. It'd be great to have it fixed in 2.0.1.", "url": "https://github.com/project-ncl/pnc/pull/3342#discussion_r507682510", "createdAt": "2020-10-19T11:48:08Z", "author": {"login": "michalovjan"}, "path": "rest-client/src/main/java/org/jboss/pnc/restclient/AdvancedProductMilestoneClient.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/**\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2014-2020 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.jboss.pnc.restclient;\n+\n+import org.jboss.pnc.client.Configuration;\n+import org.jboss.pnc.client.ProductMilestoneClient;\n+import org.jboss.pnc.client.RemoteResourceException;\n+import org.jboss.pnc.dto.ProductMilestoneCloseResult;\n+import org.jboss.pnc.dto.notification.ProductMilestoneCloseResultNotification;\n+import org.jboss.pnc.restclient.websocket.VertxWebSocketClient;\n+import org.jboss.pnc.restclient.websocket.WebSocketClient;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+import static org.jboss.pnc.restclient.websocket.predicates.ProductMilestoneCloseResultNotificationPredicates.withMilestoneId;\n+\n+public class AdvancedProductMilestoneClient extends ProductMilestoneClient {\n+\n+    private WebSocketClient webSocketClient = new VertxWebSocketClient();\n+\n+    public AdvancedProductMilestoneClient(Configuration configuration) {\n+        super(configuration);\n+    }\n+\n+    public CompletableFuture<ProductMilestoneCloseResult> waitForMilestoneClose(String milestoneId) {\n+        webSocketClient.connect(\"ws://\" + configuration.getHost() + BASE_PATH + \"/notifications\").join();\n+        return webSocketClient.catchProductMilestoneCloseResult(withMilestoneId(milestoneId))\n+                .thenApply(ProductMilestoneCloseResultNotification::getProductMilestoneCloseResult)\n+                .whenComplete((x, y) -> webSocketClient.disconnect());\n+    }\n+\n+    public CompletableFuture<ProductMilestoneCloseResult> executeMilestoneClose(String milestoneId)\n+            throws RemoteResourceException {\n+        CompletableFuture<ProductMilestoneCloseResult> future = waitForMilestoneClose(milestoneId);\n+        super.closeMilestone(milestoneId);\n+        return future;\n+    }\n+\n+    @Override\n+    public void close() {\n+        if (webSocketClient != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg5MDAxMg=="}, "originalCommit": {"oid": "7d70cbc7cab14c1bc687c460379904ddeb094eff"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25051642d19e9f4e63fa2e6b5ae05fa9273d37cd", "author": {"user": {"login": "jomrazek", "name": null}}, "url": "https://github.com/project-ncl/pnc/commit/25051642d19e9f4e63fa2e6b5ae05fa9273d37cd", "committedDate": "2020-10-19T12:58:09Z", "message": "Close also regular clients when closing advanced ones"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NjI2ODg3", "url": "https://github.com/project-ncl/pnc/pull/3342#pullrequestreview-516626887", "createdAt": "2020-10-26T10:07:40Z", "commit": {"oid": "25051642d19e9f4e63fa2e6b5ae05fa9273d37cd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2540, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}