{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMjM1MTc2", "number": 2834, "title": "[NCL-5386] - Implementation of native query to retrieve minimized list of artifact\u2026", "bodyText": "\u2026 dependencies given a build record\nChecklist:\n\n Have you added a note in the CHANGELOG wiki for your change if user-facing?\n Have you added unit tests for your change?", "createdAt": "2020-02-05T08:06:17Z", "url": "https://github.com/project-ncl/pnc/pull/2834", "merged": true, "mergeCommit": {"oid": "33c1e2617b15c773fe16759679962c7efc626381"}, "closed": true, "closedAt": "2020-02-06T16:45:53Z", "author": {"login": "vibe13"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBRgxHgH2gAyMzcxMjM1MTc2OmYyYzVkMTVmZDM0NjU4ZjkxMTMwMWQ1ZTY3YzFiOWZkZWZiYjhlZjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBtHhYgH2gAyMzcxMjM1MTc2OmQzZWZjZDBmNjJjNWYwZTJjYjhhMjUyOGI2Yjc4M2JjODM4NzdjOTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f2c5d15fd34658f911301d5e67c1b9fdefbb8ef2", "author": {"user": {"login": "vibe13", "name": "Andrea Vibelli"}}, "url": "https://github.com/project-ncl/pnc/commit/f2c5d15fd34658f911301d5e67c1b9fdefbb8ef2", "committedDate": "2020-02-05T08:04:11Z", "message": "Implementation of native query to retrieve minimized list of artifact dependencies given a build record"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd4cab12adbab2886a1a758d721ae38c4925c3d4", "author": {"user": {"login": "vibe13", "name": "Andrea Vibelli"}}, "url": "https://github.com/project-ncl/pnc/commit/fd4cab12adbab2886a1a758d721ae38c4925c3d4", "committedDate": "2020-02-05T08:15:05Z", "message": "Add missing methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8bce9069aa59d366d42d9de17fd6e262f0071ea", "author": {"user": {"login": "vibe13", "name": "Andrea Vibelli"}}, "url": "https://github.com/project-ncl/pnc/commit/b8bce9069aa59d366d42d9de17fd6e262f0071ea", "committedDate": "2020-02-05T08:15:29Z", "message": "Added CodeReady files to be ignored"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5559e8b7e408f92723040cd77072863b4c0af82f", "author": {"user": {"login": "vibe13", "name": "Andrea Vibelli"}}, "url": "https://github.com/project-ncl/pnc/commit/5559e8b7e408f92723040cd77072863b4c0af82f", "committedDate": "2020-02-05T09:11:10Z", "message": "Fix ClassCast exception when getting results of count from native query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09c941c13cfffdc61a5da99a9d7a91bfafa18723", "author": {"user": {"login": "vibe13", "name": "Andrea Vibelli"}}, "url": "https://github.com/project-ncl/pnc/commit/09c941c13cfffdc61a5da99a9d7a91bfafa18723", "committedDate": "2020-02-05T09:45:59Z", "message": "Fix org.hsqldb.HsqlException when offset is equal to 0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "deeca0801bb9608e4f6e29788386fb5db00c4ea7", "author": {"user": {"login": "vibe13", "name": "Andrea Vibelli"}}, "url": "https://github.com/project-ncl/pnc/commit/deeca0801bb9608e4f6e29788386fb5db00c4ea7", "committedDate": "2020-02-05T12:53:11Z", "message": "Add missing properties to ArtifactRest and initialize empty collections"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e0e19b4620e20cf3ee0251d0fcb516672eb1535", "author": {"user": {"login": "vibe13", "name": "Andrea Vibelli"}}, "url": "https://github.com/project-ncl/pnc/commit/1e0e19b4620e20cf3ee0251d0fcb516672eb1535", "committedDate": "2020-02-05T13:49:25Z", "message": "Cleanup and implementation of native query for the other related REST endpoint to get the list of Artifacts built given a BuildRecord"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c2406b70e12c2516598bb625f87a10bc8aa6a2f", "author": {"user": {"login": "vibe13", "name": "Andrea Vibelli"}}, "url": "https://github.com/project-ncl/pnc/commit/4c2406b70e12c2516598bb625f87a10bc8aa6a2f", "committedDate": "2020-02-05T14:05:30Z", "message": "Implementation of missing methods in ArtifactRepositoryMock"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzOTkzNzMx", "url": "https://github.com/project-ncl/pnc/pull/2834#pullrequestreview-353993731", "createdAt": "2020-02-05T19:47:14Z", "commit": {"oid": "4c2406b70e12c2516598bb625f87a10bc8aa6a2f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NDM2OTEx", "url": "https://github.com/project-ncl/pnc/pull/2834#pullrequestreview-354436911", "createdAt": "2020-02-06T13:11:57Z", "commit": {"oid": "4c2406b70e12c2516598bb625f87a10bc8aa6a2f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMzoxMTo1N1rOFmagLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMzoxMjoxNlrOFmagwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgyNDQzMA==", "bodyText": "I think, it is redundant as we have a Builder for this class.", "url": "https://github.com/project-ncl/pnc/pull/2834#discussion_r375824430", "createdAt": "2020-02-06T13:11:57Z", "author": {"login": "jbartece"}, "path": "rest-model/src/main/java/org/jboss/pnc/rest/restmodel/TargetRepositoryRest.java", "diffHunk": "@@ -78,6 +78,15 @@\n     @NotNull(groups = {WhenUpdating.class, WhenCreatingNew.class})\n     private Set<Integer> artifactIds = new HashSet<>();\n \n+    public TargetRepositoryRest(Integer id, Boolean temporaryRepo,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c2406b70e12c2516598bb625f87a10bc8aa6a2f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgyNDU3Ng==", "bodyText": "What is the reason to set it as nativeQuery?", "url": "https://github.com/project-ncl/pnc/pull/2834#discussion_r375824576", "createdAt": "2020-02-06T13:12:16Z", "author": {"login": "jbartece"}, "path": "datastore/src/main/java/org/jboss/pnc/datastore/repositories/internal/ArtifactSpringRepository.java", "diffHunk": "@@ -18,12 +18,108 @@\n package org.jboss.pnc.datastore.repositories.internal;\n \n import org.jboss.pnc.model.Artifact;\n+import org.jboss.pnc.spi.datastore.repositories.ArtifactRepository.RawArtifact;\n import org.springframework.data.jpa.repository.JpaRepository;\n import org.springframework.data.jpa.repository.JpaSpecificationExecutor;\n+import org.springframework.data.jpa.repository.Query;\n+\n+import java.util.List;\n \n import javax.enterprise.context.Dependent;\n \n @Dependent\n public interface ArtifactSpringRepository extends JpaRepository<Artifact, Integer>, JpaSpecificationExecutor<Artifact> {\n \n-}\n+    @Query(\n+            value = \"SELECT DISTINCT \" +\n+                    \" artifact.id, \" +\n+                    \" artifact.artifactQuality, \" +\n+                    \" artifact.deployPath, \" +\n+                    \" artifact.filename, \" +\n+                    \" artifact.identifier, \" +\n+                    \" artifact.importDate, \" +\n+                    \" artifact.md5, \" +\n+                    \" artifact.originUrl, \" +\n+                    \" artifact.sha1, \" +\n+                    \" artifact.sha256, \" +\n+                    \" artifact.size, \" +\n+                    \" artifact.targetRepository_id as targetRepositoryId, \" +\n+                    \" targetRepository.temporaryRepo, \" +\n+                    \" targetRepository.identifier as targetRepositoryIdentifier, \" +\n+                    \" targetRepository.repositoryPath, \" +\n+                    \" targetRepository.repositoryType \" +\n+                    \"FROM Artifact artifact \" +\n+                    \"INNER JOIN build_record_artifact_dependencies_map dependency_artifact \" +\n+                    \"  ON dependency_artifact.dependency_artifact_id = artifact.id \" +\n+                    \"INNER JOIN BuildRecord buildRecord \" +\n+                    \"  ON dependency_artifact.build_record_id = buildRecord.id \" +\n+                    \"INNER JOIN TargetRepository targetRepository \" +\n+                    \"  ON targetRepository.id = artifact.targetRepository_id \" +\n+                    \"WHERE \" +\n+                    \" buildRecord.id = ?1 \" +\n+                    \"ORDER BY \" +\n+                    \" artifact.id ASC LIMIT ?2 OFFSET ?3\",\n+            nativeQuery = true)\n+    List<RawArtifact> getMinimizedDependencyArtifactsForBuildRecord(Integer buildRecordId, int pageSize, int offset);\n+\n+    @Query(\n+            value = \"SELECT COUNT(DISTINCT artifact.id) \" +\n+                    \"FROM Artifact artifact \" +\n+                    \"INNER JOIN build_record_artifact_dependencies_map dependency_artifact \" +\n+                    \"  ON dependency_artifact.dependency_artifact_id = artifact.id \" +\n+                    \"INNER JOIN BuildRecord buildRecord \" +\n+                    \"  ON dependency_artifact.build_record_id = buildRecord.id \" +\n+                    \"INNER JOIN TargetRepository targetRepository \" +\n+                    \"  ON targetRepository.id = artifact.targetRepository_id \" +\n+                    \"WHERE \" +\n+                    \" buildRecord.id = ?1\",\n+            nativeQuery = true)\n+    Object[] countMinimizedDependencyArtifactsForBuildRecord(Integer buildRecordId);\n+\n+    @Query(\n+            value = \"SELECT DISTINCT \" +\n+                    \" artifact.id, \" +\n+                    \" artifact.artifactQuality, \" +\n+                    \" artifact.deployPath, \" +\n+                    \" artifact.filename, \" +\n+                    \" artifact.identifier, \" +\n+                    \" artifact.importDate, \" +\n+                    \" artifact.md5, \" +\n+                    \" artifact.originUrl, \" +\n+                    \" artifact.sha1, \" +\n+                    \" artifact.sha256, \" +\n+                    \" artifact.size, \" +\n+                    \" artifact.targetRepository_id as targetRepositoryId, \" +\n+                    \" targetRepository.temporaryRepo, \" +\n+                    \" targetRepository.identifier as targetRepositoryIdentifier, \" +\n+                    \" targetRepository.repositoryPath, \" +\n+                    \" targetRepository.repositoryType \" +\n+                    \"FROM Artifact artifact \" +\n+                    \"INNER JOIN build_record_built_artifact_map built_artifact \" +\n+                    \"  ON built_artifact.built_artifact_id = artifact.id \" +\n+                    \"INNER JOIN BuildRecord buildRecord \" +\n+                    \"  ON built_artifact.build_record_id = buildRecord.id \" +\n+                    \"INNER JOIN TargetRepository targetRepository \" +\n+                    \"  ON targetRepository.id = artifact.targetRepository_id \" +\n+                    \"WHERE \" +\n+                    \" buildRecord.id = ?1 \" +\n+                    \"ORDER BY \" +\n+                    \" artifact.id ASC LIMIT ?2 OFFSET ?3\",\n+            nativeQuery = true)\n+    List<RawArtifact> getMinimizedBuiltArtifactsForBuildRecord(Integer buildRecordId, int pageSize, int offset);\n+\n+    @Query(\n+            value = \"SELECT COUNT(DISTINCT artifact.id) \" +\n+                    \"FROM Artifact artifact \" +\n+                    \"INNER JOIN build_record_built_artifact_map built_artifact \" +\n+                    \"  ON built_artifact.built_artifact_id = artifact.id \" +\n+                    \"INNER JOIN BuildRecord buildRecord \" +\n+                    \"  ON built_artifact.build_record_id = buildRecord.id \" +\n+                    \"INNER JOIN TargetRepository targetRepository \" +\n+                    \"  ON targetRepository.id = artifact.targetRepository_id \" +\n+                    \"WHERE \" +\n+                    \" buildRecord.id = ?1\",\n+            nativeQuery = true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c2406b70e12c2516598bb625f87a10bc8aa6a2f"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NTEzNTY1", "url": "https://github.com/project-ncl/pnc/pull/2834#pullrequestreview-354513565", "createdAt": "2020-02-06T14:57:26Z", "commit": {"oid": "4c2406b70e12c2516598bb625f87a10bc8aa6a2f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cdfd06f456002633ce437266f2a0c008ce0a39d", "author": {"user": {"login": "matejonnet", "name": "Matej Lazar"}}, "url": "https://github.com/project-ncl/pnc/commit/9cdfd06f456002633ce437266f2a0c008ce0a39d", "committedDate": "2020-02-06T16:13:57Z", "message": "Update build tasks timing capture points."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c74a2a1bd07c085114a7ff99337ac11a515f0b1e", "author": {"user": {"login": "thescouser89", "name": "Dustin Kut"}}, "url": "https://github.com/project-ncl/pnc/commit/c74a2a1bd07c085114a7ff99337ac11a515f0b1e", "committedDate": "2020-02-06T16:13:57Z", "message": "[NCL-5297] Add parameter description"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0056fc09be58c2704c3deffb0b363f133f9bf10f", "author": {"user": {"login": "matedo1", "name": "Martin"}}, "url": "https://github.com/project-ncl/pnc/commit/0056fc09be58c2704c3deffb0b363f133f9bf10f", "committedDate": "2020-02-06T16:13:57Z", "message": "NCL-5270 Add days support [v1.8 only]"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e81453a0ec1d8c518a993903a003f69613cb428e", "author": {"user": {"login": "matedo1", "name": "Martin"}}, "url": "https://github.com/project-ncl/pnc/commit/e81453a0ec1d8c518a993903a003f69613cb428e", "committedDate": "2020-02-06T16:13:57Z", "message": "NCL-5270 Fix select init state [v1.8 only]"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66259dde097d2a1497cb7b57db5b02f95fe72a69", "author": {"user": {"login": "matedo1", "name": "Martin"}}, "url": "https://github.com/project-ncl/pnc/commit/66259dde097d2a1497cb7b57db5b02f95fe72a69", "committedDate": "2020-02-06T16:13:57Z", "message": "NCL-5270 Add titles and change order [v1.8 only]"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "438e850f4de722192b965926d6a5130163d2f524", "author": {"user": {"login": "vibe13", "name": "Andrea Vibelli"}}, "url": "https://github.com/project-ncl/pnc/commit/438e850f4de722192b965926d6a5130163d2f524", "committedDate": "2020-02-06T16:13:57Z", "message": "Removal of new constructor and use of all args constructor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3efcd0f62c5f0e2cb8a2528b6b783bc83877c98", "author": {"user": {"login": "vibe13", "name": "Andrea Vibelli"}}, "url": "https://github.com/project-ncl/pnc/commit/d3efcd0f62c5f0e2cb8a2528b6b783bc83877c98", "committedDate": "2020-02-06T16:13:57Z", "message": "Fix the calculation of cache hit ratios and do filter non supported stats"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2709, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}