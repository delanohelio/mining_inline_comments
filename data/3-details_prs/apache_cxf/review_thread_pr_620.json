{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MzUwNTE5", "number": 620, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMDozNjoyNlrODWtc5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMDozNjoyNlrODWtc5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MTM5OTQxOnYy", "diffSide": "RIGHT", "path": "rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMDozNjoyNlrOFboCVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMDo0MDo1N1rOFdJJUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxMTgyOQ==", "bodyText": "I am wondering if we have to close the source (origin) InputStream here, since we replace it (dangling?) with the copy , what do you think @andymc12 ?", "url": "https://github.com/apache/cxf/pull/620#discussion_r364511829", "createdAt": "2020-01-09T00:36:26Z", "author": {"login": "reta"}, "path": "rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java", "diffHunk": "@@ -1878,4 +1891,16 @@ public static String logMessageHandlerProblem(String name, Class<?> cls, MediaTy\n         return errorMessage;\n     }\n \n+    // copy the input stream so that it is not inadvertently closed\n+    private static InputStream copyAndGetEntityStream(Message m) {\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        try {\n+            IOUtils.copy(m.getContent(InputStream.class), baos);\n+        } catch (IOException e) {\n+            throw ExceptionUtils.toInternalServerErrorException(e, null);\n+        }\n+        final byte[] copiedBytes = baos.toByteArray();\n+        m.setContent(InputStream.class, new ByteArrayInputStream(copiedBytes));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f8a18008d35270b9987872e1ae6cbe7d45f99f1"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTAwMjcxNg==", "bodyText": "Good question.  I'm running that suggestion through our automated tests and the TCK - on the surface, I think it should be fine, but just want to be sure.  The change I added looks like this:\nInputStream origInputStream = m.getContent(InputStream.class);\n        try {\n            IOUtils.copy(origInputStream, baos);\n        } catch (IOException e) {\n            throw ExceptionUtils.toInternalServerErrorException(e, null);\n        } finally {\n            try {\n                origInputStream.close();\n            } catch (Throwable t) { /* AutoFFDC */ }\n        }\n\nI'm out of the office tomorrow, so I may not have the results until Monday.", "url": "https://github.com/apache/cxf/pull/620#discussion_r365002716", "createdAt": "2020-01-09T23:03:01Z", "author": {"login": "andymc12"}, "path": "rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java", "diffHunk": "@@ -1878,4 +1891,16 @@ public static String logMessageHandlerProblem(String name, Class<?> cls, MediaTy\n         return errorMessage;\n     }\n \n+    // copy the input stream so that it is not inadvertently closed\n+    private static InputStream copyAndGetEntityStream(Message m) {\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        try {\n+            IOUtils.copy(m.getContent(InputStream.class), baos);\n+        } catch (IOException e) {\n+            throw ExceptionUtils.toInternalServerErrorException(e, null);\n+        }\n+        final byte[] copiedBytes = baos.toByteArray();\n+        m.setContent(InputStream.class, new ByteArrayInputStream(copiedBytes));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxMTgyOQ=="}, "originalCommit": {"oid": "1f8a18008d35270b9987872e1ae6cbe7d45f99f1"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA2NTg1Ng==", "bodyText": "\ud83d\udc4d thanks a lot!", "url": "https://github.com/apache/cxf/pull/620#discussion_r365065856", "createdAt": "2020-01-10T04:09:05Z", "author": {"login": "reta"}, "path": "rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java", "diffHunk": "@@ -1878,4 +1891,16 @@ public static String logMessageHandlerProblem(String name, Class<?> cls, MediaTy\n         return errorMessage;\n     }\n \n+    // copy the input stream so that it is not inadvertently closed\n+    private static InputStream copyAndGetEntityStream(Message m) {\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        try {\n+            IOUtils.copy(m.getContent(InputStream.class), baos);\n+        } catch (IOException e) {\n+            throw ExceptionUtils.toInternalServerErrorException(e, null);\n+        }\n+        final byte[] copiedBytes = baos.toByteArray();\n+        m.setContent(InputStream.class, new ByteArrayInputStream(copiedBytes));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxMTgyOQ=="}, "originalCommit": {"oid": "1f8a18008d35270b9987872e1ae6cbe7d45f99f1"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg0NTk5MA==", "bodyText": "I see Dan already merged it (thanks Dan!), but just to followup, the change had no ill effects in our automated testing - the normal functional tests and TCK all passed.", "url": "https://github.com/apache/cxf/pull/620#discussion_r365845990", "createdAt": "2020-01-13T14:52:59Z", "author": {"login": "andymc12"}, "path": "rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java", "diffHunk": "@@ -1878,4 +1891,16 @@ public static String logMessageHandlerProblem(String name, Class<?> cls, MediaTy\n         return errorMessage;\n     }\n \n+    // copy the input stream so that it is not inadvertently closed\n+    private static InputStream copyAndGetEntityStream(Message m) {\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        try {\n+            IOUtils.copy(m.getContent(InputStream.class), baos);\n+        } catch (IOException e) {\n+            throw ExceptionUtils.toInternalServerErrorException(e, null);\n+        }\n+        final byte[] copiedBytes = baos.toByteArray();\n+        m.setContent(InputStream.class, new ByteArrayInputStream(copiedBytes));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxMTgyOQ=="}, "originalCommit": {"oid": "1f8a18008d35270b9987872e1ae6cbe7d45f99f1"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMjg2NA==", "bodyText": "Yep, I also rerun TCK (https://issues.apache.org/jira/browse/CXF-7996) and these failure are gone, thanks @andymc12 !", "url": "https://github.com/apache/cxf/pull/620#discussion_r366102864", "createdAt": "2020-01-14T00:40:57Z", "author": {"login": "reta"}, "path": "rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java", "diffHunk": "@@ -1878,4 +1891,16 @@ public static String logMessageHandlerProblem(String name, Class<?> cls, MediaTy\n         return errorMessage;\n     }\n \n+    // copy the input stream so that it is not inadvertently closed\n+    private static InputStream copyAndGetEntityStream(Message m) {\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        try {\n+            IOUtils.copy(m.getContent(InputStream.class), baos);\n+        } catch (IOException e) {\n+            throw ExceptionUtils.toInternalServerErrorException(e, null);\n+        }\n+        final byte[] copiedBytes = baos.toByteArray();\n+        m.setContent(InputStream.class, new ByteArrayInputStream(copiedBytes));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxMTgyOQ=="}, "originalCommit": {"oid": "1f8a18008d35270b9987872e1ae6cbe7d45f99f1"}, "originalPosition": 80}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3646, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}