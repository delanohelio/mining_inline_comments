{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNTc3MTIy", "number": 696, "title": "[CXF-8345] Improve performance by avoiding resize of MessageImpl", "bodyText": "Hi All,\nWhile trying to consume the new 3.4.0 release into Open Liberty, we noticed that we had made a number of changes that has effectively forked Open Liberty's implementation of CXF.  We'd like to contribute those back to Apache as much as possible.\nThis PR includes some of the changes that are easy to \"disentangle\" and include some fixes we needed to make in order to pass some JAX-RS TCK tests, improve performance (the change to MessageImpl in particular made a large difference by avoiding resizing the underlying data store), etc.\nUnfortunately, many of our forked classes contains references to Open Liberty-specific code, so we'll need to sort those out before we can contribute them back.  One thing we did in this PR to was to add an extension point (the new RunnableWrapperFactory class) so that we can avoid that.\nComments and questions welcome - and also, please let me know how to \"record\" these changes.  I could open one JIRA for all of them, or separate them out by different areas (i.e. one for the MessageImpl performance change, one for the URITemplate change, etc.) so that it is clear to users what changed between releases.\nThanks in advance!\nAndy", "createdAt": "2020-09-21T21:45:50Z", "url": "https://github.com/apache/cxf/pull/696", "merged": true, "mergeCommit": {"oid": "cb60a4d794df79f6d0901e44d3eafa3d6bc8fd0c"}, "closed": true, "closedAt": "2020-09-23T15:14:48Z", "author": {"login": "andymc12"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKMcPTgH2gAyNDkwNTc3MTIyOmU2MmY2MjZhZTEyNzQxNTc0MDBiNDk0OTBiZmZiMjQyNzU3YjY1Nzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLhPh_AFqTQ5MzkyODA0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e62f626ae1274157400b49490bffb242757b6577", "author": {"user": {"login": "andymc12", "name": "Andy McCright"}}, "url": "https://github.com/apache/cxf/commit/e62f626ae1274157400b49490bffb242757b6577", "committedDate": "2020-09-18T21:26:11Z", "message": "Perf: Avoid map resize w/ initialSize and factor\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a034b94012f6545b2f8af8cc86281d7be0f6e26", "author": {"user": {"login": "andymc12", "name": "Andy McCright"}}, "url": "https://github.com/apache/cxf/commit/8a034b94012f6545b2f8af8cc86281d7be0f6e26", "committedDate": "2020-09-18T22:28:34Z", "message": "URI processing/caching/extending changes\n\nIncludes:\n- URITemplate cache\n- Extension to allow extenders to wrap runnables from HTTPConduit\n- Numeric handling in URIs\n- URITemplate processes parameters\n- Add checking for form post when content-type includes charsets, etc.\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>"}, "afterCommit": {"oid": "e62f626ae1274157400b49490bffb242757b6577", "author": {"user": {"login": "andymc12", "name": "Andy McCright"}}, "url": "https://github.com/apache/cxf/commit/e62f626ae1274157400b49490bffb242757b6577", "committedDate": "2020-09-18T21:26:11Z", "message": "Perf: Avoid map resize w/ initialSize and factor\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzOTI4MDIy", "url": "https://github.com/apache/cxf/pull/696#pullrequestreview-493928022", "createdAt": "2020-09-23T00:14:08Z", "commit": {"oid": "e62f626ae1274157400b49490bffb242757b6577"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwMDoxNDowOFrOHWQlWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwMDoxNDowOFrOHWQlWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwMjQyNA==", "bodyText": "Sorry @andymc12 , just of of curiosity, the MessageImpl is a HashMap and uses its default constructor, where capacity is set to 16 and load factor to 0.75.\n/**\n     * Constructs an empty <tt>HashMap</tt> with the default initial capacity\n     * (16) and the default load factor (0.75).\n     */\n    public HashMap() {\n        this.loadFactor = DEFAULT_LOAD_FACTOR; // all other fields defaulted\n    }\n\nYou guys found out that load factor of 1 helps to eliminate unnecessary resizing (probably because the size of the message container is around 16 elements)?", "url": "https://github.com/apache/cxf/pull/696#discussion_r493102424", "createdAt": "2020-09-23T00:14:08Z", "author": {"login": "reta"}, "path": "core/src/main/java/org/apache/cxf/interceptor/ServiceInvokerInterceptor.java", "diffHunk": "@@ -62,7 +62,7 @@ public void run() {\n \n                     Message outMessage = runableEx.getOutMessage();\n                     if (outMessage == null) {\n-                        outMessage = new MessageImpl();\n+                        outMessage = new MessageImpl(16, 1); // perf: size 16 / factor 1 to avoid resize operation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e62f626ae1274157400b49490bffb242757b6577"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzOTI4MDQz", "url": "https://github.com/apache/cxf/pull/696#pullrequestreview-493928043", "createdAt": "2020-09-23T00:14:14Z", "commit": {"oid": "e62f626ae1274157400b49490bffb242757b6577"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2127, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}