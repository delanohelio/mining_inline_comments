{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwNTE4NjAz", "number": 4220, "title": "Allow external recording using `quality` parameter", "bodyText": "Closes #4216\nWhat has been done to verify that this works as intended?\nNew tests and manually verified.\nWhy is this the best possible solution? Were any other approaches considered?\nThe implementation is actually pretty straight forward for this. I've left a couple of comments inline.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nI think we can skip QA for this until we have support for the other audio qualities in there.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-11-13T11:16:20Z", "url": "https://github.com/getodk/collect/pull/4220", "merged": true, "mergeCommit": {"oid": "52fc61af9f43f1851ad21c410ac6815772f1af4a"}, "closed": true, "closedAt": "2020-11-16T16:47:05Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcFPwZgH2gAyNTIwNTE4NjAzOjhiZWRkZjRiMTYwMGQyZTkwNDY5NjcyZTI5NDhiZmMxYWExNDZiMGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddHzJ9gFqTUzMTUwNjcxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8beddf4b1600d2e90469672e2948bfc1aa146b0c", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/8beddf4b1600d2e90469672e2948bfc1aa146b0c", "committedDate": "2020-11-13T11:13:51Z", "message": "Default to in-app recording"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "444f56c473ef7131a67f9f2f9733afc8d2407681", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/444f56c473ef7131a67f9f2f9733afc8d2407681", "committedDate": "2020-11-13T11:13:51Z", "message": "Use CollectTestRule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f32a8160b865be15a319b9dfeb281ebe474eae3", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/9f32a8160b865be15a319b9dfeb281ebe474eae3", "committedDate": "2020-11-13T11:13:52Z", "message": "Use external recording when specified in form"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "895d5d86663a79e46540bf84c61656edae11dd28", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/895d5d86663a79e46540bf84c61656edae11dd28", "committedDate": "2020-11-13T11:13:52Z", "message": "Add helper for grabbing prompt attribute values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21048d785da04e9e317c9c9150b35e6d22c5c285", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/21048d785da04e9e317c9c9150b35e6d22c5c285", "committedDate": "2020-11-13T11:13:52Z", "message": "Remove external app recording experimental preference"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4135e1bd10edbe9e1eb8ec9d64ce4bd5bc11711", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/a4135e1bd10edbe9e1eb8ec9d64ce4bd5bc11711", "committedDate": "2020-11-13T11:13:52Z", "message": "Remove WaitingForDataRegistry from InternalRecordingRequester"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e310e2a9f176afbfc086b95370e92e821eaa0223", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/e310e2a9f176afbfc086b95370e92e821eaa0223", "committedDate": "2020-11-13T11:13:52Z", "message": "Allow enabling external recorder from settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bce7e57344e0f4d203ccfcb98255dbe4445a19e", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/7bce7e57344e0f4d203ccfcb98255dbe4445a19e", "committedDate": "2020-11-13T11:15:41Z", "message": "Extract factory for RecordingRequester"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c04a07ebd6dece5cf5a52fecde5dd266603c5fb", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/5c04a07ebd6dece5cf5a52fecde5dd266603c5fb", "committedDate": "2020-11-13T11:15:43Z", "message": "Change attribute name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4853ea1c4205d775452fb88e688d040e1fc54762", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/4853ea1c4205d775452fb88e688d040e1fc54762", "committedDate": "2020-11-13T11:15:44Z", "message": "Make sure form quality param overrides setting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cd0f0d8bded0a0f7af8bd6170bc56d1a08507b8", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/7cd0f0d8bded0a0f7af8bd6170bc56d1a08507b8", "committedDate": "2020-11-13T11:15:44Z", "message": "Make WidgetFactory an instance in ODKView"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMDEzOTQ0", "url": "https://github.com/getodk/collect/pull/4220#pullrequestreview-530013944", "createdAt": "2020-11-13T12:16:00Z", "commit": {"oid": "7cd0f0d8bded0a0f7af8bd6170bc56d1a08507b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxMjoxNjowMVrOHysIkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxMjoxNjowMVrOHysIkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjkxMzkzOA==", "bodyText": "It felt like it made sense to rearrange this relationship so the ODKView owns a WidgetFactory object. In my mind this makes the dependency clearer.", "url": "https://github.com/getodk/collect/pull/4220#discussion_r522913938", "createdAt": "2020-11-13T12:16:01Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/ODKView.java", "diffHunk": "@@ -124,35 +127,27 @@\n     PreferencesProvider preferencesProvider;\n \n     @Inject\n-    AudioRecorderViewModelFactory audioRecorderViewModelFactory;\n+    ActivityAvailability activityAvailability;\n+\n+    private final WidgetFactory widgetFactory;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cd0f0d8bded0a0f7af8bd6170bc56d1a08507b8"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDI1ODQ4", "url": "https://github.com/getodk/collect/pull/4220#pullrequestreview-530425848", "createdAt": "2020-11-13T21:26:02Z", "commit": {"oid": "895d5d86663a79e46540bf84c61656edae11dd28"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyNjowM1rOHzAFUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyNjowM1rOHzAFUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI0MDc4Nw==", "bodyText": "We talked briefly about using optionals vs sticking to nulls. Are we diving into optionals?", "url": "https://github.com/getodk/collect/pull/4220#discussion_r523240787", "createdAt": "2020-11-13T21:26:03Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/utilities/FormEntryPromptUtils.java", "diffHunk": "@@ -124,4 +126,13 @@ public static String markQuestionIfIsRequired(String questionText, boolean isReq\n \n         return questionText;\n     }\n+\n+    public static Optional<String> getAttributeValue(FormEntryPrompt prompt, String attributeName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "895d5d86663a79e46540bf84c61656edae11dd28"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDM4NTk2", "url": "https://github.com/getodk/collect/pull/4220#pullrequestreview-530438596", "createdAt": "2020-11-13T21:51:34Z", "commit": {"oid": "7cd0f0d8bded0a0f7af8bd6170bc56d1a08507b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMTo1MTozNVrOHzAtmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMTo1MTozNVrOHzAtmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI1MTA5Nw==", "bodyText": "This feels like a very null structure if you see what I mean. Not really much benefit to an Optional if you're not chaining, for example.", "url": "https://github.com/getodk/collect/pull/4220#discussion_r523251097", "createdAt": "2020-11-13T21:51:35Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/RecordingRequesterFactory.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import androidx.activity.ComponentActivity;\n+import androidx.lifecycle.LifecycleOwner;\n+\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.odk.collect.android.utilities.ActivityAvailability;\n+import org.odk.collect.android.utilities.FormEntryPromptUtils;\n+import org.odk.collect.android.utilities.PermissionUtils;\n+import org.odk.collect.android.utilities.QuestionMediaManager;\n+import org.odk.collect.audiorecorder.recording.AudioRecorderViewModel;\n+\n+import java.util.Optional;\n+\n+public class RecordingRequesterFactory {\n+\n+    private final WaitingForDataRegistry waitingForDataRegistry;\n+    private final QuestionMediaManager questionMediaManager;\n+    private final ActivityAvailability activityAvailability;\n+    private final PermissionUtils permissionUtils;\n+    private final ComponentActivity activity;\n+    private final LifecycleOwner lifecycle;\n+    private final AudioRecorderViewModel audioRecorderViewModel;\n+\n+    public RecordingRequesterFactory(WaitingForDataRegistry waitingForDataRegistry, QuestionMediaManager questionMediaManager, ActivityAvailability activityAvailability, AudioRecorderViewModel audioRecorderViewModel, PermissionUtils permissionUtils, ComponentActivity activity, LifecycleOwner lifecycle) {\n+        this.waitingForDataRegistry = waitingForDataRegistry;\n+        this.questionMediaManager = questionMediaManager;\n+        this.activityAvailability = activityAvailability;\n+        this.audioRecorderViewModel = audioRecorderViewModel;\n+        this.permissionUtils = permissionUtils;\n+        this.activity = activity;\n+        this.lifecycle = lifecycle;\n+    }\n+\n+    public RecordingRequester create(FormEntryPrompt prompt, boolean externalRecorderPreferred) {\n+        Optional<String> audioQuality = FormEntryPromptUtils.getAttributeValue(prompt, \"quality\");\n+\n+        if (audioQuality.isPresent() && (audioQuality.get().equals(\"normal\") || audioQuality.get().equals(\"voice-only\"))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cd0f0d8bded0a0f7af8bd6170bc56d1a08507b8"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57d06c891dd0b5e8c802c9bc43f6f129d1dbcb2e", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/57d06c891dd0b5e8c802c9bc43f6f129d1dbcb2e", "committedDate": "2020-11-16T10:17:50Z", "message": "Use Nullable instead of Optional"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNTA2NzEx", "url": "https://github.com/getodk/collect/pull/4220#pullrequestreview-531506711", "createdAt": "2020-11-16T16:46:15Z", "commit": {"oid": "57d06c891dd0b5e8c802c9bc43f6f129d1dbcb2e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2467, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}