{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1NTQ3NzI4", "number": 4020, "title": "Match exactly improvements", "bodyText": "Closes #4007\nWhat has been done to verify that this works as intended?\nNew and reworked tests. Verified the different issues manually as well.\nWhy is this the best possible solution? Were any other approaches considered?\nComments inline.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nShould just fix issues. Good to double-check any features around them but everything has pretty good test coverage at this point.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-08-10T14:47:09Z", "url": "https://github.com/getodk/collect/pull/4020", "merged": true, "mergeCommit": {"oid": "4a0bc90ca2a021dda77643a0bd6ca07288265580"}, "closed": true, "closedAt": "2020-08-28T21:58:57Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9jY5YAFqTQ2NDI5ODkxMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDCzLTgBqjM3MDA0MDg5NzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0Mjk4OTEy", "url": "https://github.com/getodk/collect/pull/4020#pullrequestreview-464298912", "createdAt": "2020-08-10T14:49:20Z", "commit": {"oid": "8b4b6099ae62b222190a42a51a9e597cb1f521e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDo0OToyMFrOG-R3JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDo0OToyMFrOG-R3JA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk1NzU0MA==", "bodyText": "It ended up being a lot simpler to move a bunch of the testing of these preferences into the fragment tests.", "url": "https://github.com/getodk/collect/pull/4020#discussion_r467957540", "createdAt": "2020-08-10T14:49:20Z", "author": {"login": "seadowg"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/feature/settings/FormManagementSettingsTest.java", "diffHunk": "@@ -116,22 +116,6 @@ public void whenPreviouslyDownloadedOnlyEnabled_checkingAutoDownload_downloadsUp\n                 .assertAndDismissNotification(\"ODK Collect\", \"ODK auto-download results\", \"Success\");\n     }\n \n-    @Test\n-    public void whenGoogleDriveUsingAsServer_disablesPrefsAndOnlyAllowsManualUpdates() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b4b6099ae62b222190a42a51a9e597cb1f521e4"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MzAxNTI3", "url": "https://github.com/getodk/collect/pull/4020#pullrequestreview-464301527", "createdAt": "2020-08-10T14:52:08Z", "commit": {"oid": "8b4b6099ae62b222190a42a51a9e597cb1f521e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDo1MjowOVrOG-R_kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDo1MjowOVrOG-R_kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk1OTY5OA==", "bodyText": "To me it feels a lot simpler for us to simply display the disabled prefs with the appropriate values rather than change the underlying value. This has two advantages:\n\nThe code is more declarative - we don't have to actually change values of other prefs when a pref changes (like changing the value of form update mode when the protocol changes).\nIf the user switches between different options the disabled prefs will revert to the values they had them at before.", "url": "https://github.com/getodk/collect/pull/4020#discussion_r467959698", "createdAt": "2020-08-10T14:52:09Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/preferences/FormManagementPreferences.java", "diffHunk": "@@ -91,44 +92,36 @@ public void onSharedPreferenceChanged(SharedPreferences sharedPreferences, Strin\n         if (key.equals(KEY_FORM_UPDATE_MODE) || key.equals(KEY_PERIODIC_FORM_UPDATES_CHECK)) {\n             String newValue = sharedPreferences.getString(KEY_FORM_UPDATE_MODE, null);\n             updateDisabledPrefs(newValue, sharedPreferences.getString(KEY_PROTOCOL, null));\n-\n-            Preference preference = findPreference(KEY_FORM_UPDATE_MODE);\n-            preference.setSummary(((ListPreference) preference).getEntry());\n         }\n     }\n \n     private void setupFormUpdateMode() {\n         SharedPreferences sharedPreferences = preferencesProvider.getGeneralSharedPreferences();\n         updateDisabledPrefs(sharedPreferences.getString(KEY_FORM_UPDATE_MODE, null), sharedPreferences.getString(KEY_PROTOCOL, null));\n-\n-        Preference formUpdateMode = findPreference(KEY_FORM_UPDATE_MODE);\n-        formUpdateMode.setSummary(((ListPreference) formUpdateMode).getEntry());\n     }\n \n     private void updateDisabledPrefs(String formUpdateMode, String protocol) {\n         Preference updateFrequency = findPreference(KEY_PERIODIC_FORM_UPDATES_CHECK);\n         CheckBoxPreference automaticDownload = findPreference(KEY_AUTOMATIC_UPDATE);\n \n         if (Protocol.parse(getActivity(), protocol) == Protocol.GOOGLE) {\n-            findPreference(KEY_FORM_UPDATE_MODE).setEnabled(false);\n-            automaticDownload.setEnabled(false);\n+            displayDisabled(findPreference(KEY_FORM_UPDATE_MODE), getString(R.string.manually));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b4b6099ae62b222190a42a51a9e597cb1f521e4"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MzAyMTYz", "url": "https://github.com/getodk/collect/pull/4020#pullrequestreview-464302163", "createdAt": "2020-08-10T14:52:48Z", "commit": {"oid": "8b4b6099ae62b222190a42a51a9e597cb1f521e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDo1Mjo0OFrOG-SBlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDo1Mjo0OFrOG-SBlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk2MDIxMw==", "bodyText": "This is clunky but I couldn't find any other way to just display a value in a CheckBoxPreference. You'll see the String version is much simpler.", "url": "https://github.com/getodk/collect/pull/4020#discussion_r467960213", "createdAt": "2020-08-10T14:52:48Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/preferences/utilities/PreferencesUtils.java", "diffHunk": "@@ -0,0 +1,23 @@\n+package org.odk.collect.android.preferences.utilities;\n+\n+import androidx.preference.CheckBoxPreference;\n+import androidx.preference.Preference;\n+\n+public class PreferencesUtils {\n+\n+    private PreferencesUtils() {\n+\n+    }\n+\n+    public static void displayDisabled(CheckBoxPreference preference, boolean displayValue) {\n+        preference.setPersistent(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b4b6099ae62b222190a42a51a9e597cb1f521e4"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4OTIwNzAw", "url": "https://github.com/getodk/collect/pull/4020#pullrequestreview-468920700", "createdAt": "2020-08-18T00:48:23Z", "commit": {"oid": "8b4b6099ae62b222190a42a51a9e597cb1f521e4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b4b6099ae62b222190a42a51a9e597cb1f521e4", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/8b4b6099ae62b222190a42a51a9e597cb1f521e4", "committedDate": "2020-08-10T14:28:48Z", "message": "Stop sync when device is offline"}, "afterCommit": {"oid": "4372dbcf4d310f7ba731e73bca87972ca5afb491", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/4372dbcf4d310f7ba731e73bca87972ca5afb491", "committedDate": "2020-08-24T10:07:03Z", "message": "Stop sync when device is offline"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4372dbcf4d310f7ba731e73bca87972ca5afb491", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/4372dbcf4d310f7ba731e73bca87972ca5afb491", "committedDate": "2020-08-24T10:07:03Z", "message": "Stop sync when device is offline"}, "afterCommit": {"oid": "2aca3fb85af0543b7db82f5490dc73fb7fb959ae", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/2aca3fb85af0543b7db82f5490dc73fb7fb959ae", "committedDate": "2020-08-24T12:16:29Z", "message": "Stop sync when device is offline"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNTIyMjg2", "url": "https://github.com/getodk/collect/pull/4020#pullrequestreview-473522286", "createdAt": "2020-08-24T14:05:37Z", "commit": {"oid": "52f818437284f9383388cc3ce94249d4aaaacf76"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNDowNTozN1rOHFmoYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNDowNTozN1rOHFmoYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYzNzg1Ng==", "bodyText": "I was incredibly tempted to add a Settings interface for abstracting away this kind of logic (and shared prefs themselves). This would be in a weird place however as in most places it's pretty simple to just grab the actual pref value to work out what \"state\" we're in. I think if these utils start to grow we can revisit the idea.", "url": "https://github.com/getodk/collect/pull/4020#discussion_r475637856", "createdAt": "2020-08-24T14:05:37Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/configure/SettingsUtils.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.odk.collect.android.configure;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+\n+import androidx.annotation.NonNull;\n+\n+import org.odk.collect.android.formmanagement.FormUpdateMode;\n+import org.odk.collect.android.preferences.GeneralKeys;\n+import org.odk.collect.android.preferences.Protocol;\n+\n+public class SettingsUtils {\n+\n+    private SettingsUtils() {\n+\n+    }\n+\n+    @NonNull\n+    public static FormUpdateMode getFormUpdateMode(Context context, SharedPreferences generalSharedPreferences) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52f818437284f9383388cc3ce94249d4aaaacf76"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "52f818437284f9383388cc3ce94249d4aaaacf76", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/52f818437284f9383388cc3ce94249d4aaaacf76", "committedDate": "2020-08-24T13:55:15Z", "message": "Make sure manual mode is used in the app when Google Drive selected"}, "afterCommit": {"oid": "e8abbe6261cf2a0dd5620b83a7f6566ced2642eb", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/e8abbe6261cf2a0dd5620b83a7f6566ced2642eb", "committedDate": "2020-08-24T15:31:10Z", "message": "Make sure manual mode is used in the app when Google Drive selected"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbdbeddac47b1885c973139848714368a3d17008", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/bbdbeddac47b1885c973139848714368a3d17008", "committedDate": "2020-08-27T16:10:45Z", "message": "Fix admin setting indentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5acb78eb31a8eaa85d08ba33116d957b7763b8b0", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/5acb78eb31a8eaa85d08ba33116d957b7763b8b0", "committedDate": "2020-08-27T16:10:45Z", "message": "Use helper to only display prefs as disabled with value rather than changing them"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "201a303d092d42c89b05567b76981e608db88466", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/201a303d092d42c89b05567b76981e608db88466", "committedDate": "2020-08-27T16:10:45Z", "message": "Use simpler summary provider for form update mode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a142c619c20b6c47729f363fc8ba704882a4456", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/4a142c619c20b6c47729f363fc8ba704882a4456", "committedDate": "2020-08-27T16:14:27Z", "message": "Disable Get Blank Form when Match Exactly is enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "640ca84dc88cb0cb005267784912eda658b44b0c", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/640ca84dc88cb0cb005267784912eda658b44b0c", "committedDate": "2020-08-27T16:14:29Z", "message": "Make sure setting google drive as server updates form management settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71f437e6dead87f3c93035e028da4839c545c4f4", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/71f437e6dead87f3c93035e028da4839c545c4f4", "committedDate": "2020-08-27T16:14:29Z", "message": "Stop sync when device is offline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d371cd50171131dd1c26e3f366df87eb285c69b0", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/d371cd50171131dd1c26e3f366df87eb285c69b0", "committedDate": "2020-08-27T16:14:29Z", "message": "Make sure manual mode is used in the app when Google Drive selected"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db44ceda19765ca4719793aa1b975b9fa8e357e4", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/db44ceda19765ca4719793aa1b975b9fa8e357e4", "committedDate": "2020-08-27T16:14:29Z", "message": "Use correct match exactly logic in admin settings"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "449dd19ff9da04753af4adacd42d1283e6254506", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/449dd19ff9da04753af4adacd42d1283e6254506", "committedDate": "2020-08-27T13:15:14Z", "message": "Use correct match exactly logic in admin settings"}, "afterCommit": {"oid": "db44ceda19765ca4719793aa1b975b9fa8e357e4", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/db44ceda19765ca4719793aa1b975b9fa8e357e4", "committedDate": "2020-08-27T16:14:29Z", "message": "Use correct match exactly logic in admin settings"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2603, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}