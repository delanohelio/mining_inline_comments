{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5MTI3NjA3", "number": 3616, "title": "Fix how change tracking works with save button", "bodyText": "Closes #3498. We decided in the discussion in the issue that the solve would be for a second question event to appear after form-save with the old-value/new- value.\nWhat has been done to verify that this works as intended?\nUsed a form with change tracking enabled to check the issue was solved. I also added tests to drive out the new (fixed) behaviour.\nWhy is this the best possible solution? Were any other approaches considered?\nWe discussed in #3498. In terms of the structure I think it makes sense to move audit logging into our ViewModels as much as possible. This lets us abstract the details of all the interactions we need to make every time there is some 'action' performed in the UI. It does feel like we might end up with a lot of logic in the ViewModels however so it probably would be good to start abstracting this to a more high level component responsible for handling logging logic (EnumeratorBehaviourLogger for example) before we go any further. I don't think we need an issue for this but it might be a good idea for the future.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nIt'd be good to try a few forms with change tracking and alos try repeats, groups and single questions as they all output \"question\" audit events. The new changes are tested so it feels less risky than a lot of changes to form entry.\nDo we need any specific form for testing your changes? If so, please attach one\nAny form with change tracking would be good to use but there aren't any other specific features we need to look at.\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-01-30T15:10:33Z", "url": "https://github.com/getodk/collect/pull/3616", "merged": true, "mergeCommit": {"oid": "46768d010f136b389a2c3e446df32d3bf564a013"}, "closed": true, "closedAt": "2020-02-14T15:04:22Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBVtOwgBqjMwMDk4ODI3ODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcD3gswgH2gAyMzY5MTI3NjA3OmUxNjBhYWYyODM2NDRlZWZjNzliZDVmZGUyOGJiYTZmNTgzMTUwMDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f3e704e2d10f8f7be5f168302fe478d40c5f5e5", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/0f3e704e2d10f8f7be5f168302fe478d40c5f5e5", "committedDate": "2020-01-31T19:07:40Z", "message": "Add FormEntry data class to represent form details to ViewModels"}, "afterCommit": {"oid": "56142da4797dc4da1198f9374af15d884a094be5", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/56142da4797dc4da1198f9374af15d884a094be5", "committedDate": "2020-01-30T14:03:36Z", "message": "Create saving package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "156d68eeb32575e7c975d313db330eb6311b2a3f", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/156d68eeb32575e7c975d313db330eb6311b2a3f", "committedDate": "2020-02-06T14:37:17Z", "message": "Flush audit event log when saving form"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "484d2279464d0b7d565c3f04a279115248620ec9", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/484d2279464d0b7d565c3f04a279115248620ec9", "committedDate": "2020-02-06T14:42:43Z", "message": "Log question event after form save that doesn't exit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23fd99491c9bec92a1e38a6a4c69a17ea55958a0", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/23fd99491c9bec92a1e38a6a4c69a17ea55958a0", "committedDate": "2020-02-06T14:42:43Z", "message": "Make logging tests more consistent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9eefd630f6b02ca875ffa5ea9a112056ae6d5864", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/9eefd630f6b02ca875ffa5ea9a112056ae6d5864", "committedDate": "2020-02-06T14:55:22Z", "message": "Create saving package"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "56142da4797dc4da1198f9374af15d884a094be5", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/56142da4797dc4da1198f9374af15d884a094be5", "committedDate": "2020-01-30T14:03:36Z", "message": "Create saving package"}, "afterCommit": {"oid": "9eefd630f6b02ca875ffa5ea9a112056ae6d5864", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/9eefd630f6b02ca875ffa5ea9a112056ae6d5864", "committedDate": "2020-02-06T14:55:22Z", "message": "Create saving package"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3OTQ5MTg4", "url": "https://github.com/getodk/collect/pull/3616#pullrequestreview-357949188", "createdAt": "2020-02-13T04:34:15Z", "commit": {"oid": "156d68eeb32575e7c975d313db330eb6311b2a3f"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNDozNDoxNVrOFpGwrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNDozNzoxOFrOFpGyyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY0NjcwMg==", "bodyText": "Ah yes, good name!", "url": "https://github.com/getodk/collect/pull/3616#discussion_r378646702", "createdAt": "2020-02-13T04:34:15Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/audit/AuditEventLogger.java", "diffHunk": "@@ -97,6 +97,16 @@ public void logEvent(AuditEvent.AuditEventType eventType, FormIndex formIndex,\n         }\n     }\n \n+    /*\n+     * Finalizes and writes events\n+     */\n+    public void flush() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "156d68eeb32575e7c975d313db330eb6311b2a3f"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY0NzA3MQ==", "bodyText": "This is a small thing but I'd keep the Uri first since that's what you're saving.", "url": "https://github.com/getodk/collect/pull/3616#discussion_r378647071", "createdAt": "2020-02-13T04:36:16Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/DiskFormSaver.java", "diffHunk": "@@ -2,14 +2,15 @@\n \n import android.net.Uri;\n \n+import org.odk.collect.android.logic.FormController;\n import org.odk.collect.android.tasks.SaveFormToDisk;\n import org.odk.collect.android.tasks.SaveToDiskResult;\n \n public class DiskFormSaver implements FormSaver {\n \n     @Override\n-    public SaveToDiskResult save(Uri instanceContentURI, boolean shouldFinalize, String updatedSaveName, boolean exitAfter, ProgressListener progressListener) {\n-        SaveFormToDisk saveFormToDisk = new SaveFormToDisk(instanceContentURI, exitAfter, shouldFinalize, updatedSaveName);\n+    public SaveToDiskResult save(FormController formController, boolean shouldFinalize, String updatedSaveName, boolean exitAfter, ProgressListener progressListener, Uri instanceContentURI) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "484d2279464d0b7d565c3f04a279115248620ec9"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY0NzI0Mw==", "bodyText": "This is more like logCurrentScreen or logCurrentEvents, I think?", "url": "https://github.com/getodk/collect/pull/3616#discussion_r378647243", "createdAt": "2020-02-13T04:37:18Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/audit/AuditUtils.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package org.odk.collect.android.formentry.audit;\n+\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.odk.collect.android.logic.FormController;\n+\n+import static org.javarosa.form.api.FormEntryController.EVENT_GROUP;\n+import static org.javarosa.form.api.FormEntryController.EVENT_QUESTION;\n+import static org.javarosa.form.api.FormEntryController.EVENT_REPEAT;\n+\n+public class AuditUtils {\n+\n+    private AuditUtils() {\n+\n+    }\n+\n+    public static void logCurrentEvent(FormController formController, AuditEventLogger auditEventLogger, long currentTime) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "484d2279464d0b7d565c3f04a279115248620ec9"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e160aaf283644eefc79bd5fde28bba6f58315009", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/e160aaf283644eefc79bd5fde28bba6f58315009", "committedDate": "2020-02-13T09:28:21Z", "message": "Rename to make method clearer"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2272, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}