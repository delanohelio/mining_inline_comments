{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyNzM4MzU4", "number": 4326, "title": "Always update formController for viewmodels when singleton is updated", "bodyText": "Closes #4327\nSome users are getting a crash that suggests their singleton formController is set but the ViewModels don't know about it.\nI searched for Collect.getInstance().setFormController and made sure that when it's called, formControllerAvailable is always called with the same value.\nI also added commits improving logging that I saw while troubleshooting this.\nWhat has been done to verify that this works as intended?\nI can't reproduce the issue so all I have done is visual inspection.\nWhy is this the best possible solution? Were any other approaches considered?\nIt doesn't make sense that those two updates would be different so I think this is a change we have to make. I also updated some logging. The other approach I considered was passing in formController to moveForward and moveBackward and logging if the view model one is null but the one passed in is not. I think that would be fine and perhaps we can do that too but I think this change actually addresses the root cause.\nI initially wanted to also null out the ViewModels' formControllers when            Collect.getInstance().setFormController(null) is called. However, that's not necessary for this fix and would probably require introducing new methods for those view models. It feels weird that there might be a stale form controller set but we can come back to it.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nI believe this to be very low risk. We are calling formControllerAvailable in more cases which seems it would always be positive.\nDo we need any specific form for testing your changes? If so, please attach one.\nNo.\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nNo.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-12-18T19:39:02Z", "url": "https://github.com/getodk/collect/pull/4326", "merged": true, "mergeCommit": {"oid": "48899f69777c29af43c889df69e0c8060d79a603"}, "closed": true, "closedAt": "2020-12-19T22:22:02Z", "author": {"login": "lognaturel"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdndd2cABqjQxMzEyMTU1Nzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdngXYdgFqTU1NTg2OTY0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6fc4c8271801637d5dfcf12281bd1f17a79bd213", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/6fc4c8271801637d5dfcf12281bd1f17a79bd213", "committedDate": "2020-12-18T19:35:42Z", "message": "Always update formController for viewmodels when singleton is updated"}, "afterCommit": {"oid": "04346f95ae83ca66b6a26527762d6c0fc0e6224a", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/04346f95ae83ca66b6a26527762d6c0fc0e6224a", "committedDate": "2020-12-18T19:39:59Z", "message": "Always update formController for viewmodels when singleton is updated"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1NzY3Njcy", "url": "https://github.com/getodk/collect/pull/4326#pullrequestreview-555767672", "createdAt": "2020-12-18T19:41:12Z", "commit": {"oid": "04346f95ae83ca66b6a26527762d6c0fc0e6224a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxOTo0MToxMlrOIIwfag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxOTo0MToxMlrOIIwfag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA1Mzk5NA==", "bodyText": "I see this in a lot of our logs and I can't tell if it's actually meaningful. Hopefully seeing the exception will give us some insights. I'm hoping it turns out to be expected and we can just remove the logging.", "url": "https://github.com/getodk/collect/pull/4326#discussion_r546053994", "createdAt": "2020-12-18T19:41:12Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2297,7 +2301,7 @@ public void denied() {\n                         formController.setLanguage(newLanguage);\n                     } catch (Exception e) {\n                         // if somehow we end up with a bad language, set it to the default\n-                        Timber.e(\"Ended up with a bad language. %s\", newLanguage);\n+                        Timber.e(e, \"Ended up with a bad language. %s\", newLanguage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04346f95ae83ca66b6a26527762d6c0fc0e6224a"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "882b36b9d6f7911ff2460f2afdaa933f9043c36c", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/882b36b9d6f7911ff2460f2afdaa933f9043c36c", "committedDate": "2020-12-18T21:49:53Z", "message": "Always update formController for viewmodels when singleton is updated"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d285482fa900eb10b4b785d3cc6cf21f3a589995", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/d285482fa900eb10b4b785d3cc6cf21f3a589995", "committedDate": "2020-12-18T21:50:04Z", "message": "Add more logging for attachControlsToInstanceData crash"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a42eeec4d8a25a50d19c5a9448fb63f389b4926", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/8a42eeec4d8a25a50d19c5a9448fb63f389b4926", "committedDate": "2020-12-18T21:50:04Z", "message": "Improve ContentUriProvider logging"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "661c62dfcd284a4e6ae593dc8e77ee0f28fb3a61", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/661c62dfcd284a4e6ae593dc8e77ee0f28fb3a61", "committedDate": "2020-12-18T20:07:33Z", "message": "Improve ContentUriProvider logging"}, "afterCommit": {"oid": "8a42eeec4d8a25a50d19c5a9448fb63f389b4926", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/8a42eeec4d8a25a50d19c5a9448fb63f389b4926", "committedDate": "2020-12-18T21:50:04Z", "message": "Improve ContentUriProvider logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f11048ec70df535a1b3dcf69b08b37f98a9e16d4", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/f11048ec70df535a1b3dcf69b08b37f98a9e16d4", "committedDate": "2020-12-18T22:17:33Z", "message": "Don't remotely log bad language\n\nThis is guaranteed to happen any time a language hasn't been explicitly set by the user."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1ODY5NjQ3", "url": "https://github.com/getodk/collect/pull/4326#pullrequestreview-555869647", "createdAt": "2020-12-18T23:02:46Z", "commit": {"oid": "f11048ec70df535a1b3dcf69b08b37f98a9e16d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQyMzowMjo0N1rOII1ajQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQyMzowMjo0N1rOII1ajQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEzNDY2OQ==", "bodyText": "This change makes sense. I wonder if we should also maybe dismiss the loading dialog later once we set everything because now we do that at the beginning of this method what unblocks the UI and if the rest of the job we do in this method takes some time it's dangerous.", "url": "https://github.com/getodk/collect/pull/4326#discussion_r546134669", "createdAt": "2020-12-18T23:02:47Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2282,6 +2283,8 @@ public void denied() {\n                 t.destroy();\n \n                 Collect.getInstance().setFormController(formController);\n+                formControllerAvailable(formController);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f11048ec70df535a1b3dcf69b08b37f98a9e16d4"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2388, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}