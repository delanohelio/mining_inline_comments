{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzMTU4Mjgy", "number": 3668, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMToxMDoyM1rODk0SSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMToxNDowNVrODlAPZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5OTMxOTc5OnYy", "diffSide": "RIGHT", "path": "collect_app/src/androidTest/java/org/odk/collect/android/storage/StorageMigrationCompletedBannerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMToxMDoyM1rOFxWocQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDoyMzozNVrOFxnnpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5NTM0NQ==", "bodyText": "Why is this needed? Isn't that the default runner?", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387295345", "createdAt": "2020-03-03T21:10:23Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/storage/StorageMigrationCompletedBannerTest.java", "diffHunk": "@@ -21,18 +23,10 @@\n \n import static org.odk.collect.android.support.CollectHelpers.overrideAppDependencyModule;\n \n+@RunWith(AndroidJUnit4.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73df40136ceb394198ce20f8b14d065ef0b2bb83"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3MzY3MA==", "bodyText": "You technically don't need it but I think it's weird not to have it. It is possible to specify other ones and the Google team loves deprecating/changing them.", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387573670", "createdAt": "2020-03-04T10:23:35Z", "author": {"login": "seadowg"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/storage/StorageMigrationCompletedBannerTest.java", "diffHunk": "@@ -21,18 +23,10 @@\n \n import static org.odk.collect.android.support.CollectHelpers.overrideAppDependencyModule;\n \n+@RunWith(AndroidJUnit4.class)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5NTM0NQ=="}, "originalCommit": {"oid": "73df40136ceb394198ce20f8b14d065ef0b2bb83"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5OTQ2NDk0OnYy", "diffSide": "RIGHT", "path": "collect_app/src/test/java/org/odk/collect/android/storage/migration/StorageMigratorTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMTo1Nzo0MVrOFxYDPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDowMzowMlrOFxm6bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxODU4OA==", "bodyText": "Not important to change now but there are lots of doReturn calls in this test file that should use the newer and more readable when/thenReturn syntax. See the javadoc: Use doReturn() in those rare occasions when you cannot use when(Object). CC @grzesiek2010", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387318588", "createdAt": "2020-03-03T21:57:41Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/test/java/org/odk/collect/android/storage/migration/StorageMigratorTest.java", "diffHunk": "@@ -27,45 +31,44 @@\n     private final StorageMigrationRepository storageMigrationRepository = mock(StorageMigrationRepository.class);\n     private final GeneralSharedPreferences generalSharedPreferences = mock(GeneralSharedPreferences.class);\n     private final ReferenceManager referenceManager = mock(ReferenceManager.class);\n+    private final BackgroundWorkManager backgroundWorkManager = mock(BackgroundWorkManager.class);\n \n     @Before\n     public void setup() {\n-        storageMigrator = spy(new StorageMigrator(storagePathProvider, storageStateProvider, storageEraser, storageMigrationRepository, generalSharedPreferences, referenceManager));\n+        whenFormDownloaderIsNotRunning();\n+        whenFormUploaderIsNotRunning();\n \n-        doNothing().when(storageMigrator).reopenDatabases();\n         doNothing().when(storageEraser).clearOdkDirOnScopedStorage();\n         doNothing().when(storageEraser).deleteOdkDirFromUnscopedStorage();\n         doReturn(\"/sdcard/odk/layers/countries/countries-raster.mbtiles\").when(generalSharedPreferences).get(KEY_REFERENCE_LAYER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8d3c167b32cfbe26164c8f6e1eb7eca807a5a3d"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU2MjA5NA==", "bodyText": "Right probably I used spies then refactored to mocks and forgot to update here.", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387562094", "createdAt": "2020-03-04T10:03:02Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/test/java/org/odk/collect/android/storage/migration/StorageMigratorTest.java", "diffHunk": "@@ -27,45 +31,44 @@\n     private final StorageMigrationRepository storageMigrationRepository = mock(StorageMigrationRepository.class);\n     private final GeneralSharedPreferences generalSharedPreferences = mock(GeneralSharedPreferences.class);\n     private final ReferenceManager referenceManager = mock(ReferenceManager.class);\n+    private final BackgroundWorkManager backgroundWorkManager = mock(BackgroundWorkManager.class);\n \n     @Before\n     public void setup() {\n-        storageMigrator = spy(new StorageMigrator(storagePathProvider, storageStateProvider, storageEraser, storageMigrationRepository, generalSharedPreferences, referenceManager));\n+        whenFormDownloaderIsNotRunning();\n+        whenFormUploaderIsNotRunning();\n \n-        doNothing().when(storageMigrator).reopenDatabases();\n         doNothing().when(storageEraser).clearOdkDirOnScopedStorage();\n         doNothing().when(storageEraser).deleteOdkDirFromUnscopedStorage();\n         doReturn(\"/sdcard/odk/layers/countries/countries-raster.mbtiles\").when(generalSharedPreferences).get(KEY_REFERENCE_LAYER);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxODU4OA=="}, "originalCommit": {"oid": "a8d3c167b32cfbe26164c8f6e1eb7eca807a5a3d"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5OTQ3NTMxOnYy", "diffSide": "RIGHT", "path": "collect_app/src/test/java/org/odk/collect/android/storage/migration/StorageMigratorTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMjowMToxMFrOFxYJ6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDowMjo0NVrOFxm5uA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMyMDI5Nw==", "bodyText": "These doNothing calls shouldn't be needed because storageEraser is a mock. It's needed below for the reopenDatabases because storageMigrator is a spy and not all of its methods can be run. CC @grzesiek2010", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387320297", "createdAt": "2020-03-03T22:01:10Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/test/java/org/odk/collect/android/storage/migration/StorageMigratorTest.java", "diffHunk": "@@ -27,45 +31,44 @@\n     private final StorageMigrationRepository storageMigrationRepository = mock(StorageMigrationRepository.class);\n     private final GeneralSharedPreferences generalSharedPreferences = mock(GeneralSharedPreferences.class);\n     private final ReferenceManager referenceManager = mock(ReferenceManager.class);\n+    private final BackgroundWorkManager backgroundWorkManager = mock(BackgroundWorkManager.class);\n \n     @Before\n     public void setup() {\n-        storageMigrator = spy(new StorageMigrator(storagePathProvider, storageStateProvider, storageEraser, storageMigrationRepository, generalSharedPreferences, referenceManager));\n+        whenFormDownloaderIsNotRunning();\n+        whenFormUploaderIsNotRunning();\n \n-        doNothing().when(storageMigrator).reopenDatabases();\n         doNothing().when(storageEraser).clearOdkDirOnScopedStorage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8d3c167b32cfbe26164c8f6e1eb7eca807a5a3d"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU2MTkxMg==", "bodyText": "Right probably I used spies then refactored to mocks and forgot to update here.", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387561912", "createdAt": "2020-03-04T10:02:45Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/test/java/org/odk/collect/android/storage/migration/StorageMigratorTest.java", "diffHunk": "@@ -27,45 +31,44 @@\n     private final StorageMigrationRepository storageMigrationRepository = mock(StorageMigrationRepository.class);\n     private final GeneralSharedPreferences generalSharedPreferences = mock(GeneralSharedPreferences.class);\n     private final ReferenceManager referenceManager = mock(ReferenceManager.class);\n+    private final BackgroundWorkManager backgroundWorkManager = mock(BackgroundWorkManager.class);\n \n     @Before\n     public void setup() {\n-        storageMigrator = spy(new StorageMigrator(storagePathProvider, storageStateProvider, storageEraser, storageMigrationRepository, generalSharedPreferences, referenceManager));\n+        whenFormDownloaderIsNotRunning();\n+        whenFormUploaderIsNotRunning();\n \n-        doNothing().when(storageMigrator).reopenDatabases();\n         doNothing().when(storageEraser).clearOdkDirOnScopedStorage();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMyMDI5Nw=="}, "originalCommit": {"oid": "a8d3c167b32cfbe26164c8f6e1eb7eca807a5a3d"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5OTQ4MjY4OnYy", "diffSide": "RIGHT", "path": "collect_app/src/androidTest/java/org/odk/collect/android/support/ResetStateRule.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMjowMzoyNFrOFxYOYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMjowMzoyNFrOFxYOYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMyMTQ0Mw==", "bodyText": "I didn't realize that applications were never recreated in Espresso tests before @seadowg explained this one to me. So Collect.onCreate does not run for every test.", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387321443", "createdAt": "2020-03-03T22:03:24Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/support/ResetStateRule.java", "diffHunk": "@@ -29,14 +56,44 @@ public Statement apply(final Statement base, Description description) {\n \n         @Override\n         public void evaluate() throws Throwable {\n+            // Reset any singleton state\n+            if (appDependencyModule != null) {\n+                CollectHelpers.overrideAppDependencyModule(appDependencyModule);\n+            } else {\n+                CollectHelpers.overrideAppDependencyModule(new AppDependencyModule());\n+            }\n+\n+            // Make sure we clear all our shared prefs - ignore logic that doesn't reset keys\n+            Context context = InstrumentationRegistry.getInstrumentation().getTargetContext();\n+            PreferenceManager.getDefaultSharedPreferences(context).edit().clear().commit();\n+            context.getSharedPreferences(ADMIN_PREFERENCES, 0).edit().clear().commit();\n+            new MetaSharedPreferencesProvider(context).getMetaSharedPreferences().edit().clear().commit();\n+\n+            // Reset the app in both the old and new storage locations (just nuke dirs)\n             List<Integer> resetActions = Arrays.asList(\n-                    ResetUtility.ResetAction.RESET_PREFERENCES, ResetUtility.ResetAction.RESET_INSTANCES,\n-                    ResetUtility.ResetAction.RESET_FORMS, ResetUtility.ResetAction.RESET_LAYERS,\n-                    ResetUtility.ResetAction.RESET_CACHE, ResetUtility.ResetAction.RESET_OSM_DROID\n+                    ResetUtility.ResetAction.RESET_PREFERENCES,\n+                    ResetUtility.ResetAction.RESET_INSTANCES,\n+                    ResetUtility.ResetAction.RESET_FORMS,\n+                    ResetUtility.ResetAction.RESET_LAYERS,\n+                    ResetUtility.ResetAction.RESET_CACHE,\n+                    ResetUtility.ResetAction.RESET_OSM_DROID\n             );\n \n-            Context targetContext = InstrumentationRegistry.getInstrumentation().getTargetContext();\n-            new ResetUtility().reset(targetContext, resetActions);\n+            new StorageStateProvider().disableUsingScopedStorage();\n+            new ResetUtility().reset(context, resetActions);\n+            new StorageStateProvider().enableUsingScopedStorage();\n+            new ResetUtility().reset(context, resetActions);\n+\n+            // Setup storage location for tests\n+            if (useScopedStorage) {\n+                new StorageStateProvider().enableUsingScopedStorage();\n+            } else {\n+                new StorageStateProvider().disableUsingScopedStorage();\n+            }\n+\n+            // Any dependencies (PropertyManager for instance) will already have been\n+            // passed to JavaRosa so make sure everything is reset\n+            ((Collect) context.getApplicationContext()).initializeJavaRosa();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8d3c167b32cfbe26164c8f6e1eb7eca807a5a3d"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5OTQ5NjI1OnYy", "diffSide": "RIGHT", "path": "collect_app/src/main/java/org/odk/collect/android/activities/MainMenuActivity.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMjowNzoxOVrOFxYWmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDoxNjoyNFrOFxnXew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMyMzU0NA==", "bodyText": "I don't think this is needed. Because of the KEYS_WE_SHOULD_NOT_RESET map, the scoped storage setting can't be changed by a settings file.", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387323544", "createdAt": "2020-03-03T22:07:19Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/MainMenuActivity.java", "diffHunk": "@@ -296,12 +296,8 @@ public void onClick(View v) {\n                 ToastUtils.showLongToast(R.string.corrupt_settings_file_notification);\n             }\n         }\n-    }\n \n-    private void initToolbar() {\n-        Toolbar toolbar = findViewById(R.id.toolbar);\n-        setTitle(getString(R.string.main_menu));\n-        setSupportActionBar(toolbar);\n+        setUpStorageMigrationBanner();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8d3c167b32cfbe26164c8f6e1eb7eca807a5a3d"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1Mzk2OQ==", "bodyText": "It's called in onResume() and that's enough.", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387553969", "createdAt": "2020-03-04T09:48:50Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/MainMenuActivity.java", "diffHunk": "@@ -296,12 +296,8 @@ public void onClick(View v) {\n                 ToastUtils.showLongToast(R.string.corrupt_settings_file_notification);\n             }\n         }\n-    }\n \n-    private void initToolbar() {\n-        Toolbar toolbar = findViewById(R.id.toolbar);\n-        setTitle(getString(R.string.main_menu));\n-        setSupportActionBar(toolbar);\n+        setUpStorageMigrationBanner();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMyMzU0NA=="}, "originalCommit": {"oid": "a8d3c167b32cfbe26164c8f6e1eb7eca807a5a3d"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU2OTUzMQ==", "bodyText": "Oh my bad another mistake. I was experimenting with test coverage and left this in. @grzesiek2010 is totally right it's only needed in onResume", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387569531", "createdAt": "2020-03-04T10:16:24Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/MainMenuActivity.java", "diffHunk": "@@ -296,12 +296,8 @@ public void onClick(View v) {\n                 ToastUtils.showLongToast(R.string.corrupt_settings_file_notification);\n             }\n         }\n-    }\n \n-    private void initToolbar() {\n-        Toolbar toolbar = findViewById(R.id.toolbar);\n-        setTitle(getString(R.string.main_menu));\n-        setSupportActionBar(toolbar);\n+        setUpStorageMigrationBanner();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMyMzU0NA=="}, "originalCommit": {"oid": "a8d3c167b32cfbe26164c8f6e1eb7eca807a5a3d"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMDk5NjMyOnYy", "diffSide": "RIGHT", "path": "collect_app/src/androidTest/java/org/odk/collect/android/test/FormLoadingUtils.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwOTo1MDozOFrOFxme1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwOTo1OTowMlrOFxmxcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1NTAyOQ==", "bodyText": "Shouldn't it be in ResetStateRule?", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387555029", "createdAt": "2020-03-04T09:50:38Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/test/FormLoadingUtils.java", "diffHunk": "@@ -52,6 +52,7 @@ private FormLoadingUtils() {\n      */\n     public static void copyFormToStorage(String formFilename, List<String> mediaFilePaths, boolean copyToDatabase) throws IOException {\n         new StorageInitializer().createOdkDirsOnStorage();\n+        ReferenceManager.instance().reset();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8d3c167b32cfbe26164c8f6e1eb7eca807a5a3d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1NjI4Mw==", "bodyText": "It was originally. I actually ended up on a call with @lognaturel to double check all the JavaRosa stuff (as I'm not as knowledgable about all that) and we ended up deciding to put this here. The reasoning was that the app doesn't need reset() to be called (it already handles setting up the ReferenceManager) but CopyFormRule does need it.", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387556283", "createdAt": "2020-03-04T09:52:53Z", "author": {"login": "seadowg"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/test/FormLoadingUtils.java", "diffHunk": "@@ -52,6 +52,7 @@ private FormLoadingUtils() {\n      */\n     public static void copyFormToStorage(String formFilename, List<String> mediaFilePaths, boolean copyToDatabase) throws IOException {\n         new StorageInitializer().createOdkDirsOnStorage();\n+        ReferenceManager.instance().reset();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1NTAyOQ=="}, "originalCommit": {"oid": "a8d3c167b32cfbe26164c8f6e1eb7eca807a5a3d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1OTc5Mw==", "bodyText": "ok", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387559793", "createdAt": "2020-03-04T09:59:02Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/test/FormLoadingUtils.java", "diffHunk": "@@ -52,6 +52,7 @@ private FormLoadingUtils() {\n      */\n     public static void copyFormToStorage(String formFilename, List<String> mediaFilePaths, boolean copyToDatabase) throws IOException {\n         new StorageInitializer().createOdkDirsOnStorage();\n+        ReferenceManager.instance().reset();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1NTAyOQ=="}, "originalCommit": {"oid": "a8d3c167b32cfbe26164c8f6e1eb7eca807a5a3d"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTAzNTE3OnYy", "diffSide": "RIGHT", "path": "collect_app/src/main/java/org/odk/collect/android/utilities/ResetUtility.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDowMTozNFrOFxm3Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDowNDoxMFrOFxm8zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU2MTI1NQ==", "bodyText": "What is the advantage of this change?", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387561255", "createdAt": "2020-03-04T10:01:34Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/utilities/ResetUtility.java", "diffHunk": "@@ -35,7 +35,11 @@\n public class ResetUtility {\n \n     private List<Integer> failedResetActions;\n-    private final StoragePathProvider storagePathProvider = new StoragePathProvider();\n+    private final StoragePathProvider storagePathProvider;\n+\n+    public ResetUtility() {\n+        storagePathProvider = new StoragePathProvider();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8d3c167b32cfbe26164c8f6e1eb7eca807a5a3d"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU2MjcwMg==", "bodyText": "oooo nice catch. That's a mistake. I think I'd looked at passing one in for some reason but abandoned the idea. I'll revert that.", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387562702", "createdAt": "2020-03-04T10:04:10Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/utilities/ResetUtility.java", "diffHunk": "@@ -35,7 +35,11 @@\n public class ResetUtility {\n \n     private List<Integer> failedResetActions;\n-    private final StoragePathProvider storagePathProvider = new StoragePathProvider();\n+    private final StoragePathProvider storagePathProvider;\n+\n+    public ResetUtility() {\n+        storagePathProvider = new StoragePathProvider();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU2MTI1NQ=="}, "originalCommit": {"oid": "a8d3c167b32cfbe26164c8f6e1eb7eca807a5a3d"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTE2NTU5OnYy", "diffSide": "RIGHT", "path": "collect_app/src/main/java/org/odk/collect/android/backgroundwork/CollectBackgroundWorkManager.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDozODo0NVrOFxoI2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMToyMToxMlrOFxpciQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU4MjE2OA==", "bodyText": "I feel anxious about the test you removed that verified those two methods. Those were android tests because starting evernote job / worker didn't work with Robolectric I don't know why. It required some time but at least it was verified and we were sure it won't cause any problem during migration. Now you moved the code here and it looks fine but generally when you refactor something it's good to add tests in this case we have refactoring and removing tests.", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387582168", "createdAt": "2020-03-04T10:38:45Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/backgroundwork/CollectBackgroundWorkManager.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package org.odk.collect.android.backgroundwork;\n+\n+import androidx.work.WorkInfo;\n+import androidx.work.WorkManager;\n+\n+import com.evernote.android.job.Job;\n+import com.evernote.android.job.JobManager;\n+import com.google.common.util.concurrent.ListenableFuture;\n+\n+import org.odk.collect.android.tasks.ServerPollingJob;\n+import org.odk.collect.android.upload.AutoSendWorker;\n+import org.odk.collect.utilities.BackgroundWorkManager;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+import timber.log.Timber;\n+\n+\n+/**\n+ * Abstraction that sits on top of {@link com.evernote.android.job.JobManager} and\n+ * {@link androidx.work.WorkManager}. Implementation of {@link BackgroundWorkManager} which objects\n+ * can use to interact with background work without having to care what underlying framework is\n+ * being used.\n+ */\n+public class CollectBackgroundWorkManager implements BackgroundWorkManager {\n+\n+    @Override\n+    public boolean isRunning(String tag) {\n+        switch (tag) {\n+            case AutoSendWorker.TAG: {\n+                return isWorkManagerWorkRunning(tag);\n+            }\n+\n+            case ServerPollingJob.TAG: {\n+                return isJobManagerWorkRunning(tag);\n+            }\n+\n+            default:\n+                throw new IllegalArgumentException(\"CollectBackgroundWorkManager doesn't know about \" + tag);\n+        }\n+    }\n+\n+    private boolean isJobManagerWorkRunning(String tag) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a26ccbe4af53eacc00f385798bd41fe082b7935e"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU5NjA1Mg==", "bodyText": "I can completely see where you're coming from here. The motivation behind changing the tests is that locally and on CI they were failing on and off as the waits wouldn't always work.\nI looked at faking out JobManager/WorkManager in the StorageMigrator tests but was unable to due to JobManager being a final class. Generally I'd wrap a depedency like this as I'm not trying to test that JobManager works but that our code that interacts with it does. Granted here we're wrapping a chunk of our own logic so it's not the \"thinnest\" wrapper.\nWe could of course test the wrapper (CollectBackgroundWorkManager) to give us more confidence. I'm comfortable with it being at the \"edge\" of our system enough that it doesn't need that but that's a pretty subjective statement. If you're feeling really uncomfortable with it I can have a stap at tests for the CollectBackgroundWorkManager. I'm not sure how feasible it would be for JobManager (although at worst we could wrap it in a veru light method proxy interface for tests) but WorkManager provides faking tools as far as I've seen.", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387596052", "createdAt": "2020-03-04T11:05:22Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/backgroundwork/CollectBackgroundWorkManager.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package org.odk.collect.android.backgroundwork;\n+\n+import androidx.work.WorkInfo;\n+import androidx.work.WorkManager;\n+\n+import com.evernote.android.job.Job;\n+import com.evernote.android.job.JobManager;\n+import com.google.common.util.concurrent.ListenableFuture;\n+\n+import org.odk.collect.android.tasks.ServerPollingJob;\n+import org.odk.collect.android.upload.AutoSendWorker;\n+import org.odk.collect.utilities.BackgroundWorkManager;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+import timber.log.Timber;\n+\n+\n+/**\n+ * Abstraction that sits on top of {@link com.evernote.android.job.JobManager} and\n+ * {@link androidx.work.WorkManager}. Implementation of {@link BackgroundWorkManager} which objects\n+ * can use to interact with background work without having to care what underlying framework is\n+ * being used.\n+ */\n+public class CollectBackgroundWorkManager implements BackgroundWorkManager {\n+\n+    @Override\n+    public boolean isRunning(String tag) {\n+        switch (tag) {\n+            case AutoSendWorker.TAG: {\n+                return isWorkManagerWorkRunning(tag);\n+            }\n+\n+            case ServerPollingJob.TAG: {\n+                return isJobManagerWorkRunning(tag);\n+            }\n+\n+            default:\n+                throw new IllegalArgumentException(\"CollectBackgroundWorkManager doesn't know about \" + tag);\n+        }\n+    }\n+\n+    private boolean isJobManagerWorkRunning(String tag) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU4MjE2OA=="}, "originalCommit": {"oid": "a26ccbe4af53eacc00f385798bd41fe082b7935e"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYwMDIxOA==", "bodyText": "Ok so let's merge it as is not to block other prs but if you have time you can add test if it's difficult please just let the QA team know about it so that they can verify this case manually one more time.", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387600218", "createdAt": "2020-03-04T11:13:52Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/backgroundwork/CollectBackgroundWorkManager.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package org.odk.collect.android.backgroundwork;\n+\n+import androidx.work.WorkInfo;\n+import androidx.work.WorkManager;\n+\n+import com.evernote.android.job.Job;\n+import com.evernote.android.job.JobManager;\n+import com.google.common.util.concurrent.ListenableFuture;\n+\n+import org.odk.collect.android.tasks.ServerPollingJob;\n+import org.odk.collect.android.upload.AutoSendWorker;\n+import org.odk.collect.utilities.BackgroundWorkManager;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+import timber.log.Timber;\n+\n+\n+/**\n+ * Abstraction that sits on top of {@link com.evernote.android.job.JobManager} and\n+ * {@link androidx.work.WorkManager}. Implementation of {@link BackgroundWorkManager} which objects\n+ * can use to interact with background work without having to care what underlying framework is\n+ * being used.\n+ */\n+public class CollectBackgroundWorkManager implements BackgroundWorkManager {\n+\n+    @Override\n+    public boolean isRunning(String tag) {\n+        switch (tag) {\n+            case AutoSendWorker.TAG: {\n+                return isWorkManagerWorkRunning(tag);\n+            }\n+\n+            case ServerPollingJob.TAG: {\n+                return isJobManagerWorkRunning(tag);\n+            }\n+\n+            default:\n+                throw new IllegalArgumentException(\"CollectBackgroundWorkManager doesn't know about \" + tag);\n+        }\n+    }\n+\n+    private boolean isJobManagerWorkRunning(String tag) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU4MjE2OA=="}, "originalCommit": {"oid": "a26ccbe4af53eacc00f385798bd41fe082b7935e"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYwMzU5Mw==", "bodyText": "Ok that sounds good. I'll have a look at that. Go ahead and merge when you're ready!", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387603593", "createdAt": "2020-03-04T11:21:12Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/backgroundwork/CollectBackgroundWorkManager.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package org.odk.collect.android.backgroundwork;\n+\n+import androidx.work.WorkInfo;\n+import androidx.work.WorkManager;\n+\n+import com.evernote.android.job.Job;\n+import com.evernote.android.job.JobManager;\n+import com.google.common.util.concurrent.ListenableFuture;\n+\n+import org.odk.collect.android.tasks.ServerPollingJob;\n+import org.odk.collect.android.upload.AutoSendWorker;\n+import org.odk.collect.utilities.BackgroundWorkManager;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+import timber.log.Timber;\n+\n+\n+/**\n+ * Abstraction that sits on top of {@link com.evernote.android.job.JobManager} and\n+ * {@link androidx.work.WorkManager}. Implementation of {@link BackgroundWorkManager} which objects\n+ * can use to interact with background work without having to care what underlying framework is\n+ * being used.\n+ */\n+public class CollectBackgroundWorkManager implements BackgroundWorkManager {\n+\n+    @Override\n+    public boolean isRunning(String tag) {\n+        switch (tag) {\n+            case AutoSendWorker.TAG: {\n+                return isWorkManagerWorkRunning(tag);\n+            }\n+\n+            case ServerPollingJob.TAG: {\n+                return isJobManagerWorkRunning(tag);\n+            }\n+\n+            default:\n+                throw new IllegalArgumentException(\"CollectBackgroundWorkManager doesn't know about \" + tag);\n+        }\n+    }\n+\n+    private boolean isJobManagerWorkRunning(String tag) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU4MjE2OA=="}, "originalCommit": {"oid": "a26ccbe4af53eacc00f385798bd41fe082b7935e"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTI3ODQ1OnYy", "diffSide": "RIGHT", "path": "collect_app/src/main/java/org/odk/collect/android/backgroundwork/CollectBackgroundWorkManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMToxNDowNVrOFxpPyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMToxNDowNVrOFxpPyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYwMDMzMQ==", "bodyText": "extra empty line", "url": "https://github.com/getodk/collect/pull/3668#discussion_r387600331", "createdAt": "2020-03-04T11:14:05Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/backgroundwork/CollectBackgroundWorkManager.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package org.odk.collect.android.backgroundwork;\n+\n+import androidx.work.WorkInfo;\n+import androidx.work.WorkManager;\n+\n+import com.evernote.android.job.Job;\n+import com.evernote.android.job.JobManager;\n+import com.google.common.util.concurrent.ListenableFuture;\n+\n+import org.odk.collect.android.tasks.ServerPollingJob;\n+import org.odk.collect.android.upload.AutoSendWorker;\n+import org.odk.collect.utilities.BackgroundWorkManager;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+import timber.log.Timber;\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a26ccbe4af53eacc00f385798bd41fe082b7935e"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3504, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}