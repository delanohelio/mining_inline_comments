{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzNjQxNDY0", "number": 3956, "title": "Add form sync button to Fill Blank Forms", "bodyText": "Closes #3934\nThe match exactly feature can be enabled/disabled in settings by going to General settings > Experimental. This new Experimental section can be made beta/dev only if we end up releasing before we get to implementing the settings screen for Match Exactly (#3940).\nThis also:\n\nAdds new FormRepository and MediaFileRepository interfaces that can wrap the code we have in the FormsDao and content providers. Using these makes it simpler to interact with Forms and Media Files in the database/file system. We've also talked about how it would be nice to clean up the relationship between FormsDao and the content providers etc and using these interfaces protects them so that they can be refactored without change in too many places.\nIntroduces a FormAPI interface that essentially represents the Open Rosa form API. This just makes it simpler to write and test code that has to hit the server. The implementation of this also lets us share code that was previously being duplicated. It might be worth pulling parser objects out of this in future.\n\nThere's a couple of inline comments about this but I'd thought about completely replacing the FormListDownloader with the ServerFormsDetailsFetcher (a use case I pulled out of it for the new ServerFormListSynchronizer). There isn't a lot of testing for the cases where FormListDownloader is used however, so I thought it was best to avoid diving into that work now.\nIn a similar vein,  there's an opportunity to clean up/replace the FormDownloader here but I'd like to on that and save it for later Match Exactly work to keep the size of the PRs down.\nAnother thing to note is that right now any errors that crop up during \"syncing\" are swallowed. There is a later issue to add error handling.\nWhat has been done to verify that this works as intended?\nPlayed around with the new feature and double-checked that the standard \"Get Blank Forms\" flow still works. New feature also driven out with tests.\nWhy is this the best possible solution? Were any other approaches considered?\nMajor decisions discussed above and inline.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nThere are potentially risks to fetching forms in \"Get Blank Forms\" and automatic update but it probably makes sense to merge this and QA when the feature is complete (i.e. the proper settings page is in and automatic updates happen)\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-07-02T17:03:02Z", "url": "https://github.com/getodk/collect/pull/3956", "merged": true, "mergeCommit": {"oid": "b85578264b2649b4b0cd484df6867d80f3e1aa3f"}, "closed": true, "closedAt": "2020-07-09T00:07:54Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 48, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxCCiOgBqjM1MDgwNDQ0MzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczDlw5gFqTQ0NTIwNzIwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca4893b97ff4423994fa9d4ffe1633a1e8a96a4a", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/ca4893b97ff4423994fa9d4ffe1633a1e8a96a4a", "committedDate": "2020-07-02T17:01:43Z", "message": "Use ViewModel and Scheduler for form syncing"}, "afterCommit": {"oid": "f500635ba7dd6359b71264d3d17171386be1969f", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/f500635ba7dd6359b71264d3d17171386be1969f", "committedDate": "2020-07-02T17:10:37Z", "message": "Use ViewModel and Scheduler for form syncing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxODgzNDI1", "url": "https://github.com/getodk/collect/pull/3956#pullrequestreview-441883425", "createdAt": "2020-07-02T17:13:06Z", "commit": {"oid": "8768321dbfac4961f4a51c914865c56841f6f961"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNzoxMzowNlrOGsWgtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNzoxMzowNlrOGsWgtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE1OTM0OQ==", "bodyText": "It felt like a good idea to bring this back as the ServerPollingJob and DownloadFormListTask were both using it and don't have a lot of tests around them. This would make it riskier to iterate on and improve the ServerFormsDetailsFetcher.", "url": "https://github.com/getodk/collect/pull/3956#discussion_r449159349", "createdAt": "2020-07-02T17:13:06Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/injection/config/AppDependencyModule.java", "diffHunk": "@@ -135,11 +135,11 @@ WebCredentialsUtils provideWebCredentials() {\n     }\n \n     @Provides\n-    ServerFormsDetailsFetcher provideDownloadFormListDownloader(\n+    FormListDownloader formListDownloader(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8768321dbfac4961f4a51c914865c56841f6f961"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMTg4Nzkz", "url": "https://github.com/getodk/collect/pull/3956#pullrequestreview-442188793", "createdAt": "2020-07-03T07:02:02Z", "commit": {"oid": "7509c58681820585ebeb00737bfbb9f23250d2c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwNzowMjowMlrOGsl4Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwNzowMjowMlrOGsl4Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQxMTA3OA==", "bodyText": "I think eventually this should also encapsulate DiskSyncTask, hold the list of forms that the adapter needs (probably as LiveData) and be responsible for sorting.", "url": "https://github.com/getodk/collect/pull/3956#discussion_r449411078", "createdAt": "2020-07-03T07:02:02Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/BlankFormsListViewModel.java", "diffHunk": "@@ -0,0 +1,78 @@\n+package org.odk.collect.android.formmanagement;\n+\n+import androidx.annotation.NonNull;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+import androidx.lifecycle.ViewModel;\n+import androidx.lifecycle.ViewModelProvider;\n+\n+import org.odk.collect.android.forms.FormRepository;\n+import org.odk.collect.android.forms.MediaFileRepository;\n+import org.odk.collect.android.openrosa.api.FormAPI;\n+import org.odk.collect.android.openrosa.api.FormAPIError;\n+import org.odk.collect.android.utilities.MultiFormDownloader;\n+import org.odk.collect.async.Scheduler;\n+\n+import javax.inject.Inject;\n+\n+public class BlankFormsListViewModel extends ViewModel {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7509c58681820585ebeb00737bfbb9f23250d2c5"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMTkwMzk3", "url": "https://github.com/getodk/collect/pull/3956#pullrequestreview-442190397", "createdAt": "2020-07-03T07:05:16Z", "commit": {"oid": "7509c58681820585ebeb00737bfbb9f23250d2c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwNzowNToxNlrOGsl9Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwNzowNToxNlrOGsl9Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQxMjM1NQ==", "bodyText": "I had completely forgotten we could do this. I'm not usually a huge fan of @Injects scattered around the place randomly building the dependency graph for the app - as much as it's terse give me a 500 line module definition any day. However, in the case of ViewModel where we have to deal with Factory classes like this I think just being able to @Inject the constructor and then injecting it in the Activity cuts down on a lot of explicit dependencies at the Activity level that only get used for ViewModel construction.\nProbably a nice trick to use elsewhere.", "url": "https://github.com/getodk/collect/pull/3956#discussion_r449412355", "createdAt": "2020-07-03T07:05:16Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/BlankFormsListViewModel.java", "diffHunk": "@@ -0,0 +1,78 @@\n+package org.odk.collect.android.formmanagement;\n+\n+import androidx.annotation.NonNull;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+import androidx.lifecycle.ViewModel;\n+import androidx.lifecycle.ViewModelProvider;\n+\n+import org.odk.collect.android.forms.FormRepository;\n+import org.odk.collect.android.forms.MediaFileRepository;\n+import org.odk.collect.android.openrosa.api.FormAPI;\n+import org.odk.collect.android.openrosa.api.FormAPIError;\n+import org.odk.collect.android.utilities.MultiFormDownloader;\n+import org.odk.collect.async.Scheduler;\n+\n+import javax.inject.Inject;\n+\n+public class BlankFormsListViewModel extends ViewModel {\n+\n+    private final Scheduler scheduler;\n+    private final FormRepository formRepository;\n+    private final MediaFileRepository mediaFileRepository;\n+    private final FormAPI formAPI;\n+    private final MultiFormDownloader multiFormDownloader;\n+\n+    private final MutableLiveData<Boolean> syncing = new MutableLiveData<>(false);\n+\n+    public BlankFormsListViewModel(Scheduler scheduler, FormRepository formRepository, MediaFileRepository mediaFileRepository, FormAPI formAPI, MultiFormDownloader multiFormDownloader) {\n+        this.scheduler = scheduler;\n+        this.formRepository = formRepository;\n+        this.mediaFileRepository = mediaFileRepository;\n+        this.formAPI = formAPI;\n+        this.multiFormDownloader = multiFormDownloader;\n+    }\n+\n+    public LiveData<Boolean> isSyncing() {\n+        return syncing;\n+    }\n+\n+    public void syncWithServer() {\n+        syncing.setValue(true);\n+\n+        scheduler.scheduleInBackground(() -> {\n+            try {\n+                ServerFormListSynchronizer synchronizer = new ServerFormListSynchronizer(formRepository, mediaFileRepository, formAPI, multiFormDownloader);\n+                synchronizer.synchronize();\n+            } catch (FormAPIError ignored) {\n+                // Ignored\n+            }\n+\n+            return null;\n+        }, ignored -> syncing.setValue(false));\n+    }\n+\n+    public static class Factory implements ViewModelProvider.Factory {\n+\n+        private final Scheduler scheduler;\n+        private final FormRepository formRepository;\n+        private final MediaFileRepository mediaFileRepository;\n+        private final FormAPI formAPI;\n+        private final MultiFormDownloader multiFormDownloader;\n+\n+        @Inject", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7509c58681820585ebeb00737bfbb9f23250d2c5"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNDc3Njcy", "url": "https://github.com/getodk/collect/pull/3956#pullrequestreview-443477672", "createdAt": "2020-07-07T00:00:00Z", "commit": {"oid": "c9b51a1b54068a68c55d4a5fe1fd82daf18c4248"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwMDowMDowMFrOGtqueQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNTowODo0M1rOGtvRoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUzOTEyOQ==", "bodyText": "typo", "url": "https://github.com/getodk/collect/pull/3956#discussion_r450539129", "createdAt": "2020-07-07T00:00:00Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/dao/FormsDao.java", "diffHunk": "@@ -32,7 +32,7 @@\n import java.util.List;\n \n /**\n- * This class is used to encapsulate all access to the {@link org.odk.collect.android.database.helpers.FormsDatabaseHelper#DATABASE_NAME}\n+ * This class is used to encap`sulate all access to the {@link org.odk.collect.android.database.helpers.FormsDatabaseHelper#DATABASE_NAME}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9b51a1b54068a68c55d4a5fe1fd82daf18c4248"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0ODYyMg==", "bodyText": "Should use the androidx annotations\nEdit: hmm, now I see we haven't been very consistent. I think in general we should use the androidx ones because of the android studio nullability analysis.", "url": "https://github.com/getodk/collect/pull/3956#discussion_r450548622", "createdAt": "2020-07-07T00:36:01Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/openrosa/api/OpenRosaFormAPI.java", "diffHunk": "@@ -1,12 +1,11 @@\n package org.odk.collect.android.openrosa.api;\n \n import org.javarosa.xform.parse.XFormParser;\n+import org.jetbrains.annotations.NotNull;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78ea55d10e3e61c7c651b138a8c88faa2ab5572c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU1NDMwMQ==", "bodyText": "I think this needs to be more analogous to InstancesRepository. For that interface, the concrete implementation is called DatabaseInstancesRepository and it lives in the instances package which I like slightly better. I don't mind this if you strongly prefer it, though, but I think the two should be the same. I think DatabaseXRepository captures what's really meaningful and contrasts from the test implementation -- that it's fetching X from a database.", "url": "https://github.com/getodk/collect/pull/3956#discussion_r450554301", "createdAt": "2020-07-07T00:59:21Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/dao/FormsDaoFormRepository.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package org.odk.collect.android.dao;\n+\n+import android.database.Cursor;\n+\n+import org.odk.collect.android.forms.Form;\n+import org.odk.collect.android.forms.FormRepository;\n+\n+import java.util.List;\n+\n+public class FormsDaoFormRepository implements FormRepository {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7509c58681820585ebeb00737bfbb9f23250d2c5"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU1NTQ2Mw==", "bodyText": "API should be Api: https://google.github.io/styleguide/javaguide.html#s5.3-camel-case\nWould you consider FormListApi? That links it more clearly to the corresponding OpenRosa standard https://docs.getodk.org/openrosa-form-list/. It makes sense to me that fetching the manifest is a subset of fetching the form list.", "url": "https://github.com/getodk/collect/pull/3956#discussion_r450555463", "createdAt": "2020-07-07T01:03:52Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/openrosa/api/FormAPI.java", "diffHunk": "@@ -0,0 +1,10 @@\n+package org.odk.collect.android.openrosa.api;\n+\n+import java.util.List;\n+\n+public interface FormAPI {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7509c58681820585ebeb00737bfbb9f23250d2c5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU1NTUwOA==", "bodyText": "FormApiError", "url": "https://github.com/getodk/collect/pull/3956#discussion_r450555508", "createdAt": "2020-07-07T01:04:03Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/openrosa/api/FormAPIError.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package org.odk.collect.android.openrosa.api;\n+\n+public class FormAPIError extends Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7509c58681820585ebeb00737bfbb9f23250d2c5"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwNzEzMQ==", "bodyText": "At https://forum.getodk.org/t/have-collect-exactly-match-the-forms-on-central/23101, we had described doing a soft delete so that saved records could still be edited. Unfortunately that does need adding to the db schema, I think. Maybe something to discuss.", "url": "https://github.com/getodk/collect/pull/3956#discussion_r450607131", "createdAt": "2020-07-07T04:41:33Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/dao/FormsDaoFormRepository.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package org.odk.collect.android.dao;\n+\n+import android.database.Cursor;\n+\n+import org.odk.collect.android.forms.Form;\n+import org.odk.collect.android.forms.FormRepository;\n+\n+import java.util.List;\n+\n+public class FormsDaoFormRepository implements FormRepository {\n+\n+    @Override\n+    public boolean contains(String jrFormID) {\n+        try (Cursor cursor = new FormsDao().getFormsCursorForFormId(jrFormID)) {\n+            return cursor != null && cursor.getCount() > 0;\n+        }\n+    }\n+\n+    @Override\n+    public List<Form> getAll() {\n+        try (Cursor cursor = new FormsDao().getFormsCursor()) {\n+            return new FormsDao().getFormsFromCursor(cursor);\n+        }\n+    }\n+\n+    @Override\n+    public void save(Form form) {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    public void delete(Long id) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7509c58681820585ebeb00737bfbb9f23250d2c5"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwODAwNA==", "bodyText": "Should be OpenRosaXmlFetcher", "url": "https://github.com/getodk/collect/pull/3956#discussion_r450608004", "createdAt": "2020-07-07T04:45:34Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/openrosa/OpenRosaXMLFetcher.java", "diffHunk": "@@ -21,15 +21,15 @@\n \n import timber.log.Timber;\n \n-public class OpenRosaAPIClient {\n+public class OpenRosaXMLFetcher {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7509c58681820585ebeb00737bfbb9f23250d2c5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwODU1Ng==", "bodyText": "why not in formmanagement?", "url": "https://github.com/getodk/collect/pull/3956#discussion_r450608556", "createdAt": "2020-07-07T04:48:16Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/utilities/MultiFormDownloader.java", "diffHunk": "@@ -56,26 +58,28 @@\n import static org.odk.collect.android.utilities.FileUtils.STUB_XML;\n import static org.odk.collect.android.utilities.FileUtils.write;\n \n-public class FormDownloader {\n+public class MultiFormDownloader implements FormDownloader {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7509c58681820585ebeb00737bfbb9f23250d2c5"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwOTE4Nw==", "bodyText": "Need test and implementation to hide refresh button when setting is off.", "url": "https://github.com/getodk/collect/pull/3956#discussion_r450609187", "createdAt": "2020-07-07T04:50:53Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/feature/settings/MatchExactlyTest.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package org.odk.collect.android.feature.settings;\n+\n+import android.Manifest;\n+import android.webkit.MimeTypeMap;\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+import androidx.test.rule.GrantPermissionRule;\n+\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.RuleChain;\n+import org.junit.runner.RunWith;\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.injection.config.AppDependencyModule;\n+import org.odk.collect.android.openrosa.OpenRosaHttpInterface;\n+import org.odk.collect.android.support.CollectTestRule;\n+import org.odk.collect.android.support.CopyFormRule;\n+import org.odk.collect.android.support.CountingScheduler;\n+import org.odk.collect.android.support.CountingSchedulerIdlingResource;\n+import org.odk.collect.android.support.IdlingResourceRule;\n+import org.odk.collect.android.support.ResetStateRule;\n+import org.odk.collect.android.support.StubOpenRosaServer;\n+import org.odk.collect.async.CoroutineScheduler;\n+import org.odk.collect.async.Scheduler;\n+import org.odk.collect.utilities.UserAgentProvider;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class MatchExactlyTest {\n+\n+    public final StubOpenRosaServer server = new StubOpenRosaServer();\n+    private final CountingScheduler countingScheduler = new CountingScheduler(new CoroutineScheduler());\n+\n+    public CollectTestRule rule = new CollectTestRule();\n+\n+    @Rule\n+    public RuleChain copyFormChain = RuleChain\n+            .outerRule(GrantPermissionRule.grant(\n+                    Manifest.permission.READ_EXTERNAL_STORAGE,\n+                    Manifest.permission.WRITE_EXTERNAL_STORAGE,\n+                    Manifest.permission.READ_PHONE_STATE\n+            ))\n+            .around(new ResetStateRule(new AppDependencyModule() {\n+                @Override\n+                public OpenRosaHttpInterface provideHttpInterface(MimeTypeMap mimeTypeMap, UserAgentProvider userAgentProvider) {\n+                    return server;\n+                }\n+\n+                @Override\n+                public Scheduler providesScheduler() {\n+                    return countingScheduler;\n+                }\n+            }))\n+            .around(new IdlingResourceRule(new CountingSchedulerIdlingResource(countingScheduler)))\n+            .around(new CopyFormRule(\"one-question.xml\"))\n+            .around(new CopyFormRule(\"one-question-repeat.xml\"))\n+            .around(rule);\n+\n+    @Test\n+    public void whenMatchExactlyEnabled_clickingFillBlankForm_andClickingRefresh_getsLatestFormsFromServer() {\n+        server.addForm(\"One Question Updated\", \"one_question\", \"one-question-updated.xml\");\n+        server.addForm(\"Two Question\", \"two_question\", \"two-question.xml\");\n+\n+        rule.mainMenu()\n+                .setServer(server.getURL())\n+                .enableMatchExactly()\n+                .clickFillBlankForm()\n+                .assertText(\"One Question\")\n+                .assertText(\"One Question Repeat\")\n+                .clickRefresh()\n+                .assertText(\"Two Question\") // Check new form downloaded\n+                .assertText(\"One Question Updated\") // Check updated form updated\n+                .assertTextDoesNotExist(\"One Question Repeat\"); // Check deleted form deleted\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7509c58681820585ebeb00737bfbb9f23250d2c5"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwOTQ0NA==", "bodyText": "Consider OpenRosaFormListApi", "url": "https://github.com/getodk/collect/pull/3956#discussion_r450609444", "createdAt": "2020-07-07T04:51:48Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/openrosa/api/OpenRosaFormAPI.java", "diffHunk": "@@ -0,0 +1,325 @@\n+package org.odk.collect.android.openrosa.api;\n+\n+import org.javarosa.xform.parse.XFormParser;\n+import org.jetbrains.annotations.NotNull;\n+import org.kxml2.kdom.Element;\n+import org.odk.collect.android.openrosa.OpenRosaXMLFetcher;\n+import org.odk.collect.android.openrosa.api.FormAPIError.Type;\n+import org.odk.collect.android.utilities.DocumentFetchResult;\n+\n+import java.net.HttpURLConnection;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.odk.collect.android.openrosa.api.FormAPIError.Type.AUTH_REQUIRED;\n+import static org.odk.collect.android.openrosa.api.FormAPIError.Type.FETCH_ERROR;\n+import static org.odk.collect.android.openrosa.api.FormAPIError.Type.PARSE_ERROR;\n+\n+public class OpenRosaFormAPI implements FormAPI {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7509c58681820585ebeb00737bfbb9f23250d2c5"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwOTcxNA==", "bodyText": "Change to w so we don't forget later? I don't think any of these would point to a software error we can fix.", "url": "https://github.com/getodk/collect/pull/3956#discussion_r450609714", "createdAt": "2020-07-07T04:52:59Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/ServerFormsDetailsFetcher.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2018 Nafundi\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.odk.collect.android.formmanagement;\n+\n+import org.odk.collect.android.forms.FormRepository;\n+import org.odk.collect.android.forms.MediaFileRepository;\n+import org.odk.collect.android.logic.FormDetails;\n+import org.odk.collect.android.openrosa.api.FormAPI;\n+import org.odk.collect.android.openrosa.api.FormAPIError;\n+import org.odk.collect.android.openrosa.api.FormListItem;\n+import org.odk.collect.android.openrosa.api.ManifestFile;\n+import org.odk.collect.android.openrosa.api.MediaFile;\n+import org.odk.collect.android.utilities.FileUtils;\n+import org.odk.collect.android.utilities.MultiFormDownloader;\n+\n+import java.io.File;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import timber.log.Timber;\n+\n+public class ServerFormsDetailsFetcher {\n+\n+    private final FormRepository formRepository;\n+    private final MediaFileRepository mediaFileRepository;\n+    private final FormAPI formAPI;\n+\n+    public ServerFormsDetailsFetcher(FormRepository formRepository,\n+                                     MediaFileRepository mediaFileRepository,\n+                                     FormAPI formAPI) {\n+        this.formRepository = formRepository;\n+        this.mediaFileRepository = mediaFileRepository;\n+        this.formAPI = formAPI;\n+    }\n+\n+    public List<FormDetails> fetchFormDetails() throws FormAPIError {\n+        return fetchFormDetails(true);\n+    }\n+\n+    public List<FormDetails> fetchFormDetails(boolean checkMediaFiles) throws FormAPIError {\n+        List<FormListItem> formListItems = formAPI.fetchFormList();\n+        List<FormDetails> formDetailsList = new ArrayList<>();\n+\n+        for (FormListItem listItem : formListItems) {\n+            boolean isNewerFormVersionAvailable = false;\n+            boolean areNewerMediaFilesAvailable = false;\n+            ManifestFile manifestFile = null;\n+\n+            if (isThisFormAlreadyDownloaded(listItem.getFormID())) {\n+                isNewerFormVersionAvailable = isNewerFormVersionAvailable(MultiFormDownloader.getMd5Hash(listItem.getHashWithPrefix()));\n+                if ((!isNewerFormVersionAvailable || checkMediaFiles) && listItem.getManifestURL() != null) {\n+                    manifestFile = getManifestFile(formAPI, listItem.getManifestURL());\n+                    if (manifestFile != null) {\n+                        List<MediaFile> newMediaFiles = manifestFile.getMediaFiles();\n+                        if (newMediaFiles != null && !newMediaFiles.isEmpty()) {\n+                            areNewerMediaFilesAvailable = areNewerMediaFilesAvailable(listItem.getFormID(), listItem.getVersion(), newMediaFiles);\n+                        }\n+                    }\n+                }\n+            }\n+\n+            FormDetails formDetails = FormDetails.toFormDetails(\n+                    listItem,\n+                    manifestFile != null ? manifestFile.getHash() : null,\n+                    isNewerFormVersionAvailable,\n+                    areNewerMediaFilesAvailable\n+            );\n+\n+            formDetailsList.add(formDetails);\n+        }\n+        return formDetailsList;\n+    }\n+\n+    private boolean isThisFormAlreadyDownloaded(String formId) {\n+        return formRepository.contains(formId);\n+    }\n+\n+    private ManifestFile getManifestFile(FormAPI formAPI, String manifestUrl) {\n+        if (manifestUrl == null) {\n+            return null;\n+        }\n+\n+        try {\n+            return formAPI.fetchManifest(manifestUrl);\n+        } catch (FormAPIError formAPIError) {\n+            Timber.e(formAPIError);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7509c58681820585ebeb00737bfbb9f23250d2c5"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYxMDIwNA==", "bodyText": "This is n^2, right? Both lists are going to be relatively small in this case so I think it's ok but we should be careful if doing similar things with e.g. instances at some point. I feel like streams can hide complexity in a kind of scary way sometimes.", "url": "https://github.com/getodk/collect/pull/3956#discussion_r450610204", "createdAt": "2020-07-07T04:55:09Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/ServerFormListSynchronizer.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package org.odk.collect.android.formmanagement;\n+\n+import org.odk.collect.android.forms.Form;\n+import org.odk.collect.android.forms.FormRepository;\n+import org.odk.collect.android.forms.MediaFileRepository;\n+import org.odk.collect.android.logic.FormDetails;\n+import org.odk.collect.android.openrosa.api.FormAPI;\n+import org.odk.collect.android.openrosa.api.FormAPIError;\n+\n+import java.util.List;\n+\n+public class ServerFormListSynchronizer {\n+\n+    private final FormRepository formRepository;\n+    private final MediaFileRepository mediaFileRepository;\n+    private final FormAPI formAPI;\n+    private final FormDownloader formDownloader;\n+\n+    public ServerFormListSynchronizer(FormRepository formRepository, MediaFileRepository mediaFileRepository, FormAPI formAPI, FormDownloader formDownloader) {\n+        this.formRepository = formRepository;\n+        this.mediaFileRepository = mediaFileRepository;\n+        this.formAPI = formAPI;\n+        this.formDownloader = formDownloader;\n+    }\n+\n+    public void synchronize() throws FormAPIError {\n+        ServerFormsDetailsFetcher listDownloader = new ServerFormsDetailsFetcher(formRepository, mediaFileRepository, formAPI);\n+        List<FormDetails> formList = listDownloader.fetchFormDetails();\n+\n+        List<Form> formsOnDevice = formRepository.getAll();\n+\n+        formsOnDevice.stream().forEach(form -> {\n+            if (formList.stream().noneMatch(f -> form.getJrFormId().equals(f.getFormId()))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7509c58681820585ebeb00737bfbb9f23250d2c5"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYxMDkwMQ==", "bodyText": "Consider adding a repository method to get a form by md5hash? Seems clearer and more efficient.", "url": "https://github.com/getodk/collect/pull/3956#discussion_r450610901", "createdAt": "2020-07-07T04:58:07Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/ServerFormsDetailsFetcher.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2018 Nafundi\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.odk.collect.android.formmanagement;\n+\n+import org.odk.collect.android.forms.FormRepository;\n+import org.odk.collect.android.forms.MediaFileRepository;\n+import org.odk.collect.android.logic.FormDetails;\n+import org.odk.collect.android.openrosa.api.FormAPI;\n+import org.odk.collect.android.openrosa.api.FormAPIError;\n+import org.odk.collect.android.openrosa.api.FormListItem;\n+import org.odk.collect.android.openrosa.api.ManifestFile;\n+import org.odk.collect.android.openrosa.api.MediaFile;\n+import org.odk.collect.android.utilities.FileUtils;\n+import org.odk.collect.android.utilities.MultiFormDownloader;\n+\n+import java.io.File;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import timber.log.Timber;\n+\n+public class ServerFormsDetailsFetcher {\n+\n+    private final FormRepository formRepository;\n+    private final MediaFileRepository mediaFileRepository;\n+    private final FormAPI formAPI;\n+\n+    public ServerFormsDetailsFetcher(FormRepository formRepository,\n+                                     MediaFileRepository mediaFileRepository,\n+                                     FormAPI formAPI) {\n+        this.formRepository = formRepository;\n+        this.mediaFileRepository = mediaFileRepository;\n+        this.formAPI = formAPI;\n+    }\n+\n+    public List<FormDetails> fetchFormDetails() throws FormAPIError {\n+        return fetchFormDetails(true);\n+    }\n+\n+    public List<FormDetails> fetchFormDetails(boolean checkMediaFiles) throws FormAPIError {\n+        List<FormListItem> formListItems = formAPI.fetchFormList();\n+        List<FormDetails> formDetailsList = new ArrayList<>();\n+\n+        for (FormListItem listItem : formListItems) {\n+            boolean isNewerFormVersionAvailable = false;\n+            boolean areNewerMediaFilesAvailable = false;\n+            ManifestFile manifestFile = null;\n+\n+            if (isThisFormAlreadyDownloaded(listItem.getFormID())) {\n+                isNewerFormVersionAvailable = isNewerFormVersionAvailable(MultiFormDownloader.getMd5Hash(listItem.getHashWithPrefix()));\n+                if ((!isNewerFormVersionAvailable || checkMediaFiles) && listItem.getManifestURL() != null) {\n+                    manifestFile = getManifestFile(formAPI, listItem.getManifestURL());\n+                    if (manifestFile != null) {\n+                        List<MediaFile> newMediaFiles = manifestFile.getMediaFiles();\n+                        if (newMediaFiles != null && !newMediaFiles.isEmpty()) {\n+                            areNewerMediaFilesAvailable = areNewerMediaFilesAvailable(listItem.getFormID(), listItem.getVersion(), newMediaFiles);\n+                        }\n+                    }\n+                }\n+            }\n+\n+            FormDetails formDetails = FormDetails.toFormDetails(\n+                    listItem,\n+                    manifestFile != null ? manifestFile.getHash() : null,\n+                    isNewerFormVersionAvailable,\n+                    areNewerMediaFilesAvailable\n+            );\n+\n+            formDetailsList.add(formDetails);\n+        }\n+        return formDetailsList;\n+    }\n+\n+    private boolean isThisFormAlreadyDownloaded(String formId) {\n+        return formRepository.contains(formId);\n+    }\n+\n+    private ManifestFile getManifestFile(FormAPI formAPI, String manifestUrl) {\n+        if (manifestUrl == null) {\n+            return null;\n+        }\n+\n+        try {\n+            return formAPI.fetchManifest(manifestUrl);\n+        } catch (FormAPIError formAPIError) {\n+            Timber.e(formAPIError);\n+            return null;\n+        }\n+    }\n+\n+    private boolean isNewerFormVersionAvailable(String md5Hash) {\n+        if (md5Hash == null) {\n+            return false;\n+        }\n+\n+        return formRepository.getAll().stream().noneMatch(f -> f.getMD5Hash().equals(md5Hash));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7509c58681820585ebeb00737bfbb9f23250d2c5"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYxMjY0MQ==", "bodyText": "I'm not loving all this. Isn't FormDetails a wrapper for a FormListItem that provides status information? Maybe a FormDetails should have a FormListItem field? Maybe it should be FormListItemStatus?", "url": "https://github.com/getodk/collect/pull/3956#discussion_r450612641", "createdAt": "2020-07-07T05:04:50Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/logic/FormDetails.java", "diffHunk": "@@ -87,4 +90,48 @@ public boolean isNewerFormVersionAvailable() {\n     public boolean areNewerMediaFilesAvailable() {\n         return areNewerMediaFilesAvailable;\n     }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+        if (this == o) {\n+            return true;\n+        }\n+        if (o == null || getClass() != o.getClass()) {\n+            return false;\n+        }\n+        FormDetails that = (FormDetails) o;\n+        return isNewerFormVersionAvailable() == that.isNewerFormVersionAvailable() &&\n+                areNewerMediaFilesAvailable == that.areNewerMediaFilesAvailable &&\n+                Objects.equals(getErrorStr(), that.getErrorStr()) &&\n+                Objects.equals(getFormName(), that.getFormName()) &&\n+                Objects.equals(getDownloadUrl(), that.getDownloadUrl()) &&\n+                Objects.equals(getManifestUrl(), that.getManifestUrl()) &&\n+                Objects.equals(formID, that.formID) &&\n+                Objects.equals(getFormVersion(), that.getFormVersion()) &&\n+                Objects.equals(getHash(), that.getHash()) &&\n+                Objects.equals(getManifestFileHash(), that.getManifestFileHash());\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+        return Objects.hash(getErrorStr(), getFormName(), getDownloadUrl(), getManifestUrl(), formID, getFormVersion(), getHash(), getManifestFileHash(), isNewerFormVersionAvailable(), areNewerMediaFilesAvailable);\n+    }\n+\n+    public static FormDetails toFormDetails(FormListItem formListItem) {\n+        return toFormDetails(formListItem, null, false, false);\n+    }\n+\n+    public static FormDetails toFormDetails(FormListItem formListItem, String manifestFileHash, boolean isNewerFormVersionAvailable, boolean areNewerMediaFilesAvailable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7509c58681820585ebeb00737bfbb9f23250d2c5"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYxMzY2NA==", "bodyText": "Is all this really necessary? Wouldn't comparing the hash and the error string be sufficient? The download URL would also be needed if somehow you could have downloads from multiple servers going on at the same time but I don't think we have any intention of making that possible. It seems weird to compare these status objects, anyway. Where is this used? Or is it just hashing that ends up getting used?", "url": "https://github.com/getodk/collect/pull/3956#discussion_r450613664", "createdAt": "2020-07-07T05:08:43Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/logic/FormDetails.java", "diffHunk": "@@ -87,4 +90,48 @@ public boolean isNewerFormVersionAvailable() {\n     public boolean areNewerMediaFilesAvailable() {\n         return areNewerMediaFilesAvailable;\n     }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+        if (this == o) {\n+            return true;\n+        }\n+        if (o == null || getClass() != o.getClass()) {\n+            return false;\n+        }\n+        FormDetails that = (FormDetails) o;\n+        return isNewerFormVersionAvailable() == that.isNewerFormVersionAvailable() &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7509c58681820585ebeb00737bfbb9f23250d2c5"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "751d9e7dfaef0d8b0130aadb4cbc8c3920aba46e", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/751d9e7dfaef0d8b0130aadb4cbc8c3920aba46e", "committedDate": "2020-07-07T16:07:07Z", "message": "Hide Get Blank Form when match exactly enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d764003912fdce3efb7ac6437282664455e6179", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/5d764003912fdce3efb7ac6437282664455e6179", "committedDate": "2020-07-07T16:07:08Z", "message": "Disable form update options when match exactly enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77e6913707ab156054301bf37fb758fe622cfe98", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/77e6913707ab156054301bf37fb758fe622cfe98", "committedDate": "2020-07-07T16:07:08Z", "message": "Add experimental settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "588acc7068bcc845bf851166b49de50bee96c65c", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/588acc7068bcc845bf851166b49de50bee96c65c", "committedDate": "2020-07-07T16:10:17Z", "message": "Add failing test for match exactly refresh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8190912aa9fa5e2234ddb25e18ed54582010720", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/a8190912aa9fa5e2234ddb25e18ed54582010720", "committedDate": "2020-07-07T16:10:18Z", "message": "Add naive implementation to make test green"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba199d30ff88436f5736990bcca7f0ef307de74d", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/ba199d30ff88436f5736990bcca7f0ef307de74d", "committedDate": "2020-07-07T16:10:19Z", "message": "Replace match exactly implementation with smarter but nastier version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "784c1fabbdf842380e8fb1bd870da5a9ddb05cd8", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/784c1fabbdf842380e8fb1bd870da5a9ddb05cd8", "committedDate": "2020-07-07T16:10:19Z", "message": "Make FormDownloader stateless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17c9b0b9f81e8ab48d5005805729987afb4c09af", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/17c9b0b9f81e8ab48d5005805729987afb4c09af", "committedDate": "2020-07-07T16:10:19Z", "message": "Inject FormDownloader for match exactly logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b32884c72e6476dad90d8ede9d46a22d215a5786", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/b32884c72e6476dad90d8ede9d46a22d215a5786", "committedDate": "2020-07-07T16:10:19Z", "message": "Rename class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86da699fc1d4b1d6082838b6a7857db3fbc49a95", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/86da699fc1d4b1d6082838b6a7857db3fbc49a95", "committedDate": "2020-07-07T16:10:19Z", "message": "Factor out tested use case for syncing forms with server"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55039932cd9a8b71a84c9eb2152eb934be5c316a", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/55039932cd9a8b71a84c9eb2152eb934be5c316a", "committedDate": "2020-07-07T16:10:19Z", "message": "Use FormAPI abstraction from sync use case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3214209eed0a8e96a423494eb0339cfe95858d15", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/3214209eed0a8e96a423494eb0339cfe95858d15", "committedDate": "2020-07-07T16:10:19Z", "message": "Create OpenRosaFormAPI for fetching form lists"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6833ec7455767acaa2d799dff3a50899bf7d2b3f", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/6833ec7455767acaa2d799dff3a50899bf7d2b3f", "committedDate": "2020-07-07T16:10:20Z", "message": "Use FormAPI in FormListDownloader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11c81d84c7db7bf628e1e2c0f7ac6eabfc4ecc41", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/11c81d84c7db7bf628e1e2c0f7ac6eabfc4ecc41", "committedDate": "2020-07-07T16:10:20Z", "message": "Show progress bar when syncing forms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43eac679f04e9775ddd7f7de177d46fe2288486c", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/43eac679f04e9775ddd7f7de177d46fe2288486c", "committedDate": "2020-07-07T16:10:20Z", "message": "Download forms when media files change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8e087b7375a8a7b9dd085278c1ee9b4f945b80f", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/a8e087b7375a8a7b9dd085278c1ee9b4f945b80f", "committedDate": "2020-07-07T16:10:20Z", "message": "Remove unused methods from Form"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "765105f682610cb29a0ccc4d245150aec3d39293", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/765105f682610cb29a0ccc4d245150aec3d39293", "committedDate": "2020-07-07T16:10:20Z", "message": "Use repositories in FormListDownloader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b1e4e8b475f0fab78a2dff173646cd263eaa27f", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/0b1e4e8b475f0fab78a2dff173646cd263eaa27f", "committedDate": "2020-07-07T16:10:20Z", "message": "Move manifest API classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45516197a4adb48638a8137fd84c16d19fe499e0", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/45516197a4adb48638a8137fd84c16d19fe499e0", "committedDate": "2020-07-07T16:10:20Z", "message": "Create new formmanagement package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebc81654f8d08bd8fefafd9186340afc41a25541", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/ebc81654f8d08bd8fefafd9186340afc41a25541", "committedDate": "2020-07-07T16:10:21Z", "message": "Move FormListDownloader to management package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a6fd01b9028d66ba5707227299f9bacd6f353a6", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/5a6fd01b9028d66ba5707227299f9bacd6f353a6", "committedDate": "2020-07-07T16:10:21Z", "message": "Use FormListDownloader to implement sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3706d342e06ac5abf83866c0743dbfb2cbecd4e", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/e3706d342e06ac5abf83866c0743dbfb2cbecd4e", "committedDate": "2020-07-07T16:10:21Z", "message": "Rename FormListDownloader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfa89fcf050651d0c6edf18d7b24a2f520660c00", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/cfa89fcf050651d0c6edf18d7b24a2f520660c00", "committedDate": "2020-07-07T16:10:21Z", "message": "Fix incorrect tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a0e62bae7f9a79e50a430f4fa975bb9f66a1cab", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/5a0e62bae7f9a79e50a430f4fa975bb9f66a1cab", "committedDate": "2020-07-07T16:10:21Z", "message": "Throw errors from new ServerFormsDetailsFetcher method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f27a7d2265eeb75eae610c69b0526bf186d506fb", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/f27a7d2265eeb75eae610c69b0526bf186d506fb", "committedDate": "2020-07-07T16:10:21Z", "message": "Pull old FormListDownloader out of new component to make replacing simpler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1fe3feecbf3214224f889f9c31fcf3a8b37e58d", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/d1fe3feecbf3214224f889f9c31fcf3a8b37e58d", "committedDate": "2020-07-07T16:10:21Z", "message": "Simplify methods in ServerFormsDetailsFetcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8d17f970a372a7c7010503bb401a52ae22dd114", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/a8d17f970a372a7c7010503bb401a52ae22dd114", "committedDate": "2020-07-07T16:10:22Z", "message": "Use ViewModel and Scheduler for form syncing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df6d4e098d593bb5454ced209d905f3c6adf2e43", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/df6d4e098d593bb5454ced209d905f3c6adf2e43", "committedDate": "2020-07-07T16:10:22Z", "message": "Deprecate FormListDownloader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fda653646425e032474f7db8ec4f2db834067ad", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/5fda653646425e032474f7db8ec4f2db834067ad", "committedDate": "2020-07-07T16:10:22Z", "message": "Correct camel style and correct typos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fc19c9e12e293d55a4d2e32efb2df746432d00f", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/2fc19c9e12e293d55a4d2e32efb2df746432d00f", "committedDate": "2020-07-07T16:10:22Z", "message": "Remove Timber error logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "071e0ec02cdf8f2ab223e6a0e2231ff32c8bbc2b", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/071e0ec02cdf8f2ab223e6a0e2231ff32c8bbc2b", "committedDate": "2020-07-07T16:10:22Z", "message": "Remove unused equals/hashcode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a5a805490c0dcc0ed89b587010935d555876be0", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/7a5a805490c0dcc0ed89b587010935d555876be0", "committedDate": "2020-07-07T16:10:22Z", "message": "Make repositories consistent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb3283787368c4df9832d9217690dd3381a530fa", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/eb3283787368c4df9832d9217690dd3381a530fa", "committedDate": "2020-07-07T16:10:22Z", "message": "Hide match exactly refresh button when not enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52e55f3f967908b1e3899b6d2ff57d0718a940af", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/52e55f3f967908b1e3899b6d2ff57d0718a940af", "committedDate": "2020-07-07T16:10:23Z", "message": "Add method to fetch forms by hash"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f7ea1e93ea7870c3e5fffe5eaa5f48bb7c8647b", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/8f7ea1e93ea7870c3e5fffe5eaa5f48bb7c8647b", "committedDate": "2020-07-07T16:10:23Z", "message": "Rename FormApi"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19e081ffed9af4a6a5695fdb7e0d9cfa22dd4083", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/19e081ffed9af4a6a5695fdb7e0d9cfa22dd4083", "committedDate": "2020-07-07T16:10:23Z", "message": "Isolate converting between FormListItem and FormDetails to ServerFormDetailsFetcher"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6575069d1a3b5664e253e482bdd1932268473445", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/6575069d1a3b5664e253e482bdd1932268473445", "committedDate": "2020-07-07T12:16:44Z", "message": "Isolate converting between FormListItem and FormDetails to ServerFormDetailsFetcher"}, "afterCommit": {"oid": "19e081ffed9af4a6a5695fdb7e0d9cfa22dd4083", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/19e081ffed9af4a6a5695fdb7e0d9cfa22dd4083", "committedDate": "2020-07-07T16:10:23Z", "message": "Isolate converting between FormListItem and FormDetails to ServerFormDetailsFetcher"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MjU1NzI1", "url": "https://github.com/getodk/collect/pull/3956#pullrequestreview-444255725", "createdAt": "2020-07-07T21:15:51Z", "commit": {"oid": "19e081ffed9af4a6a5695fdb7e0d9cfa22dd4083"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMToxNTo1MVrOGuP4iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMTozMDo0OVrOGuQU5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE0NzkxMw==", "bodyText": "This should be whenMatchExactlyNotEnabled or whenMatchExactlyDisabled or whatever!", "url": "https://github.com/getodk/collect/pull/3956#discussion_r451147913", "createdAt": "2020-07-07T21:15:51Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/feature/settings/MatchExactlyTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package org.odk.collect.android.feature.settings;\n+\n+import android.Manifest;\n+import android.webkit.MimeTypeMap;\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+import androidx.test.rule.GrantPermissionRule;\n+\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.RuleChain;\n+import org.junit.runner.RunWith;\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.injection.config.AppDependencyModule;\n+import org.odk.collect.android.openrosa.OpenRosaHttpInterface;\n+import org.odk.collect.android.support.CollectTestRule;\n+import org.odk.collect.android.support.CopyFormRule;\n+import org.odk.collect.android.support.CountingScheduler;\n+import org.odk.collect.android.support.CountingSchedulerIdlingResource;\n+import org.odk.collect.android.support.IdlingResourceRule;\n+import org.odk.collect.android.support.ResetStateRule;\n+import org.odk.collect.android.support.StubOpenRosaServer;\n+import org.odk.collect.async.CoroutineScheduler;\n+import org.odk.collect.async.Scheduler;\n+import org.odk.collect.utilities.UserAgentProvider;\n+\n+import static androidx.test.espresso.Espresso.onView;\n+import static androidx.test.espresso.assertion.ViewAssertions.doesNotExist;\n+import static androidx.test.espresso.matcher.ViewMatchers.withId;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class MatchExactlyTest {\n+\n+    public final StubOpenRosaServer server = new StubOpenRosaServer();\n+    private final CountingScheduler countingScheduler = new CountingScheduler(new CoroutineScheduler());\n+\n+    public CollectTestRule rule = new CollectTestRule();\n+\n+    @Rule\n+    public RuleChain copyFormChain = RuleChain\n+            .outerRule(GrantPermissionRule.grant(\n+                    Manifest.permission.READ_EXTERNAL_STORAGE,\n+                    Manifest.permission.WRITE_EXTERNAL_STORAGE,\n+                    Manifest.permission.READ_PHONE_STATE\n+            ))\n+            .around(new ResetStateRule(new AppDependencyModule() {\n+                @Override\n+                public OpenRosaHttpInterface provideHttpInterface(MimeTypeMap mimeTypeMap, UserAgentProvider userAgentProvider) {\n+                    return server;\n+                }\n+\n+                @Override\n+                public Scheduler providesScheduler() {\n+                    return countingScheduler;\n+                }\n+            }))\n+            .around(new IdlingResourceRule(new CountingSchedulerIdlingResource(countingScheduler)))\n+            .around(new CopyFormRule(\"one-question.xml\"))\n+            .around(new CopyFormRule(\"one-question-repeat.xml\"))\n+            .around(rule);\n+\n+    @Test\n+    public void whenMatchExactlyEnabled_clickingFillBlankForm_andClickingRefresh_getsLatestFormsFromServer() {\n+        server.addForm(\"One Question Updated\", \"one_question\", \"one-question-updated.xml\");\n+        server.addForm(\"Two Question\", \"two_question\", \"two-question.xml\");\n+\n+        rule.mainMenu()\n+                .setServer(server.getURL())\n+                .enableMatchExactly()\n+                .clickFillBlankForm()\n+                .assertText(\"One Question\")\n+                .assertText(\"One Question Repeat\")\n+                .clickRefresh()\n+                .assertText(\"Two Question\") // Check new form downloaded\n+                .assertText(\"One Question Updated\") // Check updated form updated\n+                .assertTextDoesNotExist(\"One Question Repeat\"); // Check deleted form deleted\n+    }\n+\n+    @Test\n+    public void whenMatchExactlyEnabled_getBlankFormsButtonIsGone() {\n+        rule.mainMenu()\n+                .enableMatchExactly()\n+                .assertTextNotDisplayed(R.string.get_forms);\n+    }\n+\n+    @Test\n+    public void whenMatchExactlyEnabled_formManagementFormUpdateIsDisabled() {\n+        rule.mainMenu()\n+                .enableMatchExactly()\n+                .clickOnMenu()\n+                .clickGeneralSettings()\n+                .clickFormManagement()\n+                .assertDisabled(R.string.periodic_form_updates_check_title)\n+                .assertDisabled(R.string.automatic_download)\n+                .assertDisabled(R.string.hide_old_form_versions_setting_title);\n+    }\n+\n+    @Test\n+    public void whenMatchExactlyEnabled_fillBlankFormRefreshButtonIsGone() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19e081ffed9af4a6a5695fdb7e0d9cfa22dd4083"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE1MjE5Mg==", "bodyText": "In our live review we talked about in a follow-up PR considering changing this to a Set. There's no reason for the results to be ordered and sets will make some client code cleaner. We also talked about replacing contains with a get by jrFormId (which should also return a set with potentially multiple versions). No action needed now but writing it down so we don't forget.", "url": "https://github.com/getodk/collect/pull/3956#discussion_r451152192", "createdAt": "2020-07-07T21:24:35Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/forms/DatabaseFormRepository.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package org.odk.collect.android.forms;\n+\n+import android.database.Cursor;\n+\n+import org.odk.collect.android.dao.FormsDao;\n+\n+import java.util.List;\n+\n+import javax.annotation.Nullable;\n+\n+public class DatabaseFormRepository implements FormRepository {\n+\n+    @Override\n+    public boolean contains(String jrFormID) {\n+        try (Cursor cursor = new FormsDao().getFormsCursorForFormId(jrFormID)) {\n+            return cursor != null && cursor.getCount() > 0;\n+        }\n+    }\n+\n+    @Override\n+    public List<Form> getAll() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19e081ffed9af4a6a5695fdb7e0d9cfa22dd4083"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE1NDI1Nw==", "bodyText": "Not actionable so let's do Timber.w or remove since it goes to the UI.", "url": "https://github.com/getodk/collect/pull/3956#discussion_r451154257", "createdAt": "2020-07-07T21:28:56Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/utilities/FormListDownloader.java", "diffHunk": "@@ -110,213 +80,38 @@ public FormListDownloader(\n             }\n         }\n \n-        DocumentFetchResult result = openRosaAPIClient.getXML(downloadListUrl);\n-\n-        clearTemporaryCredentials(url);\n-\n-        // If we can't get the document, return the error, cancel the task\n-        if (result.errorMessage != null) {\n-            if (result.responseCode == HttpURLConnection.HTTP_UNAUTHORIZED) {\n-                formList.put(DL_AUTH_REQUIRED, new FormDetails(result.errorMessage));\n-            } else {\n-                formList.put(DL_ERROR_MSG, new FormDetails(result.errorMessage));\n-            }\n-            return formList;\n-        }\n-\n-        if (result.isOpenRosaResponse) {\n-            // Attempt OpenRosa 1.0 parsing\n-            Element xformsElement = result.doc.getRootElement();\n-            if (!xformsElement.getName().equals(\"xforms\")) {\n-                String error = \"root element is not <xforms> : \" + xformsElement.getName();\n-                Timber.e(\"Parsing OpenRosa reply -- %s\", error);\n-                formList.put(\n-                        DL_ERROR_MSG,\n-                        new FormDetails(application.getString(\n-                                R.string.parse_openrosa_formlist_failed, error)));\n-                return formList;\n-            }\n-            String namespace = xformsElement.getNamespace();\n-            if (!isXformsListNamespacedElement(xformsElement)) {\n-                String error = \"root element namespace is incorrect:\" + namespace;\n-                Timber.e(\"Parsing OpenRosa reply -- %s\", error);\n-                formList.put(\n-                        DL_ERROR_MSG,\n-                        new FormDetails(application.getString(\n-                                R.string.parse_openrosa_formlist_failed, error)));\n-                return formList;\n-            }\n-            int elements = xformsElement.getChildCount();\n-            for (int i = 0; i < elements; ++i) {\n-                if (xformsElement.getType(i) != Element.ELEMENT) {\n-                    // e.g., whitespace (text)\n-                    continue;\n-                }\n-                Element xformElement = xformsElement.getElement(i);\n-                if (!isXformsListNamespacedElement(xformElement)) {\n-                    // someone else's extension?\n-                    continue;\n-                }\n-                String name = xformElement.getName();\n-                if (!name.equalsIgnoreCase(\"xform\")) {\n-                    // someone else's extension?\n-                    continue;\n-                }\n+        OpenRosaFormListApi formAPI = new OpenRosaFormListApi(openRosaXMLFetcher, downloadListUrl, downloadPath);\n+        // We populate this with available forms from the specified server.\n+        // <formname, details>\n+        HashMap<String, ServerFormDetails> formList = new HashMap<>();\n \n-                // this is something we know how to interpret\n-                String formId = null;\n-                String formName = null;\n-                String version = null;\n-                String majorMinorVersion = null;\n-                String description = null;\n-                String downloadUrl = null;\n-                String manifestUrl = null;\n-                String hash = null;\n-                // don't process descriptionUrl\n-                int fieldCount = xformElement.getChildCount();\n-                for (int j = 0; j < fieldCount; ++j) {\n-                    if (xformElement.getType(j) != Element.ELEMENT) {\n-                        // whitespace\n-                        continue;\n-                    }\n-                    Element child = xformElement.getElement(j);\n-                    if (!isXformsListNamespacedElement(child)) {\n-                        // someone else's extension?\n-                        continue;\n-                    }\n-                    String tag = child.getName();\n-                    switch (tag) {\n-                        case \"formID\":\n-                            formId = XFormParser.getXMLText(child, true);\n-                            if (formId != null && formId.length() == 0) {\n-                                formId = null;\n-                            }\n-                            break;\n-                        case \"name\":\n-                            formName = XFormParser.getXMLText(child, true);\n-                            if (formName != null && formName.length() == 0) {\n-                                formName = null;\n-                            }\n-                            break;\n-                        case \"version\":\n-                            version = XFormParser.getXMLText(child, true);\n-                            if (version != null && version.length() == 0) {\n-                                version = null;\n-                            }\n-                            break;\n-                        case \"majorMinorVersion\":\n-                            majorMinorVersion = XFormParser.getXMLText(child, true);\n-                            if (majorMinorVersion != null && majorMinorVersion.length() == 0) {\n-                                majorMinorVersion = null;\n-                            }\n-                            break;\n-                        case \"descriptionText\":\n-                            description = XFormParser.getXMLText(child, true);\n-                            if (description != null && description.length() == 0) {\n-                                description = null;\n-                            }\n-                            break;\n-                        case \"downloadUrl\":\n-                            downloadUrl = XFormParser.getXMLText(child, true);\n-                            if (downloadUrl != null && downloadUrl.length() == 0) {\n-                                downloadUrl = null;\n-                            }\n-                            break;\n-                        case \"manifestUrl\":\n-                            manifestUrl = XFormParser.getXMLText(child, true);\n-                            if (manifestUrl != null && manifestUrl.length() == 0) {\n-                                manifestUrl = null;\n-                            }\n-                            break;\n-                        case \"hash\":\n-                            hash = XFormParser.getXMLText(child, true);\n-                            if (hash != null && hash.length() == 0) {\n-                                hash = null;\n-                            }\n-                            break;\n-                    }\n-                }\n-                if (formId == null || downloadUrl == null || formName == null) {\n-                    String error =\n-                            \"Forms list entry \" + Integer.toString(i)\n-                                    + \" has missing or empty tags: formID, name, or downloadUrl\";\n-                    Timber.e(\"Parsing OpenRosa reply -- %s\", error);\n-                    formList.clear();\n-                    formList.put(\n-                            DL_ERROR_MSG,\n-                            new FormDetails(application.getString(\n-                                    R.string.parse_openrosa_formlist_failed, error)));\n-                    return formList;\n-                }\n-                boolean isNewerFormVersionAvailable = false;\n-                boolean areNewerMediaFilesAvailable = false;\n-                ManifestFile manifestFile = null;\n-                if (isThisFormAlreadyDownloaded(formId)) {\n-                    isNewerFormVersionAvailable = isNewerFormVersionAvailable(FormDownloader.getMd5Hash(hash));\n-                    if ((!isNewerFormVersionAvailable || alwaysCheckMediaFiles) && manifestUrl != null) {\n-                        manifestFile = getManifestFile(manifestUrl);\n-                        if (manifestFile != null) {\n-                            List<MediaFile> newMediaFiles = manifestFile.getMediaFiles();\n-                            if (newMediaFiles != null && !newMediaFiles.isEmpty()) {\n-                                areNewerMediaFilesAvailable = areNewerMediaFilesAvailable(formId, version, newMediaFiles);\n-                            }\n-                        }\n-                    }\n-                }\n-                formList.put(formId, new FormDetails(formName, downloadUrl, manifestUrl, formId,\n-                        (version != null) ? version : majorMinorVersion, hash,\n-                        manifestFile != null ? manifestFile.getHash() : null,\n-                        isNewerFormVersionAvailable, areNewerMediaFilesAvailable));\n+        try {\n+            ServerFormsDetailsFetcher serverFormsDetailsFetcher = new ServerFormsDetailsFetcher(formRepository, mediaFileRepository, formAPI);\n+            List<ServerFormDetails> serverFormDetailsList = serverFormsDetailsFetcher.fetchFormDetails(alwaysCheckMediaFiles);\n+            for (ServerFormDetails serverFormDetails : serverFormDetailsList) {\n+                formList.put(serverFormDetails.getFormId(), serverFormDetails);\n             }\n-        } else {\n-            // Aggregate 0.9.x mode...\n-            // populate HashMap with form names and urls\n-            Element formsElement = result.doc.getRootElement();\n-            int formsCount = formsElement.getChildCount();\n-            String formId = null;\n-            for (int i = 0; i < formsCount; ++i) {\n-                if (formsElement.getType(i) != Element.ELEMENT) {\n-                    // whitespace\n-                    continue;\n-                }\n-                Element child = formsElement.getElement(i);\n-                String tag = child.getName();\n-                if (tag.equals(\"formID\")) {\n-                    formId = XFormParser.getXMLText(child, true);\n-                    if (formId != null && formId.length() == 0) {\n-                        formId = null;\n-                    }\n-                }\n-                if (tag.equalsIgnoreCase(\"form\")) {\n-                    String formName = XFormParser.getXMLText(child, true);\n-                    if (formName != null && formName.length() == 0) {\n-                        formName = null;\n-                    }\n-                    String downloadUrl = child.getAttributeValue(null, \"url\");\n-                    downloadUrl = downloadUrl.trim();\n-                    if (downloadUrl.length() == 0) {\n-                        downloadUrl = null;\n-                    }\n-                    if (formName == null) {\n-                        String error =\n-                                \"Forms list entry \" + Integer.toString(i)\n-                                        + \" is missing form name or url attribute\";\n-                        Timber.e(\"Parsing OpenRosa reply -- %s\", error);\n-                        formList.clear();\n-                        formList.put(\n-                                DL_ERROR_MSG,\n-                                new FormDetails(application.getString(\n-                                        R.string.parse_legacy_formlist_failed, error)));\n-                        return formList;\n-                    }\n-                    formList.put(formName,\n-                            new FormDetails(formName, downloadUrl, null, formId, null, null, null, false, false));\n-\n-                    formId = null;\n-                }\n+        } catch (FormApiException formApiException) {\n+            Timber.e(formApiException);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19e081ffed9af4a6a5695fdb7e0d9cfa22dd4083"}, "originalPosition": 342}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE1NTE3NQ==", "bodyText": "I couldn't really come up with a reliable and efficient way to verify that you addressed the exact same exception list when extracting OpenRosaFormListApi. That means I'm just trusting you on that and it seems like a potential source of risk.", "url": "https://github.com/getodk/collect/pull/3956#discussion_r451155175", "createdAt": "2020-07-07T21:30:49Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/utilities/FormListDownloader.java", "diffHunk": "@@ -110,213 +80,38 @@ public FormListDownloader(\n             }\n         }\n \n-        DocumentFetchResult result = openRosaAPIClient.getXML(downloadListUrl);\n-\n-        clearTemporaryCredentials(url);\n-\n-        // If we can't get the document, return the error, cancel the task\n-        if (result.errorMessage != null) {\n-            if (result.responseCode == HttpURLConnection.HTTP_UNAUTHORIZED) {\n-                formList.put(DL_AUTH_REQUIRED, new FormDetails(result.errorMessage));\n-            } else {\n-                formList.put(DL_ERROR_MSG, new FormDetails(result.errorMessage));\n-            }\n-            return formList;\n-        }\n-\n-        if (result.isOpenRosaResponse) {\n-            // Attempt OpenRosa 1.0 parsing\n-            Element xformsElement = result.doc.getRootElement();\n-            if (!xformsElement.getName().equals(\"xforms\")) {\n-                String error = \"root element is not <xforms> : \" + xformsElement.getName();\n-                Timber.e(\"Parsing OpenRosa reply -- %s\", error);\n-                formList.put(\n-                        DL_ERROR_MSG,\n-                        new FormDetails(application.getString(\n-                                R.string.parse_openrosa_formlist_failed, error)));\n-                return formList;\n-            }\n-            String namespace = xformsElement.getNamespace();\n-            if (!isXformsListNamespacedElement(xformsElement)) {\n-                String error = \"root element namespace is incorrect:\" + namespace;\n-                Timber.e(\"Parsing OpenRosa reply -- %s\", error);\n-                formList.put(\n-                        DL_ERROR_MSG,\n-                        new FormDetails(application.getString(\n-                                R.string.parse_openrosa_formlist_failed, error)));\n-                return formList;\n-            }\n-            int elements = xformsElement.getChildCount();\n-            for (int i = 0; i < elements; ++i) {\n-                if (xformsElement.getType(i) != Element.ELEMENT) {\n-                    // e.g., whitespace (text)\n-                    continue;\n-                }\n-                Element xformElement = xformsElement.getElement(i);\n-                if (!isXformsListNamespacedElement(xformElement)) {\n-                    // someone else's extension?\n-                    continue;\n-                }\n-                String name = xformElement.getName();\n-                if (!name.equalsIgnoreCase(\"xform\")) {\n-                    // someone else's extension?\n-                    continue;\n-                }\n+        OpenRosaFormListApi formAPI = new OpenRosaFormListApi(openRosaXMLFetcher, downloadListUrl, downloadPath);\n+        // We populate this with available forms from the specified server.\n+        // <formname, details>\n+        HashMap<String, ServerFormDetails> formList = new HashMap<>();\n \n-                // this is something we know how to interpret\n-                String formId = null;\n-                String formName = null;\n-                String version = null;\n-                String majorMinorVersion = null;\n-                String description = null;\n-                String downloadUrl = null;\n-                String manifestUrl = null;\n-                String hash = null;\n-                // don't process descriptionUrl\n-                int fieldCount = xformElement.getChildCount();\n-                for (int j = 0; j < fieldCount; ++j) {\n-                    if (xformElement.getType(j) != Element.ELEMENT) {\n-                        // whitespace\n-                        continue;\n-                    }\n-                    Element child = xformElement.getElement(j);\n-                    if (!isXformsListNamespacedElement(child)) {\n-                        // someone else's extension?\n-                        continue;\n-                    }\n-                    String tag = child.getName();\n-                    switch (tag) {\n-                        case \"formID\":\n-                            formId = XFormParser.getXMLText(child, true);\n-                            if (formId != null && formId.length() == 0) {\n-                                formId = null;\n-                            }\n-                            break;\n-                        case \"name\":\n-                            formName = XFormParser.getXMLText(child, true);\n-                            if (formName != null && formName.length() == 0) {\n-                                formName = null;\n-                            }\n-                            break;\n-                        case \"version\":\n-                            version = XFormParser.getXMLText(child, true);\n-                            if (version != null && version.length() == 0) {\n-                                version = null;\n-                            }\n-                            break;\n-                        case \"majorMinorVersion\":\n-                            majorMinorVersion = XFormParser.getXMLText(child, true);\n-                            if (majorMinorVersion != null && majorMinorVersion.length() == 0) {\n-                                majorMinorVersion = null;\n-                            }\n-                            break;\n-                        case \"descriptionText\":\n-                            description = XFormParser.getXMLText(child, true);\n-                            if (description != null && description.length() == 0) {\n-                                description = null;\n-                            }\n-                            break;\n-                        case \"downloadUrl\":\n-                            downloadUrl = XFormParser.getXMLText(child, true);\n-                            if (downloadUrl != null && downloadUrl.length() == 0) {\n-                                downloadUrl = null;\n-                            }\n-                            break;\n-                        case \"manifestUrl\":\n-                            manifestUrl = XFormParser.getXMLText(child, true);\n-                            if (manifestUrl != null && manifestUrl.length() == 0) {\n-                                manifestUrl = null;\n-                            }\n-                            break;\n-                        case \"hash\":\n-                            hash = XFormParser.getXMLText(child, true);\n-                            if (hash != null && hash.length() == 0) {\n-                                hash = null;\n-                            }\n-                            break;\n-                    }\n-                }\n-                if (formId == null || downloadUrl == null || formName == null) {\n-                    String error =\n-                            \"Forms list entry \" + Integer.toString(i)\n-                                    + \" has missing or empty tags: formID, name, or downloadUrl\";\n-                    Timber.e(\"Parsing OpenRosa reply -- %s\", error);\n-                    formList.clear();\n-                    formList.put(\n-                            DL_ERROR_MSG,\n-                            new FormDetails(application.getString(\n-                                    R.string.parse_openrosa_formlist_failed, error)));\n-                    return formList;\n-                }\n-                boolean isNewerFormVersionAvailable = false;\n-                boolean areNewerMediaFilesAvailable = false;\n-                ManifestFile manifestFile = null;\n-                if (isThisFormAlreadyDownloaded(formId)) {\n-                    isNewerFormVersionAvailable = isNewerFormVersionAvailable(FormDownloader.getMd5Hash(hash));\n-                    if ((!isNewerFormVersionAvailable || alwaysCheckMediaFiles) && manifestUrl != null) {\n-                        manifestFile = getManifestFile(manifestUrl);\n-                        if (manifestFile != null) {\n-                            List<MediaFile> newMediaFiles = manifestFile.getMediaFiles();\n-                            if (newMediaFiles != null && !newMediaFiles.isEmpty()) {\n-                                areNewerMediaFilesAvailable = areNewerMediaFilesAvailable(formId, version, newMediaFiles);\n-                            }\n-                        }\n-                    }\n-                }\n-                formList.put(formId, new FormDetails(formName, downloadUrl, manifestUrl, formId,\n-                        (version != null) ? version : majorMinorVersion, hash,\n-                        manifestFile != null ? manifestFile.getHash() : null,\n-                        isNewerFormVersionAvailable, areNewerMediaFilesAvailable));\n+        try {\n+            ServerFormsDetailsFetcher serverFormsDetailsFetcher = new ServerFormsDetailsFetcher(formRepository, mediaFileRepository, formAPI);\n+            List<ServerFormDetails> serverFormDetailsList = serverFormsDetailsFetcher.fetchFormDetails(alwaysCheckMediaFiles);\n+            for (ServerFormDetails serverFormDetails : serverFormDetailsList) {\n+                formList.put(serverFormDetails.getFormId(), serverFormDetails);\n             }\n-        } else {\n-            // Aggregate 0.9.x mode...\n-            // populate HashMap with form names and urls\n-            Element formsElement = result.doc.getRootElement();\n-            int formsCount = formsElement.getChildCount();\n-            String formId = null;\n-            for (int i = 0; i < formsCount; ++i) {\n-                if (formsElement.getType(i) != Element.ELEMENT) {\n-                    // whitespace\n-                    continue;\n-                }\n-                Element child = formsElement.getElement(i);\n-                String tag = child.getName();\n-                if (tag.equals(\"formID\")) {\n-                    formId = XFormParser.getXMLText(child, true);\n-                    if (formId != null && formId.length() == 0) {\n-                        formId = null;\n-                    }\n-                }\n-                if (tag.equalsIgnoreCase(\"form\")) {\n-                    String formName = XFormParser.getXMLText(child, true);\n-                    if (formName != null && formName.length() == 0) {\n-                        formName = null;\n-                    }\n-                    String downloadUrl = child.getAttributeValue(null, \"url\");\n-                    downloadUrl = downloadUrl.trim();\n-                    if (downloadUrl.length() == 0) {\n-                        downloadUrl = null;\n-                    }\n-                    if (formName == null) {\n-                        String error =\n-                                \"Forms list entry \" + Integer.toString(i)\n-                                        + \" is missing form name or url attribute\";\n-                        Timber.e(\"Parsing OpenRosa reply -- %s\", error);\n-                        formList.clear();\n-                        formList.put(\n-                                DL_ERROR_MSG,\n-                                new FormDetails(application.getString(\n-                                        R.string.parse_legacy_formlist_failed, error)));\n-                        return formList;\n-                    }\n-                    formList.put(formName,\n-                            new FormDetails(formName, downloadUrl, null, formId, null, null, null, false, false));\n-\n-                    formId = null;\n-                }\n+        } catch (FormApiException formApiException) {\n+            Timber.e(formApiException);\n+\n+            switch (formApiException.getType()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19e081ffed9af4a6a5695fdb7e0d9cfa22dd4083"}, "originalPosition": 344}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdc8324f728f6554061edeec302c99568f022d46", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/cdc8324f728f6554061edeec302c99568f022d46", "committedDate": "2020-07-08T09:45:31Z", "message": "Clean up db connection after tests that open it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b0c582a213a99b5cb5da5f18833b0b19142334f", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/5b0c582a213a99b5cb5da5f18833b0b19142334f", "committedDate": "2020-07-08T10:29:09Z", "message": "Correct typo in test name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d78eabee79a9740542325843b5326922b78d20f5", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/d78eabee79a9740542325843b5326922b78d20f5", "committedDate": "2020-07-08T10:29:58Z", "message": "Remove timber error logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "007edeac377b9ad54c3b94a004d44fee735d72b0", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/007edeac377b9ad54c3b94a004d44fee735d72b0", "committedDate": "2020-07-08T23:45:30Z", "message": "Merge branch 'master' into match-exactly"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MjA3MjAz", "url": "https://github.com/getodk/collect/pull/3956#pullrequestreview-445207203", "createdAt": "2020-07-09T00:07:11Z", "commit": {"oid": "007edeac377b9ad54c3b94a004d44fee735d72b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2528, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}