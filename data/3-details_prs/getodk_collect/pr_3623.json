{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNDMzMzgw", "number": 3623, "title": "Changes for allowing files migration", "bodyText": "Migration steps are:\n\nClear app dir on scoped storage (just in case)\nCheck if form uploader is running in the background if it is stop\nCheck if form downloader is running in the background if it is stop\nCheck if there is enough space to copy files, if not stop\nTry to copy files, if any exception happens stop\nMigrate database paths, if any exception happens stop.\nUpdate offline map layer path (if selected in map preferences)\nReset ReferenceManager to clear old paths\nRemove itemsets.db\nClear cache\nRemove odk dir from sdcard\nUse scoped storage\n\nWhat has been done to verify that this works as intended?\nI tested implemented changes manually and added some automated tests.\nWhy is this the best possible solution? Were any other approaches considered?\nIt's what we need because of Google policy and what we agreed to do.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nThe code responsible for migration is pretty isolated that means fortunately I wouldn't expect that it might affect anything not related to this option but in the migration itself you can expect unexpected of course.\nIn order to use the AdminPassworDialog in migration I needed to factor it out (before it was used just in the Main Menu), so please make sure there is no regression there.\nDo we need any specific form for testing your changes? If so, please attach one.\nNo.\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nProbably we need to document the new scoped storage but it's not just related with this pr.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-02-05T15:24:52Z", "url": "https://github.com/getodk/collect/pull/3623", "merged": true, "mergeCommit": {"oid": "8cd8a91f269c4515621075efb2de3006d0c21b30"}, "closed": true, "closedAt": "2020-03-02T16:28:18Z", "author": {"login": "grzesiek2010"}, "timelineItems": {"totalCount": 147, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIEvYbgH2gAyMzcxNDMzMzgwOmU4Yzc5MjA2M2E5YjBjMTcxNzc1ZTVlOGU1ZjZlYzFkNmUwYzM5MmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJwTIAAFqTM2NzMzOTEzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e8c792063a9b0c171775e5e8e5f6ec1d6e0c392e", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/e8c792063a9b0c171775e5e8e5f6ec1d6e0c392e", "committedDate": "2020-02-26T11:08:51Z", "message": "Avoid multiclicking in StorageMigrationDialog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea71d20a2c26a592559e7c10b91a90a008af9f0e", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/ea71d20a2c26a592559e7c10b91a90a008af9f0e", "committedDate": "2020-02-26T11:08:51Z", "message": "Fixed build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8f0e62074699778d3456198e3063fc9fce71dcc", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f8f0e62074699778d3456198e3063fc9fce71dcc", "committedDate": "2020-02-26T11:10:51Z", "message": "Code improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "547bd2964fbf622ea6a509213c86d928f4b471a1", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/547bd2964fbf622ea6a509213c86d928f4b471a1", "committedDate": "2020-02-26T11:10:51Z", "message": "Improved communication MainMenuActivity->StorageMigrationDialog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "617641fb3dcf0b6eb5d6b87cadbd1eb345eb4cd2", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/617641fb3dcf0b6eb5d6b87cadbd1eb345eb4cd2", "committedDate": "2020-02-26T11:10:51Z", "message": "Added new TextAppearance.Collect.Button.TextButton style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef2a7f78d75c5d01f041cf075393998e1e181c69", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/ef2a7f78d75c5d01f041cf075393998e1e181c69", "committedDate": "2020-02-26T11:10:51Z", "message": "Removed unused method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dc78a9857fa4b78c5e388fb8e90a7e2e9ac9d63", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/2dc78a9857fa4b78c5e388fb8e90a7e2e9ac9d63", "committedDate": "2020-02-26T11:11:10Z", "message": "Fixed creating StorageMigrationDialog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0312b5d053ea20ebef917682fc4e5a1e7b95879b", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/0312b5d053ea20ebef917682fc4e5a1e7b95879b", "committedDate": "2020-02-26T11:11:10Z", "message": "Use MaterialButton  instead of TextView for moreDetailsButton"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c19f68a57968acb75477776c2a76a21eeb82e92", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/3c19f68a57968acb75477776c2a76a21eeb82e92", "committedDate": "2020-02-26T11:11:47Z", "message": "Handle offline map layer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a127cc6137823a930eb0ceaa4ab6bcfd5f482b1", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/4a127cc6137823a930eb0ceaa4ab6bcfd5f482b1", "committedDate": "2020-02-26T11:11:47Z", "message": "Fixed storage paths in tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b41f872629c599595fe83d27e27fc5ee3bdc1ca2", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/b41f872629c599595fe83d27e27fc5ee3bdc1ca2", "committedDate": "2020-02-26T11:11:47Z", "message": "Improved existed tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "814be2d8de1cc8a134d0f89eb27cc9c98d2403fa", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/814be2d8de1cc8a134d0f89eb27cc9c98d2403fa", "committedDate": "2020-02-26T11:11:47Z", "message": "Code improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fb6cab6cbbe6a22adb2da565564ea32ce4548c1", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/6fb6cab6cbbe6a22adb2da565564ea32ce4548c1", "committedDate": "2020-02-26T11:11:47Z", "message": "Reset ReferenceManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d04a5672c2071faa716647cc0cf54862adc9e76", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/9d04a5672c2071faa716647cc0cf54862adc9e76", "committedDate": "2020-02-26T11:11:47Z", "message": "Improved handling offline map layer paths"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c39d25aab5dc9a179da718d7aa0174b4e261cc36", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/c39d25aab5dc9a179da718d7aa0174b4e261cc36", "committedDate": "2020-02-26T11:11:47Z", "message": "Don't use database observer when migartion in being performed to avoid blocking UI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0b5bae7a2eed421472d1ad6fab63422a8858cdd", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/e0b5bae7a2eed421472d1ad6fab63422a8858cdd", "committedDate": "2020-02-26T11:11:47Z", "message": "Keep the right migration dialog state if a user leaves and returns to the app"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5c897dec0f05de683426d46fb6d78c1c74f9e51", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/a5c897dec0f05de683426d46fb6d78c1c74f9e51", "committedDate": "2020-02-26T11:11:47Z", "message": "Fixed checking if AutoSendWOrker is running"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12853f65d142faabd8005c5d9eff91b1bbaf140b", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/12853f65d142faabd8005c5d9eff91b1bbaf140b", "committedDate": "2020-02-26T11:11:47Z", "message": "Added StorageMigrationCompletedBannerTest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3a24e11149b954dbf0533343cce8ec5a38fab59", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/a3a24e11149b954dbf0533343cce8ec5a38fab59", "committedDate": "2020-02-26T10:47:39Z", "message": "Added StorageMigrationCompletedBannerTest"}, "afterCommit": {"oid": "12853f65d142faabd8005c5d9eff91b1bbaf140b", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/12853f65d142faabd8005c5d9eff91b1bbaf140b", "committedDate": "2020-02-26T11:11:47Z", "message": "Added StorageMigrationCompletedBannerTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d932897283f63bc10c8f0d3c307d2626ab93d777", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/d932897283f63bc10c8f0d3c307d2626ab93d777", "committedDate": "2020-02-26T11:34:44Z", "message": "Fixed strings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c45f65acd72ff9f01afc7bb579b52f2bc92be96e", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/c45f65acd72ff9f01afc7bb579b52f2bc92be96e", "committedDate": "2020-02-26T12:03:47Z", "message": "Added StorageMigrationBannerTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d780ec0a7609eda5ee634ac693ae47605f1b08f", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/1d780ec0a7609eda5ee634ac693ae47605f1b08f", "committedDate": "2020-02-26T15:10:20Z", "message": "AddedStorageMigrationDialogTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1034deb4bf1eaed73692004882274dcd727b3fb", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/a1034deb4bf1eaed73692004882274dcd727b3fb", "committedDate": "2020-02-27T15:11:23Z", "message": "Improved checking if background form downloader is running and added tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "571fce1894d5c2a2c186fa5b512821487b9f17ac", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/571fce1894d5c2a2c186fa5b512821487b9f17ac", "committedDate": "2020-02-27T15:27:13Z", "message": "ds"}, "afterCommit": {"oid": "a1034deb4bf1eaed73692004882274dcd727b3fb", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/a1034deb4bf1eaed73692004882274dcd727b3fb", "committedDate": "2020-02-27T15:11:23Z", "message": "Improved checking if background form downloader is running and added tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "254db8e944289890ab6bd7ada703a0b0acd9333d", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/254db8e944289890ab6bd7ada703a0b0acd9333d", "committedDate": "2020-02-27T19:49:22Z", "message": "Avoid displaying the banner again if it has been dismissed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c795398981d2a7364c6ca19965cd5c8e01e8e5fe", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/c795398981d2a7364c6ca19965cd5c8e01e8e5fe", "committedDate": "2020-02-27T23:52:57Z", "message": "Added ScrollView to StorageMigrationDialog and moved the error TextView up"}, "afterCommit": {"oid": "6fa5889f33389d20aa9be84860733f0c03d64927", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/6fa5889f33389d20aa9be84860733f0c03d64927", "committedDate": "2020-02-27T23:57:35Z", "message": "Added ScrollView to StorageMigrationDialog and moved the error TextView up"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6fa5889f33389d20aa9be84860733f0c03d64927", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/6fa5889f33389d20aa9be84860733f0c03d64927", "committedDate": "2020-02-27T23:57:35Z", "message": "Added ScrollView to StorageMigrationDialog and moved the error TextView up"}, "afterCommit": {"oid": "ee7e81876ea2c5577ee3912d88f9668e83940ce5", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/ee7e81876ea2c5577ee3912d88f9668e83940ce5", "committedDate": "2020-02-28T00:03:33Z", "message": "Added ScrollView to StorageMigrationDialog and moved the error TextView up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6122d41e691690eba139299b3a895a6a1bc947e1", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/6122d41e691690eba139299b3a895a6a1bc947e1", "committedDate": "2020-02-28T00:08:39Z", "message": "Added ScrollView to StorageMigrationDialog and moved the error TextView up"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee7e81876ea2c5577ee3912d88f9668e83940ce5", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/ee7e81876ea2c5577ee3912d88f9668e83940ce5", "committedDate": "2020-02-28T00:03:33Z", "message": "Added ScrollView to StorageMigrationDialog and moved the error TextView up"}, "afterCommit": {"oid": "6122d41e691690eba139299b3a895a6a1bc947e1", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/6122d41e691690eba139299b3a895a6a1bc947e1", "committedDate": "2020-02-28T00:08:39Z", "message": "Added ScrollView to StorageMigrationDialog and moved the error TextView up"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ea84b9c2950c91055e0397ca986c34e9c233f388", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/ea84b9c2950c91055e0397ca986c34e9c233f388", "committedDate": "2020-02-28T10:01:27Z", "message": "Code improvements and tests"}, "afterCommit": {"oid": "e3257f08b49ad8ceb26e82a3cc4fa14a726dbd25", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/e3257f08b49ad8ceb26e82a3cc4fa14a726dbd25", "committedDate": "2020-02-28T10:17:40Z", "message": "Code improvements and tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e3257f08b49ad8ceb26e82a3cc4fa14a726dbd25", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/e3257f08b49ad8ceb26e82a3cc4fa14a726dbd25", "committedDate": "2020-02-28T10:17:40Z", "message": "Code improvements and tests"}, "afterCommit": {"oid": "9c0949e42542d0000b93e621ba462044007a808b", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/9c0949e42542d0000b93e621ba462044007a808b", "committedDate": "2020-02-28T10:45:25Z", "message": "Code improvements and tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ecf4f6adbbdf88f14be4aaff53c973b9519160b", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/2ecf4f6adbbdf88f14be4aaff53c973b9519160b", "committedDate": "2020-02-28T10:47:43Z", "message": "Code improvements and tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c0949e42542d0000b93e621ba462044007a808b", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/9c0949e42542d0000b93e621ba462044007a808b", "committedDate": "2020-02-28T10:45:25Z", "message": "Code improvements and tests"}, "afterCommit": {"oid": "2ecf4f6adbbdf88f14be4aaff53c973b9519160b", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/2ecf4f6adbbdf88f14be4aaff53c973b9519160b", "committedDate": "2020-02-28T10:47:43Z", "message": "Code improvements and tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MzEwMDc5", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-366310079", "createdAt": "2020-02-28T10:49:00Z", "commit": {"oid": "2ecf4f6adbbdf88f14be4aaff53c973b9519160b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMDo0OTowMFrOFvw5Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMDo0OTowMFrOFvw5Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYyODQ1MA==", "bodyText": "Really liking this use of @Rule! I think it'd be good to still have the ResetStateRule and standard permssion rules for these tests just to make sure they are starting fresh.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r385628450", "createdAt": "2020-02-28T10:49:00Z", "author": {"login": "seadowg"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/storage/StorageMigrationBannerTest.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package org.odk.collect.android.storage;\n+\n+import androidx.test.rule.ActivityTestRule;\n+\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.odk.collect.android.activities.MainMenuActivity;\n+import org.odk.collect.android.support.StorageMigrationNotPerformedRule;\n+import org.odk.collect.android.support.pages.MainMenuPage;\n+\n+public class StorageMigrationBannerTest {\n+\n+    @Rule\n+    public ActivityTestRule<MainMenuActivity> main = new ActivityTestRule<>(MainMenuActivity.class);\n+\n+    @Rule\n+    public StorageMigrationNotPerformedRule storageMigrationNotPerformedRule = new StorageMigrationNotPerformedRule();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ecf4f6adbbdf88f14be4aaff53c973b9519160b"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MzExMTk4", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-366311198", "createdAt": "2020-02-28T10:50:53Z", "commit": {"oid": "2ecf4f6adbbdf88f14be4aaff53c973b9519160b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMDo1MDo1NFrOFvw8bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMDo1MDo1NFrOFvw8bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYyOTI5NQ==", "bodyText": "I think you'd be fine to combine this with the previous test as one flow. I think we can also move rotation/reopen testing out of Espresso for these cases but I'll have a quick think about that and get back to you on that.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r385629295", "createdAt": "2020-02-28T10:50:54Z", "author": {"login": "seadowg"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/storage/StorageMigrationBannerTest.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package org.odk.collect.android.storage;\n+\n+import androidx.test.rule.ActivityTestRule;\n+\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.odk.collect.android.activities.MainMenuActivity;\n+import org.odk.collect.android.support.StorageMigrationNotPerformedRule;\n+import org.odk.collect.android.support.pages.MainMenuPage;\n+\n+public class StorageMigrationBannerTest {\n+\n+    @Rule\n+    public ActivityTestRule<MainMenuActivity> main = new ActivityTestRule<>(MainMenuActivity.class);\n+\n+    @Rule\n+    public StorageMigrationNotPerformedRule storageMigrationNotPerformedRule = new StorageMigrationNotPerformedRule();\n+\n+    @Test\n+    public void when_storageMigrationNotPerformed_should_bannerBeVisible() {\n+        new MainMenuPage(main)\n+                .assertStorageMigrationBannerIsDisplayed()\n+                .rotateToLandscape(new MainMenuPage(main))\n+                .assertStorageMigrationBannerIsDisplayed()\n+                .rotateToPortrait(new MainMenuPage(main))\n+                .assertStorageMigrationBannerIsDisplayed()\n+                .reopenApp()\n+                .assertStorageMigrationBannerIsDisplayed();\n+    }\n+\n+    @Test\n+    public void when_learMoreButtonClicked_should_storageMigrationDialogAppear() {\n+        new MainMenuPage(main)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ecf4f6adbbdf88f14be4aaff53c973b9519160b"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MzEyNjE3", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-366312617", "createdAt": "2020-02-28T10:53:17Z", "commit": {"oid": "2ecf4f6adbbdf88f14be4aaff53c973b9519160b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMDo1MzoxN1rOFvxAtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMDo1MzoxN1rOFvxAtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYzMDM4OQ==", "bodyText": "I'm wondering if it might make sense to combine these tests with the StorageMigrationBannerTest as one file that tests the migration flow.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r385630389", "createdAt": "2020-02-28T10:53:17Z", "author": {"login": "seadowg"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/storage/StorageMigrationDialogTest.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package org.odk.collect.android.storage;\n+\n+import android.Manifest;\n+\n+import androidx.test.espresso.intent.rule.IntentsTestRule;\n+import androidx.test.rule.GrantPermissionRule;\n+\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.RuleChain;\n+import org.odk.collect.android.activities.MainMenuActivity;\n+import org.odk.collect.android.support.CopyFormRule;\n+import org.odk.collect.android.support.ResetStateRule;\n+import org.odk.collect.android.support.StorageMigrationNotPerformedRule;\n+import org.odk.collect.android.support.pages.MainMenuPage;\n+import org.odk.collect.android.support.pages.StorageMigrationDialogPage;\n+\n+public class StorageMigrationDialogTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ecf4f6adbbdf88f14be4aaff53c973b9519160b"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MzEzMjIw", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-366313220", "createdAt": "2020-02-28T10:54:14Z", "commit": {"oid": "2ecf4f6adbbdf88f14be4aaff53c973b9519160b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMDo1NDoxNVrOFvxCjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMDo1NDoxNVrOFvxCjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYzMDg2Mw==", "bodyText": "Same again: feels like we might be able to just combine these with the other migration tests", "url": "https://github.com/getodk/collect/pull/3623#discussion_r385630863", "createdAt": "2020-02-28T10:54:15Z", "author": {"login": "seadowg"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/storage/StorageMigrationTest.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package org.odk.collect.android.storage;\n+\n+import android.Manifest;\n+\n+import androidx.test.espresso.intent.rule.IntentsTestRule;\n+import androidx.test.rule.GrantPermissionRule;\n+\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.RuleChain;\n+import org.odk.collect.android.activities.MainMenuActivity;\n+import org.odk.collect.android.support.CopyFormRule;\n+import org.odk.collect.android.support.ResetStateRule;\n+import org.odk.collect.android.support.StorageMigrationNotPerformedRule;\n+import org.odk.collect.android.support.pages.MainMenuPage;\n+\n+public class StorageMigrationTest {\n+\n+    @Rule\n+    public IntentsTestRule<MainMenuActivity> main = new IntentsTestRule<>(MainMenuActivity.class);\n+\n+    @Rule\n+    public RuleChain copyFormChain = RuleChain\n+            .outerRule(GrantPermissionRule.grant(\n+                    Manifest.permission.READ_EXTERNAL_STORAGE,\n+                    Manifest.permission.WRITE_EXTERNAL_STORAGE\n+            ))\n+            .around(new StorageMigrationNotPerformedRule())\n+            .around(new ResetStateRule())\n+            .around(new CopyFormRule(\"basic.xml\", true));\n+\n+    @Test\n+    public void when_migrationIsFinishedWIthSuccess_should_storageMigrationDialogDisappear() {\n+        new MainMenuPage(main)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ecf4f6adbbdf88f14be4aaff53c973b9519160b"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MzI2MDU2", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-366326056", "createdAt": "2020-02-28T11:16:56Z", "commit": {"oid": "2ecf4f6adbbdf88f14be4aaff53c973b9519160b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMToxNjo1NlrOFvxp3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMToxNjo1NlrOFvxp3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY0MDkyNA==", "bodyText": "I'm wondering if there is a way we could test that the StorageMigrator does the right thing when these jobs are runnign without actually having to start them up (and also have tests that run in the JVM). As far as I can see these tests are non deterministic due to the waits and background work.\nI know Google released some testing around WorkManager so I can have a look and see if there is anything we can use there. Ideally we can fake the state of work or have it run paused or something. This wouldn't solve for the JobManager stuff though, Alternatively, for the moment we could hide the logic around looking up the statuses of these pieces of background work behind an interface that we can sub out for the StorageMigrator's unit test (probably as a constructor arg):\npublic interface WorkStatusProvider {\n    public boolean isFormDownloaderRunning();\n    public boolean isFormUploaderRunning();\n}\nThis would also mean that objects like the StorageMigrator wouldn't have to care about the details involved of fetching those statuses.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r385640924", "createdAt": "2020-02-28T11:16:56Z", "author": {"login": "seadowg"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/storage/StorageMigratorTest.java", "diffHunk": "@@ -0,0 +1,115 @@\n+package org.odk.collect.android.storage;\n+\n+import androidx.work.ExistingWorkPolicy;\n+import androidx.work.OneTimeWorkRequest;\n+import androidx.work.WorkManager;\n+\n+import com.evernote.android.job.JobManager;\n+import com.evernote.android.job.JobManagerCreateException;\n+import com.evernote.android.job.JobRequest;\n+\n+import org.javarosa.core.reference.ReferenceManager;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.odk.collect.android.application.Collect;\n+import org.odk.collect.android.preferences.GeneralSharedPreferences;\n+import org.odk.collect.android.storage.migration.StorageEraser;\n+import org.odk.collect.android.storage.migration.StorageMigrationRepository;\n+import org.odk.collect.android.storage.migration.StorageMigrationResult;\n+import org.odk.collect.android.storage.migration.StorageMigrator;\n+import org.odk.collect.android.storage.utils.FakedAutoSendWorker;\n+import org.odk.collect.android.storage.utils.FakedServerPollingJob;\n+import org.odk.collect.android.tasks.ServerPollingJob;\n+import org.odk.collect.android.upload.AutoSendWorker;\n+\n+import timber.log.Timber;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.core.IsNot.not;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.spy;\n+\n+public class StorageMigratorTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ecf4f6adbbdf88f14be4aaff53c973b9519160b"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "699219afb14b1f2eccc3752e8e0bb4b4ba4aebc5", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/699219afb14b1f2eccc3752e8e0bb4b4ba4aebc5", "committedDate": "2020-03-02T07:58:45Z", "message": "Fixed problem with external files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3e818eeed7fbd3c966e900732ea8a41ad362e94", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f3e818eeed7fbd3c966e900732ea8a41ad362e94", "committedDate": "2020-03-02T10:46:05Z", "message": "Improved tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6073fa3ecd523166fd21dbace8654398e2b6379", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f6073fa3ecd523166fd21dbace8654398e2b6379", "committedDate": "2020-03-02T10:27:51Z", "message": "Improved tests"}, "afterCommit": {"oid": "f3e818eeed7fbd3c966e900732ea8a41ad362e94", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f3e818eeed7fbd3c966e900732ea8a41ad362e94", "committedDate": "2020-03-02T10:46:05Z", "message": "Improved tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc5a275611e2383449717bf4817b0288ec1e15ab", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/bc5a275611e2383449717bf4817b0288ec1e15ab", "committedDate": "2020-03-02T12:56:29Z", "message": "Center migration progress circle vertically"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3df5d35675eed9bcf9f9f09ef73a817f8a27bd8a", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/3df5d35675eed9bcf9f9f09ef73a817f8a27bd8a", "committedDate": "2020-03-02T14:24:02Z", "message": "Removed one test which is not valuable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3MzM5MTMw", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-367339130", "createdAt": "2020-03-02T16:27:44Z", "commit": {"oid": "3df5d35675eed9bcf9f9f09ef73a817f8a27bd8a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db154be0ce460c6f05958bb017e8b76ade1c4c9c", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/db154be0ce460c6f05958bb017e8b76ade1c4c9c", "committedDate": "2020-02-05T15:11:22Z", "message": "Naming improvements"}, "afterCommit": {"oid": "1f9fa1685f8adfd9cfb1ba2ad8d9a11a3b90a8c1", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/1f9fa1685f8adfd9cfb1ba2ad8d9a11a3b90a8c1", "committedDate": "2020-02-06T14:00:27Z", "message": "Added StorageMigratorTask"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f9fa1685f8adfd9cfb1ba2ad8d9a11a3b90a8c1", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/1f9fa1685f8adfd9cfb1ba2ad8d9a11a3b90a8c1", "committedDate": "2020-02-06T14:00:27Z", "message": "Added StorageMigratorTask"}, "afterCommit": {"oid": "02de4c2a350497e55e4a94ef5f63ceae7881caa6", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/02de4c2a350497e55e4a94ef5f63ceae7881caa6", "committedDate": "2020-02-06T14:09:43Z", "message": "Added StorageMigratorTask"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02de4c2a350497e55e4a94ef5f63ceae7881caa6", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/02de4c2a350497e55e4a94ef5f63ceae7881caa6", "committedDate": "2020-02-06T14:09:43Z", "message": "Added StorageMigratorTask"}, "afterCommit": {"oid": "7ccb37aaabd3f90e604aa96add99ec57eeb8e2a6", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/7ccb37aaabd3f90e604aa96add99ec57eeb8e2a6", "committedDate": "2020-02-06T14:16:41Z", "message": "Added StorageMigratorTask"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NjE3NzQ2", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-354617746", "createdAt": "2020-02-06T17:02:10Z", "commit": {"oid": "7ccb37aaabd3f90e604aa96add99ec57eeb8e2a6"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNzowMjoxMFrOFmi6Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNzo0MDowMFrOFmkJ3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk2MjE1MA==", "bodyText": "I like that this is pulled out as its own object! I think you could pass the StoragePathProvider in as a constructor arg rather than have it passed in to both methods as it feels like a dependency.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r375962150", "createdAt": "2020-02-06T17:02:10Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/storage/StorageEraser.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package org.odk.collect.android.storage;\n+\n+import java.io.File;\n+\n+class StorageEraser {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ccb37aaabd3f90e604aa96add99ec57eeb8e2a6"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk2Mjg4OQ==", "bodyText": "Big fan of this returning an enum/result object for each case \ud83d\udc4d", "url": "https://github.com/getodk/collect/pull/3623#discussion_r375962889", "createdAt": "2020-02-06T17:03:23Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/storage/StorageMigrator.java", "diffHunk": "@@ -0,0 +1,201 @@\n+package org.odk.collect.android.storage;\n+\n+import android.content.ContentValues;\n+import android.database.Cursor;\n+\n+import androidx.lifecycle.LiveData;\n+import androidx.work.WorkInfo;\n+import androidx.work.WorkManager;\n+\n+import org.apache.commons.io.FileUtils;\n+import org.odk.collect.android.dao.FormsDao;\n+import org.odk.collect.android.dao.InstancesDao;\n+import org.odk.collect.android.dao.ItemsetDao;\n+import org.odk.collect.android.database.ItemsetDbAdapter;\n+import org.odk.collect.android.forms.Form;\n+import org.odk.collect.android.instances.Instance;\n+import org.odk.collect.android.itemsets.Itemset;\n+import org.odk.collect.android.provider.FormsProvider;\n+import org.odk.collect.android.provider.InstanceProvider;\n+import org.odk.collect.android.tasks.ServerPollingJob;\n+import org.odk.collect.android.upload.AutoSendWorker;\n+\n+import java.io.File;\n+import java.util.List;\n+\n+import timber.log.Timber;\n+\n+import static android.provider.BaseColumns._ID;\n+import static org.odk.collect.android.database.ItemsetDbAdapter.KEY_PATH;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.FORM_FILE_PATH;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.FORM_MEDIA_PATH;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.JRCACHE_FILE_PATH;\n+import static org.odk.collect.android.provider.InstanceProviderAPI.InstanceColumns.INSTANCE_FILE_PATH;\n+\n+public class StorageMigrator {\n+\n+    private StoragePathProvider storagePathProvider;\n+    private StorageStateProvider storageStateProvider;\n+    private StorageEraser storageEraser;\n+\n+    public static boolean isMigrationBeingPerformed;\n+\n+    public StorageMigrator() {\n+        this(new StoragePathProvider(), new StorageStateProvider(), new StorageEraser());\n+    }\n+\n+    private StorageMigrator(StoragePathProvider storagePathProvider, StorageStateProvider storageStateProvider, StorageEraser storageEraser) {\n+        this.storagePathProvider = storagePathProvider;\n+        this.storageStateProvider = storageStateProvider;\n+        this.storageEraser = storageEraser;\n+    }\n+\n+    StorageMigrationResult performStorageMigration() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ccb37aaabd3f90e604aa96add99ec57eeb8e2a6"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MDQyOA==", "bodyText": "I think it would be nice to have the execution encapsulated in a ViewModel. An example of this would be how FormSaveViewModel#saveForm works. Something like this for the ViewModel:\nclass StorageMigrationViewModel {\n    public LiveData<StorageMigratorResult> migrate() {\n        MutableLiveData<StorageMigratorResult> result = new MutableLiveData<>();\n        new StorageMigratorTask((migratorResult) -> result.setValue(migratorResult)).execute();\n        return result;\n    }\n}\nYou'll see an example of a task with a listener like this in FormSaveViewModel.\nIn can then deal with the dialog/errors in the Activity:\nstorageMigrationViewModel.migrate().observe(this, (result) -> {\n    if (result != null) {\n        // handle result\n    }\n});\nSomething like that lets us seperate out our UI logic from the migration logic and lets us avoid using WeakReference or worrying about AsyncTask memory leaks. Totally up for discussing if that approach doesn't feel right but it'd be nice for us to find a pattern we like for this kind of thing.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r375980428", "createdAt": "2020-02-06T17:35:53Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/MainMenuActivity.java", "diffHunk": "@@ -640,4 +643,14 @@ private void disableSmsIfNeeded() {\n                     .show();\n         }\n     }\n+\n+    private void setStorageMigrationBannerVisibility() {\n+        if (!new StorageStateProvider().isScopedStorageUsed()) {\n+            findViewById(R.id.storage_migration_banner).setVisibility(View.VISIBLE);\n+        }\n+    }\n+\n+    public void learnMoreAndMigrate(View view) {\n+        new StorageMigratorTask(this).execute();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ccb37aaabd3f90e604aa96add99ec57eeb8e2a6"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MTM2MQ==", "bodyText": "What are you thinking for tests for this? Feels to me like testing the StorageMigrator in a all the possible scenarios (each result) and then maybe an Espresso test for the \"happy case\" (where everything goes right)?", "url": "https://github.com/getodk/collect/pull/3623#discussion_r375981361", "createdAt": "2020-02-06T17:37:36Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/storage/StorageMigrator.java", "diffHunk": "@@ -0,0 +1,201 @@\n+package org.odk.collect.android.storage;\n+\n+import android.content.ContentValues;\n+import android.database.Cursor;\n+\n+import androidx.lifecycle.LiveData;\n+import androidx.work.WorkInfo;\n+import androidx.work.WorkManager;\n+\n+import org.apache.commons.io.FileUtils;\n+import org.odk.collect.android.dao.FormsDao;\n+import org.odk.collect.android.dao.InstancesDao;\n+import org.odk.collect.android.dao.ItemsetDao;\n+import org.odk.collect.android.database.ItemsetDbAdapter;\n+import org.odk.collect.android.forms.Form;\n+import org.odk.collect.android.instances.Instance;\n+import org.odk.collect.android.itemsets.Itemset;\n+import org.odk.collect.android.provider.FormsProvider;\n+import org.odk.collect.android.provider.InstanceProvider;\n+import org.odk.collect.android.tasks.ServerPollingJob;\n+import org.odk.collect.android.upload.AutoSendWorker;\n+\n+import java.io.File;\n+import java.util.List;\n+\n+import timber.log.Timber;\n+\n+import static android.provider.BaseColumns._ID;\n+import static org.odk.collect.android.database.ItemsetDbAdapter.KEY_PATH;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.FORM_FILE_PATH;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.FORM_MEDIA_PATH;\n+import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.JRCACHE_FILE_PATH;\n+import static org.odk.collect.android.provider.InstanceProviderAPI.InstanceColumns.INSTANCE_FILE_PATH;\n+\n+public class StorageMigrator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ccb37aaabd3f90e604aa96add99ec57eeb8e2a6"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MjU1OQ==", "bodyText": "It would be cool to pull this out as a MaterialBanner component but I think we can do that another time. I can look at doing thta in a similar way as we did for the MaterialFullScreenDialog.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r375982559", "createdAt": "2020-02-06T17:40:00Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/res/layout/storage_migration_banner.xml", "diffHunk": "@@ -0,0 +1,45 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\"?>\n+<LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ccb37aaabd3f90e604aa96add99ec57eeb8e2a6"}, "originalPosition": 2}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ccb37aaabd3f90e604aa96add99ec57eeb8e2a6", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/7ccb37aaabd3f90e604aa96add99ec57eeb8e2a6", "committedDate": "2020-02-06T14:16:41Z", "message": "Added StorageMigratorTask"}, "afterCommit": {"oid": "97d7fe364b273c029e11fd0ff55c461b31f4eba6", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/97d7fe364b273c029e11fd0ff55c461b31f4eba6", "committedDate": "2020-02-07T12:03:07Z", "message": "Moved classes responsible for migation to one dir"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b23ad9b3e5e1c072780d2bef621318a905f7947e", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/b23ad9b3e5e1c072780d2bef621318a905f7947e", "committedDate": "2020-02-11T14:56:13Z", "message": "Replace AsyncTask with Service"}, "afterCommit": {"oid": "62cc09991827ebe2b5a671a4b780113f9c4b4655", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/62cc09991827ebe2b5a671a4b780113f9c4b4655", "committedDate": "2020-02-11T14:57:44Z", "message": "Replace AsyncTask with Service"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "62cc09991827ebe2b5a671a4b780113f9c4b4655", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/62cc09991827ebe2b5a671a4b780113f9c4b4655", "committedDate": "2020-02-11T14:57:44Z", "message": "Replace AsyncTask with Service"}, "afterCommit": {"oid": "1500526aee46a3dbb83fb3d6c9f6d1fd3ae8006a", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/1500526aee46a3dbb83fb3d6c9f6d1fd3ae8006a", "committedDate": "2020-02-11T15:16:03Z", "message": "Gray out the messgage after starting migration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f883f1e2904cc3a0c191d8bbbd3d38e5b6a3a62a", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f883f1e2904cc3a0c191d8bbbd3d38e5b6a3a62a", "committedDate": "2020-02-11T15:23:14Z", "message": "Removed unused string"}, "afterCommit": {"oid": "0e141054594c4c079b5151ea14f67f7ca3684803", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/0e141054594c4c079b5151ea14f67f7ca3684803", "committedDate": "2020-02-11T15:45:29Z", "message": "Removed unused string"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MjYyNDM4", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-357262438", "createdAt": "2020-02-12T08:29:49Z", "commit": {"oid": "0e141054594c4c079b5151ea14f67f7ca3684803"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwODoyOTo0OVrOFolbhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwODoyOTo0OVrOFolbhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEwMDYxMw==", "bodyText": "I think we should be using an IntentService here (https://developer.android.com/guide/components/services#ExtendingIntentService). I've usually used them in the past as they take care of creating a worker threads and also protect us from multiple requests being exectued simultaneously etc. This would potentially mean the service could take care of the lock in StorageMigrator (.isMigrationBeingPerformed). Also if we do use a plain ol' service I think it needs to call stopSelf() when we're done executing - again an IntentService just takes care of that for us.\nSorry if this is research you already did and made the decision for some reason I'm missing!", "url": "https://github.com/getodk/collect/pull/3623#discussion_r378100613", "createdAt": "2020-02-12T08:29:49Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/storage/migration/StorageMigrationService.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package org.odk.collect.android.storage.migration;\n+\n+import android.content.Intent;\n+\n+import androidx.lifecycle.LifecycleService;\n+import androidx.localbroadcastmanager.content.LocalBroadcastManager;\n+\n+import org.jetbrains.annotations.NotNull;\n+import org.odk.collect.android.storage.StoragePathProvider;\n+import org.odk.collect.android.storage.StorageStateProvider;\n+\n+public class StorageMigrationService extends LifecycleService {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e141054594c4c079b5151ea14f67f7ca3684803"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MjczMDUz", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-357273053", "createdAt": "2020-02-12T08:48:05Z", "commit": {"oid": "0e141054594c4c079b5151ea14f67f7ca3684803"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwODo0ODowNVrOFol8OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwODo0ODowNVrOFol8OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEwODk4NQ==", "bodyText": "You should be able to use the MaterialFullScreenDialogFragment for this I think", "url": "https://github.com/getodk/collect/pull/3623#discussion_r378108985", "createdAt": "2020-02-12T08:48:05Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/storage/migration/StorageMigrationDialog.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package org.odk.collect.android.storage.migration;\n+\n+import android.app.Activity;\n+import android.content.Intent;\n+import android.os.Bundle;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n+import android.widget.Button;\n+import android.widget.TextView;\n+\n+import androidx.annotation.Nullable;\n+import androidx.appcompat.widget.Toolbar;\n+import androidx.fragment.app.DialogFragment;\n+\n+import org.jetbrains.annotations.NotNull;\n+import org.odk.collect.android.R;\n+\n+public class StorageMigrationDialog extends DialogFragment {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e141054594c4c079b5151ea14f67f7ca3684803"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MjgwMjEw", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-357280210", "createdAt": "2020-02-12T08:59:27Z", "commit": {"oid": "0e141054594c4c079b5151ea14f67f7ca3684803"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwODo1OToyN1rOFomSTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwODo1OToyN1rOFomSTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODExNDYzNg==", "bodyText": "I think we need to break this object up a bit so we're not having to fake/mock methods on the object under test. It looks like you've had to do this because of a bunch of static methods though. Maybe using a similar strategy to the BackgroundLocationHelper that @lognaturel created? This worked at the time as it allowed her to wrap a bunch of static methods/singletons that the new object she was build needed without having to go and refactor/unwrap all of them. This interface could also include isFormUploaderRunning() and isFormDownloaderRunning().", "url": "https://github.com/getodk/collect/pull/3623#discussion_r378114636", "createdAt": "2020-02-12T08:59:27Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/storage/migration/StorageMigratorTest.java", "diffHunk": "@@ -0,0 +1,163 @@\n+package org.odk.collect.android.storage.migration;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.odk.collect.android.storage.StoragePathProvider;\n+import org.odk.collect.android.storage.StorageStateProvider;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+import static org.mockito.Mockito.doNothing;\n+import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.spy;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+\n+public class StorageMigratorTest {\n+\n+    private StorageMigrator storageMigrator;\n+    private StorageEraser storageEraser;\n+    private final StoragePathProvider storagePathProvider = spy(StoragePathProvider.class);\n+    private final StorageStateProvider storageStateProvider = mock(StorageStateProvider.class);\n+\n+    @Before\n+    public void setup() {\n+        storageEraser = spy(new StorageEraser(storagePathProvider));\n+        storageMigrator = spy(new StorageMigrator(storagePathProvider, storageStateProvider, storageEraser));\n+\n+        doNothing().when(storageMigrator).reopenDatabases();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e141054594c4c079b5151ea14f67f7ca3684803"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MjgxMDQ2", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-357281046", "createdAt": "2020-02-12T09:00:46Z", "commit": {"oid": "0e141054594c4c079b5151ea14f67f7ca3684803"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTowMDo0NlrOFomU7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTowMDo0NlrOFomU7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODExNTMwOA==", "bodyText": "Can this just be a mock rather than a spy? Personally I find spies make tests harder to read and understand as the boundaries of the test (i.e. what is faked/stubbed) become unclear.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r378115308", "createdAt": "2020-02-12T09:00:46Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/storage/migration/StorageMigratorTest.java", "diffHunk": "@@ -0,0 +1,163 @@\n+package org.odk.collect.android.storage.migration;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.odk.collect.android.storage.StoragePathProvider;\n+import org.odk.collect.android.storage.StorageStateProvider;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+import static org.mockito.Mockito.doNothing;\n+import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.spy;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+\n+public class StorageMigratorTest {\n+\n+    private StorageMigrator storageMigrator;\n+    private StorageEraser storageEraser;\n+    private final StoragePathProvider storagePathProvider = spy(StoragePathProvider.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e141054594c4c079b5151ea14f67f7ca3684803"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MjgyMDM0", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-357282034", "createdAt": "2020-02-12T09:02:17Z", "commit": {"oid": "0e141054594c4c079b5151ea14f67f7ca3684803"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTowMjoxN1rOFomYKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTowMjoxN1rOFomYKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODExNjEzOQ==", "bodyText": "Again would be nice for this to be a mock/fake rather than a spy.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r378116139", "createdAt": "2020-02-12T09:02:17Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/storage/migration/StorageMigratorTest.java", "diffHunk": "@@ -0,0 +1,163 @@\n+package org.odk.collect.android.storage.migration;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.odk.collect.android.storage.StoragePathProvider;\n+import org.odk.collect.android.storage.StorageStateProvider;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+import static org.mockito.Mockito.doNothing;\n+import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.spy;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+\n+public class StorageMigratorTest {\n+\n+    private StorageMigrator storageMigrator;\n+    private StorageEraser storageEraser;\n+    private final StoragePathProvider storagePathProvider = spy(StoragePathProvider.class);\n+    private final StorageStateProvider storageStateProvider = mock(StorageStateProvider.class);\n+\n+    @Before\n+    public void setup() {\n+        storageEraser = spy(new StorageEraser(storagePathProvider));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e141054594c4c079b5151ea14f67f7ca3684803"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "28b370d685ad010ba0c33b04d8e25f45419fe10d", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/28b370d685ad010ba0c33b04d8e25f45419fe10d", "committedDate": "2020-02-12T14:39:06Z", "message": "Use Livedata instead of brodcast recivers"}, "afterCommit": {"oid": "de4a297917d1b8b7ac2eae0018a8567d74fd4486", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/de4a297917d1b8b7ac2eae0018a8567d74fd4486", "committedDate": "2020-02-12T14:40:09Z", "message": "Use Livedata instead of broadcast receivers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de4a297917d1b8b7ac2eae0018a8567d74fd4486", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/de4a297917d1b8b7ac2eae0018a8567d74fd4486", "committedDate": "2020-02-12T14:40:09Z", "message": "Use Livedata instead of broadcast receivers"}, "afterCommit": {"oid": "abbeb518d0a93a2a38f9697259333101d8620866", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/abbeb518d0a93a2a38f9697259333101d8620866", "committedDate": "2020-02-12T14:45:10Z", "message": "Use Livedata instead of broadcast receivers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "abbeb518d0a93a2a38f9697259333101d8620866", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/abbeb518d0a93a2a38f9697259333101d8620866", "committedDate": "2020-02-12T14:45:10Z", "message": "Use Livedata instead of broadcast receivers"}, "afterCommit": {"oid": "bd3ea6cccfde37848601cc639945cc4f25bb6549", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/bd3ea6cccfde37848601cc639945cc4f25bb6549", "committedDate": "2020-02-12T14:48:25Z", "message": "Use Livedata instead of broadcast receivers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd3ea6cccfde37848601cc639945cc4f25bb6549", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/bd3ea6cccfde37848601cc639945cc4f25bb6549", "committedDate": "2020-02-12T14:48:25Z", "message": "Use Livedata instead of broadcast receivers"}, "afterCommit": {"oid": "0ad9d8c9e1d36fe18889aa6032d3db20cd0b4c85", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/0ad9d8c9e1d36fe18889aa6032d3db20cd0b4c85", "committedDate": "2020-02-12T14:51:07Z", "message": "Use Livedata instead of broadcast receivers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NTc2MjU2", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-357576256", "createdAt": "2020-02-12T16:02:05Z", "commit": {"oid": "0ad9d8c9e1d36fe18889aa6032d3db20cd0b4c85"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNjowMjowNVrOFo0fdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNjowMjowNVrOFo0fdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM0NzM4Mg==", "bodyText": "Oh wow was this making it pop open the keyboard even though there aren't any fields? That's annoying. Feel free to reverse it so the default is false and the other dialogs override.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r378347382", "createdAt": "2020-02-12T16:02:05Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/material/MaterialFullScreenDialogFragment.java", "diffHunk": "@@ -39,8 +39,10 @@ public void onStart() {\n             int height = ViewGroup.LayoutParams.MATCH_PARENT;\n             dialog.getWindow().setLayout(width, height);\n \n-            // Make sure soft keyboard shows for focused field - annoyingly needed\n-            dialog.getWindow().setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_STATE_ALWAYS_VISIBLE);\n+            if (shouldShowSoftKeyboard()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ad9d8c9e1d36fe18889aa6032d3db20cd0b4c85"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ad9d8c9e1d36fe18889aa6032d3db20cd0b4c85", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/0ad9d8c9e1d36fe18889aa6032d3db20cd0b4c85", "committedDate": "2020-02-12T14:51:07Z", "message": "Use Livedata instead of broadcast receivers"}, "afterCommit": {"oid": "dcc8858054effc1658c7fd6c93336794057921eb", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/dcc8858054effc1658c7fd6c93336794057921eb", "committedDate": "2020-02-13T10:08:57Z", "message": "Use Livedata instead of broadcast receivers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b91d3f69f999cdb2c90554be765002410b81dde", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/7b91d3f69f999cdb2c90554be765002410b81dde", "committedDate": "2020-02-13T12:24:58Z", "message": "Code improvements"}, "afterCommit": {"oid": "c648963c21bc00901ebce412c99ce83758185404", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/c648963c21bc00901ebce412c99ce83758185404", "committedDate": "2020-02-13T12:46:05Z", "message": "Code improvements"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c648963c21bc00901ebce412c99ce83758185404", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/c648963c21bc00901ebce412c99ce83758185404", "committedDate": "2020-02-13T12:46:05Z", "message": "Code improvements"}, "afterCommit": {"oid": "5caad54c54b2ff94111e7edf5fd4c99566104dc1", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/5caad54c54b2ff94111e7edf5fd4c99566104dc1", "committedDate": "2020-02-13T12:48:51Z", "message": "Code improvements"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5caad54c54b2ff94111e7edf5fd4c99566104dc1", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/5caad54c54b2ff94111e7edf5fd4c99566104dc1", "committedDate": "2020-02-13T12:48:51Z", "message": "Code improvements"}, "afterCommit": {"oid": "ee4950f919a3c52ce845b1ebd2d445b7440a7249", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/ee4950f919a3c52ce845b1ebd2d445b7440a7249", "committedDate": "2020-02-13T12:52:48Z", "message": "Code improvements"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee4950f919a3c52ce845b1ebd2d445b7440a7249", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/ee4950f919a3c52ce845b1ebd2d445b7440a7249", "committedDate": "2020-02-13T12:52:48Z", "message": "Code improvements"}, "afterCommit": {"oid": "a39b50ca8ce1004dbb524e23d861052f2ba83918", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/a39b50ca8ce1004dbb524e23d861052f2ba83918", "committedDate": "2020-02-13T13:09:47Z", "message": "Code improvements"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a39b50ca8ce1004dbb524e23d861052f2ba83918", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/a39b50ca8ce1004dbb524e23d861052f2ba83918", "committedDate": "2020-02-13T13:09:47Z", "message": "Code improvements"}, "afterCommit": {"oid": "faa160541062d8bf23fc55ff1a296e1bf2b6dc2a", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/faa160541062d8bf23fc55ff1a296e1bf2b6dc2a", "committedDate": "2020-02-13T13:10:48Z", "message": "Code improvements"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "faa160541062d8bf23fc55ff1a296e1bf2b6dc2a", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/faa160541062d8bf23fc55ff1a296e1bf2b6dc2a", "committedDate": "2020-02-13T13:10:48Z", "message": "Code improvements"}, "afterCommit": {"oid": "a1eadb0a3388f7b0fd3a0a46285d77a54b356a90", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/a1eadb0a3388f7b0fd3a0a46285d77a54b356a90", "committedDate": "2020-02-13T13:12:53Z", "message": "Code improvements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NzA4OTYw", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-358708960", "createdAt": "2020-02-14T04:39:48Z", "commit": {"oid": "a1eadb0a3388f7b0fd3a0a46285d77a54b356a90"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwNDozOTo0OFrOFprdoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwNDozOTo0OFrOFprdoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTI0ODAzMw==", "bodyText": "Migartion -> Migration", "url": "https://github.com/getodk/collect/pull/3623#discussion_r379248033", "createdAt": "2020-02-14T04:39:48Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/storage/StorageStateProvider.java", "diffHunk": "@@ -1,21 +1,78 @@\n package org.odk.collect.android.storage;\n \n+import android.os.Build;\n import android.os.Environment;\n+import android.os.StatFs;\n \n import org.odk.collect.android.preferences.GeneralSharedPreferences;\n \n+import java.io.File;\n+\n+import timber.log.Timber;\n+\n import static org.odk.collect.android.preferences.GeneralKeys.KEY_SCOPED_STORAGE_USED;\n \n public class StorageStateProvider {\n-    boolean isScopedStorageUsed() {\n+\n+    public boolean isScopedStorageUsed() {\n         return GeneralSharedPreferences.getInstance().getBoolean(KEY_SCOPED_STORAGE_USED, false);\n     }\n \n-    public void recordMigrationToScopedStorage() {\n+    public void enableUsingScopedStorage() {\n         GeneralSharedPreferences.getInstance().save(KEY_SCOPED_STORAGE_USED, true);\n     }\n \n+    public void disableUsingScopedStorage() {\n+        GeneralSharedPreferences.getInstance().save(KEY_SCOPED_STORAGE_USED, false);\n+    }\n+\n     boolean isStorageMounted() {\n         return Environment.getExternalStorageState().equals(Environment.MEDIA_MOUNTED);\n     }\n+\n+    public boolean isEnoughSpaceToPerformMigartion(StoragePathProvider storagePathProvider) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1eadb0a3388f7b0fd3a0a46285d77a54b356a90"}, "originalPosition": 35}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4449cbfd90a265ef28cadcbac7855fb97f5bcebb", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/4449cbfd90a265ef28cadcbac7855fb97f5bcebb", "committedDate": "2020-02-14T10:17:09Z", "message": "Code improvemenets"}, "afterCommit": {"oid": "513d3cfed7784daf868d8eac1835ac41cedf4308", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/513d3cfed7784daf868d8eac1835ac41cedf4308", "committedDate": "2020-02-14T10:47:04Z", "message": "Code improvemenets"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "513d3cfed7784daf868d8eac1835ac41cedf4308", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/513d3cfed7784daf868d8eac1835ac41cedf4308", "committedDate": "2020-02-14T10:47:04Z", "message": "Code improvemenets"}, "afterCommit": {"oid": "4786e5177334eafdd28a262e5c3a236923713beb", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/4786e5177334eafdd28a262e5c3a236923713beb", "committedDate": "2020-02-14T10:54:45Z", "message": "Code improvemenets"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMDczMzYx", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-360073361", "createdAt": "2020-02-18T05:06:34Z", "commit": {"oid": "40c0f954e3f227b5f58a28a0255f46c60b3f7d68"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwNTowNjozNFrOFq1QFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwNTowODoyNFrOFq1RaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ1Njk4MQ==", "bodyText": "Interesting! Does this mean that the getValuesFromInstanceObject method wasn't used in that context before?", "url": "https://github.com/getodk/collect/pull/3623#discussion_r380456981", "createdAt": "2020-02-18T05:06:34Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/dao/InstancesDao.java", "diffHunk": "@@ -363,9 +363,8 @@ public ContentValues getValuesFromInstanceObject(Instance instance) {\n         values.put(InstanceColumns.STATUS, instance.getStatus());\n         values.put(InstanceColumns.LAST_STATUS_CHANGE_DATE, instance.getLastStatusChangeDate());\n         values.put(InstanceColumns.DELETED_DATE, instance.getDeletedDate());\n+        values.put(InstanceColumns.GEOMETRY, instance.getGeometry());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40c0f954e3f227b5f58a28a0255f46c60b3f7d68"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ1NzMyMQ==", "bodyText": "Is your thinking that this test prevents someone accidentally removing one of the db fields from the method? Is this likely? It seems like it doesn't help prevent the kind of problem we saw here -- a new db field not being represented in the method.\nDoes it have to be a connected test? Seems it could be Robolectric-based?", "url": "https://github.com/getodk/collect/pull/3623#discussion_r380457321", "createdAt": "2020-02-18T05:08:24Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/dao/InstancesDaoTest.java", "diffHunk": "@@ -195,6 +196,35 @@ public void updateInstanceTest() {\n         assertThat(formWithGeopointInstance.getGeometry(), is(nullValue()));\n     }\n \n+    @Test\n+    public void getValuesFromInstanceObjectTest() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40c0f954e3f227b5f58a28a0255f46c60b3f7d68"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6bae3c2c4b89e1066911540762e4e1a4f2fbb3a5", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/6bae3c2c4b89e1066911540762e4e1a4f2fbb3a5", "committedDate": "2020-02-18T10:32:21Z", "message": "Use the banner to display migration results"}, "afterCommit": {"oid": "d4c1d90bf376d2f30ff5d5c299663f3336ca1d09", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/d4c1d90bf376d2f30ff5d5c299663f3336ca1d09", "committedDate": "2020-02-18T10:58:29Z", "message": "Use the banner to display migration results"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4c1d90bf376d2f30ff5d5c299663f3336ca1d09", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/d4c1d90bf376d2f30ff5d5c299663f3336ca1d09", "committedDate": "2020-02-18T10:58:29Z", "message": "Use the banner to display migration results"}, "afterCommit": {"oid": "a194594b3806c96cce6c5f2ddf456a6343a9512f", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/a194594b3806c96cce6c5f2ddf456a6343a9512f", "committedDate": "2020-02-18T11:09:28Z", "message": "Use the banner to display migration results"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10bb88dd0de5ca6558cd746cd054fb9b28e61b53", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/10bb88dd0de5ca6558cd746cd054fb9b28e61b53", "committedDate": "2020-02-19T15:21:19Z", "message": "Get rid of additional odk dir on scoped storage"}, "afterCommit": {"oid": "d2373fd5376e36350669a17d2d78760edac60da7", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/d2373fd5376e36350669a17d2d78760edac60da7", "committedDate": "2020-02-19T23:46:08Z", "message": "Fixed buttons visiblility in the banner"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxMzQyNDY4", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-361342468", "createdAt": "2020-02-19T18:43:30Z", "commit": {"oid": "10bb88dd0de5ca6558cd746cd054fb9b28e61b53"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxODo0MzozMFrOFrzHrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxOTo1MToxMVrOFr1XBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ3MDYzOQ==", "bodyText": "Do you really need this? Like the failure message, the success message feels transient. So I think it's good for it to keep existing while someone is in a single \"app session\" but I don't think it still needs to be shown if the user closes and then reopens the app. That is, Collect going out of memory would implicitly dismiss the dialog.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r381470639", "createdAt": "2020-02-19T18:43:30Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/preferences/GeneralKeys.java", "diffHunk": "@@ -146,7 +148,8 @@\n             KEY_METADATA_MIGRATED,\n             KEY_AUTOSEND_WIFI,\n             KEY_AUTOSEND_NETWORK,\n-            KEY_SCOPED_STORAGE_USED\n+            KEY_SCOPED_STORAGE_USED,\n+            KEY_SCOPED_STORAGE_BANNER_DISMISSED", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10bb88dd0de5ca6558cd746cd054fb9b28e61b53"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ3MzU1NQ==", "bodyText": "I think you can pre-emptively go ahead and remove this one since we're sure we're changing the minSdk in this release.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r381473555", "createdAt": "2020-02-19T18:48:55Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/storage/StorageStateProvider.java", "diffHunk": "@@ -1,21 +1,78 @@\n package org.odk.collect.android.storage;\n \n+import android.os.Build;\n import android.os.Environment;\n+import android.os.StatFs;\n \n import org.odk.collect.android.preferences.GeneralSharedPreferences;\n \n+import java.io.File;\n+\n+import timber.log.Timber;\n+\n import static org.odk.collect.android.preferences.GeneralKeys.KEY_SCOPED_STORAGE_USED;\n \n public class StorageStateProvider {\n-    boolean isScopedStorageUsed() {\n+\n+    public boolean isScopedStorageUsed() {\n         return GeneralSharedPreferences.getInstance().getBoolean(KEY_SCOPED_STORAGE_USED, false);\n     }\n \n-    public void recordMigrationToScopedStorage() {\n+    public void enableUsingScopedStorage() {\n         GeneralSharedPreferences.getInstance().save(KEY_SCOPED_STORAGE_USED, true);\n     }\n \n+    public void disableUsingScopedStorage() {\n+        GeneralSharedPreferences.getInstance().save(KEY_SCOPED_STORAGE_USED, false);\n+    }\n+\n     boolean isStorageMounted() {\n         return Environment.getExternalStorageState().equals(Environment.MEDIA_MOUNTED);\n     }\n+\n+    public boolean isEnoughSpaceToPerformMigration(StoragePathProvider storagePathProvider) {\n+        try {\n+            return getAvailableScopedStorageSize(storagePathProvider) > getOdkDirSize(storagePathProvider);\n+        } catch (Exception | Error e) {\n+            Timber.w(e);\n+            return false;\n+        }\n+    }\n+\n+    private long getAvailableScopedStorageSize(StoragePathProvider storagePathProvider) {\n+        String scopedStoragePath = storagePathProvider.getScopedExternalFilesDirPath();\n+        if (scopedStoragePath.isEmpty()) {\n+            return 0;\n+        }\n+\n+        StatFs stat = new StatFs(scopedStoragePath);\n+        long blockSize;\n+        long availableBlocks;\n+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN_MR2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10bb88dd0de5ca6558cd746cd054fb9b28e61b53"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ3NDM0OA==", "bodyText": "I think we'll introduce a more user-facing post but this is a great placeholder for now.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r381474348", "createdAt": "2020-02-19T18:50:23Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/storage/migration/StorageMigrationDialog.java", "diffHunk": "@@ -0,0 +1,128 @@\n+package org.odk.collect.android.storage.migration;\n+\n+import android.app.Activity;\n+import android.content.Intent;\n+import android.os.Bundle;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n+import android.widget.Button;\n+import android.widget.LinearLayout;\n+import android.widget.TextView;\n+\n+import org.jetbrains.annotations.NotNull;\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.WebViewActivity;\n+import org.odk.collect.android.material.MaterialFullScreenDialogFragment;\n+\n+import butterknife.BindView;\n+import butterknife.ButterKnife;\n+\n+public class StorageMigrationDialog extends MaterialFullScreenDialogFragment {\n+\n+    private final int unsentInstancesNumber;\n+\n+    @BindView(R.id.cancelButton)\n+    Button cancelButton;\n+\n+    @BindView(R.id.migrateButton)\n+    Button migrateButton;\n+\n+    @BindView(R.id.messageText1)\n+    TextView messageText1;\n+\n+    @BindView(R.id.messageText2)\n+    TextView messageText2;\n+\n+    @BindView(R.id.messageText3)\n+    TextView messageText3;\n+\n+    @BindView(R.id.moreDetailsButton)\n+    TextView moreDetailsButton;\n+\n+    @BindView(R.id.progressBar)\n+    LinearLayout progressBar;\n+\n+    public static StorageMigrationDialog create(int unsentInstances) {\n+        return new StorageMigrationDialog(unsentInstances);\n+    }\n+\n+    private StorageMigrationDialog(int unsentInstancesNumber) {\n+        this.unsentInstancesNumber = unsentInstancesNumber;\n+    }\n+\n+    @Override\n+    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {\n+        return inflater.inflate(R.layout.storage_migration_dialog, container, false);\n+    }\n+\n+    @Override\n+    public void onViewCreated(@NotNull View view, Bundle savedInstanceState) {\n+        super.onViewCreated(view, savedInstanceState);\n+        ButterKnife.bind(this, view);\n+\n+        setUpToolbar();\n+        setUpMessageAboutUnsetSubmissions();\n+\n+        moreDetailsButton.setOnClickListener(view1 -> showMoreDetails());\n+        cancelButton.setOnClickListener(v -> dismiss());\n+        migrateButton.setOnClickListener(v -> {\n+            disableDialog();\n+            showProgressBar();\n+            startStorageMigrationService();\n+        });\n+    }\n+\n+    @Override\n+    protected void onCloseClicked() {\n+    }\n+\n+    @Override\n+    protected void onBackPressed() {\n+    }\n+\n+    private void setUpToolbar() {\n+        getToolbar().setTitle(R.string.storage_migration_dialog_title);\n+        getToolbar().setNavigationIcon(null);\n+    }\n+\n+    private void setUpMessageAboutUnsetSubmissions() {\n+        if (unsentInstancesNumber > 0) {\n+            messageText2.setVisibility(View.VISIBLE);\n+            messageText2.setText(getString(R.string.storage_migration_dialog_message2, unsentInstancesNumber));\n+        }\n+    }\n+\n+    private void showMoreDetails() {\n+        Intent intent = new Intent(getContext(), WebViewActivity.class);\n+        intent.putExtra(\"url\", \"https://forum.opendatakit.org/t/24159\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10bb88dd0de5ca6558cd746cd054fb9b28e61b53"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUwNzMzNA==", "bodyText": "\"You have not enough available space\" -> \"You do not have enough space\"\n\"to finish data migration\" -> \"to migrate your data\"\n\"try again later\" -> \"try again\"", "url": "https://github.com/getodk/collect/pull/3623#discussion_r381507334", "createdAt": "2020-02-19T19:51:11Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/res/values/strings.xml", "diffHunk": "@@ -725,4 +725,21 @@\n \n     <string name=\"scoped_storage_banner_text\">You must migrate Collect forms to private storage by August 2020 to comply with Android requirements.</string>\n     <string name=\"scoped_storage_learn_more\">Learn more and migrate</string>\n+    <string name=\"storage_migration_dialog_message1\">Android requirements have changed and files used by Collect must be migrated by August 2020.</string>\n+    <string name=\"storage_migration_dialog_message2\">You have %d unsent submissions. You are encouraged to submit all data before migrating.</string>\n+    <string name=\"storage_migration_dialog_message3\">If you use an external application integration such as OpenMapKit, please do not migrate yet.</string>\n+    <string name=\"storage_migration_more_details\">More details</string>\n+\n+\n+\n+    <string name=\"storage_migration_not_enough_space\">You have not enough available space on your internal storage to finish data migration. Please free up some space and try again later.</string>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10bb88dd0de5ca6558cd746cd054fb9b28e61b53"}, "originalPosition": 11}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b7ef130ab6b70477fcba7b7c69b94201ae8c6ea", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/7b7ef130ab6b70477fcba7b7c69b94201ae8c6ea", "committedDate": "2020-02-20T12:53:05Z", "message": "get rid of additional odk dir on scoped storage"}, "afterCommit": {"oid": "ff46be76e57131f524b0dbf3085856b6671235e5", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/ff46be76e57131f524b0dbf3085856b6671235e5", "committedDate": "2020-02-20T13:08:22Z", "message": "Get rid of additional odk dir on scoped storage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxOTI1MTY4", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-361925168", "createdAt": "2020-02-20T14:05:01Z", "commit": {"oid": "531b1366db726f7624e43f2572a76b7ada4b5ef3"}, "state": "DISMISSED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNDowNTowMlrOFsUiFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNTowNToyN1rOFsW7NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAxODA3MA==", "bodyText": "I'm missing why we need this. Is there any problem in just keeping the result?", "url": "https://github.com/getodk/collect/pull/3623#discussion_r382018070", "createdAt": "2020-02-20T14:05:02Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/storage/migration/StorageMigrationRepository.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package org.odk.collect.android.storage.migration;\n+\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+\n+public class StorageMigrationRepository {\n+    private MutableLiveData<StorageMigrationResult> migrationResult = new MutableLiveData<>();\n+\n+    private boolean isMigrationBeingPerformed;\n+\n+    public LiveData<StorageMigrationResult> getResult() {\n+        return migrationResult;\n+    }\n+\n+    public void setResult(StorageMigrationResult storageMigrationResult) {\n+        migrationResult.postValue(storageMigrationResult);\n+    }\n+\n+    public boolean isMigrationBeingPerformed() {\n+        return isMigrationBeingPerformed;\n+    }\n+\n+    void markMigrationStart() {\n+        isMigrationBeingPerformed = true;\n+    }\n+\n+    void markMigrationEnd() {\n+        isMigrationBeingPerformed = false;\n+    }\n+\n+    public void consumeResult() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "531b1366db726f7624e43f2572a76b7ada4b5ef3"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAyNDczNQ==", "bodyText": "Maybe I'm misinterpreting what @lognaturel was getting at before but I don't think we need any state around the banner at all. If the activity is recreated (rotation/out of memory) I think the LiveData observation on the result will take care of continuing to show the dialog (as the result is stored in a singlton). This is assuming we get rid of the consumeResult call.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r382024735", "createdAt": "2020-02-20T14:15:40Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/MainMenuActivity.java", "diffHunk": "@@ -79,9 +84,9 @@\n  * @author Carl Hartung (carlhartung@gmail.com)\n  * @author Yaw Anokwa (yanokwa@gmail.com)\n  */\n-public class MainMenuActivity extends CollectAbstractActivity {\n+public class MainMenuActivity extends CollectAbstractActivity implements AdminPasswordDialog.AdminPasswordDialogListener {\n \n-    private static final int PASSWORD_DIALOG = 1;\n+    private static final String KEEP_BANNER_WITH_SUCCESS_MSG_VISIBLE = \"keepBannerWithSuccessMsgVisible\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "531b1366db726f7624e43f2572a76b7ada4b5ef3"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAyOTEwOQ==", "bodyText": "Could this just use showIfNotShowing instead? and call startStorageMigration on the returned dialog?", "url": "https://github.com/getodk/collect/pull/3623#discussion_r382029109", "createdAt": "2020-02-20T14:22:47Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/MainMenuActivity.java", "diffHunk": "@@ -585,6 +559,26 @@ private boolean loadSharedPreferencesFromFile(File src) {\n         return res;\n     }\n \n+    @Override\n+    public void onCorrectAdminPassword(AdminPasswordDialog.Action action) {\n+        switch (action) {\n+            case ADMIN_SETTINGS:\n+                startActivity(new Intent(this, AdminPreferencesActivity.class));\n+                break;\n+            case STORAGE_MIGRATION:\n+                StorageMigrationDialog storageMigrationDialog = (StorageMigrationDialog) DialogUtils.getDialogFragment(StorageMigrationDialog.class, getSupportFragmentManager());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "531b1366db726f7624e43f2572a76b7ada4b5ef3"}, "originalPosition": 263}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAzMDc1Mg==", "bodyText": "I feel like it might make more sense to use a instanceof check here rather than caching the ClassCastException. This means we don't get warnings if we're using the Fragment in contexts where we're not interested in the listener (tests for instance).", "url": "https://github.com/getodk/collect/pull/3623#discussion_r382030752", "createdAt": "2020-02-20T14:25:29Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/fragments/dialogs/AdminPasswordDialog.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package org.odk.collect.android.fragments.dialogs;\n+\n+import android.app.AlertDialog;\n+import android.app.Dialog;\n+import android.content.Context;\n+import android.os.Bundle;\n+import android.text.InputType;\n+import android.view.View;\n+import android.view.WindowManager;\n+import android.widget.CheckBox;\n+import android.widget.EditText;\n+\n+import androidx.fragment.app.DialogFragment;\n+\n+import org.jetbrains.annotations.NotNull;\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.utilities.AdminPasswordProvider;\n+\n+import timber.log.Timber;\n+\n+public class AdminPasswordDialog extends DialogFragment {\n+\n+    public interface AdminPasswordDialogListener {\n+        void onCorrectAdminPassword(Action action);\n+        void onIncorrectAdminPassword();\n+    }\n+\n+    public enum Action { ADMIN_SETTINGS, STORAGE_MIGRATION }\n+\n+    private AdminPasswordDialogListener listener;\n+\n+    private final Action action;\n+\n+    private final AdminPasswordProvider adminPasswordProvider;\n+\n+    public static AdminPasswordDialog create(AdminPasswordProvider adminPasswordProvider, Action action) {\n+        return new AdminPasswordDialog(adminPasswordProvider, action);\n+    }\n+\n+    private AdminPasswordDialog(AdminPasswordProvider adminPasswordProvider, Action action) {\n+        this.adminPasswordProvider = adminPasswordProvider;\n+        this.action = action;\n+    }\n+\n+    @Override\n+    public void onAttach(@NotNull Context context) {\n+        super.onAttach(context);\n+        try {\n+            listener = (AdminPasswordDialogListener) getActivity();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "531b1366db726f7624e43f2572a76b7ada4b5ef3"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAzODg1Mg==", "bodyText": "I think it would be good for us to start using MaterialButton instead for new views like this. Should mean that you don't have to set textAllCaps.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r382038852", "createdAt": "2020-02-20T14:38:08Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/res/layout/storage_migration_banner.xml", "diffHunk": "@@ -0,0 +1,60 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\"?>\n+<LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n+    android:id=\"@+id/storageMigrationBanner\"\n+    android:orientation=\"vertical\"\n+    android:layout_width=\"match_parent\"\n+    android:layout_height=\"match_parent\"\n+    android:background=\"?colorSurface\"\n+    android:visibility=\"gone\">\n+\n+    <LinearLayout\n+        android:layout_width=\"match_parent\"\n+        android:layout_height=\"wrap_content\"\n+        android:orientation=\"vertical\"\n+        android:paddingStart=\"@dimen/margin_standard\"\n+        android:paddingEnd=\"@dimen/margin_standard\"\n+        android:paddingTop=\"@dimen/margin_standard\">\n+\n+        <TextView\n+            android:id=\"@+id/storageMigrationBannerText\"\n+            android:layout_width=\"match_parent\"\n+            android:layout_height=\"wrap_content\"\n+            android:textColor=\"?colorOnSurface\">\n+        </TextView>\n+\n+        <Button", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "531b1366db726f7624e43f2572a76b7ada4b5ef3"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0MDE5MQ==", "bodyText": "Lets use colorSecondary for this. They're the same but colorSecondary is the \"official\" name: https://material.io/develop/android/theming/color/", "url": "https://github.com/getodk/collect/pull/3623#discussion_r382040191", "createdAt": "2020-02-20T14:40:12Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/res/layout/storage_migration_banner.xml", "diffHunk": "@@ -0,0 +1,60 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\"?>\n+<LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n+    android:id=\"@+id/storageMigrationBanner\"\n+    android:orientation=\"vertical\"\n+    android:layout_width=\"match_parent\"\n+    android:layout_height=\"match_parent\"\n+    android:background=\"?colorSurface\"\n+    android:visibility=\"gone\">\n+\n+    <LinearLayout\n+        android:layout_width=\"match_parent\"\n+        android:layout_height=\"wrap_content\"\n+        android:orientation=\"vertical\"\n+        android:paddingStart=\"@dimen/margin_standard\"\n+        android:paddingEnd=\"@dimen/margin_standard\"\n+        android:paddingTop=\"@dimen/margin_standard\">\n+\n+        <TextView\n+            android:id=\"@+id/storageMigrationBannerText\"\n+            android:layout_width=\"match_parent\"\n+            android:layout_height=\"wrap_content\"\n+            android:textColor=\"?colorOnSurface\">\n+        </TextView>\n+\n+        <Button\n+            android:id=\"@+id/storageMigrationBannerDismissButton\"\n+            style=\"@style/Widget.MaterialComponents.Button.TextButton\"\n+            android:layout_width=\"wrap_content\"\n+            android:layout_height=\"wrap_content\"\n+            android:layout_gravity=\"end\"\n+            android:text=\"@string/scoped_storage_dismiss\"\n+            android:textColor=\"?colorAccent\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "531b1366db726f7624e43f2572a76b7ada4b5ef3"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0NDc2Mg==", "bodyText": "I think we should avoid adding bold and just use the standard style here. If people disagree maybe we should look at changing the button text style (textAppearanceButton) for everything.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r382044762", "createdAt": "2020-02-20T14:46:55Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/res/layout/storage_migration_banner.xml", "diffHunk": "@@ -0,0 +1,60 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\"?>\n+<LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n+    android:id=\"@+id/storageMigrationBanner\"\n+    android:orientation=\"vertical\"\n+    android:layout_width=\"match_parent\"\n+    android:layout_height=\"match_parent\"\n+    android:background=\"?colorSurface\"\n+    android:visibility=\"gone\">\n+\n+    <LinearLayout\n+        android:layout_width=\"match_parent\"\n+        android:layout_height=\"wrap_content\"\n+        android:orientation=\"vertical\"\n+        android:paddingStart=\"@dimen/margin_standard\"\n+        android:paddingEnd=\"@dimen/margin_standard\"\n+        android:paddingTop=\"@dimen/margin_standard\">\n+\n+        <TextView\n+            android:id=\"@+id/storageMigrationBannerText\"\n+            android:layout_width=\"match_parent\"\n+            android:layout_height=\"wrap_content\"\n+            android:textColor=\"?colorOnSurface\">\n+        </TextView>\n+\n+        <Button\n+            android:id=\"@+id/storageMigrationBannerDismissButton\"\n+            style=\"@style/Widget.MaterialComponents.Button.TextButton\"\n+            android:layout_width=\"wrap_content\"\n+            android:layout_height=\"wrap_content\"\n+            android:layout_gravity=\"end\"\n+            android:text=\"@string/scoped_storage_dismiss\"\n+            android:textColor=\"?colorAccent\"\n+            android:paddingTop=\"12dp\"\n+            android:paddingBottom=\"@dimen/margin_small\"\n+            android:textStyle=\"bold\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "531b1366db726f7624e43f2572a76b7ada4b5ef3"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1MzYzNw==", "bodyText": "I believe this should be using TextAppearance.Collect.Body2 as the style looking at the specs and the style guide I generated from Sketch.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r382053637", "createdAt": "2020-02-20T14:59:57Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/res/layout/storage_migration_banner.xml", "diffHunk": "@@ -0,0 +1,60 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\"?>\n+<LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n+    android:id=\"@+id/storageMigrationBanner\"\n+    android:orientation=\"vertical\"\n+    android:layout_width=\"match_parent\"\n+    android:layout_height=\"match_parent\"\n+    android:background=\"?colorSurface\"\n+    android:visibility=\"gone\">\n+\n+    <LinearLayout\n+        android:layout_width=\"match_parent\"\n+        android:layout_height=\"wrap_content\"\n+        android:orientation=\"vertical\"\n+        android:paddingStart=\"@dimen/margin_standard\"\n+        android:paddingEnd=\"@dimen/margin_standard\"\n+        android:paddingTop=\"@dimen/margin_standard\">\n+\n+        <TextView\n+            android:id=\"@+id/storageMigrationBannerText\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "531b1366db726f7624e43f2572a76b7ada4b5ef3"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1NjM2MA==", "bodyText": "Again we should be using colorSecondary instead of colorAccent", "url": "https://github.com/getodk/collect/pull/3623#discussion_r382056360", "createdAt": "2020-02-20T15:04:01Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/res/layout/storage_migration_dialog.xml", "diffHunk": "@@ -0,0 +1,137 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\"?>\n+<LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n+    android:layout_width=\"match_parent\"\n+    android:layout_height=\"match_parent\"\n+    android:background=\"?attr/colorSurface\"\n+    android:orientation=\"vertical\">\n+\n+    <include layout=\"@layout/material_full_screen_dialog_toolbar\" />\n+\n+    <RelativeLayout\n+        android:layout_width=\"match_parent\"\n+        android:layout_height=\"match_parent\"\n+        android:orientation=\"vertical\">\n+\n+        <LinearLayout\n+            android:layout_width=\"match_parent\"\n+            android:layout_height=\"match_parent\"\n+            android:orientation=\"vertical\"\n+            android:padding=\"@dimen/margin_standard\">\n+\n+            <TextView\n+                android:id=\"@+id/messageText1\"\n+                style=\"@style/TextAppearance.Collect.Body1\"\n+                android:layout_width=\"wrap_content\"\n+                android:layout_height=\"wrap_content\"\n+                android:layout_marginTop=\"@dimen/margin_small\"\n+                android:text=\"@string/storage_migration_dialog_message1\" />\n+\n+            <TextView\n+                android:id=\"@+id/messageText2\"\n+                style=\"@style/TextAppearance.Collect.Body1\"\n+                android:layout_width=\"wrap_content\"\n+                android:layout_height=\"wrap_content\"\n+                android:visibility=\"gone\"\n+                android:layout_marginTop=\"@dimen/margin_small\"\n+                android:text=\"@string/storage_migration_dialog_message2\" />\n+\n+            <TextView\n+                android:id=\"@+id/messageText3\"\n+                style=\"@style/TextAppearance.Collect.Body1\"\n+                android:layout_width=\"wrap_content\"\n+                android:layout_height=\"wrap_content\"\n+                android:layout_marginTop=\"@dimen/margin_small\"\n+                android:text=\"@string/storage_migration_dialog_message3\" />\n+\n+            <TextView\n+                android:id=\"@+id/moreDetailsButton\"\n+                android:layout_width=\"wrap_content\"\n+                android:layout_height=\"wrap_content\"\n+                android:text=\"@string/storage_migration_more_details\"\n+                android:textColor=\"?colorAccent\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "729864dc4ec795ecbbdc03bfbccaff8579ac7c47"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1Njc5MQ==", "bodyText": "This can be a MaterialButton with the TextButton style right?", "url": "https://github.com/getodk/collect/pull/3623#discussion_r382056791", "createdAt": "2020-02-20T15:04:43Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/res/layout/storage_migration_dialog.xml", "diffHunk": "@@ -0,0 +1,137 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\"?>\n+<LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n+    android:layout_width=\"match_parent\"\n+    android:layout_height=\"match_parent\"\n+    android:background=\"?attr/colorSurface\"\n+    android:orientation=\"vertical\">\n+\n+    <include layout=\"@layout/material_full_screen_dialog_toolbar\" />\n+\n+    <RelativeLayout\n+        android:layout_width=\"match_parent\"\n+        android:layout_height=\"match_parent\"\n+        android:orientation=\"vertical\">\n+\n+        <LinearLayout\n+            android:layout_width=\"match_parent\"\n+            android:layout_height=\"match_parent\"\n+            android:orientation=\"vertical\"\n+            android:padding=\"@dimen/margin_standard\">\n+\n+            <TextView\n+                android:id=\"@+id/messageText1\"\n+                style=\"@style/TextAppearance.Collect.Body1\"\n+                android:layout_width=\"wrap_content\"\n+                android:layout_height=\"wrap_content\"\n+                android:layout_marginTop=\"@dimen/margin_small\"\n+                android:text=\"@string/storage_migration_dialog_message1\" />\n+\n+            <TextView\n+                android:id=\"@+id/messageText2\"\n+                style=\"@style/TextAppearance.Collect.Body1\"\n+                android:layout_width=\"wrap_content\"\n+                android:layout_height=\"wrap_content\"\n+                android:visibility=\"gone\"\n+                android:layout_marginTop=\"@dimen/margin_small\"\n+                android:text=\"@string/storage_migration_dialog_message2\" />\n+\n+            <TextView\n+                android:id=\"@+id/messageText3\"\n+                style=\"@style/TextAppearance.Collect.Body1\"\n+                android:layout_width=\"wrap_content\"\n+                android:layout_height=\"wrap_content\"\n+                android:layout_marginTop=\"@dimen/margin_small\"\n+                android:text=\"@string/storage_migration_dialog_message3\" />\n+\n+            <TextView", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "729864dc4ec795ecbbdc03bfbccaff8579ac7c47"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1NzI2OQ==", "bodyText": "Again lets do MaterialButtons for these and see if we can get rid of the bold and textAllCaps", "url": "https://github.com/getodk/collect/pull/3623#discussion_r382057269", "createdAt": "2020-02-20T15:05:27Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/res/layout/storage_migration_dialog.xml", "diffHunk": "@@ -0,0 +1,137 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\"?>\n+<LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n+    android:layout_width=\"match_parent\"\n+    android:layout_height=\"match_parent\"\n+    android:background=\"?attr/colorSurface\"\n+    android:orientation=\"vertical\">\n+\n+    <include layout=\"@layout/material_full_screen_dialog_toolbar\" />\n+\n+    <RelativeLayout\n+        android:layout_width=\"match_parent\"\n+        android:layout_height=\"match_parent\"\n+        android:orientation=\"vertical\">\n+\n+        <LinearLayout\n+            android:layout_width=\"match_parent\"\n+            android:layout_height=\"match_parent\"\n+            android:orientation=\"vertical\"\n+            android:padding=\"@dimen/margin_standard\">\n+\n+            <TextView\n+                android:id=\"@+id/messageText1\"\n+                style=\"@style/TextAppearance.Collect.Body1\"\n+                android:layout_width=\"wrap_content\"\n+                android:layout_height=\"wrap_content\"\n+                android:layout_marginTop=\"@dimen/margin_small\"\n+                android:text=\"@string/storage_migration_dialog_message1\" />\n+\n+            <TextView\n+                android:id=\"@+id/messageText2\"\n+                style=\"@style/TextAppearance.Collect.Body1\"\n+                android:layout_width=\"wrap_content\"\n+                android:layout_height=\"wrap_content\"\n+                android:visibility=\"gone\"\n+                android:layout_marginTop=\"@dimen/margin_small\"\n+                android:text=\"@string/storage_migration_dialog_message2\" />\n+\n+            <TextView\n+                android:id=\"@+id/messageText3\"\n+                style=\"@style/TextAppearance.Collect.Body1\"\n+                android:layout_width=\"wrap_content\"\n+                android:layout_height=\"wrap_content\"\n+                android:layout_marginTop=\"@dimen/margin_small\"\n+                android:text=\"@string/storage_migration_dialog_message3\" />\n+\n+            <TextView\n+                android:id=\"@+id/moreDetailsButton\"\n+                android:layout_width=\"wrap_content\"\n+                android:layout_height=\"wrap_content\"\n+                android:text=\"@string/storage_migration_more_details\"\n+                android:textColor=\"?colorAccent\"\n+                android:textStyle=\"bold\"\n+                android:textAllCaps=\"true\"\n+                android:paddingTop=\"@dimen/margin_standard\" />\n+\n+            <TextView\n+                android:id=\"@+id/errorText\"\n+                style=\"@style/TextAppearance.Collect.Headline6\"\n+                android:layout_width=\"wrap_content\"\n+                android:layout_height=\"wrap_content\"\n+                android:layout_marginTop=\"@dimen/margin_standard\"\n+                android:visibility=\"gone\"/>\n+\n+            <LinearLayout\n+                android:id=\"@+id/progressBar\"\n+                android:layout_width=\"match_parent\"\n+                android:layout_height=\"match_parent\"\n+                android:orientation=\"vertical\"\n+                android:gravity=\"center\"\n+                android:visibility=\"gone\">\n+\n+                <ProgressBar\n+                    android:layout_width=\"wrap_content\"\n+                    android:layout_height=\"wrap_content\">\n+                </ProgressBar>\n+\n+                <TextView\n+                    style=\"@style/TextAppearance.Collect.Body1\"\n+                    android:layout_width=\"wrap_content\"\n+                    android:layout_height=\"wrap_content\"\n+                    android:text=\"@string/storage_migration_progress_msg\"\n+                    android:layout_marginTop=\"@dimen/margin_small\"\n+                    android:gravity=\"center_horizontal\"/>\n+            </LinearLayout>\n+        </LinearLayout>\n+\n+        <FrameLayout\n+            android:layout_width=\"match_parent\"\n+            android:layout_height=\"wrap_content\"\n+            android:layout_alignParentBottom=\"true\">\n+\n+            <LinearLayout\n+                android:layout_width=\"match_parent\"\n+                android:layout_height=\"wrap_content\"\n+                android:orientation=\"vertical\">\n+\n+                <ImageView\n+                    android:layout_width=\"match_parent\"\n+                    android:layout_height=\"wrap_content\"\n+                    android:src=\"@drawable/shadow_up\" />\n+\n+                <LinearLayout\n+                    android:layout_width=\"match_parent\"\n+                    android:layout_height=\"wrap_content\"\n+                    android:orientation=\"horizontal\"\n+                    android:gravity=\"end\">\n+\n+                    <Button", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "729864dc4ec795ecbbdc03bfbccaff8579ac7c47"}, "originalPosition": 108}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjk5OTkx", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-362299991", "createdAt": "2020-02-20T23:09:01Z", "commit": {"oid": "729864dc4ec795ecbbdc03bfbccaff8579ac7c47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMzowOTowMlrOFsmWMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMzowOTowMlrOFsmWMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMwOTkzOA==", "bodyText": "Ooh, yeah, the odk subdirectory was from the StoragePathProvider PR. Sorry I didn't think through that before! Looks great now.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r382309938", "createdAt": "2020-02-20T23:09:02Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/ResetAppStateTest.java", "diffHunk": "@@ -166,7 +166,7 @@ private void setupTestSettings() throws IOException {\n \n         assertTrue(new File(storagePathProvider.getDirPath(StorageSubdirectory.SETTINGS)).exists() || new File(storagePathProvider.getDirPath(StorageSubdirectory.SETTINGS)).mkdir());\n         assertTrue(new File(storagePathProvider.getDirPath(StorageSubdirectory.SETTINGS) + \"/collect.settings\").createNewFile());\n-        assertTrue(new File(storagePathProvider.getDirPath(StorageSubdirectory.ODK) + \"/collect.settings\").createNewFile());\n+        assertTrue(new File(storagePathProvider.getStorageRootDirPath() + \"/collect.settings\").createNewFile());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "729864dc4ec795ecbbdc03bfbccaff8579ac7c47"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzA3MTE3", "url": "https://github.com/getodk/collect/pull/3623#pullrequestreview-362307117", "createdAt": "2020-02-20T23:26:43Z", "commit": {"oid": "729864dc4ec795ecbbdc03bfbccaff8579ac7c47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMzoyNjo0M1rOFsmtbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMzoyNjo0M1rOFsmtbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxNTg4Ng==", "bodyText": "Nice.", "url": "https://github.com/getodk/collect/pull/3623#discussion_r382315886", "createdAt": "2020-02-20T23:26:43Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/utilities/AdminPasswordProvider.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package org.odk.collect.android.utilities;\n+\n+import org.odk.collect.android.preferences.AdminSharedPreferences;\n+\n+import static org.odk.collect.android.preferences.AdminKeys.KEY_ADMIN_PW;\n+\n+public class AdminPasswordProvider {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "729864dc4ec795ecbbdc03bfbccaff8579ac7c47"}, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21b09a5b1ed5420254dab74c394f2570a94a2f64", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/21b09a5b1ed5420254dab74c394f2570a94a2f64", "committedDate": "2020-02-21T08:41:27Z", "message": "Merge branch 'master' into migrate"}, "afterCommit": {"oid": "f2872ef335f41998ea1910c2248c0005fbd6e26d", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f2872ef335f41998ea1910c2248c0005fbd6e26d", "committedDate": "2020-02-21T08:48:56Z", "message": "Bumped minSdkVersion to 21"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f2872ef335f41998ea1910c2248c0005fbd6e26d", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f2872ef335f41998ea1910c2248c0005fbd6e26d", "committedDate": "2020-02-21T08:48:56Z", "message": "Bumped minSdkVersion to 21"}, "afterCommit": {"oid": "fcc9ce6601e956bffc3ee3a5266260461835dbc5", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/fcc9ce6601e956bffc3ee3a5266260461835dbc5", "committedDate": "2020-02-21T08:57:48Z", "message": "Fixed build"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9699d7998e2f2504d0a3690d694b6ec29286d906", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/9699d7998e2f2504d0a3690d694b6ec29286d906", "committedDate": "2020-02-21T09:18:27Z", "message": "Code improvements"}, "afterCommit": {"oid": "02ce2d10ac4c8cb69a302338ef91ef61dc75b2c0", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/02ce2d10ac4c8cb69a302338ef91ef61dc75b2c0", "committedDate": "2020-02-21T10:48:32Z", "message": "Code improvements"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02ce2d10ac4c8cb69a302338ef91ef61dc75b2c0", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/02ce2d10ac4c8cb69a302338ef91ef61dc75b2c0", "committedDate": "2020-02-21T10:48:32Z", "message": "Code improvements"}, "afterCommit": {"oid": "6f4a4f8aecd1888d249d98a5a72188bf64a767a7", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/6f4a4f8aecd1888d249d98a5a72188bf64a767a7", "committedDate": "2020-02-21T10:50:53Z", "message": "Code improvements"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "713f6865a307681891c93ef04c816a260ecb51ba", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/713f6865a307681891c93ef04c816a260ecb51ba", "committedDate": "2020-02-21T11:08:57Z", "message": "Added new TextAppearance.Collect.Button.TextButton style"}, "afterCommit": {"oid": "388ebb79402c7b6db2c896317b4d041488315b01", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/388ebb79402c7b6db2c896317b4d041488315b01", "committedDate": "2020-02-21T12:05:32Z", "message": "Removed unused method"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "54acd67f9683fd40599be7ac9e7aeb84038a650d", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/54acd67f9683fd40599be7ac9e7aeb84038a650d", "committedDate": "2020-02-21T12:18:20Z", "message": "Fixed creating StorageMigrationDialog"}, "afterCommit": {"oid": "244fbb9720ccacf6b16083a84b3173ef77e40511", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/244fbb9720ccacf6b16083a84b3173ef77e40511", "committedDate": "2020-02-21T12:22:07Z", "message": "Fixed creating StorageMigrationDialog"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cbb2beb1f6c4540a5a837bebc64103df7ab9f38b", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/cbb2beb1f6c4540a5a837bebc64103df7ab9f38b", "committedDate": "2020-02-21T15:08:56Z", "message": "Fixed storage paths in tests"}, "afterCommit": {"oid": "770de7c1382d404c947b7e59e195d9735c58621e", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/770de7c1382d404c947b7e59e195d9735c58621e", "committedDate": "2020-02-21T16:53:18Z", "message": "Fixed storage paths in tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "730431b31bf285b8efb4f0a833cfb63fd2b69c67", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/730431b31bf285b8efb4f0a833cfb63fd2b69c67", "committedDate": "2020-02-21T17:22:36Z", "message": "Update map layer path instead of resetting it"}, "afterCommit": {"oid": "f5c68ce7cc930bba387d3b156546d2cb6325f8f3", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f5c68ce7cc930bba387d3b156546d2cb6325f8f3", "committedDate": "2020-02-21T17:23:21Z", "message": "Update map layer path instead of resetting it"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f5c68ce7cc930bba387d3b156546d2cb6325f8f3", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f5c68ce7cc930bba387d3b156546d2cb6325f8f3", "committedDate": "2020-02-21T17:23:21Z", "message": "Update map layer path instead of resetting it"}, "afterCommit": {"oid": "b6ffab9b386f928f5c0b0c64b2b3440bb3388d21", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/b6ffab9b386f928f5c0b0c64b2b3440bb3388d21", "committedDate": "2020-02-21T08:15:00Z", "message": "Improved dealing with the banner visibility"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1030b9f459be30b2859545075cebc2d277cb5e64", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/1030b9f459be30b2859545075cebc2d277cb5e64", "committedDate": "2020-02-24T13:20:41Z", "message": "Code improvements"}, "afterCommit": {"oid": "5443cc29f39e742181db5c4820b0b758efdb42e1", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/5443cc29f39e742181db5c4820b0b758efdb42e1", "committedDate": "2020-02-24T13:26:36Z", "message": "Code improvements"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6ad44fb824a5577e7b3a4ac533a32df38e13824c", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/6ad44fb824a5577e7b3a4ac533a32df38e13824c", "committedDate": "2020-02-24T14:28:54Z", "message": "Reset ReferenceManager"}, "afterCommit": {"oid": "4533c7200e4426537b16fa2649a41063397e6d8c", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/4533c7200e4426537b16fa2649a41063397e6d8c", "committedDate": "2020-02-25T07:28:12Z", "message": "Reset ReferenceManager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "59aafb60d2544878e0bccb52d477bcc96a3f8626", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/59aafb60d2544878e0bccb52d477bcc96a3f8626", "committedDate": "2020-02-25T09:05:02Z", "message": "Improved handling offline map layer path"}, "afterCommit": {"oid": "05b08801043d78e0486fe97c599c16cd2c7b22d9", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/05b08801043d78e0486fe97c599c16cd2c7b22d9", "committedDate": "2020-02-25T09:06:13Z", "message": "Improved handling offline map layer paths"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "05b08801043d78e0486fe97c599c16cd2c7b22d9", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/05b08801043d78e0486fe97c599c16cd2c7b22d9", "committedDate": "2020-02-25T09:06:13Z", "message": "Improved handling offline map layer paths"}, "afterCommit": {"oid": "13c531d19c4dbeeea6c961644f4ad147c3f93333", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/13c531d19c4dbeeea6c961644f4ad147c3f93333", "committedDate": "2020-02-25T13:06:00Z", "message": "Improved handling offline map layer paths"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2aec2cef76323fcadf43baad6f780922420fbea9", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/2aec2cef76323fcadf43baad6f780922420fbea9", "committedDate": "2020-02-26T10:57:34Z", "message": "Added possible mgration results"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abe7f65a4c39aa7ba2ef59da653235197104623f", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/abe7f65a4c39aa7ba2ef59da653235197104623f", "committedDate": "2020-02-26T10:57:34Z", "message": "Implemented isEnoughSpaceToPerformMigartion() method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ac1f4728dae8cd4bab72e804cc6d59982f8a5ae", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/2ac1f4728dae8cd4bab72e804cc6d59982f8a5ae", "committedDate": "2020-02-26T10:57:34Z", "message": "Implemented StorageMigrator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08a57b78f017756ce3cd0cafb80ea7fff89ca8fb", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/08a57b78f017756ce3cd0cafb80ea7fff89ca8fb", "committedDate": "2020-02-26T10:57:34Z", "message": "Don't use storage paths in static fields because old values might persist after migrating"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3f83e105d37ec3dc009a4dff509ede04cb7126b", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/d3f83e105d37ec3dc009a4dff509ede04cb7126b", "committedDate": "2020-02-26T10:57:34Z", "message": "Reopen databases to update paths"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b502d280c45aa7097bfa6941fdc5480d4af0485", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/0b502d280c45aa7097bfa6941fdc5480d4af0485", "committedDate": "2020-02-26T10:57:34Z", "message": "Created StorageEraser class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "644e2adc538e325109460cdb95bc18aff7edfa92", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/644e2adc538e325109460cdb95bc18aff7edfa92", "committedDate": "2020-02-26T10:57:34Z", "message": "Code improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87aa72e8dcfa84b10ba0ed39660d616ae64a12df", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/87aa72e8dcfa84b10ba0ed39660d616ae64a12df", "committedDate": "2020-02-26T10:57:34Z", "message": "Block uploading/downloading forms if migartion is being performed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a29c353c2ff8edf82bd9887a6f930eed5e5cf20", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/0a29c353c2ff8edf82bd9887a6f930eed5e5cf20", "committedDate": "2020-02-26T11:00:07Z", "message": "Added the banner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fee5bb00098971bedf3c61fd56402864bcfeccc", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/0fee5bb00098971bedf3c61fd56402864bcfeccc", "committedDate": "2020-02-26T11:02:15Z", "message": "Added StorageMigratorTask"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "986271fcd32c40c7cc69fdcda6fccd06ccdc6508", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/986271fcd32c40c7cc69fdcda6fccd06ccdc6508", "committedDate": "2020-02-26T11:02:15Z", "message": "Moved classes responsible for migation to one dir"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f2f6aed514bd0f2ee5d029e42630be344e3de3a", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/9f2f6aed514bd0f2ee5d029e42630be344e3de3a", "committedDate": "2020-02-26T11:02:15Z", "message": "Added StorageMigratorTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "002ac82208ad3684a556dfdfcbb9f850cfcbfad6", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/002ac82208ad3684a556dfdfcbb9f850cfcbfad6", "committedDate": "2020-02-26T11:02:15Z", "message": "Code improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcf15ba45d62149a114c925a59f653928bf3c4da", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/dcf15ba45d62149a114c925a59f653928bf3c4da", "committedDate": "2020-02-26T11:03:02Z", "message": "Added StorageMigrationDialog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17e476115da9892b9be2d92ab1b473b99e578f4c", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/17e476115da9892b9be2d92ab1b473b99e578f4c", "committedDate": "2020-02-26T11:03:26Z", "message": "Replace AsyncTask with Service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1963e41fa266b9c0c9f953022814cc5828b31ebc", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/1963e41fa266b9c0c9f953022814cc5828b31ebc", "committedDate": "2020-02-26T11:03:26Z", "message": "Gray out the messgage after starting migration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a1de5ee7ba45f4baa1ddae6cf33207a8069b2a3", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/9a1de5ee7ba45f4baa1ddae6cf33207a8069b2a3", "committedDate": "2020-02-26T11:03:26Z", "message": "Removed unused string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5adaaedb6b4a95936f15c3ace52e17091cd3eac7", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/5adaaedb6b4a95936f15c3ace52e17091cd3eac7", "committedDate": "2020-02-26T11:03:26Z", "message": "Use MaterialFullScreenDialogFragment for creating StorageMigrationDialog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71640c3f30f80c4cfc7e80b8cf796e9a5e16483d", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/71640c3f30f80c4cfc7e80b8cf796e9a5e16483d", "committedDate": "2020-02-26T11:03:26Z", "message": "Improved tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4644f0f351ac9b4fbbc9eb84f1047fd9d3acf6cf", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/4644f0f351ac9b4fbbc9eb84f1047fd9d3acf6cf", "committedDate": "2020-02-26T11:05:17Z", "message": "Use Livedata instead of broadcast receivers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "510f4872da1f9b105f8490ef506f2d46a7d646d6", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/510f4872da1f9b105f8490ef506f2d46a7d646d6", "committedDate": "2020-02-26T11:05:45Z", "message": "Added CLEARING_OLD_DATA status"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84cff52a1c057bae720a9631f25b9c31fb5acc66", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/84cff52a1c057bae720a9631f25b9c31fb5acc66", "committedDate": "2020-02-26T11:05:45Z", "message": "Fixed commented line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05515702f117197e15a603b4bdbe777e6bfae960", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/05515702f117197e15a603b4bdbe777e6bfae960", "committedDate": "2020-02-26T11:05:45Z", "message": "Improved managing softKeyboard in MaterialFullScreenDialogFragment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90fceebc88237b1ff7a6b1b0855b592c5617b0f8", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/90fceebc88237b1ff7a6b1b0855b592c5617b0f8", "committedDate": "2020-02-26T11:05:45Z", "message": "Reverted changes I made by mistake"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f49f991bf12f226e5d58d31538e969952628b0b2", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f49f991bf12f226e5d58d31538e969952628b0b2", "committedDate": "2020-02-26T11:05:45Z", "message": "Code improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5d7096f4c31f43899fd3c4ee8592ce08b2a9aaa", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/b5d7096f4c31f43899fd3c4ee8592ce08b2a9aaa", "committedDate": "2020-02-26T11:06:04Z", "message": "Get rid of dynamic progress status"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0115e56d22efeb15f4543ff851da4bf805f86b3f", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/0115e56d22efeb15f4543ff851da4bf805f86b3f", "committedDate": "2020-02-26T11:06:31Z", "message": "Code improvemenets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9a837e7180f7aab93b5ee1045a2e60f8c278d8a", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/a9a837e7180f7aab93b5ee1045a2e60f8c278d8a", "committedDate": "2020-02-26T11:06:31Z", "message": "Fixed getValuesFromInstanceObject() method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73e6842819311ded7b50ab377e716c7d41a5452a", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/73e6842819311ded7b50ab377e716c7d41a5452a", "committedDate": "2020-02-26T11:06:31Z", "message": "Code improvements to make migration faster"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37c513832f5d6d4afdc3f2d25b44d342a128014b", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/37c513832f5d6d4afdc3f2d25b44d342a128014b", "committedDate": "2020-02-26T11:06:47Z", "message": "Use the banner to display migration results"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63b248b10f15104e7334e2b8216aef858b54b07c", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/63b248b10f15104e7334e2b8216aef858b54b07c", "committedDate": "2020-02-26T11:06:47Z", "message": "Avoid calling onStorageMigrationFinish every time a user returns to the app"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaa69e34c25a8ed4ac7bd0e3aaef4ed41029db70", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/eaa69e34c25a8ed4ac7bd0e3aaef4ed41029db70", "committedDate": "2020-02-26T11:06:47Z", "message": "Updated StorageMigrationDialog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bb0bd5e144f7f8909f960e42a77fbdf00bf99a1", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/7bb0bd5e144f7f8909f960e42a77fbdf00bf99a1", "committedDate": "2020-02-26T11:06:47Z", "message": "Fixed migration result observer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8c1fceb126522f0e6ac02c6c650dafcb9745801", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/a8c1fceb126522f0e6ac02c6c650dafcb9745801", "committedDate": "2020-02-26T11:06:47Z", "message": "Ask for admin password if specyfied"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7ab62544dfda115e4a1e9bf0e2f6fdc3b3030f6", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f7ab62544dfda115e4a1e9bf0e2f6fdc3b3030f6", "committedDate": "2020-02-26T11:06:47Z", "message": "Don't save migration result in shared prefs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a4fd23153181b9a7446d0f92d08144a47c7d560", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/1a4fd23153181b9a7446d0f92d08144a47c7d560", "committedDate": "2020-02-26T11:07:13Z", "message": "Display error message in StorageMigrationDialog if migration failed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c839b7631d4da164b0f408945390078c6ef98366", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/c839b7631d4da164b0f408945390078c6ef98366", "committedDate": "2020-02-26T11:07:13Z", "message": "Ask for admin pass when a user starts migration not when they open the migration dialog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07091fdc081510e516b82e2838087d3b566c9f11", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/07091fdc081510e516b82e2838087d3b566c9f11", "committedDate": "2020-02-26T11:07:13Z", "message": "Fixed buttons visiblility in the banner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a41d51163c58863480f1716eb7b5fdcf975af88", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/8a41d51163c58863480f1716eb7b5fdcf975af88", "committedDate": "2020-02-26T11:07:13Z", "message": "Fixed pmd"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3815b8de43bfe50521a7a2f1fa710a43840ef7c", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/e3815b8de43bfe50521a7a2f1fa710a43840ef7c", "committedDate": "2020-02-26T11:07:13Z", "message": "Make sure the progress circle is visble"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d198c9fbf4f8917d02b659848ffc20ef046ff52", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/4d198c9fbf4f8917d02b659848ffc20ef046ff52", "committedDate": "2020-02-26T11:07:13Z", "message": "Code improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fd161fa4c7139e1f2ff66db5893fdb887bee5f4", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/5fd161fa4c7139e1f2ff66db5893fdb887bee5f4", "committedDate": "2020-02-26T11:07:13Z", "message": "Don't keep the banner with success result visible for ever"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f03d4a8d0c4c125a50f75fb608b68ed702c38795", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f03d4a8d0c4c125a50f75fb608b68ed702c38795", "committedDate": "2020-02-26T11:07:13Z", "message": "Code improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46e4f2c9aa775036bb40fa0a2a143d1515172dff", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/46e4f2c9aa775036bb40fa0a2a143d1515172dff", "committedDate": "2020-02-26T11:07:40Z", "message": "Factored out AdminPasswordProvider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88f70e451abe2987e393f36ea1c1be70af4bec66", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/88f70e451abe2987e393f36ea1c1be70af4bec66", "committedDate": "2020-02-26T11:07:40Z", "message": "Code improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13796856d1461ca2c2ff5165f337686a595c807d", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/13796856d1461ca2c2ff5165f337686a595c807d", "committedDate": "2020-02-26T11:08:51Z", "message": "Get rid of additional odk dir on scoped storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a775fa8feb35e489fa65a9129b09ef5e338bf5a9", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/a775fa8feb35e489fa65a9129b09ef5e338bf5a9", "committedDate": "2020-02-26T11:08:51Z", "message": "Revert the change I made by mistake"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8c792063a9b0c171775e5e8e5f6ec1d6e0c392e", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/e8c792063a9b0c171775e5e8e5f6ec1d6e0c392e", "committedDate": "2020-02-26T11:08:51Z", "message": "Avoid multiclicking in StorageMigrationDialog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "534c6a779f52120d784cee4f0ad9b5da297baac9", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/534c6a779f52120d784cee4f0ad9b5da297baac9", "committedDate": "2020-02-26T11:08:51Z", "message": "Fixed dismissing the banner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7641c17fd91dc7fab025923c62fd6736dfb0a94", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/d7641c17fd91dc7fab025923c62fd6736dfb0a94", "committedDate": "2020-02-26T11:08:51Z", "message": "Fixed pmd"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2277, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}