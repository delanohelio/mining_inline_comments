{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0MzU1NjMy", "number": 3977, "title": "Revise Form Management for Match Exactly", "bodyText": "Closes #3940\nIn addition to implementing the feature as descirbed this:\n\nRemoves Evernote Job framework\nBackfills tests for manual and \"previously downloaded only\" form updates\nMoves testing around to create a smoke package that covers core parts of the app\nAdds  TestRuleChain that makes it easier to write Espresso tests with standard deps and rules\n\nWhat has been done to verify that this works as intended?\nA lot of new tests and manually verified acceptance criteria.\nWhy is this the best possible solution? Were any other approaches considered?\nNot a lot of big changes here that don't just build on the previous Match Exactly PRs so I think we're good on discussing structural decisions here.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nThere are risks to any of the auto update/auto upload features. I'm keeping track of risks and will address with QA when we do checks on master.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-07-21T10:20:07Z", "url": "https://github.com/getodk/collect/pull/3977", "merged": true, "mergeCommit": {"oid": "3ffb080825e41b5981e638a1b67ef79cfa83ade7"}, "closed": true, "closedAt": "2020-07-23T18:17:00Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 53, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3De7kgH2gAyNDU0MzU1NjMyOjk1NmI2ZTliZDY4ODdlNzhlNDFkMDg2Y2QxYjI5Yjc2Mjk3ZjRkZDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3zj5WgFqTQ1NDM4MzA4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "956b6e9bd6887e78e41d086cd1b29b76297f4dd3", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/956b6e9bd6887e78e41d086cd1b29b76297f4dd3", "committedDate": "2020-07-21T10:15:25Z", "message": "Seperate out core flow smoke test from ServerSettingsTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "180b9894c438b551d268576ddce0c6e02e2ea9aa", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/180b9894c438b551d268576ddce0c6e02e2ea9aa", "committedDate": "2020-07-21T10:15:25Z", "message": "Add failing tests for setting up manual mode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a478157d0aef9f160af9e33b5e0f6c287701bc84", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/a478157d0aef9f160af9e33b5e0f6c287701bc84", "committedDate": "2020-07-21T10:15:25Z", "message": "Add manual update forms mode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "342dd5c8d72ad83c4dba9d7a401c66ab48048f68", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/342dd5c8d72ad83c4dba9d7a401c66ab48048f68", "committedDate": "2020-07-21T10:15:26Z", "message": "Add initial tests for previously downloaded mode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24a556f48c440aebae949c9e217cfbe6e97c27a7", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/24a556f48c440aebae949c9e217cfbe6e97c27a7", "committedDate": "2020-07-21T10:15:26Z", "message": "Use form update setting to enable match exactly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19283f41d6b2f1877bbc8ff37560d0eb13f90e28", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/19283f41d6b2f1877bbc8ff37560d0eb13f90e28", "committedDate": "2020-07-21T10:15:26Z", "message": "Rename Scheduler methods based on Android docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbb187b4e3010369eb02be1a03afc9f5db73b7f9", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/cbb187b4e3010369eb02be1a03afc9f5db73b7f9", "committedDate": "2020-07-21T10:15:26Z", "message": "Allow match exactly frequency to be customized"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb598da652c87f904d900e9012a944ae8877246a", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/eb598da652c87f904d900e9012a944ae8877246a", "committedDate": "2020-07-21T10:15:26Z", "message": "Make sure correct settings are enabled for manual form update mode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4789ecd281f209280576917a69be3e9d44cb3569", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/4789ecd281f209280576917a69be3e9d44cb3569", "committedDate": "2020-07-21T10:15:26Z", "message": "Make sure correct prefs show when previously downloaded enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c11f7ba390304d4326df9153ed550be05feabe7d", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/c11f7ba390304d4326df9153ed550be05feabe7d", "committedDate": "2020-07-21T10:15:26Z", "message": "Use Scheduler for auto update work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efd288ff8f45d15954a4b0b48cffcca230ef7398", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/efd288ff8f45d15954a4b0b48cffcca230ef7398", "committedDate": "2020-07-21T10:15:27Z", "message": "Fix concurrent modification exception in ServerPollingJob"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e3c3c02c14f710a19c70bd579f6fb88aa7f425d", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/9e3c3c02c14f710a19c70bd579f6fb88aa7f425d", "committedDate": "2020-07-21T10:15:27Z", "message": "Introduce rule for notification drawer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62d584c17313bd7eb039b7e0683af36a25f919c6", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/62d584c17313bd7eb039b7e0683af36a25f919c6", "committedDate": "2020-07-21T10:15:27Z", "message": "Allow setting auto update frequency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dfac443ae0a93247ee6aa94b1c34d64a7de9672", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/1dfac443ae0a93247ee6aa94b1c34d64a7de9672", "committedDate": "2020-07-21T10:15:27Z", "message": "Add test for auto download"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb83360a4576ca4066869a15cada45a16f0e8675", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/eb83360a4576ca4066869a15cada45a16f0e8675", "committedDate": "2020-07-21T10:15:27Z", "message": "Make it easier to set up standard test deps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13eda1c080f3c0fed7a5fdd69635ebeb32297e48", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/13eda1c080f3c0fed7a5fdd69635ebeb32297e48", "committedDate": "2020-07-21T10:15:27Z", "message": "Optimize imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccf83f4c7e54ad08c7b633e16ec23c35d921bd2a", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/ccf83f4c7e54ad08c7b633e16ec23c35d921bd2a", "committedDate": "2020-07-21T10:15:27Z", "message": "Fix notification tests on devices without CLEAR ALL button"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63b435ee7f58191030af5db0a3c468c0c708e516", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/63b435ee7f58191030af5db0a3c468c0c708e516", "committedDate": "2020-07-21T10:15:28Z", "message": "Add enum for form update mode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b15195dfbaf4143981fd73a0b9557f7b01a32dc", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/6b15195dfbaf4143981fd73a0b9557f7b01a32dc", "committedDate": "2020-07-21T10:15:28Z", "message": "Delete unused strings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d746d46114011a1789985191bb3d5d1ba0f467f", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/6d746d46114011a1789985191bb3d5d1ba0f467f", "committedDate": "2020-07-21T10:15:28Z", "message": "Remove Evernote Job framework"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "302c9146d7784c6e5f14d6a4aeb12d8d64aa0e33", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/302c9146d7784c6e5f14d6a4aeb12d8d64aa0e33", "committedDate": "2020-07-21T10:15:28Z", "message": "Make sure disabling previously downloaded cancels background work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4fd5d3ea7274b4b96fe23edcbb3f42a4960fc2c", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/b4fd5d3ea7274b4b96fe23edcbb3f42a4960fc2c", "committedDate": "2020-07-21T10:15:28Z", "message": "Rework ServerPollingJob to be TaskSpec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9f8858a625705c06c8c309af34d7c6af0ac749a", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/b9f8858a625705c06c8c309af34d7c6af0ac749a", "committedDate": "2020-07-21T10:15:28Z", "message": "Isolate FormsDao interactions to inner repository class in AutoUpdateTaskSpec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "728833186e93fa219f7a288d508b18c3e7c1bdff", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/728833186e93fa219f7a288d508b18c3e7c1bdff", "committedDate": "2020-07-21T10:15:28Z", "message": "Pull dependency construction out of AutoUpdateTaskSpec as much as possible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23206a6f9da5cac4fd277969b7722345d1cc07df", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/23206a6f9da5cac4fd277969b7722345d1cc07df", "committedDate": "2020-07-21T10:15:29Z", "message": "Extract method object for notifying fo form updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5004e12b51f7d6b1480429ef6568872932889ff2", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/5004e12b51f7d6b1480429ef6568872932889ff2", "committedDate": "2020-07-21T10:15:29Z", "message": "Extract notifier from task spec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "455f0b0adc33a7a6c107c5ed35d3e344764ac1a6", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/455f0b0adc33a7a6c107c5ed35d3e344764ac1a6", "committedDate": "2020-07-21T10:15:29Z", "message": "Move auto download logic out of use case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "410d53312d0dd4fa865b1879553f7efc62226e88", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/410d53312d0dd4fa865b1879553f7efc62226e88", "committedDate": "2020-07-21T10:15:29Z", "message": "Use FormRepository instead of NotificationRepository"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d0421dc70abd4084096d2a13204750b1284d536", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/6d0421dc70abd4084096d2a13204750b1284d536", "committedDate": "2020-07-21T10:15:29Z", "message": "Add tests for ServerFormUpdatesChecker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e538bda4bfc576b1f904af35da70db9109e8ccc2", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/e538bda4bfc576b1f904af35da70db9109e8ccc2", "committedDate": "2020-07-21T10:15:29Z", "message": "Revise migrator interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff6c3bab1d55345788cbdaa1cb69e9efe0179414", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/ff6c3bab1d55345788cbdaa1cb69e9efe0179414", "committedDate": "2020-07-21T10:15:30Z", "message": "Add migration for previously downloaded settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a3fe7bb7e820e1051a8a08119d29382fe87466b", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/5a3fe7bb7e820e1051a8a08119d29382fe87466b", "committedDate": "2020-07-21T10:15:30Z", "message": "Create new migration type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "121497dcba57a5d0f73f6348e0e3b481caefa6fa", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/121497dcba57a5d0f73f6348e0e3b481caefa6fa", "committedDate": "2020-07-21T10:15:30Z", "message": "Make sure key extractor migration works properly on second run"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54eea3c2f4b6fbf26125fe7be3e85d921833717e", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/54eea3c2f4b6fbf26125fe7be3e85d921833717e", "committedDate": "2020-07-21T10:15:30Z", "message": "Set manual form update mode for Google Drive users on upgrade"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82a1f91077344ccd74021ae10c44955e40bb4660", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/82a1f91077344ccd74021ae10c44955e40bb4660", "committedDate": "2020-07-21T10:15:30Z", "message": "Set form update mode to manual when switching to Google Drive"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "247211b7a1ed6e2989f431c2aa655f636f9fe525", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/247211b7a1ed6e2989f431c2aa655f636f9fe525", "committedDate": "2020-07-21T10:15:30Z", "message": "Hide form mode setting when disabled by admin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf412f27a8480250fe371f237dd7290e06ebedcc", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/bf412f27a8480250fe371f237dd7290e06ebedcc", "committedDate": "2020-07-21T10:15:30Z", "message": "Make enums representing arrays consistent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b056529c05c1916185cd0437616b9544b4b9ac7e", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/b056529c05c1916185cd0437616b9544b4b9ac7e", "committedDate": "2020-07-21T10:15:31Z", "message": "make sure background work is setup when settings are imported"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "578158fbcab108a6e71953a234d29eb538cf4c3b", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/578158fbcab108a6e71953a234d29eb538cf4c3b", "committedDate": "2020-07-21T10:15:31Z", "message": "Revise interface around background work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d18746a455a48c3dd960f40bf186b79d10e72ff", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/5d18746a455a48c3dd960f40bf186b79d10e72ff", "committedDate": "2020-07-21T10:15:31Z", "message": "Move background tasks to background package"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMzMxNTU3", "url": "https://github.com/getodk/collect/pull/3977#pullrequestreview-452331557", "createdAt": "2020-07-21T10:35:51Z", "commit": {"oid": "5d18746a455a48c3dd960f40bf186b79d10e72ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMDozNTo1MVrOG0yGqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMDozNTo1MVrOG0yGqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAwMDA0Mg==", "bodyText": "I think really we just need a shared \"lock\" in the app that stops things that make changes running at the same time as here we have to care about multiple things, not everything is covered and there is no real thread safety. I've noted this down and I want to work on it later once we've added error handling for match exactly.", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458000042", "createdAt": "2020-07-21T10:35:51Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/storage/migration/StorageMigrator.java", "diffHunk": "@@ -104,11 +107,11 @@ public StorageMigrationResult migrate() {\n     }\n \n     private boolean isFormUploaderRunning() {\n-        return backgroundWorkManager.isFormUploaderRunning();\n+        return formSubmitManager.isSubmitRunning();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d18746a455a48c3dd960f40bf186b79d10e72ff"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4c1a88878519a1f847d74ef89a400a58393d944", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/d4c1a88878519a1f847d74ef89a400a58393d944", "committedDate": "2020-07-21T10:36:42Z", "message": "Optimize imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0308072f82c407733e1d14cb56ba376d0a60ad7", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/e0308072f82c407733e1d14cb56ba376d0a60ad7", "committedDate": "2020-07-21T10:59:35Z", "message": "Use FormUpdateMode in viewmodels"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f370faf0b47361b4e64bfb3e4bb7b79a3c6df6b", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/4f370faf0b47361b4e64bfb3e4bb7b79a3c6df6b", "committedDate": "2020-07-21T12:04:36Z", "message": "Fix broken test code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f79e92399f693f60d4cea87834e65af7b1ee12a4", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/f79e92399f693f60d4cea87834e65af7b1ee12a4", "committedDate": "2020-07-21T12:30:00Z", "message": "Make sure task spec adapter constructor is public"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3909d3b5cf9cd5789265cf0f88a379ffa6b1cde2", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/3909d3b5cf9cd5789265cf0f88a379ffa6b1cde2", "committedDate": "2020-07-21T13:54:03Z", "message": "Change sync icon when syncing fails"}, "afterCommit": {"oid": "f79e92399f693f60d4cea87834e65af7b1ee12a4", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/f79e92399f693f60d4cea87834e65af7b1ee12a4", "committedDate": "2020-07-21T12:30:00Z", "message": "Make sure task spec adapter constructor is public"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyODM2MTEy", "url": "https://github.com/getodk/collect/pull/3977#pullrequestreview-452836112", "createdAt": "2020-07-21T21:17:42Z", "commit": {"oid": "180b9894c438b551d268576ddce0c6e02e2ea9aa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMToxNzo0MlrOG1KHhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNTowNzo1N1rOG1S4Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM5MzQ3OQ==", "bodyText": "Consider \"Blank form update mode\"? With \"Mode\" you can blink and kind of forget what you're setting the mode of. I think it can use the same string as for the Admin setting (form_update_mode).", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458393479", "createdAt": "2020-07-21T21:17:42Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/res/values/strings.xml", "diffHunk": "@@ -707,4 +707,7 @@\n     <string name=\"legacy_custom_server_paths_summary\">Will be removed in a future version. Please use /formList and /submission on your server.</string>\n     <string name=\"experimental\">Experimental</string>\n     <string name=\"match_exactly\">Exactly match server</string>\n+    <string name=\"update_blank_forms\">Update blank forms</string>\n+    <string name=\"manually\">Manually</string>\n+    <string name=\"form_update_mode_title\">Mode</string>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "180b9894c438b551d268576ddce0c6e02e2ea9aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM5ODUxNg==", "bodyText": "I think this is a good call and turned out nicely. \ud83d\udc4d", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458398516", "createdAt": "2020-07-21T21:27:42Z", "author": {"login": "lognaturel"}, "path": "async/src/main/java/org/odk/collect/async/Scheduler.kt", "diffHunk": "@@ -4,18 +4,27 @@ import java.util.function.Consumer\n import java.util.function.Supplier\n \n /**\n- * Runs tasks in the foreground and background\n+ * Run and schedule tasks in the foreground (UI thread) and background. Based on terminology\n+ * used in Android's Background Processing documentation: https://developer.android.com/guide/background", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19283f41d6b2f1877bbc8ff37560d0eb13f90e28"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQwNDA0Nw==", "bodyText": "Additionally, I think the checkbox should be selected to make it clear that updates always happen automatically in match exactly mode. If the mode changes from match exactly to one of the other modes, the checkbox should be unchecked to indicate that automatic downloads aren't applicable to manual mode or are not on by default for updates to existing forms.\nI think it's ok for the value for the update frequency to stay whatever it was last set to in the case of manual update but I find the disabled automatic download option to be confusing.", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458404047", "createdAt": "2020-07-21T21:39:07Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/feature/settings/FormManagementSettingsTest.java", "diffHunk": "@@ -51,6 +51,29 @@ public Scheduler providesScheduler(WorkManager workManager) {\n             .around(new IdlingResourceRule(new SchedulerIdlingResource(testScheduler)))\n             .around(rule);\n \n+    @Test\n+    public void whenManualUpdatesEnabled_disablesPrefs() {\n+        rule.mainMenu()\n+                .clickOnMenu()\n+                .clickGeneralSettings()\n+                .clickFormManagement()\n+                .clickUpdateForms()\n+                .clickOption(R.string.manually)\n+                .assertDisabled(R.string.form_update_frequency_title)\n+                .assertDisabled(R.string.automatic_download);\n+    }\n+\n+    @Test\n+    public void whenMatchExactlyEnabled_disablesPrefs() {\n+        rule.mainMenu()\n+                .clickOnMenu()\n+                .clickGeneralSettings()\n+                .clickFormManagement()\n+                .clickUpdateForms()\n+                .clickOption(R.string.match_exactly)\n+                .assertDisabled(R.string.automatic_download);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb598da652c87f904d900e9012a944ae8877246a"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQwNTA2NA==", "bodyText": "Yeah, ok, repeat is a better name.", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458405064", "createdAt": "2020-07-21T21:41:12Z", "author": {"login": "lognaturel"}, "path": "async/src/main/java/org/odk/collect/async/Scheduler.kt", "diffHunk": "@@ -46,4 +37,13 @@ interface Scheduler {\n      * Returns true if a deferred task scheduled with tag is currently running\n      */\n     fun isRunning(tag: String): Boolean\n+\n+    /**\n+     * Run a task and then repeat in the foreground\n+     *\n+     * @param foreground the task to be run\n+     * @param repeatPeriod the period between each run of the task\n+     * @return object that allows task to be cancelled\n+     */\n+    fun repeat(foreground: Runnable, repeatPeriod: Long): Cancellable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c11f7ba390304d4326df9153ed550be05feabe7d"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0ODYwNQ==", "bodyText": "I don't understand the changes here. Why not pass in all the SharedPreferences on initialization? It seems they're always available on initialization or it would be more consistent to pass everything in on migration. I thought it was for testing but the one test that uses it does construction and migration on the same line.", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458448605", "createdAt": "2020-07-21T23:35:32Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/application/initialization/MetaPreferenceMigrator.java", "diffHunk": "@@ -32,26 +31,22 @@\n /**\n  * Migrates old preference keys and values to new ones.\n  */\n-public class CollectPreferenceMigrator implements PreferenceMigrator {\n+public class MetaPreferenceMigrator implements PreferenceMigrator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e538bda4bfc576b1f904af35da70db9109e8ccc2"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyMjM3MA==", "bodyText": "And what about the actually does something case?", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458522370", "createdAt": "2020-07-22T04:09:35Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/test/java/org/odk/collect/android/application/initialization/migration/KeyExtractorTest.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package org.odk.collect.android.application.initialization.migration;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import static androidx.test.core.app.ApplicationProvider.getApplicationContext;\n+import static org.odk.collect.android.application.initialization.migration.MigrationUtils.extractNewKey;\n+import static org.odk.collect.android.application.initialization.migration.SharedPreferenceUtils.assertPrefs;\n+import static org.odk.collect.android.application.initialization.migration.SharedPreferenceUtils.assertPrefsEmpty;\n+import static org.odk.collect.android.application.initialization.migration.SharedPreferenceUtils.initPrefs;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class KeyExtractorTest {\n+\n+    private SharedPreferences prefs;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        prefs = getApplicationContext().getSharedPreferences(\"test\", Context.MODE_PRIVATE);\n+    }\n+\n+    @Test\n+    public void whenNewKeyExists_doesNothing() {\n+        initPrefs(prefs,\n+                \"oldKey\", \"oldBlah\",\n+                \"newKey\", \"existing\"\n+        );\n+\n+        extractNewKey(\"newKey\").fromKey(\"oldKey\")\n+                .fromValue(\"oldBlah\").toValue(\"newBlah\")\n+                .apply(prefs);\n+\n+        assertPrefs(prefs,\n+                \"oldKey\", \"oldBlah\",\n+                \"newKey\", \"existing\"\n+        );\n+    }\n+\n+    @Test\n+    public void whenOldKeyMissing_doesNothing() {\n+        initPrefs(prefs);\n+\n+        extractNewKey(\"newKey\").fromKey(\"oldKey\")\n+                .fromValue(\"oldBlah\").toValue(\"newBlah\")\n+                .apply(prefs);\n+\n+        assertPrefsEmpty(prefs);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f79e92399f693f60d4cea87834e65af7b1ee12a4"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyNjg1Nw==", "bodyText": "Since you're replacing with a single line that now has very clear behavior, maybe get rid of this method?\nI think the TODO should be moved to an issue. Yes, I would expect that if auto send is turned on, that immediately attempts to send all pending submissions or enqueues the work if no connection is available. If you're ok with all that I can file the (very much not urgent) issue.", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458526857", "createdAt": "2020-07-22T04:27:34Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2484,16 +2480,7 @@ public void next() {\n      * TODO: if the user changes auto-send settings, should an auto-send job immediately be enqueued?\n      */\n     private void requestAutoSend() {\n-        Constraints constraints = new Constraints.Builder()\n-                .setRequiredNetworkType(NetworkType.CONNECTED)\n-                .build();\n-        OneTimeWorkRequest autoSendWork =\n-                new OneTimeWorkRequest.Builder(AutoSendWorker.class)\n-                        .addTag(AutoSendWorker.TAG)\n-                        .setConstraints(constraints)\n-                        .build();\n-        workManager.beginUniqueWork(AutoSendWorker.TAG,\n-                ExistingWorkPolicy.KEEP, autoSendWork).enqueue();\n+        formSubmitManager.scheduleSubmit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f79e92399f693f60d4cea87834e65af7b1ee12a4"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyOTcyNA==", "bodyText": "Seems either this should cancel submission as well or should be renamed.", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458529724", "createdAt": "2020-07-22T04:39:15Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/backgroundwork/SchedulerFormUpdateAndSubmitManager.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package org.odk.collect.android.backgroundwork;\n+\n+import android.app.Application;\n+import android.content.SharedPreferences;\n+\n+import androidx.work.Constraints;\n+import androidx.work.ExistingWorkPolicy;\n+import androidx.work.NetworkType;\n+import androidx.work.OneTimeWorkRequest;\n+import androidx.work.WorkManager;\n+\n+import org.odk.collect.android.formmanagement.FormUpdateMode;\n+import org.odk.collect.android.upload.AutoSendWorker;\n+import org.odk.collect.async.Scheduler;\n+\n+import static org.odk.collect.android.backgroundwork.BackgroundWorkUtils.getPeriodInMilliseconds;\n+import static org.odk.collect.android.preferences.GeneralKeys.KEY_FORM_UPDATE_MODE;\n+import static org.odk.collect.android.preferences.GeneralKeys.KEY_PERIODIC_FORM_UPDATES_CHECK;\n+\n+public class SchedulerFormUpdateAndSubmitManager implements FormUpdateManager, FormSubmitManager {\n+\n+    private static final String MATCH_EXACTLY_SYNC_TAG = \"match_exactly\";\n+    public static final String AUTO_UPDATE_TAG = \"serverPollingJob\";\n+\n+    private final Scheduler scheduler;\n+    private final SharedPreferences sharedPreferences;\n+    private final Application application;\n+\n+    @Deprecated // Should use Scheduler instance instead\n+    private final WorkManager workManager;\n+\n+    public SchedulerFormUpdateAndSubmitManager(Scheduler scheduler, SharedPreferences sharedPreferences, Application application, WorkManager workManager) {\n+        this.scheduler = scheduler;\n+        this.sharedPreferences = sharedPreferences;\n+        this.application = application;\n+        this.workManager = workManager;\n+    }\n+\n+    @Override\n+    public void scheduleUpdates() {\n+        cancelWork();\n+\n+        String newValue = sharedPreferences.getString(KEY_FORM_UPDATE_MODE, null);\n+        String period = sharedPreferences.getString(KEY_PERIODIC_FORM_UPDATES_CHECK, null);\n+\n+        switch (FormUpdateMode.parse(application, newValue)) {\n+            case MANUAL:\n+                break;\n+            case PREVIOUSLY_DOWNLOADED_ONLY:\n+                scheduleAutoUpdate(getPeriodInMilliseconds(period));\n+                break;\n+            case MATCH_EXACTLY:\n+                scheduleMatchExactlySync(getPeriodInMilliseconds(period));\n+                break;\n+        }\n+    }\n+\n+    private void scheduleMatchExactlySync(long repeatPeriod) {\n+        scheduler.networkDeferred(MATCH_EXACTLY_SYNC_TAG, new SyncFormsTaskSpec(), repeatPeriod);\n+    }\n+\n+    private void scheduleAutoUpdate(long repeatPeriod) {\n+        scheduler.networkDeferred(AUTO_UPDATE_TAG, new AutoUpdateTaskSpec(), repeatPeriod);\n+    }\n+\n+    private void cancelWork() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f79e92399f693f60d4cea87834e65af7b1ee12a4"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMDQyMA==", "bodyText": "I think whenPreviouslyDownloadedOnlyDisabled_stopsCheckingForUpdates verifies that if the mode is changed to manual after being one of the automatic ones, automatic work is cancelled. However, I can't find code for that. Are you sure this line doesn't need to be outside the if to guarantee that a change to manual cancels work?", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458530420", "createdAt": "2020-07-22T04:42:05Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/preferences/FormManagementPreferences.java", "diffHunk": "@@ -145,4 +168,22 @@ public boolean onPreferenceChange(Preference preference, Object newValue) {\n         });\n     }\n \n+    @Override\n+    public void onSharedPreferenceChanged(SharedPreferences sharedPreferences, String key) {\n+        if (key.equals(KEY_FORM_UPDATE_MODE) || key.equals(KEY_PERIODIC_FORM_UPDATES_CHECK)) {\n+            formUpdateManager.scheduleUpdates();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f79e92399f693f60d4cea87834e65af7b1ee12a4"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMTQ2Mg==", "bodyText": "As more of these simple enums get introduced, maybe we should consider constants with typedef annotations? https://developer.android.com/studio/write/annotations.html#enum-annotations It's not a huge amount of memory but it does add up and I think constants/typedef is just as nice.", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458531462", "createdAt": "2020-07-22T04:46:23Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/preferences/Protocol.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.odk.collect.android.preferences;\n+\n+import android.content.Context;\n+\n+import org.odk.collect.android.R;\n+\n+public enum Protocol {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f79e92399f693f60d4cea87834e65af7b1ee12a4"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMzMzNg==", "bodyText": "Nit: lastDetectedHash?", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458533336", "createdAt": "2020-07-22T04:53:52Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/forms/DatabaseFormRepository.java", "diffHunk": "@@ -48,4 +49,32 @@ public void save(Form form) {\n     public void delete(Long id) {\n         new FormsDao().deleteFormsFromIDs(new String[]{id.toString()});\n     }\n+\n+    @Override\n+    public void setLastDetectedUpdated(String jrFormId, String formHash, String manifestHash) {\n+        String formVersionHash = MultiFormDownloader.getMd5Hash(formHash) + manifestHash;\n+\n+        ContentValues values = new ContentValues();\n+        values.put(LAST_DETECTED_FORM_VERSION_HASH, formVersionHash);\n+        new FormsDao().updateForm(values, JR_FORM_ID + \"=?\", new String[]{jrFormId});\n+    }\n+\n+    @Override\n+    public Form getByLastDetectedUpdate(String formHash, String manifestHash) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f79e92399f693f60d4cea87834e65af7b1ee12a4"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzNzAzNA==", "bodyText": "What's the point of the single retry?", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458537034", "createdAt": "2020-07-22T05:07:57Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/previouslydownloaded/ServerFormsUpdateChecker.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package org.odk.collect.android.formmanagement.previouslydownloaded;\n+\n+import org.jetbrains.annotations.Nullable;\n+import org.odk.collect.android.formmanagement.ServerFormDetails;\n+import org.odk.collect.android.formmanagement.ServerFormsDetailsFetcher;\n+import org.odk.collect.android.forms.FormRepository;\n+import org.odk.collect.android.openrosa.api.FormApiException;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static java.util.Collections.emptyList;\n+\n+public class ServerFormsUpdateChecker {\n+\n+    private final ServerFormsDetailsFetcher serverFormsDetailsFetcher;\n+    private final FormRepository formRepository;\n+\n+    public ServerFormsUpdateChecker(ServerFormsDetailsFetcher serverFormsDetailsFetcher, FormRepository formRepository) {\n+        this.serverFormsDetailsFetcher = serverFormsDetailsFetcher;\n+        this.formRepository = formRepository;\n+    }\n+\n+    public List<ServerFormDetails> check() {\n+        try {\n+            List<ServerFormDetails> updatedForms = fetchUpdatedForms();\n+            List<ServerFormDetails> newUpdates = new ArrayList<>();\n+\n+            for (ServerFormDetails serverFormDetails : updatedForms) {\n+                String formHash = serverFormDetails.getHash();\n+                String manifestFileHash = serverFormDetails.getManifestFileHash() != null ? serverFormDetails.getManifestFileHash() : \"\";\n+\n+                if (formRepository.getByLastDetectedUpdate(formHash, manifestFileHash) == null) {\n+                    newUpdates.add(serverFormDetails);\n+                    formRepository.setLastDetectedUpdated(serverFormDetails.getFormId(), formHash, manifestFileHash);\n+                }\n+            }\n+\n+            return newUpdates;\n+        } catch (FormApiException e) {\n+            return emptyList();\n+        }\n+    }\n+\n+    @Nullable\n+    @SuppressWarnings(\"PMD.AvoidRethrowingException\")\n+    private List<ServerFormDetails> fetchUpdatedForms() throws FormApiException {\n+        List<ServerFormDetails> formList = null;\n+\n+        try {\n+            formList = serverFormsDetailsFetcher.fetchFormDetails();\n+        } catch (FormApiException e) {\n+            switch (e.getType()) {\n+                case AUTH_REQUIRED:\n+                    try {\n+                        serverFormsDetailsFetcher.fetchFormDetails();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f79e92399f693f60d4cea87834e65af7b1ee12a4"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd5ade6bfe03314f0c41ab6a6f83e8f181b95b70", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/cd5ade6bfe03314f0c41ab6a6f83e8f181b95b70", "committedDate": "2020-07-22T08:52:09Z", "message": "Use one form mode title"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12b7cfcf16eb0662c1087f4c52a6d3cd982da3e6", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/12b7cfcf16eb0662c1087f4c52a6d3cd982da3e6", "committedDate": "2020-07-22T08:55:27Z", "message": "Add main path test for KeyExtractor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c357c9fc3c2fa8dc379cf3cb635e74b9d629cb9", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/0c357c9fc3c2fa8dc379cf3cb635e74b9d629cb9", "committedDate": "2020-07-22T08:56:46Z", "message": "Remove private method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6815be2f29327e6d787e8cbea0d629dcbc50686", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/c6815be2f29327e6d787e8cbea0d629dcbc50686", "committedDate": "2020-07-22T09:01:00Z", "message": "Move TODO to issue https://github.com/getodk/collect/issues/3980"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae96b5830618d941dd2a68e1d0bf8abe51e9fc42", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/ae96b5830618d941dd2a68e1d0bf8abe51e9fc42", "committedDate": "2020-07-23T16:44:03Z", "message": "Rename prefs migrator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MzgzMDg0", "url": "https://github.com/getodk/collect/pull/3977#pullrequestreview-454383084", "createdAt": "2020-07-23T18:16:17Z", "commit": {"oid": "ae96b5830618d941dd2a68e1d0bf8abe51e9fc42"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2557, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}