{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4Mzg5NTIx", "number": 3992, "title": "Allow forms to be edited after blank form deletion", "bodyText": "Closes #3961. Closes #3991. Blocked by #3986.\nThis also introduces and uses a ChangeLock object that lets make sure that work that updates the forms or instances on device doesn't interfere with each other. There are probably more places this could be used but I focused on making sure places that already made an effort in this direction were covered.\nWhat has been done to verify that this works as intended?\nTried out flows manually and wrote a bunch of new tests.\nWhy is this the best possible solution? Were any other approaches considered?\nTo me it made the most sense to implement this using method objects rather than trying to change the delete logic at the bottom level. This means the logic is separate from any of the implementation of the repositories.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nWith this I think we want to merge to master and then QA there for the whole match exactly feature set.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-07-29T11:54:28Z", "url": "https://github.com/getodk/collect/pull/3992", "merged": true, "mergeCommit": {"oid": "5af55a99df491ee56df711ba0ce5f5d963f6df58"}, "closed": true, "closedAt": "2020-07-31T14:24:18Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5qwYAgBqjM1OTg5NjMyNzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6U-kcAFqTQ1OTIxMTUyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67d6acb4a5c1951778762493f57620261d3d78dd", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/67d6acb4a5c1951778762493f57620261d3d78dd", "committedDate": "2020-07-29T11:33:55Z", "message": "Remove debugging code"}, "afterCommit": {"oid": "2bf4c423197e82b3a045a3b5f37e724d02c26785", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/2bf4c423197e82b3a045a3b5f37e724d02c26785", "committedDate": "2020-07-29T13:08:22Z", "message": "Remove debugging code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MDc3Mzc2", "url": "https://github.com/getodk/collect/pull/3992#pullrequestreview-458077376", "createdAt": "2020-07-30T05:19:06Z", "commit": {"oid": "e0dceabf39e0714da5eb077b043b9973c3721427"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwNToxOTowNlrOG5TemA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwNToxOTowNlrOG5TemA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc0MTE0NA==", "bodyText": "Oops, I already merged Saumia's change for this. Probably should have assigned it to you in the first place.", "url": "https://github.com/getodk/collect/pull/3992#discussion_r462741144", "createdAt": "2020-07-30T05:19:06Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/res/xml/form_management_preferences.xml", "diffHunk": "@@ -14,7 +14,8 @@\n             android:entries=\"@array/form_update_mode_entries\"\n             android:entryValues=\"@array/form_update_mode_values\"\n             android:key=\"form_update_mode\"\n-            android:title=\"@string/form_update_mode_title\" />\n+            android:title=\"@string/form_update_mode_title\"\n+            app:iconSpaceReserved=\"false\" />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0dceabf39e0714da5eb077b043b9973c3721427"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MDc3OTAw", "url": "https://github.com/getodk/collect/pull/3992#pullrequestreview-458077900", "createdAt": "2020-07-30T05:20:41Z", "commit": {"oid": "04a674efceaef3c833bba5838213a426eebabc79"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwNToyMDo0MVrOG5TgVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwNToyNzo1M1rOG5Tn9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc0MTU4OQ==", "bodyText": "I don't understand this.", "url": "https://github.com/getodk/collect/pull/3992#discussion_r462741589", "createdAt": "2020-07-30T05:20:41Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/storage/migration/StorageMigrationResult.java", "diffHunk": "@@ -6,19 +6,16 @@\n \n public enum StorageMigrationResult {\n     SUCCESS,\n-    FORM_UPLOADER_IS_RUNNING,\n-    FORM_DOWNLOADER_IS_RUNNING,\n     NOT_ENOUGH_SPACE,\n-    MOVING_FILES_FAILED;\n+    MOVING_FILES_FAILED,\n+    CHANGES_IN_PROGRESS;\n \n     public String getErrorResultMessage(Context context) {\n         String errorMessage = context.getString(R.string.error) + \" \";\n         switch (this) {\n             case NOT_ENOUGH_SPACE:\n                 return errorMessage + context.getString(R.string.storage_migration_not_enough_space);\n-            case FORM_UPLOADER_IS_RUNNING:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04a674efceaef3c833bba5838213a426eebabc79"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc0MzU0MA==", "bodyText": "Ah, I see. Given this, I'll merge #3986 so you can clear out those commits here and not deal with merge conflicts.", "url": "https://github.com/getodk/collect/pull/3992#discussion_r462743540", "createdAt": "2020-07-30T05:27:53Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/notifications/NotificationManagerNotifier.java", "diffHunk": "@@ -84,11 +84,10 @@ public void onUpdatesDownloaded(HashMap<ServerFormDetails, String> result) {\n     @Override\n     public void onSyncFailure(FormApiException exception) {\n         Intent intent = new Intent(application, FillBlankFormActivity.class);\n-        intent.putExtra(FillBlankFormActivity.EXTRA_AUTH_REQUIRED, true);\n \n-//        if (exception.getType() == FormApiException.Type.AUTH_REQUIRED) {\n-//\n-//        }\n+        if (exception.getType() == FormApiException.Type.AUTH_REQUIRED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bf4c423197e82b3a045a3b5f37e724d02c26785"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bf4c423197e82b3a045a3b5f37e724d02c26785", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/2bf4c423197e82b3a045a3b5f37e724d02c26785", "committedDate": "2020-07-29T13:08:22Z", "message": "Remove debugging code"}, "afterCommit": {"oid": "3336a79c491d9653805c7aa4e54726045cae975d", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/3336a79c491d9653805c7aa4e54726045cae975d", "committedDate": "2020-07-29T13:08:22Z", "message": "Delete soft deleted forms when last instance deleted"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3336a79c491d9653805c7aa4e54726045cae975d", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/3336a79c491d9653805c7aa4e54726045cae975d", "committedDate": "2020-07-29T13:08:22Z", "message": "Delete soft deleted forms when last instance deleted"}, "afterCommit": {"oid": "92ea62158bbd65ebb95e2146521b5f8f3ef49bd1", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/92ea62158bbd65ebb95e2146521b5f8f3ef49bd1", "committedDate": "2020-07-30T09:17:49Z", "message": "Delete soft deleted forms when last instance deleted"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NTMzNjA1", "url": "https://github.com/getodk/collect/pull/3992#pullrequestreview-458533605", "createdAt": "2020-07-30T15:50:07Z", "commit": {"oid": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNTo1MDowN1rOG5pKIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNzoyNjo1M1rOG5szGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5NjM1Mg==", "bodyText": "whenThereFillForms? When there are filled forms?", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463096352", "createdAt": "2020-07-30T15:50:07Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/feature/formmanagement/DeleteBlankFormTest.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package org.odk.collect.android.feature.formmanagement;\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.RuleChain;\n+import org.junit.runner.RunWith;\n+import org.odk.collect.android.support.CollectTestRule;\n+import org.odk.collect.android.support.CopyFormRule;\n+import org.odk.collect.android.support.TestRuleChain;\n+import org.odk.collect.android.support.pages.MainMenuPage;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class DeleteBlankFormTest {\n+\n+    public final CollectTestRule rule = new CollectTestRule();\n+\n+    @Rule\n+    public final RuleChain chain = TestRuleChain.chain()\n+            .around(new CopyFormRule(\"one-question.xml\"))\n+            .around(rule);\n+\n+    @Test\n+    public void deletingAForm_removesFormFromBlankFormList() {\n+        rule.mainMenu()\n+                .clickDeleteSavedForm()\n+                .clickBlankForms()\n+                .clickForm(\"One Question\")\n+                .clickDeleteSelected(1)\n+                .clickDeleteForms()\n+                .pressBack(new MainMenuPage(rule))\n+                .clickFillBlankForm()\n+                .assertTextDoesNotExist(\"One Question\");\n+    }\n+\n+    @Test\n+    public void deletingAForm_whenThereFillForms_allowsEditing() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5NzI5MQ==", "bodyText": "this should be filled form list?", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463097291", "createdAt": "2020-07-30T15:51:27Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/feature/instancemanagement/DeleteFilledFormTest.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package org.odk.collect.android.feature.instancemanagement;\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.RuleChain;\n+import org.junit.runner.RunWith;\n+import org.odk.collect.android.support.CollectTestRule;\n+import org.odk.collect.android.support.CopyFormRule;\n+import org.odk.collect.android.support.TestRuleChain;\n+import org.odk.collect.android.support.pages.MainMenuPage;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class DeleteFilledFormTest {\n+\n+    public final CollectTestRule rule = new CollectTestRule();\n+\n+    @Rule\n+    public final RuleChain chain = TestRuleChain.chain()\n+            .around(new CopyFormRule(\"one-question.xml\"))\n+            .around(rule);\n+\n+    @Test\n+    public void deletingAForm_removesFormFromBlankFormList() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEwMTkxOA==", "bodyText": "We should introduce an alias for this. I guess I only put in aliases for activities with intent-filters but it's entirely possible applications would use explicit intents.", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463101918", "createdAt": "2020-07-30T15:57:59Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/AndroidManifest.xml", "diffHunk": "@@ -116,7 +116,7 @@ the specific language governing permissions and limitations under the License.\n         <activity android:name=\".activities.FillBlankFormActivity\" />\n         <activity android:name=\".activities.FormDownloadListActivity\" />\n         <activity\n-            android:name=\".activities.FileManagerTabs\"\n+            android:name=\".activities.DeleteSavedFormActivity\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEwOTMwOA==", "bodyText": "Just use getAllByJrFormIdAndJrVersion?", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463109308", "createdAt": "2020-07-30T16:09:18Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/FormDeleter.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package org.odk.collect.android.formmanagement;\n+\n+import org.odk.collect.android.forms.Form;\n+import org.odk.collect.android.forms.FormsRepository;\n+import org.odk.collect.android.instances.Instance;\n+import org.odk.collect.android.instances.InstancesRepository;\n+\n+import java.util.List;\n+import java.util.Objects;\n+\n+public class FormDeleter {\n+\n+    private final FormsRepository formsRepository;\n+    private final InstancesRepository instancesRepository;\n+\n+    public FormDeleter(FormsRepository formsRepository, InstancesRepository instancesRepository) {\n+        this.formsRepository = formsRepository;\n+        this.instancesRepository = instancesRepository;\n+    }\n+\n+    public void delete(Long id) {\n+        Form form = formsRepository.get(id);\n+        List<Instance> instances = instancesRepository.getAllByJrFormId(form.getJrFormId());\n+        long instancesForVersion = instances.stream().filter(instance -> Objects.equals(instance.getJrVersion(), form.getJrVersion())).count();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEyNjEzMg==", "bodyText": "Why not use getFormsCursor(String formId, String formVersion)? I think you may need some @NonNull annotations if you just do this.", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463126132", "createdAt": "2020-07-30T16:36:10Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/forms/DatabaseFormsRepository.java", "diffHunk": "@@ -34,6 +37,22 @@ public boolean contains(String jrFormId) {\n         }\n     }\n \n+    @Nullable\n+    @Override\n+    public Form get(Long id) {\n+        try (Cursor cursor = new FormsDao().getFormsCursor(_ID + \"=?\", new String[]{id.toString()})) {\n+            return getFormOrNull(cursor);\n+        }\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Form get(String jrFormId, String jrVersion) {\n+        try (Cursor cursor = new FormsDao().getFormsCursor(JR_FORM_ID + \"=? AND \" + JR_VERSION + \"=?\", new String[]{jrFormId, jrVersion})) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEyODA3NA==", "bodyText": "These names are really reprehensible. Maybe another thing to note for v1.29 cleanup is going further down the line of the DeleteSavedFormActivity rename.", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463128074", "createdAt": "2020-07-30T16:39:27Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/fragments/DataManagerList.java", "diffHunk": "@@ -56,8 +62,16 @@\n     private InstanceSyncTask instanceSyncTask;\n     private ProgressDialog progressDialog;\n \n-    public static DataManagerList newInstance() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMjIwOQ==", "bodyText": "Why not use constructor params? Seems catastrophic to not call this so why even make it possible?", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463132209", "createdAt": "2020-07-30T16:46:09Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/tasks/DeleteInstancesTask.java", "diffHunk": "@@ -100,8 +97,9 @@ public void setDeleteListener(DeleteInstancesListener listener) {\n         deleteInstancesListener = listener;\n     }\n \n-    public void setContentResolver(ContentResolver resolver) {\n-        contentResolver = resolver;\n+    public void setRepositories(InstancesRepository instancesRepository, FormsRepository formsRepository) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0NDkzMA==", "bodyText": "Typo?", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463144930", "createdAt": "2020-07-30T17:07:19Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/res/layout/main_menu.xml", "diffHunk": "@@ -102,7 +102,7 @@\n                         android:layout_width=\"match_parent\"\n                         android:layout_height=\"wrap_content\"\n                         android:layout_marginTop=\"@dimen/margin_extra_small\"\n-                        tools:text=\"@string/manage_files\" />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0NjQ4Mw==", "bodyText": "Whoops, this was a note to self I meant to come back to! But luckily you knew why I was confused.\nOk, I agree a single message is sufficient. I don't think that users know what \"jobs\" means in that context. How about \"Automatic send or blank form download is running. Please try again later.\" You'll also need to change the resource name.", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463146483", "createdAt": "2020-07-30T17:10:16Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/storage/migration/StorageMigrationResult.java", "diffHunk": "@@ -6,19 +6,16 @@\n \n public enum StorageMigrationResult {\n     SUCCESS,\n-    FORM_UPLOADER_IS_RUNNING,\n-    FORM_DOWNLOADER_IS_RUNNING,\n     NOT_ENOUGH_SPACE,\n-    MOVING_FILES_FAILED;\n+    MOVING_FILES_FAILED,\n+    CHANGES_IN_PROGRESS;\n \n     public String getErrorResultMessage(Context context) {\n         String errorMessage = context.getString(R.string.error) + \" \";\n         switch (this) {\n             case NOT_ENOUGH_SPACE:\n                 return errorMessage + context.getString(R.string.storage_migration_not_enough_space);\n-            case FORM_UPLOADER_IS_RUNNING:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc0MTU4OQ=="}, "originalCommit": {"oid": "04a674efceaef3c833bba5838213a426eebabc79"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0ODAyMA==", "bodyText": "Why not use parameter args to guarantee these are set? This seems dangerous.", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463148020", "createdAt": "2020-07-30T17:13:05Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/tasks/DeleteFormsTask.java", "diffHunk": "@@ -96,15 +95,16 @@ public void setDeleteListener(DeleteFormsListener listener) {\n         dl = listener;\n     }\n \n-    public void setContentResolver(ContentResolver resolver) {\n-        cr = resolver;\n-    }\n-\n     public int getDeleteCount() {\n         return successCount;\n     }\n \n     public int getToDeleteCount() {\n         return toDeleteCount;\n     }\n+\n+    public void setRepositories(FormsRepository formsRepository, InstancesRepository instancesRepository) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0OTQxOA==", "bodyText": "Previously, all of the data in the forms table could be recreated from a form definition except for the last detected hash. Now delete adds more state that can't be recreated. Still, the consequences of \"undeleting\" forms on downgrade are not very dire and we don't expect downgrade to be common so let's stick with this and not worry about it. (This is just a note to make the decision explicit to our future selves)", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463149418", "createdAt": "2020-07-30T17:15:32Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/database/helpers/FormsDatabaseHelper.java", "diffHunk": "@@ -125,7 +128,7 @@ public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {\n     public void onDowngrade(SQLiteDatabase db, int oldVersion, int newVersion) {\n         try {\n             SQLiteUtils.dropTable(db, FORMS_TABLE_NAME);\n-            createFormsTableV8(db);\n+            createFormsTableV9(db);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE1NTk5Mg==", "bodyText": "I can't imagine how it would happen but technically this could throw a IllegalMonitorStateException. Maybe catch and ignore out of an abundance of caution?", "url": "https://github.com/getodk/collect/pull/3992#discussion_r463155992", "createdAt": "2020-07-30T17:26:53Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/backgroundwork/ReentrantLockChangeLock.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package org.odk.collect.android.backgroundwork;\n+\n+import java.util.concurrent.locks.ReentrantLock;\n+import java.util.function.Function;\n+\n+public class ReentrantLockChangeLock implements ChangeLock {\n+\n+    private final ReentrantLock lock = new ReentrantLock();\n+\n+    @Override\n+    public <T> T withLock(Function<Boolean, T> function) {\n+        try {\n+            return function.apply(lock.tryLock());\n+        } finally {\n+            lock.unlock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a14bc0d82b76ee24dcf9a1e6720d660ae209b3d"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a037c8ed50c76efbe4e3cfbcbc73418907dc1413", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/a037c8ed50c76efbe4e3cfbcbc73418907dc1413", "committedDate": "2020-07-31T10:43:55Z", "message": "Add change lock to prevent background jobs or migrations running at the same time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b526a9f9f2a7f35cb54d54e376d0526e24ab3c8", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/9b526a9f9f2a7f35cb54d54e376d0526e24ab3c8", "committedDate": "2020-07-31T10:43:55Z", "message": "Add test for deleting form"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0292900ce807fe660f960189abaa1ad6e719e2d9", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/0292900ce807fe660f960189abaa1ad6e719e2d9", "committedDate": "2020-07-31T10:43:55Z", "message": "Only soft delete forms that still have instances on device"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36a3b7e5cda26f098959bfacf20713bf4c043df3", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/36a3b7e5cda26f098959bfacf20713bf4c043df3", "committedDate": "2020-07-31T10:43:55Z", "message": "Only soft delete forms that have unsubmitted instances"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9afdcf7f06cf18169498c61ed7f752e87fe23df3", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/9afdcf7f06cf18169498c61ed7f752e87fe23df3", "committedDate": "2020-07-31T10:43:55Z", "message": "Make sure form soft delete is aware of form versions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0940ea935c5b3c6b590d56329c17755f67467ff6", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/0940ea935c5b3c6b590d56329c17755f67467ff6", "committedDate": "2020-07-31T10:43:55Z", "message": "Handle null version cases for deleting forms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ed87471cfbc3d673f465d2fb5eafbdfbda53551", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/1ed87471cfbc3d673f465d2fb5eafbdfbda53551", "committedDate": "2020-07-31T10:43:55Z", "message": "Use FormDeleter in match exactly sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd6a6c3938ee340a66c5784a508feb4642c05448", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/dd6a6c3938ee340a66c5784a508feb4642c05448", "committedDate": "2020-07-31T10:43:56Z", "message": "Revise locks so that auto send can run at the same time as auto update and match exactly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab565f2435b159430ebbe5f1a7f9342f5efc3fd6", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/ab565f2435b159430ebbe5f1a7f9342f5efc3fd6", "committedDate": "2020-07-31T10:43:56Z", "message": "Allow viewing delete form's instances"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5773d701643e9b80fcede5d4fd66edc75eb4e46f", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/5773d701643e9b80fcede5d4fd66edc75eb4e46f", "committedDate": "2020-07-31T10:43:56Z", "message": "Add tests for deleting instances"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "766afa976b8e4a506eb0bb4613bc340509028ee7", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/766afa976b8e4a506eb0bb4613bc340509028ee7", "committedDate": "2020-07-31T10:43:56Z", "message": "Delete soft deleted forms when last instance deleted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7033c9213bf13647acb72f11a8571bae066dac70", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/7033c9213bf13647acb72f11a8571bae066dac70", "committedDate": "2020-07-31T10:43:56Z", "message": "Hide experimental prefs in release version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eea1de87cb32d9540633ee19a878df1f471c4fcc", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/eea1de87cb32d9540633ee19a878df1f471c4fcc", "committedDate": "2020-07-31T10:43:56Z", "message": "Correct typos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52d5602dc678c96c33a21d64572f5f5797b31449", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/52d5602dc678c96c33a21d64572f5f5797b31449", "committedDate": "2020-07-31T10:43:56Z", "message": "Ignore run time exception coming out of unlock()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fff1a549eabf565ebc0cea18661c50c0c86d5a43", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/fff1a549eabf565ebc0cea18661c50c0c86d5a43", "committedDate": "2020-07-31T10:43:56Z", "message": "Move repos to constructor args in tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "293fe813bfe76ef6bb04741bb2d4250859bae833", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/293fe813bfe76ef6bb04741bb2d4250859bae833", "committedDate": "2020-07-31T10:43:57Z", "message": "Optimize FormDeleter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31dab95a631c3386560418a69f9718c3cf7d2b3d", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/31dab95a631c3386560418a69f9718c3cf7d2b3d", "committedDate": "2020-07-31T10:43:57Z", "message": "Bubble sorting up to method name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaf1b2e3a89d8d7076144263b58c31fd3f5367b9", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/aaf1b2e3a89d8d7076144263b58c31fd3f5367b9", "committedDate": "2020-07-31T10:43:57Z", "message": "Update background job error message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8fd43d04d021733f64c883374c2c0beb4bb9e22", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/c8fd43d04d021733f64c883374c2c0beb4bb9e22", "committedDate": "2020-07-31T10:43:57Z", "message": "Update test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa741bba98b993603b68d74964bd1ed3a37daa93", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/aa741bba98b993603b68d74964bd1ed3a37daa93", "committedDate": "2020-07-31T09:36:13Z", "message": "Update test"}, "afterCommit": {"oid": "c8fd43d04d021733f64c883374c2c0beb4bb9e22", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/c8fd43d04d021733f64c883374c2c0beb4bb9e22", "committedDate": "2020-07-31T10:43:57Z", "message": "Update test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "307925a6c1af38192ac6241afabe2374262c13d7", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/307925a6c1af38192ac6241afabe2374262c13d7", "committedDate": "2020-07-31T11:14:00Z", "message": "Allow null versions when querying instances"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MjExNTIx", "url": "https://github.com/getodk/collect/pull/3992#pullrequestreview-459211521", "createdAt": "2020-07-31T14:20:08Z", "commit": {"oid": "307925a6c1af38192ac6241afabe2374262c13d7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2564, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}