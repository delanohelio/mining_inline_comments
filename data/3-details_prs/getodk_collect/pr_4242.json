{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NTEyMzIx", "number": 4242, "title": "Fixed: Minimal appearance doesn't work with \"fast external itemsets\"", "bodyText": "Closes #4051\nWhat has been done to verify that this works as intended?\nI tested the fix manually and added automated tests.\nWhy is this the best possible solution? Were any other approaches considered?\nI decided to get rid of the ItemsetWidget and just read all items in our ItemsWidget thanks to that I can use the same appearances we use in other selects no mater if items come from a form file on an external csv  file.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nPrior to this change we used a separate widget called ItemsetWIdget to handle fast external itemsets now I go rrid of it and we sue the same widgets everywhere selects no mater if items come from a form file on an external csv  file. That means the risk is in handling those fast external itemsets and that's what we need to test additionally it would be good to check normal selects for regression.\nDo we need any specific form for testing your changes? If so, please attach one.\nI used:\nselectOneExternal.zip\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nNo.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-11-24T14:20:22Z", "url": "https://github.com/getodk/collect/pull/4242", "merged": true, "mergeCommit": {"oid": "3b518be0145aefe68bfcf979aded86ef1f01c496"}, "closed": true, "closedAt": "2020-12-03T11:38:04Z", "author": {"login": "grzesiek2010"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfSISjAH2gAyNTI2NTEyMzIxOmM1OWRiMDM1NjVkMGJhODIwNjcxOGYwNjQ0MGM5Y2I5ZGU0YzVjN2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhoEJUAFqTU0MTA4NjM0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c59db03565d0ba8206718f06440c9cb9de4c5c7f", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/c59db03565d0ba8206718f06440c9cb9de4c5c7f", "committedDate": "2020-11-23T09:56:14Z", "message": "Factored out FastExternalItemsReader class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4dd1c7b16732c5bd3432461121e7b6c31c060199", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/4dd1c7b16732c5bd3432461121e7b6c31c060199", "committedDate": "2020-11-23T09:59:58Z", "message": "Read fast external items in ItemsWidget using FastExternalItemsReader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5460a71e2db8739740e222a2de60bd19a6e62dbe", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/5460a71e2db8739740e222a2de60bd19a6e62dbe", "committedDate": "2020-11-23T10:03:08Z", "message": "Removed redundant ItemsetWidget"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f545071ac4174528f9d9c53309b254ff408e38e", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/7f545071ac4174528f9d9c53309b254ff408e38e", "committedDate": "2020-11-23T10:11:05Z", "message": "Fixed pmd issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de9dfb3ee05353d9f63a4ae1729e6d45fe782b1f", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/de9dfb3ee05353d9f63a4ae1729e6d45fe782b1f", "committedDate": "2020-11-23T10:20:45Z", "message": "Display a warrning when csv file is missing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ded299e694a554a877bd2c2ba3d6ae74fdddf18", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/0ded299e694a554a877bd2c2ba3d6ae74fdddf18", "committedDate": "2020-11-23T10:31:12Z", "message": "Handle XPathSyntaxException while reading fast external items"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dc90ff1887801f5a7edfbaa69a2e77e46155df7", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/3dc90ff1887801f5a7edfbaa69a2e77e46155df7", "committedDate": "2020-11-23T10:32:35Z", "message": "Code improvements in ItemsWidget"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6373f647aae3d7d88f8fcbb80e75c6a1df9f2024", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/6373f647aae3d7d88f8fcbb80e75c6a1df9f2024", "committedDate": "2020-11-23T12:42:45Z", "message": "Fixed reading saved answers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd60362a6f910cbde564e3353354b239c2b50f01", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/bd60362a6f910cbde564e3353354b239c2b50f01", "committedDate": "2020-11-24T10:49:00Z", "message": "Removed unused ItemsetQuestionDetails class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d6ccf2e019abd37c0266646e6fa2aef2d0f88b4", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/6d6ccf2e019abd37c0266646e6fa2aef2d0f88b4", "committedDate": "2020-11-24T10:58:29Z", "message": "Created a separate package for fast external itemset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fb6a7dd3ab2ea19322af2c98f2b8e219d33355e", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/4fb6a7dd3ab2ea19322af2c98f2b8e219d33355e", "committedDate": "2020-11-24T12:08:54Z", "message": "Merged ItemsetReader and ItemsetDao"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3724547d4cd74081fb40a94ff94bd943abe0ab8", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/b3724547d4cd74081fb40a94ff94bd943abe0ab8", "committedDate": "2020-11-24T12:13:40Z", "message": "Moved XPathParseTool to fastexternalitemset package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2067ad8f3b3b20a25ab7d8d434913d778d536a46", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/2067ad8f3b3b20a25ab7d8d434913d778d536a46", "committedDate": "2020-11-24T12:20:06Z", "message": "Use showWarning() to display a warning if XPathSyntaxException is thrown like we do in case of FileNotFoundException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f3fa0ab3727ff62b4f8f28ad90ed53c9e2865dd", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/3f3fa0ab3727ff62b4f8f28ad90ed53c9e2865dd", "committedDate": "2020-11-24T13:18:10Z", "message": "Avoid NPE in isFastExternalItemsetWidget"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d36c4d135a25a8a2b62f7f0618b93775c44dc30", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/7d36c4d135a25a8a2b62f7f0618b93775c44dc30", "committedDate": "2020-11-24T14:04:32Z", "message": "Added tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d643a80a0d6ab8a1038ad238d802fc3251930958", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/d643a80a0d6ab8a1038ad238d802fc3251930958", "committedDate": "2020-11-24T14:48:37Z", "message": "Fixed reading answers in ListWidget"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55ee028bff2cbe72fc26f65e37b61ddccd67186b", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/55ee028bff2cbe72fc26f65e37b61ddccd67186b", "committedDate": "2020-11-24T14:55:06Z", "message": "Fixed reading answers in SelectOneImageMapWidget"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MDEzMTA5", "url": "https://github.com/getodk/collect/pull/4242#pullrequestreview-538013109", "createdAt": "2020-11-24T22:18:14Z", "commit": {"oid": "4dd1c7b16732c5bd3432461121e7b6c31c060199"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMjoxODoxNVrOH5YbsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMjo0MTowN1rOH5Z67A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzMTE4NA==", "bodyText": "This should be another branch along with the search() identification. Currently that is in readItems. I vaguely remember we had some back and forth about whether readItems should be separate and maybe it was related to \"fast external itemsets.\" My preference would be to have the three branches in the constructur and not have readItems at all.", "url": "https://github.com/getodk/collect/pull/4242#discussion_r529931184", "createdAt": "2020-11-24T22:18:15Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/items/ItemsWidget.java", "diffHunk": "@@ -40,7 +44,15 @@\n \n     public ItemsWidget(Context context, QuestionDetails prompt) {\n         super(context, prompt);\n-        readItems();\n+        if (isFastExternalItemsetWidget()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dd1c7b16732c5bd3432461121e7b6c31c060199"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkzNjM5MQ==", "bodyText": "How was this done before? It'd be ideal not to loop through all items.", "url": "https://github.com/getodk/collect/pull/4242#discussion_r529936391", "createdAt": "2020-11-24T22:23:11Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/utilities/SelectOneWidgetUtils.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package org.odk.collect.android.utilities;\n+\n+import org.javarosa.core.model.SelectChoice;\n+import org.javarosa.core.model.data.IAnswerData;\n+import org.javarosa.core.model.data.SelectOneData;\n+import org.javarosa.core.model.data.StringData;\n+import org.javarosa.core.model.data.helper.Selection;\n+import org.javarosa.form.api.FormEntryPrompt;\n+\n+import java.util.List;\n+\n+public class SelectOneWidgetUtils {\n+\n+    private SelectOneWidgetUtils() {\n+\n+    }\n+\n+    public static Selection getSelectedItem(FormEntryPrompt prompt, List<SelectChoice> items) {\n+        IAnswerData answer = prompt.getAnswerValue();\n+        if (answer == null) {\n+            return null;\n+        } else if (answer instanceof SelectOneData) {\n+            return (Selection) answer.getValue();\n+        } else if (answer instanceof StringData) { // Fast external itemset\n+            for (SelectChoice item : items) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6373f647aae3d7d88f8fcbb80e75c6a1df9f2024"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk1NTU2NA==", "bodyText": "I think introducing a new package to group what you have is a great idea. I wonder whether it should be top-level, though. It could be in formentry or widgets. While here, I wonder what the itemset package and Itemset class were supposed to be for. Seems they can be removed.", "url": "https://github.com/getodk/collect/pull/4242#discussion_r529955564", "createdAt": "2020-11-24T22:41:07Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/fastexternalitemset/ItemsetDbAdapter.java", "diffHunk": "@@ -1,11 +1,12 @@\n-package org.odk.collect.android.database;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55ee028bff2cbe72fc26f65e37b61ddccd67186b"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a36c3c17df50bb11ad1474102873b8cc21939f9", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/6a36c3c17df50bb11ad1474102873b8cc21939f9", "committedDate": "2020-11-24T23:28:42Z", "message": "Removed unused code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b023c3a1a11ed8b7a8017763d7d2714ec3e28597", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/b023c3a1a11ed8b7a8017763d7d2714ec3e28597", "committedDate": "2020-11-25T14:11:01Z", "message": "Code improvements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMDg2MzQx", "url": "https://github.com/getodk/collect/pull/4242#pullrequestreview-541086341", "createdAt": "2020-11-30T16:37:28Z", "commit": {"oid": "b023c3a1a11ed8b7a8017763d7d2714ec3e28597"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2485, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}