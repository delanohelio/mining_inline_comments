{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwODAwODcy", "number": 4314, "title": "Add logging", "bodyText": "The first commit is to try to get more information on this exception (needs auth). It happens on form save, generally triggered by onPause but sometimes also by manually exiting out of the form. The user experience is that a dialog is shown with the NullPointerException message. I believe that in case of a manual exit out of the form, the user is forced to tap \"OK\" and then their data is lost rather than saved. When this is triggered by onPause, it's possible that there would be a later opportunity to save again. Either way, we don't want this happening. It seems pretty clear it only affects v1.28.x and I suspect a JavaRosa issue though I can't see what it would be. Hopefully getting more information on the shape of the reference that causes this problem will help.\nThe second commit is for troubleshooting this exception. On instance save, in the code path where this is the first time the instance is being saved, there can be a crash on attempt to get the blank form corresponding to the new instance. One possible issue I saw is that the field uri was updated when a local variable should have been used. This looks like a very safe change so I made it but can also revert if preferred. I also added logging.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-12-16T00:09:09Z", "url": "https://github.com/getodk/collect/pull/4314", "merged": true, "mergeCommit": {"oid": "c63850e101c7935c5b87f308a249cac3e14c715a"}, "closed": true, "closedAt": "2020-12-17T18:20:12Z", "author": {"login": "lognaturel"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmjcZTgH2gAyNTQwODAwODcyOmE3MjM5NzU1YzFjNjUwMjJkMzMyMDNiZjZiZTcyZDgxNmMyMjZmNGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnHL8oAFqTU1NDgzODgwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a7239755c1c65022d33203bf6be72d816c226f4a", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/a7239755c1c65022d33203bf6be72d816c226f4a", "committedDate": "2020-12-16T00:04:03Z", "message": "Add logging for saveAnswer failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMjE1OTE1", "url": "https://github.com/getodk/collect/pull/4314#pullrequestreview-553215915", "createdAt": "2020-12-16T00:59:54Z", "commit": {"oid": "3b528a8948ed38c03f0c57dff87001c330bd1c81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwMDo1OTo1NFrOIGm2Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwMDo1OTo1NFrOIGm2Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5ODgwMw==", "bodyText": "This should not have been reusing the field as it's just used locally. One idea I have for why this crash happens is that somehow there is an instance that matches the path in the DB but the update fails. Then the else branch below is hit but the uri is set to the instance uri rather than the form uri as it should be. This feels like a really safe fix to me but it would be good to get confirmation.", "url": "https://github.com/getodk/collect/pull/4314#discussion_r543798803", "createdAt": "2020-12-16T00:59:54Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/tasks/SaveFormToDisk.java", "diffHunk": "@@ -212,9 +210,9 @@ private void updateInstanceDatabase(boolean incomplete, boolean canEditAfterComp\n             InstancesRepository instances = new DatabaseInstancesRepository();\n             Instance instance = instances.getOneByPath(instancePath);\n             if (instance != null) {\n-                uri = Uri.withAppendedPath(InstanceColumns.CONTENT_URI, instance.getId().toString());\n+                Uri instanceUri = Uri.withAppendedPath(InstanceColumns.CONTENT_URI, instance.getId().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b528a8948ed38c03f0c57dff87001c330bd1c81"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNjYzMjkx", "url": "https://github.com/getodk/collect/pull/4314#pullrequestreview-553663291", "createdAt": "2020-12-16T13:02:17Z", "commit": {"oid": "a7239755c1c65022d33203bf6be72d816c226f4a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxMzowMjoxN1rOIHEO8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxMzowODowMlrOIHEcxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI4MDMwNg==", "bodyText": "Does this not need to be Timber.e?", "url": "https://github.com/getodk/collect/pull/4314#discussion_r544280306", "createdAt": "2020-12-16T13:02:17Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/javarosawrapper/FormController.java", "diffHunk": "@@ -516,6 +516,9 @@ public boolean saveAnswer(FormIndex index, IAnswerData data) throws JavaRosaExce\n         try {\n             return formEntryController.saveAnswer(index, data, true);\n         } catch (Exception e) {\n+            Timber.w(\"Error saving answer of type %s with ref %s for index %s\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7239755c1c65022d33203bf6be72d816c226f4a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI4MTA0NQ==", "bodyText": "Again I thought these had to be Timber.e but I could be wrong.", "url": "https://github.com/getodk/collect/pull/4314#discussion_r544281045", "createdAt": "2020-12-16T13:03:35Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/tasks/SaveFormToDisk.java", "diffHunk": "@@ -231,7 +229,11 @@ private void updateInstanceDatabase(boolean incomplete, boolean canEditAfterComp\n             } else {\n                 Timber.i(\"No instance found, creating\");\n                 try (Cursor c = Collect.getInstance().getContentResolver().query(uri, null, null, null, null)) {\n-                    // retrieve the form definition...\n+                    // retrieve the form definition\n+                    if (c.getCount() != 1) {\n+                        Timber.w(\"No matching form found for %s\", uri);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b528a8948ed38c03f0c57dff87001c330bd1c81"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI4Mzg0Ng==", "bodyText": "Ach I'm in two minds. I think your explanation makes sense, but I'm a little worried about merging this in during regression testing especially as it's not tested. How do you feel about this being pulled out as a separate change (we can potentially as an issue) so we can add tests around it and merge later?", "url": "https://github.com/getodk/collect/pull/4314#discussion_r544283846", "createdAt": "2020-12-16T13:08:02Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/tasks/SaveFormToDisk.java", "diffHunk": "@@ -212,9 +210,9 @@ private void updateInstanceDatabase(boolean incomplete, boolean canEditAfterComp\n             InstancesRepository instances = new DatabaseInstancesRepository();\n             Instance instance = instances.getOneByPath(instancePath);\n             if (instance != null) {\n-                uri = Uri.withAppendedPath(InstanceColumns.CONTENT_URI, instance.getId().toString());\n+                Uri instanceUri = Uri.withAppendedPath(InstanceColumns.CONTENT_URI, instance.getId().toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5ODgwMw=="}, "originalCommit": {"oid": "3b528a8948ed38c03f0c57dff87001c330bd1c81"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b528a8948ed38c03f0c57dff87001c330bd1c81", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/3b528a8948ed38c03f0c57dff87001c330bd1c81", "committedDate": "2020-12-16T00:49:46Z", "message": "Add logging for crash when saving new instance"}, "afterCommit": {"oid": "9b78668c914c6ccd8223ad7d1f4c4ae4e1bfbea6", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/9b78668c914c6ccd8223ad7d1f4c4ae4e1bfbea6", "committedDate": "2020-12-16T16:51:07Z", "message": "Add logging for crash when saving new instance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzOTM1MDcz", "url": "https://github.com/getodk/collect/pull/4314#pullrequestreview-553935073", "createdAt": "2020-12-16T17:46:23Z", "commit": {"oid": "3a8d9a599f1433b0113a4d8fb1050934571fd313"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzOTM5NzA1", "url": "https://github.com/getodk/collect/pull/4314#pullrequestreview-553939705", "createdAt": "2020-12-16T17:52:08Z", "commit": {"oid": "3a8d9a599f1433b0113a4d8fb1050934571fd313"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNzo1MjowOFrOIHRyNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNzo1MjowOFrOIHRyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUwMjMyNw==", "bodyText": "Ok sorry now I'm being really paranoid, but I think it'd be good to make that we account for null data or index so there is no risk of ending up with a NullPointerException here.", "url": "https://github.com/getodk/collect/pull/4314#discussion_r544502327", "createdAt": "2020-12-16T17:52:08Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/javarosawrapper/FormController.java", "diffHunk": "@@ -516,6 +516,9 @@ public boolean saveAnswer(FormIndex index, IAnswerData data) throws JavaRosaExce\n         try {\n             return formEntryController.saveAnswer(index, data, true);\n         } catch (Exception e) {\n+            Timber.w(\"Error saving answer of type %s with ref %s for index %s\",\n+                    data.getClass().toString(), index.getReference(), index);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a8d9a599f1433b0113a4d8fb1050934571fd313"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzOTQwODg0", "url": "https://github.com/getodk/collect/pull/4314#pullrequestreview-553940884", "createdAt": "2020-12-16T17:53:29Z", "commit": {"oid": "3a8d9a599f1433b0113a4d8fb1050934571fd313"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a8224e4e0b522360916dfdab01472121f1f01a8", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/8a8224e4e0b522360916dfdab01472121f1f01a8", "committedDate": "2020-12-16T17:56:39Z", "message": "Add logging for crash when saving new instance"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a8d9a599f1433b0113a4d8fb1050934571fd313", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/3a8d9a599f1433b0113a4d8fb1050934571fd313", "committedDate": "2020-12-16T17:13:29Z", "message": "Adjust log levels to reduce noise"}, "afterCommit": {"oid": "4a831e3d41807f05ab59e87cd5b7d8c864f2b295", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/4a831e3d41807f05ab59e87cd5b7d8c864f2b295", "committedDate": "2020-12-16T17:56:42Z", "message": "Adjust log levels to reduce noise"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4a831e3d41807f05ab59e87cd5b7d8c864f2b295", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/4a831e3d41807f05ab59e87cd5b7d8c864f2b295", "committedDate": "2020-12-16T17:56:42Z", "message": "Adjust log levels to reduce noise"}, "afterCommit": {"oid": "40ef6277f15b8e99318ced52373d7ac162e88920", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/40ef6277f15b8e99318ced52373d7ac162e88920", "committedDate": "2020-12-16T18:14:14Z", "message": "Adjust log levels to reduce noise"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzOTYzMTY4", "url": "https://github.com/getodk/collect/pull/4314#pullrequestreview-553963168", "createdAt": "2020-12-16T18:20:57Z", "commit": {"oid": "40ef6277f15b8e99318ced52373d7ac162e88920"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxODoyMDo1OFrOIHS9lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxODoyMDo1OFrOIHS9lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUyMTYyMQ==", "bodyText": "This is the top reporting issue in Firebase but it's expected because there could be an attempt to get the phone number before permissions were prompted for.", "url": "https://github.com/getodk/collect/pull/4314#discussion_r544521621", "createdAt": "2020-12-16T18:20:58Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/logic/PropertyManager.java", "diffHunk": "@@ -94,7 +94,7 @@ public PropertyManager reload() {\n             putProperty(PROPMGR_DEVICE_ID,     \"\",         deviceDetailsProvider.getDeviceId());\n             putProperty(PROPMGR_PHONE_NUMBER,  SCHEME_TEL,          deviceDetailsProvider.getLine1Number());\n         } catch (SecurityException e) {\n-            Timber.e(e);\n+            Timber.i(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40ef6277f15b8e99318ced52373d7ac162e88920"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3fe90d057c7b4367a72632e37edb2dd84c5a8bf", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/a3fe90d057c7b4367a72632e37edb2dd84c5a8bf", "committedDate": "2020-12-16T22:00:08Z", "message": "Adjust log levels to reduce noise"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40ef6277f15b8e99318ced52373d7ac162e88920", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/40ef6277f15b8e99318ced52373d7ac162e88920", "committedDate": "2020-12-16T18:14:14Z", "message": "Adjust log levels to reduce noise"}, "afterCommit": {"oid": "a3fe90d057c7b4367a72632e37edb2dd84c5a8bf", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/a3fe90d057c7b4367a72632e37edb2dd84c5a8bf", "committedDate": "2020-12-16T22:00:08Z", "message": "Adjust log levels to reduce noise"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0ODM4ODA5", "url": "https://github.com/getodk/collect/pull/4314#pullrequestreview-554838809", "createdAt": "2020-12-17T17:42:40Z", "commit": {"oid": "a3fe90d057c7b4367a72632e37edb2dd84c5a8bf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2375, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}