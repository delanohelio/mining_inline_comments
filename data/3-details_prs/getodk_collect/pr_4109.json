{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwOTMzNTI4", "number": 4109, "title": "Restore soft deleted forms that have been re added to the forms folder", "bodyText": "Closes #4103\nThe main change here is that the form now has a deleted_date column rather than a deleted one. This allows us to check whether the form file on disk is newer than the deleted date or not so we can \"restore\" soft deleted forms.\nWhat has been done to verify that this works as intended?\nChecked manually and wrote new Espresso test.\nWhy is this the best possible solution? Were any other approaches considered?\nComments inline.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nShould just fix the problem but good to check form downloading (with servers and google drive) and form deletion with and without filled forms.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-09-22T13:16:55Z", "url": "https://github.com/getodk/collect/pull/4109", "merged": true, "mergeCommit": {"oid": "7296ba77340714abab56248e9308582db36f5c7a"}, "closed": true, "closedAt": "2020-09-22T17:04:55Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLT_66gH2gAyNDkwOTMzNTI4OjM1ZjZlMzNjZGJlMGRjNzA2Nzk2OWRiNDQ4MTEwNDZkMzc5NmRkYTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLZL2FAFqTQ5MzU0MDkwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "35f6e33cdbe0dc7067969db44811046d3796dda0", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/35f6e33cdbe0dc7067969db44811046d3796dda0", "committedDate": "2020-09-22T08:48:25Z", "message": "Move test to correct package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c75abc8f07505baffc1a412f428035b410c8b23", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/4c75abc8f07505baffc1a412f428035b410c8b23", "committedDate": "2020-09-22T09:40:04Z", "message": "Add test that fails when trying to copy deleted form manually"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b809a235a5987b8f3684d87cafa29bb11b8706a0", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/b809a235a5987b8f3684d87cafa29bb11b8706a0", "committedDate": "2020-09-22T12:19:25Z", "message": "Use date to track soft deleted forms\n\nThis will \"undelete\" soft deleted forms on devices with the current beta\ninstalled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d31baab75aaad64a526347e5eb01e079911ea153", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/d31baab75aaad64a526347e5eb01e079911ea153", "committedDate": "2020-09-22T12:49:26Z", "message": "Restore forms when added via adb after being soft deleted"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNDU3NzA2", "url": "https://github.com/getodk/collect/pull/4109#pullrequestreview-493457706", "createdAt": "2020-09-22T13:27:27Z", "commit": {"oid": "d31baab75aaad64a526347e5eb01e079911ea153"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMzoyNzoyN1rOHV5_tQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMzoyNzoyN1rOHV5_tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjczMjM0MQ==", "bodyText": "It would be nice to have this tested at a lower level but the disk sync code is definitely not ready for that. For another day.\nHonestly it feels like getting a disk (and Google Drive) based  implementation of FormApi together would solve a lot of problems. Then code to add and sync forms could be shared between all these sources. I've added a note to STATE.md about this.", "url": "https://github.com/getodk/collect/pull/4109#discussion_r492732341", "createdAt": "2020-09-22T13:27:27Z", "author": {"login": "seadowg"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/feature/formmanagement/DeleteBlankFormTest.java", "diffHunk": "@@ -89,4 +92,25 @@ public void afterFillingAForm_andDeletingIt_allowsFormToBeReDownloaded() {\n                 .clickOK(new MainMenuPage(rule))\n                 .startBlankForm(\"One Question\");\n     }\n+\n+    @Test\n+    public void afterFillingAForm_andDeletingIt_allowsFormToBeReloadedDirectly() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d31baab75aaad64a526347e5eb01e079911ea153"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNDYyNDMz", "url": "https://github.com/getodk/collect/pull/4109#pullrequestreview-493462433", "createdAt": "2020-09-22T13:32:13Z", "commit": {"oid": "d31baab75aaad64a526347e5eb01e079911ea153"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMzozMjoxM1rOHV6NUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMzozMjoxM1rOHV6NUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjczNTgyNg==", "bodyText": "My thinking is we need a migration here as we already have version 9 of the database out in the wild.", "url": "https://github.com/getodk/collect/pull/4109#discussion_r492735826", "createdAt": "2020-09-22T13:32:13Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/database/DatabaseConstants.java", "diffHunk": "@@ -3,7 +3,7 @@\n public class DatabaseConstants {\n \n     public static final String FORMS_TABLE_NAME = \"forms\";\n-    public static final int FORMS_DATABASE_VERSION = 9;\n+    public static final int FORMS_DATABASE_VERSION = 10;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d31baab75aaad64a526347e5eb01e079911ea153"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNDYzNDgz", "url": "https://github.com/getodk/collect/pull/4109#pullrequestreview-493463483", "createdAt": "2020-09-22T13:33:20Z", "commit": {"oid": "d31baab75aaad64a526347e5eb01e079911ea153"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMzozMzoyMFrOHV6QWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMzozMzoyMFrOHV6QWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjczNjYwMQ==", "bodyText": "This migration won't actually carry over the state from the old deleted column. My assumption is that it's ok for beta users to have their form \"restored\" if they'd already soft deleted it when they install the update.", "url": "https://github.com/getodk/collect/pull/4109#discussion_r492736601", "createdAt": "2020-09-22T13:33:20Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/database/FormDatabaseMigrator.java", "diffHunk": "@@ -223,6 +225,17 @@ private void upgradeToVersion9(SQLiteDatabase db) {\n         SQLiteUtils.dropTable(db, temporaryTable);\n     }\n \n+    private void upgradeToVersion10(SQLiteDatabase db) {\n+        String temporaryTable = FORMS_TABLE_NAME + \"_tmp\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d31baab75aaad64a526347e5eb01e079911ea153"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f017f5dcca6b30a58bd65a40dae392967371c5c", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/9f017f5dcca6b30a58bd65a40dae392967371c5c", "committedDate": "2020-09-22T13:37:49Z", "message": "Update STATE.md"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNTQwOTAy", "url": "https://github.com/getodk/collect/pull/4109#pullrequestreview-493540902", "createdAt": "2020-09-22T14:45:39Z", "commit": {"oid": "b809a235a5987b8f3684d87cafa29bb11b8706a0"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNDo0NTozOVrOHV9ymw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNDo0NzoxOFrOHV93yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5NDUyMw==", "bodyText": "Yes, absolutely.", "url": "https://github.com/getodk/collect/pull/4109#discussion_r492794523", "createdAt": "2020-09-22T14:45:39Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/database/DatabaseConstants.java", "diffHunk": "@@ -3,7 +3,7 @@\n public class DatabaseConstants {\n \n     public static final String FORMS_TABLE_NAME = \"forms\";\n-    public static final int FORMS_DATABASE_VERSION = 9;\n+    public static final int FORMS_DATABASE_VERSION = 10;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjczNTgyNg=="}, "originalCommit": {"oid": "d31baab75aaad64a526347e5eb01e079911ea153"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5NTg1MA==", "bodyText": "Yes, fine by me. @opendatakit/testers note that this is expected.", "url": "https://github.com/getodk/collect/pull/4109#discussion_r492795850", "createdAt": "2020-09-22T14:47:18Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/database/FormDatabaseMigrator.java", "diffHunk": "@@ -223,6 +225,17 @@ private void upgradeToVersion9(SQLiteDatabase db) {\n         SQLiteUtils.dropTable(db, temporaryTable);\n     }\n \n+    private void upgradeToVersion10(SQLiteDatabase db) {\n+        String temporaryTable = FORMS_TABLE_NAME + \"_tmp\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjczNjYwMQ=="}, "originalCommit": {"oid": "d31baab75aaad64a526347e5eb01e079911ea153"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2404, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}