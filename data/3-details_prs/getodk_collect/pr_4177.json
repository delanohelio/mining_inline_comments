{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2NzE1NzY3", "number": 4177, "title": "3780 restore exif data after rotate or resize", "bodyText": "Closes #3780\n\nWhat has been done to verify that this works as intended?\nUse a form (with default imagewidget) to \"capture image\".\nTried with updating image size (for scaling) on settings as well as rotating the phone on capturing images.\nUse exif viewer app (ExifTool) to view the exif information or\nSubmit the form to a server which can parse those exif information\nWhy is this the best possible solution? Were any other approaches considered?\nIt is simplest.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nIt avoids the exif data from being removed.\nDo we need any specific form for testing your changes? If so, please attach one.\nAny form with default image widget is enough as mentioned above.\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nNo. It's a bug fix. So I dont think we need any documentation\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-10-20T11:31:57Z", "url": "https://github.com/getodk/collect/pull/4177", "merged": true, "mergeCommit": {"oid": "84cf379edb3caa8b2ad39cd4c83c585bfeac1201"}, "closed": true, "closedAt": "2020-11-13T10:01:51Z", "author": {"login": "ItloMd9"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUWx5cAH2gAyNTA2NzE1NzY3OmE4ODdiZDk5ZDg5NWI1NWQyMjYzMmE2YjA5OTBiOTg4MzZiZmUwNDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXU2hkgFqTUxOTg1OTY0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a887bd99d895b55d22632a6b0990b98836bfe047", "author": {"user": {"login": "ItloMd9", "name": "Khuong Ninh"}}, "url": "https://github.com/getodk/collect/commit/a887bd99d895b55d22632a6b0990b98836bfe047", "committedDate": "2020-10-20T11:08:08Z", "message": "issue #3780. Restore exif data after rotate or resize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9a63588fa40afb0703637dba76572426212346c", "author": {"user": {"login": "ItloMd9", "name": "Khuong Ninh"}}, "url": "https://github.com/getodk/collect/commit/b9a63588fa40afb0703637dba76572426212346c", "committedDate": "2020-10-20T11:19:46Z", "message": "issue #3780. Add function comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7de0e3340344aeec4e9ba0bb06f66c2084e70828", "author": {"user": {"login": "ItloMd9", "name": "Khuong Ninh"}}, "url": "https://github.com/getodk/collect/commit/7de0e3340344aeec4e9ba0bb06f66c2084e70828", "committedDate": "2020-10-26T02:35:34Z", "message": "issue_#3780. Restore Exif data after rotation and resizing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NzQ5NzA1", "url": "https://github.com/getodk/collect/pull/4177#pullrequestreview-516749705", "createdAt": "2020-10-26T12:59:41Z", "commit": {"oid": "7de0e3340344aeec4e9ba0bb06f66c2084e70828"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NDgyMTAx", "url": "https://github.com/getodk/collect/pull/4177#pullrequestreview-517482101", "createdAt": "2020-10-27T09:09:30Z", "commit": {"oid": "7de0e3340344aeec4e9ba0bb06f66c2084e70828"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwOTowOTozMFrOHox4kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwOToxMjo1NVrOHoyA9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUyMjM4Ng==", "bodyText": "This might cause NPE. Please add a null check here.", "url": "https://github.com/getodk/collect/pull/4177#discussion_r512522386", "createdAt": "2020-10-27T09:09:30Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/utilities/ImageConverter.java", "diffHunk": "@@ -39,9 +39,26 @@\n     private ImageConverter() {\n     }\n \n+    /**\n+     * Before proceed with scaling or rotating, make sure existing exif information is store/restored.\n+     * @author Khuong Ninh (khuong.ninh@it-development.com)\n+     */\n     public static void execute(String imagePath, QuestionWidget questionWidget, Context context) {\n+        ExifInterface exif = null;\n+        try {\n+            exif = new ExifInterface(imagePath);\n+        } catch (IOException e) {\n+            Timber.w(e);\n+        }\n+\n         rotateImageIfNeeded(imagePath);\n         scaleDownImageIfNeeded(imagePath, questionWidget, context);\n+        \n+        try {\n+            exif.saveAttributes();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7de0e3340344aeec4e9ba0bb06f66c2084e70828"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUyMzA1OQ==", "bodyText": "Should be: stored/restored (d missing).", "url": "https://github.com/getodk/collect/pull/4177#discussion_r512523059", "createdAt": "2020-10-27T09:10:33Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/utilities/ImageConverter.java", "diffHunk": "@@ -39,9 +39,26 @@\n     private ImageConverter() {\n     }\n \n+    /**\n+     * Before proceed with scaling or rotating, make sure existing exif information is store/restored.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7de0e3340344aeec4e9ba0bb06f66c2084e70828"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUyNDUzNA==", "bodyText": "Could this maybe align with how you named it in the comment above (store/restore)? I mean this could be in a separate method called storeExifAttributes() and the code below also could be in a separate method called restoreExifAttributes() then the code would be cleaner.", "url": "https://github.com/getodk/collect/pull/4177#discussion_r512524534", "createdAt": "2020-10-27T09:12:55Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/utilities/ImageConverter.java", "diffHunk": "@@ -39,9 +39,26 @@\n     private ImageConverter() {\n     }\n \n+    /**\n+     * Before proceed with scaling or rotating, make sure existing exif information is store/restored.\n+     * @author Khuong Ninh (khuong.ninh@it-development.com)\n+     */\n     public static void execute(String imagePath, QuestionWidget questionWidget, Context context) {\n+        ExifInterface exif = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7de0e3340344aeec4e9ba0bb06f66c2084e70828"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bd30f527f12705e869e0056ed33208b8692345f", "author": {"user": {"login": "ItloMd9", "name": "Khuong Ninh"}}, "url": "https://github.com/getodk/collect/commit/4bd30f527f12705e869e0056ed33208b8692345f", "committedDate": "2020-10-27T09:17:53Z", "message": "issue #3780 Update per peer review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NTA1OTcy", "url": "https://github.com/getodk/collect/pull/4177#pullrequestreview-517505972", "createdAt": "2020-10-27T09:37:20Z", "commit": {"oid": "4bd30f527f12705e869e0056ed33208b8692345f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwOTozNzoyMFrOHoy-uQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwOTozNzoyMFrOHoy-uQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU0MDM0NQ==", "bodyText": "Would you like to add a test? It should be straightforward because we have this function in ImageConverterTest:\n    private void saveTestBitmap(int width, int height, Integer orientation) {\n        Bitmap bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.RGB_565);\n        FileUtils.saveBitmapToFile(bitmap, TEST_IMAGE_PATH);\n\n        if (orientation != null) {\n            try {\n                ExifInterface exifInterface = new ExifInterface(TEST_IMAGE_PATH);\n                exifInterface.setAttribute(ExifInterface.TAG_ORIENTATION, String.valueOf(orientation));\n                exifInterface.saveAttributes();\n            } catch (IOException e) {\n                Timber.w(e);\n            }\n        }\n    }\n\nwhich we use for testing ImageConverter.", "url": "https://github.com/getodk/collect/pull/4177#discussion_r512540345", "createdAt": "2020-10-27T09:37:20Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/utilities/ImageConverter.java", "diffHunk": "@@ -39,9 +39,28 @@\n     private ImageConverter() {\n     }\n \n+    /**\n+     * Before proceed with scaling or rotating, make sure existing exif information is stored/restored.\n+     * @author Khuong Ninh (khuong.ninh@it-development.com)\n+     */\n     public static void execute(String imagePath, QuestionWidget questionWidget, Context context) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bd30f527f12705e869e0056ed33208b8692345f"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "905637b5eb84dec9bc92f13a1e6d4ba18511c216", "author": {"user": {"login": "ItloMd9", "name": "Khuong Ninh"}}, "url": "https://github.com/getodk/collect/commit/905637b5eb84dec9bc92f13a1e6d4ba18511c216", "committedDate": "2020-10-27T11:03:07Z", "message": "issue #3780. Add test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a232cffca15e2e35815adc0c4f67b07672f67d6c", "author": {"user": {"login": "ItloMd9", "name": "Khuong Ninh"}}, "url": "https://github.com/getodk/collect/commit/a232cffca15e2e35815adc0c4f67b07672f67d6c", "committedDate": "2020-10-27T11:54:59Z", "message": "issue #3780. Update checking code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NjEwNjM4", "url": "https://github.com/getodk/collect/pull/4177#pullrequestreview-519610638", "createdAt": "2020-10-29T12:27:16Z", "commit": {"oid": "a232cffca15e2e35815adc0c4f67b07672f67d6c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxMjoyNzoxNlrOHqZbew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxMjoyNzoxNlrOHqZbew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDIxODg3NQ==", "bodyText": "Does this test work for you locally? I tried on various android versions and the result is:\njunit.framework.ComparisonFailure: expected:<ApertureValue_value> but was:<null>\nat junit.framework.Assert.assertEquals(Assert.java:85)\nat junit.framework.Assert.assertEquals(Assert.java:91)\nat org.odk.collect.android.instrumented.utilities.ImageConverterTest.keepExifTest1AfterScaleAndRotation(ImageConverterTest.java:426)\nat java.lang.reflect.Method.invoke(Native Method)\nat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:59)\nat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\nat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:56)\nat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\nat androidx.test.internal.runner.junit4.statement.RunBefores.evaluate(RunBefores.java:80)\nat org.odk.collect.android.support.ResetStateRule$ResetStateStatement.evaluate(ResetStateRule.java:71)", "url": "https://github.com/getodk/collect/pull/4177#discussion_r514218875", "createdAt": "2020-10-29T12:27:16Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/instrumented/utilities/ImageConverterTest.java", "diffHunk": "@@ -382,6 +383,51 @@ public void scaleImageToNewWidthTest() {\n         assertEquals(1250, image.getHeight());\n     }\n \n+    @Test\n+    public void keepExifTest1AfterScaleAndRotation() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a232cffca15e2e35815adc0c4f67b07672f67d6c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ebd56257c095abc87d70f2e1d2c00cc16dfe728", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/5ebd56257c095abc87d70f2e1d2c00cc16dfe728", "committedDate": "2020-10-29T13:30:06Z", "message": "Fixed and improved tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5Njc2ODM4", "url": "https://github.com/getodk/collect/pull/4177#pullrequestreview-519676838", "createdAt": "2020-10-29T13:43:09Z", "commit": {"oid": "5ebd56257c095abc87d70f2e1d2c00cc16dfe728"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5ODU5NjQ3", "url": "https://github.com/getodk/collect/pull/4177#pullrequestreview-519859647", "createdAt": "2020-10-29T16:35:10Z", "commit": {"oid": "5ebd56257c095abc87d70f2e1d2c00cc16dfe728"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2431, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}