{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwNjk3MDIw", "number": 3848, "title": "Improvements to Espresso tests to make tests more stable", "bodyText": "I'll leave some comments inline to explain changes. I've also put up a document of \"Espresso tips\" related to these changes up. I started this a while ago in my own notebook but thought it would be good to start collecting some of my learnings publicly as Android's documentation is falling behind somewhat.\nWhat has been done to verify that this works as intended?\nRan this branch on test lab a lot of times. Haven't seen any fails in the current change set (this doesn't mean they aren't there though).\nWhy is this the best possible solution? Were any other approaches considered?\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nOnly changes to tests so this can be merged without QA.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-05-20T11:45:32Z", "url": "https://github.com/getodk/collect/pull/3848", "merged": true, "mergeCommit": {"oid": "8e78d61108fba4b94a01c9e08269a10ae6c23110"}, "closed": true, "closedAt": "2020-05-27T21:34:18Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcihvV0gH2gAyNDIwNjk3MDIwOmFhZTQ0Y2JkODc1ODg1MThhNDI5MjcxNmU3ZmRjNGZiNWEzNzI4YTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclgOTgAFqTQxOTYyMzQwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "aae44cbd87588518a4292716e7fdc4fb5a3728a5", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/aae44cbd87588518a4292716e7fdc4fb5a3728a5", "committedDate": "2020-05-18T15:38:05Z", "message": "Make tools for dealing with postValue in Espresso"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f40ef0bd1b45a9997bf75c98fb718f3f9a42707", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/9f40ef0bd1b45a9997bf75c98fb718f3f9a42707", "committedDate": "2020-05-18T16:33:17Z", "message": "Add permissions to AdminSettingsTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de07ed32e95e535b975cf0ad775fba97df9f1c13", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/de07ed32e95e535b975cf0ad775fba97df9f1c13", "committedDate": "2020-05-18T16:36:13Z", "message": "Rename test rule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bd941813d95a0121845e98ffb6eafe341eb762a", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/5bd941813d95a0121845e98ffb6eafe341eb762a", "committedDate": "2020-05-18T17:01:32Z", "message": "Use rule chain in regression tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "542b2f74e170e993c1e16186bf97ce81420fe19b", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/542b2f74e170e993c1e16186bf97ce81420fe19b", "committedDate": "2020-05-19T12:39:38Z", "message": "Add assertion to repeat swipes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1MjU3NzE4", "url": "https://github.com/getodk/collect/pull/3848#pullrequestreview-415257718", "createdAt": "2020-05-20T11:57:36Z", "commit": {"oid": "542b2f74e170e993c1e16186bf97ce81420fe19b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMTo1NzozNlrOGYICZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMTo1NzozNlrOGYICZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1MDY5NA==", "bodyText": "We need this for CountingTaskExecutorRule", "url": "https://github.com/getodk/collect/pull/3848#discussion_r427950694", "createdAt": "2020-05-20T11:57:36Z", "author": {"login": "seadowg"}, "path": "collect_app/build.gradle", "diffHunk": "@@ -327,6 +327,7 @@ dependencies {\n     androidTestImplementation \"org.mockito:mockito-android:3.3.3\"\n     androidTestImplementation 'androidx.test.ext:junit:1.1.1'\n     androidTestImplementation 'androidx.test.espresso:espresso-core:3.2.0'\n+    androidTestImplementation \"androidx.arch.core:core-testing:2.1.0\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "542b2f74e170e993c1e16186bf97ce81420fe19b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1MjU5NDY5", "url": "https://github.com/getodk/collect/pull/3848#pullrequestreview-415259469", "createdAt": "2020-05-20T12:00:11Z", "commit": {"oid": "542b2f74e170e993c1e16186bf97ce81420fe19b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMjowMDoxMVrOGYIH9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMjowMDoxMVrOGYIH9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1MjExNw==", "bodyText": "This test needed permissions but as we've seen before it's important to chain the rules so permissions are definitely granted before any Activities launch.", "url": "https://github.com/getodk/collect/pull/3848#discussion_r427952117", "createdAt": "2020-05-20T12:00:11Z", "author": {"login": "seadowg"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/regression/AdminSettingsTest.java", "diffHunk": "@@ -1,20 +1,38 @@\n package org.odk.collect.android.regression;\n \n+import android.Manifest;\n+\n+import androidx.test.rule.GrantPermissionRule;\n import androidx.test.runner.AndroidJUnit4;\n \n+import org.junit.Rule;\n import org.junit.Test;\n+import org.junit.rules.RuleChain;\n import org.junit.runner.RunWith;\n+import org.odk.collect.android.support.CollectTestRule;\n+import org.odk.collect.android.support.ResetStateRule;\n import org.odk.collect.android.support.pages.AdminSettingsPage;\n-import org.odk.collect.android.support.pages.MainMenuPage;\n \n //Issue NODK-239\n @RunWith(AndroidJUnit4.class)\n-public class AdminSettingsTest extends BaseRegressionTest {\n+public class AdminSettingsTest {\n+\n+    public CollectTestRule rule = new CollectTestRule();\n+\n+    @Rule\n+    public RuleChain copyFormChain = RuleChain\n+            .outerRule(GrantPermissionRule.grant(\n+                    Manifest.permission.READ_EXTERNAL_STORAGE,\n+                    Manifest.permission.WRITE_EXTERNAL_STORAGE,\n+                    Manifest.permission.READ_PHONE_STATE\n+            ))\n+            .around(new ResetStateRule())\n+            .around(rule);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "542b2f74e170e993c1e16186bf97ce81420fe19b"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1MjYxNDcy", "url": "https://github.com/getodk/collect/pull/3848#pullrequestreview-415261472", "createdAt": "2020-05-20T12:03:09Z", "commit": {"oid": "542b2f74e170e993c1e16186bf97ce81420fe19b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMjowMzowOVrOGYIN5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMjowMzowOVrOGYIN5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1MzYzOQ==", "bodyText": "There is some good docs on IdlingResource here. It seems Espresso is moving towards needing them more and more so it doesn't have to integrate with all the different scheduler mechanisms in Android (Handler, ArchTaskExectuor, coroutines and WorkManager to name a few).", "url": "https://github.com/getodk/collect/pull/3848#discussion_r427953639", "createdAt": "2020-05-20T12:03:09Z", "author": {"login": "seadowg"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/support/CountingTaskExecutorIdlingResource.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package org.odk.collect.android.support;\n+\n+import androidx.arch.core.executor.testing.CountingTaskExecutorRule;\n+import androidx.test.espresso.IdlingResource;\n+\n+public class CountingTaskExecutorIdlingResource implements IdlingResource {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "542b2f74e170e993c1e16186bf97ce81420fe19b"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1MjYyMTQ0", "url": "https://github.com/getodk/collect/pull/3848#pullrequestreview-415262144", "createdAt": "2020-05-20T12:04:08Z", "commit": {"oid": "542b2f74e170e993c1e16186bf97ce81420fe19b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMjowNDowOFrOGYIPyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMjowNDowOFrOGYIPyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1NDEyMw==", "bodyText": "We might need to move all of our swipeToX helpers to this kind of style. It's definitely safer for us to have assertions with actions like gestures that can be performed on any screen.", "url": "https://github.com/getodk/collect/pull/3848#discussion_r427954123", "createdAt": "2020-05-20T12:04:08Z", "author": {"login": "seadowg"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/support/pages/FormEntryPage.java", "diffHunk": "@@ -54,6 +54,15 @@ public FormEntryPage swipeToNextQuestion(int repetitions) {\n         return this;\n     }\n \n+    public FormEntryPage swipeToNextRepeat(String repeatLabel, int repeatNumber) {\n+        tryAgainOnFail(() -> {\n+            onView(withId(R.id.questionholder)).perform(swipeLeft());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "542b2f74e170e993c1e16186bf97ce81420fe19b"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NjIzNDAz", "url": "https://github.com/getodk/collect/pull/3848#pullrequestreview-419623403", "createdAt": "2020-05-27T21:30:30Z", "commit": {"oid": "aae44cbd87588518a4292716e7fdc4fb5a3728a5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMTozMDozMFrOGbd3LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMTozMDozMFrOGbd3LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ1Mzk5Nw==", "bodyText": "Did the person on the issue you filed about WorkManager and Espresso ever get back to you and was this the answer?", "url": "https://github.com/getodk/collect/pull/3848#discussion_r431453997", "createdAt": "2020-05-27T21:30:30Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/support/CountingTaskExecutorIdlingResource.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package org.odk.collect.android.support;\n+\n+import androidx.arch.core.executor.testing.CountingTaskExecutorRule;\n+import androidx.test.espresso.IdlingResource;\n+\n+public class CountingTaskExecutorIdlingResource implements IdlingResource {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1MzYzOQ=="}, "originalCommit": {"oid": "542b2f74e170e993c1e16186bf97ce81420fe19b"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2701, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}