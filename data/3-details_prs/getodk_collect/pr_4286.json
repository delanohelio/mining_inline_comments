{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1MTEzNzMw", "number": 4286, "title": "Handle process death during filling a form", "bodyText": "Closes #4250\nCloses #4327\nCloses #3873\nWhat has been done to verify that this works as intended?\nI tested the fix manually.\nWhy is this the best possible solution? Were any other approaches considered?\nIt consists a couple of fixes and I can't come up with any better solution. generally our code was prepared for such cases but we have never tested process death so the code needed some improvements and fixes.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nI hope it will fix the problem with null form controller that we have handled in many cases adding null checks.\nTesting the issue in the way I described using the forms I mentioned would be enough.\nPlease additionally check the functionality with and without don't keep activities option. You can also test killing the app manually what you probably do more often)\nThere is one thing: during testing I noticed that sometimes we can get stuck in a state where savepoints are not saved/updated so if we add changes in a form and then kill the app those changes are lost. unfortunately I'm not able to reproduce it now so please keep an eye on it.\nDo we need any specific form for testing your changes? If so, please attach one.\nAny form with media files to reproduce the steps described in the issue, it might be the demo form.\nAlso it would be good to tests a form with multiple questions on one page, I used this one:\ngroupTestForm.txt\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nNo.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-12-09T11:32:40Z", "url": "https://github.com/getodk/collect/pull/4286", "merged": true, "mergeCommit": {"oid": "078227ce659c7ac3c7ad8be2cbfd6823dcf1b2fe"}, "closed": true, "closedAt": "2021-01-12T14:17:39Z", "author": {"login": "grzesiek2010"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkdMiZgFqTU0ODA5NzA0Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdt0YulAFqTU2MzQ5NTM1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MDk3MDQz", "url": "https://github.com/getodk/collect/pull/4286#pullrequestreview-548097043", "createdAt": "2020-12-09T11:39:27Z", "commit": {"oid": "2ef4f27a58d274adefad69ca8334f22efda83146"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMTozOToyN1rOICQSTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMTozOToyN1rOICQSTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzNDg5Mg==", "bodyText": "The problem here was that if we were in a field-list group and we wanted to get XPath for a question to remember that that question is waiting for an answer it didn't work because we were passing it's index properly like 0,1 for example but then getEvent() (without any parameter) used our current index to return the XPath which in case of field-list groups is the index of the whole group not of that particular question.", "url": "https://github.com/getodk/collect/pull/4286#discussion_r539234892", "createdAt": "2020-12-09T11:39:27Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/javarosawrapper/FormController.java", "diffHunk": "@@ -183,7 +183,7 @@ public AuditEventLogger getAuditEventLogger() {\n      */\n     public String getXPath(FormIndex index) {\n         String value;\n-        switch (getEvent()) {\n+        switch (getEvent(index)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef4f27a58d274adefad69ca8334f22efda83146"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MDk4NDYy", "url": "https://github.com/getodk/collect/pull/4286#pullrequestreview-548098462", "createdAt": "2020-12-09T11:41:26Z", "commit": {"oid": "2ef4f27a58d274adefad69ca8334f22efda83146"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMTo0MToyNlrOICQXJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMTo0MToyNlrOICQXJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzNjEzNA==", "bodyText": "In 5b6ae1a I just removed this check because we nowhere use putBooleanExtra(\"start\", false); so this is always false. Please correct me if i made a mistake.\nis it possible that external apps use this for something?", "url": "https://github.com/getodk/collect/pull/4286#discussion_r539236134", "createdAt": "2020-12-09T11:41:26Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2343,53 +2333,50 @@ public void denied() {\n                         }\n                     });\n                 } else {\n-                    Intent reqIntent = getIntent();\n-                    boolean showFirst = reqIntent.getBooleanExtra(\"start\", false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef4f27a58d274adefad69ca8334f22efda83146"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MTAwMDM4", "url": "https://github.com/getodk/collect/pull/4286#pullrequestreview-548100038", "createdAt": "2020-12-09T11:43:37Z", "commit": {"oid": "2ef4f27a58d274adefad69ca8334f22efda83146"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMTo0MzozN1rOICQciA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMTo0MzozN1rOICQciA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzNzUxMg==", "bodyText": "If we are here (just after loading a form) and our index is in form (that mean it was saved and now restored) that means it was caused by process death. I hope there are no other cases :)", "url": "https://github.com/getodk/collect/pull/4286#discussion_r539237512", "createdAt": "2020-12-09T11:43:37Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2343,53 +2333,50 @@ public void denied() {\n                         }\n                     });\n                 } else {\n-                    Intent reqIntent = getIntent();\n-                    boolean showFirst = reqIntent.getBooleanExtra(\"start\", false);\n-\n-                    if (!showFirst) {\n-                        // we've just loaded a saved form, so start in the hierarchy view\n-                        String formMode = reqIntent.getStringExtra(ApplicationConstants.BundleKeys.FORM_MODE);\n-                        if (formMode == null || ApplicationConstants.FormModes.EDIT_SAVED.equalsIgnoreCase(formMode)) {\n-                            formControllerAvailable(formController);\n-\n-                            identityPromptViewModel.requiresIdentityToContinue().observe(this, requiresIdentity -> {\n-                                if (!requiresIdentity) {\n-                                    if (!allowMovingBackwards) {\n-                                        // we aren't allowed to jump around the form so attempt to\n-                                        // go directly to the question we were on last time the\n-                                        // form was saved.\n-                                        // TODO: revisit the fallback. If for some reason the index\n-                                        // wasn't saved, we can now jump around which doesn't seem right.\n-                                        FormIndex formIndex = SaveFormIndexTask.loadFormIndexFromFile();\n-                                        if (formIndex != null) {\n-                                            formController.jumpToIndex(formIndex);\n-                                            onScreenRefresh();\n-                                            return;\n-                                        }\n-                                    }\n-\n-                                    formController.getAuditEventLogger().logEvent(AuditEvent.AuditEventType.FORM_RESUME, true, System.currentTimeMillis());\n-                                    formController.getAuditEventLogger().logEvent(AuditEvent.AuditEventType.HIERARCHY, true, System.currentTimeMillis());\n-                                    startActivityForResult(new Intent(this, FormHierarchyActivity.class), RequestCodes.HIERARCHY_ACTIVITY);\n-                                }\n-                            });\n+                    // Returning to the app after process death\n+                    if (formController.getFormIndex().isInForm()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef4f27a58d274adefad69ca8334f22efda83146"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwOTY1ODU3", "url": "https://github.com/getodk/collect/pull/4286#pullrequestreview-560965857", "createdAt": "2021-01-04T11:39:23Z", "commit": {"oid": "9a6e83b248481bbebc553b39005c7181f8c9504e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxMTozOToyM1rOINuqCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxMTo1MToyNFrOINu-Gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2NjgyNA==", "bodyText": "I can't find anything on it and it doesn't look like it's documented (looking here) but I'm still a little worried it could be relied on somewhere out there?\nWe can add a note to QA about this to see if they have any test cases for it. It doesn't look like the change would \"break\" anything if someone was using it - the user would just end up on the hierarchy.", "url": "https://github.com/getodk/collect/pull/4286#discussion_r551266824", "createdAt": "2021-01-04T11:39:23Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2343,53 +2333,50 @@ public void denied() {\n                         }\n                     });\n                 } else {\n-                    Intent reqIntent = getIntent();\n-                    boolean showFirst = reqIntent.getBooleanExtra(\"start\", false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzNjEzNA=="}, "originalCommit": {"oid": "2ef4f27a58d274adefad69ca8334f22efda83146"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI3MTYxMA==", "bodyText": "Could you add more details to the comment here? I'm not sure I follow exactly how we end up with an index in the form in this case but not if I kill the app and then open the form again?\nIt'd also good to point out here that in the activity death scenario we don't need to reload the form so we don't end up here.", "url": "https://github.com/getodk/collect/pull/4286#discussion_r551271610", "createdAt": "2021-01-04T11:50:33Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2343,53 +2333,50 @@ public void denied() {\n                         }\n                     });\n                 } else {\n-                    Intent reqIntent = getIntent();\n-                    boolean showFirst = reqIntent.getBooleanExtra(\"start\", false);\n-\n-                    if (!showFirst) {\n-                        // we've just loaded a saved form, so start in the hierarchy view\n-                        String formMode = reqIntent.getStringExtra(ApplicationConstants.BundleKeys.FORM_MODE);\n-                        if (formMode == null || ApplicationConstants.FormModes.EDIT_SAVED.equalsIgnoreCase(formMode)) {\n-                            formControllerAvailable(formController);\n-\n-                            identityPromptViewModel.requiresIdentityToContinue().observe(this, requiresIdentity -> {\n-                                if (!requiresIdentity) {\n-                                    if (!allowMovingBackwards) {\n-                                        // we aren't allowed to jump around the form so attempt to\n-                                        // go directly to the question we were on last time the\n-                                        // form was saved.\n-                                        // TODO: revisit the fallback. If for some reason the index\n-                                        // wasn't saved, we can now jump around which doesn't seem right.\n-                                        FormIndex formIndex = SaveFormIndexTask.loadFormIndexFromFile();\n-                                        if (formIndex != null) {\n-                                            formController.jumpToIndex(formIndex);\n-                                            onScreenRefresh();\n-                                            return;\n-                                        }\n-                                    }\n-\n-                                    formController.getAuditEventLogger().logEvent(AuditEvent.AuditEventType.FORM_RESUME, true, System.currentTimeMillis());\n-                                    formController.getAuditEventLogger().logEvent(AuditEvent.AuditEventType.HIERARCHY, true, System.currentTimeMillis());\n-                                    startActivityForResult(new Intent(this, FormHierarchyActivity.class), RequestCodes.HIERARCHY_ACTIVITY);\n-                                }\n-                            });\n+                    // Returning to the app after process death\n+                    if (formController.getFormIndex().isInForm()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzNzUxMg=="}, "originalCommit": {"oid": "2ef4f27a58d274adefad69ca8334f22efda83146"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI3MTk2Mw==", "bodyText": "Yeah this just seems cleaner as well!", "url": "https://github.com/getodk/collect/pull/4286#discussion_r551271963", "createdAt": "2021-01-04T11:51:24Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/javarosawrapper/FormController.java", "diffHunk": "@@ -183,7 +183,7 @@ public AuditEventLogger getAuditEventLogger() {\n      */\n     public String getXPath(FormIndex index) {\n         String value;\n-        switch (getEvent()) {\n+        switch (getEvent(index)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzNDg5Mg=="}, "originalCommit": {"oid": "2ef4f27a58d274adefad69ca8334f22efda83146"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a6e83b248481bbebc553b39005c7181f8c9504e", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/9a6e83b248481bbebc553b39005c7181f8c9504e", "committedDate": "2020-12-09T11:56:52Z", "message": "Added a comment to getFormController() method"}, "afterCommit": {"oid": "a71394f00958c37259c0928b71d081a7cdd47ea7", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/a71394f00958c37259c0928b71d081a7cdd47ea7", "committedDate": "2021-01-05T12:27:25Z", "message": "Added a comment to getFormController() method"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a71394f00958c37259c0928b71d081a7cdd47ea7", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/a71394f00958c37259c0928b71d081a7cdd47ea7", "committedDate": "2021-01-05T12:27:25Z", "message": "Added a comment to getFormController() method"}, "afterCommit": {"oid": "8e2c759200ceecc3c77709e6cabf129d4348bcf0", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/8e2c759200ceecc3c77709e6cabf129d4348bcf0", "committedDate": "2021-01-05T12:33:43Z", "message": "Added a comment to getFormController() method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxNzk3Nzk0", "url": "https://github.com/getodk/collect/pull/4286#pullrequestreview-561797794", "createdAt": "2021-01-05T13:45:00Z", "commit": {"oid": "8e2c759200ceecc3c77709e6cabf129d4348bcf0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43df56d831625686777ad6e821a7c8450d2e081b", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/43df56d831625686777ad6e821a7c8450d2e081b", "committedDate": "2021-01-07T09:59:24Z", "message": "Call formControllerAvailable() when pending activity result is detected"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47009d4c9343247226c7ddc3acf8e87094616d39", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/47009d4c9343247226c7ddc3acf8e87094616d39", "committedDate": "2021-01-07T10:00:45Z", "message": "Fixed FromController.getXPath() method to work well with field-list groups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5081446191bcbf2bc9dacb5dab4526e0c5085615", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/5081446191bcbf2bc9dacb5dab4526e0c5085615", "committedDate": "2021-01-07T10:00:45Z", "message": "Access formcontroller object in FormEntryActivity via getFormController() method only"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cbbc819d8618f45b930cc43782e0329efba0ac0", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/9cbbc819d8618f45b930cc43782e0329efba0ac0", "committedDate": "2021-01-07T10:00:45Z", "message": "Added a comment to getFormController() method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6221d5dd0a5d9a78c38b22770cba876315775ab3", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/6221d5dd0a5d9a78c38b22770cba876315775ab3", "committedDate": "2021-01-07T10:01:13Z", "message": "Removed redundant comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74794a3fd7160c6c9dc7c46acb247c787e44c88a", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/74794a3fd7160c6c9dc7c46acb247c787e44c88a", "committedDate": "2021-01-07T10:04:34Z", "message": "Removed the temporary fix implemented in #4328"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e2c759200ceecc3c77709e6cabf129d4348bcf0", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/8e2c759200ceecc3c77709e6cabf129d4348bcf0", "committedDate": "2021-01-05T12:33:43Z", "message": "Added a comment to getFormController() method"}, "afterCommit": {"oid": "74794a3fd7160c6c9dc7c46acb247c787e44c88a", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/74794a3fd7160c6c9dc7c46acb247c787e44c88a", "committedDate": "2021-01-07T10:04:34Z", "message": "Removed the temporary fix implemented in #4328"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzNDk1MzUw", "url": "https://github.com/getodk/collect/pull/4286#pullrequestreview-563495350", "createdAt": "2021-01-07T13:45:54Z", "commit": {"oid": "74794a3fd7160c6c9dc7c46acb247c787e44c88a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2355, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}