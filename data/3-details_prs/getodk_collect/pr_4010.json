{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyNzAxNzIx", "number": 4010, "title": "Fix deleting Instances of Forms without version", "bodyText": "Closes #4004\nWhat has been done to verify that this works as intended?\nNew tests and verified manually.\nWhy is this the best possible solution? Were any other approaches considered?\nComments inline.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nShouldn't be any changes other than the issue being fixed.\nDo we need any specific form for testing your changes? If so, please attach one.\nAny form without a version.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-08-04T11:20:17Z", "url": "https://github.com/getodk/collect/pull/4010", "merged": true, "mergeCommit": {"oid": "93cbbec2fa3d0dc8f66a803a36f1c4209e69e9bb"}, "closed": true, "closedAt": "2020-08-05T14:41:07Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7kM6ZAH2gAyNDYyNzAxNzIxOjZmMGMzYWM4ZjQ3MDVhM2E1NGU1ZTkyZmM3Y2E3ZTkxOTYxZmQxZWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7taUEgFqTQ2MTE4MjcxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6f0c3ac8f4705a3a54e5e92fc7ca7e91961fd1ed", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/6f0c3ac8f4705a3a54e5e92fc7ca7e91961fd1ed", "committedDate": "2020-08-04T10:38:18Z", "message": "Make sure forms instances without versions can be deleted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed3a4c75b4c5a575ead7a50e867bcc125558a970", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/ed3a4c75b4c5a575ead7a50e867bcc125558a970", "committedDate": "2020-08-04T10:54:40Z", "message": "Remove Robolectric from InMemFormsRepositoryTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b687fac1933878706b11c31b7819402c59d399c8", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/b687fac1933878706b11c31b7819402c59d399c8", "committedDate": "2020-08-04T11:01:43Z", "message": "Remove dependency on StoragePathProvider from Form.Builder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNzU0NTgw", "url": "https://github.com/getodk/collect/pull/4010#pullrequestreview-460754580", "createdAt": "2020-08-04T12:13:35Z", "commit": {"oid": "b687fac1933878706b11c31b7819402c59d399c8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMjoxMzozNVrOG7dp2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMjoxMzozNVrOG7dp2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAwNTAxNg==", "bodyText": "Given that the error here was the SQL query being constructed incorrectly it felt like the right time to start adding tests. Using a contract testing pattern like we're doing here lets us verify that our \"real\" (DatabaseFormsRepository) and \"fake\" (InMemFormsRepository) both pass the same set of tests. This lets us be more confident that we can switch the \"real\" object for the \"fake\" object in tests.", "url": "https://github.com/getodk/collect/pull/4010#discussion_r465005016", "createdAt": "2020-08-04T12:13:35Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/forms/FormsRepositoryTest.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.odk.collect.android.forms;\n+\n+import org.junit.Test;\n+import org.odk.collect.android.utilities.FileUtils;\n+\n+import java.io.File;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.notNullValue;\n+\n+public abstract class FormsRepositoryTest {\n+\n+    public abstract FormsRepository buildSubject();\n+\n+    public abstract String getFormFilesPath();\n+\n+    @Test\n+    public void get_whenFormHasNullVersion_returnsForm() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b687fac1933878706b11c31b7819402c59d399c8"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNzU1ODg1", "url": "https://github.com/getodk/collect/pull/4010#pullrequestreview-460755885", "createdAt": "2020-08-04T12:15:32Z", "commit": {"oid": "b687fac1933878706b11c31b7819402c59d399c8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMjoxNTozM1rOG7duDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMjoxNTozM1rOG7duDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAwNjA5NQ==", "bodyText": "It felt wrong that the Form object should have to care about storage details, so I removed this dependency. This also made it simpler to write tests for the InMemFormsRepository (which was my clue that something could be improved).", "url": "https://github.com/getodk/collect/pull/4010#discussion_r465006095", "createdAt": "2020-08-04T12:15:33Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/forms/Form.java", "diffHunk": "@@ -136,7 +137,7 @@ public Builder jrVersion(String jrVersion) {\n         }\n \n         public Builder formFilePath(String formFilePath) {\n-            this.formFilePath = new StoragePathProvider().getFormDbPath(formFilePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b687fac1933878706b11c31b7819402c59d399c8"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTgyNzE0", "url": "https://github.com/getodk/collect/pull/4010#pullrequestreview-461182714", "createdAt": "2020-08-04T21:19:31Z", "commit": {"oid": "6f0c3ac8f4705a3a54e5e92fc7ca7e91961fd1ed"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMToxOTozMVrOG7x5OA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMToyMTozMVrOG7x86Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMzNjYzMg==", "bodyText": "Feels too bad to have a mix of raw queries passed in to the dao layer and higher-level calls on the dao. Wouldn't getFormsCursorSortedByDateDesc do what you need here?", "url": "https://github.com/getodk/collect/pull/4010#discussion_r465336632", "createdAt": "2020-08-04T21:19:31Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/forms/DatabaseFormsRepository.java", "diffHunk": "@@ -40,16 +40,16 @@ public boolean contains(String jrFormId) {\n     @Nullable\n     @Override\n     public Form get(Long id) {\n-        try (Cursor cursor = new FormsDao().getFormsCursor(_ID + \"=?\", new String[]{id.toString()})) {\n-            return getFormOrNull(cursor);\n-        }\n+        return queryForForm(_ID + \"=?\", new String[]{id.toString()});\n     }\n \n     @Nullable\n     @Override\n-    public Form get(String jrFormId, String jrVersion) {\n-        try (Cursor cursor = new FormsDao().getFormsCursor(JR_FORM_ID + \"=? AND \" + JR_VERSION + \"=?\", new String[]{jrFormId, jrVersion})) {\n-            return getFormOrNull(cursor);\n+    public Form get(String jrFormId, @Nullable String jrVersion) {\n+        if (jrVersion != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f0c3ac8f4705a3a54e5e92fc7ca7e91961fd1ed"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMzNzU3Nw==", "bodyText": "I think another option would be to let the dao layer deal with queries and do testing at that level.", "url": "https://github.com/getodk/collect/pull/4010#discussion_r465337577", "createdAt": "2020-08-04T21:21:31Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/test/java/org/odk/collect/android/forms/FormsRepositoryTest.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.odk.collect.android.forms;\n+\n+import org.junit.Test;\n+import org.odk.collect.android.utilities.FileUtils;\n+\n+import java.io.File;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.notNullValue;\n+\n+public abstract class FormsRepositoryTest {\n+\n+    public abstract FormsRepository buildSubject();\n+\n+    public abstract String getFormFilesPath();\n+\n+    @Test\n+    public void get_whenFormHasNullVersion_returnsForm() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAwNTAxNg=="}, "originalCommit": {"oid": "b687fac1933878706b11c31b7819402c59d399c8"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2586, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}