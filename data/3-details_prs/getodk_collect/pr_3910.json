{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NjE4OTg3", "number": 3910, "title": "Implemented viewmodel for RankingWidgetDialog to solve the problem with serialization", "bodyText": "Closes #3615\nWhat has been done to verify that this works as intended?\nI tested the fix manually.\nWhy is this the best possible solution? Were any other approaches considered?\nIt's the solution we discussed in getodk/javarosa#536 (comment)\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nIt should just fix the issue and have no other impact. We can test just the rank widget.\nDo we need any specific form for testing your changes? If so, please attach one.\nAny form with rank widget.\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nNo.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-06-05T17:51:03Z", "url": "https://github.com/getodk/collect/pull/3910", "merged": true, "mergeCommit": {"oid": "677453a90ea8cb02c40cd971b7c351e9757457d5"}, "closed": true, "closedAt": "2020-06-24T13:39:00Z", "author": {"login": "grzesiek2010"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoWYS1AH2gAyNDI4NjE4OTg3OjM1OGRlMTBjZDYxYTJmOGUwZDVhMjM5MTVkOWZmY2RkNzg0YjZiOGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqCAnXgFqTQyODQ4ODk5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "358de10cd61a2f8e0d5a23915d9ffcdd784b6b8d", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/358de10cd61a2f8e0d5a23915d9ffcdd784b6b8d", "committedDate": "2020-06-05T17:47:30Z", "message": "Implemented viewmodel for RankingWidgetDialog to solve the problem with serialization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NjgyMzA0", "url": "https://github.com/getodk/collect/pull/3910#pullrequestreview-425682304", "createdAt": "2020-06-05T23:47:33Z", "commit": {"oid": "358de10cd61a2f8e0d5a23915d9ffcdd784b6b8d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQyMzo0NzozM1rOGgAFNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQwMDoyOToxN1rOGgAeBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwODk1MQ==", "bodyText": "Since this is deprecated, I think that in new code it makes sense to use the ViewModelProvider constructor - new ViewModelProvider(this, new RankingViewModel.Factory(items, formIndex)).get(RankingViewModel.class)", "url": "https://github.com/getodk/collect/pull/3910#discussion_r436208951", "createdAt": "2020-06-05T23:47:33Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/fragments/dialogs/RankingWidgetDialog.java", "diffHunk": "@@ -35,57 +36,46 @@\n \n import org.javarosa.core.model.FormIndex;\n import org.javarosa.core.model.SelectChoice;\n+import org.jetbrains.annotations.NotNull;\n import org.odk.collect.android.R;\n import org.odk.collect.android.R.string;\n import org.odk.collect.android.adapters.RankingListAdapter;\n+import org.odk.collect.android.fragments.viewmodels.RankingViewModel;\n import org.odk.collect.android.utilities.QuestionFontSizeUtils;\n import org.odk.collect.android.utilities.RankingItemTouchHelperCallback;\n \n-import java.io.Serializable;\n+import java.util.ArrayList;\n import java.util.List;\n \n public class RankingWidgetDialog extends DialogFragment {\n-\n-    private static final String ITEMS = \"items\";\n-    private static final String FORM_INDEX = \"form_index\";\n-\n     private RankingListener listener;\n-\n     private RankingListAdapter rankingListAdapter;\n     private List<SelectChoice> items;\n     private FormIndex formIndex;\n+    private RankingViewModel viewModel;\n \n     public interface RankingListener {\n         void onRankingChanged(List<SelectChoice> items);\n     }\n \n-    public static RankingWidgetDialog newInstance(List<SelectChoice> items, FormIndex formIndex) {\n-        RankingWidgetDialog dialog = new RankingWidgetDialog();\n-        Bundle bundle = new Bundle();\n-        bundle.putSerializable(ITEMS, (Serializable) items);\n-        bundle.putSerializable(FORM_INDEX, formIndex);\n-        dialog.setArguments(bundle);\n+    public RankingWidgetDialog() {\n+    }\n \n-        return dialog;\n+    public RankingWidgetDialog(List<SelectChoice> items, FormIndex formIndex) {\n+        this.items = new ArrayList<>(items);\n+        this.formIndex = formIndex;\n     }\n \n     @Override\n-    public void onAttach(Context context) {\n+    public void onAttach(@NotNull Context context) {\n         super.onAttach(context);\n         if (context instanceof RankingListener) {\n             listener = (RankingListener) context;\n         }\n-    }\n-\n-    @Override\n-    public void onCreate(Bundle savedInstanceState) {\n-        super.onCreate(savedInstanceState);\n-        items = (List<SelectChoice>) (savedInstanceState == null\n-                ? getArguments().getSerializable(ITEMS)\n-                : savedInstanceState.getSerializable(ITEMS));\n-        formIndex = (FormIndex) (savedInstanceState == null\n-                ? getArguments().getSerializable(FORM_INDEX)\n-                : savedInstanceState.getSerializable(FORM_INDEX));\n+        viewModel = ViewModelProviders.of(this, new RankingViewModel.Factory(items, formIndex)).get(RankingViewModel.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "358de10cd61a2f8e0d5a23915d9ffcdd784b6b8d"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIxNTMwMg==", "bodyText": "I don't love that these fields still end up existing since the point of the view model is to host them. What I was imagining originally is the activity creating the view model and the dialog fragment accessing it. I wasn't thinking about how the activity in this case is FormEntryActivity but currently it's the widget's responsibility to know about the items.\nGiven the existing infrastructure, I find this ok for now. It's something @SaumiaSinghal and @seadowg could give another look at when they get to this widget.", "url": "https://github.com/getodk/collect/pull/3910#discussion_r436215302", "createdAt": "2020-06-06T00:29:17Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/fragments/dialogs/RankingWidgetDialog.java", "diffHunk": "@@ -35,57 +36,46 @@\n \n import org.javarosa.core.model.FormIndex;\n import org.javarosa.core.model.SelectChoice;\n+import org.jetbrains.annotations.NotNull;\n import org.odk.collect.android.R;\n import org.odk.collect.android.R.string;\n import org.odk.collect.android.adapters.RankingListAdapter;\n+import org.odk.collect.android.fragments.viewmodels.RankingViewModel;\n import org.odk.collect.android.utilities.QuestionFontSizeUtils;\n import org.odk.collect.android.utilities.RankingItemTouchHelperCallback;\n \n-import java.io.Serializable;\n+import java.util.ArrayList;\n import java.util.List;\n \n public class RankingWidgetDialog extends DialogFragment {\n-\n-    private static final String ITEMS = \"items\";\n-    private static final String FORM_INDEX = \"form_index\";\n-\n     private RankingListener listener;\n-\n     private RankingListAdapter rankingListAdapter;\n     private List<SelectChoice> items;\n     private FormIndex formIndex;\n+    private RankingViewModel viewModel;\n \n     public interface RankingListener {\n         void onRankingChanged(List<SelectChoice> items);\n     }\n \n-    public static RankingWidgetDialog newInstance(List<SelectChoice> items, FormIndex formIndex) {\n-        RankingWidgetDialog dialog = new RankingWidgetDialog();\n-        Bundle bundle = new Bundle();\n-        bundle.putSerializable(ITEMS, (Serializable) items);\n-        bundle.putSerializable(FORM_INDEX, formIndex);\n-        dialog.setArguments(bundle);\n+    public RankingWidgetDialog() {\n+    }\n \n-        return dialog;\n+    public RankingWidgetDialog(List<SelectChoice> items, FormIndex formIndex) {\n+        this.items = new ArrayList<>(items);\n+        this.formIndex = formIndex;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "358de10cd61a2f8e0d5a23915d9ffcdd784b6b8d"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1Njk2ODE4", "url": "https://github.com/getodk/collect/pull/3910#pullrequestreview-425696818", "createdAt": "2020-06-06T00:42:22Z", "commit": {"oid": "358de10cd61a2f8e0d5a23915d9ffcdd784b6b8d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQwMDo0MjoyM1rOGgArhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQwMDo0MjoyM1rOGgArhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIxODc1OQ==", "bodyText": "This is not really related to this PR but it just came to mind that I don't really know when DialotUtils.showIfNotShowing makes a difference. Should it be used here?", "url": "https://github.com/getodk/collect/pull/3910#discussion_r436218759", "createdAt": "2020-06-06T00:42:23Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/RankingWidget.java", "diffHunk": "@@ -98,7 +98,7 @@ public void onButtonClick(int buttonId) {\n         if (formController != null) {\n             formController.setIndexWaitingForData(getFormEntryPrompt().getIndex());\n         }\n-        RankingWidgetDialog rankingWidgetDialog = RankingWidgetDialog.newInstance(savedItems == null ? items : savedItems, getFormEntryPrompt().getIndex());\n+        RankingWidgetDialog rankingWidgetDialog = new RankingWidgetDialog(savedItems == null ? items : savedItems, getFormEntryPrompt().getIndex());\n         rankingWidgetDialog.show(((FormEntryActivity) getContext()).getSupportFragmentManager(), \"RankingDialog\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "358de10cd61a2f8e0d5a23915d9ffcdd784b6b8d"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78157174a7f24a8b0ecc0208ab39c37f5f24a5c5", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/78157174a7f24a8b0ecc0208ab39c37f5f24a5c5", "committedDate": "2020-06-09T09:20:10Z", "message": "Code improvements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NDg4OTk2", "url": "https://github.com/getodk/collect/pull/3910#pullrequestreview-428488996", "createdAt": "2020-06-10T23:11:23Z", "commit": {"oid": "78157174a7f24a8b0ecc0208ab39c37f5f24a5c5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2729, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}