{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5MjAwMTcw", "number": 3997, "title": "Make sure Automatic Download setting makes sense for Form Update mode", "bodyText": "Closes #3982\nWhat has been done to verify that this works as intended?\nPlayed around with it manually and added new tests\nWhy is this the best possible solution? Were any other approaches considered?\nI also considered trying to make the setting just display correctly rather than changing it when the form update changes. This seemed like it was going to end up being pretty complex though, so I just went with the path of least resistance.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nShould just fix the bug! Good to double check how the settings change when the form update mode changes makes sense to everyone else.\nThis shouldn't skip QA like the other Match Exactly PRs.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-07-30T13:52:28Z", "url": "https://github.com/getodk/collect/pull/3997", "merged": true, "mergeCommit": {"oid": "bf4ae3e132635790646a6437381891f4a59c43a4"}, "closed": true, "closedAt": "2020-08-10T09:03:28Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7EM1PgFqTQ1OTY3OTUzMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc791-tgBqjM2MjU1MDMxMTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5Njc5NTMw", "url": "https://github.com/getodk/collect/pull/3997#pullrequestreview-459679530", "createdAt": "2020-08-02T21:21:15Z", "commit": {"oid": "f46f5c83502715cca53217734d67a38e12d69d85"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f46f5c83502715cca53217734d67a38e12d69d85", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/f46f5c83502715cca53217734d67a38e12d69d85", "committedDate": "2020-07-30T13:40:21Z", "message": "Make sure switching to google drive disables updates"}, "afterCommit": {"oid": "65ce012e6f0c823fde77935ba33d4e7984d48d55", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/65ce012e6f0c823fde77935ba33d4e7984d48d55", "committedDate": "2020-08-03T10:48:04Z", "message": "Shared settings change handler between prefs framework and importer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMzM1NTc1", "url": "https://github.com/getodk/collect/pull/3997#pullrequestreview-460335575", "createdAt": "2020-08-03T20:56:58Z", "commit": {"oid": "65ce012e6f0c823fde77935ba33d4e7984d48d55"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMDo1Njo1OFrOG7IePA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMDo1Njo1OFrOG7IePA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY1Nzk4MA==", "bodyText": "How very American.", "url": "https://github.com/getodk/collect/pull/3997#discussion_r464657980", "createdAt": "2020-08-03T20:56:58Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/feature/settings/ServerSettingsTest.java", "diffHunk": "@@ -90,4 +75,14 @@ public void selectingGoogleAccount_showsGoogleAccountSettings() {\n                 .assertText(R.string.selected_google_account_text)\n                 .assertText(R.string.google_sheets_url);\n     }\n+\n+    @Test\n+    public void selectingGoogleAccount_disablesAutomaticUpdates() {\n+        MainMenuPage mainMenu = new MainMenuPage(rule).assertOnPage()\n+                .enablePreviouslyDownloadedOnlyUpdates();\n+        assertThat(testDependencies.scheduler.getDeferredTasks().size(), is(1));\n+\n+        mainMenu.setGoogleDriveAccount(\"steph@curry.basket\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65ce012e6f0c823fde77935ba33d4e7984d48d55"}, "originalPosition": 97}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c952ffcc9380565c59781dc7aa89895e229470ba", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/c952ffcc9380565c59781dc7aa89895e229470ba", "committedDate": "2020-08-04T16:18:55Z", "message": "Make sure server URL changes schedule auto updates"}, "afterCommit": {"oid": "416827bad171f5baea5b697b7e3f05a7ded62e63", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/416827bad171f5baea5b697b7e3f05a7ded62e63", "committedDate": "2020-08-04T16:16:25Z", "message": "Make sure background work isn't scheduled every time a pref changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwOTkwMDU2", "url": "https://github.com/getodk/collect/pull/3997#pullrequestreview-460990056", "createdAt": "2020-08-04T16:45:09Z", "commit": {"oid": "416827bad171f5baea5b697b7e3f05a7ded62e63"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNjo0NToxMFrOG7oyZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNjo0NToxMFrOG7oyZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE4NzQzMQ==", "bodyText": "Iterating through ALL the keys is future proofing really but it felt weird for SettingsImporter to just pass one through knowing it would do the right thing.", "url": "https://github.com/getodk/collect/pull/3997#discussion_r465187431", "createdAt": "2020-08-04T16:45:10Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/configure/SettingsImporter.java", "diffHunk": "@@ -62,7 +62,13 @@ public boolean fromJSON(@NonNull String json) {\n         loadDefaults(generalSharedPrefs, generalDefaults);\n         loadDefaults(adminSharedPrefs, adminDefaults);\n \n-        settingsChangedHandler.onSettingsChanged();\n+        for (String key: generalSharedPrefs.getAll().keySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "416827bad171f5baea5b697b7e3f05a7ded62e63"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTY0Njgx", "url": "https://github.com/getodk/collect/pull/3997#pullrequestreview-461164681", "createdAt": "2020-08-04T20:52:35Z", "commit": {"oid": "416827bad171f5baea5b697b7e3f05a7ded62e63"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDo1MjozNVrOG7xFnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMTowNDozNlrOG7xdOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyMzQyMw==", "bodyText": "This is where I was getting confused when we were talking about the most recent changes. I think the split you're making is things that need to happen any time that a preference is updated even if the user is not anywhere near preferences in the app go to the custom handler which is always called by the base preference fragment. On the other hand, changes that only need to happen if the user is sitting in preferences at the moment are locally handled. Typically it would just be inline like with guidance hints but in this case since there are two keys that do the same thing, that ends up in onSharedPreferenceChanged. Does that sound right? I probably would have introduced a method to wrap the work that happens when either KEY_FORM_UPDATE_MODE or KEY_PERIODIC_FORM_UPDATES_CHECK changes and also defined handlers for those inline to avoid overriding onSharedPreferenceChanged but this is ok too.\nNow that this structure is in place, I think there are things we should move from inline handlers to CollectSettingsChangeHandler like sending an analytics event for a server URL change, for example. Something to file an issue for v1.29 about?", "url": "https://github.com/getodk/collect/pull/3997#discussion_r465323423", "createdAt": "2020-08-04T20:52:35Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/preferences/FormManagementPreferences.java", "diffHunk": "@@ -77,40 +84,59 @@ public void onCreate(Bundle savedInstanceState) {\n         setupFormUpdateMode();\n     }\n \n+    @Override\n+    public void onSharedPreferenceChanged(SharedPreferences sharedPreferences, String key) {\n+        super.onSharedPreferenceChanged(sharedPreferences, key);\n+\n+        if (key.equals(KEY_FORM_UPDATE_MODE) || key.equals(KEY_PERIODIC_FORM_UPDATES_CHECK)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "416827bad171f5baea5b697b7e3f05a7ded62e63"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyOTQ2Ng==", "bodyText": "One weirdness about this is that the behavior will be different depending on how the form update settings are ordered relative to the server URL and credential settings in the key set. Perhaps this can be considered at the same time as #4011.", "url": "https://github.com/getodk/collect/pull/3997#discussion_r465329466", "createdAt": "2020-08-04T21:04:36Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/configure/SettingsImporter.java", "diffHunk": "@@ -62,7 +62,13 @@ public boolean fromJSON(@NonNull String json) {\n         loadDefaults(generalSharedPrefs, generalDefaults);\n         loadDefaults(adminSharedPrefs, adminDefaults);\n \n-        settingsChangedHandler.onSettingsChanged();\n+        for (String key: generalSharedPrefs.getAll().keySet()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE4NzQzMQ=="}, "originalCommit": {"oid": "416827bad171f5baea5b697b7e3f05a7ded62e63"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7baf4f139bb425f1271e5b14cb081bdf3c92785", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/e7baf4f139bb425f1271e5b14cb081bdf3c92785", "committedDate": "2020-08-05T16:30:34Z", "message": "Move prefs testing to fragment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce7c15eb8984ce1a02777a9a5f5bb281a386dc42", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/ce7c15eb8984ce1a02777a9a5f5bb281a386dc42", "committedDate": "2020-08-05T16:30:34Z", "message": "Make sure automatic download updates with form mode updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc963bc183d11a6619211267572959c2b4701542", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/bc963bc183d11a6619211267572959c2b4701542", "committedDate": "2020-08-05T16:30:34Z", "message": "Use AndroidX lifecycle in prefs fragments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d103d829a842951e2d2a69990964de3d67131057", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/d103d829a842951e2d2a69990964de3d67131057", "committedDate": "2020-08-05T16:30:34Z", "message": "Make sure switching to google drive disables updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73bfa978734e60613372b53c054b3a877c141cf8", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/73bfa978734e60613372b53c054b3a877c141cf8", "committedDate": "2020-08-05T16:30:34Z", "message": "Shared settings change handler between prefs framework and importer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2190cea588835b1cc9e9ff921232dc2e64c06160", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/2190cea588835b1cc9e9ff921232dc2e64c06160", "committedDate": "2020-08-05T16:30:34Z", "message": "Make sure background work isn't scheduled every time a pref changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "416827bad171f5baea5b697b7e3f05a7ded62e63", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/416827bad171f5baea5b697b7e3f05a7ded62e63", "committedDate": "2020-08-04T16:16:25Z", "message": "Make sure background work isn't scheduled every time a pref changes"}, "afterCommit": {"oid": "2190cea588835b1cc9e9ff921232dc2e64c06160", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/2190cea588835b1cc9e9ff921232dc2e64c06160", "committedDate": "2020-08-05T16:30:34Z", "message": "Make sure background work isn't scheduled every time a pref changes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2570, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}