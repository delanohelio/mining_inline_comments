{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzNjk3MTI2", "number": 3872, "title": "Exit form when instance file cannot be created/is null", "bodyText": "Should fix crash found at https://console.firebase.google.com/u/0/project/api-project-322300403941/crashlytics/app/android:org.odk.collect.android/issues/30fcda84f13db871dca574a1b2cba23f?time=last-seven-days&sessionId=5ECDE9E80054000132DF2A24E11F24F0_DNE_2_v2.\nThis also makes sure we never have a null AuditEventLogger.\nWhat has been done to verify that this works as intended?\nVerified we see the error and form entry exits if instance file can't be created. Had to hardcode the failure to reproduce the case.\nWhy is this the best possible solution? Were any other approaches considered?\nDiscussed before (thanks to @grzesiek2010) for the pointers. I thought adding a specific error message might help us if someone posts this error on the forum.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nI'm not sure of a way to reproduce this (which is why I didn't create an issue) but really this should just fix the crash. I think a quick pass on form loading would be good.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-05-27T08:37:20Z", "url": "https://github.com/getodk/collect/pull/3872", "merged": true, "mergeCommit": {"oid": "0738434702111b7c29d95838e09437389850d1b3"}, "closed": true, "closedAt": "2020-06-02T08:01:17Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclV2uwAFqTQxOTAxNzAwNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnGZLyAFqTQyMjE2MjQ0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MDE3MDA0", "url": "https://github.com/getodk/collect/pull/3872#pullrequestreview-419017004", "createdAt": "2020-05-27T09:29:04Z", "commit": {"oid": "fdc9d9415821ce733460b07d878e3b823830d65d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f904d0c652f71047563af724c7d9313c9e33c76", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/1f904d0c652f71047563af724c7d9313c9e33c76", "committedDate": "2020-05-27T10:02:01Z", "message": "Stop audit event logger from ever being null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54ace7c190b8d495d5ded2eab89ef3ffba51d9a5", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/54ace7c190b8d495d5ded2eab89ef3ffba51d9a5", "committedDate": "2020-05-27T11:28:20Z", "message": "Extract form instace creation to a use case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e976806de5b7394e1ca1063b600d7888263514d", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/7e976806de5b7394e1ca1063b600d7888263514d", "committedDate": "2020-05-27T11:36:14Z", "message": "Add error handling for when form instance cannot be created"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fdc9d9415821ce733460b07d878e3b823830d65d", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/fdc9d9415821ce733460b07d878e3b823830d65d", "committedDate": "2020-05-27T08:27:57Z", "message": "Stop audit event logger from ever being null"}, "afterCommit": {"oid": "7e976806de5b7394e1ca1063b600d7888263514d", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/7e976806de5b7394e1ca1063b600d7888263514d", "committedDate": "2020-05-27T11:36:14Z", "message": "Add error handling for when form instance cannot be created"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2eb5d4e2a820b138d41d5919e37fb6df6ba0da06", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/2eb5d4e2a820b138d41d5919e37fb6df6ba0da06", "committedDate": "2020-05-27T13:08:05Z", "message": "Improve error case setup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NjExMDg5", "url": "https://github.com/getodk/collect/pull/3872#pullrequestreview-419611089", "createdAt": "2020-05-27T21:10:23Z", "commit": {"oid": "7e976806de5b7394e1ca1063b600d7888263514d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMToxMDoyM1rOGbdQ9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMToxMjowM1rOGbdUJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0NDIxNA==", "bodyText": "Would you be open to using loading_form_failed: \"An error occurred while loading the form. Please try again.\" That way we don't need to introduce a new string for a case we know is rare. I don't think that knowing the failure was about form instance file creation is actionable for users.", "url": "https://github.com/getodk/collect/pull/3872#discussion_r431444214", "createdAt": "2020-05-27T21:10:23Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/res/values/strings.xml", "diffHunk": "@@ -743,4 +743,5 @@\n \n     <string name=\"install_id\">Install ID - will replace Device ID in August 2020</string>\n     <string name=\"preference_not_available\">Not available</string>\n+    <string name=\"form_instance_file_creation_error\">Form instance file could not be created!</string>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e976806de5b7394e1ca1063b600d7888263514d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0NTAzMA==", "bodyText": "Could you also do a Timber.e(\"Error creating form instance file\") so we can see it in Crashlytics, keep an eye on how common it is, and possibly learn something from the logs?", "url": "https://github.com/getodk/collect/pull/3872#discussion_r431445030", "createdAt": "2020-05-27T21:12:03Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2394,7 +2390,18 @@ public void denied() {\n                 }\n \n                 if (formController.getInstanceFile() == null) {\n-                    createInstanceDirectory(formController);\n+                    FormInstanceFileCreator formInstanceFileCreator = new FormInstanceFileCreator(\n+                            storagePathProvider,\n+                            System::currentTimeMillis\n+                    );\n+\n+                    File instanceFile = formInstanceFileCreator.createInstanceFile(formPath);\n+                    if (instanceFile != null) {\n+                        formController.setInstanceFile(instanceFile);\n+                    } else {\n+                        showFormLoadErrorAndExit(getString(R.string.form_instance_file_creation_error));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e976806de5b7394e1ca1063b600d7888263514d"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "378bc49eb8d17d8e2e91806aa6d962e241b524e1", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/378bc49eb8d17d8e2e91806aa6d962e241b524e1", "committedDate": "2020-05-28T08:10:16Z", "message": "Add error logging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5OTcwOTQz", "url": "https://github.com/getodk/collect/pull/3872#pullrequestreview-419970943", "createdAt": "2020-05-28T10:19:39Z", "commit": {"oid": "378bc49eb8d17d8e2e91806aa6d962e241b524e1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d97e952b492e2baf40f8e4b46ac889558c7a30b", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/0d97e952b492e2baf40f8e4b46ac889558c7a30b", "committedDate": "2020-06-01T09:25:51Z", "message": "Use generic error when instance file creation fails"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMTYyNDQ3", "url": "https://github.com/getodk/collect/pull/3872#pullrequestreview-422162447", "createdAt": "2020-06-01T20:36:04Z", "commit": {"oid": "0d97e952b492e2baf40f8e4b46ac889558c7a30b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2713, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}