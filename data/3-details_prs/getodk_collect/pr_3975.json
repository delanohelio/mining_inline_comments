{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzNjA1NTU5", "number": 3975, "title": "Rework Date and Time Widgets", "bodyText": "This PR includes rewriting the test coverage and class of Date and Time Widgets\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nI used DialogFragment to create FixedDatePickerDialog and CusotmTimePickerDialog to retain the dialogs across orientation changes.\nDo we need any specific form for testing your changes? If so, please attach one.\nAny form having Date and Time Widgets like AllWidgetsForm\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-07-20T16:15:14Z", "url": "https://github.com/getodk/collect/pull/3975", "merged": true, "mergeCommit": {"oid": "ec415778865d5078f734b4cf71d22ca8a347f438"}, "closed": true, "closedAt": "2020-11-12T10:17:06Z", "author": {"login": "SaumiaSinghal"}, "timelineItems": {"totalCount": 101, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbv1LmgFqTUyODkzOTI5NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbv1LmgFqTUyODkzOTI5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4OTM5Mjk1", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-528939295", "createdAt": "2020-11-12T10:16:49Z", "commit": {"oid": "7eb6cf2d16924ab63fca3eedc18ded631e9f1299"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MTQzMzYw", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-454143360", "createdAt": "2020-07-23T13:43:30Z", "commit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMzo0MzozMVrOG2LJHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMDo0Mjo0MVrOG2a3Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ1ODg0NQ==", "bodyText": "You have this variable just to use it in return, you can get rid of it and return just binding.getRoot()", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459458845", "createdAt": "2020-07-23T13:43:31Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/DateWidget.java", "diffHunk": "@@ -15,113 +15,88 @@\n package org.odk.collect.android.widgets;\n \n import android.annotation.SuppressLint;\n-import android.app.DatePickerDialog;\n+import android.app.Activity;\n import android.content.Context;\n-import android.content.res.Resources;\n-import android.content.res.TypedArray;\n-import android.graphics.Color;\n-import android.graphics.drawable.ColorDrawable;\n-import android.os.Build;\n-import android.util.AttributeSet;\n+import android.util.TypedValue;\n import android.view.View;\n-import android.view.Window;\n-import android.widget.Button;\n-import android.widget.DatePicker;\n-import android.widget.LinearLayout;\n-import android.widget.TextView;\n \n import org.javarosa.core.model.data.DateData;\n import org.javarosa.core.model.data.IAnswerData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.joda.time.LocalDateTime;\n import org.odk.collect.android.R;\n import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.databinding.WidgetAnswerBinding;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n-import org.odk.collect.android.fragments.dialogs.BikramSambatDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.CopticDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.EthiopianDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.IslamicDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.MyanmarDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.PersianDatePickerDialog;\n import org.odk.collect.android.logic.DatePickerDetails;\n import org.odk.collect.android.utilities.DateTimeUtils;\n import org.odk.collect.android.widgets.interfaces.BinaryWidget;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n \n-import java.lang.reflect.Constructor;\n-import java.lang.reflect.Field;\n import java.util.Date;\n \n-import timber.log.Timber;\n-\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createAnswerTextView;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-import static org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog.DATE_PICKER_DIALOG;\n-\n-/**\n- * Displays a DatePicker widget. DateWidget handles leap years and does not allow dates that do not\n- * exist.\n- *\n- * @author Carl Hartung (carlhartung@gmail.com)\n- * @author Yaw Anokwa (yanokwa@gmail.com)\n- */\n @SuppressLint(\"ViewConstructor\")\n-public class DateWidget extends QuestionWidget implements DatePickerDialog.OnDateSetListener, BinaryWidget {\n-    Button dateButton;\n-    TextView dateTextView;\n-\n-    boolean isNullAnswer;\n+public class DateWidget extends QuestionWidget implements BinaryWidget {\n+    WidgetAnswerBinding binding;\n \n     private LocalDateTime date;\n-\n     private DatePickerDetails datePickerDetails;\n+    private boolean isNullAnswer;\n \n     public DateWidget(Context context, QuestionDetails prompt) {\n         this(context, prompt, false);\n     }\n \n     public DateWidget(Context context, QuestionDetails prompt, boolean isPartOfDateTimeWidget) {\n         super(context, prompt, !isPartOfDateTimeWidget);\n-        createWidget(context);\n     }\n \n-    protected void createWidget(Context context) {\n-        datePickerDetails = DateTimeUtils.getDatePickerDetails(getFormEntryPrompt().getQuestion().getAppearanceAttr());\n-        dateButton = createSimpleButton(getContext(), getFormEntryPrompt().isReadOnly(), getContext().getString(R.string.select_date), getAnswerFontSize(), this);\n-        dateTextView = createAnswerTextView(getContext(), getAnswerFontSize());\n-        addViews(context);\n+    @Override\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        binding = WidgetAnswerBinding.inflate(((Activity) context).getLayoutInflater());\n+        View answerView = binding.getRoot();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ2MDg4MQ==", "bodyText": "Do you really need this here? I don't think so because here you just want to add the default text no_date_selected which btw I don't like because it's not consistent with other widgets. @lognaturel can we maybe get rid of it?", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459460881", "createdAt": "2020-07-23T13:46:25Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/DateWidget.java", "diffHunk": "@@ -15,113 +15,88 @@\n package org.odk.collect.android.widgets;\n \n import android.annotation.SuppressLint;\n-import android.app.DatePickerDialog;\n+import android.app.Activity;\n import android.content.Context;\n-import android.content.res.Resources;\n-import android.content.res.TypedArray;\n-import android.graphics.Color;\n-import android.graphics.drawable.ColorDrawable;\n-import android.os.Build;\n-import android.util.AttributeSet;\n+import android.util.TypedValue;\n import android.view.View;\n-import android.view.Window;\n-import android.widget.Button;\n-import android.widget.DatePicker;\n-import android.widget.LinearLayout;\n-import android.widget.TextView;\n \n import org.javarosa.core.model.data.DateData;\n import org.javarosa.core.model.data.IAnswerData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.joda.time.LocalDateTime;\n import org.odk.collect.android.R;\n import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.databinding.WidgetAnswerBinding;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n-import org.odk.collect.android.fragments.dialogs.BikramSambatDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.CopticDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.EthiopianDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.IslamicDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.MyanmarDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.PersianDatePickerDialog;\n import org.odk.collect.android.logic.DatePickerDetails;\n import org.odk.collect.android.utilities.DateTimeUtils;\n import org.odk.collect.android.widgets.interfaces.BinaryWidget;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n \n-import java.lang.reflect.Constructor;\n-import java.lang.reflect.Field;\n import java.util.Date;\n \n-import timber.log.Timber;\n-\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createAnswerTextView;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-import static org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog.DATE_PICKER_DIALOG;\n-\n-/**\n- * Displays a DatePicker widget. DateWidget handles leap years and does not allow dates that do not\n- * exist.\n- *\n- * @author Carl Hartung (carlhartung@gmail.com)\n- * @author Yaw Anokwa (yanokwa@gmail.com)\n- */\n @SuppressLint(\"ViewConstructor\")\n-public class DateWidget extends QuestionWidget implements DatePickerDialog.OnDateSetListener, BinaryWidget {\n-    Button dateButton;\n-    TextView dateTextView;\n-\n-    boolean isNullAnswer;\n+public class DateWidget extends QuestionWidget implements BinaryWidget {\n+    WidgetAnswerBinding binding;\n \n     private LocalDateTime date;\n-\n     private DatePickerDetails datePickerDetails;\n+    private boolean isNullAnswer;\n \n     public DateWidget(Context context, QuestionDetails prompt) {\n         this(context, prompt, false);\n     }\n \n     public DateWidget(Context context, QuestionDetails prompt, boolean isPartOfDateTimeWidget) {\n         super(context, prompt, !isPartOfDateTimeWidget);\n-        createWidget(context);\n     }\n \n-    protected void createWidget(Context context) {\n-        datePickerDetails = DateTimeUtils.getDatePickerDetails(getFormEntryPrompt().getQuestion().getAppearanceAttr());\n-        dateButton = createSimpleButton(getContext(), getFormEntryPrompt().isReadOnly(), getContext().getString(R.string.select_date), getAnswerFontSize(), this);\n-        dateTextView = createAnswerTextView(getContext(), getAnswerFontSize());\n-        addViews(context);\n+    @Override\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        binding = WidgetAnswerBinding.inflate(((Activity) context).getLayoutInflater());\n+        View answerView = binding.getRoot();\n+\n+        datePickerDetails = DateTimeUtils.getDatePickerDetails(prompt.getQuestion().getAppearanceAttr());\n+\n+        if (prompt.isReadOnly()) {\n+            binding.widgetButton.setVisibility(GONE);\n+        } else {\n+            binding.widgetButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            binding.widgetButton.setText(getContext().getString(R.string.select_date));\n+            binding.widgetButton.setOnClickListener(v -> onButtonClick(binding.widgetButton.getId()));\n+        }\n+\n+        binding.widgetAnswerText.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+\n         if (getFormEntryPrompt().getAnswerValue() == null) {\n             clearAnswer();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ2Mjk5MA==", "bodyText": "Do we really need this field? Can't we just relay on the label, (or even on date which is nullable)? Checking if it contains the default message or is empty if we get rid of it (look at my other comment regarding the default message)", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459462990", "createdAt": "2020-07-23T13:49:23Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/DateWidget.java", "diffHunk": "@@ -15,113 +15,88 @@\n package org.odk.collect.android.widgets;\n \n import android.annotation.SuppressLint;\n-import android.app.DatePickerDialog;\n+import android.app.Activity;\n import android.content.Context;\n-import android.content.res.Resources;\n-import android.content.res.TypedArray;\n-import android.graphics.Color;\n-import android.graphics.drawable.ColorDrawable;\n-import android.os.Build;\n-import android.util.AttributeSet;\n+import android.util.TypedValue;\n import android.view.View;\n-import android.view.Window;\n-import android.widget.Button;\n-import android.widget.DatePicker;\n-import android.widget.LinearLayout;\n-import android.widget.TextView;\n \n import org.javarosa.core.model.data.DateData;\n import org.javarosa.core.model.data.IAnswerData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.joda.time.LocalDateTime;\n import org.odk.collect.android.R;\n import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.databinding.WidgetAnswerBinding;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n-import org.odk.collect.android.fragments.dialogs.BikramSambatDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.CopticDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.EthiopianDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.IslamicDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.MyanmarDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.PersianDatePickerDialog;\n import org.odk.collect.android.logic.DatePickerDetails;\n import org.odk.collect.android.utilities.DateTimeUtils;\n import org.odk.collect.android.widgets.interfaces.BinaryWidget;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n \n-import java.lang.reflect.Constructor;\n-import java.lang.reflect.Field;\n import java.util.Date;\n \n-import timber.log.Timber;\n-\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createAnswerTextView;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-import static org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog.DATE_PICKER_DIALOG;\n-\n-/**\n- * Displays a DatePicker widget. DateWidget handles leap years and does not allow dates that do not\n- * exist.\n- *\n- * @author Carl Hartung (carlhartung@gmail.com)\n- * @author Yaw Anokwa (yanokwa@gmail.com)\n- */\n @SuppressLint(\"ViewConstructor\")\n-public class DateWidget extends QuestionWidget implements DatePickerDialog.OnDateSetListener, BinaryWidget {\n-    Button dateButton;\n-    TextView dateTextView;\n-\n-    boolean isNullAnswer;\n+public class DateWidget extends QuestionWidget implements BinaryWidget {\n+    WidgetAnswerBinding binding;\n \n     private LocalDateTime date;\n-\n     private DatePickerDetails datePickerDetails;\n+    private boolean isNullAnswer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ2NDI2Nw==", "bodyText": "I would give it a more meaningful name like selectedDate?", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459464267", "createdAt": "2020-07-23T13:51:05Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/DateWidget.java", "diffHunk": "@@ -15,113 +15,88 @@\n package org.odk.collect.android.widgets;\n \n import android.annotation.SuppressLint;\n-import android.app.DatePickerDialog;\n+import android.app.Activity;\n import android.content.Context;\n-import android.content.res.Resources;\n-import android.content.res.TypedArray;\n-import android.graphics.Color;\n-import android.graphics.drawable.ColorDrawable;\n-import android.os.Build;\n-import android.util.AttributeSet;\n+import android.util.TypedValue;\n import android.view.View;\n-import android.view.Window;\n-import android.widget.Button;\n-import android.widget.DatePicker;\n-import android.widget.LinearLayout;\n-import android.widget.TextView;\n \n import org.javarosa.core.model.data.DateData;\n import org.javarosa.core.model.data.IAnswerData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.joda.time.LocalDateTime;\n import org.odk.collect.android.R;\n import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.databinding.WidgetAnswerBinding;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n-import org.odk.collect.android.fragments.dialogs.BikramSambatDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.CopticDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.EthiopianDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.IslamicDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.MyanmarDatePickerDialog;\n-import org.odk.collect.android.fragments.dialogs.PersianDatePickerDialog;\n import org.odk.collect.android.logic.DatePickerDetails;\n import org.odk.collect.android.utilities.DateTimeUtils;\n import org.odk.collect.android.widgets.interfaces.BinaryWidget;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n \n-import java.lang.reflect.Constructor;\n-import java.lang.reflect.Field;\n import java.util.Date;\n \n-import timber.log.Timber;\n-\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createAnswerTextView;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-import static org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog.DATE_PICKER_DIALOG;\n-\n-/**\n- * Displays a DatePicker widget. DateWidget handles leap years and does not allow dates that do not\n- * exist.\n- *\n- * @author Carl Hartung (carlhartung@gmail.com)\n- * @author Yaw Anokwa (yanokwa@gmail.com)\n- */\n @SuppressLint(\"ViewConstructor\")\n-public class DateWidget extends QuestionWidget implements DatePickerDialog.OnDateSetListener, BinaryWidget {\n-    Button dateButton;\n-    TextView dateTextView;\n-\n-    boolean isNullAnswer;\n+public class DateWidget extends QuestionWidget implements BinaryWidget {\n+    WidgetAnswerBinding binding;\n \n     private LocalDateTime date;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ2NjQ2OA==", "bodyText": "As in DateWidget you don't need this variable just return binding.getRoot() at the bottom", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459466468", "createdAt": "2020-07-23T13:54:04Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/TimeWidget.java", "diffHunk": "@@ -69,241 +45,73 @@ public TimeWidget(Context context, final QuestionDetails prompt) {\n \n     public TimeWidget(Context context, QuestionDetails prompt, boolean isPartOfDateTimeWidget) {\n         super(context, prompt, !isPartOfDateTimeWidget);\n-        createTimeButton();\n-        timeTextView = createAnswerTextView(getContext(), getAnswerFontSize());\n-        createTimePickerDialog();\n-        addViews();\n-    }\n-\n-    @Override\n-    public void clearAnswer() {\n-        clearAnswerWithoutValueChangeEvent();\n-        widgetValueChanged();\n-    }\n-\n-    void clearAnswerWithoutValueChangeEvent() {\n-        nullAnswer = true;\n-        timeTextView.setText(R.string.no_time_selected);\n-    }\n-\n-    @Override\n-    public IAnswerData getAnswer() {\n-        // use picker time, convert to today's date, store as utc\n-        DateTime localDateTime = new DateTime()\n-                .withTime(hourOfDay, minuteOfHour, 0, 0);\n-\n-        return !nullAnswer\n-                ? new TimeData(localDateTime.toDate())\n-                : null;\n     }\n \n     @Override\n-    public void setOnLongClickListener(OnLongClickListener l) {\n-        timeButton.setOnLongClickListener(l);\n-        timeTextView.setOnLongClickListener(l);\n-    }\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        binding = WidgetAnswerBinding.inflate(((Activity) context).getLayoutInflater());\n+        View answerView = binding.getRoot();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ2NzE4Nw==", "bodyText": "As in DateWidget I think we don't need this filed and we can relay on the label.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459467187", "createdAt": "2020-07-23T13:54:54Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/TimeWidget.java", "diffHunk": "@@ -15,52 +15,28 @@\n package org.odk.collect.android.widgets;\n \n import android.annotation.SuppressLint;\n-import android.app.TimePickerDialog;\n+import android.app.Activity;\n import android.content.Context;\n-import android.content.res.TypedArray;\n-import android.graphics.Color;\n-import android.graphics.drawable.ColorDrawable;\n-import android.os.Build;\n-import android.text.format.DateFormat;\n-import android.util.AttributeSet;\n-import android.view.Window;\n-import android.widget.Button;\n-import android.widget.LinearLayout;\n-import android.widget.TextView;\n-import android.widget.TimePicker;\n+import android.util.TypedValue;\n+import android.view.View;\n \n import org.javarosa.core.model.data.IAnswerData;\n-import org.javarosa.core.model.data.TimeData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.joda.time.DateTime;\n import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.databinding.WidgetAnswerBinding;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n-import org.odk.collect.android.widgets.interfaces.ButtonWidget;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n \n-import java.lang.reflect.Constructor;\n-import java.lang.reflect.Field;\n import java.util.Date;\n \n-import timber.log.Timber;\n-\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createAnswerTextView;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-\n-/**\n- * Displays a TimePicker widget.\n- *\n- * @author Carl Hartung (carlhartung@gmail.com)\n- */\n @SuppressLint(\"ViewConstructor\")\n-public class TimeWidget extends QuestionWidget implements ButtonWidget, TimePickerDialog.OnTimeSetListener {\n-    private TimePickerDialog timePickerDialog;\n-\n-    Button timeButton;\n-    final TextView timeTextView;\n+public class TimeWidget extends QuestionWidget {\n+    WidgetAnswerBinding binding;\n \n     private int hourOfDay;\n     private int minuteOfHour;\n-\n     private boolean nullAnswer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3OTA2NQ==", "bodyText": "What if we have at least two Time widgets on one screen then even if you change the second one , the first one will be edited because as opposed to setBinaryData which checks if a widget is waiting for data this just takes the first one? Am I missing something?", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459579065", "createdAt": "2020-07-23T16:32:50Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -698,6 +705,58 @@ private void nonblockingCreateSavePointData() {\n         }\n     }\n \n+    @Override\n+    public void onDateSet(DatePicker view, int year, int month, int dayOfMonth) {\n+        if (currentView != null) {\n+            for (QuestionWidget qw : ((ODKView) currentView).getWidgets()) {\n+                if (qw instanceof DateWidget) {\n+                    LocalDateTime date = new LocalDateTime()\n+                            .withYear(year)\n+                            .withMonthOfYear(month + 1)\n+                            .withDayOfMonth(dayOfMonth)\n+                            .withHourOfDay(0)\n+                            .withMinuteOfHour(0)\n+                            .withSecondOfMinute(0)\n+                            .withMillisOfSecond(0);\n+                    ((DateWidget) qw).setBinaryData(date);\n+                    widgetValueChanged(qw);\n+                    return;\n+                } else if (qw instanceof DateTimeWidget) {\n+                    LocalDateTime date = new LocalDateTime()\n+                            .withYear(year)\n+                            .withMonthOfYear(month + 1)\n+                            .withDayOfMonth(dayOfMonth)\n+                            .withHourOfDay(0)\n+                            .withMinuteOfHour(0)\n+                            .withSecondOfMinute(0)\n+                            .withMillisOfSecond(0);\n+                    ((DateTimeWidget) qw).setBinaryData(date);\n+                    widgetValueChanged(qw);\n+                    return;\n+                }\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void onTimeSet(TimePicker view, int hourOfDay, int minute) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4MTE4MA==", "bodyText": "Please create a view model for this dialog instead of using such a trick to prevent data from clearing.\nBTW it would be good to have a vie model for CustomDatePickerDialog too.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459581180", "createdAt": "2020-07-23T16:36:24Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/fragments/dialogs/CustomTimePickerDialog.java", "diffHunk": "@@ -0,0 +1,153 @@\n+package org.odk.collect.android.fragments.dialogs;\n+\n+import android.app.Dialog;\n+import android.app.TimePickerDialog;\n+import android.content.Context;\n+import android.content.res.TypedArray;\n+import android.graphics.Color;\n+import android.graphics.drawable.ColorDrawable;\n+import android.os.Build;\n+import android.os.Bundle;\n+import android.text.format.DateFormat;\n+import android.util.AttributeSet;\n+import android.view.Window;\n+import android.widget.TimePicker;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.fragment.app.DialogFragment;\n+\n+import org.joda.time.DateTime;\n+import org.odk.collect.android.R;\n+\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.Field;\n+\n+import timber.log.Timber;\n+\n+public class CustomTimePickerDialog extends DialogFragment {\n+    public static final String CURRENT_TIME = \"CURRENT_TIME\";\n+    public static final String TIME_PICKER_THEME = \"TIME_PICKER_THEME\";\n+\n+    private TimePickerDialog.OnTimeSetListener listener;\n+\n+    @Override\n+    public void onAttach(@NonNull Context context) {\n+        super.onAttach(context);\n+\n+        if (context instanceof TimePickerDialog.OnTimeSetListener) {\n+            listener = (TimePickerDialog.OnTimeSetListener) context;\n+        }\n+    }\n+\n+    @NonNull\n+    @Override\n+    public Dialog onCreateDialog(@Nullable Bundle savedInstanceState) {\n+        DateTime date = (DateTime) getArguments().getSerializable(CURRENT_TIME);\n+        setRetainInstance(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4NDQ2NA==", "bodyText": "If you use the same values for start/end or top/bottom you can use layout_marginVertical/layout_marginHorizontal and do that in one line.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459584464", "createdAt": "2020-07-23T16:41:51Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/res/layout/widget_answer.xml", "diffHunk": "@@ -5,22 +5,20 @@\n     android:layout_height=\"wrap_content\">\n \n     <org.odk.collect.android.views.MultiClickSafeButton\n-        android:id=\"@+id/url_button\"\n+        android:id=\"@+id/widget_button\"\n         style=\"@style/Widget.Collect.Button.Custom\"\n         android:layout_width=\"match_parent\"\n         android:layout_height=\"wrap_content\"\n         android:padding=\"@dimen/margin_small\"\n-        android:text=\"@string/open_url\"\n         android:layout_marginStart=\"@dimen/margin_standard\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcxMDQzMQ==", "bodyText": "Also the fact that here you use onTimeSet and above setBinaryData is not consistent i think it would be good to use setBinaryData in all cases. I know that name doesn't match very well since originally it was created for media widgets so I would rename it to just setAnswer maybe.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459710431", "createdAt": "2020-07-23T20:31:15Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -698,6 +705,58 @@ private void nonblockingCreateSavePointData() {\n         }\n     }\n \n+    @Override\n+    public void onDateSet(DatePicker view, int year, int month, int dayOfMonth) {\n+        if (currentView != null) {\n+            for (QuestionWidget qw : ((ODKView) currentView).getWidgets()) {\n+                if (qw instanceof DateWidget) {\n+                    LocalDateTime date = new LocalDateTime()\n+                            .withYear(year)\n+                            .withMonthOfYear(month + 1)\n+                            .withDayOfMonth(dayOfMonth)\n+                            .withHourOfDay(0)\n+                            .withMinuteOfHour(0)\n+                            .withSecondOfMinute(0)\n+                            .withMillisOfSecond(0);\n+                    ((DateWidget) qw).setBinaryData(date);\n+                    widgetValueChanged(qw);\n+                    return;\n+                } else if (qw instanceof DateTimeWidget) {\n+                    LocalDateTime date = new LocalDateTime()\n+                            .withYear(year)\n+                            .withMonthOfYear(month + 1)\n+                            .withDayOfMonth(dayOfMonth)\n+                            .withHourOfDay(0)\n+                            .withMinuteOfHour(0)\n+                            .withSecondOfMinute(0)\n+                            .withMillisOfSecond(0);\n+                    ((DateTimeWidget) qw).setBinaryData(date);\n+                    widgetValueChanged(qw);\n+                    return;\n+                }\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void onTimeSet(TimePicker view, int hourOfDay, int minute) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3OTA2NQ=="}, "originalCommit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcxNDI4NA==", "bodyText": "Why do we need this here?", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459714284", "createdAt": "2020-07-23T20:38:34Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/DateTimeWidget.java", "diffHunk": "@@ -97,56 +123,90 @@ public IAnswerData getAnswer() {\n \n     @Override\n     public void clearAnswer() {\n-        dateWidget.clearAnswerWithoutValueChangeEvent();\n-        timeWidget.clearAnswerWithoutValueChangeEvent();\n+        isDateNull = true;\n+        binding.dateAnswerText.setText(R.string.no_date_selected);\n+        setDateToCurrent();\n \n+        isTimeNull = true;\n+        binding.timeAnswerText.setText(R.string.no_time_selected);\n+        setTimeToCurrent();\n         widgetValueChanged();\n     }\n \n     @Override\n     public void setOnLongClickListener(OnLongClickListener l) {\n-        dateWidget.setOnLongClickListener(l);\n-        timeWidget.setOnLongClickListener(l);\n+        binding.dateButton.setOnLongClickListener(l);\n+        binding.dateAnswerText.setOnLongClickListener(l);\n+\n+        binding.timeButton.setOnLongClickListener(l);\n+        binding.timeAnswerText.setOnLongClickListener(l);\n     }\n \n     @Override\n     public void cancelLongPress() {\n         super.cancelLongPress();\n-        dateWidget.cancelLongPress();\n-        timeWidget.cancelLongPress();\n+        binding.dateButton.cancelLongPress();\n+        binding.dateAnswerText.cancelLongPress();\n+\n+        binding.timeButton.cancelLongPress();\n+        binding.timeAnswerText.cancelLongPress();\n     }\n \n     @Override\n     public void setBinaryData(Object answer) {\n-        dateWidget.setBinaryData(answer);\n+        if (answer instanceof LocalDateTime) {\n+            date = (LocalDateTime) answer;\n+            isDateNull = false;\n+            DateTimeWidgetUtils.setDateLabel(getContext(), binding.dateAnswerText, (Date) getAnswer().getValue(), datePickerDetails);\n+        }\n     }\n \n-    public DateWidget getDateWidget() {\n-        return dateWidget;\n+    @Override\n+    public void onButtonClick(int buttonId) {\n+        DateTimeWidgetUtils.createTimePickerDialog((FormEntryActivity) getContext(), hourOfDay, minuteOfHour);\n     }\n \n-    // Exposed for testing purposes to avoid reflection.\n-    public void setDateWidget(DateWidget dateWidget) {\n-        this.dateWidget = dateWidget;\n+    @Override\n+    public void widgetValueChanged(QuestionWidget changedWidget) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "originalPosition": 198}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcxNjM1NQ==", "bodyText": "Can't we simplify this and just include layout/widget_answer twice?\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:orientation=\"vertical\" android:layout_width=\"match_parent\"\n    android:layout_height=\"wrap_content\">\n\n    <include\n        layout=\"@layout/widget_answer\"\n        android:id=\"@+id/date_widget\"/>\n\n    <include\n        layout=\"@layout/widget_answer\"\n        android:id=\"@+id/time_widget\"/>\n\n</LinearLayout>", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459716355", "createdAt": "2020-07-23T20:42:41Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/res/layout/date_time_widget_answer.xml", "diffHunk": "@@ -0,0 +1,54 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\"?>\n+<LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n+    android:orientation=\"vertical\" android:layout_width=\"match_parent\"\n+    android:layout_height=\"wrap_content\">\n+\n+    <org.odk.collect.android.views.MultiClickSafeButton", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NDg3MjA3", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-454487207", "createdAt": "2020-07-23T20:53:37Z", "commit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMDo1MzozN1rOG2bL8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMDo1MzozN1rOG2bL8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcyMTcxMw==", "bodyText": "It's weird that we pass boolean nullAnswer here I think we should check for it before we use this method.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459721713", "createdAt": "2020-07-23T20:53:37Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/DateTimeWidgetUtils.java", "diffHunk": "@@ -0,0 +1,124 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import android.content.Context;\n+import android.os.Build;\n+import android.os.Bundle;\n+import android.widget.TextView;\n+\n+import org.javarosa.core.model.data.TimeData;\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.joda.time.DateTime;\n+import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.fragments.dialogs.BikramSambatDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CopticDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.EthiopianDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.IslamicDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.MyanmarDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.PersianDatePickerDialog;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DateTimeUtils;\n+import org.odk.collect.android.utilities.DialogUtils;\n+import org.odk.collect.android.utilities.ThemeUtils;\n+\n+import java.util.Date;\n+\n+import static org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog.DATE_PICKER_DIALOG;\n+import static org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog.CURRENT_TIME;\n+import static org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog.TIME_PICKER_THEME;\n+import static org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog.CURRENT_DATE;\n+import static org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog.DATE_PICKER_DETAILS;\n+import static org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog.DATE_PICKER_THEME;\n+\n+public class DateTimeWidgetUtils {\n+\n+    private DateTimeWidgetUtils() {\n+    }\n+\n+    public static TimeData getTimeData(int hourOfDay, int minuteOfHour, boolean nullAnswer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NDg4MjE1", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-454488215", "createdAt": "2020-07-23T20:55:07Z", "commit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMDo1NTowN1rOG2bO5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMDo1NTowN1rOG2bO5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcyMjQ3MA==", "bodyText": "it should be a part of widget class, passing TextView dateAnswerText just to setText on it is strange.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459722470", "createdAt": "2020-07-23T20:55:07Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/DateTimeWidgetUtils.java", "diffHunk": "@@ -0,0 +1,124 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import android.content.Context;\n+import android.os.Build;\n+import android.os.Bundle;\n+import android.widget.TextView;\n+\n+import org.javarosa.core.model.data.TimeData;\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.joda.time.DateTime;\n+import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.fragments.dialogs.BikramSambatDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CopticDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.EthiopianDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.IslamicDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.MyanmarDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.PersianDatePickerDialog;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DateTimeUtils;\n+import org.odk.collect.android.utilities.DialogUtils;\n+import org.odk.collect.android.utilities.ThemeUtils;\n+\n+import java.util.Date;\n+\n+import static org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog.DATE_PICKER_DIALOG;\n+import static org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog.CURRENT_TIME;\n+import static org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog.TIME_PICKER_THEME;\n+import static org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog.CURRENT_DATE;\n+import static org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog.DATE_PICKER_DETAILS;\n+import static org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog.DATE_PICKER_THEME;\n+\n+public class DateTimeWidgetUtils {\n+\n+    private DateTimeWidgetUtils() {\n+    }\n+\n+    public static TimeData getTimeData(int hourOfDay, int minuteOfHour, boolean nullAnswer) {\n+        // use picker time, convert to today's date, store as utc\n+        DateTime localDateTime = new DateTime()\n+                .withTime(hourOfDay, minuteOfHour, 0, 0);\n+\n+        return !nullAnswer\n+                ? new TimeData(localDateTime.toDate())\n+                : null;\n+    }\n+\n+    public static void setDateLabel(Context context, TextView dateAnswerText, Date date, DatePickerDetails datePickerDetails) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NDg4NDAw", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-454488400", "createdAt": "2020-07-23T20:55:24Z", "commit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMDo1NToyNVrOG2bPiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMDo1NToyNVrOG2bPiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcyMjYzMg==", "bodyText": "As above it should be a part of widget class.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459722632", "createdAt": "2020-07-23T20:55:25Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/DateTimeWidgetUtils.java", "diffHunk": "@@ -0,0 +1,124 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import android.content.Context;\n+import android.os.Build;\n+import android.os.Bundle;\n+import android.widget.TextView;\n+\n+import org.javarosa.core.model.data.TimeData;\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.joda.time.DateTime;\n+import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.fragments.dialogs.BikramSambatDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CopticDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.EthiopianDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.IslamicDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.MyanmarDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.PersianDatePickerDialog;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DateTimeUtils;\n+import org.odk.collect.android.utilities.DialogUtils;\n+import org.odk.collect.android.utilities.ThemeUtils;\n+\n+import java.util.Date;\n+\n+import static org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog.DATE_PICKER_DIALOG;\n+import static org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog.CURRENT_TIME;\n+import static org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog.TIME_PICKER_THEME;\n+import static org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog.CURRENT_DATE;\n+import static org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog.DATE_PICKER_DETAILS;\n+import static org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog.DATE_PICKER_THEME;\n+\n+public class DateTimeWidgetUtils {\n+\n+    private DateTimeWidgetUtils() {\n+    }\n+\n+    public static TimeData getTimeData(int hourOfDay, int minuteOfHour, boolean nullAnswer) {\n+        // use picker time, convert to today's date, store as utc\n+        DateTime localDateTime = new DateTime()\n+                .withTime(hourOfDay, minuteOfHour, 0, 0);\n+\n+        return !nullAnswer\n+                ? new TimeData(localDateTime.toDate())\n+                : null;\n+    }\n+\n+    public static void setDateLabel(Context context, TextView dateAnswerText, Date date, DatePickerDetails datePickerDetails) {\n+        dateAnswerText.setText(DateTimeUtils.getDateTimeLabel(date, datePickerDetails, false, context));\n+    }\n+\n+    public static void setTimeLabel(TextView timeAnswerText, int hourOfDay, int minuteOfHour, boolean nullAnswer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NDg5NjAx", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-454489601", "createdAt": "2020-07-23T20:57:15Z", "commit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMDo1NzoxNVrOG2bTRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMDo1NzoxNVrOG2bTRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcyMzU5MA==", "bodyText": "FormEntryPrompt prompt is used just to get its index so please pass the index only.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459723590", "createdAt": "2020-07-23T20:57:15Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/DateTimeWidgetUtils.java", "diffHunk": "@@ -0,0 +1,124 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import android.content.Context;\n+import android.os.Build;\n+import android.os.Bundle;\n+import android.widget.TextView;\n+\n+import org.javarosa.core.model.data.TimeData;\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.joda.time.DateTime;\n+import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.fragments.dialogs.BikramSambatDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CopticDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.EthiopianDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.IslamicDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.MyanmarDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.PersianDatePickerDialog;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DateTimeUtils;\n+import org.odk.collect.android.utilities.DialogUtils;\n+import org.odk.collect.android.utilities.ThemeUtils;\n+\n+import java.util.Date;\n+\n+import static org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog.DATE_PICKER_DIALOG;\n+import static org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog.CURRENT_TIME;\n+import static org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog.TIME_PICKER_THEME;\n+import static org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog.CURRENT_DATE;\n+import static org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog.DATE_PICKER_DETAILS;\n+import static org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog.DATE_PICKER_THEME;\n+\n+public class DateTimeWidgetUtils {\n+\n+    private DateTimeWidgetUtils() {\n+    }\n+\n+    public static TimeData getTimeData(int hourOfDay, int minuteOfHour, boolean nullAnswer) {\n+        // use picker time, convert to today's date, store as utc\n+        DateTime localDateTime = new DateTime()\n+                .withTime(hourOfDay, minuteOfHour, 0, 0);\n+\n+        return !nullAnswer\n+                ? new TimeData(localDateTime.toDate())\n+                : null;\n+    }\n+\n+    public static void setDateLabel(Context context, TextView dateAnswerText, Date date, DatePickerDetails datePickerDetails) {\n+        dateAnswerText.setText(DateTimeUtils.getDateTimeLabel(date, datePickerDetails, false, context));\n+    }\n+\n+    public static void setTimeLabel(TextView timeAnswerText, int hourOfDay, int minuteOfHour, boolean nullAnswer) {\n+        timeAnswerText.setText(getTimeData(hourOfDay, minuteOfHour, nullAnswer).getDisplayText());\n+    }\n+\n+    public static void showDatePickerDialog(FormEntryActivity activity, FormEntryPrompt prompt, DatePickerDetails datePickerDetails,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NDkxNzY4", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-454491768", "createdAt": "2020-07-23T21:00:30Z", "commit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMTowMDozMVrOG2baIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMTowMDozMVrOG2baIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcyNTM0Nw==", "bodyText": "i think we can get rid of this DATE_PICKER_DIALOG static value and use CustomDatePickerDialog.class.getName() in all cases.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459725347", "createdAt": "2020-07-23T21:00:31Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/DateTimeWidgetUtils.java", "diffHunk": "@@ -0,0 +1,124 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import android.content.Context;\n+import android.os.Build;\n+import android.os.Bundle;\n+import android.widget.TextView;\n+\n+import org.javarosa.core.model.data.TimeData;\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.joda.time.DateTime;\n+import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.fragments.dialogs.BikramSambatDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CopticDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.EthiopianDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.IslamicDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.MyanmarDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.PersianDatePickerDialog;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DateTimeUtils;\n+import org.odk.collect.android.utilities.DialogUtils;\n+import org.odk.collect.android.utilities.ThemeUtils;\n+\n+import java.util.Date;\n+\n+import static org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog.DATE_PICKER_DIALOG;\n+import static org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog.CURRENT_TIME;\n+import static org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog.TIME_PICKER_THEME;\n+import static org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog.CURRENT_DATE;\n+import static org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog.DATE_PICKER_DETAILS;\n+import static org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog.DATE_PICKER_THEME;\n+\n+public class DateTimeWidgetUtils {\n+\n+    private DateTimeWidgetUtils() {\n+    }\n+\n+    public static TimeData getTimeData(int hourOfDay, int minuteOfHour, boolean nullAnswer) {\n+        // use picker time, convert to today's date, store as utc\n+        DateTime localDateTime = new DateTime()\n+                .withTime(hourOfDay, minuteOfHour, 0, 0);\n+\n+        return !nullAnswer\n+                ? new TimeData(localDateTime.toDate())\n+                : null;\n+    }\n+\n+    public static void setDateLabel(Context context, TextView dateAnswerText, Date date, DatePickerDetails datePickerDetails) {\n+        dateAnswerText.setText(DateTimeUtils.getDateTimeLabel(date, datePickerDetails, false, context));\n+    }\n+\n+    public static void setTimeLabel(TextView timeAnswerText, int hourOfDay, int minuteOfHour, boolean nullAnswer) {\n+        timeAnswerText.setText(getTimeData(hourOfDay, minuteOfHour, nullAnswer).getDisplayText());\n+    }\n+\n+    public static void showDatePickerDialog(FormEntryActivity activity, FormEntryPrompt prompt, DatePickerDetails datePickerDetails,\n+                                            LocalDateTime date) {\n+        switch (datePickerDetails.getDatePickerType()) {\n+            case ETHIOPIAN:\n+                CustomDatePickerDialog dialog = EthiopianDatePickerDialog.newInstance(prompt.getIndex(), date, datePickerDetails);\n+                dialog.show(activity.getSupportFragmentManager(), DATE_PICKER_DIALOG);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f369b5c5978f0604b784825cb5e5867fefbf985e"}, "originalPosition": 64}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1fc2c09acd7725066751c9c8bf51a9a3015de97", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/f1fc2c09acd7725066751c9c8bf51a9a3015de97", "committedDate": "2020-07-23T22:52:38Z", "message": "code refactor"}, "afterCommit": {"oid": "5df577aab33aa664aa4b3f693522b2fba95481dc", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/5df577aab33aa664aa4b3f693522b2fba95481dc", "committedDate": "2020-07-24T02:47:05Z", "message": "code improvements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NzMzNjY1", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-454733665", "createdAt": "2020-07-24T09:00:43Z", "commit": {"oid": "38ce2d8d772001cea191113a2a0505ba5b142ee0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwOTowMDo0M1rOG2oIjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwOToxNzo0NlrOG2oreQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkzMzgzOA==", "bodyText": "You won't need negation if you turn the order:\n        return binding.widgetAnswerText.getText().equals(getContext().getString(R.string.no_date_selected))\n                ? null\n                : new DateData(selectedDate.toDate());", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459933838", "createdAt": "2020-07-24T09:00:43Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/DateWidget.java", "diffHunk": "@@ -83,291 +48,69 @@ public DateWidget(Context context, QuestionDetails prompt) {\n \n     public DateWidget(Context context, QuestionDetails prompt, boolean isPartOfDateTimeWidget) {\n         super(context, prompt, !isPartOfDateTimeWidget);\n-        createWidget(context);\n     }\n \n-    protected void createWidget(Context context) {\n-        datePickerDetails = DateTimeUtils.getDatePickerDetails(getFormEntryPrompt().getQuestion().getAppearanceAttr());\n-        dateButton = createSimpleButton(getContext(), getFormEntryPrompt().isReadOnly(), getContext().getString(R.string.select_date), getAnswerFontSize(), this);\n-        dateTextView = createAnswerTextView(getContext(), getAnswerFontSize());\n-        addViews(context);\n-        if (getFormEntryPrompt().getAnswerValue() == null) {\n-            clearAnswer();\n-            setDateToCurrent();\n+    @Override\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        binding = WidgetAnswerBinding.inflate(((Activity) context).getLayoutInflater());\n+        datePickerDetails = DateTimeUtils.getDatePickerDetails(prompt.getQuestion().getAppearanceAttr());\n+\n+        if (prompt.isReadOnly()) {\n+            binding.widgetButton.setVisibility(GONE);\n         } else {\n-            date = new LocalDateTime(getFormEntryPrompt().getAnswerValue().getValue());\n-            setDateLabel();\n+            binding.widgetButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            binding.widgetButton.setText(getContext().getString(R.string.select_date));\n+            binding.widgetButton.setOnClickListener(v -> DateTimeWidgetUtils.showDatePickerDialog(\n+                    (FormEntryActivity) getContext(), prompt.getIndex(), datePickerDetails, selectedDate));\n         }\n+        binding.widgetAnswerText.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+\n+        if (prompt.getAnswerValue() == null) {\n+            selectedDate = DateTimeWidgetUtils.getCurrentDate();\n+            binding.widgetAnswerText.setText(R.string.no_date_selected);\n+        } else {\n+            selectedDate = new LocalDateTime(getFormEntryPrompt().getAnswerValue().getValue());\n+            binding.widgetAnswerText.setText(DateTimeUtils.getDateTimeLabel(\n+                    (Date) getAnswer().getValue(), datePickerDetails, false, context));\n+        }\n+\n+        return binding.getRoot();\n     }\n \n     @Override\n     public void setOnLongClickListener(OnLongClickListener l) {\n-        dateButton.setOnLongClickListener(l);\n-        dateTextView.setOnLongClickListener(l);\n+        binding.widgetButton.setOnLongClickListener(l);\n+        binding.widgetAnswerText.setOnLongClickListener(l);\n     }\n \n     @Override\n     public void cancelLongPress() {\n         super.cancelLongPress();\n-        dateButton.cancelLongPress();\n-        dateTextView.cancelLongPress();\n+        binding.widgetButton.cancelLongPress();\n+        binding.widgetAnswerText.cancelLongPress();\n     }\n \n     @Override\n     public void clearAnswer() {\n-        clearAnswerWithoutValueChangeEvent();\n+        selectedDate = DateTimeWidgetUtils.getCurrentDate();\n+        binding.widgetAnswerText.setText(R.string.no_date_selected);\n         widgetValueChanged();\n     }\n \n-    void clearAnswerWithoutValueChangeEvent() {\n-        isNullAnswer = true;\n-        dateTextView.setText(R.string.no_date_selected);\n-        setDateToCurrent();\n-    }\n-\n     @Override\n     public IAnswerData getAnswer() {\n-        return isNullAnswer ? null : new DateData(date.toDate());\n+        return !binding.widgetAnswerText.getText().equals(getContext().getString(R.string.no_date_selected))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38ce2d8d772001cea191113a2a0505ba5b142ee0"}, "originalPosition": 153}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkzNDM0Mw==", "bodyText": "You won't need negation if you turn the order:\n        return binding.widgetAnswerText.getText().equals(getContext().getString(R.string.no_time_selected))\n                ? null\n                : DateTimeWidgetUtils.getTimeData(hourOfDay, minuteOfHour);", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459934343", "createdAt": "2020-07-24T09:01:49Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/TimeWidget.java", "diffHunk": "@@ -15,295 +15,106 @@\n package org.odk.collect.android.widgets;\n \n import android.annotation.SuppressLint;\n-import android.app.TimePickerDialog;\n+import android.app.Activity;\n import android.content.Context;\n-import android.content.res.TypedArray;\n-import android.graphics.Color;\n-import android.graphics.drawable.ColorDrawable;\n-import android.os.Build;\n-import android.text.format.DateFormat;\n-import android.util.AttributeSet;\n-import android.view.Window;\n-import android.widget.Button;\n-import android.widget.LinearLayout;\n-import android.widget.TextView;\n-import android.widget.TimePicker;\n+import android.util.TypedValue;\n+import android.view.View;\n \n import org.javarosa.core.model.data.IAnswerData;\n-import org.javarosa.core.model.data.TimeData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.joda.time.DateTime;\n import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.databinding.WidgetAnswerBinding;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n-import org.odk.collect.android.widgets.interfaces.ButtonClickListener;\n+import org.odk.collect.android.widgets.interfaces.BinaryDataReceiver;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n \n-import java.lang.reflect.Constructor;\n-import java.lang.reflect.Field;\n import java.util.Date;\n \n-import timber.log.Timber;\n-\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createAnswerTextView;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-\n-/**\n- * Displays a TimePicker widget.\n- *\n- * @author Carl Hartung (carlhartung@gmail.com)\n- */\n @SuppressLint(\"ViewConstructor\")\n-public class TimeWidget extends QuestionWidget implements ButtonClickListener, TimePickerDialog.OnTimeSetListener {\n-    private TimePickerDialog timePickerDialog;\n-\n-    Button timeButton;\n-    final TextView timeTextView;\n+public class TimeWidget extends QuestionWidget implements BinaryDataReceiver {\n+    WidgetAnswerBinding binding;\n \n     private int hourOfDay;\n     private int minuteOfHour;\n \n-    private boolean nullAnswer;\n-\n     public TimeWidget(Context context, final QuestionDetails prompt) {\n         this(context, prompt, false);\n     }\n \n     public TimeWidget(Context context, QuestionDetails prompt, boolean isPartOfDateTimeWidget) {\n         super(context, prompt, !isPartOfDateTimeWidget);\n-        createTimeButton();\n-        timeTextView = createAnswerTextView(getContext(), getAnswerFontSize());\n-        createTimePickerDialog();\n-        addViews();\n-    }\n-\n-    @Override\n-    public void clearAnswer() {\n-        clearAnswerWithoutValueChangeEvent();\n-        widgetValueChanged();\n-    }\n-\n-    void clearAnswerWithoutValueChangeEvent() {\n-        nullAnswer = true;\n-        timeTextView.setText(R.string.no_time_selected);\n-    }\n-\n-    @Override\n-    public IAnswerData getAnswer() {\n-        // use picker time, convert to today's date, store as utc\n-        DateTime localDateTime = new DateTime()\n-                .withTime(hourOfDay, minuteOfHour, 0, 0);\n-\n-        return !nullAnswer\n-                ? new TimeData(localDateTime.toDate())\n-                : null;\n     }\n \n     @Override\n-    public void setOnLongClickListener(OnLongClickListener l) {\n-        timeButton.setOnLongClickListener(l);\n-        timeTextView.setOnLongClickListener(l);\n-    }\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        binding = WidgetAnswerBinding.inflate(((Activity) context).getLayoutInflater());\n \n-    @Override\n-    public void cancelLongPress() {\n-        super.cancelLongPress();\n-        timeButton.cancelLongPress();\n-        timeTextView.cancelLongPress();\n-    }\n-\n-    private void createTimeButton() {\n-        timeButton = createSimpleButton(getContext(), getFormEntryPrompt().isReadOnly(), getContext().getString(R.string.select_time), getAnswerFontSize(), this);\n-    }\n-\n-    private void addViews() {\n-        LinearLayout linearLayout = new LinearLayout(getContext());\n-        linearLayout.setOrientation(LinearLayout.VERTICAL);\n-        linearLayout.addView(timeButton);\n-        linearLayout.addView(timeTextView);\n-        addAnswerView(linearLayout, WidgetViewUtils.getStandardMargin(getContext()));\n-    }\n-\n-    public void setTimeLabel() {\n-        nullAnswer = false;\n-        timeTextView.setText(getAnswer().getDisplayText());\n-    }\n-\n-    private void createTimePickerDialog() {\n-        timePickerDialog = new CustomTimePickerDialog(getContext(), this, 0, 0);\n-        timePickerDialog.setCanceledOnTouchOutside(false);\n+        if (prompt.isReadOnly()) {\n+            binding.widgetButton.setVisibility(GONE);\n+        } else {\n+            binding.widgetButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            binding.widgetButton.setText(getContext().getString(R.string.select_time));\n+            binding.widgetButton.setOnClickListener(v -> DateTimeWidgetUtils.createTimePickerDialog(\n+                    (FormEntryActivity) getContext(), hourOfDay, minuteOfHour));\n+        }\n+        binding.widgetAnswerText.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n \n-        if (getFormEntryPrompt().getAnswerValue() == null) {\n-            clearAnswer();\n+        if (prompt.getAnswerValue() == null) {\n+            setTimeToCurrent();\n+            binding.widgetAnswerText.setText(R.string.no_time_selected);\n         } else {\n             Date date = (Date) getFormEntryPrompt().getAnswerValue().getValue();\n-\n             DateTime dateTime = new DateTime(date);\n-            updateTime(dateTime, true);\n-        }\n-    }\n-\n-    public int getHour() {\n-        return hourOfDay;\n-    }\n \n-    public int getMinute() {\n-        return minuteOfHour;\n-    }\n-\n-    public boolean isNullAnswer() {\n-        return nullAnswer;\n-    }\n+            hourOfDay = dateTime.getHourOfDay();\n+            minuteOfHour = dateTime.getMinuteOfHour();\n+            binding.widgetAnswerText.setText(DateTimeWidgetUtils.getTimeData(hourOfDay, minuteOfHour).getDisplayText());\n+        }\n \n-    public void setTimeToCurrent() {\n-        updateTime(DateTime.now(), false);\n+        return binding.getRoot();\n     }\n \n-    public void updateTime(DateTime dateTime) {\n-        updateTime(dateTime, true);\n+    @Override\n+    public void clearAnswer() {\n+        setTimeToCurrent();\n+        binding.widgetAnswerText.setText(R.string.no_time_selected);\n+        widgetValueChanged();\n     }\n \n-    public void updateTime(DateTime dateTime, boolean shouldUpdateLabel) {\n-        updateTime(dateTime.getHourOfDay(), dateTime.getMinuteOfHour(), shouldUpdateLabel);\n+    @Override\n+    public IAnswerData getAnswer() {\n+        return !binding.widgetAnswerText.getText().equals(getContext().getString(R.string.no_time_selected))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38ce2d8d772001cea191113a2a0505ba5b142ee0"}, "originalPosition": 188}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkzNTgxMw==", "bodyText": "I think it's not consistent than in this widget we keep separate values hour, minute and in DateWidget we keep LocalDateTime wouldn't it be better to have TimeData field here instead of hour/minute?", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459935813", "createdAt": "2020-07-24T09:04:43Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/TimeWidget.java", "diffHunk": "@@ -15,295 +15,106 @@\n package org.odk.collect.android.widgets;\n \n import android.annotation.SuppressLint;\n-import android.app.TimePickerDialog;\n+import android.app.Activity;\n import android.content.Context;\n-import android.content.res.TypedArray;\n-import android.graphics.Color;\n-import android.graphics.drawable.ColorDrawable;\n-import android.os.Build;\n-import android.text.format.DateFormat;\n-import android.util.AttributeSet;\n-import android.view.Window;\n-import android.widget.Button;\n-import android.widget.LinearLayout;\n-import android.widget.TextView;\n-import android.widget.TimePicker;\n+import android.util.TypedValue;\n+import android.view.View;\n \n import org.javarosa.core.model.data.IAnswerData;\n-import org.javarosa.core.model.data.TimeData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.joda.time.DateTime;\n import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.databinding.WidgetAnswerBinding;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n-import org.odk.collect.android.widgets.interfaces.ButtonClickListener;\n+import org.odk.collect.android.widgets.interfaces.BinaryDataReceiver;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n \n-import java.lang.reflect.Constructor;\n-import java.lang.reflect.Field;\n import java.util.Date;\n \n-import timber.log.Timber;\n-\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createAnswerTextView;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-\n-/**\n- * Displays a TimePicker widget.\n- *\n- * @author Carl Hartung (carlhartung@gmail.com)\n- */\n @SuppressLint(\"ViewConstructor\")\n-public class TimeWidget extends QuestionWidget implements ButtonClickListener, TimePickerDialog.OnTimeSetListener {\n-    private TimePickerDialog timePickerDialog;\n-\n-    Button timeButton;\n-    final TextView timeTextView;\n+public class TimeWidget extends QuestionWidget implements BinaryDataReceiver {\n+    WidgetAnswerBinding binding;\n \n     private int hourOfDay;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38ce2d8d772001cea191113a2a0505ba5b142ee0"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkzODU5Ng==", "bodyText": "As I said in one of my previous comments it would be good to rename this method because now it is used in many widgets not just binary ones. setData maybe?", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459938596", "createdAt": "2020-07-24T09:09:32Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/TimeWidget.java", "diffHunk": "@@ -15,295 +15,106 @@\n package org.odk.collect.android.widgets;\n \n import android.annotation.SuppressLint;\n-import android.app.TimePickerDialog;\n+import android.app.Activity;\n import android.content.Context;\n-import android.content.res.TypedArray;\n-import android.graphics.Color;\n-import android.graphics.drawable.ColorDrawable;\n-import android.os.Build;\n-import android.text.format.DateFormat;\n-import android.util.AttributeSet;\n-import android.view.Window;\n-import android.widget.Button;\n-import android.widget.LinearLayout;\n-import android.widget.TextView;\n-import android.widget.TimePicker;\n+import android.util.TypedValue;\n+import android.view.View;\n \n import org.javarosa.core.model.data.IAnswerData;\n-import org.javarosa.core.model.data.TimeData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.joda.time.DateTime;\n import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.databinding.WidgetAnswerBinding;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n-import org.odk.collect.android.widgets.interfaces.ButtonClickListener;\n+import org.odk.collect.android.widgets.interfaces.BinaryDataReceiver;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n \n-import java.lang.reflect.Constructor;\n-import java.lang.reflect.Field;\n import java.util.Date;\n \n-import timber.log.Timber;\n-\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createAnswerTextView;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-\n-/**\n- * Displays a TimePicker widget.\n- *\n- * @author Carl Hartung (carlhartung@gmail.com)\n- */\n @SuppressLint(\"ViewConstructor\")\n-public class TimeWidget extends QuestionWidget implements ButtonClickListener, TimePickerDialog.OnTimeSetListener {\n-    private TimePickerDialog timePickerDialog;\n-\n-    Button timeButton;\n-    final TextView timeTextView;\n+public class TimeWidget extends QuestionWidget implements BinaryDataReceiver {\n+    WidgetAnswerBinding binding;\n \n     private int hourOfDay;\n     private int minuteOfHour;\n \n-    private boolean nullAnswer;\n-\n     public TimeWidget(Context context, final QuestionDetails prompt) {\n         this(context, prompt, false);\n     }\n \n     public TimeWidget(Context context, QuestionDetails prompt, boolean isPartOfDateTimeWidget) {\n         super(context, prompt, !isPartOfDateTimeWidget);\n-        createTimeButton();\n-        timeTextView = createAnswerTextView(getContext(), getAnswerFontSize());\n-        createTimePickerDialog();\n-        addViews();\n-    }\n-\n-    @Override\n-    public void clearAnswer() {\n-        clearAnswerWithoutValueChangeEvent();\n-        widgetValueChanged();\n-    }\n-\n-    void clearAnswerWithoutValueChangeEvent() {\n-        nullAnswer = true;\n-        timeTextView.setText(R.string.no_time_selected);\n-    }\n-\n-    @Override\n-    public IAnswerData getAnswer() {\n-        // use picker time, convert to today's date, store as utc\n-        DateTime localDateTime = new DateTime()\n-                .withTime(hourOfDay, minuteOfHour, 0, 0);\n-\n-        return !nullAnswer\n-                ? new TimeData(localDateTime.toDate())\n-                : null;\n     }\n \n     @Override\n-    public void setOnLongClickListener(OnLongClickListener l) {\n-        timeButton.setOnLongClickListener(l);\n-        timeTextView.setOnLongClickListener(l);\n-    }\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        binding = WidgetAnswerBinding.inflate(((Activity) context).getLayoutInflater());\n \n-    @Override\n-    public void cancelLongPress() {\n-        super.cancelLongPress();\n-        timeButton.cancelLongPress();\n-        timeTextView.cancelLongPress();\n-    }\n-\n-    private void createTimeButton() {\n-        timeButton = createSimpleButton(getContext(), getFormEntryPrompt().isReadOnly(), getContext().getString(R.string.select_time), getAnswerFontSize(), this);\n-    }\n-\n-    private void addViews() {\n-        LinearLayout linearLayout = new LinearLayout(getContext());\n-        linearLayout.setOrientation(LinearLayout.VERTICAL);\n-        linearLayout.addView(timeButton);\n-        linearLayout.addView(timeTextView);\n-        addAnswerView(linearLayout, WidgetViewUtils.getStandardMargin(getContext()));\n-    }\n-\n-    public void setTimeLabel() {\n-        nullAnswer = false;\n-        timeTextView.setText(getAnswer().getDisplayText());\n-    }\n-\n-    private void createTimePickerDialog() {\n-        timePickerDialog = new CustomTimePickerDialog(getContext(), this, 0, 0);\n-        timePickerDialog.setCanceledOnTouchOutside(false);\n+        if (prompt.isReadOnly()) {\n+            binding.widgetButton.setVisibility(GONE);\n+        } else {\n+            binding.widgetButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            binding.widgetButton.setText(getContext().getString(R.string.select_time));\n+            binding.widgetButton.setOnClickListener(v -> DateTimeWidgetUtils.createTimePickerDialog(\n+                    (FormEntryActivity) getContext(), hourOfDay, minuteOfHour));\n+        }\n+        binding.widgetAnswerText.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n \n-        if (getFormEntryPrompt().getAnswerValue() == null) {\n-            clearAnswer();\n+        if (prompt.getAnswerValue() == null) {\n+            setTimeToCurrent();\n+            binding.widgetAnswerText.setText(R.string.no_time_selected);\n         } else {\n             Date date = (Date) getFormEntryPrompt().getAnswerValue().getValue();\n-\n             DateTime dateTime = new DateTime(date);\n-            updateTime(dateTime, true);\n-        }\n-    }\n-\n-    public int getHour() {\n-        return hourOfDay;\n-    }\n \n-    public int getMinute() {\n-        return minuteOfHour;\n-    }\n-\n-    public boolean isNullAnswer() {\n-        return nullAnswer;\n-    }\n+            hourOfDay = dateTime.getHourOfDay();\n+            minuteOfHour = dateTime.getMinuteOfHour();\n+            binding.widgetAnswerText.setText(DateTimeWidgetUtils.getTimeData(hourOfDay, minuteOfHour).getDisplayText());\n+        }\n \n-    public void setTimeToCurrent() {\n-        updateTime(DateTime.now(), false);\n+        return binding.getRoot();\n     }\n \n-    public void updateTime(DateTime dateTime) {\n-        updateTime(dateTime, true);\n+    @Override\n+    public void clearAnswer() {\n+        setTimeToCurrent();\n+        binding.widgetAnswerText.setText(R.string.no_time_selected);\n+        widgetValueChanged();\n     }\n \n-    public void updateTime(DateTime dateTime, boolean shouldUpdateLabel) {\n-        updateTime(dateTime.getHourOfDay(), dateTime.getMinuteOfHour(), shouldUpdateLabel);\n+    @Override\n+    public IAnswerData getAnswer() {\n+        return !binding.widgetAnswerText.getText().equals(getContext().getString(R.string.no_time_selected))\n+                ? DateTimeWidgetUtils.getTimeData(hourOfDay, minuteOfHour)\n+                : null;\n     }\n \n-    public void updateTime(int hourOfDay, int minuteOfHour, boolean shouldUpdateLabel) {\n-        this.hourOfDay = hourOfDay;\n-        this.minuteOfHour = minuteOfHour;\n-\n-        timePickerDialog.updateTime(hourOfDay, minuteOfHour);\n-\n-        if (shouldUpdateLabel) {\n-            setTimeLabel();\n-        }\n+    @Override\n+    public void setOnLongClickListener(OnLongClickListener l) {\n+        binding.widgetButton.setOnLongClickListener(l);\n+        binding.widgetAnswerText.setOnLongClickListener(l);\n     }\n \n     @Override\n-    public void onTimeSet(TimePicker timePicker, int hourOfDay, int minute) {\n-        timePicker.clearFocus();\n-\n-        this.hourOfDay = timePicker.getCurrentHour();\n-        this.minuteOfHour = timePicker.getCurrentMinute();\n-\n-        setTimeLabel();\n-        widgetValueChanged();\n+    public void cancelLongPress() {\n+        super.cancelLongPress();\n+        binding.widgetButton.cancelLongPress();\n+        binding.widgetAnswerText.cancelLongPress();\n     }\n \n     @Override\n-    public void onButtonClick(int buttonId) {\n-        if (nullAnswer) {\n-            setTimeToCurrent();\n-        } else {\n-            updateTime(hourOfDay, minuteOfHour, true);\n+    public void setBinaryData(Object answer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38ce2d8d772001cea191113a2a0505ba5b142ee0"}, "originalPosition": 229}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk0Mjc3Nw==", "bodyText": "Please create methods that return true/false based on labels and use instead of these fields.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459942777", "createdAt": "2020-07-24T09:17:46Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/DateTimeWidget.java", "diffHunk": "@@ -15,139 +15,175 @@\n package org.odk.collect.android.widgets;\n \n import android.annotation.SuppressLint;\n+import android.app.Activity;\n import android.content.Context;\n-import android.widget.LinearLayout;\n+import android.util.TypedValue;\n+import android.view.View;\n \n import org.javarosa.core.model.data.DateTimeData;\n import org.javarosa.core.model.data.IAnswerData;\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.joda.time.DateTime;\n import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.databinding.DateTimeWidgetAnswerBinding;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.listeners.WidgetValueChangedListener;\n import org.odk.collect.android.widgets.interfaces.BinaryDataReceiver;\n-import org.odk.collect.android.widgets.interfaces.ButtonClickListener;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DateTimeUtils;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n+\n+import java.util.Date;\n \n /**\n  * Displays a DatePicker widget. DateWidget handles leap years and does not allow dates that do not\n  * exist.\n- *\n- * @author Carl Hartung (carlhartung@gmail.com)\n- * @author Yaw Anokwa (yanokwa@gmail.com)\n  */\n-\n @SuppressLint(\"ViewConstructor\")\n-public class DateTimeWidget extends QuestionWidget implements BinaryDataReceiver, WidgetValueChangedListener, ButtonClickListener {\n+public class DateTimeWidget extends QuestionWidget implements BinaryDataReceiver {\n+    DateTimeWidgetAnswerBinding binding;\n+\n+    private LocalDateTime date;\n+    private DatePickerDetails datePickerDetails;\n+    private int hourOfDay;\n+    private int minuteOfHour;\n \n-    DateWidget dateWidget;\n-    TimeWidget timeWidget;\n+    private boolean isDateNull;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38ce2d8d772001cea191113a2a0505ba5b142ee0"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NzQ2MzMy", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-454746332", "createdAt": "2020-07-24T09:22:37Z", "commit": {"oid": "38ce2d8d772001cea191113a2a0505ba5b142ee0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwOToyMjozN1rOG2o0FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwOToyMjozN1rOG2o0FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk0NDk4MQ==", "bodyText": "Those fields are now hared between CustomDatePickerDialog and FixedDatePickerDialog so shouldn't placed in CustomDatePickerDialog. This class would be probably a better place.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459944981", "createdAt": "2020-07-24T09:22:37Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/DateTimeWidgetUtils.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import android.os.Build;\n+import android.os.Bundle;\n+\n+import org.javarosa.core.model.FormIndex;\n+import org.javarosa.core.model.data.TimeData;\n+import org.joda.time.DateTime;\n+import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.fragments.dialogs.BikramSambatDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CopticDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.EthiopianDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.IslamicDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.MyanmarDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.PersianDatePickerDialog;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DialogUtils;\n+import org.odk.collect.android.utilities.ThemeUtils;\n+\n+public class DateTimeWidgetUtils {\n+\n+    private DateTimeWidgetUtils() {\n+    }\n+\n+    public static TimeData getTimeData(int hourOfDay, int minuteOfHour) {\n+        // use picker time, convert to today's date, store as utc\n+        DateTime localDateTime = new DateTime()\n+                .withTime(hourOfDay, minuteOfHour, 0, 0);\n+\n+        return new TimeData(localDateTime.toDate());\n+    }\n+\n+    public static LocalDateTime getCurrentDate() {\n+        return LocalDateTime\n+                .now()\n+                .withHourOfDay(0)\n+                .withMinuteOfHour(0)\n+                .withSecondOfMinute(0)\n+                .withMillisOfSecond(0);\n+    }\n+\n+    public static void showDatePickerDialog(FormEntryActivity activity, FormIndex formIndex, DatePickerDetails datePickerDetails,\n+                                            LocalDateTime date) {\n+        ThemeUtils themeUtils = new ThemeUtils(activity);\n+\n+        Bundle bundle = new Bundle();\n+        bundle.putInt(CustomDatePickerDialog.DATE_PICKER_THEME, getTheme(themeUtils, datePickerDetails));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38ce2d8d772001cea191113a2a0505ba5b142ee0"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NzQ4MTIy", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-454748122", "createdAt": "2020-07-24T09:25:36Z", "commit": {"oid": "38ce2d8d772001cea191113a2a0505ba5b142ee0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwOToyNTozNlrOG2o5ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwOToyNTozNlrOG2o5ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk0NjM5OA==", "bodyText": "Could be one line, it's short enough.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459946398", "createdAt": "2020-07-24T09:25:36Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/DateTimeWidgetUtils.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import android.os.Build;\n+import android.os.Bundle;\n+\n+import org.javarosa.core.model.FormIndex;\n+import org.javarosa.core.model.data.TimeData;\n+import org.joda.time.DateTime;\n+import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.fragments.dialogs.BikramSambatDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CopticDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.EthiopianDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.IslamicDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.MyanmarDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.PersianDatePickerDialog;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DialogUtils;\n+import org.odk.collect.android.utilities.ThemeUtils;\n+\n+public class DateTimeWidgetUtils {\n+\n+    private DateTimeWidgetUtils() {\n+    }\n+\n+    public static TimeData getTimeData(int hourOfDay, int minuteOfHour) {\n+        // use picker time, convert to today's date, store as utc\n+        DateTime localDateTime = new DateTime()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38ce2d8d772001cea191113a2a0505ba5b142ee0"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NzQ5Njk3", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-454749697", "createdAt": "2020-07-24T09:28:18Z", "commit": {"oid": "38ce2d8d772001cea191113a2a0505ba5b142ee0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwOToyODoxOVrOG2o-TA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwOToyODoxOVrOG2o-TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk0NzU5Ng==", "bodyText": "Make sure this method name is consistent with showDatePickerDialog it should also start with show not create.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459947596", "createdAt": "2020-07-24T09:28:19Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/DateTimeWidgetUtils.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import android.os.Build;\n+import android.os.Bundle;\n+\n+import org.javarosa.core.model.FormIndex;\n+import org.javarosa.core.model.data.TimeData;\n+import org.joda.time.DateTime;\n+import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.fragments.dialogs.BikramSambatDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CopticDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.EthiopianDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.IslamicDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.MyanmarDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.PersianDatePickerDialog;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DialogUtils;\n+import org.odk.collect.android.utilities.ThemeUtils;\n+\n+public class DateTimeWidgetUtils {\n+\n+    private DateTimeWidgetUtils() {\n+    }\n+\n+    public static TimeData getTimeData(int hourOfDay, int minuteOfHour) {\n+        // use picker time, convert to today's date, store as utc\n+        DateTime localDateTime = new DateTime()\n+                .withTime(hourOfDay, minuteOfHour, 0, 0);\n+\n+        return new TimeData(localDateTime.toDate());\n+    }\n+\n+    public static LocalDateTime getCurrentDate() {\n+        return LocalDateTime\n+                .now()\n+                .withHourOfDay(0)\n+                .withMinuteOfHour(0)\n+                .withSecondOfMinute(0)\n+                .withMillisOfSecond(0);\n+    }\n+\n+    public static void showDatePickerDialog(FormEntryActivity activity, FormIndex formIndex, DatePickerDetails datePickerDetails,\n+                                            LocalDateTime date) {\n+        ThemeUtils themeUtils = new ThemeUtils(activity);\n+\n+        Bundle bundle = new Bundle();\n+        bundle.putInt(CustomDatePickerDialog.DATE_PICKER_THEME, getTheme(themeUtils, datePickerDetails));\n+        bundle.putSerializable(CustomDatePickerDialog.DATE, date);\n+        bundle.putSerializable(CustomDatePickerDialog.DATE_PICKER_DETAILS, datePickerDetails);\n+        bundle.putSerializable(CustomDatePickerDialog.FORM_INDEX, formIndex);\n+\n+        DialogUtils.showIfNotShowing(getClass(datePickerDetails.getDatePickerType()), bundle, activity.getSupportFragmentManager());\n+    }\n+\n+    private static Class getClass(DatePickerDetails.DatePickerType datePickerType) {\n+        switch (datePickerType) {\n+            case ETHIOPIAN:\n+                return EthiopianDatePickerDialog.class;\n+            case COPTIC:\n+                return CopticDatePickerDialog.class;\n+            case ISLAMIC:\n+                return IslamicDatePickerDialog.class;\n+            case BIKRAM_SAMBAT:\n+                return BikramSambatDatePickerDialog.class;\n+            case MYANMAR:\n+                return MyanmarDatePickerDialog.class;\n+            case PERSIAN:\n+                return PersianDatePickerDialog.class;\n+            default:\n+                return FixedDatePickerDialog.class;\n+        }\n+    }\n+\n+    public static void createTimePickerDialog(FormEntryActivity activity, int hourOfDay, int minuteOfHour) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38ce2d8d772001cea191113a2a0505ba5b142ee0"}, "originalPosition": 78}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NzUwOTM3", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-454750937", "createdAt": "2020-07-24T09:30:29Z", "commit": {"oid": "38ce2d8d772001cea191113a2a0505ba5b142ee0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwOTozMDoyOVrOG2pB7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwOTozMDoyOVrOG2pB7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk0ODUyNw==", "bodyText": "please rename it to getDatePickerTheme or something like that because now it's confusing and other contributors migt think it should be used for building TimePickers as well.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r459948527", "createdAt": "2020-07-24T09:30:29Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/DateTimeWidgetUtils.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import android.os.Build;\n+import android.os.Bundle;\n+\n+import org.javarosa.core.model.FormIndex;\n+import org.javarosa.core.model.data.TimeData;\n+import org.joda.time.DateTime;\n+import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.fragments.dialogs.BikramSambatDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CopticDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.EthiopianDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.IslamicDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.MyanmarDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.PersianDatePickerDialog;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DialogUtils;\n+import org.odk.collect.android.utilities.ThemeUtils;\n+\n+public class DateTimeWidgetUtils {\n+\n+    private DateTimeWidgetUtils() {\n+    }\n+\n+    public static TimeData getTimeData(int hourOfDay, int minuteOfHour) {\n+        // use picker time, convert to today's date, store as utc\n+        DateTime localDateTime = new DateTime()\n+                .withTime(hourOfDay, minuteOfHour, 0, 0);\n+\n+        return new TimeData(localDateTime.toDate());\n+    }\n+\n+    public static LocalDateTime getCurrentDate() {\n+        return LocalDateTime\n+                .now()\n+                .withHourOfDay(0)\n+                .withMinuteOfHour(0)\n+                .withSecondOfMinute(0)\n+                .withMillisOfSecond(0);\n+    }\n+\n+    public static void showDatePickerDialog(FormEntryActivity activity, FormIndex formIndex, DatePickerDetails datePickerDetails,\n+                                            LocalDateTime date) {\n+        ThemeUtils themeUtils = new ThemeUtils(activity);\n+\n+        Bundle bundle = new Bundle();\n+        bundle.putInt(CustomDatePickerDialog.DATE_PICKER_THEME, getTheme(themeUtils, datePickerDetails));\n+        bundle.putSerializable(CustomDatePickerDialog.DATE, date);\n+        bundle.putSerializable(CustomDatePickerDialog.DATE_PICKER_DETAILS, datePickerDetails);\n+        bundle.putSerializable(CustomDatePickerDialog.FORM_INDEX, formIndex);\n+\n+        DialogUtils.showIfNotShowing(getClass(datePickerDetails.getDatePickerType()), bundle, activity.getSupportFragmentManager());\n+    }\n+\n+    private static Class getClass(DatePickerDetails.DatePickerType datePickerType) {\n+        switch (datePickerType) {\n+            case ETHIOPIAN:\n+                return EthiopianDatePickerDialog.class;\n+            case COPTIC:\n+                return CopticDatePickerDialog.class;\n+            case ISLAMIC:\n+                return IslamicDatePickerDialog.class;\n+            case BIKRAM_SAMBAT:\n+                return BikramSambatDatePickerDialog.class;\n+            case MYANMAR:\n+                return MyanmarDatePickerDialog.class;\n+            case PERSIAN:\n+                return PersianDatePickerDialog.class;\n+            default:\n+                return FixedDatePickerDialog.class;\n+        }\n+    }\n+\n+    public static void createTimePickerDialog(FormEntryActivity activity, int hourOfDay, int minuteOfHour) {\n+        ThemeUtils themeUtils = new ThemeUtils(activity);\n+        Bundle bundle = new Bundle();\n+        bundle.putInt(CustomTimePickerDialog.TIME_PICKER_THEME, themeUtils.getHoloDialogTheme());\n+        bundle.putSerializable(CustomTimePickerDialog.CURRENT_TIME, new DateTime().withTime(hourOfDay, minuteOfHour, 0, 0));\n+\n+        DialogUtils.showIfNotShowing(CustomTimePickerDialog.class, bundle, activity.getSupportFragmentManager());\n+    }\n+\n+    private static int getTheme(ThemeUtils themeUtils, DatePickerDetails datePickerDetails) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38ce2d8d772001cea191113a2a0505ba5b142ee0"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0ODQ5NTI0", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-454849524", "createdAt": "2020-07-24T12:34:33Z", "commit": {"oid": "54c371ebd725b1682d770a801358b122a9b30384"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxMjozNDozM1rOG2tqEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxMzoyNjozOFrOG2vRhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAyNDMzOQ==", "bodyText": "No need to cast to Date.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r460024339", "createdAt": "2020-07-24T12:34:33Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/TimeWidget.java", "diffHunk": "@@ -15,295 +15,94 @@\n package org.odk.collect.android.widgets;\n \n import android.annotation.SuppressLint;\n-import android.app.TimePickerDialog;\n+import android.app.Activity;\n import android.content.Context;\n-import android.content.res.TypedArray;\n-import android.graphics.Color;\n-import android.graphics.drawable.ColorDrawable;\n-import android.os.Build;\n-import android.text.format.DateFormat;\n-import android.util.AttributeSet;\n-import android.view.Window;\n-import android.widget.Button;\n-import android.widget.LinearLayout;\n-import android.widget.TextView;\n-import android.widget.TimePicker;\n+import android.util.TypedValue;\n+import android.view.View;\n \n import org.javarosa.core.model.data.IAnswerData;\n-import org.javarosa.core.model.data.TimeData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.joda.time.DateTime;\n import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.databinding.WidgetAnswerBinding;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n-import org.odk.collect.android.widgets.interfaces.ButtonClickListener;\n+import org.odk.collect.android.widgets.interfaces.BinaryDataReceiver;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n \n-import java.lang.reflect.Constructor;\n-import java.lang.reflect.Field;\n import java.util.Date;\n \n-import timber.log.Timber;\n-\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createAnswerTextView;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-\n-/**\n- * Displays a TimePicker widget.\n- *\n- * @author Carl Hartung (carlhartung@gmail.com)\n- */\n @SuppressLint(\"ViewConstructor\")\n-public class TimeWidget extends QuestionWidget implements ButtonClickListener, TimePickerDialog.OnTimeSetListener {\n-    private TimePickerDialog timePickerDialog;\n-\n-    Button timeButton;\n-    final TextView timeTextView;\n-\n-    private int hourOfDay;\n-    private int minuteOfHour;\n+public class TimeWidget extends QuestionWidget implements BinaryDataReceiver {\n+    WidgetAnswerBinding binding;\n \n-    private boolean nullAnswer;\n+    private DateTime selectedTime;\n \n     public TimeWidget(Context context, final QuestionDetails prompt) {\n         this(context, prompt, false);\n     }\n \n     public TimeWidget(Context context, QuestionDetails prompt, boolean isPartOfDateTimeWidget) {\n         super(context, prompt, !isPartOfDateTimeWidget);\n-        createTimeButton();\n-        timeTextView = createAnswerTextView(getContext(), getAnswerFontSize());\n-        createTimePickerDialog();\n-        addViews();\n     }\n \n     @Override\n-    public void clearAnswer() {\n-        clearAnswerWithoutValueChangeEvent();\n-        widgetValueChanged();\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        binding = WidgetAnswerBinding.inflate(((Activity) context).getLayoutInflater());\n+\n+        if (prompt.isReadOnly()) {\n+            binding.widgetButton.setVisibility(GONE);\n+        } else {\n+            binding.widgetButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            binding.widgetButton.setText(getContext().getString(R.string.select_time));\n+            binding.widgetButton.setOnClickListener(v -> DateTimeWidgetUtils.showTimePickerDialog(\n+                    (FormEntryActivity) getContext(), selectedTime));\n+        }\n+        binding.widgetAnswerText.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+\n+        if (prompt.getAnswerValue() == null) {\n+            selectedTime = DateTime.now();\n+            binding.widgetAnswerText.setText(R.string.no_time_selected);\n+        } else {\n+            selectedTime = new DateTime((Date) getFormEntryPrompt().getAnswerValue().getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54c371ebd725b1682d770a801358b122a9b30384"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAyNDgyMg==", "bodyText": "To be consistent with DateWidget please use selectedDate name here.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r460024822", "createdAt": "2020-07-24T12:35:32Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/DateTimeWidget.java", "diffHunk": "@@ -15,139 +15,161 @@\n package org.odk.collect.android.widgets;\n \n import android.annotation.SuppressLint;\n+import android.app.Activity;\n import android.content.Context;\n-import android.widget.LinearLayout;\n+import android.util.TypedValue;\n+import android.view.View;\n \n import org.javarosa.core.model.data.DateTimeData;\n import org.javarosa.core.model.data.IAnswerData;\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.joda.time.DateTime;\n import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.databinding.DateTimeWidgetAnswerBinding;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.listeners.WidgetValueChangedListener;\n import org.odk.collect.android.widgets.interfaces.BinaryDataReceiver;\n-import org.odk.collect.android.widgets.interfaces.ButtonClickListener;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DateTimeUtils;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n+\n+import java.util.Date;\n \n /**\n  * Displays a DatePicker widget. DateWidget handles leap years and does not allow dates that do not\n  * exist.\n- *\n- * @author Carl Hartung (carlhartung@gmail.com)\n- * @author Yaw Anokwa (yanokwa@gmail.com)\n  */\n-\n @SuppressLint(\"ViewConstructor\")\n-public class DateTimeWidget extends QuestionWidget implements BinaryDataReceiver, WidgetValueChangedListener, ButtonClickListener {\n+public class DateTimeWidget extends QuestionWidget implements BinaryDataReceiver {\n+    DateTimeWidgetAnswerBinding binding;\n \n-    DateWidget dateWidget;\n-    TimeWidget timeWidget;\n+    private LocalDateTime date;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54c371ebd725b1682d770a801358b122a9b30384"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAyNTAwNA==", "bodyText": "To be consistent with TimeWidget please use selectedTime name here.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r460025004", "createdAt": "2020-07-24T12:35:57Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/DateTimeWidget.java", "diffHunk": "@@ -15,139 +15,161 @@\n package org.odk.collect.android.widgets;\n \n import android.annotation.SuppressLint;\n+import android.app.Activity;\n import android.content.Context;\n-import android.widget.LinearLayout;\n+import android.util.TypedValue;\n+import android.view.View;\n \n import org.javarosa.core.model.data.DateTimeData;\n import org.javarosa.core.model.data.IAnswerData;\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.joda.time.DateTime;\n import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.databinding.DateTimeWidgetAnswerBinding;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.listeners.WidgetValueChangedListener;\n import org.odk.collect.android.widgets.interfaces.BinaryDataReceiver;\n-import org.odk.collect.android.widgets.interfaces.ButtonClickListener;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DateTimeUtils;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n+\n+import java.util.Date;\n \n /**\n  * Displays a DatePicker widget. DateWidget handles leap years and does not allow dates that do not\n  * exist.\n- *\n- * @author Carl Hartung (carlhartung@gmail.com)\n- * @author Yaw Anokwa (yanokwa@gmail.com)\n  */\n-\n @SuppressLint(\"ViewConstructor\")\n-public class DateTimeWidget extends QuestionWidget implements BinaryDataReceiver, WidgetValueChangedListener, ButtonClickListener {\n+public class DateTimeWidget extends QuestionWidget implements BinaryDataReceiver {\n+    DateTimeWidgetAnswerBinding binding;\n \n-    DateWidget dateWidget;\n-    TimeWidget timeWidget;\n+    private LocalDateTime date;\n+    private DatePickerDetails datePickerDetails;\n+    private DateTime time;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54c371ebd725b1682d770a801358b122a9b30384"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAyOTQyNQ==", "bodyText": "This combination is a bit confusing clearAnswerWithoutValueChangeListener() + widgetValueChanged() if you want to keep that first method I think it would be better to rename it to something like resetAnswerFields() or clearAnswerFields().", "url": "https://github.com/getodk/collect/pull/3975#discussion_r460029425", "createdAt": "2020-07-24T12:45:05Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/DateTimeWidget.java", "diffHunk": "@@ -15,139 +15,161 @@\n package org.odk.collect.android.widgets;\n \n import android.annotation.SuppressLint;\n+import android.app.Activity;\n import android.content.Context;\n-import android.widget.LinearLayout;\n+import android.util.TypedValue;\n+import android.view.View;\n \n import org.javarosa.core.model.data.DateTimeData;\n import org.javarosa.core.model.data.IAnswerData;\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.joda.time.DateTime;\n import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.databinding.DateTimeWidgetAnswerBinding;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.listeners.WidgetValueChangedListener;\n import org.odk.collect.android.widgets.interfaces.BinaryDataReceiver;\n-import org.odk.collect.android.widgets.interfaces.ButtonClickListener;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DateTimeUtils;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n+\n+import java.util.Date;\n \n /**\n  * Displays a DatePicker widget. DateWidget handles leap years and does not allow dates that do not\n  * exist.\n- *\n- * @author Carl Hartung (carlhartung@gmail.com)\n- * @author Yaw Anokwa (yanokwa@gmail.com)\n  */\n-\n @SuppressLint(\"ViewConstructor\")\n-public class DateTimeWidget extends QuestionWidget implements BinaryDataReceiver, WidgetValueChangedListener, ButtonClickListener {\n+public class DateTimeWidget extends QuestionWidget implements BinaryDataReceiver {\n+    DateTimeWidgetAnswerBinding binding;\n \n-    DateWidget dateWidget;\n-    TimeWidget timeWidget;\n+    private LocalDateTime date;\n+    private DatePickerDetails datePickerDetails;\n+    private DateTime time;\n \n     public DateTimeWidget(Context context, QuestionDetails prompt) {\n         super(context, prompt);\n+    }\n+\n+    @Override\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        binding = DateTimeWidgetAnswerBinding.inflate(((Activity) context).getLayoutInflater());\n+        datePickerDetails = DateTimeUtils.getDatePickerDetails(prompt.getQuestion().getAppearanceAttr());\n \n-        dateWidget = new DateWidget(context, prompt, true);\n-        timeWidget = new TimeWidget(context, prompt, true);\n+        if (prompt.isReadOnly()) {\n+            binding.dateWidget.widgetButton.setVisibility(GONE);\n+            binding.timeWidget.widgetButton.setVisibility(GONE);\n+        } else {\n+            binding.dateWidget.widgetButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            binding.timeWidget.widgetButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+\n+            binding.dateWidget.widgetButton.setText(getContext().getString(R.string.select_date));\n+            binding.timeWidget.widgetButton.setText(getContext().getString(R.string.select_time));\n \n-        dateWidget.getAudioVideoImageTextLabel().getLabelTextView().setVisibility(GONE);\n-        dateWidget.getHelpTextLayout().setVisibility(GONE);\n+            binding.dateWidget.widgetButton.setOnClickListener(v -> DateTimeWidgetUtils.showDatePickerDialog(\n+                    (FormEntryActivity) context, prompt.getIndex(), datePickerDetails, date));\n+            binding.timeWidget.widgetButton.setOnClickListener(v ->\n+                    DateTimeWidgetUtils.showTimePickerDialog((FormEntryActivity) getContext(), time));\n+        }\n+        binding.dateWidget.widgetAnswerText.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+        binding.timeWidget.widgetAnswerText.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n \n-        timeWidget.getAudioVideoImageTextLabel().getLabelTextView().setVisibility(GONE);\n-        timeWidget.getHelpTextLayout().setVisibility(GONE);\n+        if (getFormEntryPrompt().getAnswerValue() == null) {\n+            clearAnswerWithoutValueChangeListener();\n+        } else {\n+            date = new LocalDateTime(getFormEntryPrompt().getAnswerValue().getValue());\n+            binding.dateWidget.widgetAnswerText.setText(DateTimeUtils.getDateTimeLabel(\n+                    date.toDate(), datePickerDetails, false, context));\n \n-        LinearLayout linearLayout = new LinearLayout(getContext());\n-        linearLayout.setOrientation(LinearLayout.VERTICAL);\n-        linearLayout.addView(dateWidget);\n-        if (!dateWidget.isDayHidden()) {\n-            linearLayout.addView(timeWidget);\n+            time = new DateTime((Date) getFormEntryPrompt().getAnswerValue().getValue());\n+            binding.timeWidget.widgetAnswerText.setText(DateTimeWidgetUtils.getTimeData(time).getDisplayText());\n         }\n-        addAnswerView(linearLayout);\n \n-        timeWidget.setValueChangedListener(this);\n-        dateWidget.setValueChangedListener(this);\n+        return binding.getRoot();\n     }\n \n     @Override\n     public IAnswerData getAnswer() {\n-        if (isNullAnswer()) {\n+        if (isNullValue()) {\n             return null;\n         } else {\n-            if (timeWidget.isNullAnswer()) {\n-                timeWidget.setTimeToCurrent();\n-                timeWidget.setTimeLabel();\n-            } else if (dateWidget.isNullAnswer()) {\n-                dateWidget.setDateToCurrent();\n-                dateWidget.setDateLabel();\n+            LocalDateTime ldt;\n+            if (isTimeNull()) {\n+                ldt = DateTimeUtils.getLocalDateTime(date.getYear(),\n+                        date.getMonthOfYear(), date.getDayOfMonth(), 0, 0);\n+                time = DateTime.now();\n+            } else if (isDateNull()) {\n+                ldt = new LocalDateTime()\n+                        .withHourOfDay(time.getHourOfDay())\n+                        .withMinuteOfHour(time.getMinuteOfHour());\n+\n+                date = DateTimeWidgetUtils.getCurrentDate();\n+            } else {\n+                ldt = DateTimeUtils.getLocalDateTime(date.getYear(), date.getMonthOfYear(),\n+                        date.getDayOfMonth(), time.getHourOfDay(), time.getMinuteOfHour());\n             }\n-\n-            int year = dateWidget.getDate().getYear();\n-            int month = dateWidget.getDate().getMonthOfYear();\n-            int day = dateWidget.getDate().getDayOfMonth();\n-            int hour = timeWidget.getHour();\n-            int minute = timeWidget.getMinute();\n-\n-            LocalDateTime ldt = new LocalDateTime()\n-                    .withYear(year)\n-                    .withMonthOfYear(month)\n-                    .withDayOfMonth(day)\n-                    .withHourOfDay(hour)\n-                    .withMinuteOfHour(minute)\n-                    .withSecondOfMinute(0)\n-                    .withMillisOfSecond(0);\n-\n             return new DateTimeData(ldt.toDate());\n         }\n     }\n \n     @Override\n     public void clearAnswer() {\n-        dateWidget.clearAnswerWithoutValueChangeEvent();\n-        timeWidget.clearAnswerWithoutValueChangeEvent();\n-\n+        clearAnswerWithoutValueChangeListener();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54c371ebd725b1682d770a801358b122a9b30384"}, "originalPosition": 154}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAzMDY0MQ==", "bodyText": "Please make sure that the same format is used like above (datePickerTheme not DATE_PICKER_THEME) btw it would be good to have a lint/checkstyle for that.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r460030641", "createdAt": "2020-07-24T12:47:30Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/DateTimeWidgetUtils.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import android.os.Build;\n+import android.os.Bundle;\n+\n+import org.javarosa.core.model.FormIndex;\n+import org.javarosa.core.model.data.TimeData;\n+import org.joda.time.DateTime;\n+import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.fragments.dialogs.BikramSambatDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CopticDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.EthiopianDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.IslamicDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.MyanmarDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.PersianDatePickerDialog;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DialogUtils;\n+import org.odk.collect.android.utilities.ThemeUtils;\n+\n+public class DateTimeWidgetUtils {\n+    public static final String FORM_INDEX = \"formIndex\";\n+    public static final String DATE = \"date\";\n+    public static final String DATE_PICKER_DETAILS = \"datePickerDetails\";\n+    public static final String DATE_PICKER_THEME = \"DATE_PICKER_THEME\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54c371ebd725b1682d770a801358b122a9b30384"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA1MDgyMA==", "bodyText": "This two methods still don't work like expected please take a look at onDateChanged/onRankingChanged\nand also you probably don't need this method at all because there is existing onDateChanged can you use it?", "url": "https://github.com/getodk/collect/pull/3975#discussion_r460050820", "createdAt": "2020-07-24T13:26:38Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -700,6 +708,44 @@ private void nonblockingCreateSavePointData() {\n         }\n     }\n \n+    @Override\n+    public void onDateSet(DatePicker view, int year, int month, int dayOfMonth) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54c371ebd725b1682d770a801358b122a9b30384"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MjQ5NjIz", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-457249623", "createdAt": "2020-07-29T07:09:25Z", "commit": {"oid": "6671975c17deaa22def655bb5ba5e4c42de9a3fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzowOToyNVrOG4rbVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzowOToyNVrOG4rbVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA4NDk1MQ==", "bodyText": "Instead of setting android:layout_marginHorizontal=\"@dimen/margin_standard\" here and below it would be better to set hroizontalPadding just once in the parent LinearLayout.\nI also think that the parent LinearLayout should have some verticalPadding margin_small or margin_extra_small because otherwise those widgets might be too close to each other if you use field-list.\nHave you tested such a scenario? If so please attach a screenshot.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r462084951", "createdAt": "2020-07-29T07:09:25Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/res/layout/widget_answer.xml", "diffHunk": "@@ -5,25 +5,21 @@\n     android:layout_height=\"wrap_content\">\n \n     <org.odk.collect.android.views.MultiClickSafeButton\n-        android:id=\"@+id/url_button\"\n+        android:id=\"@+id/widget_button\"\n         style=\"@style/Widget.Collect.Button.Custom\"\n         android:layout_width=\"match_parent\"\n         android:layout_height=\"wrap_content\"\n-        android:padding=\"@dimen/margin_small\"\n-        android:text=\"@string/open_url\"\n-        android:layout_marginStart=\"@dimen/margin_standard\"\n-        android:layout_marginEnd=\"@dimen/margin_standard\"\n-        android:layout_marginTop=\"@dimen/margin_extra_small\">\n+        android:layout_marginHorizontal=\"@dimen/margin_standard\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6671975c17deaa22def655bb5ba5e4c42de9a3fd"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MzIxODg3", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-458321887", "createdAt": "2020-07-30T11:42:17Z", "commit": {"oid": "ed632d502fdf66ea73e169e7c715d49b67d871f1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMTo0MjoxOFrOG5fexw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMTo0OTo1M1rOG5fr-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkzNzc5OQ==", "bodyText": "This method name also should be changed like you did with setData() in this case it might be setWidgetData() without binary word because as i said before it is no longer used only by binary widgets.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r462937799", "createdAt": "2020-07-30T11:42:18Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2643,11 +2646,20 @@ public void onNumberPickerValueSelected(int widgetId, int value) {\n     }\n \n     @Override\n-    public void onDateChanged(LocalDateTime date) {\n-        ODKView odkView = getCurrentViewIfODKView();\n-        if (odkView != null) {\n+    public void onDateSet(DatePicker view, int year, int month, int dayOfMonth) {\n+        if (getCurrentViewIfODKView() != null) {\n             QuestionWidget widgetGettingNewValue = getWidgetWaitingForBinaryData();\n-            setBinaryWidgetData(date);\n+            setBinaryWidgetData(DateTimeUtils.getLocalDateTime(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed632d502fdf66ea73e169e7c715d49b67d871f1"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk0MTE3OQ==", "bodyText": "Great this looks good now.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r462941179", "createdAt": "2020-07-30T11:49:53Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -700,6 +708,44 @@ private void nonblockingCreateSavePointData() {\n         }\n     }\n \n+    @Override\n+    public void onDateSet(DatePicker view, int year, int month, int dayOfMonth) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA1MDgyMA=="}, "originalCommit": {"oid": "54c371ebd725b1682d770a801358b122a9b30384"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MzMyNjQ4", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-458332648", "createdAt": "2020-07-30T12:00:38Z", "commit": {"oid": "ed632d502fdf66ea73e169e7c715d49b67d871f1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjowMDozOFrOG5f_cA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjowMDozOFrOG5f_cA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk0NjE2MA==", "bodyText": "What is the reason to have DateTimeWidgetUtils and DateTimeUtils as separate classes? Shouldn't it be just one class?", "url": "https://github.com/getodk/collect/pull/3975#discussion_r462946160", "createdAt": "2020-07-30T12:00:38Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/DateTimeWidgetUtils.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import android.os.Build;\n+import android.os.Bundle;\n+\n+import org.javarosa.core.model.FormIndex;\n+import org.javarosa.core.model.data.TimeData;\n+import org.joda.time.DateTime;\n+import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.application.Collect;\n+import org.odk.collect.android.fragments.dialogs.BikramSambatDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CopticDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.EthiopianDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.IslamicDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.MyanmarDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.PersianDatePickerDialog;\n+import org.odk.collect.android.javarosawrapper.FormController;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DialogUtils;\n+import org.odk.collect.android.utilities.ThemeUtils;\n+\n+public class DateTimeWidgetUtils {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed632d502fdf66ea73e169e7c715d49b67d871f1"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MzM5NTc0", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-458339574", "createdAt": "2020-07-30T12:11:08Z", "commit": {"oid": "ed632d502fdf66ea73e169e7c715d49b67d871f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjoxMTowOFrOG5gSrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjoxMTowOFrOG5gSrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk1MTA4NQ==", "bodyText": "You still didn't implement view model as I said before (too keep data) so your picker will reset values for example if your rotate your device. This is something we should test automatically.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r462951085", "createdAt": "2020-07-30T12:11:08Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/fragments/dialogs/CustomDatePickerDialog.java", "diffHunk": "@@ -16,97 +16,55 @@\n \n package org.odk.collect.android.fragments.dialogs;\n \n+import android.app.DatePickerDialog;\n import android.app.Dialog;\n import android.content.Context;\n-import android.content.DialogInterface;\n import android.os.Bundle;\n import androidx.fragment.app.DialogFragment;\n import androidx.appcompat.app.AlertDialog;\n import android.view.View;\n+import android.widget.DatePicker;\n import android.widget.NumberPicker;\n import android.widget.TextView;\n \n-import org.javarosa.core.model.FormIndex;\n import org.joda.time.LocalDateTime;\n import org.joda.time.chrono.GregorianChronology;\n import org.odk.collect.android.R;\n-import org.odk.collect.android.application.Collect;\n import org.odk.collect.android.logic.DatePickerDetails;\n-import org.odk.collect.android.javarosawrapper.FormController;\n import org.odk.collect.android.utilities.DateTimeUtils;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n \n /**\n  * @author Grzegorz Orczykowski (gorczykowski@soldevelo.com)\n  */\n public abstract class CustomDatePickerDialog extends DialogFragment {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed632d502fdf66ea73e169e7c715d49b67d871f1"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MzQ3ODkx", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-458347891", "createdAt": "2020-07-30T12:23:22Z", "commit": {"oid": "ed632d502fdf66ea73e169e7c715d49b67d871f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjoyMzoyMlrOG5grUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjoyMzoyMlrOG5grUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk1NzM5Mw==", "bodyText": "Removing this you have broken #3948 so it's a regression. In order to fix this you need to do the same now in FormEnryActivity where onTimeSet is used. Unfortunately we don't have any test for it. Could you write one? Or at leas please file an issue to do that in the future.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r462957393", "createdAt": "2020-07-30T12:23:22Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/TimeWidget.java", "diffHunk": "@@ -15,295 +15,94 @@\n package org.odk.collect.android.widgets;\n \n import android.annotation.SuppressLint;\n-import android.app.TimePickerDialog;\n+import android.app.Activity;\n import android.content.Context;\n-import android.content.res.TypedArray;\n-import android.graphics.Color;\n-import android.graphics.drawable.ColorDrawable;\n-import android.os.Build;\n-import android.text.format.DateFormat;\n-import android.util.AttributeSet;\n-import android.view.Window;\n-import android.widget.Button;\n-import android.widget.LinearLayout;\n-import android.widget.TextView;\n-import android.widget.TimePicker;\n+import android.util.TypedValue;\n+import android.view.View;\n \n import org.javarosa.core.model.data.IAnswerData;\n-import org.javarosa.core.model.data.TimeData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.joda.time.DateTime;\n import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.databinding.WidgetAnswerBinding;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n-import org.odk.collect.android.widgets.interfaces.ButtonClickListener;\n+import org.odk.collect.android.widgets.interfaces.BinaryDataReceiver;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n \n-import java.lang.reflect.Constructor;\n-import java.lang.reflect.Field;\n-import java.util.Date;\n-\n-import timber.log.Timber;\n-\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createAnswerTextView;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-\n-/**\n- * Displays a TimePicker widget.\n- *\n- * @author Carl Hartung (carlhartung@gmail.com)\n- */\n @SuppressLint(\"ViewConstructor\")\n-public class TimeWidget extends QuestionWidget implements ButtonClickListener, TimePickerDialog.OnTimeSetListener {\n-    private TimePickerDialog timePickerDialog;\n-\n-    Button timeButton;\n-    final TextView timeTextView;\n+public class TimeWidget extends QuestionWidget implements BinaryDataReceiver {\n+    WidgetAnswerBinding binding;\n \n-    private int hourOfDay;\n-    private int minuteOfHour;\n-\n-    private boolean nullAnswer;\n+    private DateTime selectedTime;\n \n     public TimeWidget(Context context, final QuestionDetails prompt) {\n         this(context, prompt, false);\n     }\n \n     public TimeWidget(Context context, QuestionDetails prompt, boolean isPartOfDateTimeWidget) {\n         super(context, prompt, !isPartOfDateTimeWidget);\n-        createTimeButton();\n-        timeTextView = createAnswerTextView(getContext(), getAnswerFontSize());\n-        createTimePickerDialog();\n-        addViews();\n     }\n \n     @Override\n-    public void clearAnswer() {\n-        clearAnswerWithoutValueChangeEvent();\n-        widgetValueChanged();\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        binding = WidgetAnswerBinding.inflate(((Activity) context).getLayoutInflater());\n+\n+        if (prompt.isReadOnly()) {\n+            binding.widgetButton.setVisibility(GONE);\n+        } else {\n+            binding.widgetButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            binding.widgetButton.setText(getContext().getString(R.string.select_time));\n+            binding.widgetButton.setOnClickListener(v -> {\n+                DateTimeWidgetUtils.setWidgetWaitingForData(prompt.getIndex());\n+                DateTimeWidgetUtils.showTimePickerDialog((FormEntryActivity) getContext(), selectedTime);\n+            });\n+        }\n+        binding.widgetAnswerText.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+\n+        if (prompt.getAnswerValue() == null) {\n+            selectedTime = DateTime.now();\n+            binding.widgetAnswerText.setText(R.string.no_time_selected);\n+        } else {\n+            selectedTime = new DateTime(getFormEntryPrompt().getAnswerValue().getValue());\n+            binding.widgetAnswerText.setText(DateTimeWidgetUtils.getTimeData(selectedTime).getDisplayText());\n+        }\n+\n+        return binding.getRoot();\n     }\n \n-    void clearAnswerWithoutValueChangeEvent() {\n-        nullAnswer = true;\n-        timeTextView.setText(R.string.no_time_selected);\n+    @Override\n+    public void clearAnswer() {\n+        selectedTime = DateTime.now();\n+        binding.widgetAnswerText.setText(R.string.no_time_selected);\n+        widgetValueChanged();\n     }\n \n     @Override\n     public IAnswerData getAnswer() {\n-        // use picker time, convert to today's date, store as utc\n-        DateTime localDateTime = new DateTime()\n-                .withTime(hourOfDay, minuteOfHour, 0, 0);\n-\n-        return !nullAnswer\n-                ? new TimeData(localDateTime.toDate())\n-                : null;\n+        return binding.widgetAnswerText.getText().equals(getContext().getString(R.string.no_time_selected))\n+                ? null\n+                : DateTimeWidgetUtils.getTimeData(selectedTime);\n     }\n \n     @Override\n     public void setOnLongClickListener(OnLongClickListener l) {\n-        timeButton.setOnLongClickListener(l);\n-        timeTextView.setOnLongClickListener(l);\n+        binding.widgetButton.setOnLongClickListener(l);\n+        binding.widgetAnswerText.setOnLongClickListener(l);\n     }\n \n     @Override\n     public void cancelLongPress() {\n         super.cancelLongPress();\n-        timeButton.cancelLongPress();\n-        timeTextView.cancelLongPress();\n-    }\n-\n-    private void createTimeButton() {\n-        timeButton = createSimpleButton(getContext(), getFormEntryPrompt().isReadOnly(), getContext().getString(R.string.select_time), getAnswerFontSize(), this);\n-    }\n-\n-    private void addViews() {\n-        LinearLayout linearLayout = new LinearLayout(getContext());\n-        linearLayout.setOrientation(LinearLayout.VERTICAL);\n-        linearLayout.addView(timeButton);\n-        linearLayout.addView(timeTextView);\n-        addAnswerView(linearLayout, WidgetViewUtils.getStandardMargin(getContext()));\n-    }\n-\n-    public void setTimeLabel() {\n-        nullAnswer = false;\n-        timeTextView.setText(getAnswer().getDisplayText());\n-    }\n-\n-    private void createTimePickerDialog() {\n-        timePickerDialog = new CustomTimePickerDialog(getContext(), this, 0, 0);\n-        timePickerDialog.setCanceledOnTouchOutside(false);\n-\n-        if (getFormEntryPrompt().getAnswerValue() == null) {\n-            clearAnswer();\n-        } else {\n-            Date date = (Date) getFormEntryPrompt().getAnswerValue().getValue();\n-\n-            DateTime dateTime = new DateTime(date);\n-            updateTime(dateTime, true);\n-        }\n-    }\n-\n-    public int getHour() {\n-        return hourOfDay;\n-    }\n-\n-    public int getMinute() {\n-        return minuteOfHour;\n-    }\n-\n-    public boolean isNullAnswer() {\n-        return nullAnswer;\n-    }\n-\n-    public void setTimeToCurrent() {\n-        updateTime(DateTime.now(), false);\n-    }\n-\n-    public void updateTime(DateTime dateTime) {\n-        updateTime(dateTime, true);\n-    }\n-\n-    public void updateTime(DateTime dateTime, boolean shouldUpdateLabel) {\n-        updateTime(dateTime.getHourOfDay(), dateTime.getMinuteOfHour(), shouldUpdateLabel);\n-    }\n-\n-    public void updateTime(int hourOfDay, int minuteOfHour, boolean shouldUpdateLabel) {\n-        this.hourOfDay = hourOfDay;\n-        this.minuteOfHour = minuteOfHour;\n-\n-        timePickerDialog.updateTime(hourOfDay, minuteOfHour);\n-\n-        if (shouldUpdateLabel) {\n-            setTimeLabel();\n-        }\n+        binding.widgetButton.cancelLongPress();\n+        binding.widgetAnswerText.cancelLongPress();\n     }\n \n     @Override\n-    public void onTimeSet(TimePicker timePicker, int hourOfDay, int minute) {\n-        timePicker.clearFocus();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed632d502fdf66ea73e169e7c715d49b67d871f1"}, "originalPosition": 214}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MzU2NTg5", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-458356589", "createdAt": "2020-07-30T12:35:26Z", "commit": {"oid": "ed632d502fdf66ea73e169e7c715d49b67d871f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjozNToyNlrOG5hEXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjozNToyNlrOG5hEXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2MzgwNg==", "bodyText": "This isPartOfDateTimeWidget doesn't make sense anymore it is called only from the same class with false value (look above). It was implemented to fix #3761 but now as you have a separate DateTimeWidget which doesn't contain two widgets inside as before it is probably no longer an issue. So you can remove the code implemented in #3770", "url": "https://github.com/getodk/collect/pull/3975#discussion_r462963806", "createdAt": "2020-07-30T12:35:26Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/TimeWidget.java", "diffHunk": "@@ -15,295 +15,94 @@\n package org.odk.collect.android.widgets;\n \n import android.annotation.SuppressLint;\n-import android.app.TimePickerDialog;\n+import android.app.Activity;\n import android.content.Context;\n-import android.content.res.TypedArray;\n-import android.graphics.Color;\n-import android.graphics.drawable.ColorDrawable;\n-import android.os.Build;\n-import android.text.format.DateFormat;\n-import android.util.AttributeSet;\n-import android.view.Window;\n-import android.widget.Button;\n-import android.widget.LinearLayout;\n-import android.widget.TextView;\n-import android.widget.TimePicker;\n+import android.util.TypedValue;\n+import android.view.View;\n \n import org.javarosa.core.model.data.IAnswerData;\n-import org.javarosa.core.model.data.TimeData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.joda.time.DateTime;\n import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.databinding.WidgetAnswerBinding;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n-import org.odk.collect.android.widgets.interfaces.ButtonClickListener;\n+import org.odk.collect.android.widgets.interfaces.BinaryDataReceiver;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n \n-import java.lang.reflect.Constructor;\n-import java.lang.reflect.Field;\n-import java.util.Date;\n-\n-import timber.log.Timber;\n-\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createAnswerTextView;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-\n-/**\n- * Displays a TimePicker widget.\n- *\n- * @author Carl Hartung (carlhartung@gmail.com)\n- */\n @SuppressLint(\"ViewConstructor\")\n-public class TimeWidget extends QuestionWidget implements ButtonClickListener, TimePickerDialog.OnTimeSetListener {\n-    private TimePickerDialog timePickerDialog;\n-\n-    Button timeButton;\n-    final TextView timeTextView;\n+public class TimeWidget extends QuestionWidget implements BinaryDataReceiver {\n+    WidgetAnswerBinding binding;\n \n-    private int hourOfDay;\n-    private int minuteOfHour;\n-\n-    private boolean nullAnswer;\n+    private DateTime selectedTime;\n \n     public TimeWidget(Context context, final QuestionDetails prompt) {\n         this(context, prompt, false);\n     }\n \n     public TimeWidget(Context context, QuestionDetails prompt, boolean isPartOfDateTimeWidget) {\n         super(context, prompt, !isPartOfDateTimeWidget);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed632d502fdf66ea73e169e7c715d49b67d871f1"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4Mzk1Nzc4", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-458395778", "createdAt": "2020-07-30T13:24:06Z", "commit": {"oid": "ed632d502fdf66ea73e169e7c715d49b67d871f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMzoyNDowN1rOG5i1ZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMzoyNDowN1rOG5i1ZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk5Mjc0MA==", "bodyText": "Can't we use LocalDateTime here only instead of LocalDateTime and DateTime. DateTime seems redundant since you can save both date and time in LocalDateTime.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r462992740", "createdAt": "2020-07-30T13:24:07Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/DateTimeWidget.java", "diffHunk": "@@ -15,139 +15,163 @@\n package org.odk.collect.android.widgets;\n \n import android.annotation.SuppressLint;\n+import android.app.Activity;\n import android.content.Context;\n-import android.widget.LinearLayout;\n+import android.util.TypedValue;\n+import android.view.View;\n \n import org.javarosa.core.model.data.DateTimeData;\n import org.javarosa.core.model.data.IAnswerData;\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.joda.time.DateTime;\n import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.FormEntryActivity;\n+import org.odk.collect.android.databinding.DateTimeWidgetAnswerBinding;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.listeners.WidgetValueChangedListener;\n import org.odk.collect.android.widgets.interfaces.BinaryDataReceiver;\n-import org.odk.collect.android.widgets.interfaces.ButtonClickListener;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DateTimeUtils;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n \n /**\n  * Displays a DatePicker widget. DateWidget handles leap years and does not allow dates that do not\n  * exist.\n- *\n- * @author Carl Hartung (carlhartung@gmail.com)\n- * @author Yaw Anokwa (yanokwa@gmail.com)\n  */\n-\n @SuppressLint(\"ViewConstructor\")\n-public class DateTimeWidget extends QuestionWidget implements BinaryDataReceiver, WidgetValueChangedListener, ButtonClickListener {\n+public class DateTimeWidget extends QuestionWidget implements BinaryDataReceiver {\n+    DateTimeWidgetAnswerBinding binding;\n \n-    DateWidget dateWidget;\n-    TimeWidget timeWidget;\n+    private LocalDateTime selectedDate;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed632d502fdf66ea73e169e7c715d49b67d871f1"}, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da5afb57a26ceb463324476de4fe6513149a3ff4", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/da5afb57a26ceb463324476de4fe6513149a3ff4", "committedDate": "2020-07-31T21:18:51Z", "message": "update unit tests for Date and Time Widgets"}, "afterCommit": {"oid": "7e478c43fc6d49fee438484d7df61049655c53fd", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/7e478c43fc6d49fee438484d7df61049655c53fd", "committedDate": "2020-08-01T07:13:34Z", "message": "code refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwODU1MzE1", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-460855315", "createdAt": "2020-08-04T14:15:58Z", "commit": {"oid": "becb09c786c3e88232970753924155beb819637d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNTI3MzQ1", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-461527345", "createdAt": "2020-08-05T10:16:04Z", "commit": {"oid": "075c2c1c8b7a495dd9594d980af168f1b2720d45"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDoxNjowNFrOG8DTpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDoxNjowNFrOG8DTpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYyMTkyNg==", "bodyText": "Do we need this? I know it was needed in TimePickerDialog but here?", "url": "https://github.com/getodk/collect/pull/3975#discussion_r465621926", "createdAt": "2020-08-05T10:16:04Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/viewmodels/DateTimeViewModel.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package org.odk.collect.android.widgets.viewmodels;\n+\n+import android.app.DatePickerDialog;\n+import android.app.TimePickerDialog;\n+\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+import androidx.lifecycle.ViewModel;\n+\n+import org.joda.time.DateTime;\n+import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.utilities.DateTimeUtils;\n+\n+public class DateTimeViewModel extends ViewModel {\n+    private final MutableLiveData<LocalDateTime> selectedDate = new MutableLiveData<>();\n+    private final MutableLiveData<DateTime> selectedTime = new MutableLiveData<>();\n+\n+    private final DatePickerDialog.OnDateSetListener dateSetListener = (view, year, monthOfYear, dayOfMonth) -> {\n+        view.clearFocus();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "075c2c1c8b7a495dd9594d980af168f1b2720d45"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNTM4ODgz", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-461538883", "createdAt": "2020-08-05T10:33:57Z", "commit": {"oid": "075c2c1c8b7a495dd9594d980af168f1b2720d45"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDozMzo1N1rOG8D3TA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDozMzo1N1rOG8D3TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzMTA1Mg==", "bodyText": "This class seems redundant you can use DateTimeWidgetUtils everywhere you need. Or maybe I missed something important?", "url": "https://github.com/getodk/collect/pull/3975#discussion_r465631052", "createdAt": "2020-08-05T10:33:57Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/interfaces/DateTimeWidgetListener.java", "diffHunk": "@@ -0,0 +1,15 @@\n+package org.odk.collect.android.widgets.interfaces;\n+\n+import android.content.Context;\n+\n+import org.javarosa.core.model.FormIndex;\n+import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+\n+public interface DateTimeWidgetListener {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "075c2c1c8b7a495dd9594d980af168f1b2720d45"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "281d537d4c98ad2ff5effafe73cb072c8dde229f", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/281d537d4c98ad2ff5effafe73cb072c8dde229f", "committedDate": "2020-08-05T20:00:16Z", "message": "refactor dateTimeUtils and DateTimeWidgetUtils"}, "afterCommit": {"oid": "670af9c4815abeedb1b8e8db143c1198270d0938", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/670af9c4815abeedb1b8e8db143c1198270d0938", "committedDate": "2020-08-05T20:15:40Z", "message": "refactor DateTimeWidgetUtils and DateTimeUtils"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMzU5NTkw", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-462359590", "createdAt": "2020-08-06T09:31:38Z", "commit": {"oid": "cac04f4c93371c0e79f5990d00f637fafa9970bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwOTozMTozOFrOG8rmwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwOTozMTozOFrOG8rmwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI4MjE3OA==", "bodyText": "This works but it's not a proper solution. You already have ViewModel and it is a component you should use to store data and make sure it persists. I mean passing data from a widget to dialog using bundle is ok but then you should unpack it and store in your viewmodel.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r466282178", "createdAt": "2020-08-06T09:31:38Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/fragments/dialogs/CustomDatePickerDialog.java", "diffHunk": "@@ -82,6 +82,12 @@ public Dialog onCreateDialog(Bundle savedInstanceState) {\n                 .create();\n     }\n \n+    @Override\n+    public void onDestroyView() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cac04f4c93371c0e79f5990d00f637fafa9970bd"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNDY3NTA4", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-462467508", "createdAt": "2020-08-06T12:25:19Z", "commit": {"oid": "3a7c45bfeac0377b61173c808dcedb88bdd7bc92"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMjoyNToxOVrOG8xNnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMjoyNToxOVrOG8xNnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM3NDA0Nw==", "bodyText": "I think it should be viewmodel's responsibility not to return null, so this check should be moved there and here you should just call viewModel.getDate();", "url": "https://github.com/getodk/collect/pull/3975#discussion_r466374047", "createdAt": "2020-08-06T12:25:19Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/fragments/dialogs/CustomDatePickerDialog.java", "diffHunk": "@@ -242,7 +189,11 @@ public int getYear() {\n     }\n \n     public LocalDateTime getDate() {\n-        return date;\n+        if (viewModel.getDate() == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a7c45bfeac0377b61173c808dcedb88bdd7bc92"}, "originalPosition": 218}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "70325582aa3c672aab415c726b82014b9d1f9ca8", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/70325582aa3c672aab415c726b82014b9d1f9ca8", "committedDate": "2020-08-10T12:55:20Z", "message": "show answer text view as null when prompt does not has answer"}, "afterCommit": {"oid": "c5a2847e320e9ca70a3ad52cf645e75cafcee505", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/c5a2847e320e9ca70a3ad52cf645e75cafcee505", "committedDate": "2020-08-11T10:35:34Z", "message": "remove DateTimeWidgetListener and update unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NTAyODgw", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-465502880", "createdAt": "2020-08-11T23:52:14Z", "commit": {"oid": "4556e07bee64749d40e0fdd2f06d57e8aa9d2321"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMzo1MjoxNFrOG_NDsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwMDoyMDoxMVrOG_NiPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkyNzQwOQ==", "bodyText": "This is added but never used.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r468927409", "createdAt": "2020-08-11T23:52:14Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/DateTimeWidgetUtils.java", "diffHunk": "@@ -0,0 +1,275 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import android.content.Context;\n+import android.os.Build;\n+import android.os.Bundle;\n+\n+import androidx.appcompat.app.AppCompatActivity;\n+\n+import org.javarosa.core.model.FormIndex;\n+import org.joda.time.DateTime;\n+import org.joda.time.LocalDateTime;\n+import org.joda.time.chrono.CopticChronology;\n+import org.joda.time.chrono.EthiopicChronology;\n+import org.joda.time.chrono.IslamicChronology;\n+import org.joda.time.chrono.PersianChronologyKhayyamBorkowski;\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.application.Collect;\n+import org.odk.collect.android.fragments.dialogs.BikramSambatDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CopticDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.CustomTimePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.EthiopianDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.FixedDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.IslamicDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.MyanmarDatePickerDialog;\n+import org.odk.collect.android.fragments.dialogs.PersianDatePickerDialog;\n+import org.odk.collect.android.javarosawrapper.FormController;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DialogUtils;\n+import org.odk.collect.android.utilities.MyanmarDateUtils;\n+import org.odk.collect.android.utilities.ThemeUtils;\n+import org.odk.collect.android.utilities.WidgetAppearanceUtils;\n+\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Calendar;\n+import java.util.Date;\n+import java.util.Locale;\n+\n+import bikramsambat.BikramSambatDate;\n+import bikramsambat.BsCalendar;\n+import bikramsambat.BsException;\n+import bikramsambat.BsGregorianDate;\n+import mmcalendar.MyanmarDate;\n+import mmcalendar.MyanmarDateConverter;\n+import timber.log.Timber;\n+\n+public class DateTimeWidgetUtils {\n+    public static final String DATE = \"date\";\n+    public static final String TIME = \"time\";\n+    public static final String DIALOG_THEME = \"dialog_theme\";\n+    public static final String DATE_PICKER_DETAILS = \"date_picker_details\";\n+    public static final String FORM_INDEX = \"form_index\";\n+\n+    public static void setWidgetWaitingForData(FormIndex formIndex) {\n+        FormController formController = Collect.getInstance().getFormController();\n+        if (formController != null) {\n+            formController.setIndexWaitingForData(formIndex);\n+        }\n+    }\n+\n+    public static DatePickerDetails getDatePickerDetails(String appearance) {\n+        DatePickerDetails.DatePickerType datePickerType = DatePickerDetails.DatePickerType.GREGORIAN;\n+        DatePickerDetails.DatePickerMode datePickerMode = DatePickerDetails.DatePickerMode.CALENDAR;\n+        if (appearance != null) {\n+            appearance = appearance.toLowerCase(Locale.US);\n+            if (appearance.contains(WidgetAppearanceUtils.ETHIOPIAN)) {\n+                datePickerType = DatePickerDetails.DatePickerType.ETHIOPIAN;\n+                datePickerMode = DatePickerDetails.DatePickerMode.SPINNERS;\n+            } else if (appearance.contains(WidgetAppearanceUtils.COPTIC)) {\n+                datePickerType = DatePickerDetails.DatePickerType.COPTIC;\n+                datePickerMode = DatePickerDetails.DatePickerMode.SPINNERS;\n+            } else if (appearance.contains(WidgetAppearanceUtils.ISLAMIC)) {\n+                datePickerType = DatePickerDetails.DatePickerType.ISLAMIC;\n+                datePickerMode = DatePickerDetails.DatePickerMode.SPINNERS;\n+            } else if (appearance.contains(WidgetAppearanceUtils.BIKRAM_SAMBAT)) {\n+                datePickerType = DatePickerDetails.DatePickerType.BIKRAM_SAMBAT;\n+                datePickerMode = DatePickerDetails.DatePickerMode.SPINNERS;\n+            } else if (appearance.contains(WidgetAppearanceUtils.MYANMAR)) {\n+                datePickerType = DatePickerDetails.DatePickerType.MYANMAR;\n+                datePickerMode = DatePickerDetails.DatePickerMode.SPINNERS;\n+            } else if (appearance.contains(WidgetAppearanceUtils.PERSIAN)) {\n+                datePickerType = DatePickerDetails.DatePickerType.PERSIAN;\n+                datePickerMode = DatePickerDetails.DatePickerMode.SPINNERS;\n+            } else if (appearance.contains(WidgetAppearanceUtils.NO_CALENDAR)) {\n+                datePickerMode = DatePickerDetails.DatePickerMode.SPINNERS;\n+            }\n+\n+            if (appearance.contains(WidgetAppearanceUtils.MONTH_YEAR)) {\n+                datePickerMode = DatePickerDetails.DatePickerMode.MONTH_YEAR;\n+            } else if (appearance.contains(WidgetAppearanceUtils.YEAR)) {\n+                datePickerMode = DatePickerDetails.DatePickerMode.YEAR;\n+            }\n+        }\n+\n+        return new DatePickerDetails(datePickerType, datePickerMode);\n+    }\n+\n+    public static String getDateTimeLabel(Date date, DatePickerDetails datePickerDetails, boolean containsTime, Context context) {\n+        String gregorianDateText = getGregorianDateTimeLabel(date, datePickerDetails, containsTime, Locale.getDefault());\n+\n+        DateTime customDate;\n+        String[] monthArray;\n+\n+        switch (datePickerDetails.getDatePickerType()) {\n+            case GREGORIAN:\n+                return gregorianDateText;\n+            case ETHIOPIAN:\n+                customDate = new DateTime(date).withChronology(EthiopicChronology.getInstance());\n+                monthArray = context.getResources().getStringArray(R.array.ethiopian_months);\n+                break;\n+            case COPTIC:\n+                customDate = new DateTime(date).withChronology(CopticChronology.getInstance());\n+                monthArray = context.getResources().getStringArray(R.array.coptic_months);\n+                break;\n+            case ISLAMIC:\n+                customDate = new DateTime(date).withChronology(IslamicChronology.getInstance());\n+                monthArray = context.getResources().getStringArray(R.array.islamic_months);\n+                break;\n+            case BIKRAM_SAMBAT:\n+                customDate = new DateTime(date);\n+                monthArray = BsCalendar.MONTH_NAMES.toArray(new String[BsCalendar.MONTH_NAMES.size()]);\n+                break;\n+            case MYANMAR:\n+                customDate = new DateTime(date);\n+                MyanmarDate myanmarDate = MyanmarDateConverter.convert(customDate.getYear(),\n+                        customDate.getMonthOfYear(), customDate.getDayOfMonth(), customDate.getHourOfDay(),\n+                        customDate.getMinuteOfHour(), customDate.getSecondOfMinute());\n+                monthArray = MyanmarDateUtils.getMyanmarMonthsArray(myanmarDate.getYearInt());\n+                break;\n+            case PERSIAN:\n+                customDate = new DateTime(date).withChronology(PersianChronologyKhayyamBorkowski.getInstance());\n+                monthArray = context.getResources().getStringArray(R.array.persian_months);\n+                break;\n+            default:\n+                Timber.w(\"Not supported date type.\");\n+                return null;\n+        }\n+\n+        String customDateText = \"\";\n+\n+        SimpleDateFormat df = new SimpleDateFormat(\"HH:mm\", Locale.getDefault());\n+        switch (datePickerDetails.getDatePickerType()) {\n+            case BIKRAM_SAMBAT:\n+                BikramSambatDate bikramSambatDate;\n+                try {\n+                    Calendar calendar = Calendar.getInstance();\n+                    calendar.setTime(date);\n+                    bikramSambatDate = BsCalendar.getInstance().toBik(new BsGregorianDate(\n+                            calendar.get(Calendar.YEAR),\n+                            calendar.get(Calendar.MONTH) + 1,\n+                            calendar.get(Calendar.DAY_OF_MONTH)));\n+                    String day = datePickerDetails.isSpinnerMode() ? bikramSambatDate.day + \" \" : \"\";\n+                    String month = datePickerDetails.isSpinnerMode() || datePickerDetails.isMonthYearMode() ? monthArray[bikramSambatDate.month - 1] + \" \" : \"\";\n+\n+                    if (containsTime) {\n+                        customDateText = day + month + bikramSambatDate.year + \", \" + df.format(customDate.toDate());\n+                    } else {\n+                        customDateText = day + month + bikramSambatDate.year;\n+                    }\n+                } catch (BsException e) {\n+                    Timber.e(e);\n+                }\n+                break;\n+            case MYANMAR: {\n+                MyanmarDate myanmarDate = MyanmarDateConverter.convert(customDate.getYear(),\n+                        customDate.getMonthOfYear(), customDate.getDayOfMonth(), customDate.getHourOfDay(),\n+                        customDate.getMinuteOfHour(), customDate.getSecondOfMinute());\n+\n+                String day = datePickerDetails.isSpinnerMode() ? myanmarDate.getMonthDay() + \" \" : \"\";\n+                String month = datePickerDetails.isSpinnerMode() || datePickerDetails.isMonthYearMode() ? monthArray[MyanmarDateUtils.getMonthId(myanmarDate)] + \" \" : \"\";\n+\n+                if (containsTime) {\n+                    customDateText = day + month + myanmarDate.getYearInt() + \", \" + df.format(customDate.toDate());\n+                } else {\n+                    customDateText = day + month + myanmarDate.getYearInt();\n+                }\n+                break;\n+            }\n+            default:\n+                String day = datePickerDetails.isSpinnerMode() ? customDate.getDayOfMonth() + \" \" : \"\";\n+                String month = datePickerDetails.isSpinnerMode() || datePickerDetails.isMonthYearMode() ? monthArray[customDate.getMonthOfYear() - 1] + \" \" : \"\";\n+\n+                if (containsTime) {\n+                    customDateText = day + month + customDate.getYear() + \", \" + df.format(customDate.toDate());\n+                } else {\n+                    customDateText = day + month + customDate.getYear();\n+                }\n+        }\n+\n+        return String.format(context.getString(R.string.custom_date), customDateText, gregorianDateText);\n+    }\n+\n+    public void showTimePickerDialog(Context context, LocalDateTime dateTime) {\n+        ThemeUtils themeUtils = new ThemeUtils(context);\n+\n+        Bundle bundle = new Bundle();\n+        bundle.putInt(DIALOG_THEME, themeUtils.getHoloDialogTheme());\n+        bundle.putSerializable(TIME, dateTime);\n+\n+        DialogUtils.showIfNotShowing(CustomTimePickerDialog.class, bundle, ((AppCompatActivity) context).getSupportFragmentManager());\n+    }\n+\n+    public void showDatePickerDialog(Context context, FormIndex formIndex, DatePickerDetails datePickerDetails,\n+                                            LocalDateTime date) {\n+        ThemeUtils themeUtils = new ThemeUtils(context);\n+\n+        Bundle bundle = new Bundle();\n+        bundle.putInt(DIALOG_THEME, getDatePickerTheme(themeUtils, datePickerDetails));\n+        bundle.putSerializable(DATE, date);\n+        bundle.putSerializable(DATE_PICKER_DETAILS, datePickerDetails);\n+        bundle.putSerializable(FORM_INDEX, formIndex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4556e07bee64749d40e0fdd2f06d57e8aa9d2321"}, "originalPosition": 211}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkyODA3NQ==", "bodyText": "Should be stored in view model too.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r468928075", "createdAt": "2020-08-11T23:54:46Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/fragments/dialogs/CustomDatePickerDialog.java", "diffHunk": "@@ -18,137 +18,97 @@\n \n import android.app.Dialog;\n import android.content.Context;\n-import android.content.DialogInterface;\n import android.os.Bundle;\n import androidx.fragment.app.DialogFragment;\n import androidx.appcompat.app.AlertDialog;\n+import androidx.lifecycle.ViewModelProvider;\n+\n import android.view.View;\n import android.widget.NumberPicker;\n import android.widget.TextView;\n \n-import org.javarosa.core.model.FormIndex;\n import org.joda.time.LocalDateTime;\n import org.joda.time.chrono.GregorianChronology;\n import org.odk.collect.android.R;\n-import org.odk.collect.android.application.Collect;\n import org.odk.collect.android.logic.DatePickerDetails;\n-import org.odk.collect.android.javarosawrapper.FormController;\n import org.odk.collect.android.utilities.DateTimeUtils;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n+import org.odk.collect.android.widgets.viewmodels.DateTimeViewModel;\n \n /**\n  * @author Grzegorz Orczykowski (gorczykowski@soldevelo.com)\n  */\n public abstract class CustomDatePickerDialog extends DialogFragment {\n-    public static final String DATE_PICKER_DIALOG = \"datePickerDialog\";\n-\n-    private static final String FORM_INDEX = \"formIndex\";\n-    private static final String DATE = \"date\";\n-    private static final String DATE_PICKER_DETAILS = \"datePickerDetails\";\n-\n     private NumberPicker dayPicker;\n     private NumberPicker monthPicker;\n     private NumberPicker yearPicker;\n \n-    private LocalDateTime date;\n-\n     private TextView gregorianDateText;\n \n-    private FormIndex formIndex;\n-\n     private DatePickerDetails datePickerDetails;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4556e07bee64749d40e0fdd2f06d57e8aa9d2321"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzMDI4Mw==", "bodyText": "Values you acres via DateTimeWidgetUtils.TIME and DateTimeWidgetUtils.DIALOG_THEME should be stored in viewmodel like you do in CustomDatePickerDialog.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r468930283", "createdAt": "2020-08-12T00:02:17Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/fragments/dialogs/CustomTimePickerDialog.java", "diffHunk": "@@ -0,0 +1,165 @@\n+package org.odk.collect.android.fragments.dialogs;\n+\n+import android.app.Dialog;\n+import android.app.TimePickerDialog;\n+import android.content.Context;\n+import android.content.res.TypedArray;\n+import android.graphics.Color;\n+import android.graphics.drawable.ColorDrawable;\n+import android.os.Build;\n+import android.os.Bundle;\n+import android.text.format.DateFormat;\n+import android.util.AttributeSet;\n+import android.view.Window;\n+import android.widget.TimePicker;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.fragment.app.DialogFragment;\n+import androidx.lifecycle.ViewModelProvider;\n+\n+import org.joda.time.DateTime;\n+import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n+import org.odk.collect.android.widgets.viewmodels.DateTimeViewModel;\n+\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.Field;\n+\n+import timber.log.Timber;\n+\n+public class CustomTimePickerDialog extends DialogFragment {\n+    private DateTimeViewModel viewModel;\n+    private TimeChangeListener timeChangeListener;\n+\n+    public interface TimeChangeListener {\n+        void onTimeChanged(DateTime selectedTime);\n+    }\n+\n+    @Override\n+    public void onAttach(@NonNull Context context) {\n+        super.onAttach(context);\n+\n+        if (context instanceof TimeChangeListener) {\n+            timeChangeListener = (TimeChangeListener) context;\n+        }\n+\n+        viewModel = new ViewModelProvider(this).get(DateTimeViewModel.class);\n+        viewModel.getSelectedTime().observe(this, dateTime -> {\n+            timeChangeListener.onTimeChanged(dateTime);\n+        });\n+    }\n+\n+    @NonNull\n+    @Override\n+    public Dialog onCreateDialog(@Nullable Bundle savedInstanceState) {\n+        LocalDateTime time = (LocalDateTime) getArguments().getSerializable(DateTimeWidgetUtils.TIME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4556e07bee64749d40e0fdd2f06d57e8aa9d2321"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzMDc4MA==", "bodyText": "Would be good to move getDateAsGregorian and getDateWithSkippedDaylightSavingGapIfExists methods out of this class to DateTimeUtils.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r468930780", "createdAt": "2020-08-12T00:04:21Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/fragments/dialogs/CustomDatePickerDialog.java", "diffHunk": "@@ -18,137 +18,97 @@\n \n import android.app.Dialog;\n import android.content.Context;\n-import android.content.DialogInterface;\n import android.os.Bundle;\n import androidx.fragment.app.DialogFragment;\n import androidx.appcompat.app.AlertDialog;\n+import androidx.lifecycle.ViewModelProvider;\n+\n import android.view.View;\n import android.widget.NumberPicker;\n import android.widget.TextView;\n \n-import org.javarosa.core.model.FormIndex;\n import org.joda.time.LocalDateTime;\n import org.joda.time.chrono.GregorianChronology;\n import org.odk.collect.android.R;\n-import org.odk.collect.android.application.Collect;\n import org.odk.collect.android.logic.DatePickerDetails;\n-import org.odk.collect.android.javarosawrapper.FormController;\n import org.odk.collect.android.utilities.DateTimeUtils;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n+import org.odk.collect.android.widgets.viewmodels.DateTimeViewModel;\n \n /**\n  * @author Grzegorz Orczykowski (gorczykowski@soldevelo.com)\n  */\n public abstract class CustomDatePickerDialog extends DialogFragment {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4556e07bee64749d40e0fdd2f06d57e8aa9d2321"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzNTIzMQ==", "bodyText": "This is not your fault because probably it worked in the same way on master but it's not consistent. Only TimePicker is not cancelable in all other cases where we use dialogs like datePicker/RankingWidget/NumberPicker it is possible to close such a dialog clicking outside of it so I think timePicker should follow the same approach.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r468935231", "createdAt": "2020-08-12T00:20:11Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/fragments/dialogs/CustomTimePickerDialog.java", "diffHunk": "@@ -0,0 +1,165 @@\n+package org.odk.collect.android.fragments.dialogs;\n+\n+import android.app.Dialog;\n+import android.app.TimePickerDialog;\n+import android.content.Context;\n+import android.content.res.TypedArray;\n+import android.graphics.Color;\n+import android.graphics.drawable.ColorDrawable;\n+import android.os.Build;\n+import android.os.Bundle;\n+import android.text.format.DateFormat;\n+import android.util.AttributeSet;\n+import android.view.Window;\n+import android.widget.TimePicker;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.fragment.app.DialogFragment;\n+import androidx.lifecycle.ViewModelProvider;\n+\n+import org.joda.time.DateTime;\n+import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n+import org.odk.collect.android.widgets.viewmodels.DateTimeViewModel;\n+\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.Field;\n+\n+import timber.log.Timber;\n+\n+public class CustomTimePickerDialog extends DialogFragment {\n+    private DateTimeViewModel viewModel;\n+    private TimeChangeListener timeChangeListener;\n+\n+    public interface TimeChangeListener {\n+        void onTimeChanged(DateTime selectedTime);\n+    }\n+\n+    @Override\n+    public void onAttach(@NonNull Context context) {\n+        super.onAttach(context);\n+\n+        if (context instanceof TimeChangeListener) {\n+            timeChangeListener = (TimeChangeListener) context;\n+        }\n+\n+        viewModel = new ViewModelProvider(this).get(DateTimeViewModel.class);\n+        viewModel.getSelectedTime().observe(this, dateTime -> {\n+            timeChangeListener.onTimeChanged(dateTime);\n+        });\n+    }\n+\n+    @NonNull\n+    @Override\n+    public Dialog onCreateDialog(@Nullable Bundle savedInstanceState) {\n+        LocalDateTime time = (LocalDateTime) getArguments().getSerializable(DateTimeWidgetUtils.TIME);\n+\n+        TimePickerDialog dialog = new TimePickerDialog(requireContext(), getArguments().getInt(DateTimeWidgetUtils.DIALOG_THEME),\n+                viewModel.timeSetListener, time.getHourOfDay(),\n+                time.getMinuteOfHour(), DateFormat.is24HourFormat(requireContext()));\n+\n+        dialog.setTitle(requireContext().getString(R.string.select_time));\n+        fixSpinner(requireContext(), time.getHourOfDay(), time.getMinuteOfHour(),\n+                DateFormat.is24HourFormat(requireContext()));\n+\n+        Window window = dialog.getWindow();\n+        if (window != null) {\n+            window.setBackgroundDrawable(new ColorDrawable(Color.TRANSPARENT));\n+        }\n+\n+        setCancelable(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4556e07bee64749d40e0fdd2f06d57e8aa9d2321"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1ODk0Nzc1", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-465894775", "createdAt": "2020-08-12T13:04:24Z", "commit": {"oid": "608085353ec71a8f9ea700f3b9c00e475afbcf5a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMzowNDoyNFrOG_gVIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMzowNDoyNFrOG_gVIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI0MzE3MQ==", "bodyText": "Hi @grzesiek2010! I had a doubt. Here, I just test whether the date answer shown in widgetAnswerText is same as that returned by DateTimeWidgetUtils.getDateTimeLAbel() method. I do not write unit tests for all the different cases when datePickerDetails are different, and for different formats. Is it fine here just to check for one case, and have a check for all the other cases in DateTimeWidgetUtilsTest class?", "url": "https://github.com/getodk/collect/pull/3975#discussion_r469243171", "createdAt": "2020-08-12T13:04:24Z", "author": {"login": "SaumiaSinghal"}, "path": "collect_app/src/test/java/org/odk/collect/android/widgets/DateWidgetTest.java", "diffHunk": "@@ -2,65 +2,158 @@\n \n import android.view.View;\n \n-import androidx.annotation.NonNull;\n-\n import org.javarosa.core.model.QuestionDef;\n import org.javarosa.core.model.data.DateData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.joda.time.LocalDateTime;\n+import org.junit.Before;\n import org.junit.Test;\n-import org.mockito.Mock;\n+import org.junit.runner.RunWith;\n+import org.odk.collect.android.R;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.widgets.base.GeneralDateTimeWidgetTest;\n+import org.odk.collect.android.listeners.WidgetValueChangedListener;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.support.TestScreenContextActivity;\n+import org.odk.collect.android.utilities.DateTimeUtils;\n+import org.odk.collect.android.widgets.utilities.DateTimeWidgetUtils;\n+import org.robolectric.RobolectricTestRunner;\n \n import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.nullValue;\n import static org.junit.Assert.assertEquals;\n-import static org.junit.Assert.assertFalse;\n-import static org.mockito.Mockito.when;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.mockValueChangedListener;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithQuestionDefAndAnswer;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithReadOnlyAndQuestionDef;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.widgetTestActivity;\n+\n+@RunWith(RobolectricTestRunner.class)\n+public class DateWidgetTest {\n+    private TestScreenContextActivity widgetActivity;\n+    private DateTimeWidgetUtils widgetUtils;\n+    private View.OnLongClickListener onLongClickListener;\n+\n+    private QuestionDef questionDef;\n+    private LocalDateTime dateAnswer;\n+\n+    @Before\n+    public void setUp() {\n+        widgetActivity = widgetTestActivity();\n+\n+        questionDef = mock(QuestionDef.class);\n+        onLongClickListener = mock(View.OnLongClickListener.class);\n+        widgetUtils = mock(DateTimeWidgetUtils.class);\n+\n+        dateAnswer = DateTimeUtils.getSelectedDate(new LocalDateTime().withDate(2010, 5, 12), LocalDateTime.now());\n+    }\n+\n+    @Test\n+    public void usingReadOnlyOption_doesNotShowButton() {\n+        DateWidget widget = createWidget(promptWithReadOnlyAndQuestionDef(questionDef));\n+        assertEquals(widget.binding.widgetButton.getVisibility(), View.GONE);\n+    }\n+\n+    @Test\n+    public void whenPromptIsNotReadOnly_buttonShowsCorrectText() {\n+        DateWidget widget = createWidget(promptWithQuestionDefAndAnswer(questionDef, null));\n+        assertEquals(widget.binding.widgetButton.getText(), widget.getContext().getString(R.string.select_date));\n+    }\n+\n+    @Test\n+    public void getAnswer_whenPromptDoesNotHaveAnswer_returnsNull() {\n+        assertThat(createWidget(promptWithQuestionDefAndAnswer(questionDef, null)).getAnswer(), nullValue());\n+    }\n+\n+    @Test\n+    public void getAnswer_whenPromptHasAnswer_returnsDate() {\n+        DateWidget widget = createWidget(promptWithQuestionDefAndAnswer(questionDef, new DateData(dateAnswer.toDate())));\n+        assertEquals(widget.getAnswer().getDisplayText(), new DateData(dateAnswer.toDate()).getDisplayText());\n+    }\n \n-public class DateWidgetTest extends GeneralDateTimeWidgetTest<DateWidget, DateData> {\n+    @Test\n+    public void whenPromptDoesNotHaveAnswer_answerTextViewShowsNoDateSelected() {\n+        DateWidget widget = createWidget(promptWithQuestionDefAndAnswer(questionDef, null));\n+        assertEquals(widget.binding.widgetAnswerText.getText(), widget.getContext().getString(R.string.no_date_selected));\n+    }\n+\n+    @Test\n+    public void whenPromptHasAnswer_answerTextViewShowsCorrectDate() {\n+        FormEntryPrompt prompt = promptWithQuestionDefAndAnswer(questionDef, new DateData(dateAnswer.toDate()));\n+        DatePickerDetails datePickerDetails = DateTimeWidgetUtils.getDatePickerDetails(prompt.getQuestion().getAppearanceAttr());\n+        DateWidget widget = createWidget(prompt);\n+\n+        assertEquals(widget.binding.widgetAnswerText.getText(),\n+                DateTimeWidgetUtils.getDateTimeLabel(dateAnswer.toDate(), datePickerDetails, false, widget.getContext()));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "608085353ec71a8f9ea700f3b9c00e475afbcf5a"}, "originalPosition": 96}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NDk1NjY5", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-466495669", "createdAt": "2020-08-13T07:05:58Z", "commit": {"oid": "608085353ec71a8f9ea700f3b9c00e475afbcf5a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNzowNTo1OFrOG_-qvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNzoxMzozNVrOG_-42Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc0MDIyMg==", "bodyText": "You should be consequent here. Below you have private props accessed via getters, would be good to keep one approach.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r469740222", "createdAt": "2020-08-13T07:05:58Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/viewmodels/DateTimeViewModel.java", "diffHunk": "@@ -23,7 +24,9 @@\n         setSelectedTime(hourOfDay, minuteOfHour);\n     };\n \n-    public LocalDateTime date;\n+    public LocalDateTime localDateTime;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "608085353ec71a8f9ea700f3b9c00e475afbcf5a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc0MzgzMw==", "bodyText": "You can get rid of curly brackets here.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r469743833", "createdAt": "2020-08-13T07:13:35Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/viewmodels/DateTimeViewModel.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package org.odk.collect.android.widgets.viewmodels;\n+\n+import android.app.DatePickerDialog;\n+import android.app.TimePickerDialog;\n+\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+import androidx.lifecycle.ViewModel;\n+\n+import org.joda.time.DateTime;\n+import org.joda.time.LocalDateTime;\n+import org.odk.collect.android.logic.DatePickerDetails;\n+import org.odk.collect.android.utilities.DateTimeUtils;\n+\n+public class DateTimeViewModel extends ViewModel {\n+    public final DatePickerDialog.OnDateSetListener dateSetListener = (view, year, monthOfYear, dayOfMonth) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "608085353ec71a8f9ea700f3b9c00e475afbcf5a"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMzgxMTcw", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-470381170", "createdAt": "2020-08-19T11:52:24Z", "commit": {"oid": "301fe69f8be32f42be6bf3146cf16481bbc3a7ca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "301fe69f8be32f42be6bf3146cf16481bbc3a7ca", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/301fe69f8be32f42be6bf3146cf16481bbc3a7ca", "committedDate": "2020-08-13T10:35:34Z", "message": "refactor DateTimeViewModel"}, "afterCommit": {"oid": "e9aa09a5357292a5ca317669e13f3c4a26cb1130", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/e9aa09a5357292a5ca317669e13f3c4a26cb1130", "committedDate": "2020-09-08T07:59:16Z", "message": "refactor DateTimeViewModel"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a79b5ae98e4c362b636aa387c59e383421804eb2", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/a79b5ae98e4c362b636aa387c59e383421804eb2", "committedDate": "2020-09-24T17:39:03Z", "message": "fix crash on Android 7"}, "afterCommit": {"oid": "3c2b01165ee3389c451691d00fb08ed12b752939", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/3c2b01165ee3389c451691d00fb08ed12b752939", "committedDate": "2020-10-09T04:06:38Z", "message": "fix crash on Android 7"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6910d97dde2ce38cb516897186cfd6192d139bc7", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/6910d97dde2ce38cb516897186cfd6192d139bc7", "committedDate": "2020-10-09T12:27:29Z", "message": "remove yearMode and monthMode unit tests for CustomDatePickerDialogs"}, "afterCommit": {"oid": "9ace7eb312a68eb4cf184db0c06f78e56894c0be", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/9ace7eb312a68eb4cf184db0c06f78e56894c0be", "committedDate": "2020-10-13T10:34:37Z", "message": "fix unit tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ace7eb312a68eb4cf184db0c06f78e56894c0be", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/9ace7eb312a68eb4cf184db0c06f78e56894c0be", "committedDate": "2020-10-13T10:34:37Z", "message": "fix unit tests"}, "afterCommit": {"oid": "53cab7c02d9811b7d2866dc622c28dc3372a6ca1", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/53cab7c02d9811b7d2866dc622c28dc3372a6ca1", "committedDate": "2020-10-13T10:37:56Z", "message": "fix unit tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53cab7c02d9811b7d2866dc622c28dc3372a6ca1", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/53cab7c02d9811b7d2866dc622c28dc3372a6ca1", "committedDate": "2020-10-13T10:37:56Z", "message": "fix unit tests"}, "afterCommit": {"oid": "281f4915a583c288f4e2913a0f58fb6a0dd83084", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/281f4915a583c288f4e2913a0f58fb6a0dd83084", "committedDate": "2020-10-20T17:37:27Z", "message": "code refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fdadadc6c268fbd81a24c9b8b78671b27293465", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/9fdadadc6c268fbd81a24c9b8b78671b27293465", "committedDate": "2020-11-06T12:37:26Z", "message": "reslolve conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99254e99f1c182975efe95057fc2dcc671477d5d", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/99254e99f1c182975efe95057fc2dcc671477d5d", "committedDate": "2020-11-06T12:37:26Z", "message": "update layout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "663f3ade247e7db454cd218d83ce3732bc606020", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/663f3ade247e7db454cd218d83ce3732bc606020", "committedDate": "2020-11-06T12:37:27Z", "message": "fixed conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77f21c8a4909483f132b1022cb050020dc761627", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/77f21c8a4909483f132b1022cb050020dc761627", "committedDate": "2020-11-06T12:37:27Z", "message": "fixed conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b204a218e7ef413d1b15c2b281965adb6e46b73a", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/b204a218e7ef413d1b15c2b281965adb6e46b73a", "committedDate": "2020-11-06T12:37:28Z", "message": "add unit tests for time widget"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "227676955114d36075671141473cbf3def80190c", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/227676955114d36075671141473cbf3def80190c", "committedDate": "2020-11-06T12:37:28Z", "message": "fixed conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "953878ca37ff35b7c135ae4287e85f8e7191b54f", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/953878ca37ff35b7c135ae4287e85f8e7191b54f", "committedDate": "2020-11-06T12:37:29Z", "message": "fixed conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3c1b034eba62ddf8f85cd6ee3f6509b18838a21", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/b3c1b034eba62ddf8f85cd6ee3f6509b18838a21", "committedDate": "2020-11-06T12:37:30Z", "message": "fixed conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb14e16d66fa376fb8a4d148bd3527853b563640", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/cb14e16d66fa376fb8a4d148bd3527853b563640", "committedDate": "2020-11-06T12:37:31Z", "message": "add unit tests for DateTimeWidget"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90bc92536b8ffb8ec9e812bf87a10446b9c6bc9a", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/90bc92536b8ffb8ec9e812bf87a10446b9c6bc9a", "committedDate": "2020-11-06T12:37:31Z", "message": "fixed conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d37649036de136e4c7934b91c0b1d74caedd4339", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/d37649036de136e4c7934b91c0b1d74caedd4339", "committedDate": "2020-11-06T12:37:32Z", "message": "fixed conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8575a8b8d72dae07d6a6672cad99c0516172867", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/c8575a8b8d72dae07d6a6672cad99c0516172867", "committedDate": "2020-11-06T12:37:32Z", "message": "add unit tests for DateTimeWidgetUtils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "857da01294be30e9a04847fc4c856d8b6c9ec0e8", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/857da01294be30e9a04847fc4c856d8b6c9ec0e8", "committedDate": "2020-11-06T12:37:33Z", "message": "code refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78c298a6cbc669ac9fb3ddcbfb54384e95cdbc16", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/78c298a6cbc669ac9fb3ddcbfb54384e95cdbc16", "committedDate": "2020-11-06T12:37:34Z", "message": "add unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c4cafbca283d2f77a311e34bed4ced15850d464", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/4c4cafbca283d2f77a311e34bed4ced15850d464", "committedDate": "2020-11-06T12:37:34Z", "message": "code refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d9d986daea25a8080d2cefd67224bc64cad0be7", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/2d9d986daea25a8080d2cefd67224bc64cad0be7", "committedDate": "2020-11-06T12:37:35Z", "message": "code improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdb5127154fbdc1fb201e79f616070ca99ec59dc", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/cdb5127154fbdc1fb201e79f616070ca99ec59dc", "committedDate": "2020-11-06T12:37:35Z", "message": "update unit tests in DateTimeWidgetUtils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e4e3577acdcd6566db3d97c3f103b143cd25f5d", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/0e4e3577acdcd6566db3d97c3f103b143cd25f5d", "committedDate": "2020-11-06T12:37:36Z", "message": "fix test shown on date button"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5defdc69ce10c406ff1ccb735c6477dd6cc1e758", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/5defdc69ce10c406ff1ccb735c6477dd6cc1e758", "committedDate": "2020-11-06T12:37:36Z", "message": "fix month value shown in FixedDatePickerDialog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77289eba62a0980f3e6504e2a6e3aeefbd51c72c", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/77289eba62a0980f3e6504e2a6e3aeefbd51c72c", "committedDate": "2020-11-06T12:37:37Z", "message": "fix failing unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f4b1b98ff56f7fd7d2a966703f8fb37ade5b6aa", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/9f4b1b98ff56f7fd7d2a966703f8fb37ade5b6aa", "committedDate": "2020-11-06T12:38:47Z", "message": "rename BinaryDataReceiver to WidgetDataReceiver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74c257e99981502cecb0d36abb7dea5efd308abe", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/74c257e99981502cecb0d36abb7dea5efd308abe", "committedDate": "2020-11-06T12:38:56Z", "message": "code refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0835444d9cbef72947289902c00775c3d44989f", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/c0835444d9cbef72947289902c00775c3d44989f", "committedDate": "2020-11-06T12:38:56Z", "message": "fix pmd"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e3478eef1fcd93902b456557da462a30bcce76b", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/1e3478eef1fcd93902b456557da462a30bcce76b", "committedDate": "2020-11-06T12:38:57Z", "message": "code refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "501d519aaeeb42cc1c93364524750d3122bf8274", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/501d519aaeeb42cc1c93364524750d3122bf8274", "committedDate": "2020-11-06T12:38:57Z", "message": "remove CustomDatePickerDialog listener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53059ffe7368125bb835cc948932f436f369e43e", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/53059ffe7368125bb835cc948932f436f369e43e", "committedDate": "2020-11-06T12:38:58Z", "message": "rename BinaryDataReceiver to WidgetDataReceiver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e38b94d406e5fdb03de469d2a3363d30d520ca55", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/e38b94d406e5fdb03de469d2a3363d30d520ca55", "committedDate": "2020-11-06T12:38:58Z", "message": "code refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db0d0b08a6b1fa31259d36e93b9cf76575ac1de3", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/db0d0b08a6b1fa31259d36e93b9cf76575ac1de3", "committedDate": "2020-11-06T12:38:59Z", "message": "use LocalDateTime for TimeWidget and DateTimeWidget"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f6faf90fa1323046c3322851114ee99474ae5a6", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/1f6faf90fa1323046c3322851114ee99474ae5a6", "committedDate": "2020-11-06T12:38:59Z", "message": "create DateTimeViewModel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74965daaa2bb1200eb73d4641cd60f649e09034a", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/74965daaa2bb1200eb73d4641cd60f649e09034a", "committedDate": "2020-11-06T12:39:00Z", "message": "remove OnDateSetListener and OnTimeSetListener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aab3001d6d81ec4f573fa10a46d4312b05664889", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/aab3001d6d81ec4f573fa10a46d4312b05664889", "committedDate": "2020-11-06T12:41:00Z", "message": "craete DateTimeWidgetListener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38fc43884edfa52888005595e43f826f17492d4a", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/38fc43884edfa52888005595e43f826f17492d4a", "committedDate": "2020-11-06T12:41:11Z", "message": "update TimeWidget unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58e3d6afcc04697e9c4d702a9001b4c406d9945c", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/58e3d6afcc04697e9c4d702a9001b4c406d9945c", "committedDate": "2020-11-06T12:41:12Z", "message": "update unit tests for Date and Time Widgets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea57a351ce1a9f99acdc086eaa748e1206abb4af", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/ea57a351ce1a9f99acdc086eaa748e1206abb4af", "committedDate": "2020-11-06T12:41:13Z", "message": "code refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fbacdeebcb7a95dcff1169de4ecdceb069b775f", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/7fbacdeebcb7a95dcff1169de4ecdceb069b775f", "committedDate": "2020-11-06T12:41:13Z", "message": "craete separate viewmodel for sepaarte classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85a52d0fbc2efc0c28ced7105ebc19d3084aa01b", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/85a52d0fbc2efc0c28ced7105ebc19d3084aa01b", "committedDate": "2020-11-06T12:42:03Z", "message": "create viewmodel using context of dialog and add update unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90041d30febb5b43408280f05c23f0efc977e96b", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/90041d30febb5b43408280f05c23f0efc977e96b", "committedDate": "2020-11-06T12:42:11Z", "message": "fix timepicker value set listener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0ad82d7bd8fa6b1172bb874dd7b4f313f0e0389", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/a0ad82d7bd8fa6b1172bb874dd7b4f313f0e0389", "committedDate": "2020-11-06T12:42:11Z", "message": "remove registerToContextMenu in QuestionWidget"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62bcc7e5214aa17a5c348754fb9c15a8f364c5fe", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/62bcc7e5214aa17a5c348754fb9c15a8f364c5fe", "committedDate": "2020-11-06T12:42:12Z", "message": "add unit tests for DateTimeViewModel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c188c472fa4b48170c4a421100668aecc51c566", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/1c188c472fa4b48170c4a421100668aecc51c566", "committedDate": "2020-11-06T12:42:12Z", "message": "refactor DateTimeUtils and DateTimeWidgetUtils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fa3d33b1f1dcb62160b17bd26ea376021424e8b", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/3fa3d33b1f1dcb62160b17bd26ea376021424e8b", "committedDate": "2020-11-06T12:42:13Z", "message": "add unit tests for DateTimeUtils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea2a85cd3b3bd0933635a0cce95b758deab91eae", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/ea2a85cd3b3bd0933635a0cce95b758deab91eae", "committedDate": "2020-11-06T12:42:13Z", "message": "update correct values in CustomDatePickerDialog on screen orientation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50af755de8b238adcfe30b839f1b47ac15193b22", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/50af755de8b238adcfe30b839f1b47ac15193b22", "committedDate": "2020-11-06T12:42:13Z", "message": "refactor DateTimeWidgetUtils and DateTimeUtils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0768876cf44b11b0e6eb5877a6bd8371faec4462", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/0768876cf44b11b0e6eb5877a6bd8371faec4462", "committedDate": "2020-11-06T12:42:14Z", "message": "revert timePicker.clearFocus() and use viewmodel to retain date on screen rotation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb9fe76a0f08c0e984d7b8f6b286bdfd817dbd84", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/cb9fe76a0f08c0e984d7b8f6b286bdfd817dbd84", "committedDate": "2020-11-06T12:42:15Z", "message": "remove unwanted abstraction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9f1fe1862a34c00ca585e1b90155ae5cd803c49", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/f9f1fe1862a34c00ca585e1b90155ae5cd803c49", "committedDate": "2020-11-06T12:42:16Z", "message": "fix unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fd8646f9e237031a962acf85347f20b223deb20", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/0fd8646f9e237031a962acf85347f20b223deb20", "committedDate": "2020-11-06T12:42:16Z", "message": "remove DateTimeWidgetListener and update unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63efa3e63d9b41a1a12cd0a65497061c69ecef11", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/63efa3e63d9b41a1a12cd0a65497061c69ecef11", "committedDate": "2020-11-06T12:42:17Z", "message": "use viewmodel to retain values in CustomDatePickerDialog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd6dbefa14596fd70e9022ef6d7d941665a9f61b", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/bd6dbefa14596fd70e9022ef6d7d941665a9f61b", "committedDate": "2020-11-06T12:42:18Z", "message": "code refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "225e5f614237426bc8f80db06604dbed85c4c46c", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/225e5f614237426bc8f80db06604dbed85c4c46c", "committedDate": "2020-11-06T12:42:19Z", "message": "add tests for CustomDatePickerDialogs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "082b999b1cf7766dd028cc1ba407de076fbcfe14", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/082b999b1cf7766dd028cc1ba407de076fbcfe14", "committedDate": "2020-11-06T12:42:19Z", "message": "refactor DateTimeViewModel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00d7ac2c87d7a1e35e8849352bc3ef195c9f5801", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/00d7ac2c87d7a1e35e8849352bc3ef195c9f5801", "committedDate": "2020-11-06T12:42:20Z", "message": "fix pmd error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7c0c5b832fce05f03abd769baefad11253f3339", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/d7c0c5b832fce05f03abd769baefad11253f3339", "committedDate": "2020-11-06T12:42:21Z", "message": "fix crash on Android 7"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01628d0b220694cae649bc55215e251544df2a8d", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/01628d0b220694cae649bc55215e251544df2a8d", "committedDate": "2020-11-06T12:42:21Z", "message": "update date and time layout resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ee68738405ae4960a75d08553a893204d80db40", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/6ee68738405ae4960a75d08553a893204d80db40", "committedDate": "2020-11-06T12:42:22Z", "message": "retain date in custom date picker dialogs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dafae431abbe8c67d025272432c82cf32708662", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/5dafae431abbe8c67d025272432c82cf32708662", "committedDate": "2020-11-06T12:42:22Z", "message": "fix unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fa80e3856e46eb33871fa5190d0b0e77fb52a88", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/8fa80e3856e46eb33871fa5190d0b0e77fb52a88", "committedDate": "2020-11-06T12:42:23Z", "message": "fix unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d66ac5057dce652700eedd54717e8c5cf7cffc91", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/d66ac5057dce652700eedd54717e8c5cf7cffc91", "committedDate": "2020-11-06T12:42:24Z", "message": "code refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b69d65837accd84d7f485ae3cfaab2ed5aaf2cae", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/b69d65837accd84d7f485ae3cfaab2ed5aaf2cae", "committedDate": "2020-11-06T12:42:24Z", "message": "remove extra margin in widget buttons"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8166aa8d5f34172d6172859e9795bb23f940eb5e", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/8166aa8d5f34172d6172859e9795bb23f940eb5e", "committedDate": "2020-10-20T17:43:22Z", "message": "remove extra margin in widget buttons"}, "afterCommit": {"oid": "b69d65837accd84d7f485ae3cfaab2ed5aaf2cae", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/b69d65837accd84d7f485ae3cfaab2ed5aaf2cae", "committedDate": "2020-11-06T12:42:24Z", "message": "remove extra margin in widget buttons"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NjQzNTAz", "url": "https://github.com/getodk/collect/pull/3975#pullrequestreview-526643503", "createdAt": "2020-11-09T20:50:52Z", "commit": {"oid": "b69d65837accd84d7f485ae3cfaab2ed5aaf2cae"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMDo1MDo1MlrOHwBGfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMDo1Mzo0MlrOHwBMRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDExMTc0Mw==", "bodyText": "Could you explain this change to me. You added a similar code to other date dialogs as well and I think I understand why we check if copticDay > copticDate.dayOfMonth() a few lines above since it's possible that when we change months we might move from one that has more days than another but is that possible that the number which represents months is negative?", "url": "https://github.com/getodk/collect/pull/3975#discussion_r520111743", "createdAt": "2020-11-09T20:50:52Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/fragments/dialogs/CopticDatePickerDialog.java", "diffHunk": "@@ -82,6 +73,10 @@ private LocalDateTime getCurrentCopticDate() {\n             copticDay = copticDate.dayOfMonth().getMaximumValue();\n         }\n \n+        if (copticDay < copticDate.dayOfMonth().getMinimumValue()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b69d65837accd84d7f485ae3cfaab2ed5aaf2cae"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDExMzIyMg==", "bodyText": "Please rename this method to setWidgetData() since like in this case it's not only about binary files.", "url": "https://github.com/getodk/collect/pull/3975#discussion_r520113222", "createdAt": "2020-11-09T20:53:42Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2632,6 +2629,15 @@ public void onCancelFormLoading() {\n         finish();\n     }\n \n+    private void onDataChanged(Object data) {\n+        ODKView odkView = getCurrentViewIfODKView();\n+        if (odkView != null) {\n+            QuestionWidget widgetGettingNewValue = getWidgetWaitingForBinaryData();\n+            setBinaryWidgetData(data);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b69d65837accd84d7f485ae3cfaab2ed5aaf2cae"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "919cca13a0e23dc02758687738564ecfb8b61a7c", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/919cca13a0e23dc02758687738564ecfb8b61a7c", "committedDate": "2020-11-11T05:43:16Z", "message": "rename setBinaryWidgetData to setWidgetData in FormEntryActivity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7eb6cf2d16924ab63fca3eedc18ded631e9f1299", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/7eb6cf2d16924ab63fca3eedc18ded631e9f1299", "committedDate": "2020-11-12T09:56:05Z", "message": "Merge branch 'master' into rework_date_widget"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2548, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}