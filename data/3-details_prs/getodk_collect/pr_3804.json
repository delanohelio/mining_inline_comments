{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMDUzNTY0", "number": 3804, "title": "Fixed maps offline", "bodyText": "Closes #3660\nWhat has been done to verify that this works as intended?\nI tested GoogleMaps and MapBox offline and confirmed that if during installation the device is connected to the internet it will work.\nWhy is this the best possible solution? Were any other approaches considered?\nMaybe the amount of code I have added is not impressive but it wasn't easy to figure out what's wrong so I also should explain.\nThe first problem was that we need to initialize maps when we are online to be able to use them when we are offline. It's a know limitation: https://issuetracker.google.com/issues/35823181 and it works in the same way for GoogleMaps and MapBox. The initialization took place when the map is opened so a user had to open a widget with maps to make sure it will work offline in the future.\nI improved this behavior adding initialization when the app is installed: 647dc72 7507d08 of course I can't be sure that a device is online during installation but it's much more likely.\nThe second problem was that MapBox didn't work offline even if we initialized it before (according to what I described above). Here the problem is that MapBox doesn't support using mbtiles offline and in order to do that we implemented a workaround TileHttpServer that uses localhost. Unfortunately Mapbox by default detects if a device is offline and doesn't even send requests in such a case. Our implementation is as I noticed based on https://gist.github.com/typebrook/7d25be326f0e9afd58e0bbc333d2a175 and there that limitation is also mentioned. Fortunately I was able to find a fix for it as well 71e8ba5\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nIt should just fix the problems described in the issue and explained more here. It should affect anything else so testing maps would be enough.\nDo we need any specific form for testing your changes? If so, please attach one.\nAny form with maps, it might be All widgets form.\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nThe only thing I can come up with is that we could add somewhere a note that users that use offline maps should make sure they have been initialized. The best way is just open maps when internet connection is available. I try to do that during installation and in 99% cases it should work but some users might install the app not from the store but offline using .apk files. What do you think? is it worth the effort?\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-04-28T11:21:29Z", "url": "https://github.com/getodk/collect/pull/3804", "merged": true, "mergeCommit": {"oid": "139853b73dc05b713d810e802ad3b3d6bbb71c0b"}, "closed": true, "closedAt": "2020-05-07T15:02:21Z", "author": {"login": "grzesiek2010"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcb2WsfAH2gAyNDEwMDUzNTY0OjcxZThiYTVkY2MwNWY1NDA1MjYzNTQ2MGM0NDRiNWQwZGEyMmE0Mjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcexUWPgFqTQwNzA1NTgzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "71e8ba5dcc05f54052635460c444b5d0da22a429", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/71e8ba5dcc05f54052635460c444b5d0da22a429", "committedDate": "2020-04-27T21:41:42Z", "message": "Fixed Mapbox to work offline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "647dc72d81aeeefc1a7f483490714950d403b31f", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/647dc72d81aeeefc1a7f483490714950d403b31f", "committedDate": "2020-04-28T09:27:04Z", "message": "Try to initialize GoogleMaps when the app is installed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7507d08f4b73faeae6824253a4fe4123fb783170", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/7507d08f4b73faeae6824253a4fe4123fb783170", "committedDate": "2020-04-28T11:02:15Z", "message": "Try to initialize MapBox when the app is installed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNzM5MjEx", "url": "https://github.com/getodk/collect/pull/3804#pullrequestreview-401739211", "createdAt": "2020-04-28T11:22:25Z", "commit": {"oid": "7507d08f4b73faeae6824253a4fe4123fb783170"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMToyMjoyNlrOGNPQ4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMToyMjoyNlrOGNPQ4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjUzNDc1Mg==", "bodyText": "Can't be gone or with 0dp/0dp I checked it.", "url": "https://github.com/getodk/collect/pull/3804#discussion_r416534752", "createdAt": "2020-04-28T11:22:26Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/res/layout/splash_screen.xml", "diffHunk": "@@ -7,6 +7,12 @@\n     android:orientation=\"vertical\"\n     android:padding=\"10dip\">\n \n+    <com.mapbox.mapboxsdk.maps.MapView\n+        android:id=\"@+id/mapView\"\n+        android:layout_width=\"match_parent\"\n+        android:layout_height=\"1dp\"\n+        android:visibility=\"invisible\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7507d08f4b73faeae6824253a4fe4123fb783170"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNzQzMTk4", "url": "https://github.com/getodk/collect/pull/3804#pullrequestreview-401743198", "createdAt": "2020-04-28T11:28:24Z", "commit": {"oid": "7507d08f4b73faeae6824253a4fe4123fb783170"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMToyODoyNVrOGNPdNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMToyODoyNVrOGNPdNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjUzNzkwOQ==", "bodyText": "I know the fix for Mapbox doesn't look good you would probably ask: can't we do the same what works for Google: 647dc72?\nUnfortunately we can't we need to display that map even if it's not visible like in this case to make sure getMapAsync and then setStyle is called. Only then MapBox is initialized properly and we can use it offline.", "url": "https://github.com/getodk/collect/pull/3804#discussion_r416537909", "createdAt": "2020-04-28T11:28:25Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/SplashScreenActivity.java", "diffHunk": "@@ -225,4 +229,9 @@ public void run() {\n         };\n         t.start();\n     }\n+\n+    private void initMapBox() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7507d08f4b73faeae6824253a4fe4123fb783170"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3MDU1ODM1", "url": "https://github.com/getodk/collect/pull/3804#pullrequestreview-407055835", "createdAt": "2020-05-06T23:31:23Z", "commit": {"oid": "7507d08f4b73faeae6824253a4fe4123fb783170"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2669, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}