{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMjUxNzg4", "number": 4261, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDoxMjo1NVrOE_ypMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjozMToyMlrOFAhs3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MzI1NDkwOnYy", "diffSide": "RIGHT", "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/ServerFormDownloader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDoxMjo1NVrOH9sV0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMzo0NjoyNlrOH-cazQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1MTY2NA==", "bodyText": "I went back and forth on whether to localize the download message. I think it's uncommon enough that we don't need to. I've added analytics so that we can verify that claim. I also hope that if it is more common than I expect we'll hear from users on the forum and perhaps we'll choose to work on the wording. \"please send all data you have collected with the existing form and delete the data and blank form\" is admittedly awkward and I'm open to alternatives.", "url": "https://github.com/getodk/collect/pull/4261#discussion_r534451664", "createdAt": "2020-12-02T20:12:55Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/ServerFormDownloader.java", "diffHunk": "@@ -40,19 +43,31 @@\n     private final String formsDirPath;\n     private final FormMetadataParser formMetadataParser;\n \n-    public ServerFormDownloader(FormSource formSource, FormsRepository formsRepository, File cacheDir, String formsDirPath, FormMetadataParser formMetadataParser) {\n+    private final Analytics analytics;\n+\n+    public ServerFormDownloader(FormSource formSource, FormsRepository formsRepository, File cacheDir, String formsDirPath, FormMetadataParser formMetadataParser, Analytics analytics) {\n         this.cacheDir = cacheDir;\n         this.formsDirPath = formsDirPath;\n         this.multiFormDownloader = new MultiFormDownloader(formsRepository, formSource);\n         this.formsRepository = formsRepository;\n         this.formMetadataParser = formMetadataParser;\n+\n+        this.analytics = analytics;\n     }\n \n     @Override\n     public void downloadForm(ServerFormDetails form, @Nullable ProgressReporter progressReporter, @Nullable Supplier<Boolean> isCancelled) throws FormDownloadException, InterruptedException {\n         Form formOnDevice = formsRepository.get(form.getFormId(), form.getFormVersion());\n-        if (formOnDevice != null && formOnDevice.isDeleted()) {\n-            formsRepository.restore(formOnDevice.getId());\n+        if (formOnDevice != null) {\n+            if (formOnDevice.isDeleted()) {\n+                formsRepository.restore(formOnDevice.getId());\n+            } else if (!(form.getHash().equals(formOnDevice.getMD5Hash()))) {\n+                String formIdentifier = formOnDevice.getDisplayName() + \" \" + formOnDevice.getId();\n+                String formIdHash = FileUtils.getMd5Hash(new ByteArrayInputStream(formIdentifier.getBytes()));\n+                analytics.logFormEvent(DOWNLOAD_SAME_FORMID_VERSION, formIdHash);\n+                throw new FormDownloadException(\"You've already downloaded a form with the same ID and version but with different contents. \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd2225da4b76971bb912ab0e094995d9d96aeba1"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIzOTM3Mw==", "bodyText": "I think I'm happy not localizing the method and with the text but I think it'd be good to separate it out as a display concern here. Could we maybe add a type to FormDownloadException (or a subtype) that we can use to match on and then display the right message in more UI focused code?", "url": "https://github.com/getodk/collect/pull/4261#discussion_r535239373", "createdAt": "2020-12-03T13:46:26Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/ServerFormDownloader.java", "diffHunk": "@@ -40,19 +43,31 @@\n     private final String formsDirPath;\n     private final FormMetadataParser formMetadataParser;\n \n-    public ServerFormDownloader(FormSource formSource, FormsRepository formsRepository, File cacheDir, String formsDirPath, FormMetadataParser formMetadataParser) {\n+    private final Analytics analytics;\n+\n+    public ServerFormDownloader(FormSource formSource, FormsRepository formsRepository, File cacheDir, String formsDirPath, FormMetadataParser formMetadataParser, Analytics analytics) {\n         this.cacheDir = cacheDir;\n         this.formsDirPath = formsDirPath;\n         this.multiFormDownloader = new MultiFormDownloader(formsRepository, formSource);\n         this.formsRepository = formsRepository;\n         this.formMetadataParser = formMetadataParser;\n+\n+        this.analytics = analytics;\n     }\n \n     @Override\n     public void downloadForm(ServerFormDetails form, @Nullable ProgressReporter progressReporter, @Nullable Supplier<Boolean> isCancelled) throws FormDownloadException, InterruptedException {\n         Form formOnDevice = formsRepository.get(form.getFormId(), form.getFormVersion());\n-        if (formOnDevice != null && formOnDevice.isDeleted()) {\n-            formsRepository.restore(formOnDevice.getId());\n+        if (formOnDevice != null) {\n+            if (formOnDevice.isDeleted()) {\n+                formsRepository.restore(formOnDevice.getId());\n+            } else if (!(form.getHash().equals(formOnDevice.getMD5Hash()))) {\n+                String formIdentifier = formOnDevice.getDisplayName() + \" \" + formOnDevice.getId();\n+                String formIdHash = FileUtils.getMd5Hash(new ByteArrayInputStream(formIdentifier.getBytes()));\n+                analytics.logFormEvent(DOWNLOAD_SAME_FORMID_VERSION, formIdHash);\n+                throw new FormDownloadException(\"You've already downloaded a form with the same ID and version but with different contents. \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1MTY2NA=="}, "originalCommit": {"oid": "bd2225da4b76971bb912ab0e094995d9d96aeba1"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MzI1ODIyOnYy", "diffSide": "RIGHT", "path": "collect_app/src/main/java/org/odk/collect/android/utilities/EncryptionUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDoxMzo1NFrOH9sX8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDoxMzo1NFrOH9sX8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1MjIxMQ==", "bodyText": "I really wanted to update all this to use the instance/form repositories but it didn't feel worth the effort and risk at this time. I tried doing it for just this branch but there's a lot of code below that relies on having a formCursor so it becomes a lot to change.\nA lot of this code is really odd so hopefully we'll have a good context for revisiting it soon. For starters, it seems unexpected that every form goes into EncryptionUtils on finalization even if it doesn't specify encryption. Feels like that check should happen earlier.", "url": "https://github.com/getodk/collect/pull/4261#discussion_r534452211", "createdAt": "2020-12-02T20:13:54Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/utilities/EncryptionUtils.java", "diffHunk": "@@ -271,12 +271,9 @@ public static EncryptedFormInformation getEncryptedFormInformation(Uri uri,\n         Cursor formCursor = null;\n         try {\n             if (InstanceColumns.CONTENT_ITEM_TYPE.equals(cr.getType(uri))) {\n-                // chain back to the Form record...\n-                String[] selectionArgs = null;\n-                String selection = null;\n-                Cursor instanceCursor = null;\n-                try {\n-                    instanceCursor = cr.query(uri, null, null, null, null);\n+                String[] selectionArgs;\n+                String selection = FormsColumns.DELETED_DATE + \" IS NULL AND \" + FormsColumns.JR_FORM_ID + \" =? AND \";\n+                try (Cursor instanceCursor = cr.query(uri, null, null, null, null)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd2225da4b76971bb912ab0e094995d9d96aeba1"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MzI2ODY1OnYy", "diffSide": "LEFT", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDoxNjo0OVrOH9sebA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDoxNjo0OVrOH9sebA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1Mzg2OA==", "bodyText": "This just wasn't true. The dialog errored out and quit the form so this wasn't a warning and the first entry was never used. Also it's no longer true that the SQLite database needs to be touched directly.", "url": "https://github.com/getodk/collect/pull/4261#discussion_r534453868", "createdAt": "2020-12-02T20:16:49Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -594,46 +597,22 @@ private void loadFromIntent(Intent intent) {\n             }\n \n             instancePath = formInfo.getInstancePath();\n+            List<Form> candidateForms = formsRepository.getAll(formInfo.getFormId(), formInfo.getFormVersion());\n \n-            String jrFormId = formInfo.getFormId();\n-            String jrVersion = formInfo.getFormVersion();\n-\n-            String[] selectionArgs;\n-            String selection;\n-            if (jrVersion == null) {\n-                selectionArgs = new String[]{jrFormId};\n-                selection = FormsColumns.JR_FORM_ID + \"=? AND \"\n-                        + FormsColumns.JR_VERSION + \" IS NULL\";\n-            } else {\n-                selectionArgs = new String[]{jrFormId, jrVersion};\n-                selection = FormsColumns.JR_FORM_ID + \"=? AND \"\n-                        + FormsColumns.JR_VERSION + \"=?\";\n-            }\n-\n-            int formCount = FormsDaoHelper.getFormsCount(selection, selectionArgs);\n-            if (formCount < 1) {\n+            if (candidateForms.isEmpty()) {\n                 createErrorDialog(getString(\n                         R.string.parent_form_not_present,\n-                        jrFormId)\n-                                + ((jrVersion == null) ? \"\"\n-                                : \"\\n\"\n-                                + getString(R.string.version)\n-                                + \" \"\n-                                + jrVersion),\n+                        formInfo.getFormId())\n+                                + ((formInfo.getFormVersion() == null) ? \"\"\n+                                : \"\\n\" + getString(R.string.version) + \" \" + formInfo.getFormVersion()),\n                         EXIT);\n                 return;\n-            } else {\n-                formPath = FormsDaoHelper.getFormPath(selection, selectionArgs);\n-\n-                /**\n-                 * Still take the first entry, but warn that there are multiple rows. User will", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd2225da4b76971bb912ab0e094995d9d96aeba1"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MzcyMTMxOnYy", "diffSide": "RIGHT", "path": "collect_app/src/main/java/org/odk/collect/android/utilities/EncryptionUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjoyNjozOVrOH9wuvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjoyNjozOVrOH9wuvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUyMzU4Mg==", "bodyText": "Creating a new FormsRepository here locally felt much better than trying to juggle more raw cursors.", "url": "https://github.com/getodk/collect/pull/4261#discussion_r534523582", "createdAt": "2020-12-02T22:26:39Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/utilities/EncryptionUtils.java", "diffHunk": "@@ -271,40 +272,32 @@ public static EncryptedFormInformation getEncryptedFormInformation(Uri uri,\n         Cursor formCursor = null;\n         try {\n             if (InstanceColumns.CONTENT_ITEM_TYPE.equals(cr.getType(uri))) {\n-                // chain back to the Form record...\n-                String[] selectionArgs = null;\n-                String selection = null;\n-                Cursor instanceCursor = null;\n-                try {\n-                    instanceCursor = cr.query(uri, null, null, null, null);\n+                String[] selectionArgs;\n+                String selection = FormsColumns.JR_FORM_ID + \" =? AND \";\n+                try (Cursor instanceCursor = cr.query(uri, null, null, null, null)) {\n                     if (instanceCursor.getCount() != 1) {\n                         String msg = TranslationHandler.getString(Collect.getInstance(), R.string.not_exactly_one_record_for_this_instance);\n                         Timber.e(msg);\n                         throw new EncryptionException(msg, null);\n                     }\n                     instanceCursor.moveToFirst();\n-                    String jrFormId = instanceCursor.getString(\n-                            instanceCursor.getColumnIndex(InstanceColumns.JR_FORM_ID));\n+                    formId = instanceCursor.getString(instanceCursor.getColumnIndex(InstanceColumns.JR_FORM_ID));\n                     int idxJrVersion = instanceCursor.getColumnIndex(InstanceColumns.JR_VERSION);\n+                    formVersion = instanceCursor.getString(idxJrVersion);\n                     if (!instanceCursor.isNull(idxJrVersion)) {\n-                        selectionArgs = new String[]{jrFormId, instanceCursor.getString(\n-                                idxJrVersion)};\n-                        selection = FormsColumns.JR_FORM_ID + \" =? AND \" + FormsColumns.JR_VERSION\n-                                + \"=?\";\n+                        selectionArgs = new String[]{formId, instanceCursor.getString(idxJrVersion)};\n+                        selection += FormsColumns.JR_VERSION + \"=?\";\n                     } else {\n-                        selectionArgs = new String[]{jrFormId};\n-                        selection = FormsColumns.JR_FORM_ID + \" =? AND \" + FormsColumns.JR_VERSION\n-                                + \" IS NULL\";\n-                    }\n-                } finally {\n-                    if (instanceCursor != null) {\n-                        instanceCursor.close();\n+                        selectionArgs = new String[]{formId};\n+                        selection += FormsColumns.JR_VERSION + \" IS NULL\";\n                     }\n                 }\n \n                 formCursor = new FormsDao().getFormsCursor(selection, selectionArgs);\n \n-                if (formCursor.getCount() != 1) {\n+                // OK to finalize with form definition that was soft-deleted. OK if there are multiple\n+                // forms with the same formid/version as long as only one is active (not deleted).\n+                if (formCursor.getCount() == 0 || new DatabaseFormsRepository().getAllNotDeleted(formId, formVersion).size() > 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d90c5518053e81b761dee2be51d7ebc7489c3ec"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1ODAyODgxOnYy", "diffSide": "RIGHT", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMzozOTowNFrOH-cGUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNzowNToxNFrOH-nYLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIzNDEzMQ==", "bodyText": "So we can't just use FormsRepository#getAllNotDeleted because we want a different error message here?", "url": "https://github.com/getodk/collect/pull/4261#discussion_r535234131", "createdAt": "2020-12-03T13:39:04Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -594,46 +597,22 @@ private void loadFromIntent(Intent intent) {\n             }\n \n             instancePath = formInfo.getInstancePath();\n+            List<Form> candidateForms = formsRepository.getAll(formInfo.getFormId(), formInfo.getFormVersion());\n \n-            String jrFormId = formInfo.getFormId();\n-            String jrVersion = formInfo.getFormVersion();\n-\n-            String[] selectionArgs;\n-            String selection;\n-            if (jrVersion == null) {\n-                selectionArgs = new String[]{jrFormId};\n-                selection = FormsColumns.JR_FORM_ID + \"=? AND \"\n-                        + FormsColumns.JR_VERSION + \" IS NULL\";\n-            } else {\n-                selectionArgs = new String[]{jrFormId, jrVersion};\n-                selection = FormsColumns.JR_FORM_ID + \"=? AND \"\n-                        + FormsColumns.JR_VERSION + \"=?\";\n-            }\n-\n-            int formCount = FormsDaoHelper.getFormsCount(selection, selectionArgs);\n-            if (formCount < 1) {\n+            if (candidateForms.size() < 1) {\n                 createErrorDialog(getString(\n                         R.string.parent_form_not_present,\n-                        jrFormId)\n-                                + ((jrVersion == null) ? \"\"\n-                                : \"\\n\"\n-                                + getString(R.string.version)\n-                                + \" \"\n-                                + jrVersion),\n+                        formInfo.getFormId())\n+                                + ((formInfo.getFormVersion() == null) ? \"\"\n+                                : \"\\n\" + getString(R.string.version) + \" \" + formInfo.getFormVersion()),\n                         EXIT);\n                 return;\n-            } else {\n-                formPath = FormsDaoHelper.getFormPath(selection, selectionArgs);\n-\n-                /**\n-                 * Still take the first entry, but warn that there are multiple rows. User will\n-                 * need to hand-edit the SQLite database to fix it.\n-                 */\n-                if (formCount > 1) {\n-                    createErrorDialog(getString(R.string.survey_multiple_forms_error), EXIT);\n-                    return;\n-                }\n+            } else if (candidateForms.stream().filter(f -> !f.isDeleted()).count() > 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e5c468367ace3112b2fc1436aed9fdccecebc63"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQxODkyNw==", "bodyText": "(@seadowg and I talked about this but answering for posterity and to double check my thinking)\nThat's right -- the first error case is that there are no forms at all (deleted or not) that match. The second error case is if there are more than one non-deleted that match the formid/version. Basically:\n\nwe're happy to use a soft-deleted form if that's the only one that matches\nwe're happy to have formid/version matches as long as exactly one is non-deleted\n\nSo initially we need to fetch all forms including soft-deleted ones. Then I could have gone back to the db with getAllNotDeleted but filtering the list seemed simpler/more performant.", "url": "https://github.com/getodk/collect/pull/4261#discussion_r535418927", "createdAt": "2020-12-03T17:05:14Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -594,46 +597,22 @@ private void loadFromIntent(Intent intent) {\n             }\n \n             instancePath = formInfo.getInstancePath();\n+            List<Form> candidateForms = formsRepository.getAll(formInfo.getFormId(), formInfo.getFormVersion());\n \n-            String jrFormId = formInfo.getFormId();\n-            String jrVersion = formInfo.getFormVersion();\n-\n-            String[] selectionArgs;\n-            String selection;\n-            if (jrVersion == null) {\n-                selectionArgs = new String[]{jrFormId};\n-                selection = FormsColumns.JR_FORM_ID + \"=? AND \"\n-                        + FormsColumns.JR_VERSION + \" IS NULL\";\n-            } else {\n-                selectionArgs = new String[]{jrFormId, jrVersion};\n-                selection = FormsColumns.JR_FORM_ID + \"=? AND \"\n-                        + FormsColumns.JR_VERSION + \"=?\";\n-            }\n-\n-            int formCount = FormsDaoHelper.getFormsCount(selection, selectionArgs);\n-            if (formCount < 1) {\n+            if (candidateForms.size() < 1) {\n                 createErrorDialog(getString(\n                         R.string.parent_form_not_present,\n-                        jrFormId)\n-                                + ((jrVersion == null) ? \"\"\n-                                : \"\\n\"\n-                                + getString(R.string.version)\n-                                + \" \"\n-                                + jrVersion),\n+                        formInfo.getFormId())\n+                                + ((formInfo.getFormVersion() == null) ? \"\"\n+                                : \"\\n\" + getString(R.string.version) + \" \" + formInfo.getFormVersion()),\n                         EXIT);\n                 return;\n-            } else {\n-                formPath = FormsDaoHelper.getFormPath(selection, selectionArgs);\n-\n-                /**\n-                 * Still take the first entry, but warn that there are multiple rows. User will\n-                 * need to hand-edit the SQLite database to fix it.\n-                 */\n-                if (formCount > 1) {\n-                    createErrorDialog(getString(R.string.survey_multiple_forms_error), EXIT);\n-                    return;\n-                }\n+            } else if (candidateForms.stream().filter(f -> !f.isDeleted()).count() > 1) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIzNDEzMQ=="}, "originalCommit": {"oid": "9e5c468367ace3112b2fc1436aed9fdccecebc63"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1ODAzMDk0OnYy", "diffSide": "RIGHT", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMzozOTozM1rOH-cHoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMzozOTozM1rOH-cHoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIzNDQ2NA==", "bodyText": "Oh wow it feels like this is a big improvement. I'm excited to get this stuff out of the Activity...", "url": "https://github.com/getodk/collect/pull/4261#discussion_r535234464", "createdAt": "2020-12-03T13:39:33Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -594,46 +597,22 @@ private void loadFromIntent(Intent intent) {\n             }\n \n             instancePath = formInfo.getInstancePath();\n+            List<Form> candidateForms = formsRepository.getAll(formInfo.getFormId(), formInfo.getFormVersion());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e5c468367ace3112b2fc1436aed9fdccecebc63"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1ODA0NDM2OnYy", "diffSide": "RIGHT", "path": "collect_app/src/main/java/org/odk/collect/android/forms/FormsRepository.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMzo0MjoxNlrOH-cPSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjoxNTo0OVrOH-3hUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIzNjQyNw==", "bodyText": "Hmmm I think we probably want to be more consistent here and make this a getBy... that returns a list. Maybe the methods that return a single item should be getOne... or findOne...?", "url": "https://github.com/getodk/collect/pull/4261#discussion_r535236427", "createdAt": "2020-12-03T13:42:16Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/forms/FormsRepository.java", "diffHunk": "@@ -12,6 +12,8 @@\n \n     List<Form> getAll();\n \n+    List<Form> getAll(String jrFormId, @Nullable String jrVersion);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e5c468367ace3112b2fc1436aed9fdccecebc63"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM3ODA3Mw==", "bodyText": "getAllByXYZ, getOneByXYZ, getPredicateByXYZ", "url": "https://github.com/getodk/collect/pull/4261#discussion_r535378073", "createdAt": "2020-12-03T16:18:59Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/forms/FormsRepository.java", "diffHunk": "@@ -12,6 +12,8 @@\n \n     List<Form> getAll();\n \n+    List<Form> getAll(String jrFormId, @Nullable String jrVersion);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIzNjQyNw=="}, "originalCommit": {"oid": "9e5c468367ace3112b2fc1436aed9fdccecebc63"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4MzQxMA==", "bodyText": "Thanks, this was a big improvement. Don't hesitate if you want to see more changes here to either add a commit or ask me. I think having a good interface will pay dividends, it was getting confusing in there.", "url": "https://github.com/getodk/collect/pull/4261#discussion_r535683410", "createdAt": "2020-12-03T22:15:49Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/forms/FormsRepository.java", "diffHunk": "@@ -12,6 +12,8 @@\n \n     List<Form> getAll();\n \n+    List<Form> getAll(String jrFormId, @Nullable String jrVersion);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIzNjQyNw=="}, "originalCommit": {"oid": "9e5c468367ace3112b2fc1436aed9fdccecebc63"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1ODA1MDMzOnYy", "diffSide": "RIGHT", "path": "collect_app/src/main/java/org/odk/collect/android/database/DatabaseFormsRepository.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMzo0MzozNVrOH-cS9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjoxOToyMVrOH-3oVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIzNzM2Ng==", "bodyText": "I think we should add tests for these new repo methods so we then know the fake and real implementation have consistent behaviours.", "url": "https://github.com/getodk/collect/pull/4261#discussion_r535237366", "createdAt": "2020-12-03T13:43:35Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/database/DatabaseFormsRepository.java", "diffHunk": "@@ -48,6 +48,15 @@ public DatabaseFormsRepository() {\n         }\n     }\n \n+    @Override\n+    public List<Form> getAll(String jrFormId, @Nullable String jrVersion) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e5c468367ace3112b2fc1436aed9fdccecebc63"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4NTIwNw==", "bodyText": "Thanks for the nudge, that's an improvement.", "url": "https://github.com/getodk/collect/pull/4261#discussion_r535685207", "createdAt": "2020-12-03T22:19:21Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/database/DatabaseFormsRepository.java", "diffHunk": "@@ -48,6 +48,15 @@ public DatabaseFormsRepository() {\n         }\n     }\n \n+    @Override\n+    public List<Form> getAll(String jrFormId, @Nullable String jrVersion) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIzNzM2Ng=="}, "originalCommit": {"oid": "9e5c468367ace3112b2fc1436aed9fdccecebc63"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1ODExMDM0OnYy", "diffSide": "RIGHT", "path": "collect_app/src/test/java/org/odk/collect/android/formmanagement/ServerFormDownloaderTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMzo1NjozNlrOH-c3Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjoxNzo1OFrOH-3lrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI0NjY4Ng==", "bodyText": "Don't want to be too nitpicky about test names but just because this stuff is all kinda confusing I'm wondering if it should be _replacesForm or _doesNotDuplicateForm?", "url": "https://github.com/getodk/collect/pull/4261#discussion_r535246686", "createdAt": "2020-12-03T13:56:36Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/formmanagement/ServerFormDownloaderTest.java", "diffHunk": "@@ -283,6 +284,59 @@ public void whenFormIsSoftDeleted_unDeletesForm() throws Exception {\n         assertThat(formsRepository.get(1L).isDeleted(), is(false));\n     }\n \n+    @Test\n+    public void whenFormWithSameIdAndVersion_butDifferentContentsOnDevice_failsToDownload() throws Exception {\n+        Form form = buildForm(1L, \"form\", \"version\", getFormFilesPath(), \"contents1\").build();\n+        formsRepository.save(form);\n+\n+        ServerFormDetails serverFormDetails = new ServerFormDetails(\n+                form.getDisplayName(),\n+                \"http://downloadUrl\",\n+                null,\n+                form.getJrFormId(),\n+                form.getJrVersion(),\n+                \"differenthash\",\n+                false,\n+                true,\n+                null);\n+\n+        FormSource formSource = mock(FormSource.class);\n+        when(formSource.fetchForm(\"http://downloadUrl\")).thenReturn(new ByteArrayInputStream(\"foo\".getBytes()));\n+\n+        ServerFormDownloader downloader = new ServerFormDownloader(formSource, formsRepository, cacheDir, formsDir.getAbsolutePath(), new FormMetadataParser(ReferenceManager.instance()));\n+\n+        try {\n+            downloader.downloadForm(serverFormDetails, null, null);\n+            fail(\"Expected exception\");\n+        } catch (FormDownloadException e) {\n+            assertThat(e.getMessage(), notNullValue());\n+        }\n+    }\n+\n+    @Test\n+    public void whenFormWithSameIdAndVersion_andSameContentsOnDevice_downloadsSuccessfully() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22d5af393a62d97ef8afb15eae8791a52775f07c"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4NDUyNg==", "bodyText": "I find naming really important so not nitpicking at all!", "url": "https://github.com/getodk/collect/pull/4261#discussion_r535684526", "createdAt": "2020-12-03T22:17:58Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/test/java/org/odk/collect/android/formmanagement/ServerFormDownloaderTest.java", "diffHunk": "@@ -283,6 +284,59 @@ public void whenFormIsSoftDeleted_unDeletesForm() throws Exception {\n         assertThat(formsRepository.get(1L).isDeleted(), is(false));\n     }\n \n+    @Test\n+    public void whenFormWithSameIdAndVersion_butDifferentContentsOnDevice_failsToDownload() throws Exception {\n+        Form form = buildForm(1L, \"form\", \"version\", getFormFilesPath(), \"contents1\").build();\n+        formsRepository.save(form);\n+\n+        ServerFormDetails serverFormDetails = new ServerFormDetails(\n+                form.getDisplayName(),\n+                \"http://downloadUrl\",\n+                null,\n+                form.getJrFormId(),\n+                form.getJrVersion(),\n+                \"differenthash\",\n+                false,\n+                true,\n+                null);\n+\n+        FormSource formSource = mock(FormSource.class);\n+        when(formSource.fetchForm(\"http://downloadUrl\")).thenReturn(new ByteArrayInputStream(\"foo\".getBytes()));\n+\n+        ServerFormDownloader downloader = new ServerFormDownloader(formSource, formsRepository, cacheDir, formsDir.getAbsolutePath(), new FormMetadataParser(ReferenceManager.instance()));\n+\n+        try {\n+            downloader.downloadForm(serverFormDetails, null, null);\n+            fail(\"Expected exception\");\n+        } catch (FormDownloadException e) {\n+            assertThat(e.getMessage(), notNullValue());\n+        }\n+    }\n+\n+    @Test\n+    public void whenFormWithSameIdAndVersion_andSameContentsOnDevice_downloadsSuccessfully() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI0NjY4Ng=="}, "originalCommit": {"oid": "22d5af393a62d97ef8afb15eae8791a52775f07c"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MDkzMzk5OnYy", "diffSide": "RIGHT", "path": "collect_app/src/main/java/org/odk/collect/android/instances/Instance.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjoyMjo0MlrOH-3vFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjoyMjo0MlrOH-3vFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4NjkzNQ==", "bodyText": "This scares me a little bit. It's not in use by Collect code other than in tests and in the method that builds an Instance from a DB record which means the path is already sure to be the correct one. So I think it's safe. But we have to be really careful if we do use it that we pass in the correct path.\nThis mirrors what Form does. I suspect that this had to be changed by @seadowg to test the FormsRepository. Without this change, I always got a crash from this method call when trying to test InstancesRepository. This was not easy to hunt down.", "url": "https://github.com/getodk/collect/pull/4261#discussion_r535686935", "createdAt": "2020-12-03T22:22:42Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/instances/Instance.java", "diffHunk": "@@ -91,7 +91,7 @@ public Builder canEditWhenComplete(boolean canEditWhenComplete) {\n         }\n \n         public Builder instanceFilePath(String instanceFilePath) {\n-            this.instanceFilePath = new StoragePathProvider().getInstanceDbPath(instanceFilePath);\n+            this.instanceFilePath = instanceFilePath;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f6759eca9d687d56d2d95e2756e373ae843b5e4"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MDk1NTQ5OnYy", "diffSide": "RIGHT", "path": "collect_app/src/main/java/org/odk/collect/android/backgroundwork/AutoUpdateTaskSpec.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjoyODo0OVrOH-37Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjoyODo0OVrOH-37Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY5MDA3OA==", "bodyText": "Note: there isn't an easy way to show this message in \"match exactly\" mode as far as I can tell because the FormDownloadException gets converted to a generic FormSourceException. I think those two should probably be consolidated at some point but now didn't feel like the right time.", "url": "https://github.com/getodk/collect/pull/4261#discussion_r535690078", "createdAt": "2020-12-03T22:28:49Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/backgroundwork/AutoUpdateTaskSpec.java", "diffHunk": "@@ -86,7 +87,7 @@\n                                         formDownloader.downloadForm(serverFormDetails, null, null);\n                                         results.put(serverFormDetails, TranslationHandler.getString(context, R.string.success));\n                                     } catch (FormDownloadException e) {\n-                                        results.put(serverFormDetails, TranslationHandler.getString(context, R.string.failure));\n+                                        results.put(serverFormDetails, new FormDownloadExceptionMapper(context).getMessage(e));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67ac1be1e2a501b57228fb1d48a0960d110fb59d"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MDk2MzcwOnYy", "diffSide": "RIGHT", "path": "collect_app/src/test/java/org/odk/collect/android/support/FormUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjozMTowMlrOH-3_5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjozMTowMlrOH-3_5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY5MTIzOA==", "bodyText": "I have no idea why these values ended up being named jrFormId and jrVersion. The irony is that JavaRosa actually has no concept of them, they are only meaningful at the Collect level. They're clearly an ODK form spec thing at least at this point and the jr prefix is confusing.", "url": "https://github.com/getodk/collect/pull/4261#discussion_r535691238", "createdAt": "2020-12-03T22:31:02Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/test/java/org/odk/collect/android/support/FormUtils.java", "diffHunk": "@@ -28,12 +28,12 @@ public static String createXForm(String id, String version) {\n                 \"</h:html>\";\n     }\n \n-    public static Form.Builder buildForm(long id, String jrFormId, String jrVersion, String formFilesPath) {\n-        return buildForm(id, jrFormId, jrVersion, formFilesPath, \"blah\");\n+    public static Form.Builder buildForm(long id, String formId, String version, String formFilesPath) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a002168db27e0b3d5f80659dfd76f612849f1fc7"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MDk2NDc3OnYy", "diffSide": "RIGHT", "path": "collect_app/src/test/java/org/odk/collect/android/support/FormUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjozMToyMlrOH-4AlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjozMToyMlrOH-4AlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY5MTQxMg==", "bodyText": "This is so that we can represent the case where there are two forms with the same id and version.", "url": "https://github.com/getodk/collect/pull/4261#discussion_r535691412", "createdAt": "2020-12-03T22:31:22Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/test/java/org/odk/collect/android/support/FormUtils.java", "diffHunk": "@@ -28,12 +28,12 @@ public static String createXForm(String id, String version) {\n                 \"</h:html>\";\n     }\n \n-    public static Form.Builder buildForm(long id, String jrFormId, String jrVersion, String formFilesPath) {\n-        return buildForm(id, jrFormId, jrVersion, formFilesPath, \"blah\");\n+    public static Form.Builder buildForm(long id, String formId, String version, String formFilesPath) {\n+        return buildForm(id, formId, version, formFilesPath, \"blah\");\n     }\n \n-    public static Form.Builder buildForm(long id, String jrFormId, String jrVersion, String formFilesPath, String xform) {\n-        String fileName = jrFormId + \"-\" + jrVersion;\n+    public static Form.Builder buildForm(long id, String formId, String version, String formFilesPath, String xform) {\n+        String fileName = formId + \"-\" + version + \"-\" + Math.random();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a002168db27e0b3d5f80659dfd76f612849f1fc7"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3189, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}