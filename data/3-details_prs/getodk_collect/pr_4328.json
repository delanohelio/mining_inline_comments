{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyOTkyNjU2", "number": 4328, "title": "Temporarily get global formController from navigation methods", "bodyText": "Temporary fix that should prevent crashes from #4327 while we figure out when the form controller should be set.\nWhat has been done to verify that this works as intended?\nRan tests. Instrumented run: https://console.firebase.google.com/u/0/project/api-project-322300403941/testlab/histories/bh.f6f8331e5ae6e371/matrices/6070831307506522034 when_storageMigrationNotPerformed_shouldBePerformedAutomatically fails but we've seen it be flaky before so I can't imagine it's related.\nWhy is this the best possible solution? Were any other approaches considered?\nI thought #4326 was a pretty good idea but it doesn't work with the way the identity logging works. This made me pretty nervous about any kind of significant change here. This solution should be truly very low risk so I think it's best for now.\nThe other area I've taken an interest in is onResume. It seems like there might be a scenario where the form controller is still set at the App level but the viewmodels had to be recreated. I think in that case formControllerAvailable would never be called. I thought about adding a else if (formController != null) { formControllerAvailable(formController) } to if (formController == null && formLoaderTask.getStatus() == AsyncTask.Status.FINISHED) { but I'm not confident enough that this would be a fix.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nThe only intentional change is preventing a crash when navigation happens. I can't think of any specific risk but everything in this code is tricky. Worst case would be some kind of bad behavior related to navigation.\nDo we need any specific form for testing your changes? If so, please attach one.\nNo.\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nNo.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-12-19T23:34:55Z", "url": "https://github.com/getodk/collect/pull/4328", "merged": true, "mergeCommit": {"oid": "7be72c3513b849e4259b54ddcb51922080660ad9"}, "closed": true, "closedAt": "2020-12-20T21:43:31Z", "author": {"login": "lognaturel"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdn1hiegBqjQxMzI4Njk3OTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdoErsUgFqTU1NjAzNjEwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "97be109349b228fcbc29b1014a501a0648d60c17", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/97be109349b228fcbc29b1014a501a0648d60c17", "committedDate": "2020-12-19T23:30:53Z", "message": "Temporarily pass in formController to navigation methods"}, "afterCommit": {"oid": "8bc2bf526e0f3c43ff88698dc9dde0020772e434", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/8bc2bf526e0f3c43ff88698dc9dde0020772e434", "committedDate": "2020-12-19T23:41:40Z", "message": "Temporarily pass in formController to navigation methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec2564380951652ec69d18a451faf29d609436ef", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/ec2564380951652ec69d18a451faf29d609436ef", "committedDate": "2020-12-20T05:04:36Z", "message": "Temporarily pass in formController to navigation methods"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8bc2bf526e0f3c43ff88698dc9dde0020772e434", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/8bc2bf526e0f3c43ff88698dc9dde0020772e434", "committedDate": "2020-12-19T23:41:40Z", "message": "Temporarily pass in formController to navigation methods"}, "afterCommit": {"oid": "ec2564380951652ec69d18a451faf29d609436ef", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/ec2564380951652ec69d18a451faf29d609436ef", "committedDate": "2020-12-20T05:04:36Z", "message": "Temporarily pass in formController to navigation methods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1OTg3MDQ3", "url": "https://github.com/getodk/collect/pull/4328#pullrequestreview-555987047", "createdAt": "2020-12-20T05:19:32Z", "commit": {"oid": "ec2564380951652ec69d18a451faf29d609436ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMFQwNToxOTozM1rOIJA92g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMFQwNToxOTozM1rOIJA92g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjMyMzkzMA==", "bodyText": "All the subsequent calls end up using the parameter value. I assume that the singleton form controller is more likely to be the true, authoritative one. It might be possible for the ViewModels' form controllers to be set but not the same as the singleton (though I really hope not).", "url": "https://github.com/getodk/collect/pull/4328#discussion_r546323930", "createdAt": "2020-12-20T05:19:33Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/FormEntryViewModel.java", "diffHunk": "@@ -125,7 +127,12 @@ public boolean canAddRepeat() {\n         }\n     }\n \n-    public void moveForward() {\n+    public void moveForward(FormController formController) {\n+        if (this.formController == null) {\n+            Timber.w(\"Null formController\");\n+            this.formController = formController;\n+        }\n+\n         try {\n             formController.stepToNextScreenEvent();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec2564380951652ec69d18a451faf29d609436ef"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MDExMzEx", "url": "https://github.com/getodk/collect/pull/4328#pullrequestreview-556011311", "createdAt": "2020-12-20T12:02:57Z", "commit": {"oid": "ec2564380951652ec69d18a451faf29d609436ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMFQxMjowMjo1OFrOIJDnMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMFQxMjowMjo1OFrOIJDnMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2NzI4Mw==", "bodyText": "I'm thinking instead of passing FormController in here we could just grab the singleton and then wrap that in an requireFormController method. That way we're not having to change the signature so hopefully not leaving anything around we'll want to take out later.\nIn my head, if this all worked nicely the structure would actually be pretty similar anyway:  the form load and the resulting FormController would be grabbed on demand from a cache anyway (but keyed/bucketed by the form entry session rather than an application singleton) so I could see us ending up with a structure where any method that needs it in the ViewModel just loads it in lazily.\nI'll have a go at adding that in and push to this, and then we can discuss later.", "url": "https://github.com/getodk/collect/pull/4328#discussion_r546367283", "createdAt": "2020-12-20T12:02:58Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/FormEntryViewModel.java", "diffHunk": "@@ -125,7 +127,12 @@ public boolean canAddRepeat() {\n         }\n     }\n \n-    public void moveForward() {\n+    public void moveForward(FormController formController) {\n+        if (this.formController == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec2564380951652ec69d18a451faf29d609436ef"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e762a704389fd1fe3e26ead6b6b8200529ec24c", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/2e762a704389fd1fe3e26ead6b6b8200529ec24c", "committedDate": "2020-12-20T12:18:09Z", "message": "Use FormController singleton instead of passing it in"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MDEyNTE5", "url": "https://github.com/getodk/collect/pull/4328#pullrequestreview-556012519", "createdAt": "2020-12-20T12:19:16Z", "commit": {"oid": "2e762a704389fd1fe3e26ead6b6b8200529ec24c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMFQxMjoxOToxNlrOIJDvAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMFQxMjoxOToxNlrOIJDvAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2OTI4Mg==", "bodyText": "I'm wondering if we want to add any more logging here. It'd be great to try and get as much detail as possible when this happens.", "url": "https://github.com/getodk/collect/pull/4328#discussion_r546369282", "createdAt": "2020-12-20T12:19:16Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/FormEntryViewModel.java", "diffHunk": "@@ -168,6 +176,13 @@ private String getFormIdentifierHash() {\n         }\n     }\n \n+    private void ensureFormController() {\n+        if (this.formController == null) {\n+            Timber.w(\"Null formController\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e762a704389fd1fe3e26ead6b6b8200529ec24c"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dd9a8cccc04b68ab4eafe2f9e9105f396f1e8b6", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/5dd9a8cccc04b68ab4eafe2f9e9105f396f1e8b6", "committedDate": "2020-12-20T14:36:57Z", "message": "Add logging to confirm pendingActivityResult branch is the problem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acab6deae09b229e1701b46250dc8756ba88efe9", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/acab6deae09b229e1701b46250dc8756ba88efe9", "committedDate": "2020-12-20T16:35:28Z", "message": "Add logging in onResume"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MDM0ODcw", "url": "https://github.com/getodk/collect/pull/4328#pullrequestreview-556034870", "createdAt": "2020-12-20T17:05:04Z", "commit": {"oid": "acab6deae09b229e1701b46250dc8756ba88efe9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMFQxNzowNTowNVrOIJFzZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMFQxNzowNTowNVrOIJFzZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQwMzE3NA==", "bodyText": "I'm not sure if I like this...\nAs I understand it's added to avoid NPE's in cases where we forget to set formController right?\nso in collect if we call (in FormEntryActivity):\nCollect.getInstance().setFormController(formController);\nformControllerAvailable(formController);\n\nit's not needed. It's needed if we forget the second line?\nI'm not sure if it makes a lot of sense. We also might forget to call the first line then: (used in this method)\nCollect.getInstance().getFormController();\nwill return null.\nso it's still not a perfect way to avoid human mistakes. Additionally it makes the code more coupled.", "url": "https://github.com/getodk/collect/pull/4328#discussion_r546403174", "createdAt": "2020-12-20T17:05:05Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/FormEntryViewModel.java", "diffHunk": "@@ -168,6 +180,13 @@ private String getFormIdentifierHash() {\n         }\n     }\n \n+    private void ensureFormController() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acab6deae09b229e1701b46250dc8756ba88efe9"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MDM2MDEy", "url": "https://github.com/getodk/collect/pull/4328#pullrequestreview-556036012", "createdAt": "2020-12-20T17:20:19Z", "commit": {"oid": "acab6deae09b229e1701b46250dc8756ba88efe9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMFQxNzoyMDoxOVrOIJF6Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMFQxNzoyMDoxOVrOIJF6Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQwNDg5NA==", "bodyText": "Is this not really likely on opening a form as onResume would usually happen before loadingComplete (as the latter only gets called after the background task is finished)?", "url": "https://github.com/getodk/collect/pull/4328#discussion_r546404894", "createdAt": "2020-12-20T17:20:19Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2100,6 +2100,10 @@ protected void onResume() {\n \n         FormController formController = getFormController();\n \n+        if (formController != null && !formEntryViewModel.isFormControllerSet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acab6deae09b229e1701b46250dc8756ba88efe9"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MDM2MTA5", "url": "https://github.com/getodk/collect/pull/4328#pullrequestreview-556036109", "createdAt": "2020-12-20T17:21:33Z", "commit": {"oid": "acab6deae09b229e1701b46250dc8756ba88efe9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2391, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}