{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1NzA0MTQx", "number": 3698, "title": "Rebuild the mappable instance list when the map view is shown to reflect deleted geopoint", "bodyText": "Closes #3696\nWhat has been done to verify that this works as intended?\nManually verified case from issue. Added and ran automated test.\nWhy is this the best possible solution? Were any other approaches considered?\nI went to the trouble of commenting that we could skip rebuilding the mappable instance list unless the instance count changed but that is not accurate. When geometry is removed, the instance count is the same. I considered trying to do something more clever like keeping track of which instance was opened since that's the only one that could change but I don't think it's worth it for now given the complexity it would add. If folks have a lot of submissions, this code will become a performance problem, I think, since it has to do some json parsing for each point. We can revisit it if we have evidence of users having problems.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nThis now rebuilds the mappable instance list each time the form map activity is displayed. The intentional change is fixing the bug. There's also likely a performance hit for very large numbers of submissions. Risk is only in the map view.\nDo we need any specific form for testing your changes? If so, please attach one.\nAny form with a geopoint such as All Widgets.\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nNo.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-03-09T16:58:48Z", "url": "https://github.com/getodk/collect/pull/3698", "merged": true, "mergeCommit": {"oid": "badfc67290975c7c375ac8105b023e8ba2408526"}, "closed": true, "closedAt": "2020-03-10T09:13:49Z", "author": {"login": "lognaturel"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMA63MAH2gAyMzg1NzA0MTQxOjM2NDUyNzkzN2E0YjhmNjM4NmM4MWZkZWM0ZjRmNDRmNDE2YjE5ZWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMBXVdAFqTM3MTM4NDA1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "364527937a4b8f6386c81fdec4f4f44f416b19ea", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/364527937a4b8f6386c81fdec4f4f44f416b19ea", "committedDate": "2020-03-09T16:57:28Z", "message": "Add test that fails when geometry is cleared"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fe1622dfa254194478bf0c1dca38fc89b0212f5", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/1fe1622dfa254194478bf0c1dca38fc89b0212f5", "committedDate": "2020-03-09T16:57:28Z", "message": "Build mappable instance list every time"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMzgzNDQy", "url": "https://github.com/getodk/collect/pull/3698#pullrequestreview-371383442", "createdAt": "2020-03-09T17:27:53Z", "commit": {"oid": "1fe1622dfa254194478bf0c1dca38fc89b0212f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNzoyNzo1NFrOFzyP7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNzoyNzo1NFrOFzyP7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0NDk3Mg==", "bodyText": "I'm wondering if this test could be made a little simpler if it was just getMappableFormInstances_alwaysReturnsUpToDateInstances(). If the TestInstancesRepository had a method that let you switch out the list of instances you could change instances in the repo that way and then check getMappableFormInstances", "url": "https://github.com/getodk/collect/pull/3698#discussion_r389844972", "createdAt": "2020-03-09T17:27:54Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/activities/FormMapViewModelTest.java", "diffHunk": "@@ -133,6 +133,30 @@\n         assertThat(instances.get(6).getClickAction(), is(FormMapViewModel.ClickAction.OPEN_EDIT));\n     }\n \n+    @Test public void clearingInstanceGeometry_isReflectedInInstanceCountsAndList() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1fe1622dfa254194478bf0c1dca38fc89b0212f5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMzg0MDUx", "url": "https://github.com/getodk/collect/pull/3698#pullrequestreview-371384051", "createdAt": "2020-03-09T17:28:34Z", "commit": {"oid": "1fe1622dfa254194478bf0c1dca38fc89b0212f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2339, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}