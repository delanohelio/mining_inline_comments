{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyMzA4NjM3", "number": 4168, "title": "Rework `AudioWidget` view/flow and extract module for playing audio", "bodyText": "Blocked by #4171\n\nThis changes the Audio widget to match the flow mocked up at https://github.com/seadowg/collect-design/tree/master/prototypes/in-app-audio-recording. There are two key behaviour changes:\n\nThe \"Choose Sound\" and \"Record Sound\" button will be hidden once the question has been answered\nThe audio controller Card now has a \"Remove response\" action that lets the enumerator clear the answer and start again\n\nThis PR also extracts some key audio code to its own Gradle module (and converts it to Kotlin \ud83c\udf89) and introduces a new approach for the widget to interact with the \"audio player\" code that's closer to the way other integrations with widgets have been looking recently.\nWhat has been done to verify that this works as intended?\nA bunch of new tests and played around with the audio widget manually.\nWhy is this the best possible solution? Were any other approaches considered?\nComments inline.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nIntended behaviour changes are up above but it'd be good to put the audio widget through its paces.\nDo we need any specific form for testing your changes? If so, please attach one.\nAny form with audio questions.\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nWe should potentially update screenshots but I'm not sure we need docs updates yet.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-10-13T13:25:08Z", "url": "https://github.com/getodk/collect/pull/4168", "merged": true, "mergeCommit": {"oid": "2cc77d417202bf83103b07dd40a37df1cee8fd1c"}, "closed": true, "closedAt": "2020-10-19T17:57:35Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 47, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSIzB3gFqTUwNzQ0OTQ4Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUICGHgFqTUxMjAyMTc2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDQ5NDgz", "url": "https://github.com/getodk/collect/pull/4168#pullrequestreview-507449483", "createdAt": "2020-10-13T13:42:51Z", "commit": {"oid": "c95133fcc205e5f50e83f83f8e0e2cd2b806d117"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzo0Mjo1MVrOHgnbDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzo0Mjo1MVrOHgnbDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk2MjM4MA==", "bodyText": "We ended up having test helpers that weren't specific to our \"app code\" so moved some of that here, so we're not repeating anything.", "url": "https://github.com/getodk/collect/pull/4168#discussion_r503962380", "createdAt": "2020-10-13T13:42:51Z", "author": {"login": "seadowg"}, "path": "collect_app/build.gradle", "diffHunk": "@@ -310,6 +311,7 @@ dependencies {\n     testImplementation \"junit:junit:4.13\"\n     testImplementation \"org.mockito:mockito-core:3.5.11\"\n \n+    testImplementation project(path: ':test-shared')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c95133fcc205e5f50e83f83f8e0e2cd2b806d117"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDUwNTk1", "url": "https://github.com/getodk/collect/pull/4168#pullrequestreview-507450595", "createdAt": "2020-10-13T13:43:53Z", "commit": {"oid": "c95133fcc205e5f50e83f83f8e0e2cd2b806d117"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzo0Mzo1NFrOHgneYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzo0Mzo1NFrOHgneYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk2MzIzNQ==", "bodyText": "Just did a straight replacement of Butterknife with view binding here.", "url": "https://github.com/getodk/collect/pull/4168#discussion_r503963235", "createdAt": "2020-10-13T13:43:54Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/audio/AudioControllerView.java", "diffHunk": "@@ -24,64 +26,65 @@\n import org.joda.time.DateTime;\n import org.joda.time.DateTimeZone;\n import org.odk.collect.android.R;\n-\n-import butterknife.BindView;\n-import butterknife.ButterKnife;\n-import butterknife.OnClick;\n-import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import org.odk.collect.android.databinding.AudioControllerLayoutBinding;\n \n import static java.lang.Math.max;\n import static java.lang.Math.min;\n \n public class AudioControllerView extends FrameLayout {\n \n-    @BindView(R.id.currentDuration)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c95133fcc205e5f50e83f83f8e0e2cd2b806d117"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDUzNDY0", "url": "https://github.com/getodk/collect/pull/4168#pullrequestreview-507453464", "createdAt": "2020-10-13T13:46:36Z", "commit": {"oid": "c95133fcc205e5f50e83f83f8e0e2cd2b806d117"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzo0NjozNlrOHgnmhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzo0NjozNlrOHgnmhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk2NTMxOQ==", "bodyText": "I wanted to avoid using LiveData inside View components as it means we need to pass them some kind of lifecycle to use for observations. This approach lets us use a more standard listener hook in the View but lets us use LiveData as the implementation so we have lifecycle awareness.", "url": "https://github.com/getodk/collect/pull/4168#discussion_r503965319", "createdAt": "2020-10-13T13:46:36Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/AudioPlayer.java", "diffHunk": "@@ -0,0 +1,20 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import org.odk.collect.audioclips.Clip;\n+\n+import java.util.function.Consumer;\n+\n+public interface AudioPlayer {\n+\n+    void play(Clip clip);\n+\n+    void pause();\n+\n+    void setPosition(String clipId, Integer position);\n+\n+    void onPlayingChanged(String clipID, Consumer<Boolean> playingConsumer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c95133fcc205e5f50e83f83f8e0e2cd2b806d117"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDU0NzE0", "url": "https://github.com/getodk/collect/pull/4168#pullrequestreview-507454714", "createdAt": "2020-10-13T13:47:50Z", "commit": {"oid": "c95133fcc205e5f50e83f83f8e0e2cd2b806d117"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzo0Nzo1MFrOHgnqig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzo0Nzo1MFrOHgnqig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk2NjM0Ng==", "bodyText": "We should be able to swap this implementation with another one for internal recording", "url": "https://github.com/getodk/collect/pull/4168#discussion_r503966346", "createdAt": "2020-10-13T13:47:50Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/ExternalAppAudioDataRequester.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import android.app.Activity;\n+import android.content.Intent;\n+import android.provider.MediaStore;\n+import android.widget.Toast;\n+\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.listeners.PermissionListener;\n+import org.odk.collect.android.utilities.ActivityAvailability;\n+import org.odk.collect.android.utilities.ApplicationConstants;\n+import org.odk.collect.android.utilities.PermissionUtils;\n+\n+public class ExternalAppAudioDataRequester implements AudioDataRequester {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c95133fcc205e5f50e83f83f8e0e2cd2b806d117"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDYyODg4", "url": "https://github.com/getodk/collect/pull/4168#pullrequestreview-507462888", "createdAt": "2020-10-13T13:55:43Z", "commit": {"oid": "622e0a6a85fc428f94e0b7c325743c20c13a8c7e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzo1NTo0M1rOHgoDdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzo1NTo0M1rOHgoDdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk3MjcyNg==", "bodyText": "I definitely could have removed this everywhere but it felt like it would be pretty time intensive and actually pretty isolated from what I was working on. We can come back for this next time we touch anything in the neighbourhood.", "url": "https://github.com/getodk/collect/pull/4168#discussion_r503972726", "createdAt": "2020-10-13T13:55:43Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/audio/AudioHelper.java", "diffHunk": "@@ -31,21 +33,26 @@\n  * construct multiple instances (within a {@link android.view.View} or\n  * {@link androidx.fragment.app.Fragment} for instance) if needed within one\n  * {@link android.app.Activity}.\n+ *\n+ * @deprecated wrapping the ViewModel like this doesn't really fit with other ways we've integrated\n+ * widgets with \"external\" services. Instead of this widgets should talk to {@link AudioPlayer}\n+ * and the Activity/Fragment components should talk to the ViewModel itself.\n  */\n \n+@Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "622e0a6a85fc428f94e0b7c325743c20c13a8c7e"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDY0MDg4", "url": "https://github.com/getodk/collect/pull/4168#pullrequestreview-507464088", "createdAt": "2020-10-13T13:56:50Z", "commit": {"oid": "622e0a6a85fc428f94e0b7c325743c20c13a8c7e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzo1Njo1MFrOHgoHAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzo1Njo1MFrOHgoHAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk3MzYzNQ==", "bodyText": "This now uses a predictable ID for the clip. I think before I wasn't as clued up on the structure of the form. Not quite sure why we went with random IDs", "url": "https://github.com/getodk/collect/pull/4168#discussion_r503973635", "createdAt": "2020-10-13T13:56:50Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/AudioWidget.java", "diffHunk": "@@ -157,83 +112,116 @@ public IAnswerData getAnswer() {\n     }\n \n     /**\n-     * Set this widget with the actual file returned by OnActivityResult.\n-     * Both of Uri and File are supported.\n-     * If the file is local, a Uri is enough for the copy task below.\n-     * If the chose file is from cloud(such as Google Drive),\n-     * The retrieve and copy task is already executed in the previous step,\n-     * so a File object would be presented.\n-     *\n-     * @param object Uri or File of the chosen file.\n-     * @see org.odk.collect.android.activities.FormEntryActivity#onActivityResult(int, int, Intent)\n+     * @param object file name of media file that will be available in the {@link QuestionMediaManager}\n+     * @see org.odk.collect.android.activities.FormEntryActivity\n      */\n     @Override\n     public void setBinaryData(Object object) {\n-        File newAudio;\n-        // get the file path and create a copy in the instance folder\n-        if (object instanceof Uri) {\n-            String sourcePath = getSourcePathFromUri((Uri) object);\n-            String destinationPath = FileWidgetUtils.getDestinationPathFromSourcePath(sourcePath, getInstanceFolder(), fileUtil);\n-            File source = fileUtil.getFileAtPath(sourcePath);\n-            newAudio = fileUtil.getFileAtPath(destinationPath);\n-            fileUtil.copyFile(source, newAudio);\n-        } else if (object instanceof File) {\n-            // Getting a file indicates we've done the copy in the before step\n-            newAudio = (File) object;\n-        } else {\n-            Timber.w(\"AudioWidget's setBinaryData must receive a File or Uri object.\");\n-            return;\n+        // Support being handed a File as well\n+        if (object instanceof File) {\n+            object = (String) ((File) object).getName();\n         }\n \n-        if (newAudio.exists()) {\n-            // Add the copy to the content provider\n-            ContentValues values = new ContentValues(6);\n-            values.put(Audio.Media.TITLE, newAudio.getName());\n-            values.put(Audio.Media.DISPLAY_NAME, newAudio.getName());\n-            values.put(Audio.Media.DATE_ADDED, System.currentTimeMillis());\n-            values.put(Audio.Media.DATA, newAudio.getAbsolutePath());\n-\n-            questionMediaManager.replaceRecentFileForQuestion(getFormEntryPrompt().getIndex().toString(), newAudio.getAbsolutePath());\n-\n-            Uri audioURI = getContext().getContentResolver().insert(Audio.Media.EXTERNAL_CONTENT_URI, values);\n-\n-            if (audioURI != null) {\n-                Timber.i(\"Inserting AUDIO returned uri = %s\", audioURI.toString());\n-            }\n-\n-            // when replacing an answer. remove the current media.\n-            if (binaryName != null && !binaryName.equals(newAudio.getName())) {\n-                deleteFile();\n+        if (object instanceof String) {\n+            String fileName = (String) object;\n+            File newAudio = questionMediaManager.getAnswerFile(fileName);\n+\n+            if (newAudio != null && newAudio.exists()) {\n+                // Add the copy to the content provider\n+                ContentValues values = new ContentValues(6);\n+                values.put(Audio.Media.TITLE, newAudio.getName());\n+                values.put(Audio.Media.DISPLAY_NAME, newAudio.getName());\n+                values.put(Audio.Media.DATE_ADDED, System.currentTimeMillis());\n+                values.put(Audio.Media.DATA, newAudio.getAbsolutePath());\n+\n+                questionMediaManager.replaceAnswerFile(getFormEntryPrompt().getIndex().toString(), newAudio.getAbsolutePath());\n+                Uri audioURI = getContext().getContentResolver().insert(Audio.Media.EXTERNAL_CONTENT_URI, values);\n+\n+                if (audioURI != null) {\n+                    Timber.i(\"Inserting AUDIO returned uri = %s\", audioURI.toString());\n+                }\n+\n+                // when replacing an answer. remove the current media.\n+                if (binaryName != null && !binaryName.equals(newAudio.getName())) {\n+                    deleteFile();\n+                }\n+\n+                binaryName = newAudio.getName();\n+                Timber.i(\"Setting current answer to %s\", newAudio.getName());\n+\n+                hideButtonsIfNeeded();\n+                updatePlayerMedia();\n+                widgetValueChanged();\n+            } else {\n+                Timber.e(\"Inserting Audio file FAILED\");\n             }\n-\n-            binaryName = newAudio.getName();\n-            Timber.i(\"Setting current answer to %s\", newAudio.getName());\n-\n-            widgetValueChanged();\n-            updatePlayerMedia();\n         } else {\n-            Timber.e(\"Inserting Audio file FAILED\");\n+            Timber.w(\"AudioWidget's setBinaryData must receive a File object.\");\n+            return;\n         }\n     }\n \n     private void hideButtonsIfNeeded() {\n-        if (getFormEntryPrompt().getAppearanceHint() != null\n-                && getFormEntryPrompt().getAppearanceHint().toLowerCase(Locale.ENGLISH).contains(WidgetAppearanceUtils.NEW)) {\n+        if (getAnswer() == null) {\n+            binding.captureButton.setVisibility(View.VISIBLE);\n+            binding.chooseButton.setVisibility(View.VISIBLE);\n+            binding.audioController.setVisibility(View.GONE);\n+        } else {\n+            binding.captureButton.setVisibility(View.GONE);\n+            binding.chooseButton.setVisibility(View.GONE);\n+            binding.audioController.setVisibility(View.VISIBLE);\n+        }\n+\n+        if (getFormEntryPrompt().isReadOnly()) {\n+            binding.captureButton.setVisibility(View.GONE);\n+            binding.chooseButton.setVisibility(View.GONE);\n+        }\n+\n+        if (getFormEntryPrompt().getAppearanceHint() != null && getFormEntryPrompt().getAppearanceHint().toLowerCase(Locale.ENGLISH).contains(WidgetAppearanceUtils.NEW)) {\n             binding.chooseButton.setVisibility(View.GONE);\n         }\n     }\n \n     private void updatePlayerMedia() {\n         if (binaryName != null) {\n-            audioHelper.setAudio(audioController, new Clip(String.valueOf(ViewCompat.generateViewId()), getAudioFile().getAbsolutePath()));\n-            audioController.showPlayer();\n+            Clip clip = new Clip(\"audio:\" + getFormEntryPrompt().getIndex().toString(), getAudioFile().getAbsolutePath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "622e0a6a85fc428f94e0b7c325743c20c13a8c7e"}, "originalPosition": 280}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDY0NDc4", "url": "https://github.com/getodk/collect/pull/4168#pullrequestreview-507464478", "createdAt": "2020-10-13T13:57:12Z", "commit": {"oid": "622e0a6a85fc428f94e0b7c325743c20c13a8c7e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzo1NzoxMlrOHgoILg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzo1NzoxMlrOHgoILg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk3MzkzNA==", "bodyText": "I have really missed apply", "url": "https://github.com/getodk/collect/pull/4168#discussion_r503973934", "createdAt": "2020-10-13T13:57:12Z", "author": {"login": "seadowg"}, "path": "test-shared/src/main/java/org/odk/collect/testshared/FakeLifecycleOwner.kt", "diffHunk": "@@ -0,0 +1,20 @@\n+package org.odk.collect.testshared\n+\n+import androidx.lifecycle.Lifecycle\n+import androidx.lifecycle.LifecycleOwner\n+import androidx.lifecycle.LifecycleRegistry\n+\n+class FakeLifecycleOwner : LifecycleOwner {\n+\n+    private val lifecycle = LifecycleRegistry(this).apply {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "622e0a6a85fc428f94e0b7c325743c20c13a8c7e"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNjcxNTgx", "url": "https://github.com/getodk/collect/pull/4168#pullrequestreview-510671581", "createdAt": "2020-10-16T17:33:11Z", "commit": {"oid": "739c0c20f995300e11bbc36da33f9354a1c6d1b8"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNzozMzoxMVrOHjJyUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMTowNDo0NFrOHjPx4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYyMjU0Nw==", "bodyText": "Will need to pull in references for these numbers once the string module PR is merged.", "url": "https://github.com/getodk/collect/pull/4168#discussion_r506622547", "createdAt": "2020-10-16T17:33:11Z", "author": {"login": "lognaturel"}, "path": "test-shared/build.gradle", "diffHunk": "@@ -0,0 +1,45 @@\n+apply plugin: 'com.android.library'\n+apply plugin: 'kotlin-android'\n+apply plugin: 'kotlin-android-extensions'\n+\n+android {\n+    compileSdkVersion 30\n+    buildToolsVersion \"30.0.0\"\n+\n+    defaultConfig {\n+        minSdkVersion 21\n+        targetSdkVersion 30", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "739c0c20f995300e11bbc36da33f9354a1c6d1b8"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYzNzYwMg==", "bodyText": "Feels like this should be separate? But I suppose that can be discovered later once there are multiple implementations for recording.", "url": "https://github.com/getodk/collect/pull/4168#discussion_r506637602", "createdAt": "2020-10-16T17:58:01Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/AudioDataRequester.java", "diffHunk": "@@ -4,4 +4,6 @@\n \n public interface AudioDataRequester {\n     void requestRecording(FormEntryPrompt prompt);\n+\n+    void requestFile(FormEntryPrompt prompt);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ca185546c3f5cb7a39187070563cb5fe8aad325"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY1MjYzMQ==", "bodyText": "Note to come back and set these to shared vars once the strings module pr is merged.", "url": "https://github.com/getodk/collect/pull/4168#discussion_r506652631", "createdAt": "2020-10-16T18:28:10Z", "author": {"login": "lognaturel"}, "path": "audioclips/build.gradle", "diffHunk": "@@ -0,0 +1,49 @@\n+apply plugin: 'com.android.library'\n+apply plugin: 'kotlin-android'\n+apply plugin: 'kotlin-android-extensions'\n+\n+android {\n+    compileSdkVersion 29\n+    buildToolsVersion \"30.0.0\"\n+\n+    defaultConfig {\n+        minSdkVersion 21", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "622e0a6a85fc428f94e0b7c325743c20c13a8c7e"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY1MzU5OQ==", "bodyText": "We don't allow wildcard imports typically. Is this going through because it's Kotlin or because the style checks aren't applied? I do think explicit imports can avoid errors and are worth it.", "url": "https://github.com/getodk/collect/pull/4168#discussion_r506653599", "createdAt": "2020-10-16T18:30:10Z", "author": {"login": "lognaturel"}, "path": "audioclips/src/main/java/org/odk/collect/audioclips/AudioClipViewModel.kt", "diffHunk": "@@ -0,0 +1,203 @@\n+package org.odk.collect.audioclips\n+\n+import android.media.MediaPlayer\n+import androidx.lifecycle.*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "622e0a6a85fc428f94e0b7c325743c20c13a8c7e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY2MzM0NQ==", "bodyText": "It feels weird for the module and package names to be mismatched. Is that intentional? So far all modules have matching package names. Except for collect_app, I suppose.", "url": "https://github.com/getodk/collect/pull/4168#discussion_r506663345", "createdAt": "2020-10-16T18:50:57Z", "author": {"login": "lognaturel"}, "path": "test-shared/src/main/java/org/odk/collect/testshared/FakeScheduler.kt", "diffHunk": "@@ -0,0 +1,65 @@\n+package org.odk.collect.testshared", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "622e0a6a85fc428f94e0b7c325743c20c13a8c7e"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcyMDczOQ==", "bodyText": "These tests about deleting/replacing media files are good to have. This behavior is hard to reason about and I don't see any context for what it's for anywhere. Maybe you could put these tests in a region and just say something like \"we want to be able to go back to the exact state we were in at the last save if a user exits an instance without saving. This means keeping track of any media files that were previously attached so they can be restored.\" Alternately something like that could go above the two maps in FormSaveViewModel used for that purpose.\nAlso this save and discard changes behavior would be good for QA to check once the audio rework is complete. Want to keep a list like you did for the match exactly feature?", "url": "https://github.com/getodk/collect/pull/4168#discussion_r506720739", "createdAt": "2020-10-16T21:04:44Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -390,25 +394,50 @@ public void resumeFormEntry_clearsSaveResult() {\n     }\n \n     @Test\n-    public void markOriginalFileOrDelete_whenQuestionIndexHasAnswer_onRecreatingViewModel_deletesFile() {\n-        viewModel.markOriginalFileOrDelete(\"index\", \"blah\");\n+    public void deleteAnswerFile_whenFileHasAlreadyBeenDeleted_actuallyDeletesNewFile() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "622e0a6a85fc428f94e0b7c325743c20c13a8c7e"}, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "622e0a6a85fc428f94e0b7c325743c20c13a8c7e", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/622e0a6a85fc428f94e0b7c325743c20c13a8c7e", "committedDate": "2020-10-13T13:52:48Z", "message": "Convert test-shared to kotlin"}, "afterCommit": {"oid": "955e0947c2457170c71696d8863e5cdc5b6b1972", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/955e0947c2457170c71696d8863e5cdc5b6b1972", "committedDate": "2020-10-19T10:30:05Z", "message": "Add Kotlin style checks and fix failing checks\n\nThis adds ktlint which appears to be the most popular checker."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "26b9501b646e795fa3cc3bc86ecb5f557424bc73", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/26b9501b646e795fa3cc3bc86ecb5f557424bc73", "committedDate": "2020-10-19T10:38:01Z", "message": "Correct module name for CI label"}, "afterCommit": {"oid": "03a5de012a2252b26d5e741310e70a66f423e098", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/03a5de012a2252b26d5e741310e70a66f423e098", "committedDate": "2020-10-19T11:30:11Z", "message": "Use variables for dependency version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad9990ce167216da8cfaab9d4c2756d3d3291848", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/ad9990ce167216da8cfaab9d4c2756d3d3291848", "committedDate": "2020-10-19T14:02:14Z", "message": "Wrap AudioPlayerViewModel in interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89bfca6a368f4d3c95627474488bfa87de208ca0", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/89bfca6a368f4d3c95627474488bfa87de208ca0", "committedDate": "2020-10-19T14:02:14Z", "message": "Remove LiveData from AudioPlayer so views don't need access to lifecycle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fcaa4c988be47da0618900c4e27572d3dba6a72", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/0fcaa4c988be47da0618900c4e27572d3dba6a72", "committedDate": "2020-10-19T14:02:15Z", "message": "Rename viewmodel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4838f5c885d4e866b702a696790a2cd43faff84", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/b4838f5c885d4e866b702a696790a2cd43faff84", "committedDate": "2020-10-19T14:02:15Z", "message": "Pull audio view model into its own module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7cdf460699867c2331060f3f191acf1ec6e636a", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/f7cdf460699867c2331060f3f191acf1ec6e636a", "committedDate": "2020-10-19T14:02:15Z", "message": "Convert audioclips code to Kotlin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a75bcaad5c660b685c4bd542cb0bc4679d2b08c6", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/a75bcaad5c660b685c4bd542cb0bc4679d2b08c6", "committedDate": "2020-10-19T14:02:15Z", "message": "Clean up weirdness introduced in Kotlin conversion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd662191b53f484731c52c8aa370868e6e054546", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/fd662191b53f484731c52c8aa370868e6e054546", "committedDate": "2020-10-19T14:02:15Z", "message": "Create test-shared to handle shared test code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "baafad517ef4e35e16ddec7521bfac82b923b645", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/baafad517ef4e35e16ddec7521bfac82b923b645", "committedDate": "2020-10-19T14:02:16Z", "message": "Convert tests to Kotlin and remove Robolectric"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a37b6b2adc99dbdb35e54029d0ee7e32d828564", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/4a37b6b2adc99dbdb35e54029d0ee7e32d828564", "committedDate": "2020-10-19T14:02:16Z", "message": "Fix test-shared imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e5fba7bf5969cc686e0130509911672ec8903c3", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/5e5fba7bf5969cc686e0130509911672ec8903c3", "committedDate": "2020-10-19T14:02:16Z", "message": "Remove ButterKnife from AudioControllerView"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "020fb3076e3ada9e12c226191f4f269a71994dc3", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/020fb3076e3ada9e12c226191f4f269a71994dc3", "committedDate": "2020-10-19T14:02:16Z", "message": "Move testing of Audio Controller playback\n\nInstead of the integration test (which was very useful during development of the\nfeature) we now test the functionality between AudioWidgetTest, AudioControllerViewTest\nand AudioClipViewModel. This makes it clearer where responsiblities lie and means we don't\nneed the AudioHelper object for this feature."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84da323bcc732a57918def19dd8a4c832843c53c", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/84da323bcc732a57918def19dd8a4c832843c53c", "committedDate": "2020-10-19T14:02:16Z", "message": "Deprecate AudioHelper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a9b356d2800764f554a0f09bea6374b949b8215", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/8a9b356d2800764f554a0f09bea6374b949b8215", "committedDate": "2020-10-19T14:02:17Z", "message": "Extract logic that starts audio recording Activity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b261bb447fbc1c1ac1f29f3eb73a5cdc246cbfb", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/6b261bb447fbc1c1ac1f29f3eb73a5cdc246cbfb", "committedDate": "2020-10-19T14:02:17Z", "message": "Move opening recording Activity behind interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f94776d0840ef4c2f6d79ec13e45538a6b58e58e", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/f94776d0840ef4c2f6d79ec13e45538a6b58e58e", "committedDate": "2020-10-19T14:02:17Z", "message": "Pull audio choosing logic behind interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98ca69ce6d8c5a4bbf1c694eeaf1ddb797db1532", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/98ca69ce6d8c5a4bbf1c694eeaf1ddb797db1532", "committedDate": "2020-10-19T14:02:17Z", "message": "Remove mocked file usage in test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "808c86b35406daa06d6d3e3d8a18b1c5287d8f6d", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/808c86b35406daa06d6d3e3d8a18b1c5287d8f6d", "committedDate": "2020-10-19T14:02:17Z", "message": "Attempt to make it clearer what QuestionMediaManager is up to"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce54f2eb884e8466def0dc194d29c589a142222a", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/ce54f2eb884e8466def0dc194d29c589a142222a", "committedDate": "2020-10-19T14:02:18Z", "message": "Use QuestionMediaManager to access instance media files in AudioWidget"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b8f965fc188a952f5de6aea53c56da365765e71", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/7b8f965fc188a952f5de6aea53c56da365765e71", "committedDate": "2020-10-19T14:02:18Z", "message": "Use string instead of file for AudioWidget data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f2af07788f6dd3b269ba8de1932f7d05acf7542", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/0f2af07788f6dd3b269ba8de1932f7d05acf7542", "committedDate": "2020-10-19T14:02:18Z", "message": "Only show capture/choose button when AudioWidget does not have answer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e13df381c00fa71b932c32e44490aae03beec30", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/0e13df381c00fa71b932c32e44490aae03beec30", "committedDate": "2020-10-19T14:02:18Z", "message": "Fix choose sound flow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e89504f071818eea260fa092adc1a8720b1adfed", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/e89504f071818eea260fa092adc1a8720b1adfed", "committedDate": "2020-10-19T14:02:18Z", "message": "Hide button when audio is recorded/chosen"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9c6addab766a1991aa7e84cc4c894cf165faaef", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/a9c6addab766a1991aa7e84cc4c894cf165faaef", "committedDate": "2020-10-19T14:02:19Z", "message": "Make sure elevation shows for audio controller"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "044205087e2343295bc3feb2f4403ecf9e1c99fd", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/044205087e2343295bc3feb2f4403ecf9e1c99fd", "committedDate": "2020-10-19T14:02:19Z", "message": "Smooth out audio controller seek bar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "207910b44b42ffc9802be1031c79fb0904082454", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/207910b44b42ffc9802be1031c79fb0904082454", "committedDate": "2020-10-19T14:02:19Z", "message": "Always use the same frame rate for updating seekbar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cec0ad2e30236c85dc15f1b97e7e8b1952fb4c7", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/8cec0ad2e30236c85dc15f1b97e7e8b1952fb4c7", "committedDate": "2020-10-19T14:02:19Z", "message": "Optimize imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "253cb4bcb801b9140c0d0aa4f736e4ddb597c2ac", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/253cb4bcb801b9140c0d0aa4f736e4ddb597c2ac", "committedDate": "2020-10-19T14:02:19Z", "message": "Convert test-shared to kotlin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dd3f41d1f953a51bcaab7b74e70ef9654068f41", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/2dd3f41d1f953a51bcaab7b74e70ef9654068f41", "committedDate": "2020-10-19T14:02:20Z", "message": "Add quality checks to modules"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ff5f6b69a70cb971b4707c660606ef69033af5a", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/1ff5f6b69a70cb971b4707c660606ef69033af5a", "committedDate": "2020-10-19T14:02:20Z", "message": "Add Kotlin style checks and fix failing checks\n\nThis adds ktlint which appears to be the most popular checker."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "768b009fd3a2214e98212ef6008e637d444e5c35", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/768b009fd3a2214e98212ef6008e637d444e5c35", "committedDate": "2020-10-19T14:02:20Z", "message": "Add audioclips to CI tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3811f7f97ff2ce7bb66aea5c8b78ff3e516e5249", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/3811f7f97ff2ce7bb66aea5c8b78ff3e516e5249", "committedDate": "2020-10-19T14:02:20Z", "message": "Correct module name for CI label"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52655d6d8a3108dae58114f9178cbc3f613e1545", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/52655d6d8a3108dae58114f9178cbc3f613e1545", "committedDate": "2020-10-19T14:02:20Z", "message": "Use variables for dependency version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd968f54eb60ff831e924957f16e1d7f6f7af810", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/bd968f54eb60ff831e924957f16e1d7f6f7af810", "committedDate": "2020-10-19T14:02:20Z", "message": "Add more detail around QuestionMediaManager implementation and move ViewModelAudioPlayer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f9054796ce74750cdb6f27bba45c23b290b4ddc", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/5f9054796ce74750cdb6f27bba45c23b290b4ddc", "committedDate": "2020-10-19T14:02:21Z", "message": "Add optimize imports"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1957e87400409518bcd713a4f16fb4f6af9e32d8", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/1957e87400409518bcd713a4f16fb4f6af9e32d8", "committedDate": "2020-10-19T11:55:50Z", "message": "Add optimize imports"}, "afterCommit": {"oid": "5f9054796ce74750cdb6f27bba45c23b290b4ddc", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/5f9054796ce74750cdb6f27bba45c23b290b4ddc", "committedDate": "2020-10-19T14:02:21Z", "message": "Add optimize imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4327c6bdea4c4f7c59218d2f4baeaff2fce945af", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/4327c6bdea4c4f7c59218d2f4baeaff2fce945af", "committedDate": "2020-10-19T17:01:48Z", "message": "Make module names consistent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMDIxNzY3", "url": "https://github.com/getodk/collect/pull/4168#pullrequestreview-512021767", "createdAt": "2020-10-19T17:57:15Z", "commit": {"oid": "4327c6bdea4c4f7c59218d2f4baeaff2fce945af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2425, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}