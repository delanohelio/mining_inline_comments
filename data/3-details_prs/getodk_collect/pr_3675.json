{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzNzkwODM1", "number": 3675, "title": "Fix flakey tests", "bodyText": "This moves one of the tests in StorageMigrationCompletedBannerTest to Robolectric and introduces an AsyncTask where a Thread was being used. For the former this stabilizes the test as for some reason recreating an Activity in Espresso appears to be flakey. For the latter this means that Espresso is in sync with the background work (it only knows about AsyncTask).\nWhat has been done to verify that this works as intended?\nRan locally and on Test Lab.\nWhy is this the best possible solution? Were any other approaches considered?\nI did consider using standard Robolectric for the MainMenuActivityTest but the ActivityScenario felt right as it lets us worry less about what exact lifecycle methods get called in what scenario (versus the ActivityController) which is pretty nice. I like this blend of androidx lifecycle control but not using onView etc.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nShould really only effect tests. The changes to reset feature feel pretty covered by the test that was flakey so I think I'd be ok merging this without QA.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-03-04T18:58:30Z", "url": "https://github.com/getodk/collect/pull/3675", "merged": true, "mergeCommit": {"oid": "2b6bde843f9c04e4f18d8d9e774877739df8f08d"}, "closed": true, "closedAt": "2020-03-04T19:14:59Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKabVngH2gAyMzgzNzkwODM1OjYzMzZjNzcyNzMyNjIxNDU1MTQxZWM5Njk2ODUyYTM0NmRjOWExMjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKb4zEAFqTM2OTA0OTg3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6336c772732621455141ec9696852a346dc9a129", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/6336c772732621455141ec9696852a346dc9a129", "committedDate": "2020-03-04T17:32:43Z", "message": "Use Robolectric to test MainMenuActivity onDestroy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0a1854afe754aff202f6025a66b272f02d66e8f", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/c0a1854afe754aff202f6025a66b272f02d66e8f", "committedDate": "2020-03-04T17:45:06Z", "message": "Use ActivityScenario for MainMenuActivity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "228c85301061005abba5882fc0803f578ff617b0", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/228c85301061005abba5882fc0803f578ff617b0", "committedDate": "2020-03-04T18:51:41Z", "message": "Use AsyncTask for resetting app so Espresso works"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MDQ2MjIw", "url": "https://github.com/getodk/collect/pull/3675#pullrequestreview-369046220", "createdAt": "2020-03-04T19:09:31Z", "commit": {"oid": "c0a1854afe754aff202f6025a66b272f02d66e8f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOTowOTozMlrOFx5-qA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOTowOTozMlrOFx5-qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg3NDQ3Mg==", "bodyText": "So is this a no-op or am I missing something?", "url": "https://github.com/getodk/collect/pull/3675#discussion_r387874472", "createdAt": "2020-03-04T19:09:32Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/test/java/org/odk/collect/android/activities/MainMenuActivityTest.java", "diffHunk": "@@ -26,12 +26,13 @@\n import dagger.Provides;\n \n import static android.os.Environment.MEDIA_MOUNTED;\n+import static androidx.lifecycle.Lifecycle.State.DESTROYED;\n import static org.hamcrest.MatcherAssert.assertThat;\n import static org.hamcrest.Matchers.equalTo;\n import static org.robolectric.Shadows.shadowOf;\n import static org.robolectric.annotation.LooperMode.Mode.PAUSED;\n \n-@RunWith(RobolectricTestRunner.class)\n+@RunWith(AndroidJUnit4.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0a1854afe754aff202f6025a66b272f02d66e8f"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MDQ5ODc0", "url": "https://github.com/getodk/collect/pull/3675#pullrequestreview-369049874", "createdAt": "2020-03-04T19:14:48Z", "commit": {"oid": "228c85301061005abba5882fc0803f578ff617b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2329, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}