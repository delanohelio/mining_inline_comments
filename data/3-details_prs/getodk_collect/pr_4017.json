{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0NjMwNDMx", "number": 4017, "title": "Fixed auto-delete and auto-sent options", "bodyText": "Closes #3768\nWhat has been done to verify that this works as intended?\nI reproduced the issue and confirmed that this pr fixes it.\nWhy is this the best possible solution? Were any other approaches considered?\nIt is just a bug fix. Before we didn't take form versions into account while reading auto-sent and auto-delete props from database.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nIt's a safe change that should just fix the issue. Nothing else should be affacted.\nDo we need any specific form for testing your changes? If so, please attach one.\nThe form attached to the issue.\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nNo.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-08-07T14:16:40Z", "url": "https://github.com/getodk/collect/pull/4017", "merged": true, "mergeCommit": {"oid": "ced89409144f912473ec25647cd7057ba00ac35d"}, "closed": true, "closedAt": "2020-09-04T10:48:49Z", "author": {"login": "grzesiek2010"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-IQZMAFqTQ2NTc1ODY3NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFQ_5mABqjM3MjQ4NjI0NzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NzU4Njc1", "url": "https://github.com/getodk/collect/pull/4017#pullrequestreview-465758675", "createdAt": "2020-08-12T09:46:32Z", "commit": {"oid": "bfa7091820ffe2be71aba2e73d30bf2a0917d645"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bfa7091820ffe2be71aba2e73d30bf2a0917d645", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/bfa7091820ffe2be71aba2e73d30bf2a0917d645", "committedDate": "2020-08-06T11:40:59Z", "message": "Fixed auto-send functionality"}, "afterCommit": {"oid": "f2f0317284716d2648ef9d232fc4f8f66bfac4cd", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f2f0317284716d2648ef9d232fc4f8f66bfac4cd", "committedDate": "2020-08-13T10:18:49Z", "message": "Added tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NzY2MjU0", "url": "https://github.com/getodk/collect/pull/4017#pullrequestreview-466766254", "createdAt": "2020-08-13T13:34:52Z", "commit": {"oid": "7ddfd2b3d5c92019c29fc55704ba1489abfcefd6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMzozNDo1M1rOHALyJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMzozODowNFrOHAL67w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1NTEwOQ==", "bodyText": "Could this not just always call formSubmitMananer.scheduleSubmit() at this point? I might have missed something but I think the InstanceSubmitter (that the AutoSendTaskSpec will use will do the right thing and only send if it needs to.\nIf that's the case we could just test InstanceSubmitter rather than the static method (as it will be the only place we make that decision).", "url": "https://github.com/getodk/collect/pull/4017#discussion_r469955109", "createdAt": "2020-08-13T13:34:53Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -1887,7 +1887,7 @@ private void handleSaveResult(FormSaveViewModel.SaveResult result) {\n                         // finalized specifies that it should always be auto-sent.\n                         String formId = getFormController().getFormDef().getMainInstance().getRoot().getAttributeValue(\"\", \"id\");\n                         String formVersion = getFormController().getFormDef().getMainInstance().getRoot().getAttributeValue(\"\", \"version\");\n-                        if (InstanceUploaderUtils.formShouldBeAutoSent(formsRepository, formId, formVersion, GeneralSharedPreferences.isAutoSendEnabled())) {\n+                        if (InstanceUploaderUtils.shouldFormBeSent(formsRepository, formId, formVersion, GeneralSharedPreferences.isAutoSendEnabled())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ddfd2b3d5c92019c29fc55704ba1489abfcefd6"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1NzM1OQ==", "bodyText": "Might be nice to have these static methods in a new InstanceUtils class in either instancemanagement or instances. I can see us pulling the other methods out at some point (maybe as part of #3988).", "url": "https://github.com/getodk/collect/pull/4017#discussion_r469957359", "createdAt": "2020-08-13T13:38:04Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/utilities/InstanceUploaderUtils.java", "diffHunk": "@@ -154,7 +154,7 @@ public static boolean formShouldBeAutoSent(FormsRepository formsRepository, Stri\n      *\n      * If the form explicitly sets the auto-delete property, then it overrides the preference.\n      */\n-    public static boolean formShouldBeAutoDeleted(FormsRepository formsRepository, String jrFormId, String jrFormVersion, boolean isAutoDeleteAppSettingEnabled) {\n+    public static boolean shouldFormBeDeleted(FormsRepository formsRepository, String jrFormId, String jrFormVersion, boolean isAutoDeleteAppSettingEnabled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ddfd2b3d5c92019c29fc55704ba1489abfcefd6"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0cf47ba40cb587a69147262684ae4f99d8744bf0", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/0cf47ba40cb587a69147262684ae4f99d8744bf0", "committedDate": "2020-08-19T10:04:36Z", "message": "Improved getInstancesToAutoSend() method"}, "afterCommit": {"oid": "4ede48c7ef798dfe89d862bd2a8d045a4b68995d", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/4ede48c7ef798dfe89d862bd2a8d045a4b68995d", "committedDate": "2020-08-19T10:13:20Z", "message": "Improved getInstancesToAutoSend() method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNDE5NzY1", "url": "https://github.com/getodk/collect/pull/4017#pullrequestreview-471419765", "createdAt": "2020-08-20T09:28:45Z", "commit": {"oid": "f79962e56fd5c4c7c65400c436e8968a67ed7448"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwOToyODo0NVrOHD3JTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwOTozOToyOFrOHD3seA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgxMTI3OA==", "bodyText": "I think this is meant to be private", "url": "https://github.com/getodk/collect/pull/4017#discussion_r473811278", "createdAt": "2020-08-20T09:28:45Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/instancemanagement/InstanceSubmitter.java", "diffHunk": "@@ -35,20 +35,26 @@\n import timber.log.Timber;\n \n import static org.odk.collect.android.analytics.AnalyticsEvents.SUBMISSION;\n-import static org.odk.collect.android.provider.FormsProviderAPI.FormsColumns.AUTO_SEND;\n import static org.odk.collect.android.utilities.InstanceUploaderUtils.SPREADSHEET_UPLOADED_TO_GOOGLE_DRIVE;\n \n public class InstanceSubmitter {\n \n     private final Analytics analytics;\n+    private final FormsRepository formsRepository;\n+    private final InstancesRepository instancesRepository;\n \n-    public InstanceSubmitter(Analytics analytics) {\n+    public InstanceSubmitter(Analytics analytics, FormsRepository formsRepository, InstancesRepository instancesRepository) {\n         this.analytics = analytics;\n+        this.formsRepository = formsRepository;\n+        this.instancesRepository = instancesRepository;\n     }\n \n     public Pair<Boolean, String> submitUnsubmittedInstances() throws SubmitException {\n         List<Instance> toUpload = getInstancesToAutoSend(GeneralSharedPreferences.isAutoSendEnabled());\n+        return submitSelectedInstances(toUpload);\n+    }\n \n+    public Pair<Boolean, String> submitSelectedInstances(List<Instance> toUpload) throws SubmitException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f79962e56fd5c4c7c65400c436e8968a67ed7448"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgyMDI4MA==", "bodyText": "In my head this would ideally be a private method that is just an implementation detail of InstanceSubmitter. The InstanceSubmitter would then have tests around it that setup instances and check that they are sent in the right contexts. Looking at though there is a lot of dependencies on static calls we'd need to pull out to write that test (Collect.getInsance().getComponent() and GeneralSharedPreferences.isAutoSendEnabled() for example). This PR moves the needle forward so I don't think it makes sense to block it on that rework.\nCould you maybe just add a @Deprecated to this method and a @deprecated Javadoc explaining that really it should be a private method and that that requires refactoring InstanceSubmitter to make it testable/modular?", "url": "https://github.com/getodk/collect/pull/4017#discussion_r473820280", "createdAt": "2020-08-20T09:39:28Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/instancemanagement/InstanceSubmitter.java", "diffHunk": "@@ -147,19 +149,11 @@ public InstanceSubmitter(Analytics analytics) {\n      *\n      * @param isAutoSendAppSettingEnabled whether the auto-send option is enabled at the app level\n      */\n-    public static boolean formShouldBeAutoSent(String jrFormId, boolean isAutoSendAppSettingEnabled) {\n-        Cursor cursor = new FormsDao().getFormsCursorForFormId(jrFormId);\n-        String formLevelAutoSend = null;\n-        if (cursor != null && cursor.moveToFirst()) {\n-            try {\n-                int autoSendColumnIndex = cursor.getColumnIndex(AUTO_SEND);\n-                formLevelAutoSend = cursor.getString(autoSendColumnIndex);\n-            } finally {\n-                cursor.close();\n-            }\n+    public static boolean shouldFormBeSent(FormsRepository formsRepository, String jrFormId, String jrFormVersion, boolean isAutoSendAppSettingEnabled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f79962e56fd5c4c7c65400c436e8968a67ed7448"}, "originalPosition": 98}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNDgyNDkx", "url": "https://github.com/getodk/collect/pull/4017#pullrequestreview-472482491", "createdAt": "2020-08-21T13:22:17Z", "commit": {"oid": "9fed9b6b232cda117d1f54178c70a48bd1e8ae40"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2457f502f3d48122ace612760d9693634dcff68f", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/2457f502f3d48122ace612760d9693634dcff68f", "committedDate": "2020-09-03T13:12:11Z", "message": "Fixed auto-delete functionality"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e38767f11062cc402ae5305a0c4e3c57e187e103", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/e38767f11062cc402ae5305a0c4e3c57e187e103", "committedDate": "2020-09-03T13:12:11Z", "message": "Fixed auto-sent functionality"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f478e3ea254ebf9b4666165c927498c61d928f63", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f478e3ea254ebf9b4666165c927498c61d928f63", "committedDate": "2020-09-03T13:15:41Z", "message": "Code improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cc008570c036f216293de667023d4d16663b7a9", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/3cc008570c036f216293de667023d4d16663b7a9", "committedDate": "2020-09-03T13:15:41Z", "message": "Naming improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8b26c6c291301cde130d57b08b395ca39030798", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/d8b26c6c291301cde130d57b08b395ca39030798", "committedDate": "2020-09-03T13:15:41Z", "message": "Added tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f181bc7f181d557d3f44da4ca3cccb45e68cce6a", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f181bc7f181d557d3f44da4ca3cccb45e68cce6a", "committedDate": "2020-09-03T13:19:09Z", "message": "improved the code responsible for generating UploadResultMessage and moved tests from android to unit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4524838c971a8c608716817df693525fad903a5c", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/4524838c971a8c608716817df693525fad903a5c", "committedDate": "2020-09-03T13:19:09Z", "message": "Code improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef2b4e6aa74eb62ebd25f4f3c1ee7021319c392c", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/ef2b4e6aa74eb62ebd25f4f3c1ee7021319c392c", "committedDate": "2020-09-03T13:19:09Z", "message": "Fixed checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9a7da39afc21f6e177f6f2d14e2402fb2f7ac1c", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/c9a7da39afc21f6e177f6f2d14e2402fb2f7ac1c", "committedDate": "2020-09-03T13:19:09Z", "message": "Fixed reading id and version from formController"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fc37547add48212f8da6b291a620f654caa257a", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/1fc37547add48212f8da6b291a620f654caa257a", "committedDate": "2020-09-03T13:19:09Z", "message": "Try to trigger autosend every time a form is saved"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de91a2385cf6153b476cf04164950c7d9c73b705", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/de91a2385cf6153b476cf04164950c7d9c73b705", "committedDate": "2020-09-03T13:19:09Z", "message": "Added submitSelectedInstances() in InstanceSubmitter to use it in the future from uploader tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f79477472654a873044af4b68d8e9ee2a6543744", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f79477472654a873044af4b68d8e9ee2a6543744", "committedDate": "2020-09-03T13:19:09Z", "message": "Improved getInstancesToAutoSend() method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76223866fc49ae7df45ad86a1c45ef5c026db5d7", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/76223866fc49ae7df45ad86a1c45ef5c026db5d7", "committedDate": "2020-09-03T13:19:39Z", "message": "Moved shouldFormBeSent() to InstanceSubmitter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a899c5f1e8ec901ec02224587afb45c9c0e96a0e", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/a899c5f1e8ec901ec02224587afb45c9c0e96a0e", "committedDate": "2020-09-03T13:19:39Z", "message": "removed redundant code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ff118f5022665d49ae06418139597404a9a42a8", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/1ff118f5022665d49ae06418139597404a9a42a8", "committedDate": "2020-09-03T13:19:39Z", "message": "Code improvements"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9fed9b6b232cda117d1f54178c70a48bd1e8ae40", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/9fed9b6b232cda117d1f54178c70a48bd1e8ae40", "committedDate": "2020-08-21T12:56:25Z", "message": "Code improvements"}, "afterCommit": {"oid": "d457c206fe12dacda2359cd1e6c9cd4e2a0c6783", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/d457c206fe12dacda2359cd1e6c9cd4e2a0c6783", "committedDate": "2020-09-03T13:34:27Z", "message": "Fixed conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bc5dc50df75976b4d2bb565fedab7641a0e295d", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/8bc5dc50df75976b4d2bb565fedab7641a0e295d", "committedDate": "2020-09-03T13:54:44Z", "message": "Fixed conflicts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d457c206fe12dacda2359cd1e6c9cd4e2a0c6783", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/d457c206fe12dacda2359cd1e6c9cd4e2a0c6783", "committedDate": "2020-09-03T13:34:27Z", "message": "Fixed conflicts"}, "afterCommit": {"oid": "8bc5dc50df75976b4d2bb565fedab7641a0e295d", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/8bc5dc50df75976b4d2bb565fedab7641a0e295d", "committedDate": "2020-09-03T13:54:44Z", "message": "Fixed conflicts"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2601, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}