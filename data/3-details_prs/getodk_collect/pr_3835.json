{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4MTk3MjQy", "number": 3835, "title": "Fixed scanning inverted QRCodes and refactored the way we scan codes", "bodyText": "Closes #3823\nWhat has been done to verify that this works as intended?\nI tested the changes manually.\nWhy is this the best possible solution? Were any other approaches considered?\nThe problem mentioned in the issue was just a small bug which I fixed. Investigating the code I realized we have a lot of duplicated code in ScannerWithFlashlightActivity used by BarcodeWidget and QRScannerFragment used when we scan settings. I refactored the code and now in both cases we use QRScannerFragment (ScannerWithFlashlightActivity still exists to hold QRScannerFragment but the duplicated code is removed).\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nWe need to test scanning settings (no need to check result's just whether the code is scanned or not) and scanning barcodes using the BarcodeWidget (with front camera).\nDo we need any specific form for testing your changes? If so, please attach one.\nAny form with BarcodeWidget (+ one using front camera ideally).\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nNo.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-05-14T19:17:58Z", "url": "https://github.com/getodk/collect/pull/3835", "merged": true, "mergeCommit": {"oid": "67e596a25b511fe8f18749707f4ae52e18db6ab7"}, "closed": true, "closedAt": "2020-05-19T11:13:09Z", "author": {"login": "grzesiek2010"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchRCh-AH2gAyNDE4MTk3MjQyOmJjODljOGEwZTYzOTAyZDY0MjY5NzhiNzlkNTc5ZjUwMGRjZjBlMWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcidotOgH2gAyNDE4MTk3MjQyOmUyZDgyZmZlYTk0NzFmYWI3YTNjYmIwM2I5Y2JhYWU4YzczMzZlZTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bc89c8a0e63902d6426978b79d579f500dcf0e1e", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/bc89c8a0e63902d6426978b79d579f500dcf0e1e", "committedDate": "2020-05-14T17:36:44Z", "message": "Prepared QRScannerFragment to be used by BarcodeWidget as well"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ba7062b11ca09517ef0782a363aa8b88cd75d2a", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/2ba7062b11ca09517ef0782a363aa8b88cd75d2a", "committedDate": "2020-05-14T17:47:42Z", "message": "Moved the dupicated code from ScannerWithFlashlightActivity to QRScannerFragment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d7f22f36ed4a277a64bfaad4547a4cbe4c92355", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/0d7f22f36ed4a277a64bfaad4547a4cbe4c92355", "committedDate": "2020-05-14T17:49:00Z", "message": "Use QRScannerFragment in ScannerWithFlashlightActivity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afa6205fa91821e14e6dd8d1c163673fa2ad9cda", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/afa6205fa91821e14e6dd8d1c163673fa2ad9cda", "committedDate": "2020-05-14T17:56:57Z", "message": "Fix supported code formats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d238f07ba6c5b0fafd15b0e934ac529ce42afdb", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/7d238f07ba6c5b0fafd15b0e934ac529ce42afdb", "committedDate": "2020-05-14T18:01:00Z", "message": "Use our own translatable prompt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0f36f67f75970d575a6bb6dbab8fdce7e4b69ab", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f0f36f67f75970d575a6bb6dbab8fdce7e4b69ab", "committedDate": "2020-05-14T18:03:39Z", "message": "Removed duplicated/redundant code from BarcodeWidget"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87e1fa90b9688d23fa1ebe40d516d2e9c7cf4791", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/87e1fa90b9688d23fa1ebe40d516d2e9c7cf4791", "committedDate": "2020-05-14T18:59:28Z", "message": "Fixed front camera"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b9b3d4d00815afd2c16435d4e2d2479331f4b0b", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/3b9b3d4d00815afd2c16435d4e2d2479331f4b0b", "committedDate": "2020-05-14T19:10:22Z", "message": "Cleaned the code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMzMyNTk1", "url": "https://github.com/getodk/collect/pull/3835#pullrequestreview-412332595", "createdAt": "2020-05-15T04:02:20Z", "commit": {"oid": "7d238f07ba6c5b0fafd15b0e934ac529ce42afdb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNDowMjoyMFrOGV1wFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNDozNjowM1rOGV2MgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU1Mzk0Mw==", "bodyText": "I think we should make this a separate change for v1.28. Most translators won\u2019t have time to get to this in the next few days so the strings will show up in English where they were translated before.", "url": "https://github.com/getodk/collect/pull/3835#discussion_r425553943", "createdAt": "2020-05-15T04:02:20Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/preferences/qr/QRScannerFragment.java", "diffHunk": "@@ -83,6 +83,7 @@ public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle sa\n \n         Intent intent = new IntentIntegrator(getActivity())\n                 .setDesiredBarcodeFormats(getSupportedCodeFormats())\n+                .setPrompt(getContext().getString(R.string.barcode_scanner_prompt))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d238f07ba6c5b0fafd15b0e934ac529ce42afdb"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU2MTA1OA==", "bodyText": "Passing in an Action to configure the fragment makes it hard to track what the different behavior is between the two types of scanners. Did you consider an abstract BarcodeScannerFragment with SettingsQRCodeScannerFragment and BarcodeWidgetScannerFragment subtypes or something like that? You'd have abstract handleBarcodeResult and getSupportedCodeFormats methods that are the only things implemented by those concrete classes, making the different behavior really clear.", "url": "https://github.com/getodk/collect/pull/3835#discussion_r425561058", "createdAt": "2020-05-15T04:35:20Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/preferences/qr/QRScannerFragment.java", "diffHunk": "@@ -24,43 +26,70 @@\n \n import com.google.zxing.ResultPoint;\n import com.google.zxing.client.android.BeepManager;\n+import com.google.zxing.client.android.Intents;\n+import com.google.zxing.integration.android.IntentIntegrator;\n import com.journeyapps.barcodescanner.BarcodeCallback;\n import com.journeyapps.barcodescanner.BarcodeResult;\n+import com.journeyapps.barcodescanner.CaptureManager;\n import com.journeyapps.barcodescanner.DecoratedBarcodeView;\n+import com.journeyapps.barcodescanner.camera.CameraSettings;\n \n import org.odk.collect.android.R;\n import org.odk.collect.android.preferences.utilities.SettingsUtils;\n+import org.odk.collect.android.utilities.CameraUtils;\n import org.odk.collect.android.utilities.CompressionUtils;\n import org.odk.collect.android.utilities.ToastUtils;\n \n import org.odk.collect.android.listeners.PermissionListener;\n import org.odk.collect.android.utilities.PermissionUtils;\n+import org.odk.collect.android.utilities.WidgetAppearanceUtils;\n \n import java.io.IOException;\n+import java.util.Collection;\n+import java.util.Collections;\n import java.util.List;\n import java.util.zip.DataFormatException;\n \n public class QRScannerFragment extends Fragment implements DecoratedBarcodeView.TorchListener {\n \n-    DecoratedBarcodeView barcodeScannerView;\n+    private static final String ACTION = \"action\";\n+\n+    public enum Action { BARCODE_WIDGET, APPLY_SETTINGS };\n+\n+    private CaptureManager capture;\n+    private DecoratedBarcodeView barcodeScannerView;\n     private Button switchFlashlightButton;\n     private BeepManager beepManager;\n+    private Action action;\n+\n+    public static QRScannerFragment newInstance(Action action) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b9b3d4d00815afd2c16435d4e2d2479331f4b0b"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU2MTIxNg==", "bodyText": "This should be in a different package, now. It's also no longer just a QR code scanner.", "url": "https://github.com/getodk/collect/pull/3835#discussion_r425561216", "createdAt": "2020-05-15T04:36:03Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/preferences/qr/QRScannerFragment.java", "diffHunk": "@@ -24,43 +26,70 @@\n \n import com.google.zxing.ResultPoint;\n import com.google.zxing.client.android.BeepManager;\n+import com.google.zxing.client.android.Intents;\n+import com.google.zxing.integration.android.IntentIntegrator;\n import com.journeyapps.barcodescanner.BarcodeCallback;\n import com.journeyapps.barcodescanner.BarcodeResult;\n+import com.journeyapps.barcodescanner.CaptureManager;\n import com.journeyapps.barcodescanner.DecoratedBarcodeView;\n+import com.journeyapps.barcodescanner.camera.CameraSettings;\n \n import org.odk.collect.android.R;\n import org.odk.collect.android.preferences.utilities.SettingsUtils;\n+import org.odk.collect.android.utilities.CameraUtils;\n import org.odk.collect.android.utilities.CompressionUtils;\n import org.odk.collect.android.utilities.ToastUtils;\n \n import org.odk.collect.android.listeners.PermissionListener;\n import org.odk.collect.android.utilities.PermissionUtils;\n+import org.odk.collect.android.utilities.WidgetAppearanceUtils;\n \n import java.io.IOException;\n+import java.util.Collection;\n+import java.util.Collections;\n import java.util.List;\n import java.util.zip.DataFormatException;\n \n public class QRScannerFragment extends Fragment implements DecoratedBarcodeView.TorchListener {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b9b3d4d00815afd2c16435d4e2d2479331f4b0b"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25f346b87ae6f59d56764b80125dc959b5bfd6d1", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/25f346b87ae6f59d56764b80125dc959b5bfd6d1", "committedDate": "2020-05-15T12:36:57Z", "message": "Naming improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4221002e53d90076e7540957f1380e0f3c0d828", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f4221002e53d90076e7540957f1380e0f3c0d828", "committedDate": "2020-05-15T12:37:44Z", "message": "Moved CodeScannerFragment to fragments package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9982e40e785f727b8ee36db57b15e6ea4aeb629e", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/9982e40e785f727b8ee36db57b15e6ea4aeb629e", "committedDate": "2020-05-15T14:25:17Z", "message": "Added BaseCodeScannerFragment and fragments that extend it to improve managing scanning"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bca267d75c34a9f6c92b9861780b93df6a702a1f", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/bca267d75c34a9f6c92b9861780b93df6a702a1f", "committedDate": "2020-05-15T14:17:13Z", "message": "Added BaseCodeScannerFragment and fragments that extend it to improve managing scanning"}, "afterCommit": {"oid": "9982e40e785f727b8ee36db57b15e6ea4aeb629e", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/9982e40e785f727b8ee36db57b15e6ea4aeb629e", "committedDate": "2020-05-15T14:25:17Z", "message": "Added BaseCodeScannerFragment and fragments that extend it to improve managing scanning"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMTk5MDcy", "url": "https://github.com/getodk/collect/pull/3835#pullrequestreview-413199072", "createdAt": "2020-05-17T21:10:39Z", "commit": {"oid": "9982e40e785f727b8ee36db57b15e6ea4aeb629e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2d82ffea9471fab7a3cbb03b9cbaae8c7336ee5", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/e2d82ffea9471fab7a3cbb03b9cbaae8c7336ee5", "committedDate": "2020-05-18T10:51:13Z", "message": "Factored out BARCODE_RESULT_KEY"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2692, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}