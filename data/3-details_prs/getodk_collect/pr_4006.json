{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyNTcyMjg1", "number": 4006, "title": "Reworking Audio widget", "bodyText": "Closes #4005 and Closes #4008\nThis PR includes rewriting the test coverage and class of Audio Widget\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nThis PR removes MediaManager enum class and the functionality is shifted to FormSaveViewModel. Hence, it changes the structure of FileWidgets and scenarios involving rotation of activities and killing of activities in the middle of saving, replacing or deleting answers in file widgets would be good to test.\nDo we need any specific form for testing your changes? If so, please attach one.\nAny form having Audio Widget like AllWidgetsForm\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nNo\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-08-04T07:05:22Z", "url": "https://github.com/getodk/collect/pull/4006", "merged": true, "mergeCommit": {"oid": "1fcb0579fe6bc4f382beb537cfc8484dc4d2dbb4"}, "closed": true, "closedAt": "2020-08-28T22:01:02Z", "author": {"login": "SaumiaSinghal"}, "timelineItems": {"totalCount": 46, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7jK7vABqjM2MTkzNzM0MjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDAQn_AFqTQ3NjcwOTY1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "abb55c33e5090635274f04de8c56914208469039", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/abb55c33e5090635274f04de8c56914208469039", "committedDate": "2020-08-04T07:01:54Z", "message": "update unit tests"}, "afterCommit": {"oid": "289cc79436c56c8369d5a07d653ff0d82852ed5f", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/289cc79436c56c8369d5a07d653ff0d82852ed5f", "committedDate": "2020-08-04T09:25:29Z", "message": "code refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNzQ1MTk4", "url": "https://github.com/getodk/collect/pull/4006#pullrequestreview-461745198", "createdAt": "2020-08-05T14:54:36Z", "commit": {"oid": "b2bb6bf4ec6f1021f2fa63cc13152c19be8e7031"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNDo1NDozNlrOG8Na_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNTowOTo0NVrOG8OGDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc4NzY0NQ==", "bodyText": "I think better to just have the values inline (destinationPath) rather than defined anywhere. Easier to see in the test that the value is just a string.", "url": "https://github.com/getodk/collect/pull/4006#discussion_r465787645", "createdAt": "2020-08-05T14:54:36Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/widgets/AudioWidgetTest.java", "diffHunk": "@@ -1,117 +1,188 @@\n package org.odk.collect.android.widgets;\n \n-import android.content.Context;\n-import android.content.Intent;\n-import android.net.Uri;\n-import android.provider.MediaStore;\n+import android.media.MediaPlayer;\n import android.view.View;\n \n-import androidx.annotation.NonNull;\n-\n-import net.bytebuddy.utility.RandomString;\n+import androidx.core.view.ViewCompat;\n+import androidx.fragment.app.FragmentActivity;\n+import androidx.lifecycle.LifecycleOwner;\n \n import org.javarosa.core.model.data.StringData;\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.junit.Before;\n import org.junit.Test;\n-import org.mockito.Mock;\n-import org.odk.collect.android.R;\n+import org.junit.runner.RunWith;\n import org.odk.collect.android.audio.AudioControllerView;\n+import org.odk.collect.android.audio.AudioHelper;\n+import org.odk.collect.android.audio.Clip;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n+import org.odk.collect.android.listeners.WidgetValueChangedListener;\n+import org.odk.collect.android.support.FakeLifecycleOwner;\n+import org.odk.collect.android.support.FakeScheduler;\n+import org.odk.collect.android.support.TestScreenContextActivity;\n import org.odk.collect.android.utilities.FileUtil;\n import org.odk.collect.android.utilities.MediaUtil;\n-import org.odk.collect.android.widgets.base.FileWidgetTest;\n+import org.odk.collect.android.utilities.WidgetAppearanceUtils;\n import org.odk.collect.android.widgets.support.FakeWaitingForDataRegistry;\n+import org.odk.collect.async.Scheduler;\n+import org.robolectric.RobolectricTestRunner;\n \n import java.io.File;\n+import java.util.function.Supplier;\n \n import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.hamcrest.Matchers.is;\n-import static org.mockito.ArgumentMatchers.any;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.nullValue;\n import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n import static org.mockito.Mockito.when;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.mockValueChangedListener;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithAnswer;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithReadOnly;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.widgetTestActivity;\n \n-/**\n- * @author James Knight\n- */\n-public class AudioWidgetTest extends FileWidgetTest<AudioWidget> {\n-\n-    @Mock\n-    Uri uri;\n+@RunWith(RobolectricTestRunner.class)\n+public class AudioWidgetTest {\n+    private final String destinationPath = \"blah\";\n \n-    @Mock\n-    MediaUtil mediaUtil;\n+    private final MediaPlayer mediaPlayer = new MediaPlayer();\n+    private final FakeScheduler fakeScheduler = new FakeScheduler();\n \n-    @Mock\n-    FileUtil fileUtil;\n+    private TestScreenContextActivity widgetActivity;\n+    private AudioControllerView audioController;\n+    private FileUtil fileUtil;\n+    private MediaUtil mediaUtil;\n+    private AudioHelper audioHelper;\n \n-    @Mock\n-    AudioControllerView audioController;\n+    @Before\n+    public void setUp() {\n+        widgetActivity = widgetTestActivity();\n \n-    private String destinationName;\n+        audioController = mock(AudioControllerView.class);\n+        fileUtil = mock(FileUtil.class);\n+        mediaUtil = mock(MediaUtil.class);\n \n-    @NonNull\n-    @Override\n-    public AudioWidget createWidget() {\n-        return new AudioWidget(activity, new QuestionDetails(formEntryPrompt, \"formAnalyticsID\"), fileUtil, mediaUtil, audioController, new FakeWaitingForDataRegistry());\n+        audioHelper = new FakeAudioHelper(widgetActivity, new FakeLifecycleOwner(), fakeScheduler, () -> mediaPlayer);\n     }\n \n-    @NonNull\n-    @Override\n-    public StringData getNextAnswer() {\n-        return new StringData(destinationName);\n+    @Test\n+    public void usingReadOnlyOption_doesNotShowCaptureAndChooseButtons() {\n+        AudioWidget widget = createWidget(promptWithReadOnly());\n+\n+        assertThat(widget.captureButton.getVisibility(), equalTo(View.GONE));\n+        assertThat(widget.chooseButton.getVisibility(), equalTo(View.GONE));\n     }\n \n-    @Override\n-    public Object createBinaryData(StringData answerData) {\n-        return uri;\n+    @Test\n+    public void getAnswer_whenPromptDoesNotHaveAnswer_returnsNull() {\n+        AudioWidget widget = createWidget(promptWithAnswer(null));\n+        assertThat(widget.getAnswer(), nullValue());\n     }\n \n-    @Override\n-    public void setUp() throws Exception {\n-        super.setUp();\n-        destinationName = RandomString.make();\n+    @Test\n+    public void getAnswer_whenPromptHasAnswer_returnsAnswer() {\n+        AudioWidget widget = createWidget(promptWithAnswer(new StringData(destinationPath)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2bb6bf4ec6f1021f2fa63cc13152c19be8e7031"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5MzQzNw==", "bodyText": "Not sure the naming is right here. It's not really a \"listener\". Maybe the interface is QuestionMediaManager and the implementation is something else?", "url": "https://github.com/getodk/collect/pull/4006#discussion_r465793437", "createdAt": "2020-08-05T15:02:19Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/interfaces/MediaManagerListener.java", "diffHunk": "@@ -0,0 +1,7 @@\n+package org.odk.collect.android.widgets.interfaces;\n+\n+public interface MediaManagerListener {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53f46a777e8a5ffe159b4ebf557a5031462274f7"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5NjQxMw==", "bodyText": "Feels like the button text should just live in a layout?", "url": "https://github.com/getodk/collect/pull/4006#discussion_r465796413", "createdAt": "2020-08-05T15:06:27Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/widgets/AudioWidget.java", "diffHunk": "@@ -101,24 +98,33 @@ public AudioWidget(Context context, QuestionDetails prompt, WaitingForDataRegist\n         this.waitingForDataRegistry = waitingForDataRegistry;\n         this.mediaManagerListener = mediaManagerListener;\n \n-        captureButton = createSimpleButton(getContext(), R.id.capture_audio, getFormEntryPrompt().isReadOnly(), getContext().getString(R.string.capture_audio), getAnswerFontSize(), this);\n-\n-        chooseButton = createSimpleButton(getContext(), R.id.choose_sound, getFormEntryPrompt().isReadOnly(), getContext().getString(R.string.choose_sound), getAnswerFontSize(), this);\n-\n-        // finish complex layout\n-        LinearLayout answerLayout = new LinearLayout(getContext());\n-        answerLayout.setOrientation(LinearLayout.VERTICAL);\n-        answerLayout.addView(captureButton);\n-        answerLayout.addView(chooseButton);\n-        answerLayout.addView(audioController);\n-        addAnswerView(answerLayout, WidgetViewUtils.getStandardMargin(context));\n-\n         hideButtonsIfNeeded();\n \n         binaryName = questionDetails.getPrompt().getAnswerText();\n         updatePlayerMedia();\n     }\n \n+    @Override\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        binding = AudioWidgetAnswerBinding.inflate(((Activity) context).getLayoutInflater());\n+\n+        if (prompt.isReadOnly()) {\n+            binding.captureButton.widgetButton.setVisibility(View.GONE);\n+            binding.chooseButton.widgetButton.setVisibility(View.GONE);\n+        } else {\n+            binding.captureButton.widgetButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            binding.chooseButton.widgetButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+\n+            binding.captureButton.widgetButton.setText(getContext().getString(R.string.capture_audio));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1beed3da777311fc8bdba2eca7f261ca0b35986"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5ODY3MQ==", "bodyText": "We want a test for this change.", "url": "https://github.com/getodk/collect/pull/4006#discussion_r465798671", "createdAt": "2020-08-05T15:09:45Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/audio/AudioPlayerViewModel.java", "diffHunk": "@@ -178,16 +178,14 @@ public void errorDisplayed() {\n     }\n \n     private void schedulePositionUpdates() {\n-        if (positionUpdatesCancellable == null) {\n-            positionUpdatesCancellable = scheduler.repeat(() -> {\n-                CurrentlyPlaying currentlyPlaying = this.currentlyPlaying.getValue();\n+        positionUpdatesCancellable = scheduler.repeat(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c5a37fd4995edaa6d051eaa4787608a09c0a18c"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNTM3Mzk2", "url": "https://github.com/getodk/collect/pull/4006#pullrequestreview-462537396", "createdAt": "2020-08-06T13:50:04Z", "commit": {"oid": "f4d859d8ca3a4cb691d3e15bf611cc690dd93749"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMzo1MDowNVrOG80ang==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMzo1MjozMVrOG80hWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyNjUyNg==", "bodyText": "I like what's happening here but I think the variable/method should be named something more related to the scheduler than the test here. Maybe isRepeatRunning?", "url": "https://github.com/getodk/collect/pull/4006#discussion_r466426526", "createdAt": "2020-08-06T13:50:05Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/support/FakeScheduler.java", "diffHunk": "@@ -13,6 +13,7 @@\n     private Runnable foregroundTask;\n     private Runnable backgroundTask;\n     private Boolean cancelled = false;\n+    private Boolean isProgressUpdating = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4d859d8ca3a4cb691d3e15bf611cc690dd93749"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyODI1MQ==", "bodyText": "The naming scheme here is pretty confusing as by convention we use Widget at the beginning but that's referring to the general definition of the word rather than a \"question widget\". Maybe the name here could be Widget.Collect.Button.WidgetAnswer?", "url": "https://github.com/getodk/collect/pull/4006#discussion_r466428251", "createdAt": "2020-08-06T13:52:31Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/res/values/buttons.xml", "diffHunk": "@@ -6,6 +6,15 @@\n         <item name=\"android:textStyle\">normal</item>\n     </style>\n \n+    <style name=\"Widget.Collect.Button.Layout\" parent=\"Widget.Collect.Button.Custom\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "551b25a6c847b23784a05dec361f98b366b3c3ba"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MTY0OTQ5", "url": "https://github.com/getodk/collect/pull/4006#pullrequestreview-464164949", "createdAt": "2020-08-10T11:57:53Z", "commit": {"oid": "466e31dd54f2a6c426ecbc1c780c7091970d9e62"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMTo1Nzo1M1rOG-LjVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMTo1Nzo1M1rOG-LjVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1NDE2NQ==", "bodyText": "I don't think this is quite right after a second look. As much as we can we want to avoid static singletons. If there is some state that we want to keep shared at an application level (i.e. between multiple activities or services) then we should use Dagger to setup and inject a singleton (using @Singleton).\nIn this case I don't believe the state needs to persist outside of form entry so it really only needs to last as long as the Activity.  This means we could confuse ourselves by ending up with state hanging around between form entry \"sessions\". A good way to share state like this would be to use a view model where the ViewModelProvider uses the activity as its owner. Does that make sense as a way forward?", "url": "https://github.com/getodk/collect/pull/4006#discussion_r467854165", "createdAt": "2020-08-10T11:57:53Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/utilities/MediaManager.java", "diffHunk": "@@ -24,7 +24,7 @@\n  * remember an original media file answer (no matter how many times this answer is replaced), in order\n  * to be able to restore the original answer in case of ignoring changes.\n  */\n-public enum MediaManager {\n+public enum MediaManager implements QuestionMediaManager {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "466e31dd54f2a6c426ecbc1c780c7091970d9e62"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MjY4MTc4", "url": "https://github.com/getodk/collect/pull/4006#pullrequestreview-465268178", "createdAt": "2020-08-11T17:13:10Z", "commit": {"oid": "c62b6ef0282141d0327d5058899671611c0468f1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NzEzNDQ4", "url": "https://github.com/getodk/collect/pull/4006#pullrequestreview-466713448", "createdAt": "2020-08-13T12:29:24Z", "commit": {"oid": "fc611fcad1d2dd0f71457606251ff67bae652fa1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMjoyOToyNFrOHAJTqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMjo0NjozOFrOHAJ6BQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkxNDUzNw==", "bodyText": "Maybe this hasn't come through in previous comments and conversations but I'm very against the MediaManager being a singleton. Just to make it very clear I think the MediaManager should be a class (not an enum) and that this line should be:\nreturn (T) new FormSaveViewModel(System::currentTimeMillis, new DiskFormSaver(), analytics, new MediaManager());\nAs we talked about before we could get in trouble with the enum singleton implementation as its state will be carried between different instances of the FormEntryActivity. Also in tests the singleton would not be recreated for each test (as the static state is retained throughout the process) so any state in the MediaManager set up in one test might inadvertently affect another.", "url": "https://github.com/getodk/collect/pull/4006#discussion_r469914537", "createdAt": "2020-08-13T12:29:24Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -370,7 +377,7 @@ public Factory(Analytics analytics) {\n         @NonNull\n         @Override\n         public <T extends ViewModel> T create(@NonNull Class<T> modelClass) {\n-            return (T) new FormSaveViewModel(System::currentTimeMillis, new DiskFormSaver(), analytics);\n+            return (T) new FormSaveViewModel(System::currentTimeMillis, new DiskFormSaver(), analytics, MediaManager.INSTANCE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc611fcad1d2dd0f71457606251ff67bae652fa1"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkxNTgzOQ==", "bodyText": "You shouldn't need to do this as each test will get a new instance of TestWidgetActivity.", "url": "https://github.com/getodk/collect/pull/4006#discussion_r469915839", "createdAt": "2020-08-13T12:31:40Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/widgets/AudioWidgetTest.java", "diffHunk": "@@ -98,6 +102,12 @@ public void setUp() {\n         when(activityAvailability.isActivityAvailable(any())).thenReturn(true);\n     }\n \n+    @After\n+    public void tearDown() {\n+        widgetActivity.originalFiles.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc611fcad1d2dd0f71457606251ff67bae652fa1"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkyNDM1Nw==", "bodyText": "I think we're getting close with the structure but I don't like that the FormEntryActivity implements the QuestionMediaManager. I think instead:\n\nthe AudioWidget should take a QuestionMediaManager in as a dependency at it's constructor rather than casting the context to one.\nthe WidgetFactory should also take a QuestionMediaManager in as one of the args to createWidgetFromPrompt so it can pass it to any widget that needs it.\nFormSaveViewModel#getMediaManager should return a QuestionMediaManager not a MediaManager\nFormSaveViewModel#getMediaManager should be passed as the QuestionMediaManager argument to WidgetFactory#createWidgetFromPrompt\nQuitFormDialogFragment  should call viewModel.getMediaManager().revertChanges rather than relying on the static singleton instance\n\nI'm not sure if I like that currently the QuestionMediaManager is simply owned by the FromSaveViewModel and then exposes it. I'm thinking that potentially the FormSaveViewModel could implement the QuestionMediaManager interface and then there would be no need for the MediaManager class. In that world the \"revert\" call (in QuiteFormDialogFragment could just be part of the logic FormSaveViewModel#removeTempInstance.", "url": "https://github.com/getodk/collect/pull/4006#discussion_r469924357", "createdAt": "2020-08-13T12:46:38Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2674,6 +2675,16 @@ public void onCancelFormLoading() {\n         finish();\n     }\n \n+    @Override\n+    public void deleteOriginalFile(String questionIndex, String fileName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc611fcad1d2dd0f71457606251ff67bae652fa1"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2ODU5MDI4", "url": "https://github.com/getodk/collect/pull/4006#pullrequestreview-466859028", "createdAt": "2020-08-13T15:12:31Z", "commit": {"oid": "2008cb2b2f01e6fa6f5b56d3210b4b038c485c6f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "af09cd96a7553a29c259e9d6f47a8943306c4898", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/af09cd96a7553a29c259e9d6f47a8943306c4898", "committedDate": "2020-08-13T15:31:05Z", "message": "fix failing unit tests"}, "afterCommit": {"oid": "fcfb6b9f3bbd0efac9908dca71b34fbe1fa5a23d", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/fcfb6b9f3bbd0efac9908dca71b34fbe1fa5a23d", "committedDate": "2020-08-13T15:50:01Z", "message": "fix unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NDg5NDUy", "url": "https://github.com/getodk/collect/pull/4006#pullrequestreview-467489452", "createdAt": "2020-08-14T11:00:27Z", "commit": {"oid": "2008cb2b2f01e6fa6f5b56d3210b4b038c485c6f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMTowMDoyN1rOHAwi_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMTowMDo1M1rOHAwjoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU1NzQzOA==", "bodyText": "Do we need to do this in onCleared() as well? Have you played around with the behaviour when \"Don't save activities\" is enabled? It might be good to give that a go and see if we need to handle the case when we leave the app, Android kills the process, and then we return to the app. Would files get left undeleted but on in the form in this case? Would things break?\nLet me know if you have questions about trying that out!", "url": "https://github.com/getodk/collect/pull/4006#discussion_r470557438", "createdAt": "2020-08-14T11:00:27Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -126,6 +127,7 @@ public void removeTempInstance() {\n                 FileUtils.purgeMediaPath(instanceFolder);\n             }\n         }\n+        releaseMediaManager();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2008cb2b2f01e6fa6f5b56d3210b4b038c485c6f"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU1NzYwMA==", "bodyText": "Hmmm. Little worried about the viewmodel being passed into an async task here... It's another awkward change but I think really what should happen here is that a list of files to save should get passed into the save task. Does that make sense? In that world we wouldn't need saveChanges (as it would be handled in DiskFormSaver.", "url": "https://github.com/getodk/collect/pull/4006#discussion_r470557600", "createdAt": "2020-08-14T11:00:53Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -171,7 +173,7 @@ public String getReason() {\n     }\n \n     private void saveToDisk(SaveRequest saveRequest) {\n-        saveTask = new SaveTask(saveRequest, formSaver, formController, mediaManager, new SaveTask.Listener() {\n+        saveTask = new SaveTask(saveRequest, formSaver, formController, this, new SaveTask.Listener() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2008cb2b2f01e6fa6f5b56d3210b4b038c485c6f"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5MzkxNDY3", "url": "https://github.com/getodk/collect/pull/4006#pullrequestreview-469391467", "createdAt": "2020-08-18T12:25:41Z", "commit": {"oid": "59dafaa81457aa8595bdf295fa3812de4e94b89b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "59dafaa81457aa8595bdf295fa3812de4e94b89b", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/59dafaa81457aa8595bdf295fa3812de4e94b89b", "committedDate": "2020-08-14T13:29:01Z", "message": "pass collection files to asynctask"}, "afterCommit": {"oid": "e06f97083a6bbb9982919e3755da4a69aa9bd9a2", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/e06f97083a6bbb9982919e3755da4a69aa9bd9a2", "committedDate": "2020-08-19T09:45:12Z", "message": "pass collection files to asynctask"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8705c9c05a922eb8b2fbb0c4e36febeaee9e35b", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/d8705c9c05a922eb8b2fbb0c4e36febeaee9e35b", "committedDate": "2020-08-25T11:22:35Z", "message": "add unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41ea8a171ca60cf08b410763264e609068df75bd", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/41ea8a171ca60cf08b410763264e609068df75bd", "committedDate": "2020-08-25T11:22:35Z", "message": "add unit tests for Audio Widget"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5db506088f66018eea4d6782eae15841dddb28e", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/d5db506088f66018eea4d6782eae15841dddb28e", "committedDate": "2020-08-25T11:22:35Z", "message": "craete audio_widget_answer.xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bad75cb39b6e4cef96c8e767bb5eb650871111f4", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/bad75cb39b6e4cef96c8e767bb5eb650871111f4", "committedDate": "2020-08-25T11:22:35Z", "message": "update AudioWidget class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0896029b905cafdd43ba6e5009793bbeb0fa3f02", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/0896029b905cafdd43ba6e5009793bbeb0fa3f02", "committedDate": "2020-08-25T11:22:35Z", "message": "update unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c35a3713c79ee58226ed0635bbcb5d554a1d5d7e", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/c35a3713c79ee58226ed0635bbcb5d554a1d5d7e", "committedDate": "2020-08-25T11:22:35Z", "message": "add unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fe63b1b81c99e61a4aa87404c8de0519de352e0", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/0fe63b1b81c99e61a4aa87404c8de0519de352e0", "committedDate": "2020-08-25T11:22:35Z", "message": "code refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bdd4ae8dc2b7e4451306d29050e9ce5ac593f67", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/5bdd4ae8dc2b7e4451306d29050e9ce5ac593f67", "committedDate": "2020-08-25T11:22:35Z", "message": "refactor MediaManagerListener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2ce6ea1d8404ab8f4ea86d5b9adb6b4809d1933", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/f2ce6ea1d8404ab8f4ea86d5b9adb6b4809d1933", "committedDate": "2020-08-25T11:22:35Z", "message": "fix #4005"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70e43ec5b5ae376db5087dfe061c3f7d51e45dca", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/70e43ec5b5ae376db5087dfe061c3f7d51e45dca", "committedDate": "2020-08-25T11:22:35Z", "message": "fix #4008"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f60b09af11fa47d8e4257436fed84af8a11632a8", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/f60b09af11fa47d8e4257436fed84af8a11632a8", "committedDate": "2020-08-25T11:22:35Z", "message": "craete a new style Collect.Button.Layout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "682fdb2ca0dc99732c99f2e558370f8abe43d158", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/682fdb2ca0dc99732c99f2e558370f8abe43d158", "committedDate": "2020-08-25T11:22:35Z", "message": "update unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b569c455f95ab015b4211056a11cd373e8a58cb6", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/b569c455f95ab015b4211056a11cd373e8a58cb6", "committedDate": "2020-08-25T11:22:35Z", "message": "refactor button style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7104f0781ecb984bb75b64705a80bf55f13df83", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/a7104f0781ecb984bb75b64705a80bf55f13df83", "committedDate": "2020-08-25T11:22:35Z", "message": "add unit tests for progress update for AudioPlayerViewModel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8bbd94f8defe4cfd7807a95751254aeb88498b9", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/e8bbd94f8defe4cfd7807a95751254aeb88498b9", "committedDate": "2020-08-25T11:22:35Z", "message": "code refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12cd8f35b3b56f889ff5a9674d519e6a5f27b847", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/12cd8f35b3b56f889ff5a9674d519e6a5f27b847", "committedDate": "2020-08-25T11:22:35Z", "message": "remove QuestionMediaManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1d5a3f611beb65263a373a0e628262e59fe5ac6", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/f1d5a3f611beb65263a373a0e628262e59fe5ac6", "committedDate": "2020-08-25T11:22:35Z", "message": "use formsaveviewmodel to access MediaManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "356f6e15a5e842321e4b0cf3cfbdab0cd93ba1df", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/356f6e15a5e842321e4b0cf3cfbdab0cd93ba1df", "committedDate": "2020-08-25T11:22:35Z", "message": "convert MediaManager to class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4538677195fb3deb685d07793de2992249055562", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/4538677195fb3deb685d07793de2992249055562", "committedDate": "2020-08-25T11:22:35Z", "message": "delete MediaManager class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0ee45dd2bab877779659b2597c3cec6467506cb", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/a0ee45dd2bab877779659b2597c3cec6467506cb", "committedDate": "2020-08-25T11:22:35Z", "message": "fix unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62b6fac8d863b9f1120f4c809cd582ac5e4dfe8e", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/62b6fac8d863b9f1120f4c809cd582ac5e4dfe8e", "committedDate": "2020-08-25T11:22:35Z", "message": "pass collection files to asynctask"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9650495f75e4643076ab868012009114bbd1495e", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/9650495f75e4643076ab868012009114bbd1495e", "committedDate": "2020-08-25T11:22:35Z", "message": "use SavedStateHandle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0f4ef962bf2e044db7eb2be04a752e281fcc7e2", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/a0f4ef962bf2e044db7eb2be04a752e281fcc7e2", "committedDate": "2020-08-25T11:22:35Z", "message": "fix SavedStateHandle error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35225c3250a70e5771ee61e1bbb71df30dc06731", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/35225c3250a70e5771ee61e1bbb71df30dc06731", "committedDate": "2020-08-25T11:22:35Z", "message": "add unit tests for formSaveViewModel"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4b6c91a4315e4493273e03e131c238cd6988c7f", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/a4b6c91a4315e4493273e03e131c238cd6988c7f", "committedDate": "2020-08-25T11:10:11Z", "message": "add unit tests for formSaveViewModel"}, "afterCommit": {"oid": "35225c3250a70e5771ee61e1bbb71df30dc06731", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/35225c3250a70e5771ee61e1bbb71df30dc06731", "committedDate": "2020-08-25T11:22:35Z", "message": "add unit tests for formSaveViewModel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "677af1bbebfc8e3f554555969d1164efaef19ebc", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/677af1bbebfc8e3f554555969d1164efaef19ebc", "committedDate": "2020-08-25T11:39:54Z", "message": "fix unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MzgzMTAx", "url": "https://github.com/getodk/collect/pull/4006#pullrequestreview-474383101", "createdAt": "2020-08-25T11:25:56Z", "commit": {"oid": "9650495f75e4643076ab868012009114bbd1495e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMToyNTo1NlrOHGTjFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMjo0MToxMVrOHGWKxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3Mzc4Mw==", "bodyText": "This could still be set in the constructor right? Could the constructor not just call super then assign the field?", "url": "https://github.com/getodk/collect/pull/4006#discussion_r476373783", "createdAt": "2020-08-25T11:25:56Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -398,20 +420,21 @@ protected void onPostExecute(SaveToDiskResult saveToDiskResult) {\n         }\n     }\n \n-    public static class Factory implements ViewModelProvider.Factory {\n-\n-        private final Analytics analytics;\n+    public static class Factory extends AbstractSavedStateViewModelFactory {\n+        private Analytics analytics;\n \n+        public Factory(@NonNull SavedStateRegistryOwner owner, @Nullable Bundle defaultArgs) {\n+            super(owner, defaultArgs);\n+        }\n \n-        public Factory(Analytics analytics) {\n+        public void setAnalytics(Analytics analytics) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9650495f75e4643076ab868012009114bbd1495e"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3NTc5Nw==", "bodyText": "Do we need to do this if we're also handling it in markOriginalFileOrDelete (same for the RECENT_FILES)?", "url": "https://github.com/getodk/collect/pull/4006#discussion_r476375797", "createdAt": "2020-08-25T11:30:05Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -85,7 +84,9 @@ public FormSaveViewModel(SavedStateHandle stateHandle, Clock clock, FormSaver fo\n \n     @Override\n     protected void onCleared() {\n-        releaseMediaManager();\n+        originalFiles.clear();\n+        recentFiles.clear();\n+\n         stateHandle.set(ORIGINAL_FILES, originalFiles);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0f4ef962bf2e044db7eb2be04a752e281fcc7e2"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQxNjcxMA==", "bodyText": "It looks like all these new tests are mainly there to drive out the use of SavedStateHandle. I think a better way to test it would be more functionally by checking that if I call the methods that set state then use that saved state to create another view model then I get the behaviour I expect (probably that save or ignore do the right thing). This checks that the values are loaded from save state as well as written to it and also means we probably just need one test.", "url": "https://github.com/getodk/collect/pull/4006#discussion_r476416710", "createdAt": "2020-08-25T12:41:11Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -368,6 +395,47 @@ public void resumeFormEntry_clearsSaveResult() {\n         assertThat(saveResult.getValue(), equalTo(null));\n     }\n \n+    @Test\n+    public void markOriginalFileOrDelete_whenFileNameIsEmpty_doesNotSaveFileForDelete() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35225c3250a70e5771ee61e1bbb71df30dc06731"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "205686892a07dd9ff9eee2a1fb0737bbabbafc2f", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/205686892a07dd9ff9eee2a1fb0737bbabbafc2f", "committedDate": "2020-08-25T14:01:59Z", "message": "code refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NjI4Mjg0", "url": "https://github.com/getodk/collect/pull/4006#pullrequestreview-474628284", "createdAt": "2020-08-25T16:01:18Z", "commit": {"oid": "205686892a07dd9ff9eee2a1fb0737bbabbafc2f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjowMToxOFrOHGe_-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjowNToyNFrOHGfLIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2MTQwMQ==", "bodyText": "I think this should check that the files are deleted etc (so check the correct calls are made to mediaUtils) rather than checking the savedStateHandle).", "url": "https://github.com/getodk/collect/pull/4006#discussion_r476561401", "createdAt": "2020-08-25T16:01:18Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -353,6 +353,24 @@ public void whenFormSaverFinishes_mediaManagerIsCleared() {\n         assertThat(recentFiles.isEmpty(), equalTo(true));\n     }\n \n+    @Test\n+    public void whenFormSaverFinishes_onRecreatingFormSaveViewModel_mediaManagerIsCleared() {\n+        viewModel.markOriginalFileOrDelete(\"index\", \"blah\");\n+        viewModel.replaceRecentFileForQuestion(\"index\", \"blah\");\n+\n+        FormSaveViewModel restoredViewModel = new FormSaveViewModel(savedStateHandle, () -> CURRENT_TIME, formSaver, mediaUtils, null);\n+        restoredViewModel.formLoaded(formController);\n+\n+        restoredViewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n+        whenFormSaverFinishes(SaveFormToDisk.SAVED);\n+\n+        Map<String, String> originalFiles = savedStateHandle.get(FormSaveViewModel.ORIGINAL_FILES);\n+        Map<String, String> recentFiles = savedStateHandle.get(FormSaveViewModel.RECENT_FILES);\n+\n+        assertThat(originalFiles.isEmpty(), equalTo(true));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "205686892a07dd9ff9eee2a1fb0737bbabbafc2f"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2MjExMA==", "bodyText": "Actually so maybe we only need markOriginalFileOrDelete_whenQuestionIndexHasAnswer_onRecreatingViewModel_deletesFile? Unless there are reasons to check savedStateHandle directly.", "url": "https://github.com/getodk/collect/pull/4006#discussion_r476562110", "createdAt": "2020-08-25T16:02:22Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -353,6 +353,24 @@ public void whenFormSaverFinishes_mediaManagerIsCleared() {\n         assertThat(recentFiles.isEmpty(), equalTo(true));\n     }\n \n+    @Test\n+    public void whenFormSaverFinishes_onRecreatingFormSaveViewModel_mediaManagerIsCleared() {\n+        viewModel.markOriginalFileOrDelete(\"index\", \"blah\");\n+        viewModel.replaceRecentFileForQuestion(\"index\", \"blah\");\n+\n+        FormSaveViewModel restoredViewModel = new FormSaveViewModel(savedStateHandle, () -> CURRENT_TIME, formSaver, mediaUtils, null);\n+        restoredViewModel.formLoaded(formController);\n+\n+        restoredViewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n+        whenFormSaverFinishes(SaveFormToDisk.SAVED);\n+\n+        Map<String, String> originalFiles = savedStateHandle.get(FormSaveViewModel.ORIGINAL_FILES);\n+        Map<String, String> recentFiles = savedStateHandle.get(FormSaveViewModel.RECENT_FILES);\n+\n+        assertThat(originalFiles.isEmpty(), equalTo(true));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2MTQwMQ=="}, "originalCommit": {"oid": "205686892a07dd9ff9eee2a1fb0737bbabbafc2f"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NDAzMg==", "bodyText": "I don't think we need to clear these variables out here. They are part of the ViewModel which will be removed from memory.", "url": "https://github.com/getodk/collect/pull/4006#discussion_r476564032", "createdAt": "2020-08-25T16:05:06Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -26,37 +29,66 @@\n import org.odk.collect.android.tasks.SaveToDiskResult;\n import org.odk.collect.android.utilities.FileUtils;\n import org.odk.collect.android.utilities.MediaUtils;\n+import org.odk.collect.android.utilities.QuestionMediaManager;\n import org.odk.collect.utilities.Clock;\n \n import java.io.File;\n \n import timber.log.Timber;\n+\n+import java.util.Collection;\n import java.util.HashMap;\n+import java.util.Map;\n \n import static org.odk.collect.android.tasks.SaveFormToDisk.SAVED;\n import static org.odk.collect.android.tasks.SaveFormToDisk.SAVED_AND_EXIT;\n import static org.odk.collect.android.utilities.StringUtils.isBlank;\n \n-public class FormSaveViewModel extends ViewModel implements ProgressDialogFragment.Cancellable, RequiresFormController {\n+public class FormSaveViewModel extends ViewModel implements ProgressDialogFragment.Cancellable, RequiresFormController, QuestionMediaManager {\n+    public static final String ORIGINAL_FILES = \"originalFiles\";\n+    public static final String RECENT_FILES = \"recentFiles\";\n \n+    private final SavedStateHandle stateHandle;\n     private final Clock clock;\n     private final FormSaver formSaver;\n+    private final MediaUtils mediaUtils;\n \n-    private String reason = \"\";\n     private final MutableLiveData<SaveResult> saveResult = new MutableLiveData<>(null);\n+    private String reason = \"\";\n+\n+    private Map<String, String> originalFiles = new HashMap<>();\n+    private Map<String, String> recentFiles = new HashMap<>();\n \n     @Nullable\n     private FormController formController;\n \n     @Nullable\n-    private AsyncTask saveTask;\n+    private AsyncTask<Void, String, SaveToDiskResult> saveTask;\n \n     private final Analytics analytics;\n \n-    public FormSaveViewModel(Clock clock, FormSaver formSaver, Analytics analytics) {\n+    public FormSaveViewModel(SavedStateHandle stateHandle, Clock clock, FormSaver formSaver, MediaUtils mediaUtils, Analytics analytics) {\n+        this.stateHandle = stateHandle;\n         this.clock = clock;\n         this.formSaver = formSaver;\n+        this.mediaUtils = mediaUtils;\n         this.analytics = analytics;\n+\n+        if (stateHandle.get(ORIGINAL_FILES) != null) {\n+            originalFiles = stateHandle.get(ORIGINAL_FILES);\n+        }\n+        if (stateHandle.get(RECENT_FILES) != null) {\n+            recentFiles = stateHandle.get(RECENT_FILES);\n+        }\n+    }\n+\n+    @Override\n+    protected void onCleared() {\n+        originalFiles.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "205686892a07dd9ff9eee2a1fb0737bbabbafc2f"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NDI1Nw==", "bodyText": "I don't think we need anything in here.", "url": "https://github.com/getodk/collect/pull/4006#discussion_r476564257", "createdAt": "2020-08-25T16:05:24Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -85,7 +84,9 @@ public FormSaveViewModel(SavedStateHandle stateHandle, Clock clock, FormSaver fo\n \n     @Override\n     protected void onCleared() {\n-        releaseMediaManager();\n+        originalFiles.clear();\n+        recentFiles.clear();\n+\n         stateHandle.set(ORIGINAL_FILES, originalFiles);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3NTc5Nw=="}, "originalCommit": {"oid": "a0f4ef962bf2e044db7eb2be04a752e281fcc7e2"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88e97298c0cd228f145490c5763455721eba737d", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/88e97298c0cd228f145490c5763455721eba737d", "committedDate": "2020-08-25T17:41:37Z", "message": "code refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NjM0MTQ2", "url": "https://github.com/getodk/collect/pull/4006#pullrequestreview-475634146", "createdAt": "2020-08-26T15:59:05Z", "commit": {"oid": "88e97298c0cd228f145490c5763455721eba737d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNTo1OTowNlrOHHS70A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNjowMTo1OFrOHHTD5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxMjMwNA==", "bodyText": "I'm not sure you need this test and whenFormSaverFinishes_mediaManagerIsCleared. Could you explain it or do you think we should just delete this one?", "url": "https://github.com/getodk/collect/pull/4006#discussion_r477412304", "createdAt": "2020-08-26T15:59:06Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -325,6 +338,39 @@ public void whenFormSaverFinishes_isSaving_returnsFalse() {\n         assertThat(viewModel.isSaving(), equalTo(false));\n     }\n \n+    @Test\n+    public void whenFormSaverFinishes_mediaManagerIsCleared() {\n+        viewModel.markOriginalFileOrDelete(\"index\", \"blah\");\n+        viewModel.replaceRecentFileForQuestion(\"index\", \"blah\");\n+\n+        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", true);\n+        whenFormSaverFinishes(SaveFormToDisk.SAVED);\n+\n+        Map<String, String> originalFiles = savedStateHandle.get(FormSaveViewModel.ORIGINAL_FILES);\n+        Map<String, String> recentFiles = savedStateHandle.get(FormSaveViewModel.RECENT_FILES);\n+\n+        assertThat(originalFiles.isEmpty(), equalTo(true));\n+        assertThat(recentFiles.isEmpty(), equalTo(true));\n+    }\n+\n+    @Test\n+    public void whenFormSaverFinishes_onRecreatingFormSaveViewModel_mediaManagerIsCleared() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97298c0cd228f145490c5763455721eba737d"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxMzk3Mw==", "bodyText": "Instead of verifying the files here I think this test should run saveForm again and check that deleteImageFileFromMediaProvider is only called the first time. Does that make sense? Again, this is to test the intended behaviour rather than an implementation detail of that behaviour.", "url": "https://github.com/getodk/collect/pull/4006#discussion_r477413973", "createdAt": "2020-08-26T16:01:20Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -325,6 +338,39 @@ public void whenFormSaverFinishes_isSaving_returnsFalse() {\n         assertThat(viewModel.isSaving(), equalTo(false));\n     }\n \n+    @Test\n+    public void whenFormSaverFinishes_mediaManagerIsCleared() {\n+        viewModel.markOriginalFileOrDelete(\"index\", \"blah\");\n+        viewModel.replaceRecentFileForQuestion(\"index\", \"blah\");\n+\n+        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", true);\n+        whenFormSaverFinishes(SaveFormToDisk.SAVED);\n+\n+        Map<String, String> originalFiles = savedStateHandle.get(FormSaveViewModel.ORIGINAL_FILES);\n+        Map<String, String> recentFiles = savedStateHandle.get(FormSaveViewModel.RECENT_FILES);\n+\n+        assertThat(originalFiles.isEmpty(), equalTo(true));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97298c0cd228f145490c5763455721eba737d"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxNDM3Mw==", "bodyText": "It looks like you don't need these 4 lines for anything?", "url": "https://github.com/getodk/collect/pull/4006#discussion_r477414373", "createdAt": "2020-08-26T16:01:58Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -59,12 +65,19 @@ public void setup() {\n         formController = mock(FormController.class);\n         logger = mock(AuditEventLogger.class);\n         formSaver = mock(FormSaver.class);\n+        mediaUtils = mock(MediaUtils.class);\n         Analytics analytics = mock(Analytics.class);\n \n         when(formController.getAuditEventLogger()).thenReturn(logger);\n         when(logger.isChangeReasonRequired()).thenReturn(false);\n \n-        viewModel = new FormSaveViewModel(() -> CURRENT_TIME, formSaver, analytics);\n+        Map<String, String> originalFiles = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97298c0cd228f145490c5763455721eba737d"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NzczNDg0", "url": "https://github.com/getodk/collect/pull/4006#pullrequestreview-475773484", "createdAt": "2020-08-26T18:59:45Z", "commit": {"oid": "88e97298c0cd228f145490c5763455721eba737d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxODo1OTo0NVrOHHZf1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxODo1OTo0NVrOHHZf1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUxOTgyOA==", "bodyText": "When saveToDisk() task is complete, I just call clearMediaFiles() . So when I try to verify call to mediaUtils.deleteImageFileFromMediaProvider(), the test fails.", "url": "https://github.com/getodk/collect/pull/4006#discussion_r477519828", "createdAt": "2020-08-26T18:59:45Z", "author": {"login": "SaumiaSinghal"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -253,8 +279,35 @@ public AuditEventLogger getAuditEventLogger() {\n         return formController.getAuditEventLogger();\n     }\n \n-    public static class SaveResult {\n+    @Override\n+    public void markOriginalFileOrDelete(String questionIndex, String fileName) {\n+        if (questionIndex != null && fileName != null) {\n+            if (originalFiles.containsKey(questionIndex)) {\n+                mediaUtils.deleteImageFileFromMediaProvider(fileName);\n+            } else {\n+                originalFiles.put(questionIndex, fileName);\n+                stateHandle.set(ORIGINAL_FILES, originalFiles);\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void replaceRecentFileForQuestion(String questionIndex, String fileName) {\n+        if (questionIndex != null && fileName != null) {\n+            if (recentFiles.containsKey(questionIndex)) {\n+                mediaUtils.deleteImageFileFromMediaProvider(recentFiles.get(questionIndex));\n+            }\n+            recentFiles.put(questionIndex, fileName);\n+            stateHandle.set(RECENT_FILES, recentFiles);\n+        }\n+    }\n \n+    private void clearMediaFiles() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e97298c0cd228f145490c5763455721eba737d"}, "originalPosition": 137}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4970b42ce39921cf72a7819547da4917ae50d1e", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/a4970b42ce39921cf72a7819547da4917ae50d1e", "committedDate": "2020-08-27T10:42:37Z", "message": "craete FakeFormSaver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bd32012affbea012d927138a1d08affc83b5858", "author": {"user": {"login": "SaumiaSinghal", "name": "Saumia Singhal"}}, "url": "https://github.com/getodk/collect/commit/2bd32012affbea012d927138a1d08affc83b5858", "committedDate": "2020-08-27T12:59:37Z", "message": "fix unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NzA5NjU4", "url": "https://github.com/getodk/collect/pull/4006#pullrequestreview-476709658", "createdAt": "2020-08-27T13:17:10Z", "commit": {"oid": "2bd32012affbea012d927138a1d08affc83b5858"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2584, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}