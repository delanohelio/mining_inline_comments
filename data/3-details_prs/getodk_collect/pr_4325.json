{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyNTU1ODE5", "number": 4325, "title": "Fix crash when media file download fails", "bodyText": "Closes #4324\nWhat has been done to verify that this works as intended?\nNew tests.\nWhy is this the best possible solution? Were any other approaches considered?\nThe crash made a lot of sense given how OkHttpConnection is tested and behaved so really just needed to add a test to drive out accounting for the failure case in OpenRosaFormSource.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nJust checking the issue is fixed is probably enough.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-12-18T13:51:57Z", "url": "https://github.com/getodk/collect/pull/4325", "merged": true, "mergeCommit": {"oid": "e2dda7afdfe95e547450f5f89d92a2d174d7196f"}, "closed": true, "closedAt": "2020-12-20T21:44:32Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnYDVrgH2gAyNTQyNTU1ODE5OjY4OTA4NWNiZDNkZjY1NWRlMjA3MWZiZTc5NzUxN2MxNTJmZDBiNTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdoElpmgFqTU1NjAzNTU4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "689085cbd3df655de2071fbe797517c152fd0b53", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/689085cbd3df655de2071fbe797517c152fd0b53", "committedDate": "2020-12-18T13:21:39Z", "message": "Annotate fetchForm"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df2f027766fdaaaed32b8b9d9029b0725a3624ac", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/df2f027766fdaaaed32b8b9d9029b0725a3624ac", "committedDate": "2020-12-18T13:31:49Z", "message": "Make sure FormSource can't return null for media file fetch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1NTIyNDEz", "url": "https://github.com/getodk/collect/pull/4325#pullrequestreview-555522413", "createdAt": "2020-12-18T14:21:41Z", "commit": {"oid": "df2f027766fdaaaed32b8b9d9029b0725a3624ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNDoyMTo0MlrOIIksBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNDoyMTo0MlrOIIksBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg2MDYxMg==", "bodyText": "Wouldn't it be better to check this in mapException and throw new FormSourceException(FETCH_ERROR) there? Then it would be in one place.", "url": "https://github.com/getodk/collect/pull/4325#discussion_r545860612", "createdAt": "2020-12-18T14:21:42Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/openrosa/OpenRosaFormSource.java", "diffHunk": "@@ -100,13 +100,27 @@ public ManifestFile fetchManifest(String manifestURL) throws FormSourceException\n     }\n \n     @Override\n-    public @NotNull InputStream fetchForm(String formURL) throws FormSourceException {\n-        return fetchFile(formURL);\n+    @NotNull\n+    public InputStream fetchForm(String formURL) throws FormSourceException {\n+        InputStream formFile = mapException(() -> openRosaXMLFetcher.getFile(formURL, null));\n+\n+        if (formFile != null) {\n+            return formFile;\n+        } else {\n+            throw new FormSourceException(FETCH_ERROR);\n+        }\n     }\n \n     @Override\n+    @NotNull\n     public InputStream fetchMediaFile(String mediaFileURL) throws FormSourceException {\n-        return mapException(() -> openRosaXMLFetcher.getFile(mediaFileURL, null));\n+        InputStream mediaFile = mapException(() -> openRosaXMLFetcher.getFile(mediaFileURL, null));\n+\n+        if (mediaFile != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df2f027766fdaaaed32b8b9d9029b0725a3624ac"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e5b5807226336f5c742ada7d95a30de1a4efc78", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/1e5b5807226336f5c742ada7d95a30de1a4efc78", "committedDate": "2020-12-20T11:50:20Z", "message": "Move null check into helper method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MDMyODY1", "url": "https://github.com/getodk/collect/pull/4325#pullrequestreview-556032865", "createdAt": "2020-12-20T16:38:05Z", "commit": {"oid": "1e5b5807226336f5c742ada7d95a30de1a4efc78"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MDM1NTg4", "url": "https://github.com/getodk/collect/pull/4325#pullrequestreview-556035588", "createdAt": "2020-12-20T17:14:57Z", "commit": {"oid": "1e5b5807226336f5c742ada7d95a30de1a4efc78"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2386, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}