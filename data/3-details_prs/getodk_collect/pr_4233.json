{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0NjQ4Njk3", "number": 4233, "title": "Rework ResetStateRule ", "bodyText": "This fixes the build. The problem seemed to be that ResetStateRule was trying to clean up using ApplicationResetter. This meant that it needed the databases to exist for it to be able to delete records in it. Really we don't care as we're just trying to simulate an uninstall so instead it now just deletes the scoped and unscoped root dirs.\nI had also had to make changes to a couple of tests that had problems revealed by the changes to to ResetStateRule.\nWhat has been done to verify that this works as intended?\nRan locally and on test lab.\nWhy is this the best possible solution? Were any other approaches considered?\nComments inline.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nNo just changes tests.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-11-20T11:41:38Z", "url": "https://github.com/getodk/collect/pull/4233", "merged": true, "mergeCommit": {"oid": "67fb2ac8943add886a80c08647c568b7f5c9a96c"}, "closed": true, "closedAt": "2020-11-20T12:14:04Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeVEukAH2gAyNTI0NjQ4Njk3OmYwYTAwOGIwMWE4M2M2MDk4NzZmZDUzMDZkMjhiYTRiY2I4MGQ2MWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeWTT3AFqTUzNTM3NzMwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f0a008b01a83c609876fd5306d28ba4bcb80d61f", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/f0a008b01a83c609876fd5306d28ba4bcb80d61f", "committedDate": "2020-11-20T10:48:08Z", "message": "Delete files instead of using ApplicationResetter in tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebcb1404ce88c752b511099d28c301eb2c08ecec", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/ebcb1404ce88c752b511099d28c301eb2c08ecec", "committedDate": "2020-11-20T11:38:56Z", "message": "Make sure rules run in correct order"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MzU2MTYw", "url": "https://github.com/getodk/collect/pull/4233#pullrequestreview-535356160", "createdAt": "2020-11-20T11:42:15Z", "commit": {"oid": "ebcb1404ce88c752b511099d28c301eb2c08ecec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMTo0MjoxNVrOH3MXUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMTo0MjoxNVrOH3MXUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYzNjMwNw==", "bodyText": "This was causing problems as the path it would get would be determined when the class was loaded.", "url": "https://github.com/getodk/collect/pull/4233#discussion_r527636307", "createdAt": "2020-11-20T11:42:15Z", "author": {"login": "seadowg"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/instrumented/utilities/CustomSQLiteQueryExecutionTest.java", "diffHunk": "@@ -20,30 +20,29 @@\n import android.database.Cursor;\n import android.database.sqlite.SQLiteDatabase;\n \n-import androidx.test.rule.GrantPermissionRule;\n import androidx.test.ext.junit.runners.AndroidJUnit4;\n+import androidx.test.rule.GrantPermissionRule;\n \n-import org.junit.Before;\n import org.junit.Rule;\n import org.junit.Test;\n import org.junit.rules.RuleChain;\n import org.junit.runner.RunWith;\n-import org.odk.collect.android.storage.StoragePathProvider;\n-import org.odk.collect.android.storage.StorageSubdirectory;\n-import org.odk.collect.android.support.ResetStateRule;\n+import org.odk.collect.android.support.RunnableRule;\n import org.odk.collect.android.utilities.CustomSQLiteQueryExecutor;\n \n+import java.io.File;\n+import java.io.IOException;\n+\n import static junit.framework.Assert.assertEquals;\n import static junit.framework.Assert.assertFalse;\n import static junit.framework.Assert.assertTrue;\n \n @RunWith(AndroidJUnit4.class)\n public class CustomSQLiteQueryExecutionTest {\n-    private static final String DATABASE_PATH = new StoragePathProvider().getDirPath(StorageSubdirectory.METADATA) + \"/test.db\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebcb1404ce88c752b511099d28c301eb2c08ecec"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MzU2Mzc2", "url": "https://github.com/getodk/collect/pull/4233#pullrequestreview-535356376", "createdAt": "2020-11-20T11:42:34Z", "commit": {"oid": "ebcb1404ce88c752b511099d28c301eb2c08ecec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMTo0MjozNVrOH3MYCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMTo0MjozNVrOH3MYCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYzNjQ5MA==", "bodyText": "This is just testing our db helpers so it doesn't need to talk to our \"real\" db.", "url": "https://github.com/getodk/collect/pull/4233#discussion_r527636490", "createdAt": "2020-11-20T11:42:35Z", "author": {"login": "seadowg"}, "path": "collect_app/src/androidTest/java/org/odk/collect/android/instrumented/utilities/CustomSQLiteQueryExecutionTest.java", "diffHunk": "@@ -53,14 +52,15 @@\n                     Manifest.permission.READ_EXTERNAL_STORAGE,\n                     Manifest.permission.WRITE_EXTERNAL_STORAGE)\n             )\n-            .around(new ResetStateRule());\n-\n-    @Before\n-    public void setUp() {\n-        sqLiteDatabase = SQLiteDatabase.openOrCreateDatabase(DATABASE_PATH, null, null);\n-        dropTable(TEST_TABLE_NAME);\n-        dropTable(TEST_TABLE_NAME_2);\n-    }\n+            .around(new RunnableRule(() -> {\n+                try {\n+                    File dbPath = File.createTempFile(\"test\", \".db\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebcb1404ce88c752b511099d28c301eb2c08ecec"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1Mzc3MzA1", "url": "https://github.com/getodk/collect/pull/4233#pullrequestreview-535377305", "createdAt": "2020-11-20T12:13:58Z", "commit": {"oid": "ebcb1404ce88c752b511099d28c301eb2c08ecec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2478, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}