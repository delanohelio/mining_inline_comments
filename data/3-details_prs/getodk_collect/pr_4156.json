{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5MTc0NTU4", "number": 4156, "title": "Don't attempt to stop location updates if GoogleAPIClient is not already connected", "bodyText": "Closes #4155\nWhat has been done to verify that this works as intended?\nI tested the app with hardcoded disconnecting GoogleApiClient and added tests.\nWhy is this the best possible solution? Were any other approaches considered?\nWe just need to check if the client is connected before performing some operations.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nIt doesn't require testing since it's difficult to reproduce.\nDo we need any specific form for testing your changes? If so, please attach one.\nNo.\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nNo.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-10-07T11:19:13Z", "url": "https://github.com/getodk/collect/pull/4156", "merged": true, "mergeCommit": {"oid": "3215cdc73b95eb536528a5fe041940e2181ad777"}, "closed": true, "closedAt": "2020-10-08T08:18:05Z", "author": {"login": "grzesiek2010"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQK9vtgH2gAyNDk5MTc0NTU4OmEzYWVhMTY3NzkyNDkyYjJlM2U0M2VhODBkNTFjNTYxNGYyOWRmNzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQdJhKAFqTUwNDUzNDAyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a3aea167792492b2e3e43ea80d51c5614f29df72", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/a3aea167792492b2e3e43ea80d51c5614f29df72", "committedDate": "2020-10-07T11:06:31Z", "message": "Fixed bugs in GoogleFusedLocationClient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33228e2a7e483668900cb6f63b018c802636ec01", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/33228e2a7e483668900cb6f63b018c802636ec01", "committedDate": "2020-10-07T11:06:31Z", "message": "Added tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNzc0Mzgz", "url": "https://github.com/getodk/collect/pull/4156#pullrequestreview-503774383", "createdAt": "2020-10-07T11:20:06Z", "commit": {"oid": "33228e2a7e483668900cb6f63b018c802636ec01"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMToyMDowNlrOHdugdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMToyMDowNlrOHdugdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzMjcyNQ==", "bodyText": "This is a fix for another issue https://console.firebase.google.com/u/0/project/api-project-322300403941/crashlytics/app/android:org.odk.collect.android/issues/8bf1ac2f771699358e0237615316760d?time=last-seven-days&versions=v1.28.1%20(3923)&sessionEventKey=5F7C02C1035300012FE4B899DA981953_1458846445087682870", "url": "https://github.com/getodk/collect/pull/4156#discussion_r500932725", "createdAt": "2020-10-07T11:20:06Z", "author": {"login": "grzesiek2010"}, "path": "collect_app/src/main/java/org/odk/collect/android/location/client/GoogleFusedLocationClient.java", "diffHunk": "@@ -141,7 +141,7 @@ public void stopLocationUpdates() {\n     public Location getLastLocation() {\n         // We need to block if the Client isn't already connected:\n         if (!googleApiClient.isConnected()) {\n-            googleApiClient.blockingConnect();\n+            new Thread(googleApiClient::blockingConnect).start();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33228e2a7e483668900cb6f63b018c802636ec01"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzODI0MjEw", "url": "https://github.com/getodk/collect/pull/4156#pullrequestreview-503824210", "createdAt": "2020-10-07T12:28:51Z", "commit": {"oid": "33228e2a7e483668900cb6f63b018c802636ec01"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMjoyODo1MVrOHdw2jQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMjoyODo1MVrOHdw2jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3MTE0OQ==", "bodyText": "I'm a little concerned about this. If the client isn't connected, and we spin up a new thread to connect could that cause problems for the call to getLastLocation (as it might happen before the client is connected)?\nAlso, it's likely the testing of this in GoogleFusedLocationClientTest (using a timeout) will be flakey as the call to blockingConnect is now async (and make the behaviour of the method indeterminate).\nCould we maybe pull this fix out of the PR and look at it as a part of a different PR?", "url": "https://github.com/getodk/collect/pull/4156#discussion_r500971149", "createdAt": "2020-10-07T12:28:51Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/location/client/GoogleFusedLocationClient.java", "diffHunk": "@@ -141,7 +141,7 @@ public void stopLocationUpdates() {\n     public Location getLastLocation() {\n         // We need to block if the Client isn't already connected:\n         if (!googleApiClient.isConnected()) {\n-            googleApiClient.blockingConnect();\n+            new Thread(googleApiClient::blockingConnect).start();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzMjcyNQ=="}, "originalCommit": {"oid": "33228e2a7e483668900cb6f63b018c802636ec01"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MDIxMzg1", "url": "https://github.com/getodk/collect/pull/4156#pullrequestreview-504021385", "createdAt": "2020-10-07T15:45:20Z", "commit": {"oid": "a3aea167792492b2e3e43ea80d51c5614f29df72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNTo0NToyMFrOHd52CQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNTo0NToyMFrOHd52CQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTExODQ3Mw==", "bodyText": "I think it's possible for a locationListener to be set and googleApiClient not to be connected. In that case, locationListener would not be set to null. I think that's not a good state to be in. Just to be safe, I'd wrap only the removeLocationUpdates call.", "url": "https://github.com/getodk/collect/pull/4156#discussion_r501118473", "createdAt": "2020-10-07T15:45:20Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/main/java/org/odk/collect/android/location/client/GoogleFusedLocationClient.java", "diffHunk": "@@ -120,15 +120,15 @@ public void stop() {\n \n     @SuppressLint(\"MissingPermission\") // Permission checks for location services handled in widgets\n     public void requestLocationUpdates(@NonNull LocationListener locationListener) {\n-        if (!isMonitoringLocation()) {\n+        if (!isMonitoringLocation() && googleApiClient.isConnected()) {\n             fusedLocationProviderApi.requestLocationUpdates(googleApiClient, createLocationRequest(), this);\n         }\n \n         this.locationListener = locationListener;\n     }\n \n     public void stopLocationUpdates() {\n-        if (!isMonitoringLocation()) {\n+        if (!isMonitoringLocation() || !googleApiClient.isConnected()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3aea167792492b2e3e43ea80d51c5614f29df72"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "821915f497935503ed1c07f6c805e5b21db42e67", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/821915f497935503ed1c07f6c805e5b21db42e67", "committedDate": "2020-10-07T20:56:56Z", "message": "Improvements"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3db3b065b4aff32fcffe2b41cee4c7efe45a154", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/f3db3b065b4aff32fcffe2b41cee4c7efe45a154", "committedDate": "2020-10-07T20:53:37Z", "message": "Improvements"}, "afterCommit": {"oid": "821915f497935503ed1c07f6c805e5b21db42e67", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/821915f497935503ed1c07f6c805e5b21db42e67", "committedDate": "2020-10-07T20:56:56Z", "message": "Improvements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MzAwMjY2", "url": "https://github.com/getodk/collect/pull/4156#pullrequestreview-504300266", "createdAt": "2020-10-07T22:04:43Z", "commit": {"oid": "821915f497935503ed1c07f6c805e5b21db42e67"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTM0MDI5", "url": "https://github.com/getodk/collect/pull/4156#pullrequestreview-504534029", "createdAt": "2020-10-08T08:17:40Z", "commit": {"oid": "821915f497935503ed1c07f6c805e5b21db42e67"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2418, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}