{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzNTEyOTA0", "number": 4330, "title": "Prevent crash when updating buttons on Main Menu", "bodyText": "This reworks the main menu button code to not use deprecated Cursor requerying and Activity management. Instead, Cursors are just opened and closed as needed.\nI'd advise going through this commit by commit as the first two commits just add a way of preventing (and getting more info about) the crash where as the last two rework the code. If the rework is deemed to risky we could just go with the first two commits.\nWhat has been done to verify that this works as intended?\nVerified manually and ran tests. The button counts are actually tested in quite a lot of places (finalizing forms, sending forms etc) which I confirmed by killing the code and then running tests (~10 failures). It'd be good to look at further refactor and tests (probably pulling the counts out into a ViewModel and working out whether we need a content observer here or not for example) but that feels like a job for another day.\nWhy is this the best possible solution? Were any other approaches considered?\nComment inline.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nShould just prevent the crash which we don't have repro for, so I think checking the button counts update as expected should be the focus.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-12-21T14:22:20Z", "url": "https://github.com/getodk/collect/pull/4330", "merged": true, "mergeCommit": {"oid": "27d8f3071365e3ade7c188239ec8dd140d27751f"}, "closed": true, "closedAt": "2020-12-22T17:57:44Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdoV-oEgH2gAyNTQzNTEyOTA0OjIyODEyZjE5NWNlYTgwM2EyMjQ4NTZlNGFhYzMwZjI2MDUyY2U2Mjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdouZbmgFqTU1NzI2MTYyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "22812f195cea803a224856e4aac30f26052ce628", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/22812f195cea803a224856e4aac30f26052ce628", "committedDate": "2020-12-21T13:30:37Z", "message": "Catch and log crash"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b2af87ba476f6f1d64906920778fada32cd1e07", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/9b2af87ba476f6f1d64906920778fada32cd1e07", "committedDate": "2020-12-21T13:31:30Z", "message": "Log storage migration state with crash"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e04dcc89b69bda46293ce530915d2397d165a40", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/5e04dcc89b69bda46293ce530915d2397d165a40", "committedDate": "2020-12-21T13:43:57Z", "message": "Always reload cursors when updating buttons to avoid cursors pointing at old database"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49d37dc1e1b26754b5c7145d18fb388405c3c224", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/49d37dc1e1b26754b5c7145d18fb388405c3c224", "committedDate": "2020-12-21T14:19:19Z", "message": "Stop using deprecated cursor management/querying"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NDE3NDg0", "url": "https://github.com/getodk/collect/pull/4330#pullrequestreview-556417484", "createdAt": "2020-12-21T14:27:31Z", "commit": {"oid": "49d37dc1e1b26754b5c7145d18fb388405c3c224"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNDoyNzozMVrOIJaFKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNDoyNzozMVrOIJaFKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjczNTQwMw==", "bodyText": "We don't need to keep any of this state in the Activity any longer.", "url": "https://github.com/getodk/collect/pull/4330#discussion_r546735403", "createdAt": "2020-12-21T14:27:31Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/MainMenuActivity.java", "diffHunk": "@@ -96,12 +96,7 @@\n     private Button getFormsButton;\n     private AlertDialog alertDialog;\n     private MenuItem qrcodeScannerMenuItem;\n-    private int completedCount;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d37dc1e1b26754b5c7145d18fb388405c3c224"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NDE4MDIx", "url": "https://github.com/getodk/collect/pull/4330#pullrequestreview-556418021", "createdAt": "2020-12-21T14:28:15Z", "commit": {"oid": "49d37dc1e1b26754b5c7145d18fb388405c3c224"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNDoyODoxNVrOIJaGsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNDoyODoxNVrOIJaGsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjczNTc5Mw==", "bodyText": "requery is deprecated. The advice is to just open a new cursor.", "url": "https://github.com/getodk/collect/pull/4330#discussion_r546735793", "createdAt": "2020-12-21T14:28:15Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/MainMenuActivity.java", "diffHunk": "@@ -422,46 +374,50 @@ public void onClick(DialogInterface dialog, int i) {\n     }\n \n     private void updateButtons() {\n-        if (finalizedCursor != null && !finalizedCursor.isClosed()) {\n-            finalizedCursor.requery();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d37dc1e1b26754b5c7145d18fb388405c3c224"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NDE4NjU1", "url": "https://github.com/getodk/collect/pull/4330#pullrequestreview-556418655", "createdAt": "2020-12-21T14:29:08Z", "commit": {"oid": "49d37dc1e1b26754b5c7145d18fb388405c3c224"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNDoyOTowOFrOIJaIuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNDoyOTowOFrOIJaIuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjczNjMxNQ==", "bodyText": "startManagingCursor is deprecated. Instead of doing this I've switched it to using try-with-resource to manage opening/closing.", "url": "https://github.com/getodk/collect/pull/4330#discussion_r546736315", "createdAt": "2020-12-21T14:29:08Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/MainMenuActivity.java", "diffHunk": "@@ -358,48 +352,6 @@ private void initToolbar() {\n         setSupportActionBar(toolbar);\n     }\n \n-    private void countSavedForms() {\n-        InstancesDao instancesDao = new InstancesDao();\n-\n-        // count for finalized instances\n-        try {\n-            finalizedCursor = instancesDao.getFinalizedInstancesCursor();\n-        } catch (Exception e) {\n-            createErrorDialog(e.getMessage(), EXIT);\n-            return;\n-        }\n-\n-        if (finalizedCursor != null) {\n-            startManagingCursor(finalizedCursor);\n-        }\n-        completedCount = finalizedCursor != null ? finalizedCursor.getCount() : 0;\n-\n-        // count for saved instances\n-        try {\n-            savedCursor = instancesDao.getUnsentInstancesCursor();\n-        } catch (Exception e) {\n-            createErrorDialog(e.getMessage(), EXIT);\n-            return;\n-        }\n-\n-        if (savedCursor != null) {\n-            startManagingCursor(savedCursor);\n-        }\n-        savedCount = savedCursor != null ? savedCursor.getCount() : 0;\n-\n-        //count for view sent form\n-        try {\n-            viewSentCursor = instancesDao.getSentInstancesCursor();\n-        } catch (Exception e) {\n-            createErrorDialog(e.getMessage(), EXIT);\n-            return;\n-        }\n-        if (viewSentCursor != null) {\n-            startManagingCursor(viewSentCursor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d37dc1e1b26754b5c7145d18fb388405c3c224"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NzMwMjk0", "url": "https://github.com/getodk/collect/pull/4330#pullrequestreview-556730294", "createdAt": "2020-12-21T23:40:17Z", "commit": {"oid": "49d37dc1e1b26754b5c7145d18fb388405c3c224"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e96e17911d9128e00c86778973f023d41a6b8e9", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/3e96e17911d9128e00c86778973f023d41a6b8e9", "committedDate": "2020-12-22T17:34:43Z", "message": "Don't show fatal error if there is a DB error updating button counts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MjYxNjI2", "url": "https://github.com/getodk/collect/pull/4330#pullrequestreview-557261626", "createdAt": "2020-12-22T17:57:37Z", "commit": {"oid": "3e96e17911d9128e00c86778973f023d41a6b8e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2397, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}