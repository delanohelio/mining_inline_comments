{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0NDAxOTI0", "number": 3814, "title": "Add analytics that will help shape changes to the onboarding experience", "bodyText": "Adds analytics for form downloads triggered from Get Blank Form. I also verified that we already track usage of the automatic form update settings.\nWhat has been done to verify that this works as intended?\nWrote and ran tests.\nWhy is this the best possible solution? Were any other approaches considered?\nI had trouble deciding how to structure the download analytics because that area of the code doesn't have patterns to follow. There's a viewmodel but it's just holding state that was pulled out to support rotation. I felt there was enough logic involved in the analytics that I wanted the support of tests and I ended up putting that logic in the view model and testing it there. I put the analytics call in the activity and wrote a Robolectric test for that. If any of the tests seem superfluous, you're uncomfortable with the code changes, or you have a better structure to propose, let me know.\nA long time ago now, @shobhitagarwal1612 had put in a PR to add some testing here and it turned into a risky refactor with some behavior regressions. I feel badly that no one had the cycles to work with him on that at the time because there are a ton of challenges that would be good to address in this area of the code.\nParticularly dangerous is that the naming in both FormDownloadListActivity and FormDownloadListViewModel is  misleading. I tried to improve it for things I was touching but I think there are still some possibly problematic cases. For example, the viewmodel keeps track of url which seems like it could be the URL for the server that is currently configured. It is, but it's only set if the activity is launched from an external intent. In general, the external intent path seems hard to understand and brittle. There are other examples of fields that seem like they should have certain meaning but don't or are often null. Because there are no domain concepts, everything is very low level and some information is duplicated making the data flow hard to follow.\nOther things that may need follow-up and/or just bothered me:\n\nWhy is a homegrown insertion sort used to order form definitions in formListDownloadingComplete rather than putting them in a list as they come in and then sorting?\nThe item hashmap built in formListDownloadingComplete is hard to understand and should be replaceable by the Form domain object, possibly with methods added.\nI really wanted to have a higher level FormsRepository rather than using the \"dao\" abstraction but held back since it was just to get a form count.\nI think InstanceUploaderListActivity is missing a call to create the ODK storage directory. Since that class can be launched via intent, that could be a problem if Collect was never launched another way.\nThe method naming in AppDependencyModule is not consistent. Sometimes the prefix is provide and sometimes it's provides.\n\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nThere should be no change to behavior. There is some risk to form download behavior since I did do some refactoring there but I tried to keep it as minimal as possible.\nDo we need any specific form for testing your changes? If so, please attach one.\nNo.\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nNo.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-05-07T00:42:54Z", "url": "https://github.com/getodk/collect/pull/3814", "merged": true, "mergeCommit": {"oid": "87cebc6daec54af52fa3d6dab142af143cf34499"}, "closed": true, "closedAt": "2020-05-14T13:42:42Z", "author": {"login": "lognaturel"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfaEFwABqjMzMTg2ODM2Mzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchMhUNAFqTQxMTc0NjQ0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b817546698a7f2682f51178686cccddb31644b02", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/b817546698a7f2682f51178686cccddb31644b02", "committedDate": "2020-05-07T00:41:57Z", "message": "Track downloading some vs. all forms"}, "afterCommit": {"oid": "eb729cad485d1b045f05b60900ee10c663080bee", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/eb729cad485d1b045f05b60900ee10c663080bee", "committedDate": "2020-05-08T22:52:52Z", "message": "Track form download analytics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb729cad485d1b045f05b60900ee10c663080bee", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/eb729cad485d1b045f05b60900ee10c663080bee", "committedDate": "2020-05-08T22:52:52Z", "message": "Track form download analytics"}, "afterCommit": {"oid": "4e433628a140df6d945523a80a233bb9223378e4", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/4e433628a140df6d945523a80a233bb9223378e4", "committedDate": "2020-05-09T00:20:08Z", "message": "Track form download analytics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MDc3Mzc2", "url": "https://github.com/getodk/collect/pull/3814#pullrequestreview-409077376", "createdAt": "2020-05-11T11:12:21Z", "commit": {"oid": "4e433628a140df6d945523a80a233bb9223378e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMToxMjoyMVrOGTXv9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMToxMjoyMVrOGTXv9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk2NTIzNw==", "bodyText": "How would you feel about moving all of the analytics logging code to the ViewModel here? Ideally startFormDownload would be a ViewModel method and the analytics would be encapsulated within there but right now we could move logDownloadAnalyticsEvent to the ViewModel and then all the analytics testing/concern could be hidden from the Activity (you might still want a test to check the method is called).", "url": "https://github.com/getodk/collect/pull/3814#discussion_r422965237", "createdAt": "2020-05-11T11:12:21Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormDownloadListActivity.java", "diffHunk": "@@ -191,11 +204,10 @@ private void init(Bundle savedInstanceState) {\n \n         downloadButton = findViewById(R.id.add_button);\n         downloadButton.setEnabled(listView.getCheckedItemCount() > 0);\n-        downloadButton.setOnClickListener(new OnClickListener() {\n-            @Override\n-            public void onClick(View v) {\n-                downloadSelectedFiles();\n-            }\n+        downloadButton.setOnClickListener(v -> {\n+            ArrayList<FormDetails> filesToDownload = getFilesToDownload();\n+            logDownloadAnalyticsEvent();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e433628a140df6d945523a80a233bb9223378e4"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MDc5OTcw", "url": "https://github.com/getodk/collect/pull/3814#pullrequestreview-409079970", "createdAt": "2020-05-11T11:16:41Z", "commit": {"oid": "4e433628a140df6d945523a80a233bb9223378e4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c1379659865fd33e3bb65d1a1583f095e4138a83", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/c1379659865fd33e3bb65d1a1583f095e4138a83", "committedDate": "2020-05-13T04:11:51Z", "message": "Fix stale comment about action format"}, "afterCommit": {"oid": "eed1b1e2fd2912b8272183c5ef7d2b813eb8459c", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/eed1b1e2fd2912b8272183c5ef7d2b813eb8459c", "committedDate": "2020-05-13T04:15:39Z", "message": "Fix stale comment about action format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNzMzMzg5", "url": "https://github.com/getodk/collect/pull/3814#pullrequestreview-410733389", "createdAt": "2020-05-13T09:09:07Z", "commit": {"oid": "eed1b1e2fd2912b8272183c5ef7d2b813eb8459c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwOTowOTowN1rOGUohJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwOTowOTowN1rOGUohJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI4ODU0OA==", "bodyText": "These methods (getDownloadAnalyticsEvent and getDownloadAnalyticsDescription) feel like they should be private now as they're just used as helpers for logDownloadAnalyticsEvents and don't feel like they should be part of the external interface of the object. That would also mean reworking the tests a bit.", "url": "https://github.com/getodk/collect/pull/3814#discussion_r424288548", "createdAt": "2020-05-13T09:09:07Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/viewmodels/FormDownloadListViewModel.java", "diffHunk": "@@ -207,4 +226,37 @@ public boolean wasLoadingCanceled() {\n     public void setLoadingCanceled(boolean loadingCanceled) {\n         this.loadingCanceled = loadingCanceled;\n     }\n+\n+    public void logDownloadAnalyticsEvent(int downloadedFormCount, String serverUrl) {\n+        String analyticsEvent = getDownloadAnalyticsEvent(downloadedFormCount);\n+        String analyticsDesc = getDownloadAnalyticsDescription(serverUrl);\n+        analytics.logEvent(analyticsEvent, analyticsDesc);\n+    }\n+\n+    String getDownloadAnalyticsEvent(int downloadedFormCount) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eed1b1e2fd2912b8272183c5ef7d2b813eb8459c"}, "originalPosition": 108}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e19aa605e564c25895cf0f70c6b16bdb3f15b67", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/4e19aa605e564c25895cf0f70c6b16bdb3f15b67", "committedDate": "2020-05-13T21:43:22Z", "message": "Rename fields to make contents clearer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9688b7d4cd3500eb721b43698ee22853c641a0a0", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/9688b7d4cd3500eb721b43698ee22853c641a0a0", "committedDate": "2020-05-13T21:40:59Z", "message": "Make analytics event and description helpers private"}, "afterCommit": {"oid": "0c908b9d5a1beeb895ba562d145f3ad640539c99", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/0c908b9d5a1beeb895ba562d145f3ad640539c99", "committedDate": "2020-05-13T21:43:55Z", "message": "Make analytics event and description helpers private"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8998327c5c573c3a9b75237cb518a9fd57371101", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/8998327c5c573c3a9b75237cb518a9fd57371101", "committedDate": "2020-05-13T21:54:37Z", "message": "Track form download analytics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0c908b9d5a1beeb895ba562d145f3ad640539c99", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/0c908b9d5a1beeb895ba562d145f3ad640539c99", "committedDate": "2020-05-13T21:43:55Z", "message": "Make analytics event and description helpers private"}, "afterCommit": {"oid": "8998327c5c573c3a9b75237cb518a9fd57371101", "author": {"user": {"login": "lognaturel", "name": "H\u00e9l\u00e8ne Martin"}}, "url": "https://github.com/getodk/collect/commit/8998327c5c573c3a9b75237cb518a9fd57371101", "committedDate": "2020-05-13T21:54:37Z", "message": "Track form download analytics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNzQ2NDQ3", "url": "https://github.com/getodk/collect/pull/3814#pullrequestreview-411746447", "createdAt": "2020-05-14T12:20:50Z", "commit": {"oid": "8998327c5c573c3a9b75237cb518a9fd57371101"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2674, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}