{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNzQzOTA2", "number": 4107, "title": "Fixed crash caused by deleted media folder", "bodyText": "Closes #4101\nWhat has been done to verify that this works as intended?\nI tested the fix manually and added automated tests.\nWhy is this the best possible solution? Were any other approaches considered?\nIt''s just a bug fix that didn't take into account that the file we call listFiles() on might not exist. I can't imagine any better solution.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nThis fix should just solve the problem and shouldn't affect anything else so testing the scenario from the issue should be enough.\nDo we need any specific form for testing your changes? If so, please attach one.\nNo.\nDoes this change require updates to documentation? If so, please file an issue here and include the link below.\nNo.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-09-22T07:22:31Z", "url": "https://github.com/getodk/collect/pull/4107", "merged": true, "mergeCommit": {"oid": "8b955c0150cac31205fbd942eeba5416861d6030"}, "closed": true, "closedAt": "2020-09-22T14:16:45Z", "author": {"login": "grzesiek2010"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLSW6NgH2gAyNDkwNzQzOTA2Ojc3ODQ3NjZmZDhjNjA4ZTZjZTJhMzI0Y2I1MTllOTUxNWZkNGYzNzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLYsVegFqTQ5MzUwODcwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7784766fd8c608e6ce2a324cb519e9515fd4f372", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/7784766fd8c608e6ce2a324cb519e9515fd4f372", "committedDate": "2020-09-22T06:53:43Z", "message": "Handle non existing and null files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab848d89f2b6b5947c4fed60ea5b2f18dbb7d3f4", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/ab848d89f2b6b5947c4fed60ea5b2f18dbb7d3f4", "committedDate": "2020-09-22T06:53:53Z", "message": "Added tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMzAxODE0", "url": "https://github.com/getodk/collect/pull/4107#pullrequestreview-493301814", "createdAt": "2020-09-22T09:58:45Z", "commit": {"oid": "ab848d89f2b6b5947c4fed60ea5b2f18dbb7d3f4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOTo1ODo0NVrOHVyxjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMDowMjowMlrOHVy5Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYxNDAyOQ==", "bodyText": "I think we could cut out a lot of the mocking here by having formsDao.getFormMediaPath just return a file path to something that doesn't exist.  You could create a temp dir (using File.createTempDir) and then return a path of a directory in there (that you don't create). Then we wouldn't need to mock a File or FileUtils and listFiles might even work as just a static helper rather than needing to pass in the util as a dependency. What do you think?", "url": "https://github.com/getodk/collect/pull/4107#discussion_r492614029", "createdAt": "2020-09-22T09:58:45Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/database/DatabaseMediaFileRepositoryTest.java", "diffHunk": "@@ -15,6 +18,32 @@ public void whenThereIsNoFormForgivenFormIdAndVersion_shouldGetAllMethodReturnEm\n         FormsDao formsDao = mock(FormsDao.class);\n         when(formsDao.getFormMediaPath(\"1\", \"1\")).thenReturn(null);\n \n-        assertThat(new DatabaseMediaFileRepository(formsDao).getAll(\"1\", \"1\").size(), is(0));\n+        assertThat(new DatabaseMediaFileRepository(formsDao, new FileUtil()).getAll(\"1\", \"1\").size(), is(0));\n+    }\n+\n+    @Test\n+    public void whenMediaFolderFileDoesNotExist_shouldGetAllMethodReturnEmptyArray() {\n+        FormsDao formsDao = mock(FormsDao.class);\n+        FileUtil fileUtil = mock(FileUtil.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab848d89f2b6b5947c4fed60ea5b2f18dbb7d3f4"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYxNTk0Ng==", "bodyText": "I could be missing something but I don't understand how this case can happen? FileUtil#getFileAtPath looks like it couldn't return null.", "url": "https://github.com/getodk/collect/pull/4107#discussion_r492615946", "createdAt": "2020-09-22T10:02:02Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/database/DatabaseMediaFileRepositoryTest.java", "diffHunk": "@@ -15,6 +18,32 @@ public void whenThereIsNoFormForgivenFormIdAndVersion_shouldGetAllMethodReturnEm\n         FormsDao formsDao = mock(FormsDao.class);\n         when(formsDao.getFormMediaPath(\"1\", \"1\")).thenReturn(null);\n \n-        assertThat(new DatabaseMediaFileRepository(formsDao).getAll(\"1\", \"1\").size(), is(0));\n+        assertThat(new DatabaseMediaFileRepository(formsDao, new FileUtil()).getAll(\"1\", \"1\").size(), is(0));\n+    }\n+\n+    @Test\n+    public void whenMediaFolderFileDoesNotExist_shouldGetAllMethodReturnEmptyArray() {\n+        FormsDao formsDao = mock(FormsDao.class);\n+        FileUtil fileUtil = mock(FileUtil.class);\n+        File file = mock(File.class);\n+        String formMediaPath = \"/samplePath/\";\n+\n+        when(formsDao.getFormMediaPath(\"1\", \"1\")).thenReturn(formMediaPath);\n+        when(fileUtil.getFileAtPath(formMediaPath)).thenReturn(file);\n+        when(file.exists()).thenReturn(false);\n+\n+        assertThat(new DatabaseMediaFileRepository(formsDao, new FileUtil()).getAll(\"1\", \"1\").size(), is(0));\n+    }\n+\n+    @Test\n+    public void whenMediaFolderFileIsNull_shouldGetAllMethodReturnEmptyArray() {\n+        FormsDao formsDao = mock(FormsDao.class);\n+        FileUtil fileUtil = mock(FileUtil.class);\n+        String formMediaPath = \"/samplePath/\";\n+\n+        when(formsDao.getFormMediaPath(\"1\", \"1\")).thenReturn(formMediaPath);\n+        when(fileUtil.getFileAtPath(formMediaPath)).thenReturn(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab848d89f2b6b5947c4fed60ea5b2f18dbb7d3f4"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12477a9466d996662bf20bf10f3ac8264109a9fe", "author": {"user": {"login": "grzesiek2010", "name": "Grzegorz Orczykowski"}}, "url": "https://github.com/getodk/collect/commit/12477a9466d996662bf20bf10f3ac8264109a9fe", "committedDate": "2020-09-22T13:38:49Z", "message": "Improved tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNTA4NzA1", "url": "https://github.com/getodk/collect/pull/4107#pullrequestreview-493508705", "createdAt": "2020-09-22T14:16:33Z", "commit": {"oid": "12477a9466d996662bf20bf10f3ac8264109a9fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2401, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}