{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMzI1MTUx", "number": 4118, "title": "Prevent NPE in QuitFormDialogFragment", "bodyText": "Closes #4036\nThis hopefully fixes the crash but it's hard to validate as we don't have reproduction steps.\nWhat has been done to verify that this works as intended?\nIsolated code with bug and wrote new test to cover it.\nWhy is this the best possible solution? Were any other approaches considered?\nComments inline.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nShould just prevent the one case where a null could be set. I think it's a simple enough change that we can merge without QA but maybe still good for them to check loading forms and then ignoring changes here so we're confident when we do a patch release.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-09-24T09:50:39Z", "url": "https://github.com/getodk/collect/pull/4118", "merged": true, "mergeCommit": {"oid": "baf619e81abacf21692fd71f0c8561f8aa5c6c81"}, "closed": true, "closedAt": "2020-09-25T16:31:00Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdL99g2AH2gAyNDkyMzI1MTUxOmY5ZjM0NDI0MTljYjkwNWYxNWI4MzAyYTIxN2QwNjZlZTZkZWNjZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMYZbEgFqTQ5NjU3MzYxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f9f3442419cb905f15b8302a217d066ee6decce2", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/f9f3442419cb905f15b8302a217d066ee6decce2", "committedDate": "2020-09-24T09:41:48Z", "message": "Try to protect FormSaveViewModel from null FormController"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8a120688a7be264065b404a606efde309b708e4", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/d8a120688a7be264065b404a606efde309b708e4", "committedDate": "2020-09-24T09:46:14Z", "message": "Pull ignore changes code into view model"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NDA0NDgw", "url": "https://github.com/getodk/collect/pull/4118#pullrequestreview-495404480", "createdAt": "2020-09-24T09:52:57Z", "commit": {"oid": "d8a120688a7be264065b404a606efde309b708e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwOTo1Mjo1N1rOHXSuow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwOTo1Mjo1N1rOHXSuow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE4NjE0Nw==", "bodyText": "This is the one place where it seemed like we could pass a null to formLoaded as we are checking the singleton field isn't null and then calling the method again. Assigning it here means that we only deal with the one value (null or not).", "url": "https://github.com/getodk/collect/pull/4118#discussion_r494186147", "createdAt": "2020-09-24T09:52:57Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -519,8 +520,9 @@ private void loadForm() {\n             formLoaderTask = (FormLoaderTask) data;\n         } else if (data == null) {\n             if (!newForm) {\n-                if (getFormController() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8a120688a7be264065b404a606efde309b708e4"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e698c37d5cb4e2f7770f22cb5beb52d3697059f4", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/e698c37d5cb4e2f7770f22cb5beb52d3697059f4", "committedDate": "2020-09-24T09:56:20Z", "message": "Add non fatal exception when we get a null formcontroller"}, "afterCommit": {"oid": "d8a120688a7be264065b404a606efde309b708e4", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/d8a120688a7be264065b404a606efde309b708e4", "committedDate": "2020-09-24T09:46:14Z", "message": "Pull ignore changes code into view model"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7566210a00f5d94348bb6c2d5681eb1e8b5ff198", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/7566210a00f5d94348bb6c2d5681eb1e8b5ff198", "committedDate": "2020-09-24T13:45:25Z", "message": "Add test to ensure NPE is solved"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NTkwMDE3", "url": "https://github.com/getodk/collect/pull/4118#pullrequestreview-495590017", "createdAt": "2020-09-24T13:46:35Z", "commit": {"oid": "7566210a00f5d94348bb6c2d5681eb1e8b5ff198"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMzo0NjozNVrOHXbm3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMzo0NjozNVrOHXbm3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMzMTYxMw==", "bodyText": "Much easier to protect form null in the view model", "url": "https://github.com/getodk/collect/pull/4118#discussion_r494331613", "createdAt": "2020-09-24T13:46:35Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -127,8 +128,15 @@ public void saveForm(Uri instanceContentURI, boolean shouldFinalize, String upda\n     }\n \n     // Cleanup when user exits a form without saving\n-    public void removeTempInstance() {\n+    public void ignoreChanges() {\n+        ExternalDataManager manager = Collect.getInstance().getExternalDataManager();\n+        if (manager != null) {\n+            manager.close();\n+        }\n+\n         if (formController != null && formController.getInstanceFile() != null) {\n+            formController.getAuditEventLogger().logEvent(AuditEvent.AuditEventType.FORM_EXIT, true, System.currentTimeMillis());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7566210a00f5d94348bb6c2d5681eb1e8b5ff198"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NTkxMjUz", "url": "https://github.com/getodk/collect/pull/4118#pullrequestreview-495591253", "createdAt": "2020-09-24T13:47:46Z", "commit": {"oid": "7566210a00f5d94348bb6c2d5681eb1e8b5ff198"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMzo0Nzo0NlrOHXbstQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMzo0Nzo0NlrOHXbstQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMzMzEwOQ==", "bodyText": "Definitely could be expanded on but this is good enough to give us a harness to prevent a regression on this particular bug.", "url": "https://github.com/getodk/collect/pull/4118#discussion_r494333109", "createdAt": "2020-09-24T13:47:46Z", "author": {"login": "seadowg"}, "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -411,6 +411,12 @@ public void replaceRecentFileForQuestion_whenQuestionIndexHasAnswer_onRecreating\n         verify(mediaUtils).deleteImageFileFromMediaProvider(\"blah\");\n     }\n \n+    @Test\n+    public void ignoreChanges_whenFormControllerNotSet_doesNothing() {\n+        FormSaveViewModel viewModel = new FormSaveViewModel(savedStateHandle, () -> CURRENT_TIME, formSaver, mediaUtils, null);\n+        viewModel.ignoreChanges(); // Checks nothing explodes", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7566210a00f5d94348bb6c2d5681eb1e8b5ff198"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NzI2MTg5", "url": "https://github.com/getodk/collect/pull/4118#pullrequestreview-495726189", "createdAt": "2020-09-24T16:02:08Z", "commit": {"oid": "7566210a00f5d94348bb6c2d5681eb1e8b5ff198"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjowMjowOFrOHXh-lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjowMjowOFrOHXh-lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQzNTk5MA==", "bodyText": "Haven't you shaken your fist in my general direction about tests without assertions before?! \ud83d\ude05\nMore seriously, I'm not really thinking of anything meaningful to assert and I do think it's ok.", "url": "https://github.com/getodk/collect/pull/4118#discussion_r494435990", "createdAt": "2020-09-24T16:02:08Z", "author": {"login": "lognaturel"}, "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -411,6 +411,12 @@ public void replaceRecentFileForQuestion_whenQuestionIndexHasAnswer_onRecreating\n         verify(mediaUtils).deleteImageFileFromMediaProvider(\"blah\");\n     }\n \n+    @Test\n+    public void ignoreChanges_whenFormControllerNotSet_doesNothing() {\n+        FormSaveViewModel viewModel = new FormSaveViewModel(savedStateHandle, () -> CURRENT_TIME, formSaver, mediaUtils, null);\n+        viewModel.ignoreChanges(); // Checks nothing explodes", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMzMzEwOQ=="}, "originalCommit": {"oid": "7566210a00f5d94348bb6c2d5681eb1e8b5ff198"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f3a801455d5e4fb3b07fe4a5b1c333031dc5b67", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/7f3a801455d5e4fb3b07fe4a5b1c333031dc5b67", "committedDate": "2020-09-25T16:17:41Z", "message": "Still log form exit if instanceFile is null"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NTczNjE5", "url": "https://github.com/getodk/collect/pull/4118#pullrequestreview-496573619", "createdAt": "2020-09-25T16:29:49Z", "commit": {"oid": "7f3a801455d5e4fb3b07fe4a5b1c333031dc5b67"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2409, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}