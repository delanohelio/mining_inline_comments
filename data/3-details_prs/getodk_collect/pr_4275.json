{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzODU5MDEz", "number": 4275, "title": "Add error handling for audio recording", "bodyText": "Closes #4240\nWhat has been done to verify that this works as intended?\nNew tests and verified manually.\nWhy is this the best possible solution? Were any other approaches considered?\nComments inline.\nHow does this change affect users? Describe intentional changes to behavior and behavior that could have accidentally been affected by code changes. In other words, what are the regression risks?\nThe actual error cases here are pretty hard to reproduce, so I think the best way to test this is to try and throw everything at the audio recording and see if we can break it any way that we've not handled.\nDo we need any specific form for testing your changes? If so, please attach one.\nAny audio form.\nBefore submitting this PR, please make sure you have:\n\n run ./gradlew checkAll and confirmed all checks still pass OR confirm CircleCI build passes and run ./gradlew connectedDebugAndroidTest locally.\n verified that any code or assets from external sources are properly credited in comments and/or in the about file.\n verified that any new UI elements use theme colors. UI Components Style guidelines", "createdAt": "2020-12-07T18:19:26Z", "url": "https://github.com/getodk/collect/pull/4275", "merged": true, "mergeCommit": {"oid": "137dbe1099d12c57e96c4266226c5eabd05a7848"}, "closed": true, "closedAt": "2020-12-08T17:20:59Z", "author": {"login": "seadowg"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdj5waPgBqjQwODEwMzU2ODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkNXL6AFqTU0NzQ0OTA0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ab6c053de6c3b911e9d2143f88bdf3131f57301", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/9ab6c053de6c3b911e9d2143f88bdf3131f57301", "committedDate": "2020-12-07T18:16:31Z", "message": "Use Result type"}, "afterCommit": {"oid": "747068c8e1fde90cec118acda36b50acfb8a17c1", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/747068c8e1fde90cec118acda36b50acfb8a17c1", "committedDate": "2020-12-07T18:21:50Z", "message": "Use Result type"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "747068c8e1fde90cec118acda36b50acfb8a17c1", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/747068c8e1fde90cec118acda36b50acfb8a17c1", "committedDate": "2020-12-07T18:21:50Z", "message": "Use Result type"}, "afterCommit": {"oid": "93779860c4c6de8421ef6ec071f031dc71950323", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/93779860c4c6de8421ef6ec071f031dc71950323", "committedDate": "2020-12-07T18:25:51Z", "message": "Use Result type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NDczNjk5", "url": "https://github.com/getodk/collect/pull/4275#pullrequestreview-546473699", "createdAt": "2020-12-07T19:37:38Z", "commit": {"oid": "8d7dcee0b0ddfa8131d93439dac0c993fc1e48b0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxOTozNzozOFrOIA3Xyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxOTozNzozOFrOIA3Xyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc3ODEyMw==", "bodyText": "Pulling these out was a bit of a distraction, but I was focusing on cleaning the interface up a bit and it made sense for the codec config to live separately from the mechanics of recording. This hopefully makes it easier to add a new implementation or codec.", "url": "https://github.com/getodk/collect/pull/4275#discussion_r537778123", "createdAt": "2020-12-07T19:37:38Z", "author": {"login": "seadowg"}, "path": "audiorecorder/src/main/java/org/odk/collect/audiorecorder/mediarecorder/MediaRecorderRecordingResource.kt", "diffHunk": "@@ -61,3 +44,25 @@ internal class MediaRecorderRecordingResource(private val mediaRecorder: MediaRe\n         return mediaRecorder.maxAmplitude\n     }\n }\n+\n+internal class AACRecordingResource(mediaRecorder: MediaRecorder) : MediaRecorderRecordingResource(mediaRecorder) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d7dcee0b0ddfa8131d93439dac0c993fc1e48b0"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff2823998a0818f06438359307e16f734426c7df", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/ff2823998a0818f06438359307e16f734426c7df", "committedDate": "2020-12-08T10:56:20Z", "message": "Pull out media recorder config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "415804deccdab0cfddb21aac5c7476c1b5d9efd0", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/415804deccdab0cfddb21aac5c7476c1b5d9efd0", "committedDate": "2020-12-08T10:56:24Z", "message": "Add exception annotation to method that can explode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eda7841c181d90ebb460942ecfe9abf3797aaf32", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/eda7841c181d90ebb460942ecfe9abf3797aaf32", "committedDate": "2020-12-08T10:56:24Z", "message": "Add exception handling to Recorder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4944d43713c6c504ebd481b74123d74b8e3fdaa6", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/4944d43713c6c504ebd481b74123d74b8e3fdaa6", "committedDate": "2020-12-08T10:56:24Z", "message": "Catch recording start error and expose through viewmodel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20a351b1f93c78fffb5bbbca9d8f45c1c4b267bc", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/20a351b1f93c78fffb5bbbca9d8f45c1c4b267bc", "committedDate": "2020-12-08T10:56:25Z", "message": "Make sure recording error stops service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ce04d8dca79a30c772e18f0300d745f170b4a52", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/7ce04d8dca79a30c772e18f0300d745f170b4a52", "committedDate": "2020-12-08T11:06:59Z", "message": "Show error message when recording fails to start"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee4296f8246da0cea49fe256526ece9ae02e6114", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/ee4296f8246da0cea49fe256526ece9ae02e6114", "committedDate": "2020-12-08T11:07:01Z", "message": "Log error to Timber"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6c4b507ad697f5ced2ab6562c056e7daf746e22", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/f6c4b507ad697f5ced2ab6562c056e7daf746e22", "committedDate": "2020-12-08T11:07:01Z", "message": "Use recording directory in ODK dir rather than cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee79b6b47b693211d81428bb202805d2f1a09ab9", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/ee79b6b47b693211d81428bb202805d2f1a09ab9", "committedDate": "2020-12-08T11:07:01Z", "message": "Make sure filename isn't returned if file not copied"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d33ffc61d023258c86b010bf37615c96cc4a918", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/1d33ffc61d023258c86b010bf37615c96cc4a918", "committedDate": "2020-12-08T11:07:01Z", "message": "Make sure app doesn't crash if copying recording fails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dfaa53627439c504e939656ec937fd6260239e6", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/6dfaa53627439c504e939656ec937fd6260239e6", "committedDate": "2020-12-08T11:07:02Z", "message": "Log answer file copy error to Timber"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05ad0a005182ab82f3fcca87c856b48f7e472eb0", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/05ad0a005182ab82f3fcca87c856b48f7e472eb0", "committedDate": "2020-12-08T11:07:02Z", "message": "Expose answer file copy errors on ViewModel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35b0251056387dc9a01916ef2604a8374a7ddcb4", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/35b0251056387dc9a01916ef2604a8374a7ddcb4", "committedDate": "2020-12-08T11:07:02Z", "message": "Use factory injection for FormSaveViewModel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "007a1c0edcaf93935cd623f6e123367744fe9518", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/007a1c0edcaf93935cd623f6e123367744fe9518", "committedDate": "2020-12-08T11:10:59Z", "message": "Show error when answer file copying fails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8d4d6612538b45a77e2fceef7df6d8005bbd709", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/b8d4d6612538b45a77e2fceef7df6d8005bbd709", "committedDate": "2020-12-08T11:11:01Z", "message": "Don't delete file on clean up so it can be retrieved if there is an error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d330b20976199c914d774c2d019550a38ebf525", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/4d330b20976199c914d774c2d019550a38ebf525", "committedDate": "2020-12-08T11:11:01Z", "message": "Delete recordings after they've been copied to the instance folder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1a8beddd2d4fd4c017bfb5e81ca267e8302728e", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/e1a8beddd2d4fd4c017bfb5e81ca267e8302728e", "committedDate": "2020-12-08T11:11:01Z", "message": "Use Result type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c65831cc725e22fdc26ac5fc87ebb6965d75592a", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/c65831cc725e22fdc26ac5fc87ebb6965d75592a", "committedDate": "2020-12-08T12:13:03Z", "message": "Update test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8d7dcee0b0ddfa8131d93439dac0c993fc1e48b0", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/8d7dcee0b0ddfa8131d93439dac0c993fc1e48b0", "committedDate": "2020-12-07T19:34:54Z", "message": "Move strings to correct place"}, "afterCommit": {"oid": "c65831cc725e22fdc26ac5fc87ebb6965d75592a", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/c65831cc725e22fdc26ac5fc87ebb6965d75592a", "committedDate": "2020-12-08T12:13:03Z", "message": "Update test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MTg0MTE0", "url": "https://github.com/getodk/collect/pull/4275#pullrequestreview-547184114", "createdAt": "2020-12-08T12:24:31Z", "commit": {"oid": "c65831cc725e22fdc26ac5fc87ebb6965d75592a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMjoyNDozMVrOIBXs5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMjoyNDozMVrOIBXs5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMwNzgxMw==", "bodyText": "This isn't tested at the moment. I've added a note to the \"Current Release\" project to come back and look at how DialogFragment classes are tested and try and backfill this. It seems like the options we have from Android's test tooling is a horrid mess of Robolectric and the new scenario stuff.", "url": "https://github.com/getodk/collect/pull/4275#discussion_r538307813", "createdAt": "2020-12-08T12:24:31Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/SaveAnswerFileErrorDialogFragment.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package org.odk.collect.android.formentry.saving;\n+\n+import android.app.Dialog;\n+import android.content.Context;\n+import android.content.DialogInterface;\n+import android.os.Bundle;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.fragment.app.DialogFragment;\n+import androidx.lifecycle.ViewModelProvider;\n+\n+import com.google.android.material.dialog.MaterialAlertDialogBuilder;\n+\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.injection.DaggerUtils;\n+\n+import javax.inject.Inject;\n+\n+public class SaveAnswerFileErrorDialogFragment extends DialogFragment {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c65831cc725e22fdc26ac5fc87ebb6965d75592a"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MTg1MDM3", "url": "https://github.com/getodk/collect/pull/4275#pullrequestreview-547185037", "createdAt": "2020-12-08T12:26:00Z", "commit": {"oid": "c65831cc725e22fdc26ac5fc87ebb6965d75592a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMjoyNjowMFrOIBXwvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMjoyNjowMFrOIBXwvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMwODc5OA==", "bodyText": "I wanted this error to be handled here rather than in the audio specific code as I think we can start using it in other places (rather than just for audio).", "url": "https://github.com/getodk/collect/pull/4275#discussion_r538308798", "createdAt": "2020-12-08T12:26:00Z", "author": {"login": "seadowg"}, "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -372,6 +385,14 @@ private void clearMediaFiles() {\n         recentFiles.clear();\n     }\n \n+    public LiveData<String> getAnswerFileError() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c65831cc725e22fdc26ac5fc87ebb6965d75592a"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "707fb2c893136530f49cdd3497be1a5feb794441", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/707fb2c893136530f49cdd3497be1a5feb794441", "committedDate": "2020-12-08T17:11:32Z", "message": "Update strings"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9e41ca69a9e853aa0bc98b2e304b5d0e2ddb941", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/d9e41ca69a9e853aa0bc98b2e304b5d0e2ddb941", "committedDate": "2020-12-08T17:08:46Z", "message": "Update strings"}, "afterCommit": {"oid": "707fb2c893136530f49cdd3497be1a5feb794441", "author": {"user": {"login": "seadowg", "name": "Callum Stott"}}, "url": "https://github.com/getodk/collect/commit/707fb2c893136530f49cdd3497be1a5feb794441", "committedDate": "2020-12-08T17:11:32Z", "message": "Update strings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NDQ5MDQy", "url": "https://github.com/getodk/collect/pull/4275#pullrequestreview-547449042", "createdAt": "2020-12-08T17:12:36Z", "commit": {"oid": "707fb2c893136530f49cdd3497be1a5feb794441"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2507, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}