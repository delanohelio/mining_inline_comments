{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzNzk4MDg5", "number": 1559, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMDowMjoyOVrOEHD-hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo0Nzo1MVrOEMZIYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1ODQwNjQ3OnYy", "diffSide": "RIGHT", "path": "src/main/java/apoc/custom/CypherProceduresHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMDowMjoyOVrOGmPS3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNjoxOToyN1rOGtwiaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc0OTY2MQ==", "bodyText": "This should be not necessary.", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#discussion_r442749661", "createdAt": "2020-06-19T10:02:29Z", "author": {"login": "conker84"}, "path": "src/main/java/apoc/custom/CypherProceduresHandler.java", "diffHunk": "@@ -598,30 +598,32 @@ private AnyValue convertToValueRecursive(Object... toConverts) {\n \n     public void removeProcedure(String name) {\n         withSystemDb(tx -> {\n-            Node node = Iterators.single(tx.findNodes(SystemLabels.ApocCypherProcedures,\n+            tx.findNodes(SystemLabels.ApocCypherProcedures,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a5a23ce759f2478cf5eec57107ad2243bb4c971"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYzNDM0Nw==", "bodyText": "We can no longer assume there will no more than one result, because there are databases out in the wild affected by #1555 that have multiple records with same name", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#discussion_r450634347", "createdAt": "2020-07-07T06:19:27Z", "author": {"login": "augonis"}, "path": "src/main/java/apoc/custom/CypherProceduresHandler.java", "diffHunk": "@@ -598,30 +598,32 @@ private AnyValue convertToValueRecursive(Object... toConverts) {\n \n     public void removeProcedure(String name) {\n         withSystemDb(tx -> {\n-            Node node = Iterators.single(tx.findNodes(SystemLabels.ApocCypherProcedures,\n+            tx.findNodes(SystemLabels.ApocCypherProcedures,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc0OTY2MQ=="}, "originalCommit": {"oid": "3a5a23ce759f2478cf5eec57107ad2243bb4c971"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1ODQwNzAyOnYy", "diffSide": "RIGHT", "path": "src/main/java/apoc/custom/CypherProceduresHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMDowMjozOFrOGmPTOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNjoxOTo1NFrOGtwi_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc0OTc1Mw==", "bodyText": "This should be not necessary as well", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#discussion_r442749753", "createdAt": "2020-06-19T10:02:38Z", "author": {"login": "conker84"}, "path": "src/main/java/apoc/custom/CypherProceduresHandler.java", "diffHunk": "@@ -598,30 +598,32 @@ private AnyValue convertToValueRecursive(Object... toConverts) {\n \n     public void removeProcedure(String name) {\n         withSystemDb(tx -> {\n-            Node node = Iterators.single(tx.findNodes(SystemLabels.ApocCypherProcedures,\n+            tx.findNodes(SystemLabels.ApocCypherProcedures,\n                     SystemPropertyKeys.database.name(), api.databaseName(),\n                     SystemPropertyKeys.name.name(), name\n-            ).stream().filter(n -> n.hasLabel(SystemLabels.Procedure)).iterator());\n-            ProcedureDescriptor descriptor = procedureDescriptor(node);\n-            registerProcedure(descriptor.getSignature(), null);\n-            registeredProcedureSignatures.remove(descriptor.getSignature());\n-            node.delete();\n-            setLastUpdate(tx);\n+            ).stream().filter(n -> n.hasLabel(SystemLabels.Procedure)).forEach(node -> {\n+                ProcedureDescriptor descriptor = procedureDescriptor(node);\n+                registerProcedure(descriptor.getSignature(), null);\n+                registeredProcedureSignatures.remove(descriptor.getSignature());\n+                node.delete();\n+                setLastUpdate(tx);\n+            });\n             return null;\n         });\n     }\n \n     public void removeFunction(String name) {\n         withSystemDb(tx -> {\n-            Node node = Iterators.single(tx.findNodes(SystemLabels.ApocCypherProcedures,\n+            tx.findNodes(SystemLabels.ApocCypherProcedures,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a5a23ce759f2478cf5eec57107ad2243bb4c971"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYzNDQ5Mg==", "bodyText": "We can no longer assume there will no more than one result, because there are databases out in the wild affected by #1558 that have multiple records with same name", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#discussion_r450634492", "createdAt": "2020-07-07T06:19:54Z", "author": {"login": "augonis"}, "path": "src/main/java/apoc/custom/CypherProceduresHandler.java", "diffHunk": "@@ -598,30 +598,32 @@ private AnyValue convertToValueRecursive(Object... toConverts) {\n \n     public void removeProcedure(String name) {\n         withSystemDb(tx -> {\n-            Node node = Iterators.single(tx.findNodes(SystemLabels.ApocCypherProcedures,\n+            tx.findNodes(SystemLabels.ApocCypherProcedures,\n                     SystemPropertyKeys.database.name(), api.databaseName(),\n                     SystemPropertyKeys.name.name(), name\n-            ).stream().filter(n -> n.hasLabel(SystemLabels.Procedure)).iterator());\n-            ProcedureDescriptor descriptor = procedureDescriptor(node);\n-            registerProcedure(descriptor.getSignature(), null);\n-            registeredProcedureSignatures.remove(descriptor.getSignature());\n-            node.delete();\n-            setLastUpdate(tx);\n+            ).stream().filter(n -> n.hasLabel(SystemLabels.Procedure)).forEach(node -> {\n+                ProcedureDescriptor descriptor = procedureDescriptor(node);\n+                registerProcedure(descriptor.getSignature(), null);\n+                registeredProcedureSignatures.remove(descriptor.getSignature());\n+                node.delete();\n+                setLastUpdate(tx);\n+            });\n             return null;\n         });\n     }\n \n     public void removeFunction(String name) {\n         withSystemDb(tx -> {\n-            Node node = Iterators.single(tx.findNodes(SystemLabels.ApocCypherProcedures,\n+            tx.findNodes(SystemLabels.ApocCypherProcedures,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc0OTc1Mw=="}, "originalCommit": {"oid": "3a5a23ce759f2478cf5eec57107ad2243bb4c971"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDMwMDM4OnYy", "diffSide": "RIGHT", "path": "src/test/java/apoc/custom/CypherProceduresTest.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo0Nzo0MVrOGueT5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwODozOToyNlrOGwLeFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4NDI5NQ==", "bodyText": "Can you also add a test for the system db that checks if there is more than 1 node?", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#discussion_r451384295", "createdAt": "2020-07-08T08:47:41Z", "author": {"login": "conker84"}, "path": "src/test/java/apoc/custom/CypherProceduresTest.java", "diffHunk": "@@ -258,6 +258,22 @@ public void shouldRemoveTheCustomFunction() throws Exception {\n         TestUtil.count(db, \"return custom.answer()\");\n     }\n \n+    @Test\n+    public void shouldOverwriteAndRemoveCustomProcedure() throws Exception {\n+        db.executeTransactionally(\"call apoc.custom.asProcedure('answer','RETURN 42')\");\n+        db.executeTransactionally(\"call apoc.custom.asProcedure('answer','RETURN 42')\");\n+        assertEquals(\"Expecting one procedure listed\", 1, TestUtil.count(db, \"call apoc.custom.list()\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb313780ab64c9bca075140d60c1c8e1dc88a328"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTUwNTM2Nw==", "bodyText": "You mean like a separate test (what exatcly I would be testing? Unit test for Util.mergeNode?) or just a new assertions in these tests?", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#discussion_r451505367", "createdAt": "2020-07-08T12:27:11Z", "author": {"login": "augonis"}, "path": "src/test/java/apoc/custom/CypherProceduresTest.java", "diffHunk": "@@ -258,6 +258,22 @@ public void shouldRemoveTheCustomFunction() throws Exception {\n         TestUtil.count(db, \"return custom.answer()\");\n     }\n \n+    @Test\n+    public void shouldOverwriteAndRemoveCustomProcedure() throws Exception {\n+        db.executeTransactionally(\"call apoc.custom.asProcedure('answer','RETURN 42')\");\n+        db.executeTransactionally(\"call apoc.custom.asProcedure('answer','RETURN 42')\");\n+        assertEquals(\"Expecting one procedure listed\", 1, TestUtil.count(db, \"call apoc.custom.list()\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4NDI5NQ=="}, "originalCommit": {"oid": "fb313780ab64c9bca075140d60c1c8e1dc88a328"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE3NjY4Nw==", "bodyText": "No I mean a new assertion for this test that checks into the system db if there is just one node for the procedure/function; as we removed the Iterators.single now would be better have a direct check into the system db", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#discussion_r452176687", "createdAt": "2020-07-09T12:22:25Z", "author": {"login": "conker84"}, "path": "src/test/java/apoc/custom/CypherProceduresTest.java", "diffHunk": "@@ -258,6 +258,22 @@ public void shouldRemoveTheCustomFunction() throws Exception {\n         TestUtil.count(db, \"return custom.answer()\");\n     }\n \n+    @Test\n+    public void shouldOverwriteAndRemoveCustomProcedure() throws Exception {\n+        db.executeTransactionally(\"call apoc.custom.asProcedure('answer','RETURN 42')\");\n+        db.executeTransactionally(\"call apoc.custom.asProcedure('answer','RETURN 42')\");\n+        assertEquals(\"Expecting one procedure listed\", 1, TestUtil.count(db, \"call apoc.custom.list()\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4NDI5NQ=="}, "originalCommit": {"oid": "fb313780ab64c9bca075140d60c1c8e1dc88a328"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI5NjMzNg==", "bodyText": "assertEquals(\"Expecting one procedure listed\", 1, TestUtil.count(db, \"call apoc.custom.list()\")); already does that, just indirectly.\nAnd to do the check I would be more or less copying the implementation of CypherProceduresHandler.readSignatures, I'm not that comfortable querying db in code (no cypher) to write a bespoke query for the test.", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#discussion_r452296336", "createdAt": "2020-07-09T15:18:07Z", "author": {"login": "augonis"}, "path": "src/test/java/apoc/custom/CypherProceduresTest.java", "diffHunk": "@@ -258,6 +258,22 @@ public void shouldRemoveTheCustomFunction() throws Exception {\n         TestUtil.count(db, \"return custom.answer()\");\n     }\n \n+    @Test\n+    public void shouldOverwriteAndRemoveCustomProcedure() throws Exception {\n+        db.executeTransactionally(\"call apoc.custom.asProcedure('answer','RETURN 42')\");\n+        db.executeTransactionally(\"call apoc.custom.asProcedure('answer','RETURN 42')\");\n+        assertEquals(\"Expecting one procedure listed\", 1, TestUtil.count(db, \"call apoc.custom.list()\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4NDI5NQ=="}, "originalCommit": {"oid": "fb313780ab64c9bca075140d60c1c8e1dc88a328"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3Mjc1Ng==", "bodyText": "ok so let's leave it as is", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#discussion_r453172756", "createdAt": "2020-07-11T08:39:26Z", "author": {"login": "conker84"}, "path": "src/test/java/apoc/custom/CypherProceduresTest.java", "diffHunk": "@@ -258,6 +258,22 @@ public void shouldRemoveTheCustomFunction() throws Exception {\n         TestUtil.count(db, \"return custom.answer()\");\n     }\n \n+    @Test\n+    public void shouldOverwriteAndRemoveCustomProcedure() throws Exception {\n+        db.executeTransactionally(\"call apoc.custom.asProcedure('answer','RETURN 42')\");\n+        db.executeTransactionally(\"call apoc.custom.asProcedure('answer','RETURN 42')\");\n+        assertEquals(\"Expecting one procedure listed\", 1, TestUtil.count(db, \"call apoc.custom.list()\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4NDI5NQ=="}, "originalCommit": {"oid": "fb313780ab64c9bca075140d60c1c8e1dc88a328"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDMwMTEyOnYy", "diffSide": "RIGHT", "path": "src/test/java/apoc/custom/CypherProceduresTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo0Nzo1MVrOGueUVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo0Nzo1MVrOGueUVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4NDQwNg==", "bodyText": "Same as above", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#discussion_r451384406", "createdAt": "2020-07-08T08:47:51Z", "author": {"login": "conker84"}, "path": "src/test/java/apoc/custom/CypherProceduresTest.java", "diffHunk": "@@ -258,6 +258,22 @@ public void shouldRemoveTheCustomFunction() throws Exception {\n         TestUtil.count(db, \"return custom.answer()\");\n     }\n \n+    @Test\n+    public void shouldOverwriteAndRemoveCustomProcedure() throws Exception {\n+        db.executeTransactionally(\"call apoc.custom.asProcedure('answer','RETURN 42')\");\n+        db.executeTransactionally(\"call apoc.custom.asProcedure('answer','RETURN 42')\");\n+        assertEquals(\"Expecting one procedure listed\", 1, TestUtil.count(db, \"call apoc.custom.list()\"));\n+        db.executeTransactionally(\"call apoc.custom.removeProcedure('answer')\");\n+    }\n+\n+    @Test\n+    public void shouldOverwriteAndRemoveCustomFunction() throws Exception {\n+        db.executeTransactionally(\"call apoc.custom.asFunction('answer','RETURN 42','long')\");\n+        db.executeTransactionally(\"call apoc.custom.asFunction('answer','RETURN 42','long')\");\n+        assertEquals(\"Expecting one function listed\", 1, TestUtil.count(db, \"call apoc.custom.list()\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb313780ab64c9bca075140d60c1c8e1dc88a328"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4327, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}