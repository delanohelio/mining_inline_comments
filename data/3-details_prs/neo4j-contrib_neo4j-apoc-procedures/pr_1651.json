{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgwNTEzNDkw", "number": 1651, "title": "db specific initializers", "bodyText": "Adding support for db specific cypher initializers.\nSide note: also added a custom TestRule that allows for test-method specific env settings via annotations.\nPlease cherry pick this one for 4.2 as well.", "createdAt": "2020-09-05T12:41:21Z", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1651", "merged": true, "mergeCommit": {"oid": "733feb4865797885e913a7b0ddea037c9843f6ba"}, "closed": true, "closedAt": "2020-09-10T09:01:57Z", "author": {"login": "sarmbruster"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdF4f_cgH2gAyNDgwNTEzNDkwOjIxNTY3YTBlZmQxOGJhNGY2MGJhODZhNzgxMDc2MDJmNDU1MmJhOTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHHi67gFqTQ4NDc1NTk4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "21567a0efd18ba4f60ba86a78107602f4552ba99", "author": {"user": {"login": "sarmbruster", "name": "Stefan Armbruster"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/21567a0efd18ba4f60ba86a78107602f4552ba99", "committedDate": "2020-09-05T11:56:29Z", "message": "adding a junit test rule allowing to modify env settings\n\nThis is useful if testcases need to have different env settings. A nice way to declaratively test with different apoc settings."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4da1e169b7a9d0c1d92ae64aeedd8d4c64cd98d", "author": {"user": {"login": "sarmbruster", "name": "Stefan Armbruster"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/d4da1e169b7a9d0c1d92ae64aeedd8d4c64cd98d", "committedDate": "2020-09-05T12:26:51Z", "message": "fixes #1644 - support for db specific initializers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMzAyOTU3", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1651#pullrequestreview-483302957", "createdAt": "2020-09-07T07:26:52Z", "commit": {"oid": "d4da1e169b7a9d0c1d92ae64aeedd8d4c64cd98d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNzoyNjo1MlrOHNzMsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNzoyNjo1MlrOHNzMsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIzMjM3MA==", "bodyText": "It's nice if you're deprecating things to add some info on what the replacement is:\ne.g.\n/**\n     * @deprecated\n     * This has been replaced by database-specific initialisers.\n     * Use apoc.initializer.<database name> instead.\n     */", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1651#discussion_r484232370", "createdAt": "2020-09-07T07:26:52Z", "author": {"login": "eastlondoner"}, "path": "core/src/main/java/apoc/ApocConfig.java", "diffHunk": "@@ -57,7 +57,9 @@\n     public static final String APOC_CONFIG_JOBS_SCHEDULED_NUM_THREADS = \"apoc.jobs.scheduled.num_threads\";\n     public static final String APOC_CONFIG_JOBS_POOL_NUM_THREADS = \"apoc.jobs.pool.num_threads\";\n     public static final String APOC_CONFIG_JOBS_QUEUE_SIZE = \"apoc.jobs.queue.size\";\n-    public static final String APOC_CONFIG_INITIALIZER_CYPHER = \"apoc.initializer.cypher\";\n+    public static final String APOC_CONFIG_INITIALIZER = \"apoc.initializer\";\n+    @Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4da1e169b7a9d0c1d92ae64aeedd8d4c64cd98d"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4de2174e09f3c19125d1a0edef98bc85fb5c187d", "author": {"user": {"login": "sarmbruster", "name": "Stefan Armbruster"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/4de2174e09f3c19125d1a0edef98bc85fb5c187d", "committedDate": "2020-09-07T07:45:03Z", "message": "document deprecation details"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMzI4ODkw", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1651#pullrequestreview-483328890", "createdAt": "2020-09-07T07:51:10Z", "commit": {"oid": "4de2174e09f3c19125d1a0edef98bc85fb5c187d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNzo1MToxMFrOHN0MtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNzo1MToxMFrOHN0MtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI0ODc1Ng==", "bodyText": "can we move this higher as a guard clause and just return from the method?\nalso can this whole collecting initializers go into a separate method?", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1651#discussion_r484248756", "createdAt": "2020-09-07T07:51:10Z", "author": {"login": "jexp"}, "path": "core/src/main/java/apoc/cypher/CypherInitializer.java", "diffHunk": "@@ -46,23 +52,31 @@ public void available() {\n         Util.newDaemonThread(() -> {\n \n             try {\n-                awaitApocProceduresRegistered();\n+                final boolean isSystemDatabase = db.databaseName().equals(GraphDatabaseSettings.SYSTEM_DATABASE_NAME);\n+                if (!isSystemDatabase) {\n+                    awaitApocProceduresRegistered();\n+                }\n                 Configuration config = dependencyResolver.resolveDependency(ApocConfig.class).getConfig();\n \n-                TreeMap<String, String> initializers = Iterators.stream(config.getKeys(ApocConfig.APOC_CONFIG_INITIALIZER_CYPHER))\n-                        .collect(Collectors.toMap(k -> k, k -> config.getString(k),\n-                                (v1, v2) -> {\n-                                    throw new RuntimeException(String.format(\"Duplicate key for values %s and %s\", v1, v2));\n-                                },\n-                                TreeMap::new));\n+                TreeMap<String, String> initializers = new TreeMap<>();\n+\n+                config.getKeys(ApocConfig.APOC_CONFIG_INITIALIZER + \".\" + db.databaseName()).forEachRemaining(key -> initializers.put(key, config.getString(key)));\n+\n+                if (!isSystemDatabase) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de2174e09f3c19125d1a0edef98bc85fb5c187d"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMzI5MjY2", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1651#pullrequestreview-483329266", "createdAt": "2020-09-07T07:51:41Z", "commit": {"oid": "4de2174e09f3c19125d1a0edef98bc85fb5c187d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNzo1MTo0MVrOHN0Odg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNzo1MTo0MVrOHN0Odg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI0OTIwNg==", "bodyText": "what is an example of this?", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1651#discussion_r484249206", "createdAt": "2020-09-07T07:51:41Z", "author": {"login": "jexp"}, "path": "core/src/main/java/apoc/cypher/CypherInitializer.java", "diffHunk": "@@ -46,23 +52,31 @@ public void available() {\n         Util.newDaemonThread(() -> {\n \n             try {\n-                awaitApocProceduresRegistered();\n+                final boolean isSystemDatabase = db.databaseName().equals(GraphDatabaseSettings.SYSTEM_DATABASE_NAME);\n+                if (!isSystemDatabase) {\n+                    awaitApocProceduresRegistered();\n+                }\n                 Configuration config = dependencyResolver.resolveDependency(ApocConfig.class).getConfig();\n \n-                TreeMap<String, String> initializers = Iterators.stream(config.getKeys(ApocConfig.APOC_CONFIG_INITIALIZER_CYPHER))\n-                        .collect(Collectors.toMap(k -> k, k -> config.getString(k),\n-                                (v1, v2) -> {\n-                                    throw new RuntimeException(String.format(\"Duplicate key for values %s and %s\", v1, v2));\n-                                },\n-                                TreeMap::new));\n+                TreeMap<String, String> initializers = new TreeMap<>();\n+\n+                config.getKeys(ApocConfig.APOC_CONFIG_INITIALIZER + \".\" + db.databaseName()).forEachRemaining(key -> initializers.put(key, config.getString(key)));\n+\n+                if (!isSystemDatabase) {\n+                    config.getKeys(ApocConfig.APOC_CONFIG_INITIALIZER_CYPHER).forEachRemaining(key -> initializers.put(key, config.getString(key)));\n+                }\n \n                 for (Object initializer : initializers.values()) {\n                     String query = initializer.toString();\n-                    try {\n-                        db.executeTransactionally(query);\n-                        userLog.info(\"successfully initialized: \" + query);\n-                    } catch (Exception e) {\n-                        userLog.warn(\"error upon initialization, running: \" + query, e);\n+                    if (!query.isEmpty()) {\n+                        try {\n+                            // we need to apply a retry strategy here since in systemdb we potentially conflict with\n+                            // creating contraints which could cause our query to fail with a transient error.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de2174e09f3c19125d1a0edef98bc85fb5c187d"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb7ad706d88ea4ac4c914576dbe5cfb5139300b4", "author": {"user": {"login": "sarmbruster", "name": "Stefan Armbruster"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/fb7ad706d88ea4ac4c914576dbe5cfb5139300b4", "committedDate": "2020-09-07T10:13:46Z", "message": "refactor collecting initializers into a separate method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NzU1OTg4", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1651#pullrequestreview-484755988", "createdAt": "2020-09-09T08:02:11Z", "commit": {"oid": "fb7ad706d88ea4ac4c914576dbe5cfb5139300b4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 870, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}