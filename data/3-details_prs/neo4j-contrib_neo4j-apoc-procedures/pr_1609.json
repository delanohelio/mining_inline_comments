{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4OTQ4NTQ0", "number": 1609, "title": "fixes #1387: Failed batches with no error msg from apoc.refactor.rename.type", "bodyText": "Fixes #1387\nImproved returned fields and added configuration params.\nAs the procedures under the hood leverage apoc.periodic.iterate I added configuration params in order to allow fine-tuning on this procedure\nProposed Changes (Mandatory)\nA brief list of proposed changes in order to fix the issue:\n\nAdded config params\nImproved returned messages\nUpdated documentation", "createdAt": "2020-07-30T07:59:12Z", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609", "merged": true, "mergeCommit": {"oid": "5d23208a174fcb3c12cad54eb1c6b7f65fe8da18"}, "closed": true, "closedAt": "2020-11-26T10:24:13Z", "author": {"login": "conker84"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7PFcQAFqTQ1OTkwMzU0Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdN9U4WABqjM4MjQ2OTU2MzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5OTAzNTQz", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609#pullrequestreview-459903543", "createdAt": "2020-08-03T10:02:08Z", "commit": {"oid": "e945e6c31fd72691e7b8c75ca4764bd6e014a2db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMDowMjowOFrOG6zpJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMDowMjowOFrOG6zpJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxNjcxMA==", "bodyText": "need to update description", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609#discussion_r464316710", "createdAt": "2020-08-03T10:02:08Z", "author": {"login": "jexp"}, "path": "src/main/java/apoc/refactor/rename/Rename.java", "diffHunk": "@@ -61,27 +63,52 @@\n \t */\n \t@Procedure(mode = Mode.WRITE)\n \t@Description(\"apoc.refactor.rename.type(oldType, newType, [rels]) | rename all relationships with type 'oldType' to 'newType'. If 'rels' is provided renaming is applied to this set only\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e945e6c31fd72691e7b8c75ca4764bd6e014a2db"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5OTAzOTE4", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609#pullrequestreview-459903918", "createdAt": "2020-08-03T10:02:41Z", "commit": {"oid": "e945e6c31fd72691e7b8c75ca4764bd6e014a2db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMDowMjo0MlrOG6zqHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMDowMjo0MlrOG6zqHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxNjk1Ng==", "bodyText": "perhaps move to Periodic.java or Util.java?", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609#discussion_r464316956", "createdAt": "2020-08-03T10:02:42Z", "author": {"login": "jexp"}, "path": "src/main/java/apoc/refactor/rename/Rename.java", "diffHunk": "@@ -61,27 +63,52 @@\n \t */\n \t@Procedure(mode = Mode.WRITE)\n \t@Description(\"apoc.refactor.rename.type(oldType, newType, [rels]) | rename all relationships with type 'oldType' to 'newType'. If 'rels' is provided renaming is applied to this set only\")\n-\tpublic Stream<BatchAndTotalResultWithInfo> type(@Name(\"oldType\") String oldType, @Name(\"newType\") String newType, @Name(value = \"rels\", defaultValue = \"[]\") List<Relationship> rels) {\n+\tpublic Stream<BatchAndTotalResultWithInfo> type(@Name(\"oldType\") String oldType,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t@Name(\"newType\") String newType,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t@Name(value = \"rels\", defaultValue = \"[]\") List<Relationship> rels,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t@Name(value = \"config\", defaultValue = \"{}\") Map<String, Object> config) {\n \t\trels = rels.stream().map(r -> Util.rebind(tx, r)).collect(Collectors.toList());\n-\t\tList<Long> relIds = rels.stream().map(r -> r.getId()).collect(Collectors.toList());\n \t\tString cypherIterate = rels != null && ! rels.isEmpty() ?\n \t\t\t\t\"UNWIND $rels AS oldRel WITH oldRel WHERE type(oldRel)=\\\"\"+oldType+\"\\\" RETURN oldRel,startNode(oldRel) as a,endNode(oldRel) as b\" :\n \t\t\t\t\"MATCH (a)-[oldRel:`\"+oldType+\"`]->(b) RETURN oldRel,a,b\";\n \t\tString cypherAction = \"CREATE(a)-[newRel:`\"+newType+\"`]->(b)\"+ \"SET newRel+=oldRel DELETE oldRel\";\n-\t\tMap<String, Object> parameters = MapUtil.map(\"batchSize\", 100000, \"parallel\", true, \"iterateList\", true, \"params\", MapUtil.map(\"rels\", rels));\n+\t\tfinal Map<String, Object> params = MapUtil.map(\"rels\", rels);\n+\t\tMap<String, Object> parameters = getPeriodicConfig(config, params);\n \t\treturn getResultOfBatchAndTotalWithInfo(newPeriodic().iterate(cypherIterate, cypherAction, parameters), db, null, oldType, null);\n \t}\n \n+\t@NotNull", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e945e6c31fd72691e7b8c75ca4764bd6e014a2db"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5OTA0MTEx", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609#pullrequestreview-459904111", "createdAt": "2020-08-03T10:03:01Z", "commit": {"oid": "e945e6c31fd72691e7b8c75ca4764bd6e014a2db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMDowMzowMlrOG6zq2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMDowMzowMlrOG6zq2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxNzE0NA==", "bodyText": "adjust description", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609#discussion_r464317144", "createdAt": "2020-08-03T10:03:02Z", "author": {"login": "jexp"}, "path": "src/main/java/apoc/refactor/rename/Rename.java", "diffHunk": "@@ -61,27 +63,52 @@\n \t */\n \t@Procedure(mode = Mode.WRITE)\n \t@Description(\"apoc.refactor.rename.type(oldType, newType, [rels]) | rename all relationships with type 'oldType' to 'newType'. If 'rels' is provided renaming is applied to this set only\")\n-\tpublic Stream<BatchAndTotalResultWithInfo> type(@Name(\"oldType\") String oldType, @Name(\"newType\") String newType, @Name(value = \"rels\", defaultValue = \"[]\") List<Relationship> rels) {\n+\tpublic Stream<BatchAndTotalResultWithInfo> type(@Name(\"oldType\") String oldType,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t@Name(\"newType\") String newType,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t@Name(value = \"rels\", defaultValue = \"[]\") List<Relationship> rels,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t@Name(value = \"config\", defaultValue = \"{}\") Map<String, Object> config) {\n \t\trels = rels.stream().map(r -> Util.rebind(tx, r)).collect(Collectors.toList());\n-\t\tList<Long> relIds = rels.stream().map(r -> r.getId()).collect(Collectors.toList());\n \t\tString cypherIterate = rels != null && ! rels.isEmpty() ?\n \t\t\t\t\"UNWIND $rels AS oldRel WITH oldRel WHERE type(oldRel)=\\\"\"+oldType+\"\\\" RETURN oldRel,startNode(oldRel) as a,endNode(oldRel) as b\" :\n \t\t\t\t\"MATCH (a)-[oldRel:`\"+oldType+\"`]->(b) RETURN oldRel,a,b\";\n \t\tString cypherAction = \"CREATE(a)-[newRel:`\"+newType+\"`]->(b)\"+ \"SET newRel+=oldRel DELETE oldRel\";\n-\t\tMap<String, Object> parameters = MapUtil.map(\"batchSize\", 100000, \"parallel\", true, \"iterateList\", true, \"params\", MapUtil.map(\"rels\", rels));\n+\t\tfinal Map<String, Object> params = MapUtil.map(\"rels\", rels);\n+\t\tMap<String, Object> parameters = getPeriodicConfig(config, params);\n \t\treturn getResultOfBatchAndTotalWithInfo(newPeriodic().iterate(cypherIterate, cypherAction, parameters), db, null, oldType, null);\n \t}\n \n+\t@NotNull\n+\tprivate Map<String, Object> getPeriodicConfig(@Name(value = \"config\", defaultValue = \"{}\") Map<String, Object> config, Map<String, Object> params) {\n+\t\tif (config == null) {\n+\t\t\tconfig = Collections.emptyMap();\n+\t\t}\n+\t\tfinal int batchSize = Util.toInteger(config.getOrDefault(\"batchSize\", 100000));\n+\t\tfinal int concurrency = Util.toInteger(config.getOrDefault(\"concurrency\", 50));\n+\t\tfinal int retries = Util.toInteger(config.getOrDefault(\"retries\", 0));\n+\t\tfinal boolean parallel = Util.toBoolean(config.getOrDefault(\"parallel\", true));\n+\t\tfinal String batchMode = config.getOrDefault(\"batchMode\", \"BATCH\").toString();\n+\t\treturn MapUtil.map(\"batchSize\", batchSize,\n+\t\t\t\t\"retries\", retries,\n+\t\t\t\t\"parallel\", parallel,\n+\t\t\t\t\"batchMode\", batchMode,\n+\t\t\t\t\"concurrency\", concurrency,\n+\t\t\t\t\"params\", params);\n+\t}\n+\n \t/**\n \t * Rename property of a node by creating a new one and deleting the old.\n \t */\n \t@Procedure(mode = Mode.WRITE)\n \t@Description(\"apoc.refactor.rename.nodeProperty(oldName, newName, [nodes]) | rename all node's property from 'oldName' to 'newName'. If 'nodes' is provided renaming is applied to this set only\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e945e6c31fd72691e7b8c75ca4764bd6e014a2db"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5OTA0MjQ2", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609#pullrequestreview-459904246", "createdAt": "2020-08-03T10:03:13Z", "commit": {"oid": "e945e6c31fd72691e7b8c75ca4764bd6e014a2db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMDowMzoxM1rOG6zrMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMDowMzoxM1rOG6zrMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxNzIzMg==", "bodyText": "description", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609#discussion_r464317232", "createdAt": "2020-08-03T10:03:13Z", "author": {"login": "jexp"}, "path": "src/main/java/apoc/refactor/rename/Rename.java", "diffHunk": "@@ -90,11 +117,15 @@\n \t */\n \t@Procedure(mode = Mode.WRITE)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e945e6c31fd72691e7b8c75ca4764bd6e014a2db"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5OTA0NzUw", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1609#pullrequestreview-459904750", "createdAt": "2020-08-03T10:04:04Z", "commit": {"oid": "e945e6c31fd72691e7b8c75ca4764bd6e014a2db"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e945e6c31fd72691e7b8c75ca4764bd6e014a2db", "author": {"user": {"login": "conker84", "name": "Andrea Santurbano"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/e945e6c31fd72691e7b8c75ca4764bd6e014a2db", "committedDate": "2020-07-30T06:58:01Z", "message": "fixes #1387: Failed batches with no error msg from apoc.refactor.rename.type"}, "afterCommit": {"oid": "d7f0def9372522e9255c0a5541f894710aa40ef1", "author": {"user": {"login": "conker84", "name": "Andrea Santurbano"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/d7f0def9372522e9255c0a5541f894710aa40ef1", "committedDate": "2020-09-30T14:00:34Z", "message": "fixes #1387: Failed batches with no error msg from apoc.refactor.rename.type"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d7f0def9372522e9255c0a5541f894710aa40ef1", "author": {"user": {"login": "conker84", "name": "Andrea Santurbano"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/d7f0def9372522e9255c0a5541f894710aa40ef1", "committedDate": "2020-09-30T14:00:34Z", "message": "fixes #1387: Failed batches with no error msg from apoc.refactor.rename.type"}, "afterCommit": {"oid": "45ec81c4eb209ba1d45d2af5374c32fdf6af9be6", "author": {"user": {"login": "conker84", "name": "Andrea Santurbano"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/45ec81c4eb209ba1d45d2af5374c32fdf6af9be6", "committedDate": "2020-09-30T14:04:53Z", "message": "fixes #1387: Failed batches with no error msg from apoc.refactor.rename.type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82ccdc879649d8159ea44f1e784a6fbecc3fa828", "author": {"user": {"login": "conker84", "name": "Andrea Santurbano"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/82ccdc879649d8159ea44f1e784a6fbecc3fa828", "committedDate": "2020-09-30T14:05:08Z", "message": "fixes #1387: Failed batches with no error msg from apoc.refactor.rename.type"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "45ec81c4eb209ba1d45d2af5374c32fdf6af9be6", "author": {"user": {"login": "conker84", "name": "Andrea Santurbano"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/45ec81c4eb209ba1d45d2af5374c32fdf6af9be6", "committedDate": "2020-09-30T14:04:53Z", "message": "fixes #1387: Failed batches with no error msg from apoc.refactor.rename.type"}, "afterCommit": {"oid": "82ccdc879649d8159ea44f1e784a6fbecc3fa828", "author": {"user": {"login": "conker84", "name": "Andrea Santurbano"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/82ccdc879649d8159ea44f1e784a6fbecc3fa828", "committedDate": "2020-09-30T14:05:08Z", "message": "fixes #1387: Failed batches with no error msg from apoc.refactor.rename.type"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 937, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}