{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxNjkyNzM5", "number": 1628, "title": "support both, single command or list of commands for apoc.systemdb.execute", "bodyText": "", "createdAt": "2020-08-21T15:12:32Z", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1628", "merged": true, "mergeCommit": {"oid": "2410a2e2c39ca303ee97695a2a4a67974b3ce848"}, "closed": true, "closedAt": "2021-01-14T14:24:14Z", "author": {"login": "sarmbruster"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBGTCXgH2gAyNDcxNjkyNzM5OmUxYzZjOGIyNDk3ZjFlYmM3Y2JjNjg5YzgxMWQ1MjgwMDFhZmJmZjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDkwcLAH2gAyNDcxNjkyNzM5OjgxZDU1MmQ2NDRlZDNjNTY2YWYwOTllZGZiYjZiYTI0YWE4NDkxYjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e1c6c8b2497f1ebc7cbc689c811d528001afbff4", "author": {"user": {"login": "sarmbruster", "name": "Stefan Armbruster"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/e1c6c8b2497f1ebc7cbc689c811d528001afbff4", "committedDate": "2020-08-21T15:11:23Z", "message": "fixes 1627: support both, a single command or a list of commands for apoc.systemdb.execute"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNjcyODY1", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1628#pullrequestreview-472672865", "createdAt": "2020-08-21T17:39:33Z", "commit": {"oid": "e1c6c8b2497f1ebc7cbc689c811d528001afbff4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxNzozOTozM1rOHE1vkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxNzozOTozM1rOHE1vkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzNjg4MQ==", "bodyText": "should there be some explicit call to roll back on errors?", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1628#discussion_r474836881", "createdAt": "2020-08-21T17:39:33Z", "author": {"login": "eastlondoner"}, "path": "full/src/main/java/apoc/systemdb/SystemDb.java", "diffHunk": "@@ -63,9 +64,23 @@ public NodesAndRelationshipsResult(List<Node> nodes, List<Relationship> relation\n     }\n \n     @Procedure\n-    public Stream<RowResult> execute(@Name(\"DDL command\") String command, @Name(value=\"params\", defaultValue = \"{}\") Map<String ,Object> params) {\n+    public Stream<RowResult> execute(@Name(\"DDL commands, either a string or a list of strings\") Object ddlStringOrList, @Name(value=\"params\", defaultValue = \"{}\") Map<String ,Object> params) {\n         Util.checkAdmin(securityContext,\"apoc.systemdb.execute\");\n-        return withSystemDbTransaction(tx -> tx.execute(command, params).stream().map(map -> new RowResult(map)));\n+\n+        List<String> commands;\n+        if (ddlStringOrList instanceof String) {\n+            commands = Collections.singletonList((String)ddlStringOrList);\n+        } else if (ddlStringOrList instanceof List) {\n+            commands = (List<String>) ddlStringOrList;\n+        } else {\n+            throw new IllegalArgumentException(\"don't know how to handle \" + ddlStringOrList + \". Supply either a string or a list of strings\");\n+        }\n+\n+        Transaction tx = apocConfig.getSystemDb().beginTx();  // we can't use try-with-resources otherwise tx gets closed too early\n+        return commands.stream().flatMap(command -> tx.execute(command, params).stream().map(RowResult::new)).onClose(() -> {\n+            tx.commit();\n+            tx.close();\n+        });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1c6c8b2497f1ebc7cbc689c811d528001afbff4"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81d552d644ed3c566af099edfbb6ba24aa8491b8", "author": {"user": {"login": "sarmbruster", "name": "Stefan Armbruster"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/81d552d644ed3c566af099edfbb6ba24aa8491b8", "committedDate": "2020-08-29T07:48:30Z", "message": "don't commit once tx has failed"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 867, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}