{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzNzk4MDg5", "number": 1559, "title": "Fixes #1555 and #1558 ", "bodyText": "Fixes #1555 and #1558\nFixes the issue and enables repairs for affected users\nProposed Changes\n\nFix typo in Util.mergeNode (cause of the issues)\nLet apoc.custom.removeProcedure and apoc.custom.removeFunction handle existence of multiple records of procedure/function with same name", "createdAt": "2020-06-12T17:15:20Z", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559", "merged": true, "mergeCommit": {"oid": "b38f06b85ceb82bd319b9ca8cf81fe0979fdd90b"}, "closed": true, "closedAt": "2020-10-08T13:14:51Z", "author": {"login": "augonis"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcql2owAH2gAyNDMzNzk4MDg5OmZhMjJjM2U0ZmFlN2NkYWYxMjMzYTRmOWIwODM2ZjYyMzk0ZjBkYTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcz0HkYgFqTQ0Njc4ODcwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fa22c3e4fae7cdaf1233a4f9b0836f62394f0da6", "author": {"user": {"login": "augonis", "name": null}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/fa22c3e4fae7cdaf1233a4f9b0836f62394f0da6", "committedDate": "2020-06-12T16:57:04Z", "message": "Fixes #1555 and #1558\n\nFixes typo in Util.mergeNode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a5a23ce759f2478cf5eec57107ad2243bb4c971", "author": {"user": {"login": "augonis", "name": null}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/3a5a23ce759f2478cf5eec57107ad2243bb4c971", "committedDate": "2020-06-12T17:00:44Z", "message": "Allows fixing damage caused by #1555 and #1558\n\napoc.custom.removeProcedure and apoc.custom.removeFunction no longer expect there to be only one function/procedure with given name.\n\nWith this users affected by #1555 and #1558 can remove the extra functions/procedures."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzOTU0NDE2", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#pullrequestreview-433954416", "createdAt": "2020-06-19T10:02:29Z", "commit": {"oid": "3a5a23ce759f2478cf5eec57107ad2243bb4c971"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMDowMjoyOVrOGmPS3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMDowMjozOFrOGmPTOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc0OTY2MQ==", "bodyText": "This should be not necessary.", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#discussion_r442749661", "createdAt": "2020-06-19T10:02:29Z", "author": {"login": "conker84"}, "path": "src/main/java/apoc/custom/CypherProceduresHandler.java", "diffHunk": "@@ -598,30 +598,32 @@ private AnyValue convertToValueRecursive(Object... toConverts) {\n \n     public void removeProcedure(String name) {\n         withSystemDb(tx -> {\n-            Node node = Iterators.single(tx.findNodes(SystemLabels.ApocCypherProcedures,\n+            tx.findNodes(SystemLabels.ApocCypherProcedures,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a5a23ce759f2478cf5eec57107ad2243bb4c971"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc0OTc1Mw==", "bodyText": "This should be not necessary as well", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#discussion_r442749753", "createdAt": "2020-06-19T10:02:38Z", "author": {"login": "conker84"}, "path": "src/main/java/apoc/custom/CypherProceduresHandler.java", "diffHunk": "@@ -598,30 +598,32 @@ private AnyValue convertToValueRecursive(Object... toConverts) {\n \n     public void removeProcedure(String name) {\n         withSystemDb(tx -> {\n-            Node node = Iterators.single(tx.findNodes(SystemLabels.ApocCypherProcedures,\n+            tx.findNodes(SystemLabels.ApocCypherProcedures,\n                     SystemPropertyKeys.database.name(), api.databaseName(),\n                     SystemPropertyKeys.name.name(), name\n-            ).stream().filter(n -> n.hasLabel(SystemLabels.Procedure)).iterator());\n-            ProcedureDescriptor descriptor = procedureDescriptor(node);\n-            registerProcedure(descriptor.getSignature(), null);\n-            registeredProcedureSignatures.remove(descriptor.getSignature());\n-            node.delete();\n-            setLastUpdate(tx);\n+            ).stream().filter(n -> n.hasLabel(SystemLabels.Procedure)).forEach(node -> {\n+                ProcedureDescriptor descriptor = procedureDescriptor(node);\n+                registerProcedure(descriptor.getSignature(), null);\n+                registeredProcedureSignatures.remove(descriptor.getSignature());\n+                node.delete();\n+                setLastUpdate(tx);\n+            });\n             return null;\n         });\n     }\n \n     public void removeFunction(String name) {\n         withSystemDb(tx -> {\n-            Node node = Iterators.single(tx.findNodes(SystemLabels.ApocCypherProcedures,\n+            tx.findNodes(SystemLabels.ApocCypherProcedures,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a5a23ce759f2478cf5eec57107ad2243bb4c971"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb313780ab64c9bca075140d60c1c8e1dc88a328", "author": {"user": {"login": "augonis", "name": null}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/fb313780ab64c9bca075140d60c1c8e1dc88a328", "committedDate": "2020-06-29T04:53:32Z", "message": "Adds tests for #1555 and #1558"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NTM2NTcx", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#pullrequestreview-444536571", "createdAt": "2020-07-08T08:45:46Z", "commit": {"oid": "fb313780ab64c9bca075140d60c1c8e1dc88a328"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NTM4MDgw", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#pullrequestreview-444538080", "createdAt": "2020-07-08T08:47:41Z", "commit": {"oid": "fb313780ab64c9bca075140d60c1c8e1dc88a328"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo0Nzo0MVrOGueT5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo0Nzo1MVrOGueUVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4NDI5NQ==", "bodyText": "Can you also add a test for the system db that checks if there is more than 1 node?", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#discussion_r451384295", "createdAt": "2020-07-08T08:47:41Z", "author": {"login": "conker84"}, "path": "src/test/java/apoc/custom/CypherProceduresTest.java", "diffHunk": "@@ -258,6 +258,22 @@ public void shouldRemoveTheCustomFunction() throws Exception {\n         TestUtil.count(db, \"return custom.answer()\");\n     }\n \n+    @Test\n+    public void shouldOverwriteAndRemoveCustomProcedure() throws Exception {\n+        db.executeTransactionally(\"call apoc.custom.asProcedure('answer','RETURN 42')\");\n+        db.executeTransactionally(\"call apoc.custom.asProcedure('answer','RETURN 42')\");\n+        assertEquals(\"Expecting one procedure listed\", 1, TestUtil.count(db, \"call apoc.custom.list()\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb313780ab64c9bca075140d60c1c8e1dc88a328"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4NDQwNg==", "bodyText": "Same as above", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#discussion_r451384406", "createdAt": "2020-07-08T08:47:51Z", "author": {"login": "conker84"}, "path": "src/test/java/apoc/custom/CypherProceduresTest.java", "diffHunk": "@@ -258,6 +258,22 @@ public void shouldRemoveTheCustomFunction() throws Exception {\n         TestUtil.count(db, \"return custom.answer()\");\n     }\n \n+    @Test\n+    public void shouldOverwriteAndRemoveCustomProcedure() throws Exception {\n+        db.executeTransactionally(\"call apoc.custom.asProcedure('answer','RETURN 42')\");\n+        db.executeTransactionally(\"call apoc.custom.asProcedure('answer','RETURN 42')\");\n+        assertEquals(\"Expecting one procedure listed\", 1, TestUtil.count(db, \"call apoc.custom.list()\"));\n+        db.executeTransactionally(\"call apoc.custom.removeProcedure('answer')\");\n+    }\n+\n+    @Test\n+    public void shouldOverwriteAndRemoveCustomFunction() throws Exception {\n+        db.executeTransactionally(\"call apoc.custom.asFunction('answer','RETURN 42','long')\");\n+        db.executeTransactionally(\"call apoc.custom.asFunction('answer','RETURN 42','long')\");\n+        assertEquals(\"Expecting one function listed\", 1, TestUtil.count(db, \"call apoc.custom.list()\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb313780ab64c9bca075140d60c1c8e1dc88a328"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2Nzg4NzA3", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1559#pullrequestreview-446788707", "createdAt": "2020-07-11T08:39:33Z", "commit": {"oid": "fb313780ab64c9bca075140d60c1c8e1dc88a328"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 929, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}