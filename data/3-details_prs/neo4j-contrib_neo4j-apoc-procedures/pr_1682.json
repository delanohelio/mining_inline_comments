{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4NjgwODE4", "number": 1682, "title": "Handle Optional.empty() function descriptions", "bodyText": "This handles loading a stored APOC custom state where\na function or procedure had an Optional.empty() description.\nJackson serialized those to {\"present::false}, which then broke\nApocs assumptions about the schema here.\nThis makes it so we handle any in-the-wild incarnations of this,\nand modifies our write path to always ensure the value is a string\nFixes #<Replace with the number of the issue, Mandatory>\nOne sentence summary of the change.\nProposed Changes (Mandatory)\nA brief list of proposed changes in order to fix the issue:\nWhen APOC serializes custom function/procedure state, it does this:\nMap<String, Object> data = map(\"statement\", statement, \"mode\", signature.mode().toString(), \"signature\", signature.toString(), \"description\", signature.description());\n\nWhich assumes signature.description() won't be Optional.empty() (it seems that's been changed to be Optional since the original apoc code was written). In cases where it is empty, the end-result JSON will be {\"present\":false}, rather than a string, which then breaks APOC loading the state back again.\nThis changes the serialization behavior to always result in a string, and also modifies the deserialization behavior to handle existing in-the-wild stores that have ran into this issue.", "createdAt": "2020-10-06T16:27:16Z", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1682", "merged": true, "mergeCommit": {"oid": "d7e021f96feb1eda6af886635744a528616778bb"}, "closed": true, "closedAt": "2020-10-06T17:59:01Z", "author": {"login": "jakewins"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP67zjgH2gAyNDk4NjgwODE4OjdiNzU4MjA3M2EyY2VhMGIyMDY1MTA3ODFmOGZiMDAxNDNmNjJjYmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdP8NJnABqjM4NDY4MjA5NDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7b7582073a2cea0b206510781f8fb00143f62cbc", "author": {"user": {"login": "jakewins", "name": "Jacob Davis-Hansson"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/7b7582073a2cea0b206510781f8fb00143f62cbc", "committedDate": "2020-10-06T16:25:55Z", "message": "Handle Optional.empty() function descriptions\n\nThis handles loading a stored APOC custom state where\na function or procedure had an Optional.empty() description.\n\nJackson serialized those to {\"present::false}, which then broke\nApocs assumptions about the schema here.\n\nThis makes it so we handle any in-the-wild incarnations of this,\nand modifies our write path to always ensure the value is a string"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjAxNTQz", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1682#pullrequestreview-503201543", "createdAt": "2020-10-06T17:31:08Z", "commit": {"oid": "7b7582073a2cea0b206510781f8fb00143f62cbc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzozMTowOFrOHdSjVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzozMTowOFrOHdSjVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NDcwOQ==", "bodyText": "should probably return null as well", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1682#discussion_r500474709", "createdAt": "2020-10-06T17:31:08Z", "author": {"login": "jexp"}, "path": "src/main/java/apoc/custom/CypherProcedures.java", "diffHunk": "@@ -565,6 +566,18 @@ private void restoreProcedures() {\n             clearQueryCaches(api);\n         }\n \n+        private String parseStoredDescription(Object rawDescription) {\n+            // Description was changed to be an Optional in the Neo4j internal API. Optional.None serialized to\n+            // JSON objects in various stores around the world; hence, deal with this value not being a string\n+            if(rawDescription instanceof String) {\n+                if(\"null\".equals(rawDescription)) {\n+                    return null;\n+                }\n+                return (String)rawDescription;\n+            }\n+            return \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b7582073a2cea0b206510781f8fb00143f62cbc"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjAyMzk5", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1682#pullrequestreview-503202399", "createdAt": "2020-10-06T17:32:11Z", "commit": {"oid": "7b7582073a2cea0b206510781f8fb00143f62cbc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjEzMzcx", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1682#pullrequestreview-503213371", "createdAt": "2020-10-06T17:46:42Z", "commit": {"oid": "8aa81ec278410dcb8d0f66b98bc6ed32c7ffce79"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo0Njo0MlrOHdTG6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo0Njo0MlrOHdTG6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4MzgxOA==", "bodyText": "sorry I overlooked this b/c it was too far on the right :) can you use .orElse(null) so that we're consistent? in the 2 places?", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1682#discussion_r500483818", "createdAt": "2020-10-06T17:46:42Z", "author": {"login": "jexp"}, "path": "src/main/java/apoc/custom/CypherProcedures.java", "diffHunk": "@@ -589,7 +602,7 @@ public void unavailable() {\n         }\n \n         public static Map<String, Object> storeFunction(GraphDatabaseAPI api, UserFunctionSignature signature, String statement, boolean forceSingle) {\n-            Map<String, Object> data = map(\"statement\", statement, \"forceSingle\", forceSingle, \"signature\", signature.toString(), \"description\", signature.description());\n+            Map<String, Object> data = map(\"statement\", statement, \"forceSingle\", forceSingle, \"signature\", signature.toString(), \"description\", signature.description().orElse(\"\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8aa81ec278410dcb8d0f66b98bc6ed32c7ffce79"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "344fb9c1234d1bf212067a15f567e0cc4f7e48f6", "author": {"user": {"login": "jakewins", "name": "Jacob Davis-Hansson"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/344fb9c1234d1bf212067a15f567e0cc4f7e48f6", "committedDate": "2020-10-06T17:53:12Z", "message": "Fix review comments on handling Optional.empty()\n\nStandardize on null for strings that were serialized to maps."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8aa81ec278410dcb8d0f66b98bc6ed32c7ffce79", "author": {"user": {"login": "jakewins", "name": "Jacob Davis-Hansson"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/8aa81ec278410dcb8d0f66b98bc6ed32c7ffce79", "committedDate": "2020-10-06T17:41:27Z", "message": "Fix review comments on handling Optional.empty()\n\nStandardize on null for strings that were serialized to maps."}, "afterCommit": {"oid": "344fb9c1234d1bf212067a15f567e0cc4f7e48f6", "author": {"user": {"login": "jakewins", "name": "Jacob Davis-Hansson"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/344fb9c1234d1bf212067a15f567e0cc4f7e48f6", "committedDate": "2020-10-06T17:53:12Z", "message": "Fix review comments on handling Optional.empty()\n\nStandardize on null for strings that were serialized to maps."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 879, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}