{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMDk1MTY0", "number": 1672, "title": "Issue #1608: Improve deletion performance and remove the 1000 limit", "bodyText": "Fixes #1608\nOne sentence summary of the change.\nProposed Changes (Mandatory)\nA brief list of proposed changes in order to fix the issue:\n\nremoved limit 1000 to apoc.ttl.expire and apoc.ttl.expireIn\naddedTTLTest for apoc.ttl procedures\nchanged apoc.ttl.expireAtInstant and apoc.ttl.expireAfterTimeLength to apoc.ttl.expire and apoc.ttl.expireIn", "createdAt": "2020-09-21T07:14:09Z", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1672", "merged": true, "mergeCommit": {"oid": "4151e67a2ff69e52394b75738f73ef7c98cf2ad2"}, "closed": true, "closedAt": "2021-01-14T14:21:49Z", "author": {"login": "vga91"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgUJMGgBqjQwNDI4ODA2ODA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdvv2bkAH2gAyNDkwMDk1MTY0OjZjOTcyMmRjZGZiOThkYzQ3NWI4NTI3MjYyZWUwM2Y5NmNhZDYyYTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d40f0b684fbd2e17353247fcd804147d77c98375", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/d40f0b684fbd2e17353247fcd804147d77c98375", "committedDate": "2020-10-01T14:35:54Z", "message": "white-space"}, "afterCommit": {"oid": "0611deff9983c4841763e896d6f76e05ffcd9fba", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/0611deff9983c4841763e896d6f76e05ffcd9fba", "committedDate": "2020-11-26T14:50:17Z", "message": "changed long to ing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc020a0d099fb27b4951fbc3a7148e12d23aae23", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/dc020a0d099fb27b4951fbc3a7148e12d23aae23", "committedDate": "2020-12-06T18:19:25Z", "message": "#1608: improve apoc.ttl to enable deletion of more than 1000 nodes at once"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "840c386d147a1d17b96c28d1d454f90a5c3dcc72", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/840c386d147a1d17b96c28d1d454f90a5c3dcc72", "committedDate": "2020-12-06T18:19:25Z", "message": "changes review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47a9d7139ca73abbe2203641b0f9dbece7d7cb3a", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/47a9d7139ca73abbe2203641b0f9dbece7d7cb3a", "committedDate": "2020-12-06T18:19:25Z", "message": "removed unused import, format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "844ecb14d2727ab76497c3d165f47d6beb3e24d4", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/844ecb14d2727ab76497c3d165f47d6beb3e24d4", "committedDate": "2020-12-06T18:19:25Z", "message": "changed deprecated by, description and moved TTLTest from apoc.date to apoc.ttl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12daf4398b212f679f9c080da0259d5814621015", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/12daf4398b212f679f9c080da0259d5814621015", "committedDate": "2020-12-06T18:19:25Z", "message": "removed unused import DateExpiry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23cf8a867a5fb5e83bfd4d7da602b34cd2df7544", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/23cf8a867a5fb5e83bfd4d7da602b34cd2df7544", "committedDate": "2020-12-06T18:19:25Z", "message": "reset default limit 1000"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "042b0281ee7d77c69f2c443a150ea7de47f533a7", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/042b0281ee7d77c69f2c443a150ea7de47f533a7", "committedDate": "2020-12-06T18:19:25Z", "message": "changed test and query delete with periodic.iterate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f36d50ed9e2b86c642da84dba0b8c24451394340", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/f36d50ed9e2b86c642da84dba0b8c24451394340", "committedDate": "2020-12-06T18:19:25Z", "message": "removed import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d187d4e9ac9006e55e7f4d9d07dc372829a6eaef", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/d187d4e9ac9006e55e7f4d9d07dc372829a6eaef", "committedDate": "2020-12-06T18:19:25Z", "message": "removed whitespaces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18f1a2a7997ddcae4b2da55d1c358057bfb26de6", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/18f1a2a7997ddcae4b2da55d1c358057bfb26de6", "committedDate": "2020-12-06T18:19:25Z", "message": "changes review - added param batchsize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "014718080ba16c353a4a0d1730a52fc031c35579", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/014718080ba16c353a4a0d1730a52fc031c35579", "committedDate": "2020-12-06T18:19:25Z", "message": "splitted periodic iterate, fixed log.info() and added rels to test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0e1a42e27d82285107cc727777e872af333f2b5", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/d0e1a42e27d82285107cc727777e872af333f2b5", "committedDate": "2020-12-06T18:19:25Z", "message": "changed log handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a9e06ab230bbdd404ac30de8188d9fc9da44d06", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/3a9e06ab230bbdd404ac30de8188d9fc9da44d06", "committedDate": "2020-12-06T18:19:25Z", "message": "changes TTLTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6dd435b9b8f1cd53da93bdb3c4572213c3e0397", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/a6dd435b9b8f1cd53da93bdb3c4572213c3e0397", "committedDate": "2020-12-06T18:19:25Z", "message": "removed comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "271d1e96097f8e347a1598f88a64f6d3428e369f", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/271d1e96097f8e347a1598f88a64f6d3428e369f", "committedDate": "2020-12-06T18:19:25Z", "message": "white-space"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19635eeae5a5f258e5ed0940339173dc2e64e798", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/19635eeae5a5f258e5ed0940339173dc2e64e798", "committedDate": "2020-12-06T18:19:25Z", "message": "added apoc.ttl.batchsize.dbname config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5aaca4d2b17a90d8c6dbc4136f24cefb3afa75c0", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/5aaca4d2b17a90d8c6dbc4136f24cefb3afa75c0", "committedDate": "2020-12-06T18:19:25Z", "message": "code clean"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07970c24cc7d4e8307773b4dfddd9363f1259fee", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/07970c24cc7d4e8307773b4dfddd9363f1259fee", "committedDate": "2020-12-06T22:49:45Z", "message": "added procedure in date/TTLTest.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "191a6ffa968f7636c4a970869fdbc56ac93d1a9b", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/191a6ffa968f7636c4a970869fdbc56ac93d1a9b", "committedDate": "2020-11-26T14:52:35Z", "message": "code clean"}, "afterCommit": {"oid": "07970c24cc7d4e8307773b4dfddd9363f1259fee", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/07970c24cc7d4e8307773b4dfddd9363f1259fee", "committedDate": "2020-12-06T22:49:45Z", "message": "added procedure in date/TTLTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be0a94d463938da7cf8f41fb140e82fc1bbbe243", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/be0a94d463938da7cf8f41fb140e82fc1bbbe243", "committedDate": "2020-12-07T10:55:48Z", "message": "updated ttl adoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NTU2MTg2", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1672#pullrequestreview-554556186", "createdAt": "2020-12-17T12:26:34Z", "commit": {"oid": "be0a94d463938da7cf8f41fb140e82fc1bbbe243"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMjoyNjozNFrOIHzSdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMjoyNjozNFrOIHzSdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA1MTI1NQ==", "bodyText": "let's just use limit as parameter for batch size, we don't need this inner limit anymore it was just used as a \"poor mans\" single batch in the beginning.\nBut now with periodic iterate we have proper batching and can just delete everything in batches of size \"limit\"", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1672#discussion_r545051255", "createdAt": "2020-12-17T12:26:34Z", "author": {"login": "jexp"}, "path": "full/src/main/java/apoc/ttl/TTLLifeCycle.java", "diffHunk": "@@ -45,22 +46,34 @@ public void start() {\n             long ttlScheduleDb = configValues.schedule;\n             ttlIndexJobHandle = scheduler.schedule(TTL_GROUP, this::createTTLIndex, (int)(ttlScheduleDb*0.8), TimeUnit.SECONDS);\n             long limitDb = configValues.limit;\n-            ttlJobHandle = scheduler.scheduleRecurring(TTL_GROUP, () -> expireNodes(limitDb), ttlScheduleDb, ttlScheduleDb, TimeUnit.SECONDS);\n+            long batchSizeDb = configValues.batchSize;\n+            ttlJobHandle = scheduler.scheduleRecurring(TTL_GROUP, () -> expireNodes(limitDb, batchSizeDb), ttlScheduleDb, ttlScheduleDb, TimeUnit.SECONDS);\n         }\n     }\n \n-    public void expireNodes(long limit) {\n+    public void expireNodes(long limit, long batchSize) {\n         try {\n             if (!Util.isWriteableInstance(db)) return;\n-            db.executeTransactionally(\"MATCH (t:TTL) where t.ttl < timestamp() WITH t LIMIT $limit DETACH DELETE t\",\n-                    Util.map(\"limit\", limit),\n-                    result -> {\n-                        QueryStatistics stats = result.getQueryStatistics();\n-                        if (stats.getNodesDeleted()>0) {\n-                            log.info(\"TTL: Expired %d nodes %d relationships\", stats.getNodesDeleted(), stats.getRelationshipsDeleted());\n-                        }\n-                        return null;\n-                    });\n+            String withLimit = (limit > 0) ? \"LIMIT $limit\" : \"\";\n+            String matchTTL = \"MATCH (t:TTL) WHERE t.ttl < timestamp() \";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be0a94d463938da7cf8f41fb140e82fc1bbbe243"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NTU5MjU5", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1672#pullrequestreview-554559259", "createdAt": "2020-12-17T12:30:36Z", "commit": {"oid": "be0a94d463938da7cf8f41fb140e82fc1bbbe243"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMjozMDozNlrOIHzbwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMjozMDozNlrOIHzbwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA1MzYzNA==", "bodyText": "see the id(n) thing I sent to @conker84", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1672#discussion_r545053634", "createdAt": "2020-12-17T12:30:36Z", "author": {"login": "jexp"}, "path": "full/src/main/java/apoc/ttl/TTLLifeCycle.java", "diffHunk": "@@ -45,22 +46,34 @@ public void start() {\n             long ttlScheduleDb = configValues.schedule;\n             ttlIndexJobHandle = scheduler.schedule(TTL_GROUP, this::createTTLIndex, (int)(ttlScheduleDb*0.8), TimeUnit.SECONDS);\n             long limitDb = configValues.limit;\n-            ttlJobHandle = scheduler.scheduleRecurring(TTL_GROUP, () -> expireNodes(limitDb), ttlScheduleDb, ttlScheduleDb, TimeUnit.SECONDS);\n+            long batchSizeDb = configValues.batchSize;\n+            ttlJobHandle = scheduler.scheduleRecurring(TTL_GROUP, () -> expireNodes(limitDb, batchSizeDb), ttlScheduleDb, ttlScheduleDb, TimeUnit.SECONDS);\n         }\n     }\n \n-    public void expireNodes(long limit) {\n+    public void expireNodes(long limit, long batchSize) {\n         try {\n             if (!Util.isWriteableInstance(db)) return;\n-            db.executeTransactionally(\"MATCH (t:TTL) where t.ttl < timestamp() WITH t LIMIT $limit DETACH DELETE t\",\n-                    Util.map(\"limit\", limit),\n-                    result -> {\n-                        QueryStatistics stats = result.getQueryStatistics();\n-                        if (stats.getNodesDeleted()>0) {\n-                            log.info(\"TTL: Expired %d nodes %d relationships\", stats.getNodesDeleted(), stats.getRelationshipsDeleted());\n-                        }\n-                        return null;\n-                    });\n+            String withLimit = (limit > 0) ? \"LIMIT $limit\" : \"\";\n+            String matchTTL = \"MATCH (t:TTL) WHERE t.ttl < timestamp() \";\n+            String queryRels = matchTTL + \"WITH t \" + withLimit + \" MATCH (t)-[r]-() RETURN r\";\n+            String queryNodes = matchTTL +  \"RETURN t \" + withLimit;\n+            Map<String,Object> params = Util.map(\"limit\", limit, \"batchSize\", batchSize, \"queryRels\", queryRels, \"queryNodes\", queryNodes);\n+            long relationshipsDeleted = db.executeTransactionally(\n+                    \"CALL apoc.periodic.iterate($queryRels, 'DELETE r', {batchSize: $batchSize, params:{limit: $limit}})\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be0a94d463938da7cf8f41fb140e82fc1bbbe243"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c9722dcdfb98dc475b8527262ee03f96cad62a9", "author": {"user": {"login": "vga91", "name": "Giuseppe Villani"}}, "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/6c9722dcdfb98dc475b8527262ee03f96cad62a9", "committedDate": "2021-01-13T13:36:40Z", "message": "removed limit in periodic iterate - queries with id(n)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 873, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}