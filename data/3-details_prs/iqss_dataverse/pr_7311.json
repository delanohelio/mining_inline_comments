{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NDY2NjU2", "number": 7311, "title": "6919 preview tools", "bodyText": "What this PR does / why we need it:\nThis pull request does two things:\n\nThe Preview tab is available in more cases, such as...\n\nwhen a guestbook is present and\nwhen terms are present.\n\n\nExternal tools can now be \"preview only\" in the sense that...\n\nwhen preview only tools appear on the Preview tab (on the file page), a button says \"Open in New Window\" rather than \"Explore on [TOOL NAME]\" and\npreview only tools do not appear under \"Explore Options\" under the \"Access File\" dropdown button.\n\n\n\nPrior to this pull request, the Preview tab was only available for files that are publicly downloadable.\nThe way to create a \"preview only\" tool is to use the new \"preview\" type.\nNote that explore tools can continue to appear under the Preview tab (on the file page) if they have hasPreviewMode set to true, as before. This was removed in 767882b\nWhich issue(s) this PR closes:\nCloses #6919 (Preview Tools - New external tool preview type config setting, icon btn on dataset/file pgs)\nSome commits have been added to address #4429 (Revise Explore Tools documentation to reflect modularity )\nSpecial notes for your reviewer:\nStuff to notice:\n\nCustom UIInput fields have been removed.\nWe've switched to standard Bean Validation.\n\nSome questions I have:\n\nShould we add email validation to the guestbook form?\n\nSuggestions on how to test this:\nThe code having to do with the terms/guestbook popup was extensively reworked so it would be good to test...\n\nvalidation of the form\nthat the values entered actually go into the database (don't laugh)\nall the various places that the popup can appear\n\ndataset page\nfile page\nwhen clicking external tools\nwhen clicking package files\nwhen clicking worldmap files\n\n\n\nDoes this PR introduce a user interface change? If mockups are available, please link/include them here:\nScreenshot 1: preview only example\nBelow is an example of a \"preview only\" tool. Note that the button in the Preview tab says \"Open in New Window\" and the tool is not present under the \"Access File\" dropdown.\n\nScreenshot 2: Terms + Guestbook\nBelow is an example of terms and a guestbook being presented in a Preview tab. The tool happens to be an explore tool and shows up under \"Explore Options\" under the \"Access File\" dropdown.\n\nIs there a release notes update needed for this change?:\nYes, a release note has been included.\nAdditional documentation:\nDoc changes included.", "createdAt": "2020-10-07T19:24:19Z", "url": "https://github.com/IQSS/dataverse/pull/7311", "merged": true, "mergeCommit": {"oid": "391402627e73fa31bb3001bdd4a796c9e442b389"}, "closed": true, "closedAt": "2020-10-27T21:09:53Z", "author": {"login": "pdurbin"}, "timelineItems": {"totalCount": 37, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdA3axDgH2gAyNDk5NDY2NjU2OmJlZTg4ODAxODI2NjljNmE2NTliZDcyMDkwZjNiZGRjNjA4ZWNiOGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWqQzSAFqTUxNzgwMTM2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bee8880182669c6a659bd72090f3bddc608ecb8a", "author": {"user": {"login": "mheppler", "name": "Michael Heppler"}}, "url": "https://github.com/IQSS/dataverse/commit/bee8880182669c6a659bd72090f3bddc608ecb8a", "committedDate": "2020-08-20T21:51:15Z", "message": "Added static preview icon btn to file table on dataset pg, reviewed references in guides to explore tools [ref #6919]"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a6c0c90488915183f06f405c1edc84a210da8ec", "author": {"user": {"login": "mheppler", "name": "Michael Heppler"}}, "url": "https://github.com/IQSS/dataverse/commit/9a6c0c90488915183f06f405c1edc84a210da8ec", "committedDate": "2020-08-21T14:15:59Z", "message": "Added hasPreviewMode to example code in Admin Guide, added preview icon btn to Style Guide [ref #6919]"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78fb7df1e6c663d77d539ea91068abb36805df83", "author": {"user": {"login": "mheppler", "name": "Michael Heppler"}}, "url": "https://github.com/IQSS/dataverse/commit/78fb7df1e6c663d77d539ea91068abb36805df83", "committedDate": "2020-08-24T16:19:39Z", "message": "Fixed format and layout issues on Patterns pg in Style Guide [ref #6919]"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37afbce5a31f41010c4ecd878e716d3ef402ca0e", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/37afbce5a31f41010c4ecd878e716d3ef402ca0e", "committedDate": "2020-08-25T13:43:22Z", "message": "Merge branch 'develop' into 6919-preview-tools"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b142cc5a93b49e6dc020afd575683dcbe06160cf", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/b142cc5a93b49e6dc020afd575683dcbe06160cf", "committedDate": "2020-08-27T13:45:45Z", "message": "Merge branch 'develop' into 6919-preview-tools"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2d0caf7aed1e40a0c68888781e65d0d5a9e9334", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/e2d0caf7aed1e40a0c68888781e65d0d5a9e9334", "committedDate": "2020-08-28T13:22:44Z", "message": "#6919 add Preview Type to External Tools"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b2dcfd9120b5fdc2f0ae2b33dc81f269f944eab", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/8b2dcfd9120b5fdc2f0ae2b33dc81f269f944eab", "committedDate": "2020-08-28T14:57:56Z", "message": "#6919 preview mode logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54bd1e37c67737cb73d0b61d7cec77a17d56af5f", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/54bd1e37c67737cb73d0b61d7cec77a17d56af5f", "committedDate": "2020-09-02T13:33:42Z", "message": "Merge branch 'develop' into 6919-preview-tools"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f102bef25b00f572e9eb1e815f2664a9e388bc9", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/5f102bef25b00f572e9eb1e815f2664a9e388bc9", "committedDate": "2020-09-11T20:57:49Z", "message": "fix formatting #6919"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80fe7643be2340cbb1e464b5e7befbf33a16aa4e", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/80fe7643be2340cbb1e464b5e7befbf33a16aa4e", "committedDate": "2020-09-11T20:59:12Z", "message": "get test passing (preview added) #6919"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2fb03cb37ba4ff70efd1a842d1b8e1f7555ebd8", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/a2fb03cb37ba4ff70efd1a842d1b8e1f7555ebd8", "committedDate": "2020-09-11T21:01:55Z", "message": "add tools to test explore, preview, and both #6919"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c941485c2a923193801f8397c683a0b85fc959c", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/2c941485c2a923193801f8397c683a0b85fc959c", "committedDate": "2020-09-14T15:49:46Z", "message": "show preview tools on Preview tab #6919"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de01f3539e7333dc41d8691a5ce13fc122e41535", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/de01f3539e7333dc41d8691a5ce13fc122e41535", "committedDate": "2020-09-14T19:51:06Z", "message": "selectively render preview/eyeball button #6919\n\nThe rule is \"The eyeball is present if the Preview tab is present.\"\n\nThere are edge cases to consider around guestbook, terms of use,\nrestricted data, etc.\n\nFor now we at least check if the appropriate tools are in place."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50f90180b9ff05583eb414230c5e2eb8f37f57ea", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/50f90180b9ff05583eb414230c5e2eb8f37f57ea", "committedDate": "2020-09-25T20:12:53Z", "message": "remove binding and process=@this #6919\n\nOur goal is to include file-download-popup-fragment.xhtml onto another\nlocation, the Preview tab on the file page, while still displaying\nit as a popup on that page.\n\nIn the Preview tab the input fields weren't showing up and we discovered\nthat commenting out \"binding\" made them appear. Commenting out \"binding\"\nresulted in validation not working. Additionally removing process=@this\nalong with much more refactoring, got validation working. Bean validation\nwas added as well.\n\nThe hope is that with this commit in place, we can switch back to trying\nto get the extra \"include\" (mentioned above) working.\n\nSome things to note about this commit:\n\n- Custom UIInput fields have been removed in favor of standard\nBean Validation.\n- The GuestbookResponse field was removed from FileDownloadHelper because\nit was confusing to sometimes set it and other times pass it in as argument\nto various methods. Now we always pass it in.\n- Various unused code was deleted.\n- process=@this wasn't removed from the \"package\" code and it's unknown\nif that code is working.\n\nConflicts:\nsrc/main/java/ValidationMessages.properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "886cab83b01a29c22b3de7265d6767cd3f6c40d8", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/886cab83b01a29c22b3de7265d6767cd3f6c40d8", "committedDate": "2020-09-30T20:12:00Z", "message": "show gb/terms on Preview tab, relax preview rules #6919\n\nThis commit does two things:\n\n- Include file-download-popup-fragment.xhtml (where guestbook and terms live) on the Preview tab.\n- Allow files to be previewed in more scenarios, such as when datasets have a guestbook or terms.\n\nThere are a couple TODO/FIXME items not addressed:\n\n- <p:focus context=\"downloadPopup\"/> was commented out.\n- @form is used in a place where it could be more precise."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c509773bad1f9f346c4a53d461fba917cae1f412", "author": {"user": {"login": "mheppler", "name": "Michael Heppler"}}, "url": "https://github.com/IQSS/dataverse/commit/c509773bad1f9f346c4a53d461fba917cae1f412", "committedDate": "2020-10-02T17:49:48Z", "message": "Fixed guestbook form focus issue, added external tool type render logic to btn txt on file pg [ref #6919]"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2115b6d8f1debb804f03fe78f79b405439be6a61", "author": {"user": {"login": "mheppler", "name": "Michael Heppler"}}, "url": "https://github.com/IQSS/dataverse/commit/2115b6d8f1debb804f03fe78f79b405439be6a61", "committedDate": "2020-10-05T19:16:02Z", "message": "Added conditional btn text to file pg preview tab external tool btn [ref #6919]"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b34ca9e3a084d8bad141a69226c31711c13cf73", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/2b34ca9e3a084d8bad141a69226c31711c13cf73", "committedDate": "2020-10-05T19:52:08Z", "message": "adding \"process\" to target correct fields #6919"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a2428310528768f7805f5bca040274bd66c86fd", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/9a2428310528768f7805f5bca040274bd66c86fd", "committedDate": "2020-10-05T20:15:09Z", "message": "move validateThisContext up, remove extra p:fragment #6919"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8213baad2d8d04ad03470d38b926d82c4930285", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/f8213baad2d8d04ad03470d38b926d82c4930285", "committedDate": "2020-10-05T20:28:11Z", "message": "more precise update than \"form\" #6919"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55c6854bb6d0269e56ea25772f9d2dd0b24e93dc", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/55c6854bb6d0269e56ea25772f9d2dd0b24e93dc", "committedDate": "2020-10-05T20:38:43Z", "message": "expand \"update\" for validation #6919\n\nWithout this update, the failure case was this:\n\n1. When there are required fields, click Accept without filling them in.\n2. Fill in all required fields and click Accept.\n3. The form remains and you cannot see the preview."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6d32fffc388ea70dbdd63d48bf58b45b307cecd", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/a6d32fffc388ea70dbdd63d48bf58b45b307cecd", "committedDate": "2020-10-05T20:51:09Z", "message": "Merge branch 'develop' into 6919-preview-tools #6919\n\nConflicts:\nsrc/main/java/ValidationMessages.properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bff99b3f73099395e0abfd3623342c700fece6ad", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/bff99b3f73099395e0abfd3623342c700fece6ad", "committedDate": "2020-10-06T20:09:03Z", "message": "cleanup (no-op), formatting, etc.  #6919"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90f1673c04a09d00eab720bfd1a46b1e51508986", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/90f1673c04a09d00eab720bfd1a46b1e51508986", "committedDate": "2020-10-07T18:41:35Z", "message": "update docs for preview tools branch #6919\n\nLots of edits were made previously in this branch."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a42fa4ddbcd3074c90d60e3f1bb5935b5b17e6f1", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/a42fa4ddbcd3074c90d60e3f1bb5935b5b17e6f1", "committedDate": "2020-10-07T19:14:27Z", "message": "add release note for preview tools #6919"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e469cc46e06d4f23cf36d4ac2ddb33e2f8f3deab", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/e469cc46e06d4f23cf36d4ac2ddb33e2f8f3deab", "committedDate": "2020-10-07T19:16:48Z", "message": "Merge branch 'develop' into 6919-preview-tools #6919"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5696f5fe24e8870118912755145cfece14cd6af2", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/5696f5fe24e8870118912755145cfece14cd6af2", "committedDate": "2020-10-08T18:26:14Z", "message": "Merge branch 'develop' into 6919-preview-tools #6919"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1Njc1MjE0", "url": "https://github.com/IQSS/dataverse/pull/7311#pullrequestreview-505675214", "createdAt": "2020-10-09T13:31:45Z", "commit": {"oid": "5696f5fe24e8870118912755145cfece14cd6af2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzozMTo0NVrOHfJ1gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzozMTo0NVrOHfJ1gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyOTA1OA==", "bodyText": "Do we want/need to say that hasPreviewMode only pertains to explore tools?", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r502429058", "createdAt": "2020-10-09T13:31:45Z", "author": {"login": "sekmiller"}, "path": "doc/sphinx-guides/source/api/external-tools.rst", "diffHunk": "@@ -70,19 +78,19 @@ Terminology\n     ===========================  ==========\n     Term                         Definition\n     ===========================  ==========\n-    external tool manifest       A **JSON file** the defines the URL constructed by Dataverse when users click \"Explore\" or \"Configure\" buttons. External tool makers are asked to host this JSON file on a website (no app store yet, sorry) and explain how to use install and use the tool. Examples include :download:`fabulousFileTool.json <../_static/installation/files/root/external-tools/fabulousFileTool.json>` and :download:`dynamicDatasetTool.json <../_static/installation/files/root/external-tools/dynamicDatasetTool.json>` as well as the real world examples above such as Data Explorer.\n+    external tool manifest       A **JSON file** the defines the URL constructed by Dataverse when users click explore or configure tool options. External tool makers are asked to host this JSON file on a website (no app store yet, sorry) and explain how to use install and use the tool. Examples include :download:`fabulousFileTool.json <../_static/installation/files/root/external-tools/fabulousFileTool.json>` and :download:`dynamicDatasetTool.json <../_static/installation/files/root/external-tools/dynamicDatasetTool.json>` as well as the real world examples above such as Data Explorer.\n \n     displayName                  The **name** of the tool in the Dataverse web interface. For example, \"Data Explorer\".\n \n     description                  The **description** of the tool, which appears in a popup (for configure tools only) so the user who clicked the tool can learn about the tool before being redirected the tool in a new tab in their browser. HTML is supported.\n \n     scope                        Whether the external tool appears and operates at the **file** level or the **dataset** level. Note that a file level tool much also specify the type of file it operates on (see \"contentType\" below).\n \n-    type                         Whether the external tool is an **explore** tool or a **configure** tool. Configure tools require an API token because they make changes to data files (files within datasets). Configure tools are currently not supported at the dataset level (no \"Configure\" button appears in the GUI for datasets).\n+    type                         Whether the external tool is an **explore** tool, a **preview** tool or a **configure** tool. Configure tools require an API token because they make changes to data files (files within datasets). Configure tools are currently not supported at the dataset level.\n \n     toolUrl                      The **base URL** of the tool before query parameters are added.\n     \n-    hasPreviewMode               A boolean that indicates whether tool has a preview mode which can be embedded in the File Page. Since this view is designed for embedding within Dataverse, the preview mode for a tool will typically be a view without headers or other options that may be included with a tool that is designed to be launched in a new window. Sometimes, a tool will exist solely to preview files in Dataverse and the preview mode will be the same as the regular view. \n+    hasPreviewMode               A boolean that indicates whether tool has a preview mode which can be embedded in the File Page. Since this view is designed for embedding within Dataverse, the preview mode for a tool will typically be a view without headers or other options that may be included with a tool that is designed to be launched in a new window. \n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5696f5fe24e8870118912755145cfece14cd6af2"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5eacaea06a3d32e9077bfcd31e26f001672628a", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/e5eacaea06a3d32e9077bfcd31e26f001672628a", "committedDate": "2020-10-15T18:02:03Z", "message": "remove \"Tools\" from preview tool switcher #6919"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "767882b1e95120113290ed3cded3c3dff5285f3b", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/767882b1e95120113290ed3cded3c3dff5285f3b", "committedDate": "2020-10-21T20:24:42Z", "message": "support multiple types, remove hasPreviewMode #6919"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b62d0d7eb00a8f957af64686db8bf1799f4de76", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/6b62d0d7eb00a8f957af64686db8bf1799f4de76", "committedDate": "2020-10-21T20:25:51Z", "message": "Merge branch 'develop' into 6919-preview-tools #6919"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NzgwMDY1", "url": "https://github.com/IQSS/dataverse/pull/7311#pullrequestreview-514780065", "createdAt": "2020-10-22T14:19:18Z", "commit": {"oid": "5696f5fe24e8870118912755145cfece14cd6af2"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNzoyNToyN1rOHnW4Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxODoxNzowMVrOHnYj1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMTMzMA==", "bodyText": "Because the validation isn't run - any missing required are caught in the UI - we can get rid of this", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r511031330", "createdAt": "2020-10-23T17:25:27Z", "author": {"login": "sekmiller"}, "path": "src/main/java/edu/harvard/iq/dataverse/FileDownloadHelper.java", "diffHunk": "@@ -230,6 +133,7 @@ public void writeGuestbookAndStartDownload(GuestbookResponse guestbookResponse)\n          boolean valid = validateGuestbookResponse(guestbookResponse);\n \n          if (!valid) {\n+             // FIXME: This never validation error shows in the UI (even if you add a bundle entry).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b62d0d7eb00a8f957af64686db8bf1799f4de76"}, "originalPosition": 191}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMjI5OQ==", "bodyText": "I don't think this method is needed anymore.", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r511032299", "createdAt": "2020-10-23T17:27:24Z", "author": {"login": "sekmiller"}, "path": "src/main/java/edu/harvard/iq/dataverse/FileDownloadHelper.java", "diffHunk": "@@ -230,6 +133,7 @@ public void writeGuestbookAndStartDownload(GuestbookResponse guestbookResponse)\n          boolean valid = validateGuestbookResponse(guestbookResponse);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b62d0d7eb00a8f957af64686db8bf1799f4de76"}, "originalPosition": 188}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMzEyNA==", "bodyText": "Again since the validation is done in the UI, I think you can go directly to writing the GB response", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r511033124", "createdAt": "2020-10-23T17:29:04Z", "author": {"login": "sekmiller"}, "path": "src/main/java/edu/harvard/iq/dataverse/FileDownloadHelper.java", "diffHunk": "@@ -347,7 +251,22 @@ public String startWorldMapDownloadLink(GuestbookResponse guestbookResponse, Fil\n         return retVal;\n     }\n \n-        \n+     /**\n+      * Writes a guestbook entry for either popup scenario: guestbook or terms.\n+      */\n+     public boolean writeGuestbookAndShowPreview(GuestbookResponse guestbookResponse) {\n+         // We've already validated guestbooks on the front end but we validate again\n+         // on the backend (that's what older methods do).\n+         boolean valid = validateGuestbookResponse(guestbookResponse);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b62d0d7eb00a8f957af64686db8bf1799f4de76"}, "originalPosition": 206}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA1ODkwMQ==", "bodyText": "If we are rendering the buttons based on the gbResponse file formats, can we just have one method for Launching the explore tool, world map and package popup that decides what to do based on the file format. That could reduce three buttons to one.", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r511058901", "createdAt": "2020-10-23T18:17:01Z", "author": {"login": "sekmiller"}, "path": "src/main/webapp/file-download-popup-fragment.xhtml", "diffHunk": "@@ -121,56 +123,83 @@\n                                 </label>\n                                 <p:inputText id=\"customQuestionResponse\"\n                                              styleClass=\"form-control\" value=\"#{customQuestionResponse.response}\"\n-                                             required=\"#{param['DO_GB_VALIDATION'] and customQuestionResponse.customQuestion.required}\"\n+                                             required=\"#{param[validateThisContext] and customQuestionResponse.customQuestion.required}\"\n                                              rendered=\"#{customQuestionResponse.customQuestion.questionType=='text'}\"\n                                              requiredMessage=\"#{bundle['requiredField']}\">\n-                                    <p:ajax listener=\"#{fileDownloadHelper.customQuestionValueChangeListener}\"/>\n                                 </p:inputText>\n                                 <p:message id=\"cqMessages\" for=\"customQuestionResponse\" display=\"text\"/>\n                                 <p:selectOneMenu id=\"customQuestionResponseSelect\"\n                                                  styleClass=\"form-control\" value=\"#{customQuestionResponse.response}\"\n-                                                 required=\"#{param['DO_GB_VALIDATION'] and customQuestionResponse.customQuestion.required}\"\n+                                                 required=\"#{param[validateThisContext] and customQuestionResponse.customQuestion.required}\"\n                                                  rendered=\"#{customQuestionResponse.customQuestion.questionType=='options'}\"\n                                                  requiredMessage=\"#{bundle['requiredField']}\">\n                                     <f:selectItem itemLabel=\"#{bundle.select}\" itemValue=\"\" noSelectionOption=\"true\" />\n                                     <f:selectItems value=\"#{customQuestionResponse.responseSelectItems}\" />\n-                                    <p:ajax listener=\"#{fileDownloadHelper.customQuestionValueChangeListener}\"/>\n                                 </p:selectOneMenu>\n+                                <p:message id=\"cqrsMessages\" for=\"customQuestionResponseSelect\" display=\"text\"/>\n                             </div>\n-                                <div class=\"ui-message ui-message-error ui-widget ui-corner-all\" aria-live=\"polite\" jsf:rendered=\"#{!empty customQuestionResponse.validationMessage}\">\n-                                    <span class=\"ui-message-error-detail\">#{customQuestionResponse.validationMessage}</span>\n-                                </div>\n                         </ui:repeat>\n                     </div>\n                 </div>\n             </p:fragment>\n         </div>\n         <div class=\"button-block\">\n+            <!--\n+            The \"process\" directive below is very important. Without it, the\n+            setters on the GuestbookResponse object can be called twice leading\n+            to form values (name, email, etc) to be overwritten by the object in\n+            the other context. For example, \"name\" in the Preview tab could get\n+            overwritten by \"name\" in the download popup with either a blank\n+            value or a prefilled value, leading to a botched guestbook entry.\n+            \n+            Experimentation was done with adding process=\"downloadPopup\" to the\n+            non-Preview tab buttons but this caused a ComponentNotFoundException\n+            and didn't solve any problems. If you add logging to print out\n+            setName from Guestbook response, you can see that the setters are\n+            called on the GuestbookResponse object from the Preview tab but they\n+            are later overwritten by the setters on the GuestbookResponse object\n+            from the Download popup.\n+            -->\n+            <!--REGULAR DOWNLOAD BUTTON, NO EXTERNAL TOOL, NOT THE PREVIEW TAB-->\n             <!--Note: the guestbookResponse.fileFormat is being set in xhtml via the initial download buttons in file-download-button-fragment.xhtml -->\n-            <p:commandButton styleClass=\"btn btn-default\" process=\"@this\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat != 'externalTool'\n-                                                                                                                            and guestbookResponse.fileFormat != 'worldMap'\n-                                                                                                                            and guestbookResponse.fileFormat != 'package'}\"\n-                           actionListener=\"#{fileDownloadHelper.writeGuestbookAndStartDownload(guestbookResponse)}\"\n-                           update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/>\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\"\n+                             rendered=\"#{guestbookResponse.fileFormat != 'externalTool' and\n+                                         guestbookResponse.fileFormat != 'worldMap' and\n+                                         guestbookResponse.fileFormat != 'package' and\n+                                         popupContext != 'previewTab'}\"\n+                             actionListener=\"#{fileDownloadHelper.writeGuestbookAndStartDownload(guestbookResponse)}\"\n+                             update=\"guestbookUIFragment\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n+            </p:commandButton>\n+            <!--PREVIEW TAB BUTTON-->\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\"\n+                             rendered=\"#{popupContext == 'previewTab'}\"\n+                             actionListener=\"#{FilePage.showPreview(guestbookResponse)}\"\n+                             process=\"previewTab\"\n+                             update=\"fileForm:tabView\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n             </p:commandButton>\n+            <!--WORLDMAP BUTTON-->\n             <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'worldMap'}\"\n-                            actionListener=\"#{fileDownloadHelper.startWorldMapDownloadLink(guestbookResponse, null)}\" \n-                            update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/> \n+                             actionListener=\"#{fileDownloadHelper.startWorldMapDownloadLink(guestbookResponse, null)}\"\n+                             update=\"guestbookUIFragment\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n             </p:commandButton>\n+            <!--EXTERNAL TOOL BUTTON-->\n             <!--On the dataset page (but not the file page), \"tool\" is null so we get the tool from the guestbookResponse.-->\n-            <p:commandButton styleClass=\"btn btn-default\" process=\"@this\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'externalTool'}\"\n-                           action=\"#{fileDownloadHelper.writeGuestbookAndLaunchExploreTool(guestbookResponse, fileMetadata, tool)}\"\n-                           update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/>\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'externalTool'}\"\n+                             action=\"#{fileDownloadHelper.writeGuestbookAndLaunchExploreTool(guestbookResponse, fileMetadata, tool)}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b62d0d7eb00a8f957af64686db8bf1799f4de76"}, "originalPosition": 185}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e73d2f4f95819fb746736bafafef21e5f29c5943", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/e73d2f4f95819fb746736bafafef21e5f29c5943", "committedDate": "2020-10-26T18:18:51Z", "message": "remove validation checks we don't need #6919\n\nWe've switched to Bean Validation, which is done centrally instead of\nbeing only in the UI."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "132e1ee038291a38dc6549a046fbef116d1a621b", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/132e1ee038291a38dc6549a046fbef116d1a621b", "committedDate": "2020-10-26T18:31:11Z", "message": "Merge branch 'develop' into 6919-preview-tools #6919"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a82d8398292293fd945f84d8cfd9ca88f2da214e", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/a82d8398292293fd945f84d8cfd9ca88f2da214e", "committedDate": "2020-10-27T14:42:57Z", "message": "#6919 remove unused code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6c0778d63c6834fa82a07ce0a704ecdd0ca1cd3", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/b6c0778d63c6834fa82a07ce0a704ecdd0ca1cd3", "committedDate": "2020-10-27T14:43:20Z", "message": "Merge branch 'develop' into 6919-preview-tools"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3ODAxMzYz", "url": "https://github.com/IQSS/dataverse/pull/7311#pullrequestreview-517801363", "createdAt": "2020-10-27T14:57:56Z", "commit": {"oid": "b6c0778d63c6834fa82a07ce0a704ecdd0ca1cd3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 777, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}