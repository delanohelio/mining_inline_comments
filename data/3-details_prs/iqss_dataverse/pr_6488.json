{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwMTI4ODM5", "number": 6488, "title": "Iqss/6485 - Multiple File Stores", "bodyText": "What this PR does / why we need it: Implements the ability to configure multiple file stores.\nWhich issue(s) this PR closes:\nCloses #6485\nSpecial notes for your reviewer: The install script should set up a file store, backward compatible with an existing installation. The docs also describe how to do this.\nSuggestions on how to test this: Multiple things that could be tested:\nBasic install comes up with a single file store working as before (can upload/download files)\nAbility to configure a second file store (e.g. with a different file path)\nAbility to configure an additional s3 store\nAbility to configure another s3 store using a separate aws profile\nAbility to change the default store for new files (new store allows upload/download, files in other stores are still downloadable)\nAbility to list stores available and use the admin API and/or superuser UI (both described in docs) to set/reset to default which store is used for a given dataverse.\nVerify that a store set for a given dataverse works for datasets created/edited within that dataverse.\nWith a s3 store configured with the id 's3', verify that rsync still works\nWithout an s3 store configured with the id 's3', verify that rsync upload does not appear as an option.\nDoes this PR introduce a user interface change?: For superusers, adds an entry in the 'Edit'/'General Information' form for a dataverse to change the store for a given dataverse.\nIs there a release notes update needed for this change?: Yes - existing installations will have to update some jvm options to move to this version. The config docs describe the changes needed for a file store or s3 store.\nAdditional documentation:\nDCM/rsync has hardcoded using a vanilla s3 store. Since I don't have a good way to test any rsync changes, I didn't try to update it to support multiple stores, but did try to make changes to enable an existing instance to keep using DCM/rsync. Adding the jvm options to define an s3 store with id 's3', as described in the docs, should be enough to make DCM work with this update. It should be possible to make the rsync capability available per store, and support stores with specified endpoints, etc. in the future.", "createdAt": "2020-01-07T19:05:30Z", "url": "https://github.com/IQSS/dataverse/pull/6488", "merged": true, "mergeCommit": {"oid": "bf79e64a1d6ddc0af7e6eee8bcca9c2a80c11b22"}, "closed": true, "closedAt": "2020-02-19T00:09:19Z", "author": {"login": "qqmyers"}, "timelineItems": {"totalCount": 40, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4BsvsAH2gAyMzYwMTI4ODM5OmNjMDgzMzAzNTIwOGQ2YzAzZGUxOGEwMGI5MzZkNWZkMzVkYzhkOGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFm9fyAH2gAyMzYwMTI4ODM5OjAzNDc4N2JkYjViZTM5NGRlYjI0NmMxMzZhOGRkZDhhNTZiMWFhOGQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cc0833035208d6c03de18a00b936d5fd35dc8d8b", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/cc0833035208d6c03de18a00b936d5fd35dc8d8b", "committedDate": "2020-01-07T14:33:28Z", "message": "multistore implementation (built on direct upload)\n\nConflicts:\n\tpom.xml\n\tsrc/main/java/edu/harvard/iq/dataverse/api/Datasets.java\n\tsrc/main/java/edu/harvard/iq/dataverse/ingest/IngestServiceBean.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdbd6f2a0571146b156f34b1defd047a11fef59d", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/cdbd6f2a0571146b156f34b1defd047a11fef59d", "committedDate": "2020-01-07T14:53:16Z", "message": "merge issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cc034a351761d5994aee931ff102369ff439102", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/9cc034a351761d5994aee931ff102369ff439102", "committedDate": "2020-01-07T15:28:27Z", "message": "dcm - use new option name - assume store with id 's3'\n\nNote: DCM doesn't use any of the other S3 options in creating the Amazon\n client, so it is somewhat hardcoded that was as well. A rewrite might\n identify a specific s3 store to use, build the amazon client from it's\nsettings and still use the general dcm-s3-bucket-name entry. If DCM\nshould be supported across multiple stores, a\ndataverse.files.<id>.dcm-s3-bucket-name option could be created so that\neverything is ties to a specific store."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae6ecfa0bfe254bc7e16cc84112d5d76a9073091", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/ae6ecfa0bfe254bc7e16cc84112d5d76a9073091", "committedDate": "2020-01-07T16:23:59Z", "message": "control store via dataverse.storagedriver param\n\nmanageable by superuser only\n\nConflicts:\n\tsrc/main/java/edu/harvard/iq/dataverse/EditDatafilesPage.java\n\tsrc/main/java/edu/harvard/iq/dataverse/dataaccess/DataAccess.java\n\tsrc/main/java/edu/harvard/iq/dataverse/util/FileUtil.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79fbd8ce4781ae996c17f0b8e24e1d385bd6a37b", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/79fbd8ce4781ae996c17f0b8e24e1d385bd6a37b", "committedDate": "2020-01-07T16:25:05Z", "message": "redirect and url lifetime store specific"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c506ab5c9a602364563c6afaead1fc875c35135", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/6c506ab5c9a602364563c6afaead1fc875c35135", "committedDate": "2020-01-07T16:47:26Z", "message": "limit rsync setup/panel to datasets using 's3' store"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "171abe1d1a73abfd867ff5ff1b75bd64121f1b98", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/171abe1d1a73abfd867ff5ff1b75bd64121f1b98", "committedDate": "2020-01-07T17:59:59Z", "message": "documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be8a5c7717b39a4334970f9e0eb20bc73c6d48f1", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/be8a5c7717b39a4334970f9e0eb20bc73c6d48f1", "committedDate": "2020-01-07T18:29:42Z", "message": "api and doc for it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2220d87847d3ba6379d6e7f9b2dfb199aca6fe7f", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/2220d87847d3ba6379d6e7f9b2dfb199aca6fe7f", "committedDate": "2020-01-07T18:39:07Z", "message": "merge issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27b5308acedbf3ea880fe4b2a8f0d95a5961391e", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/27b5308acedbf3ea880fe4b2a8f0d95a5961391e", "committedDate": "2020-01-07T18:46:31Z", "message": "minimal file store config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e13e066124f50d6b8f1e1c11c752c18f33da661", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/9e13e066124f50d6b8f1e1c11c752c18f33da661", "committedDate": "2020-01-08T18:17:18Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7507dcd51c32cb985bdb4e4fc51e5bc1215719e", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/a7507dcd51c32cb985bdb4e4fc51e5bc1215719e", "committedDate": "2020-01-08T18:17:25Z", "message": "test fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7073314a0d0ee4a5403b614514e00719d7cf9f8b", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/7073314a0d0ee4a5403b614514e00719d7cf9f8b", "committedDate": "2020-01-08T18:17:32Z", "message": "define 'file' store type for default test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNzU4Mzcz", "url": "https://github.com/IQSS/dataverse/pull/6488#pullrequestreview-340758373", "createdAt": "2020-01-09T19:22:51Z", "commit": {"oid": "7073314a0d0ee4a5403b614514e00719d7cf9f8b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ec46ba1200e5bd28285dc14612498eb5f2d1861", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/6ec46ba1200e5bd28285dc14612498eb5f2d1861", "committedDate": "2020-01-15T17:49:26Z", "message": "doc updates per review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5edeb487007fbd19f21a73121afa4050a47697bf", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/5edeb487007fbd19f21a73121afa4050a47697bf", "committedDate": "2020-01-15T17:59:56Z", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6485\n\nConflicts:\n\tsrc/main/java/edu/harvard/iq/dataverse/ingest/IngestServiceBean.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42bec6b761da439202f54dac8136183d683f6bed", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/42bec6b761da439202f54dac8136183d683f6bed", "committedDate": "2020-01-15T21:02:04Z", "message": "inherit from parent in 'New Dataverse' form\n\nand show a 'Use Default' label when not set"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b3bbd86b947b1345c67bca83284324d7af86de8", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/2b3bbd86b947b1345c67bca83284324d7af86de8", "committedDate": "2020-01-15T21:11:49Z", "message": "allow storagedriver to be set when adding dataverse via api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb67d4e49bf77806aa2228e4681ae775e41a664d", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/fb67d4e49bf77806aa2228e4681ae775e41a664d", "committedDate": "2020-01-15T21:15:52Z", "message": "return storage driver label if set"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "feb4329cafdcde346da5c2a3efc3f0c747557d82", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/feb4329cafdcde346da5c2a3efc3f0c747557d82", "committedDate": "2020-01-15T21:56:18Z", "message": "Removing storage driver setting\n\nThinking further, since setting the driver is superuser-only, it\nshouldn't be settable via the addDataverse API call (at least not\nwithout an additional security check, but even then, making the admin\nuser make a separate call to set the driver via the already defined\nadmin API call might be cleaner."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5c7fa13920f9eb06d2de710b4c4fe56b136f35a", "author": {"user": {"login": "djbrooke", "name": "Danny Brooke"}}, "url": "https://github.com/IQSS/dataverse/commit/b5c7fa13920f9eb06d2de710b4c4fe56b136f35a", "committedDate": "2020-01-16T16:41:57Z", "message": "updating wording based on design feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3de92634578e2b57c40018faaa7c0378d7c193b", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/f3de92634578e2b57c40018faaa7c0378d7c193b", "committedDate": "2020-01-31T20:26:40Z", "message": "change inheritance mechanism per review feedback\n\nConflicts:\n\tsrc/main/java/edu/harvard/iq/dataverse/dataaccess/DataAccess.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eac17c4d197a0e74c28527cf38fa8e455a1b14bf", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/eac17c4d197a0e74c28527cf38fa8e455a1b14bf", "committedDate": "2020-01-31T20:35:18Z", "message": "Merge remote-tracking branch 'origin/IQSS/6485' into IQSS/6485"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccb39e793d0a2d28784a2c292931784acf49abdb", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/ccb39e793d0a2d28784a2c292931784acf49abdb", "committedDate": "2020-01-31T20:36:22Z", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6485"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08f059a6f294f571171c4a150cd1d0291c5926b0", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/08f059a6f294f571171c4a150cd1d0291c5926b0", "committedDate": "2020-01-31T20:44:52Z", "message": "update new API calls to match"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1a8a71096465876c9d6bf69ae70ebc964e97e43", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/e1a8a71096465876c9d6bf69ae70ebc964e97e43", "committedDate": "2020-01-31T20:52:42Z", "message": "and fix default case for test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMjg2NTQ3", "url": "https://github.com/IQSS/dataverse/pull/6488#pullrequestreview-353286547", "createdAt": "2020-02-04T20:42:28Z", "commit": {"oid": "e1a8a71096465876c9d6bf69ae70ebc964e97e43"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "310fb7352f0a095471e0a88851c7d7a77a200a85", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/310fb7352f0a095471e0a88851c7d7a77a200a85", "committedDate": "2020-02-05T21:07:21Z", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6485\n\nConflicts:\n\tsrc/main/java/edu/harvard/iq/dataverse/ingest/IngestServiceBean.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b660c5a67de9fa443805bcdb70373809ca82146", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/6b660c5a67de9fa443805bcdb70373809ca82146", "committedDate": "2020-02-07T15:38:18Z", "message": "fix storagedriver assignment\n\nthe change to the inheritance model changed the meaning of\ngetStorageDriverId() which now returns what is locally set on a\ndataverse. getEffectiveStorageDriverId() properly recurses as needed to\nfind the effective one (and should never return null)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "669836348cf09789d406be1e0422b9e95ba60739", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/669836348cf09789d406be1e0422b9e95ba60739", "committedDate": "2020-02-08T00:38:14Z", "message": "change defaults for storageidentifiers with no driver prepended"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2Mjc3Mjc3", "url": "https://github.com/IQSS/dataverse/pull/6488#pullrequestreview-356277277", "createdAt": "2020-02-10T21:29:56Z", "commit": {"oid": "669836348cf09789d406be1e0422b9e95ba60739"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMToyOTo1NlrOFn2Otg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMToyOTo1NlrOFn2Otg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMyNzI4Ng==", "bodyText": "@qqmyers After some testing and looking into this with @kcondon, we are wondering - since it is now possible to configure more than one stores of the type \"file\", it seems like we need to be able to also define different physical directories for these locations.\ni.e., instead of the fixed Ddataverse.files.directory=..., it should be\ndataverse.files.file.directory=..., dataverse.files.file1.directory=..., etc.\n(but maybe we should also leave the current dataverse.files.directory, for backward compatiblity, to be consulted if dataverse.files.file.directory is not defined - ?)\nwhat do you think?", "url": "https://github.com/IQSS/dataverse/pull/6488#discussion_r377327286", "createdAt": "2020-02-10T21:29:56Z", "author": {"login": "landreev"}, "path": "scripts/installer/glassfish-setup.sh", "diffHunk": "@@ -73,6 +73,9 @@ function preliminary_setup()\n   # location of the datafiles directory: \n   # (defaults to dataverse/files in the users home directory)\n   ./asadmin $ASADMIN_OPTS create-jvm-options \"\\-Ddataverse.files.directory=${FILES_DIR}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "669836348cf09789d406be1e0422b9e95ba60739"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ceefc72f369fd86abb2f16ec5f0ea3cc022638c4", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/ceefc72f369fd86abb2f16ec5f0ea3cc022638c4", "committedDate": "2020-02-11T14:25:11Z", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6485"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b44d8a3e8d64071464b6ffefb3958936b5d7c22", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/1b44d8a3e8d64071464b6ffefb3958936b5d7c22", "committedDate": "2020-02-11T14:54:24Z", "message": "finalize sql script name, update docs/default temp file store"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9415c63f6bde7b3e9ebb9db16384ffb6aed0084d", "author": {"user": {"login": "kcondon", "name": "Kevin Condon"}}, "url": "https://github.com/IQSS/dataverse/commit/9415c63f6bde7b3e9ebb9db16384ffb6aed0084d", "committedDate": "2020-02-11T16:32:25Z", "message": "Update 6485-multiple-stores.md\n\nFixed temp dir jvm option"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db4ac18a52e2c9e13de756ad4144b9481323d8a9", "author": {"user": {"login": "kcondon", "name": "Kevin Condon"}}, "url": "https://github.com/IQSS/dataverse/commit/db4ac18a52e2c9e13de756ad4144b9481323d8a9", "committedDate": "2020-02-11T16:35:54Z", "message": "Update config.rst\n\nClarified behavior of temp dir jvm option and made more consistent with release notes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14e26492096247e5a7d21b1a601ce1421fb9699a", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/14e26492096247e5a7d21b1a601ce1421fb9699a", "committedDate": "2020-02-14T18:33:37Z", "message": "Assure file type storage always uses '<driverID>://' prefix\n\navoid a doi: in the dataset storageidentifier\nfix dataset and file storageidentifier assignment issues\nupdate db datafile entries to have file:// if they don't have a prefix\n\nConflicts:\n\tsrc/main/resources/db/migration/V4.19.0.1__tbd_multistore.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "734d5666dde8c0ca60e10c308446d064d685df16", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/734d5666dde8c0ca60e10c308446d064d685df16", "committedDate": "2020-02-14T18:49:48Z", "message": "doc updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1efdf38e4df63118506cee352afa44c62a026621", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/1efdf38e4df63118506cee352afa44c62a026621", "committedDate": "2020-02-14T20:02:50Z", "message": "replace default file driverId with real one"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d038a9dd420702fd2d47a7a1c8e1a642e1859bae", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/d038a9dd420702fd2d47a7a1c8e1a642e1859bae", "committedDate": "2020-02-14T23:15:34Z", "message": "Merge branch 'IQSS/6485' of\nhttps://github.com/TexasDigitalLibrary/dataverse.git into IQSS/6485\n\nConflicts:\n\tdoc/release-notes/6485-multiple-stores.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "034787bdb5be394deb246c136a8ddd8a56b1aa8d", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/034787bdb5be394deb246c136a8ddd8a56b1aa8d", "committedDate": "2020-02-18T19:19:16Z", "message": "update test and comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1000, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}