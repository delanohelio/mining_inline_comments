{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwNDcyMzU5", "number": 6747, "title": "6697 delete user api", "bodyText": "What this PR does / why we need it:\nAdds testing to the delete user api with a message back to the admin describing the reason the user may not be deleted - or actually doing the deletion\nWhich issue(s) this PR closes:\nCloses #6697\nSpecial notes for your reviewer:\nSuggestions on how to test this: test that users who have done various things created/contributed to ds, has a role, has an open access request, etc. to verify messaging\nDetails:\nCreated DV/DS: cannot be deleted.\nEdited DS version:  cannot  be deleted.\nDownloaded a file: cannot  be deleted if there's a guestbook record.\nHas a role defined: cannot  be deleted.\nHas an open access request: will be deleted along with request.\nHas a notification: will be deleted along with notification\nHas a World Map Token: will be deleted along with token\nIs a group member: will be deleted along with group membership.\nDoes this PR introduce a user interface change?:\nNo, but coding done with the idea that \"Delete User\" will be added to Admin Dashboard\nIs there a release notes update needed for this change?:\nNo\nAdditional documentation:\nadded to admin native api doc", "createdAt": "2020-03-18T14:33:34Z", "url": "https://github.com/IQSS/dataverse/pull/6747", "merged": true, "mergeCommit": {"oid": "b4f5bdfc02dd12f8f1c79084c0cc0320c6a505a5"}, "closed": true, "closedAt": "2020-03-31T21:28:45Z", "author": {"login": "sekmiller"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMXWk7gH2gAyMzkwNDcyMzU5OjU2N2Q0ZDRjNzRkNWE4MzIwNzU4MDE1MDkxMjVkYTlkYThkNzQ4NWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTIEIoAH2gAyMzkwNDcyMzU5OmUxYjFkMGM2MTVlM2JhODkzNjc4ZmE3YTlhNWVlNGViNmRiNTgxMjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "567d4d4c74d5a832075801509125da9da8d7485f", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/567d4d4c74d5a832075801509125da9da8d7485f", "committedDate": "2020-03-10T19:05:39Z", "message": "#6697 delete user api update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0f7a276fd2ad9e5797420c6306aeddc4e5933c9", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/c0f7a276fd2ad9e5797420c6306aeddc4e5933c9", "committedDate": "2020-03-10T19:06:01Z", "message": "Merge branch 'develop' into 6697-delete-user-api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83a47c9e1b4387248abad6ddb633a3e0e6bae2c1", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/83a47c9e1b4387248abad6ddb633a3e0e6bae2c1", "committedDate": "2020-03-13T15:38:01Z", "message": "#6697 add test for roles, refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdc1b9711949052920cfd2fa68724a20be1f649c", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/fdc1b9711949052920cfd2fa68724a20be1f649c", "committedDate": "2020-03-13T15:38:21Z", "message": "Merge branch 'develop' into 6697-delete-user-api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92a76e8eccb0e4548cbb4a0579de47c900f79516", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/92a76e8eccb0e4548cbb4a0579de47c900f79516", "committedDate": "2020-03-13T19:34:41Z", "message": "#6697 fix delete user endpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d64f85b26d131a68d8ff46b04eeba7619a311b9", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/4d64f85b26d131a68d8ff46b04eeba7619a311b9", "committedDate": "2020-03-16T15:25:47Z", "message": "#6697 more delete user tests bundle update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac67f2c1b0dcae4d241cc1fd13aea62f8cec33ae", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/ac67f2c1b0dcae4d241cc1fd13aea62f8cec33ae", "committedDate": "2020-03-17T15:32:35Z", "message": "#6697 add integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ecc40c719aafa2877b5a352c68d8d0bebd17bf5", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/9ecc40c719aafa2877b5a352c68d8d0bebd17bf5", "committedDate": "2020-03-17T20:26:43Z", "message": "#6697 fix failing test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89f5d8e71bb651355dee18d69c4836265610312e", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/89f5d8e71bb651355dee18d69c4836265610312e", "committedDate": "2020-03-17T21:15:23Z", "message": "#6697 add test for user has role assigned"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a909444f7a22ea19a5752e93d465df71abcb422f", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/a909444f7a22ea19a5752e93d465df71abcb422f", "committedDate": "2020-03-18T14:04:41Z", "message": "#6697 refactor error messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44df633f85be8411d48757551004aed4667105f8", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/44df633f85be8411d48757551004aed4667105f8", "committedDate": "2020-03-18T14:12:15Z", "message": "#6697 add comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73cce6805e66f54108d442af5d97d0798901e04f", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/73cce6805e66f54108d442af5d97d0798901e04f", "committedDate": "2020-03-18T15:09:12Z", "message": "#6697 add doc for delete user"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a385cc2ae46951be1123a788ae7d22c2f19d94e0", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/a385cc2ae46951be1123a788ae7d22c2f19d94e0", "committedDate": "2020-03-19T15:08:08Z", "message": "Merge branch 'develop' into 6697-delete-user-api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NzQyNTYy", "url": "https://github.com/IQSS/dataverse/pull/6747#pullrequestreview-378742562", "createdAt": "2020-03-20T19:02:30Z", "commit": {"oid": "a385cc2ae46951be1123a788ae7d22c2f19d94e0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxOTowMjozMFrOF5f8Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxOTowOTo1NFrOF5gJqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzNjQ2Nw==", "bodyText": "we should probably add downloading, and no reason (I think) to say \"may\".", "url": "https://github.com/IQSS/dataverse/pull/6747#discussion_r395836467", "createdAt": "2020-03-20T19:02:30Z", "author": {"login": "scolapasta"}, "path": "doc/sphinx-guides/source/api/native-api.rst", "diffHunk": "@@ -2806,6 +2806,21 @@ Make User a SuperUser\n Toggles superuser mode on the ``AuthenticatedUser`` whose ``identifier`` (without the ``@`` sign) is passed. ::\n \n     POST http://$SERVER/api/admin/superuser/$identifier\n+    \n+Delete a User\n+~~~~~~~~~~~~~\n+\n+Deletes an ``AuthenticatedUser`` whose ``identifier`` (without the ``@`` sign) is passed. ::\n+\n+    DELETE http://$SERVER/api/admin/authenticatedUsers/$identifier\n+    \n+Deletes an ``AuthenticatedUser`` whose ``id``  is passed. ::\n+\n+    DELETE http://$SERVER/api/admin/authenticatedUsers/id/$id\n+    \n+Note: If the user has performed certain actions such as creating or contributing to a Dataset they may not be deleted.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a385cc2ae46951be1123a788ae7d22c2f19d94e0"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzOTE5Mw==", "bodyText": "Currently, once an access request is acted on, we delete, so I think it would be fair to just also delete these requests when you delete the user (instead of failing). My one question is that there has been talk of storing these for historical purposes. If/when we do, we may want to then either a) not allow delete of user or b) anonymize the requests. Or c) still delete them, of course, I just think we'll need to think of that case.\nBut that said, it makes sense to change that delete to be cascading now.", "url": "https://github.com/IQSS/dataverse/pull/6747#discussion_r395839193", "createdAt": "2020-03-20T19:08:23Z", "author": {"login": "scolapasta"}, "path": "src/main/java/edu/harvard/iq/dataverse/authorization/AuthenticationServiceBean.java", "diffHunk": "@@ -511,6 +533,69 @@ public AuthenticatedUser lookupUser( String apiToken ) {\n         return tkn.getAuthenticatedUser();\n     }\n     \n+    /*\n+    getDeleteUserErrorMessages( AuthenticatedUser au )\n+    method which checks for reasons that a user may not be deleted\n+    -has created dvObjects\n+    -has roles\n+    -has guestbook records\n+    -etc.\n+    An empty string is returned if the user is 'deletable'\n+    */\n+    \n+    public String getDeleteUserErrorMessages(AuthenticatedUser au) {\n+        String retVal = \"\";\n+        if (!dvObjSvc.findByAuthenticatedUserId(au).isEmpty()) {\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.dvobjects\");\n+        }\n+\n+        if (!roleAssigneeSvc.getAssignmentsFor(au.getIdentifier()).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.roleAssignments\");\n+        }\n+\n+        if (!gbRespSvc.findByAuthenticatedUserId(au).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.gbResps\");\n+        }\n+\n+        if (!datasetVersionService.getDatasetVersionUsersByAuthenticatedUser(au).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.versionUser\");\n+        }\n+\n+        if (!explicitGroupService.findGroups(au).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.groupMember\");\n+        }\n+\n+        if (userHasPendingAccessRequests(au)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a385cc2ae46951be1123a788ae7d22c2f19d94e0"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzOTQ1Mg==", "bodyText": "For delete of user, I think it's be fine to also just remove them from groups at the time.", "url": "https://github.com/IQSS/dataverse/pull/6747#discussion_r395839452", "createdAt": "2020-03-20T19:08:55Z", "author": {"login": "scolapasta"}, "path": "src/main/java/edu/harvard/iq/dataverse/authorization/AuthenticationServiceBean.java", "diffHunk": "@@ -511,6 +533,69 @@ public AuthenticatedUser lookupUser( String apiToken ) {\n         return tkn.getAuthenticatedUser();\n     }\n     \n+    /*\n+    getDeleteUserErrorMessages( AuthenticatedUser au )\n+    method which checks for reasons that a user may not be deleted\n+    -has created dvObjects\n+    -has roles\n+    -has guestbook records\n+    -etc.\n+    An empty string is returned if the user is 'deletable'\n+    */\n+    \n+    public String getDeleteUserErrorMessages(AuthenticatedUser au) {\n+        String retVal = \"\";\n+        if (!dvObjSvc.findByAuthenticatedUserId(au).isEmpty()) {\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.dvobjects\");\n+        }\n+\n+        if (!roleAssigneeSvc.getAssignmentsFor(au.getIdentifier()).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.roleAssignments\");\n+        }\n+\n+        if (!gbRespSvc.findByAuthenticatedUserId(au).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.gbResps\");\n+        }\n+\n+        if (!datasetVersionService.getDatasetVersionUsersByAuthenticatedUser(au).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.versionUser\");\n+        }\n+\n+        if (!explicitGroupService.findGroups(au).isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a385cc2ae46951be1123a788ae7d22c2f19d94e0"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzOTkxNQ==", "bodyText": "it's probably simpler code to add them to a list, then do a join to concatenate them at the end.", "url": "https://github.com/IQSS/dataverse/pull/6747#discussion_r395839915", "createdAt": "2020-03-20T19:09:54Z", "author": {"login": "scolapasta"}, "path": "src/main/java/edu/harvard/iq/dataverse/authorization/AuthenticationServiceBean.java", "diffHunk": "@@ -511,6 +533,69 @@ public AuthenticatedUser lookupUser( String apiToken ) {\n         return tkn.getAuthenticatedUser();\n     }\n     \n+    /*\n+    getDeleteUserErrorMessages( AuthenticatedUser au )\n+    method which checks for reasons that a user may not be deleted\n+    -has created dvObjects\n+    -has roles\n+    -has guestbook records\n+    -etc.\n+    An empty string is returned if the user is 'deletable'\n+    */\n+    \n+    public String getDeleteUserErrorMessages(AuthenticatedUser au) {\n+        String retVal = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a385cc2ae46951be1123a788ae7d22c2f19d94e0"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41008900e32164a9367c5f11c9fe6df5c49a2e02", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/41008900e32164a9367c5f11c9fe6df5c49a2e02", "committedDate": "2020-03-20T19:26:36Z", "message": "Merge branch 'develop' into 6697-delete-user-api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b85ce4a209d7f4e43652c0ff94104fa613a53194", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/b85ce4a209d7f4e43652c0ff94104fa613a53194", "committedDate": "2020-03-23T14:39:40Z", "message": "#6697 delete items that can be deleted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea4d8862d120228b724a0113b62beb7aa374c2f6", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/ea4d8862d120228b724a0113b62beb7aa374c2f6", "committedDate": "2020-03-23T14:50:24Z", "message": "#6697 update doc wording"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7043a0a08cbaf1ffceb1889fe201ec5a4d0f91dc", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/7043a0a08cbaf1ffceb1889fe201ec5a4d0f91dc", "committedDate": "2020-03-23T15:53:54Z", "message": "Update native-api.rst"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dffc893111c9c434d2612d85b3ce9424639b259a", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/dffc893111c9c434d2612d85b3ce9424639b259a", "committedDate": "2020-03-24T20:07:31Z", "message": "Merge branch 'develop' into 6697-delete-user-api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b000c78df6082aa9e99891df3320553fc5b288d5", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/b000c78df6082aa9e99891df3320553fc5b288d5", "committedDate": "2020-03-25T14:45:32Z", "message": "#6697 make world map token cascade delete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7695fb9f7a342c5308d8ac156a31cb2bd8e5216", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/c7695fb9f7a342c5308d8ac156a31cb2bd8e5216", "committedDate": "2020-03-25T15:24:19Z", "message": "#6697 add notifications to cascade delete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a1cc8a78ebf9844a442a88e2b35c74bb1f3023c", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/8a1cc8a78ebf9844a442a88e2b35c74bb1f3023c", "committedDate": "2020-03-25T20:39:07Z", "message": "#6697 fix comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNTIzODE5", "url": "https://github.com/IQSS/dataverse/pull/6747#pullrequestreview-381523819", "createdAt": "2020-03-25T20:47:45Z", "commit": {"oid": "c7695fb9f7a342c5308d8ac156a31cb2bd8e5216"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1b1d0c615e3ba893678fa7a9a5ee4eb6db58125", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/e1b1d0c615e3ba893678fa7a9a5ee4eb6db58125", "committedDate": "2020-03-31T19:14:24Z", "message": "Merge branch 'develop' into 6697-delete-user-api"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 942, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}