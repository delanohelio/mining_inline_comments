{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NzI5NTgz", "number": 6968, "title": "allow changes to file metadata via API #6962", "bodyText": "What this PR does / why we need it:\nA regression was introduced in pull request #6893 whereby modifying file metadata API failed with \"Filename already exists\". This bug is in develop, not production.\nWhich issue(s) this PR closes:\nCloses #6962\nSpecial notes for your reviewer:\nNone.\nSuggestions on how to test this:\n\nTry updating file metadata via API in develop vs this pull request. Docs: http://guides.dataverse.org/en/4.20/api/native-api.html#updating-file-metadata\nEnsure the FilesIT is passing\n\nDoes this PR introduce a user interface change? If mockups are available, please link/include them here:\nNo.\nIs there a release notes update needed for this change?:\nNo.\nAdditional documentation:\nNone.", "createdAt": "2020-06-05T20:20:22Z", "url": "https://github.com/IQSS/dataverse/pull/6968", "merged": true, "mergeCommit": {"oid": "bc06fe6e49816be0e31378434d3cdc6226336bc7"}, "closed": true, "closedAt": "2020-07-01T17:10:58Z", "author": {"login": "pdurbin"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoYe1LgH2gAyNDI4NzI5NTgzOjgwOTY0M2E5YmI3MmI4ZmFmNmZlY2Q3ZDZlM2FkMWQ1MmU5YzQwNTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcr7ZrGAFqTQzMTg3MjMzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "809643a9bb72b8faf6fecd7d6e3ad1d52e9c4058", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/809643a9bb72b8faf6fecd7d6e3ad1d52e9c4058", "committedDate": "2020-06-05T20:14:27Z", "message": "allow changes to file metadata via API #6962"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "508e95c6b9b7e999b40dea4f903424a1afb8da71", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/508e95c6b9b7e999b40dea4f903424a1afb8da71", "committedDate": "2020-06-08T16:27:57Z", "message": "allow file metadata changes if passing existing path/name #6962"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NTcxMDA3", "url": "https://github.com/IQSS/dataverse/pull/6968#pullrequestreview-426571007", "createdAt": "2020-06-08T19:53:03Z", "commit": {"oid": "508e95c6b9b7e999b40dea4f903424a1afb8da71"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxOTo1MzowM1rOGguEmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxOTo1NDoyMFrOGguHNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk2MjQ1Ng==", "bodyText": "does this do weird things if either one is null? i.e I would expect if you only passed on in, and it was the same, then there should be no labelChange, but I think the code for the equals would be false.", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r436962456", "createdAt": "2020-06-08T19:53:03Z", "author": {"login": "scolapasta"}, "path": "src/main/java/edu/harvard/iq/dataverse/api/Files.java", "diffHunk": "@@ -392,14 +392,26 @@ public Response updateFileMetadata(@FormDataParam(\"jsonData\") String jsonData,\n                 javax.json.JsonObject jsonObject = jsonReader.readObject();\n                 String label = jsonObject.getString(\"label\", null);\n                 String directoryLabel = jsonObject.getString(\"directoryLabel\", null);\n+                // If the user is trying to change the label/directoryLabel or not.\n+                boolean labelChange = true;\n+                if (label == null && directoryLabel == null) {\n+                    labelChange = false;\n+                }\n+                String oldLabel = df.getFileMetadata().getLabel();\n+                String oldDirectoryLabel = df.getFileMetadata().getDirectoryLabel();\n+                String oldPathPlusName = oldDirectoryLabel + oldLabel;\n+                String incomingPathPlusName = directoryLabel + label;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "508e95c6b9b7e999b40dea4f903424a1afb8da71"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk2MzEyNg==", "bodyText": "if directoryLabel is not passed in, do we want path to be \"\"? or keep the old value (as you do with label)?", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r436963126", "createdAt": "2020-06-08T19:54:20Z", "author": {"login": "scolapasta"}, "path": "src/main/java/edu/harvard/iq/dataverse/api/Files.java", "diffHunk": "@@ -392,14 +392,26 @@ public Response updateFileMetadata(@FormDataParam(\"jsonData\") String jsonData,\n                 javax.json.JsonObject jsonObject = jsonReader.readObject();\n                 String label = jsonObject.getString(\"label\", null);\n                 String directoryLabel = jsonObject.getString(\"directoryLabel\", null);\n+                // If the user is trying to change the label/directoryLabel or not.\n+                boolean labelChange = true;\n+                if (label == null && directoryLabel == null) {\n+                    labelChange = false;\n+                }\n+                String oldLabel = df.getFileMetadata().getLabel();\n+                String oldDirectoryLabel = df.getFileMetadata().getDirectoryLabel();\n+                String oldPathPlusName = oldDirectoryLabel + oldLabel;\n+                String incomingPathPlusName = directoryLabel + label;\n+                if (oldPathPlusName.equals(incomingPathPlusName)) {\n+                    labelChange = false;\n+                }\n                 String path = \"\";\n                 if (directoryLabel != null) {\n                     path = directoryLabel + \"/\";\n                 }\n                 if (label == null) {\n-                    label = df.getFileMetadata().getLabel();\n+                    label = oldLabel;\n                 }\n-                if (IngestUtil.conflictsWithExistingFilenames(label, directoryLabel, fmdList, df)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "508e95c6b9b7e999b40dea4f903424a1afb8da71"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NTk3Nzcx", "url": "https://github.com/IQSS/dataverse/pull/6968#pullrequestreview-426597771", "createdAt": "2020-06-08T20:31:43Z", "commit": {"oid": "508e95c6b9b7e999b40dea4f903424a1afb8da71"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMDozMTo0M1rOGgvSKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMDozNToxM1rOGgvb9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk4MjMxNQ==", "bodyText": "Sorry, maybe what I wrote wasn't clear, so let me use an example:\noldDirectory = \"directory\" and old label = \"label\"\nIf I only path in a label as \"label\" (i.e. no directory), I would expect it to allow it, as I am not changing anything. But the label check would compare \"directorylabel\" with \"nulllabel\" and so would run the check when it shouldn't.\nAlso if (for some reason) for new values you passed directory = \"director\" and label = \"ylabel\", the check would find them equal and so not check names, even though you are changing the names.\nSo the check also needs to have a \"/\" in there.", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r436982315", "createdAt": "2020-06-08T20:31:43Z", "author": {"login": "scolapasta"}, "path": "src/main/java/edu/harvard/iq/dataverse/api/Files.java", "diffHunk": "@@ -392,14 +392,26 @@ public Response updateFileMetadata(@FormDataParam(\"jsonData\") String jsonData,\n                 javax.json.JsonObject jsonObject = jsonReader.readObject();\n                 String label = jsonObject.getString(\"label\", null);\n                 String directoryLabel = jsonObject.getString(\"directoryLabel\", null);\n+                // If the user is trying to change the label/directoryLabel or not.\n+                boolean labelChange = true;\n+                if (label == null && directoryLabel == null) {\n+                    labelChange = false;\n+                }\n+                String oldLabel = df.getFileMetadata().getLabel();\n+                String oldDirectoryLabel = df.getFileMetadata().getDirectoryLabel();\n+                String oldPathPlusName = oldDirectoryLabel + oldLabel;\n+                String incomingPathPlusName = directoryLabel + label;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk2MjQ1Ng=="}, "originalCommit": {"oid": "508e95c6b9b7e999b40dea4f903424a1afb8da71"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk4NDgyMQ==", "bodyText": "Sorry path confused me here, what I'm getting it is:\nWhy don't we have have a\nif (directoryLabel == null) { directoryLabel = oldDrectorylLabel; }\nlike with label, otherwise null gets passed into the directory+name check, no? (and if we did this, we could really get rid of path altogether and just use directoryLabel + /. And this way if directorLabel were null, we would get a more accurate message anyway:\n\"Filename already exists at code/README.md\", when \"Filename already exists at README.md\" isn't accurate?", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r436984821", "createdAt": "2020-06-08T20:35:13Z", "author": {"login": "scolapasta"}, "path": "src/main/java/edu/harvard/iq/dataverse/api/Files.java", "diffHunk": "@@ -392,14 +392,26 @@ public Response updateFileMetadata(@FormDataParam(\"jsonData\") String jsonData,\n                 javax.json.JsonObject jsonObject = jsonReader.readObject();\n                 String label = jsonObject.getString(\"label\", null);\n                 String directoryLabel = jsonObject.getString(\"directoryLabel\", null);\n+                // If the user is trying to change the label/directoryLabel or not.\n+                boolean labelChange = true;\n+                if (label == null && directoryLabel == null) {\n+                    labelChange = false;\n+                }\n+                String oldLabel = df.getFileMetadata().getLabel();\n+                String oldDirectoryLabel = df.getFileMetadata().getDirectoryLabel();\n+                String oldPathPlusName = oldDirectoryLabel + oldLabel;\n+                String incomingPathPlusName = directoryLabel + label;\n+                if (oldPathPlusName.equals(incomingPathPlusName)) {\n+                    labelChange = false;\n+                }\n                 String path = \"\";\n                 if (directoryLabel != null) {\n                     path = directoryLabel + \"/\";\n                 }\n                 if (label == null) {\n-                    label = df.getFileMetadata().getLabel();\n+                    label = oldLabel;\n                 }\n-                if (IngestUtil.conflictsWithExistingFilenames(label, directoryLabel, fmdList, df)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk2MzEyNg=="}, "originalCommit": {"oid": "508e95c6b9b7e999b40dea4f903424a1afb8da71"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9954220a37fda04f5864fae9fbdfa9c77e558314", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/9954220a37fda04f5864fae9fbdfa9c77e558314", "committedDate": "2020-06-09T15:59:23Z", "message": "allow changes if dir exists and label passed, formatting #6962"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5ec9bc3648a6521c0cf99401ce88704fad91645", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/e5ec9bc3648a6521c0cf99401ce88704fad91645", "committedDate": "2020-06-09T16:06:40Z", "message": "avoid dir1 + file1 == dir + 1file1 (add \"/\") #6962"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDM0MzY5", "url": "https://github.com/IQSS/dataverse/pull/6968#pullrequestreview-427434369", "createdAt": "2020-06-09T18:32:11Z", "commit": {"oid": "e5ec9bc3648a6521c0cf99401ce88704fad91645"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxODozMjoxMlrOGhXMRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxODozOToxMFrOGhXbJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzNjE2Nw==", "bodyText": "Last suggested change - we can remove this check since it's handled by the code below (if both are null, they get populated with their old values). Simplifies the code for minimal \"cost\".", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r437636167", "createdAt": "2020-06-09T18:32:12Z", "author": {"login": "scolapasta"}, "path": "src/main/java/edu/harvard/iq/dataverse/api/Files.java", "diffHunk": "@@ -392,16 +392,32 @@ public Response updateFileMetadata(@FormDataParam(\"jsonData\") String jsonData,\n                 javax.json.JsonObject jsonObject = jsonReader.readObject();\n                 String label = jsonObject.getString(\"label\", null);\n                 String directoryLabel = jsonObject.getString(\"directoryLabel\", null);\n-                String path = \"\";\n-                if (directoryLabel != null) {\n-                    path = directoryLabel + \"/\";\n+                // If the user is trying to change the label/directoryLabel or not.\n+                boolean labelChange = true;\n+                if (label == null && directoryLabel == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5ec9bc3648a6521c0cf99401ce88704fad91645"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzOTk3NQ==", "bodyText": "I know this is just for the error message, but why not just use \"incomingPathPlusName\" here?", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r437639975", "createdAt": "2020-06-09T18:39:10Z", "author": {"login": "scolapasta"}, "path": "src/main/java/edu/harvard/iq/dataverse/api/Files.java", "diffHunk": "@@ -392,16 +392,32 @@ public Response updateFileMetadata(@FormDataParam(\"jsonData\") String jsonData,\n                 javax.json.JsonObject jsonObject = jsonReader.readObject();\n                 String label = jsonObject.getString(\"label\", null);\n                 String directoryLabel = jsonObject.getString(\"directoryLabel\", null);\n-                String path = \"\";\n-                if (directoryLabel != null) {\n-                    path = directoryLabel + \"/\";\n+                // If the user is trying to change the label/directoryLabel or not.\n+                boolean labelChange = true;\n+                if (label == null && directoryLabel == null) {\n+                    labelChange = false;\n+                }\n+                String oldLabel = df.getFileMetadata().getLabel();\n+                String oldDirectoryLabel = df.getFileMetadata().getDirectoryLabel();\n+                String oldPathPlusName = oldDirectoryLabel + \"/\" + oldLabel;\n+                if (directoryLabel == null) {\n+                    directoryLabel = oldDirectoryLabel;\n                 }\n                 if (label == null) {\n-                    label = df.getFileMetadata().getLabel();\n+                    label = oldLabel;\n+                }\n+                String incomingPathPlusName = directoryLabel + \"/\" + label;\n+                if (oldPathPlusName.equals(incomingPathPlusName)) {\n+                    labelChange = false;\n                 }\n-                if (IngestUtil.conflictsWithExistingFilenames(label, directoryLabel, fmdList, df)) {\n-                    String incomingPathPlusFileName = path + label;\n-                    return error(BAD_REQUEST, BundleUtil.getStringFromBundle(\"files.api.metadata.update.duplicateFile\", Arrays.asList(incomingPathPlusFileName)));\n+                if (labelChange && IngestUtil.conflictsWithExistingFilenames(label, directoryLabel, fmdList, df)) {\n+                    String pathPlusFilename = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5ec9bc3648a6521c0cf99401ce88704fad91645"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "491caff845882885c084498890d0ab0fc7336a32", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/491caff845882885c084498890d0ab0fc7336a32", "committedDate": "2020-06-09T20:41:04Z", "message": "eliminate code we don't need, handled elsewhere #6962\n\nIf null, populated by old values anyway."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a34d7c1a76d283fe195bcad57215ea12b920e340", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/a34d7c1a76d283fe195bcad57215ea12b920e340", "committedDate": "2020-06-10T15:16:08Z", "message": "ensure passing \"\" as directoryLabel doesn't cause problems #6962"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MDA1MTgw", "url": "https://github.com/IQSS/dataverse/pull/6968#pullrequestreview-429005180", "createdAt": "2020-06-11T15:06:50Z", "commit": {"oid": "a34d7c1a76d283fe195bcad57215ea12b920e340"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTowNjo1MFrOGihmvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTowNjo1MFrOGihmvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg1NTM1Ng==", "bodyText": "The issue here is that if it gets to the conflictswithexisting stage and that returns false, I think we have a problem:\nif conflictswithexisting filenames returns false, it\u2019s because it\u2019s treating \u2018\u2019 and null differently, since the name is the same). So if you did the same thing, but actually changed the name of the file to a different file name that does exist? Wouldn\u2019t conflictswithexisting still return false then and allow you to rename to an already existing file.\nThe use case is you have two files:\n\u2022 the existing values are null for directory for both, names are file1 and file2\n\u2022 call the api to edit file1 with \u201c\u201d as directoryLabel and label as \u201cfile2\"\n\u2022 I\u2019m concerned that labelChange would be true and conflictswithexisting would be false and that would allow you to have the same null/file2 for both.", "url": "https://github.com/IQSS/dataverse/pull/6968#discussion_r438855356", "createdAt": "2020-06-11T15:06:50Z", "author": {"login": "scolapasta"}, "path": "src/test/java/edu/harvard/iq/dataverse/api/DuplicateFilesIT.java", "diffHunk": "@@ -419,4 +420,77 @@ public void existingDirectoryPassLabelChangeDescription() throws IOException {\n \n     }\n \n+    /**\n+     * This test is for the following scenario.\n+     *\n+     * What if the database has null for the directoryLabel? What if you pass in\n+     * directory as \u201c\u201d (because you don\u2019t realize you can just not pass it).\n+     * when it check and compares, the old directory is null. so will that mean\n+     * labelChange = true and it will fail even though you didn\u2019t really change\n+     * the directory?\n+     *\n+     * While \"labelChange\" does end up being true,\n+     * IngestUtil.conflictsWithExistingFilenames returns false, so the change is\n+     * allowed to go through. The description is allowed to be changed and the\n+     * directoryLabel remains null even though the user passed in an empty\n+     * string, which is what we want.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a34d7c1a76d283fe195bcad57215ea12b920e340"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2debed2d9cc0ee0996d9b53fa4dde0b0f13dbb11", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/2debed2d9cc0ee0996d9b53fa4dde0b0f13dbb11", "committedDate": "2020-06-15T16:08:31Z", "message": "simply conflict-checking code #6962"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxODcyMzM3", "url": "https://github.com/IQSS/dataverse/pull/6968#pullrequestreview-431872337", "createdAt": "2020-06-16T20:37:16Z", "commit": {"oid": "2debed2d9cc0ee0996d9b53fa4dde0b0f13dbb11"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 842, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}