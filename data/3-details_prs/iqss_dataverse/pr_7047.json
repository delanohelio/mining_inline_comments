{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyOTU2NDg0", "number": 7047, "title": "Add \"download all\" buttons (including size of dataset) to dataset page", "bodyText": "What this PR does / why we need it:\nThis pull request adds \"download all\" buttons at the dataset level and shows the size of the dataset.\nWhich issue(s) this PR closes:\n\nCloses #6118  Make download all files feature more prominent\nCloses #6400 Display the total size of a dataset on the dataset page\n\nSpecial notes for your reviewer:\n(this should probably be removed, since the issue has been resolved? - At least I'm going to mark it as resolved. -- L.A.)\nRiddle me this... why do I get a different \"size of dataset\" number that what I see for the file? Here's a screenshot:\n\nAlso, there has been discussion of adding a \"download all files\" API but @djbrooke and I have decided to split this off into a separate chunk, represented by #4529.\nSuggestions on how to test this:\n\nTest both tabular and non tabular files.\nTest datasets with and without terms of use.\nTest datasets with and without a guestbook.\nTest restricted files.\n\nDoes this PR introduce a user interface change? If mockups are available, please link/include them here:\nI don't see any mockups linked from #6118 but I believe they are our there somewhere. In addition to the screenshot above, here's one for a dataset with no tabular files:\n\nIs there a release notes update needed for this change?:\nI think there's already a release note about general dataset redesign improvements? I can add another note if we want.\nAdditional documentation:\nI didn't touch the User Guide because my understanding is that we are going to update it all at once after the UI changes.", "createdAt": "2020-07-01T19:58:22Z", "url": "https://github.com/IQSS/dataverse/pull/7047", "merged": true, "mergeCommit": {"oid": "d3f1f6d02a2f4c1ad1ae9f049644767b2b707ba7"}, "closed": true, "closedAt": "2020-07-20T18:58:58Z", "author": {"login": "pdurbin"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwY3X1gH2gAyNDQyOTU2NDg0OmMxYTYxMjYyOGUzMzFjZGFhMjk3NTNhOGM2MzY5ZmM3YzdiY2Q5YWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1lNJdgH2gAyNDQyOTU2NDg0OjE3NGVjNDMyODExNzEwY2M3MDFiMzQxZWE5OWQwZTVlYjcxZWNmNWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c1a612628e331cdaa29753a8c6369fc7c7bcd9ae", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/c1a612628e331cdaa29753a8c6369fc7c7bcd9ae", "committedDate": "2020-06-30T17:12:39Z", "message": "add download all buttons under access button #6118"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/3f4ac7f34c2be2948a4a7a0507d31e700adb064a", "committedDate": "2020-07-01T17:08:06Z", "message": "add size to \"download all\" link #6118"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjU1NDA0", "url": "https://github.com/IQSS/dataverse/pull/7047#pullrequestreview-441255404", "createdAt": "2020-07-01T23:24:29Z", "commit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzoyNDoyOVrOGr4Ycg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzoyNDoyOVrOGr4Ycg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NTcxNA==", "bodyText": "Links are missing the btn-download style class included in the placeholder, and required by the analytics code.", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r448665714", "createdAt": "2020-07-01T23:24:29Z", "author": {"login": "mheppler"}, "path": "src/main/webapp/dataset.xhtml", "diffHunk": "@@ -143,17 +139,29 @@\n                                                 </button>\n                                                 <ul class=\"dropdown-menu pull-right text-left\">\n                                                     \n-                                                    <ui:remove>\n                                                     <!-- DOWNLOAD -->\n-                                                    <!-- TO-DO #3513 DOWNLOAD ALL LINK -->\n                                                     <ui:fragment rendered=\"#{DatasetPage.canDownloadFiles()}\">\n                                                         <li class=\"dropdown-header\">#{bundle['dataset.accessBtn.header.download']} <span class=\"glyphicon glyphicon-download-alt\"/></li>\n-                                                        <li class=\"disabled\">\n-                                                            <span class=\"ui-commandlink ui-widget ui-state-disabled btn-download\">Download (Placeholder)</span>\n+                                                        <!-- NORMAL DOWNLOAD BUTTON (NO TABULAR FILES) -->\n+                                                        <li jsf:rendered=\"#{!DatasetPage.isHasTabular()}\">\n+                                                            <p:commandLink update=\"@form\" actionListener=\"#{DatasetPage.validateAllFilesForDownloadArchival()}\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjU1NzM1", "url": "https://github.com/IQSS/dataverse/pull/7047#pullrequestreview-441255735", "createdAt": "2020-07-01T23:25:33Z", "commit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzoyNTozM1rOGr4Zpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzoyNTozM1rOGr4Zpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NjAyMw==", "bodyText": "\"ZIP\" file type labels should be moved to the bundle.", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r448666023", "createdAt": "2020-07-01T23:25:33Z", "author": {"login": "mheppler"}, "path": "src/main/webapp/dataset.xhtml", "diffHunk": "@@ -143,17 +139,29 @@\n                                                 </button>\n                                                 <ul class=\"dropdown-menu pull-right text-left\">\n                                                     \n-                                                    <ui:remove>\n                                                     <!-- DOWNLOAD -->\n-                                                    <!-- TO-DO #3513 DOWNLOAD ALL LINK -->\n                                                     <ui:fragment rendered=\"#{DatasetPage.canDownloadFiles()}\">\n                                                         <li class=\"dropdown-header\">#{bundle['dataset.accessBtn.header.download']} <span class=\"glyphicon glyphicon-download-alt\"/></li>\n-                                                        <li class=\"disabled\">\n-                                                            <span class=\"ui-commandlink ui-widget ui-state-disabled btn-download\">Download (Placeholder)</span>\n+                                                        <!-- NORMAL DOWNLOAD BUTTON (NO TABULAR FILES) -->\n+                                                        <li jsf:rendered=\"#{!DatasetPage.isHasTabular()}\">\n+                                                            <p:commandLink update=\"@form\" actionListener=\"#{DatasetPage.validateAllFilesForDownloadArchival()}\">\n+                                                                #{bundle.download} (ZIP, #{DatasetPage.sizeOfDataset})\n+                                                            </p:commandLink>\n+                                                        </li>\n+                                                        <!-- DOWNLOAD ORIGINAL BUTTON (TABULAR FILES PRESENT) -->\n+                                                        <li jsf:rendered=\"#{DatasetPage.isHasTabular()}\">\n+                                                            <p:commandLink update=\"@form\" actionListener=\"#{DatasetPage.validateAllFilesForDownloadOriginal()}\">\n+                                                                #{bundle.downloadOriginal} (ZIP, #{DatasetPage.sizeOfDataset})\n+                                                            </p:commandLink>\n+                                                        </li>\n+                                                        <!-- DOWNLOAD ARCHIVAL FILES (TABULAR FILES PRESENT) -->\n+                                                        <li jsf:rendered=\"#{DatasetPage.isHasTabular()}\">\n+                                                            <p:commandLink update=\"@form\" actionListener=\"#{DatasetPage.validateAllFilesForDownloadArchival()}\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjU3MTUw", "url": "https://github.com/IQSS/dataverse/pull/7047#pullrequestreview-441257150", "createdAt": "2020-07-01T23:29:48Z", "commit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzoyOTo0OFrOGr4eZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzoyOTo0OFrOGr4eZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NzIzOA==", "bodyText": "I assume this selectAllFiles() is what's responsible for the odd UI behavior... when you select \"Download\" from the Access Dataset dropdown, you get the ZIP download, but now all the files are selected in the files table... that shouldn't be necessary... there has to be a way to get the ZIP without the unexpected UI behavior.", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r448667238", "createdAt": "2020-07-01T23:29:48Z", "author": {"login": "mheppler"}, "path": "src/main/java/edu/harvard/iq/dataverse/DatasetPage.java", "diffHunk": "@@ -2886,8 +2889,35 @@ public void setSelectedDownloadableFiles(List<FileMetadata> selectedDownloadable\n     public void setSelectedNonDownloadableFiles(List<FileMetadata> selectedNonDownloadableFiles) {\n         this.selectedNonDownloadableFiles = selectedNonDownloadableFiles;\n     }\n-    \n-            \n+\n+    public String getSizeOfDataset() {\n+        GetDatasetStorageSizeCommand cmd = new GetDatasetStorageSizeCommand(dvRequestService.getDataverseRequest(), dataset, false, GetDatasetStorageSizeCommand.Mode.DOWNLOAD, workingVersion);\n+        try {\n+            long bytes = commandEngine.submit(cmd);\n+            return FileSizeChecker.bytesToHumanReadable(bytes);\n+        } catch (CommandException ex) {\n+            return \"\";\n+        }\n+    }\n+\n+    public void validateAllFilesForDownloadArchival() {\n+        selectAllFiles();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjU4MDM4", "url": "https://github.com/IQSS/dataverse/pull/7047#pullrequestreview-441258038", "createdAt": "2020-07-01T23:32:29Z", "commit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzozMjoyOVrOGr4iJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzozMjoyOVrOGr4iJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2ODE5Ng==", "bodyText": "Bug in the download size displayed. My locally tested datasets are saying the download will be \"300 B\", but the resulting ZIP is 11 KB, or 11,000 B.", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r448668196", "createdAt": "2020-07-01T23:32:29Z", "author": {"login": "mheppler"}, "path": "src/main/java/edu/harvard/iq/dataverse/DatasetPage.java", "diffHunk": "@@ -2886,8 +2889,35 @@ public void setSelectedDownloadableFiles(List<FileMetadata> selectedDownloadable\n     public void setSelectedNonDownloadableFiles(List<FileMetadata> selectedNonDownloadableFiles) {\n         this.selectedNonDownloadableFiles = selectedNonDownloadableFiles;\n     }\n-    \n-            \n+\n+    public String getSizeOfDataset() {\n+        GetDatasetStorageSizeCommand cmd = new GetDatasetStorageSizeCommand(dvRequestService.getDataverseRequest(), dataset, false, GetDatasetStorageSizeCommand.Mode.DOWNLOAD, workingVersion);\n+        try {\n+            long bytes = commandEngine.submit(cmd);\n+            return FileSizeChecker.bytesToHumanReadable(bytes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "054f249a4181672e2ca49245a4c9d138f4c9d37a", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/054f249a4181672e2ca49245a4c9d138f4c9d37a", "committedDate": "2020-07-02T15:27:32Z", "message": "add btn-download style class for analytics #6118"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "140ba41e4501324bb513bc6fe760e3aa5e8ed55d", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/140ba41e4501324bb513bc6fe760e3aa5e8ed55d", "committedDate": "2020-07-02T16:16:49Z", "message": "move ZIP to bundle #6118"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "427c88356ee9aa684360457b14419d3f8474423a", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/427c88356ee9aa684360457b14419d3f8474423a", "committedDate": "2020-07-07T18:35:23Z", "message": "stop using selectedFiles field #6118"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19577769b5aabe4ab1b9391b0fc0de01857a547b", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/19577769b5aabe4ab1b9391b0fc0de01857a547b", "committedDate": "2020-07-07T21:13:47Z", "message": "don't double count tabular files in size #6118"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MjkyMzE4", "url": "https://github.com/IQSS/dataverse/pull/7047#pullrequestreview-447292318", "createdAt": "2020-07-13T14:15:56Z", "commit": {"oid": "19577769b5aabe4ab1b9391b0fc0de01857a547b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "115353c44aa69a48e1b729d9abeb87a63c6f3411", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/115353c44aa69a48e1b729d9abeb87a63c6f3411", "committedDate": "2020-07-16T18:05:57Z", "message": "prevent orig file size from being added to tabular files #6118"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e79f1beb3372f1d536e67d4558bbf69e649fb56", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/7e79f1beb3372f1d536e67d4558bbf69e649fb56", "committedDate": "2020-07-16T18:45:37Z", "message": "use version to determine if tabular download #6118"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c13a5cc688178da83577f59ebc0791301aca6de2", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/c13a5cc688178da83577f59ebc0791301aca6de2", "committedDate": "2020-07-16T20:12:31Z", "message": "switch to smaller, simpler download size method #6118\n\nAlso, revert changes to GetDatasetStorageSizeCommand\nand DatasetServiceBean since we won't be using them."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "174ec432811710cc701b341ea99d0e5eb71ecf5d", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/174ec432811710cc701b341ea99d0e5eb71ecf5d", "committedDate": "2020-07-16T20:24:55Z", "message": "remove unused imports #6118"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 873, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}