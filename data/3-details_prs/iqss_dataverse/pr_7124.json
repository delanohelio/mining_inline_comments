{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1ODc1MTA5", "number": 7124, "title": "tsv ingest fix for directupload", "bodyText": "What this PR does / why we need it: enables ingest of .tsv files (and potentially other types) with direct upload when the browser does not supply a mimetype. The changes here invoke code to determine the mimetype from the extension and then update the mapping of tsv files to the currently required text/tsv mimetype.\nWhich issue(s) this PR closes:\nCloses #7122\nSpecial notes for your reviewer:\nSuggestions on how to test this: setup for direct upload and try uploading a small tsv - it should ingest to produce a .tab file. Also turn on fine logging for the FileUtil class and look for \"Determined type: text/tsv\".  - If you see this, it indicates that you are in the test case where your browser doesn't supply a mimetype for .tsv files. If you don't see this, you may need to remove any mapping for the .tsv extension from your test browser/machine (or I can slack/demo against the test server from my browser that doesn't provide a mimetype).\nDoes this PR introduce a user interface change? If mockups are available, please link/include them here: no\nIs there a release notes update needed for this change?: no\nAdditional documentation:", "createdAt": "2020-07-23T18:13:45Z", "url": "https://github.com/IQSS/dataverse/pull/7124", "merged": true, "mergeCommit": {"oid": "a56068255588a1632c070d7497d4587c5930dcc4"}, "closed": true, "closedAt": "2020-08-12T22:09:14Z", "author": {"login": "qqmyers"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3zVYpAH2gAyNDU1ODc1MTA5OjgwOTNkYzExYjMxNmVlZjZjZjU5MmZiMmFiOGM3NjhiNDExNjNiZTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-SmcSAFqTQ2NjMwMTU2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8093dc11b316eef6cf592fb2ab8c768b41163be7", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/8093dc11b316eef6cf592fb2ab8c768b41163be7", "committedDate": "2020-07-23T18:00:26Z", "message": "add tsv to recognized extensions for mimetype determination"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba33cd1227d5128820e08fdd317254f144183747", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/ba33cd1227d5128820e08fdd317254f144183747", "committedDate": "2020-07-23T18:00:44Z", "message": "enable direct upload/ingest of text/tsv\n\nwhen no mimetype is assigned by the browser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d930df0a5b5203a8a40ebccc3b16cc94daaedea", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/4d930df0a5b5203a8a40ebccc3b16cc94daaedea", "committedDate": "2020-07-23T18:00:58Z", "message": "use mimetype determination by extension for direct upload"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ae270b9a04924ac8fd0b1b2371b9e96e38800ff", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/8ae270b9a04924ac8fd0b1b2371b9e96e38800ff", "committedDate": "2020-07-23T18:06:16Z", "message": "remove unnecessary changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMzIwMzI1", "url": "https://github.com/IQSS/dataverse/pull/7124#pullrequestreview-463320325", "createdAt": "2020-08-07T13:40:00Z", "commit": {"oid": "8ae270b9a04924ac8fd0b1b2371b9e96e38800ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMzo0MDowMFrOG9aROw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMzo0MDowMFrOG9aROw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA0NjcxNQ==", "bodyText": "Do we care if the suppliedContentType is blank or null?", "url": "https://github.com/IQSS/dataverse/pull/7124#discussion_r467046715", "createdAt": "2020-08-07T13:40:00Z", "author": {"login": "sekmiller"}, "path": "src/main/java/edu/harvard/iq/dataverse/util/FileUtil.java", "diffHunk": "@@ -1091,8 +1091,13 @@ public static String generateOriginalExtension(String fileType) {\n \n \t\t\t} \n \t\t} else {\n-\t\t\t//Remote file, trust supplier\n-\t\t\tfinalType = suppliedContentType;\n+\t\t\tif(suppliedContentType==FileUtil.MIME_TYPE_UNDETERMINED_DEFAULT) {\n+\t\t\t\tfinalType=determineFileTypeByExtension(fileName);\n+\t\t\t\tlogger.fine(\"Determined type: \" + finalType);\n+\t\t\t} else {\n+\t\t\t  //Remote file, trust supplier\n+\t\t\t  finalType = suppliedContentType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ae270b9a04924ac8fd0b1b2371b9e96e38800ff"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22572a59f05199f68b0b333a1ebe6c8ff08a7689", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/22572a59f05199f68b0b333a1ebe6c8ff08a7689", "committedDate": "2020-08-07T14:03:03Z", "message": "avoid a null/blank finalType"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNTMzNjU2", "url": "https://github.com/IQSS/dataverse/pull/7124#pullrequestreview-463533656", "createdAt": "2020-08-07T18:53:50Z", "commit": {"oid": "22572a59f05199f68b0b333a1ebe6c8ff08a7689"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54a12b1496cf5750337ff8cd9bf0fe2f8636f774", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/54a12b1496cf5750337ff8cd9bf0fe2f8636f774", "committedDate": "2020-08-10T18:34:17Z", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/7122-tsv_ingest_with_directupload"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5715f0e780245c161bdbc52d4078c9b62f3ddd64", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/5715f0e780245c161bdbc52d4078c9b62f3ddd64", "committedDate": "2020-08-12T20:46:48Z", "message": "still check if suppliedType was blank"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3be92f4ae977d7883abf1a1b1fed151daa9d7f0", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/b3be92f4ae977d7883abf1a1b1fed151daa9d7f0", "committedDate": "2020-08-12T21:47:55Z", "message": "Use same rules for replacing mimetypes in direct upload\n\nas in normal upload. This will replace generic types as in this issue as\nwell as replace text/tab-separated-value mimetypes so that tsv files get\ningested and will stop the browser supplied mimetypes for r, stata, etc.\nin the same way that normal upload does."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MzAxNTYx", "url": "https://github.com/IQSS/dataverse/pull/7124#pullrequestreview-466301561", "createdAt": "2020-08-12T21:49:39Z", "commit": {"oid": "b3be92f4ae977d7883abf1a1b1fed151daa9d7f0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMTo0OTozOVrOG_0EuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMTo0OTozOVrOG_0EuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU2NjY0OA==", "bodyText": "just moved and made to return a boolean, no logic changes.", "url": "https://github.com/IQSS/dataverse/pull/7124#discussion_r469566648", "createdAt": "2020-08-12T21:49:39Z", "author": {"login": "qqmyers"}, "path": "src/main/java/edu/harvard/iq/dataverse/util/FileUtil.java", "diffHunk": "@@ -1126,7 +1106,42 @@ public static String generateOriginalExtension(String fileType) {\n     }   // end createDataFiles\n     \n \n-    private static File saveInputStreamInTempFile(InputStream inputStream, Long fileSizeLimit)\n+\tprivate static boolean useRecognizedType(String suppliedContentType, String recognizedType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3be92f4ae977d7883abf1a1b1fed151daa9d7f0"}, "originalPosition": 83}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 908, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}