{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0MDUxOTcz", "number": 7105, "title": "6865 no more deadlocks", "bodyText": "What this PR does / why we need it:\nIt cleans up some indexing code - it extracts the index call that was in the DataverseServiceBean save into separate helper methods that can be called my commands in their onSuccess methods; it also removes the indexing of role related permissions during execute (since the dataverse is indexed in the onSuccess), which appeared to be the cause of the deadlocks we were getting in the tests\nWhich issue(s) this PR closes:\nCloses #6865\nSpecial notes for your reviewer:\nThe Commands that call the save are listed here and whether I added on success call. Please review these decisions carefully, in case I missed something.\nCreateDataverseCommand - already had an onSuccess index call - so it was already doubling up\nPublishDataverseCommand - already had a call to index the permissions on success\nRenameDataverseCommand- added a call to re index object on success\nUpdateDataverseCommand - already had a call to index the object and all child datasets (unsure why it needed, but kept same logic it had)\nUpdatePermissionRootCommand - added a call to re index object and permissions on success (honestly wasn't sure when this command is needed so went the safe root)\nMoveDataverseCommand - indexing is already happening in execute - should be moved to onSuccess, but out of scope for this change\nUpdateDataverseDefaultContributorRoleCommand - doesn't need indexing\nUpdateDataverseGuestbookCommand - doesn't need indexing\nUpdateDataverseGuestbookRootCommand - doesn't need indexing\nUpdateDataverseTemplateRootCommand - doesn't need indexing\nUpdateDataverseThemeCommand - doesn't need indexing\nSuggestions on how to test this:\nThe straightforward thing to do would be test where each of the above commands are used, as they are the ones that will be affected by these changes. In particular that roles permissions are indexed correctly for CreateDataverseCommand.\nDoes this PR introduce a user interface change? If mockups are available, please link/include them here:\nno\nIs there a release notes update needed for this change?:\nno\nAdditional documentation:", "createdAt": "2020-07-21T02:45:42Z", "url": "https://github.com/IQSS/dataverse/pull/7105", "merged": true, "mergeCommit": {"oid": "4525f9490085f62cddec2c33fe0e865bec5d4133"}, "closed": true, "closedAt": "2020-07-28T14:13:31Z", "author": {"login": "scolapasta"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc28oyjgH2gAyNDU0MDUxOTczOjYzZWEyMjNmMjE1MjM3NWVhYmRlMWM2MmJhYzQ4ZDdlOTM0YWYwMTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5ES42gFqTQ1NTkzNjgwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "63ea223f2152375eabde1c62bac48d7e934af012", "author": {"user": {"login": "scolapasta", "name": "Gustavo Durand"}}, "url": "https://github.com/IQSS/dataverse/commit/63ea223f2152375eabde1c62bac48d7e934af012", "committedDate": "2020-07-21T02:16:51Z", "message": "Extract index from save and create new helper methods for commands to call."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "710f6273cd696a27b6dcfc6249d987b64235d235", "author": {"user": {"login": "scolapasta", "name": "Gustavo Durand"}}, "url": "https://github.com/IQSS/dataverse/commit/710f6273cd696a27b6dcfc6249d987b64235d235", "committedDate": "2020-07-21T02:18:32Z", "message": "Extract index from save and create new helper methods for commands to call."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72e00a22db4047109ff348f234b766e39d4bddd7", "author": {"user": {"login": "scolapasta", "name": "Gustavo Durand"}}, "url": "https://github.com/IQSS/dataverse/commit/72e00a22db4047109ff348f234b766e39d4bddd7", "committedDate": "2020-07-21T02:20:37Z", "message": "Extract index from save and create new helper methods for commands to call."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94c58c2e8dd6f440b58f44a8d12dee0ff13cfffb", "author": {"user": {"login": "scolapasta", "name": "Gustavo Durand"}}, "url": "https://github.com/IQSS/dataverse/commit/94c58c2e8dd6f440b58f44a8d12dee0ff13cfffb", "committedDate": "2020-07-21T02:24:42Z", "message": "removed an extraneous indexing call"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a86d1285a26953a534f9109c8c47f73b6a24cee", "author": {"user": {"login": "scolapasta", "name": "Gustavo Durand"}}, "url": "https://github.com/IQSS/dataverse/commit/4a86d1285a26953a534f9109c8c47f73b6a24cee", "committedDate": "2020-07-21T02:25:58Z", "message": "added a TODO comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8225dd29d6a96108700235aad5a2fafbfd33d3e2", "author": {"user": {"login": "scolapasta", "name": "Gustavo Durand"}}, "url": "https://github.com/IQSS/dataverse/commit/8225dd29d6a96108700235aad5a2fafbfd33d3e2", "committedDate": "2020-07-21T02:27:26Z", "message": "Extract index from save and create new helper methods for commands to call."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82749f63b9a7eafecadd8c6b4b6429f465afd21f", "author": {"user": {"login": "scolapasta", "name": "Gustavo Durand"}}, "url": "https://github.com/IQSS/dataverse/commit/82749f63b9a7eafecadd8c6b4b6429f465afd21f", "committedDate": "2020-07-21T02:30:13Z", "message": "Extract index from save and create new helper methods for commands to call."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f506a0fbad5fe3376b16c7c9dd95a175b199694", "author": {"user": {"login": "scolapasta", "name": "Gustavo Durand"}}, "url": "https://github.com/IQSS/dataverse/commit/1f506a0fbad5fe3376b16c7c9dd95a175b199694", "committedDate": "2020-07-21T02:31:56Z", "message": "Extract index from save and create new helper methods for commands to call."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c794c8db9d1794e7e05f4642e7b4fcc64dd23799", "author": {"user": {"login": "scolapasta", "name": "Gustavo Durand"}}, "url": "https://github.com/IQSS/dataverse/commit/c794c8db9d1794e7e05f4642e7b4fcc64dd23799", "committedDate": "2020-07-21T02:34:20Z", "message": "Extract index from save and create new helper methods for commands to call."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f0d65aacf770b9b4d91f077d790172e3dbbb1dd", "author": {"user": {"login": "scolapasta", "name": "Gustavo Durand"}}, "url": "https://github.com/IQSS/dataverse/commit/3f0d65aacf770b9b4d91f077d790172e3dbbb1dd", "committedDate": "2020-07-21T02:36:49Z", "message": "because indexing happens asynchronously, we'll wait first, and then retry a few times, before failing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68ccc23bf2d2e97ab181518c0f26a3199d8519cd", "author": {"user": {"login": "scolapasta", "name": "Gustavo Durand"}}, "url": "https://github.com/IQSS/dataverse/commit/68ccc23bf2d2e97ab181518c0f26a3199d8519cd", "committedDate": "2020-07-21T02:37:53Z", "message": "Extract index from save and create new helper methods for commands to call."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNTU2ODk2", "url": "https://github.com/IQSS/dataverse/pull/7105#pullrequestreview-453556896", "createdAt": "2020-07-22T17:59:33Z", "commit": {"oid": "68ccc23bf2d2e97ab181518c0f26a3199d8519cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNzo1OTozNFrOG1t8_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNzo1OTozNFrOG1t8_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MDYwNw==", "bodyText": "The index dataverse here does not index permissions. Should you be using index((Dataverse) r, true)?", "url": "https://github.com/IQSS/dataverse/pull/7105#discussion_r458980607", "createdAt": "2020-07-22T17:59:34Z", "author": {"login": "sekmiller"}, "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/CreateDataverseCommand.java", "diffHunk": "@@ -168,17 +169,8 @@ public Dataverse execute(CommandContext ctxt) throws CommandException {\n     }\n     \n     @Override\n-    public boolean onSuccess(CommandContext ctxt, Object r) {\n-        try{\n-            ctxt.index().indexDataverse((Dataverse) r);\n-        } catch (IOException | SolrServerException e){           \n-            Dataverse dv = (Dataverse) r;            \n-            String failureLogText = \"Indexing failed. You can kickoff a re-index of this dataverse with: \\r\\n curl http://localhost:8080/api/admin/index/dataverses/\" + dv.getId().toString();\n-            failureLogText += \"\\r\\n\" + e.getLocalizedMessage();\n-            LoggingUtil.writeOnSuccessFailureLog(this, failureLogText,  dv);\n-            return false;\n-        }\n-        return true;\n+    public boolean onSuccess(CommandContext ctxt, Object r) {  \n+        return ctxt.dataverses().index((Dataverse) r);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68ccc23bf2d2e97ab181518c0f26a3199d8519cd"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNTk4Nzgw", "url": "https://github.com/IQSS/dataverse/pull/7105#pullrequestreview-453598780", "createdAt": "2020-07-22T18:57:46Z", "commit": {"oid": "68ccc23bf2d2e97ab181518c0f26a3199d8519cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODo1Nzo0NlrOG1wCKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODo1Nzo0NlrOG1wCKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxNDY5OQ==", "bodyText": "reindexing datasets may not actually be needed here. (based on the instances where it is called ManageTemplates, Guestbook, etc.)", "url": "https://github.com/IQSS/dataverse/pull/7105#discussion_r459014699", "createdAt": "2020-07-22T18:57:46Z", "author": {"login": "sekmiller"}, "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/UpdateDataverseCommand.java", "diffHunk": "@@ -90,20 +90,19 @@ public Dataverse execute(CommandContext ctxt) throws CommandException {\n         \n     @Override\n     public boolean onSuccess(CommandContext ctxt, Object r) {\n-        Dataverse result = (Dataverse) r;\n-\n-        List<Dataset> datasets = ctxt.datasets().findByOwnerId(result.getId());\n+        \n+        // first kick of async index of datasets\n+        // TODO: is this actually needed? Is there a better way to handle\n         try {\n-            Future<String> indResponse = ctxt.index().indexDataverse(result);\n+            Dataverse result = (Dataverse) r;\n+            List<Dataset> datasets = ctxt.datasets().findByOwnerId(result.getId());\n             ctxt.index().asyncIndexDatasetList(datasets, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68ccc23bf2d2e97ab181518c0f26a3199d8519cd"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MTM5NDkz", "url": "https://github.com/IQSS/dataverse/pull/7105#pullrequestreview-454139493", "createdAt": "2020-07-23T13:39:23Z", "commit": {"oid": "68ccc23bf2d2e97ab181518c0f26a3199d8519cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMzozOToyM1rOG2K9Ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMzozOToyM1rOG2K9Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ1NTgyNg==", "bodyText": "This will never be a dataset so we can simplify the code here", "url": "https://github.com/IQSS/dataverse/pull/7105#discussion_r459455826", "createdAt": "2020-07-23T13:39:23Z", "author": {"login": "sekmiller"}, "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/UpdatePermissionRootCommand.java", "diffHunk": "@@ -37,6 +37,13 @@ public Dataverse execute( final CommandContext ctxt) throws CommandException {\n \t\t}\n \t}\n \n+    @Override\n+    public boolean onSuccess(CommandContext ctxt, Object r) {  \n+        return ctxt.dataverses().index((Dataverse) r,true);\n+    }        \n+\n+\n+    //TODO: Review this as this will never be an instance of Dataset, will it?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68ccc23bf2d2e97ab181518c0f26a3199d8519cd"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MjE5MjQ2", "url": "https://github.com/IQSS/dataverse/pull/7105#pullrequestreview-454219246", "createdAt": "2020-07-23T14:54:55Z", "commit": {"oid": "68ccc23bf2d2e97ab181518c0f26a3199d8519cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNDo1NDo1NVrOG2OY5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNDo1NDo1NVrOG2OY5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUxMjAzOQ==", "bodyText": "Kind of a nit, but there are cases where this isn't being called by onSuccess so the failure message so maybe add to the general log in those cases.", "url": "https://github.com/IQSS/dataverse/pull/7105#discussion_r459512039", "createdAt": "2020-07-23T14:54:55Z", "author": {"login": "sekmiller"}, "path": "src/main/java/edu/harvard/iq/dataverse/DataverseServiceBean.java", "diffHunk": "@@ -91,21 +92,33 @@ public Dataverse save(Dataverse dataverse) {\n        \n         dataverse.setModificationTime(new Timestamp(new Date().getTime()));\n         Dataverse savedDataverse = em.merge(dataverse);\n+        return savedDataverse;\n+    }\n+    \n+    public boolean index(Dataverse dataverse) {\n+        return index(dataverse, false);\n+\n+    }\n+        \n+    public boolean index(Dataverse dataverse, boolean indexPermissions) {    \n         /**\n          * @todo check the result to see if indexing was successful or not\n          * added logging of exceptions \n          */\n         try {\n-            Future<String> indexingResult = indexService.indexDataverse(savedDataverse);\n+            indexService.indexDataverse(dataverse);\n+            if (indexPermissions) {\n+                solrIndexService.indexPermissionsOnSelfAndChildren(dataverse);\n+            }\n         } catch (IOException | SolrServerException e) {\n-            String failureLogText = \"Post-save indexing failed. You can kickoff a re-index of this dataverse with: \\r\\n curl http://localhost:8080/api/admin/index/dataverses/\" + savedDataverse.getId().toString();\n+            String failureLogText = \"Post-save indexing failed. You can kickoff a re-index of this dataverse with: \\r\\n curl http://localhost:8080/api/admin/index/dataverses/\" + dataverse.getId().toString();\n             failureLogText += \"\\r\\n\" + e.getLocalizedMessage();\n-            LoggingUtil.writeOnSuccessFailureLog(null, failureLogText, savedDataverse);\n+            LoggingUtil.writeOnSuccessFailureLog(null, failureLogText, dataverse);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68ccc23bf2d2e97ab181518c0f26a3199d8519cd"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NDEzMzYx", "url": "https://github.com/IQSS/dataverse/pull/7105#pullrequestreview-454413361", "createdAt": "2020-07-23T18:59:22Z", "commit": {"oid": "68ccc23bf2d2e97ab181518c0f26a3199d8519cd"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1OTM2ODAy", "url": "https://github.com/IQSS/dataverse/pull/7105#pullrequestreview-455936802", "createdAt": "2020-07-27T16:20:01Z", "commit": {"oid": "68ccc23bf2d2e97ab181518c0f26a3199d8519cd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 897, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}