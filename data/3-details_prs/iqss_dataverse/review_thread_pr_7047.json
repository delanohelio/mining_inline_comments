{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyOTU2NDg0", "number": 7047, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzoyNDoyOVrOEKsS6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzozMjoyOVrOEKsZpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjQ2OTUzOnYy", "diffSide": "RIGHT", "path": "src/main/webapp/dataset.xhtml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzoyNDoyOVrOGr4Ycg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNToyODo0M1rOGsSATw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NTcxNA==", "bodyText": "Links are missing the btn-download style class included in the placeholder, and required by the analytics code.", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r448665714", "createdAt": "2020-07-01T23:24:29Z", "author": {"login": "mheppler"}, "path": "src/main/webapp/dataset.xhtml", "diffHunk": "@@ -143,17 +139,29 @@\n                                                 </button>\n                                                 <ul class=\"dropdown-menu pull-right text-left\">\n                                                     \n-                                                    <ui:remove>\n                                                     <!-- DOWNLOAD -->\n-                                                    <!-- TO-DO #3513 DOWNLOAD ALL LINK -->\n                                                     <ui:fragment rendered=\"#{DatasetPage.canDownloadFiles()}\">\n                                                         <li class=\"dropdown-header\">#{bundle['dataset.accessBtn.header.download']} <span class=\"glyphicon glyphicon-download-alt\"/></li>\n-                                                        <li class=\"disabled\">\n-                                                            <span class=\"ui-commandlink ui-widget ui-state-disabled btn-download\">Download (Placeholder)</span>\n+                                                        <!-- NORMAL DOWNLOAD BUTTON (NO TABULAR FILES) -->\n+                                                        <li jsf:rendered=\"#{!DatasetPage.isHasTabular()}\">\n+                                                            <p:commandLink update=\"@form\" actionListener=\"#{DatasetPage.validateAllFilesForDownloadArchival()}\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA4NTUxOQ==", "bodyText": "Fixed in 054f249.", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r449085519", "createdAt": "2020-07-02T15:28:43Z", "author": {"login": "pdurbin"}, "path": "src/main/webapp/dataset.xhtml", "diffHunk": "@@ -143,17 +139,29 @@\n                                                 </button>\n                                                 <ul class=\"dropdown-menu pull-right text-left\">\n                                                     \n-                                                    <ui:remove>\n                                                     <!-- DOWNLOAD -->\n-                                                    <!-- TO-DO #3513 DOWNLOAD ALL LINK -->\n                                                     <ui:fragment rendered=\"#{DatasetPage.canDownloadFiles()}\">\n                                                         <li class=\"dropdown-header\">#{bundle['dataset.accessBtn.header.download']} <span class=\"glyphicon glyphicon-download-alt\"/></li>\n-                                                        <li class=\"disabled\">\n-                                                            <span class=\"ui-commandlink ui-widget ui-state-disabled btn-download\">Download (Placeholder)</span>\n+                                                        <!-- NORMAL DOWNLOAD BUTTON (NO TABULAR FILES) -->\n+                                                        <li jsf:rendered=\"#{!DatasetPage.isHasTabular()}\">\n+                                                            <p:commandLink update=\"@form\" actionListener=\"#{DatasetPage.validateAllFilesForDownloadArchival()}\">", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NTcxNA=="}, "originalCommit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjQ3MTY2OnYy", "diffSide": "RIGHT", "path": "src/main/webapp/dataset.xhtml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzoyNTozM1rOGr4Zpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNjoxNzo0OFrOGsUqBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NjAyMw==", "bodyText": "\"ZIP\" file type labels should be moved to the bundle.", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r448666023", "createdAt": "2020-07-01T23:25:33Z", "author": {"login": "mheppler"}, "path": "src/main/webapp/dataset.xhtml", "diffHunk": "@@ -143,17 +139,29 @@\n                                                 </button>\n                                                 <ul class=\"dropdown-menu pull-right text-left\">\n                                                     \n-                                                    <ui:remove>\n                                                     <!-- DOWNLOAD -->\n-                                                    <!-- TO-DO #3513 DOWNLOAD ALL LINK -->\n                                                     <ui:fragment rendered=\"#{DatasetPage.canDownloadFiles()}\">\n                                                         <li class=\"dropdown-header\">#{bundle['dataset.accessBtn.header.download']} <span class=\"glyphicon glyphicon-download-alt\"/></li>\n-                                                        <li class=\"disabled\">\n-                                                            <span class=\"ui-commandlink ui-widget ui-state-disabled btn-download\">Download (Placeholder)</span>\n+                                                        <!-- NORMAL DOWNLOAD BUTTON (NO TABULAR FILES) -->\n+                                                        <li jsf:rendered=\"#{!DatasetPage.isHasTabular()}\">\n+                                                            <p:commandLink update=\"@form\" actionListener=\"#{DatasetPage.validateAllFilesForDownloadArchival()}\">\n+                                                                #{bundle.download} (ZIP, #{DatasetPage.sizeOfDataset})\n+                                                            </p:commandLink>\n+                                                        </li>\n+                                                        <!-- DOWNLOAD ORIGINAL BUTTON (TABULAR FILES PRESENT) -->\n+                                                        <li jsf:rendered=\"#{DatasetPage.isHasTabular()}\">\n+                                                            <p:commandLink update=\"@form\" actionListener=\"#{DatasetPage.validateAllFilesForDownloadOriginal()}\">\n+                                                                #{bundle.downloadOriginal} (ZIP, #{DatasetPage.sizeOfDataset})\n+                                                            </p:commandLink>\n+                                                        </li>\n+                                                        <!-- DOWNLOAD ARCHIVAL FILES (TABULAR FILES PRESENT) -->\n+                                                        <li jsf:rendered=\"#{DatasetPage.isHasTabular()}\">\n+                                                            <p:commandLink update=\"@form\" actionListener=\"#{DatasetPage.validateAllFilesForDownloadArchival()}\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3MDE0Ng==", "bodyText": "There is already a application/zip=ZIP Archive entry in the MimeTypeDisplay.properties, not sure if it would be possible to pull from that file, or if we need a new entry in Bundle.properties.", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r448670146", "createdAt": "2020-07-01T23:39:16Z", "author": {"login": "mheppler"}, "path": "src/main/webapp/dataset.xhtml", "diffHunk": "@@ -143,17 +139,29 @@\n                                                 </button>\n                                                 <ul class=\"dropdown-menu pull-right text-left\">\n                                                     \n-                                                    <ui:remove>\n                                                     <!-- DOWNLOAD -->\n-                                                    <!-- TO-DO #3513 DOWNLOAD ALL LINK -->\n                                                     <ui:fragment rendered=\"#{DatasetPage.canDownloadFiles()}\">\n                                                         <li class=\"dropdown-header\">#{bundle['dataset.accessBtn.header.download']} <span class=\"glyphicon glyphicon-download-alt\"/></li>\n-                                                        <li class=\"disabled\">\n-                                                            <span class=\"ui-commandlink ui-widget ui-state-disabled btn-download\">Download (Placeholder)</span>\n+                                                        <!-- NORMAL DOWNLOAD BUTTON (NO TABULAR FILES) -->\n+                                                        <li jsf:rendered=\"#{!DatasetPage.isHasTabular()}\">\n+                                                            <p:commandLink update=\"@form\" actionListener=\"#{DatasetPage.validateAllFilesForDownloadArchival()}\">\n+                                                                #{bundle.download} (ZIP, #{DatasetPage.sizeOfDataset})\n+                                                            </p:commandLink>\n+                                                        </li>\n+                                                        <!-- DOWNLOAD ORIGINAL BUTTON (TABULAR FILES PRESENT) -->\n+                                                        <li jsf:rendered=\"#{DatasetPage.isHasTabular()}\">\n+                                                            <p:commandLink update=\"@form\" actionListener=\"#{DatasetPage.validateAllFilesForDownloadOriginal()}\">\n+                                                                #{bundle.downloadOriginal} (ZIP, #{DatasetPage.sizeOfDataset})\n+                                                            </p:commandLink>\n+                                                        </li>\n+                                                        <!-- DOWNLOAD ARCHIVAL FILES (TABULAR FILES PRESENT) -->\n+                                                        <li jsf:rendered=\"#{DatasetPage.isHasTabular()}\">\n+                                                            <p:commandLink update=\"@form\" actionListener=\"#{DatasetPage.validateAllFilesForDownloadArchival()}\">", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NjAyMw=="}, "originalCommit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTEyODk2NA==", "bodyText": "Fixed in 140ba41.", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r449128964", "createdAt": "2020-07-02T16:17:48Z", "author": {"login": "pdurbin"}, "path": "src/main/webapp/dataset.xhtml", "diffHunk": "@@ -143,17 +139,29 @@\n                                                 </button>\n                                                 <ul class=\"dropdown-menu pull-right text-left\">\n                                                     \n-                                                    <ui:remove>\n                                                     <!-- DOWNLOAD -->\n-                                                    <!-- TO-DO #3513 DOWNLOAD ALL LINK -->\n                                                     <ui:fragment rendered=\"#{DatasetPage.canDownloadFiles()}\">\n                                                         <li class=\"dropdown-header\">#{bundle['dataset.accessBtn.header.download']} <span class=\"glyphicon glyphicon-download-alt\"/></li>\n-                                                        <li class=\"disabled\">\n-                                                            <span class=\"ui-commandlink ui-widget ui-state-disabled btn-download\">Download (Placeholder)</span>\n+                                                        <!-- NORMAL DOWNLOAD BUTTON (NO TABULAR FILES) -->\n+                                                        <li jsf:rendered=\"#{!DatasetPage.isHasTabular()}\">\n+                                                            <p:commandLink update=\"@form\" actionListener=\"#{DatasetPage.validateAllFilesForDownloadArchival()}\">\n+                                                                #{bundle.download} (ZIP, #{DatasetPage.sizeOfDataset})\n+                                                            </p:commandLink>\n+                                                        </li>\n+                                                        <!-- DOWNLOAD ORIGINAL BUTTON (TABULAR FILES PRESENT) -->\n+                                                        <li jsf:rendered=\"#{DatasetPage.isHasTabular()}\">\n+                                                            <p:commandLink update=\"@form\" actionListener=\"#{DatasetPage.validateAllFilesForDownloadOriginal()}\">\n+                                                                #{bundle.downloadOriginal} (ZIP, #{DatasetPage.sizeOfDataset})\n+                                                            </p:commandLink>\n+                                                        </li>\n+                                                        <!-- DOWNLOAD ARCHIVAL FILES (TABULAR FILES PRESENT) -->\n+                                                        <li jsf:rendered=\"#{DatasetPage.isHasTabular()}\">\n+                                                            <p:commandLink update=\"@form\" actionListener=\"#{DatasetPage.validateAllFilesForDownloadArchival()}\">", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NjAyMw=="}, "originalCommit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjQ3OTkxOnYy", "diffSide": "RIGHT", "path": "src/main/java/edu/harvard/iq/dataverse/DatasetPage.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzoyOTo0OFrOGr4eZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxODozODozNVrOGuK9dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NzIzOA==", "bodyText": "I assume this selectAllFiles() is what's responsible for the odd UI behavior... when you select \"Download\" from the Access Dataset dropdown, you get the ZIP download, but now all the files are selected in the files table... that shouldn't be necessary... there has to be a way to get the ZIP without the unexpected UI behavior.", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r448667238", "createdAt": "2020-07-01T23:29:48Z", "author": {"login": "mheppler"}, "path": "src/main/java/edu/harvard/iq/dataverse/DatasetPage.java", "diffHunk": "@@ -2886,8 +2889,35 @@ public void setSelectedDownloadableFiles(List<FileMetadata> selectedDownloadable\n     public void setSelectedNonDownloadableFiles(List<FileMetadata> selectedNonDownloadableFiles) {\n         this.selectedNonDownloadableFiles = selectedNonDownloadableFiles;\n     }\n-    \n-            \n+\n+    public String getSizeOfDataset() {\n+        GetDatasetStorageSizeCommand cmd = new GetDatasetStorageSizeCommand(dvRequestService.getDataverseRequest(), dataset, false, GetDatasetStorageSizeCommand.Mode.DOWNLOAD, workingVersion);\n+        try {\n+            long bytes = commandEngine.submit(cmd);\n+            return FileSizeChecker.bytesToHumanReadable(bytes);\n+        } catch (CommandException ex) {\n+            return \"\";\n+        }\n+    }\n+\n+    public void validateAllFilesForDownloadArchival() {\n+        selectAllFiles();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE1NzMxMA==", "bodyText": "I tried adding clearSelection() to the end like this...\n     public void validateAllFilesForDownloadArchival() {\n         selectAllFiles();\n         boolean guestbookRequired = isDownloadPopupRequired();\n         boolean downloadOriginal = false;\n         validateFilesForDownload(guestbookRequired, downloadOriginal);\n+        clearSelection();\n     }\n\n... but now it thinks no files are selected:\n\nSo yes, I agree a fix would be nice but I'm not sure what that fix is.", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r449157310", "createdAt": "2020-07-02T17:09:02Z", "author": {"login": "pdurbin"}, "path": "src/main/java/edu/harvard/iq/dataverse/DatasetPage.java", "diffHunk": "@@ -2886,8 +2889,35 @@ public void setSelectedDownloadableFiles(List<FileMetadata> selectedDownloadable\n     public void setSelectedNonDownloadableFiles(List<FileMetadata> selectedNonDownloadableFiles) {\n         this.selectedNonDownloadableFiles = selectedNonDownloadableFiles;\n     }\n-    \n-            \n+\n+    public String getSizeOfDataset() {\n+        GetDatasetStorageSizeCommand cmd = new GetDatasetStorageSizeCommand(dvRequestService.getDataverseRequest(), dataset, false, GetDatasetStorageSizeCommand.Mode.DOWNLOAD, workingVersion);\n+        try {\n+            long bytes = commandEngine.submit(cmd);\n+            return FileSizeChecker.bytesToHumanReadable(bytes);\n+        } catch (CommandException ex) {\n+            return \"\";\n+        }\n+    }\n+\n+    public void validateAllFilesForDownloadArchival() {\n+        selectAllFiles();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NzIzOA=="}, "originalCommit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE2MzA1Ng==", "bodyText": "Wouldn't the fix be to use a different method than what the one that cares about selected files? i.e\nchange current method to get selected files and get a list, path that to new private method that takes core of current method but uses this new list.\nCreate a new method that generates a list and calls new that new private method.\nYou'd of course have to make sure all the checks for permissions are happening correctly, but I'd expect that to already be in the backend side (i.e. we already shouldn't be relying in the front end to only pass in the permissible values)", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r449163056", "createdAt": "2020-07-02T17:18:42Z", "author": {"login": "scolapasta"}, "path": "src/main/java/edu/harvard/iq/dataverse/DatasetPage.java", "diffHunk": "@@ -2886,8 +2889,35 @@ public void setSelectedDownloadableFiles(List<FileMetadata> selectedDownloadable\n     public void setSelectedNonDownloadableFiles(List<FileMetadata> selectedNonDownloadableFiles) {\n         this.selectedNonDownloadableFiles = selectedNonDownloadableFiles;\n     }\n-    \n-            \n+\n+    public String getSizeOfDataset() {\n+        GetDatasetStorageSizeCommand cmd = new GetDatasetStorageSizeCommand(dvRequestService.getDataverseRequest(), dataset, false, GetDatasetStorageSizeCommand.Mode.DOWNLOAD, workingVersion);\n+        try {\n+            long bytes = commandEngine.submit(cmd);\n+            return FileSizeChecker.bytesToHumanReadable(bytes);\n+        } catch (CommandException ex) {\n+            return \"\";\n+        }\n+    }\n+\n+    public void validateAllFilesForDownloadArchival() {\n+        selectAllFiles();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NzIzOA=="}, "originalCommit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA2NzI1NQ==", "bodyText": "@scolapasta @mheppler please see 427c883. This pull request is now much bigger but it no longer uses selectedFiles which is what the checkboxes are connected to.", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r451067255", "createdAt": "2020-07-07T18:38:35Z", "author": {"login": "pdurbin"}, "path": "src/main/java/edu/harvard/iq/dataverse/DatasetPage.java", "diffHunk": "@@ -2886,8 +2889,35 @@ public void setSelectedDownloadableFiles(List<FileMetadata> selectedDownloadable\n     public void setSelectedNonDownloadableFiles(List<FileMetadata> selectedNonDownloadableFiles) {\n         this.selectedNonDownloadableFiles = selectedNonDownloadableFiles;\n     }\n-    \n-            \n+\n+    public String getSizeOfDataset() {\n+        GetDatasetStorageSizeCommand cmd = new GetDatasetStorageSizeCommand(dvRequestService.getDataverseRequest(), dataset, false, GetDatasetStorageSizeCommand.Mode.DOWNLOAD, workingVersion);\n+        try {\n+            long bytes = commandEngine.submit(cmd);\n+            return FileSizeChecker.bytesToHumanReadable(bytes);\n+        } catch (CommandException ex) {\n+            return \"\";\n+        }\n+    }\n+\n+    public void validateAllFilesForDownloadArchival() {\n+        selectAllFiles();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NzIzOA=="}, "originalCommit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjQ4Njc5OnYy", "diffSide": "RIGHT", "path": "src/main/java/edu/harvard/iq/dataverse/DatasetPage.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzozMjoyOVrOGr4iJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMToxNjo1N1rOGuP62w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2ODE5Ng==", "bodyText": "Bug in the download size displayed. My locally tested datasets are saying the download will be \"300 B\", but the resulting ZIP is 11 KB, or 11,000 B.", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r448668196", "createdAt": "2020-07-01T23:32:29Z", "author": {"login": "mheppler"}, "path": "src/main/java/edu/harvard/iq/dataverse/DatasetPage.java", "diffHunk": "@@ -2886,8 +2889,35 @@ public void setSelectedDownloadableFiles(List<FileMetadata> selectedDownloadable\n     public void setSelectedNonDownloadableFiles(List<FileMetadata> selectedNonDownloadableFiles) {\n         this.selectedNonDownloadableFiles = selectedNonDownloadableFiles;\n     }\n-    \n-            \n+\n+    public String getSizeOfDataset() {\n+        GetDatasetStorageSizeCommand cmd = new GetDatasetStorageSizeCommand(dvRequestService.getDataverseRequest(), dataset, false, GetDatasetStorageSizeCommand.Mode.DOWNLOAD, workingVersion);\n+        try {\n+            long bytes = commandEngine.submit(cmd);\n+            return FileSizeChecker.bytesToHumanReadable(bytes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTEzNDk0NQ==", "bodyText": "Yes, this what I noted when saying \"riddle me this\" in the description of this pull request (with a screenshot), that there's a mismatch in size. GetDatasetStorageSizeCommand needs discussion in tech hours or #dv-tech (heads up @scolapasta ) or a smaller group. I haven't looked into the implementation but the thing I was wondering about is how we estimate the size of a zip. Text files compress really well. Video files don't. I doubt the number will ever be 100% accurate. But yes, it seems pretty far off right now.", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r449134945", "createdAt": "2020-07-02T16:28:04Z", "author": {"login": "pdurbin"}, "path": "src/main/java/edu/harvard/iq/dataverse/DatasetPage.java", "diffHunk": "@@ -2886,8 +2889,35 @@ public void setSelectedDownloadableFiles(List<FileMetadata> selectedDownloadable\n     public void setSelectedNonDownloadableFiles(List<FileMetadata> selectedNonDownloadableFiles) {\n         this.selectedNonDownloadableFiles = selectedNonDownloadableFiles;\n     }\n-    \n-            \n+\n+    public String getSizeOfDataset() {\n+        GetDatasetStorageSizeCommand cmd = new GetDatasetStorageSizeCommand(dvRequestService.getDataverseRequest(), dataset, false, GetDatasetStorageSizeCommand.Mode.DOWNLOAD, workingVersion);\n+        try {\n+            long bytes = commandEngine.submit(cmd);\n+            return FileSizeChecker.bytesToHumanReadable(bytes);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2ODE5Ng=="}, "originalCommit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE0Mzk4NQ==", "bodyText": "We can discuss next tech hours, sure. But isn't the inaccuracy in the wrong direction?\ni.e. the ip should be smaller than the size from GetDatasetStorageSizeCommand? I could imagine a scenario where it would be large (due to zip headers), but in that case, I would expect it to be close in size.\nBut maybe this is \"close\" in this scenario.", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r449143985", "createdAt": "2020-07-02T16:43:54Z", "author": {"login": "scolapasta"}, "path": "src/main/java/edu/harvard/iq/dataverse/DatasetPage.java", "diffHunk": "@@ -2886,8 +2889,35 @@ public void setSelectedDownloadableFiles(List<FileMetadata> selectedDownloadable\n     public void setSelectedNonDownloadableFiles(List<FileMetadata> selectedNonDownloadableFiles) {\n         this.selectedNonDownloadableFiles = selectedNonDownloadableFiles;\n     }\n-    \n-            \n+\n+    public String getSizeOfDataset() {\n+        GetDatasetStorageSizeCommand cmd = new GetDatasetStorageSizeCommand(dvRequestService.getDataverseRequest(), dataset, false, GetDatasetStorageSizeCommand.Mode.DOWNLOAD, workingVersion);\n+        try {\n+            long bytes = commandEngine.submit(cmd);\n+            return FileSizeChecker.bytesToHumanReadable(bytes);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2ODE5Ng=="}, "originalCommit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE0ODUwNw==", "bodyText": "As discussed in tech hours, the problem seems to stem from double counting tabular files (counting both the size of the original file and the archival version). I just pushed a fix in 1957776.", "url": "https://github.com/IQSS/dataverse/pull/7047#discussion_r451148507", "createdAt": "2020-07-07T21:16:57Z", "author": {"login": "pdurbin"}, "path": "src/main/java/edu/harvard/iq/dataverse/DatasetPage.java", "diffHunk": "@@ -2886,8 +2889,35 @@ public void setSelectedDownloadableFiles(List<FileMetadata> selectedDownloadable\n     public void setSelectedNonDownloadableFiles(List<FileMetadata> selectedNonDownloadableFiles) {\n         this.selectedNonDownloadableFiles = selectedNonDownloadableFiles;\n     }\n-    \n-            \n+\n+    public String getSizeOfDataset() {\n+        GetDatasetStorageSizeCommand cmd = new GetDatasetStorageSizeCommand(dvRequestService.getDataverseRequest(), dataset, false, GetDatasetStorageSizeCommand.Mode.DOWNLOAD, workingVersion);\n+        try {\n+            long bytes = commandEngine.submit(cmd);\n+            return FileSizeChecker.bytesToHumanReadable(bytes);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2ODE5Ng=="}, "originalCommit": {"oid": "3f4ac7f34c2be2948a4a7a0507d31e700adb064a"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3248, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}