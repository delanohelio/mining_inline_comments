{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NDk5NzU5", "number": 7313, "title": "Iqss/7309 s3 resource leaks", "bodyText": "What this PR does / why we need it:  Closes more streams/channels that may hold S3 http connections open and exhaust the aws s3 client's pool.\nWhich issue(s) this PR closes:\nCloses #7309\nSpecial notes for your reviewer:\nTried to use the new try-with-resources format where that looked simple and just used Apache's IOUtils.closeQuietly() for others (it just closes if the object isn't null and eats any exception). If I understand correctly, using try-with-resources will still throw any exception (unless you add a catch) so I think the only effect is to assure the streams/channels are closed.\nOne place where this PR isn't complete is in the tabulardata/impl/plugins classes. There are other classes there that do the same thing as DTAFileReaderSpi in creating a stream that doesn't look like it gets closed, and in having methods that have a stream param. In this latter case, I didn't find where these methods were getting called, so I didn't want to just close the streams in case that was already handled by the caller (or the stream is reused, etc.). So - some discussion about what could/should happen there would help.\nSuggestions on how to test this: If we can reliably exhaust the pool by setting a low value and using some of the functionality affected by this PR (e.g. thumbnails created for pdfs), then applying this PR should stop that problem.\nTesting should also cover making sure that things still work, e.g. that I haven't accidentally closed streams/channels before they're used.\nDoes this PR introduce a user interface change? If mockups are available, please link/include them here: No.\nIs there a release notes update needed for this change?:\nAdditional documentation:", "createdAt": "2020-10-07T20:30:21Z", "url": "https://github.com/IQSS/dataverse/pull/7313", "merged": true, "mergeCommit": {"oid": "6af5099fd3d18de960ae59321652f48c0c623abf"}, "closed": true, "closedAt": "2020-10-08T14:10:23Z", "author": {"login": "qqmyers"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQSugrgH2gAyNDk5NDk5NzU5OjAwZGM5Yjk3YjRhMGQyZGY1MDFiMzMwMGJjNzJmOTg5OTUyOGMxZjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQWTnxAFqTUwNDM1MjExNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "00dc9b97b4a0d2df501b3300bc72f9899528c1f1", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/00dc9b97b4a0d2df501b3300bc72f9899528c1f1", "committedDate": "2020-10-07T20:09:07Z", "message": "close any open streams/channels\n\nusing try-with-resources where it looks straight forward, or\nIOUtils.closeQuietly() where it isn't. (The latter is deprecated in\nfavor of using try-with-resources these days.)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec791bd79cd52076ae9f80942c62eba59a9f5918", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/ec791bd79cd52076ae9f80942c62eba59a9f5918", "committedDate": "2020-10-07T20:14:01Z", "message": "formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MjQ5NzI1", "url": "https://github.com/IQSS/dataverse/pull/7313#pullrequestreview-504249725", "createdAt": "2020-10-07T20:40:36Z", "commit": {"oid": "ec791bd79cd52076ae9f80942c62eba59a9f5918"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMDo0MDozNlrOHeEsjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMDo0MDozNlrOHeEsjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI5NjI3MA==", "bodyText": "guessing this method could/should close it but I didn't see where it was getting called.", "url": "https://github.com/IQSS/dataverse/pull/7313#discussion_r501296270", "createdAt": "2020-10-07T20:40:36Z", "author": {"login": "qqmyers"}, "path": "src/main/java/edu/harvard/iq/dataverse/ingest/tabulardata/impl/plugins/dta/DTAFileReaderSpi.java", "diffHunk": "@@ -131,6 +131,7 @@ public boolean canDecodeInput(Object source) throws IOException {\n \n     @Override\n     public boolean canDecodeInput(BufferedInputStream stream) throws IOException {\n+    \t//who closes this stream?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec791bd79cd52076ae9f80942c62eba59a9f5918"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MjYzNzky", "url": "https://github.com/IQSS/dataverse/pull/7313#pullrequestreview-504263792", "createdAt": "2020-10-07T21:01:03Z", "commit": {"oid": "ec791bd79cd52076ae9f80942c62eba59a9f5918"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMTowMTowM1rOHeFX3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMTowMTowM1rOHeFX3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwNzM1OQ==", "bodyText": "FWIW - this private method doesn't get used according to eclipse - do we need it?", "url": "https://github.com/IQSS/dataverse/pull/7313#discussion_r501307359", "createdAt": "2020-10-07T21:01:03Z", "author": {"login": "qqmyers"}, "path": "src/main/java/edu/harvard/iq/dataverse/ingest/IngestServiceBean.java", "diffHunk": "@@ -1056,12 +1061,11 @@ private BufferedInputStream openFile(DataFile dataFile) throws IOException {\n         if (storageIO.isLocalFile()) {\n             inputStream = new BufferedInputStream(storageIO.getInputStream());\n         } else {\n-            ReadableByteChannel dataFileChannel = storageIO.getReadChannel();\n-            File tempFile = File.createTempFile(\"tempIngestSourceFile\", \".tmp\");\n-            FileChannel tempIngestSourceChannel = new FileOutputStream(tempFile).getChannel();\n-            \n-            tempIngestSourceChannel.transferFrom(dataFileChannel, 0, storageIO.getSize());\n-            \n+        \tFile tempFile = File.createTempFile(\"tempIngestSourceFile\", \".tmp\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec791bd79cd52076ae9f80942c62eba59a9f5918"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MzUyMTE2", "url": "https://github.com/IQSS/dataverse/pull/7313#pullrequestreview-504352116", "createdAt": "2020-10-08T00:19:22Z", "commit": {"oid": "ec791bd79cd52076ae9f80942c62eba59a9f5918"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 784, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}