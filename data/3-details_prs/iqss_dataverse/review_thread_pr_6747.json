{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwNDcyMzU5", "number": 6747, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxOTowMjozMFrODp-8Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxOTowOTo1NFrODp_EGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MzQ5Mzc5OnYy", "diffSide": "RIGHT", "path": "doc/sphinx-guides/source/api/native-api.rst", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxOTowMjozMFrOF5f8Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNjoxMTo0OFrOF6Mz_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzNjQ2Nw==", "bodyText": "we should probably add downloading, and no reason (I think) to say \"may\".", "url": "https://github.com/IQSS/dataverse/pull/6747#discussion_r395836467", "createdAt": "2020-03-20T19:02:30Z", "author": {"login": "scolapasta"}, "path": "doc/sphinx-guides/source/api/native-api.rst", "diffHunk": "@@ -2806,6 +2806,21 @@ Make User a SuperUser\n Toggles superuser mode on the ``AuthenticatedUser`` whose ``identifier`` (without the ``@`` sign) is passed. ::\n \n     POST http://$SERVER/api/admin/superuser/$identifier\n+    \n+Delete a User\n+~~~~~~~~~~~~~\n+\n+Deletes an ``AuthenticatedUser`` whose ``identifier`` (without the ``@`` sign) is passed. ::\n+\n+    DELETE http://$SERVER/api/admin/authenticatedUsers/$identifier\n+    \n+Deletes an ``AuthenticatedUser`` whose ``id``  is passed. ::\n+\n+    DELETE http://$SERVER/api/admin/authenticatedUsers/id/$id\n+    \n+Note: If the user has performed certain actions such as creating or contributing to a Dataset they may not be deleted.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a385cc2ae46951be1123a788ae7d22c2f19d94e0"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3MTY0NA==", "bodyText": "Changes \"may\" to \"cannot\" and added \"downloaded a file\"", "url": "https://github.com/IQSS/dataverse/pull/6747#discussion_r396571644", "createdAt": "2020-03-23T16:11:48Z", "author": {"login": "sekmiller"}, "path": "doc/sphinx-guides/source/api/native-api.rst", "diffHunk": "@@ -2806,6 +2806,21 @@ Make User a SuperUser\n Toggles superuser mode on the ``AuthenticatedUser`` whose ``identifier`` (without the ``@`` sign) is passed. ::\n \n     POST http://$SERVER/api/admin/superuser/$identifier\n+    \n+Delete a User\n+~~~~~~~~~~~~~\n+\n+Deletes an ``AuthenticatedUser`` whose ``identifier`` (without the ``@`` sign) is passed. ::\n+\n+    DELETE http://$SERVER/api/admin/authenticatedUsers/$identifier\n+    \n+Deletes an ``AuthenticatedUser`` whose ``id``  is passed. ::\n+\n+    DELETE http://$SERVER/api/admin/authenticatedUsers/id/$id\n+    \n+Note: If the user has performed certain actions such as creating or contributing to a Dataset they may not be deleted.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzNjQ2Nw=="}, "originalCommit": {"oid": "a385cc2ae46951be1123a788ae7d22c2f19d94e0"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MzUxMDA1OnYy", "diffSide": "RIGHT", "path": "src/main/java/edu/harvard/iq/dataverse/authorization/AuthenticationServiceBean.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxOTowODoyM1rOF5gG2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNjoxNDozNVrOF6M8kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzOTE5Mw==", "bodyText": "Currently, once an access request is acted on, we delete, so I think it would be fair to just also delete these requests when you delete the user (instead of failing). My one question is that there has been talk of storing these for historical purposes. If/when we do, we may want to then either a) not allow delete of user or b) anonymize the requests. Or c) still delete them, of course, I just think we'll need to think of that case.\nBut that said, it makes sense to change that delete to be cascading now.", "url": "https://github.com/IQSS/dataverse/pull/6747#discussion_r395839193", "createdAt": "2020-03-20T19:08:23Z", "author": {"login": "scolapasta"}, "path": "src/main/java/edu/harvard/iq/dataverse/authorization/AuthenticationServiceBean.java", "diffHunk": "@@ -511,6 +533,69 @@ public AuthenticatedUser lookupUser( String apiToken ) {\n         return tkn.getAuthenticatedUser();\n     }\n     \n+    /*\n+    getDeleteUserErrorMessages( AuthenticatedUser au )\n+    method which checks for reasons that a user may not be deleted\n+    -has created dvObjects\n+    -has roles\n+    -has guestbook records\n+    -etc.\n+    An empty string is returned if the user is 'deletable'\n+    */\n+    \n+    public String getDeleteUserErrorMessages(AuthenticatedUser au) {\n+        String retVal = \"\";\n+        if (!dvObjSvc.findByAuthenticatedUserId(au).isEmpty()) {\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.dvobjects\");\n+        }\n+\n+        if (!roleAssigneeSvc.getAssignmentsFor(au.getIdentifier()).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.roleAssignments\");\n+        }\n+\n+        if (!gbRespSvc.findByAuthenticatedUserId(au).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.gbResps\");\n+        }\n+\n+        if (!datasetVersionService.getDatasetVersionUsersByAuthenticatedUser(au).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.versionUser\");\n+        }\n+\n+        if (!explicitGroupService.findGroups(au).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.groupMember\");\n+        }\n+\n+        if (userHasPendingAccessRequests(au)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a385cc2ae46951be1123a788ae7d22c2f19d94e0"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3Mzg0Mw==", "bodyText": "Deleting requests, explicit group memberships and world map tokens in a newly created method that is run if there are no other records that would prevent a deletion (created dataset, downloaded a file etc.)", "url": "https://github.com/IQSS/dataverse/pull/6747#discussion_r396573843", "createdAt": "2020-03-23T16:14:35Z", "author": {"login": "sekmiller"}, "path": "src/main/java/edu/harvard/iq/dataverse/authorization/AuthenticationServiceBean.java", "diffHunk": "@@ -511,6 +533,69 @@ public AuthenticatedUser lookupUser( String apiToken ) {\n         return tkn.getAuthenticatedUser();\n     }\n     \n+    /*\n+    getDeleteUserErrorMessages( AuthenticatedUser au )\n+    method which checks for reasons that a user may not be deleted\n+    -has created dvObjects\n+    -has roles\n+    -has guestbook records\n+    -etc.\n+    An empty string is returned if the user is 'deletable'\n+    */\n+    \n+    public String getDeleteUserErrorMessages(AuthenticatedUser au) {\n+        String retVal = \"\";\n+        if (!dvObjSvc.findByAuthenticatedUserId(au).isEmpty()) {\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.dvobjects\");\n+        }\n+\n+        if (!roleAssigneeSvc.getAssignmentsFor(au.getIdentifier()).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.roleAssignments\");\n+        }\n+\n+        if (!gbRespSvc.findByAuthenticatedUserId(au).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.gbResps\");\n+        }\n+\n+        if (!datasetVersionService.getDatasetVersionUsersByAuthenticatedUser(au).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.versionUser\");\n+        }\n+\n+        if (!explicitGroupService.findGroups(au).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.groupMember\");\n+        }\n+\n+        if (userHasPendingAccessRequests(au)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzOTE5Mw=="}, "originalCommit": {"oid": "a385cc2ae46951be1123a788ae7d22c2f19d94e0"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MzUxMTU3OnYy", "diffSide": "RIGHT", "path": "src/main/java/edu/harvard/iq/dataverse/authorization/AuthenticationServiceBean.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxOTowODo1NVrOF5gH3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNjoxNDo1NFrOF6M9lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzOTQ1Mg==", "bodyText": "For delete of user, I think it's be fine to also just remove them from groups at the time.", "url": "https://github.com/IQSS/dataverse/pull/6747#discussion_r395839452", "createdAt": "2020-03-20T19:08:55Z", "author": {"login": "scolapasta"}, "path": "src/main/java/edu/harvard/iq/dataverse/authorization/AuthenticationServiceBean.java", "diffHunk": "@@ -511,6 +533,69 @@ public AuthenticatedUser lookupUser( String apiToken ) {\n         return tkn.getAuthenticatedUser();\n     }\n     \n+    /*\n+    getDeleteUserErrorMessages( AuthenticatedUser au )\n+    method which checks for reasons that a user may not be deleted\n+    -has created dvObjects\n+    -has roles\n+    -has guestbook records\n+    -etc.\n+    An empty string is returned if the user is 'deletable'\n+    */\n+    \n+    public String getDeleteUserErrorMessages(AuthenticatedUser au) {\n+        String retVal = \"\";\n+        if (!dvObjSvc.findByAuthenticatedUserId(au).isEmpty()) {\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.dvobjects\");\n+        }\n+\n+        if (!roleAssigneeSvc.getAssignmentsFor(au.getIdentifier()).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.roleAssignments\");\n+        }\n+\n+        if (!gbRespSvc.findByAuthenticatedUserId(au).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.gbResps\");\n+        }\n+\n+        if (!datasetVersionService.getDatasetVersionUsersByAuthenticatedUser(au).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.versionUser\");\n+        }\n+\n+        if (!explicitGroupService.findGroups(au).isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a385cc2ae46951be1123a788ae7d22c2f19d94e0"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3NDEwMg==", "bodyText": "done", "url": "https://github.com/IQSS/dataverse/pull/6747#discussion_r396574102", "createdAt": "2020-03-23T16:14:54Z", "author": {"login": "sekmiller"}, "path": "src/main/java/edu/harvard/iq/dataverse/authorization/AuthenticationServiceBean.java", "diffHunk": "@@ -511,6 +533,69 @@ public AuthenticatedUser lookupUser( String apiToken ) {\n         return tkn.getAuthenticatedUser();\n     }\n     \n+    /*\n+    getDeleteUserErrorMessages( AuthenticatedUser au )\n+    method which checks for reasons that a user may not be deleted\n+    -has created dvObjects\n+    -has roles\n+    -has guestbook records\n+    -etc.\n+    An empty string is returned if the user is 'deletable'\n+    */\n+    \n+    public String getDeleteUserErrorMessages(AuthenticatedUser au) {\n+        String retVal = \"\";\n+        if (!dvObjSvc.findByAuthenticatedUserId(au).isEmpty()) {\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.dvobjects\");\n+        }\n+\n+        if (!roleAssigneeSvc.getAssignmentsFor(au.getIdentifier()).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.roleAssignments\");\n+        }\n+\n+        if (!gbRespSvc.findByAuthenticatedUserId(au).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.gbResps\");\n+        }\n+\n+        if (!datasetVersionService.getDatasetVersionUsersByAuthenticatedUser(au).isEmpty()) {\n+            if (!retVal.isEmpty()) {\n+                retVal += \"; \";\n+            }\n+            retVal += BundleUtil.getStringFromBundle(\"admin.api.deleteUser.failure.versionUser\");\n+        }\n+\n+        if (!explicitGroupService.findGroups(au).isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzOTQ1Mg=="}, "originalCommit": {"oid": "a385cc2ae46951be1123a788ae7d22c2f19d94e0"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MzUxNDUwOnYy", "diffSide": "RIGHT", "path": "src/main/java/edu/harvard/iq/dataverse/authorization/AuthenticationServiceBean.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxOTowOTo1NFrOF5gJqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNjoxNTowN1rOF6M-Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzOTkxNQ==", "bodyText": "it's probably simpler code to add them to a list, then do a join to concatenate them at the end.", "url": "https://github.com/IQSS/dataverse/pull/6747#discussion_r395839915", "createdAt": "2020-03-20T19:09:54Z", "author": {"login": "scolapasta"}, "path": "src/main/java/edu/harvard/iq/dataverse/authorization/AuthenticationServiceBean.java", "diffHunk": "@@ -511,6 +533,69 @@ public AuthenticatedUser lookupUser( String apiToken ) {\n         return tkn.getAuthenticatedUser();\n     }\n     \n+    /*\n+    getDeleteUserErrorMessages( AuthenticatedUser au )\n+    method which checks for reasons that a user may not be deleted\n+    -has created dvObjects\n+    -has roles\n+    -has guestbook records\n+    -etc.\n+    An empty string is returned if the user is 'deletable'\n+    */\n+    \n+    public String getDeleteUserErrorMessages(AuthenticatedUser au) {\n+        String retVal = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a385cc2ae46951be1123a788ae7d22c2f19d94e0"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3NDI2Mg==", "bodyText": "done", "url": "https://github.com/IQSS/dataverse/pull/6747#discussion_r396574262", "createdAt": "2020-03-23T16:15:07Z", "author": {"login": "sekmiller"}, "path": "src/main/java/edu/harvard/iq/dataverse/authorization/AuthenticationServiceBean.java", "diffHunk": "@@ -511,6 +533,69 @@ public AuthenticatedUser lookupUser( String apiToken ) {\n         return tkn.getAuthenticatedUser();\n     }\n     \n+    /*\n+    getDeleteUserErrorMessages( AuthenticatedUser au )\n+    method which checks for reasons that a user may not be deleted\n+    -has created dvObjects\n+    -has roles\n+    -has guestbook records\n+    -etc.\n+    An empty string is returned if the user is 'deletable'\n+    */\n+    \n+    public String getDeleteUserErrorMessages(AuthenticatedUser au) {\n+        String retVal = \"\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzOTkxNQ=="}, "originalCommit": {"oid": "a385cc2ae46951be1123a788ae7d22c2f19d94e0"}, "originalPosition": 67}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3320, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}