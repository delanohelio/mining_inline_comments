{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5Mzk4OTY1", "number": 7015, "title": "only iterate over current files in latest published version", "bodyText": "What this PR does / why we need it: Fixes the ability to re-publish without updating the version on datasets where files have been deleted in prior versions.\nWhich issue(s) this PR closes:\nCloses #7014\nSpecial notes for your reviewer: a flaw in my original logic\nSuggestions on how to test this: This class is used for the admin only 'Update Current Version' option under the publish menu that is available when there are metadata only changes. That option should work as before for all datasets. The fix is that, prior to this fix, if you have a dataset in, for example, v2 with fewer/different files than v1 had, when you make a metadata update (update the description) for v2 and try to 'Update Current Version' it would fail and after this PR it should work.\nDoes this PR introduce a user interface change? If mockups are available, please link/include them here: No\nIs there a release notes update needed for this change?: No\nAdditional documentation:", "createdAt": "2020-06-24T18:59:18Z", "url": "https://github.com/IQSS/dataverse/pull/7015", "merged": true, "mergeCommit": {"oid": "98bff8fbe63e31815704f3a8422b055f8431bfed"}, "closed": true, "closedAt": "2020-07-02T18:56:38Z", "author": {"login": "qqmyers"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuerOlAH2gAyNDM5Mzk4OTY1OjA0OGJiNWQxOTFjN2U1NWFhYzE0NzIwY2ZkNDUzZTk4ZmRlNGIyMjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvHHpwgFqTQzODQ5MDg1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "048bb5d191c7e55aac14720cfd453e98fde4b226", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/048bb5d191c7e55aac14720cfd453e98fde4b226", "committedDate": "2020-06-24T18:50:58Z", "message": "only iterate over current files in latest published version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NDIxODg0", "url": "https://github.com/IQSS/dataverse/pull/7015#pullrequestreview-438421884", "createdAt": "2020-06-26T16:11:19Z", "commit": {"oid": "048bb5d191c7e55aac14720cfd453e98fde4b226"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNjoxMToxOVrOGpmn6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNjoxNzowNVrOGpmzag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI3NzYwOA==", "bodyText": "English that users can see in the UI (including errors) should be moved to a bundle.", "url": "https://github.com/IQSS/dataverse/pull/7015#discussion_r446277608", "createdAt": "2020-06-26T16:11:19Z", "author": {"login": "pdurbin"}, "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/CuratePublishedDatasetVersionCommand.java", "diffHunk": "@@ -85,18 +85,26 @@ public Dataset execute(CommandContext ctxt) throws CommandException {\n         Dataset tempDataset = ctxt.em().merge(getDataset());\n \n         // Look for file metadata changes and update published metadata if needed\n-        for (DataFile dataFile : tempDataset.getFiles()) {\n-            List<FileMetadata> fmdList = dataFile.getFileMetadatas();\n+        List<FileMetadata> pubFmds = updateVersion.getFileMetadatas();\n+        int pubFileCount = pubFmds.size();\n+        int newFileCount = tempDataset.getEditVersion().getFileMetadatas().size();\n+        if (pubFileCount != newFileCount) {\n+            logger.severe(\"Draft version of dataset: \" + tempDataset.getId() + \" has: \" + newFileCount + \" while last published version has \" + pubFileCount);\n+            throw new IllegalCommandException(\"Different number of files in draft version\", this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "048bb5d191c7e55aac14720cfd453e98fde4b226"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4MDU1NA==", "bodyText": "English should go in the bundle. In addition, since we have the file id, maybe it would be worth exposing it to the user in the error message, if it will help them troubleshoot the problem.", "url": "https://github.com/IQSS/dataverse/pull/7015#discussion_r446280554", "createdAt": "2020-06-26T16:17:05Z", "author": {"login": "pdurbin"}, "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/CuratePublishedDatasetVersionCommand.java", "diffHunk": "@@ -85,18 +85,26 @@ public Dataset execute(CommandContext ctxt) throws CommandException {\n         Dataset tempDataset = ctxt.em().merge(getDataset());\n \n         // Look for file metadata changes and update published metadata if needed\n-        for (DataFile dataFile : tempDataset.getFiles()) {\n-            List<FileMetadata> fmdList = dataFile.getFileMetadatas();\n+        List<FileMetadata> pubFmds = updateVersion.getFileMetadatas();\n+        int pubFileCount = pubFmds.size();\n+        int newFileCount = tempDataset.getEditVersion().getFileMetadatas().size();\n+        if (pubFileCount != newFileCount) {\n+            logger.severe(\"Draft version of dataset: \" + tempDataset.getId() + \" has: \" + newFileCount + \" while last published version has \" + pubFileCount);\n+            throw new IllegalCommandException(\"Different number of files in draft version\", this);\n+        }\n+        for (FileMetadata publishedFmd : pubFmds) {\n+            DataFile dataFile = publishedFmd.getDataFile();\n             FileMetadata draftFmd = dataFile.getLatestFileMetadata();\n-            FileMetadata publishedFmd = null;\n-            for (FileMetadata fmd : fmdList) {\n-                if (fmd.getDatasetVersion().equals(updateVersion)) {\n-                    publishedFmd = fmd;\n-                    break;\n-                }\n-            }\n             boolean metadataUpdated = false;\n-            if (draftFmd != null && publishedFmd != null) {\n+            if (draftFmd == null || draftFmd.getDatasetVersion().equals(updateVersion)) {\n+                if (draftFmd == null) {\n+                    logger.severe(\"Unable to find latest FMD for file id: \" + dataFile.getId());\n+                } else {\n+                    logger.severe(\"No filemetadata for file id: \" + dataFile.getId() + \" in draft version\");\n+                }\n+                throw new IllegalCommandException(\"Cannot change files in the dataset\", this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "048bb5d191c7e55aac14720cfd453e98fde4b226"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4a3911255e0a5c8084adac014af16546baffd06", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/a4a3911255e0a5c8084adac014af16546baffd06", "committedDate": "2020-06-26T16:49:05Z", "message": "updates per review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NDkwODUx", "url": "https://github.com/IQSS/dataverse/pull/7015#pullrequestreview-438490851", "createdAt": "2020-06-26T17:58:13Z", "commit": {"oid": "a4a3911255e0a5c8084adac014af16546baffd06"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 864, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}