{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3MDYyNDUz", "number": 6785, "title": "MDC scripts", "bodyText": "What this PR does / why we need it: convenience scripts for running MDC processing\nWhich issue(s) this PR closes:\nCloses #6784\nSpecial notes for your reviewer:\nSuggestions on how to test this: nominally these scripts automate the processing already described in the MDC sections of the guide, so testing should just confirm that\nDoes this PR introduce a user interface change?: no\nIs there a release notes update needed for this change?: could be worth mentioning, but running them is optional/requires no config changes unless/until some (other?) PR(s) install them by default.\nAdditional documentation: added notes about example scripts in the MDC docs and linked to the files", "createdAt": "2020-04-01T15:18:41Z", "url": "https://github.com/IQSS/dataverse/pull/6785", "merged": true, "mergeCommit": {"oid": "b592e48542e474dbad5521bd95e164e36a2b04d9"}, "closed": true, "closedAt": "2020-10-20T21:23:37Z", "author": {"login": "qqmyers"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTZNj-gH2gAyMzk3MDYyNDUzOmJiYjI3MjJkNzk5ZThhNDM4NjY5NWYzNjZkNzM3MDY0ZThjM2MwYmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSMzSQgFqTUwNzcxNTU2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bbb2722d799e8a4386695f366d737064e8c3c0bc", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/bbb2722d799e8a4386695f366d737064e8c3c0bc", "committedDate": "2020-04-01T15:13:05Z", "message": "MDC scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e582e45b1ec280110b33859e62779bfbdc27bee0", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/e582e45b1ec280110b33859e62779bfbdc27bee0", "committedDate": "2020-04-01T21:53:42Z", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6784"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c78a0e3dc8d5caeb2f8c2d246d1f31bb975a769", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/3c78a0e3dc8d5caeb2f8c2d246d1f31bb975a769", "committedDate": "2020-05-08T20:00:41Z", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6784"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1d37b3e334e59644c7c35ddceff84c48fd5d69d", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/c1d37b3e334e59644c7c35ddceff84c48fd5d69d", "committedDate": "2020-05-08T20:13:26Z", "message": "script updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "197095364e54ca8f9adc88818fb95a993e1c7816", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/197095364e54ca8f9adc88818fb95a993e1c7816", "committedDate": "2020-05-08T21:51:36Z", "message": "also report # of citation counts found"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0772e2967aa4a2ab34a5833eb2b4fe1bbea9777", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/f0772e2967aa4a2ab34a5833eb2b4fe1bbea9777", "committedDate": "2020-05-08T22:10:44Z", "message": "fix cut/pasted names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f35f8d7a4659ea8753bc8ec47159a990fdb05a1c", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/f35f8d7a4659ea8753bc8ec47159a990fdb05a1c", "committedDate": "2020-05-08T22:10:52Z", "message": "add todo note"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f0fbd9560b77176423f8ec43c6c58f20a554647", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/2f0fbd9560b77176423f8ec43c6c58f20a554647", "committedDate": "2020-06-04T21:52:46Z", "message": "Updates to script location, made paths configurable, added documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbdb3329ebc4be912502041d02ae6e192570a4b0", "author": {"user": {"login": "djbrooke", "name": "Danny Brooke"}}, "url": "https://github.com/IQSS/dataverse/commit/dbdb3329ebc4be912502041d02ae6e192570a4b0", "committedDate": "2020-06-05T01:11:27Z", "message": "adding release note"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NDQ3NDQ1", "url": "https://github.com/IQSS/dataverse/pull/6785#pullrequestreview-425447445", "createdAt": "2020-06-05T16:25:22Z", "commit": {"oid": "dbdb3329ebc4be912502041d02ae6e192570a4b0"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNjoyNToyMlrOGf1Jyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxODoxNDo1OFrOGf4qZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAyOTg5OQ==", "bodyText": "Are we standardizing on having \"mdc\" in the path? If so, should we change the example for :MDCLogPath in the docs? This: http://guides.dataverse.org/en/4.20/installation/config.html#mdclogpath . And explain in the docs that this \"mdc\" directory should be created?", "url": "https://github.com/IQSS/dataverse/pull/6785#discussion_r436029899", "createdAt": "2020-06-05T16:25:22Z", "author": {"login": "pdurbin"}, "path": "doc/sphinx-guides/source/_static/admin/counter-processor-config.yaml", "diffHunk": "@@ -2,7 +2,7 @@\n # 4-digit year and 2-digit month and day\n # /usr/local/payara5/glassfish/domains/domain1/logs/counter_2019-01-11.log\n #log_name_pattern: sample_logs/counter_(yyyy-mm-dd).log\n-log_name_pattern: /usr/local/payara5/glassfish/domains/domain1/logs/counter_(yyyy-mm-dd).log\n+log_name_pattern: /usr/local/payara5/glassfish/domains/domain1/logs/mdc/counter_(yyyy-mm-dd).log", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbdb3329ebc4be912502041d02ae6e192570a4b0"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAzMjEwNg==", "bodyText": "dataverse-ansible installs Counter Processor in /usr/local: https://github.com/IQSS/dataverse-ansible/blob/61381428ef0c30d321c8dd7ca4d9f21b9f46e733/tasks/dataverse-counter.yml#L40\nShould we consider using the same path. Pinging @donsizemore", "url": "https://github.com/IQSS/dataverse/pull/6785#discussion_r436032106", "createdAt": "2020-06-05T16:29:45Z", "author": {"login": "pdurbin"}, "path": "doc/sphinx-guides/source/_static/util/counter_daily.sh", "diffHunk": "@@ -0,0 +1,36 @@\n+#! /bin/bash\n+\n+COUNTER_PROCESSOR_DIRECTORY=\"/opt/counter-processor-0.0.1\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbdb3329ebc4be912502041d02ae6e192570a4b0"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAzMzQ2MA==", "bodyText": "It feels a little insecure to me to put this data in /tmp.", "url": "https://github.com/IQSS/dataverse/pull/6785#discussion_r436033460", "createdAt": "2020-06-05T16:32:19Z", "author": {"login": "pdurbin"}, "path": "doc/sphinx-guides/source/_static/util/counter_daily.sh", "diffHunk": "@@ -0,0 +1,36 @@\n+#! /bin/bash\n+\n+COUNTER_PROCESSOR_DIRECTORY=\"/opt/counter-processor-0.0.1\"\n+MDC_LOG_DIRECTORY=\"/usr/local/payara5/glassfish/domains/domain1/logs/mdc\"\n+\n+# counter_daily.sh\n+\n+cd $COUNTER_PROCESSOR_DIRECTORY\n+\n+echo >>/tmp/counter_daily.log\n+date >>/tmp/counter_daily.log\n+echo >>/tmp/counter_daily.log\n+\n+# \"You should run Counter Processor once a day to create reports in SUSHI (JSON) format that are saved to disk for Dataverse to process and that are sent to the DataCite hub.\"\n+\n+LAST=$(date -d \"yesterday 13:00\" '+%Y-%m-%d')\n+# echo $LAST\n+YEAR_MONTH=$(date -d \"yesterday 13:00\" '+%Y-%m')\n+# echo $YEAR_MONTH\n+d=$(date -I -d \"$YEAR_MONTH-01\")\n+#echo $d\n+while [ \"$(date -d \"$d\" +%Y%m%d)\" -le \"$(date -d \"$LAST\" +%Y%m%d)\" ];\n+do\n+  if [ -f \"$MDC_LOG_DIRECTORY/counter_$d.log\" ]; then\n+#       echo \"Found counter_$d.log\"\n+  else\n+        touch \"$MDC_LOG_DIRECTORY/counter_$d.log\"\n+  fi\n+  d=$(date -I -d \"$d + 1 day\")\n+done\n+\n+#run counter-processor as counter user\n+\n+sudo -u counter YEAR_MONTH=$YEAR_MONTH python3 main.py >>/tmp/counter_daily.log\n+\n+curl -X POST \"http://localhost:8080/api/admin/makeDataCount/addUsageMetricsFromSushiReport?reportOnDisk=/tmp/make-data-count-report.json\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbdb3329ebc4be912502041d02ae6e192570a4b0"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA4NzM5OQ==", "bodyText": "I'm confused by this comment. When I look into at datasetExternalCitationsService.save(dm) I see logic in there about repopulating and a comment that says \"Replace existing if necessary\". Some variables in that method were renamed in this pull request so it seems to have been examined.\nThat said there's more below (hasPart, etc.) that I'm not entirely following. And this is just a comment, not a code change. \ud83d\ude04\nIf there's a bug, it might be better to not add this comment and simply create an issue to handle it separately.", "url": "https://github.com/IQSS/dataverse/pull/6785#discussion_r436087399", "createdAt": "2020-06-05T18:14:58Z", "author": {"login": "pdurbin"}, "path": "src/main/java/edu/harvard/iq/dataverse/api/MakeDataCountApi.java", "diffHunk": "@@ -170,7 +170,13 @@ public Response updateCitationsForDataset(@PathParam(\"id\") String id) throws Mal\n             } while (nextPage == true);\n             JsonArray allData = dataBuilder.build();\n             List<DatasetExternalCitations> datasetExternalCitations = datasetExternalCitationsService.parseCitations(allData);\n-\n+            /*\n+             * ToDo: If this is the only source of citations, we should remove all the existing ones for the dataset and repopuate them.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbdb3329ebc4be912502041d02ae6e192570a4b0"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81457d555dd75deb698b723e8ccb5b1a931c23a5", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/81457d555dd75deb698b723e8ccb5b1a931c23a5", "committedDate": "2020-06-05T18:40:46Z", "message": "Change default CP dir per comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d459aab17462224e453cc543b3dea244a69deb7", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/1d459aab17462224e453cc543b3dea244a69deb7", "committedDate": "2020-08-10T18:42:06Z", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6784"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcfb64234c257e6fd07f144d676163f8c90161e7", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/bcfb64234c257e6fd07f144d676163f8c90161e7", "committedDate": "2020-09-15T16:10:45Z", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6784"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90002279c039ab8aa4cae967b4550ded459e4341", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/90002279c039ab8aa4cae967b4550ded459e4341", "committedDate": "2020-10-06T15:26:30Z", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6784"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b12c8317e2ad5825a854a29f37690f8615deb22", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/7b12c8317e2ad5825a854a29f37690f8615deb22", "committedDate": "2020-10-08T18:39:33Z", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6784"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NzE1NTY2", "url": "https://github.com/IQSS/dataverse/pull/6785#pullrequestreview-507715566", "createdAt": "2020-10-13T18:22:45Z", "commit": {"oid": "7b12c8317e2ad5825a854a29f37690f8615deb22"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 954, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}