{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMzE5OTQz", "number": 6974, "title": "6936 Implement email domain based groups", "bodyText": "What this PR does / why we need it:\nNext to explicit groups, IP groups and Shibboleth groups, there is another valuable source of information to which association a user belongs to: a verified email.\nBased on the domain part of the email, it's very easy to create groups based on affiliations. This might be handy for installations like the one from Leuven, where different universities share one instance (multi-tenancy). Our use case @ FZJ is to be able to open up for collaboration while automatically granting some rights to staff.\nAs this is independent from Shibboleth, this might be good for other instances like WZB (ping @RightInTwo), that create users via API.\nWhich issue(s) this PR closes:\nCloses #6936\nSpecial notes for your reviewer:\nThis is not only introducing a new group provider, but also refactors some other places in the codebase. Some noteable places:\n\nAdd a simpler verification check function for email addresses and make use of it. It's much easier to understand now and easier to extend (looking at #6694).\nExtend the usage of ExceptionMappers in REST API endpoints. There are a lot of places with lots of boilerplate and catch all like try-catch code. This makes the code more verbose and violates DRY principle. Obviously I didn't touch too much of other code to keep the scope of this PR as small as possible. (But didn't want to encourage the use of catch-alls any further...)\n\nSuggestions on how to test this:\n\nDeploy, but don't yet publish the root dataverse.\nCreate a new mail domain group\nAdd the group as member or similar to the root dataverse\nCreate a user with a group-matching mail address\nVerify user email\nGet access to the root dataverse\nDelete the permission\nVerify permission is gone\n\nDoes this PR introduce a user interface change? If mockups are available, please link/include them here:\nNope.\nIs there a release notes update needed for this change?:\nIt should be mentioned this is a new option to create groups of people.\nAdditional documentation:\nNada.", "createdAt": "2020-06-10T09:15:35Z", "url": "https://github.com/IQSS/dataverse/pull/6974", "merged": true, "mergeCommit": {"oid": "c79ce40e7cba46072b0e044598e6aab27bb01f3f"}, "closed": true, "closedAt": "2020-07-01T16:48:35Z", "author": {"login": "poikilotherm"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcp1njggH2gAyNDMyMzE5OTQzOjk2NzNlODIwYmEzMDBmM2I1ZWU4ODc2MGYwYTEzOTM0ZGZiOTA2Mjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcr3JD1AFqTQzMTY0MDUyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9673e820ba300f3b5ee88760f0a13934dfb90627", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/9673e820ba300f3b5ee88760f0a13934dfb90627", "committedDate": "2020-06-10T08:45:09Z", "message": "Refactor ConfirmEmailService to offer verification checking and start to use in some places. #6936"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45cb9a7cacd12fd47a15e937fb4731eb992e0962", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/45cb9a7cacd12fd47a15e937fb4731eb992e0962", "committedDate": "2020-06-10T08:45:09Z", "message": "Add a very basic first implementation of the mail domain group infrastructure. Still lacking tests, API endpoints etc. #6936"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a6b6807da458f15e3cb20dde91f919d93789faa", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/1a6b6807da458f15e3cb20dde91f919d93789faa", "committedDate": "2020-06-10T08:45:09Z", "message": "Make domain comparison use lowercase. Add some more JavaDocs. #6936"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d7379c05db3a1f8f7d1240de5bc0ccc8ad73a95", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/0d7379c05db3a1f8f7d1240de5bc0ccc8ad73a95", "committedDate": "2020-06-10T08:45:09Z", "message": "Add tests for MailDomainGroup and MailDomainGroupProvider. #6936"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39075d93b943d7dadf6ddc62f85cb620530c4550", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/39075d93b943d7dadf6ddc62f85cb620530c4550", "committedDate": "2020-06-10T08:45:09Z", "message": "Add generator for MailDomainGroups during testing. #6936"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa2a5446767ecf19be2bfae08e37f6470c3700c1", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/fa2a5446767ecf19be2bfae08e37f6470c3700c1", "committedDate": "2020-06-10T08:45:09Z", "message": "Make MailDomainGroupServiceBean more testable by making the mail bisection function static. #6936"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b5e0e1b05fd3b395d01a48e8e0119435bce61ea", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/1b5e0e1b05fd3b395d01a48e8e0119435bce61ea", "committedDate": "2020-06-10T08:45:09Z", "message": "Add test for MailDomainGroupServiceBean and fix error when filtering matching entries. #6936"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69a485fb105ecc6d6fefe8fe9e66e11c0008c05c", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/69a485fb105ecc6d6fefe8fe9e66e11c0008c05c", "committedDate": "2020-06-10T08:45:09Z", "message": "Wire the new mail domain group in the GroupServiceBean, so it will be included in group searches. #6936"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d2b9cb202159aba66e3bf4ae6e16d718e7184fc", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/8d2b9cb202159aba66e3bf4ae6e16d718e7184fc", "committedDate": "2020-06-10T08:45:09Z", "message": "Make MailDomainGroup and its test usable from other packages (for JSON parsing/printing). #6936"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8aaab6110125bac89abff420e1bc0bedeb2e35d0", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/8aaab6110125bac89abff420e1bc0bedeb2e35d0", "committedDate": "2020-06-10T08:46:26Z", "message": "Add JSON parser and printer for MailDomainGroup, to be used for REST API endpoints. #6936"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc0da65275a8b0acb908f175e07d0f42eaf6fb8c", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/dc0da65275a8b0acb908f175e07d0f42eaf6fb8c", "committedDate": "2020-06-10T08:46:28Z", "message": "Add persistence handling to create and update MailDomainGroups to the service and entity layer. #6936"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c72ed52e71dd62da378d7318e5c484ff73ff909", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/7c72ed52e71dd62da378d7318e5c484ff73ff909", "committedDate": "2020-06-10T08:46:28Z", "message": "Add first REST endpoints to get, create and update MailDomainGroups. Lacking deletion support. #6936"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "694ee50602010376de0a7a0fa7ed953ffd50be3c", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/694ee50602010376de0a7a0fa7ed953ffd50be3c", "committedDate": "2020-06-10T08:46:28Z", "message": "Extend exception handling at REST endpoints. Does now provide a catch-all for exceptions, support JsonParseExceptions and JPA ConstraintViolationExceptions. Relates to #3423 and #6936."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "389324bad3d78bce16cf9135eff2b9fa11677dc7", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/389324bad3d78bce16cf9135eff2b9fa11677dc7", "committedDate": "2020-06-10T08:46:28Z", "message": "Remove try-catch-boilerplate for mail domain group creation by using the extended exception handling. #6936"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09c7f64b0eab4f9d592868748ec9747d58aa962c", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/09c7f64b0eab4f9d592868748ec9747d58aa962c", "committedDate": "2020-06-10T08:46:28Z", "message": "Make JsonParser fail on empty (maybe filtered invalid) domains array of MailDomainGroup. #6936"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd0f68586c649966837e3199ad12c3624b431d5a", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/bd0f68586c649966837e3199ad12c3624b431d5a", "committedDate": "2020-06-10T08:46:28Z", "message": "Add deletion endpoint for MailDomainGroup and make consistent use of group alias as the identifier everywhere. #6936"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b6578888e9157563260b3fb674489806187e346", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/6b6578888e9157563260b3fb674489806187e346", "committedDate": "2020-06-15T14:01:06Z", "message": "Add db migration for MailDomainGroups as PersistedGlobalGroup uses SINGLE_TABLE inheritance strategy. #6936"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76ae9278b3e9e3b860c2a1af97f449a764252dc5", "author": {"user": {"login": "poikilotherm", "name": "Oliver Bertuch"}}, "url": "https://github.com/IQSS/dataverse/commit/76ae9278b3e9e3b860c2a1af97f449a764252dc5", "committedDate": "2020-06-15T16:16:34Z", "message": "Add docs for mail domain groups only, without refactoring to a groups page. #6936"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwODUyNjM2", "url": "https://github.com/IQSS/dataverse/pull/6974#pullrequestreview-430852636", "createdAt": "2020-06-15T17:32:13Z", "commit": {"oid": "76ae9278b3e9e3b860c2a1af97f449a764252dc5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzozMjoxM1rOGj781g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzozMjoxM1rOGj781g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMzNTU3NA==", "bodyText": "Somebody else here has pointed out that there is a connection with issue #3438; in a sense that, if we rely on users having verified emails for the purposes of group membership, not being able to verify it becomes more of an issue.\nSince you have been using these email groups in production, have you done anything to address #3438? (one possible solutions appear to be to just always show this button below - ?)", "url": "https://github.com/IQSS/dataverse/pull/6974#discussion_r440335574", "createdAt": "2020-06-15T17:32:13Z", "author": {"login": "landreev"}, "path": "src/main/java/edu/harvard/iq/dataverse/authorization/providers/builtin/DataverseUserPage.java", "diffHunk": "@@ -546,6 +546,7 @@ public void sendConfirmEmail() {\n     \n     /**\n      * Determines whether the button to send a verification email appears on user page\n+     * TODO: cant this be refactored to use confirmEmailService.hasVerifiedEmail(currentUser) ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76ae9278b3e9e3b860c2a1af97f449a764252dc5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNjQwNTI4", "url": "https://github.com/IQSS/dataverse/pull/6974#pullrequestreview-431640528", "createdAt": "2020-06-16T15:39:30Z", "commit": {"oid": "76ae9278b3e9e3b860c2a1af97f449a764252dc5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 847, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}