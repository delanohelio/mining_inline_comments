{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwODcyMzY2", "number": 7410, "title": "don't always return OK from get PID API #7187", "bodyText": "What this PR does / why we need it:\nThe \"get PID\" API always returns OK (200) even if there's a problem.\nWhich issue(s) this PR closes:\nCloses #7187\nSpecial notes for your reviewer:\nThe test case is a hostname that isn't in DNS. I changed the JSON format for the error.\nBefore:\n{\n  \"status\": \"OK\",\n  \"data\": {\n    \"response\": \"junk.test.datacite.org\"\n  }\n}\n\nAfter:\n{\n  \"status\": \"ERROR\",\n  \"message\": \"Problem getting status code from https://junk.test.datacite.org. Is it in DNS? Is doi.dataciterestapiurlstring configured properly?\"\n}\n\n\nSuggestions on how to test this:\nChange doi.dataciterestapiurlstring to a hostname that isn't in DNS, then try the \"get PID\" endpoint.\nDoes this PR introduce a user interface change? If mockups are available, please link/include them here:\nNo.\nIs there a release notes update needed for this change?:\nNo.\nAdditional documentation:\nNone.", "createdAt": "2020-11-13T21:58:40Z", "url": "https://github.com/IQSS/dataverse/pull/7410", "merged": true, "mergeCommit": {"oid": "d1674188b2f2bb29b2a47fd401cacb39dca0b944"}, "closed": true, "closedAt": "2021-01-08T14:50:30Z", "author": {"login": "pdurbin"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcOX3NgH2gAyNTIwODcyMzY2OjExNjM3OWVkNWIwZTM2ZmVkZTk1NjYwZTk2MjgxODNjNTRkYzM0OWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtiVl3gFqTU2Mjg2NjkwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "116379ed5b0e36fede95660e9628183c54dc349c", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/116379ed5b0e36fede95660e9628183c54dc349c", "committedDate": "2020-11-13T21:51:51Z", "message": "don't always return OK from get PID API #7187"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTkzODcy", "url": "https://github.com/IQSS/dataverse/pull/7410#pullrequestreview-530593872", "createdAt": "2020-11-14T17:55:18Z", "commit": {"oid": "116379ed5b0e36fede95660e9628183c54dc349c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQxNzo1NToxOVrOHzMkAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQxNzo1NToxOVrOHzMkAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NTI1MQ==", "bodyText": "Since this is a config problem, BAD_REQUEST is probably not the right response.", "url": "https://github.com/IQSS/dataverse/pull/7410#discussion_r523445251", "createdAt": "2020-11-14T17:55:19Z", "author": {"login": "qqmyers"}, "path": "src/main/java/edu/harvard/iq/dataverse/api/Pids.java", "diffHunk": "@@ -48,8 +48,12 @@ public Response getPid(@QueryParam(\"persistentId\") String persistentId) {\n         String baseUrl = systemConfig.getDataCiteRestApiUrlString();\n         String username = System.getProperty(\"doi.username\");\n         String password = System.getProperty(\"doi.password\");\n-        JsonObjectBuilder result = PidUtil.queryDoi(persistentId, baseUrl, username, password);\n-        return ok(result);\n+        try {\n+            JsonObjectBuilder result = PidUtil.queryDoi(persistentId, baseUrl, username, password);\n+            return ok(result);\n+        } catch (Exception ex) {\n+            return error(Response.Status.BAD_REQUEST, ex.getLocalizedMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "116379ed5b0e36fede95660e9628183c54dc349c"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTk1Mjk4", "url": "https://github.com/IQSS/dataverse/pull/7410#pullrequestreview-530595298", "createdAt": "2020-11-14T18:20:06Z", "commit": {"oid": "116379ed5b0e36fede95660e9628183c54dc349c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQxODoyMDowN1rOHzMsqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQxODoyMDowN1rOHzMsqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NzQ2NA==", "bodyText": "This stops the specific error in the issue from resulting in an OK response, but the other exceptions in this class are still being caught and returned as OK. One option for handling these would be to just throw subclasses of WebApplicationException directly from this class (see, for example, the table on this page for the available exceptions. The edu.harvard.iq.dataverse.api.errorhandlers.WebApplicationExceptionHandler will handle them from there. Each type of error has a default message and any InternalServerErrorExceptions get additional logging.\nYou can also just let any Throwable be caught by the ThrowableHandler - which are returned as 500 errors.\nNeither of these let you pass the exception message on to the user though, so you'd still have to catch exceptions for that in Pids.java if you want to include that in the response (but you could still throw the WebApplicationExceptions to also be able to pass the error type/status code.)", "url": "https://github.com/IQSS/dataverse/pull/7410#discussion_r523447464", "createdAt": "2020-11-14T18:20:07Z", "author": {"login": "qqmyers"}, "path": "src/main/java/edu/harvard/iq/dataverse/pidproviders/PidUtil.java", "diffHunk": "@@ -45,7 +46,7 @@ public static JsonObjectBuilder queryDoi(String persistentId, String baseUrl, St\n             status = connection.getResponseCode();\n         } catch (IOException ex) {\n             // Hostname not in DNS, for example.\n-            return Json.createObjectBuilder().add(\"response\", ex.getLocalizedMessage());\n+            throw new RuntimeException(BundleUtil.getStringFromBundle(\"pids.datacite.errors.noResponseCode\", Arrays.asList(baseUrl)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "116379ed5b0e36fede95660e9628183c54dc349c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c55e2bd3700a05486d161871faa14b8a06722ad", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/7c55e2bd3700a05486d161871faa14b8a06722ad", "committedDate": "2020-11-16T16:41:29Z", "message": "return 500 error instead of 400 (BAD_REQUEST) #7187"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0190cad09a4c3a2ab4dcff2a0858569da2be1424", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/0190cad09a4c3a2ab4dcff2a0858569da2be1424", "committedDate": "2020-11-16T17:49:45Z", "message": "Catching/assigning status codes to other errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee4af2a346444b23e67dab878004c562faf7b249", "author": {"user": {"login": "qqmyers", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/ee4af2a346444b23e67dab878004c562faf7b249", "committedDate": "2020-11-16T20:49:03Z", "message": "change 404 msg to handle cases where the specific thing doesn't exist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00cf232c752b5c625a0f03dbe0b1f9fa4f94da2e", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/00cf232c752b5c625a0f03dbe0b1f9fa4f94da2e", "committedDate": "2021-01-05T20:21:01Z", "message": "Revert \"change 404 msg to handle cases where the specific thing doesn't exist\"\n\nThis reverts commit ee4af2a346444b23e67dab878004c562faf7b249.\n\nWe've had this message since the beginning and I'm not comfortable\nchanging it without more discussion with the group. It seems out of\nscope for the current effort for the PID API."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ef61d4521986d8d11e8ab851afba5106afb3001", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/2ef61d4521986d8d11e8ab851afba5106afb3001", "committedDate": "2021-01-05T20:23:45Z", "message": "Merge branch 'develop' into 7187-get-pids #7187"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c359cbe5ff69fed6197cd5b1098f85fe61f1e986", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/c359cbe5ff69fed6197cd5b1098f85fe61f1e986", "committedDate": "2021-01-05T20:56:20Z", "message": "expose more detail of 404 from DataCite via API #7187"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyODY2OTAy", "url": "https://github.com/IQSS/dataverse/pull/7410#pullrequestreview-562866902", "createdAt": "2021-01-06T16:44:11Z", "commit": {"oid": "c359cbe5ff69fed6197cd5b1098f85fe61f1e986"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 676, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}