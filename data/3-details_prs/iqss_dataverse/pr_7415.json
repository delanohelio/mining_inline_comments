{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxOTY2Mzk2", "number": 7415, "title": "prevent double linking of datasets and dataverses #7259", "bodyText": "What this PR does / why we need it:\nUsers have been able to link a dataset to the same dataverse twice (or more) via API. This prevents it.\nUpdate: in testing, it was found that it's also possible to link a dataverse to the same dataverse more than once. A fix has been added for this too.\nWhich issue(s) this PR closes:\nCloses #7259\nSpecial notes for your reviewer:\nI tacked a test on an existing test method but I'm happy to create a dedicated test method if that's preferred. Update: a new LinkIT test class was added.\nSuggestions on how to test this:\n\nTry to link the same dataset to the same dataverse via API multiple times.\nTry to link the same dataverse to the same dataverse via API multiple times.\n\nDoes this PR introduce a user interface change? If mockups are available, please link/include them here:\nNo.\nIs there a release notes update needed for this change?:\nProbably not worth it. Just a bug fix.\nAdditional documentation:\nNone.", "createdAt": "2020-11-16T21:23:39Z", "url": "https://github.com/IQSS/dataverse/pull/7415", "merged": true, "mergeCommit": {"oid": "f9402797612266a917672e943287ef4be8bf6e75"}, "closed": true, "closedAt": "2020-11-20T23:59:14Z", "author": {"login": "pdurbin"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddLt50AH2gAyNTIxOTY2Mzk2OmJlOTk5ZGJhMDNkMjE3NDEwYzJkNTgxYWM0ZmJlOGE4YzMzZTI2YTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeb9ATAFqTUzNTY5MjY5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "be999dba03d217410c2d581ac4fbe8a8c33e26a2", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/be999dba03d217410c2d581ac4fbe8a8c33e26a2", "committedDate": "2020-11-16T21:20:08Z", "message": "prevent double linking of datasets #7259"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNzk2MTM0", "url": "https://github.com/IQSS/dataverse/pull/7415#pullrequestreview-531796134", "createdAt": "2020-11-16T21:31:40Z", "commit": {"oid": "be999dba03d217410c2d581ac4fbe8a8c33e26a2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMTozMTo0MVrOH0TjQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMTozMjoxOVrOH0TmHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDYwODMyMw==", "bodyText": "will this be efficient enough, instead of adding a find method specific for an existing link?", "url": "https://github.com/IQSS/dataverse/pull/7415#discussion_r524608323", "createdAt": "2020-11-16T21:31:41Z", "author": {"login": "scolapasta"}, "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/LinkDatasetCommand.java", "diffHunk": "@@ -50,6 +52,13 @@ public DatasetLinkingDataverse execute(CommandContext ctxt) throws CommandExcept\n         if (linkedDataset.getOwner().getOwners().contains(linkingDataverse)) {\n             throw new IllegalCommandException(BundleUtil.getStringFromBundle(\"dataset.link.not.to.parent.dataverse\"), this);\n         }\n+        List<Dataverse> existingLinksToDataverses = new ArrayList<>();\n+        for (DatasetLinkingDataverse datasetLinkingDataverse : linkedDataset.getDatasetLinkingDataverses()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be999dba03d217410c2d581ac4fbe8a8c33e26a2"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDYwOTA1Mg==", "bodyText": "is this test in the move tests? I see what you mean then - it works, but I wonder if we won't lose track that it's being tested here.", "url": "https://github.com/IQSS/dataverse/pull/7415#discussion_r524609052", "createdAt": "2020-11-16T21:32:19Z", "author": {"login": "scolapasta"}, "path": "src/test/java/edu/harvard/iq/dataverse/api/MoveIT.java", "diffHunk": "@@ -254,6 +254,12 @@ public void testMoveLinkedDataset() {\n         linkDataset.then().assertThat()\n                 .statusCode(OK.getStatusCode());\n \n+        // A dataset cannot be linked to the same dataverse again.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be999dba03d217410c2d581ac4fbe8a8c33e26a2"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bccd4fbc1455ed79a703232a620c3a684611e09", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/6bccd4fbc1455ed79a703232a620c3a684611e09", "committedDate": "2020-11-19T19:22:52Z", "message": "move linking tests to dedicated class #7259"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d4a3dcc1fa200b16e8d55c1d1c181560d4bda95", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/5d4a3dcc1fa200b16e8d55c1d1c181560d4bda95", "committedDate": "2020-11-19T20:48:33Z", "message": "check if dataverse to dataverse links already exist #7259"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "109a3d3a1773ad87ff99aa0339f3656e02e70222", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/109a3d3a1773ad87ff99aa0339f3656e02e70222", "committedDate": "2020-11-19T21:00:09Z", "message": "switch to alreadyLinked method #7259"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "041d4a60a3b8acb0756a7297efd647fd0bb62dc3", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/041d4a60a3b8acb0756a7297efd647fd0bb62dc3", "committedDate": "2020-11-19T21:05:35Z", "message": "Merge branch 'develop' into 7259-linking #7259"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "403a96644f94340b5221bb582970e98e660c0f34", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/403a96644f94340b5221bb582970e98e660c0f34", "committedDate": "2020-11-20T17:38:46Z", "message": "add tests for linking levels of dataverses #7430 #7259"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NjkyNjky", "url": "https://github.com/IQSS/dataverse/pull/7415#pullrequestreview-535692692", "createdAt": "2020-11-20T18:49:02Z", "commit": {"oid": "403a96644f94340b5221bb582970e98e660c0f34"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 687, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}