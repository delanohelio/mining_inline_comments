{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MzgzNDE5", "number": 6774, "title": "2734 preserve orig filename", "bodyText": "What this PR does / why we need it:\nThis PR provides a method for storing the original file name for ingested tabular files. It also adds the original file name to the json printer for data files. For files that were uploaded previously the son printer will infer the original file name from the file metadata and a conversion of the extension based on the original file format field on the data table.\nWhich issue(s) this PR closes:\nCloses #2734\nSpecial notes for your reviewer:\nNone\nSuggestions on how to test this:\nVerify that ingested tabular files json export includes the original file name even if the file was ingested previously and thus does not have the original file name saved to the dataTable table.\nDoes this PR introduce a user interface change?:\nNo\nIs there a release notes update needed for this change?:\nNo\nAdditional documentation:\nThere is a sql script that adds the new field to the dataTable table.", "createdAt": "2020-03-26T19:45:48Z", "url": "https://github.com/IQSS/dataverse/pull/6774", "merged": true, "mergeCommit": {"oid": "d631b05b3755b9659d10d94947104e6fd42333bb"}, "closed": true, "closedAt": "2020-04-02T13:44:28Z", "author": {"login": "sekmiller"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQzRy8AH2gAyMzk0MzgzNDE5OjBlMzc2ZmViMTgyNDM4OTdjNjg5NGZlMzg1MGQyNDkyMWYyM2M2ZGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTexiNAH2gAyMzk0MzgzNDE5OjA4NTZkNDcyNTAyYjJhNTQwYzEzZWEwYjZiN2UyOTg1NzUxMDBlNDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0e376feb18243897c6894fe3850d24921f23c6df", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/0e376feb18243897c6894fe3850d24921f23c6df", "committedDate": "2020-03-24T13:53:28Z", "message": "Merge branch 'develop' into 2734-preserve-orig-filename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10dd0e34cbe446719fa7921609f958bb47b6c7f6", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/10dd0e34cbe446719fa7921609f958bb47b6c7f6", "committedDate": "2020-03-25T17:40:05Z", "message": "Merge branch 'develop' into 2734-preserve-orig-filename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b30dfaf1a4c2113204809894efc1e1e2a6b5c337", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/b30dfaf1a4c2113204809894efc1e1e2a6b5c337", "committedDate": "2020-03-25T20:18:48Z", "message": "#2734 add field to table and write to it on ingest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98d3844fecafaf18efb92b8f93e221fdf363a5b5", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/98d3844fecafaf18efb92b8f93e221fdf363a5b5", "committedDate": "2020-03-26T15:49:11Z", "message": "#2734 add originalFileName to json printer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ed9ed1b11664f91f8e3005069c36a1174d16e44", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/1ed9ed1b11664f91f8e3005069c36a1174d16e44", "committedDate": "2020-03-26T15:49:32Z", "message": "Merge branch 'develop' into 2734-preserve-orig-filename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07f208b5b2d22c34e2901a6b94c50b5134d7e7d1", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/07f208b5b2d22c34e2901a6b94c50b5134d7e7d1", "committedDate": "2020-03-26T18:34:21Z", "message": "#2734 add orig file name to json printer test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1ed82082bea9d10eedf917ed3ad941912a24073", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/f1ed82082bea9d10eedf917ed3ad941912a24073", "committedDate": "2020-03-26T19:47:53Z", "message": "#2734 remove unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNTU5OTA2", "url": "https://github.com/IQSS/dataverse/pull/6774#pullrequestreview-382559906", "createdAt": "2020-03-27T03:32:29Z", "commit": {"oid": "f1ed82082bea9d10eedf917ed3ad941912a24073"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMzozMjozMFrOF8iCDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMzozMjozMFrOF8iCDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxNjQ2Mw==", "bodyText": "@sekmiller Am I reading this correctly - that if the current filename has no extension (\"foo\"), this code will return \"foo\"? - shouldn't it still return \"foo.<ORIG_EXT>\"?\n(although this shouldn't really happen - since ingested files should always have the \".tab\" extension)\n(also, it looks like we never checked for this \"no extension\" case before. To be really OCD though, if you call .replace(\".tab\", \".dta\") on something exotic like \"datafile.tabular.tab\" will return \"datafile.dtaular.dta\". See my really old code in StoredOriginalFile.java - I use the regex version of replace there: .replaceAll(\".tab$\", \".dta\"), to make sure I'm only replacing the end part.", "url": "https://github.com/IQSS/dataverse/pull/6774#discussion_r399016463", "createdAt": "2020-03-27T03:32:30Z", "author": {"login": "landreev"}, "path": "src/main/java/edu/harvard/iq/dataverse/DataFile.java", "diffHunk": "@@ -398,6 +399,29 @@ public Long getOriginalFileSize() {\n         }\n         return null;\n     }\n+    \n+    public String getOriginalFileName() {\n+        if (isTabularData()) {\n+            DataTable dataTable = getDataTable();\n+            if (dataTable != null) {\n+                return dataTable.getOriginalFileName() != null ? dataTable.getOriginalFileName()\n+                        : getDerivedOriginalFileName();\n+            }\n+        }\n+        return null;\n+    }\n+\n+    private String getDerivedOriginalFileName() {\n+        FileMetadata fm = getFileMetadata();\n+        String filename = fm.getLabel();\n+        String originalExtension = FileUtil.generateOriginalExtension(getOriginalFileFormat());\n+        String extensionToRemove = StringUtil.substringIncludingLast(filename, \".\");\n+        if (StringUtil.nonEmpty(extensionToRemove)) {\n+            String newFileName = filename.replace(extensionToRemove, originalExtension);\n+            return newFileName;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1ed82082bea9d10eedf917ed3ad941912a24073"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNTYyODU2", "url": "https://github.com/IQSS/dataverse/pull/6774#pullrequestreview-382562856", "createdAt": "2020-03-27T03:44:26Z", "commit": {"oid": "f1ed82082bea9d10eedf917ed3ad941912a24073"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "715fd00c1caf9ce9e93e26f9a796e0db4de06574", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/715fd00c1caf9ce9e93e26f9a796e0db4de06574", "committedDate": "2020-03-27T15:03:21Z", "message": "#2734 streamline original file name replace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "786593eaebad17d1879b2512eecc4bc50e4b9aa4", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/786593eaebad17d1879b2512eecc4bc50e4b9aa4", "committedDate": "2020-03-27T15:17:18Z", "message": "#2734 update uningest with new method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c46851969a839f832589fefb90c3c9aaad2d5b22", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/c46851969a839f832589fefb90c3c9aaad2d5b22", "committedDate": "2020-03-27T15:24:20Z", "message": "#2734 update stored original file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75b21e3bee0ea302ad661600129917e3e8e51702", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/75b21e3bee0ea302ad661600129917e3e8e51702", "committedDate": "2020-03-27T18:01:45Z", "message": "#2734 return handling of one-off cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6a7c2aac3ae4f91717f6399b21406a31218fcd2", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/d6a7c2aac3ae4f91717f6399b21406a31218fcd2", "committedDate": "2020-03-27T20:50:35Z", "message": "small changes to simplify StoredOriginalFile\n\nsimplifies the logic, removes unused code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMTkxNjY1", "url": "https://github.com/IQSS/dataverse/pull/6774#pullrequestreview-383191665", "createdAt": "2020-03-27T20:51:23Z", "commit": {"oid": "d6a7c2aac3ae4f91717f6399b21406a31218fcd2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0856d472502b2a540c13ea0b6b7e298575100e43", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/0856d472502b2a540c13ea0b6b7e298575100e43", "committedDate": "2020-04-01T21:41:54Z", "message": "Merge branch 'develop' into 2734-preserve-orig-filename"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 947, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}