{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3ODg3ODA1", "number": 6790, "title": "6558 validate files on publish", "bodyText": "What this PR does / why we need it:\nSee the issue; and the release note: https://github.com/IQSS/dataverse/blob/6558-validate-files-on-publish/doc/release-notes/6558-validate-files-on-publish.md\nWhich issue(s) this PR closes:\nCloses #6558\nSpecial notes for your reviewer:\nSuggestions on how to test this:\nCreate a dataset, upload some files, mess up one of the files in the dataset directory or in the S3 bucket... try to publish.\nTry it with both the synchronous and asynchronous (\"too many files\") publishing modes.\nDoes this PR introduce a user interface change?:\nThere is a new UI error message notifying the user about the failure to publish, explaining to them that some of their files do not pass validation, and telling them that they must contact support in order to fix it, before they can make another attempt to publish.\nIt uses the standard \"red\" error banner system at the top of the page.\nIs there a release notes update needed for this change?:\nyes, above.\nAdditional documentation:", "createdAt": "2020-04-03T01:31:08Z", "url": "https://github.com/IQSS/dataverse/pull/6790", "merged": true, "mergeCommit": {"oid": "75f3b69453e6a28b75be370df9abac5bf77c3870"}, "closed": true, "closedAt": "2020-04-14T19:32:08Z", "author": {"login": "landreev"}, "timelineItems": {"totalCount": 33, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRwW9dgH2gAyMzk3ODg3ODA1OmYxZjUyODVhYzdhNTZkOGYyNzA1YTRiYTMxMWU4M2NjYjE2ZWJlMTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXlL1KgH2gAyMzk3ODg3ODA1OmEyMDc5ZDJlMzc5YjQ5OGRhMmJkNTU2N2YyOGQ4NTg0NGQyMzRmYWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f1f5285ac7a56d8f2705a4ba311e83ccb16ebe14", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/f1f5285ac7a56d8f2705a4ba311e83ccb16ebe14", "committedDate": "2020-03-27T13:03:19Z", "message": "the framework for the physical file validations (#655)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f149e121e42496f04cdc7d9190d6fe6e40d01ee6", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/f149e121e42496f04cdc7d9190d6fe6e40d01ee6", "committedDate": "2020-03-31T02:48:35Z", "message": "Physical file validation framework, refined; (#6558)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad0960c1dc7c8c24aee8622e86d2b0446bcff791", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/ad0960c1dc7c8c24aee8622e86d2b0446bcff791", "committedDate": "2020-03-31T02:53:36Z", "message": "one added TODO in the finalize command (#6558)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92806657d2d92357e3885df9b6afd5dc59b2922a", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/92806657d2d92357e3885df9b6afd5dc59b2922a", "committedDate": "2020-04-01T03:14:23Z", "message": "renamed DatasetLock.Reason.pidRegister DatasetLock.Reason.finalizePublication\n(#6558)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58ac83b8341414d8732c8a91003b45ec328b37ff", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/58ac83b8341414d8732c8a91003b45ec328b37ff", "committedDate": "2020-04-01T04:10:36Z", "message": "documentation for validate-files-on-publish. (#6558)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "790a5e548a3860b96a1578f3c9d761a75faf7d7f", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/790a5e548a3860b96a1578f3c9d761a75faf7d7f", "committedDate": "2020-04-02T12:54:04Z", "message": "More changes/refinements, dedicated \"validation failed\" lock, etc. (#6558)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdfb7672245fabf1e30d219a7b16be496fd88bab", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/fdfb7672245fabf1e30d219a7b16be496fd88bab", "committedDate": "2020-04-02T13:13:18Z", "message": "refresh the changed error/lock message after a file validation failure. (#6558)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3df9c534c37ef90060206ec738d81e49c72d7c3", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/a3df9c534c37ef90060206ec738d81e49c72d7c3", "committedDate": "2020-04-02T14:31:18Z", "message": "cleaned up lock refresh and messaging. (#6558)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d16bed59a6dd9e716495d15d912da748c602de40", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/d16bed59a6dd9e716495d15d912da748c602de40", "committedDate": "2020-04-02T18:02:31Z", "message": "Merge branch 'develop' into 6558-validate-files-on-publish"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dd277dc65449875495d3d7142f057ea49fe057f", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/7dd277dc65449875495d3d7142f057ea49fe057f", "committedDate": "2020-04-02T19:34:26Z", "message": "a flyway script for purging any locks of type pidRegister."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d21e9dffdf675582aed9a9bc492188506da5e26", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/3d21e9dffdf675582aed9a9bc492188506da5e26", "committedDate": "2020-04-02T19:48:49Z", "message": "another lock refresh tweak. (#6558)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "811ab0918570e6998e0f8f8de70b95c79a914bee", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/811ab0918570e6998e0f8f8de70b95c79a914bee", "committedDate": "2020-04-02T20:49:15Z", "message": "A release note for #6558."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a6411a16c82249a117695322905d743d3113bf6", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/2a6411a16c82249a117695322905d743d3113bf6", "committedDate": "2020-04-02T21:45:29Z", "message": "final (?) info messaging mechanism for the dataset page. (#6558)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc6e37fde1e10cfbf33bbddc1e3923f888f0ac6d", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/bc6e37fde1e10cfbf33bbddc1e3923f888f0ac6d", "committedDate": "2020-04-03T01:09:58Z", "message": "rewrote/rearranged the troubleshooting guide for invalid files. (#6558)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31f8df01438ea953dfaba4cf316b6e1806122859", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/31f8df01438ea953dfaba4cf316b6e1806122859", "committedDate": "2020-04-03T01:13:56Z", "message": "extra lock checking in the publish command. (#6558)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b102dafbd7e755326ff067c06462d5a9f3c82e2e", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/b102dafbd7e755326ff067c06462d5a9f3c82e2e", "committedDate": "2020-04-03T01:21:05Z", "message": "a typo/dropped word in the release notes. (#6558)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74badcbee4f92a7cd2930bbd750ce9a7e666d84e", "author": {"user": {"login": "djbrooke", "name": "Danny Brooke"}}, "url": "https://github.com/IQSS/dataverse/commit/74badcbee4f92a7cd2930bbd750ce9a7e666d84e", "committedDate": "2020-04-03T14:26:42Z", "message": "typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NDY3MjIy", "url": "https://github.com/IQSS/dataverse/pull/6790#pullrequestreview-388467222", "createdAt": "2020-04-06T17:29:40Z", "commit": {"oid": "74badcbee4f92a7cd2930bbd750ce9a7e666d84e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNzoyOTo0MFrOGBiZtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNzoyOTo0MFrOGBiZtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI2NTM5OA==", "bodyText": "Because we want the admin to intercede here we probably don't want to remove the lock, but should we update the  edit data button so that if there is a file validation failure the user cannot add files? We would still allow them to make other edits?", "url": "https://github.com/IQSS/dataverse/pull/6790#discussion_r404265398", "createdAt": "2020-04-06T17:29:40Z", "author": {"login": "sekmiller"}, "path": "src/main/java/edu/harvard/iq/dataverse/DatasetPage.java", "diffHunk": "@@ -2011,48 +2037,42 @@ private String init(boolean initFull) {\n                 lockedDueToDcmUpload = true;\n             }\n             //This is a hack to remove dataset locks for File PID registration if \n-                //the dataset is released\n-                //in testing we had cases where datasets with 1000 files were remaining locked after being published successfully\n-                /*if(dataset.getLatestVersion().isReleased() && dataset.isLockedFor(DatasetLock.Reason.pidRegister)){\n-                    datasetService.removeDatasetLocks(dataset.getId(), DatasetLock.Reason.pidRegister);\n-                }*/\n-            if (dataset.isLockedFor(DatasetLock.Reason.pidRegister)) {\n+            //the dataset is released\n+            //in testing we had cases where datasets with 1000 files were remaining locked after being published successfully\n+            /*if(dataset.getLatestVersion().isReleased() && dataset.isLockedFor(DatasetLock.Reason.finalizePublication)){\n+                datasetService.removeDatasetLocks(dataset.getId(), DatasetLock.Reason.finalizePublication);\n+            }*/\n+            if (dataset.isLockedFor(DatasetLock.Reason.finalizePublication)) {\n+                // \"finalizePublication\" lock is used to lock the dataset while \n+                // the FinalizeDatasetPublicationCommand is running asynchronously. \n+                // the tasks currently performed by the command are the  pid registration \n+                // for files and (or) physical file validation (either or both \n+                // of these two can be disabled via database settings). More \n+                // such asynchronous processing tasks may be added in the future. \n                 JH.addMessage(FacesMessage.SEVERITY_WARN, BundleUtil.getStringFromBundle(\"dataset.publish.workflow.message\"),\n                         BundleUtil.getStringFromBundle(\"dataset.pidRegister.workflow.inprogress\"));\n             }\n+            if (dataset.isLockedFor(DatasetLock.Reason.FileValidationFailed)) {\n+                // the dataset is locked, because one or more datafiles in it \n+                // failed validation during an attempt to publish it. \n+                if (FacesContext.getCurrentInstance().getExternalContext().getFlash().get(\"errorMsg\") == null) {\n+                    JH.addMessage(FacesMessage.SEVERITY_ERROR, BundleUtil.getStringFromBundle(\"dataset.publish.file.validation.error.message\"),\n+                            BundleUtil.getStringFromBundle(\"dataset.publish.file.validation.error.contactSupport\"));\n+                }\n+                /* and now that we've shown the message to the user - remove the lock? */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74badcbee4f92a7cd2930bbd750ce9a7e666d84e"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NTA1MDQw", "url": "https://github.com/IQSS/dataverse/pull/6790#pullrequestreview-388505040", "createdAt": "2020-04-06T18:20:58Z", "commit": {"oid": "74badcbee4f92a7cd2930bbd750ce9a7e666d84e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxODoyMDo1OFrOGBkSIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxODoyMDo1OFrOGBkSIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5NjIyNQ==", "bodyText": "I think it would be desirable to attempt to validate all of the files before throwing an exception. It would make the admins job easier if they knew more than one file failed validation.", "url": "https://github.com/IQSS/dataverse/pull/6790#discussion_r404296225", "createdAt": "2020-04-06T18:20:58Z", "author": {"login": "sekmiller"}, "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/FinalizeDatasetPublicationCommand.java", "diffHunk": "@@ -225,6 +240,98 @@ private void updateParentDataversesSubjectsField(Dataset savedDataset, CommandCo\n         }\n     }\n \n+    private void validateDataFiles(Dataset dataset, CommandContext ctxt) throws CommandException {\n+        try {\n+            for (DataFile dataFile : dataset.getFiles()) {\n+                // TODO: Should we validate all the files in the dataset, or only \n+                // the files that haven't been published previously?\n+                logger.log(Level.FINE, \"validating DataFile {0}\", dataFile.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74badcbee4f92a7cd2930bbd750ce9a7e666d84e"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d126a72a962582992ce83ef2c5b1b5c0f893b53a", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/d126a72a962582992ce83ef2c5b1b5c0f893b53a", "committedDate": "2020-04-07T02:38:25Z", "message": "Merge branch 'develop' into 6558-validate-files-on-publish"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45cfa0f1679afc5b2d79496e7b0f67b18a01beb2", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/45cfa0f1679afc5b2d79496e7b0f67b18a01beb2", "committedDate": "2020-04-07T02:39:00Z", "message": "Merge branch '6558-validate-files-on-publish' of https://github.com/IQSS/dataverse into 6558-validate-files-on-publish"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3fbad2688ea8c9eaaeda5d0c33625da5f1ef91d", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/c3fbad2688ea8c9eaaeda5d0c33625da5f1ef91d", "committedDate": "2020-04-07T04:01:58Z", "message": "Added /admin API call that an admin can use to find the files that have failed validation,\nthat need to be fixed or removed before the dataset can be published. (#6558)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ecb82c1a576d0fabcb349b0763443e9ac6fff1f", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/9ecb82c1a576d0fabcb349b0763443e9ac6fff1f", "committedDate": "2020-04-07T19:39:42Z", "message": "Extra documentation entries for the validate files across dataset admin API (#6558)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "608228b03425fe0605e0a0dab650f771c923110d", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/608228b03425fe0605e0a0dab650f771c923110d", "committedDate": "2020-04-07T21:55:51Z", "message": "Another documentation entry, the \"dataset management\" section of the user guide. (#6558)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5OTkwMjcz", "url": "https://github.com/IQSS/dataverse/pull/6790#pullrequestreview-389990273", "createdAt": "2020-04-08T13:47:06Z", "commit": {"oid": "608228b03425fe0605e0a0dab650f771c923110d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0340c843d5dced0291d4c2f5ea3c397ee06f6e1", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/c0340c843d5dced0291d4c2f5ea3c397ee06f6e1", "committedDate": "2020-04-09T20:02:25Z", "message": "removed the incorrect/confusing \"API\" reference\n\n... from the troubleshooting guide; also moved around the diag. API and the example sections."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93160c9719bd9e54768fa60013dfa488fc77266f", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/93160c9719bd9e54768fa60013dfa488fc77266f", "committedDate": "2020-04-09T20:03:56Z", "message": "cosmetic/style change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "840f389f50a6059d9e6c9dff0fcf0e6912e830f5", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/840f389f50a6059d9e6c9dff0fcf0e6912e830f5", "committedDate": "2020-04-09T20:15:48Z", "message": "\"strongly recommened\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "093ed6d6c908088e61f85bf29a90d787164bbd36", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/093ed6d6c908088e61f85bf29a90d787164bbd36", "committedDate": "2020-04-13T22:14:17Z", "message": "rearranged the order of operations inside FinalizeDatasetPublicationCommand. #6558"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b055cadd632a07e090a6f587a7efb79b91b0f558", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/b055cadd632a07e090a6f587a7efb79b91b0f558", "committedDate": "2020-04-14T02:25:12Z", "message": "one other rearrangment - changes where the dataset is merged, after it's modified during the first\nstage of the async publishing. #6558."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "402a6247e5e4d246cf2d0629a2ffb2e0af1ac43f", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/402a6247e5e4d246cf2d0629a2ffb2e0af1ac43f", "committedDate": "2020-04-14T12:58:02Z", "message": "Cleaned up messaging; removed some commented out code. #6558"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc389b3f2ff63422f6cf7000939e21da004a698e", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/bc389b3f2ff63422f6cf7000939e21da004a698e", "committedDate": "2020-04-14T13:23:30Z", "message": "added an entry for the file number limit for async. handling. #6558"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2079d2e379b498da2bd5567f28d85844d234fae", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/a2079d2e379b498da2bd5567f28d85844d234fae", "committedDate": "2020-04-14T15:25:45Z", "message": "as discussed, skipping file validation for minor version releases (#6558)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 958, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}