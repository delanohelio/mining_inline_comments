{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NDY2NjU2", "number": 7311, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzozMTo0NVrOEsDKPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxODoxNzowMVrOExT9EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NjI0NTc0OnYy", "diffSide": "RIGHT", "path": "doc/sphinx-guides/source/api/external-tools.rst", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzozMTo0NVrOHfJ1gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMDoyOTo0NlrOHmDvIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyOTA1OA==", "bodyText": "Do we want/need to say that hasPreviewMode only pertains to explore tools?", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r502429058", "createdAt": "2020-10-09T13:31:45Z", "author": {"login": "sekmiller"}, "path": "doc/sphinx-guides/source/api/external-tools.rst", "diffHunk": "@@ -70,19 +78,19 @@ Terminology\n     ===========================  ==========\n     Term                         Definition\n     ===========================  ==========\n-    external tool manifest       A **JSON file** the defines the URL constructed by Dataverse when users click \"Explore\" or \"Configure\" buttons. External tool makers are asked to host this JSON file on a website (no app store yet, sorry) and explain how to use install and use the tool. Examples include :download:`fabulousFileTool.json <../_static/installation/files/root/external-tools/fabulousFileTool.json>` and :download:`dynamicDatasetTool.json <../_static/installation/files/root/external-tools/dynamicDatasetTool.json>` as well as the real world examples above such as Data Explorer.\n+    external tool manifest       A **JSON file** the defines the URL constructed by Dataverse when users click explore or configure tool options. External tool makers are asked to host this JSON file on a website (no app store yet, sorry) and explain how to use install and use the tool. Examples include :download:`fabulousFileTool.json <../_static/installation/files/root/external-tools/fabulousFileTool.json>` and :download:`dynamicDatasetTool.json <../_static/installation/files/root/external-tools/dynamicDatasetTool.json>` as well as the real world examples above such as Data Explorer.\n \n     displayName                  The **name** of the tool in the Dataverse web interface. For example, \"Data Explorer\".\n \n     description                  The **description** of the tool, which appears in a popup (for configure tools only) so the user who clicked the tool can learn about the tool before being redirected the tool in a new tab in their browser. HTML is supported.\n \n     scope                        Whether the external tool appears and operates at the **file** level or the **dataset** level. Note that a file level tool much also specify the type of file it operates on (see \"contentType\" below).\n \n-    type                         Whether the external tool is an **explore** tool or a **configure** tool. Configure tools require an API token because they make changes to data files (files within datasets). Configure tools are currently not supported at the dataset level (no \"Configure\" button appears in the GUI for datasets).\n+    type                         Whether the external tool is an **explore** tool, a **preview** tool or a **configure** tool. Configure tools require an API token because they make changes to data files (files within datasets). Configure tools are currently not supported at the dataset level.\n \n     toolUrl                      The **base URL** of the tool before query parameters are added.\n     \n-    hasPreviewMode               A boolean that indicates whether tool has a preview mode which can be embedded in the File Page. Since this view is designed for embedding within Dataverse, the preview mode for a tool will typically be a view without headers or other options that may be included with a tool that is designed to be launched in a new window. Sometimes, a tool will exist solely to preview files in Dataverse and the preview mode will be the same as the regular view. \n+    hasPreviewMode               A boolean that indicates whether tool has a preview mode which can be embedded in the File Page. Since this view is designed for embedding within Dataverse, the preview mode for a tool will typically be a view without headers or other options that may be included with a tool that is designed to be launched in a new window. \n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5696f5fe24e8870118912755145cfece14cd6af2"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU1OTYyMA==", "bodyText": "As we discussed with @scolapasta we might do away with hasPreviewMode entirely and factor out \"type\" to its own table. The idea would be the perhaps tools could have multiple types, so an explore tool would also be a preview tool if it supports preview. We plan to discuss more next week.", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r502559620", "createdAt": "2020-10-09T16:58:37Z", "author": {"login": "pdurbin"}, "path": "doc/sphinx-guides/source/api/external-tools.rst", "diffHunk": "@@ -70,19 +78,19 @@ Terminology\n     ===========================  ==========\n     Term                         Definition\n     ===========================  ==========\n-    external tool manifest       A **JSON file** the defines the URL constructed by Dataverse when users click \"Explore\" or \"Configure\" buttons. External tool makers are asked to host this JSON file on a website (no app store yet, sorry) and explain how to use install and use the tool. Examples include :download:`fabulousFileTool.json <../_static/installation/files/root/external-tools/fabulousFileTool.json>` and :download:`dynamicDatasetTool.json <../_static/installation/files/root/external-tools/dynamicDatasetTool.json>` as well as the real world examples above such as Data Explorer.\n+    external tool manifest       A **JSON file** the defines the URL constructed by Dataverse when users click explore or configure tool options. External tool makers are asked to host this JSON file on a website (no app store yet, sorry) and explain how to use install and use the tool. Examples include :download:`fabulousFileTool.json <../_static/installation/files/root/external-tools/fabulousFileTool.json>` and :download:`dynamicDatasetTool.json <../_static/installation/files/root/external-tools/dynamicDatasetTool.json>` as well as the real world examples above such as Data Explorer.\n \n     displayName                  The **name** of the tool in the Dataverse web interface. For example, \"Data Explorer\".\n \n     description                  The **description** of the tool, which appears in a popup (for configure tools only) so the user who clicked the tool can learn about the tool before being redirected the tool in a new tab in their browser. HTML is supported.\n \n     scope                        Whether the external tool appears and operates at the **file** level or the **dataset** level. Note that a file level tool much also specify the type of file it operates on (see \"contentType\" below).\n \n-    type                         Whether the external tool is an **explore** tool or a **configure** tool. Configure tools require an API token because they make changes to data files (files within datasets). Configure tools are currently not supported at the dataset level (no \"Configure\" button appears in the GUI for datasets).\n+    type                         Whether the external tool is an **explore** tool, a **preview** tool or a **configure** tool. Configure tools require an API token because they make changes to data files (files within datasets). Configure tools are currently not supported at the dataset level.\n \n     toolUrl                      The **base URL** of the tool before query parameters are added.\n     \n-    hasPreviewMode               A boolean that indicates whether tool has a preview mode which can be embedded in the File Page. Since this view is designed for embedding within Dataverse, the preview mode for a tool will typically be a view without headers or other options that may be included with a tool that is designed to be launched in a new window. Sometimes, a tool will exist solely to preview files in Dataverse and the preview mode will be the same as the regular view. \n+    hasPreviewMode               A boolean that indicates whether tool has a preview mode which can be embedded in the File Page. Since this view is designed for embedding within Dataverse, the preview mode for a tool will typically be a view without headers or other options that may be included with a tool that is designed to be launched in a new window. \n ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyOTA1OA=="}, "originalCommit": {"oid": "5696f5fe24e8870118912755145cfece14cd6af2"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU5MzA0Nw==", "bodyText": "FWIW: Looking at 5.x with QDR, some of the previewers like audio are small (regardless of file size) and it really makes no sense to have a separate explore button on the file page, so being able to mark such a previewer as preview only would help there, and would make it easy for admins to decide whether other previewers are worth popping out as explore tools or not. So - support for allowing tools to register with one or more types.", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r502593047", "createdAt": "2020-10-09T18:05:31Z", "author": {"login": "qqmyers"}, "path": "doc/sphinx-guides/source/api/external-tools.rst", "diffHunk": "@@ -70,19 +78,19 @@ Terminology\n     ===========================  ==========\n     Term                         Definition\n     ===========================  ==========\n-    external tool manifest       A **JSON file** the defines the URL constructed by Dataverse when users click \"Explore\" or \"Configure\" buttons. External tool makers are asked to host this JSON file on a website (no app store yet, sorry) and explain how to use install and use the tool. Examples include :download:`fabulousFileTool.json <../_static/installation/files/root/external-tools/fabulousFileTool.json>` and :download:`dynamicDatasetTool.json <../_static/installation/files/root/external-tools/dynamicDatasetTool.json>` as well as the real world examples above such as Data Explorer.\n+    external tool manifest       A **JSON file** the defines the URL constructed by Dataverse when users click explore or configure tool options. External tool makers are asked to host this JSON file on a website (no app store yet, sorry) and explain how to use install and use the tool. Examples include :download:`fabulousFileTool.json <../_static/installation/files/root/external-tools/fabulousFileTool.json>` and :download:`dynamicDatasetTool.json <../_static/installation/files/root/external-tools/dynamicDatasetTool.json>` as well as the real world examples above such as Data Explorer.\n \n     displayName                  The **name** of the tool in the Dataverse web interface. For example, \"Data Explorer\".\n \n     description                  The **description** of the tool, which appears in a popup (for configure tools only) so the user who clicked the tool can learn about the tool before being redirected the tool in a new tab in their browser. HTML is supported.\n \n     scope                        Whether the external tool appears and operates at the **file** level or the **dataset** level. Note that a file level tool much also specify the type of file it operates on (see \"contentType\" below).\n \n-    type                         Whether the external tool is an **explore** tool or a **configure** tool. Configure tools require an API token because they make changes to data files (files within datasets). Configure tools are currently not supported at the dataset level (no \"Configure\" button appears in the GUI for datasets).\n+    type                         Whether the external tool is an **explore** tool, a **preview** tool or a **configure** tool. Configure tools require an API token because they make changes to data files (files within datasets). Configure tools are currently not supported at the dataset level.\n \n     toolUrl                      The **base URL** of the tool before query parameters are added.\n     \n-    hasPreviewMode               A boolean that indicates whether tool has a preview mode which can be embedded in the File Page. Since this view is designed for embedding within Dataverse, the preview mode for a tool will typically be a view without headers or other options that may be included with a tool that is designed to be launched in a new window. Sometimes, a tool will exist solely to preview files in Dataverse and the preview mode will be the same as the regular view. \n+    hasPreviewMode               A boolean that indicates whether tool has a preview mode which can be embedded in the File Page. Since this view is designed for embedding within Dataverse, the preview mode for a tool will typically be a view without headers or other options that may be included with a tool that is designed to be launched in a new window. \n ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyOTA1OA=="}, "originalCommit": {"oid": "5696f5fe24e8870118912755145cfece14cd6af2"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU5ODU0Ng==", "bodyText": "@qqmyers thanks. To be clear, even with the code as-is in this pull request, it's possible for admins to decide if a tool that offers preview appears under \"explore\" or not. To convert the audio tool to \"preview only\" (again, given the code so far), you'd change it from an \"explore\" tool to a \"preview\" tool. To switch it back, you'd change it from \"preview\" to \"explore\" and make sure hasPreviewMode is true.\nAlso, please note that from the Preview tab, there's always a button to open the tool in a new window. For preview tools the button is labeled \"Open in a New Window\" and for explore tools it's labeled as it was before, \"Explore on [TOOL NAME]\". So popping out happens for both.", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r502598546", "createdAt": "2020-10-09T18:16:53Z", "author": {"login": "pdurbin"}, "path": "doc/sphinx-guides/source/api/external-tools.rst", "diffHunk": "@@ -70,19 +78,19 @@ Terminology\n     ===========================  ==========\n     Term                         Definition\n     ===========================  ==========\n-    external tool manifest       A **JSON file** the defines the URL constructed by Dataverse when users click \"Explore\" or \"Configure\" buttons. External tool makers are asked to host this JSON file on a website (no app store yet, sorry) and explain how to use install and use the tool. Examples include :download:`fabulousFileTool.json <../_static/installation/files/root/external-tools/fabulousFileTool.json>` and :download:`dynamicDatasetTool.json <../_static/installation/files/root/external-tools/dynamicDatasetTool.json>` as well as the real world examples above such as Data Explorer.\n+    external tool manifest       A **JSON file** the defines the URL constructed by Dataverse when users click explore or configure tool options. External tool makers are asked to host this JSON file on a website (no app store yet, sorry) and explain how to use install and use the tool. Examples include :download:`fabulousFileTool.json <../_static/installation/files/root/external-tools/fabulousFileTool.json>` and :download:`dynamicDatasetTool.json <../_static/installation/files/root/external-tools/dynamicDatasetTool.json>` as well as the real world examples above such as Data Explorer.\n \n     displayName                  The **name** of the tool in the Dataverse web interface. For example, \"Data Explorer\".\n \n     description                  The **description** of the tool, which appears in a popup (for configure tools only) so the user who clicked the tool can learn about the tool before being redirected the tool in a new tab in their browser. HTML is supported.\n \n     scope                        Whether the external tool appears and operates at the **file** level or the **dataset** level. Note that a file level tool much also specify the type of file it operates on (see \"contentType\" below).\n \n-    type                         Whether the external tool is an **explore** tool or a **configure** tool. Configure tools require an API token because they make changes to data files (files within datasets). Configure tools are currently not supported at the dataset level (no \"Configure\" button appears in the GUI for datasets).\n+    type                         Whether the external tool is an **explore** tool, a **preview** tool or a **configure** tool. Configure tools require an API token because they make changes to data files (files within datasets). Configure tools are currently not supported at the dataset level.\n \n     toolUrl                      The **base URL** of the tool before query parameters are added.\n     \n-    hasPreviewMode               A boolean that indicates whether tool has a preview mode which can be embedded in the File Page. Since this view is designed for embedding within Dataverse, the preview mode for a tool will typically be a view without headers or other options that may be included with a tool that is designed to be launched in a new window. Sometimes, a tool will exist solely to preview files in Dataverse and the preview mode will be the same as the regular view. \n+    hasPreviewMode               A boolean that indicates whether tool has a preview mode which can be embedded in the File Page. Since this view is designed for embedding within Dataverse, the preview mode for a tool will typically be a view without headers or other options that may be included with a tool that is designed to be launched in a new window. \n ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyOTA1OA=="}, "originalCommit": {"oid": "5696f5fe24e8870118912755145cfece14cd6af2"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY2OTE1Mg==", "bodyText": "hasPreviewMode has been removed in 767882b", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r509669152", "createdAt": "2020-10-21T20:29:46Z", "author": {"login": "pdurbin"}, "path": "doc/sphinx-guides/source/api/external-tools.rst", "diffHunk": "@@ -70,19 +78,19 @@ Terminology\n     ===========================  ==========\n     Term                         Definition\n     ===========================  ==========\n-    external tool manifest       A **JSON file** the defines the URL constructed by Dataverse when users click \"Explore\" or \"Configure\" buttons. External tool makers are asked to host this JSON file on a website (no app store yet, sorry) and explain how to use install and use the tool. Examples include :download:`fabulousFileTool.json <../_static/installation/files/root/external-tools/fabulousFileTool.json>` and :download:`dynamicDatasetTool.json <../_static/installation/files/root/external-tools/dynamicDatasetTool.json>` as well as the real world examples above such as Data Explorer.\n+    external tool manifest       A **JSON file** the defines the URL constructed by Dataverse when users click explore or configure tool options. External tool makers are asked to host this JSON file on a website (no app store yet, sorry) and explain how to use install and use the tool. Examples include :download:`fabulousFileTool.json <../_static/installation/files/root/external-tools/fabulousFileTool.json>` and :download:`dynamicDatasetTool.json <../_static/installation/files/root/external-tools/dynamicDatasetTool.json>` as well as the real world examples above such as Data Explorer.\n \n     displayName                  The **name** of the tool in the Dataverse web interface. For example, \"Data Explorer\".\n \n     description                  The **description** of the tool, which appears in a popup (for configure tools only) so the user who clicked the tool can learn about the tool before being redirected the tool in a new tab in their browser. HTML is supported.\n \n     scope                        Whether the external tool appears and operates at the **file** level or the **dataset** level. Note that a file level tool much also specify the type of file it operates on (see \"contentType\" below).\n \n-    type                         Whether the external tool is an **explore** tool or a **configure** tool. Configure tools require an API token because they make changes to data files (files within datasets). Configure tools are currently not supported at the dataset level (no \"Configure\" button appears in the GUI for datasets).\n+    type                         Whether the external tool is an **explore** tool, a **preview** tool or a **configure** tool. Configure tools require an API token because they make changes to data files (files within datasets). Configure tools are currently not supported at the dataset level.\n \n     toolUrl                      The **base URL** of the tool before query parameters are added.\n     \n-    hasPreviewMode               A boolean that indicates whether tool has a preview mode which can be embedded in the File Page. Since this view is designed for embedding within Dataverse, the preview mode for a tool will typically be a view without headers or other options that may be included with a tool that is designed to be launched in a new window. Sometimes, a tool will exist solely to preview files in Dataverse and the preview mode will be the same as the regular view. \n+    hasPreviewMode               A boolean that indicates whether tool has a preview mode which can be embedded in the File Page. Since this view is designed for embedding within Dataverse, the preview mode for a tool will typically be a view without headers or other options that may be included with a tool that is designed to be launched in a new window. \n ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyOTA1OA=="}, "originalCommit": {"oid": "5696f5fe24e8870118912755145cfece14cd6af2"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMTI0OTc0OnYy", "diffSide": "RIGHT", "path": "src/main/java/edu/harvard/iq/dataverse/FileDownloadHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNzoyNToyN1rOHnW4Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxODoyMDo0NFrOHocrBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMTMzMA==", "bodyText": "Because the validation isn't run - any missing required are caught in the UI - we can get rid of this", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r511031330", "createdAt": "2020-10-23T17:25:27Z", "author": {"login": "sekmiller"}, "path": "src/main/java/edu/harvard/iq/dataverse/FileDownloadHelper.java", "diffHunk": "@@ -230,6 +133,7 @@ public void writeGuestbookAndStartDownload(GuestbookResponse guestbookResponse)\n          boolean valid = validateGuestbookResponse(guestbookResponse);\n \n          if (!valid) {\n+             // FIXME: This never validation error shows in the UI (even if you add a bundle entry).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b62d0d7eb00a8f957af64686db8bf1799f4de76"}, "originalPosition": 191}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3NDg1Mg==", "bodyText": "Done in e73d2f4.", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r512174852", "createdAt": "2020-10-26T18:20:44Z", "author": {"login": "pdurbin"}, "path": "src/main/java/edu/harvard/iq/dataverse/FileDownloadHelper.java", "diffHunk": "@@ -230,6 +133,7 @@ public void writeGuestbookAndStartDownload(GuestbookResponse guestbookResponse)\n          boolean valid = validateGuestbookResponse(guestbookResponse);\n \n          if (!valid) {\n+             // FIXME: This never validation error shows in the UI (even if you add a bundle entry).", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMTMzMA=="}, "originalCommit": {"oid": "6b62d0d7eb00a8f957af64686db8bf1799f4de76"}, "originalPosition": 191}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMTI1NTk3OnYy", "diffSide": "RIGHT", "path": "src/main/java/edu/harvard/iq/dataverse/FileDownloadHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNzoyNzoyNFrOHnW76w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxODoyMToxMFrOHocsPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMjI5OQ==", "bodyText": "I don't think this method is needed anymore.", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r511032299", "createdAt": "2020-10-23T17:27:24Z", "author": {"login": "sekmiller"}, "path": "src/main/java/edu/harvard/iq/dataverse/FileDownloadHelper.java", "diffHunk": "@@ -230,6 +133,7 @@ public void writeGuestbookAndStartDownload(GuestbookResponse guestbookResponse)\n          boolean valid = validateGuestbookResponse(guestbookResponse);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b62d0d7eb00a8f957af64686db8bf1799f4de76"}, "originalPosition": 188}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3NTE2NQ==", "bodyText": "Done in e73d2f4.", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r512175165", "createdAt": "2020-10-26T18:21:10Z", "author": {"login": "pdurbin"}, "path": "src/main/java/edu/harvard/iq/dataverse/FileDownloadHelper.java", "diffHunk": "@@ -230,6 +133,7 @@ public void writeGuestbookAndStartDownload(GuestbookResponse guestbookResponse)\n          boolean valid = validateGuestbookResponse(guestbookResponse);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMjI5OQ=="}, "originalCommit": {"oid": "6b62d0d7eb00a8f957af64686db8bf1799f4de76"}, "originalPosition": 188}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMTI2MTI0OnYy", "diffSide": "RIGHT", "path": "src/main/java/edu/harvard/iq/dataverse/FileDownloadHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNzoyOTowNFrOHnW_JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxODoyMDo1OFrOHocroQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMzEyNA==", "bodyText": "Again since the validation is done in the UI, I think you can go directly to writing the GB response", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r511033124", "createdAt": "2020-10-23T17:29:04Z", "author": {"login": "sekmiller"}, "path": "src/main/java/edu/harvard/iq/dataverse/FileDownloadHelper.java", "diffHunk": "@@ -347,7 +251,22 @@ public String startWorldMapDownloadLink(GuestbookResponse guestbookResponse, Fil\n         return retVal;\n     }\n \n-        \n+     /**\n+      * Writes a guestbook entry for either popup scenario: guestbook or terms.\n+      */\n+     public boolean writeGuestbookAndShowPreview(GuestbookResponse guestbookResponse) {\n+         // We've already validated guestbooks on the front end but we validate again\n+         // on the backend (that's what older methods do).\n+         boolean valid = validateGuestbookResponse(guestbookResponse);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b62d0d7eb00a8f957af64686db8bf1799f4de76"}, "originalPosition": 206}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3NTAwOQ==", "bodyText": "Done in e73d2f4.", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r512175009", "createdAt": "2020-10-26T18:20:58Z", "author": {"login": "pdurbin"}, "path": "src/main/java/edu/harvard/iq/dataverse/FileDownloadHelper.java", "diffHunk": "@@ -347,7 +251,22 @@ public String startWorldMapDownloadLink(GuestbookResponse guestbookResponse, Fil\n         return retVal;\n     }\n \n-        \n+     /**\n+      * Writes a guestbook entry for either popup scenario: guestbook or terms.\n+      */\n+     public boolean writeGuestbookAndShowPreview(GuestbookResponse guestbookResponse) {\n+         // We've already validated guestbooks on the front end but we validate again\n+         // on the backend (that's what older methods do).\n+         boolean valid = validateGuestbookResponse(guestbookResponse);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMzEyNA=="}, "originalCommit": {"oid": "6b62d0d7eb00a8f957af64686db8bf1799f4de76"}, "originalPosition": 206}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMTQyNjA5OnYy", "diffSide": "RIGHT", "path": "src/main/webapp/file-download-popup-fragment.xhtml", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxODoxNzowMVrOHnYj1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxODozMzo0MVrOHodJ8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA1ODkwMQ==", "bodyText": "If we are rendering the buttons based on the gbResponse file formats, can we just have one method for Launching the explore tool, world map and package popup that decides what to do based on the file format. That could reduce three buttons to one.", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r511058901", "createdAt": "2020-10-23T18:17:01Z", "author": {"login": "sekmiller"}, "path": "src/main/webapp/file-download-popup-fragment.xhtml", "diffHunk": "@@ -121,56 +123,83 @@\n                                 </label>\n                                 <p:inputText id=\"customQuestionResponse\"\n                                              styleClass=\"form-control\" value=\"#{customQuestionResponse.response}\"\n-                                             required=\"#{param['DO_GB_VALIDATION'] and customQuestionResponse.customQuestion.required}\"\n+                                             required=\"#{param[validateThisContext] and customQuestionResponse.customQuestion.required}\"\n                                              rendered=\"#{customQuestionResponse.customQuestion.questionType=='text'}\"\n                                              requiredMessage=\"#{bundle['requiredField']}\">\n-                                    <p:ajax listener=\"#{fileDownloadHelper.customQuestionValueChangeListener}\"/>\n                                 </p:inputText>\n                                 <p:message id=\"cqMessages\" for=\"customQuestionResponse\" display=\"text\"/>\n                                 <p:selectOneMenu id=\"customQuestionResponseSelect\"\n                                                  styleClass=\"form-control\" value=\"#{customQuestionResponse.response}\"\n-                                                 required=\"#{param['DO_GB_VALIDATION'] and customQuestionResponse.customQuestion.required}\"\n+                                                 required=\"#{param[validateThisContext] and customQuestionResponse.customQuestion.required}\"\n                                                  rendered=\"#{customQuestionResponse.customQuestion.questionType=='options'}\"\n                                                  requiredMessage=\"#{bundle['requiredField']}\">\n                                     <f:selectItem itemLabel=\"#{bundle.select}\" itemValue=\"\" noSelectionOption=\"true\" />\n                                     <f:selectItems value=\"#{customQuestionResponse.responseSelectItems}\" />\n-                                    <p:ajax listener=\"#{fileDownloadHelper.customQuestionValueChangeListener}\"/>\n                                 </p:selectOneMenu>\n+                                <p:message id=\"cqrsMessages\" for=\"customQuestionResponseSelect\" display=\"text\"/>\n                             </div>\n-                                <div class=\"ui-message ui-message-error ui-widget ui-corner-all\" aria-live=\"polite\" jsf:rendered=\"#{!empty customQuestionResponse.validationMessage}\">\n-                                    <span class=\"ui-message-error-detail\">#{customQuestionResponse.validationMessage}</span>\n-                                </div>\n                         </ui:repeat>\n                     </div>\n                 </div>\n             </p:fragment>\n         </div>\n         <div class=\"button-block\">\n+            <!--\n+            The \"process\" directive below is very important. Without it, the\n+            setters on the GuestbookResponse object can be called twice leading\n+            to form values (name, email, etc) to be overwritten by the object in\n+            the other context. For example, \"name\" in the Preview tab could get\n+            overwritten by \"name\" in the download popup with either a blank\n+            value or a prefilled value, leading to a botched guestbook entry.\n+            \n+            Experimentation was done with adding process=\"downloadPopup\" to the\n+            non-Preview tab buttons but this caused a ComponentNotFoundException\n+            and didn't solve any problems. If you add logging to print out\n+            setName from Guestbook response, you can see that the setters are\n+            called on the GuestbookResponse object from the Preview tab but they\n+            are later overwritten by the setters on the GuestbookResponse object\n+            from the Download popup.\n+            -->\n+            <!--REGULAR DOWNLOAD BUTTON, NO EXTERNAL TOOL, NOT THE PREVIEW TAB-->\n             <!--Note: the guestbookResponse.fileFormat is being set in xhtml via the initial download buttons in file-download-button-fragment.xhtml -->\n-            <p:commandButton styleClass=\"btn btn-default\" process=\"@this\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat != 'externalTool'\n-                                                                                                                            and guestbookResponse.fileFormat != 'worldMap'\n-                                                                                                                            and guestbookResponse.fileFormat != 'package'}\"\n-                           actionListener=\"#{fileDownloadHelper.writeGuestbookAndStartDownload(guestbookResponse)}\"\n-                           update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/>\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\"\n+                             rendered=\"#{guestbookResponse.fileFormat != 'externalTool' and\n+                                         guestbookResponse.fileFormat != 'worldMap' and\n+                                         guestbookResponse.fileFormat != 'package' and\n+                                         popupContext != 'previewTab'}\"\n+                             actionListener=\"#{fileDownloadHelper.writeGuestbookAndStartDownload(guestbookResponse)}\"\n+                             update=\"guestbookUIFragment\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n+            </p:commandButton>\n+            <!--PREVIEW TAB BUTTON-->\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\"\n+                             rendered=\"#{popupContext == 'previewTab'}\"\n+                             actionListener=\"#{FilePage.showPreview(guestbookResponse)}\"\n+                             process=\"previewTab\"\n+                             update=\"fileForm:tabView\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n             </p:commandButton>\n+            <!--WORLDMAP BUTTON-->\n             <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'worldMap'}\"\n-                            actionListener=\"#{fileDownloadHelper.startWorldMapDownloadLink(guestbookResponse, null)}\" \n-                            update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/> \n+                             actionListener=\"#{fileDownloadHelper.startWorldMapDownloadLink(guestbookResponse, null)}\"\n+                             update=\"guestbookUIFragment\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n             </p:commandButton>\n+            <!--EXTERNAL TOOL BUTTON-->\n             <!--On the dataset page (but not the file page), \"tool\" is null so we get the tool from the guestbookResponse.-->\n-            <p:commandButton styleClass=\"btn btn-default\" process=\"@this\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'externalTool'}\"\n-                           action=\"#{fileDownloadHelper.writeGuestbookAndLaunchExploreTool(guestbookResponse, fileMetadata, tool)}\"\n-                           update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/>\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'externalTool'}\"\n+                             action=\"#{fileDownloadHelper.writeGuestbookAndLaunchExploreTool(guestbookResponse, fileMetadata, tool)}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b62d0d7eb00a8f957af64686db8bf1799f4de76"}, "originalPosition": 185}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA2MjQxNQ==", "bodyText": "A related thought: @djbrooke  has given the ok to start removing world map related buttons and such, so if that helps simplify the code... (I've started to do that in the kebab issue / edit buttons)", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r511062415", "createdAt": "2020-10-23T18:23:54Z", "author": {"login": "scolapasta"}, "path": "src/main/webapp/file-download-popup-fragment.xhtml", "diffHunk": "@@ -121,56 +123,83 @@\n                                 </label>\n                                 <p:inputText id=\"customQuestionResponse\"\n                                              styleClass=\"form-control\" value=\"#{customQuestionResponse.response}\"\n-                                             required=\"#{param['DO_GB_VALIDATION'] and customQuestionResponse.customQuestion.required}\"\n+                                             required=\"#{param[validateThisContext] and customQuestionResponse.customQuestion.required}\"\n                                              rendered=\"#{customQuestionResponse.customQuestion.questionType=='text'}\"\n                                              requiredMessage=\"#{bundle['requiredField']}\">\n-                                    <p:ajax listener=\"#{fileDownloadHelper.customQuestionValueChangeListener}\"/>\n                                 </p:inputText>\n                                 <p:message id=\"cqMessages\" for=\"customQuestionResponse\" display=\"text\"/>\n                                 <p:selectOneMenu id=\"customQuestionResponseSelect\"\n                                                  styleClass=\"form-control\" value=\"#{customQuestionResponse.response}\"\n-                                                 required=\"#{param['DO_GB_VALIDATION'] and customQuestionResponse.customQuestion.required}\"\n+                                                 required=\"#{param[validateThisContext] and customQuestionResponse.customQuestion.required}\"\n                                                  rendered=\"#{customQuestionResponse.customQuestion.questionType=='options'}\"\n                                                  requiredMessage=\"#{bundle['requiredField']}\">\n                                     <f:selectItem itemLabel=\"#{bundle.select}\" itemValue=\"\" noSelectionOption=\"true\" />\n                                     <f:selectItems value=\"#{customQuestionResponse.responseSelectItems}\" />\n-                                    <p:ajax listener=\"#{fileDownloadHelper.customQuestionValueChangeListener}\"/>\n                                 </p:selectOneMenu>\n+                                <p:message id=\"cqrsMessages\" for=\"customQuestionResponseSelect\" display=\"text\"/>\n                             </div>\n-                                <div class=\"ui-message ui-message-error ui-widget ui-corner-all\" aria-live=\"polite\" jsf:rendered=\"#{!empty customQuestionResponse.validationMessage}\">\n-                                    <span class=\"ui-message-error-detail\">#{customQuestionResponse.validationMessage}</span>\n-                                </div>\n                         </ui:repeat>\n                     </div>\n                 </div>\n             </p:fragment>\n         </div>\n         <div class=\"button-block\">\n+            <!--\n+            The \"process\" directive below is very important. Without it, the\n+            setters on the GuestbookResponse object can be called twice leading\n+            to form values (name, email, etc) to be overwritten by the object in\n+            the other context. For example, \"name\" in the Preview tab could get\n+            overwritten by \"name\" in the download popup with either a blank\n+            value or a prefilled value, leading to a botched guestbook entry.\n+            \n+            Experimentation was done with adding process=\"downloadPopup\" to the\n+            non-Preview tab buttons but this caused a ComponentNotFoundException\n+            and didn't solve any problems. If you add logging to print out\n+            setName from Guestbook response, you can see that the setters are\n+            called on the GuestbookResponse object from the Preview tab but they\n+            are later overwritten by the setters on the GuestbookResponse object\n+            from the Download popup.\n+            -->\n+            <!--REGULAR DOWNLOAD BUTTON, NO EXTERNAL TOOL, NOT THE PREVIEW TAB-->\n             <!--Note: the guestbookResponse.fileFormat is being set in xhtml via the initial download buttons in file-download-button-fragment.xhtml -->\n-            <p:commandButton styleClass=\"btn btn-default\" process=\"@this\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat != 'externalTool'\n-                                                                                                                            and guestbookResponse.fileFormat != 'worldMap'\n-                                                                                                                            and guestbookResponse.fileFormat != 'package'}\"\n-                           actionListener=\"#{fileDownloadHelper.writeGuestbookAndStartDownload(guestbookResponse)}\"\n-                           update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/>\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\"\n+                             rendered=\"#{guestbookResponse.fileFormat != 'externalTool' and\n+                                         guestbookResponse.fileFormat != 'worldMap' and\n+                                         guestbookResponse.fileFormat != 'package' and\n+                                         popupContext != 'previewTab'}\"\n+                             actionListener=\"#{fileDownloadHelper.writeGuestbookAndStartDownload(guestbookResponse)}\"\n+                             update=\"guestbookUIFragment\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n+            </p:commandButton>\n+            <!--PREVIEW TAB BUTTON-->\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\"\n+                             rendered=\"#{popupContext == 'previewTab'}\"\n+                             actionListener=\"#{FilePage.showPreview(guestbookResponse)}\"\n+                             process=\"previewTab\"\n+                             update=\"fileForm:tabView\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n             </p:commandButton>\n+            <!--WORLDMAP BUTTON-->\n             <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'worldMap'}\"\n-                            actionListener=\"#{fileDownloadHelper.startWorldMapDownloadLink(guestbookResponse, null)}\" \n-                            update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/> \n+                             actionListener=\"#{fileDownloadHelper.startWorldMapDownloadLink(guestbookResponse, null)}\"\n+                             update=\"guestbookUIFragment\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n             </p:commandButton>\n+            <!--EXTERNAL TOOL BUTTON-->\n             <!--On the dataset page (but not the file page), \"tool\" is null so we get the tool from the guestbookResponse.-->\n-            <p:commandButton styleClass=\"btn btn-default\" process=\"@this\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'externalTool'}\"\n-                           action=\"#{fileDownloadHelper.writeGuestbookAndLaunchExploreTool(guestbookResponse, fileMetadata, tool)}\"\n-                           update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/>\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'externalTool'}\"\n+                             action=\"#{fileDownloadHelper.writeGuestbookAndLaunchExploreTool(guestbookResponse, fileMetadata, tool)}\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA1ODkwMQ=="}, "originalCommit": {"oid": "6b62d0d7eb00a8f957af64686db8bf1799f4de76"}, "originalPosition": 185}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA2NDM1NA==", "bodyText": "Yes - I have on my list to start clearing out Worldmap issues from Github and to create an issue to pull out any Worldmap/Geoconnect code specific in Dataverse, so it's good to get a headstart.", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r511064354", "createdAt": "2020-10-23T18:27:40Z", "author": {"login": "djbrooke"}, "path": "src/main/webapp/file-download-popup-fragment.xhtml", "diffHunk": "@@ -121,56 +123,83 @@\n                                 </label>\n                                 <p:inputText id=\"customQuestionResponse\"\n                                              styleClass=\"form-control\" value=\"#{customQuestionResponse.response}\"\n-                                             required=\"#{param['DO_GB_VALIDATION'] and customQuestionResponse.customQuestion.required}\"\n+                                             required=\"#{param[validateThisContext] and customQuestionResponse.customQuestion.required}\"\n                                              rendered=\"#{customQuestionResponse.customQuestion.questionType=='text'}\"\n                                              requiredMessage=\"#{bundle['requiredField']}\">\n-                                    <p:ajax listener=\"#{fileDownloadHelper.customQuestionValueChangeListener}\"/>\n                                 </p:inputText>\n                                 <p:message id=\"cqMessages\" for=\"customQuestionResponse\" display=\"text\"/>\n                                 <p:selectOneMenu id=\"customQuestionResponseSelect\"\n                                                  styleClass=\"form-control\" value=\"#{customQuestionResponse.response}\"\n-                                                 required=\"#{param['DO_GB_VALIDATION'] and customQuestionResponse.customQuestion.required}\"\n+                                                 required=\"#{param[validateThisContext] and customQuestionResponse.customQuestion.required}\"\n                                                  rendered=\"#{customQuestionResponse.customQuestion.questionType=='options'}\"\n                                                  requiredMessage=\"#{bundle['requiredField']}\">\n                                     <f:selectItem itemLabel=\"#{bundle.select}\" itemValue=\"\" noSelectionOption=\"true\" />\n                                     <f:selectItems value=\"#{customQuestionResponse.responseSelectItems}\" />\n-                                    <p:ajax listener=\"#{fileDownloadHelper.customQuestionValueChangeListener}\"/>\n                                 </p:selectOneMenu>\n+                                <p:message id=\"cqrsMessages\" for=\"customQuestionResponseSelect\" display=\"text\"/>\n                             </div>\n-                                <div class=\"ui-message ui-message-error ui-widget ui-corner-all\" aria-live=\"polite\" jsf:rendered=\"#{!empty customQuestionResponse.validationMessage}\">\n-                                    <span class=\"ui-message-error-detail\">#{customQuestionResponse.validationMessage}</span>\n-                                </div>\n                         </ui:repeat>\n                     </div>\n                 </div>\n             </p:fragment>\n         </div>\n         <div class=\"button-block\">\n+            <!--\n+            The \"process\" directive below is very important. Without it, the\n+            setters on the GuestbookResponse object can be called twice leading\n+            to form values (name, email, etc) to be overwritten by the object in\n+            the other context. For example, \"name\" in the Preview tab could get\n+            overwritten by \"name\" in the download popup with either a blank\n+            value or a prefilled value, leading to a botched guestbook entry.\n+            \n+            Experimentation was done with adding process=\"downloadPopup\" to the\n+            non-Preview tab buttons but this caused a ComponentNotFoundException\n+            and didn't solve any problems. If you add logging to print out\n+            setName from Guestbook response, you can see that the setters are\n+            called on the GuestbookResponse object from the Preview tab but they\n+            are later overwritten by the setters on the GuestbookResponse object\n+            from the Download popup.\n+            -->\n+            <!--REGULAR DOWNLOAD BUTTON, NO EXTERNAL TOOL, NOT THE PREVIEW TAB-->\n             <!--Note: the guestbookResponse.fileFormat is being set in xhtml via the initial download buttons in file-download-button-fragment.xhtml -->\n-            <p:commandButton styleClass=\"btn btn-default\" process=\"@this\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat != 'externalTool'\n-                                                                                                                            and guestbookResponse.fileFormat != 'worldMap'\n-                                                                                                                            and guestbookResponse.fileFormat != 'package'}\"\n-                           actionListener=\"#{fileDownloadHelper.writeGuestbookAndStartDownload(guestbookResponse)}\"\n-                           update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/>\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\"\n+                             rendered=\"#{guestbookResponse.fileFormat != 'externalTool' and\n+                                         guestbookResponse.fileFormat != 'worldMap' and\n+                                         guestbookResponse.fileFormat != 'package' and\n+                                         popupContext != 'previewTab'}\"\n+                             actionListener=\"#{fileDownloadHelper.writeGuestbookAndStartDownload(guestbookResponse)}\"\n+                             update=\"guestbookUIFragment\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n+            </p:commandButton>\n+            <!--PREVIEW TAB BUTTON-->\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\"\n+                             rendered=\"#{popupContext == 'previewTab'}\"\n+                             actionListener=\"#{FilePage.showPreview(guestbookResponse)}\"\n+                             process=\"previewTab\"\n+                             update=\"fileForm:tabView\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n             </p:commandButton>\n+            <!--WORLDMAP BUTTON-->\n             <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'worldMap'}\"\n-                            actionListener=\"#{fileDownloadHelper.startWorldMapDownloadLink(guestbookResponse, null)}\" \n-                            update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/> \n+                             actionListener=\"#{fileDownloadHelper.startWorldMapDownloadLink(guestbookResponse, null)}\"\n+                             update=\"guestbookUIFragment\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n             </p:commandButton>\n+            <!--EXTERNAL TOOL BUTTON-->\n             <!--On the dataset page (but not the file page), \"tool\" is null so we get the tool from the guestbookResponse.-->\n-            <p:commandButton styleClass=\"btn btn-default\" process=\"@this\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'externalTool'}\"\n-                           action=\"#{fileDownloadHelper.writeGuestbookAndLaunchExploreTool(guestbookResponse, fileMetadata, tool)}\"\n-                           update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/>\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'externalTool'}\"\n+                             action=\"#{fileDownloadHelper.writeGuestbookAndLaunchExploreTool(guestbookResponse, fileMetadata, tool)}\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA1ODkwMQ=="}, "originalCommit": {"oid": "6b62d0d7eb00a8f957af64686db8bf1799f4de76"}, "originalPosition": 185}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE4Mjc2OA==", "bodyText": "I just looked at this and I don't see a lot of value in refactoring. The complexity has to live somewhere and right now a decision is made on the front end. I think it's fine as it is.", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r512182768", "createdAt": "2020-10-26T18:33:41Z", "author": {"login": "pdurbin"}, "path": "src/main/webapp/file-download-popup-fragment.xhtml", "diffHunk": "@@ -121,56 +123,83 @@\n                                 </label>\n                                 <p:inputText id=\"customQuestionResponse\"\n                                              styleClass=\"form-control\" value=\"#{customQuestionResponse.response}\"\n-                                             required=\"#{param['DO_GB_VALIDATION'] and customQuestionResponse.customQuestion.required}\"\n+                                             required=\"#{param[validateThisContext] and customQuestionResponse.customQuestion.required}\"\n                                              rendered=\"#{customQuestionResponse.customQuestion.questionType=='text'}\"\n                                              requiredMessage=\"#{bundle['requiredField']}\">\n-                                    <p:ajax listener=\"#{fileDownloadHelper.customQuestionValueChangeListener}\"/>\n                                 </p:inputText>\n                                 <p:message id=\"cqMessages\" for=\"customQuestionResponse\" display=\"text\"/>\n                                 <p:selectOneMenu id=\"customQuestionResponseSelect\"\n                                                  styleClass=\"form-control\" value=\"#{customQuestionResponse.response}\"\n-                                                 required=\"#{param['DO_GB_VALIDATION'] and customQuestionResponse.customQuestion.required}\"\n+                                                 required=\"#{param[validateThisContext] and customQuestionResponse.customQuestion.required}\"\n                                                  rendered=\"#{customQuestionResponse.customQuestion.questionType=='options'}\"\n                                                  requiredMessage=\"#{bundle['requiredField']}\">\n                                     <f:selectItem itemLabel=\"#{bundle.select}\" itemValue=\"\" noSelectionOption=\"true\" />\n                                     <f:selectItems value=\"#{customQuestionResponse.responseSelectItems}\" />\n-                                    <p:ajax listener=\"#{fileDownloadHelper.customQuestionValueChangeListener}\"/>\n                                 </p:selectOneMenu>\n+                                <p:message id=\"cqrsMessages\" for=\"customQuestionResponseSelect\" display=\"text\"/>\n                             </div>\n-                                <div class=\"ui-message ui-message-error ui-widget ui-corner-all\" aria-live=\"polite\" jsf:rendered=\"#{!empty customQuestionResponse.validationMessage}\">\n-                                    <span class=\"ui-message-error-detail\">#{customQuestionResponse.validationMessage}</span>\n-                                </div>\n                         </ui:repeat>\n                     </div>\n                 </div>\n             </p:fragment>\n         </div>\n         <div class=\"button-block\">\n+            <!--\n+            The \"process\" directive below is very important. Without it, the\n+            setters on the GuestbookResponse object can be called twice leading\n+            to form values (name, email, etc) to be overwritten by the object in\n+            the other context. For example, \"name\" in the Preview tab could get\n+            overwritten by \"name\" in the download popup with either a blank\n+            value or a prefilled value, leading to a botched guestbook entry.\n+            \n+            Experimentation was done with adding process=\"downloadPopup\" to the\n+            non-Preview tab buttons but this caused a ComponentNotFoundException\n+            and didn't solve any problems. If you add logging to print out\n+            setName from Guestbook response, you can see that the setters are\n+            called on the GuestbookResponse object from the Preview tab but they\n+            are later overwritten by the setters on the GuestbookResponse object\n+            from the Download popup.\n+            -->\n+            <!--REGULAR DOWNLOAD BUTTON, NO EXTERNAL TOOL, NOT THE PREVIEW TAB-->\n             <!--Note: the guestbookResponse.fileFormat is being set in xhtml via the initial download buttons in file-download-button-fragment.xhtml -->\n-            <p:commandButton styleClass=\"btn btn-default\" process=\"@this\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat != 'externalTool'\n-                                                                                                                            and guestbookResponse.fileFormat != 'worldMap'\n-                                                                                                                            and guestbookResponse.fileFormat != 'package'}\"\n-                           actionListener=\"#{fileDownloadHelper.writeGuestbookAndStartDownload(guestbookResponse)}\"\n-                           update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/>\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\"\n+                             rendered=\"#{guestbookResponse.fileFormat != 'externalTool' and\n+                                         guestbookResponse.fileFormat != 'worldMap' and\n+                                         guestbookResponse.fileFormat != 'package' and\n+                                         popupContext != 'previewTab'}\"\n+                             actionListener=\"#{fileDownloadHelper.writeGuestbookAndStartDownload(guestbookResponse)}\"\n+                             update=\"guestbookUIFragment\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n+            </p:commandButton>\n+            <!--PREVIEW TAB BUTTON-->\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\"\n+                             rendered=\"#{popupContext == 'previewTab'}\"\n+                             actionListener=\"#{FilePage.showPreview(guestbookResponse)}\"\n+                             process=\"previewTab\"\n+                             update=\"fileForm:tabView\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n             </p:commandButton>\n+            <!--WORLDMAP BUTTON-->\n             <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'worldMap'}\"\n-                            actionListener=\"#{fileDownloadHelper.startWorldMapDownloadLink(guestbookResponse, null)}\" \n-                            update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/> \n+                             actionListener=\"#{fileDownloadHelper.startWorldMapDownloadLink(guestbookResponse, null)}\"\n+                             update=\"guestbookUIFragment\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n             </p:commandButton>\n+            <!--EXTERNAL TOOL BUTTON-->\n             <!--On the dataset page (but not the file page), \"tool\" is null so we get the tool from the guestbookResponse.-->\n-            <p:commandButton styleClass=\"btn btn-default\" process=\"@this\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'externalTool'}\"\n-                           action=\"#{fileDownloadHelper.writeGuestbookAndLaunchExploreTool(guestbookResponse, fileMetadata, tool)}\"\n-                           update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/>\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'externalTool'}\"\n+                             action=\"#{fileDownloadHelper.writeGuestbookAndLaunchExploreTool(guestbookResponse, fileMetadata, tool)}\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA1ODkwMQ=="}, "originalCommit": {"oid": "6b62d0d7eb00a8f957af64686db8bf1799f4de76"}, "originalPosition": 185}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2402, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}