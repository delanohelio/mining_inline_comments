{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyMTEwMTk3", "number": 6622, "title": "6290 dataset role mgmt api", "bodyText": "What this PR does / why we need it:\nAllows admins to assign roles to users at the dataset level\nWhich issue(s) this PR closes:\nCloses #6290 Dataset Role Management API\nSpecial notes for your reviewer:\nNone\nSuggestions on how to test this:\nDoes this PR introduce a user interface change?:\nNone\nIs there a release notes update needed for this change?:\nNo\nAdditional documentation:", "createdAt": "2020-02-06T21:01:53Z", "url": "https://github.com/IQSS/dataverse/pull/6622", "merged": true, "mergeCommit": {"oid": "28001fba14020a16d55fdbc7767e8fa8b09206dc"}, "closed": true, "closedAt": "2020-02-13T17:03:21Z", "author": {"login": "sekmiller"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBdP9SgH2gAyMzcyMTEwMTk3OmJhOWI5MGU3NDNhNzdhYWQ3MzVhZWFmNDM4Yzk2NmZjNmU0MzdkODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcD84PFgH2gAyMzcyMTEwMTk3OmI3YjM2NDVlNzA0MTFjNjA1MjY1MjdkZjU5MjBjYjI3MDhkNzg4MDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ba9b90e743a77aad735aeaf438c966fc6e437d84", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/ba9b90e743a77aad735aeaf438c966fc6e437d84", "committedDate": "2020-02-05T21:44:41Z", "message": "#6290 add DS Role api and tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d7a28809d387b409b32526c2db54079c60288fa", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/7d7a28809d387b409b32526c2db54079c60288fa", "committedDate": "2020-02-05T21:44:55Z", "message": "Merge branch 'develop' into 6290-dataset-role-mgmt-api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dac1ad19f76bbb083e1f9668f2e20abf86009336", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/dac1ad19f76bbb083e1f9668f2e20abf86009336", "committedDate": "2020-02-06T16:11:49Z", "message": "#6290 cannot add role without permission"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c24610e991ef52d5d05e2db1f03d039c4b648c7", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/3c24610e991ef52d5d05e2db1f03d039c4b648c7", "committedDate": "2020-02-06T18:04:25Z", "message": "Merge branch 'develop' into 6290-dataset-role-mgmt-api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6286fc124aeac6950a701d52cfa0b62020c8deaa", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/6286fc124aeac6950a701d52cfa0b62020c8deaa", "committedDate": "2020-02-06T20:23:59Z", "message": "Merge branch 'develop' into 6290-dataset-role-mgmt-api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd120eed71ac51d68005b1fe8aa61ddf098826ee", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/cd120eed71ac51d68005b1fe8aa61ddf098826ee", "committedDate": "2020-02-06T20:37:47Z", "message": "Merge branch 'develop' into 6290-dataset-role-mgmt-api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba7f66c10555cc0e03fc9052f470e5dde4a5a026", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/ba7f66c10555cc0e03fc9052f470e5dde4a5a026", "committedDate": "2020-02-06T20:50:02Z", "message": "#6290 Add doc to dataset role api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NzgwMzMx", "url": "https://github.com/IQSS/dataverse/pull/6622#pullrequestreview-354780331", "createdAt": "2020-02-06T21:21:15Z", "commit": {"oid": "ba7f66c10555cc0e03fc9052f470e5dde4a5a026"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMToyMToxNVrOFmqnnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMToyMToxNVrOFmqnnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA4ODQ3Nw==", "bodyText": "I think the new-ish rule is that when we touch APIs we should put the English in a bundle.", "url": "https://github.com/IQSS/dataverse/pull/6622#discussion_r376088477", "createdAt": "2020-02-06T21:21:15Z", "author": {"login": "pdurbin"}, "path": "src/main/java/edu/harvard/iq/dataverse/api/Datasets.java", "diffHunk": "@@ -1084,24 +1086,38 @@ public Response getLinks(@PathParam(\"id\") String idSupplied ) {\n     }\n \n     /**\n-     * @todo Make this real. Currently only used for API testing. Copied from\n-     * the equivalent API endpoint for dataverses and simplified with values\n-     * hard coded.\n+     * Add a given assignment to a given user or group\n+     * @param ra role assignment DTO\n+     * @param id dataset id\n+     * @param apiKey\n      */\n     @POST\n     @Path(\"{identifier}/assignments\")\n-    public Response createAssignment(String userOrGroup, @PathParam(\"identifier\") String id, @QueryParam(\"key\") String apiKey) {\n-        boolean apiTestingOnly = true;\n-        if (apiTestingOnly) {\n-            return error(Response.Status.FORBIDDEN, \"This is only for API tests.\");\n-        }\n+    public Response createAssignment(RoleAssignmentDTO ra, @PathParam(\"identifier\") String id, @QueryParam(\"key\") String apiKey) {\n         try {\n             Dataset dataset = findDatasetOrDie(id);\n-            RoleAssignee assignee = findAssignee(userOrGroup);\n+            \n+            RoleAssignee assignee = findAssignee(ra.getAssignee());\n             if (assignee == null) {\n                 return error(Response.Status.BAD_REQUEST, \"Assignee not found\");\n+            }           \n+            \n+            DataverseRole theRole;\n+            Dataverse dv = dataset.getOwner();\n+            theRole = null;\n+            while ((theRole == null) && (dv != null)) {\n+                for (DataverseRole aRole : rolesSvc.availableRoles(dv.getId())) {\n+                    if (aRole.getAlias().equals(ra.getRole())) {\n+                        theRole = aRole;\n+                        break;\n+                    }\n+                }\n+                dv = dv.getOwner();\n             }\n-            DataverseRole theRole = rolesSvc.findBuiltinRoleByAlias(\"admin\");\n+            if (theRole == null) {\n+                return error(Status.BAD_REQUEST, \"Can't find role named '\" + ra.getRole() + \"' in dataverse \" + dataset.getOwner());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba7f66c10555cc0e03fc9052f470e5dde4a5a026"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "039bd5e199ff50b4426a249bf60cf8b465e8742f", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/039bd5e199ff50b4426a249bf60cf8b465e8742f", "committedDate": "2020-02-10T19:18:09Z", "message": "#6920 add revoke role api for datasets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b191a44e77ce2280077d24962a1c64b8749bcd0", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/1b191a44e77ce2280077d24962a1c64b8749bcd0", "committedDate": "2020-02-10T19:19:28Z", "message": "Merge branch 'develop' into 6290-dataset-role-mgmt-api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9eb308ad82a2de3fd4bbd8d16e2c9fe47325b15a", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/9eb308ad82a2de3fd4bbd8d16e2c9fe47325b15a", "committedDate": "2020-02-10T21:01:14Z", "message": "#6290 bundle-ize api messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f341af23adf611ef08b01a94b061cedd07521e4e", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/f341af23adf611ef08b01a94b061cedd07521e4e", "committedDate": "2020-02-10T22:15:46Z", "message": "#6290 Add doc for revoke role on Dataset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fed7f86ca2c0d59fcbc9eae44c7024de76b02260", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/fed7f86ca2c0d59fcbc9eae44c7024de76b02260", "committedDate": "2020-02-10T22:17:35Z", "message": "#6290 fix doc typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzA4ODA5", "url": "https://github.com/IQSS/dataverse/pull/6622#pullrequestreview-356308809", "createdAt": "2020-02-10T22:22:37Z", "commit": {"oid": "fed7f86ca2c0d59fcbc9eae44c7024de76b02260"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d60cc65bcda09192f64d6d3ee39a2579b3843db", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/7d60cc65bcda09192f64d6d3ee39a2579b3843db", "committedDate": "2020-02-11T14:50:17Z", "message": "Merge branch 'develop' into 6290-dataset-role-mgmt-api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71e3e036dbc043619f40d8c0e7ecbff614738a38", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/71e3e036dbc043619f40d8c0e7ecbff614738a38", "committedDate": "2020-02-11T14:59:16Z", "message": "#6290 fix list dataset roles after merge conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a064189b23917095a0c5e10bd641ff415bc50bd6", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/a064189b23917095a0c5e10bd641ff415bc50bd6", "committedDate": "2020-02-11T15:02:09Z", "message": "#6290 add code block tags"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1dafdcbc509f16e9317e183fe91970c88dae260", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/d1dafdcbc509f16e9317e183fe91970c88dae260", "committedDate": "2020-02-11T15:04:49Z", "message": "reformat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e3de66da0c87290b90a129b1848fb6cf4ed1a84", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/4e3de66da0c87290b90a129b1848fb6cf4ed1a84", "committedDate": "2020-02-11T15:08:58Z", "message": "once again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a1ff014e9b4da99db35941d392c5c32e8a92228", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/9a1ff014e9b4da99db35941d392c5c32e8a92228", "committedDate": "2020-02-11T15:12:11Z", "message": "Update native-api.rst"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a7d066e34521566cc0308f259c1b0f70df8d60e", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/0a7d066e34521566cc0308f259c1b0f70df8d60e", "committedDate": "2020-02-11T15:13:28Z", "message": "Update native-api.rst"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60988887c50f76081d24672fd396aea087419aee", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/60988887c50f76081d24672fd396aea087419aee", "committedDate": "2020-02-12T20:29:12Z", "message": "Update native-api.rst"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7288f919adcf4d8b287628bf568c623d3413d4ad", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/7288f919adcf4d8b287628bf568c623d3413d4ad", "committedDate": "2020-02-12T22:14:56Z", "message": "Update native-api.rst"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e311549b4f43efdbf376dbce262af155486f637", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/9e311549b4f43efdbf376dbce262af155486f637", "committedDate": "2020-02-13T15:07:42Z", "message": "#6290 get role assignments at DV level for DS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7c60509708a39c32b89ee5259b85f353606fd80", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/b7c60509708a39c32b89ee5259b85f353606fd80", "committedDate": "2020-02-13T15:08:23Z", "message": "Merge branch 'develop' into 6290-dataset-role-mgmt-api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7b3645e70411c60526527df5920cb2708d78802", "author": {"user": {"login": "sekmiller", "name": "Stephen Kraffmiller"}}, "url": "https://github.com/IQSS/dataverse/commit/b7b3645e70411c60526527df5920cb2708d78802", "committedDate": "2020-02-13T15:43:35Z", "message": "Update native-api.rst"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 922, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}