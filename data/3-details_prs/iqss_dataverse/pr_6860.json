{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5ODU0MTMy", "number": 6860, "title": "Destroy Dataset with a Mapped DataFile", "bodyText": "What this PR does / why we need it:\nSelf-explanatory; see issue.\nWhich issue(s) this PR closes:\nCloses #4093\nSpecial notes for your reviewer:\nIt implements cascade delete on both the map layer and tokens; as in the original PR 2.5 yrs ago. In addition, the code is added to the DeleteDataFileCommand, that deletes any data associated with the layer that may exist on the WorldMap side.\nSuggestions on how to test this:\nDeploy on demo, destroy all those old, as of now un-destroyable datasets.\nDoes this PR introduce a user interface change?:\nno\nIs there a release notes update needed for this change?:\nno\nAdditional documentation:", "createdAt": "2020-04-28T03:05:50Z", "url": "https://github.com/IQSS/dataverse/pull/6860", "merged": true, "mergeCommit": {"oid": "1424ba87ee5daf8aff655cf085defa9babbf95c8"}, "closed": true, "closedAt": "2020-05-04T16:10:51Z", "author": {"login": "landreev"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcb6TmCAH2gAyNDA5ODU0MTMyOmI4YjhlM2NlOGFkNTQ3MmZmMDBkNzAyNzcwM2I0ZTIwNjYyOWQ5ODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccH4w_AFqTQwMjA4Njk2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b8b8e3ce8ad5472ff00d7027703b4e206629d986", "author": {"user": {"login": "landreev", "name": null}}, "url": "https://github.com/IQSS/dataverse/commit/b8b8e3ce8ad5472ff00d7027703b4e206629d986", "committedDate": "2020-04-28T02:17:56Z", "message": "make sure that we delete both the worldmap entities on the dataverse side, and possible\nremote layer data. #4093"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxOTA3MDAw", "url": "https://github.com/IQSS/dataverse/pull/6860#pullrequestreview-401907000", "createdAt": "2020-04-28T14:42:01Z", "commit": {"oid": "b8b8e3ce8ad5472ff00d7027703b4e206629d986"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNDo0MjowMVrOGNXjFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNDo0MjowMVrOGNXjFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY3MDQ4NA==", "bodyText": "I had forgotten that there's a DeleteMapLayerMetadataCommand but this comment makes me wonder why we don't call it. I get that we don't need to call it thanks to the cascade, but would calling the command cause problems? Does it do more than we want? It seems to clean up thumbnails, for example. Also, there's tiny typo above: dedicatd.", "url": "https://github.com/IQSS/dataverse/pull/6860#discussion_r416670484", "createdAt": "2020-04-28T14:42:01Z", "author": {"login": "pdurbin"}, "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/DeleteDataFileCommand.java", "diffHunk": "@@ -210,6 +213,31 @@ public FileVisitResult postVisitDirectory(final Path dir, final IOException e)\n         } catch (Exception e) {\n             logger.log(Level.WARNING, \"Identifier deletion was not successfull:\", e.getMessage());\n         }\n+        \n+        // If there is a Map Layer associated with this file, we may need to \n+        // try and remove the layer data on the WorldMap side. \n+        if (ctxt.mapLayerMetadata().findMetadataByDatafile(doomed) != null) {\n+            // (We need an AuthenticatedUser in order to produce a WorldMap token!)\n+            String id = getUser().getIdentifier();\n+            id = id.startsWith(\"@\") ? id.substring(1) : id;\n+            AuthenticatedUser authenticatedUser = ctxt.authentication().getAuthenticatedUser(id);\n+            try {\n+                ctxt.mapLayerMetadata().deleteMapLayerFromWorldMap(doomed, authenticatedUser);\n+\n+                // We have the dedicatd command DeleteMapLayerMetadataCommand, but \n+                // there's no need to use it explicitly, since the Dataverse-side\n+                // MapLayerMetadata entity will be deleted by the database \n+                // cascade on the DataFile. -- L.A. Apr. 2020", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8b8e3ce8ad5472ff00d7027703b4e206629d986"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMDg2OTY4", "url": "https://github.com/IQSS/dataverse/pull/6860#pullrequestreview-402086968", "createdAt": "2020-04-28T18:07:18Z", "commit": {"oid": "b8b8e3ce8ad5472ff00d7027703b4e206629d986"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 980, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}