{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyNzY4NTQ3", "number": 7222, "title": "Security18 hibernate validator vulnerability", "bodyText": "What this PR does / why we need it:an attacker to escalate permissions and access private values and create invalid instances - see CVE-2017-7536. It is reported to be fixed in versions 5.2.5.Final and greater\nWhich issue(s) this PR closes:Investigate and Address Possible Vulnerability in org.hibernate:hibernate-validator #18\nCloses  #IQSS/dataverse-security#18\nSpecial notes for your reviewer:\nSuggestions on how to test this:The library upgrade is reported to be sufficient to eliminate the security vulnerability. However, it required code changes due to changes in the api and a dependency change due to a change in the initialization behavior of the library\nThe issue you were seeing earlier may have been due to a specified library conflicting with provide library in Payara. I had thought this was addressed due to a comment by Oliver, but somehow that change may not have gotten into the pull request. I believe it is up to date now and the hibernate validator pom entry references the Payara provided version. org.hibernate.validator.internal.util.CollectionHelper is provided by Payara\nDoes this PR introduce a user interface change? If mockups are available, please link/include them here:no\nIs there a release notes update needed for this change?:no\nAdditional documentation:", "createdAt": "2020-08-24T21:11:43Z", "url": "https://github.com/IQSS/dataverse/pull/7222", "merged": true, "mergeCommit": {"oid": "796e612577f9cfeb05f6a6aeab03346b6b788394"}, "closed": true, "closedAt": "2020-08-26T14:18:20Z", "author": {"login": "rtreacy"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAzFYIAH2gAyNDcyNzY4NTQ3Ojc2YzBiM2MwMGUyMTFlODNmN2MwZTJkMDM1ZmMxZWI1MjA2NmM0YzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCsSdQAH2gAyNDcyNzY4NTQ3OjVlM2I2YWNiNWIxM2NlN2ExMWQ4NjMxMjVlYjYyMjhmMGYyYzk5ZTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "76c0b3c00e211e83f7c0e2d035fc1eb52066c4c3", "author": {"user": {"login": "rtreacy", "name": "Bob Treacy"}}, "url": "https://github.com/IQSS/dataverse/commit/76c0b3c00e211e83f7c0e2d035fc1eb52066c4c3", "committedDate": "2020-08-20T16:48:16Z", "message": "The version pf hibernate-validator that we were using, 5.0.3.Final was reported to allow an attacker to escalate permissions and access private values and create invalid instances - see CVE-2017-7536. It is reported to be fixed in versions 5.2.5.Final and greater.\n\nThe upgraded library had changes to the api for constructing ConstaintValidatorContextImpl, used in URLValidatorTest.java. In investigating the changes, it was found that there were further changes to the api in recent versions and it was decided to adapt the code to the latest changes and use the latest available stable hibernate-validator library - 6.1.5.Final.\n\nIt was also necessary to add a dependency to javax.el due to changes in the library starting with version 5.3.1.Final and later."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "438a7d0b4a317abae32d0116beed5d377c8b1b6d", "author": {"user": {"login": "rtreacy", "name": "Bob Treacy"}}, "url": "https://github.com/IQSS/dataverse/commit/438a7d0b4a317abae32d0116beed5d377c8b1b6d", "committedDate": "2020-08-20T17:49:41Z", "message": "code cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab33496e6bc3b62c0de83e94a011dbd6a48142c1", "author": {"user": {"login": "rtreacy", "name": "Bob Treacy"}}, "url": "https://github.com/IQSS/dataverse/commit/ab33496e6bc3b62c0de83e94a011dbd6a48142c1", "committedDate": "2020-08-20T17:53:40Z", "message": "sorry, one more line of commented code removed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df442c5c4ccd84a02169adda11f0ebda52833833", "author": {"user": {"login": "rtreacy", "name": "Bob Treacy"}}, "url": "https://github.com/IQSS/dataverse/commit/df442c5c4ccd84a02169adda11f0ebda52833833", "committedDate": "2020-08-20T20:31:45Z", "message": "Change ek dependency to jakarta.el provided by Payara"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7fcdfa9a1891fb73c58467c5aaa6d09a369dd24", "author": {"user": {"login": "rtreacy", "name": "Bob Treacy"}}, "url": "https://github.com/IQSS/dataverse/commit/a7fcdfa9a1891fb73c58467c5aaa6d09a369dd24", "committedDate": "2020-08-20T21:50:13Z", "message": "Use hibernate-validator provided with Payara (still a 6.1.x -6.1.2 specifically at this point)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dd243115af5e04eba4d3a4751fa42d20bcc7064", "author": {"user": {"login": "rtreacy", "name": "Bob Treacy"}}, "url": "https://github.com/IQSS/dataverse/commit/1dd243115af5e04eba4d3a4751fa42d20bcc7064", "committedDate": "2020-08-25T21:52:16Z", "message": "changed hibernat-validator scope from provided to compile, because we were getting NoClassDefFoundError: org/hibernate/validator/internal/util/CollectionHelper at runtime while creating an account"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MjMwNTc2", "url": "https://github.com/IQSS/dataverse/pull/7222#pullrequestreview-475230576", "createdAt": "2020-08-26T07:42:15Z", "commit": {"oid": "1dd243115af5e04eba4d3a4751fa42d20bcc7064"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwNzo0MjoxNlrOHG_xxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwNzo1NTozMlrOHHAQKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA5ODQzNg==", "bodyText": "I doubt this is necessary. There isn't a single use of this package as far as I know from the codebase. Using EL in JSF usually doesn't imply adding it to the direct dependencies. Your commit message states it had been added because of the validator dependency, but the Payara BOM already should take care of that. Please try to remove and test.", "url": "https://github.com/IQSS/dataverse/pull/7222#discussion_r477098436", "createdAt": "2020-08-26T07:42:16Z", "author": {"login": "poikilotherm"}, "path": "pom.xml", "diffHunk": "@@ -294,9 +294,14 @@\n             <version>1.7</version> <!-- Or 1.8-SNAPSHOT -->\n         </dependency>\n         <dependency>\n-            <groupId>org.hibernate</groupId>\n+            <groupId>org.hibernate.validator</groupId>\n             <artifactId>hibernate-validator</artifactId>\n-            <version>5.0.3.Final</version>\n+            <scope>compile</scope>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.glassfish</groupId>\n+            <artifactId>jakarta.el</artifactId>\n+            <scope>provided</scope>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dd243115af5e04eba4d3a4751fa42d20bcc7064"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA5ODY4Mw==", "bodyText": "This should remain provided or be deleted, as compile is the default.", "url": "https://github.com/IQSS/dataverse/pull/7222#discussion_r477098683", "createdAt": "2020-08-26T07:42:43Z", "author": {"login": "poikilotherm"}, "path": "pom.xml", "diffHunk": "@@ -294,9 +294,14 @@\n             <version>1.7</version> <!-- Or 1.8-SNAPSHOT -->\n         </dependency>\n         <dependency>\n-            <groupId>org.hibernate</groupId>\n+            <groupId>org.hibernate.validator</groupId>\n             <artifactId>hibernate-validator</artifactId>\n-            <version>5.0.3.Final</version>\n+            <scope>compile</scope>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dd243115af5e04eba4d3a4751fa42d20bcc7064"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEwMDU5Nw==", "bodyText": "The complete test class should be refactored to use a JUnit5 @ParameterizedTest, usable for both unit tests.\nThe context object should be mocked. Creating a real object is of no use here and at least on my machine creates errors. Happy to create a PR against this PR.", "url": "https://github.com/IQSS/dataverse/pull/7222#discussion_r477100597", "createdAt": "2020-08-26T07:46:01Z", "author": {"login": "poikilotherm"}, "path": "src/test/java/edu/harvard/iq/dataverse/URLValidatorTest.java", "diffHunk": "@@ -35,15 +39,15 @@ public void testIsValidWithUnspecifiedContext() {\n     @Test\n     public void testIsValidWithContextAndValidURL() {\n         String value = \"https://twitter.com/\";\n-        ConstraintValidatorContext context = new ConstraintValidatorContextImpl(null, PathImpl.createPathFromString(\"\"), null);\n+        ConstraintValidatorContext context = new ConstraintValidatorContextImpl(validatorFactory.getClockProvider(), PathImpl.createPathFromString(\"\"),null, null);\n \n         assertEquals(true, new URLValidator().isValid(value, context));\n     }\n \n     @Test\n     public void testIsValidWithContextButInvalidURL() {\n         String value = \"cnn.com\";\n-        ConstraintValidatorContext context = new ConstraintValidatorContextImpl(null, PathImpl.createPathFromString(\"\"), null);\n+        ConstraintValidatorContext context = new ConstraintValidatorContextImpl(validatorFactory.getClockProvider(), PathImpl.createPathFromString(\"\"),null, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dd243115af5e04eba4d3a4751fa42d20bcc7064"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEwMjE3MQ==", "bodyText": "IMHO you should take a look at this:\n\nWe're using an internal validator class in our code and I'm not sure if this is a supported use case. This should be refactored and use Java 8 Collections API.", "url": "https://github.com/IQSS/dataverse/pull/7222#discussion_r477102171", "createdAt": "2020-08-26T07:48:47Z", "author": {"login": "poikilotherm"}, "path": "pom.xml", "diffHunk": "@@ -294,9 +294,14 @@\n             <version>1.7</version> <!-- Or 1.8-SNAPSHOT -->\n         </dependency>\n         <dependency>\n-            <groupId>org.hibernate</groupId>\n+            <groupId>org.hibernate.validator</groupId>\n             <artifactId>hibernate-validator</artifactId>\n-            <version>5.0.3.Final</version>\n+            <scope>compile</scope>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA5ODY4Mw=="}, "originalCommit": {"oid": "1dd243115af5e04eba4d3a4751fa42d20bcc7064"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEwNjIxNg==", "bodyText": "BTW @kcondon I noticed you're testing on Payara 5.201. It's not important for this issue (both 5.201 up to 5.2020.4 use Hibernate Validator 6.1.2 Final), but we should make sure that testers, QA etc all use the same version referenced in pom.xml.", "url": "https://github.com/IQSS/dataverse/pull/7222#discussion_r477106216", "createdAt": "2020-08-26T07:55:32Z", "author": {"login": "poikilotherm"}, "path": "pom.xml", "diffHunk": "@@ -294,9 +294,14 @@\n             <version>1.7</version> <!-- Or 1.8-SNAPSHOT -->\n         </dependency>\n         <dependency>\n-            <groupId>org.hibernate</groupId>\n+            <groupId>org.hibernate.validator</groupId>\n             <artifactId>hibernate-validator</artifactId>\n-            <version>5.0.3.Final</version>\n+            <scope>compile</scope>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA5ODY4Mw=="}, "originalCommit": {"oid": "1dd243115af5e04eba4d3a4751fa42d20bcc7064"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f3051a93715a1780ea9c7a2e0a6ffcf3381ae6b", "author": {"user": {"login": "rtreacy", "name": "Bob Treacy"}}, "url": "https://github.com/IQSS/dataverse/commit/7f3051a93715a1780ea9c7a2e0a6ffcf3381ae6b", "committedDate": "2020-08-26T13:44:35Z", "message": "Remove compile scope as unneccessary because it is the default scope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e3b6acb5b13ce7a11d863125eb6228f0f2c99e6", "author": {"user": {"login": "rtreacy", "name": "Bob Treacy"}}, "url": "https://github.com/IQSS/dataverse/commit/5e3b6acb5b13ce7a11d863125eb6228f0f2c99e6", "committedDate": "2020-08-26T14:01:04Z", "message": "Last commit included experimental removal of jakarta.el, which does not work"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 758, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}