{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMDAwNjIx", "number": 6893, "title": "6574 filenames", "bodyText": "What this PR does / why we need it:\nSeveral bugs were found while investigating filenames:\n\nFrom the \"edit metadata for files\" page, you could give files the same name.\nVia API, it was possible to give rename files to have the same name.\nVia API, it was possible to \"move\" files to directory with a file that has the same name, creating a duplicate.\n\nWhich issue(s) this PR closes:\nCloses #6574\nSpecial notes for your reviewer:\nMethods are in IngestUtil because that's where similar methods are found. Previous methods were focused on returning a unique filename such as README-1.md. The new methods are focused on identifying duplicates.\nSuggestions on how to test this:\nTry exercising the bugs above on develop vs. this branch. The API to use is this one, passing \"label\" and \"directoryLabel\" in the JSON: http://guides.dataverse.org/en/4.20/api/native-api.html#updating-file-metadata\nDoes this PR introduce a user interface change?:\nYes, if you try to rename a file to create a naming conflict, you will see an error like this:\n\nIs there a release notes update needed for this change?:\nI don't believe so.\nAdditional documentation:\nNone.", "createdAt": "2020-05-04T14:52:38Z", "url": "https://github.com/IQSS/dataverse/pull/6893", "merged": true, "mergeCommit": {"oid": "3c2e7e681dd3faf089c82b74ce800eab13c81103"}, "closed": true, "closedAt": "2020-05-07T16:45:28Z", "author": {"login": "pdurbin"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcceVcQAH2gAyNDEzMDAwNjIxOjQxYWIxYzQxYWIxNGY5ZjA1N2JhODE2ODY0NDIwNTU1MjM2MWJlNGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceqUr2gFqTQwNjcyMzc2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "41ab1c41ab14f9f057ba8168644205552361be4c", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/41ab1c41ab14f9f057ba8168644205552361be4c", "committedDate": "2020-04-29T20:16:32Z", "message": "prevent filename conflicts via file metadata API #6574"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15d18dd527497c38705e353ccf056f9f2be8342e", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/15d18dd527497c38705e353ccf056f9f2be8342e", "committedDate": "2020-04-29T21:10:36Z", "message": "add test: files not renamed in diff dirs on upload #6574"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3e92758dc5293eec385c831b9f823c36a286d07", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/c3e92758dc5293eec385c831b9f823c36a286d07", "committedDate": "2020-04-30T18:28:06Z", "message": "centralize duplicate file check with related methods #6574"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35d07a4466d6120698aa4d567ad1801602ea8f11", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/35d07a4466d6120698aa4d567ad1801602ea8f11", "committedDate": "2020-05-01T21:07:38Z", "message": "prevent filename duplicates from \"edit metadata for files\" page #6574"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ef84f80e65ecc6ab0fac51ad8a4eba45804a2d4", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/6ef84f80e65ecc6ab0fac51ad8a4eba45804a2d4", "committedDate": "2020-05-04T14:43:51Z", "message": "Merge branch 'develop' into 6574-filenames #6574"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2NjAxOTE5", "url": "https://github.com/IQSS/dataverse/pull/6893#pullrequestreview-406601919", "createdAt": "2020-05-06T13:18:19Z", "commit": {"oid": "6ef84f80e65ecc6ab0fac51ad8a4eba45804a2d4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMzoxODoxOVrOGRSg2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMzoxODoxOVrOGRSg2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc4MjI5Nw==", "bodyText": "would it be possible to combine this with findDuplicateFilenames so that the UI and api are using the same method? You're passing in the filemetadata list from the dataset version which is the param for findDuplicateFilenames", "url": "https://github.com/IQSS/dataverse/pull/6893#discussion_r420782297", "createdAt": "2020-05-06T13:18:19Z", "author": {"login": "sekmiller"}, "path": "src/main/java/edu/harvard/iq/dataverse/ingest/IngestUtil.java", "diffHunk": "@@ -100,6 +101,80 @@ public static String duplicateFilenameCheck(FileMetadata fileMetadata, Set<Strin\n         return fileName;\n     }\n \n+    /**\n+     * Given a new proposed label or directoryLabel for a file, check against\n+     * existing files if a duplicate directoryLabel/label combination would be\n+     * created.\n+     *\n+     * @param label The new label (filename) that is being proposed. Can be\n+     * null.\n+     * @param directoryLabel The new directoryLabel (file path) that is being\n+     * proposed. Can be null.\n+     * @param fileMetadatas The list fileMetadatas to be compared against,\n+     * probably from a draft.\n+     * @param dataFile The file that is being updated with a new name or path.\n+     * @return true if there is a conflict, false otherwise.\n+     */\n+    public static boolean conflictsWithExistingFilenames(String label, String directoryLabel, List<FileMetadata> fileMetadatas, DataFile dataFile) {\n+        List<String> filePathsAndNames = new ArrayList<>();\n+        for (FileMetadata fileMetadata : fileMetadatas) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ef84f80e65ecc6ab0fac51ad8a4eba45804a2d4"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d6a5c8e6718f9989a1cd0216b026439b8064b32", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/8d6a5c8e6718f9989a1cd0216b026439b8064b32", "committedDate": "2020-05-06T15:06:39Z", "message": "consolidate duplicate code #6574"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc77ac19ff2795e9a377fe37e38fe290bfa924b1", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/dc77ac19ff2795e9a377fe37e38fe290bfa924b1", "committedDate": "2020-05-06T15:08:22Z", "message": "include new DuplicateFilesIT in API test suite #6574"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e79280bfb667d7f0ea215ca4f465d1f692ccf2f4", "author": {"user": {"login": "pdurbin", "name": "Philip Durbin"}}, "url": "https://github.com/IQSS/dataverse/commit/e79280bfb667d7f0ea215ca4f465d1f692ccf2f4", "committedDate": "2020-05-06T15:09:23Z", "message": "Merge branch 'develop' into 6574-filenames #6574"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2NzIzNzY1", "url": "https://github.com/IQSS/dataverse/pull/6893#pullrequestreview-406723765", "createdAt": "2020-05-06T15:22:25Z", "commit": {"oid": "e79280bfb667d7f0ea215ca4f465d1f692ccf2f4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 982, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}