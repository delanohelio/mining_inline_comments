{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NTk0ODg4", "number": 4055, "title": "[Doris On ES] Add docvalue limitation for doc_values scan and enable doc_values scan default", "bodyText": "#3306\nWhen reading more column values such as above 20  (default, can be configured), switch from column(doc_value)reading to row(_source or stored_fields) reading, And we set enable_docvalue_scan to true for default.\nIt is possible to notice that retrieving an high number of fields leads to a sensible worsening of performance if DocValues are used(referenced from Solr performance-smackdown)\n\nDoris On ES would provide 20(default value) for max doc_value fields, if exceeding this value, would use _source\uff08_stored_fields\uff09\nBTW: after ES 6.x,  ES introduce a dynamic index level setting index.max_docvalue_fields_search which default value is 100", "createdAt": "2020-07-09T03:29:50Z", "url": "https://github.com/apache/incubator-doris/pull/4055", "merged": true, "mergeCommit": {"oid": "265c26f67d80ec7074572c33bb3d71a773781bb2"}, "closed": true, "closedAt": "2020-07-10T10:37:37Z", "author": {"login": "wuyunfeng"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczGaz0AH2gAyNDQ2NTk0ODg4OjgyNDFhYjY2YWRiNzc3Y2YxNWU4Y2YwYWI0MDg4NDRhZTcyNWE1M2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczKhoIAFqTQ0NTM4NjA3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a", "author": {"user": {"login": "wuyunfeng", "name": "Yunfeng,Wu"}}, "url": "https://github.com/apache/incubator-doris/commit/8241ab66adb777cf15e8cf0ab408844ae725a53a", "committedDate": "2020-07-09T03:24:56Z", "message": "[Doris On ES] Add docvalue limitation for doc_values scan"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MzEwMzgy", "url": "https://github.com/apache/incubator-doris/pull/4055#pullrequestreview-445310382", "createdAt": "2020-07-09T06:01:50Z", "commit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowMTo1MVrOGvCyiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowMTo1MVrOGvCyiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MTk2MQ==", "bodyText": "pure_docvalue = properties[ESScanReader::KEY_DOC_VALUE_MODE] == \"1\" ? true: false;\n\u770b\u5230\u5bf9bool\u53d8\u91cf\u8d4b\u503c\uff0c\u8fd9\u6837\u5b50\u4f1a\u4e0d\u4f1a\u66f4\u76f4\u89c2\u4e9b\uff1f\u800c\u4e0d\u7528\u8003\u8651atoi\u8fd4\u56de\u503c\u6210\u529f\u8fd8\u662f\u5931\u8d25\u7684\u60c5\u51b5\u4e0b\uff0cdocvalue\u662ftrue\u8fd8\u662ffalse\u3002", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451981961", "createdAt": "2020-07-09T06:01:51Z", "author": {"login": "blackfox1983"}, "path": "be/src/exec/es/es_scroll_query.cpp", "diffHunk": "@@ -76,14 +76,20 @@ std::string ESScrollQueryBuilder::build(const std::map<std::string, std::string>\n     // note: add `query` for this value....\n     es_query_dsl.AddMember(\"query\", query_node, allocator);\n     bool pure_docvalue = true;\n-    // check docvalue sacan optimization\n-    if (docvalue_context.size() == 0 || docvalue_context.size() < fields.size()) {\n-        pure_docvalue = false;\n+\n+    // Doris FE already has checked docvalue-scan optimization\n+    if (properties.find(ESScanReader::KEY_DOC_VALUE_MODE) != properties.end()) {\n+        pure_docvalue = atoi(properties.at(ESScanReader::KEY_DOC_VALUE_MODE).c_str());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MzExOTY4", "url": "https://github.com/apache/incubator-doris/pull/4055#pullrequestreview-445311968", "createdAt": "2020-07-09T06:05:57Z", "commit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowNTo1OFrOGvC3pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowNTo1OFrOGvC3pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MzI3MA==", "bodyText": "why set 30, not set DEFAULT_MAX_DOCVALUE_FIELDS.", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451983270", "createdAt": "2020-07-09T06:05:58Z", "author": {"login": "wutiangan"}, "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "diffHunk": "@@ -294,6 +331,13 @@ public void readFields(DataInput in) throws IOException {\n             } else {\n                 enableKeywordSniff = true;\n             }\n+            if (tableContext.containsKey(\"maxDocValueFields\")) {\n+                try {\n+                    maxDocValueFields = Integer.parseInt(tableContext.get(\"maxDocValueFields\"));\n+                } catch (Exception e) {\n+                    maxDocValueFields = 30;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 108}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MzEyMjU0", "url": "https://github.com/apache/incubator-doris/pull/4055#pullrequestreview-445312254", "createdAt": "2020-07-09T06:06:34Z", "commit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowNjozNFrOGvC4lA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowNjozNFrOGvC4lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MzUwOA==", "bodyText": "\u662f\u4e0d\u662f\u76f4\u63a5\u62a5\u9519\u5f97\u4e86\uff1f\u6211\u4eec\u4e0d\u5141\u8bb8\u8fd9\u7c7b\u4f4e\u7ea7\u9519\u8bef\u3002\u6bd4\u5982\u8bbe\u7f6e\u4e3a0\u6216\u8005-1. \u53ef\u80fd\u7528\u6237\u60f3\u5173\u95eddocvalue\u67e5\u8be2\uff1f", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451983508", "createdAt": "2020-07-09T06:06:34Z", "author": {"login": "blackfox1983"}, "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "diffHunk": "@@ -194,6 +219,17 @@ private void validate(Map<String, String> properties) throws DdlException {\n                         + \" but value is \" + transport);\n             }\n         }\n+\n+        if (properties.containsKey(MAX_DOCVALUE_FIELDS)) {\n+            try {\n+                maxDocValueFields = Integer.parseInt(properties.get(MAX_DOCVALUE_FIELDS).trim());\n+                if (maxDocValueFields < 1) {\n+                    maxDocValueFields = 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 83}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MzEyNDE1", "url": "https://github.com/apache/incubator-doris/pull/4055#pullrequestreview-445312415", "createdAt": "2020-07-09T06:07:01Z", "commit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowNzowMVrOGvC5HA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowNzowMVrOGvC5HA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MzY0NA==", "bodyText": "if the tableContext don't contain \"maxDocValueFields\", the maxDocValueFields should set Default_max_docvaues_fields or set MaxInt.", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451983644", "createdAt": "2020-07-09T06:07:01Z", "author": {"login": "wutiangan"}, "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "diffHunk": "@@ -294,6 +331,13 @@ public void readFields(DataInput in) throws IOException {\n             } else {\n                 enableKeywordSniff = true;\n             }\n+            if (tableContext.containsKey(\"maxDocValueFields\")) {\n+                try {\n+                    maxDocValueFields = Integer.parseInt(tableContext.get(\"maxDocValueFields\"));\n+                } catch (Exception e) {\n+                    maxDocValueFields = 30;\n+                }\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 110}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MzEyNTQy", "url": "https://github.com/apache/incubator-doris/pull/4055#pullrequestreview-445312542", "createdAt": "2020-07-09T06:07:22Z", "commit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowNzoyM1rOGvC5hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowNzoyM1rOGvC5hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4Mzc0OQ==", "bodyText": "\u8fd9\u4e2a\u5730\u65b9\u662f\u4e0d\u662f\u53ef\u4ee5\u4f7f\u7528\u5b9a\u4e49\u7684\u503c\uff1fDEFAULT_MAX_DOC_VALUS_FILEDS", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451983749", "createdAt": "2020-07-09T06:07:23Z", "author": {"login": "blackfox1983"}, "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "diffHunk": "@@ -294,6 +331,13 @@ public void readFields(DataInput in) throws IOException {\n             } else {\n                 enableKeywordSniff = true;\n             }\n+            if (tableContext.containsKey(\"maxDocValueFields\")) {\n+                try {\n+                    maxDocValueFields = Integer.parseInt(tableContext.get(\"maxDocValueFields\"));\n+                } catch (Exception e) {\n+                    maxDocValueFields = 30;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 108}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MzEzMjc0", "url": "https://github.com/apache/incubator-doris/pull/4055#pullrequestreview-445313274", "createdAt": "2020-07-09T06:09:15Z", "commit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowOToxNlrOGvC7wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowOToxNlrOGvC7wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4NDMyMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                static constexpr const char* KEY_DOC_VALUE_MODE = \"doc_values_mode\";\n          \n          \n            \n                static constexpr const char* KEY_DOC_VALUES_MODE = \"doc_values_mode\";", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451984322", "createdAt": "2020-07-09T06:09:16Z", "author": {"login": "wutiangan"}, "path": "be/src/exec/es/es_scan_reader.h", "diffHunk": "@@ -40,6 +40,7 @@ class ESScanReader {\n     static constexpr const char* KEY_QUERY = \"query\";\n     static constexpr const char* KEY_BATCH_SIZE = \"batch_size\";\n     static constexpr const char* KEY_TERMINATE_AFTER = \"limit\";\n+    static constexpr const char* KEY_DOC_VALUE_MODE = \"doc_values_mode\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MzEzMzE5", "url": "https://github.com/apache/incubator-doris/pull/4055#pullrequestreview-445313319", "createdAt": "2020-07-09T06:09:21Z", "commit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowOToyMVrOGvC76w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowOToyMVrOGvC76w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4NDM2Mw==", "bodyText": "\u6211\u4e0d\u592a\u786e\u5b9a fe\u901a\u8fc7thrift\u4f20\u9012\u7ed9be\u7684\u53c2\u6570\u662f\u5426\u652f\u6301bool\u3002\u8fd9\u4e2a\u5730\u65b9\u8bfb\u8d77\u6765bool\u66f4\u76f4\u89c2\u3002\n\u5426\u5219\u6211\u5f97\u5e26\u7740c++\u7684\u601d\u7ef4\u53bb\u7406\u89e3\u3002\uff081\u662ftrue\uff0c0\u662ffalse\uff09", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451984363", "createdAt": "2020-07-09T06:09:21Z", "author": {"login": "blackfox1983"}, "path": "fe/src/main/java/org/apache/doris/planner/EsScanNode.java", "diffHunk": "@@ -109,6 +110,34 @@ public void finalize(Analyzer analyzer) throws UserException {\n         isFinalized = true;\n     }\n \n+    /**\n+     * return whether can use the doc_values scan\n+     * 0 and 1 are returned to facilitate Doris BE processing", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MzEzNDc4", "url": "https://github.com/apache/incubator-doris/pull/4055#pullrequestreview-445313478", "createdAt": "2020-07-09T06:09:44Z", "commit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06acf0de99f0b1ecdf5bfa50d071fb936f8b0a9c", "author": {"user": {"login": "wuyunfeng", "name": "Yunfeng,Wu"}}, "url": "https://github.com/apache/incubator-doris/commit/06acf0de99f0b1ecdf5bfa50d071fb936f8b0a9c", "committedDate": "2020-07-09T06:30:22Z", "message": "[Doris On ES] Add docvalue limitation for doc_values scan"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MzI4OTIw", "url": "https://github.com/apache/incubator-doris/pull/4055#pullrequestreview-445328920", "createdAt": "2020-07-09T06:44:01Z", "commit": {"oid": "06acf0de99f0b1ecdf5bfa50d071fb936f8b0a9c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5b2f17fc984609e0b938d32af1f0b1bac4d898c", "author": {"user": {"login": "wuyunfeng", "name": "Yunfeng,Wu"}}, "url": "https://github.com/apache/incubator-doris/commit/c5b2f17fc984609e0b938d32af1f0b1bac4d898c", "committedDate": "2020-07-09T06:47:48Z", "message": "[Doris On ES] Add docvalue limitation for doc_values scan"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MzQ5MjA0", "url": "https://github.com/apache/incubator-doris/pull/4055#pullrequestreview-445349204", "createdAt": "2020-07-09T07:19:18Z", "commit": {"oid": "c5b2f17fc984609e0b938d32af1f0b1bac4d898c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MzQ5ODQy", "url": "https://github.com/apache/incubator-doris/pull/4055#pullrequestreview-445349842", "createdAt": "2020-07-09T07:20:20Z", "commit": {"oid": "c5b2f17fc984609e0b938d32af1f0b1bac4d898c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1Mzg2MDcy", "url": "https://github.com/apache/incubator-doris/pull/4055#pullrequestreview-445386072", "createdAt": "2020-07-09T08:12:00Z", "commit": {"oid": "c5b2f17fc984609e0b938d32af1f0b1bac4d898c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2344, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}