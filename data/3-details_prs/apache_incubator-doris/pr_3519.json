{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1MDIxMTIx", "number": 3519, "title": "Check backend disk has available capactiy by storage medium before create table", "bodyText": "Currently we choose BE random without check disk is available, the create table will failed until create tablet task is sent to BE and BE will check is there has avaliable capcity to create tablet.So Check\nbackend disk available by storage medium will reduce unnecessary RPC call.", "createdAt": "2020-05-08T03:11:12Z", "url": "https://github.com/apache/incubator-doris/pull/3519", "merged": true, "mergeCommit": {"oid": "b2b9e22b240ad150ac40ceeff3e8a7ee0580b696"}, "closed": true, "closedAt": "2020-06-28T01:36:32Z", "author": {"login": "WingsGo"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcf3-6lAFqTQwODcyNjI5MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvCP4ogFqTQzODI0NjczNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NzI2Mjkx", "url": "https://github.com/apache/incubator-doris/pull/3519#pullrequestreview-408726291", "createdAt": "2020-05-10T09:32:24Z", "commit": {"oid": "9cffe922792506d4732909606fa4994c81c0cf2c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwOTozMjoyNFrOGTChnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwOTo0OToxNlrOGTCpng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYxNzUwMQ==", "bodyText": "We can just remove the if (table.getType() == TableType.OLAP). The argument is already OlapTable", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r422617501", "createdAt": "2020-05-10T09:32:24Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -4894,8 +4894,7 @@ public void renameTable(Database db, OlapTable table, TableRenameClause tableRen\n \n         // check if rollup has same name\n         if (table.getType() == TableType.OLAP) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cffe922792506d4732909606fa4994c81c0cf2c"}, "originalPosition": 235}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYxNzUxOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        for (String idxName: table.getIndexNameToId().keySet()) {\n          \n          \n            \n                        for (String idxName : table.getIndexNameToId().keySet()) {", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r422617519", "createdAt": "2020-05-10T09:32:30Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -4894,8 +4894,7 @@ public void renameTable(Database db, OlapTable table, TableRenameClause tableRen\n \n         // check if rollup has same name\n         if (table.getType() == TableType.OLAP) {\n-            OlapTable olapTable = (OlapTable) table;\n-            for (String idxName: olapTable.getIndexNameToId().keySet()) {\n+            for (String idxName: table.getIndexNameToId().keySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cffe922792506d4732909606fa4994c81c0cf2c"}, "originalPosition": 238}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYxODUxNQ==", "bodyText": "Add comment to explain the return value of this method.\nthe name checkDiskExceedLimitByStorageMedium is a little bit confused.", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r422618515", "createdAt": "2020-05-10T09:40:37Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/system/Backend.java", "diffHunk": "@@ -346,6 +347,23 @@ public double getMaxDiskUsedPct() {\n         return maxPct;\n     }\n \n+    public boolean checkDiskExceedLimitByStorageMedium(TStorageMedium storageMedium) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cffe922792506d4732909606fa4994c81c0cf2c"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYxODY1MA==", "bodyText": "Is this logic correct? If all disks are offline or is not with specified storage medium, then this method will return false?", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r422618650", "createdAt": "2020-05-10T09:41:46Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/system/Backend.java", "diffHunk": "@@ -346,6 +347,23 @@ public double getMaxDiskUsedPct() {\n         return maxPct;\n     }\n \n+    public boolean checkDiskExceedLimitByStorageMedium(TStorageMedium storageMedium) {\n+        // no available disk with storage medium\n+        if (getDiskNumByStorageMedium(storageMedium) <= 0) {\n+            return true;\n+        }\n+        ImmutableMap<String, DiskInfo> disks = disksRef.get();\n+        boolean exceedLimit = false;\n+        for (DiskInfo diskInfo : disks.values()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cffe922792506d4732909606fa4994c81c0cf2c"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYxOTEwOA==", "bodyText": "Actually, the method calculateDecommissionBackends() is deprecated.\nSo could you please add @Derepcated to this method?", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r422619108", "createdAt": "2020-05-10T09:45:30Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/system/SystemInfoService.java", "diffHunk": "@@ -443,7 +390,7 @@ public void releaseBackends(String clusterName, boolean isReplay) {\n         }\n \n         List<List<Backend>> hostList = Lists.newArrayList(hostBackendsMapInCluster.values());\n-        Collections.sort(hostList, hostBackendsListComparator);\n+        hostList.sort(hostBackendsListComparator);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cffe922792506d4732909606fa4994c81c0cf2c"}, "originalPosition": 170}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYxOTU1MA==", "bodyText": "This is not user friendly. For example, if all backends not meet the checkDiskExceedLimitByStorageMedium(), the user will only get the msg: \"Not enough backends\", but he will not know why there is no enough backend.\nSo could you please find a way to return the detail msg to user about the reason of failure?", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r422619550", "createdAt": "2020-05-10T09:49:16Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/system/SystemInfoService.java", "diffHunk": "@@ -729,8 +639,18 @@ public void releaseBackends(String clusterName, boolean isReplay) {\n     // return null if not enough backend\n     // use synchronized to run serially\n     public synchronized List<Long> seqChooseBackendIds(int backendNum, boolean needAlive, boolean isCreate,\n-            String clusterName) {\n-        long lastBackendId = -1L;\n+                                                       String clusterName) {\n+        return seqChooseBackendIds(backendNum, needAlive, isCreate, clusterName, getClusterBackends(clusterName));\n+    }\n+    public synchronized List<Long> seqChooseBackendIdsByStorageMedium(int backendNum, boolean needAlive, boolean isCreate,\n+                                                                      String clusterName, TStorageMedium storageMedium) {\n+        final List<Backend> backends = getClusterBackends(clusterName).stream().filter(v -> !v.checkDiskExceedLimitByStorageMedium(storageMedium)).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cffe922792506d4732909606fa4994c81c0cf2c"}, "originalPosition": 292}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "000ea8aca0ae8bc9e901028d00194745f597adfc", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/000ea8aca0ae8bc9e901028d00194745f597adfc", "committedDate": "2020-06-19T07:24:57Z", "message": "remove code format"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e142ed61e46e953128f07758e8717ebf99bf5a84", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/e142ed61e46e953128f07758e8717ebf99bf5a84", "committedDate": "2020-05-10T11:10:53Z", "message": "fix doc"}, "afterCommit": {"oid": "000ea8aca0ae8bc9e901028d00194745f597adfc", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/000ea8aca0ae8bc9e901028d00194745f597adfc", "committedDate": "2020-06-19T07:24:57Z", "message": "remove code format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "215844f5eaf588a1eebf6e6cce397401aee04452", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/215844f5eaf588a1eebf6e6cce397401aee04452", "committedDate": "2020-06-19T07:37:38Z", "message": "add odc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f53eaa65b90b8a549301646a980ae18eadc0e122", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/f53eaa65b90b8a549301646a980ae18eadc0e122", "committedDate": "2020-06-19T08:41:46Z", "message": "remove in be"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NDI2OTY2", "url": "https://github.com/apache/incubator-doris/pull/3519#pullrequestreview-434426966", "createdAt": "2020-06-20T12:58:34Z", "commit": {"oid": "f53eaa65b90b8a549301646a980ae18eadc0e122"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50d82125259c406ac5c6d069e79f8ab5dd429868", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/50d82125259c406ac5c6d069e79f8ab5dd429868", "committedDate": "2020-06-21T13:40:21Z", "message": "Add config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fa9b36c94dd17f6f9a531bf2b5832f8cdbddd6a", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/1fa9b36c94dd17f6f9a531bf2b5832f8cdbddd6a", "committedDate": "2020-06-21T14:14:15Z", "message": "add doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd9340644920f67691bc53ea7f9f42736cf772ce", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/cd9340644920f67691bc53ea7f9f42736cf772ce", "committedDate": "2020-06-21T14:19:55Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8eb74df697b33539c1b6ad9ced231f9b102debba", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/8eb74df697b33539c1b6ad9ced231f9b102debba", "committedDate": "2020-06-21T14:31:40Z", "message": "add docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd2a8b42a14bc8facbf6f56dd4b20a6562db6a0d", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/cd2a8b42a14bc8facbf6f56dd4b20a6562db6a0d", "committedDate": "2020-06-22T02:24:57Z", "message": "add normal check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0OTM3ODQ5", "url": "https://github.com/apache/incubator-doris/pull/3519#pullrequestreview-434937849", "createdAt": "2020-06-22T13:46:00Z", "commit": {"oid": "cd2a8b42a14bc8facbf6f56dd4b20a6562db6a0d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMzo0NjowMFrOGnBTsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMzo0NjowMFrOGnBTsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU2OTA3Mw==", "bodyText": "missing coment?", "url": "https://github.com/apache/incubator-doris/pull/3519#discussion_r443569073", "createdAt": "2020-06-22T13:46:00Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/common/Config.java", "diffHunk": "@@ -1082,5 +1082,11 @@\n      */\n     @ConfField(mutable = true, masterOnly = true)\n     public static boolean drop_backend_after_decommission = true;\n+\n+    /**\n+     *\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd2a8b42a14bc8facbf6f56dd4b20a6562db6a0d"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57234c6bc1db32bfb498e69d3d9ff0b601070c9f", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/57234c6bc1db32bfb498e69d3d9ff0b601070c9f", "committedDate": "2020-06-22T14:23:22Z", "message": "add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32060e69acfb254a81fbb97e6e49b0a68294e907", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/32060e69acfb254a81fbb97e6e49b0a68294e907", "committedDate": "2020-06-22T15:26:06Z", "message": "fix conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05b67c18aa2f7e82da06740ceb58677abe42c6aa", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/05b67c18aa2f7e82da06740ceb58677abe42c6aa", "committedDate": "2020-06-22T15:30:34Z", "message": "Merge branch 'master' into fix_create_table_by_storage_medium"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34268f80be26748e5c893a239537af66d4bcaabe", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/34268f80be26748e5c893a239537af66d4bcaabe", "committedDate": "2020-06-24T06:32:26Z", "message": "fix UT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43b5b52f141e0a86ae2f9496cb6c70519e021428", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/43b5b52f141e0a86ae2f9496cb6c70519e021428", "committedDate": "2020-06-24T08:28:29Z", "message": "fix ut"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8ad6434774aacca23268561f4df0836d8749c84", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/e8ad6434774aacca23268561f4df0836d8749c84", "committedDate": "2020-06-24T14:15:12Z", "message": "Merge branch 'master' into fix_create_table_by_storage_medium"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MjQ2NzM1", "url": "https://github.com/apache/incubator-doris/pull/3519#pullrequestreview-438246735", "createdAt": "2020-06-26T12:17:41Z", "commit": {"oid": "e8ad6434774aacca23268561f4df0836d8749c84"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2997, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}