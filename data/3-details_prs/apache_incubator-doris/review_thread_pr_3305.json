{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMTcwOTQ2", "number": 3305, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMDo0MjowMVrODw74SA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxMzozOTowNVrODxPpig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNjM5MzA0OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/planner/EsScanNode.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMDo0MjowMVrOGEMPcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMDo0OTozOVrOGEMSKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA0ODA1MA==", "bodyText": "!table.fieldsContext().isEmpty()\u662f\u4e0d\u662f\u66f4\u597d\u4e00\u70b9", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407048050", "createdAt": "2020-04-11T10:42:01Z", "author": {"login": "stalary"}, "path": "fe/src/main/java/org/apache/doris/planner/EsScanNode.java", "diffHunk": "@@ -123,6 +123,9 @@ protected void toThrift(TPlanNode msg) {\n         if (table.isDocValueScanEnable()) {\n             esScanNode.setDocvalue_context(table.docValueContext());\n         }\n+        if (table.isKeywordSniffEnable() && table.fieldsContext().size() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA0ODc0Nw==", "bodyText": "\u8fd9\u4e24\u4e2a\u662f\u4e00\u6837\u7684\uff0c\u7b2c\u4e00\u4e2a\u6761\u4ef6\u662f\u7528\u6237\u4e3b\u52a8\u914d\u7f6e\u7684\uff0c\u7b2c\u4e8c\u4e2a\u76ee\u524d\u4ee3\u7801\u90fd\u662f\u8fd9\u4e48\u5199\u7684^o^", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407048747", "createdAt": "2020-04-11T10:49:39Z", "author": {"login": "wuyunfeng"}, "path": "fe/src/main/java/org/apache/doris/planner/EsScanNode.java", "diffHunk": "@@ -123,6 +123,9 @@ protected void toThrift(TPlanNode msg) {\n         if (table.isDocValueScanEnable()) {\n             esScanNode.setDocvalue_context(table.docValueContext());\n         }\n+        if (table.isKeywordSniffEnable() && table.fieldsContext().size() > 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA0ODA1MA=="}, "originalCommit": {"oid": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNjUwODI2OnYy", "diffSide": "RIGHT", "path": "be/src/exec/es/es_predicate.h", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMzowODo1NFrOGENGYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMzoxMzo1N1rOGENIRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA2MjExMw==", "bodyText": "better to call set_ field_context", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407062113", "createdAt": "2020-04-11T13:08:54Z", "author": {"login": "morningman"}, "path": "be/src/exec/es/es_predicate.h", "diffHunk": "@@ -198,6 +198,10 @@ class EsPredicate {\n         return _es_query_status;\n     }\n \n+    void field_context(const std::map<std::string, std::string>& field_context) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA2MjU5OQ==", "bodyText": "And your UT failed.", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407062599", "createdAt": "2020-04-11T13:13:57Z", "author": {"login": "morningman"}, "path": "be/src/exec/es/es_predicate.h", "diffHunk": "@@ -198,6 +198,10 @@ class EsPredicate {\n         return _es_query_status;\n     }\n \n+    void field_context(const std::map<std::string, std::string>& field_context) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA2MjExMw=="}, "originalCommit": {"oid": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNjU0NDUyOnYy", "diffSide": "RIGHT", "path": "be/src/exec/es/es_predicate.cpp", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMzo1MzoyNFrOGENYGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQxMDowNTo1MVrOGEUDgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA2NjY0OQ==", "bodyText": "Repeat four times.\n        std::string col = slot_desc->col_name();\n        if (_field_context.find(col) != _field_context.end()) {\n            col = _field_context[col];\n        }", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407066649", "createdAt": "2020-04-11T13:53:24Z", "author": {"login": "kangkaisen"}, "path": "be/src/exec/es/es_predicate.cpp", "diffHunk": "@@ -298,8 +302,12 @@ Status EsPredicate::build_disjuncts_list(const Expr* conjunct) {\n         } else {\n             is_not_null = true;\n         }\n+        std::string col = slot_desc->col_name();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3NjA2Nw==", "bodyText": "maybe introduce a common function would increase the complexity", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407176067", "createdAt": "2020-04-12T10:05:51Z", "author": {"login": "wuyunfeng"}, "path": "be/src/exec/es/es_predicate.cpp", "diffHunk": "@@ -298,8 +302,12 @@ Status EsPredicate::build_disjuncts_list(const Expr* conjunct) {\n         } else {\n             is_not_null = true;\n         }\n+        std::string col = slot_desc->col_name();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA2NjY0OQ=="}, "originalCommit": {"oid": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyOTU4Njg3OnYy", "diffSide": "RIGHT", "path": "gensrc/thrift/PlanNodes.thrift", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxMzoyMjo1NVrOGEmUrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNTowNjo0MlrOGEpdWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ3NTM3NA==", "bodyText": "If this is only used for keyword path, fields_context seems no relation with keyword", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407475374", "createdAt": "2020-04-13T13:22:55Z", "author": {"login": "imay"}, "path": "gensrc/thrift/PlanNodes.thrift", "diffHunk": "@@ -222,6 +222,18 @@ struct TEsScanNode {\n     // {\"city\": \"city.raw\"}\n     // use select city from table, if enable the docvalue, we will fetch the `city` field value from `city.raw`\n     3: optional map<string, string> docvalue_context\n+    // used to indicate which string-type field predicate should used xxx.keyword etc.\n+    // \"k1\": {\n+    //    \"type\": \"text\",\n+    //    \"fields\": {\n+    //        \"keyword\": {\n+    //            \"type\": \"keyword\",\n+    //            \"ignore_above\": 256\n+    //           }\n+    //    }\n+    // }\n+    // k1 > 'abc' -> k1.keyword > 'abc'\n+    4: optional map<string, string> fields_context", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fc9980c7bdd27252de962ae39ce8218dd9d3386"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUxMDI4OA==", "bodyText": "https://www.elastic.co/guide/en/elasticsearch/reference/current/multi-fields.html\nfields is what it means to be, maybe enable_keyword_sniff is no t suitable?", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407510288", "createdAt": "2020-04-13T14:35:22Z", "author": {"login": "wuyunfeng"}, "path": "gensrc/thrift/PlanNodes.thrift", "diffHunk": "@@ -222,6 +222,18 @@ struct TEsScanNode {\n     // {\"city\": \"city.raw\"}\n     // use select city from table, if enable the docvalue, we will fetch the `city` field value from `city.raw`\n     3: optional map<string, string> docvalue_context\n+    // used to indicate which string-type field predicate should used xxx.keyword etc.\n+    // \"k1\": {\n+    //    \"type\": \"text\",\n+    //    \"fields\": {\n+    //        \"keyword\": {\n+    //            \"type\": \"keyword\",\n+    //            \"ignore_above\": 256\n+    //           }\n+    //    }\n+    // }\n+    // k1 > 'abc' -> k1.keyword > 'abc'\n+    4: optional map<string, string> fields_context", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ3NTM3NA=="}, "originalCommit": {"oid": "2fc9980c7bdd27252de962ae39ce8218dd9d3386"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUyNjc0NQ==", "bodyText": "You're right", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407526745", "createdAt": "2020-04-13T15:06:42Z", "author": {"login": "imay"}, "path": "gensrc/thrift/PlanNodes.thrift", "diffHunk": "@@ -222,6 +222,18 @@ struct TEsScanNode {\n     // {\"city\": \"city.raw\"}\n     // use select city from table, if enable the docvalue, we will fetch the `city` field value from `city.raw`\n     3: optional map<string, string> docvalue_context\n+    // used to indicate which string-type field predicate should used xxx.keyword etc.\n+    // \"k1\": {\n+    //    \"type\": \"text\",\n+    //    \"fields\": {\n+    //        \"keyword\": {\n+    //            \"type\": \"keyword\",\n+    //            \"ignore_above\": 256\n+    //           }\n+    //    }\n+    // }\n+    // k1 > 'abc' -> k1.keyword > 'abc'\n+    4: optional map<string, string> fields_context", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ3NTM3NA=="}, "originalCommit": {"oid": "2fc9980c7bdd27252de962ae39ce8218dd9d3386"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyOTYzMjEwOnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/external/EsStateStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxMzozOTowNVrOGEmwQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNDoxMzo1OVrOGEnxUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4MjQzMw==", "bodyText": "ignorecase compare?", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407482433", "createdAt": "2020-04-13T13:39:05Z", "author": {"login": "imay"}, "path": "fe/src/main/java/org/apache/doris/external/EsStateStore.java", "diffHunk": "@@ -209,36 +206,54 @@ public EsTableState parseClusterState55(String responseStr, EsTable esTable)\n                 }\n                 JSONObject fieldObject = schema.optJSONObject(colName);\n                 String fieldType = fieldObject.optString(\"type\");\n-                if (EsTable.DEFAULT_DOCVALUE_DISABLED_FIELDS.contains(fieldType)) {\n-                    JSONObject fieldsObject = fieldObject.optJSONObject(\"fields\");\n-                    if (fieldsObject != null) {\n-                        for (String key : fieldsObject.keySet()) {\n-                            JSONObject innerTypeObject = fieldsObject.optJSONObject(key);\n-                            if (EsTable.DEFAULT_DOCVALUE_DISABLED_FIELDS.contains(innerTypeObject.optString(\"type\"))) {\n-                                continue;\n-                            }\n-                            if (innerTypeObject.has(\"doc_values\")) {\n-                                boolean docValue = innerTypeObject.getBoolean(\"doc_values\");\n-                                if (docValue) {\n-                                    esTable.addDocValueField(colName, colName);\n+                // string-type field used keyword type to generate predicate\n+                if (esTable.isKeywordSniffEnable()) {\n+                    // if text field type seen, we should use the `field` keyword type?\n+                    if (\"text\".equals(fieldType)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fc9980c7bdd27252de962ae39ce8218dd9d3386"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5OTA4OQ==", "bodyText": "Elasticsearch's type must be lowercase...", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407499089", "createdAt": "2020-04-13T14:13:59Z", "author": {"login": "wuyunfeng"}, "path": "fe/src/main/java/org/apache/doris/external/EsStateStore.java", "diffHunk": "@@ -209,36 +206,54 @@ public EsTableState parseClusterState55(String responseStr, EsTable esTable)\n                 }\n                 JSONObject fieldObject = schema.optJSONObject(colName);\n                 String fieldType = fieldObject.optString(\"type\");\n-                if (EsTable.DEFAULT_DOCVALUE_DISABLED_FIELDS.contains(fieldType)) {\n-                    JSONObject fieldsObject = fieldObject.optJSONObject(\"fields\");\n-                    if (fieldsObject != null) {\n-                        for (String key : fieldsObject.keySet()) {\n-                            JSONObject innerTypeObject = fieldsObject.optJSONObject(key);\n-                            if (EsTable.DEFAULT_DOCVALUE_DISABLED_FIELDS.contains(innerTypeObject.optString(\"type\"))) {\n-                                continue;\n-                            }\n-                            if (innerTypeObject.has(\"doc_values\")) {\n-                                boolean docValue = innerTypeObject.getBoolean(\"doc_values\");\n-                                if (docValue) {\n-                                    esTable.addDocValueField(colName, colName);\n+                // string-type field used keyword type to generate predicate\n+                if (esTable.isKeywordSniffEnable()) {\n+                    // if text field type seen, we should use the `field` keyword type?\n+                    if (\"text\".equals(fieldType)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4MjQzMw=="}, "originalCommit": {"oid": "2fc9980c7bdd27252de962ae39ce8218dd9d3386"}, "originalPosition": 38}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1903, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}