{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5NDkyNTA0", "number": 3405, "title": " [Profile] Make running profile clearer and more intuitive to improve usability", "bodyText": "This CL mainly made the following modifications:\n1. Delete Invalid MemoryUsed Counter and Add PeakMemUsage in each exec node and datastreamsender\n2. Add intent in child execnode profile\uff0cmake it is easily to know the relationship between execnode\n3. Del _is_result_order we not support any more in olap_scan_node.h and olap_scan_node.cpp\n4. Add scan_disk method to olap_scanner to fix the counter _num_disks_accessed_counter\n5. Now we do not use buffer pool to read and write disk, so comment out readio counter and writeio counter code\nISSUE #3365", "createdAt": "2020-04-27T13:13:20Z", "url": "https://github.com/apache/incubator-doris/pull/3405", "merged": true, "mergeCommit": {"oid": "d0fe7e4d944cecc888062b94e898ee0ca8152a77"}, "closed": true, "closedAt": "2020-04-30T06:57:21Z", "author": {"login": "HappenLee"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbu7WnAH2gAyNDA5NDkyNTA0OmU5MGUwY2YwMGUyZWJmN2U3OTI2M2YxNjdiMzgxZDE0ZWQzOTk0ZTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccneMFAFqTQwMzI0NzU1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e90e0cf00e2ebf7e79263f167b381d14ed3994e0", "author": {"user": {"login": "HappenLee", "name": "HappenLee"}}, "url": "https://github.com/apache/incubator-doris/commit/e90e0cf00e2ebf7e79263f167b381d14ed3994e0", "committedDate": "2020-04-27T13:02:30Z", "message": " [Profile] Make running profile clearer and more intuitive to improve usability\n\nThis CL mainly made the following modifications:\n    1. Delete Invalid MemoryUsed Counter and Add PeakMemUsage in each exec node and datastreamsender\n    2. Add intent in child execnode profile\uff0cmake it is easily to know the relationship between execnode\n    3. Del _is_result_order we not support any more in olap_scan_node.h and olap_scan_node.cpp\n    4. Add scan_disk method to olap_scanner to fix the counter _num_disks_accessed_counter\n    5. Now we do not use buffer pool to read and write disk, so annotation eadio counter and writeio counter code\n#ISSUE 3365"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMDIzODk2", "url": "https://github.com/apache/incubator-doris/pull/3405#pullrequestreview-401023896", "createdAt": "2020-04-27T14:44:47Z", "commit": {"oid": "e90e0cf00e2ebf7e79263f167b381d14ed3994e0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNDo0NDo0N1rOGMm-Ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNDo0NzoyOVrOGMnHlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg3NDY0Mg==", "bodyText": "It seem that the false here is to distinguish child[0] and other children.\nAre you sure this is more readable? You can put the result screenshots here to explain.", "url": "https://github.com/apache/incubator-doris/pull/3405#discussion_r415874642", "createdAt": "2020-04-27T14:44:47Z", "author": {"login": "morningman"}, "path": "be/src/exec/exec_node.cpp", "diffHunk": "@@ -339,7 +337,7 @@ Status ExecNode::create_tree_helper(\n     }\n \n     if (!node->_children.empty()) {\n-        node->runtime_profile()->add_child(node->_children[0]->runtime_profile(), false, NULL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e90e0cf00e2ebf7e79263f167b381d14ed3994e0"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg3NzAxNA==", "bodyText": "disk_set is a set, so no need to find and insert, just insert is OK.", "url": "https://github.com/apache/incubator-doris/pull/3405#discussion_r415877014", "createdAt": "2020-04-27T14:47:29Z", "author": {"login": "morningman"}, "path": "be/src/exec/olap_scan_node.cpp", "diffHunk": "@@ -702,8 +694,13 @@ Status OlapScanNode::start_scan_thread(RuntimeState* state) {\n                 state, this, _olap_scan_node.is_preaggregation, _need_agg_finalize, *scan_range, scanner_ranges);\n             _scanner_pool->add(scanner);\n             _olap_scanners.push_back(scanner);\n+\n+            if (disk_set.find(scanner->scan_disk()) == disk_set.end()) {\n+                disk_set.insert(scanner->scan_disk());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e90e0cf00e2ebf7e79263f167b381d14ed3994e0"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNDM0NjM5", "url": "https://github.com/apache/incubator-doris/pull/3405#pullrequestreview-401434639", "createdAt": "2020-04-28T01:21:03Z", "commit": {"oid": "e90e0cf00e2ebf7e79263f167b381d14ed3994e0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwMToyMTowM1rOGM-Zmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwMToyMTowM1rOGM-Zmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI1ODQ1OA==", "bodyText": "What is this metric used for? If this metric is not useful, just remove it", "url": "https://github.com/apache/incubator-doris/pull/3405#discussion_r416258458", "createdAt": "2020-04-28T01:21:03Z", "author": {"login": "imay"}, "path": "be/src/exec/olap_scan_node.cpp", "diffHunk": "@@ -702,8 +694,13 @@ Status OlapScanNode::start_scan_thread(RuntimeState* state) {\n                 state, this, _olap_scan_node.is_preaggregation, _need_agg_finalize, *scan_range, scanner_ranges);\n             _scanner_pool->add(scanner);\n             _olap_scanners.push_back(scanner);\n+\n+            if (disk_set.find(scanner->scan_disk()) == disk_set.end()) {\n+                disk_set.insert(scanner->scan_disk());\n+            }\n         }\n     }\n+    COUNTER_SET(_num_disks_accessed_counter, static_cast<int64_t>(disk_set.size()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e90e0cf00e2ebf7e79263f167b381d14ed3994e0"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c5be321ce04ee39dc182614320bd32247c7cf94", "author": {"user": {"login": "HappenLee", "name": "HappenLee"}}, "url": "https://github.com/apache/incubator-doris/commit/1c5be321ce04ee39dc182614320bd32247c7cf94", "committedDate": "2020-04-28T03:32:38Z", "message": "change find and insert to insert operation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNjU0MjA4", "url": "https://github.com/apache/incubator-doris/pull/3405#pullrequestreview-401654208", "createdAt": "2020-04-28T09:23:03Z", "commit": {"oid": "1c5be321ce04ee39dc182614320bd32247c7cf94"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwOToyMzowM1rOGNK8vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwOToyMzowM1rOGNK8vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ2NDA2Mw==", "bodyText": "You'd better remove this field if it's not used. Btw, _memory_used_counter seems to be used by HashJoinNode::close, is it really ok to remove it?", "url": "https://github.com/apache/incubator-doris/pull/3405#discussion_r416464063", "createdAt": "2020-04-28T09:23:03Z", "author": {"login": "gaodayue"}, "path": "be/src/exec/exec_node.cpp", "diffHunk": "@@ -172,15 +172,13 @@ Status ExecNode::prepare(RuntimeState* state) {\n     DCHECK(_runtime_profile.get() != NULL);\n     _rows_returned_counter =\n         ADD_COUNTER(_runtime_profile, \"RowsReturned\", TUnit::UNIT);\n-    _memory_used_counter =\n-        ADD_COUNTER(_runtime_profile, \"MemoryUsed\", TUnit::BYTES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c5be321ce04ee39dc182614320bd32247c7cf94"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMzY0MzUw", "url": "https://github.com/apache/incubator-doris/pull/3405#pullrequestreview-402364350", "createdAt": "2020-04-29T04:57:21Z", "commit": {"oid": "1c5be321ce04ee39dc182614320bd32247c7cf94"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwNDo1NzoyMVrOGNvviA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwNDo1NzozNlrOGNvvyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA2Njg4OA==", "bodyText": "not used profile can be removed", "url": "https://github.com/apache/incubator-doris/pull/3405#discussion_r417066888", "createdAt": "2020-04-29T04:57:21Z", "author": {"login": "chaoyli"}, "path": "be/src/runtime/bufferpool/buffer_pool_counters.h", "diffHunk": "@@ -35,19 +35,19 @@ struct BufferPoolClientCounters {\n   RuntimeProfile::Counter* cumulative_bytes_alloced;\n \n   /// Amount of time spent waiting for reads from disk to complete.\n-  RuntimeProfile::Counter* read_wait_time;\n+  //RuntimeProfile::Counter* read_wait_time;\n \n   /// Total number of read I/O operations issued.\n-  RuntimeProfile::Counter* read_io_ops;\n+  //RuntimeProfile::Counter* read_io_ops;\n \n   /// Total bytes read from disk.\n   RuntimeProfile::Counter* bytes_read;\n \n   /// Amount of time spent waiting for writes to disk to complete.\n-  RuntimeProfile::Counter* write_wait_time;\n+  //RuntimeProfile::Counter* write_wait_time;\n \n   /// Total number of write I/O operations issued.\n-  RuntimeProfile::Counter* write_io_ops;\n+  //RuntimeProfile::Counter* write_io_ops;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c5be321ce04ee39dc182614320bd32247c7cf94"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA2Njk1NA==", "bodyText": "not used profile can be removed.", "url": "https://github.com/apache/incubator-doris/pull/3405#discussion_r417066954", "createdAt": "2020-04-29T04:57:36Z", "author": {"login": "chaoyli"}, "path": "be/src/runtime/bufferpool/buffer_pool.cc", "diffHunk": "@@ -392,11 +392,11 @@ BufferPool::Client::Client(BufferPool* pool, //TmpFileMgr::FileGroup* file_group\n       ADD_COUNTER(child_profile, \"CumulativeAllocations\", TUnit::UNIT);\n   counters_.cumulative_bytes_alloced =\n       ADD_COUNTER(child_profile, \"CumulativeAllocationBytes\", TUnit::BYTES);\n-  counters_.read_wait_time = ADD_TIMER(child_profile, \"ReadIoWaitTime\");\n-  counters_.read_io_ops = ADD_COUNTER(child_profile, \"ReadIoOps\", TUnit::UNIT);\n+//  counters_.read_wait_time = ADD_TIMER(child_profile, \"ReadIoWaitTime\");\n+//  counters_.read_io_ops = ADD_COUNTER(child_profile, \"ReadIoOps\", TUnit::UNIT);\n   counters_.bytes_read = ADD_COUNTER(child_profile, \"ReadIoBytes\", TUnit::BYTES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c5be321ce04ee39dc182614320bd32247c7cf94"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNjQxNjY5", "url": "https://github.com/apache/incubator-doris/pull/3405#pullrequestreview-402641669", "createdAt": "2020-04-29T13:01:21Z", "commit": {"oid": "1c5be321ce04ee39dc182614320bd32247c7cf94"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1da4ffae68f0229fe2187b504a23304bac2e372a", "author": {"user": {"login": "HappenLee", "name": "HappenLee"}}, "url": "https://github.com/apache/incubator-doris/commit/1da4ffae68f0229fe2187b504a23304bac2e372a", "committedDate": "2020-04-29T17:29:20Z", "message": "1.delete the idle counter in buffer pool\n2.delete the MemUsed counter in exec node"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMjQ3NTUy", "url": "https://github.com/apache/incubator-doris/pull/3405#pullrequestreview-403247552", "createdAt": "2020-04-30T06:55:14Z", "commit": {"oid": "1da4ffae68f0229fe2187b504a23304bac2e372a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2869, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}