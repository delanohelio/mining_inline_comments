{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MDA1NDcx", "number": 3068, "title": "Support delete materialized view", "bodyText": "DROP MATERIALIZE VIEW [ IF EXISTS ] <mv_name> ON [db_name].<table_name>\nParameters\nIF EXISTS: Do not throw an error if the materialized view does not exist. A notice is issued in this case.\nmv_name: The name of the materialized view to remove.\ndb_name: The name of db to which materialized view belongs.\ntable_name: The name of table to which materialized view belongs.\nAdd the check of keystype in create mv stmt test", "createdAt": "2020-03-10T08:48:35Z", "url": "https://github.com/apache/incubator-doris/pull/3068", "merged": true, "mergeCommit": {"oid": "c8705ccf1296c50b5196b9521da143155589797b"}, "closed": true, "closedAt": "2020-03-11T10:16:24Z", "author": {"login": "EmmyMiao87"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMOgkUgH2gAyMzg2MDA1NDcxOjdjNTdmMGRjYzBjNmI2M2JhNjAyOGRjNTFmZWMyMTg0MWU5ODdiYmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMkXwLAFqTM3MjYyNjEzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7c57f0dcc0c6b63ba6028dc51fec21841e987bbb", "author": {"user": {"login": "EmmyMiao87", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/7c57f0dcc0c6b63ba6028dc51fec21841e987bbb", "committedDate": "2020-03-10T08:47:25Z", "message": "Support delete materialized view\n\nDROP MATERIALIZE VIEW [ IF EXISTS ] <mv_name> ON [db_name].<table_name>\nParameters\n  IF EXISTS: Do not throw an error if the materialized view does not exist. A notice is issued in this case.\n  mv_name: The name of the materialized view to remove.\n  db_name: The name of db to which materialized view belongs.\n  table_name: The name of table to which materialized view belongs.\n\nAdd the check of keystype in create mv stmt test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edf08516cc1540cdb32c627a3081388d47c8a2fe", "author": {"user": {"login": "EmmyMiao87", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/edf08516cc1540cdb32c627a3081388d47c8a2fe", "committedDate": "2020-03-10T09:09:15Z", "message": "Add unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxOTU0MjY5", "url": "https://github.com/apache/incubator-doris/pull/3068#pullrequestreview-371954269", "createdAt": "2020-03-10T13:35:07Z", "commit": {"oid": "edf08516cc1540cdb32c627a3081388d47c8a2fe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMzozNTowN1rOF0O-Cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMzozNTowN1rOF0O-Cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMxNTUzMQ==", "bodyText": "No need to check table's stable when dropping mv.", "url": "https://github.com/apache/incubator-doris/pull/3068#discussion_r390315531", "createdAt": "2020-03-10T13:35:07Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -107,24 +114,38 @@ public void processCreateMaterializedView(CreateMaterializedViewStmt stmt) throw\n                 throw new DdlException(\"Do not support alter non-OLAP table[\" + tableName + \"]\");\n             }\n             OlapTable olapTable = (OlapTable) table;\n+            olapTable.checkStableAndNormal(db.getClusterName());\n \n-            if (olapTable.getState() != OlapTableState.NORMAL) {\n-                throw new DdlException(\"Table[\" + table.getName() + \"]'s state is not NORMAL. \"\n-                                               + \"Do not allow doing materialized view\");\n+            ((MaterializedViewHandler)materializedViewHandler).processCreateMaterializedView(stmt, db, olapTable);\n+        } finally {\n+            db.writeUnlock();\n+        }\n+    }\n+\n+    public void processDropMaterializedView(DropMaterializedViewStmt stmt) throws DdlException, MetaNotFoundException {\n+        // check db\n+        String dbName = stmt.getTableName().getDb();\n+        Database db = Catalog.getInstance().getDb(dbName);\n+        if (db == null) {\n+            ErrorReport.reportDdlException(ErrorCode.ERR_BAD_DB_ERROR, dbName);\n+        }\n+\n+        db.writeLock();\n+        try {\n+            String tableName = stmt.getTableName().getTbl();\n+            Table table = db.getTable(tableName);\n+            if (table == null) {\n+                ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n             }\n-            // check if all tablets are healthy, and no tablet is in tablet scheduler\n-            boolean isStable = olapTable.isStable(Catalog.getCurrentSystemInfo(),\n-                                                  Catalog.getCurrentCatalog().getTabletScheduler(),\n-                                                  db.getClusterName());\n-            if (!isStable) {\n-                throw new DdlException(\"table [\" + olapTable.getName() + \"] is not stable.\"\n-                                               + \" Some tablets of this table may not be healthy or are being \"\n-                                               + \"scheduled.\"\n-                                               + \" You need to repair the table first\"\n-                                               + \" or stop cluster balance. See 'help admin;'.\");\n+\n+            if (table.getType() != TableType.OLAP) {\n+                throw new DdlException(\"Do not support non-OLAP table [\" + tableName + \"] when drop materialized view\");\n             }\n \n-            ((MaterializedViewHandler)materializedViewHandler).processCreateMaterializedView(stmt, db, olapTable);\n+            OlapTable olapTable = (OlapTable) table;\n+            olapTable.checkStableAndNormal(db.getClusterName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edf08516cc1540cdb32c627a3081388d47c8a2fe"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b2918ee9d04305a6825c68725d3740b8f27ca21", "author": {"user": {"login": "EmmyMiao87", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/3b2918ee9d04305a6825c68725d3740b8f27ca21", "committedDate": "2020-03-11T02:48:28Z", "message": "Remove check tablet stable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f71d2c3eb23d8dc0f2ed98a4349bf8b6ae1a347", "author": {"user": {"login": "EmmyMiao87", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/0f71d2c3eb23d8dc0f2ed98a4349bf8b6ae1a347", "committedDate": "2020-03-11T03:04:08Z", "message": "Forbidden then same column with different aggregation function"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNDY3MTM5", "url": "https://github.com/apache/incubator-doris/pull/3068#pullrequestreview-372467139", "createdAt": "2020-03-11T04:18:08Z", "commit": {"oid": "0f71d2c3eb23d8dc0f2ed98a4349bf8b6ae1a347"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54bf241f412a07c69d59dc9c35c78f7d8a9c28cf", "author": {"user": {"login": "EmmyMiao87", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/54bf241f412a07c69d59dc9c35c78f7d8a9c28cf", "committedDate": "2020-03-11T04:42:03Z", "message": "Remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61b87b1776498639b0f3c2834d4a9768377f7c14", "author": {"user": {"login": "EmmyMiao87", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/61b87b1776498639b0f3c2834d4a9768377f7c14", "committedDate": "2020-03-11T06:09:40Z", "message": "Fix unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNjI2MTM0", "url": "https://github.com/apache/incubator-doris/pull/3068#pullrequestreview-372626134", "createdAt": "2020-03-11T10:15:42Z", "commit": {"oid": "61b87b1776498639b0f3c2834d4a9768377f7c14"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3546, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}