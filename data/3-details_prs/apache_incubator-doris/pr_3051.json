{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MTEyMTUw", "number": 3051, "title": "Support sharding tablet_map_lock into more small map locks to make good performance for tablet manage task", "bodyText": "This PR is to enhance the peformance for tablet manage task, when there are so many tablet in doris be, the only one tablet_map_lock may cause poor performance, and now we split it into many small locks.", "createdAt": "2020-03-07T06:39:04Z", "url": "https://github.com/apache/incubator-doris/pull/3051", "merged": true, "mergeCommit": {"oid": "a1f5b57011dd158c7f03393f40a56c5171f9aa25"}, "closed": true, "closedAt": "2020-03-09T08:29:57Z", "author": {"login": "caiconghui"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcLOxfxgH2gAyMzg1MTEyMTUwOmRiODQ2ZWUwN2Y1M2VlNTMxMGY1N2NiZmNhN2QxN2NmYmI2NTBlNTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcL5h3tAFqTM3MDk3NzY1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "db846ee07f53ee5310f57cbfca7d17cfbb650e55", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/db846ee07f53ee5310f57cbfca7d17cfbb650e55", "committedDate": "2020-03-07T06:31:59Z", "message": "Support sharding tablet_map_lock into more small map locks to make good performance for tablet manage task"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNzMxODcy", "url": "https://github.com/apache/incubator-doris/pull/3051#pullrequestreview-370731872", "createdAt": "2020-03-07T08:35:10Z", "commit": {"oid": "db846ee07f53ee5310f57cbfca7d17cfbb650e55"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwODozNToxMFrOFzNO8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwODo1MzoxNVrOFzNSzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzODUxMw==", "bodyText": "This method name is _add_tablet_to_map_unlocked(), why you add a rlock here?", "url": "https://github.com/apache/incubator-doris/pull/3051#discussion_r389238513", "createdAt": "2020-03-07T08:35:10Z", "author": {"login": "morningman"}, "path": "be/src/olap/tablet_manager.cpp", "diffHunk": "@@ -172,24 +183,29 @@ OLAPStatus TabletManager::_add_tablet_to_map_unlocked(TTabletId tablet_id, Schem\n     RETURN_NOT_OK_LOG(tablet->register_tablet_into_dir(), Substitute(\n             \"fail to register tablet into StorageEngine. data_dir=$0\",\n             tablet->data_dir()->path()));\n-\n-    _tablet_map[tablet_id].table_arr.push_back(tablet);\n-    _tablet_map[tablet_id].table_arr.sort(_cmp_tablet_by_create_time);\n-    _partition_tablet_map[tablet->partition_id()].insert(tablet->get_tablet_info());\n+    tablet_map_t& tablet_map = _get_tablet_map(tablet_id);\n+    tablet_map[tablet_id].table_arr.push_back(tablet);\n+    tablet_map[tablet_id].table_arr.sort(_cmp_tablet_by_create_time);\n+    {\n+        ReadLock rlock(&_partition_tablet_map_lock);\n+        _partition_tablet_map[tablet->partition_id()].insert(tablet->get_tablet_info());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db846ee07f53ee5310f57cbfca7d17cfbb650e55"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzODg0OQ==", "bodyText": "When there are lots of tablet in tablet_info_vec, there will be many lock/unlock operation. Does  it matter?", "url": "https://github.com/apache/incubator-doris/pull/3051#discussion_r389238849", "createdAt": "2020-03-07T08:40:58Z", "author": {"login": "morningman"}, "path": "be/src/olap/tablet_manager.cpp", "diffHunk": "@@ -533,11 +551,12 @@ OLAPStatus TabletManager::_drop_tablet_unlocked(\n OLAPStatus TabletManager::drop_tablets_on_error_root_path(\n         const vector<TabletInfo>& tablet_info_vec) {\n     OLAPStatus res = OLAP_SUCCESS;\n-    WriteLock wlock(&_tablet_map_lock);\n \n     for (const TabletInfo& tablet_info : tablet_info_vec) {\n         TTabletId tablet_id = tablet_info.tablet_id;\n         TSchemaHash schema_hash = tablet_info.schema_hash;\n+        RWMutex& tablet_map_lock = _get_tablet_map_lock(tablet_id);\n+        WriteLock wlock(&tablet_map_lock);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db846ee07f53ee5310f57cbfca7d17cfbb650e55"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzOTUwMA==", "bodyText": "And comment of these 2 locks: _partition_tablet_map_lock and _shutdown_tablets_lock.\nEspecially notice the lock order of these locks, to avoid dead lock.", "url": "https://github.com/apache/incubator-doris/pull/3051#discussion_r389239500", "createdAt": "2020-03-07T08:53:15Z", "author": {"login": "morningman"}, "path": "be/src/olap/tablet_manager.h", "diffHunk": "@@ -190,8 +192,12 @@ class TabletManager {\n     typedef std::unordered_map<int64_t, TableInstances> tablet_map_t;\n \n     // Protect _tablet_map, _partition_tablet_map, _shutdown_tablets\n-    RWMutex _tablet_map_lock;\n-    tablet_map_t _tablet_map;\n+    int32_t _tablet_map_lock_shard_size;\n+    RWMutex *_tablet_map_lock_array;\n+    tablet_map_t *_tablet_map_array;\n+\n+    RWMutex _partition_tablet_map_lock;\n+    RWMutex _shutdown_tablets_lock;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db846ee07f53ee5310f57cbfca7d17cfbb650e55"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65434e9669a62f210fc987e776503baebf421c86", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/65434e9669a62f210fc987e776503baebf421c86", "committedDate": "2020-03-07T13:04:47Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac7a1914f253bb70bfbfbc9c7b8c1f5a76392940", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/ac7a1914f253bb70bfbfbc9c7b8c1f5a76392940", "committedDate": "2020-03-08T12:52:11Z", "message": "fix ut"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwOTc3NjU2", "url": "https://github.com/apache/incubator-doris/pull/3051#pullrequestreview-370977656", "createdAt": "2020-03-09T08:20:50Z", "commit": {"oid": "ac7a1914f253bb70bfbfbc9c7b8c1f5a76392940"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3515, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}