{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3MTQ5NTkw", "number": 3916, "title": "[Bug] Can not use non-key column as partition column in duplicate table", "bodyText": "The following statement will throw error:\ncreate table test.tbl2\n(k1 int, k2 int, k3 float)\nduplicate key(k1)\npartition by range(k2)\n(partition p1 values less than(\"10\"))\ndistributed by hash(k3) buckets 1\nproperties('replication_num' = '1'); \n\nError: Only key column can be partition column\nBut in duplicate key table, columns can be partition or distribution column\neven if they are not in duplicate keys.\nThis bug is introduced by #3812", "createdAt": "2020-06-19T15:00:47Z", "url": "https://github.com/apache/incubator-doris/pull/3916", "merged": true, "mergeCommit": {"oid": "56bb218148d02fb1db4cea60ac193da0b6600cec"}, "closed": true, "closedAt": "2020-06-22T01:24:22Z", "author": {"login": "morningman"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcs9k6wgH2gAyNDM3MTQ5NTkwOjhiYjA4NWU3MTdiNmZmYzNiYTc1MTI2ZWQzZDcwODU2NzEwZTUxMjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABctXTU4AFqTQzNDQ3Nzg5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8bb085e717b6ffc3ba75126ed3d70856710e5125", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/8bb085e717b6ffc3ba75126ed3d70856710e5125", "committedDate": "2020-06-20T01:43:17Z", "message": "first"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "728b601b1016e3dc5bd96ea6ca880291c88b25fd", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/728b601b1016e3dc5bd96ea6ca880291c88b25fd", "committedDate": "2020-06-20T01:43:17Z", "message": "fix bug"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c72a2846bdaed3c2eca2c6194df30de40a6e7682", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/c72a2846bdaed3c2eca2c6194df30de40a6e7682", "committedDate": "2020-06-19T15:02:50Z", "message": "fix bug"}, "afterCommit": {"oid": "728b601b1016e3dc5bd96ea6ca880291c88b25fd", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/728b601b1016e3dc5bd96ea6ca880291c88b25fd", "committedDate": "2020-06-20T01:43:17Z", "message": "fix bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NDcyMjU2", "url": "https://github.com/apache/incubator-doris/pull/3916#pullrequestreview-434472256", "createdAt": "2020-06-21T05:57:18Z", "commit": {"oid": "728b601b1016e3dc5bd96ea6ca880291c88b25fd"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwNTo1NzoxOVrOGmp3GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwNjowMToxNFrOGmp4Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE4NDkyMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    throw new AnalysisException(\"Only key column can be partition column\");\n          \n          \n            \n                                    throw new AnalysisException(\"The partition column could not be aggregated column\");", "url": "https://github.com/apache/incubator-doris/pull/3916#discussion_r443184920", "createdAt": "2020-06-21T05:57:19Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/analysis/RangePartitionDesc.java", "diffHunk": "@@ -71,9 +72,12 @@ public void analyze(List<ColumnDef> columnDefs, Map<String, String> otherPropert\n             boolean found = false;\n             for (ColumnDef columnDef : columnDefs) {\n                 if (columnDef.getName().equals(partitionCol)) {\n-                    if (!columnDef.isKey()) {\n+                    if (!columnDef.isKey() && columnDef.getAggregateType() != AggregateType.NONE) {\n                         throw new AnalysisException(\"Only key column can be partition column\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "728b601b1016e3dc5bd96ea6ca880291c88b25fd"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE4NTE1NA==", "bodyText": "Why does it need a second check here?", "url": "https://github.com/apache/incubator-doris/pull/3916#discussion_r443185154", "createdAt": "2020-06-21T06:01:14Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/analysis/RangePartitionDesc.java", "diffHunk": "@@ -145,9 +149,14 @@ public PartitionInfo toPartitionInfo(List<Column> schema, Map<String, Long> part\n             boolean find = false;\n             for (Column column : schema) {\n                 if (column.getName().equalsIgnoreCase(colName)) {\n-                    if (!column.isKey()) {\n+                    if (!column.isKey() && column.getAggregationType() != AggregateType.NONE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "728b601b1016e3dc5bd96ea6ca880291c88b25fd"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4a98cd31c75db5f4184bc71eef1162d9540c27a", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/c4a98cd31c75db5f4184bc71eef1162d9540c27a", "committedDate": "2020-06-21T07:14:56Z", "message": "Update fe/src/main/java/org/apache/doris/analysis/RangePartitionDesc.java\n\nCo-authored-by: EmmyMiao87 <522274284@qq.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NDc2NzEw", "url": "https://github.com/apache/incubator-doris/pull/3916#pullrequestreview-434476710", "createdAt": "2020-06-21T07:23:43Z", "commit": {"oid": "c4a98cd31c75db5f4184bc71eef1162d9540c27a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwNzoyMzo0M1rOGmqNEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwNzoyMzo0M1rOGmqNEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5MDU0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    throw new DdlException(\"Partition column[\" + colName + \"] is not key column\");\n          \n          \n            \n                                    throw new DdlException(\"The partition column could not be aggregated column\");", "url": "https://github.com/apache/incubator-doris/pull/3916#discussion_r443190547", "createdAt": "2020-06-21T07:23:43Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/analysis/RangePartitionDesc.java", "diffHunk": "@@ -145,9 +149,14 @@ public PartitionInfo toPartitionInfo(List<Column> schema, Map<String, Long> part\n             boolean find = false;\n             for (Column column : schema) {\n                 if (column.getName().equalsIgnoreCase(colName)) {\n-                    if (!column.isKey()) {\n+                    if (!column.isKey() && column.getAggregationType() != AggregateType.NONE) {\n                         throw new DdlException(\"Partition column[\" + colName + \"] is not key column\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4a98cd31c75db5f4184bc71eef1162d9540c27a"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f3bf7764ff135651df74f475cb953da51294951", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/5f3bf7764ff135651df74f475cb953da51294951", "committedDate": "2020-06-21T07:33:28Z", "message": "Update fe/src/main/java/org/apache/doris/analysis/RangePartitionDesc.java\n\nCo-authored-by: EmmyMiao87 <522274284@qq.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NDc3ODk5", "url": "https://github.com/apache/incubator-doris/pull/3916#pullrequestreview-434477899", "createdAt": "2020-06-21T07:41:36Z", "commit": {"oid": "5f3bf7764ff135651df74f475cb953da51294951"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2614, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}