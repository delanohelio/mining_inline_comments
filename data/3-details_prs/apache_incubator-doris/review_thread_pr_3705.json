{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzODA5MjQ4", "number": 3705, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTo1NzozNFrOEAVZTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzoxOTozMVrOEAY4XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4Nzg1OTk2OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/alter/RollupJobV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTo1NzozNFrOGbjGdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMjozNjozMlrOGbjr9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzOTgzMQ==", "bodyText": "This is not match with what write writes. We should make them consistent.", "url": "https://github.com/apache/incubator-doris/pull/3705#discussion_r431539831", "createdAt": "2020-05-28T01:57:34Z", "author": {"login": "imay"}, "path": "fe/src/main/java/org/apache/doris/alter/RollupJobV2.java", "diffHunk": "@@ -770,4 +714,85 @@ public void setJobState(JobState jobState) {\n         this.jobState = jobState;\n     }\n \n+    private void setColumnsDefineExpr(List<MVColumnItem> items) {\n+        for (MVColumnItem item : items) {\n+            for (Column column : rollupSchema) {\n+                if (column.getName().equals(item.getName())) {\n+                    column.setDefineExpr(item.getDefineExpr());\n+                    break;\n+                }\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void write(DataOutput out) throws IOException {\n+        String json = GsonUtils.GSON.toJson(this, AlterJobV2.class);\n+        Text.writeString(out, json);\n+    }\n+\n+    public static RollupJobV2 read(DataInput in) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a13bc3d286e70794d78d1421cb8778a43c9ffb4"}, "originalPosition": 228}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU0OTQyOA==", "bodyText": "This is also used by the Meta <85. If the Meta is more then 86, the read of AlterJobV2 wil be used.", "url": "https://github.com/apache/incubator-doris/pull/3705#discussion_r431549428", "createdAt": "2020-05-28T02:36:32Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/alter/RollupJobV2.java", "diffHunk": "@@ -770,4 +714,85 @@ public void setJobState(JobState jobState) {\n         this.jobState = jobState;\n     }\n \n+    private void setColumnsDefineExpr(List<MVColumnItem> items) {\n+        for (MVColumnItem item : items) {\n+            for (Column column : rollupSchema) {\n+                if (column.getName().equals(item.getName())) {\n+                    column.setDefineExpr(item.getDefineExpr());\n+                    break;\n+                }\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void write(DataOutput out) throws IOException {\n+        String json = GsonUtils.GSON.toJson(this, AlterJobV2.class);\n+        Text.writeString(out, json);\n+    }\n+\n+    public static RollupJobV2 read(DataInput in) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzOTgzMQ=="}, "originalCommit": {"oid": "9a13bc3d286e70794d78d1421cb8778a43c9ffb4"}, "originalPosition": 228}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4Nzg2NDc2OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeJobV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMjowMDozNFrOGbjJXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMjozODo0MFrOGbjuEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU0MDU3NQ==", "bodyText": "write don't match with readFields", "url": "https://github.com/apache/incubator-doris/pull/3705#discussion_r431540575", "createdAt": "2020-05-28T02:00:34Z", "author": {"login": "imay"}, "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeJobV2.java", "diffHunk": "@@ -1081,14 +969,8 @@ private void readJobFinishedData(DataInput in) throws IOException {\n \n     @Override\n     public void write(DataOutput out) throws IOException {\n-        super.write(out);\n-\n-        out.writeBoolean(isMetaPruned);\n-        if (isMetaPruned) {\n-            writeJobFinishedData(out);\n-        } else {\n-            writeJobNotFinishData(out);\n-        }\n+        String json = GsonUtils.GSON.toJson(this, AlterJobV2.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a13bc3d286e70794d78d1421cb8778a43c9ffb4"}, "originalPosition": 222}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU0OTk3MA==", "bodyText": "I have conducted a compatibility test. The read of AlterJobV2 match the write of RollupJobV2 and SchemaChangeV2", "url": "https://github.com/apache/incubator-doris/pull/3705#discussion_r431549970", "createdAt": "2020-05-28T02:38:40Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeJobV2.java", "diffHunk": "@@ -1081,14 +969,8 @@ private void readJobFinishedData(DataInput in) throws IOException {\n \n     @Override\n     public void write(DataOutput out) throws IOException {\n-        super.write(out);\n-\n-        out.writeBoolean(isMetaPruned);\n-        if (isMetaPruned) {\n-            writeJobFinishedData(out);\n-        } else {\n-            writeJobNotFinishData(out);\n-        }\n+        String json = GsonUtils.GSON.toJson(this, AlterJobV2.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU0MDU3NQ=="}, "originalCommit": {"oid": "9a13bc3d286e70794d78d1421cb8778a43c9ffb4"}, "originalPosition": 222}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NzkzMzA5OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/analysis/StatementBase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMjo0NDoyMVrOGbjzdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMjo0NDoyMVrOGbjzdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU1MTM1MA==", "bodyText": "NULL should be judged in set, it may be too late to judge in get function", "url": "https://github.com/apache/incubator-doris/pull/3705#discussion_r431551350", "createdAt": "2020-05-28T02:44:21Z", "author": {"login": "HangyuanLiu"}, "path": "fe/src/main/java/org/apache/doris/analysis/StatementBase.java", "diffHunk": "@@ -153,7 +156,17 @@ public String getClusterName() {\n \n     public void setClusterName(String clusterName) {\n         this.clusterName = clusterName;\n-    } \n+    }\n+\n+    public void setOrigStmt(OriginStatement origStmt) {\n+        this.origStmt = origStmt;\n+    }\n+\n+    public OriginStatement getOrigStmt() {\n+        Preconditions.checkState(origStmt != null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a13bc3d286e70794d78d1421cb8778a43c9ffb4"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4Nzk0OTMxOnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/catalog/MaterializedIndexMeta.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMjo1NTo0MlrOGbj97Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODowMDo0MlrOGbp8Fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU1NDAyOQ==", "bodyText": "The name defineStmt can easily cause ambiguity with DefineExpr. But this statement may not only parse the semantics of defineExpr in the future\u3002MaterializedViewStmt is a better name ?", "url": "https://github.com/apache/incubator-doris/pull/3705#discussion_r431554029", "createdAt": "2020-05-28T02:55:42Z", "author": {"login": "HangyuanLiu"}, "path": "fe/src/main/java/org/apache/doris/catalog/MaterializedIndexMeta.java", "diffHunk": "@@ -46,9 +55,11 @@\n     private TStorageType storageType;\n     @SerializedName(value = \"keysType\")\n     private KeysType keysType;\n+    @SerializedName(value = \"defineStmt\")\n+    private OriginStatement defineStmt;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a13bc3d286e70794d78d1421cb8778a43c9ffb4"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY1MTg2Mg==", "bodyText": "The define stmt means that this is the definition of materialized views.", "url": "https://github.com/apache/incubator-doris/pull/3705#discussion_r431651862", "createdAt": "2020-05-28T08:00:42Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/catalog/MaterializedIndexMeta.java", "diffHunk": "@@ -46,9 +55,11 @@\n     private TStorageType storageType;\n     @SerializedName(value = \"keysType\")\n     private KeysType keysType;\n+    @SerializedName(value = \"defineStmt\")\n+    private OriginStatement defineStmt;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU1NDAyOQ=="}, "originalCommit": {"oid": "9a13bc3d286e70794d78d1421cb8778a43c9ffb4"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4ODMyOTk2OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/alter/AlterJobV2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNjo0MzoxMlrOGbnoRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzo1OTozNVrOGbp5uA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYxNDAyMA==", "bodyText": "Add else to make logic more explict", "url": "https://github.com/apache/incubator-doris/pull/3705#discussion_r431614020", "createdAt": "2020-05-28T06:43:12Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/alter/AlterJobV2.java", "diffHunk": "@@ -220,16 +233,20 @@ protected boolean checkTableStable(Database db) throws AlterCancelException {\n     public abstract void replay(AlterJobV2 replayedJob);\n \n     public static AlterJobV2 read(DataInput in) throws IOException {\n-        JobType type = JobType.valueOf(Text.readString(in));\n-        switch (type) {\n-            case ROLLUP:\n-                return RollupJobV2.read(in);\n-            case SCHEMA_CHANGE:\n-                return SchemaChangeJobV2.read(in);\n-            default:\n-                Preconditions.checkState(false);\n-                return null;\n+        if (Catalog.getCurrentCatalogJournalVersion() < FeMetaVersion.VERSION_86) {\n+            JobType type = JobType.valueOf(Text.readString(in));\n+            switch (type) {\n+                case ROLLUP:\n+                    return RollupJobV2.read(in);\n+                case SCHEMA_CHANGE:\n+                    return SchemaChangeJobV2.read(in);\n+                default:\n+                    Preconditions.checkState(false);\n+                    return null;\n+            }\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48ffb10d0982a0ecd3aecb2b3b7c662d8340b1c6"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY1MTI1Ng==", "bodyText": "Added", "url": "https://github.com/apache/incubator-doris/pull/3705#discussion_r431651256", "createdAt": "2020-05-28T07:59:35Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/alter/AlterJobV2.java", "diffHunk": "@@ -220,16 +233,20 @@ protected boolean checkTableStable(Database db) throws AlterCancelException {\n     public abstract void replay(AlterJobV2 replayedJob);\n \n     public static AlterJobV2 read(DataInput in) throws IOException {\n-        JobType type = JobType.valueOf(Text.readString(in));\n-        switch (type) {\n-            case ROLLUP:\n-                return RollupJobV2.read(in);\n-            case SCHEMA_CHANGE:\n-                return SchemaChangeJobV2.read(in);\n-            default:\n-                Preconditions.checkState(false);\n-                return null;\n+        if (Catalog.getCurrentCatalogJournalVersion() < FeMetaVersion.VERSION_86) {\n+            JobType type = JobType.valueOf(Text.readString(in));\n+            switch (type) {\n+                case ROLLUP:\n+                    return RollupJobV2.read(in);\n+                case SCHEMA_CHANGE:\n+                    return SchemaChangeJobV2.read(in);\n+                default:\n+                    Preconditions.checkState(false);\n+                    return null;\n+            }\n         }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYxNDAyMA=="}, "originalCommit": {"oid": "48ffb10d0982a0ecd3aecb2b3b7c662d8340b1c6"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4ODQxODIxOnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/analysis/CreateMaterializedViewStmt.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzoxNTowOVrOGbogVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzoxNTowOVrOGbogVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYyODM3NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new AnalysisException(\"The materialized view is disable\");\n          \n          \n            \n                        throw new AnalysisException(\"The materialized view is disabled\");", "url": "https://github.com/apache/incubator-doris/pull/3705#discussion_r431628375", "createdAt": "2020-05-28T07:15:09Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/CreateMaterializedViewStmt.java", "diffHunk": "@@ -100,9 +102,8 @@ public KeysType getMVKeysType() {\n \n     @Override\n     public void analyze(Analyzer analyzer) throws UserException {\n-        // TODO(ml): remove it\n         if (!Config.enable_materialized_view) {\n-            throw new AnalysisException(\"The materialized view is coming soon\");\n+            throw new AnalysisException(\"The materialized view is disable\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48ffb10d0982a0ecd3aecb2b3b7c662d8340b1c6"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4ODQyMTEwOnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/catalog/Column.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzoxNjowOVrOGboiMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzoxNjowOVrOGboiMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYyODg0OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void readFields(DataInput in) throws IOException {\n          \n          \n            \n                private void readFields(DataInput in) throws IOException {", "url": "https://github.com/apache/incubator-doris/pull/3705#discussion_r431628848", "createdAt": "2020-05-28T07:16:09Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/Column.java", "diffHunk": "@@ -411,28 +412,8 @@ public boolean equals(Object obj) {\n \n     @Override\n     public void write(DataOutput out) throws IOException {\n-        Text.writeString(out, name);\n-        ColumnType.write(out, type);\n-        if (null == aggregationType) {\n-            out.writeBoolean(false);\n-        } else {\n-            out.writeBoolean(true);\n-            Text.writeString(out, aggregationType.name());\n-            out.writeBoolean(isAggregationTypeImplicit);\n-        }\n-\n-        out.writeBoolean(isKey);\n-        out.writeBoolean(isAllowNull);\n-\n-        if (defaultValue == null) {\n-            out.writeBoolean(false);\n-        } else {\n-            out.writeBoolean(true);\n-            Text.writeString(out, defaultValue);\n-        }\n-        stats.write(out);\n-\n-        Text.writeString(out, comment);\n+        String json = GsonUtils.GSON.toJson(this);\n+        Text.writeString(out, json);\n     }\n \n     public void readFields(DataInput in) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48ffb10d0982a0ecd3aecb2b3b7c662d8340b1c6"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4ODQzMTAxOnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/qe/DdlExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzoxOTozMVrOGbooXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzoxOTozMVrOGbooXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYzMDQyOQ==", "bodyText": "Parameter ddlStmt.getOrigStmt() is no longer needed, it can be got from loadStmt", "url": "https://github.com/apache/incubator-doris/pull/3705#discussion_r431630429", "createdAt": "2020-05-28T07:19:31Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/qe/DdlExecutor.java", "diffHunk": "@@ -132,7 +131,7 @@ public static void execute(Catalog catalog, DdlStmt ddlStmt, OriginStatement ori\n             if (loadStmt.getVersion().equals(Load.VERSION) || jobType == EtlJobType.HADOOP) {\n                 catalog.getLoadManager().createLoadJobV1FromStmt(loadStmt, jobType, System.currentTimeMillis());\n             } else {\n-                catalog.getLoadManager().createLoadJobFromStmt(loadStmt, origStmt);\n+                catalog.getLoadManager().createLoadJobFromStmt(loadStmt, ddlStmt.getOrigStmt());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48ffb10d0982a0ecd3aecb2b3b7c662d8340b1c6"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1641, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}