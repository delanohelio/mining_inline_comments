{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4NjAyMTI5", "number": 4373, "title": "[Optimize]Optimize the disk selection strategy on BE for tablet creation", "bodyText": "Proposed changes\nWhen creating a tablet, it is necessary to select a disk from all disks that meet the requirements on the BE node to store the tablet. In doris, the current disk selection strategy is to randomly select a disk from all disks that meet the requirements for tablet creation. After the cluster has been running for a long time, we found that the distribution of the number of tablets on different disks in a BE node is unbalanced. In order to solve this problem, we introduced the algorithm of \"two random choices\" for disk selection when creating the tablet:\n(1) Select two disks from all disks that meet the requirements on the BE node randomly\uff1b\n(2) Choose the disk with a smaller number of tablet from the two disks selected in (1) for tablet creation.\nTypes of changes\nWhat types of changes does your code introduce to Doris?\nPut an x in the boxes that apply\n\n[] Bugfix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n[] Breaking change (fix or feature that would cause existing functionality to not work as expected)\n[] Documentation Update (if none of the other choices apply)\n[] Code refactor (Modify the code structure, format the code, etc...)\n\nChecklist\nPut an x in the boxes that apply. You can also fill these out after creating the PR. If you're unsure about any of them, don't hesitate to ask. We're here to help! This is simply a reminder of what we are going to look for before merging your code.\n\n I have create an issue on (Fix #4329), and have described the bug/feature there in detail\n Compiling and unit tests pass locally with my changes\n[] I have added tests that prove my fix is effective or that my feature works\n[] If this change need a document change, I have updated the document\n Any dependent changes have been merged", "createdAt": "2020-08-17T05:58:42Z", "url": "https://github.com/apache/incubator-doris/pull/4373", "merged": true, "mergeCommit": {"oid": "613c44e8890b995bd67c72d82b244823e54c3166"}, "closed": true, "closedAt": "2020-08-26T02:35:33Z", "author": {"login": "weizuo93"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-f6cmgH2gAyNDY4NjAyMTI5OmM4ZjViM2FhOTBjMGNiN2RjMjk3OWViMGNhYzNkZWMyMDlhNmViMTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCYVlhgFqTQ3NDU1NjU0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c8f5b3aa90c0cb7dc2979eb0cac3dec209a6eb18", "author": {"user": {"login": "weizuo93", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/c8f5b3aa90c0cb7dc2979eb0cac3dec209a6eb18", "committedDate": "2020-08-13T13:20:17Z", "message": "Optimize the disk selection strategy on BE for tablet creation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d253542537bb00cd3cb23efdda2f3d7557ab4575", "author": {"user": {"login": "weizuo93", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/d253542537bb00cd3cb23efdda2f3d7557ab4575", "committedDate": "2020-08-13T14:24:41Z", "message": "Optimize the disk selection strategy on BE for tablet creation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDc3OTg1", "url": "https://github.com/apache/incubator-doris/pull/4373#pullrequestreview-471077985", "createdAt": "2020-08-20T02:04:27Z", "commit": {"oid": "d253542537bb00cd3cb23efdda2f3d7557ab4575"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMjowNDoyOFrOHDmOqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMjowNDoyOFrOHDmOqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUzNDEyMg==", "bodyText": "What's the purpose of the this random_shuffle?", "url": "https://github.com/apache/incubator-doris/pull/4373#discussion_r473534122", "createdAt": "2020-08-20T02:04:28Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -428,6 +428,18 @@ std::vector<DataDir*> StorageEngine::get_stores_for_create_tablet(\n     std::random_device rd;\n     srand(rd());\n     std::random_shuffle(stores.begin(), stores.end());\n+    // Two random choices\n+    for (int i = 0; i < stores.size(); i++) {\n+        int j = i + 1;\n+        if (j < stores.size()) {\n+            if (stores[i]->tablet_set().size() > stores[j]->tablet_set().size()) {\n+                std::swap(stores[i], stores[j]);\n+            }\n+            std::random_shuffle(stores.begin() + j, stores.end());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d253542537bb00cd3cb23efdda2f3d7557ab4575"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDkxNTMw", "url": "https://github.com/apache/incubator-doris/pull/4373#pullrequestreview-471091530", "createdAt": "2020-08-20T02:50:29Z", "commit": {"oid": "d253542537bb00cd3cb23efdda2f3d7557ab4575"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMjo1MDoyOVrOHDnlsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMjo1MDoyOVrOHDnlsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU1NjQwMw==", "bodyText": "@weizuo93 you can use std::sort directly, and std::random_shuffle in line 430 is not needed?", "url": "https://github.com/apache/incubator-doris/pull/4373#discussion_r473556403", "createdAt": "2020-08-20T02:50:29Z", "author": {"login": "acelyc111"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -428,6 +428,18 @@ std::vector<DataDir*> StorageEngine::get_stores_for_create_tablet(\n     std::random_device rd;\n     srand(rd());\n     std::random_shuffle(stores.begin(), stores.end());\n+    // Two random choices\n+    for (int i = 0; i < stores.size(); i++) {\n+        int j = i + 1;\n+        if (j < stores.size()) {\n+            if (stores[i]->tablet_set().size() > stores[j]->tablet_set().size()) {\n+                std::swap(stores[i], stores[j]);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d253542537bb00cd3cb23efdda2f3d7557ab4575"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NTU2NTQ4", "url": "https://github.com/apache/incubator-doris/pull/4373#pullrequestreview-474556548", "createdAt": "2020-08-25T14:46:23Z", "commit": {"oid": "d253542537bb00cd3cb23efdda2f3d7557ab4575"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1829, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}