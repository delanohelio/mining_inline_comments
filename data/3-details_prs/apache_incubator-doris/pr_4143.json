{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MDMzMTM5", "number": 4143, "title": "Fix alter schema add key column bug in agg model", "bodyText": "Proposed changes\nFix the bug \"alter schema add key column bug in agg model when using LinkedSchemaChange policy\",  the detail description #4142.\nThe change is when add key column  in agg model , we set sc_directly = true to use SchemaChangeDirectly policy.\nTypes of changes\nWhat types of changes does your code introduce to Doris?\nPut an x in the boxes that apply\n\n Bugfix (non-breaking change which fixes an issue)\n\nChecklist\nPut an x in the boxes that apply. You can also fill these out after creating the PR. If you're unsure about any of them, don't hesitate to ask. We're here to help! This is simply a reminder of what we are going to look for before merging your code.\n\n I have create an issue on Doris's issues, and have described the bug/feature there in detail\n Commit messages in my PR start with the related issues ID, like \"#4071 Add pull request template to doris project\"\n Compiling and unit tests pass locally with my changes\n I have added tests that prove my fix is effective or that my feature works\n If this change need a document change, I have updated the document\n Any dependent changes have been merged", "createdAt": "2020-07-22T10:36:58Z", "url": "https://github.com/apache/incubator-doris/pull/4143", "merged": true, "mergeCommit": {"oid": "f292d8026671ca0c63684bbda9cbf560b9680b20"}, "closed": true, "closedAt": "2020-07-28T12:53:05Z", "author": {"login": "ZhangYu0123"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3XnkOgH2gAyNDU1MDMzMTM5OmMwYjFmODdlNzUyYjQxZWY3YmUyMDNlNGEyZTNjMGY2NjIxMDVlZWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc44YVJAFqTQ1NTQzNzIxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c0b1f87e752b41ef7be203e4a2e3c0f662105eeb", "author": {"user": {"login": "ZhangYu0123", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/c0b1f87e752b41ef7be203e4a2e3c0f662105eeb", "committedDate": "2020-07-22T09:42:57Z", "message": "Fix alter schema add key column bug in agg module"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNzk3Mzcy", "url": "https://github.com/apache/incubator-doris/pull/4143#pullrequestreview-453797372", "createdAt": "2020-07-23T02:02:01Z", "commit": {"oid": "c0b1f87e752b41ef7be203e4a2e3c0f662105eeb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwMjowMjowMVrOG16CDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwMjowMjowMVrOG16CDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE3ODUwOQ==", "bodyText": "this will disable all linked schema in when add key column in agg table, try some better way", "url": "https://github.com/apache/incubator-doris/pull/4143#discussion_r459178509", "createdAt": "2020-07-23T02:02:01Z", "author": {"login": "yangzhg"}, "path": "be/src/olap/schema_change.cpp", "diffHunk": "@@ -2111,6 +2111,11 @@ OLAPStatus SchemaChangeHandler::_parse_request(TabletSharedPtr base_tablet,\n     for (size_t i = 0; i < new_tablet->num_columns(); ++i) {\n         ColumnMapping* column_mapping = rb_changer->get_mutable_column_mapping(i);\n         if (column_mapping->ref_column < 0) {\n+            // check agg model, add key-column operation use sc_directly to build index\n+            if (new_tablet_schema.keys_type() == AGG_KEYS && new_tablet_schema.column(i).is_key()) {\n+                *sc_directly = true;\n+                return OLAP_SUCCESS;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0b1f87e752b41ef7be203e4a2e3c0f662105eeb"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f741397d85903adedf8c2ed10054325abf0a02a0", "author": {"user": {"login": "ZhangYu0123", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/f741397d85903adedf8c2ed10054325abf0a02a0", "committedDate": "2020-07-24T02:51:52Z", "message": "Fix alter schema add key column bug in agg model"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NjEyNTYw", "url": "https://github.com/apache/incubator-doris/pull/4143#pullrequestreview-454612560", "createdAt": "2020-07-24T03:04:37Z", "commit": {"oid": "f741397d85903adedf8c2ed10054325abf0a02a0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMzowNDozN1rOG2h4RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMzowNDozN1rOG2h4RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgzMTM2NA==", "bodyText": "better to make this comment more readable", "url": "https://github.com/apache/incubator-doris/pull/4143#discussion_r459831364", "createdAt": "2020-07-24T03:04:37Z", "author": {"login": "yangzhg"}, "path": "be/src/olap/rowset/segment_group.cpp", "diffHunk": "@@ -268,11 +265,14 @@ OLAPStatus SegmentGroup::add_zone_maps_for_linked_schema_change(\n         WrapperField* second = WrapperField::create(column);\n         DCHECK(second != NULL) << \"failed to allocate memory for field: \" << i;\n \n-        if (schema_mapping[i].ref_column == -1) {\n+        // add column also can add zone map index", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f741397d85903adedf8c2ed10054325abf0a02a0"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NjEzNjEy", "url": "https://github.com/apache/incubator-doris/pull/4143#pullrequestreview-454613612", "createdAt": "2020-07-24T03:10:04Z", "commit": {"oid": "f741397d85903adedf8c2ed10054325abf0a02a0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMzoxMDowNFrOG2h8bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMzoxMDowNFrOG2h8bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgzMjQyOA==", "bodyText": "if you set it to default value\uff0c in duplicated table update from 0.11 to 0.12 may cause value clumn filtered unexpected", "url": "https://github.com/apache/incubator-doris/pull/4143#discussion_r459832428", "createdAt": "2020-07-24T03:10:04Z", "author": {"login": "yangzhg"}, "path": "be/src/olap/rowset/segment_group.cpp", "diffHunk": "@@ -268,11 +265,14 @@ OLAPStatus SegmentGroup::add_zone_maps_for_linked_schema_change(\n         WrapperField* second = WrapperField::create(column);\n         DCHECK(second != NULL) << \"failed to allocate memory for field: \" << i;\n \n-        if (schema_mapping[i].ref_column == -1) {\n+        // add column also can add zone map index\n+        if (schema_mapping[i].ref_column == -1 || i >= zone_map_fields.size()) {\n             // ref_column == -1 means this is a new column.\n             // for new column, use default value to fill into column_statistics\n-            first->copy(schema_mapping[i].default_value);\n-            second->copy(schema_mapping[i].default_value);\n+            if (schema_mapping[i].default_value != nullptr) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f741397d85903adedf8c2ed10054325abf0a02a0"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21670207f3c86dfe592f48bf5ab630bb6d6080ba", "author": {"user": {"login": "ZhangYu0123", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/21670207f3c86dfe592f48bf5ab630bb6d6080ba", "committedDate": "2020-07-24T04:30:55Z", "message": "Fix alter schema add key column bug in agg model"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NjM4MzE0", "url": "https://github.com/apache/incubator-doris/pull/4143#pullrequestreview-454638314", "createdAt": "2020-07-24T05:15:45Z", "commit": {"oid": "21670207f3c86dfe592f48bf5ab630bb6d6080ba"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NDM3MjE3", "url": "https://github.com/apache/incubator-doris/pull/4143#pullrequestreview-455437217", "createdAt": "2020-07-27T02:27:06Z", "commit": {"oid": "21670207f3c86dfe592f48bf5ab630bb6d6080ba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1990, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}