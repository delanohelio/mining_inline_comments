{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNTk3NDE2", "number": 3276, "title": "[refactor] A small refactor on class DataDir", "bodyText": "main refactor points are:\n\nUse a single get_absolute_tablet_path function instead of 3\nindependent functions\nRemove meaningless return value of register_tablet and deregister_tablet\nSome typo and format", "createdAt": "2020-04-08T02:45:00Z", "url": "https://github.com/apache/incubator-doris/pull/3276", "merged": true, "mergeCommit": {"oid": "f39c8b156dd74b2eb5d1ed6fa03ff9477e4ddae3"}, "closed": true, "closedAt": "2020-04-09T16:32:23Z", "author": {"login": "acelyc111"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVehOWAH2gAyNDAwNTk3NDE2Ojg2N2I3YTVmY2JhNWU0Y2E4ZjNhYjI3ZmZlZWIzYWEwNjVkNTRmYjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcV_GrGAFqTM5MDk0ODkxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "867b7a5fcba5e4ca8f3ab27ffeeb3aa065d54fb8", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/867b7a5fcba5e4ca8f3ab27ffeeb3aa065d54fb8", "committedDate": "2020-04-08T02:31:56Z", "message": "[refactor] A small refactor on class DataDir\n\nmain refactor points are:\n- Use a single get_absolute_tablet_path function instead of 3\n  independent functions\n- Remove meaningless return value of register_tablet and deregister_tablet\n- Some typo and format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5Nzc3MjMy", "url": "https://github.com/apache/incubator-doris/pull/3276#pullrequestreview-389777232", "createdAt": "2020-04-08T08:53:47Z", "commit": {"oid": "867b7a5fcba5e4ca8f3ab27ffeeb3aa065d54fb8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwODo1Mzo0N1rOGClcgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwOTowNDoyOFrOGCl4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM2Mzg0MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                _tablet_set.emplace(tablet_info);\n          \n          \n            \n                _tablet_set.emplace(std::move(tablet_info));", "url": "https://github.com/apache/incubator-doris/pull/3276#discussion_r405363840", "createdAt": "2020-04-08T08:53:47Z", "author": {"login": "imay"}, "path": "be/src/olap/data_dir.cpp", "diffHunk": "@@ -395,69 +395,47 @@ OLAPStatus DataDir::get_shard(uint64_t* shard) {\n     return OLAP_SUCCESS;\n }\n \n-OLAPStatus DataDir::register_tablet(Tablet* tablet) {\n-    std::lock_guard<std::mutex> l(_mutex);\n-\n+void DataDir::register_tablet(Tablet* tablet) {\n     TabletInfo tablet_info(tablet->tablet_id(), tablet->schema_hash(), tablet->tablet_uid());\n-    _tablet_set.insert(tablet_info);\n-    return OLAP_SUCCESS;\n-}\n \n-OLAPStatus DataDir::deregister_tablet(Tablet* tablet) {\n     std::lock_guard<std::mutex> l(_mutex);\n+    _tablet_set.emplace(tablet_info);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "867b7a5fcba5e4ca8f3ab27ffeeb3aa065d54fb8"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM3MDkzNw==", "bodyText": "I think it will be better to have a function with argument shard_id, tablet_id and schema_hash. Then there won't be the following functions which do the same thing.\nAnd the string operator + performance is bad, prefer strings::Substitute.", "url": "https://github.com/apache/incubator-doris/pull/3276#discussion_r405370937", "createdAt": "2020-04-08T09:04:28Z", "author": {"login": "imay"}, "path": "be/src/olap/data_dir.cpp", "diffHunk": "@@ -395,69 +395,47 @@ OLAPStatus DataDir::get_shard(uint64_t* shard) {\n     return OLAP_SUCCESS;\n }\n \n-OLAPStatus DataDir::register_tablet(Tablet* tablet) {\n-    std::lock_guard<std::mutex> l(_mutex);\n-\n+void DataDir::register_tablet(Tablet* tablet) {\n     TabletInfo tablet_info(tablet->tablet_id(), tablet->schema_hash(), tablet->tablet_uid());\n-    _tablet_set.insert(tablet_info);\n-    return OLAP_SUCCESS;\n-}\n \n-OLAPStatus DataDir::deregister_tablet(Tablet* tablet) {\n     std::lock_guard<std::mutex> l(_mutex);\n+    _tablet_set.emplace(tablet_info);\n+}\n \n+void DataDir::deregister_tablet(Tablet* tablet) {\n     TabletInfo tablet_info(tablet->tablet_id(), tablet->schema_hash(), tablet->tablet_uid());\n+\n+    std::lock_guard<std::mutex> l(_mutex);\n     _tablet_set.erase(tablet_info);\n-    return OLAP_SUCCESS;\n }\n \n void DataDir::clear_tablets(std::vector<TabletInfo>* tablet_infos) {\n-    for (auto& tablet : _tablet_set) {\n-        tablet_infos->push_back(tablet);\n-    }\n+    std::lock_guard<std::mutex> l(_mutex);\n+\n+    tablet_infos->insert(tablet_infos->end(), _tablet_set.begin(), _tablet_set.end());\n     _tablet_set.clear();\n }\n \n std::string DataDir::get_absolute_shard_path(const std::string& shard_string) {\n     return _path + DATA_PREFIX + \"/\" + shard_string;\n }\n \n-std::string DataDir::get_absolute_tablet_path(TabletMeta* tablet_meta, bool with_schema_hash) {\n+template <typename T>\n+std::string DataDir::get_absolute_tablet_path(const T& tablet_meta, bool with_schema_hash) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "867b7a5fcba5e4ca8f3ab27ffeeb3aa065d54fb8"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6ff6b8d58591df812fa799707577c71947147f3", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/c6ff6b8d58591df812fa799707577c71947147f3", "committedDate": "2020-04-08T16:25:56Z", "message": "Update be/src/olap/data_dir.cpp\n\nCo-Authored-By: ZHAO Chun <buaa.zhaoc@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60e0b44458448a803a28a729a6ef99ddb9452f52", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/60e0b44458448a803a28a729a6ef99ddb9452f52", "committedDate": "2020-04-09T07:07:50Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1765699f47a1493755256a9cec7849db0d424c7f", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/1765699f47a1493755256a9cec7849db0d424c7f", "committedDate": "2020-04-09T07:35:50Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "828690d415e58b196947b6be1803d61ec6a9ae53", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/828690d415e58b196947b6be1803d61ec6a9ae53", "committedDate": "2020-04-09T08:14:39Z", "message": "style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2670639b2e358068a928b82c428141427cd7450e", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/2670639b2e358068a928b82c428141427cd7450e", "committedDate": "2020-04-09T08:24:39Z", "message": "style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwOTQ4OTE4", "url": "https://github.com/apache/incubator-doris/pull/3276#pullrequestreview-390948918", "createdAt": "2020-04-09T16:29:48Z", "commit": {"oid": "2670639b2e358068a928b82c428141427cd7450e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3178, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}