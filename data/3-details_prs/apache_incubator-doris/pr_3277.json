{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNjAwNjQ3", "number": 3277, "title": "[Doris On ES] Support compound_and predicate push down to Elasticsearch", "bodyText": "Relate Issue: #3248\nSQL:\nselect * from test where (k2 = 6 and k3 = 1) or (k2 = 2 and k3 =3 and k4 = 'beijing');\n\nOutput filter:\n((#k2:[6 TO 6] #k3:[1 TO 1]) (#(#k2:[2 TO 2] #k3:[3 TO 3]) #k4:beijing))~1\n\nSQL:\nselect * from test where (k2 = 6 or k3 = 7) or (k2 = 2 and k3 =3 and (k4 = 'beijing' or k4 = 'zhaochun'));\n\nOutput filter:\n(k2:[6 TO 6] k3:[7 TO 7] (#(#k2:[2 TO 2] #k3:[3 TO 3]) #((k4:beijing k4:zhaochun)~1)))~1\n\nSQL:\nselect * from test where (k2 = 6 or k3 = 7) or (k2 = 2 and abs(k3) =3 and (k4 = 'beijing' or k4 = 'zhaochun'));\n\nOutput filter (abs can not be pushed down to es, so doris on es would not process this scenario ):\nmatch_all", "createdAt": "2020-04-08T02:58:12Z", "url": "https://github.com/apache/incubator-doris/pull/3277", "merged": true, "mergeCommit": {"oid": "614a76beeac73821c78903c46e7a703b7956796b"}, "closed": true, "closedAt": "2020-04-08T13:09:40Z", "author": {"login": "wuyunfeng"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVfMOTAH2gAyNDAwNjAwNjQ3OjBlOTRjMmM0MjhiODQ0MjM1YjljZTU4YTU2NzEzZWExZWZlNTVlMjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVmbKOgFqTM4OTg5NjAzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0e94c2c428b844235b9ce58a56713ea1efe55e25", "author": {"user": {"login": "wuyunfeng", "name": "Yunfeng,Wu"}}, "url": "https://github.com/apache/incubator-doris/commit/0e94c2c428b844235b9ce58a56713ea1efe55e25", "committedDate": "2020-04-08T03:18:54Z", "message": "[Doris On ES] Support compound_and push down"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd2d9f692ec3eb9a66422b18092894ef89372f1e", "author": {"user": {"login": "wuyunfeng", "name": "Yunfeng,Wu"}}, "url": "https://github.com/apache/incubator-doris/commit/bd2d9f692ec3eb9a66422b18092894ef89372f1e", "committedDate": "2020-04-08T02:52:44Z", "message": "[Doris On ES] Support compound_and push down"}, "afterCommit": {"oid": "0e94c2c428b844235b9ce58a56713ea1efe55e25", "author": {"user": {"login": "wuyunfeng", "name": "Yunfeng,Wu"}}, "url": "https://github.com/apache/incubator-doris/commit/0e94c2c428b844235b9ce58a56713ea1efe55e25", "committedDate": "2020-04-08T03:18:54Z", "message": "[Doris On ES] Support compound_and push down"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "267bc41bd21636fb15845f5288730fe01ec8f46f", "author": {"user": {"login": "wuyunfeng", "name": "Yunfeng,Wu"}}, "url": "https://github.com/apache/incubator-doris/commit/267bc41bd21636fb15845f5288730fe01ec8f46f", "committedDate": "2020-04-08T03:26:53Z", "message": "format some code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NjM4NDQ4", "url": "https://github.com/apache/incubator-doris/pull/3277#pullrequestreview-389638448", "createdAt": "2020-04-08T04:04:57Z", "commit": {"oid": "267bc41bd21636fb15845f5288730fe01ec8f46f"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNDowNDo1OFrOGCeP2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNDoyNjo1MFrOGCejVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0NTkxNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                ExtCompAndPredicates(std::vector<EsPredicate*> conjuncts) : ExtPredicate(TExprNodeType::COMPOUND_PRED), op(TExprOpcode::COMPOUND_AND), conjuncts(conjuncts) {\n          \n          \n            \n                ExtCompAndPredicates(const std::vector<EsPredicate*>& conjuncts) : ExtPredicate(TExprNodeType::COMPOUND_PRED), op(TExprOpcode::COMPOUND_AND), conjuncts(conjuncts) {", "url": "https://github.com/apache/incubator-doris/pull/3277#discussion_r405245915", "createdAt": "2020-04-08T04:04:58Z", "author": {"login": "imay"}, "path": "be/src/exec/es/es_predicate.h", "diffHunk": "@@ -85,6 +86,15 @@ struct ExtPredicate {\n     TExprNodeType::type node_type;\n };\n \n+// this used for placeholder for compound_and\n+struct ExtCompAndPredicates : public ExtPredicate {\n+    ExtCompAndPredicates(std::vector<EsPredicate*> conjuncts) : ExtPredicate(TExprNodeType::COMPOUND_PRED), op(TExprOpcode::COMPOUND_AND), conjuncts(conjuncts) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "267bc41bd21636fb15845f5288730fe01ec8f46f"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0NjgxNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (TExprOpcode::COMPOUND_AND == conjunct->op()) {\n          \n          \n            \n                        if (conjunct->op() == TExprOpcode::COMPOUND_AND) {", "url": "https://github.com/apache/incubator-doris/pull/3277#discussion_r405246814", "createdAt": "2020-04-08T04:09:01Z", "author": {"login": "imay"}, "path": "be/src/exec/es/es_predicate.cpp", "diffHunk": "@@ -384,10 +390,27 @@ Status EsPredicate::build_disjuncts_list(const Expr* conjunct) {\n         _disjuncts.push_back(predicate);\n \n         return Status::OK();\n-    } \n-    \n+    }\n     if (TExprNodeType::COMPOUND_PRED == conjunct->node_type()) {\n         if (TExprOpcode::COMPOUND_OR != conjunct->op()) {\n+            // processe COMPOUND_AND, such as:\n+            // k = 1 or (k1 = 7 and (k2 in (6,7) or k3 = 12))\n+            // k1 = 7 and (k2 in (6,7) or k3 = 12) is compound pred, we should rebuild this sub tree\n+            if (TExprOpcode::COMPOUND_AND == conjunct->op()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "267bc41bd21636fb15845f5288730fe01ec8f46f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0OTcyMg==", "bodyText": "better to add a break clause here.", "url": "https://github.com/apache/incubator-doris/pull/3277#discussion_r405249722", "createdAt": "2020-04-08T04:21:54Z", "author": {"login": "imay"}, "path": "be/src/exec/es/es_query_builder.cpp", "diffHunk": "@@ -359,6 +370,17 @@ void BooleanQueryBuilder::validate(const std::vector<EsPredicate*>& espredicates\n                     }\n                     break;\n                 }\n+                case TExprNodeType::COMPOUND_PRED: {\n+                    ExtCompAndPredicates* compound_predicates = (ExtCompAndPredicates *)predicate;\n+                    std::vector<bool> list;\n+                    validate(compound_predicates->conjuncts, &list);\n+                    for(int i = list.size() - 1; i >= 0; i--) {\n+                        if(!list[i]) {\n+                            flag = false;\n+                            break;\n+                        }\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "267bc41bd21636fb15845f5288730fe01ec8f46f"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI1MDkwMg==", "bodyText": "There are three possibilities here. AND, OR, NOT, For me, NOT can be supported too.\nAnd you can do as follow\nif (conjunct->op() == AND)\nelse if (conjunct->op() == NOT)\n\nDCHECK(op() == OR)\n// handle OR", "url": "https://github.com/apache/incubator-doris/pull/3277#discussion_r405250902", "createdAt": "2020-04-08T04:26:50Z", "author": {"login": "imay"}, "path": "be/src/exec/es/es_predicate.cpp", "diffHunk": "@@ -384,10 +390,27 @@ Status EsPredicate::build_disjuncts_list(const Expr* conjunct) {\n         _disjuncts.push_back(predicate);\n \n         return Status::OK();\n-    } \n-    \n+    }\n     if (TExprNodeType::COMPOUND_PRED == conjunct->node_type()) {\n         if (TExprOpcode::COMPOUND_OR != conjunct->op()) {\n+            // processe COMPOUND_AND, such as:\n+            // k = 1 or (k1 = 7 and (k2 in (6,7) or k3 = 12))\n+            // k1 = 7 and (k2 in (6,7) or k3 = 12) is compound pred, we should rebuild this sub tree\n+            if (TExprOpcode::COMPOUND_AND == conjunct->op()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "267bc41bd21636fb15845f5288730fe01ec8f46f"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "466e2679193474b7585bca42eb48602561c2530c", "author": {"user": {"login": "wuyunfeng", "name": "Yunfeng,Wu"}}, "url": "https://github.com/apache/incubator-doris/commit/466e2679193474b7585bca42eb48602561c2530c", "committedDate": "2020-04-08T05:21:06Z", "message": "modify some code and reformat"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5Nzc1OTU5", "url": "https://github.com/apache/incubator-doris/pull/3277#pullrequestreview-389775959", "createdAt": "2020-04-08T08:52:10Z", "commit": {"oid": "466e2679193474b7585bca42eb48602561c2530c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50c288205177e4331c79c3442af0325d54b3ab1b", "author": {"user": {"login": "wuyunfeng", "name": "Yunfeng,Wu"}}, "url": "https://github.com/apache/incubator-doris/commit/50c288205177e4331c79c3442af0325d54b3ab1b", "committedDate": "2020-04-08T11:17:42Z", "message": "Add UT for compound and query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5ODk2MDM5", "url": "https://github.com/apache/incubator-doris/pull/3277#pullrequestreview-389896039", "createdAt": "2020-04-08T11:44:33Z", "commit": {"oid": "50c288205177e4331c79c3442af0325d54b3ab1b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3181, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}