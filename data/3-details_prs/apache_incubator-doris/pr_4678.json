{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzNjg1OTQx", "number": 4678, "title": "[Bug] Fix hard cardinality check which makes queries fail", "bodyText": "Proposed changes\n#4581\nfix hard Preconditions.checkState() by setting cardinality to -1 when computation is invalid.\nTypes of changes\n\n Bugfix (non-breaking change which fixes an issue)\n[] New feature (non-breaking change which adds functionality)\n[] Breaking change (fix or feature that would cause existing functionality to not work as expected)\n[] Documentation Update (if none of the other choices apply)\n[] Code refactor (Modify the code structure, format the code, etc...)\n\nChecklist\n\n I have create an issue on (Fix #4581), and have described the bug/feature there in detail\n Compiling and unit tests pass locally with my changes\n[] I have added tests that prove my fix is effective or that my feature works\n[] If this change need a document change, I have updated the document\n Any dependent changes have been merged", "createdAt": "2020-09-27T07:53:14Z", "url": "https://github.com/apache/incubator-doris/pull/4678", "merged": true, "mergeCommit": {"oid": "c69fe23c423218c7b3543d9aa146111054fae913"}, "closed": true, "closedAt": "2020-10-13T02:07:23Z", "author": {"login": "ccoffline"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdM34WJgH2gAyNDkzNjg1OTQxOjZmMzk4NGZjNzU1ZGUzMjQxMmMxMmE3ZjA2ZTJlNzJkNjhmNDcxYmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdR1QingFqTUwNjY5NDM5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6f3984fc755de32412c12a7f06e2e72d68f471bf", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/6f3984fc755de32412c12a7f06e2e72d68f471bf", "committedDate": "2020-09-27T05:10:39Z", "message": "fix hard cardinality check which makes the queries fail"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNTg1NzY4", "url": "https://github.com/apache/incubator-doris/pull/4678#pullrequestreview-501585768", "createdAt": "2020-10-04T02:21:14Z", "commit": {"oid": "6f3984fc755de32412c12a7f06e2e72d68f471bf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQwMjoyMToxNFrOHcEqJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQwMjoyMToxNFrOHcEqJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE5ODUwMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LOG.info(\"stats Select: cardinality={}\", this.cardinality);\n          \n          \n            \n                    LOG.debug(\"stats Select: cardinality={}\", this.cardinality);", "url": "https://github.com/apache/incubator-doris/pull/4678#discussion_r499198500", "createdAt": "2020-10-04T02:21:14Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/planner/SelectNode.java", "diffHunk": "@@ -63,13 +62,14 @@ public void init(Analyzer analyzer) throws UserException {\n     @Override\n     public void computeStats(Analyzer analyzer) {\n         super.computeStats(analyzer);\n-        if (getChild(0).cardinality == -1) {\n-            cardinality = -1;\n+        long cardinality = getChild(0).cardinality;\n+        double selectivity = computeSelectivity();\n+        if (cardinality < 0 || selectivity < 0) {\n+            this.cardinality = -1;\n         } else {\n-            cardinality = Math.round(((double) getChild(0).cardinality) * computeSelectivity());\n-            Preconditions.checkState(cardinality >= 0);\n+            this.cardinality = Math.round(cardinality * selectivity);\n         }\n-        LOG.info(\"stats Select: cardinality=\" + Long.toString(cardinality));\n+        LOG.info(\"stats Select: cardinality={}\", this.cardinality);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f3984fc755de32412c12a7f06e2e72d68f471bf"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "821b5a654c7a2f0f6a04a4c593109927c82e1a07", "author": {"user": {"login": "ccoffline", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/821b5a654c7a2f0f6a04a4c593109927c82e1a07", "committedDate": "2020-10-09T03:09:11Z", "message": "Update fe/fe-core/src/main/java/org/apache/doris/planner/SelectNode.java\n\nCo-authored-by: Mingyu Chen <morningman.cmy@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2Njk0Mzk5", "url": "https://github.com/apache/incubator-doris/pull/4678#pullrequestreview-506694399", "createdAt": "2020-10-12T14:56:59Z", "commit": {"oid": "821b5a654c7a2f0f6a04a4c593109927c82e1a07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4699, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}