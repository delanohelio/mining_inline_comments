{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3Njk2NDU3", "number": 3106, "title": "[Alter] Alter job got stuck because of table is untable", "bodyText": "This CL solve the issue #3105\nI add a new temporary table state WAITING_STABLE.\nWhen an alter job is ready to start, it checks whether the table is stable. If it is not stable,\nthe table state is set to WAITING_STABLE. In this state, the tablet repair logic will continue to\nrepair the tablet until the table becomes stable.\nAfter that, the table state will be reset to SCHEMA_CHANGE/ROLLUP and alter operations will begin.\nThis is just a temporary state, it does not need to be persistent, and only the master FE can see this state.", "createdAt": "2020-03-13T10:15:37Z", "url": "https://github.com/apache/incubator-doris/pull/3106", "merged": true, "mergeCommit": {"oid": "e01850e6eca85b68458717bb3256b0d827bfd26d"}, "closed": true, "closedAt": "2020-03-14T15:48:37Z", "author": {"login": "morningman"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNMBaVAH2gAyMzg3Njk2NDU3OjEyNjk1MjllYmUxZjQzODc5NzU4MzYwNDA4ZGI5ZTdiYmJiY2Q0YTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNmCojAFqTM3NDczMTU1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1269529ebe1f43879758360408db9e7bbbbcd4a5", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/1269529ebe1f43879758360408db9e7bbbbcd4a5", "committedDate": "2020-03-13T08:27:30Z", "message": "1"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MjExMzgx", "url": "https://github.com/apache/incubator-doris/pull/3106#pullrequestreview-374211381", "createdAt": "2020-03-13T10:58:43Z", "commit": {"oid": "1269529ebe1f43879758360408db9e7bbbbcd4a5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMDo1ODo0M1rOF1_isQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMDo1ODo0M1rOF1_isQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE1OTkyMQ==", "bodyText": "Could we reduce the write lock scope? because the tbl.isStable and CreateReplicaTask both need to iterate every replica.", "url": "https://github.com/apache/incubator-doris/pull/3106#discussion_r392159921", "createdAt": "2020-03-13T10:58:43Z", "author": {"login": "kangkaisen"}, "path": "fe/src/main/java/org/apache/doris/alter/RollupJobV2.java", "diffHunk": "@@ -162,7 +162,7 @@ protected void runPendingJob() throws AlterCancelException {\n             }\n         }\n         MarkedCountDownLatch<Long, Long> countDownLatch = new MarkedCountDownLatch<Long, Long>(totalReplicaNum);\n-        db.readLock();\n+        db.writeLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1269529ebe1f43879758360408db9e7bbbbcd4a5"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96b8a0f49c5bbbf44206ff06c28a2f41528a43dc", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/96b8a0f49c5bbbf44206ff06c28a2f41528a43dc", "committedDate": "2020-03-13T13:39:45Z", "message": "fix by review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0Mzg4NDUy", "url": "https://github.com/apache/incubator-doris/pull/3106#pullrequestreview-374388452", "createdAt": "2020-03-13T15:21:04Z", "commit": {"oid": "96b8a0f49c5bbbf44206ff06c28a2f41528a43dc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNToyMTowNFrOF2Hxnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNToyMTowNFrOF2Hxnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI5NDgxNQ==", "bodyText": "Should still use db.readLock.", "url": "https://github.com/apache/incubator-doris/pull/3106#discussion_r392294815", "createdAt": "2020-03-13T15:21:04Z", "author": {"login": "kangkaisen"}, "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeJobV2.java", "diffHunk": "@@ -185,22 +189,13 @@ protected void runPendingJob() throws AlterCancelException {\n             }\n         }\n         MarkedCountDownLatch<Long, Long> countDownLatch = new MarkedCountDownLatch<>(totalReplicaNum);\n-        db.readLock();\n+        db.writeLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96b8a0f49c5bbbf44206ff06c28a2f41528a43dc"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "360ede6cf3a378bc99a5759e360597cf59d7e2c2", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/360ede6cf3a378bc99a5759e360597cf59d7e2c2", "committedDate": "2020-03-14T13:01:35Z", "message": "fix log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NzMxNTU1", "url": "https://github.com/apache/incubator-doris/pull/3106#pullrequestreview-374731555", "createdAt": "2020-03-14T14:46:22Z", "commit": {"oid": "360ede6cf3a378bc99a5759e360597cf59d7e2c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3581, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}