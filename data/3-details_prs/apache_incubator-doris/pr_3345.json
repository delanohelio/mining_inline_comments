{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1MDUxMjUw", "number": 3345, "title": "[FIX] fix doris string functions not support multibyte string", "bodyText": "fixes the bug describe in  #3332 , doris string functions not support utf8 strings", "createdAt": "2020-04-17T10:25:20Z", "url": "https://github.com/apache/incubator-doris/pull/3345", "merged": true, "mergeCommit": {"oid": "94b3a2bd501aa6c6e1f29f3c3ee5dafcf1256e3c"}, "closed": true, "closedAt": "2020-05-08T04:52:46Z", "author": {"login": "yangzhg"}, "timelineItems": {"totalCount": 35, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYfHPlAFqTM5NTM1MjU4Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABce_utfgFqTQwNzYzMTc1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MzUyNTgz", "url": "https://github.com/apache/incubator-doris/pull/3345#pullrequestreview-395352583", "createdAt": "2020-04-17T10:48:26Z", "commit": {"oid": "14e4008b73281195f86e19d623339e135c14d87d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMDo0ODoyN1rOGHJQxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMDo1NDo1NVrOGHJcDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE0NDk2Ng==", "bodyText": "Is this only valid for UTF8 encode?\nIf it is, better to rename utf8_length.", "url": "https://github.com/apache/incubator-doris/pull/3345#discussion_r410144966", "createdAt": "2020-04-17T10:48:27Z", "author": {"login": "imay"}, "path": "be/src/exprs/string_functions.cpp", "diffHunk": "@@ -223,6 +259,36 @@ IntVal StringFunctions::length(FunctionContext* context, const StringVal& str) {\n     return IntVal(str.len);\n }\n \n+// Implementation of CHAR_LENGTH\n+//   int char_length(string input)\n+// Returns the length of charactors of input. If input == NULL, returns\n+// NULL per MySQL\n+IntVal StringFunctions::char_length(FunctionContext* context, const StringVal& str) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14e4008b73281195f86e19d623339e135c14d87d"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE0Nzg1Mg==", "bodyText": "Can you write a function and to reuse it?", "url": "https://github.com/apache/incubator-doris/pull/3345#discussion_r410147852", "createdAt": "2020-04-17T10:54:55Z", "author": {"login": "imay"}, "path": "be/src/exprs/string_functions.cpp", "diffHunk": "@@ -266,7 +332,25 @@ StringVal StringFunctions::reverse(FunctionContext* context, const StringVal& st\n     if (UNLIKELY(result.is_null)) {\n         return result;\n     }\n-    std::reverse_copy(str.ptr, str.ptr + str.len, result.ptr);\n+\n+    for (size_t i = 0, char_size = 0; i < str.len; i += char_size) {\n+        unsigned char byte = (unsigned)(str.ptr)[i];\n+        if (byte >= 0xFC) {\n+            char_size = 6;\n+        } else if (byte >= 0xF8) {\n+            char_size = 5;\n+        } else if (byte >= 0xF0) {\n+            char_size = 4;\n+        } else if (byte >= 0xE0) {\n+            char_size = 3;\n+        } else if (byte >= 0xC0) {\n+            char_size = 2;\n+        } else {\n+            char_size = 1;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14e4008b73281195f86e19d623339e135c14d87d"}, "originalPosition": 152}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NTA1NTg1", "url": "https://github.com/apache/incubator-doris/pull/3345#pullrequestreview-395505585", "createdAt": "2020-04-17T14:30:31Z", "commit": {"oid": "14e4008b73281195f86e19d623339e135c14d87d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNDozMDozMVrOGHQZXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNDozMDozMVrOGHQZXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2MTg1NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // index save ervery charactor's length\n          \n          \n            \n                // index save every character's length", "url": "https://github.com/apache/incubator-doris/pull/3345#discussion_r410261854", "createdAt": "2020-04-17T14:30:31Z", "author": {"login": "morningman"}, "path": "be/src/exprs/string_functions.cpp", "diffHunk": "@@ -37,19 +37,55 @@ void StringFunctions::init() {\n //  - supported negative positions (count from the end of the string)\n //  - [optional] len.  No len indicates longest substr possible\n StringVal StringFunctions::substring(\n-        FunctionContext* context, const StringVal& str, \n+        FunctionContext* context, const StringVal& str,\n         const IntVal& pos, const IntVal& len) {\n     if (str.is_null || pos.is_null || len.is_null) {\n         return StringVal::null();\n     }\n+    if (len.val <= 0 || str.len == 0) {\n+        return StringVal();\n+    }\n+\n+    // create index indicate every char start byte\n+    // e.g.  \"hello word \u4f60\u597d\" => [0,1,2,3,4,5,6,7,8,9,10,11,14] \u4f60 and \u597d are 3 bytes\n+    // why use a vector as index? if theres is no negative pos val it is unnecessary,\n+    // but if has pos is negative it is not easy to determin where to start, so need a \n+    // index save ervery charactor's length", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14e4008b73281195f86e19d623339e135c14d87d"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79294a3ada9cdeed0b873e10672b38ea4ea0ae2a", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/79294a3ada9cdeed0b873e10672b38ea4ea0ae2a", "committedDate": "2020-04-20T04:27:43Z", "message": "fix typo and rename function"}, "afterCommit": {"oid": "1f03432423f2fa9f8d9961cf185e4366365b7e68", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/1f03432423f2fa9f8d9961cf185e4366365b7e68", "committedDate": "2020-04-20T06:49:19Z", "message": "[FIX] fix when string contains some characters that span multiple bytes, cannot be handler correctly"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDEyNzUy", "url": "https://github.com/apache/incubator-doris/pull/3345#pullrequestreview-397412752", "createdAt": "2020-04-21T14:53:50Z", "commit": {"oid": "5ee1bcae2ec5a8f0f7699f8af3fe6e6f9d07b89e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNDo1Mzo1MFrOGJKKIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNDo1ODoyNFrOGJKaAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI1NjgwMw==", "bodyText": "Can an optimization be done here?\n\nDetermine first, when pos is positive and greater than the length of str, return null directly, without for loop.\nWhen pos is positive, can the for loop terminate after pos + len cycles? Instead of looping until the end of str?", "url": "https://github.com/apache/incubator-doris/pull/3345#discussion_r412256803", "createdAt": "2020-04-21T14:53:50Z", "author": {"login": "morningman"}, "path": "be/src/exprs/string_functions.cpp", "diffHunk": "@@ -19,37 +19,78 @@\n \n #include <re2/re2.h>\n \n-#include \"exprs/expr.h\"\n #include \"exprs/anyval_util.h\"\n+#include \"exprs/expr.h\"\n+#include \"math_functions.h\"\n #include \"runtime/string_value.hpp\"\n #include \"runtime/tuple_row.h\"\n #include \"util/url_parser.h\"\n-#include \"math_functions.h\"\n \n // NOTE: be careful not to use string::append.  It is not performant.\n namespace doris {\n \n void StringFunctions::init() {\n }\n \n+size_t get_utf8_byte_length(unsigned char byte) {\n+    size_t char_size = 0;\n+    if (byte >= 0xFC) {\n+        char_size = 6;\n+    } else if (byte >= 0xF8) {\n+        char_size = 5;\n+    } else if (byte >= 0xF0) {\n+        char_size = 4;\n+    } else if (byte >= 0xE0) {\n+        char_size = 3;\n+    } else if (byte >= 0xC0) {\n+        char_size = 2;\n+    } else {\n+        char_size = 1;\n+    }\n+    return char_size;\n+}\n+\n // This behaves identically to the mysql implementation, namely:\n //  - 1-indexed positions\n //  - supported negative positions (count from the end of the string)\n //  - [optional] len.  No len indicates longest substr possible\n StringVal StringFunctions::substring(\n-        FunctionContext* context, const StringVal& str, \n+        FunctionContext* context, const StringVal& str,\n         const IntVal& pos, const IntVal& len) {\n     if (str.is_null || pos.is_null || len.is_null) {\n         return StringVal::null();\n     }\n+    if (len.val <= 0 || str.len == 0) {\n+        return StringVal();\n+    }\n+\n+    // create index indicate every char start byte\n+    // e.g.  \"hello word \u4f60\u597d\" => [0,1,2,3,4,5,6,7,8,9,10,11,14] \u4f60 and \u597d are 3 bytes\n+    // why use a vector as index? It is unnecessary if there is no negative pos val,\n+    // but if has pos is negative it is not easy to determin where to start, so need a \n+    // index save every character's length\n+    size_t byte_pos = 0;\n+    std::vector<size_t> index;\n+    for (size_t i = 0, char_size = 0; i < str.len; i += char_size) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ee1bcae2ec5a8f0f7699f8af3fe6e6f9d07b89e"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI1ODYwMA==", "bodyText": "should it be char_length_utf8", "url": "https://github.com/apache/incubator-doris/pull/3345#discussion_r412258600", "createdAt": "2020-04-21T14:55:54Z", "author": {"login": "morningman"}, "path": "docs/documentation/cn/sql-reference/sql-functions/string-functions/char_length_utf8.md", "diffHunk": "@@ -0,0 +1,47 @@\n+<!-- \n+Licensed to the Apache Software Foundation (ASF) under one\n+or more contributor license agreements.  See the NOTICE file\n+distributed with this work for additional information\n+regarding copyright ownership.  The ASF licenses this file\n+to you under the Apache License, Version 2.0 (the\n+\"License\"); you may not use this file except in compliance\n+with the License.  You may obtain a copy of the License at\n+\n+  http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing,\n+software distributed under the License is distributed on an\n+\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+KIND, either express or implied.  See the License for the\n+specific language governing permissions and limitations\n+under the License.\n+-->\n+\n+# length", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ee1bcae2ec5a8f0f7699f8af3fe6e6f9d07b89e"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI1ODk0OQ==", "bodyText": "Should it be 2?", "url": "https://github.com/apache/incubator-doris/pull/3345#discussion_r412258949", "createdAt": "2020-04-21T14:56:13Z", "author": {"login": "morningman"}, "path": "docs/documentation/cn/sql-reference/sql-functions/string-functions/char_length_utf8.md", "diffHunk": "@@ -0,0 +1,47 @@\n+<!-- \n+Licensed to the Apache Software Foundation (ASF) under one\n+or more contributor license agreements.  See the NOTICE file\n+distributed with this work for additional information\n+regarding copyright ownership.  The ASF licenses this file\n+to you under the Apache License, Version 2.0 (the\n+\"License\"); you may not use this file except in compliance\n+with the License.  You may obtain a copy of the License at\n+\n+  http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing,\n+software distributed under the License is distributed on an\n+\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+KIND, either express or implied.  See the License for the\n+specific language governing permissions and limitations\n+under the License.\n+-->\n+\n+# length\n+## description\n+### Syntax\n+\n+`INT char_length_utf8(VARCHAR str)`\n+\n+\n+\u8fd4\u56de\u5b57\u7b26\u4e32\u7684\u957f\u5ea6\uff0c\u5bf9\u4e8e\u591a\u5b57\u8282\u5b57\u7b26\uff0c\u8fd4\u56de\u7684\u5b57\u7b26\u6570\u3002\n+\n+## example\n+\n+```\n+mysql> select length(\"abc\");\n++---------------+\n+| length('abc') |\n++---------------+\n+|             3 |\n++---------------+\n+\n+mysql> select length(\"\u4e2d\u56fd\");\n++------------------+\n+| length('\u4e2d\u56fd')   |\n++------------------+\n+|                6 |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ee1bcae2ec5a8f0f7699f8af3fe6e6f9d07b89e"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI2MDg2Ng==", "bodyText": "Why using this type?", "url": "https://github.com/apache/incubator-doris/pull/3345#discussion_r412260866", "createdAt": "2020-04-21T14:58:24Z", "author": {"login": "morningman"}, "path": "run-ut.sh", "diffHunk": "@@ -24,6 +24,7 @@ ROOT=`cd \"$ROOT\"; pwd`\n export DORIS_HOME=${ROOT}\n \n . ${DORIS_HOME}/env.sh\n+export BUILD_TYPE=DEBUG", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ee1bcae2ec5a8f0f7699f8af3fe6e6f9d07b89e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDQwNzU5", "url": "https://github.com/apache/incubator-doris/pull/3345#pullrequestreview-397440759", "createdAt": "2020-04-21T15:22:36Z", "commit": {"oid": "5ee1bcae2ec5a8f0f7699f8af3fe6e6f9d07b89e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNToyMjozNlrOGJLrIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNToyMjozNlrOGJLrIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI4MTYzMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \u8fd4\u56de\u5b57\u7b26\u4e32\u7684\u957f\u5ea6\uff0c\u5bf9\u4e8e\u591a\u5b57\u8282\u5b57\u7b26\uff0c\u8fd4\u56de\u7684\u5b57\u7b26\u6570\u3002\n          \n          \n            \n            \u8fd4\u56de\u5b57\u7b26\u4e32\u7684\u957f\u5ea6\uff0c\u5bf9\u4e8e\u591a\u5b57\u8282\u5b57\u7b26\uff0c\u8fd4\u56de\u5b57\u7b26\u6570\u3002", "url": "https://github.com/apache/incubator-doris/pull/3345#discussion_r412281633", "createdAt": "2020-04-21T15:22:36Z", "author": {"login": "wutiangan"}, "path": "docs/documentation/cn/sql-reference/sql-functions/string-functions/char_length_utf8.md", "diffHunk": "@@ -0,0 +1,47 @@\n+<!-- \n+Licensed to the Apache Software Foundation (ASF) under one\n+or more contributor license agreements.  See the NOTICE file\n+distributed with this work for additional information\n+regarding copyright ownership.  The ASF licenses this file\n+to you under the Apache License, Version 2.0 (the\n+\"License\"); you may not use this file except in compliance\n+with the License.  You may obtain a copy of the License at\n+\n+  http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing,\n+software distributed under the License is distributed on an\n+\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+KIND, either express or implied.  See the License for the\n+specific language governing permissions and limitations\n+under the License.\n+-->\n+\n+# length\n+## description\n+### Syntax\n+\n+`INT char_length_utf8(VARCHAR str)`\n+\n+\n+\u8fd4\u56de\u5b57\u7b26\u4e32\u7684\u957f\u5ea6\uff0c\u5bf9\u4e8e\u591a\u5b57\u8282\u5b57\u7b26\uff0c\u8fd4\u56de\u7684\u5b57\u7b26\u6570\u3002", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ee1bcae2ec5a8f0f7699f8af3fe6e6f9d07b89e"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDQyMDc1", "url": "https://github.com/apache/incubator-doris/pull/3345#pullrequestreview-397442075", "createdAt": "2020-04-21T15:24:02Z", "commit": {"oid": "5ee1bcae2ec5a8f0f7699f8af3fe6e6f9d07b89e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNToyNDowMlrOGJLvyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNToyNDowMlrOGJLvyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI4MjgyNw==", "bodyText": "\u8fd4\u56de\u5b57\u7b26\u4e32\u7684\u5b57\u8282\u6570", "url": "https://github.com/apache/incubator-doris/pull/3345#discussion_r412282827", "createdAt": "2020-04-21T15:24:02Z", "author": {"login": "wutiangan"}, "path": "docs/documentation/cn/sql-reference/sql-functions/string-functions/length.md", "diffHunk": "@@ -24,7 +24,7 @@ under the License.\n `INT length(VARCHAR str)`\n \n \n-\u8fd4\u56de\u5b57\u7b26\u4e32\u7684\u957f\u5ea6\uff0c\u5bf9\u4e8e\u591a\u5b57\u8282\u5b57\u7b26\uff0c\u8fd4\u56de\u7684\u5b57\u7b26\u6570\u3002\u6bd4\u59825\u4e2a\u4e24\u5b57\u8282\u5bbd\u5ea6\u5b57\uff0c\u8fd4\u56de\u7684\u957f\u5ea6\u662f10\u3002\n+\u8fd4\u56de\u5b57\u7b26\u4e32\u7684\u5b57\u8282\u3002", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ee1bcae2ec5a8f0f7699f8af3fe6e6f9d07b89e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDQyOTQ5", "url": "https://github.com/apache/incubator-doris/pull/3345#pullrequestreview-397442949", "createdAt": "2020-04-21T15:24:53Z", "commit": {"oid": "5ee1bcae2ec5a8f0f7699f8af3fe6e6f9d07b89e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNToyNDo1M1rOGJLypQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNToyNDo1M1rOGJLypQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI4MzU1Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \u5b83\u8fd4\u56de\u5177\u6709\u6307\u5b9a\u957f\u5ea6\u7684\u5b57\u7b26\u4e32\u7684\u53f3\u8fb9\u90e8\u5206, \u5ea6\u7684\u5355\u4f4d\u4e3autf8\u5b57\u7b26\n          \n          \n            \n            \u5b83\u8fd4\u56de\u5177\u6709\u6307\u5b9a\u957f\u5ea6\u7684\u5b57\u7b26\u4e32\u7684\u53f3\u8fb9\u90e8\u5206, \u957f\u5ea6\u7684\u5355\u4f4d\u4e3autf8\u5b57\u7b26", "url": "https://github.com/apache/incubator-doris/pull/3345#discussion_r412283557", "createdAt": "2020-04-21T15:24:53Z", "author": {"login": "wutiangan"}, "path": "docs/documentation/cn/sql-reference/sql-functions/string-functions/right.md", "diffHunk": "@@ -24,7 +24,7 @@ under the License.\n `VARCHAR right(VARCHAR str)`\n \n \n-\u5b83\u8fd4\u56de\u5177\u6709\u6307\u5b9a\u957f\u5ea6\u7684\u5b57\u7b26\u4e32\u7684\u53f3\u8fb9\u90e8\u5206\n+\u5b83\u8fd4\u56de\u5177\u6709\u6307\u5b9a\u957f\u5ea6\u7684\u5b57\u7b26\u4e32\u7684\u53f3\u8fb9\u90e8\u5206, \u5ea6\u7684\u5355\u4f4d\u4e3autf8\u5b57\u7b26", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ee1bcae2ec5a8f0f7699f8af3fe6e6f9d07b89e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5OTkwOTk2", "url": "https://github.com/apache/incubator-doris/pull/3345#pullrequestreview-399990996", "createdAt": "2020-04-24T14:21:23Z", "commit": {"oid": "236b93be57d3e817b7e18162dafc2e3ab9e24b6b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMDY1OTI5", "url": "https://github.com/apache/incubator-doris/pull/3345#pullrequestreview-400065929", "createdAt": "2020-04-24T15:48:32Z", "commit": {"oid": "236b93be57d3e817b7e18162dafc2e3ab9e24b6b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNTo0ODozMlrOGLeAhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNTo0ODozMlrOGLeAhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY3OTE3NQ==", "bodyText": "why not utf8_length?", "url": "https://github.com/apache/incubator-doris/pull/3345#discussion_r414679175", "createdAt": "2020-04-24T15:48:32Z", "author": {"login": "imay"}, "path": "gensrc/script/doris_builtins_functions.py", "diffHunk": "@@ -533,6 +533,8 @@\n             '15FunctionContextERKNS1_9StringValERKNS1_6IntValES6_'],\n     [['length'], 'INT', ['VARCHAR'],\n             '_ZN5doris15StringFunctions6lengthEPN9doris_udf15FunctionContextERKNS1_9StringValE'],\n+    [['char_length_utf8'], 'INT', ['VARCHAR'],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "236b93be57d3e817b7e18162dafc2e3ab9e24b6b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNTI2ODQw", "url": "https://github.com/apache/incubator-doris/pull/3345#pullrequestreview-401526840", "createdAt": "2020-04-28T06:18:37Z", "commit": {"oid": "ed6be71856e1dc45005d24ac3e6c4a8427b8143c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNjoxODozN1rOGNEWgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNjoxODozN1rOGNEWgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM1NTk2OA==", "bodyText": "Better to give a synonym CHARACTER_LENGTH, which is also supported in MySQL", "url": "https://github.com/apache/incubator-doris/pull/3345#discussion_r416355968", "createdAt": "2020-04-28T06:18:37Z", "author": {"login": "imay"}, "path": "gensrc/script/doris_builtins_functions.py", "diffHunk": "@@ -533,6 +533,8 @@\n             '15FunctionContextERKNS1_9StringValERKNS1_6IntValES6_'],\n     [['length'], 'INT', ['VARCHAR'],\n             '_ZN5doris15StringFunctions6lengthEPN9doris_udf15FunctionContextERKNS1_9StringValE'],\n+    [['char_length'], 'INT', ['VARCHAR'],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed6be71856e1dc45005d24ac3e6c4a8427b8143c"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3810d6a6a94f70469d0126b7498b105b71fce67c", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/3810d6a6a94f70469d0126b7498b105b71fce67c", "committedDate": "2020-04-29T06:42:35Z", "message": "add CHARACTER_LENGTH"}, "afterCommit": {"oid": "7cfc2973644b083d21177057723f958757238380", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/7cfc2973644b083d21177057723f958757238380", "committedDate": "2020-04-29T06:46:50Z", "message": "add CHARACTER_LENGTH"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7cfc2973644b083d21177057723f958757238380", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/7cfc2973644b083d21177057723f958757238380", "committedDate": "2020-04-29T06:46:50Z", "message": "add CHARACTER_LENGTH"}, "afterCommit": {"oid": "14287c72d2866be1a3a96a5461d352b5ebb4adad", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/14287c72d2866be1a3a96a5461d352b5ebb4adad", "committedDate": "2020-04-29T11:29:09Z", "message": "add CHARACTER_LENGTH"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMjk2MTk2", "url": "https://github.com/apache/incubator-doris/pull/3345#pullrequestreview-403296196", "createdAt": "2020-04-30T08:12:16Z", "commit": {"oid": "14287c72d2866be1a3a96a5461d352b5ebb4adad"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "14287c72d2866be1a3a96a5461d352b5ebb4adad", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/14287c72d2866be1a3a96a5461d352b5ebb4adad", "committedDate": "2020-04-29T11:29:09Z", "message": "add CHARACTER_LENGTH"}, "afterCommit": {"oid": "fa0b7b409f84f46d389ecba940c726fa8171af1b", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/fa0b7b409f84f46d389ecba940c726fa8171af1b", "committedDate": "2020-04-30T09:11:35Z", "message": "add CHARACTER_LENGTH"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MTE5MTIw", "url": "https://github.com/apache/incubator-doris/pull/3345#pullrequestreview-404119120", "createdAt": "2020-05-01T11:23:33Z", "commit": {"oid": "fa0b7b409f84f46d389ecba940c726fa8171af1b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c4d01c8b94f4d895bce167995f570495703d8160", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/c4d01c8b94f4d895bce167995f570495703d8160", "committedDate": "2020-05-06T02:33:59Z", "message": "fix unit test"}, "afterCommit": {"oid": "616b52ae947782b27bd113b41e10dd821dd918c2", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/616b52ae947782b27bd113b41e10dd821dd918c2", "committedDate": "2020-05-06T03:32:57Z", "message": "fix unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2NDg0MjIx", "url": "https://github.com/apache/incubator-doris/pull/3345#pullrequestreview-406484221", "createdAt": "2020-05-06T10:27:46Z", "commit": {"oid": "616b52ae947782b27bd113b41e10dd821dd918c2"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMDoyNzo0NlrOGRM0eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMDozMzo0NFrOGRNATg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY4OTAxNg==", "bodyText": "Should change this document according to current document format.", "url": "https://github.com/apache/incubator-doris/pull/3345#discussion_r420689016", "createdAt": "2020-05-06T10:27:46Z", "author": {"login": "imay"}, "path": "docs/documentation/cn/sql-reference/sql-functions/string-functions/char_length.md", "diffHunk": "@@ -0,0 +1,47 @@\n+<!-- ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "616b52ae947782b27bd113b41e10dd821dd918c2"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY4OTgwMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                [['char_length'], 'INT', ['VARCHAR'],\n          \n          \n            \n                [['char_length', 'character_length'], 'INT', ['VARCHAR'],\n          \n      \n    \n    \n  \n\nPrefer above type", "url": "https://github.com/apache/incubator-doris/pull/3345#discussion_r420689803", "createdAt": "2020-05-06T10:29:18Z", "author": {"login": "imay"}, "path": "gensrc/script/doris_builtins_functions.py", "diffHunk": "@@ -533,6 +533,8 @@\n             '15FunctionContextERKNS1_9StringValERKNS1_6IntValES6_'],\n     [['length'], 'INT', ['VARCHAR'],\n             '_ZN5doris15StringFunctions6lengthEPN9doris_udf15FunctionContextERKNS1_9StringValE'],\n+    [['char_length'], 'INT', ['VARCHAR'],", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM1NTk2OA=="}, "originalCommit": {"oid": "ed6be71856e1dc45005d24ac3e6c4a8427b8143c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY5MjA0Ng==", "bodyText": "Should change function reverse documentation", "url": "https://github.com/apache/incubator-doris/pull/3345#discussion_r420692046", "createdAt": "2020-05-06T10:33:44Z", "author": {"login": "imay"}, "path": "be/src/exprs/string_functions.cpp", "diffHunk": "@@ -260,13 +321,16 @@ StringVal StringFunctions::reverse(FunctionContext* context, const StringVal& st\n         return StringVal::null();\n     }\n \n-    // TODO pengyubing\n-    // StringVal result = StringVal::create_temp_string_val(context, str.len);\n     StringVal result(context, str.len);\n     if (UNLIKELY(result.is_null)) {\n         return result;\n     }\n-    std::reverse_copy(str.ptr, str.ptr + str.len, result.ptr);\n+\n+    for (size_t i = 0, char_size = 0; i < str.len; i += char_size) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "616b52ae947782b27bd113b41e10dd821dd918c2"}, "originalPosition": 145}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d13ac2053fcaaf92c6333823d1447333501e455", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/3d13ac2053fcaaf92c6333823d1447333501e455", "committedDate": "2020-05-07T05:07:52Z", "message": "[FIX] fix when string contains some characters that span multiple bytes, cannot be handler correctly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce92f1cd0c6a014bd7e0ec9f95138f3917c57736", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/ce92f1cd0c6a014bd7e0ec9f95138f3917c57736", "committedDate": "2020-05-07T05:07:52Z", "message": "fix typo and rename function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e980152dcf98425aa8be96c4673c2a3e1c43ac7a", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/e980152dcf98425aa8be96c4673c2a3e1c43ac7a", "committedDate": "2020-05-07T05:07:52Z", "message": "ADD DOCS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d168e7002de7dda16174d10ca651520514963d45", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/d168e7002de7dda16174d10ca651520514963d45", "committedDate": "2020-05-07T05:07:52Z", "message": "fix typo and optimize code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bc0205e8fec976d18b58a644ff983b8740eae68", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/5bc0205e8fec976d18b58a644ff983b8740eae68", "committedDate": "2020-05-07T05:07:52Z", "message": "fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "002532012f8cb37d65b0268fb09d7c4b8623e0a8", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/002532012f8cb37d65b0268fb09d7c4b8623e0a8", "committedDate": "2020-05-07T05:07:52Z", "message": "remove debug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "418e2f336d15f7fdde74f20c47296dc5e9ff5250", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/418e2f336d15f7fdde74f20c47296dc5e9ff5250", "committedDate": "2020-05-07T05:07:52Z", "message": "rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12f577c463ca3c6f0a03585ab8b5916bb6c577bc", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/12f577c463ca3c6f0a03585ab8b5916bb6c577bc", "committedDate": "2020-05-07T05:07:52Z", "message": "rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aeac6be9967048f1bd2b016c3bce77634cafad55", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/aeac6be9967048f1bd2b016c3bce77634cafad55", "committedDate": "2020-05-07T05:07:52Z", "message": "rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4b09e67fbd9d587ec22aa2d3df01f735b9b6c81", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/f4b09e67fbd9d587ec22aa2d3df01f735b9b6c81", "committedDate": "2020-05-07T05:07:52Z", "message": "change to char_length"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "879926bb82fb82790d037d007f5f1b7e0bafb4bd", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/879926bb82fb82790d037d007f5f1b7e0bafb4bd", "committedDate": "2020-05-07T05:07:52Z", "message": "add CHARACTER_LENGTH"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25de01bea6de07c8be873f0e3e3ff31c2d80b789", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/25de01bea6de07c8be873f0e3e3ff31c2d80b789", "committedDate": "2020-05-07T05:07:52Z", "message": "fix unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0681c9292e1c717616139d35ccd819691beb2c80", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/0681c9292e1c717616139d35ccd819691beb2c80", "committedDate": "2020-05-07T05:07:52Z", "message": "fix docs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "22eabf7a38be31ce2e93be7de2e0268546e6547c", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/22eabf7a38be31ce2e93be7de2e0268546e6547c", "committedDate": "2020-05-07T02:25:58Z", "message": "fix docs"}, "afterCommit": {"oid": "2b80d693cc1bd9de3ddc4e3372ea746e8de408d3", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/2b80d693cc1bd9de3ddc4e3372ea746e8de408d3", "committedDate": "2020-05-07T05:07:52Z", "message": "fix docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3MTU0NzAw", "url": "https://github.com/apache/incubator-doris/pull/3345#pullrequestreview-407154700", "createdAt": "2020-05-07T05:17:52Z", "commit": {"oid": "2b80d693cc1bd9de3ddc4e3372ea746e8de408d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwNToxNzo1MlrOGRuvjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwNToxNzo1MlrOGRuvjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI0NDgxMg==", "bodyText": "This can be merged in one line.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                [['char_length'], 'INT', ['VARCHAR'],\n          \n          \n            \n                        '_ZN5doris15StringFunctions16char_utf8_lengthEPN9doris_udf15FunctionContextERKNS1_9StringValE'],\n          \n          \n            \n                [['character_length'], 'INT', ['VARCHAR'],\n          \n          \n            \n                        '_ZN5doris15StringFunctions16char_utf8_lengthEPN9doris_udf15FunctionContextERKNS1_9StringValE'],\n          \n          \n            \n                [['char_length', 'character_length'], 'INT', ['VARCHAR'],\n          \n          \n            \n                        '_ZN5doris15StringFunctions16char_utf8_lengthEPN9doris_udf15FunctionContextERKNS1_9StringValE'],", "url": "https://github.com/apache/incubator-doris/pull/3345#discussion_r421244812", "createdAt": "2020-05-07T05:17:52Z", "author": {"login": "imay"}, "path": "gensrc/script/doris_builtins_functions.py", "diffHunk": "@@ -533,6 +533,10 @@\n             '15FunctionContextERKNS1_9StringValERKNS1_6IntValES6_'],\n     [['length'], 'INT', ['VARCHAR'],\n             '_ZN5doris15StringFunctions6lengthEPN9doris_udf15FunctionContextERKNS1_9StringValE'],\n+    [['char_length'], 'INT', ['VARCHAR'],\n+            '_ZN5doris15StringFunctions16char_utf8_lengthEPN9doris_udf15FunctionContextERKNS1_9StringValE'],\n+    [['character_length'], 'INT', ['VARCHAR'],\n+            '_ZN5doris15StringFunctions16char_utf8_lengthEPN9doris_udf15FunctionContextERKNS1_9StringValE'],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b80d693cc1bd9de3ddc4e3372ea746e8de408d3"}, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b80d693cc1bd9de3ddc4e3372ea746e8de408d3", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/2b80d693cc1bd9de3ddc4e3372ea746e8de408d3", "committedDate": "2020-05-07T05:07:52Z", "message": "fix docs"}, "afterCommit": {"oid": "0681c9292e1c717616139d35ccd819691beb2c80", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/0681c9292e1c717616139d35ccd819691beb2c80", "committedDate": "2020-05-07T05:07:52Z", "message": "fix docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f91327dd5041b4c57aef6a2a5b484e59258933db", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/f91327dd5041b4c57aef6a2a5b484e59258933db", "committedDate": "2020-05-07T08:36:49Z", "message": "merge functions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NjMxNzU4", "url": "https://github.com/apache/incubator-doris/pull/3345#pullrequestreview-407631758", "createdAt": "2020-05-07T16:18:51Z", "commit": {"oid": "f91327dd5041b4c57aef6a2a5b484e59258933db"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3267, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}