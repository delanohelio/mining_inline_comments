{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4NjAyMTI5", "number": 4373, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMjowNDoyOFrOEaRRpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMjo1MDoyOVrOEaSFPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1OTgxNDc4OnYy", "diffSide": "RIGHT", "path": "be/src/olap/storage_engine.cpp", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMjowNDoyOFrOHDmOqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjoxOTozNlrOHFhwpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUzNDEyMg==", "bodyText": "What's the purpose of the this random_shuffle?", "url": "https://github.com/apache/incubator-doris/pull/4373#discussion_r473534122", "createdAt": "2020-08-20T02:04:28Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -428,6 +428,18 @@ std::vector<DataDir*> StorageEngine::get_stores_for_create_tablet(\n     std::random_device rd;\n     srand(rd());\n     std::random_shuffle(stores.begin(), stores.end());\n+    // Two random choices\n+    for (int i = 0; i < stores.size(); i++) {\n+        int j = i + 1;\n+        if (j < stores.size()) {\n+            if (stores[i]->tablet_set().size() > stores[j]->tablet_set().size()) {\n+                std::swap(stores[i], stores[j]);\n+            }\n+            std::random_shuffle(stores.begin() + j, stores.end());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d253542537bb00cd3cb23efdda2f3d7557ab4575"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU1ODA1Mg==", "bodyText": "@chaoyli\nThe purpose of the this random_shuffle is that:\nIf it failed to create tablet on the first disk selected using \"two random choices\", it is necessary to select another disk from the remaining disks to create the tablet by using \"two random choices\" again. This random_shuffle is the beginning of the next \"two random choices\".", "url": "https://github.com/apache/incubator-doris/pull/4373#discussion_r475558052", "createdAt": "2020-08-24T12:19:36Z", "author": {"login": "weizuo93"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -428,6 +428,18 @@ std::vector<DataDir*> StorageEngine::get_stores_for_create_tablet(\n     std::random_device rd;\n     srand(rd());\n     std::random_shuffle(stores.begin(), stores.end());\n+    // Two random choices\n+    for (int i = 0; i < stores.size(); i++) {\n+        int j = i + 1;\n+        if (j < stores.size()) {\n+            if (stores[i]->tablet_set().size() > stores[j]->tablet_set().size()) {\n+                std::swap(stores[i], stores[j]);\n+            }\n+            std::random_shuffle(stores.begin() + j, stores.end());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUzNDEyMg=="}, "originalCommit": {"oid": "d253542537bb00cd3cb23efdda2f3d7557ab4575"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1OTk0Njg0OnYy", "diffSide": "RIGHT", "path": "be/src/olap/storage_engine.cpp", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMjo1MDoyOVrOHDnlsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMjowNToyMVrOHGAmHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU1NjQwMw==", "bodyText": "@weizuo93 you can use std::sort directly, and std::random_shuffle in line 430 is not needed?", "url": "https://github.com/apache/incubator-doris/pull/4373#discussion_r473556403", "createdAt": "2020-08-20T02:50:29Z", "author": {"login": "acelyc111"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -428,6 +428,18 @@ std::vector<DataDir*> StorageEngine::get_stores_for_create_tablet(\n     std::random_device rd;\n     srand(rd());\n     std::random_shuffle(stores.begin(), stores.end());\n+    // Two random choices\n+    for (int i = 0; i < stores.size(); i++) {\n+        int j = i + 1;\n+        if (j < stores.size()) {\n+            if (stores[i]->tablet_set().size() > stores[j]->tablet_set().size()) {\n+                std::swap(stores[i], stores[j]);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d253542537bb00cd3cb23efdda2f3d7557ab4575"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY0MDU0NQ==", "bodyText": "@acelyc111\nIf we use std::sort directly, all tablets will be created on the same disk which has the least amount of tablets. I think it would be better to take into account both the number of tablets on the disk and the randomness of disk selection.", "url": "https://github.com/apache/incubator-doris/pull/4373#discussion_r475640545", "createdAt": "2020-08-24T14:09:47Z", "author": {"login": "weizuo93"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -428,6 +428,18 @@ std::vector<DataDir*> StorageEngine::get_stores_for_create_tablet(\n     std::random_device rd;\n     srand(rd());\n     std::random_shuffle(stores.begin(), stores.end());\n+    // Two random choices\n+    for (int i = 0; i < stores.size(); i++) {\n+        int j = i + 1;\n+        if (j < stores.size()) {\n+            if (stores[i]->tablet_set().size() > stores[j]->tablet_set().size()) {\n+                std::swap(stores[i], stores[j]);\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU1NjQwMw=="}, "originalCommit": {"oid": "d253542537bb00cd3cb23efdda2f3d7557ab4575"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA2MzI2Mg==", "bodyText": "@weizuo93 I got it.", "url": "https://github.com/apache/incubator-doris/pull/4373#discussion_r476063262", "createdAt": "2020-08-25T02:05:21Z", "author": {"login": "acelyc111"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -428,6 +428,18 @@ std::vector<DataDir*> StorageEngine::get_stores_for_create_tablet(\n     std::random_device rd;\n     srand(rd());\n     std::random_shuffle(stores.begin(), stores.end());\n+    // Two random choices\n+    for (int i = 0; i < stores.size(); i++) {\n+        int j = i + 1;\n+        if (j < stores.size()) {\n+            if (stores[i]->tablet_set().size() > stores[j]->tablet_set().size()) {\n+                std::swap(stores[i], stores[j]);\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU1NjQwMw=="}, "originalCommit": {"oid": "d253542537bb00cd3cb23efdda2f3d7557ab4575"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1148, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}