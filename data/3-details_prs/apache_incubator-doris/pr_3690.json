{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMDk1Mjgw", "number": 3690, "title": "[compaction] Update cumulative point calculate algorithm", "bodyText": "Ref #3687\nCurrent cumulative point calculate algorithm may skip singleton version\nrowset when the rowset has only one segment and with NONOVERLAPPING flag.\nWhen a tablet is new created and cumulate many singleton version rowsets,\ncumulative point will be calculated as the max version + 1, and then\ncumulative compaction couldn't pick any rowsets and compaction failed, and\nwill lead the next base compaction on this tablet with all rowsets, which\ncan also cause memory consume problem, suppose there are thousands of rowsets.\nAll singleton version rowsets must be newly wrote by delta writer and hasn't\ndo any compaction, we should place cumulative point before any of these rowsets.", "createdAt": "2020-05-26T09:38:37Z", "url": "https://github.com/apache/incubator-doris/pull/3690", "merged": true, "mergeCommit": {"oid": "43d25afa2c4c2a553c99fa1feb7e5e2e46f48446"}, "closed": true, "closedAt": "2020-05-30T02:34:54Z", "author": {"login": "acelyc111"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclBXY-AH2gAyNDIzMDk1MjgwOjAwNDZiNGFkOGNlZjllMjY4MTBlZjE1ZjlhOWU1NzQ4NjRmOTE0MWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcmNtIeAFqTQyMTM3MDc0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0046b4ad8cef9e26810ef15f9a9e574864f9141d", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/0046b4ad8cef9e26810ef15f9a9e574864f9141d", "committedDate": "2020-05-26T09:36:44Z", "message": "[compaction] Update cumulative point calculate algorithm\n\nCurrent cumulative point calculate algorithm may skip sigleton version\nrowset when the rowset has only one segment and with NONOVERLAPPING flag.\nWhen a tablet is new created and cumulate many singleton version rowsets,\ncumulative point will be calculated as the max version + 1, and then\ncumulative compaction couldn't pick any rowsets and compaction failed, and\nwill lead the next base compaction on this tablet with all rowsets, which\ncan also cause memory consume problem, suppose there are thousands of rowsets.\n\nAll sigleton version rowsets must be newly wrote by delta writer and hasn't\ndo any compaction, we should place cumulative point before any of these rowsets.\nAnd also we should store cumulative point into tablet meta."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NzMxMDg1", "url": "https://github.com/apache/incubator-doris/pull/3690#pullrequestreview-419731085", "createdAt": "2020-05-28T02:13:11Z", "commit": {"oid": "0046b4ad8cef9e26810ef15f9a9e574864f9141d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMjoxMzoxMlrOGbjV2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMjoxMzoxMlrOGbjV2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU0Mzc3MQ==", "bodyText": "cumulative point in tablet meta has non-sense.\nIf will cause another persistence for clone/compaction.\nSo it's removed from tablet meta when refactoring BE.\nYou can see it because of compatibility for the old code path.", "url": "https://github.com/apache/incubator-doris/pull/3690#discussion_r431543771", "createdAt": "2020-05-28T02:13:12Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/tablet.cpp", "diffHunk": "@@ -68,7 +68,7 @@ Tablet::Tablet(TabletMetaSharedPtr tablet_meta, DataDir* data_dir) :\n         _last_base_compaction_failure_millis(0),\n         _last_cumu_compaction_success_millis(0),\n         _last_base_compaction_success_millis(0),\n-        _cumulative_point(kInvalidCumulativePoint) {\n+        _cumulative_point(tablet_meta->cumulative_layer_point()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0046b4ad8cef9e26810ef15f9a9e574864f9141d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5957f36f953912bc04c855feb517ed0d037b70e2", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/5957f36f953912bc04c855feb517ed0d037b70e2", "committedDate": "2020-05-28T08:04:00Z", "message": "not persistent cumulative point"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMzcwNzQ1", "url": "https://github.com/apache/incubator-doris/pull/3690#pullrequestreview-421370745", "createdAt": "2020-05-30T02:33:16Z", "commit": {"oid": "5957f36f953912bc04c855feb517ed0d037b70e2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2765, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}