{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyOTU0MDc1", "number": 3188, "title": "fix join hints not work when need table reorder", "bodyText": "1 fix join hints not work when need table reorder, this bug is described in #3187\n2 fix cross join node does not implement computeStats, this will  cause brodcast join cost always 0 #3195", "createdAt": "2020-03-24T12:12:59Z", "url": "https://github.com/apache/incubator-doris/pull/3188", "merged": true, "mergeCommit": {"oid": "d14726e05bb498f5c0ce9b5d929aafd5d2c5ae7a"}, "closed": true, "closedAt": "2020-04-02T09:13:36Z", "author": {"login": "yangzhg"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQx4q1gBqjMxNTkzODY0MDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTop29AFqTM4NjI0MjI1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "33d08968f9efd5f3acd999cdbfdfe0d3bfd8e68e", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/33d08968f9efd5f3acd999cdbfdfe0d3bfd8e68e", "committedDate": "2020-03-24T11:41:53Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}, "afterCommit": {"oid": "10c547fae17259be8391f11fa2f4401b5f6cf548", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/10c547fae17259be8391f11fa2f4401b5f6cf548", "committedDate": "2020-03-24T12:15:56Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10c547fae17259be8391f11fa2f4401b5f6cf548", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/10c547fae17259be8391f11fa2f4401b5f6cf548", "committedDate": "2020-03-24T12:15:56Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}, "afterCommit": {"oid": "5bd965b624f4d3902baa516c9868583040c61357", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/5bd965b624f4d3902baa516c9868583040c61357", "committedDate": "2020-03-24T12:18:29Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5bd965b624f4d3902baa516c9868583040c61357", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/5bd965b624f4d3902baa516c9868583040c61357", "committedDate": "2020-03-24T12:18:29Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}, "afterCommit": {"oid": "f81f486b000fd3ccab32e49c7104c802194bff1a", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/f81f486b000fd3ccab32e49c7104c802194bff1a", "committedDate": "2020-03-25T05:48:35Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f81f486b000fd3ccab32e49c7104c802194bff1a", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/f81f486b000fd3ccab32e49c7104c802194bff1a", "committedDate": "2020-03-25T05:48:35Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}, "afterCommit": {"oid": "4cd69aafc204672e5e9d6d73bdcef2663dce253e", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/4cd69aafc204672e5e9d6d73bdcef2663dce253e", "committedDate": "2020-03-25T06:06:26Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4cd69aafc204672e5e9d6d73bdcef2663dce253e", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/4cd69aafc204672e5e9d6d73bdcef2663dce253e", "committedDate": "2020-03-25T06:06:26Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}, "afterCommit": {"oid": "2bbcbb5f6ba9c9f210f1558208ed9afd02d886a6", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/2bbcbb5f6ba9c9f210f1558208ed9afd02d886a6", "committedDate": "2020-03-25T06:53:17Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bbcbb5f6ba9c9f210f1558208ed9afd02d886a6", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/2bbcbb5f6ba9c9f210f1558208ed9afd02d886a6", "committedDate": "2020-03-25T06:53:17Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}, "afterCommit": {"oid": "f281c330cac5bd939381d2687133f149ad270853", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/f281c330cac5bd939381d2687133f149ad270853", "committedDate": "2020-03-25T07:31:12Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f281c330cac5bd939381d2687133f149ad270853", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/f281c330cac5bd939381d2687133f149ad270853", "committedDate": "2020-03-25T07:31:12Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}, "afterCommit": {"oid": "aa0a1f6155f9718758ea02d9a07963ad6a65f21c", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/aa0a1f6155f9718758ea02d9a07963ad6a65f21c", "committedDate": "2020-03-25T07:34:19Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa0a1f6155f9718758ea02d9a07963ad6a65f21c", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/aa0a1f6155f9718758ea02d9a07963ad6a65f21c", "committedDate": "2020-03-25T07:34:19Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}, "afterCommit": {"oid": "c421a1dcc8d2781ec1ecae0d0fb84ab2b24a031f", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/c421a1dcc8d2781ec1ecae0d0fb84ab2b24a031f", "committedDate": "2020-03-25T08:06:12Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c421a1dcc8d2781ec1ecae0d0fb84ab2b24a031f", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/c421a1dcc8d2781ec1ecae0d0fb84ab2b24a031f", "committedDate": "2020-03-25T08:06:12Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}, "afterCommit": {"oid": "41c9337a8d84c9d0eb63d029125afdbb07859800", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/41c9337a8d84c9d0eb63d029125afdbb07859800", "committedDate": "2020-03-25T09:21:58Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "41c9337a8d84c9d0eb63d029125afdbb07859800", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/41c9337a8d84c9d0eb63d029125afdbb07859800", "committedDate": "2020-03-25T09:21:58Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}, "afterCommit": {"oid": "fd0dd516dfd633d5a56689b9b4146941cfa11bfa", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/fd0dd516dfd633d5a56689b9b4146941cfa11bfa", "committedDate": "2020-03-27T04:09:59Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNjcwMzc2", "url": "https://github.com/apache/incubator-doris/pull/3188#pullrequestreview-381670376", "createdAt": "2020-03-26T02:54:47Z", "commit": {"oid": "41c9337a8d84c9d0eb63d029125afdbb07859800"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwMjo1NDo0N1rOF71ppw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDo1MzoyNFrOF9tr4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI4OTMxOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // When a join statement with a join hit, the decorated part should be reordered as a whole,\n          \n          \n            \n                // When a join statement with a join hint, the decorated part should be reordered as a whole,", "url": "https://github.com/apache/incubator-doris/pull/3188#discussion_r398289319", "createdAt": "2020-03-26T02:54:47Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/SelectStmt.java", "diffHunk": "@@ -612,11 +611,14 @@ public void materializeRequiredSlots(Analyzer analyzer) throws AnalysisException\n         }\n     }\n \n+    // When a join statement with a join hit, the decorated part should be reordered as a whole,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41c9337a8d84c9d0eb63d029125afdbb07859800"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI1NTk2OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     LOG.debug(\"stats CrossJoin: cardinality=\" + Long.toString(cardinality));\n          \n          \n            \n                     LOG.debug(\"stats CrossJoin: cardinality= {}\", Long.toString(cardinality));", "url": "https://github.com/apache/incubator-doris/pull/3188#discussion_r400255969", "createdAt": "2020-03-30T14:53:24Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/planner/CrossJoinNode.java", "diffHunk": "@@ -59,16 +59,16 @@ public TableRef getInnerRef() {\n \n     @Override\n     public void computeStats(Analyzer analyzer) {\n-        // super.computeStats(analyzer);\n-        // if (getChild(0).cardinality_ == -1 || getChild(1).cardinality_ == -1) {\n-        //   cardinality_ = -1;\n-        // } else {\n-        //   cardinality_ = getChild(0).cardinality_ * getChild(1).cardinality_;\n-        //   if (computeSelectivity() != -1) {\n-        //     cardinality_ = Math.round(((double) cardinality_) * computeSelectivity());\n-        //   }\n-        // }\n-        // LOG.debug(\"stats CrossJoin: cardinality=\" + Long.toString(cardinality_));\n+         super.computeStats(analyzer);\n+         if (getChild(0).cardinality == -1 || getChild(1).cardinality == -1) {\n+           cardinality = -1;\n+         } else {\n+           cardinality = getChild(0).cardinality * getChild(1).cardinality;\n+           if (computeSelectivity() != -1) {\n+             cardinality = Math.round(((double) cardinality) * computeSelectivity());\n+           }\n+         }\n+         LOG.debug(\"stats CrossJoin: cardinality=\" + Long.toString(cardinality));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd0dd516dfd633d5a56689b9b4146941cfa11bfa"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MjM0NTc3", "url": "https://github.com/apache/incubator-doris/pull/3188#pullrequestreview-385234577", "createdAt": "2020-04-01T02:57:21Z", "commit": {"oid": "92c299f8f535df42bc3e2d425b83a64efd629898"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMjo1NzoyMVrOF-vIFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMjo1NzoyMVrOF-vIFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMyODE0OA==", "bodyText": "How about cross join?", "url": "https://github.com/apache/incubator-doris/pull/3188#discussion_r401328148", "createdAt": "2020-04-01T02:57:21Z", "author": {"login": "wutiangan"}, "path": "fe/src/main/java/org/apache/doris/analysis/SelectStmt.java", "diffHunk": "@@ -612,11 +611,14 @@ public void materializeRequiredSlots(Analyzer analyzer) throws AnalysisException\n         }\n     }\n \n+    // When a join statement with a join hint, the decorated part should be reordered as a whole,\n+    // rather than individually.\n     protected void reorderTable(Analyzer analyzer) throws AnalysisException {\n-        List<Pair<TableRef, Long>> candidates = Lists.newArrayList();\n+        List<Pair<List<TableRef>, Long>> candidates = Lists.newArrayList();\n \n-        // New pair of table ref and row count\n-        for (TableRef tblRef : fromClause_) {\n+        for (int i = 0; i < fromClause_.size(); ++i) {\n+            List<TableRef> tableRefs = new ArrayList<>();\n+            TableRef tblRef = fromClause_.get(i);\n             if (tblRef.getJoinOp() != JoinOperator.INNER_JOIN) {\n                 // Unsupported reorder outer join", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92c299f8f535df42bc3e2d425b83a64efd629898"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "92c299f8f535df42bc3e2d425b83a64efd629898", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/92c299f8f535df42bc3e2d425b83a64efd629898", "committedDate": "2020-04-01T01:43:25Z", "message": "fix some typo"}, "afterCommit": {"oid": "5e2fa0391c0ae742945eecbdb4183536176fc1fa", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/5e2fa0391c0ae742945eecbdb4183536176fc1fa", "committedDate": "2020-04-01T03:47:56Z", "message": "fix some typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MTQ2NDM3", "url": "https://github.com/apache/incubator-doris/pull/3188#pullrequestreview-386146437", "createdAt": "2020-04-02T06:48:42Z", "commit": {"oid": "5e2fa0391c0ae742945eecbdb4183536176fc1fa"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "907d91b1d0814cccecc9cdd30412da8c5d249e5e", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/907d91b1d0814cccecc9cdd30412da8c5d249e5e", "committedDate": "2020-04-02T07:43:54Z", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de68899b30e95ca32f7c0083f492078a32db13bd", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/de68899b30e95ca32f7c0083f492078a32db13bd", "committedDate": "2020-04-02T07:43:54Z", "message": "fix some typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66f8452c1eaabb4a3f2a435931d9f2b630e0af40", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/66f8452c1eaabb4a3f2a435931d9f2b630e0af40", "committedDate": "2020-04-02T07:48:21Z", "message": "disable table reorder when has join hints"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e2fa0391c0ae742945eecbdb4183536176fc1fa", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/5e2fa0391c0ae742945eecbdb4183536176fc1fa", "committedDate": "2020-04-01T03:47:56Z", "message": "fix some typo"}, "afterCommit": {"oid": "66f8452c1eaabb4a3f2a435931d9f2b630e0af40", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/66f8452c1eaabb4a3f2a435931d9f2b630e0af40", "committedDate": "2020-04-02T07:48:21Z", "message": "disable table reorder when has join hints"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MjQyMjUy", "url": "https://github.com/apache/incubator-doris/pull/3188#pullrequestreview-386242252", "createdAt": "2020-04-02T09:12:34Z", "commit": {"oid": "66f8452c1eaabb4a3f2a435931d9f2b630e0af40"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3374, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}