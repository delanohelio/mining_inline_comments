{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzNTQyMjM1", "number": 4006, "title": "[Feature] Support InPredicate in delete statement", "bodyText": "This PR is to add inPredicate support to delete statement, and add max_allowed_in_element_num_of_delete variable to limit element num of InPredicate in delete statement.", "createdAt": "2020-07-02T14:09:30Z", "url": "https://github.com/apache/incubator-doris/pull/4006", "merged": true, "mergeCommit": {"oid": "eefad13107ac74a406212e0f0f57181973ac9c1e"}, "closed": true, "closedAt": "2020-08-06T15:19:41Z", "author": {"login": "caiconghui"}, "timelineItems": {"totalCount": 37, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcx_DF1AFqTQ0MjY4NzUzMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7fSNxAFqTQ2MDQ5NDgxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjg3NTMw", "url": "https://github.com/apache/incubator-doris/pull/4006#pullrequestreview-442687530", "createdAt": "2020-07-05T15:46:21Z", "commit": {"oid": "b5dcece74379ed808ac4083a9612e0e684c30e6b"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQxNTo0NjoyMlrOGtDLtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQxNjoxNDozOFrOGtDWCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5MTI1NA==", "bodyText": "Why skipping the base index?\nIf there is no rollup index, the entire check will be skipped.", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r449891254", "createdAt": "2020-07-05T15:46:22Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/load/DeleteHandler.java", "diffHunk": "@@ -516,25 +537,22 @@ private void checkDeleteV2(OlapTable table, Partition partition, List<Predicate>\n         }\n         Map<Long, List<Column>> indexIdToSchema = table.getIndexIdToSchema();\n         for (MaterializedIndex index : partition.getMaterializedIndices(MaterializedIndex.IndexExtState.VISIBLE)) {\n+            if (table.getBaseIndexId() == index.getId()) {\n+                continue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5dcece74379ed808ac4083a9612e0e684c30e6b"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5MTY1NA==", "bodyText": "Is it better be a FE's config instead of a session variable?\nI think this should be a system-level restriction to prevent users from writing too many conditions, resulting in a reduction in the efficiency of reading and writing the underlying data in storage system.", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r449891654", "createdAt": "2020-07-05T15:50:48Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/qe/SessionVariable.java", "diffHunk": "@@ -248,6 +249,8 @@\n     private int maxScanKeyNum = -1;\n     @VariableMgr.VarAttr(name = MAX_PUSHDOWN_CONDITIONS_PER_COLUMN)\n     private int maxPushdownConditionsPerColumn = -1;\n+    @VariableMgr.VarAttr(name = MAX_ALLOWED_IN_ELEMENT_NUM_OF_DELETE)\n+    private int maxAllowedInElementNumOfDelete = 1024;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5dcece74379ed808ac4083a9612e0e684c30e6b"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5MjIyOA==", "bodyText": "This log may be very long. the number of conditions and column name is enough.", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r449892228", "createdAt": "2020-07-05T15:56:43Z", "author": {"login": "morningman"}, "path": "be/src/olap/delete_handler.cpp", "diffHunk": "@@ -66,9 +67,22 @@ OLAPStatus DeleteConditionHandler::generate_delete_predicate(\n \n     // \u5b58\u50a8\u5220\u9664\u6761\u4ef6\n     for (const TCondition& condition : conditions) {\n-        string condition_str = construct_sub_predicates(condition);\n-        del_pred->add_sub_predicates(condition_str);\n-        LOG(INFO) << \"store one sub-delete condition. condition=\" << condition_str;\n+        if (condition.condition_values.size() > 1) {\n+            InPredicatePB* in_pred = del_pred->add_in_predicates();\n+            in_pred->set_column_name(condition.column_name);\n+            bool is_not_in = condition.condition_op == \"!*=\";\n+            in_pred->set_is_not_in(is_not_in);\n+            for (const auto& condition_value : condition.condition_values) {\n+                in_pred->add_values(condition_value);\n+            }\n+            string condition_str;\n+            json2pb::ProtoMessageToJson(*in_pred, &condition_str);\n+            LOG(INFO) << \"store one sub-delete condition. condition=\" << condition_str;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5dcece74379ed808ac4083a9612e0e684c30e6b"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5MjcwMQ==", "bodyText": "Could we defined this magic number somewhere?", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r449892701", "createdAt": "2020-07-05T16:01:05Z", "author": {"login": "morningman"}, "path": "be/src/olap/olap_cond.cpp", "diffHunk": "@@ -57,77 +57,49 @@ using doris::ColumnStatistics;\n namespace doris {\n \n static CondOp parse_op_type(const string& op) {\n-    if (op.size() > 2) {\n+    if (op.size() > 3) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5dcece74379ed808ac4083a9612e0e684c30e6b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5MzY2NQ==", "bodyText": "Should this be:\nmin_value_field->cmp(stat.second) <= 0 && max_value_field->cmp(stat.first) >= 0\n?", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r449893665", "createdAt": "2020-07-05T16:11:44Z", "author": {"login": "morningman"}, "path": "be/src/olap/olap_cond.cpp", "diffHunk": "@@ -378,20 +347,31 @@ int Cond::del_eval(const std::pair<WrapperField*, WrapperField*>& stat) const {\n         return ret;\n     }\n     case OP_IN: {\n-        FieldSet::const_iterator it = operand_set.begin();\n-        for (; it != operand_set.end(); ++it) {\n-            if ((*it)->cmp(stat.first) >= 0\n-                && (*it)->cmp(stat.second) <= 0) {\n-                if (stat.first->cmp(stat.second) == 0) {\n-                    ret = DEL_SATISFIED;\n-                } else {\n-                    ret = DEL_PARTIAL_SATISFIED;\n-                }\n-                break;\n+        if (stat.first->cmp(stat.second) == 0) {\n+            if (operand_set.find(stat.first) != operand_set.end()) {\n+                ret = DEL_SATISFIED;\n+            } else {\n+                ret = DEL_NOT_SATISFIED;\n+            }\n+        } else {\n+            if ((min_value_field->cmp(stat.first) >= 0 && min_value_field->cmp(stat.second) <= 0) ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5dcece74379ed808ac4083a9612e0e684c30e6b"}, "originalPosition": 214}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5MzcxMA==", "bodyText": "Should this be:\nmin_value_field->cmp(stat.second) <= 0 && max_value_field->cmp(stat.first) >= 0\n?", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r449893710", "createdAt": "2020-07-05T16:12:17Z", "author": {"login": "morningman"}, "path": "be/src/olap/olap_cond.cpp", "diffHunk": "@@ -262,28 +242,17 @@ bool Cond::eval(const std::pair<WrapperField*, WrapperField*>& statistic) const\n         return operand_field->cmp(statistic.second) <= 0;\n     }\n     case OP_IN: {\n-        FieldSet::const_iterator it = operand_set.begin();\n-        for (; it != operand_set.end(); ++it) {\n-            if ((*it)->cmp(statistic.first) >= 0 \n-                    && (*it)->cmp(statistic.second) <= 0) {\n-                return true;\n-            }\n-        }\n-        break;\n+        return (min_value_field->cmp(statistic.first) >= 0 && min_value_field->cmp(statistic.second) <= 0) ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5dcece74379ed808ac4083a9612e0e684c30e6b"}, "originalPosition": 169}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5Mzg5Nw==", "bodyText": "Normally, the invalid OP should be at the beginning(-1) or at last of the enum.\nI am not sure if we persist the order of CondOp in storage. If not, I think its better to move the OP_NULL to the beginning and set it as -1.", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r449893897", "createdAt": "2020-07-05T16:14:38Z", "author": {"login": "morningman"}, "path": "be/src/olap/olap_cond.h", "diffHunk": "@@ -46,7 +46,8 @@ enum CondOp {\n     OP_GE = 5,      // greater or equal\n     OP_IN = 6,      // IN\n     OP_IS = 7,      // is null or not null\n-    OP_NULL = 8    // invalid OP\n+    OP_NULL = 8,     // invalid OP\n+    OP_NOT_IN = 9    // not in", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5dcece74379ed808ac4083a9612e0e684c30e6b"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ec82218935d3b0b7c8846c5554a9f150dcb2bae9", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/ec82218935d3b0b7c8846c5554a9f150dcb2bae9", "committedDate": "2020-07-06T15:45:40Z", "message": "remove unused content from docs"}, "afterCommit": {"oid": "105777771afca6e9ae09974f2520bf33339d31ad", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/105777771afca6e9ae09974f2520bf33339d31ad", "committedDate": "2020-07-06T15:50:18Z", "message": "remove unused content from docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNTgxOTU0", "url": "https://github.com/apache/incubator-doris/pull/4006#pullrequestreview-443581954", "createdAt": "2020-07-07T05:57:34Z", "commit": {"oid": "105777771afca6e9ae09974f2520bf33339d31ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNTo1NzozNFrOGtwHTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNTo1NzozNFrOGtwHTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYyNzQwNw==", "bodyText": "the last loop is \u201c i == inPredicate.getInElementNum()\u201d, should \" i + 1 != inPredicate.getInElementNum()\" modify \"i != inPredicate.getInElementNum()\"?", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r450627407", "createdAt": "2020-07-07T05:57:34Z", "author": {"login": "wutiangan"}, "path": "fe/src/main/java/org/apache/doris/load/DeleteHandler.java", "diffHunk": "@@ -569,6 +587,19 @@ private void checkDeleteV2(OlapTable table, Partition partition, List<Predicate>\n                     sb.append(\" IS NULL\");\n                 }\n                 deleteConditions.add(sb.toString());\n+            } else if (condition instanceof InPredicate) {\n+                InPredicate inPredicate = (InPredicate) condition;\n+                SlotRef slotRef = (SlotRef) inPredicate.getChild(0);\n+                String columnName = slotRef.getColumnName();\n+                StringBuilder strBuilder = new StringBuilder();\n+                String notStr = inPredicate.isNotIn() ? \"NOT \" : \"\";\n+                strBuilder.append(columnName).append(\" \" + notStr + \"IN (\");\n+                for (int i = 1; i <= inPredicate.getInElementNum(); ++i) {\n+                    strBuilder.append(inPredicate.getChild(i).toSql());\n+                    strBuilder.append((i + 1 != inPredicate.getInElementNum()) ? \", \" : \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "105777771afca6e9ae09974f2520bf33339d31ad"}, "originalPosition": 124}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNTgzMzE2", "url": "https://github.com/apache/incubator-doris/pull/4006#pullrequestreview-443583316", "createdAt": "2020-07-07T06:00:59Z", "commit": {"oid": "105777771afca6e9ae09974f2520bf33339d31ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNjowMTowMFrOGtwLRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNjowMTowMFrOGtwLRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYyODQyMQ==", "bodyText": "can slotRef be the second child of binaryPreidicate?", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r450628421", "createdAt": "2020-07-07T06:01:00Z", "author": {"login": "wutiangan"}, "path": "fe/src/main/java/org/apache/doris/load/DeleteHandler.java", "diffHunk": "@@ -450,7 +451,22 @@ public DeleteJob getDeleteJob(long transactionId) {\n         return idToDeleteJob.get(transactionId);\n     }\n \n-    private void checkDeleteV2(OlapTable table, Partition partition, List<Predicate> conditions, List<String> deleteConditions, boolean preCheck)\n+    private SlotRef getSlotRef(Predicate condition) {\n+        SlotRef slotRef = null;\n+        if (condition instanceof BinaryPredicate) {\n+            BinaryPredicate binaryPredicate = (BinaryPredicate) condition;\n+            slotRef = (SlotRef) binaryPredicate.getChild(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "105777771afca6e9ae09974f2520bf33339d31ad"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNTg4MDIy", "url": "https://github.com/apache/incubator-doris/pull/4006#pullrequestreview-443588022", "createdAt": "2020-07-07T06:12:50Z", "commit": {"oid": "105777771afca6e9ae09974f2520bf33339d31ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNjoxMjo1MFrOGtwZzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNjoxMjo1MFrOGtwZzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYzMjE0MQ==", "bodyText": "what does the for loop do? LiteralExpr.create has no return value?", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r450632141", "createdAt": "2020-07-07T06:12:50Z", "author": {"login": "wutiangan"}, "path": "fe/src/main/java/org/apache/doris/load/DeleteHandler.java", "diffHunk": "@@ -507,7 +516,19 @@ private void checkDeleteV2(OlapTable table, Partition partition, List<Predicate>\n                     LiteralExpr.create(value, Type.fromPrimitiveType(column.getDataType()));\n                 } catch (AnalysisException e) {\n                     // ErrorReport.reportDdlException(ErrorCode.ERR_INVALID_VALUE, value);\n-                    throw new DdlException(\"Invalid column value[\" + value + \"]\");\n+                    throw new DdlException(\"Invalid column value[\" + value + \"] for column \" + columnName);\n+                }\n+            } else if (condition instanceof InPredicate) {\n+                String value = null;\n+                try {\n+                    InPredicate inPredicate = (InPredicate) condition;\n+                    for (int i = 1; i <= inPredicate.getInElementNum(); i++) {\n+                        value = ((LiteralExpr) inPredicate.getChild(i)).getStringValue();\n+                        LiteralExpr.create(value, Type.fromPrimitiveType(column.getDataType()));\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "105777771afca6e9ae09974f2520bf33339d31ad"}, "originalPosition": 71}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e44c701b197285102e55a62fbdab49d8ca88f1c", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/1e44c701b197285102e55a62fbdab49d8ca88f1c", "committedDate": "2020-07-07T06:50:01Z", "message": "fix in predicate str error"}, "afterCommit": {"oid": "ae4c78fd2841986e5e4d52e2d3040e3cd23d0cf1", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/ae4c78fd2841986e5e4d52e2d3040e3cd23d0cf1", "committedDate": "2020-07-28T06:02:05Z", "message": "fix in predicate str error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NTQ5MjA3", "url": "https://github.com/apache/incubator-doris/pull/4006#pullrequestreview-457549207", "createdAt": "2020-07-29T13:58:45Z", "commit": {"oid": "ae4c78fd2841986e5e4d52e2d3040e3cd23d0cf1"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMzo1ODo0NVrOG45xbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNTowNzoyNlrOG49APg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMxOTk4MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                throw new AnalysisException(\"Right expr of binary predicate should be value\");\n          \n          \n            \n                                throw new AnalysisException(\"Child of in predicate should be value\");", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r462319981", "createdAt": "2020-07-29T13:58:45Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/analysis/DeleteStmt.java", "diffHunk": "@@ -119,11 +120,29 @@ private void analyzePredicate(Expr predicate) throws AnalysisException {\n             IsNullPredicate isNullPredicate = (IsNullPredicate) predicate;\n             Expr leftExpr = isNullPredicate.getChild(0);\n             if (!(leftExpr instanceof SlotRef)) {\n-                throw new AnalysisException(\"Left expr should be column name\");\n+                throw new AnalysisException(\"Left expr of is_null predicate should be column name\");\n             }\n             deleteConditions.add(isNullPredicate);\n+        } else if (predicate instanceof InPredicate) {\n+            InPredicate inPredicate = (InPredicate) predicate;\n+            Expr leftExpr = inPredicate.getChild(0);\n+            if (!(leftExpr instanceof SlotRef)) {\n+                throw new AnalysisException(\"Left expr of in predicate should be column name\");\n+            }\n+            int inElementNum = inPredicate.getInElementNum();\n+            int maxAllowedInElementNumOfDelete = Config.max_allowed_in_element_num_of_delete;\n+            if (inElementNum > maxAllowedInElementNumOfDelete) {\n+                throw new AnalysisException(\"Element num of in predicate should not be more than \" + maxAllowedInElementNumOfDelete);\n+            }\n+            for (int i = 1; i <= inPredicate.getInElementNum(); i++) {\n+                Expr expr = inPredicate.getChild(i);\n+                if (!(expr instanceof LiteralExpr)) {\n+                    throw new AnalysisException(\"Right expr of binary predicate should be value\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae4c78fd2841986e5e4d52e2d3040e3cd23d0cf1"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMyMDQwMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new AnalysisException(\"Where clause should be compound or binary predicate or is_null predicate or in predicate\");\n          \n          \n            \n                        throw new AnalysisException(\"Where clause only supports compound predicate, binary predicate, is_null predicate or in predicate\");", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r462320403", "createdAt": "2020-07-29T13:59:22Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/analysis/DeleteStmt.java", "diffHunk": "@@ -119,11 +120,29 @@ private void analyzePredicate(Expr predicate) throws AnalysisException {\n             IsNullPredicate isNullPredicate = (IsNullPredicate) predicate;\n             Expr leftExpr = isNullPredicate.getChild(0);\n             if (!(leftExpr instanceof SlotRef)) {\n-                throw new AnalysisException(\"Left expr should be column name\");\n+                throw new AnalysisException(\"Left expr of is_null predicate should be column name\");\n             }\n             deleteConditions.add(isNullPredicate);\n+        } else if (predicate instanceof InPredicate) {\n+            InPredicate inPredicate = (InPredicate) predicate;\n+            Expr leftExpr = inPredicate.getChild(0);\n+            if (!(leftExpr instanceof SlotRef)) {\n+                throw new AnalysisException(\"Left expr of in predicate should be column name\");\n+            }\n+            int inElementNum = inPredicate.getInElementNum();\n+            int maxAllowedInElementNumOfDelete = Config.max_allowed_in_element_num_of_delete;\n+            if (inElementNum > maxAllowedInElementNumOfDelete) {\n+                throw new AnalysisException(\"Element num of in predicate should not be more than \" + maxAllowedInElementNumOfDelete);\n+            }\n+            for (int i = 1; i <= inPredicate.getInElementNum(); i++) {\n+                Expr expr = inPredicate.getChild(i);\n+                if (!(expr instanceof LiteralExpr)) {\n+                    throw new AnalysisException(\"Right expr of binary predicate should be value\");\n+                }\n+            }\n+            deleteConditions.add(inPredicate);\n         } else {\n-            throw new AnalysisException(\"Where clause should be compound or binary predicate\");\n+            throw new AnalysisException(\"Where clause should be compound or binary predicate or is_null predicate or in predicate\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae4c78fd2841986e5e4d52e2d3040e3cd23d0cf1"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMyMjQ4NQ==", "bodyText": "Remove unused code", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r462322485", "createdAt": "2020-07-29T14:02:13Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/DeleteHandler.java", "diffHunk": "@@ -507,7 +516,19 @@ private void checkDeleteV2(OlapTable table, Partition partition, List<Predicate>\n                     LiteralExpr.create(value, Type.fromPrimitiveType(column.getDataType()));\n                 } catch (AnalysisException e) {\n                     // ErrorReport.reportDdlException(ErrorCode.ERR_INVALID_VALUE, value);\n-                    throw new DdlException(\"Invalid column value[\" + value + \"]\");\n+                    throw new DdlException(\"Invalid column value[\" + value + \"] for column \" + columnName);\n+                }\n+            } else if (condition instanceof InPredicate) {\n+                String value = null;\n+                try {\n+                    InPredicate inPredicate = (InPredicate) condition;\n+                    for (int i = 1; i <= inPredicate.getInElementNum(); i++) {\n+                        value = ((LiteralExpr) inPredicate.getChild(i)).getStringValue();\n+                        LiteralExpr.create(value, Type.fromPrimitiveType(column.getDataType()));\n+                    }\n+                } catch (AnalysisException e) {\n+                    // ErrorReport.reportDdlException(ErrorCode.ERR_INVALID_VALUE, value);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae4c78fd2841986e5e4d52e2d3040e3cd23d0cf1"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM2MDQwOQ==", "bodyText": "These 2 case (OP_IN and OP_NOT_IN) looks same?", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r462360409", "createdAt": "2020-07-29T14:50:51Z", "author": {"login": "morningman"}, "path": "be/src/olap/olap_cond.cpp", "diffHunk": "@@ -210,19 +192,19 @@ bool Cond::eval(const RowCursorCell& cell) const {\n     case OP_GE:\n         return operand_field->field()->compare_cell(*operand_field, cell) <= 0;\n     case OP_IN: {\n-        for (const WrapperField* field : operand_set) {\n-            if (field->field()->compare_cell(*field, cell) == 0) {\n-                return true;\n-            }\n-        }\n-        return false;\n+        WrapperField wrapperField(const_cast<Field *> (min_value_field->field()), cell);\n+        auto ret = operand_set.find(&wrapperField) != operand_set.end();\n+        wrapperField.release_field();\n+        return ret;\n+    }\n+    case OP_NOT_IN: {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae4c78fd2841986e5e4d52e2d3040e3cd23d0cf1"}, "originalPosition": 144}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM3MDIwMQ==", "bodyText": "I am a little confused.\nA->cmp(B) > 0 means A > B  or A < B?", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r462370201", "createdAt": "2020-07-29T15:03:48Z", "author": {"login": "morningman"}, "path": "be/src/olap/olap_cond.cpp", "diffHunk": "@@ -176,6 +150,14 @@ OLAPStatus Cond::init(const TCondition& tcond, const TabletColumn& column) {\n                                  tcond.column_name.c_str(), operand.c_str(), op);\n                 return res;\n             }\n+            if (min_value_field == nullptr || f->cmp(min_value_field) > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae4c78fd2841986e5e4d52e2d3040e3cd23d0cf1"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM3MjkyNg==", "bodyText": "Add comment to explains these 2 new fields.", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r462372926", "createdAt": "2020-07-29T15:07:26Z", "author": {"login": "morningman"}, "path": "be/src/olap/olap_cond.h", "diffHunk": "@@ -87,11 +88,13 @@ struct Cond {\n     }\n \n     CondOp op;\n-    // valid when op is not OP_IN\n+    // valid when op is not OP_IN and OP_NOT_IN\n     WrapperField* operand_field;\n-    // valid when op is OP_IN\n+    // valid when op is OP_IN or OP_NOT_IN\n     typedef std::unordered_set<const WrapperField*, FieldHash, FieldEqual> FieldSet;\n     FieldSet operand_set;\n+    WrapperField* min_value_field;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae4c78fd2841986e5e4d52e2d3040e3cd23d0cf1"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0b8a9d590023738b59926e0ff404c02833e0d10", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/d0b8a9d590023738b59926e0ff404c02833e0d10", "committedDate": "2020-07-29T16:15:27Z", "message": "small fix"}, "afterCommit": {"oid": "c28df3a3101c268c703510283fcf090df8355eb5", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/c28df3a3101c268c703510283fcf090df8355eb5", "committedDate": "2020-07-30T02:42:41Z", "message": "small fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28085aed599fed7e21cc11883d98f71afbeb086d", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/28085aed599fed7e21cc11883d98f71afbeb086d", "committedDate": "2020-07-30T05:04:54Z", "message": "support in predicate in delete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b73213d1716c0faa219d065bfa7dcecc6b5c5bb", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/2b73213d1716c0faa219d065bfa7dcecc6b5c5bb", "committedDate": "2020-07-30T05:04:54Z", "message": "support in predicate in delete stmt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1c81a9cca14a238cd1da30ba5f26d2e017e1454", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/e1c81a9cca14a238cd1da30ba5f26d2e017e1454", "committedDate": "2020-07-30T05:04:54Z", "message": "Support in and not in predicate in be delete handler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cfbde55339a7da01d9496b1d93da6e88a5cf02f", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/4cfbde55339a7da01d9496b1d93da6e88a5cf02f", "committedDate": "2020-07-30T05:04:55Z", "message": "Support delete with in predicate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd90e851340e7247ea636a5c169e9740b9c74cd9", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/dd90e851340e7247ea636a5c169e9740b9c74cd9", "committedDate": "2020-07-30T05:04:55Z", "message": "remove some unused function and log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d98a7f9b79648b222c17f7e7618e952d54eeeed", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/1d98a7f9b79648b222c17f7e7618e952d54eeeed", "committedDate": "2020-07-30T05:04:55Z", "message": "Add max_allowed_in_element_num_of_delete variable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8739b622918c099a00b995cb3f23ffb29c30b38", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/e8739b622918c099a00b995cb3f23ffb29c30b38", "committedDate": "2020-07-30T05:04:55Z", "message": "Add doc content for max_allowed_in_element_num_of_delete variable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7387ab5174a60a53d7dd3d8d49c25e936c5a41a", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/a7387ab5174a60a53d7dd3d8d49c25e936c5a41a", "committedDate": "2020-07-30T05:04:55Z", "message": "Improve performance of in predicate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad93769e2be04b28658b583540f2a117fe9ae240", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/ad93769e2be04b28658b583540f2a117fe9ae240", "committedDate": "2020-07-30T05:04:55Z", "message": "Fix bug for in predicate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9a1e0dff3f109430ffff7b888be3b655d895509", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/b9a1e0dff3f109430ffff7b888be3b655d895509", "committedDate": "2020-07-30T05:04:55Z", "message": "support fast delete filter with in predicate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8773704a01c3fc6df28252df319a29f23323642e", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/8773704a01c3fc6df28252df319a29f23323642e", "committedDate": "2020-07-30T05:04:55Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27108afdbaeb39d2b93b03bb336de3e7b763ffa3", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/27108afdbaeb39d2b93b03bb336de3e7b763ffa3", "committedDate": "2020-07-30T05:04:55Z", "message": "fix deletehandler unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "722737199ab4addedcada5e968f585b763c7c9bd", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/722737199ab4addedcada5e968f585b763c7c9bd", "committedDate": "2020-07-30T05:04:55Z", "message": "add unit test for delete_handler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e049558e622ed7aff9ef3d2d496ee5ac05982da8", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/e049558e622ed7aff9ef3d2d496ee5ac05982da8", "committedDate": "2020-07-30T05:07:54Z", "message": "fix by review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cafcb4170fa7e6f026219431627f2d31b223ddda", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/cafcb4170fa7e6f026219431627f2d31b223ddda", "committedDate": "2020-07-30T05:07:54Z", "message": "remove unused content from docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e7e2a9a167233628750f9e55ecd8fba35c2ff62", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/1e7e2a9a167233628750f9e55ecd8fba35c2ff62", "committedDate": "2020-07-30T05:07:54Z", "message": "fix in predicate str error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d1c423d5d7872213c3bfe8cf19b8537a67fda85", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/4d1c423d5d7872213c3bfe8cf19b8537a67fda85", "committedDate": "2020-07-30T05:07:54Z", "message": "fix by review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad3dc45050ba362f0fe971d66ae6312d55ac49ec", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/ad3dc45050ba362f0fe971d66ae6312d55ac49ec", "committedDate": "2020-07-30T05:07:54Z", "message": "Add doc content about delete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fc8ae429810ced14cc6c084b912749681d5d340", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/7fc8ae429810ced14cc6c084b912749681d5d340", "committedDate": "2020-07-30T05:07:54Z", "message": "small fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c28df3a3101c268c703510283fcf090df8355eb5", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/c28df3a3101c268c703510283fcf090df8355eb5", "committedDate": "2020-07-30T02:42:41Z", "message": "small fix"}, "afterCommit": {"oid": "7fc8ae429810ced14cc6c084b912749681d5d340", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/7fc8ae429810ced14cc6c084b912749681d5d340", "committedDate": "2020-07-30T05:07:54Z", "message": "small fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTY4MjE5", "url": "https://github.com/apache/incubator-doris/pull/4006#pullrequestreview-459568219", "createdAt": "2020-08-01T10:04:12Z", "commit": {"oid": "7fc8ae429810ced14cc6c084b912749681d5d340"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2777547694b5cfb78149aaf96ed4660ca3eb0bea", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/2777547694b5cfb78149aaf96ed4660ca3eb0bea", "committedDate": "2020-08-01T10:49:25Z", "message": "fix unit test failed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTc2NjAx", "url": "https://github.com/apache/incubator-doris/pull/4006#pullrequestreview-459576601", "createdAt": "2020-08-01T13:00:28Z", "commit": {"oid": "7fc8ae429810ced14cc6c084b912749681d5d340"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMVQxMzowMDoyOFrOG6d33w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMVQxMzo0MjozNFrOG6eEvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk2MDAzMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @ConfField(mutable = true, masterOnly = true)\n          \n          \n            \n                @ConfField(mutable = true)\n          \n      \n    \n    \n  \n\nThis is not a \"master only\" config.", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r463960031", "createdAt": "2020-08-01T13:00:28Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/common/Config.java", "diffHunk": "@@ -1192,4 +1191,11 @@\n      */\n     @ConfField(mutable = true, masterOnly = false)\n     public static int cache_result_max_row_count = 3000;\n+    \n+    /**\n+     * Used to limit element num of InPredicate in delete statement.\n+     */\n+    @ConfField(mutable = true, masterOnly = true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fc8ae429810ced14cc6c084b912749681d5d340"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk2MzMyNQ==", "bodyText": "I think it's better to check the condition.condition_op to see if this condition is InPredicate, not by the size of condition.condition_values.", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r463963325", "createdAt": "2020-08-01T13:42:34Z", "author": {"login": "morningman"}, "path": "be/src/olap/delete_handler.cpp", "diffHunk": "@@ -66,9 +67,22 @@ OLAPStatus DeleteConditionHandler::generate_delete_predicate(\n \n     // \u5b58\u50a8\u5220\u9664\u6761\u4ef6\n     for (const TCondition& condition : conditions) {\n-        string condition_str = construct_sub_predicates(condition);\n-        del_pred->add_sub_predicates(condition_str);\n-        LOG(INFO) << \"store one sub-delete condition. condition=\" << condition_str;\n+        if (condition.condition_values.size() > 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2777547694b5cfb78149aaf96ed4660ca3eb0bea"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTgzNDEw", "url": "https://github.com/apache/incubator-doris/pull/4006#pullrequestreview-459583410", "createdAt": "2020-08-01T14:58:25Z", "commit": {"oid": "2777547694b5cfb78149aaf96ed4660ca3eb0bea"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NzA5MDk1", "url": "https://github.com/apache/incubator-doris/pull/4006#pullrequestreview-459709095", "createdAt": "2020-08-03T02:00:49Z", "commit": {"oid": "2777547694b5cfb78149aaf96ed4660ca3eb0bea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwMjowMDo0OVrOG6p-ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwMjowMDo0OVrOG6p-ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE1ODM3MQ==", "bodyText": "For  protobuf, we prefer optional than required, because we maybe remove or rename column_name from InPredicatePB. Please change all required  to optional.", "url": "https://github.com/apache/incubator-doris/pull/4006#discussion_r464158371", "createdAt": "2020-08-03T02:00:49Z", "author": {"login": "kangkaisen"}, "path": "gensrc/proto/olap_file.proto", "diffHunk": "@@ -181,6 +181,13 @@ enum KeysType {\n message DeletePredicatePB {\n     required int32 version = 1;\n     repeated string sub_predicates = 2;\n+    repeated InPredicatePB in_predicates = 3;\n+}\n+\n+message InPredicatePB {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2777547694b5cfb78149aaf96ed4660ca3eb0bea"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1858a94b0fcbe72748109f5e09134cde21655e5d", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/1858a94b0fcbe72748109f5e09134cde21655e5d", "committedDate": "2020-08-03T07:20:20Z", "message": "Change all required to optional for InPredicatePB"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5ODAzMDQ4", "url": "https://github.com/apache/incubator-doris/pull/4006#pullrequestreview-459803048", "createdAt": "2020-08-03T07:26:06Z", "commit": {"oid": "1858a94b0fcbe72748109f5e09134cde21655e5d"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d090f678c34b49bdee76a6c62110139dc2796468", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/d090f678c34b49bdee76a6c62110139dc2796468", "committedDate": "2020-08-03T11:18:52Z", "message": "fix be ut failed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNDk0ODE0", "url": "https://github.com/apache/incubator-doris/pull/4006#pullrequestreview-460494814", "createdAt": "2020-08-04T04:54:34Z", "commit": {"oid": "d090f678c34b49bdee76a6c62110139dc2796468"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2275, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}