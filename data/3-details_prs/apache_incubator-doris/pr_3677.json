{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyNTA4ODgz", "number": 3677, "title": "Support materialized view load and insert", "bodyText": "This commit mainly supports load bitmap_union, hll_union, and count materialized views.\nThe main changes are as follows:\n1\u3001insert stmt support load extend column\n2\u3001load stmt support load extend column\nIssue : #3344", "createdAt": "2020-05-25T02:02:43Z", "url": "https://github.com/apache/incubator-doris/pull/3677", "merged": true, "mergeCommit": {"oid": "de3c4b198e35533996d33ed858b4f6af1a693f02"}, "closed": true, "closedAt": "2020-07-17T02:43:37Z", "author": {"login": "HangyuanLiu"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABckmO8KAH2gAyNDIyNTA4ODgzOjc4NDYzMzdhNGEzZTJlYTY2YTI4MmNiNGI2OWRmZDZlZmI5YWEzYzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1ZcMAgH2gAyNDIyNTA4ODgzOmEyOTliOGJhYTRkYTI2ZmFlMTZiNWM1NmUzNThmMmJjYTIwNDNhZWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7846337a4a3e2ea66a282cb4b69dfd6efb9aa3c1", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/7846337a4a3e2ea66a282cb4b69dfd6efb9aa3c1", "committedDate": "2020-05-25T02:00:04Z", "message": "support materialized view load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a94db58e9b69532554ac10f372b268da2be42855", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/a94db58e9b69532554ac10f372b268da2be42855", "committedDate": "2020-05-28T06:16:21Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-doris into mv_load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94bd0a09d6e489f068ca1f1e845e522f26001d36", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/94bd0a09d6e489f068ca1f1e845e522f26001d36", "committedDate": "2020-05-28T08:50:41Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-doris into mv_load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "731164f9e4ae446cd89475fbed9c561dd1970bd8", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/731164f9e4ae446cd89475fbed9c561dd1970bd8", "committedDate": "2020-05-29T02:06:53Z", "message": "support materialized view insert statement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65e709c0844be7e32a770dac7a525282ef200bff", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/65e709c0844be7e32a770dac7a525282ef200bff", "committedDate": "2020-05-29T11:56:37Z", "message": "support materialized view insert statement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "208adb6cd6e7e1e13e2d7c71a1ea3a4fddf4d1b3", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/208adb6cd6e7e1e13e2d7c71a1ea3a4fddf4d1b3", "committedDate": "2020-05-30T12:35:30Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-doris into mv_load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a6ae7cbc4ce62e97a44d6a00cd320bbbf35cbb1", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/5a6ae7cbc4ce62e97a44d6a00cd320bbbf35cbb1", "committedDate": "2020-05-30T12:41:44Z", "message": "support materialized view insert statement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ca77be25fd9816f00fa23d9bc10ccc14f695184", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/0ca77be25fd9816f00fa23d9bc10ccc14f695184", "committedDate": "2020-05-30T12:45:10Z", "message": "Merge branch 'mv_load' of github.com:HangyuanLiu/incubator-doris into mv_load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2052dc4f9c787b52635937df05c6498cd3a3d730", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/2052dc4f9c787b52635937df05c6498cd3a3d730", "committedDate": "2020-06-04T07:27:58Z", "message": "fix bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0OTYxMzY0", "url": "https://github.com/apache/incubator-doris/pull/3677#pullrequestreview-424961364", "createdAt": "2020-06-05T02:45:30Z", "commit": {"oid": "2052dc4f9c787b52635937df05c6498cd3a3d730"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwMjo0NTozMFrOGfenYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNTowNTo1OFrOGfghhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY2MDY0Mw==", "bodyText": "Comment about what does this code do", "url": "https://github.com/apache/incubator-doris/pull/3677#discussion_r435660643", "createdAt": "2020-06-05T02:45:30Z", "author": {"login": "imay"}, "path": "fe/src/main/java/org/apache/doris/analysis/InsertStmt.java", "diffHunk": "@@ -453,6 +453,25 @@ private void analyzeSubquery(Analyzer analyzer) throws UserException {\n             }\n         }\n \n+        Map<Integer, Integer> origColIdxsForMVCols = Maps.newHashMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2052dc4f9c787b52635937df05c6498cd3a3d730"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY2MjU2Ng==", "bodyText": "In general, use to in map's name.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Map<Integer, Integer> origColIdxsForMVCols = Maps.newHashMap();\n          \n          \n            \n                    Map<Integer, Integer> origColIdx2MvColIdx = Maps.newHashMap();", "url": "https://github.com/apache/incubator-doris/pull/3677#discussion_r435662566", "createdAt": "2020-06-05T02:53:41Z", "author": {"login": "imay"}, "path": "fe/src/main/java/org/apache/doris/analysis/InsertStmt.java", "diffHunk": "@@ -453,6 +453,25 @@ private void analyzeSubquery(Analyzer analyzer) throws UserException {\n             }\n         }\n \n+        Map<Integer, Integer> origColIdxsForMVCols = Maps.newHashMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2052dc4f9c787b52635937df05c6498cd3a3d730"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY5MTkxMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    //The extension column of the materialized view is added to the expression evaluation of load\n          \n          \n            \n                    // The extension column of the materialized view is added to the expression evaluation of load", "url": "https://github.com/apache/incubator-doris/pull/3677#discussion_r435691910", "createdAt": "2020-06-05T05:05:58Z", "author": {"login": "imay"}, "path": "fe/src/main/java/org/apache/doris/load/Load.java", "diffHunk": "@@ -1013,6 +1013,13 @@ public static void initColumns(Table tbl, List<ImportColumnDesc> columnExprs,\n                 slotDescByName.put(realColName, slotDesc);\n             }\n         }\n+        //The extension column of the materialized view is added to the expression evaluation of load", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2052dc4f9c787b52635937df05c6498cd3a3d730"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae6fc569859a6509b7720faa128f1f61c231948b", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/ae6fc569859a6509b7720faa128f1f61c231948b", "committedDate": "2020-06-06T09:14:51Z", "message": "fix typo and comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MDcyODUz", "url": "https://github.com/apache/incubator-doris/pull/3677#pullrequestreview-426072853", "createdAt": "2020-06-08T09:48:07Z", "commit": {"oid": "ae6fc569859a6509b7720faa128f1f61c231948b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwOTo0ODowN1rOGgWnfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwOTo1MjoxNVrOGgWwag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU3ODE3Mg==", "bodyText": "Please add some example", "url": "https://github.com/apache/incubator-doris/pull/3677#discussion_r436578172", "createdAt": "2020-06-08T09:48:07Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/load/Load.java", "diffHunk": "@@ -1013,6 +1013,13 @@ public static void initColumns(Table tbl, List<ImportColumnDesc> columnExprs,\n                 slotDescByName.put(realColName, slotDesc);\n             }\n         }\n+        // The extension column of the materialized view is added to the expression evaluation of load", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae6fc569859a6509b7720faa128f1f61c231948b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU4MDQ1OA==", "bodyText": "Are you sure that this is correctcolumn(a, tmp_c) set(b=f(c), c=b)\uff1f", "url": "https://github.com/apache/incubator-doris/pull/3677#discussion_r436580458", "createdAt": "2020-06-08T09:52:15Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/load/Load.java", "diffHunk": "@@ -1013,6 +1013,13 @@ public static void initColumns(Table tbl, List<ImportColumnDesc> columnExprs,\n                 slotDescByName.put(realColName, slotDesc);\n             }\n         }\n+        // The extension column of the materialized view is added to the expression evaluation of load\n+        for (Column column : tbl.getFullSchema()) {\n+            if (column.getDefineExpr() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae6fc569859a6509b7720faa128f1f61c231948b"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MDkyOTA3", "url": "https://github.com/apache/incubator-doris/pull/3677#pullrequestreview-426092907", "createdAt": "2020-06-08T10:16:26Z", "commit": {"oid": "ae6fc569859a6509b7720faa128f1f61c231948b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMDoxNjoyN1rOGgXiUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMTozODo1NlrOGgZ5rA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU5MzIzNQ==", "bodyText": "Please abstract function name getRefColumn in Column", "url": "https://github.com/apache/incubator-doris/pull/3677#discussion_r436593235", "createdAt": "2020-06-08T10:16:27Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/analysis/InsertStmt.java", "diffHunk": "@@ -453,6 +453,26 @@ private void analyzeSubquery(Analyzer analyzer) throws UserException {\n             }\n         }\n \n+        //Get the correspondence of this column to the original column through defineExpr\n+        Map<Integer, Integer> origColIdx2MvColIdx = Maps.newHashMap();\n+        for (int mvColumnIdx = 0; mvColumnIdx < targetTable.getFullSchema().size(); ++mvColumnIdx) {\n+            Column column = targetTable.getFullSchema().get(mvColumnIdx);\n+            if (column.isNameWithPrefix(CreateMaterializedViewStmt.MATERIALIZED_VIEW_NAME_PRFIX)) {\n+                List<Expr> slots = new ArrayList<>();\n+                column.getDefineExpr().collect(SlotRef.class, slots);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae6fc569859a6509b7720faa128f1f61c231948b"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYwMjM4Nw==", "bodyText": "Do not use the index of origin col. The fullSchema may be rebuilt and the index of origin col may be changed.", "url": "https://github.com/apache/incubator-doris/pull/3677#discussion_r436602387", "createdAt": "2020-06-08T10:34:46Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/analysis/InsertStmt.java", "diffHunk": "@@ -453,6 +453,26 @@ private void analyzeSubquery(Analyzer analyzer) throws UserException {\n             }\n         }\n \n+        //Get the correspondence of this column to the original column through defineExpr\n+        Map<Integer, Integer> origColIdx2MvColIdx = Maps.newHashMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae6fc569859a6509b7720faa128f1f61c231948b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzMDI5Ng==", "bodyText": "mvColumnIdxToOrigColumnIdx?", "url": "https://github.com/apache/incubator-doris/pull/3677#discussion_r436630296", "createdAt": "2020-06-08T11:35:06Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/analysis/InsertStmt.java", "diffHunk": "@@ -453,6 +453,26 @@ private void analyzeSubquery(Analyzer analyzer) throws UserException {\n             }\n         }\n \n+        //Get the correspondence of this column to the original column through defineExpr\n+        Map<Integer, Integer> origColIdx2MvColIdx = Maps.newHashMap();\n+        for (int mvColumnIdx = 0; mvColumnIdx < targetTable.getFullSchema().size(); ++mvColumnIdx) {\n+            Column column = targetTable.getFullSchema().get(mvColumnIdx);\n+            if (column.isNameWithPrefix(CreateMaterializedViewStmt.MATERIALIZED_VIEW_NAME_PRFIX)) {\n+                List<Expr> slots = new ArrayList<>();\n+                column.getDefineExpr().collect(SlotRef.class, slots);\n+                //We only support one children of define expr in materialized view column\n+                Preconditions.checkArgument(slots.size() == 1);\n+                String origName = ((SlotRef) slots.get(0)).getColumnName();\n+                for (int originColumnIdx = 0; originColumnIdx < targetColumns.size(); originColumnIdx++) {\n+                    if (targetColumns.get(originColumnIdx).nameEquals(origName, false)) {\n+                        origColIdx2MvColIdx.put(mvColumnIdx, originColumnIdx);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae6fc569859a6509b7720faa128f1f61c231948b"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzMTk4MA==", "bodyText": "The key of origColIdx2MvColIdx is mvColIdx. The mvColumn has been supplied at the end of result exprs in query stmt. So I think it is not match.", "url": "https://github.com/apache/incubator-doris/pull/3677#discussion_r436631980", "createdAt": "2020-06-08T11:38:56Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/analysis/InsertStmt.java", "diffHunk": "@@ -519,17 +556,23 @@ private void analyzeSubquery(Analyzer analyzer) throws UserException {\n         }\n \n         // expand baseTblResultExprs and colLabels in QueryStmt\n-        if (!origColIdxsForShadowCols.isEmpty()) {\n+        if (!origColIdxsForShadowCols.isEmpty() || !origColIdx2MvColIdx.isEmpty()) {\n             if (queryStmt.getResultExprs().size() != queryStmt.getBaseTblResultExprs().size()) {\n                 for (Integer idx : origColIdxsForShadowCols) {\n                     queryStmt.getBaseTblResultExprs().add(queryStmt.getBaseTblResultExprs().get(idx));\n                 }\n+                for (Integer idx : origColIdx2MvColIdx.keySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae6fc569859a6509b7720faa128f1f61c231948b"}, "originalPosition": 79}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MTU0MTQ3", "url": "https://github.com/apache/incubator-doris/pull/3677#pullrequestreview-426154147", "createdAt": "2020-06-08T11:54:59Z", "commit": {"oid": "ae6fc569859a6509b7720faa128f1f61c231948b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMTo1NDo1OVrOGgaVlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMTo1NDo1OVrOGgaVlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzOTEyNg==", "bodyText": "Please add example of mv column and schema change column", "url": "https://github.com/apache/incubator-doris/pull/3677#discussion_r436639126", "createdAt": "2020-06-08T11:54:59Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/analysis/InsertStmt.java", "diffHunk": "@@ -453,6 +453,26 @@ private void analyzeSubquery(Analyzer analyzer) throws UserException {\n             }\n         }\n \n+        //Get the correspondence of this column to the original column through defineExpr", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae6fc569859a6509b7720faa128f1f61c231948b"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31b8d9656ac9f43210be845df98ffffd5b8cd937", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/31b8d9656ac9f43210be845df98ffffd5b8cd937", "committedDate": "2020-06-09T06:31:38Z", "message": "fix bug"}, "afterCommit": {"oid": "6186e6e01cf5ba10551476325f1b43c02f0074b2", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/6186e6e01cf5ba10551476325f1b43c02f0074b2", "committedDate": "2020-06-09T07:58:27Z", "message": "fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22d18bc8ac09dbb3f187cfd728c1cfb9d30a254f", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/22d18bc8ac09dbb3f187cfd728c1cfb9d30a254f", "committedDate": "2020-06-10T13:25:54Z", "message": "fix bug"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6186e6e01cf5ba10551476325f1b43c02f0074b2", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/6186e6e01cf5ba10551476325f1b43c02f0074b2", "committedDate": "2020-06-09T07:58:27Z", "message": "fix bug"}, "afterCommit": {"oid": "22d18bc8ac09dbb3f187cfd728c1cfb9d30a254f", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/22d18bc8ac09dbb3f187cfd728c1cfb9d30a254f", "committedDate": "2020-06-10T13:25:54Z", "message": "fix bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMTMzODU0", "url": "https://github.com/apache/incubator-doris/pull/3677#pullrequestreview-430133854", "createdAt": "2020-06-13T11:48:48Z", "commit": {"oid": "22d18bc8ac09dbb3f187cfd728c1cfb9d30a254f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMzA2NjIw", "url": "https://github.com/apache/incubator-doris/pull/3677#pullrequestreview-430306620", "createdAt": "2020-06-15T03:51:15Z", "commit": {"oid": "22d18bc8ac09dbb3f187cfd728c1cfb9d30a254f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwMzo1MToxNVrOGjicZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwNDo0NzowMlrOGjjFmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkxNzY3MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     * origColIdx2MVColumn has 1 element: \"3, __doris_materialized_view_bitmap_union_C\"\n          \n          \n            \n                     * origColIdx2MVColumn has 1 element: \"2, __doris_materialized_view_bitmap_union_C\"", "url": "https://github.com/apache/incubator-doris/pull/3677#discussion_r439917670", "createdAt": "2020-06-15T03:51:15Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/analysis/InsertStmt.java", "diffHunk": "@@ -453,19 +454,25 @@ private void analyzeSubquery(Analyzer analyzer) throws UserException {\n             }\n         }\n \n-        //Get the correspondence of this column to the original column through defineExpr\n-        Map<Integer, Integer> origColIdx2MvColIdx = Maps.newHashMap();\n-        for (int mvColumnIdx = 0; mvColumnIdx < targetTable.getFullSchema().size(); ++mvColumnIdx) {\n-            Column column = targetTable.getFullSchema().get(mvColumnIdx);\n+        /*\n+         * When table have materialized view, there may be some materialized view columns.\n+         * we should add them to the end of targetColumns.\n+         * eg: origin targetColumns: (A,B,C), shadow column: __doris_materialized_view_bitmap_union_C\n+         * after processing, targetColumns: (A, B, C, __doris_materialized_view_bitmap_union_C), and\n+         * origColIdx2MVColumn has 1 element: \"3, __doris_materialized_view_bitmap_union_C\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22d18bc8ac09dbb3f187cfd728c1cfb9d30a254f"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkxNzk1Mg==", "bodyText": "Better  to show which field is error.", "url": "https://github.com/apache/incubator-doris/pull/3677#discussion_r439917952", "createdAt": "2020-06-15T03:52:42Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/analysis/InsertStmt.java", "diffHunk": "@@ -453,19 +454,25 @@ private void analyzeSubquery(Analyzer analyzer) throws UserException {\n             }\n         }\n \n-        //Get the correspondence of this column to the original column through defineExpr\n-        Map<Integer, Integer> origColIdx2MvColIdx = Maps.newHashMap();\n-        for (int mvColumnIdx = 0; mvColumnIdx < targetTable.getFullSchema().size(); ++mvColumnIdx) {\n-            Column column = targetTable.getFullSchema().get(mvColumnIdx);\n+        /*\n+         * When table have materialized view, there may be some materialized view columns.\n+         * we should add them to the end of targetColumns.\n+         * eg: origin targetColumns: (A,B,C), shadow column: __doris_materialized_view_bitmap_union_C\n+         * after processing, targetColumns: (A, B, C, __doris_materialized_view_bitmap_union_C), and\n+         * origColIdx2MVColumn has 1 element: \"3, __doris_materialized_view_bitmap_union_C\"\n+         * will be used in as a mapping from queryStmt.getResultExprs() to targetColumns define expr\n+         */\n+        List<Pair<Integer, Column>>  origColIdx2MVColumn = Lists.newArrayList();\n+        for (Column column : targetTable.getFullSchema()) {\n             if (column.isNameWithPrefix(CreateMaterializedViewStmt.MATERIALIZED_VIEW_NAME_PRFIX)) {\n-                List<Expr> slots = new ArrayList<>();\n-                column.getDefineExpr().collect(SlotRef.class, slots);\n-                //We only support one children of define expr in materialized view column\n-                Preconditions.checkArgument(slots.size() == 1);\n-                String origName = ((SlotRef) slots.get(0)).getColumnName();\n+                SlotRef refColumn = column.getRefColumn();\n+                if (refColumn == null) {\n+                    ErrorReport.reportAnalysisException(ErrorCode.ERR_BAD_FIELD_ERROR);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22d18bc8ac09dbb3f187cfd728c1cfb9d30a254f"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkyODIxOQ==", "bodyText": "What's different between resultExpr and baseTblResultExpr", "url": "https://github.com/apache/incubator-doris/pull/3677#discussion_r439928219", "createdAt": "2020-06-15T04:47:02Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/analysis/InsertStmt.java", "diffHunk": "@@ -521,22 +530,22 @@ private void analyzeSubquery(Analyzer analyzer) throws UserException {\n                 // extend the result expr by duplicating the related exprs\n                 for (Integer idx : origColIdxsForShadowCols) {\n                     queryStmt.getResultExprs().add(queryStmt.getResultExprs().get(idx));\n+                    queryStmt.getBaseTblResultExprs().add(queryStmt.getResultExprs().get(idx));\n                 }\n             }\n \n-            if (!origColIdx2MvColIdx.isEmpty()) {\n-                origColIdx2MvColIdx.forEach((key, value) -> {\n-                    Column mvColumn = targetTable.getFullSchema().get(key);\n-                    Expr expr = mvColumn.getDefineExpr();\n-                    ArrayList<SlotRef> slots = new ArrayList<>();\n-                    expr.collect(SlotRef.class, slots);\n-\n+            if (!origColIdx2MVColumn.isEmpty()) {\n+                origColIdx2MVColumn.forEach(entry -> {\n+                    Integer origColIdx = entry.first;\n+                    Column mvColumn = entry.second;\n                     //substitute define expr slot with select statement result expr\n                     ExprSubstitutionMap smap = new ExprSubstitutionMap();\n-                    smap.getLhs().add(slots.get(0));\n-                    smap.getRhs().add(queryStmt.getResultExprs().get(value));\n+                    smap.getLhs().add(mvColumn.getRefColumn());\n+                    smap.getRhs().add(queryStmt.getResultExprs().get(origColIdx));\n \n-                    queryStmt.getResultExprs().add(Expr.substituteList(Lists.newArrayList(expr), smap, analyzer, false).get(0));\n+                    Expr e = Expr.substituteList(Lists.newArrayList(mvColumn.getDefineExpr()), smap, analyzer, false).get(0);\n+                    queryStmt.getResultExprs().add(e);\n+                    queryStmt.getBaseTblResultExprs().add(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22d18bc8ac09dbb3f187cfd728c1cfb9d30a254f"}, "originalPosition": 97}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49e89cc9ee94b889be104ed55dbc3221a91d2449", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/49e89cc9ee94b889be104ed55dbc3221a91d2449", "committedDate": "2020-06-15T06:54:00Z", "message": "Merge branch 'mv_load' of github.com:HangyuanLiu/incubator-doris into mv_load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49d59006279e2eaca9e4b4d74d47d40884d950d0", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/49d59006279e2eaca9e4b4d74d47d40884d950d0", "committedDate": "2020-06-15T07:14:52Z", "message": "unify shadow column and mv column"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b6b589c583fbd3153995a44279b3e4f0fed972e", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/4b6b589c583fbd3153995a44279b3e4f0fed972e", "committedDate": "2020-07-10T13:40:46Z", "message": "fix bug : define expr should add cast node"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4ODk0MjA2", "url": "https://github.com/apache/incubator-doris/pull/3677#pullrequestreview-448894206", "createdAt": "2020-07-15T12:15:40Z", "commit": {"oid": "4b6b589c583fbd3153995a44279b3e4f0fed972e"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMjoxNTo0MFrOGx7WWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMjoyNTozMVrOGx7reQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAwNTc4NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     * eg: origin targetColumns: (A,B,C), shadow column: __doris_materialized_view_bitmap_union_C\n          \n          \n            \n                     * eg: origin targetColumns: (A,B,C), shadow column: mv_bitmap_union_C", "url": "https://github.com/apache/incubator-doris/pull/3677#discussion_r455005784", "createdAt": "2020-07-15T12:15:40Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/analysis/InsertStmt.java", "diffHunk": "@@ -437,15 +438,36 @@ private void analyzeSubquery(Analyzer analyzer) throws UserException {\n          * Rule A: If the column which the shadow column related to is not mentioned,\n          * then do not add the shadow column to targetColumns. They will be filled by\n          * null or default value when loading.\n+         *\n+         * When table have materialized view, there may be some materialized view columns.\n+         * we should add them to the end of targetColumns.\n+         * eg: origin targetColumns: (A,B,C), shadow column: __doris_materialized_view_bitmap_union_C", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b6b589c583fbd3153995a44279b3e4f0fed972e"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAwNTg5Nw==", "bodyText": "same as above", "url": "https://github.com/apache/incubator-doris/pull/3677#discussion_r455005897", "createdAt": "2020-07-15T12:15:50Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/analysis/InsertStmt.java", "diffHunk": "@@ -437,15 +438,36 @@ private void analyzeSubquery(Analyzer analyzer) throws UserException {\n          * Rule A: If the column which the shadow column related to is not mentioned,\n          * then do not add the shadow column to targetColumns. They will be filled by\n          * null or default value when loading.\n+         *\n+         * When table have materialized view, there may be some materialized view columns.\n+         * we should add them to the end of targetColumns.\n+         * eg: origin targetColumns: (A,B,C), shadow column: __doris_materialized_view_bitmap_union_C\n+         * after processing, targetColumns: (A, B, C, __doris_materialized_view_bitmap_union_C), and", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b6b589c583fbd3153995a44279b3e4f0fed972e"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAwNzg1NQ==", "bodyText": "The shadow cols is not meaningful. Maybe extend ?", "url": "https://github.com/apache/incubator-doris/pull/3677#discussion_r455007855", "createdAt": "2020-07-15T12:19:28Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/analysis/InsertStmt.java", "diffHunk": "@@ -437,15 +438,36 @@ private void analyzeSubquery(Analyzer analyzer) throws UserException {\n          * Rule A: If the column which the shadow column related to is not mentioned,\n          * then do not add the shadow column to targetColumns. They will be filled by\n          * null or default value when loading.\n+         *\n+         * When table have materialized view, there may be some materialized view columns.\n+         * we should add them to the end of targetColumns.\n+         * eg: origin targetColumns: (A,B,C), shadow column: __doris_materialized_view_bitmap_union_C\n+         * after processing, targetColumns: (A, B, C, __doris_materialized_view_bitmap_union_C), and\n+         * origColIdx2MVColumn has 1 element: \"2, __doris_materialized_view_bitmap_union_C\"\n+         * will be used in as a mapping from queryStmt.getResultExprs() to targetColumns define expr\n          */\n-        List<Integer> origColIdxsForShadowCols = Lists.newArrayList();\n+        List<Pair<Integer, Column>> origColIdxsForShadowCols = Lists.newArrayList();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b6b589c583fbd3153995a44279b3e4f0fed972e"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAxMTE5Mw==", "bodyText": "Totally same as the result expr of query stmt?", "url": "https://github.com/apache/incubator-doris/pull/3677#discussion_r455011193", "createdAt": "2020-07-15T12:25:31Z", "author": {"login": "EmmyMiao87"}, "path": "fe/src/main/java/org/apache/doris/analysis/InsertStmt.java", "diffHunk": "@@ -518,17 +550,26 @@ private void analyzeSubquery(Analyzer analyzer) throws UserException {\n             }\n         }\n \n-        // expand baseTblResultExprs and colLabels in QueryStmt\n+        // expand colLabels in QueryStmt\n         if (!origColIdxsForShadowCols.isEmpty()) {\n             if (queryStmt.getResultExprs().size() != queryStmt.getBaseTblResultExprs().size()) {\n-                for (Integer idx : origColIdxsForShadowCols) {\n-                    queryStmt.getBaseTblResultExprs().add(queryStmt.getBaseTblResultExprs().get(idx));\n+                for (Pair<Integer, Column> entry  : origColIdxsForShadowCols) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b6b589c583fbd3153995a44279b3e4f0fed972e"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29b8062bff822512312c8eb647e53c921d03184e", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/29b8062bff822512312c8eb647e53c921d03184e", "committedDate": "2020-07-16T03:40:00Z", "message": "fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd6435ba60cf661d6a49d7e1226e502aa72480e6", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/fd6435ba60cf661d6a49d7e1226e502aa72480e6", "committedDate": "2020-07-16T03:40:51Z", "message": "Merge branch 'mv_load' of github.com:HangyuanLiu/incubator-doris into mv_load"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NDg2ODAz", "url": "https://github.com/apache/incubator-doris/pull/3677#pullrequestreview-449486803", "createdAt": "2020-07-16T03:45:11Z", "commit": {"oid": "29b8062bff822512312c8eb647e53c921d03184e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a299b8baa4da26fae16b5c56e358f2bca2043aeb", "author": {"user": {"login": "HangyuanLiu", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/a299b8baa4da26fae16b5c56e358f2bca2043aeb", "committedDate": "2020-07-16T06:42:29Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-doris into mv_load"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2751, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}