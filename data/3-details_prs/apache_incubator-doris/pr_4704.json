{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5MDM0NTA1", "number": 4704, "title": "[Feature][Config] Support persistence of configuration items modified at runtime", "bodyText": "Proposed changes\nSupport persistence of configuration items modified at runtime via HTTP API.\nFE:\nGET /api/_set_config?key=value&persist=true\n\nBE\nPOST /api/update_config?key=value&persist=true\n\nThe modified config will be saved in fe_custom.conf or be_custom.conf.\nAnd when process starts, it will load fe.conf/be.conf first, then fe_custom.conf/be_custom.conf.\nTypes of changes\n\n New feature (non-breaking change which adds functionality)\n\nChecklist\n\n I have create an issue on (Fix #4703), and have described the bug/feature there in detail\n If this change need a document change, I have updated the document", "createdAt": "2020-10-07T07:10:16Z", "url": "https://github.com/apache/incubator-doris/pull/4704", "merged": true, "mergeCommit": {"oid": "0213e93ea1ac0b6720514444dd1b8d6bc679cab1"}, "closed": true, "closedAt": "2020-10-22T13:39:03Z", "author": {"login": "morningman"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQiB4XgBqjM4NTU2MDY5OTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUmTMugFqTUxMzMxMTQ0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19f2256a8fda10ccf4ab702ef2269eae851ce212", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/19f2256a8fda10ccf4ab702ef2269eae851ce212", "committedDate": "2020-10-08T12:56:32Z", "message": "fix ut"}, "afterCommit": {"oid": "02e5de2a4f9fc5da2f3341ed28096bceab284948", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/02e5de2a4f9fc5da2f3341ed28096bceab284948", "committedDate": "2020-10-08T13:58:37Z", "message": "fix ut"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MzIwOTA0", "url": "https://github.com/apache/incubator-doris/pull/4704#pullrequestreview-505320904", "createdAt": "2020-10-09T02:30:57Z", "commit": {"oid": "02e5de2a4f9fc5da2f3341ed28096bceab284948"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwMjozMDo1N1rOHe4i8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwMjo0MzoxOVrOHe49aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE0NTc3Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                out << \"# will overwrite the configurations in fe.conf\\n\";\n          \n          \n            \n                out << \"# will overwrite the configurations in be.conf\\n\";", "url": "https://github.com/apache/incubator-doris/pull/4704#discussion_r502145777", "createdAt": "2020-10-09T02:30:57Z", "author": {"login": "acelyc111"}, "path": "be/src/common/configbase.cpp", "diffHunk": "@@ -227,6 +231,34 @@ bool Properties::get(const char* key, const char* defstr, T& retval) const {\n     return strtox(valstr, retval);\n }\n \n+void Properties::set(const std::string& key, const std::string& val) {\n+    file_conf_map.emplace(key, val);\n+}\n+\n+bool Properties::dump(const std::string& conffile) {\n+    std::vector<std::string> files = { conffile };\n+    Status st = FileSystemUtil::remove_paths(files); \n+    if (!st.ok()) {\n+        return false;\n+    }\n+    st = FileSystemUtil::create_file(conffile);\n+    if (!st.ok()) {\n+        return false;\n+    }\n+\n+    std::ofstream out(conffile);\n+    out << \"# THIS IS AN AUTO GENERATED CONFIG FILE.\\n\";\n+    out << \"# You can modify this file manually, and the configurations in this file\\n\";\n+    out << \"# will overwrite the configurations in fe.conf\\n\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02e5de2a4f9fc5da2f3341ed28096bceab284948"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE1MDM3MA==", "bodyText": "I think you should also describe the optional parameter persist in error message.", "url": "https://github.com/apache/incubator-doris/pull/4704#discussion_r502150370", "createdAt": "2020-10-09T02:39:29Z", "author": {"login": "acelyc111"}, "path": "be/src/http/action/update_config_action.cpp", "diffHunk": "@@ -38,25 +38,53 @@ namespace doris {\n \n const static std::string HEADER_JSON = \"application/json\";\n \n+const static std::string PERSIST_PARAM = \"persist\";\n+\n void UpdateConfigAction::handle(HttpRequest* req) {\n     LOG(INFO) << req->debug_string();\n \n     Status s;\n     std::string msg;\n-    if (req->params()->size() != 1) {\n+    // We only support set one config at a time, and along with a optional param \"persist\".\n+    // So the number of query params should at most be 2.\n+    if (req->params()->size() > 2 || req->params()->size() < 1) {\n         s = Status::InvalidArgument(\"\");\n         msg = \"Now only support to set a single config once, via 'config_name=new_value'\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02e5de2a4f9fc5da2f3341ed28096bceab284948"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE1MDYxNg==", "bodyText": "Same", "url": "https://github.com/apache/incubator-doris/pull/4704#discussion_r502150616", "createdAt": "2020-10-09T02:39:54Z", "author": {"login": "acelyc111"}, "path": "be/src/http/action/update_config_action.cpp", "diffHunk": "@@ -38,25 +38,53 @@ namespace doris {\n \n const static std::string HEADER_JSON = \"application/json\";\n \n+const static std::string PERSIST_PARAM = \"persist\";\n+\n void UpdateConfigAction::handle(HttpRequest* req) {\n     LOG(INFO) << req->debug_string();\n \n     Status s;\n     std::string msg;\n-    if (req->params()->size() != 1) {\n+    // We only support set one config at a time, and along with a optional param \"persist\".\n+    // So the number of query params should at most be 2.\n+    if (req->params()->size() > 2 || req->params()->size() < 1) {\n         s = Status::InvalidArgument(\"\");\n         msg = \"Now only support to set a single config once, via 'config_name=new_value'\";\n     } else {\n-        DCHECK(req->params()->size() == 1);\n-        const std::string& config = req->params()->begin()->first;\n-        const std::string& new_value = req->params()->begin()->second;\n-        s = config::set_config(config, new_value);\n-        if (s.ok()) {\n-            LOG(INFO) << \"set_config \" << config << \"=\" << new_value << \" success\";\n-        } else {\n-            LOG(WARNING) << \"set_config \" << config << \"=\" << new_value << \" failed\";\n-            msg = strings::Substitute(\"set $0=$1 failed, reason: $2\", config, new_value,\n-                                      s.to_string());\n+        if (req->params()->size() == 1) {\n+            const std::string& config = req->params()->begin()->first;\n+            const std::string& new_value = req->params()->begin()->second;\n+            s = config::set_config(config, new_value, false);\n+            if (s.ok()) {\n+                LOG(INFO) << \"set_config \" << config << \"=\" << new_value << \" success\";\n+            } else {\n+                LOG(WARNING) << \"set_config \" << config << \"=\" << new_value << \" failed\";\n+                msg = strings::Substitute(\"set $0=$1 failed, reason: $2\", config, new_value,\n+                        s.to_string());\n+            }\n+        } else if (req->params()->size() == 2) {\n+            if (req->params()->find(PERSIST_PARAM) == req->params()->end()) {\n+                s = Status::InvalidArgument(\"\");\n+                msg = \"Now only support to set a single config once, via 'config_name=new_value'\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02e5de2a4f9fc5da2f3341ed28096bceab284948"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE1MTYzNg==", "bodyText": "... is used for recording ... ?", "url": "https://github.com/apache/incubator-doris/pull/4704#discussion_r502151636", "createdAt": "2020-10-09T02:41:40Z", "author": {"login": "acelyc111"}, "path": "docs/en/administrator-guide/config/be_config.md", "diffHunk": "@@ -30,51 +30,70 @@ under the License.\n \n This document mainly introduces the relevant configuration items of BE.\n \n+The BE configuration file `be.conf` is usually stored in the `conf/` directory of the BE deployment path. In version 0.14, another configuration file `be_custom.conf` will be introduced. The configuration file is used to record the configuration items that are dynamically configured and persisted by the user during operation.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02e5de2a4f9fc5da2f3341ed28096bceab284948"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE1MjU1NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                curl -X POST http://{be_ip}:{be_http_port}/api/update_config?{key}={value}&persis=true'\n          \n          \n            \n                curl -X POST http://{be_ip}:{be_http_port}/api/update_config?{key}={value}&persist=true'", "url": "https://github.com/apache/incubator-doris/pull/4704#discussion_r502152555", "createdAt": "2020-10-09T02:43:19Z", "author": {"login": "acelyc111"}, "path": "docs/en/administrator-guide/config/be_config.md", "diffHunk": "@@ -30,51 +30,70 @@ under the License.\n \n This document mainly introduces the relevant configuration items of BE.\n \n+The BE configuration file `be.conf` is usually stored in the `conf/` directory of the BE deployment path. In version 0.14, another configuration file `be_custom.conf` will be introduced. The configuration file is used to record the configuration items that are dynamically configured and persisted by the user during operation.\n+\n+After the BE process is started, it will read the configuration items in `be.conf` first, and then read the configuration items in `be_custom.conf`. The configuration items in `be_custom.conf` will overwrite the same configuration items in `be.conf`.\n+\n ## View configuration items\n-(TODO)\n+\n+Users can view the current configuration items by visiting BE's web page:\n+\n+`http://be_host:be_webserver_port/varz`\n \n ## Set configuration items\n \n There are two ways to configure BE configuration items:\n \n 1. Static configuration\n \n-         Add and set configuration items in the `conf/be.conf` file. The configuration items in `be.conf` will be read when BE starts. Configuration items not in `be.conf` will use default values.\n+    Add and set configuration items in the `conf/be.conf` file. The configuration items in `be.conf` will be read when BE starts. Configuration items not in `be.conf` will use default values.\n \n 2. Dynamic configuration\n \n-         After BE starts, the configuration items can be dynamically set with the following commands.\n+    After BE starts, the configuration items can be dynamically set with the following commands.\n+\n+    ```\n+    curl -X POST http://{be_ip}:{be_http_port}/api/update_config?{key}={value}'\n+    ```\n \n-         ```curl -X POST http://{be_ip}:{be_http_port}/api/update_config?{key}={value}'```\n+    In version 0.13 and before, the configuration items modified in this way will become invalid after the BE process restarts. In 0.14 and later versions, the modified configuration can be persisted through the following command. The modified configuration items are stored in the `be_custom.conf` file.\n \n-         **Configuration items modified in this way will become invalid after the BE process restarts. **\n+    ```\n+    curl -X POST http://{be_ip}:{be_http_port}/api/update_config?{key}={value}&persis=true'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02e5de2a4f9fc5da2f3341ed28096bceab284948"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NjUyMzEz", "url": "https://github.com/apache/incubator-doris/pull/4704#pullrequestreview-505652313", "createdAt": "2020-10-09T13:04:33Z", "commit": {"oid": "02e5de2a4f9fc5da2f3341ed28096bceab284948"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzowNDozM1rOHfI0Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzowODoyM1rOHfI9Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQxMjM4Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tcurl -X POST http://{be_ip}:{be_http_port}/api/update_config?{key}={value}&persis=true'\n          \n          \n            \n            \tcurl -X POST http://{be_ip}:{be_http_port}/api/update_config?{key}={value}&persist=true'", "url": "https://github.com/apache/incubator-doris/pull/4704#discussion_r502412386", "createdAt": "2020-10-09T13:04:33Z", "author": {"login": "xy720"}, "path": "docs/zh-CN/administrator-guide/config/be_config.md", "diffHunk": "@@ -45,9 +52,15 @@ BE \u7684\u914d\u7f6e\u9879\u6709\u4e24\u79cd\u65b9\u5f0f\u8fdb\u884c\u914d\u7f6e\uff1a\n \n \tBE \u542f\u52a8\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e00\u4e0b\u547d\u4ee4\u52a8\u6001\u8bbe\u7f6e\u914d\u7f6e\u9879\u3002\n \n-\t```curl -X POST http://{be_ip}:{be_http_port}/api/update_config?{key}={value}'```\n+\t```\n+\tcurl -X POST http://{be_ip}:{be_http_port}/api/update_config?{key}={value}'\n+\t```\n \n-\t**\u901a\u8fc7\u8be5\u65b9\u5f0f\u4fee\u6539\u7684\u914d\u7f6e\u9879\u5c06\u5728 BE \u8fdb\u7a0b\u91cd\u542f\u540e\u5931\u6548\u3002**\n+\t\u5728 0.13 \u7248\u672c\u53ca\u4e4b\u524d\uff0c\u901a\u8fc7\u8be5\u65b9\u5f0f\u4fee\u6539\u7684\u914d\u7f6e\u9879\u5c06\u5728 BE \u8fdb\u7a0b\u91cd\u542f\u540e\u5931\u6548\u3002\u5728 0.14 \u53ca\u4e4b\u540e\u7248\u672c\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u6301\u4e45\u5316\u4fee\u6539\u540e\u7684\u914d\u7f6e\u3002\u4fee\u6539\u540e\u7684\u914d\u7f6e\u9879\u5b58\u50a8\u5728 `be_custom.conf` \u6587\u4ef6\u4e2d\u3002\n+\t\n+\t```\n+\tcurl -X POST http://{be_ip}:{be_http_port}/api/update_config?{key}={value}&persis=true'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02e5de2a4f9fc5da2f3341ed28096bceab284948"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQxNDYwMg==", "bodyText": "I think users can edit this file if they need to.", "url": "https://github.com/apache/incubator-doris/pull/4704#discussion_r502414602", "createdAt": "2020-10-09T13:08:23Z", "author": {"login": "xy720"}, "path": "fe/fe-core/src/main/java/org/apache/doris/common/ConfigBase.java", "diffHunk": "@@ -284,4 +308,31 @@ public synchronized static boolean checkIsMasterOnly(String key) {\n \n         return anno.masterOnly();\n     }\n+\n+    // overwrite configs to customConfFile.\n+    // use synchronized to make sure only one thread modify this file\n+    public synchronized static void persistConfig(Map<String, String> customConf) throws IOException {\n+        File file = new File(customConfFile);\n+        if (!file.exists()) {\n+            file.createNewFile();\n+        } else {\n+            // clear the file content\n+            try (PrintWriter writer = new PrintWriter(file)) {\n+                writer.print(\"\");\n+            }\n+        }\n+\n+        Properties props = new Properties();\n+        props.load(new FileReader(customConfFile));\n+\n+        for (Map.Entry<String, String> entry : customConf.entrySet()) {\n+            props.setProperty(entry.getKey(), entry.getValue());\n+        }\n+\n+        try (FileOutputStream fos = new FileOutputStream(file)) {\n+            props.store(fos, \"THIS IS AN AUTO GENERATED CONFIG FILE. DO NOT EDIT IT!\\n\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02e5de2a4f9fc5da2f3341ed28096bceab284948"}, "originalPosition": 113}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0393d9734171a2fe237cb2151adc970afd4b7fd", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/a0393d9734171a2fe237cb2151adc970afd4b7fd", "committedDate": "2020-10-10T04:10:17Z", "message": "fix by review"}, "afterCommit": {"oid": "330e656407314e24fa3544cc90336eda3be4b1f3", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/330e656407314e24fa3544cc90336eda3be4b1f3", "committedDate": "2020-10-12T04:25:56Z", "message": "fix by review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMjc0MjY3", "url": "https://github.com/apache/incubator-doris/pull/4704#pullrequestreview-512274267", "createdAt": "2020-10-20T01:50:44Z", "commit": {"oid": "330e656407314e24fa3544cc90336eda3be4b1f3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a67bb896fcce539f7a49a54d89135e55118b8828", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/a67bb896fcce539f7a49a54d89135e55118b8828", "committedDate": "2020-10-20T03:59:04Z", "message": "first"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f43137e5d17208ad94fe9bed704375581b49a646", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/f43137e5d17208ad94fe9bed704375581b49a646", "committedDate": "2020-10-20T03:59:04Z", "message": "second"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e81d43a1571f37a73e35e1049a1efc841845876", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/3e81d43a1571f37a73e35e1049a1efc841845876", "committedDate": "2020-10-20T03:59:04Z", "message": "be config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e976d464147025ef197b090e7d52bf9b922aeeaa", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/e976d464147025ef197b090e7d52bf9b922aeeaa", "committedDate": "2020-10-20T03:59:05Z", "message": "doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebf4216ab5a946a8527962b641aa3ac6ffde0127", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/ebf4216ab5a946a8527962b641aa3ac6ffde0127", "committedDate": "2020-10-20T03:59:05Z", "message": "fix ut"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c71bf55b2dedb55af79a74037c33c511b602344", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/4c71bf55b2dedb55af79a74037c33c511b602344", "committedDate": "2020-10-20T03:59:05Z", "message": "fix by review"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "330e656407314e24fa3544cc90336eda3be4b1f3", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/330e656407314e24fa3544cc90336eda3be4b1f3", "committedDate": "2020-10-12T04:25:56Z", "message": "fix by review"}, "afterCommit": {"oid": "4c71bf55b2dedb55af79a74037c33c511b602344", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/4c71bf55b2dedb55af79a74037c33c511b602344", "committedDate": "2020-10-20T03:59:05Z", "message": "fix by review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c9190cdba43e34fbb374ecf555215c0fe0e1c38", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/3c9190cdba43e34fbb374ecf555215c0fe0e1c38", "committedDate": "2020-10-20T04:24:27Z", "message": "add custom config dir config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88a5b19cf0b28d0cf89916e388739169f8e46a06", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/88a5b19cf0b28d0cf89916e388739169f8e46a06", "committedDate": "2020-10-20T15:58:50Z", "message": "add custom_conf_dir config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMzExNDQz", "url": "https://github.com/apache/incubator-doris/pull/4704#pullrequestreview-513311443", "createdAt": "2020-10-21T05:13:05Z", "commit": {"oid": "88a5b19cf0b28d0cf89916e388739169f8e46a06"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4728, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}