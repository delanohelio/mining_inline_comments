{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwNDYxOTIw", "number": 4899, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwOTo0MzowNFrOE4mGbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQwMjoyNzo0MlrOE5F__g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3Nzc5OTUxOnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/SchemaTable.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwOTo0MzowNFrOHynatw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxMTozMjoxNVrOHyq7pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgzNjY2Mw==", "bodyText": "Maybe add a constant variables like 'PRIVILEGE_TYPE_LEN' is better.", "url": "https://github.com/apache/incubator-doris/pull/4899#discussion_r522836663", "createdAt": "2020-11-13T09:43:04Z", "author": {"login": "EmmyMiao87"}, "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/SchemaTable.java", "diffHunk": "@@ -104,11 +104,32 @@ public static Builder builder() {\n                             TableType.SCHEMA,\n                             builder()\n                                     .column(\"GRANTEE\", ScalarType.createVarchar(NAME_CHAR_LEN))\n-                                    .column(\"TABLE_CATALOG\", ScalarType.createVarchar(NAME_CHAR_LEN))\n+                                    .column(\"TABLE_CATALOG\", ScalarType.createVarchar(FN_REFLEN))\n                                     .column(\"TABLE_SCHEMA\", ScalarType.createVarchar(NAME_CHAR_LEN))\n                                     .column(\"TABLE_NAME\", ScalarType.createVarchar(NAME_CHAR_LEN))\n-                                    .column(\"PRIVILEGE_TYPE\", ScalarType.createVarchar(NAME_CHAR_LEN))\n-                                    .column(\"IS_GRANTABLE\", ScalarType.createVarchar(NAME_CHAR_LEN))\n+                                    .column(\"PRIVILEGE_TYPE\", ScalarType.createVarchar(64))\n+                                    .column(\"IS_GRANTABLE\", ScalarType.createVarchar(3))\n+                                    .build()))\n+                    .put(\"schema_privileges\", new SchemaTable(\n+                            SystemIdGenerator.getNextId(),\n+                            \"schema_privileges\",\n+                            TableType.SCHEMA,\n+                            builder()\n+                                    .column(\"GRANTEE\", ScalarType.createVarchar(NAME_CHAR_LEN))\n+                                    .column(\"TABLE_CATALOG\", ScalarType.createVarchar(FN_REFLEN))\n+                                    .column(\"TABLE_SCHEMA\", ScalarType.createVarchar(NAME_CHAR_LEN))\n+                                    .column(\"PRIVILEGE_TYPE\", ScalarType.createVarchar(64))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e1b359a71767ff3187e0bd384a3e4a5337d7d2e"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjg5NDI0Ng==", "bodyText": "Good idea.", "url": "https://github.com/apache/incubator-doris/pull/4899#discussion_r522894246", "createdAt": "2020-11-13T11:32:15Z", "author": {"login": "luozenglin"}, "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/SchemaTable.java", "diffHunk": "@@ -104,11 +104,32 @@ public static Builder builder() {\n                             TableType.SCHEMA,\n                             builder()\n                                     .column(\"GRANTEE\", ScalarType.createVarchar(NAME_CHAR_LEN))\n-                                    .column(\"TABLE_CATALOG\", ScalarType.createVarchar(NAME_CHAR_LEN))\n+                                    .column(\"TABLE_CATALOG\", ScalarType.createVarchar(FN_REFLEN))\n                                     .column(\"TABLE_SCHEMA\", ScalarType.createVarchar(NAME_CHAR_LEN))\n                                     .column(\"TABLE_NAME\", ScalarType.createVarchar(NAME_CHAR_LEN))\n-                                    .column(\"PRIVILEGE_TYPE\", ScalarType.createVarchar(NAME_CHAR_LEN))\n-                                    .column(\"IS_GRANTABLE\", ScalarType.createVarchar(NAME_CHAR_LEN))\n+                                    .column(\"PRIVILEGE_TYPE\", ScalarType.createVarchar(64))\n+                                    .column(\"IS_GRANTABLE\", ScalarType.createVarchar(3))\n+                                    .build()))\n+                    .put(\"schema_privileges\", new SchemaTable(\n+                            SystemIdGenerator.getNextId(),\n+                            \"schema_privileges\",\n+                            TableType.SCHEMA,\n+                            builder()\n+                                    .column(\"GRANTEE\", ScalarType.createVarchar(NAME_CHAR_LEN))\n+                                    .column(\"TABLE_CATALOG\", ScalarType.createVarchar(FN_REFLEN))\n+                                    .column(\"TABLE_SCHEMA\", ScalarType.createVarchar(NAME_CHAR_LEN))\n+                                    .column(\"PRIVILEGE_TYPE\", ScalarType.createVarchar(64))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgzNjY2Mw=="}, "originalCommit": {"oid": "1e1b359a71767ff3187e0bd384a3e4a5337d7d2e"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3Nzg1NzI5OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/mysql/privilege/PaloAuth.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwOTo1ODoxMVrOHyn9Gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxMTozNToxMlrOHyrA0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjg0NTQ2Nw==", "bodyText": "Are word of yes or no case sensitive ?", "url": "https://github.com/apache/incubator-doris/pull/4899#discussion_r522845467", "createdAt": "2020-11-13T09:58:11Z", "author": {"login": "EmmyMiao87"}, "path": "fe/fe-core/src/main/java/org/apache/doris/mysql/privilege/PaloAuth.java", "diffHunk": "@@ -1300,6 +1301,120 @@ public TFetchResourceResult toResourceThrift() {\n         }\n     }\n \n+    // Used for transforming privileges in palo to mysql.\n+    private final String[] privilegesInMysql = new String[]{\"\", \"\", \"\", \"SELECT\", \"INSERT\", \"ALTER\",\n+            \"CREATE\", \"DROP\", \"USAGE\"};\n+\n+    // Used for creating table_privileges table in information_schema.\n+    public void getTablePrivStatus(List<TPrivilegeStatus> tblPrivResult, UserIdentity currentUser) {\n+        readLock();\n+        try {\n+            for (PrivEntry entry : tablePrivTable.getEntries()) {\n+                TablePrivEntry tblPrivEntry = (TablePrivEntry) entry;\n+                String dbName = ClusterNamespace.getNameFromFullName(tblPrivEntry.getOrigDb());\n+                String tblName = tblPrivEntry.getOrigTbl();\n+\n+                if (dbName.equals(\"information_schema\" /* Don't show privileges in information_schema */)\n+                        || !checkTblPriv(currentUser, tblPrivEntry.getOrigDb(), tblName, PrivPredicate.SHOW)) {\n+                    continue;\n+                }\n+\n+                String grantee = new String(\"\\'\").concat(ClusterNamespace.getNameFromFullName(tblPrivEntry.getOrigUser()))\n+                        .concat(\"\\'@\\'\").concat(tblPrivEntry.getOrigHost()).concat(\"\\'\");\n+                String isGrantable = tblPrivEntry.getPrivSet().get(2) ? \"yes\" : \"no\"; //Grant_priv", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e1b359a71767ff3187e0bd384a3e4a5337d7d2e"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjg5NTU2OQ==", "bodyText": "Should use uppercase, I will modify it.", "url": "https://github.com/apache/incubator-doris/pull/4899#discussion_r522895569", "createdAt": "2020-11-13T11:35:12Z", "author": {"login": "luozenglin"}, "path": "fe/fe-core/src/main/java/org/apache/doris/mysql/privilege/PaloAuth.java", "diffHunk": "@@ -1300,6 +1301,120 @@ public TFetchResourceResult toResourceThrift() {\n         }\n     }\n \n+    // Used for transforming privileges in palo to mysql.\n+    private final String[] privilegesInMysql = new String[]{\"\", \"\", \"\", \"SELECT\", \"INSERT\", \"ALTER\",\n+            \"CREATE\", \"DROP\", \"USAGE\"};\n+\n+    // Used for creating table_privileges table in information_schema.\n+    public void getTablePrivStatus(List<TPrivilegeStatus> tblPrivResult, UserIdentity currentUser) {\n+        readLock();\n+        try {\n+            for (PrivEntry entry : tablePrivTable.getEntries()) {\n+                TablePrivEntry tblPrivEntry = (TablePrivEntry) entry;\n+                String dbName = ClusterNamespace.getNameFromFullName(tblPrivEntry.getOrigDb());\n+                String tblName = tblPrivEntry.getOrigTbl();\n+\n+                if (dbName.equals(\"information_schema\" /* Don't show privileges in information_schema */)\n+                        || !checkTblPriv(currentUser, tblPrivEntry.getOrigDb(), tblName, PrivPredicate.SHOW)) {\n+                    continue;\n+                }\n+\n+                String grantee = new String(\"\\'\").concat(ClusterNamespace.getNameFromFullName(tblPrivEntry.getOrigUser()))\n+                        .concat(\"\\'@\\'\").concat(tblPrivEntry.getOrigHost()).concat(\"\\'\");\n+                String isGrantable = tblPrivEntry.getPrivSet().get(2) ? \"yes\" : \"no\"; //Grant_priv", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjg0NTQ2Nw=="}, "originalCommit": {"oid": "1e1b359a71767ff3187e0bd384a3e4a5337d7d2e"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3Nzg2MjY2OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/mysql/privilege/PaloAuth.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwOTo1OTozM1rOHyoAVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwOTo1OTozM1rOHyoAVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjg0NjI5Mg==", "bodyText": "Maybe a map is better? such as <PaloPrivilege, String> ?", "url": "https://github.com/apache/incubator-doris/pull/4899#discussion_r522846292", "createdAt": "2020-11-13T09:59:33Z", "author": {"login": "EmmyMiao87"}, "path": "fe/fe-core/src/main/java/org/apache/doris/mysql/privilege/PaloAuth.java", "diffHunk": "@@ -1300,6 +1301,120 @@ public TFetchResourceResult toResourceThrift() {\n         }\n     }\n \n+    // Used for transforming privileges in palo to mysql.\n+    private final String[] privilegesInMysql = new String[]{\"\", \"\", \"\", \"SELECT\", \"INSERT\", \"ALTER\",\n+            \"CREATE\", \"DROP\", \"USAGE\"};\n+\n+    // Used for creating table_privileges table in information_schema.\n+    public void getTablePrivStatus(List<TPrivilegeStatus> tblPrivResult, UserIdentity currentUser) {\n+        readLock();\n+        try {\n+            for (PrivEntry entry : tablePrivTable.getEntries()) {\n+                TablePrivEntry tblPrivEntry = (TablePrivEntry) entry;\n+                String dbName = ClusterNamespace.getNameFromFullName(tblPrivEntry.getOrigDb());\n+                String tblName = tblPrivEntry.getOrigTbl();\n+\n+                if (dbName.equals(\"information_schema\" /* Don't show privileges in information_schema */)\n+                        || !checkTblPriv(currentUser, tblPrivEntry.getOrigDb(), tblName, PrivPredicate.SHOW)) {\n+                    continue;\n+                }\n+\n+                String grantee = new String(\"\\'\").concat(ClusterNamespace.getNameFromFullName(tblPrivEntry.getOrigUser()))\n+                        .concat(\"\\'@\\'\").concat(tblPrivEntry.getOrigHost()).concat(\"\\'\");\n+                String isGrantable = tblPrivEntry.getPrivSet().get(2) ? \"yes\" : \"no\"; //Grant_priv\n+                for (PaloPrivilege paloPriv : tblPrivEntry.getPrivSet().toPrivilegeList()) {\n+                    if (paloPriv == PaloPrivilege.GRANT_PRIV) {\n+                        continue;\n+                    }\n+                    TPrivilegeStatus status = new TPrivilegeStatus();\n+                    status.setTableName(tblName);\n+                    status.setPrivilegeType(privilegesInMysql[paloPriv.getIdx()]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e1b359a71767ff3187e0bd384a3e4a5337d7d2e"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MzAyNTkwOnYy", "diffSide": "RIGHT", "path": "be/src/exec/schema_scanner/schema_user_privileges_scanner.cpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQwMjoyNzo0MlrOHzY3LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQwMjoyNzo0MlrOHzY3LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzY0Njc2NQ==", "bodyText": "{\n        void *slot = tuple->get_slot(_tuple_desc->slots()[0]->tuple_offset());\n        StringValue* str_slot = reinterpret_cast<StringValue*>(slot);\n        const std::string* src = &tbl_priv_status.grantee;\n        str_slot->len = src->length();\n        str_slot->ptr = (char *)pool->allocate(str_slot->len);\n        if (NULL == str_slot->ptr) {\n            return Status::InternalError(\"Allocate memcpy failed.\");\n        }\n        memcpy(str_slot->ptr, src->c_str(), str_slot->len);\n    }\n\nThis kind of code block is used everywhere, I think we can extract a common method for it.", "url": "https://github.com/apache/incubator-doris/pull/4899#discussion_r523646765", "createdAt": "2020-11-15T02:27:42Z", "author": {"login": "morningman"}, "path": "be/src/exec/schema_scanner/schema_user_privileges_scanner.cpp", "diffHunk": "@@ -0,0 +1,150 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#include \"exec/schema_scanner/schema_helper.h\"\n+#include \"exec/schema_scanner/schema_user_privileges_scanner.h\"\n+#include \"runtime/primitive_type.h\"\n+#include \"runtime/string_value.h\"\n+//#include \"runtime/datetime_value.h\"\n+\n+namespace doris\n+{\n+\n+SchemaScanner::ColumnDesc SchemaUserPrivilegesScanner::_s_tbls_columns[] = {\n+    //   name,       type,          size,     is_null\n+    { \"GRANTEE\", TYPE_VARCHAR, sizeof(StringValue), true},\n+    { \"TABLE_CATALOG\", TYPE_VARCHAR, sizeof(StringValue), true},\n+    { \"PRIVILEGE_TYPE\", TYPE_VARCHAR, sizeof(StringValue), false},\n+    { \"IS_GRANTABLE\", TYPE_VARCHAR, sizeof(StringValue), true},\n+};\n+\n+SchemaUserPrivilegesScanner::SchemaUserPrivilegesScanner()\n+        : SchemaScanner(_s_tbls_columns,\n+                        sizeof(_s_tbls_columns) / sizeof(SchemaScanner::ColumnDesc)),\n+        _priv_index(0) {\n+}\n+\n+SchemaUserPrivilegesScanner::~SchemaUserPrivilegesScanner() {\n+}\n+\n+Status SchemaUserPrivilegesScanner::start(RuntimeState *state) {\n+    if (!_is_init) {\n+        return Status::InternalError(\"used before initialized.\");\n+    }\n+    RETURN_IF_ERROR(get_new_table());\n+    return Status::OK();\n+}\n+\n+Status SchemaUserPrivilegesScanner::fill_one_row(Tuple *tuple, MemPool *pool) {\n+    // set all bit to not null\n+    memset((void *)tuple, 0, _tuple_desc->num_null_bytes());\n+    const TPrivilegeStatus& tbl_priv_status = _priv_result.privileges[_priv_index];\n+    // grantee", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ff6c6dab966e201ce34e190884a28164d779381"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 888, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}