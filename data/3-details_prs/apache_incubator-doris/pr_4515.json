{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3NjE5MDgz", "number": 4515, "title": "[Feature] Support cancel load jobs in batch", "bodyText": "Proposed changes\n#3992\nTypes of changes\nWhat types of changes does your code introduce to Doris?\nPut an x in the boxes that apply\n\n New feature (non-breaking change which adds functionality)\n\nChecklist\nPut an x in the boxes that apply. You can also fill these out after creating the PR. If you're unsure about any of them, don't hesitate to ask. We're here to help! This is simply a reminder of what we are going to look for before merging your code.\n\n I have create an issue on (Fix #ISSUE), and have described the bug/feature there in detail\n Compiling and unit tests pass locally with my changes\n I have added tests that prove my fix is effective or that my feature works", "createdAt": "2020-09-02T07:03:41Z", "url": "https://github.com/apache/incubator-doris/pull/4515", "merged": true, "mergeCommit": {"oid": "21e7428999c1ec5cd201eebba8a38ebb50a3b662"}, "closed": true, "closedAt": "2020-10-15T14:49:40Z", "author": {"login": "xy720"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEzitQAH2gAyNDc3NjE5MDgzOjI5NjdmNWIxZDc5MWNlMzgxYmE4YWQ4NDczY2E0ZDdkOTg2MmI5ZDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdR07QUAFqTUwNjY3NDU4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2967f5b1d791ce381ba8ad8473ca4d7d9862b9d5", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/2967f5b1d791ce381ba8ad8473ca4d7d9862b9d5", "committedDate": "2020-09-02T03:36:00Z", "message": "save code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f9ac135e67826ea324aa1acbb390f6b637ceaa5", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/1f9ac135e67826ea324aa1acbb390f6b637ceaa5", "committedDate": "2020-09-02T06:05:14Z", "message": "save code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd1e6a2809423ed0e372d862790786e76091aebf", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/fd1e6a2809423ed0e372d862790786e76091aebf", "committedDate": "2020-09-02T07:00:38Z", "message": "add ut"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "655c006cf32541fbc8bc4d22cbcd8ab43d0e0d6f", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/655c006cf32541fbc8bc4d22cbcd8ab43d0e0d6f", "committedDate": "2020-09-02T07:15:26Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MzAzNDI5", "url": "https://github.com/apache/incubator-doris/pull/4515#pullrequestreview-487303429", "createdAt": "2020-09-13T12:38:35Z", "commit": {"oid": "655c006cf32541fbc8bc4d22cbcd8ab43d0e0d6f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxMjozODozNlrOHQ8JHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxMjozODozNlrOHQ8JHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzUyNDYzNg==", "bodyText": "We should not rely on \"the last one is running\", better filter it by state.\nSo that we can unify the logic just same as batch cancel.", "url": "https://github.com/apache/incubator-doris/pull/4515#discussion_r487524636", "createdAt": "2020-09-13T12:38:36Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/Load.java", "diffHunk": "@@ -1570,6 +1581,105 @@ public boolean isLabelExist(String dbName, String label) throws DdlException {\n         }\n     }\n \n+    public boolean cancelLoadJob(CancelLoadStmt stmt, boolean isAccurateMatch) throws DdlException {\n+        // get params\n+        String dbName = stmt.getDbName();\n+        String label = stmt.getLabel();\n+\n+        // get load job and check state\n+        Database db = Catalog.getCurrentCatalog().getDb(dbName);\n+        if (db == null) {\n+            throw new DdlException(\"Db does not exist. name: \" + dbName);\n+        }\n+        // List of load jobs waiting to be cancelled\n+        List<LoadJob> loadJobs = Lists.newArrayList();\n+        readLock();\n+        try {\n+            Map<String, List<LoadJob>> labelToLoadJobs = dbLabelToLoadJobs.get(db.getId());\n+            if (labelToLoadJobs == null) {\n+                throw new DdlException(\"Load job does not exist\");\n+            }\n+\n+            // get jobs by label\n+            List<LoadJob> matchLoadJobs = Lists.newArrayList();\n+            if (isAccurateMatch) {\n+                if (labelToLoadJobs.containsKey(label)) {\n+                    matchLoadJobs.addAll(labelToLoadJobs.get(label));\n+                }\n+            } else {\n+                for (Map.Entry<String, List<LoadJob>> entry : labelToLoadJobs.entrySet()) {\n+                    if (entry.getKey().contains(label)) {\n+                        matchLoadJobs.addAll(entry.getValue());\n+                    }\n+                }\n+            }\n+\n+            if (matchLoadJobs.isEmpty()) {\n+                throw new DdlException(\"Load job does not exist\");\n+            }\n+\n+            // check state here\n+            if (isAccurateMatch) {\n+                // only the last one should be running", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "655c006cf32541fbc8bc4d22cbcd8ab43d0e0d6f"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f9b9cf94e49ff0646fc0cb66943bf8fd254d1c4", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/0f9b9cf94e49ff0646fc0cb66943bf8fd254d1c4", "committedDate": "2020-09-29T17:12:09Z", "message": "unify logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2Njc0NTgy", "url": "https://github.com/apache/incubator-doris/pull/4515#pullrequestreview-506674582", "createdAt": "2020-10-12T14:33:44Z", "commit": {"oid": "0f9b9cf94e49ff0646fc0cb66943bf8fd254d1c4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4919, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}