{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0Nzc1NzEz", "number": 4475, "title": "[Refactor] Refactor storage medium migration task process", "bodyText": "Proposed changes\nThis CL refactor the storage medium migration task process in BE.\nI did not modify the execution logic. Just extract part of the logic\nin the migration task and put it in task_work_pool.\nIn this way, the migration task is only used to process the migration\nfrom the specified tablet to the specified data dir.\nLater, we can use this task to migrate of tablets between different disks. #4476\nTypes of changes\n\n Code refactor (Modify the code structure, format the code, etc...)\n\nChecklist\n\n Compiling and unit tests pass locally with my changes", "createdAt": "2020-08-27T15:22:37Z", "url": "https://github.com/apache/incubator-doris/pull/4475", "merged": true, "mergeCommit": {"oid": "a1ae399737f16d6cb9fdb2ca9dd616e1e2c485b0"}, "closed": true, "closedAt": "2020-11-12T02:00:44Z", "author": {"login": "morningman"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQwONLgBqjM4NTg2NTAyNjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbouXNAFqTUyODY4MDczOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "70f904d4a4990658f0877385d6ed9cd680f6fb23", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/70f904d4a4990658f0877385d6ed9cd680f6fb23", "committedDate": "2020-08-27T10:31:00Z", "message": "refector migration task"}, "afterCommit": {"oid": "caed1bcbe3180ef167b0cc610078e99a1639ccfb", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/caed1bcbe3180ef167b0cc610078e99a1639ccfb", "committedDate": "2020-10-09T06:30:45Z", "message": "refector migration task"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "caed1bcbe3180ef167b0cc610078e99a1639ccfb", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/caed1bcbe3180ef167b0cc610078e99a1639ccfb", "committedDate": "2020-10-09T06:30:45Z", "message": "refector migration task"}, "afterCommit": {"oid": "ef22bf156b744b5ad079ff89ca3cd0a32b0cf31a", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/ef22bf156b744b5ad079ff89ca3cd0a32b0cf31a", "committedDate": "2020-10-09T08:01:04Z", "message": "refector migration task"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef22bf156b744b5ad079ff89ca3cd0a32b0cf31a", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/ef22bf156b744b5ad079ff89ca3cd0a32b0cf31a", "committedDate": "2020-10-09T08:01:04Z", "message": "refector migration task"}, "afterCommit": {"oid": "f000d5e3fa2749402e4c457eb97eec225d56efc5", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/f000d5e3fa2749402e4c457eb97eec225d56efc5", "committedDate": "2020-10-20T03:03:33Z", "message": "refector migration task"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a765b0b403af9bcd836f2a7f87d705da30378675", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/a765b0b403af9bcd836f2a7f87d705da30378675", "committedDate": "2020-10-20T03:58:28Z", "message": "refector migration task"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f000d5e3fa2749402e4c457eb97eec225d56efc5", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/f000d5e3fa2749402e4c457eb97eec225d56efc5", "committedDate": "2020-10-20T03:03:33Z", "message": "refector migration task"}, "afterCommit": {"oid": "a765b0b403af9bcd836f2a7f87d705da30378675", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/a765b0b403af9bcd836f2a7f87d705da30378675", "committedDate": "2020-10-20T03:58:28Z", "message": "refector migration task"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNjI5MjE0", "url": "https://github.com/apache/incubator-doris/pull/4475#pullrequestreview-512629214", "createdAt": "2020-10-20T12:01:45Z", "commit": {"oid": "a765b0b403af9bcd836f2a7f87d705da30378675"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMjowMTo0NlrOHk41Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMjowMTo0NlrOHk41Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ0MTg1OQ==", "bodyText": "Doesn't it print out the reason for the check failure?", "url": "https://github.com/apache/incubator-doris/pull/4475#discussion_r508441859", "createdAt": "2020-10-20T12:01:46Z", "author": {"login": "EmmyMiao87"}, "path": "be/src/agent/task_worker_pool.cpp", "diffHunk": "@@ -916,19 +916,26 @@ void TaskWorkerPool::_storage_medium_migrate_worker_thread_callback() {\n         }\n \n         TStatusCode::type status_code = TStatusCode::OK;\n-        vector<string> error_msgs;\n-        TStatus task_status;\n-        EngineStorageMigrationTask engine_task(storage_medium_migrate_req);\n-        OLAPStatus res = _env->storage_engine()->execute_task(&engine_task);\n-        if (res != OLAP_SUCCESS) {\n-            LOG(WARNING) << \"storage media migrate failed. status: \" << res\n-                         << \", signature: \" << agent_task_req.signature;\n-            status_code = TStatusCode::RUNTIME_ERROR;\n+        // check request and get info\n+        TabletSharedPtr tablet;\n+        DataDir* dest_store;\n+        if (_check_migrate_requset(storage_medium_migrate_req, tablet, &dest_store) != OLAP_SUCCESS) {\n+            status_code = TStatusCode::RUNTIME_ERROR; ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a765b0b403af9bcd836f2a7f87d705da30378675"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NjgwNzM5", "url": "https://github.com/apache/incubator-doris/pull/4475#pullrequestreview-528680739", "createdAt": "2020-11-12T02:00:02Z", "commit": {"oid": "a765b0b403af9bcd836f2a7f87d705da30378675"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4870, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}