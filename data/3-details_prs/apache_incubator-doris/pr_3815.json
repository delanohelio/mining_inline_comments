{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMjIwNzE1", "number": 3815, "title": "Optimize the logic for getting TabletMeta from TabletInvertedIndex to reduce frequency of getting read lock ", "bodyText": "This PR is to optimize the logic for getting tabletMeta from TabletInvertedIndex to reduce frequence of getting read lock", "createdAt": "2020-06-10T05:56:13Z", "url": "https://github.com/apache/incubator-doris/pull/3815", "merged": true, "mergeCommit": {"oid": "6928c727038bc5449fb700e200c3fbc206edfa1b"}, "closed": true, "closedAt": "2020-06-13T04:47:00Z", "author": {"login": "caiconghui"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpkdOigH2gAyNDMyMjIwNzE1OjcwM2ViYjRlMWI2ODZjMjIwOTM4MjBkNTNiZjhhMWEwODczMzk3ZTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqPsj6gFqTQyOTAwNjM4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "703ebb4e1b686c22093820d53bf8a1a0873397e7", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/703ebb4e1b686c22093820d53bf8a1a0873397e7", "committedDate": "2020-06-09T12:45:29Z", "message": "Reduce frequency to get read lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acaffd986dbc714d30aeb393859be71e1cc13d30", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/acaffd986dbc714d30aeb393859be71e1cc13d30", "committedDate": "2020-06-10T05:53:27Z", "message": "Reduce frequency to get read lock in TabletInvertIndex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8555ee95ddba7cff3926b5d1a6de51aaf26f469", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/e8555ee95ddba7cff3926b5d1a6de51aaf26f469", "committedDate": "2020-06-10T06:08:14Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3OTM3ODMx", "url": "https://github.com/apache/incubator-doris/pull/3815#pullrequestreview-427937831", "createdAt": "2020-06-10T10:53:05Z", "commit": {"oid": "e8555ee95ddba7cff3926b5d1a6de51aaf26f469"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMDo1MzowNVrOGhvhCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMDo1MzowNVrOGhvhCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODAzNDY5Nw==", "bodyText": "Have you tested its performance? There may be millions of tablet in tabletIds. I am not sure how long it will take to process that much of tablets.", "url": "https://github.com/apache/incubator-doris/pull/3815#discussion_r438034697", "createdAt": "2020-06-10T10:53:05Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/master/ReportHandler.java", "diffHunk": "@@ -388,21 +389,26 @@ private static void sync(Map<Long, TTablet> backendTablets, ListMultimap<Long, L\n                 List<Long> tabletIds = tabletSyncMap.get(dbId);\n                 LOG.info(\"before sync tablets in db[{}]. report num: {}. backend[{}]\",\n                          dbId, tabletIds.size(), backendId);\n-\n-                for (Long tabletId : tabletIds) {\n-                    long tableId = invertedIndex.getTableId(tabletId);\n+                List<TabletMeta> tabletMetaList = invertedIndex.getTabletMetaList(tabletIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8555ee95ddba7cff3926b5d1a6de51aaf26f469"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8f3189fee2098abb176e6b332a616fa8d0e9d29", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/a8f3189fee2098abb176e6b332a616fa8d0e9d29", "committedDate": "2020-06-11T03:53:27Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4ODkwNDU2", "url": "https://github.com/apache/incubator-doris/pull/3815#pullrequestreview-428890456", "createdAt": "2020-06-11T13:10:42Z", "commit": {"oid": "a8f3189fee2098abb176e6b332a616fa8d0e9d29"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMzoxMDo0MlrOGicWaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMzoxNjo1NFrOGicluw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc2OTI1OQ==", "bodyText": "It is very error-prone to result a list will null in it.\nHow about using getOrDefault() method, and return an NonExistTabletMeta is not found?\nAnd NonExistTabletMeta can be a final static member with all id as NON_EXIST_VALUE in it.\nIn this way, we don't have to check null each time we visit the returned list.", "url": "https://github.com/apache/incubator-doris/pull/3815#discussion_r438769259", "createdAt": "2020-06-11T13:10:42Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/TabletInvertedIndex.java", "diffHunk": "@@ -298,57 +262,28 @@ public Long getTabletIdByReplica(long replicaId) {\n         }\n     }\n \n-    public long getPartitionId(long tabletId) {\n-        readLock();\n-        try {\n-            if (tabletMetaMap.containsKey(tabletId)) {\n-                return tabletMetaMap.get(tabletId).getPartitionId();\n-            }\n-            return NOT_EXIST_VALUE;\n-        } finally {\n-            readUnlock();\n-        }\n-    }\n-\n-    public long getIndexId(long tabletId) {\n+    public TabletMeta getTabletMeta(long tabletId) {\n         readLock();\n         try {\n-            if (tabletMetaMap.containsKey(tabletId)) {\n-                return tabletMetaMap.get(tabletId).getIndexId();\n-            }\n-            return NOT_EXIST_VALUE;\n+            return tabletMetaMap.get(tabletId);\n         } finally {\n             readUnlock();\n         }\n     }\n \n-    public int getEffectiveSchemaHash(long tabletId) {\n-        // always get old schema hash(as effective one)\n+    public List<TabletMeta> getTabletMetaList(List<Long> tabletIdList) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8f3189fee2098abb176e6b332a616fa8d0e9d29"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc3MzE3OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                long indexId = tabletMeta.getPartitionId();\n          \n          \n            \n                                long indexId = tabletMeta.getIndexId();\n          \n      \n    \n    \n  \n\nPlease double check again for similar errors.", "url": "https://github.com/apache/incubator-doris/pull/3815#discussion_r438773179", "createdAt": "2020-06-11T13:16:54Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/master/ReportHandler.java", "diffHunk": "@@ -388,21 +389,26 @@ private static void sync(Map<Long, TTablet> backendTablets, ListMultimap<Long, L\n                 List<Long> tabletIds = tabletSyncMap.get(dbId);\n                 LOG.info(\"before sync tablets in db[{}]. report num: {}. backend[{}]\",\n                          dbId, tabletIds.size(), backendId);\n-\n-                for (Long tabletId : tabletIds) {\n-                    long tableId = invertedIndex.getTableId(tabletId);\n+                List<TabletMeta> tabletMetaList = invertedIndex.getTabletMetaList(tabletIds);\n+                for (int i = 0; i < tabletMetaList.size(); i++) {\n+                    TabletMeta tabletMeta = tabletMetaList.get(i);\n+                    if (tabletMeta == null) {\n+                        continue;\n+                    }\n+                    long tabletId = tabletIds.get(i);\n+                    long tableId = tabletMeta.getTableId();\n                     OlapTable olapTable = (OlapTable) db.getTable(tableId);\n                     if (olapTable == null) {\n                         continue;\n                     }\n \n-                    long partitionId = invertedIndex.getPartitionId(tabletId);\n+                    long partitionId = tabletMeta.getPartitionId();\n                     Partition partition = olapTable.getPartition(partitionId);\n                     if (partition == null) {\n                         continue;\n                     }\n \n-                    long indexId = invertedIndex.getIndexId(tabletId);\n+                    long indexId = tabletMeta.getPartitionId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8f3189fee2098abb176e6b332a616fa8d0e9d29"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38d543c2f64c50e60f22e8d59bf22517c261cdaf", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/38d543c2f64c50e60f22e8d59bf22517c261cdaf", "committedDate": "2020-06-11T14:57:16Z", "message": "fix by review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MDA2Mzgz", "url": "https://github.com/apache/incubator-doris/pull/3815#pullrequestreview-429006383", "createdAt": "2020-06-11T15:08:09Z", "commit": {"oid": "38d543c2f64c50e60f22e8d59bf22517c261cdaf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2518, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}