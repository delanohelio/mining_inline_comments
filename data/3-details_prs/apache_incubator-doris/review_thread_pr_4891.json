{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5ODk2MDk4", "number": 4891, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNDo1NjowMFrOE8wo2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNDo1NzozNlrOE8wsMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMTQ2OTA0OnYy", "diffSide": "RIGHT", "path": "be/src/olap/base_compaction.cpp", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNDo1NjowMFrOH5ErdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMjozMTo0M1rOH5g0xQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTYwNzU0MA==", "bodyText": "Add comment to explain why setting clone occurred here.", "url": "https://github.com/apache/incubator-doris/pull/4891#discussion_r529607540", "createdAt": "2020-11-24T14:56:00Z", "author": {"login": "morningman"}, "path": "be/src/olap/base_compaction.cpp", "diffHunk": "@@ -43,9 +50,26 @@ OLAPStatus BaseCompaction::compact() {\n     RETURN_NOT_OK(pick_rowsets_to_compact());\n     TRACE(\"rowsets picked\");\n     TRACE_COUNTER_INCREMENT(\"input_rowsets_count\", _input_rowsets.size());\n+    _tablet->set_clone_occurred(false);\n+\n+    return OLAP_SUCCESS;\n+}\n+\n+OLAPStatus BaseCompaction::execute_compact() {\n+    MutexLock lock(_tablet->get_base_lock(), TRY_LOCK);\n+    if (!lock.own_lock()) {\n+        LOG(WARNING) << \"another base compaction is running. tablet=\" << _tablet->full_name();\n+        return OLAP_ERR_BE_TRY_BE_LOCK_ERROR;\n+    }\n+    TRACE(\"got base compaction lock\");\n+\n+    if (_tablet->get_clone_occurred()) {\n+        _tablet->set_clone_occurred(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8937a3b2d0448da4e9c1df857b0a978dedc33246"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA2ODY3Nw==", "bodyText": "OK.", "url": "https://github.com/apache/incubator-doris/pull/4891#discussion_r530068677", "createdAt": "2020-11-25T02:31:43Z", "author": {"login": "weizuo93"}, "path": "be/src/olap/base_compaction.cpp", "diffHunk": "@@ -43,9 +50,26 @@ OLAPStatus BaseCompaction::compact() {\n     RETURN_NOT_OK(pick_rowsets_to_compact());\n     TRACE(\"rowsets picked\");\n     TRACE_COUNTER_INCREMENT(\"input_rowsets_count\", _input_rowsets.size());\n+    _tablet->set_clone_occurred(false);\n+\n+    return OLAP_SUCCESS;\n+}\n+\n+OLAPStatus BaseCompaction::execute_compact() {\n+    MutexLock lock(_tablet->get_base_lock(), TRY_LOCK);\n+    if (!lock.own_lock()) {\n+        LOG(WARNING) << \"another base compaction is running. tablet=\" << _tablet->full_name();\n+        return OLAP_ERR_BE_TRY_BE_LOCK_ERROR;\n+    }\n+    TRACE(\"got base compaction lock\");\n+\n+    if (_tablet->get_clone_occurred()) {\n+        _tablet->set_clone_occurred(false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTYwNzU0MA=="}, "originalCommit": {"oid": "8937a3b2d0448da4e9c1df857b0a978dedc33246"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMTQ3NzYxOnYy", "diffSide": "RIGHT", "path": "be/src/olap/base_compaction.cpp", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNDo1NzozNlrOH5EwdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMjoxNjowOVrOH5ghow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTYwODgyMA==", "bodyText": "Who will call BaseCompaction::compact() now?", "url": "https://github.com/apache/incubator-doris/pull/4891#discussion_r529608820", "createdAt": "2020-11-24T14:57:36Z", "author": {"login": "morningman"}, "path": "be/src/olap/base_compaction.cpp", "diffHunk": "@@ -28,6 +28,13 @@ BaseCompaction::BaseCompaction(TabletSharedPtr tablet, const std::string& label,\n BaseCompaction::~BaseCompaction() { }\n \n OLAPStatus BaseCompaction::compact() {\n+    RETURN_NOT_OK(prepare_compact());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8937a3b2d0448da4e9c1df857b0a978dedc33246"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA2Mzc3OQ==", "bodyText": "Who will call BaseCompaction::compact() now?\n\nBaseCompaction::compact() will still be called in \"be/src/http/action/compaction_action.cpp\" for /api/compaction/run.", "url": "https://github.com/apache/incubator-doris/pull/4891#discussion_r530063779", "createdAt": "2020-11-25T02:16:09Z", "author": {"login": "weizuo93"}, "path": "be/src/olap/base_compaction.cpp", "diffHunk": "@@ -28,6 +28,13 @@ BaseCompaction::BaseCompaction(TabletSharedPtr tablet, const std::string& label,\n BaseCompaction::~BaseCompaction() { }\n \n OLAPStatus BaseCompaction::compact() {\n+    RETURN_NOT_OK(prepare_compact());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTYwODgyMA=="}, "originalCommit": {"oid": "8937a3b2d0448da4e9c1df857b0a978dedc33246"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 882, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}