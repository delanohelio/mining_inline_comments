{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNTI4MjM2", "number": 3424, "reviewThreads": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNDo0MDozMVrOD3qMsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMzoxOTowNFrOD8D8ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5Njg5NjUxOnYy", "diffSide": "RIGHT", "path": "be/src/olap/olap_cond.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNDo0MDozMVrOGOCL_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNDo0MDozMVrOGOCL_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM2OTA4NA==", "bodyText": "cond_it.second->is_key() || _schema->keys_type() == KeysType::DUP_KEYS\nThis condition shows many times. How about extract it to a method?", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r417369084", "createdAt": "2020-04-29T14:40:31Z", "author": {"login": "morningman"}, "path": "be/src/olap/olap_cond.cpp", "diffHunk": "@@ -681,17 +681,17 @@ int Conditions::delete_pruning_filter(const std::vector<KeyRange>& zone_maps) co\n     for (auto& cond_it : _columns) {\n         /*\n          * this is base on the assumption that the delete condition\n-         * is only about key field, not about value field.\n+         * is only about key field, not about value field except the storage model is duplicate.\n         */\n-        if (cond_it.second->is_key() && cond_it.first > zone_maps.size()) {\n+        if ((cond_it.second->is_key() || _schema->keys_type() == KeysType::DUP_KEYS) && cond_it.first > zone_maps.size()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "adacf8007b8b9345bea2210e50e1c482618e2035"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5Njk0NjA0OnYy", "diffSide": "RIGHT", "path": "be/test/olap/delete_handler_test.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNDo1MDo0MlrOGOCrqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNDo1MDo0MlrOGOCrqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM3NzE5Mw==", "bodyText": "English", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r417377193", "createdAt": "2020-04-29T14:50:42Z", "author": {"login": "morningman"}, "path": "be/test/olap/delete_handler_test.cpp", "diffHunk": "@@ -265,6 +358,17 @@ TEST_F(TestDeleteConditionHandler, StoreCondNonexistentColumn) {\n \n     failed_res = _delete_condition_handler.generate_delete_predicate(tablet->tablet_schema(), conditions, &del_pred);;\n     ASSERT_EQ(OLAP_ERR_DELETE_INVALID_CONDITION, failed_res);\n+\n+    // 'v'\u662fvalue\u5217 \u4f46\u662f\u5728duplicate \u6a21\u578b\u6c47\u603b", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "adacf8007b8b9345bea2210e50e1c482618e2035"}, "originalPosition": 125}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMDQ1Nzk5OnYy", "diffSide": "RIGHT", "path": "be/src/olap/rowset/segment_group.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxMToxNzozNFrOGOkzZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNzoyNjozMlrOGRG8jA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNjIzMA==", "bodyText": "ZoneMap is not used for un-sorted column.\nMost of the time, you will have to filter the delete predicate row by row.", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r417936230", "createdAt": "2020-04-30T11:17:34Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/rowset/segment_group.cpp", "diffHunk": "@@ -697,6 +697,13 @@ const TabletSchema& SegmentGroup::get_tablet_schema() {\n     return *_schema;\n }\n \n+int SegmentGroup::get_num_zone_map_columns() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34b15825294263a9415fa31173fa2c98f834710"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU5Mjc4MA==", "bodyText": "this function only get the column num of maybe has ZoneMap, in agg, uniq, replace table  itt returns the key columns count, it certainly sorted and had ZoneMap, in duplicate table it return the all column count, the key columns has sorted and has  ZoneMap, the value column in new code also has ZoneMap, but not sorted, so it is not  Most of the time, you will have to filter the delete predicate row by row.,  only  when delete by duplicted values, in otherwise if we sorted the duplicate table's value column, it will be the same with key column essentially, so that the value column is unmeaningful", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r420592780", "createdAt": "2020-05-06T07:26:32Z", "author": {"login": "yangzhg"}, "path": "be/src/olap/rowset/segment_group.cpp", "diffHunk": "@@ -697,6 +697,13 @@ const TabletSchema& SegmentGroup::get_tablet_schema() {\n     return *_schema;\n }\n \n+int SegmentGroup::get_num_zone_map_columns() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNjIzMA=="}, "originalCommit": {"oid": "e34b15825294263a9415fa31173fa2c98f834710"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNDcxMTQ1OnYy", "diffSide": "RIGHT", "path": "be/src/olap/delete_handler.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNTo1MDo1OVrOGSFEiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNTo1MDo1OVrOGSFEiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxMDYzMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LOG(WARNING) << \"field is not key column, or storage model is not duplicted, or its type is float or double.\";\n          \n          \n            \n                    LOG(WARNING) << \"field is not key column, or storage model is not duplicated, or its type is float or double.\";", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r421610632", "createdAt": "2020-05-07T15:50:59Z", "author": {"login": "morningman"}, "path": "be/src/olap/delete_handler.cpp", "diffHunk": "@@ -105,10 +105,10 @@ OLAPStatus DeleteConditionHandler::check_condition_valid(\n     // \u68c0\u67e5\u6307\u5b9a\u7684\u5217\u662f\u4e0d\u662fkey\uff0c\u662f\u4e0d\u662ffloat\u6216doulbe\u7c7b\u578b\n     const TabletColumn& column = schema.column(field_index);\n \n-    if (!column.is_key()\n+    if ((!column.is_key() && schema.keys_type() != KeysType::DUP_KEYS)\n             || column.type() == OLAP_FIELD_TYPE_DOUBLE\n             || column.type() == OLAP_FIELD_TYPE_FLOAT) {\n-        LOG(WARNING) << \"field is not key column, or its type is float or double.\";\n+        LOG(WARNING) << \"field is not key column, or storage model is not duplicted, or its type is float or double.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2081aba768f1dc3944b3c083aece8b4ca96ef991"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNDcyNzE0OnYy", "diffSide": "RIGHT", "path": "be/src/olap/rowset/column_data.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNTo1NDoyNlrOGSFOKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwMjoyMjoyNlrOGS32Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxMzA5Ng==", "bodyText": "Does float or double column have ZoneMap?", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r421613096", "createdAt": "2020-05-07T15:54:26Z", "author": {"login": "morningman"}, "path": "be/src/olap/rowset/column_data.cpp", "diffHunk": "@@ -509,7 +510,10 @@ int ColumnData::delete_pruning_filter() {\n         return DEL_NOT_SATISFIED;\n     }\n \n-    if (!_segment_group->has_zone_maps()) {\n+    int num_zone_maps = _schema.keys_type() == KeysType::DUP_KEYS ? _schema.num_columns() : _schema.num_key_columns();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2081aba768f1dc3944b3c083aece8b4ca96ef991"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0MjUzOQ==", "bodyText": "float and double is disabled in fe", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r422442539", "createdAt": "2020-05-09T02:22:26Z", "author": {"login": "yangzhg"}, "path": "be/src/olap/rowset/column_data.cpp", "diffHunk": "@@ -509,7 +510,10 @@ int ColumnData::delete_pruning_filter() {\n         return DEL_NOT_SATISFIED;\n     }\n \n-    if (!_segment_group->has_zone_maps()) {\n+    int num_zone_maps = _schema.keys_type() == KeysType::DUP_KEYS ? _schema.num_columns() : _schema.num_key_columns();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxMzA5Ng=="}, "originalCommit": {"oid": "2081aba768f1dc3944b3c083aece8b4ca96ef991"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNDc0ODY0OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/common/Config.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNTo1OTowN1rOGSFbYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNTo1OTowN1rOGSFbYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxNjQ4Mw==", "bodyText": "Do not change this in this PR, better to submit another new PR to change it.", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r421616483", "createdAt": "2020-05-07T15:59:07Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/common/Config.java", "diffHunk": "@@ -1053,7 +1053,7 @@\n      * control materialized view\n      */\n     @ConfField(mutable = true, masterOnly = true)\n-    public static boolean enable_materialized_view = false;\n+    public static boolean enable_materialized_view = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2081aba768f1dc3944b3c083aece8b4ca96ef991"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNDc2NDg2OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/load/DeleteHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNjowMjo1MVrOGSFlVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNjowMjo1MVrOGSFlVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxOTAyOQ==", "bodyText": "if index is DUPLICATED, but column type is float or double, we should also forbid the delete operation.", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r421619029", "createdAt": "2020-05-07T16:02:51Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/load/DeleteHandler.java", "diffHunk": "@@ -509,8 +510,8 @@ private void checkDeleteV2(OlapTable table, Partition partition, List<Predicate>\n                 if (column == null) {\n                     ErrorReport.reportDdlException(ErrorCode.ERR_BAD_FIELD_ERROR, columnName, indexName);\n                 }\n-\n-                if (table.getKeysType() == KeysType.DUP_KEYS && !column.isKey()) {\n+                MaterializedIndexMeta indexMeta = table.getIndexIdToMeta().get(index.getId());\n+                if (indexMeta.getKeysType() != KeysType.DUP_KEYS && !column.isKey()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2081aba768f1dc3944b3c083aece8b4ca96ef991"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNDc2NzA4OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/load/Load.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNjowMzoyNlrOGSFmzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNjowMzoyNlrOGSFmzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxOTQwNg==", "bodyText": "No need to modify here, this method is deprecated.", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r421619406", "createdAt": "2020-05-07T16:03:26Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/load/Load.java", "diffHunk": "@@ -3123,7 +3123,7 @@ private void checkDeleteV2(OlapTable table, Partition partition, List<Predicate>\n             }\n \n             Column column = nameToColumn.get(columnName);\n-            if (!column.isKey()) {\n+            if (!column.isKey() && table.getKeysType() != KeysType.DUP_KEYS) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2081aba768f1dc3944b3c083aece8b4ca96ef991"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMDE0OTQ1OnYy", "diffSide": "RIGHT", "path": "be/src/olap/delete_handler.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNDoxMzo0MlrOGS4WTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNDoxMzo0MlrOGS4WTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MDc2NA==", "bodyText": "just check column.agg_type = AGG_NONE\uff1f", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r422450764", "createdAt": "2020-05-09T04:13:42Z", "author": {"login": "kangpinghuang"}, "path": "be/src/olap/delete_handler.cpp", "diffHunk": "@@ -105,10 +105,10 @@ OLAPStatus DeleteConditionHandler::check_condition_valid(\n     // \u68c0\u67e5\u6307\u5b9a\u7684\u5217\u662f\u4e0d\u662fkey\uff0c\u662f\u4e0d\u662ffloat\u6216doulbe\u7c7b\u578b\n     const TabletColumn& column = schema.column(field_index);\n \n-    if (!column.is_key()\n+    if ((!column.is_key() && schema.keys_type() != KeysType::DUP_KEYS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5de3b9f34af5749656205267a449bcf422df7f2"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMDE0OTYzOnYy", "diffSide": "RIGHT", "path": "be/src/olap/olap_cond.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNDoxNDoxMFrOGS4WYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwMjoxODo1N1rOGTKWDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MDc4NQ==", "bodyText": "I think check agg type is more clear?", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r422450785", "createdAt": "2020-05-09T04:14:10Z", "author": {"login": "kangpinghuang"}, "path": "be/src/olap/olap_cond.cpp", "diffHunk": "@@ -637,7 +637,7 @@ bool Conditions::delete_conditions_eval(const RowCursor& row) const {\n     }\n     \n     for (auto& each_cond : _columns) {\n-        if (each_cond.second->is_key() && !each_cond.second->eval(row)) {\n+        if (_cond_column_is_key_or_duplicate(each_cond.second) && !each_cond.second->eval(row)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5de3b9f34af5749656205267a449bcf422df7f2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc0NTYxMw==", "bodyText": "agg type has two may be null or AGG_NONE, it maybe  more complicated", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r422745613", "createdAt": "2020-05-11T02:18:57Z", "author": {"login": "yangzhg"}, "path": "be/src/olap/olap_cond.cpp", "diffHunk": "@@ -637,7 +637,7 @@ bool Conditions::delete_conditions_eval(const RowCursor& row) const {\n     }\n     \n     for (auto& each_cond : _columns) {\n-        if (each_cond.second->is_key() && !each_cond.second->eval(row)) {\n+        if (_cond_column_is_key_or_duplicate(each_cond.second) && !each_cond.second->eval(row)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MDc4NQ=="}, "originalCommit": {"oid": "b5de3b9f34af5749656205267a449bcf422df7f2"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMDE1MDkyOnYy", "diffSide": "RIGHT", "path": "be/src/olap/rowset/alpha_rowset.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNDoxNzoxNVrOGS4XFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwOTo0Mjo0M1rOGS55Fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MDk2Nw==", "bodyText": "I think we should change the num_key_columns name.\nnum_key_columns  will be ambiguous.", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r422450967", "createdAt": "2020-05-09T04:17:15Z", "author": {"login": "kangpinghuang"}, "path": "be/src/olap/rowset/alpha_rowset.cpp", "diffHunk": "@@ -300,7 +300,7 @@ OLAPStatus AlphaRowset::init() {\n \n         if (segment_group_meta.zone_maps_size() != 0) {\n             size_t zone_maps_size = segment_group_meta.zone_maps_size();\n-            size_t num_key_columns = _schema->num_key_columns();\n+            size_t num_key_columns = _schema->keys_type() == KeysType::DUP_KEYS ? _schema->num_columns() : _schema->num_key_columns();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5de3b9f34af5749656205267a449bcf422df7f2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ3NjA1NA==", "bodyText": "it better to submit anthor pr to fix this", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r422476054", "createdAt": "2020-05-09T09:42:43Z", "author": {"login": "yangzhg"}, "path": "be/src/olap/rowset/alpha_rowset.cpp", "diffHunk": "@@ -300,7 +300,7 @@ OLAPStatus AlphaRowset::init() {\n \n         if (segment_group_meta.zone_maps_size() != 0) {\n             size_t zone_maps_size = segment_group_meta.zone_maps_size();\n-            size_t num_key_columns = _schema->num_key_columns();\n+            size_t num_key_columns = _schema->keys_type() == KeysType::DUP_KEYS ? _schema->num_columns() : _schema->num_key_columns();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MDk2Nw=="}, "originalCommit": {"oid": "b5de3b9f34af5749656205267a449bcf422df7f2"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMDE1NjU4OnYy", "diffSide": "RIGHT", "path": "be/src/olap/wrapper_field.h", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNDoyOTo0NlrOGS4Z6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNDoyOTo0NlrOGS4Z6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MTY4OQ==", "bodyText": "why to add this condition?", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r422451689", "createdAt": "2020-05-09T04:29:46Z", "author": {"login": "kangpinghuang"}, "path": "be/src/olap/wrapper_field.h", "diffHunk": "@@ -81,7 +81,7 @@ class WrapperField {\n     char* ptr() const { return _field_buf + 1; }\n     size_t size() const { return _rep->size(); }\n     size_t field_size() const { return _rep->field_size(); }\n-    bool is_null() const { return *reinterpret_cast<bool*>(_field_buf); }\n+    bool is_null() const { return _field_buf == nullptr || *reinterpret_cast<bool*>(_field_buf); }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5de3b9f34af5749656205267a449bcf422df7f2"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMDE1ODE4OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/load/DeleteHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNDozMzoyOFrOGS4auA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNDozMzoyOFrOGS4auA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MTg5Ng==", "bodyText": "should add some comment to explain why float and double type delete predicate can not be supported.", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r422451896", "createdAt": "2020-05-09T04:33:28Z", "author": {"login": "kangpinghuang"}, "path": "fe/src/main/java/org/apache/doris/load/DeleteHandler.java", "diffHunk": "@@ -478,9 +479,11 @@ private void checkDeleteV2(OlapTable table, Partition partition, List<Predicate>\n             }\n \n             Column column = nameToColumn.get(columnName);\n-            if (!column.isKey()) {\n+            if (!column.isKey() && table.getKeysType() != KeysType.DUP_KEYS", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5de3b9f34af5749656205267a449bcf422df7f2"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0MzA1MjI5OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMzoxODowMVrOGUxGmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMjoxOToyMFrOGVJx-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQyOTIxMQ==", "bodyText": "What is about?", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r424429211", "createdAt": "2020-05-13T13:18:01Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "diffHunk": "@@ -549,7 +548,10 @@ private RollupJobV2 createMaterializedViewJob(String mvName, String baseIndexNam\n                     }\n                     keyStorageLayoutBytes += baseColumn.getType().getStorageLayoutBytes();\n                     Column rollupColumn = new Column(baseColumn);\n-                    if ((i + 1) <= FeConstants.shortkey_max_column_count\n+                    if(changeStorageFormat) {\n+                        rollupColumn.setIsKey(baseColumn.isKey());\n+                        rollupColumn.setAggregationType(baseColumn.getAggregationType(), true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa0034f7fb199a2e42942127a3bfad188d4e73d8"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgzMzUyOA==", "bodyText": "when create a segmentv2 rollup on duplicate table, the previous code did not handle this specific sutiation, it will create a all key rollup, all value columns will convert to key column", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r424833528", "createdAt": "2020-05-14T02:19:20Z", "author": {"login": "yangzhg"}, "path": "fe/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "diffHunk": "@@ -549,7 +548,10 @@ private RollupJobV2 createMaterializedViewJob(String mvName, String baseIndexNam\n                     }\n                     keyStorageLayoutBytes += baseColumn.getType().getStorageLayoutBytes();\n                     Column rollupColumn = new Column(baseColumn);\n-                    if ((i + 1) <= FeConstants.shortkey_max_column_count\n+                    if(changeStorageFormat) {\n+                        rollupColumn.setIsKey(baseColumn.isKey());\n+                        rollupColumn.setAggregationType(baseColumn.getAggregationType(), true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQyOTIxMQ=="}, "originalCommit": {"oid": "aa0034f7fb199a2e42942127a3bfad188d4e73d8"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0MzA1Nzg3OnYy", "diffSide": "RIGHT", "path": "be/src/olap/rowset/segment_group.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMzoxOTowNFrOGUxJ0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMzoyODozMlrOGVKzTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQzMDAzNA==", "bodyText": "All types of column has zone map now?", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r424430034", "createdAt": "2020-05-13T13:19:04Z", "author": {"login": "morningman"}, "path": "be/src/olap/rowset/segment_group.cpp", "diffHunk": "@@ -249,13 +249,13 @@ OLAPStatus SegmentGroup::add_zone_maps_for_linked_schema_change(\n         return OLAP_SUCCESS;\n     }\n \n-    // 1. rollup tablet num_key_columns() will less than base tablet zone_map_fields.size().\n+    // 1. rollup tablet get_num_zone_map_columns() will less than base tablet zone_map_fields.size().\n     //    For LinkedSchemaChange, the rollup tablet keys order is the same as base tablet\n-    // 2. adding column to existed table, num_key_columns() will larger than\n+    // 2. adding column to existed table, get_num_zone_map_columns() will larger than\n     //    zone_map_fields.size()\n \n     int num_new_keys = 0;\n-    for (size_t i = 0; i < _schema->num_key_columns(); ++i) {\n+    for (size_t i = 0; i < get_num_zone_map_columns(); ++i) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa0034f7fb199a2e42942127a3bfad188d4e73d8"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg1MDI1Mg==", "bodyText": "float and double can generate zone map\uff0c bitmap cannot used in duplicate table, so it OK", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r424850252", "createdAt": "2020-05-14T03:28:32Z", "author": {"login": "yangzhg"}, "path": "be/src/olap/rowset/segment_group.cpp", "diffHunk": "@@ -249,13 +249,13 @@ OLAPStatus SegmentGroup::add_zone_maps_for_linked_schema_change(\n         return OLAP_SUCCESS;\n     }\n \n-    // 1. rollup tablet num_key_columns() will less than base tablet zone_map_fields.size().\n+    // 1. rollup tablet get_num_zone_map_columns() will less than base tablet zone_map_fields.size().\n     //    For LinkedSchemaChange, the rollup tablet keys order is the same as base tablet\n-    // 2. adding column to existed table, num_key_columns() will larger than\n+    // 2. adding column to existed table, get_num_zone_map_columns() will larger than\n     //    zone_map_fields.size()\n \n     int num_new_keys = 0;\n-    for (size_t i = 0; i < _schema->num_key_columns(); ++i) {\n+    for (size_t i = 0; i < get_num_zone_map_columns(); ++i) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQzMDAzNA=="}, "originalCommit": {"oid": "aa0034f7fb199a2e42942127a3bfad188d4e73d8"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1702, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}