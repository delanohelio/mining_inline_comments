{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0MDE4MzU5", "number": 3485, "title": "Enhance AssertNumRowsNode", "bodyText": "fixes #3483\nstep1:  Enhance AssertNumRowsNode to support equal, less than, greate than,... assert conditions", "createdAt": "2020-05-06T10:46:12Z", "url": "https://github.com/apache/incubator-doris/pull/3485", "merged": true, "mergeCommit": {"oid": "f90da720787a4a8c79c353d21c2d73d3180ff953"}, "closed": true, "closedAt": "2020-05-08T04:49:49Z", "author": {"login": "yangzhg"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceldufAH2gAyNDE0MDE4MzU5OjRkOWIwNGJlZjUwZGY5NTk2ZTc2ZmFiZGRlZjgxMjljMTBkYjZiMTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABce-6a0AFqTQwNzU4MTE3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4d9b04bef50df9596e76fabddef8129c10db6b19", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/4d9b04bef50df9596e76fabddef8129c10db6b19", "committedDate": "2020-05-06T09:42:46Z", "message": "enhance assert_num_rows_node support specify assert condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c373e5af56a672ae1713ab67263d6b8b15925621", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/c373e5af56a672ae1713ab67263d6b8b15925621", "committedDate": "2020-05-06T09:57:47Z", "message": "enhance assert_num_rows_node support specify assert condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adf1b78eda6b2d90374763dec31a8b530652f91e", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/adf1b78eda6b2d90374763dec31a8b530652f91e", "committedDate": "2020-05-06T10:00:08Z", "message": "enhance assert_num_rows_node support specify assert condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "112dc0f1042225c578267b62a13b0ad03ec56ae6", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/112dc0f1042225c578267b62a13b0ad03ec56ae6", "committedDate": "2020-05-06T10:02:41Z", "message": "enhance assert_num_rows_node support specify assert condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b26349ab56037a1bc8e33496677e56a57fac8bf0", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/b26349ab56037a1bc8e33496677e56a57fac8bf0", "committedDate": "2020-05-06T10:11:43Z", "message": "enhance assert_num_rows_node support specify assert condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a78710f96c8a41a71acf80c9692b66325ebb715", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/5a78710f96c8a41a71acf80c9692b66325ebb715", "committedDate": "2020-05-06T10:24:52Z", "message": "enhance assert_num_rows_node support specify assert condition"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2NzUxOTUy", "url": "https://github.com/apache/incubator-doris/pull/3485#pullrequestreview-406751952", "createdAt": "2020-05-06T15:52:16Z", "commit": {"oid": "5a78710f96c8a41a71acf80c9692b66325ebb715"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNTo1MjoxNlrOGRZvaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNTo1MjoxNlrOGRZvaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwMDcxNQ==", "bodyText": "Where is _TAssertion_VALUES_TO_NAMES  ?", "url": "https://github.com/apache/incubator-doris/pull/3485#discussion_r420900715", "createdAt": "2020-05-06T15:52:16Z", "author": {"login": "kangkaisen"}, "path": "be/src/exec/assert_num_rows_node.cpp", "diffHunk": "@@ -56,12 +62,46 @@ Status AssertNumRowsNode::get_next(RuntimeState* state, RowBatch* output_batch,\n     output_batch->reset();\n     child(0)->get_next(state, output_batch, eos);\n     _num_rows_returned += output_batch->num_rows();\n-    if (_num_rows_returned > _desired_num_rows) {\n-        LOG(INFO) << \"Expected no more than \" << _desired_num_rows << \" to be returned by expression \"\n-                  << _subquery_string;\n-        return Status::Cancelled(strings::Substitute(\n-                                \"Expected no more than $0 to be returned by expression $1\",\n-                                _desired_num_rows, _subquery_string));\n+    bool assert_res = false;\n+    switch (_assertion) {\n+    case TAssertion::EQ:\n+        assert_res = _num_rows_returned == _desired_num_rows;\n+        break;\n+    case TAssertion::NE:\n+        assert_res = _num_rows_returned != _desired_num_rows;\n+        break;\n+    case TAssertion::LT:\n+        assert_res = _num_rows_returned < _desired_num_rows;\n+        break;\n+    case TAssertion::LE:\n+        assert_res = _num_rows_returned <= _desired_num_rows;\n+        break;\n+    case TAssertion::GT:\n+        assert_res = _num_rows_returned > _desired_num_rows;\n+        break;\n+    case TAssertion::GE:\n+        assert_res = _num_rows_returned >= _desired_num_rows;\n+        break;\n+    default:\n+        break;\n+    }\n+\n+    if (!assert_res) {\n+        auto to_string_lamba = [](TAssertion::type assertion) {\n+            std::map<int, const char*>::const_iterator it =\n+                    _TAssertion_VALUES_TO_NAMES.find(assertion);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a78710f96c8a41a71acf80c9692b66325ebb715"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2NzUyMTU3", "url": "https://github.com/apache/incubator-doris/pull/3485#pullrequestreview-406752157", "createdAt": "2020-05-06T15:52:29Z", "commit": {"oid": "5a78710f96c8a41a71acf80c9692b66325ebb715"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNTo1MjoyOVrOGRZwDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNTo1MjoyOVrOGRZwDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwMDg3Nw==", "bodyText": "Code format.", "url": "https://github.com/apache/incubator-doris/pull/3485#discussion_r420900877", "createdAt": "2020-05-06T15:52:29Z", "author": {"login": "kangkaisen"}, "path": "be/src/exec/assert_num_rows_node.cpp", "diffHunk": "@@ -17,19 +17,25 @@\n \n #include \"exec/assert_num_rows_node.h\"\n \n+#include \"gen_cpp/PlanNodes_types.h\"\n+#include \"gutil/strings/substitute.h\"\n #include \"runtime/row_batch.h\"\n #include \"runtime/runtime_state.h\"\n #include \"util/runtime_profile.h\"\n-#include \"gen_cpp/PlanNodes_types.h\"\n-#include \"gutil/strings/substitute.h\"\n \n namespace doris {\n \n-AssertNumRowsNode::AssertNumRowsNode(\n-    ObjectPool* pool, const TPlanNode& tnode, const DescriptorTbl& descs) :\n-        ExecNode(pool, tnode, descs),\n-        _desired_num_rows(tnode.assert_num_rows_node.desired_num_rows),\n-        _subquery_string(tnode.assert_num_rows_node.subquery_string) {\n+AssertNumRowsNode::AssertNumRowsNode(ObjectPool* pool, const TPlanNode& tnode,\n+                                     const DescriptorTbl& descs)\n+        : ExecNode(pool, tnode, descs),\n+          _desired_num_rows(tnode.assert_num_rows_node.desired_num_rows),\n+          _subquery_string(tnode.assert_num_rows_node.subquery_string) {\n+    if (tnode.assert_num_rows_node.__isset.assertion) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a78710f96c8a41a71acf80c9692b66325ebb715"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b417cdec40e698acdd5e1654c256fcbc61f7b91c", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/b417cdec40e698acdd5e1654c256fcbc61f7b91c", "committedDate": "2020-05-07T02:33:13Z", "message": "format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db28059309e06898be844c3a4b6f720db3d7c563", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/db28059309e06898be844c3a4b6f720db3d7c563", "committedDate": "2020-05-07T02:35:17Z", "message": "format"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db28059309e06898be844c3a4b6f720db3d7c563", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/db28059309e06898be844c3a4b6f720db3d7c563", "committedDate": "2020-05-07T02:35:17Z", "message": "format"}, "afterCommit": {"oid": "d2880c07bdbfe418dd8c75b11c21ab757703238b", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/d2880c07bdbfe418dd8c75b11c21ab757703238b", "committedDate": "2020-05-07T04:57:30Z", "message": "format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3MTIxNzA1", "url": "https://github.com/apache/incubator-doris/pull/3485#pullrequestreview-407121705", "createdAt": "2020-05-07T03:10:36Z", "commit": {"oid": "5a78710f96c8a41a71acf80c9692b66325ebb715"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwMzoxMDozNlrOGRs0PQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwMzoxMjoyMFrOGRs2Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxMzI0NQ==", "bodyText": "Pay attention to code alignment", "url": "https://github.com/apache/incubator-doris/pull/3485#discussion_r421213245", "createdAt": "2020-05-07T03:10:36Z", "author": {"login": "EmmyMiao87"}, "path": "be/src/exec/assert_num_rows_node.cpp", "diffHunk": "@@ -17,19 +17,25 @@\n \n #include \"exec/assert_num_rows_node.h\"\n \n+#include \"gen_cpp/PlanNodes_types.h\"\n+#include \"gutil/strings/substitute.h\"\n #include \"runtime/row_batch.h\"\n #include \"runtime/runtime_state.h\"\n #include \"util/runtime_profile.h\"\n-#include \"gen_cpp/PlanNodes_types.h\"\n-#include \"gutil/strings/substitute.h\"\n \n namespace doris {\n \n-AssertNumRowsNode::AssertNumRowsNode(\n-    ObjectPool* pool, const TPlanNode& tnode, const DescriptorTbl& descs) :\n-        ExecNode(pool, tnode, descs),\n-        _desired_num_rows(tnode.assert_num_rows_node.desired_num_rows),\n-        _subquery_string(tnode.assert_num_rows_node.subquery_string) {\n+AssertNumRowsNode::AssertNumRowsNode(ObjectPool* pool, const TPlanNode& tnode,\n+                                     const DescriptorTbl& descs)\n+        : ExecNode(pool, tnode, descs),\n+          _desired_num_rows(tnode.assert_num_rows_node.desired_num_rows),\n+          _subquery_string(tnode.assert_num_rows_node.subquery_string) {\n+    if (tnode.assert_num_rows_node.__isset.assertion) {\n+                _assertion = tnode.assert_num_rows_node.assertion;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a78710f96c8a41a71acf80c9692b66325ebb715"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxMzY5OA==", "bodyText": "Pay attention to code alignment", "url": "https://github.com/apache/incubator-doris/pull/3485#discussion_r421213698", "createdAt": "2020-05-07T03:12:20Z", "author": {"login": "EmmyMiao87"}, "path": "be/src/exec/assert_num_rows_node.cpp", "diffHunk": "@@ -56,12 +62,46 @@ Status AssertNumRowsNode::get_next(RuntimeState* state, RowBatch* output_batch,\n     output_batch->reset();\n     child(0)->get_next(state, output_batch, eos);\n     _num_rows_returned += output_batch->num_rows();\n-    if (_num_rows_returned > _desired_num_rows) {\n-        LOG(INFO) << \"Expected no more than \" << _desired_num_rows << \" to be returned by expression \"\n-                  << _subquery_string;\n-        return Status::Cancelled(strings::Substitute(\n-                                \"Expected no more than $0 to be returned by expression $1\",\n-                                _desired_num_rows, _subquery_string));\n+    bool assert_res = false;\n+    switch (_assertion) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a78710f96c8a41a71acf80c9692b66325ebb715"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3MTg3MjMz", "url": "https://github.com/apache/incubator-doris/pull/3485#pullrequestreview-407187233", "createdAt": "2020-05-07T06:42:30Z", "commit": {"oid": "d2880c07bdbfe418dd8c75b11c21ab757703238b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2880c07bdbfe418dd8c75b11c21ab757703238b", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/d2880c07bdbfe418dd8c75b11c21ab757703238b", "committedDate": "2020-05-07T04:57:30Z", "message": "format"}, "afterCommit": {"oid": "db28059309e06898be844c3a4b6f720db3d7c563", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/db28059309e06898be844c3a4b6f720db3d7c563", "committedDate": "2020-05-07T02:35:17Z", "message": "format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3MjkwMDk5", "url": "https://github.com/apache/incubator-doris/pull/3485#pullrequestreview-407290099", "createdAt": "2020-05-07T09:13:23Z", "commit": {"oid": "db28059309e06898be844c3a4b6f720db3d7c563"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NTgxMTc2", "url": "https://github.com/apache/incubator-doris/pull/3485#pullrequestreview-407581176", "createdAt": "2020-05-07T15:21:44Z", "commit": {"oid": "db28059309e06898be844c3a4b6f720db3d7c563"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2965, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}