{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyNDMwNTU1", "number": 2752, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNDo1NToyOFrODXu52A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwMTowNzoxOVrODYCWKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MjEyMzEyOnYy", "diffSide": "RIGHT", "path": "be/src/exprs/bitmap_function.cpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNDo1NToyOFrOFdMLNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNDo1NToyOFrOFdMLNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MjUwMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            BooleanVal BitmapFunctions::bitmap_contains(FunctionContext *ctx, const StringVal &src, const IntVal &input) {\n          \n          \n            \n            BooleanVal BitmapFunctions::bitmap_contains(FunctionContext* ctx, const StringVal& src, const IntVal& input) {", "url": "https://github.com/apache/incubator-doris/pull/2752#discussion_r366152501", "createdAt": "2020-01-14T04:55:28Z", "author": {"login": "imay"}, "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -465,6 +465,43 @@ StringVal BitmapFunctions::bitmap_from_string(FunctionContext* ctx, const String\n     return result;\n }\n \n+BooleanVal BitmapFunctions::bitmap_contains(FunctionContext *ctx, const StringVal &src, const IntVal &input) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f1a1db03e1903f6ddcc8f642f620d7492af1635"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MjEyNTE4OnYy", "diffSide": "RIGHT", "path": "be/src/exprs/bitmap_function.cpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNDo1NzoyMFrOFdMMYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNDo1NzoyMFrOFdMMYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MjgwMQ==", "bodyText": "when src.len == 0, src.ptr points to a bitmap object. we should handle that case", "url": "https://github.com/apache/incubator-doris/pull/2752#discussion_r366152801", "createdAt": "2020-01-14T04:57:20Z", "author": {"login": "imay"}, "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -465,6 +465,43 @@ StringVal BitmapFunctions::bitmap_from_string(FunctionContext* ctx, const String\n     return result;\n }\n \n+BooleanVal BitmapFunctions::bitmap_contains(FunctionContext *ctx, const StringVal &src, const IntVal &input) {\n+    if (src.is_null || input.is_null) {\n+        return BooleanVal::null();\n+    }\n+\n+    if (src.len == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f1a1db03e1903f6ddcc8f642f620d7492af1635"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MjEyNzM4OnYy", "diffSide": "RIGHT", "path": "be/src/exprs/bitmap_function.cpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNDo1ODo1NVrOFdMNqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNDo1ODo1NVrOFdMNqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MzEyOQ==", "bodyText": "RoaringBitmap has already had contains method, you can use it directly", "url": "https://github.com/apache/incubator-doris/pull/2752#discussion_r366153129", "createdAt": "2020-01-14T04:58:55Z", "author": {"login": "imay"}, "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -465,6 +465,43 @@ StringVal BitmapFunctions::bitmap_from_string(FunctionContext* ctx, const String\n     return result;\n }\n \n+BooleanVal BitmapFunctions::bitmap_contains(FunctionContext *ctx, const StringVal &src, const IntVal &input) {\n+    if (src.is_null || input.is_null) {\n+        return BooleanVal::null();\n+    }\n+\n+    if (src.len == 0) {\n+        return BooleanVal(false);\n+    }\n+\n+    RoaringBitmap bitmap;\n+    bitmap.update(input.val);\n+    bitmap.intersect(RoaringBitmap((char*)src.ptr));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f1a1db03e1903f6ddcc8f642f620d7492af1635"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MjEyODM2OnYy", "diffSide": "RIGHT", "path": "be/src/exprs/bitmap_function.cpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNDo1OTo0M1rOFdMOPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNDo1OTo0M1rOFdMOPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MzI3OA==", "bodyText": "zero size means the src input is a object pointer", "url": "https://github.com/apache/incubator-doris/pull/2752#discussion_r366153278", "createdAt": "2020-01-14T04:59:43Z", "author": {"login": "kangkaisen"}, "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -465,6 +465,43 @@ StringVal BitmapFunctions::bitmap_from_string(FunctionContext* ctx, const String\n     return result;\n }\n \n+BooleanVal BitmapFunctions::bitmap_contains(FunctionContext *ctx, const StringVal &src, const IntVal &input) {\n+    if (src.is_null || input.is_null) {\n+        return BooleanVal::null();\n+    }\n+\n+    if (src.len == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f1a1db03e1903f6ddcc8f642f620d7492af1635"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MjEyODc1OnYy", "diffSide": "RIGHT", "path": "be/src/exprs/bitmap_function.cpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNTowMDowOVrOFdMOeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNTowMDowOVrOFdMOeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MzMzOA==", "bodyText": "zero size means the src input is a object pointer", "url": "https://github.com/apache/incubator-doris/pull/2752#discussion_r366153338", "createdAt": "2020-01-14T05:00:09Z", "author": {"login": "kangkaisen"}, "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -465,6 +465,43 @@ StringVal BitmapFunctions::bitmap_from_string(FunctionContext* ctx, const String\n     return result;\n }\n \n+BooleanVal BitmapFunctions::bitmap_contains(FunctionContext *ctx, const StringVal &src, const IntVal &input) {\n+    if (src.is_null || input.is_null) {\n+        return BooleanVal::null();\n+    }\n+\n+    if (src.len == 0) {\n+        return BooleanVal(false);\n+    }\n+\n+    RoaringBitmap bitmap;\n+    bitmap.update(input.val);\n+    bitmap.intersect(RoaringBitmap((char*)src.ptr));\n+\n+    if (bitmap.cardinality() == 1) {\n+        return BooleanVal(true);\n+    }\n+    return BooleanVal(false);\n+}\n+\n+BooleanVal BitmapFunctions::bitmap_has_any(FunctionContext *ctx, const StringVal &lhs, const StringVal &rhs) {\n+    if (lhs.is_null || rhs.is_null) {\n+        return BooleanVal::null();\n+    }\n+\n+    if (lhs.len == 0 || rhs.len == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f1a1db03e1903f6ddcc8f642f620d7492af1635"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MjEyOTE0OnYy", "diffSide": "RIGHT", "path": "be/src/exprs/bitmap_function.cpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNTowMDozNlrOFdMOtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNTowMDozNlrOFdMOtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MzM5Nw==", "bodyText": "Because we don't have unsigned int, but the bit value can exceede the max int. Better use BigIntValue as bit index", "url": "https://github.com/apache/incubator-doris/pull/2752#discussion_r366153397", "createdAt": "2020-01-14T05:00:36Z", "author": {"login": "imay"}, "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -465,6 +465,43 @@ StringVal BitmapFunctions::bitmap_from_string(FunctionContext* ctx, const String\n     return result;\n }\n \n+BooleanVal BitmapFunctions::bitmap_contains(FunctionContext *ctx, const StringVal &src, const IntVal &input) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f1a1db03e1903f6ddcc8f642f620d7492af1635"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NTMwODU4OnYy", "diffSide": "RIGHT", "path": "be/src/exprs/bitmap_function.cpp", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwMTowNzoxOVrOFdqslg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwMjo1ODo1MVrOFdsIiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY1MjU2Ng==", "bodyText": "This operation is wasteful.\nIt is efficient to operate with src.ptr.", "url": "https://github.com/apache/incubator-doris/pull/2752#discussion_r366652566", "createdAt": "2020-01-15T01:07:19Z", "author": {"login": "imay"}, "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -465,6 +465,44 @@ StringVal BitmapFunctions::bitmap_from_string(FunctionContext* ctx, const String\n     return result;\n }\n \n+BooleanVal BitmapFunctions::bitmap_contains(FunctionContext* ctx, const StringVal& src, const BigIntVal& input) {\n+    if (src.is_null || input.is_null) {\n+        return BooleanVal::null();\n+    }\n+\n+    RoaringBitmap bitmap;\n+    if (src.len == 0) {\n+        bitmap.merge(*reinterpret_cast<RoaringBitmap*>(src.ptr));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da2e36b99e47fac59eee0c6fe575ff531492e5a0"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY3NjEwNA==", "bodyText": "ok", "url": "https://github.com/apache/incubator-doris/pull/2752#discussion_r366676104", "createdAt": "2020-01-15T02:58:51Z", "author": {"login": "DanyBin"}, "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -465,6 +465,44 @@ StringVal BitmapFunctions::bitmap_from_string(FunctionContext* ctx, const String\n     return result;\n }\n \n+BooleanVal BitmapFunctions::bitmap_contains(FunctionContext* ctx, const StringVal& src, const BigIntVal& input) {\n+    if (src.is_null || input.is_null) {\n+        return BooleanVal::null();\n+    }\n+\n+    RoaringBitmap bitmap;\n+    if (src.len == 0) {\n+        bitmap.merge(*reinterpret_cast<RoaringBitmap*>(src.ptr));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY1MjU2Ng=="}, "originalCommit": {"oid": "da2e36b99e47fac59eee0c6fe575ff531492e5a0"}, "originalPosition": 11}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2346, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}