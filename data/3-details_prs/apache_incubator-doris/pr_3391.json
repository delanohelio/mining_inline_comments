{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4NTUwMjUz", "number": 3391, "title": "[Load] Add more info in SHOW LOAD result", "bodyText": "Fix #3390\nThis CL add more info in JobDetails column of SHOW LOAD result for Broker Load Job.\nFor example:\n{\n\t\"Unfinished backends\": {\n\t\t\"9c3441027ff948a0-8287923329a2b6a7\": [10002]\n\t},\n        \"All backends\": {\n\t\t\"9c3441027ff948a0-8287923329a2b6a7\": [10002, 10004, 10006]\n\t},\n\t\"ScannedRows\": 2390016,\n\t\"TaskNumber\": 1,\n\t\"FileNumber\": 1,\n\t\"FileSize\": 1073741824\n}\n\n2 newly added keys:\nUnfinished backends indicates the BE which task on them are not finished.\nAll backends indicates the BE which this job has tasks on it.\nOne more thing, I pass the Backend Id along with the heartbeat msg from FE to BE, so that BE can\nknow the Id of themselves.", "createdAt": "2020-04-24T13:26:03Z", "url": "https://github.com/apache/incubator-doris/pull/3391", "merged": true, "mergeCommit": {"oid": "9a934ec9f6c3eedf184303823cde43ae2975912b"}, "closed": true, "closedAt": "2020-04-26T13:30:24Z", "author": {"login": "morningman"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaxVF7AH2gAyNDA4NTUwMjUzOmVhNzY4MWZkMDg4YjVmYjQwMTlhY2UyYWNlZGRkYzRmZDE3MjQ4ODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbZYN9gFqTQwMDQ5NTUxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ea7681fd088b5fb4019ace2acedddc4fd1724883", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/ea7681fd088b5fb4019ace2acedddc4fd1724883", "committedDate": "2020-04-24T13:16:30Z", "message": "commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9325446458e3116ab358a3902c8d6b1474efaad5", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/9325446458e3116ab358a3902c8d6b1474efaad5", "committedDate": "2020-04-24T14:00:13Z", "message": "fix bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMzczODc3", "url": "https://github.com/apache/incubator-doris/pull/3391#pullrequestreview-400373877", "createdAt": "2020-04-25T08:49:49Z", "commit": {"oid": "9325446458e3116ab358a3902c8d6b1474efaad5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwODo0OTo1MFrOGLyo4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwODo0OTo1MFrOGLyo4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTAxNzE4NQ==", "bodyText": "Maybe change \u201cbeId\u201d to \u201dbackendId\u201c is better\uff0cat before you use unfinished\u201cBackendIds\u201d  and all\u201dBackendIds\u201c", "url": "https://github.com/apache/incubator-doris/pull/3391#discussion_r415017185", "createdAt": "2020-04-25T08:49:50Z", "author": {"login": "wutiangan"}, "path": "fe/src/main/java/org/apache/doris/load/loadv2/LoadJob.java", "diffHunk": "@@ -138,30 +139,41 @@\n         // load task id -> fragment id -> rows count\n         private Table<TUniqueId, TUniqueId, Long> counterTbl = HashBasedTable.create();\n \n+        // load task id -> unfinished backend id list\n+        private Map<TUniqueId, List<Long>> unfinishedBackendIds = Maps.newHashMap();\n+        // load task id -> all backend id list\n+        private Map<TUniqueId, List<Long>> allBackendIds = Maps.newHashMap();\n+\n         // number of file to be loaded\n         public int fileNum = 0;\n         public long totalFileSizeB = 0;\n \n         // init the statistic of specified load task\n-        public synchronized void initLoad(TUniqueId loadId, Set<TUniqueId> fragmentIds) {\n+        public synchronized void initLoad(TUniqueId loadId, Set<TUniqueId> fragmentIds, List<Long> relatedBackendIds) {\n             counterTbl.rowMap().remove(loadId);\n             for (TUniqueId fragId : fragmentIds) {\n                 counterTbl.put(loadId, fragId, 0L);\n             }\n+            allBackendIds.put(loadId, relatedBackendIds);\n+            // need to get a copy of relatedBackendIds, so that when we modify the \"relatedBackendIds\" in\n+            // allBackendIds, the list in unfinishedBackendIds will not be changed.\n+            unfinishedBackendIds.put(loadId, Lists.newArrayList(relatedBackendIds));\n         }\n \n         public synchronized void removeLoad(TUniqueId loadId) {\n             counterTbl.rowMap().remove(loadId);\n+            unfinishedBackendIds.remove(loadId);\n+            allBackendIds.remove(loadId);\n         }\n \n-        public synchronized void updateLoad(TUniqueId loadId, TUniqueId fragmentId, long rows) {\n+        public synchronized void updateLoadProgress(long beId, TUniqueId loadId, TUniqueId fragmentId, long rows,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9325446458e3116ab358a3902c8d6b1474efaad5"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMzczODg0", "url": "https://github.com/apache/incubator-doris/pull/3391#pullrequestreview-400373884", "createdAt": "2020-04-25T08:49:54Z", "commit": {"oid": "9325446458e3116ab358a3902c8d6b1474efaad5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwODo0OTo1NFrOGLyo8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwODo0OTo1NFrOGLyo8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTAxNzIwMg==", "bodyText": "can unfinishedBackendIds.get(loadId) be empty\uff1f", "url": "https://github.com/apache/incubator-doris/pull/3391#discussion_r415017202", "createdAt": "2020-04-25T08:49:54Z", "author": {"login": "wutiangan"}, "path": "fe/src/main/java/org/apache/doris/load/loadv2/LoadJob.java", "diffHunk": "@@ -138,30 +139,41 @@\n         // load task id -> fragment id -> rows count\n         private Table<TUniqueId, TUniqueId, Long> counterTbl = HashBasedTable.create();\n \n+        // load task id -> unfinished backend id list\n+        private Map<TUniqueId, List<Long>> unfinishedBackendIds = Maps.newHashMap();\n+        // load task id -> all backend id list\n+        private Map<TUniqueId, List<Long>> allBackendIds = Maps.newHashMap();\n+\n         // number of file to be loaded\n         public int fileNum = 0;\n         public long totalFileSizeB = 0;\n \n         // init the statistic of specified load task\n-        public synchronized void initLoad(TUniqueId loadId, Set<TUniqueId> fragmentIds) {\n+        public synchronized void initLoad(TUniqueId loadId, Set<TUniqueId> fragmentIds, List<Long> relatedBackendIds) {\n             counterTbl.rowMap().remove(loadId);\n             for (TUniqueId fragId : fragmentIds) {\n                 counterTbl.put(loadId, fragId, 0L);\n             }\n+            allBackendIds.put(loadId, relatedBackendIds);\n+            // need to get a copy of relatedBackendIds, so that when we modify the \"relatedBackendIds\" in\n+            // allBackendIds, the list in unfinishedBackendIds will not be changed.\n+            unfinishedBackendIds.put(loadId, Lists.newArrayList(relatedBackendIds));\n         }\n \n         public synchronized void removeLoad(TUniqueId loadId) {\n             counterTbl.rowMap().remove(loadId);\n+            unfinishedBackendIds.remove(loadId);\n+            allBackendIds.remove(loadId);\n         }\n \n-        public synchronized void updateLoad(TUniqueId loadId, TUniqueId fragmentId, long rows) {\n+        public synchronized void updateLoadProgress(long beId, TUniqueId loadId, TUniqueId fragmentId, long rows,\n+                boolean isDone) {\n             if (counterTbl.contains(loadId, fragmentId)) {\n                 counterTbl.put(loadId, fragmentId, rows);\n             }\n-        }\n-\n-        public synchronized void clearAllLoads() {\n-            counterTbl.clear();\n+            if (isDone && unfinishedBackendIds.containsKey(loadId)) {\n+                unfinishedBackendIds.get(loadId).remove(beId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9325446458e3116ab358a3902c8d6b1474efaad5"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b441fa7cfe84cc2448616ed52dca6888044898a", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/3b441fa7cfe84cc2448616ed52dca6888044898a", "committedDate": "2020-04-25T13:45:52Z", "message": "fix by review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDk1NTE2", "url": "https://github.com/apache/incubator-doris/pull/3391#pullrequestreview-400495516", "createdAt": "2020-04-26T11:56:08Z", "commit": {"oid": "3b441fa7cfe84cc2448616ed52dca6888044898a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2860, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}