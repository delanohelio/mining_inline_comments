{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNTI4MjM2", "number": 3424, "title": "allow delete duplicated non-key column using delete from ", "bodyText": "#3321\nallow delete duplicated non-key column using delete from clasue\nmysql> show create table table1;\n+--------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Table  | Create Table                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |\n+--------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| table1 | CREATE TABLE `table1` (\n  `siteid` int(11) NULL DEFAULT \"10\" COMMENT \"\",\n  `citycode` smallint(6) NULL COMMENT \"\",\n  `username` varchar(32) NULL DEFAULT \"\" COMMENT \"\",\n  `pv` bigint(20) NULL DEFAULT \"0\" COMMENT \"\"\n) ENGINE=OLAP\nDUPLICATE KEY(`siteid`, `citycode`, `username`)\nCOMMENT \"OLAP\"\nDISTRIBUTED BY HASH(`siteid`) BUCKETS 10\nPROPERTIES (\n\"storage_type\" = \"COLUMN\",\n \"replication_num\" = \"1\",\n \"in_memory\" = \"false\"\n); |\n+--------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n1 row in set (0.00 sec)\nmysql> select * from table1;\n+--------+----------+----------+------+\n| siteid | citycode | username | pv   |\n+--------+----------+----------+------+\n|      3 |        2 | tom      |    2 |\n|      3 |        2 | tom      |    2 |\n|      5 |        3 | helen    |    3 |\n|      2 |        1 | grace    |    2 |\n|      2 |        1 | grace    |    2 |\n|      2 |        1 | grace    |    2 |\n|      4 |        3 | bush     |    3 |\n+--------+----------+----------+------+\n7 rows in set (0.05 sec)\nmysql> delete from table1 where pv =3;\nQuery OK, 0 rows affected (0.03 sec)\n{'label':'delete_6a5c9479-5581-46b7-9ebc-c4f770639ca9', 'status':'VISIBLE', 'txnId':'13388'}\n\nmysql> select * from table1;\n+--------+----------+----------+------+\n| siteid | citycode | username | pv   |\n+--------+----------+----------+------+\n|      2 |        1 | grace    |    2 |\n|      2 |        1 | grace    |    2 |\n|      2 |        1 | grace    |    2 |\n|      3 |        2 | tom      |    2 |\n|      3 |        2 | tom      |    2 |\n+--------+----------+----------+------+\n5 rows in set (0.06 sec)", "createdAt": "2020-04-29T07:02:45Z", "url": "https://github.com/apache/incubator-doris/pull/3424", "merged": true, "mergeCommit": {"oid": "123e1394b167247bd48adf04be6b104362f0c23a"}, "closed": true, "closedAt": "2020-05-15T01:26:37Z", "author": {"login": "yangzhg"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccWyeGABqjMyODQxNjU5MjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchNav_AFqTQxMTc5ODU4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a5e12da8e28d130da8dc0cb1916d395f094ff23e", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/a5e12da8e28d130da8dc0cb1916d395f094ff23e", "committedDate": "2020-04-29T10:44:15Z", "message": "add unit test"}, "afterCommit": {"oid": "adacf8007b8b9345bea2210e50e1c482618e2035", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/adacf8007b8b9345bea2210e50e1c482618e2035", "committedDate": "2020-04-29T11:28:26Z", "message": "add unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNzM1OTAw", "url": "https://github.com/apache/incubator-doris/pull/3424#pullrequestreview-402735900", "createdAt": "2020-04-29T14:40:31Z", "commit": {"oid": "adacf8007b8b9345bea2210e50e1c482618e2035"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNDo0MDozMVrOGOCL_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNDo1MDo0MlrOGOCrqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM2OTA4NA==", "bodyText": "cond_it.second->is_key() || _schema->keys_type() == KeysType::DUP_KEYS\nThis condition shows many times. How about extract it to a method?", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r417369084", "createdAt": "2020-04-29T14:40:31Z", "author": {"login": "morningman"}, "path": "be/src/olap/olap_cond.cpp", "diffHunk": "@@ -681,17 +681,17 @@ int Conditions::delete_pruning_filter(const std::vector<KeyRange>& zone_maps) co\n     for (auto& cond_it : _columns) {\n         /*\n          * this is base on the assumption that the delete condition\n-         * is only about key field, not about value field.\n+         * is only about key field, not about value field except the storage model is duplicate.\n         */\n-        if (cond_it.second->is_key() && cond_it.first > zone_maps.size()) {\n+        if ((cond_it.second->is_key() || _schema->keys_type() == KeysType::DUP_KEYS) && cond_it.first > zone_maps.size()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "adacf8007b8b9345bea2210e50e1c482618e2035"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM3NzE5Mw==", "bodyText": "English", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r417377193", "createdAt": "2020-04-29T14:50:42Z", "author": {"login": "morningman"}, "path": "be/test/olap/delete_handler_test.cpp", "diffHunk": "@@ -265,6 +358,17 @@ TEST_F(TestDeleteConditionHandler, StoreCondNonexistentColumn) {\n \n     failed_res = _delete_condition_handler.generate_delete_predicate(tablet->tablet_schema(), conditions, &del_pred);;\n     ASSERT_EQ(OLAP_ERR_DELETE_INVALID_CONDITION, failed_res);\n+\n+    // 'v'\u662fvalue\u5217 \u4f46\u662f\u5728duplicate \u6a21\u578b\u6c47\u603b", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "adacf8007b8b9345bea2210e50e1c482618e2035"}, "originalPosition": 125}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "adacf8007b8b9345bea2210e50e1c482618e2035", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/adacf8007b8b9345bea2210e50e1c482618e2035", "committedDate": "2020-04-29T11:28:26Z", "message": "add unit test"}, "afterCommit": {"oid": "06896596fa4389ab53cb67841b30ac78f57c4811", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/06896596fa4389ab53cb67841b30ac78f57c4811", "committedDate": "2020-04-30T03:38:30Z", "message": "fix typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNDI1NDE2", "url": "https://github.com/apache/incubator-doris/pull/3424#pullrequestreview-403425416", "createdAt": "2020-04-30T11:17:34Z", "commit": {"oid": "e34b15825294263a9415fa31173fa2c98f834710"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxMToxNzozNFrOGOkzZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxMToxNzozNFrOGOkzZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNjIzMA==", "bodyText": "ZoneMap is not used for un-sorted column.\nMost of the time, you will have to filter the delete predicate row by row.", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r417936230", "createdAt": "2020-04-30T11:17:34Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/rowset/segment_group.cpp", "diffHunk": "@@ -697,6 +697,13 @@ const TabletSchema& SegmentGroup::get_tablet_schema() {\n     return *_schema;\n }\n \n+int SegmentGroup::get_num_zone_map_columns() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34b15825294263a9415fa31173fa2c98f834710"}, "originalPosition": 39}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e34b15825294263a9415fa31173fa2c98f834710", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/e34b15825294263a9415fa31173fa2c98f834710", "committedDate": "2020-04-30T08:38:26Z", "message": "fix bug"}, "afterCommit": {"oid": "ba2168ed9036bfe6d700b2a431ab6a284c1c98f4", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/ba2168ed9036bfe6d700b2a431ab6a284c1c98f4", "committedDate": "2020-05-06T07:59:15Z", "message": "fix bug"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ba2168ed9036bfe6d700b2a431ab6a284c1c98f4", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/ba2168ed9036bfe6d700b2a431ab6a284c1c98f4", "committedDate": "2020-05-06T07:59:15Z", "message": "fix bug"}, "afterCommit": {"oid": "2cbfd62af8df1ba740326259b6708b876ba2fece", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/2cbfd62af8df1ba740326259b6708b876ba2fece", "committedDate": "2020-05-07T05:05:52Z", "message": "allow delete duplicated non-key column"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2cbfd62af8df1ba740326259b6708b876ba2fece", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/2cbfd62af8df1ba740326259b6708b876ba2fece", "committedDate": "2020-05-07T05:05:52Z", "message": "allow delete duplicated non-key column"}, "afterCommit": {"oid": "ba2168ed9036bfe6d700b2a431ab6a284c1c98f4", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/ba2168ed9036bfe6d700b2a431ab6a284c1c98f4", "committedDate": "2020-05-06T07:59:15Z", "message": "fix bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NjA3OTE3", "url": "https://github.com/apache/incubator-doris/pull/3424#pullrequestreview-407607917", "createdAt": "2020-05-07T15:50:59Z", "commit": {"oid": "2081aba768f1dc3944b3c083aece8b4ca96ef991"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNTo1MDo1OVrOGSFEiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNjowMzoyNlrOGSFmzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxMDYzMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LOG(WARNING) << \"field is not key column, or storage model is not duplicted, or its type is float or double.\";\n          \n          \n            \n                    LOG(WARNING) << \"field is not key column, or storage model is not duplicated, or its type is float or double.\";", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r421610632", "createdAt": "2020-05-07T15:50:59Z", "author": {"login": "morningman"}, "path": "be/src/olap/delete_handler.cpp", "diffHunk": "@@ -105,10 +105,10 @@ OLAPStatus DeleteConditionHandler::check_condition_valid(\n     // \u68c0\u67e5\u6307\u5b9a\u7684\u5217\u662f\u4e0d\u662fkey\uff0c\u662f\u4e0d\u662ffloat\u6216doulbe\u7c7b\u578b\n     const TabletColumn& column = schema.column(field_index);\n \n-    if (!column.is_key()\n+    if ((!column.is_key() && schema.keys_type() != KeysType::DUP_KEYS)\n             || column.type() == OLAP_FIELD_TYPE_DOUBLE\n             || column.type() == OLAP_FIELD_TYPE_FLOAT) {\n-        LOG(WARNING) << \"field is not key column, or its type is float or double.\";\n+        LOG(WARNING) << \"field is not key column, or storage model is not duplicted, or its type is float or double.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2081aba768f1dc3944b3c083aece8b4ca96ef991"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxMzA5Ng==", "bodyText": "Does float or double column have ZoneMap?", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r421613096", "createdAt": "2020-05-07T15:54:26Z", "author": {"login": "morningman"}, "path": "be/src/olap/rowset/column_data.cpp", "diffHunk": "@@ -509,7 +510,10 @@ int ColumnData::delete_pruning_filter() {\n         return DEL_NOT_SATISFIED;\n     }\n \n-    if (!_segment_group->has_zone_maps()) {\n+    int num_zone_maps = _schema.keys_type() == KeysType::DUP_KEYS ? _schema.num_columns() : _schema.num_key_columns();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2081aba768f1dc3944b3c083aece8b4ca96ef991"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxNjQ4Mw==", "bodyText": "Do not change this in this PR, better to submit another new PR to change it.", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r421616483", "createdAt": "2020-05-07T15:59:07Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/common/Config.java", "diffHunk": "@@ -1053,7 +1053,7 @@\n      * control materialized view\n      */\n     @ConfField(mutable = true, masterOnly = true)\n-    public static boolean enable_materialized_view = false;\n+    public static boolean enable_materialized_view = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2081aba768f1dc3944b3c083aece8b4ca96ef991"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxOTAyOQ==", "bodyText": "if index is DUPLICATED, but column type is float or double, we should also forbid the delete operation.", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r421619029", "createdAt": "2020-05-07T16:02:51Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/load/DeleteHandler.java", "diffHunk": "@@ -509,8 +510,8 @@ private void checkDeleteV2(OlapTable table, Partition partition, List<Predicate>\n                 if (column == null) {\n                     ErrorReport.reportDdlException(ErrorCode.ERR_BAD_FIELD_ERROR, columnName, indexName);\n                 }\n-\n-                if (table.getKeysType() == KeysType.DUP_KEYS && !column.isKey()) {\n+                MaterializedIndexMeta indexMeta = table.getIndexIdToMeta().get(index.getId());\n+                if (indexMeta.getKeysType() != KeysType.DUP_KEYS && !column.isKey()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2081aba768f1dc3944b3c083aece8b4ca96ef991"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxOTQwNg==", "bodyText": "No need to modify here, this method is deprecated.", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r421619406", "createdAt": "2020-05-07T16:03:26Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/load/Load.java", "diffHunk": "@@ -3123,7 +3123,7 @@ private void checkDeleteV2(OlapTable table, Partition partition, List<Predicate>\n             }\n \n             Column column = nameToColumn.get(columnName);\n-            if (!column.isKey()) {\n+            if (!column.isKey() && table.getKeysType() != KeysType.DUP_KEYS) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2081aba768f1dc3944b3c083aece8b4ca96ef991"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b2287abbb2efc9ce6dbee4aed7f3ef8d37a5eba", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/4b2287abbb2efc9ce6dbee4aed7f3ef8d37a5eba", "committedDate": "2020-05-08T11:25:38Z", "message": "allow delete duplicated non-key column\n\nadd some comment\n\nadd unit test\n\nfix double unregister\n\nfix typo\n\nfix typo\n\nfix schema\n\nfix typo\n\nfix bug\n\nUpdate be/src/olap/delete_handler.cpp\n\nCo-authored-by: Mingyu Chen <morningman.cmy@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f19780987dd54f6ff849fa900233b232bbe15552", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/f19780987dd54f6ff849fa900233b232bbe15552", "committedDate": "2020-05-08T02:21:05Z", "message": "Update be/src/olap/delete_handler.cpp\n\nCo-authored-by: Mingyu Chen <morningman.cmy@gmail.com>"}, "afterCommit": {"oid": "4b2287abbb2efc9ce6dbee4aed7f3ef8d37a5eba", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/4b2287abbb2efc9ce6dbee4aed7f3ef8d37a5eba", "committedDate": "2020-05-08T11:25:38Z", "message": "allow delete duplicated non-key column\n\nadd some comment\n\nadd unit test\n\nfix double unregister\n\nfix typo\n\nfix typo\n\nfix schema\n\nfix typo\n\nfix bug\n\nUpdate be/src/olap/delete_handler.cpp\n\nCo-authored-by: Mingyu Chen <morningman.cmy@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca39f68ed72666123e688c0594127e212895bbfa", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/ca39f68ed72666123e688c0594127e212895bbfa", "committedDate": "2020-05-08T11:41:11Z", "message": "revert config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e23d744573845c7300c1311467c659206f0b31b", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/6e23d744573845c7300c1311467c659206f0b31b", "committedDate": "2020-05-08T12:06:59Z", "message": "revert config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "060be5c4363048c37b4dd6be733d81f7700a14e8", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/060be5c4363048c37b4dd6be733d81f7700a14e8", "committedDate": "2020-05-09T02:27:39Z", "message": "disable float"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5de3b9f34af5749656205267a449bcf422df7f2", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/b5de3b9f34af5749656205267a449bcf422df7f2", "committedDate": "2020-05-09T03:46:22Z", "message": "disable float"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjEwNDg4", "url": "https://github.com/apache/incubator-doris/pull/3424#pullrequestreview-408610488", "createdAt": "2020-05-09T04:13:42Z", "commit": {"oid": "b5de3b9f34af5749656205267a449bcf422df7f2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNDoxMzo0MlrOGS4WTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNDozMzoyOFrOGS4auA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MDc2NA==", "bodyText": "just check column.agg_type = AGG_NONE\uff1f", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r422450764", "createdAt": "2020-05-09T04:13:42Z", "author": {"login": "kangpinghuang"}, "path": "be/src/olap/delete_handler.cpp", "diffHunk": "@@ -105,10 +105,10 @@ OLAPStatus DeleteConditionHandler::check_condition_valid(\n     // \u68c0\u67e5\u6307\u5b9a\u7684\u5217\u662f\u4e0d\u662fkey\uff0c\u662f\u4e0d\u662ffloat\u6216doulbe\u7c7b\u578b\n     const TabletColumn& column = schema.column(field_index);\n \n-    if (!column.is_key()\n+    if ((!column.is_key() && schema.keys_type() != KeysType::DUP_KEYS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5de3b9f34af5749656205267a449bcf422df7f2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MDc4NQ==", "bodyText": "I think check agg type is more clear?", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r422450785", "createdAt": "2020-05-09T04:14:10Z", "author": {"login": "kangpinghuang"}, "path": "be/src/olap/olap_cond.cpp", "diffHunk": "@@ -637,7 +637,7 @@ bool Conditions::delete_conditions_eval(const RowCursor& row) const {\n     }\n     \n     for (auto& each_cond : _columns) {\n-        if (each_cond.second->is_key() && !each_cond.second->eval(row)) {\n+        if (_cond_column_is_key_or_duplicate(each_cond.second) && !each_cond.second->eval(row)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5de3b9f34af5749656205267a449bcf422df7f2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MDk2Nw==", "bodyText": "I think we should change the num_key_columns name.\nnum_key_columns  will be ambiguous.", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r422450967", "createdAt": "2020-05-09T04:17:15Z", "author": {"login": "kangpinghuang"}, "path": "be/src/olap/rowset/alpha_rowset.cpp", "diffHunk": "@@ -300,7 +300,7 @@ OLAPStatus AlphaRowset::init() {\n \n         if (segment_group_meta.zone_maps_size() != 0) {\n             size_t zone_maps_size = segment_group_meta.zone_maps_size();\n-            size_t num_key_columns = _schema->num_key_columns();\n+            size_t num_key_columns = _schema->keys_type() == KeysType::DUP_KEYS ? _schema->num_columns() : _schema->num_key_columns();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5de3b9f34af5749656205267a449bcf422df7f2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MTY4OQ==", "bodyText": "why to add this condition?", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r422451689", "createdAt": "2020-05-09T04:29:46Z", "author": {"login": "kangpinghuang"}, "path": "be/src/olap/wrapper_field.h", "diffHunk": "@@ -81,7 +81,7 @@ class WrapperField {\n     char* ptr() const { return _field_buf + 1; }\n     size_t size() const { return _rep->size(); }\n     size_t field_size() const { return _rep->field_size(); }\n-    bool is_null() const { return *reinterpret_cast<bool*>(_field_buf); }\n+    bool is_null() const { return _field_buf == nullptr || *reinterpret_cast<bool*>(_field_buf); }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5de3b9f34af5749656205267a449bcf422df7f2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MTg5Ng==", "bodyText": "should add some comment to explain why float and double type delete predicate can not be supported.", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r422451896", "createdAt": "2020-05-09T04:33:28Z", "author": {"login": "kangpinghuang"}, "path": "fe/src/main/java/org/apache/doris/load/DeleteHandler.java", "diffHunk": "@@ -478,9 +479,11 @@ private void checkDeleteV2(OlapTable table, Partition partition, List<Predicate>\n             }\n \n             Column column = nameToColumn.get(columnName);\n-            if (!column.isKey()) {\n+            if (!column.isKey() && table.getKeysType() != KeysType.DUP_KEYS", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5de3b9f34af5749656205267a449bcf422df7f2"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe46dde9008f56703bd1567b4101b6fbe48c0863", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/fe46dde9008f56703bd1567b4101b6fbe48c0863", "committedDate": "2020-05-11T02:13:33Z", "message": "revert change"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ffe6c1f8ee4f9c5db811d0417f7494002e49056", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/1ffe6c1f8ee4f9c5db811d0417f7494002e49056", "committedDate": "2020-05-09T11:03:22Z", "message": "fix some comment"}, "afterCommit": {"oid": "fe46dde9008f56703bd1567b4101b6fbe48c0863", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/fe46dde9008f56703bd1567b4101b6fbe48c0863", "committedDate": "2020-05-11T02:13:33Z", "message": "revert change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8ed40cea68590890f80fe3cdc106e28b4c76d23", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/f8ed40cea68590890f80fe3cdc106e28b4c76d23", "committedDate": "2020-05-11T02:15:15Z", "message": "revert change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa0034f7fb199a2e42942127a3bfad188d4e73d8", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/aa0034f7fb199a2e42942127a3bfad188d4e73d8", "committedDate": "2020-05-11T03:24:51Z", "message": "Merge branch 'master' into delete_value_column"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwODYzNzA3", "url": "https://github.com/apache/incubator-doris/pull/3424#pullrequestreview-410863707", "createdAt": "2020-05-13T12:17:45Z", "commit": {"oid": "aa0034f7fb199a2e42942127a3bfad188d4e73d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwOTEzNTQy", "url": "https://github.com/apache/incubator-doris/pull/3424#pullrequestreview-410913542", "createdAt": "2020-05-13T13:18:01Z", "commit": {"oid": "aa0034f7fb199a2e42942127a3bfad188d4e73d8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMzoxODowMVrOGUxGmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMzoxOTowNFrOGUxJ0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQyOTIxMQ==", "bodyText": "What is about?", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r424429211", "createdAt": "2020-05-13T13:18:01Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "diffHunk": "@@ -549,7 +548,10 @@ private RollupJobV2 createMaterializedViewJob(String mvName, String baseIndexNam\n                     }\n                     keyStorageLayoutBytes += baseColumn.getType().getStorageLayoutBytes();\n                     Column rollupColumn = new Column(baseColumn);\n-                    if ((i + 1) <= FeConstants.shortkey_max_column_count\n+                    if(changeStorageFormat) {\n+                        rollupColumn.setIsKey(baseColumn.isKey());\n+                        rollupColumn.setAggregationType(baseColumn.getAggregationType(), true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa0034f7fb199a2e42942127a3bfad188d4e73d8"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQzMDAzNA==", "bodyText": "All types of column has zone map now?", "url": "https://github.com/apache/incubator-doris/pull/3424#discussion_r424430034", "createdAt": "2020-05-13T13:19:04Z", "author": {"login": "morningman"}, "path": "be/src/olap/rowset/segment_group.cpp", "diffHunk": "@@ -249,13 +249,13 @@ OLAPStatus SegmentGroup::add_zone_maps_for_linked_schema_change(\n         return OLAP_SUCCESS;\n     }\n \n-    // 1. rollup tablet num_key_columns() will less than base tablet zone_map_fields.size().\n+    // 1. rollup tablet get_num_zone_map_columns() will less than base tablet zone_map_fields.size().\n     //    For LinkedSchemaChange, the rollup tablet keys order is the same as base tablet\n-    // 2. adding column to existed table, num_key_columns() will larger than\n+    // 2. adding column to existed table, get_num_zone_map_columns() will larger than\n     //    zone_map_fields.size()\n \n     int num_new_keys = 0;\n-    for (size_t i = 0; i < _schema->num_key_columns(); ++i) {\n+    for (size_t i = 0; i < get_num_zone_map_columns(); ++i) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa0034f7fb199a2e42942127a3bfad188d4e73d8"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNzk4NTg4", "url": "https://github.com/apache/incubator-doris/pull/3424#pullrequestreview-411798588", "createdAt": "2020-05-14T13:23:34Z", "commit": {"oid": "aa0034f7fb199a2e42942127a3bfad188d4e73d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2894, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}