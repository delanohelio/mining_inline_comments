{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0OTM3OTA5", "number": 3881, "title": "[BUG]Fix broker read buffer size from input stream", "bodyText": "Fix #3879\nThis commit fixs a bug that broker cannot read the full length of buffer size, when the buffer size is set larger than 128k.\nThis bug will cause the data size returned by pread request to be less than 128K all the time.", "createdAt": "2020-06-16T02:41:00Z", "url": "https://github.com/apache/incubator-doris/pull/3881", "merged": true, "mergeCommit": {"oid": "1d9fa5071d1bd80582d4148c13e6e8d2d985c9e0"}, "closed": true, "closedAt": "2020-06-19T01:33:10Z", "author": {"login": "xy720"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrru6VgH2gAyNDM0OTM3OTA5OmZjZGFlYjU3ZWQ4ZmU0N2FlOWU1NWYzODFiYzU0YmQ4NWNmZTMyNzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsaJ46gFqTQzMzA1MzkzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fcdaeb57ed8fe47ae9e55f381bc54bd85cfe3279", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/fcdaeb57ed8fe47ae9e55f381bc54bd85cfe3279", "committedDate": "2020-06-16T02:21:59Z", "message": "fix broker read buffer size"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMTMwMDY5", "url": "https://github.com/apache/incubator-doris/pull/3881#pullrequestreview-431130069", "createdAt": "2020-06-16T03:12:13Z", "commit": {"oid": "fcdaeb57ed8fe47ae9e55f381bc54bd85cfe3279"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMzoxMjoxNFrOGkJtCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMzoxMjoxNFrOGkJtCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU2MDkwNw==", "bodyText": "Maybe too many logs here.", "url": "https://github.com/apache/incubator-doris/pull/3881#discussion_r440560907", "createdAt": "2020-06-16T03:12:14Z", "author": {"login": "yiguolei"}, "path": "fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java", "diffHunk": "@@ -550,19 +550,20 @@ public ByteBuffer pread(TBrokerFD fd, long offset, long length) {\n                             currentStreamOffset, offset);\n                 }\n             }\n-            byte[] buf;\n+            ByteBuffer buf;\n             if (length > readBufferSize) {\n-                buf = new byte[readBufferSize];\n+                buf = ByteBuffer.allocate(readBufferSize);\n             } else {\n-                buf = new byte[(int) length];\n+                buf = ByteBuffer.allocate((int) length);\n             }\n             try {\n-                int readLength = fsDataInputStream.read(buf);\n+                int readLength = readByteBufferFully(fsDataInputStream, buf);\n                 if (readLength < 0) {\n                     throw new BrokerException(TBrokerOperationStatusCode.END_OF_FILE,\n                             \"end of file reached\");\n                 }\n-                return ByteBuffer.wrap(buf, 0, readLength);\n+                logger.info(\"read length:\" + length + \", readBufferSize:\" + readBufferSize + \", return length:\" + readLength);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcdaeb57ed8fe47ae9e55f381bc54bd85cfe3279"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMTYxNzAx", "url": "https://github.com/apache/incubator-doris/pull/3881#pullrequestreview-431161701", "createdAt": "2020-06-16T05:04:35Z", "commit": {"oid": "fcdaeb57ed8fe47ae9e55f381bc54bd85cfe3279"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e48e51a21c5c02ba48e13c9a84e6cc7332247a2", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/5e48e51a21c5c02ba48e13c9a84e6cc7332247a2", "committedDate": "2020-06-16T10:00:54Z", "message": "add debug log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNjMwODEz", "url": "https://github.com/apache/incubator-doris/pull/3881#pullrequestreview-431630813", "createdAt": "2020-06-16T15:29:33Z", "commit": {"oid": "5e48e51a21c5c02ba48e13c9a84e6cc7332247a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNToyOTozNFrOGkhCPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNToyOTozNFrOGkhCPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk0MzE2Nw==", "bodyText": "if (logger.isDebugEnable()) {\nlogger.debug(\"read buffer from input stream, buffer size: {}, read length: {}\", buf.capacity(), readLength);\n}", "url": "https://github.com/apache/incubator-doris/pull/3881#discussion_r440943167", "createdAt": "2020-06-16T15:29:34Z", "author": {"login": "morningman"}, "path": "fs_brokers/apache_hdfs_broker/src/main/java/org/apache/doris/broker/hdfs/FileSystemManager.java", "diffHunk": "@@ -550,19 +550,20 @@ public ByteBuffer pread(TBrokerFD fd, long offset, long length) {\n                             currentStreamOffset, offset);\n                 }\n             }\n-            byte[] buf;\n+            ByteBuffer buf;\n             if (length > readBufferSize) {\n-                buf = new byte[readBufferSize];\n+                buf = ByteBuffer.allocate(readBufferSize);\n             } else {\n-                buf = new byte[(int) length];\n+                buf = ByteBuffer.allocate((int) length);\n             }\n             try {\n-                int readLength = fsDataInputStream.read(buf);\n+                int readLength = readByteBufferFully(fsDataInputStream, buf);\n                 if (readLength < 0) {\n                     throw new BrokerException(TBrokerOperationStatusCode.END_OF_FILE,\n                             \"end of file reached\");\n                 }\n-                return ByteBuffer.wrap(buf, 0, readLength);\n+                logger.debug(\"read buffer from input stream, buffer size:\" + buf.capacity() + \", read length:\" + readLength);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e48e51a21c5c02ba48e13c9a84e6cc7332247a2"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "800f6666e64421ddc7689c5959bf129de4609749", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/800f6666e64421ddc7689c5959bf129de4609749", "committedDate": "2020-06-17T02:48:14Z", "message": "fix debug log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e158f31bde522dc3d4b6b7fb7966e285b332c23", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/6e158f31bde522dc3d4b6b7fb7966e285b332c23", "committedDate": "2020-06-18T08:23:19Z", "message": "fix tab"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMDUzOTM4", "url": "https://github.com/apache/incubator-doris/pull/3881#pullrequestreview-433053938", "createdAt": "2020-06-18T08:27:05Z", "commit": {"oid": "6e158f31bde522dc3d4b6b7fb7966e285b332c23"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2573, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}