{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1OTM1MjAy", "number": 2918, "title": "Some refactor on `TabletManager`", "bodyText": "Add some comments to make the code easier to understand;\nMake the metric create_tablet_requests_failed to be accurate;\nSome internal methods use naked pointers directly instead of shared_ptr;\nThe using in .h files are contagious when included by other files,\nso we should only use it in .cpp files;\nSome formatting changes: such as wrapping lines that are too long\nParameters that need to be modified, use pointers instead of references\n\nNo functional changes in this patch.", "createdAt": "2020-02-17T04:39:01Z", "url": "https://github.com/apache/incubator-doris/pull/2918", "merged": true, "mergeCommit": {"oid": "feef077520ba9dc843fa900febd43b8ed03c2b66"}, "closed": true, "closedAt": "2020-02-17T06:50:29Z", "author": {"login": "lingbin"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFFsmwgH2gAyMzc1OTM1MjAyOjcwOGM0NmJhMTIzN2NhZTRkOWY3MDFiYjJiMDZhNDQ2YzlhMDI4Mzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFHhTggFqTM1OTUxMzg1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "708c46ba1237cae4d9f701bb2b06a446c9a02839", "author": {"user": {"login": "lingbin", "name": "LingBin"}}, "url": "https://github.com/apache/incubator-doris/commit/708c46ba1237cae4d9f701bb2b06a446c9a02839", "committedDate": "2020-02-17T04:33:57Z", "message": "Some refactor on TabletManager\n\n1. Add some comments to make the code easier to understand;\n2. Make the metric `create_tablet_requests_failed` to be accurate;\n3. Some internal methods use naked pointers directly instead of `shared_ptr`;\n4. Using in `.h` files is contagious when included by other file,\n   so we should only use it in `.cpp` files;\n5. Some formatting changes: such as wrapping lines that are too long\n6. Parameters that need to be modified, use pointers instead of references\n\nNo functional changes in this patch."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NTAyMjQw", "url": "https://github.com/apache/incubator-doris/pull/2918#pullrequestreview-359502240", "createdAt": "2020-02-17T05:58:29Z", "commit": {"oid": "708c46ba1237cae4d9f701bb2b06a446c9a02839"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwNTo1ODoyOVrOFqZK0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwNTo1ODoyOVrOFqZK0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk5Njg4MA==", "bodyText": "existed_tablet", "url": "https://github.com/apache/incubator-doris/pull/2918#discussion_r379996880", "createdAt": "2020-02-17T05:58:29Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/tablet_manager.cpp", "diffHunk": "@@ -83,42 +72,42 @@ OLAPStatus TabletManager::_add_tablet_unlocked(TTabletId tablet_id, SchemaHash s\n     VLOG(3) << \"begin to add tablet to TabletManager. \" << \"tablet_id=\" << tablet_id\n             << \", schema_hash=\" << schema_hash << \", force=\" << force;\n \n-    TabletSharedPtr tablet_item = nullptr;\n+    TabletSharedPtr exist_tablet = nullptr;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "708c46ba1237cae4d9f701bb2b06a446c9a02839"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NTA5MjEz", "url": "https://github.com/apache/incubator-doris/pull/2918#pullrequestreview-359509213", "createdAt": "2020-02-17T06:24:41Z", "commit": {"oid": "708c46ba1237cae4d9f701bb2b06a446c9a02839"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwNjoyNDo0MVrOFqZgDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwNjoyNDo0MVrOFqZgDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAwMjMxOA==", "bodyText": "use SCOPED_CLEANUP instead", "url": "https://github.com/apache/incubator-doris/pull/2918#discussion_r380002318", "createdAt": "2020-02-17T06:24:41Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/tablet_manager.cpp", "diffHunk": "@@ -212,120 +191,133 @@ bool TabletManager::_check_tablet_id_exist_unlocked(TTabletId tablet_id) {\n     return it != _tablet_map.end() && !it->second.table_arr.empty();\n }\n \n-void TabletManager::clear() {\n-    _tablet_map.clear();\n-    _shutdown_tablets.clear();\n-}\n-\n OLAPStatus TabletManager::create_tablet(const TCreateTabletReq& request,\n                                         std::vector<DataDir*> stores) {\n-    LOG(INFO) << \"begin to process create tablet. tablet=\" << request.tablet_id\n-              << \", schema_hash=\" << request.tablet_schema.schema_hash;\n-    WriteLock wrlock(&_tablet_map_lock);\n-    OLAPStatus res = OLAP_SUCCESS;\n     DorisMetrics::create_tablet_requests_total.increment(1);\n-    // Make sure create_tablet operation is idempotent:\n-    // return true if tablet with same tablet_id and schema_hash exist,\n-    //        false if tablet with same tablet_id but different schema_hash exist\n-    // during alter, if the tablet(same tabletid and schema hash) already exist\n-    // then just return true, if tablet id with different schema hash exist, wait report\n-    // task to delete the tablet\n-    if (_check_tablet_id_exist_unlocked(request.tablet_id)) {\n-        TabletSharedPtr tablet = _get_tablet_unlocked(\n-                request.tablet_id, request.tablet_schema.schema_hash);\n+\n+    int64_t tablet_id = request.tablet_id;\n+    int32_t schema_hash = request.tablet_schema.schema_hash;\n+    LOG(INFO) << \"begin to create tablet. tablet_id=\" << tablet_id\n+              << \", schema_hash=\" << schema_hash;\n+\n+    WriteLock wrlock(&_tablet_map_lock);\n+    // Make create_tablet operation to be idempotent:\n+    // 1. Return true if tablet with same tablet_id and schema_hash exist;\n+    //           false if tablet with same tablet_id but different schema_hash exist.\n+    // 2. When this is an alter task, if the tablet(both tablet_id and schema_hash are\n+    // same) already exist, then just return true(an duplicate request). But if\n+    // tablet_id exist but with different schema_hash, return an error(report task will\n+    // eventually trigger its deletion).\n+    if (_check_tablet_id_exist_unlocked(tablet_id)) {\n+        TabletSharedPtr tablet = _get_tablet_unlocked(tablet_id, schema_hash);\n         if (tablet != nullptr) {\n-            LOG(INFO) << \"create tablet success because tablet already exist. tablet_id=\"\n-                    << request.tablet_id;\n+            LOG(INFO) << \"success to create tablet. tablet already exist. tablet_id=\" << tablet_id;\n             return OLAP_SUCCESS;\n         } else {\n-            LOG(WARNING) << \"tablet with different schema hash already exists. tablet_id=\"\n-                    << request.tablet_id;\n+            LOG(WARNING) << \"fail to create tablet. tablet exist but with different schema_hash. \"\n+                    << \"tablet_id=\" << tablet_id << \", schema_hash=\" << schema_hash;\n+            DorisMetrics::create_tablet_requests_failed.increment(1);\n             return OLAP_ERR_CE_TABLET_ID_EXIST;\n         }\n     }\n \n-    TabletSharedPtr ref_tablet = nullptr;\n-    bool is_schema_change_tablet = false;\n-    // if the CreateTabletReq has base_tablet_id then it is a alter tablet request\n+    TabletSharedPtr base_tablet = nullptr;\n+    bool is_schema_change = false;\n+    // If the CreateTabletReq has base_tablet_id then it is a alter-tablet request\n     if (request.__isset.base_tablet_id && request.base_tablet_id > 0) {\n-        is_schema_change_tablet = true;\n-        ref_tablet = _get_tablet_unlocked(request.base_tablet_id, request.base_schema_hash);\n-        if (ref_tablet == nullptr) {\n-            LOG(WARNING) << \"fail to create new tablet. new_tablet_id=\" << request.tablet_id\n-                         << \", new_schema_hash=\" << request.tablet_schema.schema_hash\n-                         << \", because could not find base tablet, base_tablet_id=\" << request.base_tablet_id\n+        is_schema_change = true;\n+        base_tablet = _get_tablet_unlocked(request.base_tablet_id, request.base_schema_hash);\n+        if (base_tablet == nullptr) {\n+            LOG(WARNING) << \"fail to create tablet(change schema), base tablet does not exist. \"\n+                         << \"new_tablet_id=\" << tablet_id << \", new_schema_hash=\" << schema_hash\n+                         << \", base_tablet_id=\" << request.base_tablet_id\n                          << \", base_schema_hash=\" << request.base_schema_hash;\n+            DorisMetrics::create_tablet_requests_failed.increment(1);\n             return OLAP_ERR_TABLE_CREATE_META_ERROR;\n         }\n-        // schema change should use the same data dir\n+        // If we are doing schema-change, we should use the same data dir\n+        // TODO(lingbin): A litter trick here, the directory should be determined before\n+        // entering this method\n         stores.clear();\n-        stores.push_back(ref_tablet->data_dir());\n+        stores.push_back(base_tablet->data_dir());\n     }\n \n-    // set alter type to schema change. it is useless\n-    TabletSharedPtr tablet = _internal_create_tablet_unlocked(AlterTabletType::SCHEMA_CHANGE, request,\n-        is_schema_change_tablet, ref_tablet, stores);\n+    // set alter type to schema-change. it is useless\n+    TabletSharedPtr tablet = _internal_create_tablet_unlocked(\n+            AlterTabletType::SCHEMA_CHANGE, request, is_schema_change, base_tablet.get(), stores);\n     if (tablet == nullptr) {\n-        res = OLAP_ERR_CE_CMD_PARAMS_ERROR;\n-        LOG(WARNING) << \"fail to create tablet. res=\" << res;\n+        LOG(WARNING) << \"fail to create tablet. tablet_id=\" << request.tablet_id;\n+        DorisMetrics::create_tablet_requests_failed.increment(1);\n+        return OLAP_ERR_CE_CMD_PARAMS_ERROR;\n     }\n \n-    LOG(INFO) << \"finish to process create tablet. res=\" << res;\n-    return res;\n-} // create_tablet\n+    LOG(INFO) << \"success to create tablet. tablet_id=\" << tablet_id\n+              << \", schema_hash=\" << schema_hash;\n+    return OLAP_SUCCESS;\n+}\n \n TabletSharedPtr TabletManager::_internal_create_tablet_unlocked(\n         const AlterTabletType alter_type, const TCreateTabletReq& request,\n-        const bool is_schema_change_tablet, const TabletSharedPtr ref_tablet,\n-        std::vector<DataDir*> data_dirs) {\n-    DCHECK((is_schema_change_tablet && ref_tablet != nullptr)\n-            || (!is_schema_change_tablet && ref_tablet == nullptr));\n-    // check if the tablet with specified tablet id and schema hash already exists\n-    auto checked_tablet = _get_tablet_unlocked(request.tablet_id, request.tablet_schema.schema_hash);\n-    if (checked_tablet != nullptr) {\n-        LOG(WARNING) << \"failed to create tablet because tablet already exist.\"\n-                     << \" tablet id = \" << request.tablet_id\n-                     << \" schema hash = \" << request.tablet_schema.schema_hash;\n-        return nullptr;\n-    }\n-    bool is_tablet_added = false;\n-    auto tablet = _create_tablet_meta_and_dir_unlocked(request, is_schema_change_tablet, ref_tablet, data_dirs);\n+        const bool is_schema_change, const Tablet* base_tablet,\n+        const std::vector<DataDir*>& data_dirs) {\n+    // If in schema-change state, base_tablet must also be provided.\n+    // i.e., is_schema_change and base_tablet are either assigned or not assigned\n+    DCHECK((is_schema_change && base_tablet) || (!is_schema_change && !base_tablet));\n+\n+    // NOTE: The existence of tablet_id and schema_hash has already been checked,\n+    // no need check again here.\n+\n+    auto tablet = _create_tablet_meta_and_dir_unlocked(request, is_schema_change,\n+                                                       base_tablet, data_dirs);\n     if (tablet == nullptr) {\n         return nullptr;\n     }\n \n+    int64_t new_tablet_id = request.tablet_id;\n+    int32_t new_schema_hash = request.tablet_schema.schema_hash;\n+\n+    // should remove the tablet's pending_id no matter create-tablet success or not\n+    DataDir* data_dir = tablet->data_dir();\n+    std::shared_ptr<void> __defer(nullptr, [&](...) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "708c46ba1237cae4d9f701bb2b06a446c9a02839"}, "originalPosition": 355}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4db01eb15d897ca6bb8364dc182e01c7e86ff4c5", "author": {"user": {"login": "lingbin", "name": "LingBin"}}, "url": "https://github.com/apache/incubator-doris/commit/4db01eb15d897ca6bb8364dc182e01c7e86ff4c5", "committedDate": "2020-02-17T06:36:33Z", "message": "Improve variable naming"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NTEzODUz", "url": "https://github.com/apache/incubator-doris/pull/2918#pullrequestreview-359513853", "createdAt": "2020-02-17T06:41:25Z", "commit": {"oid": "4db01eb15d897ca6bb8364dc182e01c7e86ff4c5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3782, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}