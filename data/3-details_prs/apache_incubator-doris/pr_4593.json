{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1OTE4OTY5", "number": 4593, "title": "[Bug] Fix bug of cumulative compaction and deletion of stale version", "bodyText": "Proposed changes\nWhen selecting candicate rowsets to do the cumulative compaction,\nsome rowsets may not be selected because the protection time has not expired.\nTherefore, we need to find the current longest continuous version path in the candicate rowsets.\nTypes of changes\n\n Bugfix (non-breaking change which fixes an issue)\n\nChecklist\n\n I have create an issue on (Fix #4551), and have described the bug/feature there in detail\n Compiling and unit tests pass locally with my changes", "createdAt": "2020-09-12T14:21:45Z", "url": "https://github.com/apache/incubator-doris/pull/4593", "merged": true, "mergeCommit": {"oid": "588e5bee4793cc383dc49e73f06f6cde2e286986"}, "closed": true, "closedAt": "2020-10-21T02:03:56Z", "author": {"login": "morningman"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdIKtK0gH2gAyNDg1OTE4OTY5OjFmMDJkMWI0Yzg0MDA3NDM4OWUwNzY2ZjdhZjIzMWM2NjJmZDJkMTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUPPx-AFqTUxMjI4MzgxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1f02d1b4c840074389e0766f7af231c662fd2d16", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/1f02d1b4c840074389e0766f7af231c662fd2d16", "committedDate": "2020-09-12T14:17:01Z", "message": "[Bug] Fix bug of cumulative compaction and deletion of stale version\n\nWhen selecting candicate rowsets to do the cumulative compaction,\nsome rowsets may not be selected because the protection time has not expired.\nTherefore, we need to find the current longest continuous version path in the candicate rowsets."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b66841b330a03a7053e8e90f08d96487773bb8a", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/9b66841b330a03a7053e8e90f08d96487773bb8a", "committedDate": "2020-09-12T15:00:40Z", "message": "add ut"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3OTM2OTkw", "url": "https://github.com/apache/incubator-doris/pull/4593#pullrequestreview-507936990", "createdAt": "2020-10-14T01:40:33Z", "commit": {"oid": "9b66841b330a03a7053e8e90f08d96487773bb8a"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3OTM5MzAx", "url": "https://github.com/apache/incubator-doris/pull/4593#pullrequestreview-507939301", "createdAt": "2020-10-14T01:48:57Z", "commit": {"oid": "9b66841b330a03a7053e8e90f08d96487773bb8a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMTo0ODo1N1rOHg_Qcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMTo0ODo1N1rOHg_Qcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM1Mjg4Mw==", "bodyText": "Is it appropriate to print the warning log here?\nI think this function only deals with specific logic, and the caller can decide whether to print the log. This allows this function to be used in more scenarios.", "url": "https://github.com/apache/incubator-doris/pull/4593#discussion_r504352883", "createdAt": "2020-10-14T01:48:57Z", "author": {"login": "imay"}, "path": "be/src/olap/compaction.cpp", "diffHunk": "@@ -181,6 +181,30 @@ OLAPStatus Compaction::gc_unused_rowsets() {\n     return OLAP_SUCCESS;\n }\n \n+// find the longest consecutive version path in \"rowset\", from begining.\n+OLAPStatus Compaction::find_longest_consecutive_version(vector<RowsetSharedPtr>* rowsets) {\n+    if (rowsets->empty()) {\n+        return OLAP_SUCCESS;\n+    }\n+    RowsetSharedPtr prev_rowset = rowsets->front();\n+    size_t i = 1;\n+    for (; i < rowsets->size(); ++i) {\n+        RowsetSharedPtr rowset = (*rowsets)[i];\n+        if (rowset->start_version() != prev_rowset->end_version() + 1) {\n+            LOG(WARNING) << \"There are missed versions among rowsets. \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b66841b330a03a7053e8e90f08d96487773bb8a"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5470d315a0b73f92b14eaa4942cd931f604e8b8a", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/5470d315a0b73f92b14eaa4942cd931f604e8b8a", "committedDate": "2020-10-16T14:27:44Z", "message": "modify log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODcwMDU2", "url": "https://github.com/apache/incubator-doris/pull/4593#pullrequestreview-510870056", "createdAt": "2020-10-17T03:25:15Z", "commit": {"oid": "5470d315a0b73f92b14eaa4942cd931f604e8b8a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QwMzoyNToxNVrOHjT4Gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QwMzoyNToxNVrOHjT4Gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc4Nzg2Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (missing_versions.empty()) {\n          \n          \n            \n                if (!missing_versions.empty()) {", "url": "https://github.com/apache/incubator-doris/pull/4593#discussion_r506787867", "createdAt": "2020-10-17T03:25:15Z", "author": {"login": "imay"}, "path": "be/src/olap/cumulative_compaction.cpp", "diffHunk": "@@ -83,7 +83,18 @@ OLAPStatus CumulativeCompaction::pick_rowsets_to_compact() {\n         return OLAP_ERR_CUMULATIVE_NO_SUITABLE_VERSIONS;\n     }\n \n-    RETURN_NOT_OK(check_version_continuity(candidate_rowsets));\n+    // candidate_rowsets may not be continuous. Because some rowset may not be selected\n+    // because the protection time has not expired(config::cumulative_compaction_skip_window_seconds).\n+    // So we need to choose the longest continuous path from it.\n+    std::vector<Version> missing_versions;\n+    RETURN_NOT_OK(find_longest_consecutive_version(&candidate_rowsets, &missing_versions));\n+    if (missing_versions.empty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5470d315a0b73f92b14eaa4942cd931f604e8b8a"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "019f047709f8cf8f584ef2bea2df08179d16bbc1", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/019f047709f8cf8f584ef2bea2df08179d16bbc1", "committedDate": "2020-10-20T01:42:51Z", "message": "Update be/src/olap/cumulative_compaction.cpp\n\nCo-authored-by: Zhao Chun <buaa.zhaoc@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMjc0NzI4", "url": "https://github.com/apache/incubator-doris/pull/4593#pullrequestreview-512274728", "createdAt": "2020-10-20T01:52:13Z", "commit": {"oid": "019f047709f8cf8f584ef2bea2df08179d16bbc1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMjgzODE5", "url": "https://github.com/apache/incubator-doris/pull/4593#pullrequestreview-512283819", "createdAt": "2020-10-20T02:21:32Z", "commit": {"oid": "019f047709f8cf8f584ef2bea2df08179d16bbc1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4981, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}