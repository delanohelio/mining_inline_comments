{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNzc4MjIx", "number": 3293, "title": "[Transaction]Cancel all txns whose coordinate be is down.", "bodyText": "This CL solve problem:\n\nFE cann't aware Coordinate BE down and cancel the txns because the\ntxns cann't finish.\nDo some codestyle refactor", "createdAt": "2020-04-10T06:32:52Z", "url": "https://github.com/apache/incubator-doris/pull/3293", "merged": true, "mergeCommit": {"oid": "9331574818e3b4e7853019425cb4be409b69cab2"}, "closed": true, "closedAt": "2020-04-17T03:24:04Z", "author": {"login": "WingsGo"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWMR-xgFqTM5MTMwODYzMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYYoX0gFqTM5NTEzNjA3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzA4NjMz", "url": "https://github.com/apache/incubator-doris/pull/3293#pullrequestreview-391308633", "createdAt": "2020-04-10T07:34:45Z", "commit": {"oid": "ae8793c5a87a96ffc44d7354a8d30dc3dd9076de"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNzozNDo0NVrOGDzb4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNzo1MDo0OFrOGDzxSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY0MTYzMg==", "bodyText": "Could  rename aLong and value  to src and target", "url": "https://github.com/apache/incubator-doris/pull/3293#discussion_r406641632", "createdAt": "2020-04-10T07:34:45Z", "author": {"login": "kangkaisen"}, "path": "fe/src/main/java/org/apache/doris/transaction/GlobalTransactionMgr.java", "diffHunk": "@@ -818,24 +817,26 @@ public boolean isPreviousTransactionsFinished(long endTransactionId, long dbId,\n         return true;\n     }\n \n-    // check if there exists a intersection between the source tableId list and target tableId list\n-    // if one of them is null or empty, that means that we don't know related tables in tableList,\n-    // we think the two lists may have intersection for right ordered txns\n+    /**\n+     * check if there exists a intersection between the source tableId list and target tableId list\n+     * if one of them is null or empty, that means that we don't know related tables in tableList,\n+     * we think the two lists may have intersection for right ordered txns\n+     */\n     public boolean isIntersectionNotEmpty(List<Long> sourceTableIdList, List<Long> targetTableIdList) {\n         if (CollectionUtils.isEmpty(sourceTableIdList) || CollectionUtils.isEmpty(targetTableIdList)) {\n             return true;\n         }\n-        for (int i = 0; i < sourceTableIdList.size(); i++) {\n-            for (int j = 0; j < targetTableIdList.size(); j++) {\n-                if (sourceTableIdList.get(i).equals(targetTableIdList.get(j))) {\n+        for (Long aLong : sourceTableIdList) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae8793c5a87a96ffc44d7354a8d30dc3dd9076de"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY0NzExMg==", "bodyText": "Would better rename coordinate to coordinateHost", "url": "https://github.com/apache/incubator-doris/pull/3293#discussion_r406647112", "createdAt": "2020-04-10T07:50:48Z", "author": {"login": "kangkaisen"}, "path": "fe/src/main/java/org/apache/doris/transaction/GlobalTransactionMgr.java", "diffHunk": "@@ -1389,4 +1389,33 @@ public TransactionState getTransactionStateByCallbackId(long callbackId) {\n         }\n         return null;\n     }\n+\n+    public List<Long> getTransactionIdByCoordinateBe(String coordinate, int limit) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae8793c5a87a96ffc44d7354a8d30dc3dd9076de"}, "originalPosition": 178}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzg1MjQ1", "url": "https://github.com/apache/incubator-doris/pull/3293#pullrequestreview-391385245", "createdAt": "2020-04-10T10:53:47Z", "commit": {"oid": "0097dc06677be4c957be0208903a079875d12bbd"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzYyOTY0", "url": "https://github.com/apache/incubator-doris/pull/3293#pullrequestreview-391762964", "createdAt": "2020-04-11T12:37:00Z", "commit": {"oid": "0097dc06677be4c957be0208903a079875d12bbd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMjozNzowMFrOGEM6aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMjo1MDowNFrOGEM_lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA1OTA1MQ==", "bodyText": "Why removing the preStatus != null check?", "url": "https://github.com/apache/incubator-doris/pull/3293#discussion_r407059051", "createdAt": "2020-04-11T12:37:00Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/transaction/GlobalTransactionMgr.java", "diffHunk": "@@ -1148,8 +1149,7 @@ private void updateDBRunningTxnNum(TransactionStatus preStatus, TransactionState\n                 && (curTxnState.getTransactionStatus() == TransactionStatus.PREPARE\n                 || curTxnState.getTransactionStatus() == TransactionStatus.COMMITTED)) {\n             ++txnNum;\n-        } else if (preStatus != null\n-                && (preStatus == TransactionStatus.PREPARE\n+        } else if ((preStatus == TransactionStatus.PREPARE", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0097dc06677be4c957be0208903a079875d12bbd"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA2MDM3Mg==", "bodyText": "In some clusters, FE and BE are deployed together.\nSo only by checking t.getCoordinator().contains(coordinateHost) will also abort those transactions\nwhich the coordinator is FE, not the BE, which is not expected.\nThe current value of the coordinator is an informal value, it is just for displaying the job information. If we want to use this coordinator field to do some logic control, we should make it formal, for example, by creating a new class \"TxnCoordinator\" to save the coordinator info.\nCurrently, the coordinator is either \"FE: 192.168.0.1\" or \"BE: 192.168.0.1\". So the new class \"TxnCoordinator\" may looks like:\nclass TxnCoordinator {\n    private String source;   // \"FE\" or \"BE\"\n    private String ip;    // the ip\n}\n\nAnd in getTransactionIdByCoordinateBe, we should get all transactions with the specified IP and source is BE.", "url": "https://github.com/apache/incubator-doris/pull/3293#discussion_r407060372", "createdAt": "2020-04-11T12:50:04Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/transaction/GlobalTransactionMgr.java", "diffHunk": "@@ -1389,4 +1389,33 @@ public TransactionState getTransactionStateByCallbackId(long callbackId) {\n         }\n         return null;\n     }\n+\n+    public List<Long> getTransactionIdByCoordinateBe(String coordinateHost, int limit) {\n+        ArrayList<Long> txnIds = new ArrayList<>();\n+        readLock();\n+        try {\n+            idToTransactionState.values().stream()\n+                    .filter(t -> (t.getCoordinator().contains(coordinateHost) && (!t.getTransactionStatus().isFinalStatus())))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0097dc06677be4c957be0208903a079875d12bbd"}, "originalPosition": 183}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4522d4a2ff50cb8e24b34b67789df4e35e8a1dfc", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/4522d4a2ff50cb8e24b34b67789df4e35e8a1dfc", "committedDate": "2020-04-15T01:37:27Z", "message": "[Transaction]Cancel all txns whose coordinate be is down.\n\nThis CL solve problem:\n- FE cann't aware Coordinate BE down and cancel the txns because the\ntxns cann't finish.\n- Do some codestyle refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60581683270605d13d719597dcf0185fcbc140cf", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/60581683270605d13d719597dcf0185fcbc140cf", "committedDate": "2020-04-15T01:37:27Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f56f9ef74d594f80b80a794379571eb7d603294", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/2f56f9ef74d594f80b80a794379571eb7d603294", "committedDate": "2020-04-15T01:39:18Z", "message": "Refacor Coordinator && replace Timer with SchedulerExecutorService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "af501ec13a70c5523d3b046c2265899b88634141", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/af501ec13a70c5523d3b046c2265899b88634141", "committedDate": "2020-04-15T01:42:14Z", "message": "fix conflict"}, "afterCommit": {"oid": "2f56f9ef74d594f80b80a794379571eb7d603294", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/2f56f9ef74d594f80b80a794379571eb7d603294", "committedDate": "2020-04-15T01:39:18Z", "message": "Refacor Coordinator && replace Timer with SchedulerExecutorService"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzODMwMjAy", "url": "https://github.com/apache/incubator-doris/pull/3293#pullrequestreview-393830202", "createdAt": "2020-04-15T14:29:10Z", "commit": {"oid": "2f56f9ef74d594f80b80a794379571eb7d603294"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNDoyOToxMVrOGF8dNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNDoyOToxMVrOGF8dNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg4NjU4Mg==", "bodyText": "Why here is a limit 100?", "url": "https://github.com/apache/incubator-doris/pull/3293#discussion_r408886582", "createdAt": "2020-04-15T14:29:11Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/system/HeartbeatMgr.java", "diffHunk": "@@ -176,6 +176,7 @@ private boolean handleHbResponse(HeartbeatResponse response, boolean isReplay) {\n                     if (hbResponse.getStatus() != HbStatus.OK) {\n                         // invalid all connections cached in ClientPool\n                         ClientPool.backendPool.clearPool(new TNetworkAddress(be.getHost(), be.getBePort()));\n+                        Catalog.getCurrentCatalog().getGlobalTransactionMgr().abortTxnWhenCoordinateBeDown(be.getHost(), 100);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f56f9ef74d594f80b80a794379571eb7d603294"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0fac54068c8f17e7328d982a01abe852c2d6834", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/b0fac54068c8f17e7328d982a01abe852c2d6834", "committedDate": "2020-04-16T03:19:03Z", "message": "Merge branch 'master' into cancel_txn_coordinate_be"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dee6f7ef9dcad72bb88c9e0de606d48584ccf57", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/8dee6f7ef9dcad72bb88c9e0de606d48584ccf57", "committedDate": "2020-04-16T03:22:51Z", "message": "fix review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NzUwNzI3", "url": "https://github.com/apache/incubator-doris/pull/3293#pullrequestreview-394750727", "createdAt": "2020-04-16T15:29:28Z", "commit": {"oid": "8dee6f7ef9dcad72bb88c9e0de606d48584ccf57"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NzUyODU4", "url": "https://github.com/apache/incubator-doris/pull/3293#pullrequestreview-394752858", "createdAt": "2020-04-16T15:31:41Z", "commit": {"oid": "8dee6f7ef9dcad72bb88c9e0de606d48584ccf57"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfacf09992875d681b57bc2c8b5b87ce87110390", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/bfacf09992875d681b57bc2c8b5b87ce87110390", "committedDate": "2020-04-16T15:43:34Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MTM2MDcz", "url": "https://github.com/apache/incubator-doris/pull/3293#pullrequestreview-395136073", "createdAt": "2020-04-17T03:22:05Z", "commit": {"oid": "bfacf09992875d681b57bc2c8b5b87ce87110390"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3206, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}