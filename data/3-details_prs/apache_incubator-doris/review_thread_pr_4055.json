{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NTk0ODg4", "number": 4055, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowMTo1MVrOEMwKww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowOToyMVrOEMwRBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxODA3NTU1OnYy", "diffSide": "RIGHT", "path": "be/src/exec/es/es_scroll_query.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowMTo1MVrOGvCyiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowMjo1NlrOGvC0BA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MTk2MQ==", "bodyText": "pure_docvalue = properties[ESScanReader::KEY_DOC_VALUE_MODE] == \"1\" ? true: false;\n\u770b\u5230\u5bf9bool\u53d8\u91cf\u8d4b\u503c\uff0c\u8fd9\u6837\u5b50\u4f1a\u4e0d\u4f1a\u66f4\u76f4\u89c2\u4e9b\uff1f\u800c\u4e0d\u7528\u8003\u8651atoi\u8fd4\u56de\u503c\u6210\u529f\u8fd8\u662f\u5931\u8d25\u7684\u60c5\u51b5\u4e0b\uff0cdocvalue\u662ftrue\u8fd8\u662ffalse\u3002", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451981961", "createdAt": "2020-07-09T06:01:51Z", "author": {"login": "blackfox1983"}, "path": "be/src/exec/es/es_scroll_query.cpp", "diffHunk": "@@ -76,14 +76,20 @@ std::string ESScrollQueryBuilder::build(const std::map<std::string, std::string>\n     // note: add `query` for this value....\n     es_query_dsl.AddMember(\"query\", query_node, allocator);\n     bool pure_docvalue = true;\n-    // check docvalue sacan optimization\n-    if (docvalue_context.size() == 0 || docvalue_context.size() < fields.size()) {\n-        pure_docvalue = false;\n+\n+    // Doris FE already has checked docvalue-scan optimization\n+    if (properties.find(ESScanReader::KEY_DOC_VALUE_MODE) != properties.end()) {\n+        pure_docvalue = atoi(properties.at(ESScanReader::KEY_DOC_VALUE_MODE).c_str());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MjM0MA==", "bodyText": "\u4e2a\u4eba\u611f\u89c9\u8fd9\u79cd\u503c\u7684\u8bbe\u5b9a\u662f\u7531FE\u5b8c\u5168\u63a7\u5236\u7684\uff0c\u5012\u8fd8\u597d", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451982340", "createdAt": "2020-07-09T06:02:56Z", "author": {"login": "wuyunfeng"}, "path": "be/src/exec/es/es_scroll_query.cpp", "diffHunk": "@@ -76,14 +76,20 @@ std::string ESScrollQueryBuilder::build(const std::map<std::string, std::string>\n     // note: add `query` for this value....\n     es_query_dsl.AddMember(\"query\", query_node, allocator);\n     bool pure_docvalue = true;\n-    // check docvalue sacan optimization\n-    if (docvalue_context.size() == 0 || docvalue_context.size() < fields.size()) {\n-        pure_docvalue = false;\n+\n+    // Doris FE already has checked docvalue-scan optimization\n+    if (properties.find(ESScanReader::KEY_DOC_VALUE_MODE) != properties.end()) {\n+        pure_docvalue = atoi(properties.at(ESScanReader::KEY_DOC_VALUE_MODE).c_str());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MTk2MQ=="}, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxODA4NDM0OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowNTo1OFrOGvC3pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowNzo0MVrOGvC52A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MzI3MA==", "bodyText": "why set 30, not set DEFAULT_MAX_DOCVALUE_FIELDS.", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451983270", "createdAt": "2020-07-09T06:05:58Z", "author": {"login": "wutiangan"}, "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "diffHunk": "@@ -294,6 +331,13 @@ public void readFields(DataInput in) throws IOException {\n             } else {\n                 enableKeywordSniff = true;\n             }\n+            if (tableContext.containsKey(\"maxDocValueFields\")) {\n+                try {\n+                    maxDocValueFields = Integer.parseInt(tableContext.get(\"maxDocValueFields\"));\n+                } catch (Exception e) {\n+                    maxDocValueFields = 30;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MzgzMg==", "bodyText": "Oh\uff0cI forget this...", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451983832", "createdAt": "2020-07-09T06:07:41Z", "author": {"login": "wuyunfeng"}, "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "diffHunk": "@@ -294,6 +331,13 @@ public void readFields(DataInput in) throws IOException {\n             } else {\n                 enableKeywordSniff = true;\n             }\n+            if (tableContext.containsKey(\"maxDocValueFields\")) {\n+                try {\n+                    maxDocValueFields = Integer.parseInt(tableContext.get(\"maxDocValueFields\"));\n+                } catch (Exception e) {\n+                    maxDocValueFields = 30;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MzI3MA=="}, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 108}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxODA4NjAyOnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowNjozNFrOGvC4lA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjoyODo0M1rOGvDXaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MzUwOA==", "bodyText": "\u662f\u4e0d\u662f\u76f4\u63a5\u62a5\u9519\u5f97\u4e86\uff1f\u6211\u4eec\u4e0d\u5141\u8bb8\u8fd9\u7c7b\u4f4e\u7ea7\u9519\u8bef\u3002\u6bd4\u5982\u8bbe\u7f6e\u4e3a0\u6216\u8005-1. \u53ef\u80fd\u7528\u6237\u60f3\u5173\u95eddocvalue\u67e5\u8be2\uff1f", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451983508", "createdAt": "2020-07-09T06:06:34Z", "author": {"login": "blackfox1983"}, "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "diffHunk": "@@ -194,6 +219,17 @@ private void validate(Map<String, String> properties) throws DdlException {\n                         + \" but value is \" + transport);\n             }\n         }\n+\n+        if (properties.containsKey(MAX_DOCVALUE_FIELDS)) {\n+            try {\n+                maxDocValueFields = Integer.parseInt(properties.get(MAX_DOCVALUE_FIELDS).trim());\n+                if (maxDocValueFields < 1) {\n+                    maxDocValueFields = 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk5MTQwMA==", "bodyText": "\u53ef\u4ee5\u8bbe\u7f6e\u4e3a0\uff0c\u4e0d\u8fc7\u63a7\u5236\u5f00\u5173\u7684\u8bdd\u8fd8\u662f\u7528\u4e0a\u9762\u90a3\u4e2a\uff1f", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451991400", "createdAt": "2020-07-09T06:28:43Z", "author": {"login": "wuyunfeng"}, "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "diffHunk": "@@ -194,6 +219,17 @@ private void validate(Map<String, String> properties) throws DdlException {\n                         + \" but value is \" + transport);\n             }\n         }\n+\n+        if (properties.containsKey(MAX_DOCVALUE_FIELDS)) {\n+            try {\n+                maxDocValueFields = Integer.parseInt(properties.get(MAX_DOCVALUE_FIELDS).trim());\n+                if (maxDocValueFields < 1) {\n+                    maxDocValueFields = 1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MzUwOA=="}, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxODA4Njk5OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowNzowMVrOGvC5HA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowNzowMVrOGvC5HA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4MzY0NA==", "bodyText": "if the tableContext don't contain \"maxDocValueFields\", the maxDocValueFields should set Default_max_docvaues_fields or set MaxInt.", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451983644", "createdAt": "2020-07-09T06:07:01Z", "author": {"login": "wutiangan"}, "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "diffHunk": "@@ -294,6 +331,13 @@ public void readFields(DataInput in) throws IOException {\n             } else {\n                 enableKeywordSniff = true;\n             }\n+            if (tableContext.containsKey(\"maxDocValueFields\")) {\n+                try {\n+                    maxDocValueFields = Integer.parseInt(tableContext.get(\"maxDocValueFields\"));\n+                } catch (Exception e) {\n+                    maxDocValueFields = 30;\n+                }\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 110}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxODA4NzY1OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowNzoyM1rOGvC5hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowODoxMlrOGvC6ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4Mzc0OQ==", "bodyText": "\u8fd9\u4e2a\u5730\u65b9\u662f\u4e0d\u662f\u53ef\u4ee5\u4f7f\u7528\u5b9a\u4e49\u7684\u503c\uff1fDEFAULT_MAX_DOC_VALUS_FILEDS", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451983749", "createdAt": "2020-07-09T06:07:23Z", "author": {"login": "blackfox1983"}, "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "diffHunk": "@@ -294,6 +331,13 @@ public void readFields(DataInput in) throws IOException {\n             } else {\n                 enableKeywordSniff = true;\n             }\n+            if (tableContext.containsKey(\"maxDocValueFields\")) {\n+                try {\n+                    maxDocValueFields = Integer.parseInt(tableContext.get(\"maxDocValueFields\"));\n+                } catch (Exception e) {\n+                    maxDocValueFields = 30;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4Mzk5NQ==", "bodyText": "\u662f\u7684\uff0c\u6211\u5fd8\u4e86", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451983995", "createdAt": "2020-07-09T06:08:12Z", "author": {"login": "wuyunfeng"}, "path": "fe/src/main/java/org/apache/doris/catalog/EsTable.java", "diffHunk": "@@ -294,6 +331,13 @@ public void readFields(DataInput in) throws IOException {\n             } else {\n                 enableKeywordSniff = true;\n             }\n+            if (tableContext.containsKey(\"maxDocValueFields\")) {\n+                try {\n+                    maxDocValueFields = Integer.parseInt(tableContext.get(\"maxDocValueFields\"));\n+                } catch (Exception e) {\n+                    maxDocValueFields = 30;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4Mzc0OQ=="}, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 108}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxODA5MTI4OnYy", "diffSide": "RIGHT", "path": "be/src/exec/es/es_scan_reader.h", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowOToxNlrOGvC7wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowOToxNlrOGvC7wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4NDMyMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                static constexpr const char* KEY_DOC_VALUE_MODE = \"doc_values_mode\";\n          \n          \n            \n                static constexpr const char* KEY_DOC_VALUES_MODE = \"doc_values_mode\";", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451984322", "createdAt": "2020-07-09T06:09:16Z", "author": {"login": "wutiangan"}, "path": "be/src/exec/es/es_scan_reader.h", "diffHunk": "@@ -40,6 +40,7 @@ class ESScanReader {\n     static constexpr const char* KEY_QUERY = \"query\";\n     static constexpr const char* KEY_BATCH_SIZE = \"batch_size\";\n     static constexpr const char* KEY_TERMINATE_AFTER = \"limit\";\n+    static constexpr const char* KEY_DOC_VALUE_MODE = \"doc_values_mode\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxODA5MTU4OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/planner/EsScanNode.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjowOToyMVrOGvC76w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjoxMDoxOVrOGvC9LA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4NDM2Mw==", "bodyText": "\u6211\u4e0d\u592a\u786e\u5b9a fe\u901a\u8fc7thrift\u4f20\u9012\u7ed9be\u7684\u53c2\u6570\u662f\u5426\u652f\u6301bool\u3002\u8fd9\u4e2a\u5730\u65b9\u8bfb\u8d77\u6765bool\u66f4\u76f4\u89c2\u3002\n\u5426\u5219\u6211\u5f97\u5e26\u7740c++\u7684\u601d\u7ef4\u53bb\u7406\u89e3\u3002\uff081\u662ftrue\uff0c0\u662ffalse\uff09", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451984363", "createdAt": "2020-07-09T06:09:21Z", "author": {"login": "blackfox1983"}, "path": "fe/src/main/java/org/apache/doris/planner/EsScanNode.java", "diffHunk": "@@ -109,6 +110,34 @@ public void finalize(Analyzer analyzer) throws UserException {\n         isFinalized = true;\n     }\n \n+    /**\n+     * return whether can use the doc_values scan\n+     * 0 and 1 are returned to facilitate Doris BE processing", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4NDY4NA==", "bodyText": "\u8fd9\u548c\u4f20\u9012\u6ca1\u6709\u5173\u7cfb\uff0c\u56e0\u4e3a\u6709\u4e00\u4e2amap\u7ed3\u6784\u5f53\u65f6\u7559\u7740\u5c31\u662f\u4e3a\u4e86\u5728\u4e0d\u6539thrift\u7ed3\u6784\u7684\u60c5\u51b5\u4e0b\u5bb9\u6613\u6269\u5c55", "url": "https://github.com/apache/incubator-doris/pull/4055#discussion_r451984684", "createdAt": "2020-07-09T06:10:19Z", "author": {"login": "wuyunfeng"}, "path": "fe/src/main/java/org/apache/doris/planner/EsScanNode.java", "diffHunk": "@@ -109,6 +110,34 @@ public void finalize(Analyzer analyzer) throws UserException {\n         isFinalized = true;\n     }\n \n+    /**\n+     * return whether can use the doc_values scan\n+     * 0 and 1 are returned to facilitate Doris BE processing", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4NDM2Mw=="}, "originalCommit": {"oid": "8241ab66adb777cf15e8cf0ab408844ae725a53a"}, "originalPosition": 65}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1396, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}