{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4MDUzNDQz", "number": 3260, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMjoxNTo1OFrODuWgfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzo0ODo1MVrODvcI-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5OTI5ODU1OnYy", "diffSide": "RIGHT", "path": "be/src/olap/storage_engine.cpp", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMjoxNTo1OFrOGAS5Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQwMTo1Mjo1NVrOGAuEfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk2MjY5MQ==", "bodyText": "Try to avoid using exceptions\nShould join all other threads before delete store, otherwise exceptions are prone to occur", "url": "https://github.com/apache/incubator-doris/pull/3260#discussion_r402962691", "createdAt": "2020-04-03T12:15:58Z", "author": {"login": "imay"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -148,16 +148,33 @@ void StorageEngine::load_data_dirs(const std::vector<DataDir*>& data_dirs) {\n \n OLAPStatus StorageEngine::_open() {\n     // init store_map\n+    std::vector<std::pair<DataDir*,std::future<Status>>> tmp_vec;\n     for (auto& path : _options.store_paths) {\n+        LOG(INFO) << \"store_path \" << path.path;\n         DataDir* store = new DataDir(path.path, path.capacity_bytes, path.storage_medium,\n                                      _tablet_manager.get(), _txn_manager.get());\n-        auto st = store->init();\n-        if (!st.ok()) {\n-            LOG(WARNING) << \"Store load failed, path=\" << path.path;\n-            return OLAP_ERR_INVALID_ROOT_PATH;\n+        tmp_vec.emplace_back(std::make_pair(store,std::async([store](){ return store->init();})));\n+    }\n+\n+    try {\n+        for (auto& pair : tmp_vec) {\n+            DataDir* store = pair.first;\n+            auto st = pair.second.get();\n+            if (!st.ok()) {\n+                throw std::runtime_error(\"Store load failed, path=\" + store->path());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6118dbfbe80e7f4883b6c93070f1ee7130fb19fa"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQwNzM0MA==", "bodyText": "Yes, I forgot it's not safe to delete stores in catch block.\nI think using exception in the phase of storage initialization should be no problem. But we should wait all threads finished, so catching exceptions can't make the code clean.\nSo I will modify the code like\nstd::vector<status> sts;\nstd::vector<std::thread> threads;\nfor dir in data dirs:\n    threads.emplace_back([&sts[i],dir](){ sts[i}=dir->init() });\nfor_each(threads, [](t){ t.join();})\nfor st in sts:\n    if(st.ok()) { ... }\n    else { init_error=true; break; }\nif(init_error) { \n    // clean up\n    return error;\n}", "url": "https://github.com/apache/incubator-doris/pull/3260#discussion_r403407340", "createdAt": "2020-04-04T01:47:14Z", "author": {"login": "vagetablechicken"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -148,16 +148,33 @@ void StorageEngine::load_data_dirs(const std::vector<DataDir*>& data_dirs) {\n \n OLAPStatus StorageEngine::_open() {\n     // init store_map\n+    std::vector<std::pair<DataDir*,std::future<Status>>> tmp_vec;\n     for (auto& path : _options.store_paths) {\n+        LOG(INFO) << \"store_path \" << path.path;\n         DataDir* store = new DataDir(path.path, path.capacity_bytes, path.storage_medium,\n                                      _tablet_manager.get(), _txn_manager.get());\n-        auto st = store->init();\n-        if (!st.ok()) {\n-            LOG(WARNING) << \"Store load failed, path=\" << path.path;\n-            return OLAP_ERR_INVALID_ROOT_PATH;\n+        tmp_vec.emplace_back(std::make_pair(store,std::async([store](){ return store->init();})));\n+    }\n+\n+    try {\n+        for (auto& pair : tmp_vec) {\n+            DataDir* store = pair.first;\n+            auto st = pair.second.get();\n+            if (!st.ok()) {\n+                throw std::runtime_error(\"Store load failed, path=\" + store->path());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk2MjY5MQ=="}, "originalCommit": {"oid": "6118dbfbe80e7f4883b6c93070f1ee7130fb19fa"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQwNzk5Nw==", "bodyText": "Looks good for me. Should log detail error message in lambda.", "url": "https://github.com/apache/incubator-doris/pull/3260#discussion_r403407997", "createdAt": "2020-04-04T01:52:55Z", "author": {"login": "imay"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -148,16 +148,33 @@ void StorageEngine::load_data_dirs(const std::vector<DataDir*>& data_dirs) {\n \n OLAPStatus StorageEngine::_open() {\n     // init store_map\n+    std::vector<std::pair<DataDir*,std::future<Status>>> tmp_vec;\n     for (auto& path : _options.store_paths) {\n+        LOG(INFO) << \"store_path \" << path.path;\n         DataDir* store = new DataDir(path.path, path.capacity_bytes, path.storage_medium,\n                                      _tablet_manager.get(), _txn_manager.get());\n-        auto st = store->init();\n-        if (!st.ok()) {\n-            LOG(WARNING) << \"Store load failed, path=\" << path.path;\n-            return OLAP_ERR_INVALID_ROOT_PATH;\n+        tmp_vec.emplace_back(std::make_pair(store,std::async([store](){ return store->init();})));\n+    }\n+\n+    try {\n+        for (auto& pair : tmp_vec) {\n+            DataDir* store = pair.first;\n+            auto st = pair.second.get();\n+            if (!st.ok()) {\n+                throw std::runtime_error(\"Store load failed, path=\" + store->path());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk2MjY5MQ=="}, "originalCommit": {"oid": "6118dbfbe80e7f4883b6c93070f1ee7130fb19fa"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMDcwMzQyOnYy", "diffSide": "RIGHT", "path": "be/src/olap/storage_engine.cpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzo0Nzo1MlrOGB3HxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzo0Nzo1MlrOGB3HxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYwNDg2OQ==", "bodyText": "should print st.to_string() too.", "url": "https://github.com/apache/incubator-doris/pull/3260#discussion_r404604869", "createdAt": "2020-04-07T07:47:52Z", "author": {"login": "imay"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -185,6 +177,39 @@ OLAPStatus StorageEngine::_open() {\n     return OLAP_SUCCESS;\n }\n \n+OLAPStatus StorageEngine::_init_store_map() {\n+    std::vector < std::pair<DataDir*> tmp_stores;\n+    std::vector<std::thread> threads;\n+    std::atomic<bool> init_error{false};\n+    for (auto& path : _options.store_paths) {\n+        DataDir* store = new DataDir(path.path, path.capacity_bytes, path.storage_medium,\n+                                     _tablet_manager.get(), _txn_manager.get());\n+        tmp_stores.emplace_back(store);\n+        threads.emplace_back([store, &init_error]() {\n+            auto st = store->init();\n+            if (!st.ok()) {\n+                init_error = true;\n+                LOG(WARNING) << \"Store load failed, path=\" << store->path();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f87375c95c8418d01d215fda59ad23e1c53c296"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMDcwNzEyOnYy", "diffSide": "RIGHT", "path": "be/src/olap/storage_engine.cpp", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzo0ODo1MVrOGB3KDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwODoxMDo0MFrOGB39DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYwNTQ1Mw==", "bodyText": "???\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                std::vector < std::pair<DataDir*> tmp_stores;\n          \n          \n            \n                std::vector<DataDir*> tmp_stores;", "url": "https://github.com/apache/incubator-doris/pull/3260#discussion_r404605453", "createdAt": "2020-04-07T07:48:51Z", "author": {"login": "imay"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -185,6 +177,39 @@ OLAPStatus StorageEngine::_open() {\n     return OLAP_SUCCESS;\n }\n \n+OLAPStatus StorageEngine::_init_store_map() {\n+    std::vector < std::pair<DataDir*> tmp_stores;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f87375c95c8418d01d215fda59ad23e1c53c296"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYxODUwOA==", "bodyText": "cherry-pick mistake \ud83d\ude13\nWhen can we have a look at CI output? It will be enormously helpful.", "url": "https://github.com/apache/incubator-doris/pull/3260#discussion_r404618508", "createdAt": "2020-04-07T08:10:40Z", "author": {"login": "vagetablechicken"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -185,6 +177,39 @@ OLAPStatus StorageEngine::_open() {\n     return OLAP_SUCCESS;\n }\n \n+OLAPStatus StorageEngine::_init_store_map() {\n+    std::vector < std::pair<DataDir*> tmp_stores;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYwNTQ1Mw=="}, "originalCommit": {"oid": "3f87375c95c8418d01d215fda59ad23e1c53c296"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1861, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}