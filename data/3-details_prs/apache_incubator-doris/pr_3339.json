{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0ODk1MTI1", "number": 3339, "title": "[tablet] A small refactor on class Tablet", "bodyText": "There is no functional changes in this patch.\nKey refactor points are:\n\nRemove meaningless return value of functions in class Tablet, and\nalso some related functions in other classes\nAllow RowsetGraph::capture_consistent_versions to pass a nullptr\nto the output parameter\nUse CHECK instead of LOG(FATAL) to simplify code", "createdAt": "2020-04-17T03:04:53Z", "url": "https://github.com/apache/incubator-doris/pull/3339", "merged": true, "mergeCommit": {"oid": "37fccd53c4aa60eb0e995aa4fe9111cff344356e"}, "closed": true, "closedAt": "2020-04-24T14:22:27Z", "author": {"login": "acelyc111"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYYQAQAH2gAyNDA0ODk1MTI1OjEyZGY0YzE3ZjQyN2VmZTUxNTE3YTdhNjVjNThjMGMwYTc1ZGM1Yzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcayPkHAFqTM5OTk5MDExMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/12df4c17f427efe51517a7a65c58c0c0a75dc5c7", "committedDate": "2020-04-17T02:55:28Z", "message": "[tablet] A small refactor on class Tablet\n\nThere is no functional changes in this patch.\nKey refactor points are:\n- Remove meaningless return value of functions in class Tablet, and\n  also some related functions in other classes\n- Allow RowsetGraph::capture_consistent_versions to pass a nullptr\n  to the output parameter\n- Use CHECK instead of LOG(FATAL) to simplify code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MTQ4OTc3", "url": "https://github.com/apache/incubator-doris/pull/3339#pullrequestreview-395148977", "createdAt": "2020-04-17T04:10:58Z", "commit": {"oid": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNDoxMDo1OFrOGG_UCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNDoyNjo0M1rOGG_iOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MTk2MA==", "bodyText": "CHECK_EQ takes no effect on release version.", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r409981960", "createdAt": "2020-04-17T04:10:58Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/tablet.cpp", "diffHunk": "@@ -135,16 +130,12 @@ OLAPStatus Tablet::set_tablet_state(TabletState state) {\n \n // should save tablet meta to remote meta store\n // if it's a primary replica\n-OLAPStatus Tablet::save_meta() {\n-    OLAPStatus res = _tablet_meta->save_meta(_data_dir);\n-    if (res != OLAP_SUCCESS) {\n-       LOG(FATAL) << \"fail to save tablet_meta. res=\" << res << \", root=\" << _data_dir->path();\n-    }\n+void Tablet::save_meta() {\n+    auto res = _tablet_meta->save_meta(_data_dir);\n+    CHECK_EQ(res, OLAP_SUCCESS) << \"fail to save tablet_meta. res=\" << res << \", root=\" << _data_dir->path();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4NTU1NA==", "bodyText": "I think should not coupling outside VersionPath empty logic in this function.", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r409985554", "createdAt": "2020-04-17T04:26:35Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/rowset_graph.cpp", "diffHunk": "@@ -237,25 +232,26 @@ OLAPStatus RowsetGraph::capture_consistent_versions(const Version& spec_version,\n         reversed_path.push_back(tmp_vertex_index);\n     }\n \n-    // Make version_path from reversed_path.\n-    std::stringstream shortest_path_for_debug;\n-    for (size_t path_id = reversed_path.size() - 1; path_id > 0; --path_id) {\n-        int64_t tmp_start_vertex_value = _version_graph[reversed_path[path_id]].value;\n-        int64_t tmp_end_vertex_value = _version_graph[reversed_path[path_id - 1]].value;\n-\n-        // tmp_start_vertex_value mustn't be equal to tmp_end_vertex_value\n-        if (tmp_start_vertex_value <= tmp_end_vertex_value) {\n-            version_path->emplace_back(tmp_start_vertex_value, tmp_end_vertex_value - 1);\n-        } else {\n-            version_path->emplace_back(tmp_end_vertex_value, tmp_start_vertex_value - 1);\n-        }\n+    if (version_path != nullptr) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4NTU5Mg==", "bodyText": "You can CHECK(VERSION_PATH != nullptr) to replace above logic.", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r409985592", "createdAt": "2020-04-17T04:26:43Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/rowset_graph.cpp", "diffHunk": "@@ -159,11 +159,6 @@ OLAPStatus RowsetGraph::capture_consistent_versions(const Version& spec_version,\n         return OLAP_ERR_INPUT_PARAMETER_ERROR;\n     }\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTcyNzY0", "url": "https://github.com/apache/incubator-doris/pull/3339#pullrequestreview-395972764", "createdAt": "2020-04-19T03:46:49Z", "commit": {"oid": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0854d7a896cb989c2a889f10b3670ca3de1f59c2", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/0854d7a896cb989c2a889f10b3670ca3de1f59c2", "committedDate": "2020-04-19T06:01:59Z", "message": "fix compile error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3Nzk5MjE2", "url": "https://github.com/apache/incubator-doris/pull/3339#pullrequestreview-397799216", "createdAt": "2020-04-22T02:26:29Z", "commit": {"oid": "0854d7a896cb989c2a889f10b3670ca3de1f59c2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjoyNjoyOVrOGJgc5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjoyNjoyOVrOGJgc5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYyMjA1NQ==", "bodyText": "I think there is no necessity for capture_consistent_versions() judge version_path is nullptr or not.\nSo you can DCHECK(version_path != nullptr) instead.\nOf course, you should guarantee that the caller should the version_path is not nullptr.", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r412622055", "createdAt": "2020-04-22T02:26:29Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/rowset_graph.cpp", "diffHunk": "@@ -237,25 +232,26 @@ OLAPStatus RowsetGraph::capture_consistent_versions(const Version& spec_version,\n         reversed_path.push_back(tmp_vertex_index);\n     }\n \n-    // Make version_path from reversed_path.\n-    std::stringstream shortest_path_for_debug;\n-    for (size_t path_id = reversed_path.size() - 1; path_id > 0; --path_id) {\n-        int64_t tmp_start_vertex_value = _version_graph[reversed_path[path_id]].value;\n-        int64_t tmp_end_vertex_value = _version_graph[reversed_path[path_id - 1]].value;\n-\n-        // tmp_start_vertex_value mustn't be equal to tmp_end_vertex_value\n-        if (tmp_start_vertex_value <= tmp_end_vertex_value) {\n-            version_path->emplace_back(tmp_start_vertex_value, tmp_end_vertex_value - 1);\n-        } else {\n-            version_path->emplace_back(tmp_end_vertex_value, tmp_start_vertex_value - 1);\n-        }\n+    if (version_path != nullptr) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4NTU1NA=="}, "originalCommit": {"oid": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5OTg4OTM1", "url": "https://github.com/apache/incubator-doris/pull/3339#pullrequestreview-399988935", "createdAt": "2020-04-24T14:19:03Z", "commit": {"oid": "0854d7a896cb989c2a889f10b3670ca3de1f59c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5OTkwMTEx", "url": "https://github.com/apache/incubator-doris/pull/3339#pullrequestreview-399990111", "createdAt": "2020-04-24T14:20:22Z", "commit": {"oid": "0854d7a896cb989c2a889f10b3670ca3de1f59c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3257, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}