{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0NzE0OTM0", "number": 4029, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDo0NjoxOVrOELt-Pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQxMjo1Njo0MVrOEP2jXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwNzIzMDA2OnYy", "diffSide": "LEFT", "path": "fe/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDo0NjoxOVrOGtaesA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDo0NjoxOVrOGtaesA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3Mjk0NA==", "bodyText": "Add a Preconditions.checkState( db.isWriteLockHeldByCurrentThread()) to NOTICE.", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r450272944", "createdAt": "2020-07-06T14:46:19Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "diffHunk": "@@ -716,7 +716,6 @@ public void processBatchDropRollup(List<AlterClause> dropRollupClauses, Database\n \n     public void processDropMaterializedView(DropMaterializedViewStmt dropMaterializedViewStmt, Database db,\n             OlapTable olapTable) throws DdlException, MetaNotFoundException {\n-        db.writeLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "032bbaf691e529f103ed8bd9acbc13b559087f83"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwNzI0MDIxOnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDo0ODozOVrOGtalCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDo0ODozOVrOGtalCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NDU2OA==", "bodyText": "There are still some transactions in the COMMITTED state waiting to be completed. The database cannot be dropped. If you want to force drop(cannot be recovered), please use \"DROPP database\";", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r450274568", "createdAt": "2020-07-06T14:48:39Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -2666,6 +2666,13 @@ public void dropDb(DropDbStmt stmt) throws DdlException {\n             Database db = this.fullNameToDb.get(dbName);\n             db.writeLock();\n             try {\n+                if (stmt.isNeedCheckCommitedTxns()) {\n+                    if (Catalog.getCurrentCatalog().getGlobalTransactionMgr().existCommittedTxns(db.getId(), null, null)) {\n+                        throw new DdlException(\"There are still some commited txns cannot be aborted in db [\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "032bbaf691e529f103ed8bd9acbc13b559087f83"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwNzI0NTE3OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/analysis/DropTableStmt.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDo0OTo0NFrOGtaoCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDo0OTo0NFrOGtaoCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NTMzOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public boolean isNeedCheckCommitedTxns() {\n          \n          \n            \n                public boolean isNeedCheckCommittedTxns() {", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r450275338", "createdAt": "2020-07-06T14:49:44Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/DropTableStmt.java", "diffHunk": "@@ -61,6 +64,10 @@ public boolean isView() {\n         return isView;\n     }\n \n+    public boolean isNeedCheckCommitedTxns() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "032bbaf691e529f103ed8bd9acbc13b559087f83"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwNzI0NTczOnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/analysis/DropTableStmt.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDo0OTo1MFrOGtaoXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDo0OTo1MFrOGtaoXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NTQyMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public DropTableStmt(boolean ifExists, TableName tableName, boolean needCheckCommitedTxns) {\n          \n          \n            \n                public DropTableStmt(boolean ifExists, TableName tableName, boolean needCheckCommittedTxns) {", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r450275423", "createdAt": "2020-07-06T14:49:50Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/DropTableStmt.java", "diffHunk": "@@ -32,17 +32,20 @@\n     private boolean ifExists;\n     private final TableName tableName;\n     private final boolean isView;\n+    private boolean needCheckCommitedTxns;\n \n-    public DropTableStmt(boolean ifExists, TableName tableName) {\n+    public DropTableStmt(boolean ifExists, TableName tableName, boolean needCheckCommitedTxns) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "032bbaf691e529f103ed8bd9acbc13b559087f83"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwNzI0NjE4OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/analysis/DropTableStmt.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDo0OTo1N1rOGtaoqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDo0OTo1N1rOGtaoqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NTQ5OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean needCheckCommitedTxns;\n          \n          \n            \n                private boolean needCheckCommittedTxns;", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r450275499", "createdAt": "2020-07-06T14:49:57Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/DropTableStmt.java", "diffHunk": "@@ -32,17 +32,20 @@\n     private boolean ifExists;\n     private final TableName tableName;\n     private final boolean isView;\n+    private boolean needCheckCommitedTxns;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "032bbaf691e529f103ed8bd9acbc13b559087f83"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwNzI0NzQyOnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/analysis/DropTableStmt.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDo1MDoxNFrOGtapaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDo1MDoxNFrOGtapaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NTY4OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.needCheckCommitedTxns = needCheckCommitedTxns;\n          \n          \n            \n                    this.needCheckCommittedTxns = needCheckCommittedTxns;", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r450275689", "createdAt": "2020-07-06T14:50:14Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/DropTableStmt.java", "diffHunk": "@@ -32,17 +32,20 @@\n     private boolean ifExists;\n     private final TableName tableName;\n     private final boolean isView;\n+    private boolean needCheckCommitedTxns;\n \n-    public DropTableStmt(boolean ifExists, TableName tableName) {\n+    public DropTableStmt(boolean ifExists, TableName tableName, boolean needCheckCommitedTxns) {\n         this.ifExists = ifExists;\n         this.tableName = tableName;\n         this.isView = false;\n+        this.needCheckCommitedTxns = needCheckCommitedTxns;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "032bbaf691e529f103ed8bd9acbc13b559087f83"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwNzI0ODY1OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDo1MDozMlrOGtaqMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNjoyNjoxN1rOGtegcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NTg5MQ==", "bodyText": "Duplicated if clause?", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r450275891", "createdAt": "2020-07-06T14:50:32Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -3308,6 +3315,20 @@ public void dropPartition(Database db, OlapTable olapTable, DropPartitionClause\n         if (isTempPartition) {\n             olapTable.dropTempPartition(partitionName, true);\n         } else {\n+            if (clause.isNeedCheckCommitedTxns()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "032bbaf691e529f103ed8bd9acbc13b559087f83"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMzODkzMQ==", "bodyText": "my bad, I will fix it.", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r450338931", "createdAt": "2020-07-06T16:26:17Z", "author": {"login": "caiconghui"}, "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -3308,6 +3315,20 @@ public void dropPartition(Database db, OlapTable olapTable, DropPartitionClause\n         if (isTempPartition) {\n             olapTable.dropTempPartition(partitionName, true);\n         } else {\n+            if (clause.isNeedCheckCommitedTxns()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NTg5MQ=="}, "originalCommit": {"oid": "032bbaf691e529f103ed8bd9acbc13b559087f83"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwOTQ2NDYxOnYy", "diffSide": "RIGHT", "path": "fe/src/main/cup/sql_parser.cup", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNTozNjowOVrOGtvuxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNzozNDoyOVrOG3W2VQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYyMTEyNQ==", "bodyText": "DROPP is a not a good syntax. It's better to use\nDROP TABLE $table_name FORCE", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r450621125", "createdAt": "2020-07-07T05:36:09Z", "author": {"login": "chaoyli"}, "path": "fe/src/main/cup/sql_parser.cup", "diffHunk": "@@ -879,7 +879,11 @@ alter_table_clause ::=\n     :}\n     | KW_DROP opt_tmp:isTempPartition KW_PARTITION opt_if_exists:ifExists ident:partitionName\n     {:\n-        RESULT = new DropPartitionClause(ifExists, partitionName, isTempPartition);\n+        RESULT = new DropPartitionClause(ifExists, partitionName, isTempPartition, !isTempPartition);\n+    :}\n+    | KW_DROPP opt_tmp:isTempPartition KW_PARTITION opt_if_exists:ifExists ident:partitionName", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4c2ed10b9013d09f8d98d5c128f7337f88b2842"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY5OTIyMQ==", "bodyText": "@chaoyli I has fixed it before. old commit version?", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r460699221", "createdAt": "2020-07-27T07:34:29Z", "author": {"login": "caiconghui"}, "path": "fe/src/main/cup/sql_parser.cup", "diffHunk": "@@ -879,7 +879,11 @@ alter_table_clause ::=\n     :}\n     | KW_DROP opt_tmp:isTempPartition KW_PARTITION opt_if_exists:ifExists ident:partitionName\n     {:\n-        RESULT = new DropPartitionClause(ifExists, partitionName, isTempPartition);\n+        RESULT = new DropPartitionClause(ifExists, partitionName, isTempPartition, !isTempPartition);\n+    :}\n+    | KW_DROPP opt_tmp:isTempPartition KW_PARTITION opt_if_exists:ifExists ident:partitionName", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYyMTEyNQ=="}, "originalCommit": {"oid": "c4c2ed10b9013d09f8d98d5c128f7337f88b2842"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MDU3ODg1OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQxMjo1Njo0MVrOGzvUHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNzoyMToxMVrOG3WdCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkwNTc1Nw==", "bodyText": "DROP database FORCE. Use upper case will be better.", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r456905757", "createdAt": "2020-07-19T12:56:41Z", "author": {"login": "chaoyli"}, "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -2666,6 +2666,13 @@ public void dropDb(DropDbStmt stmt) throws DdlException {\n             Database db = this.fullNameToDb.get(dbName);\n             db.writeLock();\n             try {\n+                if (stmt.isNeedCheckCommittedTxns()) {\n+                    if (Catalog.getCurrentCatalog().getGlobalTransactionMgr().existCommittedTxns(db.getId(), null, null)) {\n+                       throw new DdlException(\"There are still some transactions in the COMMITTED state waiting to be completed. \" +\n+                               \"The database [\" + dbName +\"] cannot be dropped. If you want to forcibly drop(cannot be recovered),\" +\n+                               \" please use \\\"DROP database force\\\".\");\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6da313d589cef7426bfdad515ec89ea8f0c866d"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY5Mjc0NA==", "bodyText": "ok", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r460692744", "createdAt": "2020-07-27T07:21:11Z", "author": {"login": "caiconghui"}, "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -2666,6 +2666,13 @@ public void dropDb(DropDbStmt stmt) throws DdlException {\n             Database db = this.fullNameToDb.get(dbName);\n             db.writeLock();\n             try {\n+                if (stmt.isNeedCheckCommittedTxns()) {\n+                    if (Catalog.getCurrentCatalog().getGlobalTransactionMgr().existCommittedTxns(db.getId(), null, null)) {\n+                       throw new DdlException(\"There are still some transactions in the COMMITTED state waiting to be completed. \" +\n+                               \"The database [\" + dbName +\"] cannot be dropped. If you want to forcibly drop(cannot be recovered),\" +\n+                               \" please use \\\"DROP database force\\\".\");\n+                    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkwNTc1Nw=="}, "originalCommit": {"oid": "a6da313d589cef7426bfdad515ec89ea8f0c866d"}, "originalPosition": 9}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1378, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}