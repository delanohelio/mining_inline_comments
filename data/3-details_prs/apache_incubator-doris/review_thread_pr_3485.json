{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0MDE4MzU5", "number": 3485, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNTo1MjoxNlrOD54bUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwMzoxMjoyMFrOD6Eruw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyMDE5OTIwOnYy", "diffSide": "RIGHT", "path": "be/src/exec/assert_num_rows_node.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNTo1MjoxNlrOGRZvaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwMjozMDo0MlrOGRsMAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwMDcxNQ==", "bodyText": "Where is _TAssertion_VALUES_TO_NAMES  ?", "url": "https://github.com/apache/incubator-doris/pull/3485#discussion_r420900715", "createdAt": "2020-05-06T15:52:16Z", "author": {"login": "kangkaisen"}, "path": "be/src/exec/assert_num_rows_node.cpp", "diffHunk": "@@ -56,12 +62,46 @@ Status AssertNumRowsNode::get_next(RuntimeState* state, RowBatch* output_batch,\n     output_batch->reset();\n     child(0)->get_next(state, output_batch, eos);\n     _num_rows_returned += output_batch->num_rows();\n-    if (_num_rows_returned > _desired_num_rows) {\n-        LOG(INFO) << \"Expected no more than \" << _desired_num_rows << \" to be returned by expression \"\n-                  << _subquery_string;\n-        return Status::Cancelled(strings::Substitute(\n-                                \"Expected no more than $0 to be returned by expression $1\",\n-                                _desired_num_rows, _subquery_string));\n+    bool assert_res = false;\n+    switch (_assertion) {\n+    case TAssertion::EQ:\n+        assert_res = _num_rows_returned == _desired_num_rows;\n+        break;\n+    case TAssertion::NE:\n+        assert_res = _num_rows_returned != _desired_num_rows;\n+        break;\n+    case TAssertion::LT:\n+        assert_res = _num_rows_returned < _desired_num_rows;\n+        break;\n+    case TAssertion::LE:\n+        assert_res = _num_rows_returned <= _desired_num_rows;\n+        break;\n+    case TAssertion::GT:\n+        assert_res = _num_rows_returned > _desired_num_rows;\n+        break;\n+    case TAssertion::GE:\n+        assert_res = _num_rows_returned >= _desired_num_rows;\n+        break;\n+    default:\n+        break;\n+    }\n+\n+    if (!assert_res) {\n+        auto to_string_lamba = [](TAssertion::type assertion) {\n+            std::map<int, const char*>::const_iterator it =\n+                    _TAssertion_VALUES_TO_NAMES.find(assertion);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a78710f96c8a41a71acf80c9692b66325ebb715"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIwMjk0Ng==", "bodyText": "_TAssertion_VALUES_TO_NAMES is generated by thrift, every enum has a variable like  _xxxx_VALUES_TO_NAMES", "url": "https://github.com/apache/incubator-doris/pull/3485#discussion_r421202946", "createdAt": "2020-05-07T02:30:42Z", "author": {"login": "yangzhg"}, "path": "be/src/exec/assert_num_rows_node.cpp", "diffHunk": "@@ -56,12 +62,46 @@ Status AssertNumRowsNode::get_next(RuntimeState* state, RowBatch* output_batch,\n     output_batch->reset();\n     child(0)->get_next(state, output_batch, eos);\n     _num_rows_returned += output_batch->num_rows();\n-    if (_num_rows_returned > _desired_num_rows) {\n-        LOG(INFO) << \"Expected no more than \" << _desired_num_rows << \" to be returned by expression \"\n-                  << _subquery_string;\n-        return Status::Cancelled(strings::Substitute(\n-                                \"Expected no more than $0 to be returned by expression $1\",\n-                                _desired_num_rows, _subquery_string));\n+    bool assert_res = false;\n+    switch (_assertion) {\n+    case TAssertion::EQ:\n+        assert_res = _num_rows_returned == _desired_num_rows;\n+        break;\n+    case TAssertion::NE:\n+        assert_res = _num_rows_returned != _desired_num_rows;\n+        break;\n+    case TAssertion::LT:\n+        assert_res = _num_rows_returned < _desired_num_rows;\n+        break;\n+    case TAssertion::LE:\n+        assert_res = _num_rows_returned <= _desired_num_rows;\n+        break;\n+    case TAssertion::GT:\n+        assert_res = _num_rows_returned > _desired_num_rows;\n+        break;\n+    case TAssertion::GE:\n+        assert_res = _num_rows_returned >= _desired_num_rows;\n+        break;\n+    default:\n+        break;\n+    }\n+\n+    if (!assert_res) {\n+        auto to_string_lamba = [](TAssertion::type assertion) {\n+            std::map<int, const char*>::const_iterator it =\n+                    _TAssertion_VALUES_TO_NAMES.find(assertion);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwMDcxNQ=="}, "originalCommit": {"oid": "5a78710f96c8a41a71acf80c9692b66325ebb715"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyMDIwMDE3OnYy", "diffSide": "RIGHT", "path": "be/src/exec/assert_num_rows_node.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNTo1MjoyOVrOGRZwDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNTo1MjoyOVrOGRZwDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwMDg3Nw==", "bodyText": "Code format.", "url": "https://github.com/apache/incubator-doris/pull/3485#discussion_r420900877", "createdAt": "2020-05-06T15:52:29Z", "author": {"login": "kangkaisen"}, "path": "be/src/exec/assert_num_rows_node.cpp", "diffHunk": "@@ -17,19 +17,25 @@\n \n #include \"exec/assert_num_rows_node.h\"\n \n+#include \"gen_cpp/PlanNodes_types.h\"\n+#include \"gutil/strings/substitute.h\"\n #include \"runtime/row_batch.h\"\n #include \"runtime/runtime_state.h\"\n #include \"util/runtime_profile.h\"\n-#include \"gen_cpp/PlanNodes_types.h\"\n-#include \"gutil/strings/substitute.h\"\n \n namespace doris {\n \n-AssertNumRowsNode::AssertNumRowsNode(\n-    ObjectPool* pool, const TPlanNode& tnode, const DescriptorTbl& descs) :\n-        ExecNode(pool, tnode, descs),\n-        _desired_num_rows(tnode.assert_num_rows_node.desired_num_rows),\n-        _subquery_string(tnode.assert_num_rows_node.subquery_string) {\n+AssertNumRowsNode::AssertNumRowsNode(ObjectPool* pool, const TPlanNode& tnode,\n+                                     const DescriptorTbl& descs)\n+        : ExecNode(pool, tnode, descs),\n+          _desired_num_rows(tnode.assert_num_rows_node.desired_num_rows),\n+          _subquery_string(tnode.assert_num_rows_node.subquery_string) {\n+    if (tnode.assert_num_rows_node.__isset.assertion) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a78710f96c8a41a71acf80c9692b66325ebb715"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyMjIwNDEzOnYy", "diffSide": "RIGHT", "path": "be/src/exec/assert_num_rows_node.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwMzoxMDozNlrOGRs0PQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwMzoxMDozNlrOGRs0PQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxMzI0NQ==", "bodyText": "Pay attention to code alignment", "url": "https://github.com/apache/incubator-doris/pull/3485#discussion_r421213245", "createdAt": "2020-05-07T03:10:36Z", "author": {"login": "EmmyMiao87"}, "path": "be/src/exec/assert_num_rows_node.cpp", "diffHunk": "@@ -17,19 +17,25 @@\n \n #include \"exec/assert_num_rows_node.h\"\n \n+#include \"gen_cpp/PlanNodes_types.h\"\n+#include \"gutil/strings/substitute.h\"\n #include \"runtime/row_batch.h\"\n #include \"runtime/runtime_state.h\"\n #include \"util/runtime_profile.h\"\n-#include \"gen_cpp/PlanNodes_types.h\"\n-#include \"gutil/strings/substitute.h\"\n \n namespace doris {\n \n-AssertNumRowsNode::AssertNumRowsNode(\n-    ObjectPool* pool, const TPlanNode& tnode, const DescriptorTbl& descs) :\n-        ExecNode(pool, tnode, descs),\n-        _desired_num_rows(tnode.assert_num_rows_node.desired_num_rows),\n-        _subquery_string(tnode.assert_num_rows_node.subquery_string) {\n+AssertNumRowsNode::AssertNumRowsNode(ObjectPool* pool, const TPlanNode& tnode,\n+                                     const DescriptorTbl& descs)\n+        : ExecNode(pool, tnode, descs),\n+          _desired_num_rows(tnode.assert_num_rows_node.desired_num_rows),\n+          _subquery_string(tnode.assert_num_rows_node.subquery_string) {\n+    if (tnode.assert_num_rows_node.__isset.assertion) {\n+                _assertion = tnode.assert_num_rows_node.assertion;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a78710f96c8a41a71acf80c9692b66325ebb715"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyMjIwNzMxOnYy", "diffSide": "RIGHT", "path": "be/src/exec/assert_num_rows_node.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwMzoxMjoyMFrOGRs2Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwMzoxMjoyMFrOGRs2Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxMzY5OA==", "bodyText": "Pay attention to code alignment", "url": "https://github.com/apache/incubator-doris/pull/3485#discussion_r421213698", "createdAt": "2020-05-07T03:12:20Z", "author": {"login": "EmmyMiao87"}, "path": "be/src/exec/assert_num_rows_node.cpp", "diffHunk": "@@ -56,12 +62,46 @@ Status AssertNumRowsNode::get_next(RuntimeState* state, RowBatch* output_batch,\n     output_batch->reset();\n     child(0)->get_next(state, output_batch, eos);\n     _num_rows_returned += output_batch->num_rows();\n-    if (_num_rows_returned > _desired_num_rows) {\n-        LOG(INFO) << \"Expected no more than \" << _desired_num_rows << \" to be returned by expression \"\n-                  << _subquery_string;\n-        return Status::Cancelled(strings::Substitute(\n-                                \"Expected no more than $0 to be returned by expression $1\",\n-                                _desired_num_rows, _subquery_string));\n+    bool assert_res = false;\n+    switch (_assertion) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a78710f96c8a41a71acf80c9692b66325ebb715"}, "originalPosition": 44}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1747, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}