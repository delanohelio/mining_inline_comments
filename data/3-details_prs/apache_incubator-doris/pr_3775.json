{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3Nzk4MjUz", "number": 3775, "title": "Support read and write lock in table level to reduce lock competition", "bodyText": "This PR is to reduce lock competition by supporting read and write lock in table level. When we modify or read table's meta, we don't need to get db lock, just get table write or read lock. And when we get db lock, that means meta directly in db cannot be modified by other thread. Db lock only protect meta in Database class, while table lock protect meta in Table class.", "createdAt": "2020-06-04T12:22:55Z", "url": "https://github.com/apache/incubator-doris/pull/3775", "merged": true, "mergeCommit": {"oid": "f7730031b8eca90c150c400c8d67e008290a6f70"}, "closed": true, "closedAt": "2021-01-13T02:27:59Z", "author": {"login": "caiconghui"}, "timelineItems": {"totalCount": 75, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoRAxegFqTQyNTIxOTA2Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdvZ88QAFqTU2NjIwNDQ2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MjE5MDYy", "url": "https://github.com/apache/incubator-doris/pull/3775#pullrequestreview-425219062", "createdAt": "2020-06-05T11:32:16Z", "commit": {"oid": "e9e9d8279a9ee1c664f26d6679ed0268f854aabf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMTozMjoxN1rOGfq3nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMTozMjoxN1rOGfq3nA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg2MTQwNA==", "bodyText": "Could use getTableOrThrowException", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r435861404", "createdAt": "2020-06-05T11:32:17Z", "author": {"login": "kangkaisen"}, "path": "fe/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -118,30 +118,30 @@ public void processDropMaterializedView(DropMaterializedViewStmt stmt) throws Dd\n             ErrorReport.reportDdlException(ErrorCode.ERR_BAD_DB_ERROR, dbName);\n         }\n \n-        db.writeLock();\n+        String tableName = stmt.getTableName().getTbl();\n+        Table table = db.getTable(tableName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9e9d8279a9ee1c664f26d6679ed0268f854aabf"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MjIyMTQ5", "url": "https://github.com/apache/incubator-doris/pull/3775#pullrequestreview-425222149", "createdAt": "2020-06-05T11:37:46Z", "commit": {"oid": "e9e9d8279a9ee1c664f26d6679ed0268f854aabf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMTozNzo0NlrOGfrAsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMTozNzo0NlrOGfrAsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg2MzczMA==", "bodyText": "Could use getTableOrThrowException", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r435863730", "createdAt": "2020-06-05T11:37:46Z", "author": {"login": "kangkaisen"}, "path": "fe/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -169,18 +169,19 @@ public void processAlterTable(AlterTableStmt stmt) throws UserException {\n         // some operations will take long time to process, need to be done outside the databse lock\n         boolean needProcessOutsideDatabaseLock = false;\n         String tableName = dbTableName.getTbl();\n-        db.writeLock();\n-        try {\n-            Table table = db.getTable(tableName);\n-            if (table == null) {\n-                ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n-            }\n \n-            if (table.getType() != TableType.OLAP) {\n-                throw new DdlException(\"Do not support alter non-OLAP table[\" + tableName + \"]\");\n-            }\n-            OlapTable olapTable = (OlapTable) table;\n+        Table table = db.getTable(tableName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9e9d8279a9ee1c664f26d6679ed0268f854aabf"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MjIyOTA1", "url": "https://github.com/apache/incubator-doris/pull/3775#pullrequestreview-425222905", "createdAt": "2020-06-05T11:39:07Z", "commit": {"oid": "e9e9d8279a9ee1c664f26d6679ed0268f854aabf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMTozOTowN1rOGfrDAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMTozOTowN1rOGfrDAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg2NDMyMg==", "bodyText": "Why don't add the table lock\uff1f", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r435864322", "createdAt": "2020-06-05T11:39:07Z", "author": {"login": "kangkaisen"}, "path": "fe/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "diffHunk": "@@ -1015,13 +1017,8 @@ private void runOldAlterJob() {\n                 continue;\n             }\n \n-            db.writeLock();\n-            try {\n-                OlapTable olapTable = (OlapTable) db.getTable(rollupJob.getTableId());\n-                rollupJob.cancel(olapTable, \"cancelled\");\n-            } finally {\n-                db.writeUnlock();\n-            }\n+            OlapTable olapTable = (OlapTable) db.getTable(rollupJob.getTableId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9e9d8279a9ee1c664f26d6679ed0268f854aabf"}, "originalPosition": 105}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MzQ2NTcw", "url": "https://github.com/apache/incubator-doris/pull/3775#pullrequestreview-425346570", "createdAt": "2020-06-05T14:21:40Z", "commit": {"oid": "e9e9d8279a9ee1c664f26d6679ed0268f854aabf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e9e9d8279a9ee1c664f26d6679ed0268f854aabf", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/e9e9d8279a9ee1c664f26d6679ed0268f854aabf", "committedDate": "2020-06-04T13:58:04Z", "message": "add null check for olap_table"}, "afterCommit": {"oid": "940e992c282b1b75f0d70abb839d07b321ad21c3", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/940e992c282b1b75f0d70abb839d07b321ad21c3", "committedDate": "2020-06-13T16:50:36Z", "message": "fix merge"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1489155795489901bfddd51590fdf11a3dcfa99", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/f1489155795489901bfddd51590fdf11a3dcfa99", "committedDate": "2020-06-16T11:32:13Z", "message": "fix test"}, "afterCommit": {"oid": "81519db79dfe1a12fdc3f2b052c2882f60b0902f", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/81519db79dfe1a12fdc3f2b052c2882f60b0902f", "committedDate": "2020-06-25T03:28:49Z", "message": "fix load"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81519db79dfe1a12fdc3f2b052c2882f60b0902f", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/81519db79dfe1a12fdc3f2b052c2882f60b0902f", "committedDate": "2020-06-25T03:28:49Z", "message": "fix load"}, "afterCommit": {"oid": "2c247dcb3ae9642040d6f7a9ed16540853d4775d", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/2c247dcb3ae9642040d6f7a9ed16540853d4775d", "committedDate": "2020-09-22T12:32:40Z", "message": "fix ReportHandler"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c247dcb3ae9642040d6f7a9ed16540853d4775d", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/2c247dcb3ae9642040d6f7a9ed16540853d4775d", "committedDate": "2020-09-22T12:32:40Z", "message": "fix ReportHandler"}, "afterCommit": {"oid": "5c762125f510c09173240cf965a2033aa4125b33", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/5c762125f510c09173240cf965a2033aa4125b33", "committedDate": "2020-09-24T09:09:03Z", "message": "fix unit test failed for AlterTest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c762125f510c09173240cf965a2033aa4125b33", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/5c762125f510c09173240cf965a2033aa4125b33", "committedDate": "2020-09-24T09:09:03Z", "message": "fix unit test failed for AlterTest"}, "afterCommit": {"oid": "ccba5ad1346f7938c6545091e5ba77ff6a09e596", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/ccba5ad1346f7938c6545091e5ba77ff6a09e596", "committedDate": "2020-10-20T13:21:18Z", "message": "Add MetaLockUtils and fix some table lock level"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6a0178c45ec516a67fbb07304eaf6f35339a087", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/f6a0178c45ec516a67fbb07304eaf6f35339a087", "committedDate": "2020-10-21T12:19:56Z", "message": "Change db level lock to table level lock for query"}, "afterCommit": {"oid": "2300dcef1be5862c18ed3f0dd1a78c3493603bd2", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/2300dcef1be5862c18ed3f0dd1a78c3493603bd2", "committedDate": "2020-10-22T13:01:43Z", "message": "fix unittest failed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2300dcef1be5862c18ed3f0dd1a78c3493603bd2", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/2300dcef1be5862c18ed3f0dd1a78c3493603bd2", "committedDate": "2020-10-22T13:01:43Z", "message": "fix unittest failed"}, "afterCommit": {"oid": "ce976dfd2ac48df81bf6b04196636643ea563a21", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/ce976dfd2ac48df81bf6b04196636643ea563a21", "committedDate": "2020-11-05T12:32:17Z", "message": "Add unit test for MetaLockUtils"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce976dfd2ac48df81bf6b04196636643ea563a21", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/ce976dfd2ac48df81bf6b04196636643ea563a21", "committedDate": "2020-11-05T12:32:17Z", "message": "Add unit test for MetaLockUtils"}, "afterCommit": {"oid": "7bba9d749461906b95e4cf3eb8b8d2d3e11625bc", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/7bba9d749461906b95e4cf3eb8b8d2d3e11625bc", "committedDate": "2020-11-09T02:49:12Z", "message": "use MetadataLockUtils to lock table when finish transaction"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0aed452dcf8efdff71b083a57fc7e24198f3c9a0", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/0aed452dcf8efdff71b083a57fc7e24198f3c9a0", "committedDate": "2020-11-09T16:17:48Z", "message": "fix"}, "afterCommit": {"oid": "d8f4bcdcda7e0df89ade477185f0f10a1be9e4dd", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/d8f4bcdcda7e0df89ade477185f0f10a1be9e4dd", "committedDate": "2020-11-10T03:32:35Z", "message": "fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a447398758f294f18e168b0482f0e7cb4524d6ee", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/a447398758f294f18e168b0482f0e7cb4524d6ee", "committedDate": "2020-11-10T11:30:18Z", "message": "Fix dead lock bug"}, "afterCommit": {"oid": "304942c20152c249c7b33b57c4fcaa1b25e5701f", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/304942c20152c249c7b33b57c4fcaa1b25e5701f", "committedDate": "2020-11-13T07:33:44Z", "message": "Fix dead lock bug"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "304942c20152c249c7b33b57c4fcaa1b25e5701f", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/304942c20152c249c7b33b57c4fcaa1b25e5701f", "committedDate": "2020-11-13T07:33:44Z", "message": "Fix dead lock bug"}, "afterCommit": {"oid": "45ef11272f26be0996e187521501ce2076d7df6a", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/45ef11272f26be0996e187521501ce2076d7df6a", "committedDate": "2020-11-19T09:32:08Z", "message": "fix unit test failed for SelectStmt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "45ef11272f26be0996e187521501ce2076d7df6a", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/45ef11272f26be0996e187521501ce2076d7df6a", "committedDate": "2020-11-19T09:32:08Z", "message": "fix unit test failed for SelectStmt"}, "afterCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/1585a01d6746345b57a61fc904f18ea6a59731bd", "committedDate": "2020-11-23T02:53:24Z", "message": "fix unit test failed for SelectStmt"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NDE1NzY1", "url": "https://github.com/apache/incubator-doris/pull/3775#pullrequestreview-538415765", "createdAt": "2020-11-25T11:47:16Z", "commit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "state": "COMMENTED", "comments": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMTo0NzoxN1rOH5vyhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwMjoyMzo0OVrOH6vEZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxMzg2Mw==", "bodyText": "Missing if (olapTable.getState() != OlapTableState.NORMAL) { check?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530313863", "createdAt": "2020-11-25T11:47:17Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -128,30 +124,10 @@ public void processDropMaterializedView(DropMaterializedViewStmt stmt) throws Dd\n             ErrorReport.reportDdlException(ErrorCode.ERR_BAD_DB_ERROR, dbName);\n         }\n \n-        db.writeLock();\n-        try {\n-            String tableName = stmt.getTableName().getTbl();\n-            Table table = db.getTable(tableName);\n-            // if table exists\n-            if (table == null) {\n-                ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n-            }\n-            // check table type\n-            if (table.getType() != TableType.OLAP) {\n-                throw new DdlException(\"Do not support non-OLAP table [\" + tableName + \"] when drop materialized view\");\n-            }\n-            // check table state\n-            OlapTable olapTable = (OlapTable) table;\n-            if (olapTable.getState() != OlapTableState.NORMAL) {\n-                throw new DdlException(\"Table[\" + table.getName() + \"]'s state is not NORMAL. \"\n-                        + \"Do not allow doing DROP ops\");\n-            }\n-            // drop materialized view\n-            ((MaterializedViewHandler)materializedViewHandler).processDropMaterializedView(stmt, db, olapTable);\n-\n-        } finally {\n-            db.writeUnlock();\n-        }\n+        String tableName = stmt.getTableName().getTbl();\n+        OlapTable olapTable = (OlapTable) db.getTableOrThrowException(tableName, TableType.OLAP);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxODkyNw==", "bodyText": "I think we can just lock the table outside the switch, avoid call lock/unlock everywhere inside the processAlterOlapTable and processAlterExternalTable.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530318927", "createdAt": "2020-11-25T11:56:16Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -232,54 +223,61 @@ private void processAlterExternalTable(AlterTableStmt stmt, Table externalTable,\n         List<AlterClause> alterClauses = stmt.getOps();\n         AlterOperations currentAlterOps = new AlterOperations();\n         currentAlterOps.checkConflict(alterClauses);\n-\n         if (currentAlterOps.hasRenameOp()) {\n             processRename(db, externalTable, alterClauses);\n         } else if (currentAlterOps.hasSchemaChangeOp()) {\n-            schemaChangeHandler.processExternalTable(alterClauses, db, externalTable);\n+            externalTable.writeLock();\n+            try {\n+                schemaChangeHandler.processExternalTable(alterClauses, db, externalTable);\n+            } finally {\n+                externalTable.writeUnlock();\n+            }\n         }\n     }\n \n     public void processAlterTable(AlterTableStmt stmt) throws UserException {\n         TableName dbTableName = stmt.getTbl();\n         String dbName = dbTableName.getDb();\n+        String tableName = dbTableName.getTbl();\n         final String clusterName = stmt.getClusterName();\n \n         Database db = Catalog.getCurrentCatalog().getDb(dbName);\n         if (db == null) {\n             ErrorReport.reportDdlException(ErrorCode.ERR_BAD_DB_ERROR, dbName);\n         }\n+        Table table = db.getTable(tableName);\n+        if (table == null) {\n+            ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n+        }\n         List<AlterClause> alterClauses = Lists.newArrayList();\n+        // some operations will take long time to process, need to be done outside the table lock\n+        boolean needProcessOutsideTableLock = false;\n \n-        // some operations will take long time to process, need to be done outside the database lock\n-        boolean needProcessOutsideDatabaseLock = false;\n-        String tableName = dbTableName.getTbl();\n-        db.writeLock();\n-        try {\n-            Table table = db.getTable(tableName);\n-            if (table == null) {\n-                ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n-            }\n+        // check conflict alter ops first\n+        AlterOperations currentAlterOps = new AlterOperations();\n+        currentAlterOps.checkConflict(alterClauses);\n+        // check cluster capacity and db quota outside table lock to escape dead lock, only need to check once.\n+        if (currentAlterOps.needCheckCapacity()) {\n+            Catalog.getCurrentSystemInfo().checkClusterCapacity(clusterName);\n+            db.checkQuota();\n+        }\n \n-            switch (table.getType()) {\n-                case OLAP:\n-                    OlapTable olapTable = (OlapTable) table;\n-                    needProcessOutsideDatabaseLock = processAlterOlapTable(stmt, olapTable, alterClauses, clusterName, db);\n-                    break;\n-                case ODBC:\n-                case MYSQL:\n-                case ELASTICSEARCH:\n-                    processAlterExternalTable(stmt, table, db);\n-                    return;\n-                default:\n-                    throw new DdlException(\"Do not support alter \" + table.getType().toString() + \" table[\" + tableName + \"]\");\n-            }\n-        } finally {\n-            db.writeUnlock();\n+        switch (table.getType()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 238}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyMTUzMQ==", "bodyText": "Better put these locks inside the renameTable method.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530321531", "createdAt": "2020-11-25T12:00:52Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -476,27 +464,48 @@ public void processAlterCluster(AlterSystemStmt stmt) throws UserException {\n     private void processRename(Database db, OlapTable table, List<AlterClause> alterClauses) throws DdlException {\n         for (AlterClause alterClause : alterClauses) {\n             if (alterClause instanceof TableRenameClause) {\n-                Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof RollupRenameClause) {\n-                Catalog.getCurrentCatalog().renameRollup(db, table, (RollupRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof PartitionRenameClause) {\n-                Catalog.getCurrentCatalog().renamePartition(db, table, (PartitionRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof ColumnRenameClause) {\n-                Catalog.getCurrentCatalog().renameColumn(db, table, (ColumnRenameClause) alterClause);\n+                db.writeLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 424}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyMTY5NQ==", "bodyText": "Put lock inside the method", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530321695", "createdAt": "2020-11-25T12:01:09Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -476,27 +464,48 @@ public void processAlterCluster(AlterSystemStmt stmt) throws UserException {\n     private void processRename(Database db, OlapTable table, List<AlterClause> alterClauses) throws DdlException {\n         for (AlterClause alterClause : alterClauses) {\n             if (alterClause instanceof TableRenameClause) {\n-                Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof RollupRenameClause) {\n-                Catalog.getCurrentCatalog().renameRollup(db, table, (RollupRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof PartitionRenameClause) {\n-                Catalog.getCurrentCatalog().renamePartition(db, table, (PartitionRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof ColumnRenameClause) {\n-                Catalog.getCurrentCatalog().renameColumn(db, table, (ColumnRenameClause) alterClause);\n+                db.writeLock();\n+                table.writeLock();\n+                try {\n+                    Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n+                } finally {\n+                    table.writeUnlock();\n+                    db.writeUnlock();\n+                }\n                 break;\n             } else {\n-                Preconditions.checkState(false);\n+                table.writeLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 435}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyMTkzNQ==", "bodyText": "Put lock inside the method", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530321935", "createdAt": "2020-11-25T12:01:34Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -476,27 +464,48 @@ public void processAlterCluster(AlterSystemStmt stmt) throws UserException {\n     private void processRename(Database db, OlapTable table, List<AlterClause> alterClauses) throws DdlException {\n         for (AlterClause alterClause : alterClauses) {\n             if (alterClause instanceof TableRenameClause) {\n-                Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof RollupRenameClause) {\n-                Catalog.getCurrentCatalog().renameRollup(db, table, (RollupRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof PartitionRenameClause) {\n-                Catalog.getCurrentCatalog().renamePartition(db, table, (PartitionRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof ColumnRenameClause) {\n-                Catalog.getCurrentCatalog().renameColumn(db, table, (ColumnRenameClause) alterClause);\n+                db.writeLock();\n+                table.writeLock();\n+                try {\n+                    Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n+                } finally {\n+                    table.writeUnlock();\n+                    db.writeUnlock();\n+                }\n                 break;\n             } else {\n-                Preconditions.checkState(false);\n+                table.writeLock();\n+                try {\n+                    if (alterClause instanceof RollupRenameClause) {\n+                        Catalog.getCurrentCatalog().renameRollup(db, table, (RollupRenameClause) alterClause);\n+                        break;\n+                    } else if (alterClause instanceof PartitionRenameClause) {\n+                        Catalog.getCurrentCatalog().renamePartition(db, table, (PartitionRenameClause) alterClause);\n+                        break;\n+                    } else if (alterClause instanceof ColumnRenameClause) {\n+                        Catalog.getCurrentCatalog().renameColumn(db, table, (ColumnRenameClause) alterClause);\n+                        break;\n+                    } else {\n+                        Preconditions.checkState(false);\n+                    }\n+                } finally {\n+                    table.writeUnlock();\n+                }\n             }\n         }\n     }\n \n     private void processRename(Database db, Table table, List<AlterClause> alterClauses) throws DdlException {\n         for (AlterClause alterClause : alterClauses) {\n             if (alterClause instanceof TableRenameClause) {\n-                Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n+                db.writeLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 460}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyNzUyMA==", "bodyText": "Why lock again?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530327520", "createdAt": "2020-11-25T12:11:56Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "diffHunk": "@@ -722,14 +732,21 @@ public void processBatchDropRollup(List<AlterClause> dropRollupClauses, Database\n             editLog.logBatchDropRollup(new BatchDropInfo(dbId, tableId, indexIdSet));\n             LOG.info(\"finished drop rollup index[{}] in table[{}]\", String.join(\"\", rollupNameSet), olapTable.getName());\n         } finally {\n-            db.writeUnlock();\n+            olapTable.writeUnlock();\n         }\n     }\n \n     public void processDropMaterializedView(DropMaterializedViewStmt dropMaterializedViewStmt, Database db,\n             OlapTable olapTable) throws DdlException, MetaNotFoundException {\n-        Preconditions.checkState(db.isWriteLockHeldByCurrentThread());\n+        Preconditions.checkState(olapTable.isWriteLockHeldByCurrentThread());\n+        olapTable.writeLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMzODgxMg==", "bodyText": "Why not using getOrThrowException?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530338812", "createdAt": "2020-11-25T12:31:49Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/backup/BackupHandler.java", "diffHunk": "@@ -274,25 +274,25 @@ private void backup(Repository repository, Database db, BackupStmt stmt) throws\n         // This is just a pre-check to avoid most of invalid backup requests.\n         // Also calculate the signature for incremental backup check.\n         List<TableRef> tblRefs = stmt.getTableRefs();\n-        BackupMeta curBackupMeta = null;\n-        db.readLock();\n-        try {\n-            List<Table> backupTbls = Lists.newArrayList();\n-            for (TableRef tblRef : tblRefs) {\n-                String tblName = tblRef.getName().getTbl();\n-                Table tbl = db.getTable(tblName);\n-                if (tbl == null) {\n-                    ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tblName);\n-                }\n-                if (tbl.getType() != TableType.OLAP) {\n-                    ErrorReport.reportDdlException(ErrorCode.ERR_NOT_OLAP_TABLE, tblName);\n-                }\n \n-                OlapTable olapTbl = (OlapTable) tbl;\n+        List<Table> backupTbls = Lists.newArrayList();\n+        for (TableRef tblRef : tblRefs) {\n+            String tblName = tblRef.getName().getTbl();\n+            Table tbl = db.getTable(tblName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM0Nzk3OA==", "bodyText": "We can use db.createTableWithLock()", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530347978", "createdAt": "2020-11-25T12:46:59Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/backup/RestoreJob.java", "diffHunk": "@@ -664,18 +667,25 @@ private void checkAndPrepareMeta() {\n                                 remoteDataProperty, (short) restoreReplicationNum,\n                                 remotePartitionInfo.getIsInMemory(remotePartId));\n                         localTbl.addPartition(restoredPart);\n+                    } finally {\n+                        localTbl.writeUnlock();\n                     }\n \n-                    // add restored tables\n-                    for (OlapTable tbl : restoredTbls) {\n+                }\n+\n+                // add restored tables\n+                for (OlapTable tbl : restoredTbls) {\n+                    db.writeLock();\n+                    try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 297}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM0OTE2Mw==", "bodyText": "Use db.dropTableWithLock()", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530349163", "createdAt": "2020-11-25T12:49:03Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/backup/RestoreJob.java", "diffHunk": "@@ -1347,42 +1374,53 @@ public void cancelInternal(boolean isReplay) {\n         // clean restored objs\n         Database db = catalog.getDb(dbId);\n         if (db != null) {\n-            db.writeLock();\n-            try {\n-                // rollback table's state to NORMAL\n-                setTableStateToNormal(db);\n+            // rollback table's state to NORMAL\n+            setTableStateToNormal(db);\n \n-                // remove restored tbls\n-                for (OlapTable restoreTbl : restoredTbls) {\n-                    LOG.info(\"remove restored table when cancelled: {}\", restoreTbl.getName());\n+            // remove restored tbls\n+            for (OlapTable restoreTbl : restoredTbls) {\n+                LOG.info(\"remove restored table when cancelled: {}\", restoreTbl.getName());\n+                restoreTbl.writeLock();\n+                try {\n                     for (Partition part : restoreTbl.getPartitions()) {\n                         for (MaterializedIndex idx : part.getMaterializedIndices(IndexExtState.VISIBLE)) {\n                             for (Tablet tablet : idx.getTablets()) {\n                                 Catalog.getCurrentInvertedIndex().deleteTablet(tablet.getId());\n                             }\n                         }\n                     }\n+                } finally {\n+                    restoreTbl.writeUnlock();\n+                }\n+                db.writeLock();\n+                try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 674}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM1MzA0OQ==", "bodyText": "Is it safe to write db without lock?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530353049", "createdAt": "2020-11-25T12:55:13Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -2043,12 +2044,7 @@ public long saveDb(DataOutputStream dos, long checksum) throws IOException {\n             // Don't write information_schema db meta\n             if (!InfoSchemaDb.isInfoSchemaDb(dbName)) {\n                 checksum ^= entry.getKey();\n-                db.readLock();\n-                try {\n-                    db.write(dos);\n-                } finally {\n-                    db.readUnlock();\n-                }\n+                db.write(dos);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM5Mzg2Mg==", "bodyText": "Does checkPartitionNameExist  need table lock?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530393862", "createdAt": "2020-11-25T13:59:53Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -6673,86 +6680,75 @@ public void convertDistributionType(Database db, OlapTable tbl) throws DdlExcept\n             editLog.logModifyDistributionType(tableInfo);\n             LOG.info(\"finished to modify distribution type of table: \" + tbl.getName());\n         } finally {\n-            db.writeUnlock();\n+            tbl.writeUnlock();\n         }\n     }\n \n     public void replayConvertDistributionType(TableInfo tableInfo) {\n         Database db = getDb(tableInfo.getDbId());\n-        db.writeLock();\n+        OlapTable tbl = (OlapTable) db.getTable(tableInfo.getTableId());\n+        if (tbl == null) {\n+            return;\n+        }\n+        tbl.writeLock();\n         try {\n-            OlapTable tbl = (OlapTable) db.getTable(tableInfo.getTableId());\n             tbl.convertRandomDistributionToHashDistribution();\n             LOG.info(\"replay modify distribution type of table: \" + tbl.getName());\n         } finally {\n-            db.writeUnlock();\n+            tbl.writeUnlock();\n         }\n     }\n \n     /*\n      * The entry of replacing partitions with temp partitions.\n      */\n-    public void replaceTempPartition(Database db, String tableName, ReplacePartitionClause clause) throws DdlException {\n+    public void replaceTempPartition(Database db, OlapTable olapTable, ReplacePartitionClause clause) throws DdlException {\n+        Preconditions.checkState(olapTable.isWriteLockHeldByCurrentThread());\n         List<String> partitionNames = clause.getPartitionNames();\n         List<String> tempPartitionNames = clause.getTempPartitionNames();\n         boolean isStrictRange = clause.isStrictRange();\n         boolean useTempPartitionName = clause.useTempPartitionName();\n-        db.writeLock();\n-        try {\n-            Table table = db.getTable(tableName);\n-            if (table == null) {\n-                ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n-            }\n-\n-            if (table.getType() != TableType.OLAP) {\n-                throw new DdlException(\"Table[\" + tableName + \"] is not OLAP table\");\n+        // check partition exist\n+        for (String partName : partitionNames) {\n+            if (!olapTable.checkPartitionNameExist(partName, false)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 1001}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM5NDA1OQ==", "bodyText": "Does replaceTempPartitions need table lock?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530394059", "createdAt": "2020-11-25T14:00:07Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -6673,86 +6680,75 @@ public void convertDistributionType(Database db, OlapTable tbl) throws DdlExcept\n             editLog.logModifyDistributionType(tableInfo);\n             LOG.info(\"finished to modify distribution type of table: \" + tbl.getName());\n         } finally {\n-            db.writeUnlock();\n+            tbl.writeUnlock();\n         }\n     }\n \n     public void replayConvertDistributionType(TableInfo tableInfo) {\n         Database db = getDb(tableInfo.getDbId());\n-        db.writeLock();\n+        OlapTable tbl = (OlapTable) db.getTable(tableInfo.getTableId());\n+        if (tbl == null) {\n+            return;\n+        }\n+        tbl.writeLock();\n         try {\n-            OlapTable tbl = (OlapTable) db.getTable(tableInfo.getTableId());\n             tbl.convertRandomDistributionToHashDistribution();\n             LOG.info(\"replay modify distribution type of table: \" + tbl.getName());\n         } finally {\n-            db.writeUnlock();\n+            tbl.writeUnlock();\n         }\n     }\n \n     /*\n      * The entry of replacing partitions with temp partitions.\n      */\n-    public void replaceTempPartition(Database db, String tableName, ReplacePartitionClause clause) throws DdlException {\n+    public void replaceTempPartition(Database db, OlapTable olapTable, ReplacePartitionClause clause) throws DdlException {\n+        Preconditions.checkState(olapTable.isWriteLockHeldByCurrentThread());\n         List<String> partitionNames = clause.getPartitionNames();\n         List<String> tempPartitionNames = clause.getTempPartitionNames();\n         boolean isStrictRange = clause.isStrictRange();\n         boolean useTempPartitionName = clause.useTempPartitionName();\n-        db.writeLock();\n-        try {\n-            Table table = db.getTable(tableName);\n-            if (table == null) {\n-                ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n-            }\n-\n-            if (table.getType() != TableType.OLAP) {\n-                throw new DdlException(\"Table[\" + tableName + \"] is not OLAP table\");\n+        // check partition exist\n+        for (String partName : partitionNames) {\n+            if (!olapTable.checkPartitionNameExist(partName, false)) {\n+                throw new DdlException(\"Partition[\" + partName + \"] does not exist\");\n             }\n-\n-            OlapTable olapTable = (OlapTable) table;\n-            // check partition exist\n-            for (String partName : partitionNames) {\n-                if (!olapTable.checkPartitionNameExist(partName, false)) {\n-                    throw new DdlException(\"Partition[\" + partName + \"] does not exist\");\n-                }\n-            }\n-            for (String partName : tempPartitionNames) {\n-                if (!olapTable.checkPartitionNameExist(partName, true)) {\n-                    throw new DdlException(\"Temp partition[\" + partName + \"] does not exist\");\n-                }\n+        }\n+        for (String partName : tempPartitionNames) {\n+            if (!olapTable.checkPartitionNameExist(partName, true)) {\n+                throw new DdlException(\"Temp partition[\" + partName + \"] does not exist\");\n             }\n-\n-            olapTable.replaceTempPartitions(partitionNames, tempPartitionNames, isStrictRange, useTempPartitionName);\n-\n-            // write log\n-            ReplacePartitionOperationLog info = new ReplacePartitionOperationLog(db.getId(), olapTable.getId(),\n-                    partitionNames, tempPartitionNames, isStrictRange, useTempPartitionName);\n-            editLog.logReplaceTempPartition(info);\n-            LOG.info(\"finished to replace partitions {} with temp partitions {} from table: {}\",\n-                    clause.getPartitionNames(), clause.getTempPartitionNames(), tableName);\n-        } finally {\n-            db.writeUnlock();\n         }\n+        olapTable.replaceTempPartitions(partitionNames, tempPartitionNames, isStrictRange, useTempPartitionName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 1033}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQwNDQ4OA==", "bodyText": "is it safe to markGroupStable/markGroupUnstable outside the lock?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530404488", "createdAt": "2020-11-25T14:15:30Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/clone/ColocateTableBalancer.java", "diffHunk": "@@ -233,16 +232,16 @@ private void matchGroup() {\n                             }\n                         }\n                     }\n-                } // end for tables\n-\n-                // mark group as stable or unstable\n-                if (isGroupStable) {\n-                    colocateIndex.markGroupStable(groupId, true);\n-                } else {\n-                    colocateIndex.markGroupUnstable(groupId, true);\n+                } finally {\n+                    olapTable.readUnlock();\n                 }\n-            } finally {\n-                db.readUnlock();\n+            } // end for tables\n+\n+            // mark group as stable or unstable\n+            if (isGroupStable) {\n+                colocateIndex.markGroupStable(groupId, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwNDIxMA==", "bodyText": "I think we should hold the table's readLock before checking table' state", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531104210", "createdAt": "2020-11-26T15:32:30Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/Load.java", "diffHunk": "@@ -398,7 +398,7 @@ private void addLoadJob(LoadJob job, Database db) throws DdlException {\n         }\n \n         // check if table is in restore process\n-        db.readLock();\n+        readLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwNjQ4OA==", "bodyText": "The lock order is wrong.\nthe origin lock order is db lock -> 'load lock'.\nBut here you use 'table lock' -> 'load lock'", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531106488", "createdAt": "2020-11-26T15:36:13Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/Load.java", "diffHunk": "@@ -3229,19 +3234,19 @@ public void unprotectDelete(DeleteInfo deleteInfo, Database db) {\n \n     public void replayFinishAsyncDeleteJob(AsyncDeleteJob deleteJob, Catalog catalog) {\n         Database db = catalog.getDb(deleteJob.getDbId());\n-        db.writeLock();\n+        writeLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 243}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwNzAzMQ==", "bodyText": "All other place in Load.java should also be checked again.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531107031", "createdAt": "2020-11-26T15:37:09Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/Load.java", "diffHunk": "@@ -3229,19 +3234,19 @@ public void unprotectDelete(DeleteInfo deleteInfo, Database db) {\n \n     public void replayFinishAsyncDeleteJob(AsyncDeleteJob deleteJob, Catalog catalog) {\n         Database db = catalog.getDb(deleteJob.getDbId());\n-        db.writeLock();\n+        writeLock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwNjQ4OA=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 243}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwODY4NQ==", "bodyText": "This part should be protected by lock", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531108685", "createdAt": "2020-11-26T15:40:01Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/LoadChecker.java", "diffHunk": "@@ -565,18 +568,14 @@ private void runOneQuorumFinishedDeleteJob(AsyncDeleteJob job) {\n             load.removeDeleteJobAndSetState(job);\n             return;\n         }\n-        db.readLock();\n-        try {\n-            // if the delete job is quorum finished, just set it to finished\n-            job.clearTasks();\n-            job.setState(DeleteState.FINISHED);\n-            // log\n-            Catalog.getCurrentCatalog().getEditLog().logFinishAsyncDelete(job);\n-            load.removeDeleteJobAndSetState(job);\n-            LOG.info(\"delete job {} finished\", job.getJobId());\n-        } finally {\n-            db.readUnlock();\n-        }\n+\n+        // if the delete job is quorum finished, just set it to finished\n+        job.clearTasks();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTExMzM4OA==", "bodyText": "In origin implementation, this prepareTablePartitionInfos and following logic is within same db lock.\nBut now you put them into 2 lock phases, which becomes not atomic.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531113388", "createdAt": "2020-11-26T15:48:30Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/loadv2/SparkLoadPendingTask.java", "diffHunk": "@@ -133,13 +136,18 @@ private void createEtlJobConf() throws LoadException {\n         }\n \n         Map<Long, EtlTable> tables = Maps.newHashMap();\n-        db.readLock();\n+        Map<Long, Set<Long>> tableIdToPartitionIds = Maps.newHashMap();\n+        Set<Long> allPartitionsTableIds = Sets.newHashSet();\n+        prepareTablePartitionInfos(db, tableIdToPartitionIds, allPartitionsTableIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTMyODI3Ng==", "bodyText": "Why this license is different?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531328276", "createdAt": "2020-11-27T01:53:17Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/master/ReportHandler.java", "diffHunk": "@@ -14,6 +14,22 @@\n // KIND, either express or implied.  See the License for the\n // specific language governing permissions and limitations\n // under the License.\n+// Licensed to the Apache Software Foundation (ASF) under one", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTMzMzU4Mg==", "bodyText": "Are you sure this can get table list in order?\nI think it is more safe and clear to change tableMap to tableList, and sort the tableList explicitly.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531333582", "createdAt": "2020-11-27T01:59:05Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/qe/StmtExecutor.java", "diffHunk": "@@ -456,23 +437,23 @@ public void analyze(TQueryOptions tQueryOptions) throws UserException {\n         if (parsedStmt instanceof QueryStmt\n                 || parsedStmt instanceof InsertStmt\n                 || parsedStmt instanceof CreateTableAsSelectStmt) {\n-            Map<String, Database> dbs = Maps.newTreeMap();\n+            Map<Long, Table> tableMap = Maps.newTreeMap();\n             QueryStmt queryStmt;\n             Set<String> parentViewNameSet = Sets.newHashSet();\n             if (parsedStmt instanceof QueryStmt) {\n                 queryStmt = (QueryStmt) parsedStmt;\n-                queryStmt.getDbs(analyzer, dbs, parentViewNameSet);\n+                queryStmt.getTables(analyzer, tableMap, parentViewNameSet);\n             } else {\n                 InsertStmt insertStmt;\n                 if (parsedStmt instanceof InsertStmt) {\n                     insertStmt = (InsertStmt) parsedStmt;\n                 } else {\n                     insertStmt = ((CreateTableAsSelectStmt) parsedStmt).getInsertStmt();\n                 }\n-                insertStmt.getDbs(analyzer, dbs, parentViewNameSet);\n+                insertStmt.getTables(analyzer, tableMap, parentViewNameSet);\n             }\n-\n-            lock(dbs);\n+            List<Table> tables = Lists.newArrayList(tableMap.values());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM0MDM5MA==", "bodyText": "In original implementation, we use db locks to ensure mutual exclusion and order.\nSo here we may still need to add table locks.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531340390", "createdAt": "2020-11-27T02:06:42Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/system/SystemInfoService.java", "diffHunk": "@@ -894,18 +893,8 @@ public long getBackendReportVersion(long backendId) {\n     public void updateBackendReportVersion(long backendId, long newReportVersion, long dbId) {\n         AtomicLong atomicLong = null;\n         if ((atomicLong = idToReportVersionRef.get(backendId)) != null) {\n-            Database db = Catalog.getCurrentCatalog().getDb(dbId);\n-            if (db != null) {\n-                db.readLock();\n-                try {\n-                    atomicLong.set(newReportVersion);\n-                    LOG.debug(\"update backend {} report version: {}, db: {}\", backendId, newReportVersion, dbId);\n-                } finally {\n-                    db.readUnlock();\n-                }\n-            } else {\n-                LOG.warn(\"failed to update backend report version, db {} does not exist\", dbId);\n-            }\n+            atomicLong.set(newReportVersion);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM0NjA3Mw==", "bodyText": "Table's lock should be held to call method like createEtlPartitions()", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531346073", "createdAt": "2020-11-27T02:13:07Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/task/HadoopLoadPendingTask.java", "diffHunk": "@@ -70,41 +70,41 @@ public HadoopLoadPendingTask(LoadJob job) {\n \n     @Override\n     protected void createEtlRequest() throws Exception {\n-        db.readLock();\n-        try {\n-            EtlTaskConf taskConf = new EtlTaskConf();\n-            // output path\n-            taskConf.setOutputPath(getOutputPath());\n-            // output file pattern\n-            taskConf.setOutputFilePattern(job.getLabel() + \".%(table)s.%(view)s.%(bucket)s\");\n-            // tables (partitions)\n-            Map<String, EtlPartitionConf> etlPartitions = createEtlPartitions();\n-            Preconditions.checkNotNull(etlPartitions);\n-            taskConf.setEtlPartitions(etlPartitions);\n+        EtlTaskConf taskConf = new EtlTaskConf();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM1MDYyOA==", "bodyText": "Is it more safe to lock all tables at once outside the for loop?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531350628", "createdAt": "2020-11-27T02:23:49Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/transaction/PublishVersionDaemon.java", "diffHunk": "@@ -190,16 +190,18 @@ private void publishVersion() throws UserException {\n                             LOG.warn(\"Database [{}] has been dropped.\", transactionState.getDbId());\n                             continue;\n                         }\n-                        db.readLock();\n-                        try {\n-                            for (int i = 0; i < transactionState.getTableIdList().size(); i++) {\n-                                long tableId = transactionState.getTableIdList().get(i);\n-                                Table table = db.getTable(tableId);\n-                                if (table == null || table.getType() != Table.TableType.OLAP) {\n-                                    LOG.warn(\"Table [{}] in database [{}] has been dropped.\", tableId, db.getFullName());\n-                                    continue;\n-                                }\n-                                OlapTable olapTable = (OlapTable) table;\n+\n+\n+                        for (int i = 0; i < transactionState.getTableIdList().size(); i++) {\n+                            long tableId = transactionState.getTableIdList().get(i);\n+                            Table table = db.getTable(tableId);\n+                            if (table == null || table.getType() != Table.TableType.OLAP) {\n+                                LOG.warn(\"Table [{}] in database [{}] has been dropped.\", tableId, db.getFullName());\n+                                continue;\n+                            }\n+                            OlapTable olapTable = (OlapTable) table;\n+                            olapTable.readLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a10c9c373832c14e1930dae95525477eca39b63", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/3a10c9c373832c14e1930dae95525477eca39b63", "committedDate": "2020-11-29T09:18:40Z", "message": "change db level lock to table lock level in http2"}, "afterCommit": {"oid": "614434768adc5e6b6d22de43727d57ea3225f2d1", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/614434768adc5e6b6d22de43727d57ea3225f2d1", "committedDate": "2020-11-30T14:11:42Z", "message": "change db level lock to table lock level in http2"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "614434768adc5e6b6d22de43727d57ea3225f2d1", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/614434768adc5e6b6d22de43727d57ea3225f2d1", "committedDate": "2020-11-30T14:11:42Z", "message": "change db level lock to table lock level in http2"}, "afterCommit": {"oid": "1485ab037fa195b539fa0efa342e0e3ef9474722", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/1485ab037fa195b539fa0efa342e0e3ef9474722", "committedDate": "2020-12-02T07:38:51Z", "message": "Fix broker load failed bug and add unit test for db"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzODUyNDE3", "url": "https://github.com/apache/incubator-doris/pull/3775#pullrequestreview-543852417", "createdAt": "2020-12-03T11:19:22Z", "commit": {"oid": "0df43a0c0b8586ee3b73f579bac1a348485b5d8c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMToxOToyM1rOH-VV8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMToxOToyM1rOH-VV8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTEyMzQ0MA==", "bodyText": "I find a corner case as below:\nThere are three threads wants to get table lock:\nT1(thread 1) try lock(TableA,TableB)\nT2(thread 2) try lock(TableB,TableC)\nT3(thread 3) try lock(TableC,TableA)\nIf T1 get TableA's lock  and T2 get TableB's lock and T3 get TableC's lock at the same time ,\nThen three threads try get next table's lock ,dead lock happends.\nT1 try lock TableB, but TableB is held by T2.\nT2 try lock TableC,but TableC is held by T3.\nT3 try lock TableA,but TableA is held by T1.\nCan the current implementation solve this case?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r535123440", "createdAt": "2020-12-03T11:19:23Z", "author": {"login": "wangbo"}, "path": "fe/fe-core/src/main/java/org/apache/doris/common/util/MetaLockUtils.java", "diffHunk": "@@ -0,0 +1,76 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.common.util;\n+\n+import org.apache.doris.catalog.Database;\n+import org.apache.doris.catalog.Table;\n+\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+public class MetaLockUtils {\n+\n+    public static void readLockDatabases(List<Database> databaseList) {\n+        for (Database database : databaseList) {\n+            database.readLock();\n+        }\n+    }\n+\n+    public static void readUnlockDatabases(List<Database> databaseList) {\n+        for (int i = databaseList.size() - 1; i >= 0; i--) {\n+            databaseList.get(i).readUnlock();\n+        }\n+    }\n+\n+    public static void readLockTables(List<Table> tableList) {\n+        for (Table table : tableList) {\n+            table.readLock();\n+        }\n+    }\n+\n+    public static void readUnlockTables(List<Table> tableList) {\n+        for (int i = tableList.size() - 1; i >= 0; i--) {\n+            tableList.get(i).readUnlock();\n+        }\n+    }\n+\n+    public static void writeLockTables(List<Table> tableList) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0df43a0c0b8586ee3b73f579bac1a348485b5d8c"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0OTE4OTA0", "url": "https://github.com/apache/incubator-doris/pull/3775#pullrequestreview-544918904", "createdAt": "2020-12-04T12:33:04Z", "commit": {"oid": "17c0d45cad336510b52957be02bc50cfc6499cc1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMjozMzowNVrOH_O8Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMjozMzowNVrOH_O8Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2NzEwMg==", "bodyText": "When drop a table from database, a db lock will be held;\nWhy not get a db read lock here when get a table from database.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r536067102", "createdAt": "2020-12-04T12:33:05Z", "author": {"login": "wangbo"}, "path": "fe/fe-core/src/main/java/org/apache/doris/clone/DynamicPartitionScheduler.java", "diffHunk": "@@ -265,17 +265,16 @@ private void executeDynamicPartition() {\n             String tableName;\n             boolean skipAddPartition = false;\n             OlapTable olapTable;\n-            db.readLock();\n+            olapTable = (OlapTable) db.getTable(tableId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17c0d45cad336510b52957be02bc50cfc6499cc1"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "17c0d45cad336510b52957be02bc50cfc6499cc1", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/17c0d45cad336510b52957be02bc50cfc6499cc1", "committedDate": "2020-12-03T12:45:25Z", "message": "Add some comment for the usage of MetaLockUtils"}, "afterCommit": {"oid": "1a02c135df7f569172863429628b7083cb129526", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/1a02c135df7f569172863429628b7083cb129526", "committedDate": "2020-12-28T02:55:13Z", "message": "Add some comment for the usage of MetaLockUtils"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4aeabefc18ad96d8fffb9f9d87facbb69a50a95b", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/4aeabefc18ad96d8fffb9f9d87facbb69a50a95b", "committedDate": "2020-12-31T14:58:22Z", "message": "fix bug for npe"}, "afterCommit": {"oid": "29ac965acaf01113e86a761b691ac80ed4b975df", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/29ac965acaf01113e86a761b691ac80ed4b975df", "committedDate": "2021-01-11T07:02:25Z", "message": "apply fix patch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a982111ccca73b5109127e5f61d7da4cfe5e1dfd", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/a982111ccca73b5109127e5f61d7da4cfe5e1dfd", "committedDate": "2021-01-12T07:58:06Z", "message": "Support table level read and write lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "944f9dc89e5f8f6b432f56417bb25867d8edb5a7", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/944f9dc89e5f8f6b432f56417bb25867d8edb5a7", "committedDate": "2021-01-12T07:58:06Z", "message": "Use table lock to replace db lock in some functions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08a71144348ed496cd7aee8a9c488cd2ac7d9eba", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/08a71144348ed496cd7aee8a9c488cd2ac7d9eba", "committedDate": "2021-01-12T07:58:06Z", "message": "use table write lock to replace db write lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5118571e4dd32ef905250d6e654121cc0a4ee448", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/5118571e4dd32ef905250d6e654121cc0a4ee448", "committedDate": "2021-01-12T07:58:06Z", "message": "remove some unused temp code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1354d056e8218bd394f58ad03ee05baa38b81385", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/1354d056e8218bd394f58ad03ee05baa38b81385", "committedDate": "2021-01-12T07:58:06Z", "message": "use table lock to replace db lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cffcbbd2d4b384372321dd4061cf3b8395892744", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/cffcbbd2d4b384372321dd4061cf3b8395892744", "committedDate": "2021-01-12T07:58:06Z", "message": "Continue to use table lock to replace db lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3763e582f230a76dd6b62fe6392b4a8929f433cb", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/3763e582f230a76dd6b62fe6392b4a8929f433cb", "committedDate": "2021-01-12T07:58:06Z", "message": "finish to replace db lock by table lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e13b952a7a3870928d268595b88d6794d78980eb", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/e13b952a7a3870928d268595b88d6794d78980eb", "committedDate": "2021-01-12T07:58:06Z", "message": "fix unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2ff4432eaee19d879f6a0547fc37cb929f124cf", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/c2ff4432eaee19d879f6a0547fc37cb929f124cf", "committedDate": "2021-01-12T07:58:06Z", "message": "add null check for olap_table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06467838b7186d8a8bbc3231163f5e3e9ad12888", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/06467838b7186d8a8bbc3231163f5e3e9ad12888", "committedDate": "2021-01-12T07:58:06Z", "message": "fix merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6481957664ef0b81e8652bd2ac646b8c2739de8", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/f6481957664ef0b81e8652bd2ac646b8c2739de8", "committedDate": "2021-01-12T07:58:06Z", "message": "modify .gitignore content"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd9952d3c6008585558dbb02090a35629bc7dbbc", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/dd9952d3c6008585558dbb02090a35629bc7dbbc", "committedDate": "2021-01-12T07:58:06Z", "message": "fix Alter Class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d98756ee42101b52fb95bf88bf27d3d6a5514901", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/d98756ee42101b52fb95bf88bf27d3d6a5514901", "committedDate": "2021-01-12T07:58:06Z", "message": "Fix AlterJobV2 and MaterializedViewHandler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ec9c842c13b96fead044b41d6e29a7c8eaf0c13", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/6ec9c842c13b96fead044b41d6e29a7c8eaf0c13", "committedDate": "2021-01-12T07:58:06Z", "message": "Fix RollupJob"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "721a8400d03c4ffe994227121fc9d896ba399de4", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/721a8400d03c4ffe994227121fc9d896ba399de4", "committedDate": "2021-01-12T07:58:06Z", "message": "fix RollupJobV2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f76aa9b09a9aa13b0962d9ee860e029ad00733ab", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/f76aa9b09a9aa13b0962d9ee860e029ad00733ab", "committedDate": "2021-01-12T07:58:06Z", "message": "fix cancel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61676849d04888c74f9fa151e62dabf56bf24efc", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/61676849d04888c74f9fa151e62dabf56bf24efc", "committedDate": "2021-01-12T07:58:06Z", "message": "fix SchemaChangeJobV2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a25bb5888479a043b8dd30805b9ef78031d38e7a", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/a25bb5888479a043b8dd30805b9ef78031d38e7a", "committedDate": "2021-01-12T07:58:06Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92dfd35fbceb7fc46c7a5e9668ecc91f74fde901", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/92dfd35fbceb7fc46c7a5e9668ecc91f74fde901", "committedDate": "2021-01-12T07:58:06Z", "message": "fix DeleteHandler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e40783a3372612be4a90ed2c0d409d026069ea3e", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/e40783a3372612be4a90ed2c0d409d026069ea3e", "committedDate": "2021-01-12T07:58:06Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "746e85a246838eac7e8853a4afad81b464c1c987", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/746e85a246838eac7e8853a4afad81b464c1c987", "committedDate": "2021-01-12T07:58:06Z", "message": "fix conflict after rebasing mater"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c824f7cb93e54931dd8a62b5405779b33cfb4d5a", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/c824f7cb93e54931dd8a62b5405779b33cfb4d5a", "committedDate": "2021-01-12T07:58:06Z", "message": "fix ReportHandler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a57f8d08fe4abda7bc8b01442fba6b9cee63140", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/3a57f8d08fe4abda7bc8b01442fba6b9cee63140", "committedDate": "2021-01-12T07:58:06Z", "message": "fix unit test failed for AlterTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9357dc0d0dcb666f2081a7849f8a94e50e5ed8e4", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/9357dc0d0dcb666f2081a7849f8a94e50e5ed8e4", "committedDate": "2021-01-12T07:58:06Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "461335b5aba98ad2918f79adb775e335d95c63cc", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/461335b5aba98ad2918f79adb775e335d95c63cc", "committedDate": "2021-01-12T07:58:06Z", "message": "Add MetaLockUtils and fix some table lock level"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40f5cf1ce1e0bd078a23d0d761772b14e1b32b0d", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/40f5cf1ce1e0bd078a23d0d761772b14e1b32b0d", "committedDate": "2021-01-12T07:58:06Z", "message": "Fix unittest for AlterTest failed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3c287cd6d10023fd1f2117eb4fccb591e8d09f2", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/d3c287cd6d10023fd1f2117eb4fccb591e8d09f2", "committedDate": "2021-01-12T07:58:07Z", "message": "Change db level lock to table level lock for query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1860b70ce5b2a90777bc9fef4dd1159230c322a1", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/1860b70ce5b2a90777bc9fef4dd1159230c322a1", "committedDate": "2021-01-12T07:58:07Z", "message": "fix unittest failed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46b8d0459dd33f4c654f86a876194db0fb34edfe", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/46b8d0459dd33f4c654f86a876194db0fb34edfe", "committedDate": "2021-01-12T07:58:07Z", "message": "fix conflict for table lock and db lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc877535de1d0b0f5bb8d97a8547de82ff27464c", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/dc877535de1d0b0f5bb8d97a8547de82ff27464c", "committedDate": "2021-01-12T07:58:07Z", "message": "fix unittest failed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07d7314e8cf12fc2840a980397b23a33ae5738b0", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/07d7314e8cf12fc2840a980397b23a33ae5738b0", "committedDate": "2021-01-12T07:58:07Z", "message": "fix unit test failed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a983540b048297f5d793f2c3d52e4d2e153aa65", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/6a983540b048297f5d793f2c3d52e4d2e153aa65", "committedDate": "2021-01-12T07:58:07Z", "message": "Fix SparkLoadJobTest Failed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3b30a75c7377053dd3881618264c8d081d9d70b", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/b3b30a75c7377053dd3881618264c8d081d9d70b", "committedDate": "2021-01-12T07:58:07Z", "message": "Fix save image lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "619b71cb15599bd9a015155d1922df56a770957f", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/619b71cb15599bd9a015155d1922df56a770957f", "committedDate": "2021-01-12T07:58:07Z", "message": "Add unit test for MetaLockUtils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fb1e329c56a993c609335368f3fa660dd32f357", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/8fb1e329c56a993c609335368f3fa660dd32f357", "committedDate": "2021-01-12T07:58:07Z", "message": "use MetadataLockUtils to lock table when finish transaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11e4e07052268206f44aeb85cb67814d2f7fbaa3", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/11e4e07052268206f44aeb85cb67814d2f7fbaa3", "committedDate": "2021-01-12T07:58:07Z", "message": "remove useless code of dropTableWithLock for Database"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b089e40d678926205811ecdedd56f8c60c20ec7", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/1b089e40d678926205811ecdedd56f8c60c20ec7", "committedDate": "2021-01-12T07:58:07Z", "message": "remove useless db read lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "841d3f88daba40579d5d44a5f6130d4e136f0c1d", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/841d3f88daba40579d5d44a5f6130d4e136f0c1d", "committedDate": "2021-01-12T07:58:07Z", "message": "remove useless db read lock and change some db read lock to table locks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "520cd273fdb196ad5eae1f21f9ffcb63c76100d2", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/520cd273fdb196ad5eae1f21f9ffcb63c76100d2", "committedDate": "2021-01-12T07:58:07Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2faf9d395b0c70a61900442cdcb576089ccdf10", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/a2faf9d395b0c70a61900442cdcb576089ccdf10", "committedDate": "2021-01-12T07:58:07Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26f39d1f923bf52f25ec15c09ea5775ad4590524", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/26f39d1f923bf52f25ec15c09ea5775ad4590524", "committedDate": "2021-01-12T07:58:07Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e518f1e1cd4a5b05298cd5ff0f15f0feffc4ff33", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/e518f1e1cd4a5b05298cd5ff0f15f0feffc4ff33", "committedDate": "2021-01-12T07:58:07Z", "message": "Fix dead lock bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7563bfbc0b0bc4f684071050f8ef3ad834fad909", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/7563bfbc0b0bc4f684071050f8ef3ad834fad909", "committedDate": "2021-01-12T07:58:07Z", "message": "fix unit test failed for SelectStmt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dfc2f8612383ac395cd8b8d0665aa935f74c330", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/7dfc2f8612383ac395cd8b8d0665aa935f74c330", "committedDate": "2021-01-12T07:58:07Z", "message": "Fix by review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63195339ad1ba0ee1598eb3511b03744ae0d0564", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/63195339ad1ba0ee1598eb3511b03744ae0d0564", "committedDate": "2021-01-12T07:58:07Z", "message": "Add table lock when update BackendReportVersion in SystemInfoService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bb19a231982f4fed54f1dfdc71c518a47c0b2c0", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/8bb19a231982f4fed54f1dfdc71c518a47c0b2c0", "committedDate": "2021-01-12T07:58:07Z", "message": "change db level lock to table lock level in http2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4b680790f1548548ef350b2b8efb091b9d13faf", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/b4b680790f1548548ef350b2b8efb091b9d13faf", "committedDate": "2021-01-12T07:58:07Z", "message": "Fix broker load failed bug and add unit test for db"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2f55d756fa12b888cf44d69eaa30a58342b3d26", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/b2f55d756fa12b888cf44d69eaa30a58342b3d26", "committedDate": "2021-01-12T07:58:07Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "faa6eb24a1d5a4bff4aed3202c8c468fd667f07c", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/faa6eb24a1d5a4bff4aed3202c8c468fd667f07c", "committedDate": "2021-01-12T07:58:07Z", "message": "Add some comment for the usage of MetaLockUtils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56b8d3159e8fde9a54a0e6cfca43c970aa0ee51f", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/56b8d3159e8fde9a54a0e6cfca43c970aa0ee51f", "committedDate": "2021-01-12T07:58:07Z", "message": "apply fix patch"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "29ac965acaf01113e86a761b691ac80ed4b975df", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/29ac965acaf01113e86a761b691ac80ed4b975df", "committedDate": "2021-01-11T07:02:25Z", "message": "apply fix patch"}, "afterCommit": {"oid": "56b8d3159e8fde9a54a0e6cfca43c970aa0ee51f", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/56b8d3159e8fde9a54a0e6cfca43c970aa0ee51f", "committedDate": "2021-01-12T07:58:07Z", "message": "apply fix patch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2MjA0NDY5", "url": "https://github.com/apache/incubator-doris/pull/3775#pullrequestreview-566204469", "createdAt": "2021-01-12T12:05:52Z", "commit": {"oid": "56b8d3159e8fde9a54a0e6cfca43c970aa0ee51f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2465, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}