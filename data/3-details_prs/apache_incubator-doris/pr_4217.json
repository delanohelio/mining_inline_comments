{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5MDI3MzQ1", "number": 4217, "title": "[Bug][Load][Json] #4124 Load json format with stream load failed", "bodyText": "Proposed changes\nStream load should read all the data completely before parsing the json.\nAnd also add a new BE config streaming_load_max_batch_read_mb\nto limit the data size when loading json data.\nFix the bug of loading empty json array []\nAdd doc to explain some certain case of loading json format data.\nFix: #4124\nTypes of changes\n\n Bugfix (non-breaking change which fixes an issue)\n\nChecklist\n\n I have create an issue on #4124, and have described the bug/feature there in detail\n Commit messages in my PR start with the related issues ID, like \"#4071 Add pull request template to doris project\"\n Compiling and unit tests pass locally with my changes\n If this change need a document change, I have updated the document\n Any dependent changes have been merged", "createdAt": "2020-07-30T09:47:58Z", "url": "https://github.com/apache/incubator-doris/pull/4217", "merged": true, "mergeCommit": {"oid": "3f31866169dcd1a76c79026da42a384fda5c2c79"}, "closed": true, "closedAt": "2020-08-04T04:55:54Z", "author": {"login": "morningman"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc52fs-AH2gAyNDU5MDI3MzQ1OmUyZmNkMDI3ZDQzYTAwNjE5M2ZhMGUzYWYwMjNjYTdjNzFmYzc2NDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7NK_VgFqTQ1OTgxNTUyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e2fcd027d43a006193fa0e3af023ca7c71fc7644", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/e2fcd027d43a006193fa0e3af023ca7c71fc7644", "committedDate": "2020-07-30T02:49:16Z", "message": "first\n\nremove unused code\n\nsecond\n\nfix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42caa860b63c4abb999a448d43c577176cf19ac5", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/42caa860b63c4abb999a448d43c577176cf19ac5", "committedDate": "2020-07-30T06:25:33Z", "message": "remove fill tuple param"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74d170985d55940cfdd32fb3a68727993406bf4e", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/74d170985d55940cfdd32fb3a68727993406bf4e", "committedDate": "2020-07-30T09:45:45Z", "message": "add doc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODk5MDQz", "url": "https://github.com/apache/incubator-doris/pull/4217#pullrequestreview-458899043", "createdAt": "2020-07-31T03:45:05Z", "commit": {"oid": "74d170985d55940cfdd32fb3a68727993406bf4e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMzo0NTowNVrOG57FAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMzo1MDowNlrOG57JBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4OTk1NA==", "bodyText": "a stream load can process 10G by default?", "url": "https://github.com/apache/incubator-doris/pull/4217#discussion_r463389954", "createdAt": "2020-07-31T03:45:05Z", "author": {"login": "wuyunfeng"}, "path": "be/src/common/config.h", "diffHunk": "@@ -303,11 +303,14 @@ namespace config {\n     CONF_Int64(load_data_reserve_hours, \"4\");\n     // log error log will be removed after this time\n     CONF_mInt64(load_error_log_reserve_hours, \"48\");\n-    // Deprecated, use streaming_load_max_mb instead\n-    // CONF_Int64(mini_load_max_mb, \"2048\");\n     CONF_Int32(number_tablet_writer_threads, \"16\");\n \n+    // The maximum amount of data that can be processed by a stream load", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74d170985d55940cfdd32fb3a68727993406bf4e"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM5MDk4Mg==", "bodyText": "the size of this batch exceed the max size of json type data\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            ss << \"body exceed max size of json format: \" << ctx->body_bytes << \", limit: \" << max_body_bytes;\n          \n          \n            \n                            ss << \"the size of this batch exceed the max size [\" << max_body_bytes << \"]  of json type data \" << \" data [ \" << ctx->body_bytes << \" ] \"\n          \n      \n    \n    \n  \n\nAnd I suggest you should truncate the logged body_bytes such as just show 1024 byte", "url": "https://github.com/apache/incubator-doris/pull/4217#discussion_r463390982", "createdAt": "2020-07-31T03:50:06Z", "author": {"login": "wuyunfeng"}, "path": "be/src/http/action/stream_load.cpp", "diffHunk": "@@ -234,11 +234,19 @@ Status StreamLoadAction::_on_header(HttpRequest* http_req, StreamLoadContext* ct\n     } else {\n         ctx->format = parse_format(http_req->header(HTTP_FORMAT_KEY));\n         if (ctx->format == TFileFormatType::FORMAT_UNKNOWN) {\n-            LOG(WARNING) << \"unknown data format.\" << ctx->brief();\n             std::stringstream ss;\n             ss << \"unknown data format, format=\" << http_req->header(HTTP_FORMAT_KEY);\n             return Status::InternalError(ss.str());\n         }\n+\n+        size_t max_body_bytes = config::streaming_load_max_batch_size_mb * 1024 * 1024;\n+        if (ctx->format == TFileFormatType::FORMAT_JSON) {\n+            if (ctx->body_bytes > max_body_bytes) {\n+                std::stringstream ss;\n+                ss << \"body exceed max size of json format: \" << ctx->body_bytes << \", limit: \" << max_body_bytes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74d170985d55940cfdd32fb3a68727993406bf4e"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2d6cdfe36d4b0a7616b14a56d99f721c2b82eb0", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/d2d6cdfe36d4b0a7616b14a56d99f721c2b82eb0", "committedDate": "2020-08-02T07:35:49Z", "message": "fix bug review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5ODE1NTI1", "url": "https://github.com/apache/incubator-doris/pull/4217#pullrequestreview-459815525", "createdAt": "2020-08-03T07:48:23Z", "commit": {"oid": "d2d6cdfe36d4b0a7616b14a56d99f721c2b82eb0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2093, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}