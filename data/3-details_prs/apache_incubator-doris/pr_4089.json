{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MzAzNzky", "number": 4089, "title": "Fix some problem related with publish version task", "bodyText": "This PR is mainly do following three things:\n\nAdd thread name in fe log to make trace problem more easy.\nAdd agent_task_resend_wait_time_ms config to escape sending duplicate agent task to be.\nSkip to continue to update replica version when new version is lower than replica version in fe.", "createdAt": "2020-07-13T14:47:17Z", "url": "https://github.com/apache/incubator-doris/pull/4089", "merged": true, "mergeCommit": {"oid": "2334f5d9978ce23df667ab4303f968427af54d82"}, "closed": true, "closedAt": "2020-07-23T12:06:03Z", "author": {"login": "caiconghui"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1BXUxgFqTQ0ODU5MDEzOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3meFPAFqTQ1MzgxMDI4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTkwMTM5", "url": "https://github.com/apache/incubator-doris/pull/4089#pullrequestreview-448590139", "createdAt": "2020-07-15T02:39:26Z", "commit": {"oid": "202b2615113a907c95bf53a28af164b621b1402d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMjozOToyNlrOGxsFaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMjozOToyNlrOGxsFaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc1NTY4OA==", "bodyText": "why the replica meta version been updated by ReportHandler before?\nthis is abnormal, I think using warning is better", "url": "https://github.com/apache/incubator-doris/pull/4089#discussion_r454755688", "createdAt": "2020-07-15T02:39:26Z", "author": {"login": "yangzhg"}, "path": "fe/src/main/java/org/apache/doris/catalog/Replica.java", "diffHunk": "@@ -318,12 +318,17 @@ private void updateReplicaInfo(long newVersion, long newVersionHash,\n             long lastFailedVersion, long lastFailedVersionHash, \n             long lastSuccessVersion, long lastSuccessVersionHash, \n             long newDataSize, long newRowCount) {\n-        LOG.debug(\"before update: {}\", this.toString());\n+        if (LOG.isDebugEnabled()) {\n+            LOG.debug(\"before update: {}\", this.toString());\n+        }\n \n         if (newVersion < this.version) {\n-            // yiguolei: could not find any reason why new version less than this.version should run???\n-            LOG.warn(\"replica {} on backend {}'s new version {} is lower than meta version {}\",\n-                    id, backendId, newVersion, this.version);\n+            // This case means that replica meta version has been updated by ReportHandler before", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "202b2615113a907c95bf53a28af164b621b1402d"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDMxMjU3", "url": "https://github.com/apache/incubator-doris/pull/4089#pullrequestreview-449031257", "createdAt": "2020-07-15T14:45:44Z", "commit": {"oid": "202b2615113a907c95bf53a28af164b621b1402d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDo0NTo0NFrOGyBnPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDo1NTozOVrOGyCLJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwODQxMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \u5f53\u4ee3\u7406\u4efb\u52a1\u7684\u521b\u5efa\u65f6\u95f4\u88ab\u8bbe\u7f6e\u7684\u65f6\u5019\uff0c\u6b64\u914d\u7f6e\u5c06\u51b3\u5b9a\u662f\u5426\u91cd\u65b0\u53d1\u9001\u4ee3\u7406\u4efb\u52a1\uff0c \u5f53\u4e14\u4ec5\u5f53\u5f53\u524d\u65f6\u95f4\u51cf\u53bb\u521b\u5efa\u65f6\u95f4\u5927\u4e8eagent_task_task_resend_wait_time_ms\u65f6\uff0cReportHandler\u53ef\u4ee5\u91cd\u65b0\u53d1\u9001\u4ee3\u7406\u4efb\u52a1\u3002    \n          \n          \n            \n            \u5f53\u4ee3\u7406\u4efb\u52a1\u7684\u521b\u5efa\u65f6\u95f4\u88ab\u8bbe\u7f6e\u7684\u65f6\u5019\uff0c\u6b64\u914d\u7f6e\u5c06\u51b3\u5b9a\u662f\u5426\u91cd\u65b0\u53d1\u9001\u4ee3\u7406\u4efb\u52a1\uff0c \u5f53\u4e14\u4ec5\u5f53\u5f53\u524d\u65f6\u95f4\u51cf\u53bb\u521b\u5efa\u65f6\u95f4\u5927\u4e8e `agent_task_task_resend_wait_time_ms` \u65f6\uff0cReportHandler\u53ef\u4ee5\u91cd\u65b0\u53d1\u9001\u4ee3\u7406\u4efb\u52a1\u3002    \n          \n      \n    \n    \n  \n\n\u5efa\u8bae\u589e\u52a0\u8bf4\u660e\u8be5\u8bbe\u7f6e\u89e3\u51b3\u7684\u95ee\u9898\u548c\u6700\u4f73\u5b9e\u8df5", "url": "https://github.com/apache/incubator-doris/pull/4089#discussion_r455108413", "createdAt": "2020-07-15T14:45:44Z", "author": {"login": "morningman"}, "path": "docs/en/administrator-guide/config/fe_config.md", "diffHunk": "@@ -110,6 +110,10 @@ There are two ways to configure FE configuration items:\n \n ## Configurations\n \n+### `agent_task_resend_wait_time_ms`\n+\n+\u5f53\u4ee3\u7406\u4efb\u52a1\u7684\u521b\u5efa\u65f6\u95f4\u88ab\u8bbe\u7f6e\u7684\u65f6\u5019\uff0c\u6b64\u914d\u7f6e\u5c06\u51b3\u5b9a\u662f\u5426\u91cd\u65b0\u53d1\u9001\u4ee3\u7406\u4efb\u52a1\uff0c \u5f53\u4e14\u4ec5\u5f53\u5f53\u524d\u65f6\u95f4\u51cf\u53bb\u521b\u5efa\u65f6\u95f4\u5927\u4e8eagent_task_task_resend_wait_time_ms\u65f6\uff0cReportHandler\u53ef\u4ee5\u91cd\u65b0\u53d1\u9001\u4ee3\u7406\u4efb\u52a1\u3002    ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "202b2615113a907c95bf53a28af164b621b1402d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTExMDgyMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @ConfField\n          \n          \n            \n                @ConfField (mutable = true, masterOnly = true)", "url": "https://github.com/apache/incubator-doris/pull/4089#discussion_r455110820", "createdAt": "2020-07-15T14:48:56Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/common/Config.java", "diffHunk": "@@ -1117,5 +1117,13 @@\n      */\n     @ConfField\n     public static String thrift_server_type = ThriftServer.THREAD_POOL;\n+\n+    /**\n+     * This config will decide whether to resend agent task when create_time for agent_task is set,\n+     * only when current_time - create_time > agent_task_resend_wait_time_ms can ReportHandler do resend agent task\n+     */\n+    @ConfField", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "202b2615113a907c95bf53a28af164b621b1402d"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTExNzYwNg==", "bodyText": "Good explaination. I suggest to add this directly to the comment.", "url": "https://github.com/apache/incubator-doris/pull/4089#discussion_r455117606", "createdAt": "2020-07-15T14:55:39Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/Replica.java", "diffHunk": "@@ -318,12 +318,17 @@ private void updateReplicaInfo(long newVersion, long newVersionHash,\n             long lastFailedVersion, long lastFailedVersionHash, \n             long lastSuccessVersion, long lastSuccessVersionHash, \n             long newDataSize, long newRowCount) {\n-        LOG.debug(\"before update: {}\", this.toString());\n+        if (LOG.isDebugEnabled()) {\n+            LOG.debug(\"before update: {}\", this.toString());\n+        }\n \n         if (newVersion < this.version) {\n-            // yiguolei: could not find any reason why new version less than this.version should run???\n-            LOG.warn(\"replica {} on backend {}'s new version {} is lower than meta version {}\",\n-                    id, backendId, newVersion, this.version);\n+            // This case means that replica meta version has been updated by ReportHandler before", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc1NTY4OA=="}, "originalCommit": {"oid": "202b2615113a907c95bf53a28af164b621b1402d"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNDYyNTE4", "url": "https://github.com/apache/incubator-doris/pull/4089#pullrequestreview-453462518", "createdAt": "2020-07-22T16:02:11Z", "commit": {"oid": "02d2399fde665443a965d3beeab96b82d7e2df15"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02d2399fde665443a965d3beeab96b82d7e2df15", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/02d2399fde665443a965d3beeab96b82d7e2df15", "committedDate": "2020-07-16T07:46:58Z", "message": "fix comment"}, "afterCommit": {"oid": "7d0eead23a8c8c5582616b7510e69d152fba47ff", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/7d0eead23a8c8c5582616b7510e69d152fba47ff", "committedDate": "2020-07-22T17:05:17Z", "message": "fix comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "866ca70935aa53f3aeac2a64c01aa0d763a050c6", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/866ca70935aa53f3aeac2a64c01aa0d763a050c6", "committedDate": "2020-07-22T17:10:00Z", "message": "Add thread name in fe log to make trace problem more easy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce1fccce624cd049989e2e8401a71e58f8d415ee", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/ce1fccce624cd049989e2e8401a71e58f8d415ee", "committedDate": "2020-07-22T17:10:00Z", "message": "Skip to update replica version when new version is lower than replica's version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "371739988af7611986b419a06c4c80fefdb3d109", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/371739988af7611986b419a06c4c80fefdb3d109", "committedDate": "2020-07-22T17:10:00Z", "message": "Add resend time interval check to escape duplicate agent task send"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34bbf99774a889fef267789df5eba338fe0d2734", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/34bbf99774a889fef267789df5eba338fe0d2734", "committedDate": "2020-07-22T17:10:00Z", "message": "Add doc content for config agent_task_resend_wait_time_ms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23f0f1e2b9338b732ec5dfa2cf2111ad71463f89", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/23f0f1e2b9338b732ec5dfa2cf2111ad71463f89", "committedDate": "2020-07-22T17:10:00Z", "message": "fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e734cc2982cdae4c0b0b71701957a347bd9d910", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/4e734cc2982cdae4c0b0b71701957a347bd9d910", "committedDate": "2020-07-22T17:10:00Z", "message": "fix comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aef9ac152d3b88502eff36e47ad6b97c21266a1b", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/aef9ac152d3b88502eff36e47ad6b97c21266a1b", "committedDate": "2020-07-22T17:10:01Z", "message": "fix by review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c16498ecac08936141d1635b44991db548e88fd", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/2c16498ecac08936141d1635b44991db548e88fd", "committedDate": "2020-07-22T17:10:01Z", "message": "small fix in finishTransaction method of DatabaseTransactionMgr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aedbeb9af7c856f1a5fb88588c2cd998036c82f1", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/aedbeb9af7c856f1a5fb88588c2cd998036c82f1", "committedDate": "2020-07-22T17:10:01Z", "message": "fix comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7d0eead23a8c8c5582616b7510e69d152fba47ff", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/7d0eead23a8c8c5582616b7510e69d152fba47ff", "committedDate": "2020-07-22T17:05:17Z", "message": "fix comment"}, "afterCommit": {"oid": "aedbeb9af7c856f1a5fb88588c2cd998036c82f1", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/aedbeb9af7c856f1a5fb88588c2cd998036c82f1", "committedDate": "2020-07-22T17:10:01Z", "message": "fix comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzODEwMjg4", "url": "https://github.com/apache/incubator-doris/pull/4089#pullrequestreview-453810288", "createdAt": "2020-07-23T03:01:10Z", "commit": {"oid": "aedbeb9af7c856f1a5fb88588c2cd998036c82f1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1919, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}