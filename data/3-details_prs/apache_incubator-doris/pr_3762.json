{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MTUwMDc1", "number": 3762, "title": "[Memory Engine] MemTablet creation and compatibility handling in BE", "bodyText": "After adding meta, BE now can create MemTablet, and put it into TabletManager, but MemTablet is not compatible with Tablet, a lot of code may break. This CL contains the following changes:\nWhen TabletManager::get_tablet is called, only return Tablet, if the underlying tablet is MemTablet, return an error, this keeps the initial code changes small.\nFor methods/functionalities Tablet&MemTablet both have, refactor/extract them to BaseTablet, and change the usage to TabletManager::get_base_tablet, and it will gradually remove errors introduced by step1, this is a long going process.\nResolves #3669", "createdAt": "2020-06-03T11:48:50Z", "url": "https://github.com/apache/incubator-doris/pull/3762", "merged": true, "mergeCommit": {"oid": "ca96ea30560c9e9837c28cfd2cdd8ed24196f787"}, "closed": true, "closedAt": "2020-06-18T01:56:08Z", "author": {"login": "decster"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnn3dQAH2gAyNDI3MTUwMDc1OjIxYzE4YmZhZDllM2FiNTljYjZkYjA0ODNiOTg5ZDc4ZjEzOGFiZTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsUjrIgFqTQzMjg4NzkyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "21c18bfad9e3ab59cb6db0483b989d78f138abe8", "author": {"user": {"login": "decster", "name": "Binglin Chang"}}, "url": "https://github.com/apache/incubator-doris/commit/21c18bfad9e3ab59cb6db0483b989d78f138abe8", "committedDate": "2020-06-03T11:36:00Z", "message": "[Memory Engine] MemTablet creation and compatibility handling in BE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1543b26bac47991a677eacc0a56f0d293b874389", "author": {"user": {"login": "decster", "name": "Binglin Chang"}}, "url": "https://github.com/apache/incubator-doris/commit/1543b26bac47991a677eacc0a56f0d293b874389", "committedDate": "2020-06-04T03:20:07Z", "message": "Merge branch 'master' into tablet-manager2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1Mzg3OTg5", "url": "https://github.com/apache/incubator-doris/pull/3762#pullrequestreview-425387989", "createdAt": "2020-06-05T15:10:35Z", "commit": {"oid": "1543b26bac47991a677eacc0a56f0d293b874389"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNToxMDozNVrOGfyegg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNToxMTo1MFrOGfyhPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4NjA1MA==", "bodyText": "Is this a incomplete implementation? If yes, better add a TODO", "url": "https://github.com/apache/incubator-doris/pull/3762#discussion_r435986050", "createdAt": "2020-06-05T15:10:35Z", "author": {"login": "morningman"}, "path": "be/src/olap/memory/mem_tablet.h", "diffHunk": "@@ -27,6 +27,15 @@ class MemSubTablet;\n class ScanSpec;\n class MemTabletScan;\n class WriteTxn;\n+class MemTablet;\n+using MemTabletSharedPtr = std::shared_ptr<MemTablet>;\n+\n+inline MemTabletSharedPtr to_mem_tablet(const BaseTabletSharedPtr& base) {\n+    if (base->is_memory()) {\n+        return std::static_pointer_cast<MemTablet>(base);\n+    }\n+    return MemTabletSharedPtr();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1543b26bac47991a677eacc0a56f0d293b874389"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4Njc1MA==", "bodyText": "incomplete?", "url": "https://github.com/apache/incubator-doris/pull/3762#discussion_r435986750", "createdAt": "2020-06-05T15:11:50Z", "author": {"login": "morningman"}, "path": "be/src/olap/tablet.h", "diffHunk": "@@ -46,47 +46,27 @@ class TabletMeta;\n \n using TabletSharedPtr = std::shared_ptr<Tablet>;\n \n+inline TabletSharedPtr to_tablet(const BaseTabletSharedPtr& base) {\n+    if (base->is_memory()) {\n+        return TabletSharedPtr();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1543b26bac47991a677eacc0a56f0d293b874389"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MzQ4MjAy", "url": "https://github.com/apache/incubator-doris/pull/3762#pullrequestreview-426348202", "createdAt": "2020-06-08T15:18:24Z", "commit": {"oid": "1543b26bac47991a677eacc0a56f0d293b874389"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNToxODoyNFrOGgjeBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNToxODoyNFrOGgjeBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc4ODc0MA==", "bodyText": "Change the comment", "url": "https://github.com/apache/incubator-doris/pull/3762#discussion_r436788740", "createdAt": "2020-06-08T15:18:24Z", "author": {"login": "morningman"}, "path": "be/src/olap/tablet_manager.cpp", "diffHunk": "@@ -98,26 +99,34 @@ OLAPStatus TabletManager::_add_tablet_unlocked(TTabletId tablet_id, SchemaHash s\n \n     if (existed_tablet == nullptr) {\n         return _add_tablet_to_map_unlocked(tablet_id, schema_hash,\n-                                           tablet, update_meta,\n+                                           base_tablet, update_meta,\n                                            false /*keep_files*/, false /*drop_old*/);\n     }\n \n     if (!force) {\n-        if (existed_tablet->tablet_path() == tablet->tablet_path()) {\n+        if (existed_tablet->tablet_path() == base_tablet->tablet_path()) {\n             LOG(WARNING) << \"add the same tablet twice! tablet_id=\" << tablet_id\n                          << \", schema_hash=\" << schema_hash\n-                         << \", tablet_path=\" << tablet->tablet_path();\n+                         << \", tablet_path=\" << base_tablet->tablet_path();\n             return OLAP_ERR_ENGINE_INSERT_EXISTS_TABLE;\n         }\n-        if (existed_tablet->data_dir() == tablet->data_dir()) {\n+        if (existed_tablet->data_dir() == base_tablet->data_dir()) {\n             LOG(WARNING) << \"add tablet with same data dir twice! tablet_id=\" << tablet_id\n                          << \", schema_hash=\" << schema_hash;\n             return OLAP_ERR_ENGINE_INSERT_EXISTS_TABLE;\n         }\n     }\n \n+    if (base_tablet->is_memory() || existed_tablet->is_memory()) {\n+        LOG(WARNING) << \"add the same tablet twice! tablet_id=\" << tablet_id", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1543b26bac47991a677eacc0a56f0d293b874389"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab7da59bd93517bf0bf50e21234bd0dc0d4c4750", "author": {"user": {"login": "decster", "name": "Binglin Chang"}}, "url": "https://github.com/apache/incubator-doris/commit/ab7da59bd93517bf0bf50e21234bd0dc0d4c4750", "committedDate": "2020-06-09T07:11:50Z", "message": "[Memory Engine] MemTablet creation and compatibility handling in BE: address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NzM1NDg0", "url": "https://github.com/apache/incubator-doris/pull/3762#pullrequestreview-426735484", "createdAt": "2020-06-09T01:53:12Z", "commit": {"oid": "1543b26bac47991a677eacc0a56f0d293b874389"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwMTo1MzoxMlrOGg2EMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwMTo1MzoxMlrOGg2EMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA5MzQyNg==", "bodyText": "You can return nullptr directly.", "url": "https://github.com/apache/incubator-doris/pull/3762#discussion_r437093426", "createdAt": "2020-06-09T01:53:12Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/tablet_manager.cpp", "diffHunk": "@@ -1374,16 +1482,29 @@ TabletSharedPtr TabletManager::_get_tablet_unlocked(TTabletId tablet_id, SchemaH\n \n     VLOG(3) << \"fail to get tablet. tablet_id=\" << tablet_id << \", schema_hash=\" << schema_hash;\n     // Return nullptr tablet if fail\n-    TabletSharedPtr tablet;\n+    BaseTabletSharedPtr tablet;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1543b26bac47991a677eacc0a56f0d293b874389"}, "originalPosition": 544}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7697bf465fe9274e05ac4ec1317d5da2f1bfff7", "author": {"user": {"login": "decster", "name": "Binglin Chang"}}, "url": "https://github.com/apache/incubator-doris/commit/d7697bf465fe9274e05ac4ec1317d5da2f1bfff7", "committedDate": "2020-06-16T02:43:09Z", "message": "[Memory Engine] MemTablet creation and compatibility handling in BE: address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyODg3OTI0", "url": "https://github.com/apache/incubator-doris/pull/3762#pullrequestreview-432887924", "createdAt": "2020-06-18T01:55:49Z", "commit": {"oid": "d7697bf465fe9274e05ac4ec1317d5da2f1bfff7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2444, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}