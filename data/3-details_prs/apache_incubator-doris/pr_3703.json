{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzNjk0NzAw", "number": 3703, "title": "[Load] Add more metric to trace the time cost in stream load and make brpc_num_threads configurable", "bodyText": "This PR mainly do three things:\n\nMake brpc_num_threads configurable to get better performance for qps\nChange some default config in be to make doris get better performance both in stream load and query\nAdd more metric to trace the time cost in stream load", "createdAt": "2020-05-27T08:33:00Z", "url": "https://github.com/apache/incubator-doris/pull/3703", "merged": true, "mergeCommit": {"oid": "01c1de1870c979f8f2a58bc007a1ab60663f885b"}, "closed": true, "closedAt": "2020-06-04T05:37:29Z", "author": {"login": "caiconghui"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclVTGegBqjMzNzcwNzg1Mjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcn1HwRAFqTQyNDA2OTgzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a48208febbc053a850b6ba7f952ec8e77351d76a", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/a48208febbc053a850b6ba7f952ec8e77351d76a", "committedDate": "2020-05-27T07:32:34Z", "message": "Add more metric to trace the time cost in stream load"}, "afterCommit": {"oid": "deb705ec99473108c62c0ba1e7021bae5b3b90fd", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/deb705ec99473108c62c0ba1e7021bae5b3b90fd", "committedDate": "2020-05-27T08:49:11Z", "message": "Add more metric to trace the time cost in stream load and add doc content for brpc_num_threads"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MDA2ODIz", "url": "https://github.com/apache/incubator-doris/pull/3703#pullrequestreview-419006823", "createdAt": "2020-05-27T09:16:12Z", "commit": {"oid": "4243f671f4c4ef6c3303fe5f57e8c49f4ee758d5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwOToxNjoxMlrOGbAn5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwOToxNzoxNlrOGbAqdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3NDk1MQ==", "bodyText": "modify the document of stream load to explain this new fields", "url": "https://github.com/apache/incubator-doris/pull/3703#discussion_r430974951", "createdAt": "2020-05-27T09:16:12Z", "author": {"login": "morningman"}, "path": "be/src/runtime/stream_load/stream_load_context.cpp", "diffHunk": "@@ -70,6 +70,17 @@ std::string StreamLoadContext::to_json() const {\n     writer.Int64(receive_bytes);\n     writer.Key(\"LoadTimeMs\");\n     writer.Int64(load_cost_nanos / 1000000);\n+    writer.Key(\"BeginTxnTimeMs\");\n+    writer.Int64(begin_txn_cost_nanos / 1000000);\n+    writer.Key(\"StreamLoadPutTimeMs\");\n+    writer.Int64(stream_load_put_cost_nanos / 1000000);\n+    writer.Key(\"ReadDataTimeMs\");\n+    writer.Int64(read_data_cost_nanos / 1000000);\n+    writer.Key(\"WriteDataTimeMs\");\n+    writer.Int(write_data_cost_nanos / 1000000);\n+    writer.Key(\"CommitAndPublishTimeMs\");\n+    writer.Int64(commit_and_publish_txn_cost_nanos / 1000000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4243f671f4c4ef6c3303fe5f57e8c49f4ee758d5"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3NTYwNw==", "bodyText": "Better give an suggestion value or an example. eg: \"In our env, we have xx BE with xx core, set this to xx, it can reach xx QPS\"", "url": "https://github.com/apache/incubator-doris/pull/3703#discussion_r430975607", "createdAt": "2020-05-27T09:17:16Z", "author": {"login": "morningman"}, "path": "docs/en/administrator-guide/config/be_config.md", "diffHunk": "@@ -77,6 +77,12 @@ Sometimes the query fails and an error message of `The server is overcrowded` wi\n \n Since this is a brpc configuration, users can also modify this parameter directly during operation. Modify by visiting `http://be_host:brpc_port/flags`.\n \n+### brpc_num_threads\n+\n+This configuration is mainly used to modify the num of bthreads for brpc. The default value is set to -1, which means the num of bthreads is #cpu-cores.\n+\n+User can set this configuration to a larger value to get better QPS performance.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4243f671f4c4ef6c3303fe5f57e8c49f4ee758d5"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MDk1MjA2", "url": "https://github.com/apache/incubator-doris/pull/3703#pullrequestreview-419095206", "createdAt": "2020-05-27T11:21:07Z", "commit": {"oid": "66df4e9bfa1146024b3f5f0530bb8f0382f6333c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMToyMTowOFrOGbEy2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMToyMTowOFrOGbEy2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA0MzI5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                //the num of bthreads for brpc, the default value is set to -1, which means the num of bthreads is #cpu-cores\n          \n          \n            \n                //the number of bthreads for brpc, the default value is set to -1, which means the number of bthreads is #cpu-cores\n          \n      \n    \n    \n  \n\nfor Keep consistent with other variables", "url": "https://github.com/apache/incubator-doris/pull/3703#discussion_r431043291", "createdAt": "2020-05-27T11:21:08Z", "author": {"login": "wutiangan"}, "path": "be/src/common/config.h", "diffHunk": "@@ -30,6 +30,9 @@ namespace config {\n     // port for brpc\n     CONF_Int32(brpc_port, \"8060\");\n \n+    //the num of bthreads for brpc, the default value is set to -1, which means the num of bthreads is #cpu-cores", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66df4e9bfa1146024b3f5f0530bb8f0382f6333c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NzE3Mzcw", "url": "https://github.com/apache/incubator-doris/pull/3703#pullrequestreview-419717370", "createdAt": "2020-05-28T01:27:44Z", "commit": {"oid": "a07c6e63686ac3a4a9c244dd9997dc3d6a67e5fd"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMToyNzo0NFrOGbiouQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMToyOTowMVrOGbip9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzMjIxNw==", "bodyText": "I think 512 is some big, why not keep it 64?\nFor most scenario, 64 is enough.", "url": "https://github.com/apache/incubator-doris/pull/3703#discussion_r431532217", "createdAt": "2020-05-28T01:27:44Z", "author": {"login": "imay"}, "path": "be/src/common/config.h", "diffHunk": "@@ -137,7 +140,7 @@ namespace config {\n     // the maximum number of bytes to display on the debug webserver's log page\n     CONF_Int64(web_log_bytes, \"1048576\");\n     // number of threads available to serve backend execution requests\n-    CONF_Int32(be_service_threads, \"64\");\n+    CONF_Int32(be_service_threads, \"512\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a07c6e63686ac3a4a9c244dd9997dc3d6a67e5fd"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzMjUzNA==", "bodyText": "48 is some big, how about 12?", "url": "https://github.com/apache/incubator-doris/pull/3703#discussion_r431532534", "createdAt": "2020-05-28T01:29:01Z", "author": {"login": "imay"}, "path": "be/src/common/config.h", "diffHunk": "@@ -271,7 +274,7 @@ namespace config {\n     // Port to start debug webserver on\n     CONF_Int32(webserver_port, \"8040\");\n     // Number of webserver workers\n-    CONF_Int32(webserver_num_workers, \"5\");\n+    CONF_Int32(webserver_num_workers, \"48\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a07c6e63686ac3a4a9c244dd9997dc3d6a67e5fd"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMjIwMDg4", "url": "https://github.com/apache/incubator-doris/pull/3703#pullrequestreview-423220088", "createdAt": "2020-06-03T05:04:20Z", "commit": {"oid": "f61131dff0680b1f46f2d950d49fec07b43da3fc"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNTgyMjEz", "url": "https://github.com/apache/incubator-doris/pull/3703#pullrequestreview-423582213", "createdAt": "2020-06-03T13:59:44Z", "commit": {"oid": "f61131dff0680b1f46f2d950d49fec07b43da3fc"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23c089773d4953e31738e5b222e31166a896a158", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/23c089773d4953e31738e5b222e31166a896a158", "committedDate": "2020-06-04T02:38:17Z", "message": "Make brpc_num_threads configurable to get better performance for qps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0458d3dbfb0610e38a7c7899e5c7ea26bf5b1441", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/0458d3dbfb0610e38a7c7899e5c7ea26bf5b1441", "committedDate": "2020-06-04T02:38:17Z", "message": "Change some default config in be to make doris get better performance in stream load and query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef84eb2f6cbbb1520af6a9480d4afa2396cb4f7d", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/ef84eb2f6cbbb1520af6a9480d4afa2396cb4f7d", "committedDate": "2020-06-04T02:43:06Z", "message": "Add more metric to trace the time cost in stream load and add doc content for brpc_num_threads"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fb722dfcec5f55fe5759ae201dbd04016a537c2", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/1fb722dfcec5f55fe5759ae201dbd04016a537c2", "committedDate": "2020-06-04T02:43:06Z", "message": "use StreamLoadPutTimeMs instead of StreamLoadPutMs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1ea5154b6f3f0de08a11dff84f8f4926a2b17dd", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/b1ea5154b6f3f0de08a11dff84f8f4926a2b17dd", "committedDate": "2020-06-04T02:43:06Z", "message": "Add more doc contents about stream load result parameter and brpc_num_threads"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c500936216c966698336c84f66a61043485192f5", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/c500936216c966698336c84f66a61043485192f5", "committedDate": "2020-06-04T02:43:06Z", "message": "fix comment content for brpc_num_threads"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3ea99ccde4c270db575f63fcd15a7d1d6c04c61", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/f3ea99ccde4c270db575f63fcd15a7d1d6c04c61", "committedDate": "2020-06-04T02:43:06Z", "message": "Revert be_service_threads config modification"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f849a223ce4fea417ce036b6f3d0677c034791df", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/f849a223ce4fea417ce036b6f3d0677c034791df", "committedDate": "2020-06-04T02:43:06Z", "message": "Make metric for write data more accurate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6918caf64b0397792a616f46e4dccbf5f077e30d", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/6918caf64b0397792a616f46e4dccbf5f077e30d", "committedDate": "2020-06-04T02:45:35Z", "message": "fix conflict in be_config.md"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f61131dff0680b1f46f2d950d49fec07b43da3fc", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/f61131dff0680b1f46f2d950d49fec07b43da3fc", "committedDate": "2020-05-28T09:58:32Z", "message": "Make metric for write data more accurate"}, "afterCommit": {"oid": "6918caf64b0397792a616f46e4dccbf5f077e30d", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/6918caf64b0397792a616f46e4dccbf5f077e30d", "committedDate": "2020-06-04T02:45:35Z", "message": "fix conflict in be_config.md"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MDY5ODMy", "url": "https://github.com/apache/incubator-doris/pull/3703#pullrequestreview-424069832", "createdAt": "2020-06-04T03:02:34Z", "commit": {"oid": "6918caf64b0397792a616f46e4dccbf5f077e30d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2792, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}