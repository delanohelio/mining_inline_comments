{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1OTQ4MTU3", "number": 2922, "title": "AlterJobV2 Pending Status Replay Fix Bug", "bodyText": "#2920", "createdAt": "2020-02-17T05:31:36Z", "url": "https://github.com/apache/incubator-doris/pull/2922", "merged": true, "mergeCommit": {"oid": "11b43700b95b07dac6c2d82e53beca0711cb22a6"}, "closed": true, "closedAt": "2020-02-17T15:02:19Z", "author": {"login": "wangbo"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFGYv9AH2gAyMzc1OTQ4MTU3OmYyOTRmMmZiMTM0MWJmZTdlM2E1NGRiMzE5MWNkMDk2MDljZGM2ZmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFOqYcAFqTM1OTc5NjU5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f294f2fb1341bfe7e3a54db3191cd09609cdc6fd", "author": {"user": {"login": "wangbo", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/f294f2fb1341bfe7e3a54db3191cd09609cdc6fd", "committedDate": "2020-02-17T05:22:10Z", "message": "AlterJobV2 Pending Status Replay Fix Bug #2920"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NTAzNTA1", "url": "https://github.com/apache/incubator-doris/pull/2922#pullrequestreview-359503505", "createdAt": "2020-02-17T06:03:22Z", "commit": {"oid": "f294f2fb1341bfe7e3a54db3191cd09609cdc6fd"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwNjowMzoyMlrOFqZO7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwNjowMzo0OVrOFqZPTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk5NzkzNA==", "bodyText": "code style. Add {} to if else.", "url": "https://github.com/apache/incubator-doris/pull/2922#discussion_r379997934", "createdAt": "2020-02-17T06:03:22Z", "author": {"login": "kangkaisen"}, "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -1702,8 +1702,18 @@ public long loadAlterJob(DataInputStream dis, long checksum, JobType type) throw\n             newChecksum ^= size;\n             for (int i = 0; i < size; i++) {\n                 AlterJobV2 alterJobV2 = AlterJobV2.read(dis);\n-                if (type == JobType.ROLLUP) {\n-                    this.getRollupHandler().addAlterJobV2(alterJobV2);\n+                if (type == JobType.ROLLUP || type == JobType.SCHEMA_CHANGE) {\n+                    if (type == JobType.ROLLUP)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f294f2fb1341bfe7e3a54db3191cd09609cdc6fd"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk5ODAyOA==", "bodyText": "info is enough.", "url": "https://github.com/apache/incubator-doris/pull/2922#discussion_r379998028", "createdAt": "2020-02-17T06:03:49Z", "author": {"login": "kangkaisen"}, "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -1702,8 +1702,18 @@ public long loadAlterJob(DataInputStream dis, long checksum, JobType type) throw\n             newChecksum ^= size;\n             for (int i = 0; i < size; i++) {\n                 AlterJobV2 alterJobV2 = AlterJobV2.read(dis);\n-                if (type == JobType.ROLLUP) {\n-                    this.getRollupHandler().addAlterJobV2(alterJobV2);\n+                if (type == JobType.ROLLUP || type == JobType.SCHEMA_CHANGE) {\n+                    if (type == JobType.ROLLUP)\n+                        this.getRollupHandler().addAlterJobV2(alterJobV2);\n+                    else\n+                        alterJobsV2.put(alterJobV2.getJobId(), alterJobV2);\n+                    // ATTN : we just want to add tablet into TabletInvertedIndex when only PendingJob is checkpointed\n+                    // to prevent TabletInvertedIndex data loss,\n+                    // So just use AlterJob.replay() instead of AlterHandler.replay().\n+                    if (alterJobV2.getJobState() == AlterJobV2.JobState.PENDING) {\n+                        alterJobV2.replay(alterJobV2);\n+                        LOG.warn(\"replay pending alter job when load alter job {} \", alterJobV2.getJobId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f294f2fb1341bfe7e3a54db3191cd09609cdc6fd"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7318356bc656af29847c5100c1c650f3d59c3d8", "author": {"user": {"login": "wangbo", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/b7318356bc656af29847c5100c1c650f3d59c3d8", "committedDate": "2020-02-17T07:28:03Z", "message": "1 fix code style;2 using LOG.info"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NjgyNjA4", "url": "https://github.com/apache/incubator-doris/pull/2922#pullrequestreview-359682608", "createdAt": "2020-02-17T11:56:58Z", "commit": {"oid": "b7318356bc656af29847c5100c1c650f3d59c3d8"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5Nzk2NTk2", "url": "https://github.com/apache/incubator-doris/pull/2922#pullrequestreview-359796596", "createdAt": "2020-02-17T15:00:40Z", "commit": {"oid": "b7318356bc656af29847c5100c1c650f3d59c3d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3791, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}