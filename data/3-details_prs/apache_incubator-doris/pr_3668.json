{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxODczODQ0", "number": 3668, "title": "[Memory Engine] Add TabletType to PartitionInfo and TabletMeta", "bodyText": "This CL add TabletType to TabletMeta and PartitionInfo, it also adds a create table property \"tablet_type\" : \"disk/memory\" for user to specify tablet type. This is a temporary entry point for testing only, it may change in the future, so this field does not persist to FE PartitionInfo(need to upgrade meta version).\nResolves #3442", "createdAt": "2020-05-22T11:42:34Z", "url": "https://github.com/apache/incubator-doris/pull/3668", "merged": true, "mergeCommit": {"oid": "c967eaf496a2c03200ec29fa0b14357fd4d3df24"}, "closed": true, "closedAt": "2020-05-29T12:20:45Z", "author": {"login": "decster"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABck-wcZgFqTQxNzk5NjUxNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcmBgWvgFqTQyMDg5OTk5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3OTk2NTE0", "url": "https://github.com/apache/incubator-doris/pull/3668#pullrequestreview-417996514", "createdAt": "2020-05-26T06:16:22Z", "commit": {"oid": "4c20b5d7e14a15f59aefcc9e90a944f78abb03ed"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwNjoxNjoyMlrOGaP9dQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwNjozMjo0OVrOGaQV4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE3NzY1Mw==", "bodyText": "It may be not set default.", "url": "https://github.com/apache/incubator-doris/pull/3668#discussion_r430177653", "createdAt": "2020-05-26T06:16:22Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/base_tablet.h", "diffHunk": "@@ -84,6 +85,10 @@ inline const TabletMetaSharedPtr BaseTablet::tablet_meta() {\n     return _tablet_meta;\n }\n \n+inline bool BaseTablet::is_memory() const {\n+    return _tablet_meta->tablet_type() == TabletTypePB::TABLET_TYPE_MEMORY;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c20b5d7e14a15f59aefcc9e90a944f78abb03ed"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE3ODIyNQ==", "bodyText": "Normal upgrade procedure is upgrading BE process proceeding of upgrading FE.\nWhen upgrading BE, tabletType may be not set.", "url": "https://github.com/apache/incubator-doris/pull/3668#discussion_r430178225", "createdAt": "2020-05-26T06:18:02Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/tablet_meta.cpp", "diffHunk": "@@ -101,6 +89,8 @@ TabletMeta::TabletMeta(int64_t table_id, int64_t partition_id,\n     tablet_meta_pb.set_cumulative_layer_point(-1);\n     tablet_meta_pb.set_tablet_state(PB_RUNNING);\n     *(tablet_meta_pb.mutable_tablet_uid()) = tablet_uid.to_proto();\n+    tablet_meta_pb.set_tablet_type(tabletType == TTabletType::TABLET_TYPE_MEMORY ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c20b5d7e14a15f59aefcc9e90a944f78abb03ed"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE4MzkwNA==", "bodyText": "You should add constraint about ALTER TABLE.\nIf I have a disk table.\nALTER TABLE test SET(\"tablet_type\"=\"memory\");\n\nwill be encounter error in BE processing.", "url": "https://github.com/apache/incubator-doris/pull/3668#discussion_r430183904", "createdAt": "2020-05-26T06:32:49Z", "author": {"login": "chaoyli"}, "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeJobV2.java", "diffHunk": "@@ -240,7 +240,8 @@ protected void runPendingJob() throws AlterCancelException {\n                                     Partition.PARTITION_INIT_VERSION, Partition.PARTITION_INIT_VERSION_HASH,\n                                     tbl.getKeysType(), TStorageType.COLUMN, storageMedium,\n                                     shadowSchema, bfColumns, bfFpp, countDownLatch, indexes,\n-                                    tbl.isInMemory());\n+                                    tbl.isInMemory(),\n+                                    tbl.getPartitionInfo().getTabletType(partitionId));\n                             createReplicaTask.setBaseTablet(partitionIndexTabletMap.get(partitionId, shadowIdxId).get(shadowTabletId), originSchemaHash);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c20b5d7e14a15f59aefcc9e90a944f78abb03ed"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MzA3NjA3", "url": "https://github.com/apache/incubator-doris/pull/3668#pullrequestreview-419307607", "createdAt": "2020-05-27T14:56:00Z", "commit": {"oid": "1cef0cb5ce8743ec68f0d1baaecb71a108c8965e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNDo1NjowMFrOGbOh2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNDo1NjowMFrOGbOh2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIwMjc3OA==", "bodyText": "modify the comment", "url": "https://github.com/apache/incubator-doris/pull/3668#discussion_r431202778", "createdAt": "2020-05-27T14:56:00Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/common/util/PropertyAnalyzer.java", "diffHunk": "@@ -233,6 +236,23 @@ public static TStorageType analyzeStorageType(Map<String, String> properties) th\n         return tStorageType;\n     }\n \n+    public static TTabletType analyzeTabletType(Map<String, String> properties) throws AnalysisException {\n+        // default is COLUMN", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1cef0cb5ce8743ec68f0d1baaecb71a108c8965e"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3c0d9005017b550b388a51c069626490f46959f", "author": {"user": {"login": "decster", "name": "Binglin Chang"}}, "url": "https://github.com/apache/incubator-doris/commit/a3c0d9005017b550b388a51c069626490f46959f", "committedDate": "2020-05-29T09:04:32Z", "message": "[Memory Engine] Add TabletType to PartitionInfo and TabletMeta"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff3215d6f82990fa0174448acab526746c9a4bec", "author": {"user": {"login": "decster", "name": "Binglin Chang"}}, "url": "https://github.com/apache/incubator-doris/commit/ff3215d6f82990fa0174448acab526746c9a4bec", "committedDate": "2020-05-29T09:04:32Z", "message": "[Memory Engine] Add TabletType to PartitionInfo and TabletMeta: fix java build error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ef7f336dfb03456dcc92fdb16a2b3563bf426f7", "author": {"user": {"login": "decster", "name": "Binglin Chang"}}, "url": "https://github.com/apache/incubator-doris/commit/7ef7f336dfb03456dcc92fdb16a2b3563bf426f7", "committedDate": "2020-05-29T09:04:32Z", "message": "[Memory Engine] Add TabletType to PartitionInfo and TabletMeta: fix UT error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4546fdd618da499888530be5f7c7ebb3e536d4e8", "author": {"user": {"login": "decster", "name": "Binglin Chang"}}, "url": "https://github.com/apache/incubator-doris/commit/4546fdd618da499888530be5f7c7ebb3e536d4e8", "committedDate": "2020-05-29T09:04:32Z", "message": "[Memory Engine] Add TabletType to PartitionInfo and TabletMeta: address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce70ac4808795e6cd595edeffcc42f7b547bc113", "author": {"user": {"login": "decster", "name": "Binglin Chang"}}, "url": "https://github.com/apache/incubator-doris/commit/ce70ac4808795e6cd595edeffcc42f7b547bc113", "committedDate": "2020-05-29T09:04:32Z", "message": "[Memory Engine] Add TabletType to PartitionInfo and TabletMeta: address review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "48cc3ed9d596a851012240c8dbeb6acdf7378a8f", "author": {"user": {"login": "decster", "name": "Binglin Chang"}}, "url": "https://github.com/apache/incubator-doris/commit/48cc3ed9d596a851012240c8dbeb6acdf7378a8f", "committedDate": "2020-05-28T08:21:04Z", "message": "[Memory Engine] Add TabletType to PartitionInfo and TabletMeta: address review comments"}, "afterCommit": {"oid": "ce70ac4808795e6cd595edeffcc42f7b547bc113", "author": {"user": {"login": "decster", "name": "Binglin Chang"}}, "url": "https://github.com/apache/incubator-doris/commit/ce70ac4808795e6cd595edeffcc42f7b547bc113", "committedDate": "2020-05-29T09:04:32Z", "message": "[Memory Engine] Add TabletType to PartitionInfo and TabletMeta: address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwODk5OTkx", "url": "https://github.com/apache/incubator-doris/pull/3668#pullrequestreview-420899991", "createdAt": "2020-05-29T12:20:27Z", "commit": {"oid": "ce70ac4808795e6cd595edeffcc42f7b547bc113"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2740, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}