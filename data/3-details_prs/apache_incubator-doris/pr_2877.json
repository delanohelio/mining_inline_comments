{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczNDU1ODkw", "number": 2877, "title": "[FIX] fix a bug when using grouping set without all column in a grouping set item", "bodyText": "fix a bug when using grouping sets without all column in a grouping set item will produce wrong value.\nfix grouping function check will not work in group by clause", "createdAt": "2020-02-11T03:20:04Z", "url": "https://github.com/apache/incubator-doris/pull/2877", "merged": true, "mergeCommit": {"oid": "3e160aeb66516e1b4063af6b1768f9ea7313cfd6"}, "closed": true, "closedAt": "2020-02-12T13:50:13Z", "author": {"login": "yangzhg"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDKsw6ABqjMwMjUyNTI2OTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDmpmQgFqTM1NzQ2NDIzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "916834c15f60dba48b9fee3202c33f7ef67f7695", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/916834c15f60dba48b9fee3202c33f7ef67f7695", "committedDate": "2020-02-11T03:17:28Z", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item"}, "afterCommit": {"oid": "fcd96a25c1740a0acd48af352d94519beb76a86b", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/fcd96a25c1740a0acd48af352d94519beb76a86b", "committedDate": "2020-02-11T05:15:22Z", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NjUzMzAy", "url": "https://github.com/apache/incubator-doris/pull/2877#pullrequestreview-356653302", "createdAt": "2020-02-11T13:27:41Z", "commit": {"oid": "fcd96a25c1740a0acd48af352d94519beb76a86b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMzoyNzo0MVrOFoI2JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMzozNDo1M1rOFoJFZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYzMjI5Mg==", "bodyText": "Plz add comment to this function", "url": "https://github.com/apache/incubator-doris/pull/2877#discussion_r377632292", "createdAt": "2020-02-11T13:27:41Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/GroupByClause.java", "diffHunk": "@@ -202,12 +202,7 @@ public void analyze(Analyzer analyzer) throws AnalysisException {\n     }\n \n     public boolean isGroupByExtension() {\n-        if (groupingType == GroupingType.GROUP_BY ||\n-                groupingType == GroupingType.GROUPING_SETS && (groupingSetList == null || groupingSetList.size() < 2)) {\n-            return false;\n-        } else {\n-            return true;\n-        }\n+        return groupingType != GroupingType.GROUP_BY;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd96a25c1740a0acd48af352d94519beb76a86b"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYzMzg3Mw==", "bodyText": "Would add some examples for all these cases?", "url": "https://github.com/apache/incubator-doris/pull/2877#discussion_r377633873", "createdAt": "2020-02-11T13:30:36Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/GroupingInfo.java", "diffHunk": "@@ -85,12 +86,11 @@ public VirtualSlotRef addGroupingSlots(List<Expr> realSlots, Analyzer analyzer)\n     // generate the bitmap that repeated node will repeat rows according to\n     public void buildRepeat(ArrayList<Expr> groupingExprs, List<ArrayList<Expr>> groupingSetList) {\n         groupingIdList = new ArrayList<>();\n-        BitSet bitSetAll = new BitSet();\n+        bitSetAll = new BitSet();\n         bitSetAll.set(0, groupingExprs.size(), true);\n-        groupingIdList.add(bitSetAll);\n         switch (groupingType) {\n             case CUBE:\n-                for (int i = 0; i < (1 << groupingExprs.size()) - 1; i++) {\n+                for (int i = 0; i < (1 << groupingExprs.size()); i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd96a25c1740a0acd48af352d94519beb76a86b"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYzNDYzNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        \"cannot use GROUPING functions without [grouping sets|rollup|cube] a\"\n          \n          \n            \n                                        \"cannot use GROUPING functions without [grouping sets|rollup|cube] \"", "url": "https://github.com/apache/incubator-doris/pull/2877#discussion_r377634636", "createdAt": "2020-02-11T13:31:55Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/SelectStmt.java", "diffHunk": "@@ -351,6 +351,14 @@ public void analyze(Analyzer analyzer) throws AnalysisException, UserException {\n         if (groupByClause != null && groupByClause.isGroupByExtension()) {\n             groupingInfo = new GroupingInfo(analyzer, groupByClause.getGroupingType());\n             groupingInfo.substituteGroupingFn(resultExprs, analyzer);\n+        } else {\n+            for (Expr expr : resultExprs) {\n+                if (checkGroupingFn(expr)) {\n+                    throw new AnalysisException(\n+                            \"cannot use GROUPING functions without [grouping sets|rollup|cube] a\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd96a25c1740a0acd48af352d94519beb76a86b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYzNTQxMw==", "bodyText": "All newly added fields should be optional, or it will cause incompatible.\nAnd name should be all_slot_ids", "url": "https://github.com/apache/incubator-doris/pull/2877#discussion_r377635413", "createdAt": "2020-02-11T13:33:19Z", "author": {"login": "morningman"}, "path": "gensrc/thrift/PlanNodes.thrift", "diffHunk": "@@ -396,6 +396,8 @@ struct TRepeatNode {\n   3: required list<i64> repeat_id_list\n   // A list of integer list, it indicates the position of the grouping virtual slot.\n   4: required list<list<i64>> grouping_list\n+  // A list of all slot\n+  5: required set<Types.TSlotId> all_slot_id", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd96a25c1740a0acd48af352d94519beb76a86b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYzNjE5Ng==", "bodyText": "rename to _all_slot_ids.\nAnd tnode.repeat_node.all_slot_id should be optional, so here you need to check whether this field is set.\nSince this is a bug, you can just return ERROR if this field is not set.", "url": "https://github.com/apache/incubator-doris/pull/2877#discussion_r377636196", "createdAt": "2020-02-11T13:34:53Z", "author": {"login": "morningman"}, "path": "be/src/exec/repeat_node.cpp", "diffHunk": "@@ -30,6 +30,7 @@ RepeatNode::RepeatNode(ObjectPool* pool, const TPlanNode& tnode,\n                      const DescriptorTbl& descs)\n     : ExecNode(pool, tnode, descs),\n     _slot_id_set_list(tnode.repeat_node.slot_id_set_list),\n+    _all_slot_id(tnode.repeat_node.all_slot_id),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd96a25c1740a0acd48af352d94519beb76a86b"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fcd96a25c1740a0acd48af352d94519beb76a86b", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/fcd96a25c1740a0acd48af352d94519beb76a86b", "committedDate": "2020-02-11T05:15:22Z", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item"}, "afterCommit": {"oid": "24272993c81b309ec4828b21d075ab72ada25010", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/24272993c81b309ec4828b21d075ab72ada25010", "committedDate": "2020-02-11T14:04:29Z", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "24272993c81b309ec4828b21d075ab72ada25010", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/24272993c81b309ec4828b21d075ab72ada25010", "committedDate": "2020-02-11T14:04:29Z", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item"}, "afterCommit": {"oid": "821f23fa57f83b78c2367ad1d3020506d8527608", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/821f23fa57f83b78c2367ad1d3020506d8527608", "committedDate": "2020-02-11T15:30:30Z", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "821f23fa57f83b78c2367ad1d3020506d8527608", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/821f23fa57f83b78c2367ad1d3020506d8527608", "committedDate": "2020-02-11T15:30:30Z", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item"}, "afterCommit": {"oid": "8ec5fee12d44fd7657444805c3bd1bd604b7c88e", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/8ec5fee12d44fd7657444805c3bd1bd604b7c88e", "committedDate": "2020-02-12T02:57:44Z", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ec5fee12d44fd7657444805c3bd1bd604b7c88e", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/8ec5fee12d44fd7657444805c3bd1bd604b7c88e", "committedDate": "2020-02-12T02:57:44Z", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item"}, "afterCommit": {"oid": "adc5d07dd4a5cfd2e85b3edca17a2695505da06f", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/adc5d07dd4a5cfd2e85b3edca17a2695505da06f", "committedDate": "2020-02-12T03:00:02Z", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3be65869475da1b9ff549c9ce8ac043d0abf8b9b", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/3be65869475da1b9ff549c9ce8ac043d0abf8b9b", "committedDate": "2020-02-12T11:08:06Z", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "adc5d07dd4a5cfd2e85b3edca17a2695505da06f", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/adc5d07dd4a5cfd2e85b3edca17a2695505da06f", "committedDate": "2020-02-12T03:00:02Z", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item"}, "afterCommit": {"oid": "3be65869475da1b9ff549c9ce8ac043d0abf8b9b", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/3be65869475da1b9ff549c9ce8ac043d0abf8b9b", "committedDate": "2020-02-12T11:08:06Z", "message": "[FIX] fix a bug when using grouping set without all column in a grouping set item"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NDY0MjM3", "url": "https://github.com/apache/incubator-doris/pull/2877#pullrequestreview-357464237", "createdAt": "2020-02-12T13:49:41Z", "commit": {"oid": "3be65869475da1b9ff549c9ce8ac043d0abf8b9b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3739, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}