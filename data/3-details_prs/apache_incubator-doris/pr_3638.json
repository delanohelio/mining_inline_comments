{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwNTM1MDQ4", "number": 3638, "title": "Support utf-8 encoding in instr, locate, locate_pos, lpad, rpad", "bodyText": "Support utf-8 encoding for string function instr, locate, locate_pos, lpad, rpad\nand add unit test for them", "createdAt": "2020-05-20T06:26:07Z", "url": "https://github.com/apache/incubator-doris/pull/3638", "merged": true, "mergeCommit": {"oid": "ba7d2dbf7b7c7dfe9fd4483a10dad07be5083b9b"}, "closed": true, "closedAt": "2020-05-22T06:34:27Z", "author": {"login": "yangzhg"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjDNL8gH2gAyNDIwNTM1MDQ4OjQ3YzkxMGQ1NzZjMTg2OTY5N2IyYmEyMTczZGIwZDNlMzFkYzJmN2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjo2aYAFqTQxNjYwOTc3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "47c910d576c1869697b2ba2173db0d3e31dc2f7d", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/47c910d576c1869697b2ba2173db0d3e31dc2f7d", "committedDate": "2020-05-20T06:37:33Z", "message": "Supoort utf-8 encoding in `instr`, `locate`, `locate_pos`, `lpad`, `rpad`"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ffb759d4b2f4c7ad19de838472157797db46bf2a", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/ffb759d4b2f4c7ad19de838472157797db46bf2a", "committedDate": "2020-05-20T06:23:19Z", "message": "Supoort utf-8 encoding in `instr`, `locate`, `locate_pos`, `lpad`, `rpad`"}, "afterCommit": {"oid": "47c910d576c1869697b2ba2173db0d3e31dc2f7d", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/47c910d576c1869697b2ba2173db0d3e31dc2f7d", "committedDate": "2020-05-20T06:37:33Z", "message": "Supoort utf-8 encoding in `instr`, `locate`, `locate_pos`, `lpad`, `rpad`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NDUyMjc4", "url": "https://github.com/apache/incubator-doris/pull/3638#pullrequestreview-415452278", "createdAt": "2020-05-20T15:24:22Z", "commit": {"oid": "47c910d576c1869697b2ba2173db0d3e31dc2f7d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNToyNDoyMlrOGYRQHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNToyNTo1MVrOGYRUsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEwMTY2MA==", "bodyText": "Should use operator[]", "url": "https://github.com/apache/incubator-doris/pull/3638#discussion_r428101660", "createdAt": "2020-05-20T15:24:22Z", "author": {"login": "kangkaisen"}, "path": "be/src/exprs/string_functions.cpp", "diffHunk": "@@ -196,28 +196,56 @@ StringVal StringFunctions::lpad(\n     if (str.is_null || len.is_null || pad.is_null || len.val < 0) {\n         return StringVal::null();\n     }\n+\n+    size_t str_char_size = 0;\n+    size_t pad_char_size = 0;\n+    size_t byte_pos = 0;\n+    std::vector<size_t> str_index;\n+    std::vector<size_t> pad_index;\n+    for (size_t i = 0, char_size = 0; i < str.len; i += char_size) {\n+        char_size = get_utf8_byte_length((unsigned)(str.ptr)[i]);\n+        str_index.push_back(byte_pos);\n+        byte_pos += char_size;\n+        ++str_char_size;\n+    }\n+    byte_pos = 0;\n+    for (size_t i = 0, char_size = 0; i < pad.len; i += char_size) {\n+        char_size = get_utf8_byte_length((unsigned)(pad.ptr)[i]);\n+        pad_index.push_back(byte_pos);\n+        byte_pos += char_size;\n+        ++pad_char_size;\n+    }\n+    \n     // Corner cases: Shrink the original string, or leave it alone.\n     // TODO: Hive seems to go into an infinite loop if pad.len == 0,\n     // so we should pay attention to Hive's future solution to be compatible.\n-    if (len.val <= str.len || pad.len == 0) {\n-        return StringVal(str.ptr, len.val);\n+    if (len.val <= str_char_size || pad.len == 0) {\n+        if (len.val >= str_index.size()) {\n+            return StringVal::null();\n+        }\n+        return StringVal(str.ptr, str_index.at(len.val));\n     }\n \n     // TODO pengyubing\n     // StringVal result = StringVal::create_temp_string_val(context, len.val);\n-    StringVal result(context, len.val);\n+    int32_t pad_byte_len = 0;\n+    int32_t pad_times = (len.val - str_char_size) / pad_char_size;\n+    int32_t pad_remainder = (len.val - str_char_size) % pad_char_size;\n+    pad_byte_len = pad_times * pad.len;\n+    pad_byte_len += pad_index.at(pad_remainder);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47c910d576c1869697b2ba2173db0d3e31dc2f7d"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEwMjgzNQ==", "bodyText": "Reduplicative code\n    for (size_t i = 0, char_size = 0; i < str.len; i += char_size) {\n        char_size = get_utf8_byte_length((unsigned)(str.ptr)[i]);\n        str_index.push_back(byte_pos);\n        byte_pos += char_size;\n        ++str_char_size;\n    }", "url": "https://github.com/apache/incubator-doris/pull/3638#discussion_r428102835", "createdAt": "2020-05-20T15:25:51Z", "author": {"login": "kangkaisen"}, "path": "be/src/exprs/string_functions.cpp", "diffHunk": "@@ -196,28 +196,56 @@ StringVal StringFunctions::lpad(\n     if (str.is_null || len.is_null || pad.is_null || len.val < 0) {\n         return StringVal::null();\n     }\n+\n+    size_t str_char_size = 0;\n+    size_t pad_char_size = 0;\n+    size_t byte_pos = 0;\n+    std::vector<size_t> str_index;\n+    std::vector<size_t> pad_index;\n+    for (size_t i = 0, char_size = 0; i < str.len; i += char_size) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47c910d576c1869697b2ba2173db0d3e31dc2f7d"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d03028c85d52094c0f98ec4466151de35fc0c1d9", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/d03028c85d52094c0f98ec4466151de35fc0c1d9", "committedDate": "2020-05-21T04:48:52Z", "message": "fix some bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9af2faa176bb244fa94110172fe54e17c92e9ef5", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/9af2faa176bb244fa94110172fe54e17c92e9ef5", "committedDate": "2020-05-21T08:05:22Z", "message": " add docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2MDA4NjMz", "url": "https://github.com/apache/incubator-doris/pull/3638#pullrequestreview-416008633", "createdAt": "2020-05-21T09:35:09Z", "commit": {"oid": "9af2faa176bb244fa94110172fe54e17c92e9ef5"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2MDEzMTk1", "url": "https://github.com/apache/incubator-doris/pull/3638#pullrequestreview-416013195", "createdAt": "2020-05-21T09:43:05Z", "commit": {"oid": "9af2faa176bb244fa94110172fe54e17c92e9ef5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwOTo0MzowNVrOGYsuIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwOTo0Mzo0OFrOGYsvZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU1MTcxMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                for (size_t i = 0, char_size = 0; i < str.len; i += char_size) {\n          \n          \n            \n                for (size_t i = 0; i < str.len; i += char_size) {", "url": "https://github.com/apache/incubator-doris/pull/3638#discussion_r428551712", "createdAt": "2020-05-21T09:43:05Z", "author": {"login": "kangpinghuang"}, "path": "be/src/exprs/string_functions.cpp", "diffHunk": "@@ -49,6 +49,17 @@ size_t get_utf8_byte_length(unsigned char byte) {\n     }\n     return char_size;\n }\n+size_t get_char_len(const StringVal& str, std::vector<size_t>* str_index) {\n+    size_t char_len = 0;\n+    size_t byte_pos = 0;\n+    for (size_t i = 0, char_size = 0; i < str.len; i += char_size) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9af2faa176bb244fa94110172fe54e17c92e9ef5"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU1MTkyOQ==", "bodyText": "just use i to replace byte_pos and remove byte_pos", "url": "https://github.com/apache/incubator-doris/pull/3638#discussion_r428551929", "createdAt": "2020-05-21T09:43:34Z", "author": {"login": "kangpinghuang"}, "path": "be/src/exprs/string_functions.cpp", "diffHunk": "@@ -49,6 +49,17 @@ size_t get_utf8_byte_length(unsigned char byte) {\n     }\n     return char_size;\n }\n+size_t get_char_len(const StringVal& str, std::vector<size_t>* str_index) {\n+    size_t char_len = 0;\n+    size_t byte_pos = 0;\n+    for (size_t i = 0, char_size = 0; i < str.len; i += char_size) {\n+        char_size = get_utf8_byte_length((unsigned)(str.ptr)[i]);\n+        str_index->push_back(byte_pos);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9af2faa176bb244fa94110172fe54e17c92e9ef5"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU1MjAzNg==", "bodyText": "can remove this variable", "url": "https://github.com/apache/incubator-doris/pull/3638#discussion_r428552036", "createdAt": "2020-05-21T09:43:48Z", "author": {"login": "kangpinghuang"}, "path": "be/src/exprs/string_functions.cpp", "diffHunk": "@@ -49,6 +49,17 @@ size_t get_utf8_byte_length(unsigned char byte) {\n     }\n     return char_size;\n }\n+size_t get_char_len(const StringVal& str, std::vector<size_t>* str_index) {\n+    size_t char_len = 0;\n+    size_t byte_pos = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9af2faa176bb244fa94110172fe54e17c92e9ef5"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "207890e4ab8de94d2b0a3f8aec5796d1de8fe364", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/207890e4ab8de94d2b0a3f8aec5796d1de8fe364", "committedDate": "2020-05-21T10:50:21Z", "message": "fix comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NjA5Nzc4", "url": "https://github.com/apache/incubator-doris/pull/3638#pullrequestreview-416609778", "createdAt": "2020-05-22T02:29:04Z", "commit": {"oid": "207890e4ab8de94d2b0a3f8aec5796d1de8fe364"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2701, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}