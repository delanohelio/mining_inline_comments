{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4NDY5NTUw", "number": 2632, "title": "[Rowset Reader] Improve the merge read efficiency of alpha rowsets", "bodyText": "When merge reads from one rowset with multi overlapping segments,\nI introduce a priority queue(A Minimum heap data structure) for multipath merge sort,\nto replace the old N*M time complexity algorithm.\nThis can significantly improve the read efficiency when merging large number of\noverlapping data.\nIn mytest:\n\nCompaction with 187 segments reduce time from 75 seconds to 42 seconds\nCompaction with 3574 segments cost 43 seconds, and with old version, I kill the\nprocess after waiting more than 10 minutes...\n\nThis CL only change the reads of alpha rowset. Beta rowset will be changed in another CL.\nISSUE: #2631", "createdAt": "2020-01-01T09:15:20Z", "url": "https://github.com/apache/incubator-doris/pull/2632", "merged": true, "mergeCommit": {"oid": "cc924c9e6aac56b245defd6aff6cd6529e53e9c7"}, "closed": true, "closedAt": "2020-01-02T06:10:06Z", "author": {"login": "morningman"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb1zaUKgH2gAyMzU4NDY5NTUwOjhkZDI4NjgyNmYxY2ZiMDMxNzkyMGM1MWJmYmM2NTE4M2M1NjUxY2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb2QwfSgFqTMzNzUyMTI4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8dd286826f1cfb0317920c51bfbc65183c5651ce", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/8dd286826f1cfb0317920c51bfbc65183c5651ce", "committedDate": "2019-12-31T16:46:49Z", "message": "first"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bc401e6b68d23580f419905f745ceffb0cdafcc", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/2bc401e6b68d23580f419905f745ceffb0cdafcc", "committedDate": "2020-01-01T08:03:21Z", "message": "second"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a83b447feb1ae2ff62266254a4b8bbadb7788f9", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/8a83b447feb1ae2ff62266254a4b8bbadb7788f9", "committedDate": "2020-01-01T09:12:19Z", "message": "second"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM3NDg1MDky", "url": "https://github.com/apache/incubator-doris/pull/2632#pullrequestreview-337485092", "createdAt": "2020-01-01T12:11:44Z", "commit": {"oid": "8a83b447feb1ae2ff62266254a4b8bbadb7788f9"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wMVQxMjoxMTo0NFrOFZiO0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wMVQxMjoyMDozMlrOFZiQig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMxOTU3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            bool RowCursorWithOrdinalComparator::operator () (const RowCursorWithOrdinal &x, const RowCursorWithOrdinal &y) const {\n          \n          \n            \n            bool RowCursorWithOrdinalComparator::operator () (const RowCursorWithOrdinal& x, const RowCursorWithOrdinal& y) const {", "url": "https://github.com/apache/incubator-doris/pull/2632#discussion_r362319571", "createdAt": "2020-01-01T12:11:44Z", "author": {"login": "imay"}, "path": "be/src/olap/rowset/alpha_rowset_reader.cpp", "diffHunk": "@@ -326,4 +382,8 @@ RowsetSharedPtr AlphaRowsetReader::rowset() {\n     return std::static_pointer_cast<Rowset>(_rowset);\n }\n \n+bool RowCursorWithOrdinalComparator::operator () (const RowCursorWithOrdinal &x, const RowCursorWithOrdinal &y) const {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a83b447feb1ae2ff62266254a4b8bbadb7788f9"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMyMDAxMA==", "bodyText": "why not use use RowCursorWithOrdinal as element of queue. If then, there is no need to record ordinal.", "url": "https://github.com/apache/incubator-doris/pull/2632#discussion_r362320010", "createdAt": "2020-01-01T12:20:32Z", "author": {"login": "imay"}, "path": "be/src/olap/rowset/alpha_rowset_reader.h", "diffHunk": "@@ -103,6 +128,9 @@ class AlphaRowsetReader : public RowsetReader {\n     RowsetReaderContext* _current_read_context;\n     OlapReaderStatistics _owned_stats;\n     OlapReaderStatistics* _stats = &_owned_stats;\n+\n+    // a priority queue for merging rowsets\n+    std::priority_queue<RowCursorWithOrdinal, vector<RowCursorWithOrdinal>, RowCursorWithOrdinalComparator> _merge_queue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a83b447feb1ae2ff62266254a4b8bbadb7788f9"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f0d1c4fab9a92a972ce6284efa0914f246be5b7", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/9f0d1c4fab9a92a972ce6284efa0914f246be5b7", "committedDate": "2020-01-01T13:44:57Z", "message": "4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6482b1f74935bcdfbaf235b64ccc7bb9ae703a8", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/d6482b1f74935bcdfbaf235b64ccc7bb9ae703a8", "committedDate": "2020-01-02T02:26:45Z", "message": "fix by reviews"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM3NTIxMjg3", "url": "https://github.com/apache/incubator-doris/pull/2632#pullrequestreview-337521287", "createdAt": "2020-01-02T02:58:17Z", "commit": {"oid": "d6482b1f74935bcdfbaf235b64ccc7bb9ae703a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3827, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}