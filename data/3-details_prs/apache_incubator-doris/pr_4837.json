{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0NTQ4OTAz", "number": 4837, "title": "[Optimize] Take 'tablet scan frequency' into consideration when selecting a tablet for compaction", "bodyText": "Proposed changes\nA large  number of small segment files will lead to low efficiency for scan operations. Multiple small files can be merged into a large file by compaction operation. So we could take the tablet scan frequency into consideration when selecting an tablet for compaction and preferentially do compaction for those tablets which are scanned frequently during a latest period of time at the present.\nUsing the compaction strategy of Kudufor reference, scan frequency can be calculated for tablet during a latest period of time and be taken into consideration when calculating compaction score.\nTypes of changes\nWhat types of changes does your code introduce to Doris?\nPut an x in the boxes that apply\n\n[] Bugfix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n[] Breaking change (fix or feature that would cause existing functionality to not work as expected)\n[] Documentation Update (if none of the other choices apply)\n[] Code refactor (Modify the code structure, format the code, etc...)\n\nChecklist\nPut an x in the boxes that apply. You can also fill these out after creating the PR. If you're unsure about any of them, don't hesitate to ask. We're here to help! This is simply a reminder of what we are going to look for before merging your code.\n\n I have create an issue on (Fix #4834), and have described the bug/feature there in detail\n Compiling and unit tests pass locally with my changes\n[] I have added tests that prove my fix is effective or that my feature works\n If this change need a document change, I have updated the document\n Any dependent changes have been merged", "createdAt": "2020-11-03T07:45:33Z", "url": "https://github.com/apache/incubator-doris/pull/4837", "merged": true, "mergeCommit": {"oid": "6247408689d5828bb421fede7c9c67c460f22120"}, "closed": true, "closedAt": "2020-11-18T13:51:13Z", "author": {"login": "weizuo93"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdY4UYnAFqTUyMjQ0NjMxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABddbcdvAFqTUzMjUwMTMwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNDQ2MzEx", "url": "https://github.com/apache/incubator-doris/pull/4837#pullrequestreview-522446311", "createdAt": "2020-11-03T12:27:46Z", "commit": {"oid": "372fc1df0e9dcf25ffe29cfee31c4241c28ef0aa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMjoyNzo0NlrOHssk9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMjoyNzo0NlrOHssk9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYyOTc0OA==", "bodyText": "Add comment for the new fields", "url": "https://github.com/apache/incubator-doris/pull/4837#discussion_r516629748", "createdAt": "2020-11-03T12:27:46Z", "author": {"login": "morningman"}, "path": "be/src/olap/tablet.h", "diffHunk": "@@ -301,6 +303,10 @@ class Tablet : public BaseTablet {\n     // cumulative compaction policy\n     std::unique_ptr<CumulativeCompactionPolicy> _cumulative_compaction_policy;\n     std::string _cumulative_compaction_type;\n+\n+    int64_t _last_update_scan_count;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "372fc1df0e9dcf25ffe29cfee31c4241c28ef0aa"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMTA0OTI5", "url": "https://github.com/apache/incubator-doris/pull/4837#pullrequestreview-523104929", "createdAt": "2020-11-04T07:43:00Z", "commit": {"oid": "372fc1df0e9dcf25ffe29cfee31c4241c28ef0aa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwNzo0MzowMFrOHtMLpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwNzo0MzowMFrOHtMLpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE0NzU1Ng==", "bodyText": "Do they need to be normalized? If needed, you should define them as double.", "url": "https://github.com/apache/incubator-doris/pull/4837#discussion_r517147556", "createdAt": "2020-11-04T07:43:00Z", "author": {"login": "acelyc111"}, "path": "be/src/common/config.h", "diffHunk": "@@ -329,6 +329,13 @@ namespace config {\n     CONF_mInt32(base_compaction_trace_threshold, \"10\");\n     CONF_mInt32(cumulative_compaction_trace_threshold, \"2\");\n \n+    // update tablet scan count in second\n+    CONF_mInt64(update_tablet_scan_count_interval_second, \"300\");\n+    // coefficient for tablet scan frequency and compaction score when finding a tablet for compaction\n+    CONF_mInt32(compaction_tablet_scan_frequency_factor, \"0\");\n+    CONF_mInt32(compaction_tablet_compaction_score_factor, \"1\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "372fc1df0e9dcf25ffe29cfee31c4241c28ef0aa"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NjU3NTQx", "url": "https://github.com/apache/incubator-doris/pull/4837#pullrequestreview-525657541", "createdAt": "2020-11-07T14:44:33Z", "commit": {"oid": "3221d91d1d1a208f48f5e2419bb7a570219fd79b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QxNDo0NDozM1rOHvIfug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QxNDo1Mjo1NlrOHvIjKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NDMxNA==", "bodyText": "Why no document for these 2 configs?\nBetter give best practice for them.", "url": "https://github.com/apache/incubator-doris/pull/4837#discussion_r519184314", "createdAt": "2020-11-07T14:44:33Z", "author": {"login": "morningman"}, "path": "docs/zh-CN/administrator-guide/config/be_config.md", "diffHunk": "@@ -180,6 +180,10 @@ Metrics: {\"filtered_rows\":0,\"input_row_num\":3346807,\"input_rowsets_count\":42,\"in\n \n ### `column_dictionary_key_size_threshold`\n \n+### `compaction_tablet_compaction_score_factor`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3221d91d1d1a208f48f5e2419bb7a570219fd79b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NDkyMg==", "bodyText": "if compaction_tablet_scan_frequency_factor is zero, we can skip calling calculate_scan_frequency() to save some CPU.", "url": "https://github.com/apache/incubator-doris/pull/4837#discussion_r519184922", "createdAt": "2020-11-07T14:50:03Z", "author": {"login": "morningman"}, "path": "be/src/olap/tablet_manager.cpp", "diffHunk": "@@ -745,17 +747,22 @@ TabletSharedPtr TabletManager::find_best_tablet_to_compaction(\n                     }\n                 }\n \n-                uint32_t table_score = 0;\n+                double tablet_score = 0;\n+                uint32_t current_compaction_score = 0;\n                 {\n                     ReadLock rdlock(tablet_ptr->get_header_lock_ptr());\n                     if (compaction_type == CompactionType::BASE_COMPACTION) {\n-                        table_score = tablet_ptr->calc_base_compaction_score();\n+                        current_compaction_score = tablet_ptr->calc_base_compaction_score();\n                     } else if (compaction_type == CompactionType::CUMULATIVE_COMPACTION) {\n-                        table_score = tablet_ptr->calc_cumulative_compaction_score();\n+                        current_compaction_score = tablet_ptr->calc_cumulative_compaction_score();\n                     }\n                 }\n-                if (table_score > highest_score) {\n-                    highest_score = table_score;\n+                double scan_frequency = tablet_ptr->calculate_scan_frequency();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3221d91d1d1a208f48f5e2419bb7a570219fd79b"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NTE5Mw==", "bodyText": "Why multi 60?", "url": "https://github.com/apache/incubator-doris/pull/4837#discussion_r519185193", "createdAt": "2020-11-07T14:52:56Z", "author": {"login": "morningman"}, "path": "be/src/olap/tablet.cpp", "diffHunk": "@@ -1309,4 +1311,16 @@ void Tablet::generate_tablet_meta_copy_unlocked(TabletMetaSharedPtr new_tablet_m\n     new_tablet_meta->init_from_pb(tablet_meta_pb);\n }\n \n+double Tablet::calculate_scan_frequency() {\n+    time_t now = time(nullptr);\n+    int64_t current_count = query_scan_count->value();\n+    double interval = difftime(now, _last_record_scan_count_timestamp);\n+    double scan_frequency = (current_count - _last_record_scan_count) * 60 / interval;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3221d91d1d1a208f48f5e2419bb7a570219fd79b"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64ed98dff0559241933373cd5d4cea166aa910c7", "author": {"user": {"login": "weizuo93", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/64ed98dff0559241933373cd5d4cea166aa910c7", "committedDate": "2020-11-16T06:09:13Z", "message": "take tablet scan frequency into consider when selecting tablet for compaction"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6806c9dda423dd3ee5104a3a1c5e5467d11363b6", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/6806c9dda423dd3ee5104a3a1c5e5467d11363b6", "committedDate": "2020-11-09T08:53:54Z", "message": "take tablet scan frequency into consider when selecting tablet for compaction"}, "afterCommit": {"oid": "64ed98dff0559241933373cd5d4cea166aa910c7", "author": {"user": {"login": "weizuo93", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/64ed98dff0559241933373cd5d4cea166aa910c7", "committedDate": "2020-11-16T06:09:13Z", "message": "take tablet scan frequency into consider when selecting tablet for compaction"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNTAxMzAw", "url": "https://github.com/apache/incubator-doris/pull/4837#pullrequestreview-532501300", "createdAt": "2020-11-17T15:39:34Z", "commit": {"oid": "64ed98dff0559241933373cd5d4cea166aa910c7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4817, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}