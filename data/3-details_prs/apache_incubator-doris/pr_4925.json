{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNzA1MTI0", "number": 4925, "title": "[Refactor] Refactor DeleteHandler and Cond module", "bodyText": "Proposed changes\nThis patch mainly do the following refactors:\n\nUse int64_t instead of int32_t for 'version' in DeleteHandler\nMove some comments from .cpp to .h file, add some new comments in .h files, and also remove some meaningless comments\nUse switch...case... instead of multiple if..else.. for DeleteConditionHandler::is_condition_value_valid\nUse range loop to simplify code\nReduce some compare operations in Cond::del_eval\nImprove some branch predictions in Reader\nFix and improve some unit tests\n\nTypes of changes\nWhat types of changes does your code introduce to Doris?\nPut an x in the boxes that apply\n\n[] Bugfix (non-breaking change which fixes an issue)\n[] New feature (non-breaking change which adds functionality)\n[] Breaking change (fix or feature that would cause existing functionality to not work as expected)\n[] Documentation Update (if none of the other choices apply)\n Code refactor (Modify the code structure, format the code, etc...)\n\nChecklist\nPut an x in the boxes that apply. You can also fill these out after creating the PR. If you're unsure about any of them, don't hesitate to ask. We're here to help! This is simply a reminder of what we are going to look for before merging your code.\n\n[] I have create an issue on (Fix #ISSUE), and have described the bug/feature there in detail\n Compiling and unit tests pass locally with my changes\n[] I have added tests that prove my fix is effective or that my feature works\n[] If this change need a document change, I have updated the document\n[] Any dependent changes have been merged", "createdAt": "2020-11-19T06:17:33Z", "url": "https://github.com/apache/incubator-doris/pull/4925", "merged": true, "mergeCommit": {"oid": "9c9992e0aa28ee85364eebf86a6675f1073e08fb"}, "closed": true, "closedAt": "2020-12-04T04:13:30Z", "author": {"login": "acelyc111"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdd8pIQABqjQwMTQxNDgxMjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiv0JAgFqTU0NDY0NDYxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae68a0f7405f865623957021b0faf6c7852b1340", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/ae68a0f7405f865623957021b0faf6c7852b1340", "committedDate": "2020-11-19T04:23:34Z", "message": "comment"}, "afterCommit": {"oid": "edd1ef52a4f312193c1007ed35944d908e73c71c", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/edd1ef52a4f312193c1007ed35944d908e73c71c", "committedDate": "2020-11-19T06:19:43Z", "message": "[Refactor] Refactor DeleteHandler and Cond module"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1OTY4MjA0", "url": "https://github.com/apache/incubator-doris/pull/4925#pullrequestreview-535968204", "createdAt": "2020-11-21T13:58:52Z", "commit": {"oid": "edd1ef52a4f312193c1007ed35944d908e73c71c"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQxMzo1ODo1MlrOH3uvZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQxNDoyNTo0MlrOH3u5FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODE5OTUyNA==", "bodyText": "I think we can translate it to English this time", "url": "https://github.com/apache/incubator-doris/pull/4925#discussion_r528199524", "createdAt": "2020-11-21T13:58:52Z", "author": {"login": "morningman"}, "path": "be/src/olap/delete_handler.cpp", "diffHunk": "@@ -162,27 +165,23 @@ OLAPStatus DeleteConditionHandler::check_condition_valid(\n \n     // \u68c0\u67e5\u6307\u5b9a\u7684\u5217\u662f\u4e0d\u662fkey\uff0c\u662f\u4e0d\u662ffloat\u6216double\u7c7b\u578b\n     const TabletColumn& column = schema.column(field_index);\n-\n     if ((!column.is_key() && schema.keys_type() != KeysType::DUP_KEYS)\n             || column.type() == OLAP_FIELD_TYPE_DOUBLE\n             || column.type() == OLAP_FIELD_TYPE_FLOAT) {\n         LOG(WARNING) << \"field is not key column, or storage model is not duplicate, or data type is float or double.\";\n         return OLAP_ERR_DELETE_INVALID_CONDITION;\n     }\n \n-    // \u68c0\u67e5\u5220\u9664\u6761\u4ef6\u4e2d\u6307\u5b9a\u7684\u8fc7\u6ee4\u503c\u662f\u5426\u7b26\u5408\u6bcf\u4e2a\u7c7b\u578b\u81ea\u8eab\u7684\u8981\u6c42\n-    // 1. \u5bf9\u4e8e\u6574\u6570\u7c7b\u578b(int8,int16,in32,int64,uint8,uint16,uint32,uint64)\uff0c\u68c0\u67e5\u662f\u5426\u6ea2\u51fa\n-    // 2. \u5bf9\u4e8edecimal\u7c7b\u578b\uff0c\u68c0\u67e5\u662f\u5426\u8d85\u8fc7\u5efa\u8868\u65f6\u6307\u5b9a\u7684\u7cbe\u5ea6\u548c\u6807\u5ea6\n-    // 3. \u5bf9\u4e8edate\u548cdatetime\u7c7b\u578b\uff0c\u68c0\u67e5\u6307\u5b9a\u7684\u8fc7\u6ee4\u503c\u662f\u5426\u7b26\u5408\u65e5\u671f\u683c\u5f0f\u4ee5\u53ca\u662f\u5426\u6307\u5b9a\u9519\u8bef\u7684\u503c\n-    // 4. \u5bf9\u4e8estring\u548cvarchar\u7c7b\u578b\uff0c\u68c0\u67e5\u6307\u5b9a\u7684\u8fc7\u6ee4\u503c\u662f\u5426\u8d85\u8fc7\u5efa\u8868\u65f6\u6307\u5b9a\u7684\u957f\u5ea6\n+    // \u68c0\u67e5'op'\u4e0e'operands'\u6570\u662f\u5426\u5408\u6cd5", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edd1ef52a4f312193c1007ed35944d908e73c71c"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODIwMTUwMg==", "bodyText": "I think DEL_NOT_SATISFIED is more safe. Or you'd better change DCHECK to CHECK", "url": "https://github.com/apache/incubator-doris/pull/4925#discussion_r528201502", "createdAt": "2020-11-21T14:20:32Z", "author": {"login": "morningman"}, "path": "be/src/olap/olap_cond.cpp", "diffHunk": "@@ -382,28 +386,30 @@ int Cond::del_eval(const std::pair<WrapperField*, WrapperField*>& stat) const {\n             } else if (stat.first->is_null() && !stat.second->is_null()) {\n                 ret = DEL_PARTIAL_SATISFIED;\n             } else {\n+                DCHECK(false);\n                 //\u4e0d\u4f1a\u51fa\u73b0min\u4e0d\u4e3aNULL\uff0cmax\u4e3aNULL\n-                ret = DEL_NOT_SATISFIED;\n+                ret = DEL_SATISFIED;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edd1ef52a4f312193c1007ed35944d908e73c71c"}, "originalPosition": 130}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODIwMTU3MA==", "bodyText": "Change to CHECK, or ret = DEL_NOT_SATISFIED", "url": "https://github.com/apache/incubator-doris/pull/4925#discussion_r528201570", "createdAt": "2020-11-21T14:20:59Z", "author": {"login": "morningman"}, "path": "be/src/olap/olap_cond.cpp", "diffHunk": "@@ -382,28 +386,30 @@ int Cond::del_eval(const std::pair<WrapperField*, WrapperField*>& stat) const {\n             } else if (stat.first->is_null() && !stat.second->is_null()) {\n                 ret = DEL_PARTIAL_SATISFIED;\n             } else {\n+                DCHECK(false);\n                 //\u4e0d\u4f1a\u51fa\u73b0min\u4e0d\u4e3aNULL\uff0cmax\u4e3aNULL\n-                ret = DEL_NOT_SATISFIED;\n+                ret = DEL_SATISFIED;\n             }\n         } else {\n             if (stat.first->is_null() && stat.second->is_null()) {\n                 ret = DEL_NOT_SATISFIED;\n             } else if (stat.first->is_null() && !stat.second->is_null()) {\n                 ret = DEL_PARTIAL_SATISFIED;\n             } else {\n+                DCHECK(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edd1ef52a4f312193c1007ed35944d908e73c71c"}, "originalPosition": 138}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODIwMjAwNQ==", "bodyText": "Why using DCHECK here?", "url": "https://github.com/apache/incubator-doris/pull/4925#discussion_r528202005", "createdAt": "2020-11-21T14:25:42Z", "author": {"login": "morningman"}, "path": "be/src/olap/reader.cpp", "diffHunk": "@@ -599,13 +599,12 @@ OLAPStatus Reader::_init_params(const ReaderParams& read_params) {\n \n     if (_tablet->tablet_schema().has_sequence_col()) {\n         _sequence_col_idx = _tablet->tablet_schema().sequence_col_idx();\n-        if (_sequence_col_idx != -1) {\n-            for (auto col : _return_columns) {\n-                // query has sequence col\n-                if (col == _sequence_col_idx) {\n-                    _has_sequence_col = true;\n-                    break;\n-                }\n+        DCHECK_NE(_sequence_col_idx, -1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edd1ef52a4f312193c1007ed35944d908e73c71c"}, "originalPosition": 196}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2ccf12e2c9f12ddaaf8501f0ddee87ad97325dcb", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/2ccf12e2c9f12ddaaf8501f0ddee87ad97325dcb", "committedDate": "2020-11-22T06:41:39Z", "message": "translate comments and use CHECK"}, "afterCommit": {"oid": "40cf1bde3c057ca185a4b97d3298d31453d40e52", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/40cf1bde3c057ca185a4b97d3298d31453d40e52", "committedDate": "2020-11-27T05:16:58Z", "message": "translate comments and use CHECK"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40cf1bde3c057ca185a4b97d3298d31453d40e52", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/40cf1bde3c057ca185a4b97d3298d31453d40e52", "committedDate": "2020-11-27T05:16:58Z", "message": "translate comments and use CHECK"}, "afterCommit": {"oid": "92d9d636d54ddcf7b470931ce12006d7cc1d87dd", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/92d9d636d54ddcf7b470931ce12006d7cc1d87dd", "committedDate": "2020-11-30T02:37:04Z", "message": "[Refactor] Refactor DeleteHandler and Cond module"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "92d9d636d54ddcf7b470931ce12006d7cc1d87dd", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/92d9d636d54ddcf7b470931ce12006d7cc1d87dd", "committedDate": "2020-11-30T02:37:04Z", "message": "[Refactor] Refactor DeleteHandler and Cond module"}, "afterCommit": {"oid": "963f6ca0bb6d5b2384d9ba88230304254ecd99d2", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/963f6ca0bb6d5b2384d9ba88230304254ecd99d2", "committedDate": "2020-11-30T02:56:29Z", "message": "[Refactor] Refactor DeleteHandler and Cond module"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "963f6ca0bb6d5b2384d9ba88230304254ecd99d2", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/963f6ca0bb6d5b2384d9ba88230304254ecd99d2", "committedDate": "2020-11-30T02:56:29Z", "message": "[Refactor] Refactor DeleteHandler and Cond module"}, "afterCommit": {"oid": "780999ed2a6c6d1c82582a2791b5f8b8f282af0d", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/780999ed2a6c6d1c82582a2791b5f8b8f282af0d", "committedDate": "2020-11-30T03:52:33Z", "message": "[Refactor] Refactor DeleteHandler and Cond module"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxOTk0NjQ2", "url": "https://github.com/apache/incubator-doris/pull/4925#pullrequestreview-541994646", "createdAt": "2020-12-01T15:08:02Z", "commit": {"oid": "780999ed2a6c6d1c82582a2791b5f8b8f282af0d"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "780999ed2a6c6d1c82582a2791b5f8b8f282af0d", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/780999ed2a6c6d1c82582a2791b5f8b8f282af0d", "committedDate": "2020-11-30T03:52:33Z", "message": "[Refactor] Refactor DeleteHandler and Cond module"}, "afterCommit": {"oid": "e6547a1ce85e34ce9f46ad456f055a9f7be79b68", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/e6547a1ce85e34ce9f46ad456f055a9f7be79b68", "committedDate": "2020-12-01T15:48:10Z", "message": "[Refactor] Refactor DeleteHandler and Cond module"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e6547a1ce85e34ce9f46ad456f055a9f7be79b68", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/e6547a1ce85e34ce9f46ad456f055a9f7be79b68", "committedDate": "2020-12-01T15:48:10Z", "message": "[Refactor] Refactor DeleteHandler and Cond module"}, "afterCommit": {"oid": "352b777e7fa1c3949bf2f736547bb8e0312105f3", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/352b777e7fa1c3949bf2f736547bb8e0312105f3", "committedDate": "2020-12-01T15:59:51Z", "message": "[Refactor] Refactor DeleteHandler and Cond module"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "352b777e7fa1c3949bf2f736547bb8e0312105f3", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/352b777e7fa1c3949bf2f736547bb8e0312105f3", "committedDate": "2020-12-01T15:59:51Z", "message": "[Refactor] Refactor DeleteHandler and Cond module"}, "afterCommit": {"oid": "8e9656a002446f3ab93ba7e8821ca0c581bc13e9", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/8e9656a002446f3ab93ba7e8821ca0c581bc13e9", "committedDate": "2020-12-01T16:08:38Z", "message": "[Refactor] Refactor DeleteHandler and Cond module"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzOTAwOTQ2", "url": "https://github.com/apache/incubator-doris/pull/4925#pullrequestreview-543900946", "createdAt": "2020-12-03T12:24:37Z", "commit": {"oid": "8e9656a002446f3ab93ba7e8821ca0c581bc13e9"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f48dba873f5c27d3c5880971394b44c7ff0aa05", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/5f48dba873f5c27d3c5880971394b44c7ff0aa05", "committedDate": "2020-12-04T04:07:27Z", "message": "[Refactor] Refactor DeleteHandler and Cond module"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e9656a002446f3ab93ba7e8821ca0c581bc13e9", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/8e9656a002446f3ab93ba7e8821ca0c581bc13e9", "committedDate": "2020-12-01T16:08:38Z", "message": "[Refactor] Refactor DeleteHandler and Cond module"}, "afterCommit": {"oid": "5f48dba873f5c27d3c5880971394b44c7ff0aa05", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/5f48dba873f5c27d3c5880971394b44c7ff0aa05", "committedDate": "2020-12-04T04:07:27Z", "message": "[Refactor] Refactor DeleteHandler and Cond module"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NjQ0NjEx", "url": "https://github.com/apache/incubator-doris/pull/4925#pullrequestreview-544644611", "createdAt": "2020-12-04T04:13:10Z", "commit": {"oid": "5f48dba873f5c27d3c5880971394b44c7ff0aa05"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4614, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}