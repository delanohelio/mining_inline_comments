{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMjA2NTk4", "number": 4256, "title": "Support sequence column for UNIQUE_KEYS Table", "bodyText": "For #3930", "createdAt": "2020-08-05T07:40:56Z", "url": "https://github.com/apache/incubator-doris/pull/4256", "merged": true, "mergeCommit": {"oid": "068707484d16bbb26a7944baf89244ced07c2471"}, "closed": true, "closedAt": "2020-09-04T02:10:18Z", "author": {"login": "Youngwb"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8PLR1ABqjM2Mjg4NTk0Mjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEJLduAFqTQ3ODI2OTQwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e7ad192060a65487d5cd8d42be20052b80e1639b", "author": {"user": {"login": "Youngwb", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/e7ad192060a65487d5cd8d42be20052b80e1639b", "committedDate": "2020-08-06T07:03:22Z", "message": "Merge branch 'sequence_col' of https://github.com/Youngwb/incubator-doris into sequence_col"}, "afterCommit": {"oid": "3f083204347daf3d8024d4a571c2240354f2d01b", "author": {"user": {"login": "Youngwb", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/3f083204347daf3d8024d4a571c2240354f2d01b", "committedDate": "2020-08-06T12:05:38Z", "message": "add sequence  col"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzOTMyMjc3", "url": "https://github.com/apache/incubator-doris/pull/4256#pullrequestreview-463932277", "createdAt": "2020-08-10T02:26:42Z", "commit": {"oid": "3f083204347daf3d8024d4a571c2240354f2d01b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwMjoyNjo0MlrOG9_5vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwMjoyNjo0MlrOG9_5vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MzI5NA==", "bodyText": "how about checking sequence_col_idx != -1 instead of _has_sequence_col", "url": "https://github.com/apache/incubator-doris/pull/4256#discussion_r467663294", "createdAt": "2020-08-10T02:26:42Z", "author": {"login": "yangzhg"}, "path": "be/src/olap/tablet_schema.h", "diffHunk": "@@ -111,6 +111,8 @@ class TabletSchema {\n     inline double bloom_filter_fpp() const { return _bf_fpp; }\n     inline bool is_in_memory() const { return _is_in_memory; }\n     inline void set_is_in_memory(bool is_in_memory) { _is_in_memory = is_in_memory; }\n+    inline bool has_sequence_col() const { return  _has_sequence_col; }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f083204347daf3d8024d4a571c2240354f2d01b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzOTM5OTIx", "url": "https://github.com/apache/incubator-doris/pull/4256#pullrequestreview-463939921", "createdAt": "2020-08-10T03:17:02Z", "commit": {"oid": "3f083204347daf3d8024d4a571c2240354f2d01b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwMzoxNzowMlrOG-AZlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwMzoxNzowMlrOG-AZlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY3MTQ0NA==", "bodyText": "why do not check if sequenceColName ia alread exist in rollupSchema", "url": "https://github.com/apache/incubator-doris/pull/4256#discussion_r467671444", "createdAt": "2020-08-10T03:17:02Z", "author": {"login": "yangzhg"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "diffHunk": "@@ -537,6 +538,13 @@ private RollupJobV2 createMaterializedViewJob(String mvName, String baseIndexNam\n                     }\n                 }\n             }\n+            if (KeysType.UNIQUE_KEYS == keysType && olapTable.hasSequence()) {\n+                if (meetValue) {\n+                    // add the sequence column\n+                    rollupSchema.add(keysNumOfRollup, new Column(olapTable.sequenceColName, olapTable.getSequenceType(),\n+                            false, AggregateType.MAX, null, \"\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f083204347daf3d8024d4a571c2240354f2d01b"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MDU0MDEz", "url": "https://github.com/apache/incubator-doris/pull/4256#pullrequestreview-464054013", "createdAt": "2020-08-10T08:50:28Z", "commit": {"oid": "3f083204347daf3d8024d4a571c2240354f2d01b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODo1MDoyOFrOG-GOWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODo1MDoyOFrOG-GOWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc2Njg3Mg==", "bodyText": "not using \uff1f", "url": "https://github.com/apache/incubator-doris/pull/4256#discussion_r467766872", "createdAt": "2020-08-10T08:50:28Z", "author": {"login": "yangzhg"}, "path": "fe/fe-core/src/main/java/org/apache/doris/common/FeMetaVersion.java", "diffHunk": "@@ -190,6 +190,8 @@\n     // force drop db, force drop table, force drop partition\n     // make force drop operation do not recycle meta\n     public static final int VERSION_89 = 89;\n+    // sequence column for unique_keys\n+    public static final int VERSION_90 = 90;\n     // note: when increment meta version, should assign the latest version to VERSION_CURRENT\n-    public static final int VERSION_CURRENT = VERSION_89;\n+    public static final int VERSION_CURRENT = VERSION_90;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f083204347daf3d8024d4a571c2240354f2d01b"}, "originalPosition": 8}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "56a838724e9f5e10d206c1f74ddd8b598dd4bdf3", "author": {"user": {"login": "Youngwb", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/56a838724e9f5e10d206c1f74ddd8b598dd4bdf3", "committedDate": "2020-08-10T09:27:20Z", "message": "fix"}, "afterCommit": {"oid": "6f1566e097332af367a9b9d5a4cc686030712e2e", "author": {"user": {"login": "Youngwb", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/6f1566e097332af367a9b9d5a4cc686030712e2e", "committedDate": "2020-08-10T16:05:11Z", "message": "add sequence  col"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0OTAzMTQx", "url": "https://github.com/apache/incubator-doris/pull/4256#pullrequestreview-464903141", "createdAt": "2020-08-11T09:33:56Z", "commit": {"oid": "3d287fd80d29bb0484789f9291022c181900ecde"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9e62c93e5214cf63f24bd789029bb52cbb06edb", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/d9e62c93e5214cf63f24bd789029bb52cbb06edb", "committedDate": "2020-08-12T09:53:25Z", "message": "fix for CREATE EXTERNAL TABLE"}, "afterCommit": {"oid": "9964eb5ade0edce879713225f28fc5a3037fe3f8", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/9964eb5ade0edce879713225f28fc5a3037fe3f8", "committedDate": "2020-08-25T07:35:20Z", "message": "rebase"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6860383228ce5db82e9207d47e3971a6b703adc3", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/6860383228ce5db82e9207d47e3971a6b703adc3", "committedDate": "2020-08-27T07:26:01Z", "message": "fix UT"}, "afterCommit": {"oid": "9d04603d8e655e4296ba3cbe8928d3c5e52e4f2d", "author": {"user": {"login": "Youngwb", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/9d04603d8e655e4296ba3cbe8928d3c5e52e4f2d", "committedDate": "2020-08-27T07:40:18Z", "message": "add sequence  col"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d04603d8e655e4296ba3cbe8928d3c5e52e4f2d", "author": {"user": {"login": "Youngwb", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/9d04603d8e655e4296ba3cbe8928d3c5e52e4f2d", "committedDate": "2020-08-27T07:40:18Z", "message": "add sequence  col"}, "afterCommit": {"oid": "7f278fd9f73a1eeab0cde6b3577ab8ab9eff492a", "author": {"user": {"login": "Youngwb", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/7f278fd9f73a1eeab0cde6b3577ab8ab9eff492a", "committedDate": "2020-08-27T15:18:22Z", "message": "add sequence  col"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MjA1NjAx", "url": "https://github.com/apache/incubator-doris/pull/4256#pullrequestreview-477205601", "createdAt": "2020-08-28T02:44:40Z", "commit": {"oid": "7f278fd9f73a1eeab0cde6b3577ab8ab9eff492a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwMjo0NDo0MFrOHInoMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwMjo0NDo0MFrOHInoMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc5OTkyMQ==", "bodyText": "indent\uff1f", "url": "https://github.com/apache/incubator-doris/pull/4256#discussion_r478799921", "createdAt": "2020-08-28T02:44:40Z", "author": {"login": "yangzhg"}, "path": "be/test/olap/test_data/header.txt", "diffHunk": "@@ -50,7 +50,8 @@\n         \"compress_kind\": \"COMPRESS_LZ4\",\n         \"next_column_unique_id\": 3,\n         \"is_in_memory\": false,\n-        \"delete_sign_idx\": -1\n+        \"delete_sign_idx\": -1,\n+\t    \"has_sequence_col\": false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f278fd9f73a1eeab0cde6b3577ab8ab9eff492a"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "41e076816b3ee8a2c11bf8d017a499cce04039f6", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/41e076816b3ee8a2c11bf8d017a499cce04039f6", "committedDate": "2020-08-28T02:47:43Z", "message": "fix"}, "afterCommit": {"oid": "fdaaccf62a07cff02801b7b17700bc7fbca8c7b3", "author": {"user": {"login": "Youngwb", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/fdaaccf62a07cff02801b7b17700bc7fbca8c7b3", "committedDate": "2020-08-28T03:11:42Z", "message": "add sequence  col"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MjE1ODYz", "url": "https://github.com/apache/incubator-doris/pull/4256#pullrequestreview-477215863", "createdAt": "2020-08-28T03:23:07Z", "commit": {"oid": "fdaaccf62a07cff02801b7b17700bc7fbca8c7b3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwMzoyMzowN1rOHIoLlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwMzoyMzowN1rOHIoLlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgwODk4MA==", "bodyText": "add AggregateType.MAX to unique table ??", "url": "https://github.com/apache/incubator-doris/pull/4256#discussion_r478808980", "createdAt": "2020-08-28T03:23:07Z", "author": {"login": "yangzhg"}, "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/OlapTable.java", "diffHunk": "@@ -796,6 +801,43 @@ public void setBloomFilterInfo(Set<String> bfColumns, double bfFpp) {\n         this.bfFpp = bfFpp;\n     }\n \n+    public void setSequenceInfo(Type type) {\n+        this.hasSequenceCol = true;\n+        this.sequenceType = type;\n+\n+        // sequence column is value column with MAX aggregate type\n+        // this makes it easy to compare and update the sequence column\n+        Column sequenceCol = new Column(Column.SEQUENCE_COL, type, false, AggregateType.MAX, false, null, \"\", false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdaaccf62a07cff02801b7b17700bc7fbca8c7b3"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac52dd946f2ddde0309a7583e3f127d86817b4b5", "author": {"user": {"login": "Youngwb", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/ac52dd946f2ddde0309a7583e3f127d86817b4b5", "committedDate": "2020-08-28T07:42:03Z", "message": "add sequence  col"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb7bdee92a8df21c4707849f48edc84d00da4b2b", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/cb7bdee92a8df21c4707849f48edc84d00da4b2b", "committedDate": "2020-08-28T07:17:14Z", "message": "fix"}, "afterCommit": {"oid": "ac52dd946f2ddde0309a7583e3f127d86817b4b5", "author": {"user": {"login": "Youngwb", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/ac52dd946f2ddde0309a7583e3f127d86817b4b5", "committedDate": "2020-08-28T07:42:03Z", "message": "add sequence  col"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08cf336a589efeb55a78add23cc6f5bbed0965d7", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/08cf336a589efeb55a78add23cc6f5bbed0965d7", "committedDate": "2020-08-28T08:03:16Z", "message": "fix rollup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99edfdeb34c07b1af2a5a2942b14dbb263f52981", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/99edfdeb34c07b1af2a5a2942b14dbb263f52981", "committedDate": "2020-08-28T08:37:00Z", "message": "fix for camelCase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25153c4254542260c0f6c256ba8761fec7aeeb0b", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/25153c4254542260c0f6c256ba8761fec7aeeb0b", "committedDate": "2020-08-28T08:41:23Z", "message": "fix for camelCase"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NTcwMzI5", "url": "https://github.com/apache/incubator-doris/pull/4256#pullrequestreview-477570329", "createdAt": "2020-08-28T09:10:59Z", "commit": {"oid": "25153c4254542260c0f6c256ba8761fec7aeeb0b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fb769491a678d4573f0e5666676e80a82e9307c", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/1fb769491a678d4573f0e5666676e80a82e9307c", "committedDate": "2020-08-28T12:46:18Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad7eab7a65578b682c25e5923c7dd3f3b5a50073", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/ad7eab7a65578b682c25e5923c7dd3f3b5a50073", "committedDate": "2020-08-28T17:47:00Z", "message": "fix for null sequence_col"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MjY5NDAw", "url": "https://github.com/apache/incubator-doris/pull/4256#pullrequestreview-478269400", "createdAt": "2020-08-31T02:14:36Z", "commit": {"oid": "ad7eab7a65578b682c25e5923c7dd3f3b5a50073"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2149, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}