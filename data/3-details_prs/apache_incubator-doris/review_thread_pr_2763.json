{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyNjAyOTc4", "number": 2763, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNDozODoxNFrODX3pbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwODozNToyNVrODY_S4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MzU1NTY3OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/alter/Alter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNDozODoxNFrOFdZsbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwOTo1MToyOFrOFdylsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM3Mzk5OA==", "bodyText": "First, olapTable.getState() != OlapTableState.NORMAL does not mean the table is unhealthy.\nSecond, it's not good to sleep here, it will block the client connection for a very long time.\nThird, I don't think its good idea to add priority repair here.  We should solve more why the table is often unhealthy, rather than increase the complexity here.", "url": "https://github.com/apache/incubator-doris/pull/2763#discussion_r366373998", "createdAt": "2020-01-14T14:38:14Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -273,6 +276,18 @@ public void processAlterTable(AlterTableStmt stmt) throws UserException {\n                 throw new DdlException(\"table with empty parition cannot do schema change. [\" + tableName + \"]\");\n             }\n \n+            // if table state is unhealthy, change table repair priority, and wait until repair finish or exceed timeout\n+            if (olapTable.getState() != OlapTableState.NORMAL) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7f4fd603f6b584e64715e15682ed2c067bd7ca9"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njc4MTg3Mw==", "bodyText": "@morningman Yes, you're right, I change the waiting logic to runPendingJob.", "url": "https://github.com/apache/incubator-doris/pull/2763#discussion_r366781873", "createdAt": "2020-01-15T09:51:28Z", "author": {"login": "WingsGo"}, "path": "fe/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -273,6 +276,18 @@ public void processAlterTable(AlterTableStmt stmt) throws UserException {\n                 throw new DdlException(\"table with empty parition cannot do schema change. [\" + tableName + \"]\");\n             }\n \n+            // if table state is unhealthy, change table repair priority, and wait until repair finish or exceed timeout\n+            if (olapTable.getState() != OlapTableState.NORMAL) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM3Mzk5OA=="}, "originalCommit": {"oid": "f7f4fd603f6b584e64715e15682ed2c067bd7ca9"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MDMxODM5OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeJobV2.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDowOToxNFrOFeaicw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDowOToxNFrOFeaicw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzNjQwMw==", "bodyText": "You can add this error msg to the errMsg of the AlterJob, so that user can see what happen.\nAnd this log should contains job id for debugging. And in errMsg, it can be shorten, eg, \"table is unstable\".", "url": "https://github.com/apache/incubator-doris/pull/2763#discussion_r367436403", "createdAt": "2020-01-16T14:09:14Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeJobV2.java", "diffHunk": "@@ -184,13 +184,22 @@ protected void runPendingJob() throws AlterCancelException {\n                 totalReplicaNum += tablet.getReplicas().size();\n             }\n         }\n-        MarkedCountDownLatch<Long, Long> countDownLatch = new MarkedCountDownLatch<Long, Long>(totalReplicaNum);\n+        MarkedCountDownLatch<Long, Long> countDownLatch = new MarkedCountDownLatch<>(totalReplicaNum);\n         db.readLock();\n         try {\n             OlapTable tbl = (OlapTable) db.getTable(tableId);\n             if (tbl == null) {\n                 throw new AlterCancelException(\"Table \" + tableId + \" does not exist\");\n-            } \n+            }\n+\n+            boolean isStable = tbl.isStable(Catalog.getCurrentSystemInfo(),\n+                    Catalog.getCurrentCatalog().getTabletScheduler(),\n+                    db.getClusterName());\n+            if (!isStable) {\n+                LOG.warn(\"doing schema change job while table is not stable, wait until tablet to be repaired.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f826c97a3594f505bdeb429a7005ec527486cd55"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MDMyNjk1OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/clone/TabletChecker.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoxMTo1MFrOFean1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoxMTo1MFrOFean1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzNzc4Mw==", "bodyText": "Why not just pass the entire repairTabletInfo? instead of each field of repairTabletInfo?\nAnd addPrios() can be a private method.", "url": "https://github.com/apache/incubator-doris/pull/2763#discussion_r367437783", "createdAt": "2020-01-16T14:11:50Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/clone/TabletChecker.java", "diffHunk": "@@ -356,71 +368,72 @@ private void removePriosIfNecessary() {\n      * when being scheduled.\n      */\n     public void repairTable(AdminRepairTableStmt stmt) throws DdlException {\n-        Catalog catalog = Catalog.getCurrentCatalog();\n-        Database db = catalog.getDb(stmt.getDbName());\n-        if (db == null) {\n-            throw new DdlException(\"Database \" + stmt.getDbName() + \" does not exist\");\n-        }\n+        RepairTabletInfo repairTabletInfo = getRepairTabletInfo(stmt.getDbName(), stmt.getTblName(), stmt.getPartitions());\n+        addPrios(repairTabletInfo.dbId, repairTabletInfo.tblId, repairTabletInfo.partIds, stmt.getTimeoutS() * 1000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f826c97a3594f505bdeb429a7005ec527486cd55"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MDMyNzY1OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/clone/TabletChecker.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoxMjowNlrOFeaoVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoxMjowNlrOFeaoVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzNzkwOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    removePrios(repairTabletInfo.dbId, repairTabletInfo.tblId, repairTabletInfo.partIds);\n          \n          \n            \n                    removePrios(repairTabletInfo);", "url": "https://github.com/apache/incubator-doris/pull/2763#discussion_r367437908", "createdAt": "2020-01-16T14:12:06Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/clone/TabletChecker.java", "diffHunk": "@@ -356,71 +368,72 @@ private void removePriosIfNecessary() {\n      * when being scheduled.\n      */\n     public void repairTable(AdminRepairTableStmt stmt) throws DdlException {\n-        Catalog catalog = Catalog.getCurrentCatalog();\n-        Database db = catalog.getDb(stmt.getDbName());\n-        if (db == null) {\n-            throw new DdlException(\"Database \" + stmt.getDbName() + \" does not exist\");\n-        }\n+        RepairTabletInfo repairTabletInfo = getRepairTabletInfo(stmt.getDbName(), stmt.getTblName(), stmt.getPartitions());\n+        addPrios(repairTabletInfo.dbId, repairTabletInfo.tblId, repairTabletInfo.partIds, stmt.getTimeoutS() * 1000);\n+        LOG.info(\"repair database: {}, table: {}, partition: {}\", repairTabletInfo.dbId, repairTabletInfo.tblId, repairTabletInfo.partIds);\n+    }\n \n-        long dbId = db.getId();\n-        long tblId = -1;\n-        List<Long> partIds = Lists.newArrayList();\n-        db.readLock();\n-        try {\n-            Table tbl = db.getTable(stmt.getTblName());\n-            if (tbl == null || tbl.getType() != TableType.OLAP) {\n-                throw new DdlException(\"Table does not exist or is not OLAP table: \" + stmt.getTblName());\n+    /*\n+     * handle ADMIN CANCEL REPAIR TABLE stmt send by user.\n+     * This operation will remove the specified partitions from 'prios'\n+     */\n+    public void cancelRepairTable(AdminCancelRepairTableStmt stmt) throws DdlException {\n+        RepairTabletInfo repairTabletInfo = getRepairTabletInfo(stmt.getDbName(), stmt.getTblName(), stmt.getPartitions());\n+        removePrios(repairTabletInfo.dbId, repairTabletInfo.tblId, repairTabletInfo.partIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f826c97a3594f505bdeb429a7005ec527486cd55"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MDMzOTgyOnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/alter/Alter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoxNTo1MlrOFeav1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNjoxMzowN1rOFefDKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzOTgyOA==", "bodyText": "I think rollup job can be changed to same as schema change job.", "url": "https://github.com/apache/incubator-doris/pull/2763#discussion_r367439828", "createdAt": "2020-01-16T14:15:52Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -276,8 +276,9 @@ public void processAlterTable(AlterTableStmt stmt) throws UserException {\n             if (olapTable.getState() != OlapTableState.NORMAL) {\n                 throw new DdlException(\"Table[\" + table.getName() + \"]'s state is not NORMAL. Do not allow doing ALTER ops\");\n             }\n-            \n-            if (needTableStable) {\n+\n+            // schema change job will wait until table become stable\n+            if (needTableStable && !hasSchemaChange) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f826c97a3594f505bdeb429a7005ec527486cd55"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUxMDMxNA==", "bodyText": "@morningman Done", "url": "https://github.com/apache/incubator-doris/pull/2763#discussion_r367510314", "createdAt": "2020-01-16T16:13:07Z", "author": {"login": "WingsGo"}, "path": "fe/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -276,8 +276,9 @@ public void processAlterTable(AlterTableStmt stmt) throws UserException {\n             if (olapTable.getState() != OlapTableState.NORMAL) {\n                 throw new DdlException(\"Table[\" + table.getName() + \"]'s state is not NORMAL. Do not allow doing ALTER ops\");\n             }\n-            \n-            if (needTableStable) {\n+\n+            // schema change job will wait until table become stable\n+            if (needTableStable && !hasSchemaChange) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzOTgyOA=="}, "originalCommit": {"oid": "f826c97a3594f505bdeb429a7005ec527486cd55"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NTI5MjY5OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/alter/RollupJobV2.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwODoyOToxMVrOFfKDKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwODoyOToxMVrOFfKDKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIxNDgyNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            LOG.warn(\"doing rollup job: \" + jobId + \"while table is not stable.\");\n          \n          \n            \n                            LOG.warn(\"doing rollup job: \" + jobId + \" while table is not stable.\");", "url": "https://github.com/apache/incubator-doris/pull/2763#discussion_r368214827", "createdAt": "2020-01-18T08:29:11Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/alter/RollupJobV2.java", "diffHunk": "@@ -168,8 +168,17 @@ protected void runPendingJob() throws AlterCancelException {\n             if (tbl == null) {\n                 throw new AlterCancelException(\"Table \" + tableId + \" does not exist\");\n             }\n-            Preconditions.checkState(tbl.getState() == OlapTableState.ROLLUP);\n \n+            boolean isStable = tbl.isStable(Catalog.getCurrentSystemInfo(),\n+                    Catalog.getCurrentCatalog().getTabletScheduler(),\n+                    db.getClusterName());\n+            if (!isStable) {\n+                errMsg = \"table is unstable\";\n+                LOG.warn(\"doing rollup job: \" + jobId + \"while table is not stable.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09a00f4511e46f5db0b10e361704ea32cb21b3e9"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NTI5NDQzOnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeJobV2.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwODozNToyNVrOFfKECw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwODozNToyNVrOFfKECw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIxNTA1MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            LOG.warn(\"doing schema change job: \" + jobId + \"while table is not stable.\");\n          \n          \n            \n                            LOG.warn(\"doing schema change job: \" + jobId + \" while table is not stable.\");", "url": "https://github.com/apache/incubator-doris/pull/2763#discussion_r368215051", "createdAt": "2020-01-18T08:35:25Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeJobV2.java", "diffHunk": "@@ -184,13 +184,23 @@ protected void runPendingJob() throws AlterCancelException {\n                 totalReplicaNum += tablet.getReplicas().size();\n             }\n         }\n-        MarkedCountDownLatch<Long, Long> countDownLatch = new MarkedCountDownLatch<Long, Long>(totalReplicaNum);\n+        MarkedCountDownLatch<Long, Long> countDownLatch = new MarkedCountDownLatch<>(totalReplicaNum);\n         db.readLock();\n         try {\n             OlapTable tbl = (OlapTable) db.getTable(tableId);\n             if (tbl == null) {\n                 throw new AlterCancelException(\"Table \" + tableId + \" does not exist\");\n-            } \n+            }\n+\n+            boolean isStable = tbl.isStable(Catalog.getCurrentSystemInfo(),\n+                    Catalog.getCurrentCatalog().getTabletScheduler(),\n+                    db.getClusterName());\n+            if (!isStable) {\n+                errMsg = \"table is unstable\";\n+                LOG.warn(\"doing schema change job: \" + jobId + \"while table is not stable.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09a00f4511e46f5db0b10e361704ea32cb21b3e9"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2353, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}