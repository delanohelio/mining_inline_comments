{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxNzk3MjQx", "number": 3985, "title": "[Doris On ES] [Bug-Fix][Refactor] Fix potential null pointer exception and refactor function process logic", "bodyText": "fix: #3984\n\nadd conjunct.size checking and slot_desc nullptr checking logic\nFor historical reasons, the function predicates are added one by one, I just refactor the processing make thelogic for function predicate processing more clearly", "createdAt": "2020-06-30T05:47:01Z", "url": "https://github.com/apache/incubator-doris/pull/3985", "merged": true, "mergeCommit": {"oid": "1e813df3fd3b1127d8be9449138fa087f49abc2f"}, "closed": true, "closedAt": "2020-07-02T14:32:17Z", "author": {"login": "wuyunfeng"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwPSjIgFqTQzOTY5MzM2Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcw_xAwAFqTQ0MTczNjc3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NjkzMzY2", "url": "https://github.com/apache/incubator-doris/pull/3985#pullrequestreview-439693366", "createdAt": "2020-06-30T06:03:16Z", "commit": {"oid": "e54f060cfbb609f251ddb21fcf8cffeb5672bef0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNjowMzoxNlrOGqs8Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNjowMzoxNlrOGqs8Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQyOTcxOQ==", "bodyText": "\u5224\u65ad\u4e0b conjunt->children_size()?\n\u6211\u770b\u540e\u9762\u5f88\u591a\u76f4\u63a5\u53d6index\u7684\u3002", "url": "https://github.com/apache/incubator-doris/pull/3985#discussion_r447429719", "createdAt": "2020-06-30T06:03:16Z", "author": {"login": "blackfox1983"}, "path": "be/src/exec/es/es_predicate.cpp", "diffHunk": "@@ -283,93 +283,91 @@ Status EsPredicate::build_disjuncts_list(const Expr* conjunct) {\n         _disjuncts.push_back(predicate);\n         return Status::OK();\n     }\n-    \n-    if (is_match_func(conjunct)) {\n-        Expr* expr = conjunct->get_child(1);\n-        ExtLiteral literal(expr->type().type, _context->get_value(expr, NULL));\n-        vector<ExtLiteral> query_conditions;\n-        query_conditions.emplace_back(literal);\n-        vector<ExtColumnDesc> cols; //TODO\n-        ExtPredicate* predicate = new ExtFunction(\n-                        TExprNodeType::FUNCTION_CALL,\n-                        conjunct->fn().name.function_name,\n-                        cols,\n-                        query_conditions);\n-        if (_es_query_status.ok()) {\n-            _es_query_status \n-                = BooleanQueryBuilder::check_es_query(*(ExtFunction *)predicate); \n-            if (!_es_query_status.ok()) {\n-                delete predicate;\n-                return _es_query_status;\n-            }\n-        }\n-        _disjuncts.push_back(predicate);\n-\n-        return Status::OK();\n-    }\n-\n-    if (TExprNodeType::FUNCTION_CALL == conjunct->node_type()\n-        && (conjunct->fn().name.function_name == \"is_null_pred\" || conjunct->fn().name.function_name == \"is_not_null_pred\")) {\n-        // such as sub-query: select * from (select split_part(k, \"_\", 1) as new_field from case_replay_for_milimin) t where t.new_field > 1;\n-        // conjunct->get_child(0)->node_type() == TExprNodeType::FUNCTION_CALL, at present doris on es can not support push down function \n-        RETURN_ERROR_IF_EXPR_IS_NOT_SLOTREF(conjunct->get_child(0));\n-        SlotRef* slot_ref = (SlotRef*)(conjunct->get_child(0));\n-        const SlotDescriptor* slot_desc = get_slot_desc(slot_ref);\n-        bool is_not_null;\n-        if (conjunct->fn().name.function_name == \"is_null_pred\") {\n-            is_not_null = false;\n-        } else {\n-            is_not_null = true;\n-        }\n-        std::string col = slot_desc->col_name();\n-        if (_field_context.find(col) != _field_context.end()) {\n-            col = _field_context[col];\n-        }\n-        // use TExprNodeType::IS_NULL_PRED for BooleanQueryBuilder translate\n-        ExtIsNullPredicate* predicate = new ExtIsNullPredicate(TExprNodeType::IS_NULL_PRED, col, slot_desc->type(), is_not_null);\n-        _disjuncts.push_back(predicate);\n-        return Status::OK();\n-    }\n-\n+    // process function call predicate: esquery, is_null_pred, is_not_null_pred\n     if (TExprNodeType::FUNCTION_CALL == conjunct->node_type()) {\n         std::string fname = conjunct->fn().name.function_name;\n-        if (fname != \"like\") {\n-            return Status::InternalError(\"build disjuncts failed: function name is not like\");\n-        }\n+        if (fname == \"esquery\") {\n+            Expr* expr = conjunct->get_child(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e54f060cfbb609f251ddb21fcf8cffeb5672bef0"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5Njk1OTEx", "url": "https://github.com/apache/incubator-doris/pull/3985#pullrequestreview-439695911", "createdAt": "2020-06-30T06:09:15Z", "commit": {"oid": "e54f060cfbb609f251ddb21fcf8cffeb5672bef0"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5OTUzMzQw", "url": "https://github.com/apache/incubator-doris/pull/3985#pullrequestreview-439953340", "createdAt": "2020-06-30T12:15:08Z", "commit": {"oid": "fb162abc1de5932871036a59c25dd25b06419967"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNTAwNDU3", "url": "https://github.com/apache/incubator-doris/pull/3985#pullrequestreview-440500457", "createdAt": "2020-07-01T02:08:03Z", "commit": {"oid": "fb162abc1de5932871036a59c25dd25b06419967"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMzIyNDU5", "url": "https://github.com/apache/incubator-doris/pull/3985#pullrequestreview-441322459", "createdAt": "2020-07-02T03:16:40Z", "commit": {"oid": "fb162abc1de5932871036a59c25dd25b06419967"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNDIyNDA1", "url": "https://github.com/apache/incubator-doris/pull/3985#pullrequestreview-441422405", "createdAt": "2020-07-02T07:36:29Z", "commit": {"oid": "fb162abc1de5932871036a59c25dd25b06419967"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a94c1a9173827926c6e9a357754eaf72d589249a", "author": {"user": {"login": "wuyunfeng", "name": "Yunfeng,Wu"}}, "url": "https://github.com/apache/incubator-doris/commit/a94c1a9173827926c6e9a357754eaf72d589249a", "committedDate": "2020-07-02T08:16:43Z", "message": "[Doris On ES] fix potential null pointer exception and refactor some code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "033e3c8bc829157463f63b5a1593591956e13c5a", "author": {"user": {"login": "wuyunfeng", "name": "Yunfeng,Wu"}}, "url": "https://github.com/apache/incubator-doris/commit/033e3c8bc829157463f63b5a1593591956e13c5a", "committedDate": "2020-07-02T08:16:43Z", "message": "[Doris On ES] fix potential null pointer exception and refactor some code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb162abc1de5932871036a59c25dd25b06419967", "author": {"user": {"login": "wuyunfeng", "name": "Yunfeng,Wu"}}, "url": "https://github.com/apache/incubator-doris/commit/fb162abc1de5932871036a59c25dd25b06419967", "committedDate": "2020-06-30T11:50:11Z", "message": "[Doris On ES] fix potential null pointer exception and refactor some code"}, "afterCommit": {"oid": "033e3c8bc829157463f63b5a1593591956e13c5a", "author": {"user": {"login": "wuyunfeng", "name": "Yunfeng,Wu"}}, "url": "https://github.com/apache/incubator-doris/commit/033e3c8bc829157463f63b5a1593591956e13c5a", "committedDate": "2020-07-02T08:16:43Z", "message": "[Doris On ES] fix potential null pointer exception and refactor some code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNzM2Nzcz", "url": "https://github.com/apache/incubator-doris/pull/3985#pullrequestreview-441736773", "createdAt": "2020-07-02T14:32:00Z", "commit": {"oid": "033e3c8bc829157463f63b5a1593591956e13c5a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2229, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}