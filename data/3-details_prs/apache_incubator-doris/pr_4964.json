{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3OTI1NjUz", "number": 4964, "title": "[Bug][Compaction] Fix bug that output rowset is not deleted after compaction failure.", "bodyText": "Proposed changes\nThis CL fix 2 bugs:\n\n\n\nWhen the compaction fails, we must explicitly delete the output rowset,\notherwise the GC logic cannot process these rows.\n\n\n\nBase compaction failed if compaction process include some delete version in SegmentV2,\nBecause the number of filtered rows is wrong.\nTypes of changes\n\n Bugfix (non-breaking change which fixes an issue)\n\nChecklist\n\n I have create an issue on (Fix #4963 ), and have described the bug/feature there in detail", "createdAt": "2020-11-26T08:54:28Z", "url": "https://github.com/apache/incubator-doris/pull/4964", "merged": true, "mergeCommit": {"oid": "99404df8b22bab445b3ecb536e05d381901fcb6b"}, "closed": true, "closedAt": "2020-11-30T14:02:04Z", "author": {"login": "morningman"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgTLXEgFqTUzOTMyNDMwMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhfUmxAFqTU0MDYyNTMxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5MzI0MzAx", "url": "https://github.com/apache/incubator-doris/pull/4964#pullrequestreview-539324301", "createdAt": "2020-11-26T13:41:05Z", "commit": {"oid": "ec5186be8fb6ed789dce4c1a27923efe7da108c3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMzo0MTowNVrOH6b56Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMzo0MTowNVrOH6b56Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzNjY0OQ==", "bodyText": "Hi, is it compatible with segment v1?\nIn alpha_rowset_reader.h, filtered_rows() only calculates rows_del_filtered.", "url": "https://github.com/apache/incubator-doris/pull/4964#discussion_r531036649", "createdAt": "2020-11-26T13:41:05Z", "author": {"login": "xy720"}, "path": "be/src/olap/reader.h", "diffHunk": "@@ -128,7 +128,7 @@ class Reader {\n     }\n \n     uint64_t filtered_rows() const {\n-        return _stats.rows_del_filtered;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec5186be8fb6ed789dce4c1a27923efe7da108c3"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5Njc2NzQ2", "url": "https://github.com/apache/incubator-doris/pull/4964#pullrequestreview-539676746", "createdAt": "2020-11-27T02:37:13Z", "commit": {"oid": "ec5186be8fb6ed789dce4c1a27923efe7da108c3"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NzAzNTU3", "url": "https://github.com/apache/incubator-doris/pull/4964#pullrequestreview-539703557", "createdAt": "2020-11-27T04:36:17Z", "commit": {"oid": "ec5186be8fb6ed789dce4c1a27923efe7da108c3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5ODQ0ODI5", "url": "https://github.com/apache/incubator-doris/pull/4964#pullrequestreview-539844829", "createdAt": "2020-11-27T09:54:36Z", "commit": {"oid": "ec5186be8fb6ed789dce4c1a27923efe7da108c3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOTo1NDozNlrOH632iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOTo1NDozNlrOH632iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ5NDUzOQ==", "bodyText": "why not call gc_output_rowset in every succeed? It seems a new imported bug ?", "url": "https://github.com/apache/incubator-doris/pull/4964#discussion_r531494539", "createdAt": "2020-11-27T09:54:36Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/compaction.cpp", "diffHunk": "@@ -164,17 +173,11 @@ void Compaction::modify_rowsets() {\n     _tablet->save_meta();\n }\n \n-OLAPStatus Compaction::gc_unused_rowsets() {\n+void Compaction::gc_output_rowset() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec5186be8fb6ed789dce4c1a27923efe7da108c3"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNTUzNjAw", "url": "https://github.com/apache/incubator-doris/pull/4964#pullrequestreview-540553600", "createdAt": "2020-11-30T01:42:04Z", "commit": {"oid": "ec5186be8fb6ed789dce4c1a27923efe7da108c3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ea8fa53017e5e8cf447dc87a17fe6fd3a9a1a3f", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/8ea8fa53017e5e8cf447dc87a17fe6fd3a9a1a3f", "committedDate": "2020-11-30T06:18:37Z", "message": "rebase"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ec5186be8fb6ed789dce4c1a27923efe7da108c3", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/ec5186be8fb6ed789dce4c1a27923efe7da108c3", "committedDate": "2020-11-26T12:08:18Z", "message": "fix bug"}, "afterCommit": {"oid": "8ea8fa53017e5e8cf447dc87a17fe6fd3a9a1a3f", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/8ea8fa53017e5e8cf447dc87a17fe6fd3a9a1a3f", "committedDate": "2020-11-30T06:18:37Z", "message": "rebase"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNjI1MzE5", "url": "https://github.com/apache/incubator-doris/pull/4964#pullrequestreview-540625319", "createdAt": "2020-11-30T06:26:18Z", "commit": {"oid": "8ea8fa53017e5e8cf447dc87a17fe6fd3a9a1a3f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4639, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}