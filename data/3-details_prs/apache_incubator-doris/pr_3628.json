{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NDk0MzMz", "number": 3628, "title": "Fix first start error after upgrade doris to support delete dulplicate table value columns", "bodyText": "Fixes #3627", "createdAt": "2020-05-18T13:15:47Z", "url": "https://github.com/apache/incubator-doris/pull/3628", "merged": true, "mergeCommit": {"oid": "58a6628af2dcc985a1b4f2e6c8be485c8f80e040"}, "closed": true, "closedAt": "2020-05-20T01:39:25Z", "author": {"login": "yangzhg"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcifkl8AH2gAyNDE5NDk0MzMzOjMwMzE3NDhkNWExNjVkMTIwZWIzN2RiNmQzNmYyODA1ODdlYTZiZmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcit-WIAFqTQxNDEyMDQ5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3031748d5a165d120eb37db6d36f280587ea6bfd", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/3031748d5a165d120eb37db6d36f280587ea6bfd", "committedDate": "2020-05-18T13:06:32Z", "message": "fix first start error after upgrade doris to support delete dulplicat table value columns"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52dfc9300f2b966d4f3d5246a42200215cf828cf", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/52dfc9300f2b966d4f3d5246a42200215cf828cf", "committedDate": "2020-05-18T13:21:28Z", "message": "fix first start error after upgrade doris to support delete dulplicat table value columns"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNTg3NTc2", "url": "https://github.com/apache/incubator-doris/pull/3628#pullrequestreview-413587576", "createdAt": "2020-05-18T13:21:34Z", "commit": {"oid": "3031748d5a165d120eb37db6d36f280587ea6bfd"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMzoyMTozNFrOGW24gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMzoyNDoxMlrOGW2_NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYyMTA1OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            LOG(WARNING) << \"expect zone map size is \" << expect_zone_maps_num << \", actrual num is \" << zone_maps_size\n          \n          \n            \n                            LOG(WARNING) << \"expect zone map size is \" << expect_zone_maps_num << \", actual num is \" << zone_maps_size", "url": "https://github.com/apache/incubator-doris/pull/3628#discussion_r426621059", "createdAt": "2020-05-18T13:21:34Z", "author": {"login": "morningman"}, "path": "be/src/olap/rowset/alpha_rowset.cpp", "diffHunk": "@@ -300,16 +300,23 @@ OLAPStatus AlphaRowset::init() {\n \n         if (segment_group_meta.zone_maps_size() != 0) {\n             size_t zone_maps_size = segment_group_meta.zone_maps_size();\n-            size_t num_key_columns = _schema->keys_type() == KeysType::DUP_KEYS ? _schema->num_columns() : _schema->num_key_columns();\n-            if (num_key_columns != zone_maps_size) {\n+            size_t expect_zone_maps_num = _schema->keys_type() == KeysType::DUP_KEYS ? _schema->num_columns() : _schema->num_key_columns();\n+            if ((_schema->keys_type() != KeysType::DUP_KEYS && expect_zone_maps_num != zone_maps_size) \n+            || (_schema->keys_type() == KeysType::DUP_KEYS && expect_zone_maps_num < zone_maps_size)) {\n                 LOG(ERROR) << \"column pruning size is error.\"\n+                        << \"KeysType=\" << KeysType_Name(_schema->keys_type()) << \", \"\n                         << \"zone_maps_size=\" << zone_maps_size << \", \"\n-                        << \"num_key_columns=\" << _schema->num_key_columns();\n+                        << \"num_key_columns=\" << _schema->num_key_columns() << \", \"\n+                        << \"num_columns=\" << _schema->num_columns();\n                 return OLAP_ERR_TABLE_INDEX_VALIDATE_ERROR;\n             }\n-            std::vector<std::pair<std::string, std::string>> zone_map_strings(num_key_columns);\n-            std::vector<bool> null_vec(num_key_columns);\n-            for (size_t j = 0; j < num_key_columns; ++j) {\n+            if (expect_zone_maps_num > zone_maps_size) {\n+                LOG(WARNING) << \"expect zone map size is \" << expect_zone_maps_num << \", actrual num is \" << zone_maps_size", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3031748d5a165d120eb37db6d36f280587ea6bfd"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYyMTY5OQ==", "bodyText": "Better add comment to explain the logic here.", "url": "https://github.com/apache/incubator-doris/pull/3628#discussion_r426621699", "createdAt": "2020-05-18T13:22:34Z", "author": {"login": "morningman"}, "path": "be/src/olap/rowset/alpha_rowset.cpp", "diffHunk": "@@ -300,16 +300,23 @@ OLAPStatus AlphaRowset::init() {\n \n         if (segment_group_meta.zone_maps_size() != 0) {\n             size_t zone_maps_size = segment_group_meta.zone_maps_size();\n-            size_t num_key_columns = _schema->keys_type() == KeysType::DUP_KEYS ? _schema->num_columns() : _schema->num_key_columns();\n-            if (num_key_columns != zone_maps_size) {\n+            size_t expect_zone_maps_num = _schema->keys_type() == KeysType::DUP_KEYS ? _schema->num_columns() : _schema->num_key_columns();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3031748d5a165d120eb37db6d36f280587ea6bfd"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYyMjc3Mw==", "bodyText": "Better to add tablet id in log, or we can not know what tablet is wrong", "url": "https://github.com/apache/incubator-doris/pull/3628#discussion_r426622773", "createdAt": "2020-05-18T13:24:12Z", "author": {"login": "morningman"}, "path": "be/src/olap/rowset/alpha_rowset.cpp", "diffHunk": "@@ -300,16 +300,23 @@ OLAPStatus AlphaRowset::init() {\n \n         if (segment_group_meta.zone_maps_size() != 0) {\n             size_t zone_maps_size = segment_group_meta.zone_maps_size();\n-            size_t num_key_columns = _schema->keys_type() == KeysType::DUP_KEYS ? _schema->num_columns() : _schema->num_key_columns();\n-            if (num_key_columns != zone_maps_size) {\n+            size_t expect_zone_maps_num = _schema->keys_type() == KeysType::DUP_KEYS ? _schema->num_columns() : _schema->num_key_columns();\n+            if ((_schema->keys_type() != KeysType::DUP_KEYS && expect_zone_maps_num != zone_maps_size) \n+            || (_schema->keys_type() == KeysType::DUP_KEYS && expect_zone_maps_num < zone_maps_size)) {\n                 LOG(ERROR) << \"column pruning size is error.\"\n+                        << \"KeysType=\" << KeysType_Name(_schema->keys_type()) << \", \"\n                         << \"zone_maps_size=\" << zone_maps_size << \", \"\n-                        << \"num_key_columns=\" << _schema->num_key_columns();\n+                        << \"num_key_columns=\" << _schema->num_key_columns() << \", \"\n+                        << \"num_columns=\" << _schema->num_columns();\n                 return OLAP_ERR_TABLE_INDEX_VALIDATE_ERROR;\n             }\n-            std::vector<std::pair<std::string, std::string>> zone_map_strings(num_key_columns);\n-            std::vector<bool> null_vec(num_key_columns);\n-            for (size_t j = 0; j < num_key_columns; ++j) {\n+            if (expect_zone_maps_num > zone_maps_size) {\n+                LOG(WARNING) << \"expect zone map size is \" << expect_zone_maps_num << \", actrual num is \" << zone_maps_size", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3031748d5a165d120eb37db6d36f280587ea6bfd"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d60b0f8309c009a5f318f444da9392b75615d1dc", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/d60b0f8309c009a5f318f444da9392b75615d1dc", "committedDate": "2020-05-19T04:51:34Z", "message": "add comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MTIwNDkx", "url": "https://github.com/apache/incubator-doris/pull/3628#pullrequestreview-414120491", "createdAt": "2020-05-19T05:53:20Z", "commit": {"oid": "d60b0f8309c009a5f318f444da9392b75615d1dc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2675, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}